---
layout: post
title: "uniapp对接打印机和电子秤"
date: 2025-03-05 20:32:31 +0800
description: "连接电子秤和打印机，最难的不是连接蓝牙和电子成，而是打印机。因为打印机涉及到向打印机写数据操作，然后这个写的数据需要做一个编码转换。难就难在编码转换。如果是java那就是一句代码的事情，而js就没有那么简单了。其实js也是一句代码的事情，打印机接收的的编码为GBK，但是hbuilderx编码为UTF-8。编码转换我们可以使用或者GBK.js，但是这些引入方式为。Vue3已经废弃require这种引入方式，所以没有办法引入。使用可以解决，但是只能在浏览器里面解决，手机不支持这个命令。所有将编码转换成GBK。"
keywords: "uniapp对接打印机和电子秤"
categories: ['未分类']
tags: ['Vue', 'Javascript', 'App']
artid: "146052189"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146052189
    alt: "uniapp对接打印机和电子秤"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146052189
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146052189
cover: https://bing.ee123.net/img/rand?artid=146052189
image: https://bing.ee123.net/img/rand?artid=146052189
img: https://bing.ee123.net/img/rand?artid=146052189
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     uniapp对接打印机和电子秤
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="uniapp_0">
     </a>
     uniapp对接打印机和电子秤
    </h2>
    <blockquote>
     <p>
      连接电子秤和打印机，最难的不是连接蓝牙和电子成，而是打印机。因为打印机涉及到向打印机写数据操作，然后这个写的数据需要做一个编码转换。难就难在编码转换。如果是
      <code>
       java
      </code>
      那就是一句代码的事情，而
      <code>
       js
      </code>
      就没有那么简单了。其实
      <code>
       js
      </code>
      也是一句代码的事情，打印机接收的的编码为
      <code>
       GBK
      </code>
      ，但是
      <code>
       hbuilderx
      </code>
      编码为
      <code>
       UTF-8
      </code>
      。编码转换我们可以使用
      <code>
       encoding.js
      </code>
      或者
      <code>
       GBK.js
      </code>
      ，但是这些引入方式为
      <code>
       var encode = require("./encoding.js");
      </code>
      。
      <code>
       Vue3
      </code>
      已经废弃
      <code>
       require
      </code>
      这种引入方式，所以没有办法引入 。使用
      <code>
       new TextDecoder('gbk').decode(codes)
      </code>
      可以解决，但是只能在浏览器里面解决，手机不支持这个命令。所有将编码转换成
      <code>
       GBK
      </code>
      ，并且转换后返回
      <code>
       10
      </code>
      进制的数组打印。打印机编码可以设置为
      <code>
       UTF-8
      </code>
      ，但是不靠谱，不通用，这样也面临着数据转成
      <code>
       10
      </code>
      进制后似乎也有问题。
     </p>
     <p>
      我找到一个文件进过更改后可以解决这个问题，下面对接打印机详细讲解。
     </p>
    </blockquote>
    <h2>
     <a id="_6">
     </a>
     一、连接蓝牙
    </h2>
    <p>
     参考：https://uniapp.dcloud.net.cn/api/system/bluetooth.html#openbluetoothadapter
    </p>
    <ol>
     <li>
      初始化蓝牙模块
     </li>
     <li>
      开始搜寻附近的蓝牙外围设备
     </li>
     <li>
      监听寻找到新设备的事件（这里可以设备信息）
     </li>
     <li>
      连接低功耗蓝牙设备。
     </li>
     <li>
      获取蓝牙设备所有服务(service)。
     </li>
     <li>
      根据设备获取蓝牙特征值（一个设备特征值很多，这个设备 支持读，写，异步监听等就看这个特征值了。）
     </li>
    </ol>
    <h3>
     <a id="11_17">
     </a>
     1.1、初始化蓝牙
    </h3>
    <pre><code class="prism language-js"><span class="token comment">// 初始化蓝牙</span>
uni<span class="token punctuation">.</span><span class="token function">openBluetoothAdapter</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        that<span class="token punctuation">.</span>connectLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"蓝牙初始化完成"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="12_31">
     </a>
     1.2、开始搜寻附近的蓝牙外围设备
    </h3>
    <p>
     这异步需要初始化蓝牙完成在操作
    </p>
    <pre><code class="prism language-js">uni<span class="token punctuation">.</span><span class="token function">startBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// services: ['0000FFE0'],</span>
    <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        that<span class="token punctuation">.</span>connectLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"查找设备失败"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="13_48">
     </a>
     1.3、发现外围设备
    </h3>
    <p>
     这一步才是真正的搜索附近的蓝牙设备
    </p>
    <pre><code class="prism language-js">uni<span class="token punctuation">.</span><span class="token function">onBluetoothDeviceFound</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     这里会频繁的调用，因为搜索到一个设备调用一次。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/849c9b6e501b439f9f205d6381bc4a09.png"/>
    </p>
    <p>
     注意：deviceId，name要保存下来，后面需要使用。
    </p>
    <h3>
     <a id="14_64">
     </a>
     1.4、连接蓝牙设备
    </h3>
    <pre><code class="prism language-js">uni<span class="token punctuation">.</span><span class="token function">createBLEConnection</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//创建蓝牙连接,连接低功耗蓝牙设备</span>
    <span class="token literal-property property">deviceId</span><span class="token operator">:</span> item<span class="token punctuation">.</span>deviceId<span class="token punctuation">,</span> <span class="token comment">//传入刚刚获取的uuid</span>
    <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        that<span class="token punctuation">.</span>connectLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"创建连接失败"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <blockquote>
     <p>
      这里的
      <code>
       deviceId
      </code>
      既是
      <code>
       uni.onBluetoothDeviceFound
      </code>
      中过去到的
      <code>
       deviceId
      </code>
     </p>
    </blockquote>
    <h3>
     <a id="15_82">
     </a>
     1.5、获取蓝牙设备所有服务
    </h3>
    <p>
     蓝牙已经连接成功了，获取这个蓝牙设备有哪些服务，获取蓝牙特征值需要使用蓝牙服务的
     <code>
      uuid
     </code>
     。因为每个蓝牙有很多服务，每个服务的特征值不同，需要根据蓝牙特征值来寻找是否可以写，可以读，可以监听。
    </p>
    <pre><code class="prism language-js">uni<span class="token punctuation">.</span><span class="token function">getBLEDeviceServices</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//获取蓝牙设备所有服务</span>
    <span class="token literal-property property">deviceId</span><span class="token operator">:</span> deviceId<span class="token punctuation">,</span>
    <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//为什么要用延时,因为不用延时就拿不到所有的服务,在上一步,连接低功耗蓝牙</span>
        <span class="token comment">//设备的时候,需要一个600-1000毫秒的时间后,再去获取设备所有服务,不给延时就会一直返回错误码10004</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"蓝牙可用服务："</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"搜索蓝牙服务失败："</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
        that<span class="token punctuation">.</span>connectLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"搜索蓝牙服务失败"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <blockquote>
     <p>
      这里的
      <code>
       deviceId
      </code>
      既是
      <code>
       uni.onBluetoothDeviceFound
      </code>
      中过去到的
      <code>
       deviceId
      </code>
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2d6b957eb10f4ea3aeaa4ad921bfd530.png"/>
    </p>
    <h3>
     <a id="16_106">
     </a>
     1.6、获取蓝牙特征值
    </h3>
    <pre><code class="prism language-js">uni<span class="token punctuation">.</span><span class="token function">getBLEDeviceCharacteristics</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//获取蓝牙设备某个服务中所有特征值</span>
    <span class="token literal-property property">deviceId</span><span class="token operator">:</span> that<span class="token punctuation">.</span>deviceId<span class="token punctuation">,</span>
    <span class="token literal-property property">serviceId</span><span class="token operator">:</span> item<span class="token punctuation">.</span>uuid<span class="token punctuation">,</span> <span class="token comment">//这个serviceId可以在上一步获取中拿到,也可以在</span>
    <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"获取特征值："</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <blockquote>
     <p>
      这里的
      <code>
       deviceId
      </code>
      既是
      <code>
       uni.onBluetoothDeviceFound
      </code>
      中获取到的
      <code>
       deviceId
      </code>
     </p>
     <p>
      <code>
       serviceId
      </code>
      获取蓝牙服务时获取到的服务
      <code>
       uuid
      </code>
     </p>
    </blockquote>
    <p>
     一台蓝牙设备有多个服务，一个服务可以获取多个蓝牙特征值，需要循环所有的蓝牙服务，去获取蓝牙特征值，找到符合自己需求的特征值即可，除非蓝牙设备不支持。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/afc5b03b3c8349af864cce3c9c34b1d0.png"/>
    </p>
    <h3>
     <a id="17_130">
     </a>
     1.7、连接蓝牙完整步骤
    </h3>
    <pre><code class="prism language-js"><span class="token comment">// 第一步 在页面显示的时候判断是否已经初始化完成蓝牙适配器若成功，则开始查找设备</span>
<span class="token function">openBluetoothAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
	<span class="token comment">// 初始化蓝牙</span>
	uni<span class="token punctuation">.</span><span class="token function">openBluetoothAdapter</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
		<span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// 初始化完毕开始搜索</span>
			that<span class="token punctuation">.</span><span class="token function">StartBluetoothDeviceDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">/**
 * 第二步 在页面显示的时候判断是都已经初始化完成蓝牙适配器若成功，则开始查找设备
 */</span>
<span class="token function">StartBluetoothDeviceDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
	uni<span class="token punctuation">.</span><span class="token function">startBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
		<span class="token comment">// services: ['0000FFE0'],</span>
		<span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
			that<span class="token punctuation">.</span><span class="token function">OnBluetoothDeviceFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
			that<span class="token punctuation">.</span>connectLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"查找设备失败"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">/**
 * 第三步  发现外围设备
 */</span>
<span class="token function">OnBluetoothDeviceFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
	uni<span class="token punctuation">.</span><span class="token function">onBluetoothDeviceFound</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
		res<span class="token punctuation">.</span>devices<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">device</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//这一步就是去筛选找到的蓝牙中,有没有你匹配的名称</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>device<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"MPT-II"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// 连接蓝牙</span>
				that<span class="token punctuation">.</span><span class="token function">CreateBLEConnection</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>
				<span class="token comment">// 找到需要连接的蓝牙了，可以关闭蓝牙搜索了。</span>
				that<span class="token punctuation">.</span><span class="token function">StopBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token comment">// </span>
<span class="token comment">/**
 * 第四步 停止搜索蓝牙设备
 */</span>
<span class="token function">StopBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
	uni<span class="token punctuation">.</span><span class="token function">stopBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
		<span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"第四步 找到匹配的蓝牙后就关掉蓝牙搜寻:"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第四步 停止搜索蓝牙设备失败，错误码：'</span> <span class="token operator">+</span> res<span class="token punctuation">.</span>errCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// 第五步 创建蓝牙连接,连接低功耗蓝牙设备</span>
<span class="token function">CreateBLEConnection</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
	uni<span class="token punctuation">.</span><span class="token function">createBLEConnection</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//创建蓝牙连接,连接低功耗蓝牙设备</span>
		<span class="token literal-property property">deviceId</span><span class="token operator">:</span> item<span class="token punctuation">.</span>deviceId<span class="token punctuation">,</span> <span class="token comment">//传入刚刚获取的uuid</span>
		<span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			that<span class="token punctuation">.</span><span class="token function">GetBLEDeviceServices</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>deviceId<span class="token punctuation">)</span> <span class="token comment">//获取蓝牙设备所有服务(service)。</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			that<span class="token punctuation">.</span>connectLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"创建连接失败"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

<span class="token comment">//第六步 获取蓝牙设备所有服务(service)。</span>
<span class="token function">GetBLEDeviceServices</span><span class="token punctuation">(</span><span class="token parameter">deviceId</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
		uni<span class="token punctuation">.</span><span class="token function">getBLEDeviceServices</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//获取蓝牙设备所有服务</span>
			<span class="token literal-property property">deviceId</span><span class="token operator">:</span> deviceId<span class="token punctuation">,</span>
			<span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//为什么要用延时,因为不用延时就拿不到所有的服务,在上一步,连接低功耗蓝牙</span>
				<span class="token comment">//设备的时候,需要一个600-1000毫秒的时间后,再去获取设备所有服务,不给延时就会一直返回错误码10004</span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"蓝牙可用服务："</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
				that<span class="token punctuation">.</span><span class="token function">GetBLEDeviceCharacteristics</span><span class="token punctuation">(</span>deviceId<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token comment">//获取蓝牙设备某个服务中所有特征值</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"搜索蓝牙服务失败："</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
				that<span class="token punctuation">.</span>connectLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"搜索蓝牙服务失败"</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// 第七步 获取蓝牙特征值</span>
<span class="token function">GetBLEDeviceCharacteristics</span><span class="token punctuation">(</span><span class="token parameter">deviceId<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
	<span class="token comment">// 获取当前连接这个蓝牙的可用服务</span>
	<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
		item<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">services</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
			console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"服务："</span><span class="token punctuation">,</span> services<span class="token punctuation">)</span>
			uni<span class="token punctuation">.</span><span class="token function">getBLEDeviceCharacteristics</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//获取蓝牙设备某个服务中所有特征值</span>
				<span class="token literal-property property">deviceId</span><span class="token operator">:</span> deviceId<span class="token punctuation">,</span>
				<span class="token literal-property property">serviceId</span><span class="token operator">:</span> services<span class="token punctuation">.</span>uuid<span class="token punctuation">,</span> <span class="token comment">//这个serviceId可以在上一步获取中拿到,也可以在</span>
				<span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"特征值"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
					<span class="token comment">// 循环筛选蓝牙特征值，筛选到符合打印机的特征值为止</span>
					res<span class="token punctuation">.</span>characteristics<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ch</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
						<span class="token comment">// 判断是否支持打印</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>ch<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>write<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
							<span class="token comment">// 连接蓝牙最终就是使用者三个值。</span>
							console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"蓝牙设备deviceId："</span><span class="token punctuation">,</span> deviceId<span class="token punctuation">)</span>
							console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"使用蓝牙服务uuid:"</span><span class="token punctuation">,</span> services<span class="token punctuation">.</span>uuid<span class="token punctuation">)</span>
							console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"特征值uuid："</span><span class="token punctuation">,</span> ch<span class="token punctuation">.</span>uuid<span class="token punctuation">)</span>
							<span class="token comment">// 这里不能结束最外层循环，就让他全部循环完成把，反正也不多。</span>
							<span class="token keyword">return</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span>
				<span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					that<span class="token punctuation">.</span>connectLog<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">"获取特征值失败"</span><span class="token punctuation">)</span>
					console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"获取蓝牙设备某个服务中所有特征值失败:"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
    <h2>
     <a id="_261">
     </a>
     二、对接电子秤
    </h2>
    <h3>
     <a id="21_263">
     </a>
     2.1、使用
    </h3>
    <pre><code class="prism language-js">uni<span class="token punctuation">.</span><span class="token function">notifyBLECharacteristicValueChange</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 启用 notify 功能</span>
    <span class="token literal-property property">deviceId</span><span class="token operator">:</span> that<span class="token punctuation">.</span>deviceId<span class="token punctuation">,</span> <span class="token comment">// 蓝牙设备 deviceId</span>
    <span class="token literal-property property">serviceId</span><span class="token operator">:</span> that<span class="token punctuation">.</span>serviceId<span class="token punctuation">,</span> <span class="token comment">// 蓝牙服务uuid</span>
    <span class="token literal-property property">characteristicId</span><span class="token operator">:</span> that<span class="token punctuation">.</span>characteristicId<span class="token punctuation">,</span> <span class="token comment">// 蓝牙特征值uuid</span>
    <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'订阅电子秤成功'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>errMsg<span class="token punctuation">)</span>
        <span class="token comment">// 电子秤回调事件</span>
        uni<span class="token punctuation">.</span><span class="token function">onBLECharacteristicValueChange</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> dataString <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                dataString <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            that<span class="token punctuation">.</span>weight <span class="token operator">=</span> dataString
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <blockquote>
     <p>
      需要的三个参数，连接蓝牙，的时候就说过怎么获取了。
     </p>
    </blockquote>
    <p>
     这里千万需要注意：
     <code>
      uni.onBLECharacteristicValueChange
     </code>
     返回的是重量，这里要看电子秤厂商给我们返回啥。我的电子秤是和厂商说好的，值返回重量，所以这里直接把ArrayBuffer转成普通文本，我就能得到了重量。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/2ba9458c5fce4c908c330fd54f1bb05c.png"/>
    </p>
    <h3>
     <a id="22_294">
     </a>
     2.2、完整案列
    </h3>
    <p>
     注意：连接电子秤部分，我直接将电子秤的蓝牙名称写死了，这样方便操作，今后电子秤蓝牙名称不同的，需要更改。
    </p>
    <pre><code class="prism language-js"><span class="token operator">&lt;</span>template<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 打印 <span class="token operator">--</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>view <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"balance-box"</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 操作区 <span class="token operator">--</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>view <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"operation-box"</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>button @click<span class="token operator">=</span><span class="token string">"openBluetoothAdapter"</span><span class="token operator">&gt;</span>连接蓝牙<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>input <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"balance-input"</span> <span class="token operator">:</span>value<span class="token operator">=</span><span class="token string">"weight"</span> placeholder<span class="token operator">=</span><span class="token string">"这里是电子秤返回数据"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 显示连接蓝牙日志 <span class="token operator">--</span><span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span>view <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"connect-log"</span><span class="token operator">&gt;</span>
			<span class="token operator">&lt;</span>view v<span class="token operator">-</span><span class="token keyword">for</span><span class="token operator">=</span><span class="token string">"(log,index) in connectLog"</span> <span class="token operator">:</span>key<span class="token operator">=</span><span class="token string">"index"</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>log<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
		<span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span><span class="token operator">/</span>view<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>template<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
	<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
				<span class="token literal-property property">connectLog</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">// 日志</span>
				<span class="token literal-property property">weight</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 获取到的重量</span>
				<span class="token literal-property property">deviceId</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 蓝牙设备的 deviceId</span>
				<span class="token comment">// 这里的 serviceId 需要在 getBLEDeviceServices 接口中获取</span>
				<span class="token literal-property property">serviceId</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 蓝牙服务uuid</span>
				<span class="token comment">// 这里的 characteristicId 需要在 getBLEDeviceCharacteristics 接口中获取</span>
				<span class="token literal-property property">characteristicId</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// 蓝牙特征值uuid</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">openBluetoothAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
				<span class="token comment">// 初始化蓝牙</span>
				uni<span class="token punctuation">.</span><span class="token function">openBluetoothAdapter</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
					<span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
						<span class="token comment">// 初始化完毕开始搜索</span>
						that<span class="token punctuation">.</span><span class="token function">StartBluetoothDeviceDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span><span class="token punctuation">,</span>
					<span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token comment">/**
			 * 第二步 在页面显示的时候判断是都已经初始化完成蓝牙适配器若成功，则开始查找设备
			 */</span>
			<span class="token function">StartBluetoothDeviceDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
				uni<span class="token punctuation">.</span><span class="token function">startBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
					<span class="token comment">// services: ['0000FFE0'],</span>
					<span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
						that<span class="token punctuation">.</span><span class="token function">OnBluetoothDeviceFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">,</span>
					<span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
						<span class="token comment">// that.connectLog.push("查找设备失败")</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token comment">/**
			 * 第三步  发现外围设备
			 */</span>
			<span class="token function">OnBluetoothDeviceFound</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
				uni<span class="token punctuation">.</span><span class="token function">onBluetoothDeviceFound</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
					res<span class="token punctuation">.</span>devices<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">device</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//这一步就是去筛选找到的蓝牙中,有没有你匹配的名称</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>device<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">"ANDZ"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
							<span class="token comment">// 连接蓝牙</span>
							that<span class="token punctuation">.</span><span class="token function">CreateBLEConnection</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>
							<span class="token comment">// 找到需要连接的蓝牙了，可以关闭蓝牙搜索了。</span>
							that<span class="token punctuation">.</span><span class="token function">StopBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>

			<span class="token comment">// </span>
			<span class="token comment">/**
			 * 第四步 停止搜索蓝牙设备
			 */</span>
			<span class="token function">StopBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
				uni<span class="token punctuation">.</span><span class="token function">stopBluetoothDevicesDiscovery</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
					<span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
						console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"第四步 找到匹配的蓝牙后就关掉蓝牙搜寻:"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span><span class="token punctuation">,</span>
					<span class="token function-variable function">fail</span><span class="token operator">:</span> <span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
						console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第四步 停止搜索蓝牙设备失败，错误码：'</span> <span class="token operator">+</span> res<span class="token punctuation">.</span>errCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token comment">// 第五步 创建蓝牙连接,连接低功耗蓝牙设备</span>
			<span class="token function">CreateBLEConnection</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
				uni<span class="token punctuation">.</span><span class="token function">createBLEConnection</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//创建蓝牙连接,连接低功耗蓝牙设备</span>
					<span class="token literal-property property">deviceId</span><span class="token operator">:</span> item<span class="token punctuation">.</span>deviceId<span class="token punctuation">,</span> <span class="token comment">//传入刚刚获取的uuid</span>
					<span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						that<span class="token punctuation">.</span><span class="token function">GetBLEDeviceServices</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>deviceId<span class="token punctuation">)</span> <span class="token comment">//获取蓝牙设备所有服务(service)。</span>
					<span class="token punctuation">}</span><span class="token punctuation">,</span>
					<span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>

			<span class="token comment">//第六步 获取蓝牙设备所有服务(service)。</span>
			<span class="token function">GetBLEDeviceServices</span><span class="token punctuation">(</span><span class="token parameter">deviceId</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
				<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
					uni<span class="token punctuation">.</span><span class="token function">getBLEDeviceServices</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//获取蓝牙设备所有服务</span>
						<span class="token literal-property property">deviceId</span><span class="token operator">:</span> deviceId<span class="token punctuation">,</span>
						<span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//为什么要用延时,因为不用延时就拿不到所有的服务,在上一步,连接低功耗蓝牙</span>
							<span class="token comment">//设备的时候,需要一个600-1000毫秒的时间后,再去获取设备所有服务,不给延时就会一直返回错误码10004</span>
							console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"蓝牙可用服务："</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
							that<span class="token punctuation">.</span><span class="token function">GetBLEDeviceCharacteristics</span><span class="token punctuation">(</span>deviceId<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token comment">//获取蓝牙设备某个服务中所有特征值</span>
						<span class="token punctuation">}</span><span class="token punctuation">,</span>
						<span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
							console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"搜索蓝牙服务失败："</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token comment">// 第七步 获取蓝牙特征值</span>
			<span class="token function">GetBLEDeviceCharacteristics</span><span class="token punctuation">(</span><span class="token parameter">deviceId<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
				<span class="token comment">// 获取当前连接这个蓝牙的可用服务</span>
				<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
					item<span class="token punctuation">.</span>services<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">services</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
						console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"服务："</span><span class="token punctuation">,</span> services<span class="token punctuation">)</span>
						uni<span class="token punctuation">.</span><span class="token function">getBLEDeviceCharacteristics</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//获取蓝牙设备某个服务中所有特征值</span>
							<span class="token literal-property property">deviceId</span><span class="token operator">:</span> deviceId<span class="token punctuation">,</span>
							<span class="token literal-property property">serviceId</span><span class="token operator">:</span> services<span class="token punctuation">.</span>uuid<span class="token punctuation">,</span> <span class="token comment">//这个serviceId可以在上一步获取中拿到,也可以在</span>
							<span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
								console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"特征值"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
								<span class="token comment">// 循环筛选蓝牙特征值，筛选到符合打印机的特征值为止</span>
								res<span class="token punctuation">.</span>characteristics<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">ch</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
									<span class="token comment">// 判断是否支持打印</span>
									<span class="token keyword">if</span> <span class="token punctuation">(</span>ch<span class="token punctuation">.</span>properties<span class="token punctuation">.</span>notify<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
										<span class="token comment">// 连接蓝牙最终就是使用者三个值。</span>
										<span class="token comment">// console.log("蓝牙设备deviceId：", deviceId)</span>
										<span class="token comment">// console.log("使用蓝牙服务uuid:", services.uuid)</span>
										<span class="token comment">// console.log("特征值uuid：", ch.uuid)</span>
										that<span class="token punctuation">.</span>deviceId <span class="token operator">=</span> deviceId
										that<span class="token punctuation">.</span>serviceId <span class="token operator">=</span> services<span class="token punctuation">.</span>uuid
										that<span class="token punctuation">.</span>characteristicId <span class="token operator">=</span> ch<span class="token punctuation">.</span>uuid
										<span class="token comment">// 这里不能结束最外层循环，就让他全部循环完成把，反正也不多。</span>
										<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
											that<span class="token punctuation">.</span><span class="token function">onNotifyBLECharacteristicValueChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
										<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1500</span><span class="token punctuation">)</span>
										<span class="token keyword">return</span>
									<span class="token punctuation">}</span>
								<span class="token punctuation">}</span><span class="token punctuation">)</span>
							<span class="token punctuation">}</span><span class="token punctuation">,</span>
							<span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
								console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"获取蓝牙设备某个服务中所有特征值失败:"</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span>
							<span class="token punctuation">}</span>
						<span class="token punctuation">}</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>

			<span class="token comment">// 监听电子秤</span>
			<span class="token function">onNotifyBLECharacteristicValueChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
				uni<span class="token punctuation">.</span><span class="token function">notifyBLECharacteristicValueChange</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
					<span class="token literal-property property">state</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 启用 notify 功能</span>
					<span class="token literal-property property">deviceId</span><span class="token operator">:</span> that<span class="token punctuation">.</span>deviceId<span class="token punctuation">,</span> <span class="token comment">// 蓝牙设备 deviceId</span>
					<span class="token literal-property property">serviceId</span><span class="token operator">:</span> that<span class="token punctuation">.</span>serviceId<span class="token punctuation">,</span> <span class="token comment">// 蓝牙服务uuid</span>
					<span class="token literal-property property">characteristicId</span><span class="token operator">:</span> that<span class="token punctuation">.</span>characteristicId<span class="token punctuation">,</span> <span class="token comment">// 蓝牙特征值uuid</span>
					<span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'订阅电子秤成功'</span><span class="token punctuation">,</span> res<span class="token punctuation">.</span>errMsg<span class="token punctuation">)</span>
						<span class="token comment">// 电子秤回调事件</span>
						uni<span class="token punctuation">.</span><span class="token function">onBLECharacteristicValueChange</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
							<span class="token keyword">const</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token keyword">var</span> dataString <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
							<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> buffer<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
								dataString <span class="token operator">+=</span> String<span class="token punctuation">.</span><span class="token function">fromCharCode</span><span class="token punctuation">(</span>buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token punctuation">}</span>
							that<span class="token punctuation">.</span>weight <span class="token operator">=</span> dataString
						<span class="token punctuation">}</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

<span class="token operator">&lt;</span>style lang<span class="token operator">=</span><span class="token string">"scss"</span><span class="token operator">&gt;</span>
	<span class="token punctuation">.</span>balance<span class="token operator">-</span>box <span class="token punctuation">{<!-- --></span>
		<span class="token literal-property property">display</span><span class="token operator">:</span> flex<span class="token punctuation">;</span>

		<span class="token punctuation">.</span>operation<span class="token operator">-</span>box <span class="token punctuation">{<!-- --></span>
			<span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">70</span><span class="token operator">%</span><span class="token punctuation">;</span>
			<span class="token literal-property property">overflow</span><span class="token operator">:</span> auto<span class="token punctuation">;</span>

			<span class="token punctuation">.</span>balance<span class="token operator">-</span>input <span class="token punctuation">{<!-- --></span>
				<span class="token literal-property property">height</span><span class="token operator">:</span> 80rpx<span class="token punctuation">;</span>
				border<span class="token operator">-</span>radius<span class="token operator">:</span> 10rpx<span class="token punctuation">;</span>
				<span class="token literal-property property">border</span><span class="token operator">:</span> 2rpx solid saddlebrown<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>

		<span class="token punctuation">.</span>connect<span class="token operator">-</span>log <span class="token punctuation">{<!-- --></span>
			<span class="token literal-property property">display</span><span class="token operator">:</span> flex<span class="token punctuation">;</span>
			flex<span class="token operator">-</span>direction<span class="token operator">:</span> column<span class="token punctuation">;</span>
			<span class="token literal-property property">position</span><span class="token operator">:</span> sticky<span class="token punctuation">;</span>
			<span class="token literal-property property">top</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">30</span><span class="token operator">%</span><span class="token punctuation">;</span>
			<span class="token literal-property property">color</span><span class="token operator">:</span> #fff<span class="token punctuation">;</span>
			<span class="token literal-property property">height</span><span class="token operator">:</span> 100vh<span class="token punctuation">;</span>
			<span class="token literal-property property">overflow</span><span class="token operator">:</span> auto<span class="token punctuation">;</span>
			background<span class="token operator">-</span>color<span class="token operator">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			view <span class="token punctuation">{<!-- --></span>
				<span class="token literal-property property">margin</span><span class="token operator">:</span> 10rpx <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>

</code></pre>
    <h2>
     <a id="_515">
     </a>
     三、对接打印机
    </h2>
    <h3>
     <a id="31_517">
     </a>
     3.1、对接打印机
    </h3>
    <pre><code class="prism language-js"><span class="token comment">// 第八步 发送二进制数据</span>
<span class="token function">WriteBLECharacteristicValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// return</span>
    <span class="token keyword">let</span> that <span class="token operator">=</span> <span class="token keyword">this</span>
    <span class="token comment">// 打印的内容</span>
    uni<span class="token punctuation">.</span><span class="token function">writeBLECharacteristicValue</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 蓝牙设备 deviceId</span>
        <span class="token literal-property property">deviceId</span><span class="token operator">:</span> that<span class="token punctuation">.</span>deviceId<span class="token punctuation">,</span>
        <span class="token comment">// 蓝牙服务uuid</span>
        <span class="token literal-property property">serviceId</span><span class="token operator">:</span> that<span class="token punctuation">.</span>serviceId<span class="token punctuation">,</span>
        <span class="token comment">// 蓝牙特征值uuid</span>
        <span class="token literal-property property">characteristicId</span><span class="token operator">:</span> that<span class="token punctuation">.</span>characteristicId<span class="token punctuation">,</span>
        <span class="token comment">// 打印的数据，ArrayBuffer 类型，数据为 10进制或者16进制。编码方式：GBK</span>
        <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">178</span><span class="token punctuation">,</span> <span class="token number">226</span><span class="token punctuation">,</span> <span class="token number">202</span><span class="token punctuation">,</span> <span class="token number">212</span><span class="token punctuation">,</span> <span class="token number">163</span><span class="token punctuation">,</span> <span class="token number">161</span><span class="token punctuation">,</span> <span class="token number">163</span><span class="token punctuation">,</span> <span class="token number">161</span><span class="token punctuation">,</span> <span class="token number">163</span><span class="token punctuation">,</span> <span class="token number">161</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"打印成功"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"打印失败"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
    <p>
     对接打印机，难点在value的值，这个是ArrayBuffer类型的，这个里面可以放10进制和16进制，我是使用10进制的。例如：[27,100,2]表示走纸2行[27,100,3]表示走纸三行。为什么是[27,100,n]这个要看打印机的指令说明文档，里面有10进制和16进制的。不同厂商的打印机指令有差异。
    </p>
    <p>
     并且value的数据最多只能有20个，多了需要拆分开，批量发送。
    </p>
    <h3>
     <a id="32_550">
     </a>
     3.2、编码转换
    </h3>
    <p>
     编码转换就是在前言所说的这个困惑，由于我使用的是
     <code>
      Vue3
     </code>
     ，所以不支持
     <code>
      var encode = require("./encoding.js");
     </code>
     方式引入。编码转换的
     <code>
      js
     </code>
     有
     <code>
      encoding.js
     </code>
     和
     <code>
      GBK.js
     </code>
     ，但是这两种都是
     <code>
      require
     </code>
     引入的方式，所以
     <code>
      Vue3
     </code>
     无法使用，
     <code>
      uniapp
     </code>
     的手机端 不支持
     <code>
      new TextDecoder('gbk').decode(codes)
     </code>
     ，百思不得其解的时刻，偶然间发现
     <code>
      GBK.js
     </code>
     的另外一个版本有改动的希望，所以我使用
     <code>
      GBK.js
     </code>
     的另外一个版本改动了一下，成功解决这个困惑。
    </p>
    <h4>
     <a id="321GBK_554">
     </a>
     3.2.1、GBK文件改动
    </h4>
    <p>
     文件来源：https://github.com/EtherDream/str2gbk
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/7b053825e8944a858536ba2c76abd89c.png"/>
    </p>
    <p>
     这个文件在
     <code>
      Vue3
     </code>
     中可以使用，但是有一个地方使用了
     <code>
      new TextDecoder('gbk').decode(codes)
     </code>
     ，因为手机端不支持这个，但是浏览器支持。看看
     <code>
      GBK.js
     </code>
     源代码。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/497c342f8aae4a058d61778f16339d9a.png"/>
    </p>
    <p>
     最终看到这里，因为这个
     <code>
      js
     </code>
     文件里面的
     <code>
      table
     </code>
     数组的数据的来源是，根据
     <code>
      codes
     </code>
     参数通过
     <code>
      new TextDecoder('gbk').decode(codes)
     </code>
     转换得到的，而
     <code>
      codes
     </code>
     参数又是通过一段算法计算得到，都与我们的参数无关，可以说是一段死的数据。那么我们就可以在浏览器里面执行，将最终转换后的
     <code>
      table
     </code>
     集合数据获取到，直接卸载文件里面，这样就可以解决
     <code>
      UTF-8
     </code>
     编码转为
     <code>
      GBK
     </code>
     编码的问题，并且转换后 是
     <code>
      10
     </code>
     进制的
     <code>
      Uint8Array
     </code>
     数组，刚好符合打印条件。转换后的
     <code>
      gbk.js
     </code>
     这个文件已经放在当前目录的
     <code>
      doc
     </code>
     文件夹下面。
    </p>
    <h4>
     <a id="322GBKjs_566">
     </a>
     3.2.2、使用GBK.js
    </h4>
    <ul>
     <li>
      引入文件
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token keyword">import</span> gbk <span class="token keyword">from</span> <span class="token string">"./gbk.js"</span>
</code></pre>
    <ul>
     <li>
      使用
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token function">gbk</span><span class="token punctuation">(</span><span class="token string">"这是打印的内容，不得有误。"</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre>
    <ul>
     <li>
      返回数据案例
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token number">213</span><span class="token punctuation">,</span><span class="token number">226</span><span class="token punctuation">,</span><span class="token number">202</span><span class="token punctuation">,</span><span class="token number">199</span><span class="token punctuation">,</span><span class="token number">180</span><span class="token punctuation">,</span><span class="token number">242</span><span class="token punctuation">,</span><span class="token number">211</span><span class="token punctuation">,</span><span class="token number">161</span><span class="token punctuation">,</span><span class="token number">181</span><span class="token punctuation">,</span><span class="token number">196</span><span class="token punctuation">,</span><span class="token number">196</span><span class="token punctuation">,</span><span class="token number">218</span><span class="token punctuation">,</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token number">221</span><span class="token punctuation">,</span><span class="token number">163</span><span class="token punctuation">,</span><span class="token number">172</span><span class="token punctuation">,</span><span class="token number">178</span><span class="token punctuation">,</span><span class="token number">187</span><span class="token punctuation">,</span><span class="token number">181</span><span class="token punctuation">,</span><span class="token number">195</span><span class="token punctuation">,</span><span class="token number">211</span><span class="token punctuation">,</span><span class="token number">208</span><span class="token punctuation">,</span><span class="token number">206</span><span class="token punctuation">,</span><span class="token number">243</span><span class="token punctuation">,</span><span class="token number">161</span><span class="token punctuation">,</span><span class="token number">163</span>
</code></pre>
    <p>
     是个数组，只是打印出来的时候是这样子而已。这个数据可以直接打印了，只是不能超过20个，多的话需要拆分发送，3.3拆分打印数据有现成方法。
    </p>
    <h3>
     <a id="33_597">
     </a>
     3.3、拆分打印数据
    </h3>
    <p>
     因为
     <code>
      value
     </code>
     最多只能发送20个，所以需要拆分批量发送。
    </p>
    <pre><code class="prism language-js"><span class="token comment">/**
 * 拆分打印数据并打印，将uint8Array打印的数据拆分成，最多 20
 * @param {Object} deviceId 蓝牙设备deviceId
 * @param {Object} serviceId 服务uuid
 * @param {Object} characteristicId 蓝牙特征值uuid
 * @param {Object} uint8Array 打印数据
 */</span>
<span class="token function">senBlData</span><span class="token punctuation">(</span><span class="token parameter">deviceId<span class="token punctuation">,</span> serviceId<span class="token punctuation">,</span> characteristicId<span class="token punctuation">,</span> uint8Array</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'************deviceId = ['</span> <span class="token operator">+</span> deviceId <span class="token operator">+</span> <span class="token string">']  serviceId = ['</span> <span class="token operator">+</span> serviceId <span class="token operator">+</span>
		<span class="token string">'] characteristics=['</span> <span class="token operator">+</span> characteristicId <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> uint8Buf <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>uint8Array<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">function</span> <span class="token function">split_array</span><span class="token punctuation">(</span><span class="token parameter">datas<span class="token punctuation">,</span> size</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
		<span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> datas<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">+=</span> size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			result<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> datas<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> i <span class="token operator">+</span> size<span class="token punctuation">)</span>
			j<span class="token operator">++</span>
		<span class="token punctuation">}</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
		<span class="token keyword">return</span> result
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> sendloop <span class="token operator">=</span> <span class="token function">split_array</span><span class="token punctuation">(</span>uint8Buf<span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">function</span> <span class="token function">realWriteData</span><span class="token punctuation">(</span><span class="token parameter">sendloop<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">var</span> data <span class="token operator">=</span> sendloop<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"undefined"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"第【"</span> <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token string">"】次写数据"</span> <span class="token operator">+</span> data<span class="token punctuation">)</span>
		<span class="token keyword">var</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
		<span class="token keyword">var</span> dataView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataView</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> data<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			dataView<span class="token punctuation">.</span><span class="token function">setUint8</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span> data<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// 调动打印机打印</span>
		uni<span class="token punctuation">.</span><span class="token function">writeBLECharacteristicValue</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
			deviceId<span class="token punctuation">,</span>
			serviceId<span class="token punctuation">,</span>
			characteristicId<span class="token punctuation">,</span>
			<span class="token literal-property property">value</span><span class="token operator">:</span> buffer<span class="token punctuation">,</span>
			<span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">realWriteData</span><span class="token punctuation">(</span>sendloop<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"点错误："</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span>
				<span class="token function">realWriteData</span><span class="token punctuation">(</span>sendloop<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">realWriteData</span><span class="token punctuation">(</span>sendloop<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
    <h3>
     <a id="34_660">
     </a>
     3.4、打印指令讲解
    </h3>
    <p>
     打印指令就像是命令，发送什么样的命令干什么样的事情。打印机的指令有十进制和十六进制两种，如果使用十六进制的，会遇到
     <code>
      x011，0x0a，0x1c，0x10
     </code>
     等，而这里的
     <code>
      x0
     </code>
     在
     <code>
      C
     </code>
     语言里面表示指令的意思，没有其他作用，但是发送的时候得这样写，真正的指令是后面的
     <code>
      11，0a,1c,10
     </code>
     。
    </p>
    <p>
     不同打印机的指令不同，估计大多都一样把，我目前使用的打印机是 “便捷式打印机MoilePrinter”这种。
    </p>
    <p>
     特备强调：打印机如果设置了，没有恢复，那么后面打印的所有内容都是按照设置后的打印，除非发送设置默认命令或者关机重启。例如：将行间距设置为150，那么后面打印的所有内容都是150行间距，如果发送了恢复行间距了，后面打印的行间距为默认行间距。
    </p>
    <h4>
     <a id="341_670">
     </a>
     3.4.1、打印机指令使用说明
    </h4>
    <p>
     首先拿着打印机指令说明，需要看看打印机参数。比如：编码方式，多少点每行。这些都是需要使用的到，必须了解。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/bd262cc3ba794d0e868b55e0b96c80a9.png"/>
    </p>
    <p>
     说明书里面的指令列表可以不同看，最关键的是指令详解。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/73537cb08f4f47009755eebc6c00407c.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/12d2be49707c4991874d3211611b0a55.png"/>
    </p>
    <h5>
     <a id="_686">
     </a>
     案列
    </h5>
    <ul>
     <li>
      走纸60 行
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token comment">// 打印的内容</span>
uni<span class="token punctuation">.</span><span class="token function">writeBLECharacteristicValue</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 蓝牙设备 deviceId</span>
    <span class="token literal-property property">deviceId</span><span class="token operator">:</span> that<span class="token punctuation">.</span>deviceId<span class="token punctuation">,</span>
    <span class="token comment">// 蓝牙服务uuid</span>
    <span class="token literal-property property">serviceId</span><span class="token operator">:</span> that<span class="token punctuation">.</span>serviceId<span class="token punctuation">,</span>
    <span class="token comment">// 蓝牙特征值uuid</span>
    <span class="token literal-property property">characteristicId</span><span class="token operator">:</span> that<span class="token punctuation">.</span>characteristicId<span class="token punctuation">,</span>
    <span class="token comment">// 打印的数据，ArrayBuffer 类型，数据为 10进制或者16进制。编码方式：GBK</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">success</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"打印成功"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"打印失败"</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/6d216a4ae81c40ff90f0578683dbc42b.png"/>
    </p>
    <ul>
     <li>
      打印
      <code>
       这是测试打印机
      </code>
      并走纸 2 行
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token function">printData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 打印的数据</span>
    <span class="token keyword">let</span> command <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">// 打印的数据，这里的 \r\n表示换行，必须要进过转码</span>
    <span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token function">gbk</span><span class="token punctuation">(</span><span class="token string">"这是测试打印机"</span><span class="token punctuation">)</span>
    data<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        command<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 打印指令</span>
    <span class="token keyword">let</span> instruct <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">27</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token comment">// 将打印指令增加到 打印的数据中，因为是打印为在走纸两行，所以说 27,100,2 要增加在打印数据的后面，【 27,100,2  这三个数字就相当于中文对人说 ，走纸两			行。而这里是对机器说走纸两行，机器的走纸两行的语言就是  27,100,2】</span>
    instruct<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">d</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        command<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 这里打印的数据可能超过20个字符了，所有拆分批量打印。</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">senBlData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deviceId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serviceId<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>characteristicId<span class="token punctuation">,</span> command<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
    <p>
     “这是测试打印机”这几个中文通过
     <code>
      gbk()
     </code>
     转码后得到的
     <code>
      Uint8Array
     </code>
     数组是
     <code>
      213, 226, 202, 199, 178, 226, 202, 212, 180, 242, 211, 161, 187, 250
     </code>
     ，打印并走纸两行 的十进制是
     <code>
      27,100,2
     </code>
     。是先打印然后在走纸，所以走纸的命令要增加在后面，所以最终打印数据为：
    </p>
    <pre><code class="prism language-js"><span class="token number">213</span><span class="token punctuation">,</span> <span class="token number">226</span><span class="token punctuation">,</span> <span class="token number">202</span><span class="token punctuation">,</span> <span class="token number">199</span><span class="token punctuation">,</span> <span class="token number">178</span><span class="token punctuation">,</span> <span class="token number">226</span><span class="token punctuation">,</span> <span class="token number">202</span><span class="token punctuation">,</span> <span class="token number">212</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">242</span><span class="token punctuation">,</span> <span class="token number">211</span><span class="token punctuation">,</span> <span class="token number">161</span><span class="token punctuation">,</span> <span class="token number">187</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2</span>
</code></pre>
    <h4>
     <a id="341n_745">
     </a>
     3.4.1、打印并进纸n行
    </h4>
    <pre><code class="prism language-js"><span class="token number">27</span> <span class="token number">100</span> n
</code></pre>
    <blockquote>
     <p>
      0 ≤ n ≤ 255
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/62c0ba9476e949b2ad34304dd6d5c5e8.png"/>
    </p>
    <h4>
     <a id="342_757">
     </a>
     3.4.2、设置行间距
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/dbb770c3621b4119812d2245aa770bb0.png"/>
    </p>
    <ul>
     <li>
      实例值
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token number">27</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">,</span> <span class="token number">255</span>
</code></pre>
    <h4>
     <a id="343_771">
     </a>
     3.4.3、设置行间距为默认
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/20e26d9ae2ee40a880ef47b41666fe22.png"/>
    </p>
    <ul>
     <li>
      参数
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token number">27</span><span class="token punctuation">,</span> <span class="token number">50</span>
</code></pre>
    <p>
     这个必须是这样，没有其他任何参数，因为是设置为默认。
    </p>
    <h4>
     <a id="344_787">
     </a>
     3.4.4、字体大小
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/84759e9ea558484c816db914eb8d53e1.png"/>
    </p>
    <ul>
     <li>
      设置字2倍宽
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">16</span>
</code></pre>
    <ul>
     <li>
      设置字体2倍高度
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">1</span>
</code></pre>
    <ul>
     <li>
      设置字体2倍宽和2倍高
     </li>
    </ul>
    <p>
     直接在打印数组里面增加就行。
    </p>
    <pre><code class="prism language-js"><span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">16</span>
</code></pre>
    <ul>
     <li>
      恢复字体宽高
     </li>
    </ul>
    <blockquote>
     <p>
      直接使用 29, 33, 0 字体的宽高都恢复默认了。
     </p>
    </blockquote>
    <pre><code class="prism language-js"><span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">,</span> <span class="token number">0</span>
</code></pre>
    <h4>
     <a id="345_827">
     </a>
     3.4.5、字体对齐方式
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/17c592edacd848439eaf9aac019012a6.png"/>
    </p>
    <ul>
     <li>
      字体居左
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">0</span>    或者   <span class="token number">27</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">48</span>
</code></pre>
    <ul>
     <li>
      字体居中
     </li>
    </ul>
    <pre><code>27,97,1    或者   27,97,49
</code></pre>
    <ul>
     <li>
      字体居右
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token number">27</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">2</span>    或者   <span class="token number">27</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">50</span>
</code></pre>
    <h4>
     <a id="346_853">
     </a>
     3.4.6、打印一维码
    </h4>
    <h5>
     <a id="HRI_855">
     </a>
     设置一维条码可读字符（HRI）打印位置
    </h5>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/6219d054d6b84a34aa6eab92cd120ba9.png"/>
    </p>
    <ul>
     <li>
      实例
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">0</span>
<span class="token number">29</span><span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">1</span>
<span class="token number">29</span><span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">2</span>
<span class="token number">29</span><span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">3</span>
或者
<span class="token number">29</span><span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">48</span>
<span class="token number">29</span><span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">49</span>
<span class="token number">29</span><span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">50</span>
<span class="token number">29</span><span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">51</span>
</code></pre>
    <h5>
     <a id="_873">
     </a>
     设置一维条码高度
    </h5>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/7e8809ab0a274f5495d1bc61c73bc41c.png"/>
    </p>
    <ul>
     <li>
      实例值
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">104</span><span class="token punctuation">,</span><span class="token number">100</span>
</code></pre>
    <h5>
     <a id="_885">
     </a>
     设置一维条码宽度
    </h5>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/fa01de2aad1548e598fc6b372a45399a.png"/>
    </p>
    <ul>
     <li>
      实例值
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">119</span><span class="token punctuation">,</span><span class="token number">3</span>
</code></pre>
    <h5>
     <a id="_897">
     </a>
     打印一维条码
    </h5>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/1665b624e8ac4461b58ec9c67270b326.png"/>
    </p>
    <p>
     这里分为 A 和 B两种情况，并且参数都有了，自己仔细观察。
    </p>
    <ul>
     <li>
      实例值
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">107</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">48</span>

<span class="token number">29</span><span class="token punctuation">,</span><span class="token number">107</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">48</span>
</code></pre>
    <pre><code class="prism language-java"><span class="token comment">// 打印一维码</span>
let instruct <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">104</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">119</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">,</span> <span class="token number">107</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">]</span>
<span class="token comment">// let instruct = [29, 72, 3, 29, 104, 255, 29, 119, 1, 29, 107, 65, 11, 50]</span>
let data <span class="token operator">=</span> <span class="token function">gbk</span><span class="token punctuation">(</span><span class="token string">"12345678901"</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="347_920">
     </a>
     3.4.7、二维码打印
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/9804592a3fcc428b9baf291d2fcce6c1.png"/>
    </p>
    <p>
     特别注意：这里的k计算出来是多个，那么二维码打印的内容必须就是多少个字节，如果k计算出来是2个字节，打印的内容才有1个或者3个字节都是错的。
    </p>
    <ul>
     <li>
      实例值
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">107</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span>
</code></pre>
    <pre><code class="prism language-js"><span class="token comment">// 打印二维码</span>
<span class="token keyword">let</span> instruct <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">29</span><span class="token punctuation">,</span><span class="token number">107</span><span class="token punctuation">,</span><span class="token number">97</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token comment">// 里面必须 2 个字节，一个汉字 2个字节</span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token function">gbk</span><span class="token punctuation">(</span><span class="token string">"12"</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     注意：这里如果是中文，那么将中文通过
     <code>
      gkb()
     </code>
     方法转换后，得到
     <code>
      GKB
     </code>
     编码的10进制，那么扫描出来的编码也是
     <code>
      GBK
     </code>
     ，二维码里面最好不要保存中文。或者不要进行GBK转码，直接获取10进制数组。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/a6361f65a7b54cf785538d53e20ceaab.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://img-blog.csdnimg.cn/b3023845ce2a414287c59e60bc5dea3c.png"/>
    </p>
    <h4>
     <a id="348_969">
     </a>
     3.4.8、完整案例
    </h4>
    <pre><code class="prism language-vue">&lt;template&gt;
	&lt;!-- 打印 --&gt;
	&lt;view class="print-box"&gt;
		&lt;!-- 操作区 --&gt;
		&lt;view class="operation-box"&gt;
			&lt;button @click="onPrint"&gt;打印&lt;/button&gt;
		&lt;/view&gt;
		&lt;!-- 显示连接蓝牙日志 --&gt;
		&lt;view class="connect-log"&gt;
			&lt;view v-for="(log,index) in connectLog" :key="index"&gt;{<!-- -->{log}}&lt;/view&gt;
		&lt;/view&gt;
	&lt;/view&gt;
&lt;/template&gt;

&lt;script&gt;
	import gbk from "./gbk.js"
	export default {
		data() {
			return {
				connectLog: [], // 日志
				deviceId: null, // 蓝牙设备的 deviceId
				// 这里的 serviceId 需要在 getBLEDeviceServices 接口中获取
				serviceId: null, // 蓝牙服务uuid
				// 这里的 characteristicId 需要在 getBLEDeviceCharacteristics 接口中获取
				characteristicId: null, // 蓝牙特征值uuid
			}
		},
		methods: {

			// 打印
			onPrint() {
				// 判断是否连接蓝牙，已连接直接打印，未连接就去连接。
				if (this.deviceId) {
					this.printData()
				} else {
					this.openBluetoothAdapter()
				}
			},

			// 第一步 在页面显示的时候判断是否已经初始化完成蓝牙适配器若成功，则开始查找设备
			openBluetoothAdapter() {
				let that = this
				// 初始化蓝牙
				uni.openBluetoothAdapter({
					success: (res) =&gt; {
						that.connectLog.push("初始化蓝牙成功")
						// 初始化完毕开始搜索
						that.StartBluetoothDeviceDiscovery()
					},
					fail: (res) =&gt; {
						that.connectLog.push("初始化蓝牙失败")
					}
				});
			},
			/**
			 * 第二步 在页面显示的时候判断是都已经初始化完成蓝牙适配器若成功，则开始查找设备
			 */
			StartBluetoothDeviceDiscovery() {
				let that = this
				uni.startBluetoothDevicesDiscovery({
					// services: ['0000FFE0'],
					success: res =&gt; {
						that.connectLog.push("查找设备")
						that.OnBluetoothDeviceFound();
					},
					fail: res =&gt; {
						that.connectLog.push("查找设备失败")
					}
				});
			},
			/**
			 * 第三步  发现外围设备
			 */
			OnBluetoothDeviceFound() {
				let that = this
				uni.onBluetoothDeviceFound(res =&gt; {
					res.devices.forEach(device =&gt; { //这一步就是去筛选找到的蓝牙中,有没有你匹配的名称
						that.connectLog.push(`查找到设备${device.name}`)
						if (device.name === "MPT-II") {
							// 连接蓝牙
							that.CreateBLEConnection(device)
							// 找到需要连接的蓝牙了，可以关闭蓝牙搜索了。
							that.StopBluetoothDevicesDiscovery()
						}
					})
				});
			},

			// 
			/**
			 * 第四步 停止搜索蓝牙设备
			 */
			StopBluetoothDevicesDiscovery() {
				let that = this
				uni.stopBluetoothDevicesDiscovery({
					success: res =&gt; {
						that.connectLog.push("关闭蓝牙搜索")
						console.log("第四步 找到匹配的蓝牙后就关掉蓝牙搜寻:", JSON.stringify(res))
					},
					fail: res =&gt; {
						that.connectLog.push("关闭蓝牙搜索失败")
						console.log('第四步 停止搜索蓝牙设备失败，错误码：' + res.errCode);
					}
				});
			},
			// 第五步 创建蓝牙连接,连接低功耗蓝牙设备
			CreateBLEConnection(item) {
				let that = this
				that.connectLog.push("创建蓝牙连接" + item.name)
				uni.createBLEConnection({ //创建蓝牙连接,连接低功耗蓝牙设备
					deviceId: item.deviceId, //传入刚刚获取的uuid
					success(res) {
						that.connectLog.push("蓝牙连接成功")
						that.GetBLEDeviceServices(item.deviceId) //获取蓝牙设备所有服务(service)。
					},
					fail(res) {
						that.connectLog.push("蓝牙连接失败")
					}
				})
			},

			//第六步 获取蓝牙设备所有服务(service)。
			GetBLEDeviceServices(deviceId) {
				let that = this
				that.connectLog.push("开始搜索蓝牙服务")
				setTimeout(() =&gt; {
					uni.getBLEDeviceServices({ //获取蓝牙设备所有服务
						deviceId: deviceId,
						success(res) { //为什么要用延时,因为不用延时就拿不到所有的服务,在上一步,连接低功耗蓝牙
							//设备的时候,需要一个600-1000毫秒的时间后,再去获取设备所有服务,不给延时就会一直返回错误码10004
							console.log("蓝牙可用服务：", res)
							that.connectLog.push("搜索到蓝牙服务")
							that.GetBLEDeviceCharacteristics(deviceId, res) //获取蓝牙设备某个服务中所有特征值
						},
						fail(res) {
							that.connectLog.push("搜索蓝牙服务失败")
							console.log("搜索蓝牙服务失败：", res)
						}
					})
				}, 1000)
			},
			// 第七步 获取蓝牙特征值
			GetBLEDeviceCharacteristics(deviceId, item) {
				let that = this
				that.connectLog.push("开始获取蓝牙特征值")
				// 获取当前连接这个蓝牙的可用服务
				setTimeout(() =&gt; {
					item.services.forEach((services) =&gt; {
						console.log("服务：", services)
						uni.getBLEDeviceCharacteristics({ //获取蓝牙设备某个服务中所有特征值
							deviceId: deviceId,
							serviceId: services.uuid, //这个serviceId可以在上一步获取中拿到,也可以在
							success(res) {
								that.connectLog.push("蓝牙特征值获取成功")
								console.log("特征值", res)
								// 循环筛选蓝牙特征值，筛选到符合打印机的特征值为止
								res.characteristics.forEach((ch) =&gt; {
									// 判断是否支持打印机
									if (ch.properties.write) {
										// 连接蓝牙最终就是使用者三个值。
										// console.log("蓝牙设备deviceId：", deviceId)
										// console.log("使用蓝牙服务uuid:", services.uuid)
										// console.log("特征值uuid：", ch.uuid)
										that.deviceId = deviceId
										that.serviceId = services.uuid
										that.characteristicId = ch.uuid
										// 这里不能结束最外层循环，就让他全部循环完成把，反正也不多。
										that.connectLog.push("找打符合条件特征值")
										return
									}
								})
							},
							fail(res) {
								that.connectLog.push("蓝牙特征值获取失败")
								console.log("获取蓝牙设备某个服务中所有特征值失败:", JSON.stringify(res))
							}
						})
					})
				}, 2000)
			},
			// 第八步 发送二进制数据
			WriteBLECharacteristicValue() {
				// return
				let that = this
				// 打印的内容
				uni.writeBLECharacteristicValue({
					// 蓝牙设备 deviceId
					deviceId: that.deviceId,
					// 蓝牙服务uuid
					serviceId: that.serviceId,
					// 蓝牙特征值uuid
					characteristicId: that.characteristicId,
					// 打印的数据，ArrayBuffer 类型，数据为 10进制或者16进制。编码方式：GBK
					value: [27, 100, 60],
					success(res) {
						console.log("打印成功")
					},
					fail(res) {
						console.log("打印失败", res)
					}
				})
			},
			printData() {
				// 打印的数据
				let command = []
				// 打印的数据，这里的 \r\n表示换行，必须要进过转码
				// let data = gbk(
				// 	"这是打印的内容，我要写很多很多文字，然后打印出来看看看，什么行间距啊，什么间距啥的有没有设置好。如果没有设置好，自己看看到底是怪哪里，是我的编写问题，就更改。是厂商的问题，就寻找厂商。")
				// 设置行间距
				// let instruct = [27, 51, 255]

				// 设置行间距为默认 
				// let instruct = [27, 50]


				// 设置开始打印的位置
				// let instruct = [29, 33, 1, 29, 33, 16]
				// 字体恢复默认
				// let instruct = [29, 33, 0]
				// let data = gbk("这是打印的内容，反正是很多的那种，不止一行数据，自己看着办，结束。")

				// 居中字体
				// let instruct = [27, 97, 49]
				// 字体居中
				// let instruct = [27, 97, 1]
				// 字体居左
				// let instruct = [27, 97, 0]
				// let data = gbk("字体居左")
				// 字体居右
				// let instruct = [27, 97, 1]
				// let data = gbk("字体居右")

				// // 打印一维码
				// let instruct = [29, 72, 2, 29, 104, 100, 29, 119, 6, 29, 107, 0, 48]
				// // let instruct = [29, 72, 3, 29, 104, 255, 29, 119, 1, 29, 107, 65, 11, 50]
				// let data = gbk("12345678901")
				
				// 打印二维码
				let instruct = [29,107,97,0,1,2,0]
				// 里面必须 2 个字节，一个汉字 2个字节
				let data = gbk("12")

				// 将打印指令增加到 打印的数据中
				instruct.forEach((d) =&gt; {
					command.push(d)
				})
				data.forEach((d) =&gt; {
					command.push(d)
				})
				command.push(27)
				command.push(100)
				command.push(2)
				// 这里打印的数据可能超过20个字符了，所有拆分批量打印。
				this.senBlData(this.deviceId, this.serviceId, this.characteristicId, command)
			},

			/**
			 * 拆分打印数据并打印，将uint8Array打印的数据拆分成，最多 20
			 * @param {Object} deviceId 蓝牙设备deviceId
			 * @param {Object} serviceId 服务uuid
			 * @param {Object} characteristicId 蓝牙特征值uuid
			 * @param {Object} uint8Array 打印数据
			 */
			senBlData(deviceId, serviceId, characteristicId, uint8Array) {
				var that = this;
				console.log('************deviceId = [' + deviceId + ']  serviceId = [' + serviceId +
					'] characteristics=[' + characteristicId + "]")
				var uint8Buf = Array.from(uint8Array);

				function split_array(datas, size) {
					var result = {};
					var j = 0
					for (var i = 0; i &lt; datas.length; i += size) {
						result[j] = datas.slice(i, i + size)
						j++
					}
					console.log(result)
					return result
				}
				var sendloop = split_array(uint8Buf, 20);

				function realWriteData(sendloop, i) {
					var data = sendloop[i]
					if (typeof(data) == "undefined") {
						return
					}
					console.log("第【" + i + "】次写数据" + data)
					var buffer = new ArrayBuffer(data.length)
					var dataView = new DataView(buffer)
					for (var j = 0; j &lt; data.length; j++) {
						dataView.setUint8(j, data[j]);
					}
					// 调动打印机打印
					uni.writeBLECharacteristicValue({
						deviceId,
						serviceId,
						characteristicId,
						value: buffer, // 打印的数据，ArrayBuffer 类型，数据为 10进制或者16进制。编码方式：GBK
						success(res) {
							realWriteData(sendloop, i + 1);
						},
						fail(e) {
							console.log("点错误：", e)
							realWriteData(sendloop, i + 1);
						}
					})
				}
				var i = 0;
				realWriteData(sendloop, i);
			},
		}
	}
&lt;/script&gt;

&lt;style lang="scss"&gt;
	.print-box {
		display: flex;

		.operation-box {
			width: 70%;
			overflow: auto;

			.device-box {
				background-color: #8d98cc;
				margin: 20rpx;
			}

			.services-css {
				margin: 20rpx;
				background-color: #8d98cc;

				.char-css {
					margin: 20rpx;
					background-color: #ffffdc;
				}
			}
		}

		.connect-log {
			display: flex;
			flex-direction: column;
			position: sticky;
			top: 0;
			width: 30%;
			color: #fff;
			height: 100vh;
			overflow: auto;
			background-color: rgba(0, 0, 0, 0.2);
		}
	}
&lt;/style&gt;

</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34313835333434372f:61727469636c652f64657461696c732f313436303532313839" class_="artid" style="display:none">
 </p>
</div>


