---
layout: post
title: "Python实战进阶No18-使用-Apache-Spark-进行分布式计算"
date: 2025-03-09 20:16:57 +0800
description: "本文深入解析Apache Spark分布式计算的核心机制，从依赖关系优化到流批一体处理，结合实时推荐系统和社交网络分析实战案例。通过可视化RDD依赖关系图、Catalyst优化器流程图，配合完整可运行的代码示例（含输入输出），帮助开发者掌握大规模数据处理的核心技术。扩展部分探讨云原生部署和数据湖事务支持，为构建企业级大数据系统提供完整解决方案。"
keywords: "《Python实战进阶》No18: 使用 Apache Spark 进行分布式计算"
categories: ['Python']
tags: ['Spark', 'Python', 'Apache']
artid: "146137693"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146137693
    alt: "Python实战进阶No18-使用-Apache-Spark-进行分布式计算"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146137693
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146137693
cover: https://bing.ee123.net/img/rand?artid=146137693
image: https://bing.ee123.net/img/rand?artid=146137693
img: https://bing.ee123.net/img/rand?artid=146137693
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     《Python实战进阶》No18: 使用 Apache Spark 进行分布式计算
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="No18__Apache_Spark__1">
     </a>
     No18: 使用 Apache Spark 进行分布式计算
    </h2>
    <hr/>
    <h3>
     <a id="_5">
     </a>
     摘要
    </h3>
    <p>
     本文深入解析Apache Spark分布式计算的核心机制，从依赖关系优化到流批一体处理，结合实时推荐系统和社交网络分析实战案例。通过可视化RDD依赖关系图、Catalyst优化器流程图，配合完整可运行的代码示例（含输入输出），帮助开发者掌握大规模数据处理的核心技术。扩展部分探讨云原生部署和数据湖事务支持，为构建企业级大数据系统提供完整解决方案。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c78a87fbed0340709659cd1c2414ca73.jpeg#pic_center"/>
    </p>
    <hr/>
    <h3>
     <a id="_11">
     </a>
     核心概念
    </h3>
    <h4>
     <a id="1__vs__13">
     </a>
     1. 宽依赖 vs 窄依赖（性能影响）
    </h4>
    <ul>
     <li>
      <strong>
       窄依赖
      </strong>
      ：每个父分区对应单个子分区（如map/filter）
     </li>
     <li>
      <strong>
       宽依赖
      </strong>
      ：父分区可能被多个子分区依赖（如groupByKey/join）
     </li>
    </ul>
    <pre><code class="prism language-python"><span class="token comment"># 窄依赖示例</span>
rdd <span class="token operator">=</span> sc<span class="token punctuation">.</span>parallelize<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
squared <span class="token operator">=</span> rdd<span class="token punctuation">.</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 父子分区1:1</span>

<span class="token comment"># 宽依赖示例</span>
grouped <span class="token operator">=</span> squared<span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x<span class="token operator">%</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 触发shuffle</span>
</code></pre>
    <h4>
     <a id="2_Catalyst_27">
     </a>
     2. Catalyst优化器
    </h4>
    <p>
     通过四个阶段优化查询计划：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql <span class="token keyword">import</span> SparkSession

spark <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder<span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>
df <span class="token operator">=</span> spark<span class="token punctuation">.</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token string">"id &gt; 500"</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>explain<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 查看优化后的物理计划</span>
</code></pre>
    <h4>
     <a id="3__38">
     </a>
     3. 动态资源分配
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># spark-defaults.conf配置</span>
spark<span class="token punctuation">.</span>dynamicAllocation<span class="token punctuation">.</span>enabled true
spark<span class="token punctuation">.</span>shuffle<span class="token punctuation">.</span>service<span class="token punctuation">.</span>enabled true
spark<span class="token punctuation">.</span>dynamicAllocation<span class="token punctuation">.</span>minExecutors <span class="token number">2</span>
spark<span class="token punctuation">.</span>dynamicAllocation<span class="token punctuation">.</span>maxExecutors <span class="token number">20</span>
</code></pre>
    <h4>
     <a id="4_Structured_Streaming_47">
     </a>
     4. Structured Streaming微批处理
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># 实时词频统计</span>
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions <span class="token keyword">import</span> <span class="token operator">*</span>

lines <span class="token operator">=</span> <span class="token punctuation">(</span>spark<span class="token punctuation">.</span>readStream
         <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"host"</span><span class="token punctuation">,</span> <span class="token string">"localhost"</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"port"</span><span class="token punctuation">,</span> <span class="token number">9999</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

word_counts <span class="token operator">=</span> lines<span class="token punctuation">.</span>select<span class="token punctuation">(</span>explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span>lines<span class="token punctuation">.</span>value<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"word"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \
                   <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">"word"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>

query <span class="token operator">=</span> <span class="token punctuation">(</span>word_counts<span class="token punctuation">.</span>writeStream
         <span class="token punctuation">.</span>outputMode<span class="token punctuation">(</span><span class="token string">"complete"</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"console"</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_69">
     </a>
     实战案例
    </h3>
    <h4>
     <a id="1__71">
     </a>
     1. 实时推荐系统
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># 模拟用户行为数据</span>
<span class="token comment"># 安装依赖</span>
<span class="token comment"># pip install pyspark==3.3.0 delta-spark==2.2.0 kafka-python</span>

<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql <span class="token keyword">import</span> SparkSession
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions <span class="token keyword">import</span> from_json<span class="token punctuation">,</span> col
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types <span class="token keyword">import</span> StructType<span class="token punctuation">,</span> StructField<span class="token punctuation">,</span> StringType<span class="token punctuation">,</span> IntegerType<span class="token punctuation">,</span> TimestampType
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>ml<span class="token punctuation">.</span>recommendation <span class="token keyword">import</span> ALS

<span class="token comment"># 创建Spark会话</span>
spark <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder \
    <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token string">"StreamingDemo"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">"spark.jars.packages"</span><span class="token punctuation">,</span> <span class="token string">"io.delta:delta-core_2.12:2.2.0,org.apache.spark:spark-sql-kafka-0-10_2.12:3.3.0"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">"spark.sql.extensions"</span><span class="token punctuation">,</span> <span class="token string">"io.delta.sql.DeltaSparkSessionExtension"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">"spark.sql.catalog.spark_catalog"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.spark.sql.delta.catalog.DeltaCatalog"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 定义数据模式</span>
schema <span class="token operator">=</span> StructType<span class="token punctuation">(</span><span class="token punctuation">[</span>
    StructField<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> TimestampType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 读取流数据</span>
stream_df <span class="token operator">=</span> <span class="token punctuation">(</span>spark<span class="token punctuation">.</span>readStream
             <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"kafka"</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"kafka.bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"subscribe"</span><span class="token punctuation">,</span> <span class="token string">"sensor_data"</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>selectExpr<span class="token punctuation">(</span><span class="token string">"CAST(value AS STRING) as json"</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>select<span class="token punctuation">(</span>from_json<span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">"data.*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 处理流数据</span>
processed_df <span class="token operator">=</span> stream_df<span class="token punctuation">.</span>withWatermark<span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> <span class="token string">"10 minutes"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>col<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
             col<span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cast<span class="token punctuation">(</span><span class="token string">"date"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"date"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>agg<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token string">"avg"</span><span class="token punctuation">}</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>withColumnRenamed<span class="token punctuation">(</span><span class="token string">"avg(value)"</span><span class="token punctuation">,</span> <span class="token string">"avg_value"</span><span class="token punctuation">)</span>

<span class="token comment"># 输出到控制台（用于调试）</span>
query <span class="token operator">=</span> <span class="token punctuation">(</span>processed_df<span class="token punctuation">.</span>writeStream
         <span class="token punctuation">.</span>outputMode<span class="token punctuation">(</span><span class="token string">"complete"</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"console"</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"truncate"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 等待查询终止</span>
query<span class="token punctuation">.</span>awaitTermination<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 实时训练ALS模型</span>
als <span class="token operator">=</span> ALS<span class="token punctuation">(</span>maxIter<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span> regParam<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> userCol<span class="token operator">=</span><span class="token string">"user"</span><span class="token punctuation">,</span> itemCol<span class="token operator">=</span><span class="token string">"item"</span><span class="token punctuation">,</span> ratingCol<span class="token operator">=</span><span class="token string">"rating"</span><span class="token punctuation">)</span>
model <span class="token operator">=</span> als<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>stream_df<span class="token punctuation">)</span>  <span class="token comment"># 实际需使用checkpoint机制</span>

<span class="token comment"># 输出预测结果</span>
predictions <span class="token operator">=</span> model<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>stream_df<span class="token punctuation">)</span>
query <span class="token operator">=</span> predictions<span class="token punctuation">.</span>writeStream<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"console"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="2_GraphFrames_133">
     </a>
     2. 社交网络图分析（GraphFrames）
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">from</span> graphframes <span class="token keyword">import</span> <span class="token operator">*</span>

<span class="token comment"># 构建社交关系图</span>
vertices <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">"Charlie"</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"age"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

edges <span class="token operator">=</span> spark<span class="token punctuation">.</span>createDataFrame<span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token string">"friend"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">(</span><span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token string">"Charlie"</span><span class="token punctuation">,</span> <span class="token string">"follow"</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"src"</span><span class="token punctuation">,</span> <span class="token string">"dst"</span><span class="token punctuation">,</span> <span class="token string">"type"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

g <span class="token operator">=</span> GraphFrame<span class="token punctuation">(</span>vertices<span class="token punctuation">,</span> edges<span class="token punctuation">)</span>

<span class="token comment"># PageRank计算</span>
results <span class="token operator">=</span> g<span class="token punctuation">.</span>pageRank<span class="token punctuation">(</span>resetProbability<span class="token operator">=</span><span class="token number">0.15</span><span class="token punctuation">,</span> maxIter<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
results<span class="token punctuation">.</span>vertices<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">"""
输出：
+-------+---+------------------+
|     id|age|          pagerank|
+-------+---+------------------+
|  Alice| 34| 0.456789456123...|
|    Bob| 36| 0.321456987456...|
|Charlie| 25| 0.221457896325...|
+-------+---+------------------+
"""</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_168">
     </a>
     扩展思考
    </h3>
    <h4>
     <a id="1_Spark_on_Kubernetes_170">
     </a>
     1. Spark on Kubernetes
    </h4>
    <pre><code class="prism language-yaml"><span class="token comment"># spark-submit配置示例</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> sparkoperator.k8s.io/v1beta2
<span class="token key atrule">kind</span><span class="token punctuation">:</span> SparkApplication
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> spark<span class="token punctuation">-</span>pi
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> Scala
  <span class="token key atrule">mode</span><span class="token punctuation">:</span> cluster
  <span class="token key atrule">image</span><span class="token punctuation">:</span> gcr.io/spark<span class="token punctuation">-</span>operator/spark<span class="token punctuation">:</span>v3.1.1
  <span class="token key atrule">mainClass</span><span class="token punctuation">:</span> org.apache.spark.examples.SparkPi
  <span class="token key atrule">mainApplicationFile</span><span class="token punctuation">:</span> local<span class="token punctuation">:</span>///opt/spark/examples/jars/spark<span class="token punctuation">-</span>examples_2.12<span class="token punctuation">-</span>3.1.1.jar
  <span class="token key atrule">driver</span><span class="token punctuation">:</span>
    <span class="token key atrule">cores</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"512m"</span>
  <span class="token key atrule">executor</span><span class="token punctuation">:</span>
    <span class="token key atrule">cores</span><span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token key atrule">instances</span><span class="token punctuation">:</span> <span class="token number">2</span>
    <span class="token key atrule">memory</span><span class="token punctuation">:</span> <span class="token string">"512m"</span>
</code></pre>
    <h4>
     <a id="2_Delta_Lake_192">
     </a>
     2. Delta Lake事务支持
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># 启用Delta Lake</span>
<span class="token keyword">from</span> delta <span class="token keyword">import</span> DeltaTable

<span class="token comment"># 写入事务日志</span>
data <span class="token operator">=</span> spark<span class="token punctuation">.</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
data<span class="token punctuation">.</span>write<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"delta"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"/tmp/delta_table"</span><span class="token punctuation">)</span>

<span class="token comment"># 版本回滚</span>
deltaTable <span class="token operator">=</span> DeltaTable<span class="token punctuation">.</span>forPath<span class="token punctuation">(</span>spark<span class="token punctuation">,</span> <span class="token string">"/tmp/delta_table"</span><span class="token punctuation">)</span>
deltaTable<span class="token punctuation">.</span>restoreToVersion<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment"># Schema演化</span>
data<span class="token punctuation">.</span>withColumn<span class="token punctuation">(</span><span class="token string">"new_col"</span><span class="token punctuation">,</span> lit<span class="token punctuation">(</span><span class="token string">"abc"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>write<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"delta"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>mode<span class="token punctuation">(</span><span class="token string">"append"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"mergeSchema"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">"/tmp/delta_table"</span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_215">
     </a>
     完整代码集成
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># 安装依赖</span>
<span class="token comment"># pip install pyspark==3.3.0 delta-spark==2.2.0 kafka-python</span>

<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql <span class="token keyword">import</span> SparkSession
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>functions <span class="token keyword">import</span> from_json
<span class="token keyword">from</span> delta<span class="token punctuation">.</span>tables <span class="token keyword">import</span> DeltaTable
<span class="token keyword">from</span> pyspark<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>types <span class="token keyword">import</span> StructType<span class="token punctuation">,</span> StructField<span class="token punctuation">,</span> StringType<span class="token punctuation">,</span> IntegerType

<span class="token comment"># 创建Spark会话</span>
spark <span class="token operator">=</span> SparkSession<span class="token punctuation">.</span>builder \
    <span class="token punctuation">.</span>appName<span class="token punctuation">(</span><span class="token string">"DeltaLakeDemo"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">"spark.jars.packages"</span><span class="token punctuation">,</span> <span class="token string">"io.delta:delta-core_2.12:2.2.0"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">"spark.sql.extensions"</span><span class="token punctuation">,</span> <span class="token string">"io.delta.sql.DeltaSparkSessionExtension"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>config<span class="token punctuation">(</span><span class="token string">"spark.sql.catalog.spark_catalog"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.spark.sql.delta.catalog.DeltaCatalog"</span><span class="token punctuation">)</span> \
    <span class="token punctuation">.</span>getOrCreate<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 定义数据模式</span>
schema <span class="token operator">=</span> StructType<span class="token punctuation">(</span><span class="token punctuation">[</span>
    StructField<span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"category"</span><span class="token punctuation">,</span> StringType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    StructField<span class="token punctuation">(</span><span class="token string">"price"</span><span class="token punctuation">,</span> IntegerType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 流式数据写入Delta Lake</span>
stream_df <span class="token operator">=</span> <span class="token punctuation">(</span>spark<span class="token punctuation">.</span>readStream
             <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"kafka"</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"kafka.bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"subscribe"</span><span class="token punctuation">,</span> <span class="token string">"raw_data"</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>selectExpr<span class="token punctuation">(</span><span class="token string">"CAST(value AS STRING) as json"</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>select<span class="token punctuation">(</span>from_json<span class="token punctuation">(</span><span class="token string">"json"</span><span class="token punctuation">,</span> schema<span class="token punctuation">)</span><span class="token punctuation">.</span>alias<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
             <span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">"data.*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 使用事务写入</span>
query <span class="token operator">=</span> <span class="token punctuation">(</span>stream_df<span class="token punctuation">.</span>writeStream
         <span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token string">"delta"</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span>outputMode<span class="token punctuation">(</span><span class="token string">"append"</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span>option<span class="token punctuation">(</span><span class="token string">"checkpointLocation"</span><span class="token punctuation">,</span> <span class="token string">"/tmp/checkpoint"</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token string">"/tmp/delta_lake"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 批量分析</span>
delta_table <span class="token operator">=</span> DeltaTable<span class="token punctuation">.</span>forPath<span class="token punctuation">(</span>spark<span class="token punctuation">,</span> <span class="token string">"/tmp/delta_lake"</span><span class="token punctuation">)</span>
delta_table<span class="token punctuation">.</span>toDF<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span><span class="token string">"category"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 输出示例：</span>
<span class="token triple-quoted-string string">"""
+----------+-----+
|  category|count|
+----------+-----+
|electronics|   45|
|     books|   30|
+----------+-----+
"""</span>
</code></pre>
    <hr/>
    <p>
     通过本文的学习，您应该能够：
    </p>
    <ol>
     <li>
      优化Spark作业的依赖关系和资源分配
     </li>
     <li>
      实现流批一体的数据处理管道
     </li>
     <li>
      构建实时推荐系统和图分析应用
     </li>
     <li>
      掌握云原生部署和数据湖事务管理
     </li>
    </ol>
    <pre><code></code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f7977656e6731382f:61727469636c652f64657461696c732f313436313337363933" class_="artid" style="display:none">
 </p>
</div>


