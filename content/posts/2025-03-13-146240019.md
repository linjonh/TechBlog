---
layout: post
title: "Python带多组标签的Snowflake-SQL查询批量数据导出程序"
date: 2025-03-13 19:14:01 +0800
description: "设计一个基于多个带标签Snowflake SQL语句作为json配置文件的Python代码程序，实现根据不同的输入参数自动批量地将Snowflake数据库的数据导出为CSV文件到本地目录上，标签加扩展名.csv为导出数据文件名，文件已经存在则覆盖原始文件。"
keywords: "Python带多组标签的Snowflake SQL查询批量数据导出程序"
categories: ['未分类']
tags: ['开发语言', 'Sql', 'Python']
artid: "146240019"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146240019
    alt: "Python带多组标签的Snowflake-SQL查询批量数据导出程序"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146240019
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146240019
cover: https://bing.ee123.net/img/rand?artid=146240019
image: https://bing.ee123.net/img/rand?artid=146240019
img: https://bing.ee123.net/img/rand?artid=146240019
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Python带多组标签的Snowflake SQL查询批量数据导出程序
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     设计一个基于多个带标签Snowflake SQL语句作为json配置文件的Python代码程序，实现根据不同的输入参数自动批量地将Snowflake数据库的数据导出为CSV文件到本地目录上，标签加扩展名.csv为导出数据文件名，文件已经存在则覆盖原始文件。使用Python Snowflake Connector，需要考虑SQL结果集是大数据量分批数据导出的情况，通过多线程和异步操作来提高程序性能，程序需要异常处理和输出，输出出错时的错误信息，每次每个查询导出数据的运行状态和表数据行数以及运行时间戳，导出时间，输出每个文件记录数量的日志。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> argparse
<span class="token keyword">import</span> csv
<span class="token keyword">import</span> json
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> os
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">import</span> snowflake<span class="token punctuation">.</span>connector
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Optional

<span class="token comment"># 日志配置</span>
logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>
    level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span>
    <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">"%(asctime)s - %(levelname)s - %(message)s"</span><span class="token punctuation">,</span>
    handlers<span class="token operator">=</span><span class="token punctuation">[</span>
        logging<span class="token punctuation">.</span>FileHandler<span class="token punctuation">(</span><span class="token string">"data_export.log"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        logging<span class="token punctuation">.</span>StreamHandler<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">)</span>
logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">SnowflakeExporter</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> config<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> output_dir<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"./output"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>snowflake_config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"user"</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"SNOWFLAKE_USER"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"password"</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"SNOWFLAKE_PASSWORD"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"account"</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"SNOWFLAKE_ACCOUNT"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"warehouse"</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"SNOWFLAKE_WAREHOUSE"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"database"</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"SNOWFLAKE_DATABASE"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"schema"</span><span class="token punctuation">:</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"SNOWFLAKE_SCHEMA"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>output_dir <span class="token operator">=</span> output_dir
        os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>self<span class="token punctuation">.</span>output_dir<span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        
    <span class="token keyword">def</span> <span class="token function">_get_file_path</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> label<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>output_dir<span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>label<span class="token punctuation">}</span></span><span class="token string">.csv"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_export_query</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query_config<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span><span class="token punctuation">:</span>
        label <span class="token operator">=</span> query_config<span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span>
        sql <span class="token operator">=</span> query_config<span class="token punctuation">[</span><span class="token string">"sql"</span><span class="token punctuation">]</span>
        params <span class="token operator">=</span> query_config<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"params"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        file_path <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_file_path<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
        
        start_time <span class="token operator">=</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
        total_rows <span class="token operator">=</span> <span class="token number">0</span>
        status <span class="token operator">=</span> <span class="token string">"SUCCESS"</span>
        error_msg <span class="token operator">=</span> <span class="token boolean">None</span>
        
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            conn <span class="token operator">=</span> snowflake<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token operator">**</span>self<span class="token punctuation">.</span>snowflake_config<span class="token punctuation">)</span>
            cursor <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Executing query for [</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>label<span class="token punctuation">}</span></span><span class="token string">]"</span></span><span class="token punctuation">)</span>
            cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
            
            <span class="token comment"># 获取列信息</span>
            columns <span class="token operator">=</span> <span class="token punctuation">[</span>col<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">for</span> col <span class="token keyword">in</span> cursor<span class="token punctuation">.</span>description<span class="token punctuation">]</span>
            
            <span class="token comment"># 初始化文件写入</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">,</span> newline<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                writer <span class="token operator">=</span> csv<span class="token punctuation">.</span>writer<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
                writer<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span>columns<span class="token punctuation">)</span>
                
                <span class="token comment"># 分批处理数据</span>
                <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                    rows <span class="token operator">=</span> cursor<span class="token punctuation">.</span>fetchmany<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token keyword">not</span> rows<span class="token punctuation">:</span>
                        <span class="token keyword">break</span>
                    writer<span class="token punctuation">.</span>writerows<span class="token punctuation">(</span>rows<span class="token punctuation">)</span>
                    total_rows <span class="token operator">+=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>rows<span class="token punctuation">)</span>
                    
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            status <span class="token operator">=</span> <span class="token string">"FAILED"</span>
            error_msg <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error exporting </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>label<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>error_msg<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> exc_info<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            
        <span class="token keyword">finally</span><span class="token punctuation">:</span>
            cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            duration <span class="token operator">=</span> <span class="token punctuation">(</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span><span class="token punctuation">.</span>total_seconds<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 记录日志</span>
            log_entry <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"timestamp"</span><span class="token punctuation">:</span> datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isoformat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"label"</span><span class="token punctuation">:</span> label<span class="token punctuation">,</span>
                <span class="token string">"status"</span><span class="token punctuation">:</span> status<span class="token punctuation">,</span>
                <span class="token string">"file_path"</span><span class="token punctuation">:</span> file_path<span class="token punctuation">,</span>
                <span class="token string">"rows_exported"</span><span class="token punctuation">:</span> total_rows<span class="token punctuation">,</span>
                <span class="token string">"duration_seconds"</span><span class="token punctuation">:</span> <span class="token builtin">round</span><span class="token punctuation">(</span>duration<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token string">"error_message"</span><span class="token punctuation">:</span> error_msg
            <span class="token punctuation">}</span>
            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>log_entry<span class="token punctuation">,</span> indent<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">execute_export</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> queries<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Dict<span class="token punctuation">]</span><span class="token punctuation">,</span> max_workers<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span>max_workers<span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
            futures <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> query <span class="token keyword">in</span> queries<span class="token punctuation">:</span>
                futures<span class="token punctuation">.</span>append<span class="token punctuation">(</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_export_query<span class="token punctuation">,</span> query<span class="token punctuation">)</span><span class="token punctuation">)</span>
                
            <span class="token keyword">for</span> future <span class="token keyword">in</span> futures<span class="token punctuation">:</span>
                <span class="token keyword">try</span><span class="token punctuation">:</span>
                    future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                    logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Thread execution error: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span><span class="token string">"Snowflake Data Exporter"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--config"</span><span class="token punctuation">,</span> required<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Path to JSON config file"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--output-dir"</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">"./output"</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Output directory"</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">"--labels"</span><span class="token punctuation">,</span> nargs<span class="token operator">=</span><span class="token string">"+"</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">"Filter queries by labels"</span><span class="token punctuation">)</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 加载配置文件</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>config<span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        config_data <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    
    <span class="token comment"># 过滤查询配置</span>
    queries <span class="token operator">=</span> config_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"queries"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> args<span class="token punctuation">.</span>labels<span class="token punctuation">:</span>
        queries <span class="token operator">=</span> <span class="token punctuation">[</span>q <span class="token keyword">for</span> q <span class="token keyword">in</span> queries <span class="token keyword">if</span> q<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"label"</span><span class="token punctuation">)</span> <span class="token keyword">in</span> args<span class="token punctuation">.</span>labels<span class="token punctuation">]</span>
    
    <span class="token comment"># 执行导出</span>
    exporter <span class="token operator">=</span> SnowflakeExporter<span class="token punctuation">(</span>config_data<span class="token punctuation">,</span> args<span class="token punctuation">.</span>output_dir<span class="token punctuation">)</span>
    exporter<span class="token punctuation">.</span>execute_export<span class="token punctuation">(</span>queries<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_132">
     </a>
     程序说明
    </h4>
    <ol>
     <li>
      <strong>
       配置文件结构
      </strong>
      ：
     </li>
    </ol>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"queries"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"label"</span><span class="token operator">:</span> <span class="token string">"user_data"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"sql"</span><span class="token operator">:</span> <span class="token string">"SELECT * FROM users WHERE created_at &gt;= %(start_date)s"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"params"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"start_date"</span><span class="token operator">:</span> <span class="token string">"2023-01-01"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
    <ol start="2">
     <li>
      <strong>
       主要特性
      </strong>
      ：
     </li>
    </ol>
    <ul>
     <li>
      多线程处理：使用ThreadPoolExecutor实现并发导出
     </li>
     <li>
      分批处理：每次获取10,000条记录处理大数据
     </li>
     <li>
      自动重写文件：始终使用’w’模式打开文件
     </li>
     <li>
      详细日志：记录到文件和控制台，包含JSON格式的运行状态
     </li>
     <li>
      错误处理：捕获所有异常并记录详细信息
     </li>
     <li>
      参数化查询：防止SQL注入攻击
     </li>
     <li>
      环境变量：通过环境变量管理敏感信息
     </li>
    </ul>
    <ol start="3">
     <li>
      <strong>
       运行方式
      </strong>
      ：
     </li>
    </ol>
    <pre><code class="prism language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">SNOWFLAKE_USER</span><span class="token operator">=</span>your_user
<span class="token builtin class-name">export</span> <span class="token assign-left variable">SNOWFLAKE_PASSWORD</span><span class="token operator">=</span>your_password
python exporter.py <span class="token parameter variable">--config</span> queries.json --output-dir ./data <span class="token parameter variable">--labels</span> user_data sales_data
</code></pre>
    <ol start="4">
     <li>
      <strong>
       日志示例
      </strong>
      ：
     </li>
    </ol>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"timestamp"</span><span class="token operator">:</span> <span class="token string">"2023-10-10T15:30:45.123456"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"label"</span><span class="token operator">:</span> <span class="token string">"user_data"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"status"</span><span class="token operator">:</span> <span class="token string">"SUCCESS"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"file_path"</span><span class="token operator">:</span> <span class="token string">"./output/user_data.csv"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"rows_exported"</span><span class="token operator">:</span> <span class="token number">150000</span><span class="token punctuation">,</span>
  <span class="token string-property property">"duration_seconds"</span><span class="token operator">:</span> <span class="token number">12.34</span><span class="token punctuation">,</span>
  <span class="token string-property property">"error_message"</span><span class="token operator">:</span> <span class="token keyword">null</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_178">
     </a>
     优化点说明
    </h4>
    <ol>
     <li>
      <strong>
       内存管理
      </strong>
      ：
     </li>
    </ol>
    <ul>
     <li>
      使用服务器端游标分批获取数据（fetchmany）
     </li>
     <li>
      流式写入CSV文件，避免内存中保存完整结果集
     </li>
    </ul>
    <ol start="2">
     <li>
      <strong>
       并发控制
      </strong>
      ：
     </li>
    </ol>
    <ul>
     <li>
      通过ThreadPoolExecutor管理线程池
     </li>
     <li>
      默认5个worker（可根据硬件调整）
     </li>
    </ul>
    <ol start="3">
     <li>
      <strong>
       可观测性
      </strong>
      ：
     </li>
    </ol>
    <ul>
     <li>
      结构化日志记录
     </li>
     <li>
      精确的性能指标（持续时间、处理行数）
     </li>
     <li>
      错误堆栈信息记录
     </li>
    </ul>
    <ol start="4">
     <li>
      <strong>
       安全措施
      </strong>
      ：
     </li>
    </ol>
    <ul>
     <li>
      参数化查询防止SQL注入
     </li>
     <li>
      敏感信息通过环境变量传递
     </li>
     <li>
      自动清理资源（with语句保证连接关闭）
     </li>
    </ul>
    <p>
     可根据实际需求调整以下参数：
    </p>
    <ul>
     <li>
      fetchmany的批量大小（当前10,000）
     </li>
     <li>
      线程池大小（默认5）
     </li>
     <li>
      日志格式和详细程度
     </li>
     <li>
      文件编码方式（当前utf-8）
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f33303737373931332f:61727469636c652f64657461696c732f313436323430303139" class_="artid" style="display:none">
 </p>
</div>


