---
layout: post
title: "dockerollamaflaskmysql实现本地数据库读取操作"
date: 2025-03-12 18:22:47 +0800
description: "安装mysql后，使用自带的数据库表。"
keywords: "docker+ollama+flask+mysql实现本地数据库读取操作"
categories: ['未分类']
tags: ['数据库', 'Flask', 'Docker']
artid: "146206722"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146206722
    alt: "dockerollamaflaskmysql实现本地数据库读取操作"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146206722
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146206722
cover: https://bing.ee123.net/img/rand?artid=146206722
image: https://bing.ee123.net/img/rand?artid=146206722
img: https://bing.ee123.net/img/rand?artid=146206722
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     docker+ollama+flask+mysql实现本地数据库读取操作
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="1mysql_0">
     </a>
     1.安装mysql
    </h2>
    <p>
     安装mysql后，使用自带的数据库表
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d1cc4efcfa914d02a8be6c7ec6c3338f.png"/>
    </p>
    <h2>
     <a id="2_flask_3">
     </a>
     2. 使用flask，创建查询接口
    </h2>
    <p>
     文件目录
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/70da08007b934e5099f352d29d81b59b.png">
      <br/>
      config.py,配置数据库相关信息
     </img>
    </p>
    <pre><code class="prism language-python">MYSQL_HOST <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
MYSQL_PORT <span class="token operator">=</span> <span class="token number">3306</span>
MYSQL_USER <span class="token operator">=</span> <span class="token string">"root"</span>
MYSQL_PASSWD <span class="token operator">=</span> <span class="token string">"123456"</span>
MYSQL_DB <span class="token operator">=</span> <span class="token string">"world"</span>
</code></pre>
    <p>
     mysql_operate.py:创建mysql操作类
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> pymysql
<span class="token keyword">from</span> config<span class="token punctuation">.</span>config <span class="token keyword">import</span> MYSQL_HOST<span class="token punctuation">,</span> MYSQL_PORT<span class="token punctuation">,</span> MYSQL_USER<span class="token punctuation">,</span> MYSQL_PASSWD<span class="token punctuation">,</span> MYSQL_DB

<span class="token keyword">class</span> <span class="token class-name">MysqlDb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> user<span class="token punctuation">,</span> password<span class="token punctuation">,</span> db<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>conn <span class="token operator">=</span> pymysql<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span>host<span class="token punctuation">,</span>
                                    port<span class="token operator">=</span>port<span class="token punctuation">,</span>
                                    user<span class="token operator">=</span>user<span class="token punctuation">,</span>
                                    passwd<span class="token operator">=</span>password<span class="token punctuation">,</span>
                                    db<span class="token operator">=</span>db<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cursor <span class="token operator">=</span> self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">select_db</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>ping<span class="token punctuation">(</span>reconnect<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
        data <span class="token operator">=</span> self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> data

    <span class="token keyword">def</span> <span class="token function">__del__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">execute_db</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sql<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>ping<span class="token punctuation">(</span>reconnect<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>cursor<span class="token punctuation">.</span>execute<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token string">"插入成功"</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>conn<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token string">"error"</span>

db <span class="token operator">=</span> MysqlDb<span class="token punctuation">(</span>MYSQL_HOST<span class="token punctuation">,</span> MYSQL_PORT<span class="token punctuation">,</span> MYSQL_USER<span class="token punctuation">,</span> MYSQL_PASSWD<span class="token punctuation">,</span> MYSQL_DB<span class="token punctuation">)</span>

</code></pre>
    <p>
     app.py
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask
<span class="token keyword">from</span> flask <span class="token keyword">import</span> jsonify
<span class="token keyword">from</span> flask <span class="token keyword">import</span> request
<span class="token keyword">from</span> common <span class="token keyword">import</span> mysql_operate

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token string">'hello mysql'</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/query'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># put application's code here</span>
    <span class="token comment"># sql = "SELECT * FROM city"</span>
    data <span class="token operator">=</span> request<span class="token punctuation">.</span>get_json<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> data <span class="token keyword">or</span> <span class="token string">'sql'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> data<span class="token punctuation">:</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"sql语句是必须的"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    sql <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'sql'</span><span class="token punctuation">]</span>
    data <span class="token operator">=</span> mysql_operate<span class="token punctuation">.</span>db<span class="token punctuation">.</span>select_db<span class="token punctuation">(</span>sql<span class="token punctuation">)</span>
    <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span>data<span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>


</code></pre>
    <h2>
     <a id="3_difysql_82">
     </a>
     3. 在dify中创建sql工作流
    </h2>
    <p>
     1.创建空白工作流
     <br/>
     2.在开始模块中创建sql变量
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/124f3b95253049cc9fbd4a761f8edc85.png">
      <br/>
      3.创建http请求并修改相关参数
      <br/>
      修改请求方式未post
      <br/>
      修改请求地址，注意 127.0.0.1需要更改为host.docker.internal
      <br/>
      求改headers
      <br/>
      修改json数据
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/570aa6a6bbd64cc284ae92fec1e3f34e.png">
       3.进行模板转换
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c32e212684364eb0a0fdbab51dea0d74.png">
        <br/>
        4.添加结束节点
        <br/>
        选择上一步模板转换中的输出output，如果没有3，则直接选择http body也可以
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6a55f49575834d4b8db8e0d46b286aed.png">
         <br/>
         4.发布为工具
        </img>
       </img>
      </img>
     </img>
    </p>
    <h2>
     <a id="4agent_98">
     </a>
     4.创建agent
    </h2>
    <p>
     1.创建agent
     <br/>
     2.输入提示词
    </p>
    <pre><code class="prism language-bash"><span class="token comment">## 角色</span>
你是一个专业的数据分析专家，并且精通根据用户的问题，数据表接口进行生成sql语句进行查询数据库
<span class="token comment">## 背景</span>
根据用户问题，精确确定用户需求，首先查看数据表中的数据表结构，然后编写准确的并且可以直接执行的sql语句进行统计和查询数据库中的数据，并且返回相关数据，对于用户的工作效率提升十分重要
<span class="token comment">## 任务</span>
根据用户的相关问题，首先查询知识库查看大概的数据表结构，然后编写可执行的mysql语句并且调用’查询数据库‘工具进行查询数据库，用于最后满足用户的需求。对于用户需要查询数据库的需求务必调用’查询数据库‘工具。
<span class="token comment">## mysql语法提示</span>
如果需要子查询的话需要用如下语法
<span class="token keyword">select</span> * from table where <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">"beijing"</span>
<span class="token comment">## 首先进行下面的逻辑推理过程</span>
<span class="token number">1</span>.查询知识库了解数据库表结构
<span class="token number">2</span>.梳理和理解用户需求
<span class="token number">3</span>.分析这个需求需要编写多少sql语句
<span class="token number">4</span>.分析如何编写sql语句使得以最少的sql查询次数进行查询数据库
<span class="token number">5</span>.尝试编写仅仅一条或者5条内sql进行查询数据库
<span class="token number">6</span>.判断sql语句是否符合mysql语句的语法
<span class="token comment">## 提示</span>
调用查询数据库工具时，直接输入组装好的sql语句即可，不用输入字典
</code></pre>
    <p>
     3.添加知识库和工具
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f66647340a8e4836b5d844100f220308.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f4272756365426f726769612f:61727469636c652f64657461696c732f313436323036373232" class_="artid" style="display:none">
 </p>
</div>


