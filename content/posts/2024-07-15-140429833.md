---
layout: post
title: "云原生存储解决方案"
date: 2024-07-15 09:42:28 +0800
description: "云原生存储是指设计用于云原生环境中的存储解决方案，通常在容器化平台如Kubernetes上运行。它提"
keywords: "云原生存储解决方案"
categories: ['未分类']
tags: ['云原生']
artid: "140429833"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=140429833
  alt: "云原生存储解决方案"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=140429833
featuredImagePreview: https://bing.ee123.net/img/rand?artid=140429833
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     云原生存储解决方案
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_2">
     </a>
     云原生存储解决方案
    </h3>
    <p>
     使用Rook、Ceph等工具进行云原生存储管理
    </p>
    <h3>
     <a id="_6">
     </a>
     云原生存储简介
    </h3>
    <h4>
     <a id="_8">
     </a>
     什么是云原生存储
    </h4>
    <p>
     云原生存储是指设计用于云原生环境中的存储解决方案，通常在容器化平台如Kubernetes上运行。它提供了高可用性、弹性、可扩展性和自动化管理等特性，满足现代应用的存储需求。
    </p>
    <h4>
     <a id="_12">
     </a>
     云原生存储的重要性
    </h4>
    <ul>
     <li>
      <strong>
       动态环境支持
      </strong>
      ：云原生存储能够适应容器化应用的动态变化，提供灵活的存储资源管理。
     </li>
     <li>
      <strong>
       高可用性和持久性
      </strong>
      ：确保数据在容器重启或迁移时不丢失，保证业务的连续性。
     </li>
     <li>
      <strong>
       自动化管理
      </strong>
      ：通过自动化机制简化存储资源的配置和管理，减少人工干预。
     </li>
    </ul>
    <h3>
     <a id="RookCeph_18">
     </a>
     Rook和Ceph简介
    </h3>
    <h4>
     <a id="Rook_20">
     </a>
     什么是Rook
    </h4>
    <p>
     Rook是一个开源的云原生存储编排器，它将存储系统集成到Kubernetes中，通过Kubernetes原生API管理存储资源。Rook支持多种存储后端，包括Ceph、EdgeFS、CockroachDB等。
    </p>
    <h4>
     <a id="Ceph_24">
     </a>
     什么是Ceph
    </h4>
    <p>
     Ceph是一个开源的分布式存储系统，提供对象存储、块存储和文件系统存储。Ceph具有高可用性、可扩展性和强大的数据保护机制，被广泛应用于云计算和大数据领域。
    </p>
    <h4>
     <a id="RookCeph_28">
     </a>
     Rook与Ceph的关系
    </h4>
    <p>
     Rook通过操作员模式（Operator）管理Ceph集群，使得在Kubernetes中部署和管理Ceph变得更加简单和自动化。Rook操作员负责Ceph集群的安装、配置、升级和维护。
    </p>
    <h3>
     <a id="RookCeph_32">
     </a>
     安装和配置Rook和Ceph
    </h3>
    <h4>
     <a id="_34">
     </a>
     前提条件
    </h4>
    <ul>
     <li>
      一个运行中的Kubernetes集群（推荐使用1.18及以上版本）。
     </li>
     <li>
      已安装并配置好
      <code>
       kubectl
      </code>
      命令行工具。
     </li>
    </ul>
    <h4>
     <a id="_39">
     </a>
     安装步骤
    </h4>
    <ol>
     <li>
      <strong>
       安装Rook
      </strong>
     </li>
    </ol>
    <p>
     首先，克隆Rook的GitHub仓库：
    </p>
    <pre><code class="prism language-bash"><span class="token function">git</span> clone --single-branch <span class="token parameter variable">--branch</span> release-1.7 https://github.com/rook/rook.git
<span class="token builtin class-name">cd</span> rook/cluster/examples/kubernetes/ceph
</code></pre>
    <ol start="2">
     <li>
      <strong>
       部署Rook Operator
      </strong>
     </li>
    </ol>
    <pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> crds.yaml <span class="token parameter variable">-f</span> common.yaml <span class="token parameter variable">-f</span> operator.yaml
</code></pre>
    <ol start="3">
     <li>
      <strong>
       创建Ceph集群
      </strong>
     </li>
    </ol>
    <p>
     编辑
     <code>
      cluster.yaml
     </code>
     文件，根据需求配置Ceph集群：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> ceph.rook.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CephCluster
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">cephVersion</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> ceph/ceph<span class="token punctuation">:</span>v15.2.8
  <span class="token key atrule">dataDirHostPath</span><span class="token punctuation">:</span> /var/lib/rook
  <span class="token key atrule">mon</span><span class="token punctuation">:</span>
    <span class="token key atrule">count</span><span class="token punctuation">:</span> <span class="token number">3</span>
    <span class="token key atrule">allowMultiplePerNode</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
  <span class="token key atrule">dashboard</span><span class="token punctuation">:</span>
    <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">storage</span><span class="token punctuation">:</span>
    <span class="token key atrule">useAllNodes</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
    <span class="token key atrule">useAllDevices</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token key atrule">config</span><span class="token punctuation">:</span>
      <span class="token key atrule">databaseSizeMB</span><span class="token punctuation">:</span> <span class="token string">"1024"</span>
      <span class="token key atrule">journalSizeMB</span><span class="token punctuation">:</span> <span class="token string">"1024"</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">...</span>
</code></pre>
    <p>
     应用配置文件：
    </p>
    <pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> cluster.yaml
</code></pre>
    <h4>
     <a id="_91">
     </a>
     配置存储集群
    </h4>
    <p>
     创建存储类，供Kubernetes使用：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> storage.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StorageClass
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>block
<span class="token key atrule">provisioner</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph.rbd.csi.ceph.com
<span class="token key atrule">parameters</span><span class="token punctuation">:</span>
  <span class="token key atrule">clusterID</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
  <span class="token key atrule">pool</span><span class="token punctuation">:</span> replicapool
  <span class="token key atrule">imageFormat</span><span class="token punctuation">:</span> <span class="token string">"2"</span>
  <span class="token key atrule">imageFeatures</span><span class="token punctuation">:</span> layering
  <span class="token key atrule">csi.storage.k8s.io/fstype</span><span class="token punctuation">:</span> xfs
<span class="token key atrule">reclaimPolicy</span><span class="token punctuation">:</span> Retain
<span class="token key atrule">allowVolumeExpansion</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
</code></pre>
    <p>
     应用存储类配置：
    </p>
    <pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> storageclass.yaml
</code></pre>
    <h3>
     <a id="_117">
     </a>
     基本使用方法
    </h3>
    <h4>
     <a id="_119">
     </a>
     创建和管理存储池
    </h4>
    <ol>
     <li>
      <strong>
       创建存储池
      </strong>
     </li>
    </ol>
    <p>
     编辑
     <code>
      pool.yaml
     </code>
     文件：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> ceph.rook.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> CephBlockPool
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> replicapool
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicated</span><span class="token punctuation">:</span>
    <span class="token key atrule">size</span><span class="token punctuation">:</span> <span class="token number">3</span>
</code></pre>
    <p>
     应用配置文件：
    </p>
    <pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> pool.yaml
</code></pre>
    <h4>
     <a id="_142">
     </a>
     创建和管理存储卷
    </h4>
    <ol>
     <li>
      <strong>
       创建PVC
      </strong>
     </li>
    </ol>
    <p>
     编辑
     <code>
      pvc.yaml
     </code>
     文件：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolumeClaim
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>pvc
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>block
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> ReadWriteOnce
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
    <span class="token key atrule">requests</span><span class="token punctuation">:</span>
      <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
</code></pre>
    <p>
     应用PVC配置：
    </p>
    <pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> pvc.yaml
</code></pre>
    <ol start="2">
     <li>
      <strong>
       绑定PVC到Pod
      </strong>
     </li>
    </ol>
    <p>
     编辑
     <code>
      pod.yaml
     </code>
     文件：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>test<span class="token punctuation">-</span>pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>test<span class="token punctuation">-</span>container
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"sleep"</span><span class="token punctuation">,</span> <span class="token string">"1000000"</span> <span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> <span class="token string">"/mnt/ceph"</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>vol
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>vol
    <span class="token key atrule">persistentVolumeClaim</span><span class="token punctuation">:</span>
      <span class="token key atrule">claimName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>pvc
</code></pre>
    <p>
     应用Pod配置：
    </p>
    <pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> pod.yaml
</code></pre>
    <h4>
     <a id="_197">
     </a>
     监控和管理存储资源
    </h4>
    <ol>
     <li>
      <strong>
       访问Ceph Dashboard
      </strong>
     </li>
    </ol>
    <p>
     通过端口转发访问Ceph Dashboard：
    </p>
    <pre><code class="prism language-bash">kubectl <span class="token parameter variable">-n</span> rook-ceph port-forward svc/rook-ceph-mgr-dashboard <span class="token number">7000</span>:7000
</code></pre>
    <p>
     在浏览器中访问
     <code>
      http://localhost:7000
     </code>
     。
    </p>
    <ol start="2">
     <li>
      <strong>
       使用ceph工具
      </strong>
     </li>
    </ol>
    <p>
     进入Ceph工具箱容器：
    </p>
    <pre><code class="prism language-bash">kubectl <span class="token parameter variable">-n</span> rook-ceph <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> deploy/rook-ceph-tools -- <span class="token function">bash</span>
</code></pre>
    <p>
     执行Ceph命令：
    </p>
    <pre><code class="prism language-bash">ceph status
ceph osd status
ceph <span class="token function">df</span>
</code></pre>
    <h3>
     <a id="_225">
     </a>
     最佳实践
    </h3>
    <h4>
     <a id="_227">
     </a>
     数据保护
    </h4>
    <ol>
     <li>
      <strong>
       启用数据复制
      </strong>
     </li>
    </ol>
    <p>
     确保存储池配置了合适的复制级别，保证数据的冗余性和高可用性。
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">replicated</span><span class="token punctuation">:</span>
    <span class="token key atrule">size</span><span class="token punctuation">:</span> <span class="token number">3</span>
</code></pre>
    <ol start="2">
     <li>
      <strong>
       定期备份
      </strong>
     </li>
    </ol>
    <p>
     使用Rook/Ceph提供的快照和备份功能，定期备份关键数据。
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> snapshot.storage.k8s.io/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> VolumeSnapshot
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>snapshot
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">volumeSnapshotClassName</span><span class="token punctuation">:</span> rook<span class="token punctuation">-</span>ceph<span class="token punctuation">-</span>block
  <span class="token key atrule">source</span><span class="token punctuation">:</span>
    <span class="token key atrule">persistentVolumeClaimName</span><span class="token punctuation">:</span> ceph<span class="token punctuation">-</span>pvc
</code></pre>
    <h4>
     <a id="_254">
     </a>
     性能优化
    </h4>
    <ol>
     <li>
      <strong>
       优化硬件资源
      </strong>
     </li>
    </ol>
    <p>
     为Ceph集群提供足够的CPU、内存和存储资源，避免性能瓶颈。
    </p>
    <ol start="2">
     <li>
      <strong>
       监控和调优
      </strong>
     </li>
    </ol>
    <p>
     定期监控Ceph集群性能，调整配置以优化性能。可以使用Ceph Dashboard和Prometheus/Grafana进行监控。
    </p>
    <h4>
     <a id="_264">
     </a>
     常见问题及解决方案
    </h4>
    <ol>
     <li>
      <strong>
       Ceph OSD Pod崩溃
      </strong>
     </li>
    </ol>
    <p>
     <strong>
      问题
     </strong>
     ：Ceph OSD Pod频繁崩溃。
     <br/>
     <strong>
      解决方案
     </strong>
     ：检查OSD Pod日志，确保硬盘健康状态良好，并检查资源配置是否合理。
    </p>
    <pre><code class="prism language-bash">kubectl logs <span class="token operator">&lt;</span>osd-pod-name<span class="token operator">&gt;</span> <span class="token parameter variable">-n</span> rook-ceph
</code></pre>
    <ol start="2">
     <li>
      <strong>
       存储池状态不正常
      </strong>
     </li>
    </ol>
    <p>
     <strong>
      问题
     </strong>
     ：存储池状态为
     <code>
      HEALTH_WARN
     </code>
     或
     <code>
      HEALTH_ERR
     </code>
     。
     <br/>
     <strong>
      解决方案
     </strong>
     ：使用Ceph工具箱检查详细状态，并根据提示进行修复。
    </p>
    <pre><code class="prism language-bash">ceph health detail
</code></pre>
    <hr/>
    <p>
     以上就是关于云原生存储解决方案——使用Rook、Ceph等工具进行云原生存储管理的详细文档。希望这篇文章对您有所帮助。如果有任何问题或建议，欢迎留言讨论。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f33393337323331312f:61727469636c652f64657461696c732f313430343239383333" class_="artid" style="display:none">
 </p>
</div>
