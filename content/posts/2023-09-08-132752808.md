---
layout: post
title: "MCP2515调试心得"
date: 2023-09-08 10:15:54 +0800
description: "采用 STM32 硬件 SPI 时注意使用软件去控制 NSS 的输出，硬件控制操作 MCP2515 "
keywords: "stm32 mcp2515"
categories: ['未分类']
tags: ['Stm', 'Mcp']
artid: "132752808"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=132752808
  alt: "MCP2515调试心得"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=132752808
featuredImagePreview: https://bing.ee123.net/img/rand?artid=132752808
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     MCP2515调试心得
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      基于 STM32 芯片的 MCP2515 芯片调试心得
     </h4>
     <ul>
      <li>
       <a href="#1_MCP2515__1" rel="nofollow">
        1. MCP2515 芯片解析
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#11__2" rel="nofollow">
          1.1 外部时钟源
         </a>
        </li>
        <li>
         <a href="#12__14" rel="nofollow">
          1.2 可采用连续传输提高效率
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#_TX0__16" rel="nofollow">
            发送数据时，使用 TX0 为例：
           </a>
          </li>
         </ul>
        </li>
        <li>
         <a href="#13__MASK__Filter__170" rel="nofollow">
          1.3 关于 MASK 和 Filter 的注意事项
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#131_Filter__171" rel="nofollow">
            1.3.1 Filter 的注意事项
           </a>
          </li>
          <li>
           <a href="#132_MASK__259" rel="nofollow">
            1.3.2 MASK 设置的一些问题
           </a>
          </li>
         </ul>
        </li>
       </ul>
      </li>
      <li>
       <a href="#2_STM32__SPI__267" rel="nofollow">
        2. STM32 硬件 SPI 问题
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h2>
     <a id="1_MCP2515__1">
     </a>
     1. MCP2515 芯片解析
    </h2>
    <h3>
     <a id="11__2">
     </a>
     1.1 外部时钟源
    </h3>
    <ul>
     <li>
      使用晶振
      <br/>
      外部晶振由 OSC1 和 OSC2 引脚输入
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/4dd1658372bfc0d05e1f9df007dfec8f.png#pic_center">
       <br/>
       支持 8M 和 16M 两种时钟，详细参考下图：
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5aa3c4dc0ac9eb1092edeca79893c7ec.png#pic_center"/>
      </img>
     </li>
     <li>
      使用外部时钟源
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/00b26b10c3b7a264858f898b1646e8ee.png#pic_center">
       <br/>
       需要注意 OSC1 前面添加了一个
       <strong>
        反相器
       </strong>
       ，猜测原因是为了提高外部时钟的驱动力。
      </img>
     </li>
    </ul>
    <blockquote>
     <p>
      在某次项目，使用 STM32 的 MCO 直接输出 8M 的 HSE 连接进 MCP2515 的 OSC1 出现无法驱动的情况，可见很需要加一个
      <strong>
       反相器
      </strong>
      。
     </p>
    </blockquote>
    <ul>
     <li>
      第三种，方式不清楚没有使用过。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/832b3217bcc849d182cef9363ab900fb.png#pic_center"/>
     </li>
    </ul>
    <h3>
     <a id="12__14">
     </a>
     1.2 可采用连续传输提高效率
    </h3>
    <p>
     网上大部分的 MCP2515 芯片驱动是发送一个字节，先发送该字节要写入的寄存器地址，这种方式在操作连续地址的多个寄存器时的效率很低。
    </p>
    <h4>
     <a id="_TX0__16">
     </a>
     发送数据时，使用 TX0 为例：
    </h4>
    <p>
     参阅 MCP2515 手册可知与 TX0 相关的寄存器地址是连续递增的，如下：
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MCP2515_TXB0CTRL</span>            <span class="token expression"><span class="token number">0x30</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MCP2515_TXB0SIDH</span>            <span class="token expression"><span class="token number">0x31</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MCP2515_TXB0SIDL</span>            <span class="token expression"><span class="token number">0x32</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MCP2515_TXB0EID8</span>            <span class="token expression"><span class="token number">0x33</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MCP2515_TXB0EID0</span>            <span class="token expression"><span class="token number">0x34</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MCP2515_TXB0DLC</span>             <span class="token expression"><span class="token number">0x35</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MCP2515_TXB0D0</span>              <span class="token expression"><span class="token number">0x36</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MCP2515_TXB0D1</span>              <span class="token expression"><span class="token number">0x37</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MCP2515_TXB0D2</span>              <span class="token expression"><span class="token number">0x38</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MCP2515_TXB0D3</span>              <span class="token expression"><span class="token number">0x39</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MCP2515_TXB0D4</span>              <span class="token expression"><span class="token number">0x3A</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MCP2515_TXB0D5</span>              <span class="token expression"><span class="token number">0x3B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MCP2515_TXB0D6</span>              <span class="token expression"><span class="token number">0x3C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MCP2515_TXB0D7</span>              <span class="token expression"><span class="token number">0x3D</span></span></span>
</code></pre>
    <p>
     其实 TXB0SIDH 到 MCP2515_TXB0D7 是可以通过只设置一次地址，连续传输将数据写入到 MCP2515 里。
     <br/>
     具体操作的编码可以这样实现：
    </p>
    <pre><code class="prism language-c"><span class="token class-name">uint32_t</span> <span class="token function">_hdl_mcp2515_send</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> mcp2515<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> recv_id<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> id_type<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span>sendBuff<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> count<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">uint32_t</span> returnValue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    _id_reg idReg<span class="token punctuation">;</span>
    _ctrl_status_t ctrlStatus<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> instruction_load_buffer<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> instruction_request_to_send<span class="token punctuation">;</span>

    idReg<span class="token punctuation">.</span>tempSIDH <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    idReg<span class="token punctuation">.</span>tempSIDL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    idReg<span class="token punctuation">.</span>tempEID8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    idReg<span class="token punctuation">.</span>tempEID0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    ctrlStatus<span class="token punctuation">.</span>ctrl_status <span class="token operator">=</span> <span class="token function">_hdl_mcp2515_read_status_instruction</span><span class="token punctuation">(</span>mcp2515<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* 目前 Transmission 查找并传送未 Pending 的缓冲器。 */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ctrlStatus<span class="token punctuation">.</span>TXB1REQ <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        instruction_load_buffer <span class="token operator">=</span> MCP2515_LOAD_TXB1SIDH<span class="token punctuation">;</span>
        instruction_request_to_send <span class="token operator">=</span> MCP2515_RTS_TX1<span class="token punctuation">;</span>
        returnValue <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctrlStatus<span class="token punctuation">.</span>TXB2REQ <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        instruction_load_buffer <span class="token operator">=</span> MCP2515_LOAD_TXB2SIDH<span class="token punctuation">;</span>
        instruction_request_to_send <span class="token operator">=</span> MCP2515_RTS_TX2<span class="token punctuation">;</span>
        returnValue <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ctrlStatus<span class="token punctuation">.</span>TXB0REQ <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        instruction_load_buffer <span class="token operator">=</span> MCP2515_LOAD_TXB0SIDH<span class="token punctuation">;</span>
        instruction_request_to_send <span class="token operator">=</span> MCP2515_RTS_TX0<span class="token punctuation">;</span>
        returnValue <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>returnValue<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* 转换成符合 ID 类型 */</span>
        <span class="token function">_hdl_mcp2515_convert_can_id_to_register</span><span class="token punctuation">(</span>recv_id<span class="token punctuation">,</span> id_type<span class="token punctuation">,</span> <span class="token operator">&amp;</span>idReg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* Loading 要传送到 Tx Buffer */</span>
        <span class="token function">_hdl_mcp2515_load_tx_buffer</span><span class="token punctuation">(</span>mcp2515<span class="token punctuation">,</span> instruction_load_buffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>idReg<span class="token punctuation">,</span> sendBuff<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* 请求传送Tx Buffer的数据 */</span>
        <span class="token function">_hdl_mcp2515_request_to_send</span><span class="token punctuation">(</span>mcp2515<span class="token punctuation">,</span> instruction_request_to_send<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> returnValue<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre>
<ul>
<li>
<code>
\_hdl_mcp2515_convert_can_id_to_register
</code>
：将 can 的 id 转成对应的寄存器 id；
</li>
<li>
<code>
\_hdl_mcp2515_load_tx_buffer
</code>
：把数据填充到对应的长度寄存器 DLC 和 D0 ~ D7 寄存器；
</li>
<li>
<code>
\_hdl_mcp2515_request_to_send
</code>
: 发送命令将 TXnBuffer 中的数据发生出去；
<br/>
<img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/42ac65696ddb6902aba5be9631177eb1.png#pic_center"/>
</li>
</ul>
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">\_hdl_mcp2515_convert_can_id_to_register</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> tempPassedInID<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> canIdType<span class="token punctuation">,</span> \_id_reg_t passedIdReg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token class-name">uint8_t</span> wipSIDL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>canIdType <span class="token operator">==</span> dEXTENDED_CAN_MSG_ID_2_0B<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// EID0</span>
        passedIdReg<span class="token operator">-&gt;</span>tempEID0 <span class="token operator">=</span> <span class="token number">0xFF</span> <span class="token operator">&amp;</span> tempPassedInID<span class="token punctuation">;</span>
        tempPassedInID <span class="token operator">=</span> tempPassedInID <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>

        <span class="token comment">// EID8</span>
        passedIdReg<span class="token operator">-&gt;</span>tempEID8 <span class="token operator">=</span> <span class="token number">0xFF</span> <span class="token operator">&amp;</span> tempPassedInID<span class="token punctuation">;</span>
        tempPassedInID <span class="token operator">=</span> tempPassedInID <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>

        <span class="token comment">// SIDL</span>
        wipSIDL <span class="token operator">=</span> <span class="token number">0x03</span> <span class="token operator">&amp;</span> tempPassedInID<span class="token punctuation">;</span>
        tempPassedInID <span class="token operator">=</span> tempPassedInID <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
        wipSIDL <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0x07</span> <span class="token operator">&amp;</span> tempPassedInID<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">|</span> wipSIDL<span class="token punctuation">;</span>
        wipSIDL <span class="token operator">=</span> wipSIDL <span class="token operator">|</span> <span class="token number">0x08</span><span class="token punctuation">;</span>
        passedIdReg<span class="token operator">-&gt;</span>tempSIDL <span class="token operator">=</span> <span class="token number">0xEB</span> <span class="token operator">&amp;</span> wipSIDL<span class="token punctuation">;</span>

        <span class="token comment">// SIDH</span>
        tempPassedInID <span class="token operator">=</span> tempPassedInID <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
        passedIdReg<span class="token operator">-&gt;</span>tempSIDH <span class="token operator">=</span> <span class="token number">0xFF</span> <span class="token operator">&amp;</span> tempPassedInID<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        passedIdReg<span class="token operator">-&gt;</span>tempEID8 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        passedIdReg<span class="token operator">-&gt;</span>tempEID0 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        tempPassedInID <span class="token operator">=</span> tempPassedInID <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span>
        passedIdReg<span class="token operator">-&gt;</span>tempSIDL <span class="token operator">=</span> <span class="token number">0xFF</span> <span class="token operator">&amp;</span> tempPassedInID<span class="token punctuation">;</span>
        tempPassedInID <span class="token operator">=</span> tempPassedInID <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
        passedIdReg<span class="token operator">-&gt;</span>tempSIDH <span class="token operator">=</span> <span class="token number">0xFF</span> <span class="token operator">&amp;</span> tempPassedInID<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">\_hdl_mcp2515_load_tx_buffer</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> mcp2515<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> instruction<span class="token punctuation">,</span> \_id_reg_t id_reg<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> <span class="token operator">\*</span>data<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> length<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token class-name">uint8_t</span> buff<span class="token punctuation">[</span>length <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>_id_reg<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 不推荐这样写，后面会改这部分实现</span>
<span class="token class-name">uint8_t</span> idx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    buff<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> instruction<span class="token punctuation">;</span>

    <span class="token function">memcpy</span><span class="token punctuation">(</span>buff <span class="token operator">+</span> idx<span class="token punctuation">,</span> id_reg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>_id_reg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    idx <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>_id_reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    buff<span class="token punctuation">[</span>idx<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> length<span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>buff <span class="token operator">+</span> idx<span class="token punctuation">,</span> data<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hdl_mcp2515_transmit_hook</span><span class="token punctuation">(</span>mcp2515<span class="token punctuation">,</span> buff<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buff<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">\_hdl_mcp2515_request_to_send</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> mcp2515<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> instruction<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token function">hdl_mcp2515_transmit_hook</span><span class="token punctuation">(</span>mcp2515<span class="token punctuation">,</span> <span class="token operator">&amp;</span>instruction<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>
相关的寄存器定义如下：
</p>
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
<span class="token class-name">uint8_t</span> tempSIDH<span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> tempSIDL<span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> tempEID8<span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> tempEID0<span class="token punctuation">;</span>
<span class="token punctuation">}</span> \_id_reg<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
<span class="token class-name">uint8_t</span> RX0IF <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> RX1IF <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> TXB0REQ <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> TX0IF <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> TXB1REQ <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> TX1IF <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> TXB2REQ <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> TX2IF <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> ctrl_status<span class="token punctuation">;</span>  
<span class="token punctuation">}</span> \_ctrl_status_t<span class="token punctuation">;</span>

</code></pre>
<h3>
<a id="13__MASK__Filter__170">
</a>
1.3 关于 MASK 和 Filter 的注意事项
</h3>
<h4>
<a id="131_Filter__171">
</a>
1.3.1 Filter 的注意事项
</h4>
<p>
Filter 的设置有四个寄存器，如下：
<br/>
<img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/6172eedd20a119ff50a400d745a2e897.png#pic_center">
<br/>
<img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/9e44cb8bda3215cf1a73effcab270259.png#pic_center">
<br/>
<img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/ecf30ed8d7971591540b3995a7a8d713.png#pic_center"/>
<br/>
<img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1570e7e30beb74b2cb7dffa977ce626a.png#pic_center"/>
<br/>
转成 C 的结构体：
</img>
</img>
</p>
<pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
<span class="token class-name">uint8_t</span> RXFnSIDH<span class="token punctuation">;</span>
<span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
<span class="token class-name">uint8_t</span> EID16 <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> EID17 <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> reserve_1 <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> EXIDE <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> reserve_2 <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> SID0 <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> SID1 <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> SID2 <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> RXFnSIDL<span class="token punctuation">;</span>
<span class="token punctuation">}</span> \_sid_reg<span class="token punctuation">;</span>
<span class="token keyword">struct</span>
<span class="token punctuation">{<!-- --></span>
<span class="token class-name">uint8_t</span> RXFxEID8<span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> RXFxEID0<span class="token punctuation">;</span>
<span class="token punctuation">}</span> \_eid_reg<span class="token punctuation">;</span>
<span class="token punctuation">}</span> \_mcp2515_filter_reg<span class="token punctuation">;</span>

<span class="token keyword">typedef</span> \_mcp2515_filter_reg<span class="token operator">\*</span> \_mcp2515_filter_reg_t<span class="token punctuation">;</span>
</code></pre>
<ul>
<li>
标准 ID 和扩展 ID 是根据 EXIDE 位来控制，这想必没问题。
</li>
<li>
但是注意上方红色方框的话，如果采用的扩展 ID，那么 RXFxEID8 : RXFxEID0 对应的是 ID 号的低 16 位，剩余的位，按低到高依次填充进 EID16、EID17、SID0、SID1、SID2、RXFnSIDH 寄存器里面。
</li>
</ul>
<p>
对应的代码实现：
</p>
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">\_hdl_mcp2515_add_filter</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> mcp2515<span class="token punctuation">,</span> <span class="token class-name">hdl_mcp2515_filter_t</span> filter<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> id<span class="token punctuation">,</span> HDL_MCP2515_BOOL isExt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
\_mcp2515_filter_reg filter_reg <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> filter_addr<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>filter<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> HDL_MCP2515_RX_BUFF1_FILTER_1<span class="token operator">:</span> filter_addr <span class="token operator">=</span> MCP2515_RXF0SIDH<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> HDL_MCP2515_RX_BUFF1_FILTER_2<span class="token operator">:</span> filter_addr <span class="token operator">=</span> MCP2515_RXF1SIDH<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> HDL_MCP2515_RX_BUFF2_FILTER_1<span class="token operator">:</span> filter_addr <span class="token operator">=</span> MCP2515_RXF2SIDH<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> HDL_MCP2515_RX_BUFF2_FILTER_2<span class="token operator">:</span> filter_addr <span class="token operator">=</span> MCP2515_RXF3SIDH<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> HDL_MCP2515_RX_BUFF2_FILTER_3<span class="token operator">:</span> filter_addr <span class="token operator">=</span> MCP2515_RXF4SIDH<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> HDL_MCP2515_RX_BUFF2_FILTER_4<span class="token operator">:</span> filter_addr <span class="token operator">=</span> MCP2515_RXF5SIDH<span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>isExt <span class="token operator">==</span> HDL_MCP2515_TRUE<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        filter_reg<span class="token punctuation">.</span>_sid_reg<span class="token punctuation">.</span>RXFnSIDL<span class="token punctuation">.</span>EXIDE <span class="token operator">=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>

        filter_reg<span class="token punctuation">.</span>_eid_reg<span class="token punctuation">.</span>RXFxEID0 <span class="token operator">=</span> id <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
        filter_reg<span class="token punctuation">.</span>_eid_reg<span class="token punctuation">.</span>RXFxEID8 <span class="token operator">=</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>
        filter_reg<span class="token punctuation">.</span>_sid_reg<span class="token punctuation">.</span>RXFnSIDL<span class="token punctuation">.</span>EID16 <span class="token operator">=</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        filter_reg<span class="token punctuation">.</span>_sid_reg<span class="token punctuation">.</span>RXFnSIDL<span class="token punctuation">.</span>EID17 <span class="token operator">=</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;&gt;</span> <span class="token number">17</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">;</span>

        filter_reg<span class="token punctuation">.</span>_sid_reg<span class="token punctuation">.</span>RXFnSIDL<span class="token punctuation">.</span>SID0 <span class="token operator">=</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;&gt;</span> <span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        filter_reg<span class="token punctuation">.</span>_sid_reg<span class="token punctuation">.</span>RXFnSIDL<span class="token punctuation">.</span>SID1 <span class="token operator">=</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;&gt;</span> <span class="token number">19</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        filter_reg<span class="token punctuation">.</span>_sid_reg<span class="token punctuation">.</span>RXFnSIDL<span class="token punctuation">.</span>SID2 <span class="token operator">=</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;&gt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">;</span>

        filter_reg<span class="token punctuation">.</span>_sid_reg<span class="token punctuation">.</span>RXFnSIDH <span class="token operator">=</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;&gt;</span> <span class="token number">21</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>

        <span class="token function">_hdl_mcp2515_write_sequence</span><span class="token punctuation">(</span>mcp2515<span class="token punctuation">,</span> filter_addr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>filter_reg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>filter_reg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        filter_reg<span class="token punctuation">.</span>_sid_reg<span class="token punctuation">.</span>RXFnSIDL<span class="token punctuation">.</span>EXIDE <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

        filter_reg<span class="token punctuation">.</span>_sid_reg<span class="token punctuation">.</span>RXFnSIDL<span class="token punctuation">.</span>SID0 <span class="token operator">=</span> id <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        filter_reg<span class="token punctuation">.</span>_sid_reg<span class="token punctuation">.</span>RXFnSIDL<span class="token punctuation">.</span>SID1 <span class="token operator">=</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
        filter_reg<span class="token punctuation">.</span>_sid_reg<span class="token punctuation">.</span>RXFnSIDL<span class="token punctuation">.</span>SID2 <span class="token operator">=</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x01</span><span class="token punctuation">;</span>
    	filter_reg<span class="token punctuation">.</span>_sid_reg<span class="token punctuation">.</span>RXFnSIDH <span class="token operator">=</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>

        <span class="token function">_hdl_mcp2515_write_sequence</span><span class="token punctuation">(</span>mcp2515<span class="token punctuation">,</span> filter_addr<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>filter_reg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>filter_reg<span class="token punctuation">.</span>_sid_reg<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<p>
Filter 寄存器的设置也可以采用连续传输的方式实现。
</p>
<h4>
<a id="132_MASK__259">
</a>
1.3.2 MASK 设置的一些问题
</h4>
<ul>
<li>
MASK 寄存器的设置与 Filter 非常相似，除了没有 EXIDE 位之外；
</li>
<li>
设置 MASK 后，不推荐标准 ID 和 扩展 ID 混用，在 ID 过滤上的计算很复杂，具体说来：
<br/>
– 设置 MASK 为扩展 ID 位时，标准 ID 过滤采用 RXMnSIDH、RXMnSIDL 里面的位；
<br/>
– 设置 MASK 为标准 ID 位时，RXMnEID8 和 RXMnEID0 会默认为 0，此时扩展 ID 也是参考 RXMnSIDH、RXMnSIDL 的位；
</li>
</ul>
<p>
RXBn 接收标准 ID 或扩展 ID 还是同时接收，可以配置 RXM&lt;1:0&gt; 来设置：
<br/>
<img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5ffa42c53f51fb7bfe35c70fb11a6fa4.png#pic_center"/>
</p>
<h2>
<a id="2_STM32__SPI__267">
</a> 2. STM32 硬件 SPI 问题
</h2>
<p>
采用 STM32 硬件 SPI 时注意使用软件去控制 NSS 的输出，硬件控制操作 MCP2515 芯片会有问题。本人使用的是 STM32F407VG 和 STM32F429 去操作时都会出现这个问题。
</p>

   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f42696e5f576174736f6e2f:61727469636c652f64657461696c732f313332373532383038" class_="artid" style="display:none">
 </p>
</div>
