---
layout: post
title: "PostgreSQL-多数据库集簇配置及多数据库复制方法流程代码实例"
date: 2025-03-13 22:31:42 +0800
description: "Pg 集簇配置及复制备份方法"
keywords: "PostgreSQL 多数据库集簇配置及多数据库复制方法【流程+代码实例】"
categories: ['Postgresql', 'Database']
tags: ['数据库', 'Postgresql']
artid: "146243878"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146243878
    alt: "PostgreSQL-多数据库集簇配置及多数据库复制方法流程代码实例"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146243878
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146243878
cover: https://bing.ee123.net/img/rand?artid=146243878
image: https://bing.ee123.net/img/rand?artid=146243878
img: https://bing.ee123.net/img/rand?artid=146243878
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     PostgreSQL 多数据库集簇配置及多数据库复制方法【流程+代码实例】
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="PostgreSQL__1">
     </a>
     PostgreSQL 多数据库集簇配置及多数据库复制方法
    </h2>
    <h3>
     <a id="1__3">
     </a>
     1. 多数据库集簇配置
    </h3>
    <p>
     安装下载完postgresql后，系统此时包含一个
     <code>
      postgres
     </code>
     用户和一个名为
     <code>
      postgres
     </code>
     的默认数据库。
    </p>
    <h4>
     <a id="PostgreSQL__7">
     </a>
     PostgreSQL 基本命令
    </h4>
    <ul>
     <li>
      <p>
       服务管理命令
      </p>
      <pre><code class="prism language-bash"><span class="token comment"># 停止和启动及重启PostgreSQL服务</span>
<span class="token function">sudo</span> systemctl stop postgresql
<span class="token function">sudo</span> systemctl start postgresql
<span class="token function">sudo</span> systemctl restart postgresql

<span class="token comment"># 查看服务当前状态</span>
<span class="token function">sudo</span> systemctl status postgresql

<span class="token comment"># 设置服务开机自启动</span>
<span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> postgresql
<span class="token comment"># 禁止服务开机自启动</span>
<span class="token function">sudo</span> systemctl disable postgresql
</code></pre>
      <blockquote>
       <p>
        <code>
         systemctl
        </code>
        是 Linux 系统中用于管理系统服务的工具
       </p>
      </blockquote>
     </li>
     <li>
      <p>
       客服端交互命令
      </p>
      <pre><code class="prism language-bash"><span class="token comment"># 连接到数据库</span>
<span class="token function">sudo</span> <span class="token parameter variable">-u</span> postgres psql

<span class="token comment"># 连接指定数据库</span>
<span class="token function">sudo</span> <span class="token parameter variable">-u</span> postgres psql <span class="token parameter variable">-d</span> <span class="token operator">&lt;</span>database_name<span class="token operator">&gt;</span>

<span class="token comment"># 退出</span>
<span class="token punctuation">\</span>q
</code></pre>
     </li>
     <li>
      <p>
       数据库操作命令（psql客户端）
      </p>
      <pre><code class="prism language-sql"><span class="token comment"># 创建新数据库</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token operator">&lt;</span>database_name<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment"># 删除</span>
<span class="token keyword">DROP</span> <span class="token keyword">DATABASE</span> <span class="token operator">&lt;</span>database_name<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token comment"># 列出</span>
\l

<span class="token comment"># 切换</span>
\c <span class="token operator">&lt;</span>database_name<span class="token operator">&gt;</span>
</code></pre>
     </li>
     <li>
      <p>
       用户及权限管理
      </p>
      <pre><code class="prism language-sql"><span class="token comment"># 创建</span>
<span class="token keyword">CREATE</span> <span class="token keyword">USER</span> your_username <span class="token keyword">WITH</span> PASSWORD <span class="token string">'your_password'</span><span class="token punctuation">;</span>

<span class="token comment"># 删除</span>
<span class="token keyword">DROP</span> <span class="token keyword">USER</span> your_username<span class="token punctuation">;</span>

<span class="token comment"># 授权</span>
<span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token keyword">DATABASE</span> your_database_name <span class="token keyword">TO</span> your_username<span class="token punctuation">;</span>

<span class="token comment"># 撤销</span>
<span class="token keyword">REVOKE</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> <span class="token keyword">DATABASE</span> your_database_name <span class="token keyword">FROM</span> your_username<span class="token punctuation">;</span>
</code></pre>
     </li>
    </ul>
    <h4>
     <a id="_73">
     </a>
     自定义端口与数据库集簇
    </h4>
    <p>
     配置要设置端口等基本信息，需要先停止服务
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> systemctl stop postgresql
</code></pre>
    <p>
     初始化集簇步骤：
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 创建一个数据库集簇的数据目录 -p 递归创建</span>
<span class="token function">sudo</span> <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/postgresql
<span class="token comment"># 赋权</span>
<span class="token function">sudo</span> <span class="token function">chown</span> postgres:postgres /data/postgresql
<span class="token comment"># 当前用户使用postgres用户的身份初始化数据库集簇 -u 指定用户 -D 指定数据目录 -E 指定默认字符编码</span>
<span class="token function">sudo</span> <span class="token parameter variable">-u</span> postgres /usr/lib/postgresql/<span class="token operator">&lt;</span>version<span class="token operator">&gt;</span>/bin/initdb <span class="token parameter variable">-D</span> /data/postgresql <span class="token parameter variable">-E</span> UTF8
</code></pre>
    <blockquote>
     <p>
      <code>
       initdb
      </code>
      是 PostgreSQL 数据库管理系统中的一个关键命令，主要用于
      <strong>
       初始化一个新的数据库集簇
      </strong>
      。
     </p>
    </blockquote>
    <p>
     修改配置文件：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token parameter variable">-u</span> postgres <span class="token function">vim</span> <span class="token operator">&lt;</span>PG_HOME<span class="token operator">&gt;</span>/postgresql.conf
<span class="token comment"># 本例中&lt;PG_HOME&gt;为 /data/postgresql 即数据目录</span>

<span class="token comment"># 设置值</span>
listen_addresses <span class="token operator">=</span> <span class="token string">'*'</span>   <span class="token comment"># 允许远程访问</span>
port <span class="token operator">=</span> <span class="token number">5439</span>    <span class="token comment"># 改成任意空闲端口          </span>
max_connections <span class="token operator">=</span> <span class="token number">100</span> <span class="token comment"># 设置最大连接数</span>
</code></pre>
    <p>
     等价于:
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># -a 追加模式 tee 将标准输入复制到每个指定的文件</span>
<span class="token function">sudo</span> <span class="token parameter variable">-u</span> postgres <span class="token function">tee</span> <span class="token parameter variable">-a</span> <span class="token operator">&lt;</span>PG_HOME<span class="token operator">&gt;</span>/postgresql.conf <span class="token operator">&lt;&lt;</span> <span class="token string">EOF
listen_addresses = '*'   
port = 5439            
max_connections = 100   
EOF</span>
</code></pre>
    <blockquote>
     <p>
      <code>
       EOF
      </code>
      （Here Document）是一种在脚本中向文件追加内容或传递多行输入的便捷方法。
     </p>
    </blockquote>
    <h4>
     <a id="_119">
     </a>
     两种启动数据库集簇方式
    </h4>
    <h5>
     <a id="1_121">
     </a>
     1.手动
    </h5>
    <pre><code class="prism language-bash"><span class="token comment"># pg_ctl 根据-D 后的数据目录来定位要启动的数据库集簇。</span>
<span class="token function">sudo</span> <span class="token parameter variable">-u</span> postgres /usr/lib/postgresql/<span class="token operator">&lt;</span>PostgreSQL-Version<span class="token operator">&gt;</span>/bin/pg_ctl start <span class="token parameter variable">-D</span> /data/postgresql
</code></pre>
    <blockquote>
     <p>
      <code>
       pg_ctl
      </code>
      是 PostgreSQL 提供的一个实用工具，用于
      <strong>
       控制 PostgreSQL 服务器
      </strong>
      的启动、停止、重启、重新加载配置等操作。
     </p>
     <p>
      注意和
      <code>
       systemctl
      </code>
      的比较：
     </p>
     <ul>
      <li>
       <code>
        pg_ctl
       </code>
       是 PostgreSQL 自带的命令行工具，主要用于对 PostgreSQL 数据库集簇进行精细的控制和管理。直接与 PostgreSQL 服务器进行交互，操作的核心是数据库集簇。
      </li>
      <li>
       <code>
        systemctl
       </code>
       是 Linux 系统中
       <code>
        systemd
       </code>
       系统和服务管理器的命令行工具，用于管理系统服务。它是操作系统层面的服务管理工具，对各种系统服务（包括 PostgreSQL 服务）进行统一管理。（见2）
      </li>
     </ul>
    </blockquote>
    <h4>
     <a id="2_135">
     </a>
     2.一键启动
    </h4>
    <p>
     首先创建Systemd服务文件
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/systemd/system/postgresql-custom.service
<span class="token comment"># postgresql-custom 自定义名称，一个名称对应与一个数据库集簇</span>
</code></pre>
    <p>
     加入以下内容：
    </p>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>PostgreSQL Custom Instance  <span class="token comment"># 对该服务的简要描述，方便用户了解服务的功能</span>
<span class="token assign-left variable">After</span><span class="token operator">=</span>network.target   <span class="token comment"># 确保在网络服务启动后再启动 PostgreSQL 服务</span>

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>forking  <span class="token comment"># 服务使用 fork() 方式启动，即父进程启动子进程后退出</span>
<span class="token assign-left variable">User</span><span class="token operator">=</span>postgres
<span class="token assign-left variable">Group</span><span class="token operator">=</span>postgres <span class="token comment"># 指定服务以 postgres 用户和 postgres 用户组的身份运行</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>on-failure  <span class="token comment"># 服务因异常退出时，systemd 会自动尝试重启该服务</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/lib/postgresql/14/bin/pg_ctl start <span class="token parameter variable">-D</span> /data/postgresql  <span class="token comment"># 启动服务时执行的命令</span>
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/usr/lib/postgresql/14/bin/pg_ctl stop <span class="token parameter variable">-D</span> /data/postgresql    <span class="token comment"># 停止服务时执行的命令</span>

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target  <span class="token comment"># 该服务在多用户模式下被启动</span>
</code></pre>
    <p>
     保存退出，命令行输入：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> systemctl daemon-reload   <span class="token comment"># 重新加载 systemd 配置</span>
<span class="token function">sudo</span> systemctl start postgresql-custom <span class="token comment"># 若启动其他集簇，编辑对应systemd文件并启动即可</span>
</code></pre>
    <h4>
     <a id="_170">
     </a>
     监听服务状态
    </h4>
    <pre><code class="prism language-bash"><span class="token comment"># 监听的端口号； ss 显示套接字统计信息的工具 -t tcp -u udp -l 显示处于监听状态的套接字 -n 数字形式显示地址和端口号 -p 显示使用该套接字的进程信息  | grep &lt;port_id&gt;  筛选出监听 5439 端口的套接字信息</span>
<span class="token function">sudo</span> ss <span class="token parameter variable">-tulnp</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token number">5439</span>
</code></pre>
    <p>
     对应端口显示
     <code>
      listen
     </code>
     即可。
    </p>
    <h3>
     <a id="2__179">
     </a>
     2. 多数据库异步流复制
    </h3>
    <h4>
     <a id="Docker_181">
     </a>
     速通Docker安装
    </h4>
    <ul>
     <li>
      <p>
       更换apt源
      </p>
      <pre><code class="prism language-bash"> <span class="token function">sudo</span> <span class="token function">apt</span> update
 <span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> apt-transport-https <span class="token punctuation">\</span>
 ca-certificates <span class="token punctuation">\</span>
 <span class="token function">curl</span> <span class="token punctuation">\</span>
 software-properties-common <span class="token punctuation">\</span>
                    gnupg <span class="token punctuation">\</span>
                    lsb-release
 <span class="token comment"># **阿里源**</span>
 <span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg <span class="token punctuation">\</span>
        <span class="token operator">|</span> <span class="token function">sudo</span> gpg <span class="token parameter variable">--dearmor</span> <span class="token parameter variable">-o</span> /usr/share/keyrings/docker-archive-keyring.gpg

    <span class="token comment"># 添加 apt 源:</span>
    <span class="token comment"># 阿里 apt 源</span>
<span class="token builtin class-name">echo</span> <span class="token string">"deb [arch=<span class="token variable"><span class="token variable">$(</span>dpkg --print-architecture<span class="token variable">)</span></span> \
signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] \
https://mirrors.aliyun.com/docker-ce/linux/ubuntu \
<span class="token variable"><span class="token variable">$(</span>lsb_release <span class="token parameter variable">-cs</span><span class="token variable">)</span></span> stable"</span> <span class="token punctuation">\</span>
<span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/docker.list <span class="token operator">&gt;</span> /dev/null

<span class="token function">sudo</span> <span class="token function">apt</span> update
<span class="token function">sudo</span> <span class="token function">apt-get</span> update
</code></pre>
      <blockquote>
       <p>
        问题总结：
       </p>
       <ol>
        <li>
         sudo apt update 报错
         <code>
          E: 仓库 “https://apt.postgresql.org/pub/repos/apt xenial-pgdg Release” 没有 Release 文件
         </code>
        </li>
       </ol>
       <p>
        解决：
        <code>
         sudo rm /etc/apt/sources.list.d/pgdg.list
        </code>
       </p>
       <ol start="2">
        <li>
         安装
         <code>
          curl
         </code>
         依赖报错： curl : 依赖: libcurl3-gnutls (= 7.47.0-1ubuntu2) 但是 7.47.0-1ubuntu2.15 正要被安装
        </li>
       </ol>
       <p>
        解决：强制安装指定版本：
        <code>
         sudo apt-get install libcurl3-gnutls=7.47.0-1ubuntu2
        </code>
       </p>
      </blockquote>
     </li>
     <li>
      <p>
       安装Docker Engine
      </p>
      <p>
       插件先不装
      </p>
      <pre><code class="prism language-bash"> <span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> docker-ce <span class="token punctuation">\</span>
                docker-ce-cli <span class="token punctuation">\</span>
                containerd.io 
</code></pre>
     </li>
     <li>
      <p>
       更换镜像
      </p>
      <pre><code class="prism language-bash"><span class="token comment"># 设置registry mirror</span>
<span class="token function">sudo</span> <span class="token function">vim</span> /etc/docker/daemon.json

<span class="token comment"># 加入以下内容 （最新镜像源 可以网上找资源）</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"https://docker.1ms.run"</span>,
        <span class="token string">"https://docker.xuanyuan.me"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">## 重启Docker</span>
systemctl daemon-reload
systemctl restart <span class="token function">docker</span>
</code></pre>
     </li>
     <li>
      <p>
       测试
      </p>
      <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> run hello-world
<span class="token comment"># 本地找不到镜像就会去镜像源拉去相关镜像 输出对应镜像信息</span>
</code></pre>
     </li>
    </ul>
    <h4>
     <a id="_257">
     </a>
     异步流复制
    </h4>
    <h5>
     <a id="_259">
     </a>
     动机
    </h5>
    <p>
     简单来说就是为了防止大哥出事，搞几个备份顺便还能分担大哥的压力。
    </p>
    <h5>
     <a id="_263">
     </a>
     准备工作
    </h5>
    <p>
     下载pg的docker镜像：
    </p>
    <pre><code class="prism language-bash"><span class="token function">docker</span> pull postgres
</code></pre>
    <p>
     挂载数据卷同步数据：
    </p>
    <pre><code class="prism language-bash">ocker volume create postgre-data
</code></pre>
    <h5>
     <a id="_277">
     </a>
     创建主库容器
    </h5>
    <pre><code class="prism language-bash"><span class="token function">docker</span> run <span class="token parameter variable">-id</span> <span class="token parameter variable">--name</span><span class="token operator">=</span>pg1 <span class="token parameter variable">-v</span> postgre-data:/var/lib/postgresql/data <span class="token parameter variable">-p</span> <span class="token number">5432</span>:5432 <span class="token parameter variable">-e</span> <span class="token assign-left variable">POSTGRES_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> <span class="token parameter variable">-e</span> <span class="token assign-left variable"><span class="token environment constant">LANG</span></span><span class="token operator">=</span>C.UTF-8 postgres
<span class="token comment"># dock run :基于指定的镜像创建并启动一个新的容器</span>
<span class="token comment"># -d 保持后台运行 -i 保持标准输入流处于打开状态 --name 命名</span>
<span class="token comment"># -v 挂载数据卷 -v &lt;column_name&gt;:&lt;data_path&gt; 数据卷名称及容器内数据目录</span>
<span class="token comment"># -p &lt;home_port&gt;:&lt;container_port&gt; 将容器内部的端口映射到宿主机的端口 能通过宿主机的 5432 端口访问容器内运行的 PostgreSQL 服务</span>
<span class="token comment"># postgres 镜像名称</span>
</code></pre>
    <h5>
     <a id="_288">
     </a>
     相关配置（挂载数据卷内配置，不进入容器）
    </h5>
    <p>
     获取主机ip
    </p>
    <pre><code class="prism language-bash"><span class="token function">hostname</span>  <span class="token comment"># 主机名</span>
<span class="token function">hostname</span> <span class="token parameter variable">-i</span> <span class="token comment"># 主机ip</span>
</code></pre>
    <p>
     打开配置文件,加入配置信息
    </p>
    <pre><code class="prism language-bash"><span class="token function">vim</span> /var/lib/docker/volumes/postgre-data/_data/postgresql.conf

<span class="token comment"># 添加信息 普通模式 G 跳转底部</span>
wal_level <span class="token operator">=</span> replica         
max_wal_senders <span class="token operator">=</span> <span class="token number">3</span>        
hot_standby <span class="token operator">=</span> on  
<span class="token comment"># host replication all 127.0.0.1/32 md5</span>

<span class="token comment"># pg_hba.conf 文件定义了哪些客户端可以连接到 PostgreSQL 服务器，以及它们使用何种认证方法进行身份验证。</span>
<span class="token function">sudo</span> <span class="token function">vim</span> /var/lib/postgresql/data/pg_hba.conf
<span class="token comment">#添加</span>
<span class="token function">host</span> replication all <span class="token number">127.0</span>.0.1/16 md5
<span class="token comment"># 退出重启容器 docker ps -a 查看容器状态</span>
<span class="token function">sudo</span> <span class="token function">docker</span> restart pg1
</code></pre>
    <p>
     在主库中插入测试数据：
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 进入容器并使用 psql 连接数据库</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pg1 psql <span class="token parameter variable">-U</span> postgres
</code></pre>
    <pre><code class="prism language-sql"><span class="token comment">-- 创建学生表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> students <span class="token punctuation">(</span>
 student_id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
 name <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
 age <span class="token keyword">INT</span><span class="token punctuation">,</span>
 gender <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 enrollment_date <span class="token keyword">DATE</span>
 <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">-- 插入示例数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> students <span class="token punctuation">(</span>name<span class="token punctuation">,</span> age<span class="token punctuation">,</span> gender<span class="token punctuation">,</span> enrollment_date<span class="token punctuation">)</span>
 <span class="token keyword">VALUES</span> 
<span class="token punctuation">(</span><span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'2024-09-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token string">'李四'</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'2023-09-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token string">'王五'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'2022-09-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token string">'赵六'</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'2025-01-15'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token string">'孙七'</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'2022-03-20'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token string">'周八'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'2024-07-10'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token string">'吴九'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'2023-11-05'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token string">'郑十'</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'2024-04-25'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token string">'王十一'</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'2025-02-01'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token string">'李十二'</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'2021-09-30'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token string">'张十三'</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'2024-09-12'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token string">'刘十四'</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token string">'F'</span><span class="token punctuation">,</span> <span class="token string">'2023-06-18'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 <span class="token punctuation">(</span><span class="token string">'陈十五'</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">,</span> <span class="token string">'M'</span><span class="token punctuation">,</span> <span class="token string">'2025-03-08'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 <span class="token comment"># \q 退出psql</span>
</code></pre>
    <h5>
     <a id="pg_basebackup___351">
     </a>
     创建备库（pg_basebackup 初始化）
    </h5>
    <p>
     创建备库
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">--name</span> pg2 <span class="token parameter variable">-e</span> <span class="token assign-left variable">POSTGRES_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> postgres:latest <span class="token function">bash</span> <span class="token parameter variable">-c</span> <span class="token string">"while true; do sleep 1; done"</span> 
<span class="token comment"># PostgreSQL 需要一个数据目录来存储数据库文件。如果没有挂载数据卷，PostgreSQL 服务将无法启动，因为默认的数据目录是空的。</span>
<span class="token comment"># 当 PostgreSQL 服务无法启动时，容器会因为没有主进程而退出 无限循环脚本阻止容器退出</span>
<span class="token comment"># bash -c：在容器内启动一个 Bash Shell，并执行后面的命令</span>
</code></pre>
    <p>
     查看
     <code>
      pg1
     </code>
     ip：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> pg1

<span class="token function">apt-get</span> update
<span class="token function">apt-get</span> <span class="token function">install</span> net-tools
<span class="token function">ifconfig</span>

<span class="token builtin class-name">exit</span>
</code></pre>
    <p>
     执行
     <code>
      pg_basebackup
     </code>
     创建基础备份:
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># -h 主库ip或主机名  -U 连接到主库使用的用户名 -D 基础备份数据存储的目标目录  -R 自动生成恢复配置文件 备库在启动时连接到主库，并开始接收 WAL（预写式日志）流，从而实现流复制。 -X 指定如何处理WAL  stream 通过流复制的方式实时获取主节点的 WAL 日志，确保备份数据的一致性。</span>
<span class="token function">sudo</span> <span class="token function">docker</span> <span class="token builtin class-name">exec</span> pg2 pg_basebackup <span class="token parameter variable">-h</span> <span class="token operator">&lt;</span>pg1_ip<span class="token operator">&gt;</span> <span class="token parameter variable">-U</span> postgres <span class="token parameter variable">-D</span> /var/lib/postgresql/data <span class="token parameter variable">-P</span> <span class="token parameter variable">-R</span> <span class="token parameter variable">-X</span> stream <span class="token parameter variable">-v</span>
<span class="token comment"># 172.17.0.2</span>
</code></pre>
    <blockquote>
     <p>
      <code>
       pg_basebackup
      </code>
      是 PostgreSQL 提供的一个工具，用于创建 PostgreSQL 数据库集群的基础备份。基础备份是创建流复制环境的第一步，它会复制主节点上的所有数据文件，为从节点提供一个初始的数据副本。
     </p>
    </blockquote>
    <p>
     启动备库：
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">docker</span> <span class="token builtin class-name">exec</span> pg2 <span class="token function">su</span> postgres <span class="token parameter variable">-c</span> <span class="token string">"pg_ctl start -D /var/lib/postgresql/data"</span>
</code></pre>
    <h4>
     <a id="_390">
     </a>
     主备一致性
    </h4>
    <p>
     接下来就是验收结果
    </p>
    <ul>
     <li>
      <p>
       主库检查
      </p>
      <pre><code class="prism language-sql"><span class="token comment"># 进入主库容器 psql进入pg交互</span>
<span class="token keyword">SELECT</span> client_addr<span class="token punctuation">,</span> state<span class="token punctuation">,</span> sync_state<span class="token punctuation">,</span> sent_lsn<span class="token punctuation">,</span> write_lsn  <span class="token keyword">FROM</span> pg_stat_replication<span class="token punctuation">;</span>
<span class="token comment"># 输出应备库IP等信息</span>
</code></pre>
     </li>
     <li>
      <p>
       备库检查
      </p>
      <pre><code class="prism language-sql"><span class="token comment"># 备库同理</span>
<span class="token keyword">SELECT</span> pg_is_in_recovery<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment"># t 备库模式</span>
<span class="token keyword">SELECT</span> pg_last_wal_receive_lsn<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pg_last_wal_replay_lsn<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 与主库一致</span>
</code></pre>
     </li>
     <li>
      <p>
       数据一致性
      </p>
      <pre><code class="prism language-sql"><span class="token comment"># 主库写入</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test <span class="token punctuation">(</span>id <span class="token keyword">SERIAL</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span> <span class="token keyword">data</span> <span class="token keyword">TEXT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> test <span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'HA test'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 备库查询</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> test<span class="token punctuation">;</span>  <span class="token comment"># 数据一致</span>
</code></pre>
     </li>
     <li>
      <p>
       日志信息等
      </p>
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f4d725f584c4d2f:61727469636c652f64657461696c732f313436323433383738" class_="artid" style="display:none">
 </p>
</div>


