---
layout: post
title: "PyTorch-的-unfold-函数深入解析与在-Vision-Transformer-ViT-中的应用"
date: 2025-03-12 19:46:11 +0800
description: "它在图像处理中特别有用，可以高效地将二维图像分割为多个局部块（Patch），而无需显式循环。"
keywords: "PyTorch 的 unfold 函数：深入解析与在 Vision Transformer (ViT) 中的应用"
categories: ['Pytorch']
tags: ['人工智能', 'Transformer', 'Pytorch']
artid: "146213194"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146213194
    alt: "PyTorch-的-unfold-函数深入解析与在-Vision-Transformer-ViT-中的应用"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146213194
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146213194
cover: https://bing.ee123.net/img/rand?artid=146213194
image: https://bing.ee123.net/img/rand?artid=146213194
img: https://bing.ee123.net/img/rand?artid=146213194
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     PyTorch 的 unfold 函数：深入解析与在 Vision Transformer (ViT) 中的应用
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-github-gist" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="PyTorch__unfold__Vision_Transformer_ViT__0">
     </a>
     PyTorch 的
     <code>
      unfold
     </code>
     函数：深入解析与在 Vision Transformer (ViT) 中的应用
    </h2>
    <p>
     作为一名深度学习研究者，你可能对 PyTorch 的灵活性和强大功能并不陌生。在计算机视觉领域，尤其是 Vision Transformer (ViT) 的实现中，
     <code>
      torch.nn.functional.unfold
     </code>
     （或 Tensor 的
     <code>
      unfold
     </code>
     方法）是一个非常实用的工具，用于将图像分割成固定大小的 Patch。本篇博客将深入介绍
     <code>
      unfold
     </code>
     函数的原理、用法，并结合 ViT 中的 Patch Embedding 模块，展示它在现代视觉模型中的具体应用。目标读者是对 PyTorch 和深度学习有一定基础的研究者，希望通过这篇文章加深你对
     <code>
      unfold
     </code>
     的理解及其在 ViT 中的作用。
    </p>
    <hr/>
    <h3>
     <a id="_unfold__6">
     </a>
     什么是
     <code>
      unfold
     </code>
     函数？
    </h3>
    <p>
     <code>
      unfold
     </code>
     是 PyTorch 提供的一个操作，用于从张量中提取滑动窗口（Sliding Window）的子区域。它在图像处理中特别有用，可以高效地将二维图像分割为多个局部块（Patch），而无需显式循环。这种操作类似于卷积神经网络（CNN）中的卷积操作，但它直接返回原始数据的子块，而不是计算加权和。
    </p>
    <h4>
     <a id="_10">
     </a>
     基本定义
    </h4>
    <p>
     对于一个张量，
     <code>
      unfold
     </code>
     方法的签名如下：
    </p>
    <pre><code class="prism language-python">tensor<span class="token punctuation">.</span>unfold<span class="token punctuation">(</span>dimension<span class="token punctuation">,</span> size<span class="token punctuation">,</span> step<span class="token punctuation">)</span>
</code></pre>
    <ul>
     <li>
      <strong>
       dimension
      </strong>
      ：沿哪个维度展开（对于图像，通常是高度或宽度维度）。
     </li>
     <li>
      <strong>
       size
      </strong>
      ：窗口大小（即提取的子块大小）。
     </li>
     <li>
      <strong>
       step
      </strong>
      ：滑动步幅（Stride），控制窗口移动的距离。
     </li>
    </ul>
    <p>
     返回的张量包含所有滑动窗口的子块，形状根据输入和参数调整。
    </p>
    <h4>
     <a id="_21">
     </a>
     工作原理
    </h4>
    <p>
     假设有一个二维张量 (
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        X 
        
       
         ∈ 
        
        
        
          R 
         
         
         
           H 
          
         
           × 
          
         
           W 
          
         
        
       
      
        X \in \mathbb{R}^{H \times W}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7224em; vertical-align: -0.0391em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0785em;">
          X
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ∈
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8413em;">
         </span>
         <span class="mord">
          <span class="mord mathbb">
           R
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8413em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0813em;">
                  H
                 </span>
                 <span class="mbin mtight">
                  ×
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                  W
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     )（高 (
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        H 
        
       
      
        H
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0813em;">
          H
         </span>
        </span>
       </span>
      </span>
     </span>
     )，宽 (
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        W 
        
       
      
        W
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.1389em;">
          W
         </span>
        </span>
       </span>
      </span>
     </span>
     )），沿高度维度应用
     <code>
      unfold
     </code>
     ：
    </p>
    <pre><code class="prism language-python">X<span class="token punctuation">.</span>unfold<span class="token punctuation">(</span>dimension<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> size<span class="token operator">=</span>kh<span class="token punctuation">,</span> step<span class="token operator">=</span>stride<span class="token punctuation">)</span>
</code></pre>
    <ul>
     <li>
      (
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         k 
         
        
          h 
         
        
       
         kh
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6944em;">
          </span>
          <span class="mord mathnormal">
           kh
          </span>
         </span>
        </span>
       </span>
      </span>
      ) 是窗口高度。
     </li>
     <li>
      输出形状为 (
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         ( 
         
        
          H 
         
        
          − 
         
        
          k 
         
        
          h 
         
        
          + 
         
        
          1 
         
        
          ) 
         
        
          / 
         
        
          s 
         
        
          t 
         
        
          r 
         
        
          i 
         
        
          d 
         
        
          e 
         
        
          × 
         
        
          W 
         
        
          × 
         
        
          k 
         
        
          h 
         
        
       
         (H - kh + 1) / stride \times W \times kh
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0813em;">
           H
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           −
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.7778em; vertical-align: -0.0833em;">
          </span>
          <span class="mord mathnormal">
           kh
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           +
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord">
           1
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mord">
           /
          </span>
          <span class="mord mathnormal">
           s
          </span>
          <span class="mord mathnormal">
           t
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           r
          </span>
          <span class="mord mathnormal">
           i
          </span>
          <span class="mord mathnormal">
           d
          </span>
          <span class="mord mathnormal">
           e
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ×
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           W
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ×
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6944em;">
          </span>
          <span class="mord mathnormal">
           kh
          </span>
         </span>
        </span>
       </span>
      </span>
      )（假设步幅正好整除）。
     </li>
     <li>
      每个窗口是一个长度为 (
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         k 
         
        
          h 
         
        
       
         kh
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6944em;">
          </span>
          <span class="mord mathnormal">
           kh
          </span>
         </span>
        </span>
       </span>
      </span>
      ) 的向量，包含原始张量在该维度上的连续子区域。
     </li>
    </ul>
    <p>
     如果再沿宽度维度应用
     <code>
      unfold
     </code>
     ，可以得到所有二维 Patch。
    </p>
    <h4>
     <a id="_unfold_32">
     </a>
     示例：二维图像的
     <code>
      unfold
     </code>
    </h4>
    <p>
     假设有一个 (
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        4 
        
       
         × 
        
       
         4 
        
       
      
        4 \times 4
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
         </span>
         <span class="mord">
          4
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          ×
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6444em;">
         </span>
         <span class="mord">
          4
         </span>
        </span>
       </span>
      </span>
     </span>
     ) 的张量：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> torch

x <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"原始张量:"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>

<span class="token comment"># 沿高度维度展开，窗口大小为 2，步幅为 2</span>
x_unfolded <span class="token operator">=</span> x<span class="token punctuation">.</span>unfold<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n沿高度展开:"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>x_unfolded<span class="token punctuation">)</span>

<span class="token comment"># 再沿宽度维度展开，窗口大小为 2，步幅为 2</span>
x_unfolded <span class="token operator">=</span> x_unfolded<span class="token punctuation">.</span>unfold<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n沿宽度展开:"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>x_unfolded<span class="token punctuation">)</span>
</code></pre>
    <p>
     输出：
    </p>
    <pre><code>原始张量:
tensor([[ 0.,  1.,  2.,  3.],
        [ 4.,  5.,  6.,  7.],
        [ 8.,  9., 10., 11.],
        [12., 13., 14., 15.]])

沿高度展开:
tensor([[[ 0.,  1.,  2.,  3.],
         [ 4.,  5.,  6.,  7.]],
        [[ 8.,  9., 10., 11.],
         [12., 13., 14., 15.]]])

沿宽度展开:
tensor([[[[ 0.,  1.],
          [ 4.,  5.]],
         [[ 2.,  3.],
          [ 6.,  7.]]],
        [[[ 8.,  9.],
          [12., 13.]],
         [[10., 11.],
          [14., 15.]]]])
</code></pre>
    <ul>
     <li>
      第一次
      <code>
       unfold
      </code>
      将 (
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         4 
         
        
          × 
         
        
          4 
         
        
       
         4 \times 4
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
          </span>
          <span class="mord">
           4
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ×
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6444em;">
          </span>
          <span class="mord">
           4
          </span>
         </span>
        </span>
       </span>
      </span>
      ) 张量分成 (
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         2 
         
        
          × 
         
        
          4 
         
        
          × 
         
        
          2 
         
        
       
         2 \times 4 \times 2
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
          </span>
          <span class="mord">
           2
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ×
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
          </span>
          <span class="mord">
           4
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ×
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6444em;">
          </span>
          <span class="mord">
           2
          </span>
         </span>
        </span>
       </span>
      </span>
      ) 的张量（2 个高度块，每个块高 2，宽 4）。
     </li>
     <li>
      第二次
      <code>
       unfold
      </code>
      将每个高度块再分成 (
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         2 
         
        
          × 
         
        
          2 
         
        
          × 
         
        
          2 
         
        
       
         2 \times 2 \times 2
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
          </span>
          <span class="mord">
           2
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ×
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
          </span>
          <span class="mord">
           2
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ×
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6444em;">
          </span>
          <span class="mord">
           2
          </span>
         </span>
        </span>
       </span>
      </span>
      ) 的块，最终得到 (
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         2 
         
        
          × 
         
        
          2 
         
        
          × 
         
        
          2 
         
        
          × 
         
        
          2 
         
        
       
         2 \times 2 \times 2 \times 2
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
          </span>
          <span class="mord">
           2
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ×
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
          </span>
          <span class="mord">
           2
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ×
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
          </span>
          <span class="mord">
           2
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ×
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6444em;">
          </span>
          <span class="mord">
           2
          </span>
         </span>
        </span>
       </span>
      </span>
      ) 的张量，表示 4 个 (
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         2 
         
        
          × 
         
        
          2 
         
        
       
         2 \times 2
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
          </span>
          <span class="mord">
           2
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ×
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6444em;">
          </span>
          <span class="mord">
           2
          </span>
         </span>
        </span>
       </span>
      </span>
      ) 的 Patch。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="_ViT_Patch_Embedding_81">
     </a>
     在 ViT 中的应用：Patch Embedding
    </h3>
    <p>
     Vision Transformer (ViT) 的核心创新是将图像视为 Patch 序列，而不是传统 CNN 的像素网格。Patch Embedding 模块负责将输入图像分割为固定大小的 Patch，并将其嵌入到 Transformer 可处理的向量空间中。
     <code>
      unfold
     </code>
     在这里发挥了关键作用。具体可以参考笔者的另一篇博客：
     <a href="https://blog.csdn.net/shizheng_Li/article/details/146211685?spm=1001.2014.3001.5501">
      Vision Transformer (ViT)：将Transformer带入计算机视觉的革命性尝试（代码实现）
     </a>
    </p>
    <h4>
     <a id="ViT_Patch_Embedding__85">
     </a>
     ViT Patch Embedding 代码解析
    </h4>
    <p>
     以下是 ViT 中 Patch Embedding 的 PyTorch 实现（以 MNIST 为例，图像大小 (
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        28 
        
       
         × 
        
       
         28 
        
       
      
        28 \times 28
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
         </span>
         <span class="mord">
          28
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          ×
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6444em;">
         </span>
         <span class="mord">
          28
         </span>
        </span>
       </span>
      </span>
     </span>
     )）：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">PatchEmbedding</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image_size<span class="token punctuation">,</span> patch_size<span class="token punctuation">,</span> patch_dim<span class="token punctuation">,</span> dim<span class="token punctuation">,</span> dropout<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>num_patches <span class="token operator">=</span> <span class="token punctuation">(</span>image_size <span class="token operator">//</span> patch_size<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span>
        <span class="token comment"># 线性投影：将 Patch 展平并映射到 dim 维度</span>
        self<span class="token punctuation">.</span>proj <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>patch_dim<span class="token punctuation">,</span> dim<span class="token punctuation">)</span>
        <span class="token comment"># 位置编码</span>
        self<span class="token punctuation">.</span>pos_embedding <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_patches <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> dim<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># CLS Token</span>
        self<span class="token punctuation">.</span>cls_token <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> dim<span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>dropout<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        B <span class="token operator">=</span> x<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># Batch Size</span>
        <span class="token comment"># 将图像分割为 Patch 并展平</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>unfold<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> patch_size<span class="token punctuation">,</span> patch_size<span class="token punctuation">)</span><span class="token punctuation">.</span>unfold<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> patch_size<span class="token punctuation">,</span> patch_size<span class="token punctuation">)</span>  <span class="token comment"># (B, C, H/p, W/p, p, p)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># (B, H/p, W/p, C, p, p)</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span>B<span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_patches<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># (B, num_patches, patch_dim)</span>
        <span class="token comment"># 线性投影</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>proj<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># (B, num_patches, dim)</span>
        <span class="token comment"># 添加 CLS Token</span>
        cls_tokens <span class="token operator">=</span> self<span class="token punctuation">.</span>cls_token<span class="token punctuation">.</span>expand<span class="token punctuation">(</span>B<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># (B, 1, dim)</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>cls_tokens<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># (B, num_patches + 1, dim)</span>
        <span class="token comment"># 添加位置编码</span>
        x <span class="token operator">=</span> x <span class="token operator">+</span> self<span class="token punctuation">.</span>pos_embedding
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x
</code></pre>
    <h5>
     <a id="_117">
     </a>
     代码逐步解析
    </h5>
    <ol>
     <li>
      <p>
       <strong>
        输入张量
       </strong>
       ：
      </p>
      <ul>
       <li>
        输入 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           x 
           
          
         
           x
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.4306em;">
            </span>
            <span class="mord mathnormal">
             x
            </span>
           </span>
          </span>
         </span>
        </span>
        ) 的形状为 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           ( 
           
          
            B 
           
          
            , 
           
          
            C 
           
          
            , 
           
          
            H 
           
          
            , 
           
          
            W 
           
          
            ) 
           
          
         
           (B, C, H, W)
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1em; vertical-align: -0.25em;">
            </span>
            <span class="mopen">
             (
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0502em;">
             B
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0715em;">
             C
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0813em;">
             H
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="mclose">
             )
            </span>
           </span>
          </span>
         </span>
        </span>
        )，例如 MNIST 的 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           ( 
           
          
            B 
           
          
            , 
           
          
            1 
           
          
            , 
           
          
            28 
           
          
            , 
           
          
            28 
           
          
            ) 
           
          
         
           (B, 1, 28, 28)
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1em; vertical-align: -0.25em;">
            </span>
            <span class="mopen">
             (
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0502em;">
             B
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             1
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             28
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             28
            </span>
            <span class="mclose">
             )
            </span>
           </span>
          </span>
         </span>
        </span>
        )（灰度图，通道数 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           C 
           
          
            = 
           
          
            1 
           
          
         
           C=1
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6833em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0715em;">
             C
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
            <span class="mrel">
             =
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 0.6444em;">
            </span>
            <span class="mord">
             1
            </span>
           </span>
          </span>
         </span>
        </span>
        )）。
       </li>
       <li>
        (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           B 
           
          
         
           B
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6833em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0502em;">
             B
            </span>
           </span>
          </span>
         </span>
        </span>
        ) 是批次大小，(
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           H 
           
          
         
           H
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6833em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0813em;">
             H
            </span>
           </span>
          </span>
         </span>
        </span>
        ) 和 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           W 
           
          
         
           W
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6833em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
           </span>
          </span>
         </span>
        </span>
        ) 是图像高度和宽度。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        使用
        <code>
         unfold
        </code>
        分割 Patch
       </strong>
       ：
      </p>
      <ul>
       <li>
        <strong>
         高度维度
        </strong>
        ：
        <code>
         x.unfold(2, patch_size, patch_size)
        </code>
        将高度 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           H 
           
          
            = 
           
          
            28 
           
          
         
           H=28
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6833em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0813em;">
             H
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
            <span class="mrel">
             =
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 0.6444em;">
            </span>
            <span class="mord">
             28
            </span>
           </span>
          </span>
         </span>
        </span>
        ) 分成 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           H 
           
          
            / 
           
          
            p 
           
          
            = 
           
          
            28 
           
          
            / 
           
          
            7 
           
          
            = 
           
          
            4 
           
          
         
           H/p=28/7=4
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1em; vertical-align: -0.25em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0813em;">
             H
            </span>
            <span class="mord">
             /
            </span>
            <span class="mord mathnormal">
             p
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
            <span class="mrel">
             =
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 1em; vertical-align: -0.25em;">
            </span>
            <span class="mord">
             28/7
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
            <span class="mrel">
             =
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 0.6444em;">
            </span>
            <span class="mord">
             4
            </span>
           </span>
          </span>
         </span>
        </span>
        ) 个块，每个块大小为 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           p 
           
          
            = 
           
          
            7 
           
          
         
           p=7
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
            </span>
            <span class="mord mathnormal">
             p
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
            <span class="mrel">
             =
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 0.6444em;">
            </span>
            <span class="mord">
             7
            </span>
           </span>
          </span>
         </span>
        </span>
        )，步幅为 7（无重叠）。形状变为 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           ( 
           
          
            B 
           
          
            , 
           
          
            C 
           
          
            , 
           
          
            4 
           
          
            , 
           
          
            W 
           
          
            , 
           
          
            7 
           
          
            ) 
           
          
         
           (B, C, 4, W, 7)
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1em; vertical-align: -0.25em;">
            </span>
            <span class="mopen">
             (
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0502em;">
             B
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0715em;">
             C
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             4
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             7
            </span>
            <span class="mclose">
             )
            </span>
           </span>
          </span>
         </span>
        </span>
        )。
       </li>
       <li>
        <strong>
         宽度维度
        </strong>
        ：再次
        <code>
         unfold(3, patch_size, patch_size)
        </code>
        将宽度 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           W 
           
          
            = 
           
          
            28 
           
          
         
           W=28
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6833em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
            <span class="mrel">
             =
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 0.6444em;">
            </span>
            <span class="mord">
             28
            </span>
           </span>
          </span>
         </span>
        </span>
        ) 分成 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           W 
           
          
            / 
           
          
            p 
           
          
            = 
           
          
            4 
           
          
         
           W/p=4
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1em; vertical-align: -0.25em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="mord">
             /
            </span>
            <span class="mord mathnormal">
             p
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
            <span class="mrel">
             =
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 0.6444em;">
            </span>
            <span class="mord">
             4
            </span>
           </span>
          </span>
         </span>
        </span>
        ) 个块，形状变为 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           ( 
           
          
            B 
           
          
            , 
           
          
            C 
           
          
            , 
           
          
            4 
           
          
            , 
           
          
            4 
           
          
            , 
           
          
            7 
           
          
            , 
           
          
            7 
           
          
            ) 
           
          
         
           (B, C, 4, 4, 7, 7)
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1em; vertical-align: -0.25em;">
            </span>
            <span class="mopen">
             (
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0502em;">
             B
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0715em;">
             C
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             4
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             4
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             7
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             7
            </span>
            <span class="mclose">
             )
            </span>
           </span>
          </span>
         </span>
        </span>
        )。
       </li>
       <li>
        结果是 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           4 
           
          
            × 
           
          
            4 
           
          
            = 
           
          
            16 
           
          
         
           4 \times 4 = 16
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
            </span>
            <span class="mord">
             4
            </span>
            <span class="mspace" style="margin-right: 0.2222em;">
            </span>
            <span class="mbin">
             ×
            </span>
            <span class="mspace" style="margin-right: 0.2222em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 0.6444em;">
            </span>
            <span class="mord">
             4
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
            <span class="mrel">
             =
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 0.6444em;">
            </span>
            <span class="mord">
             16
            </span>
           </span>
          </span>
         </span>
        </span>
        ) 个 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           7 
           
          
            × 
           
          
            7 
           
          
         
           7 \times 7
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
            </span>
            <span class="mord">
             7
            </span>
            <span class="mspace" style="margin-right: 0.2222em;">
            </span>
            <span class="mbin">
             ×
            </span>
            <span class="mspace" style="margin-right: 0.2222em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 0.6444em;">
            </span>
            <span class="mord">
             7
            </span>
           </span>
          </span>
         </span>
        </span>
        ) 的 Patch。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        调整维度
       </strong>
       ：
      </p>
      <ul>
       <li>
        <code>
         permute(0, 2, 3, 1, 4, 5)
        </code>
        调整顺序为 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           ( 
           
          
            B 
           
          
            , 
           
          
            4 
           
          
            , 
           
          
            4 
           
          
            , 
           
          
            C 
           
          
            , 
           
          
            7 
           
          
            , 
           
          
            7 
           
          
            ) 
           
          
         
           (B, 4, 4, C, 7, 7)
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1em; vertical-align: -0.25em;">
            </span>
            <span class="mopen">
             (
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0502em;">
             B
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             4
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             4
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0715em;">
             C
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             7
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             7
            </span>
            <span class="mclose">
             )
            </span>
           </span>
          </span>
         </span>
        </span>
        )，将空间维度 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           ( 
           
          
            H 
           
          
            / 
           
          
            p 
           
          
            , 
           
          
            W 
           
          
            / 
           
          
            p 
           
          
            ) 
           
          
         
           (H/p, W/p)
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1em; vertical-align: -0.25em;">
            </span>
            <span class="mopen">
             (
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0813em;">
             H
            </span>
            <span class="mord">
             /
            </span>
            <span class="mord mathnormal">
             p
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="mord">
             /
            </span>
            <span class="mord mathnormal">
             p
            </span>
            <span class="mclose">
             )
            </span>
           </span>
          </span>
         </span>
        </span>
        ) 放在前面。
       </li>
       <li>
        <code>
         view(B, num_patches, -1)
        </code>
        将每个 Patch 展平为向量，形状变为 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           ( 
           
          
            B 
           
          
            , 
           
          
            16 
           
          
            , 
           
          
            49 
           
          
            ) 
           
          
         
           (B, 16, 49)
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1em; vertical-align: -0.25em;">
            </span>
            <span class="mopen">
             (
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0502em;">
             B
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             16
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             49
            </span>
            <span class="mclose">
             )
            </span>
           </span>
          </span>
         </span>
        </span>
        )（对于灰度图，(
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           p 
           
          
            a 
           
          
            t 
           
          
            c 
           
          
            h 
           
          
            _ 
           
          
            d 
           
          
            i 
           
          
            m 
           
          
            = 
           
          
            7 
           
          
            × 
           
          
            7 
           
          
            × 
           
          
            1 
           
          
            = 
           
          
            49 
           
          
         
           patch\_dim = 7 \times 7 \times 1 = 49
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1.0044em; vertical-align: -0.31em;">
            </span>
            <span class="mord mathnormal">
             p
            </span>
            <span class="mord mathnormal">
             a
            </span>
            <span class="mord mathnormal">
             t
            </span>
            <span class="mord mathnormal">
             c
            </span>
            <span class="mord mathnormal">
             h
            </span>
            <span class="mord" style="margin-right: 0.0278em;">
             _
            </span>
            <span class="mord mathnormal">
             d
            </span>
            <span class="mord mathnormal">
             im
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
            <span class="mrel">
             =
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
            </span>
            <span class="mord">
             7
            </span>
            <span class="mspace" style="margin-right: 0.2222em;">
            </span>
            <span class="mbin">
             ×
            </span>
            <span class="mspace" style="margin-right: 0.2222em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
            </span>
            <span class="mord">
             7
            </span>
            <span class="mspace" style="margin-right: 0.2222em;">
            </span>
            <span class="mbin">
             ×
            </span>
            <span class="mspace" style="margin-right: 0.2222em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 0.6444em;">
            </span>
            <span class="mord">
             1
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
            <span class="mrel">
             =
            </span>
            <span class="mspace" style="margin-right: 0.2778em;">
            </span>
           </span>
           <span class="base">
            <span class="strut" style="height: 0.6444em;">
            </span>
            <span class="mord">
             49
            </span>
           </span>
          </span>
         </span>
        </span>
        )）。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        线性投影
       </strong>
       ：
      </p>
      <ul>
       <li>
        <code>
         self.proj
        </code>
        将 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           49 
           
          
         
           49
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6444em;">
            </span>
            <span class="mord">
             49
            </span>
           </span>
          </span>
         </span>
        </span>
        ) 维 Patch 映射到目标维度 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           d 
           
          
            i 
           
          
            m 
           
          
         
           dim
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 0.6944em;">
            </span>
            <span class="mord mathnormal">
             d
            </span>
            <span class="mord mathnormal">
             im
            </span>
           </span>
          </span>
         </span>
        </span>
        )（例如 64），形状变为 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           ( 
           
          
            B 
           
          
            , 
           
          
            16 
           
          
            , 
           
          
            64 
           
          
            ) 
           
          
         
           (B, 16, 64)
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1em; vertical-align: -0.25em;">
            </span>
            <span class="mopen">
             (
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0502em;">
             B
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             16
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             64
            </span>
            <span class="mclose">
             )
            </span>
           </span>
          </span>
         </span>
        </span>
        )。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        添加 CLS Token 和位置编码
       </strong>
       ：
      </p>
      <ul>
       <li>
        CLS Token 扩展为 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           ( 
           
          
            B 
           
          
            , 
           
          
            1 
           
          
            , 
           
          
            64 
           
          
            ) 
           
          
         
           (B, 1, 64)
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1em; vertical-align: -0.25em;">
            </span>
            <span class="mopen">
             (
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0502em;">
             B
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             1
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             64
            </span>
            <span class="mclose">
             )
            </span>
           </span>
          </span>
         </span>
        </span>
        )，与 Patch 拼接后为 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           ( 
           
          
            B 
           
          
            , 
           
          
            17 
           
          
            , 
           
          
            64 
           
          
            ) 
           
          
         
           (B, 17, 64)
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1em; vertical-align: -0.25em;">
            </span>
            <span class="mopen">
             (
            </span>
            <span class="mord mathnormal" style="margin-right: 0.0502em;">
             B
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             17
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             64
            </span>
            <span class="mclose">
             )
            </span>
           </span>
          </span>
         </span>
        </span>
        )。
       </li>
       <li>
        位置编码 ( pos_embedding )（形状 (
        <span class="katex--inline">
         <span class="katex">
          <span class="katex-mathml">
           ( 
           
          
            1 
           
          
            , 
           
          
            17 
           
          
            , 
           
          
            64 
           
          
            ) 
           
          
         
           (1, 17, 64)
          </span>
          <span class="katex-html">
           <span class="base">
            <span class="strut" style="height: 1em; vertical-align: -0.25em;">
            </span>
            <span class="mopen">
             (
            </span>
            <span class="mord">
             1
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             17
            </span>
            <span class="mpunct">
             ,
            </span>
            <span class="mspace" style="margin-right: 0.1667em;">
            </span>
            <span class="mord">
             64
            </span>
            <span class="mclose">
             )
            </span>
           </span>
          </span>
         </span>
        </span>
        )）加到序列上，保留空间信息。
       </li>
      </ul>
     </li>
    </ol>
    <h5>
     <a id="unfold__138">
     </a>
     <code>
      unfold
     </code>
     的作用
    </h5>
    <ul>
     <li>
      <strong>
       高效性
      </strong>
      ：
      <code>
       unfold
      </code>
      避免了手动循环或切片，直接提取所有 Patch，计算效率高。
     </li>
     <li>
      <strong>
       灵活性
      </strong>
      ：通过调整
      <code>
       patch_size
      </code>
      和
      <code>
       step
      </code>
      ，可以轻松改变 Patch 大小和重叠程度。
     </li>
     <li>
      <strong>
       与 ViT 的契合
      </strong>
      ：ViT 需要将图像转为序列，
      <code>
       unfold
      </code>
      提供了自然的分块方式，符合 Transformer 的输入需求。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="unfold__145">
     </a>
     <code>
      unfold
     </code>
     的优势与局限
    </h3>
    <h4>
     <a id="_147">
     </a>
     优势
    </h4>
    <ol>
     <li>
      <strong>
       计算效率
      </strong>
      ：
      <code>
       unfold
      </code>
      是 PyTorch 的原生操作，底层优化良好，适合大批量图像处理。
     </li>
     <li>
      <strong>
       内存友好
      </strong>
      ：返回的张量是输入的视图（View），不复制数据，节省内存。
     </li>
     <li>
      <strong>
       直观性
      </strong>
      ：与卷积类似，易于理解和调试。
     </li>
    </ol>
    <h4>
     <a id="_152">
     </a>
     局限
    </h4>
    <ol>
     <li>
      <strong>
       边界处理
      </strong>
      ：如果图像大小不能被
      <code>
       patch_size
      </code>
      和
      <code>
       step
      </code>
      整除，部分区域可能被截断（需填充或调整输入）。
     </li>
     <li>
      <strong>
       步幅限制
      </strong>
      ：当前实现中步幅等于 Patch 大小（无重叠），若需重叠 Patch，需调整逻辑。
     </li>
     <li>
      <strong>
       维度管理
      </strong>
      ：多次
      <code>
       unfold
      </code>
      后维度复杂，需配合
      <code>
       permute
      </code>
      和
      <code>
       view
      </code>
      调整。
     </li>
    </ol>
    <hr/>
    <h3>
     <a id="_ViT__159">
     </a>
     在 ViT 中的意义
    </h3>
    <p>
     ViT 的创新在于将图像视为 Patch 序列，
     <code>
      unfold
     </code>
     是实现这一思想的关键步骤：
    </p>
    <ul>
     <li>
      <strong>
       序列化
      </strong>
      ：通过
      <code>
       unfold
      </code>
      分割，图像从二维网格变为 Transformer 可处理的一维序列。
     </li>
     <li>
      <strong>
       全局建模
      </strong>
      ：与 CNN 的局部卷积不同，ViT 依赖自注意力全局整合信息，
      <code>
       unfold
      </code>
      提供了基础输入。
     </li>
     <li>
      <strong>
       可扩展性
      </strong>
      ：对于更高分辨率图像（如 224x224 的 ImageNet），只需调整
      <code>
       patch_size
      </code>
      （如 16），即可生成更多 Patch。
     </li>
    </ul>
    <h4>
     <a id="MNIST__166">
     </a>
     示例：MNIST 上的可视化
    </h4>
    <p>
     假设输入一张 (
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        28 
        
       
         × 
        
       
         28 
        
       
      
        28 \times 28
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
         </span>
         <span class="mord">
          28
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          ×
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6444em;">
         </span>
         <span class="mord">
          28
         </span>
        </span>
       </span>
      </span>
     </span>
     ) 的 MNIST 图像，
     <code>
      unfold
     </code>
     生成了 16 个 (
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        7 
        
       
         × 
        
       
         7 
        
       
      
        7 \times 7
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
         </span>
         <span class="mord">
          7
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          ×
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6444em;">
         </span>
         <span class="mord">
          7
         </span>
        </span>
       </span>
      </span>
     </span>
     ) 的 Patch。每个 Patch 展平为 49 维向量，投影后作为 Transformer 的输入 token。这种分块方式保留了局部信息，同时通过位置编码和自注意力捕捉全局关系。
    </p>
    <hr/>
    <h3>
     <a id="_171">
     </a>
     扩展与优化建议
    </h3>
    <ol>
     <li>
      <strong>
       支持重叠 Patch
      </strong>
      ：
      <ul>
       <li>
        将
        <code>
         step
        </code>
        设为小于
        <code>
         patch_size
        </code>
        （如
        <code>
         step=5
        </code>
        ），生成重叠 Patch，增强局部细节捕捉。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       动态输入大小
      </strong>
      ：
      <ul>
       <li>
        对非整除的图像大小，添加填充（Padding）确保完整分割。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       替代实现
      </strong>
      ：
      <ul>
       <li>
        使用
        <code>
         torch.nn.functional.unfold
        </code>
        （而不是 Tensor 的
        <code>
         unfold
        </code>
        方法），一次性提取所有 Patch，可能更高效：
        <pre><code class="prism language-python">x <span class="token operator">=</span> F<span class="token punctuation">.</span>unfold<span class="token punctuation">(</span>x<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span>patch_size<span class="token punctuation">,</span> stride<span class="token operator">=</span>patch_size<span class="token punctuation">)</span>  <span class="token comment"># (B, C*p*p, num_patches)</span>
x <span class="token operator">=</span> x<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># (B, num_patches, C*p*p)</span>
</code></pre>
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h3>
     <a id="_186">
     </a>
     结语
    </h3>
    <p>
     <code>
      unfold
     </code>
     函数是 PyTorch 中一个强大而低调的工具，在 ViT 的 Patch Embedding 中扮演了至关重要的角色。它高效地将图像分割为 Patch，为 Transformer 的序列化输入奠定了基础。通过理解
     <code>
      unfold
     </code>
     的原理和用法，你不仅能更好地实现 ViT，还能将其应用于其他需要滑动窗口的任务（如时间序列分析或特征提取）。希望这篇博客为你提供了清晰的思路，欢迎留言讨论你的应用场景或优化想法！
    </p>
    <hr/>
    <h4>
     <a id="_192">
     </a>
     参考
    </h4>
    <ul>
     <li>
      PyTorch 官方文档：
      <a href="https://pytorch.org/docs/stable/generated/torch.Tensor.unfold.html" rel="nofollow">
       torch.Tensor.unfold
      </a>
     </li>
     <li>
      ViT 原始论文：
      <a href="https://arxiv.org/abs/2010.11929" rel="nofollow">
       An Image is Worth 16x16 Words
      </a>
     </li>
    </ul>
    <h3>
     <a id="_196">
     </a>
     后记
    </h3>
    <p>
     2025年3月12日19点45分于上海，在Grok 3大模型辅助下完成。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f7368697a68656e675f4c692f:61727469636c652f64657461696c732f313436323133313934" class_="artid" style="display:none">
 </p>
</div>


