---
layout: post
title: "Linuxç³»ç»Ÿçº¿ç¨‹æ§åˆ¶"
date: 2025-08-29T23:01:08+0800
description: "POSIXçº¿ç¨‹ï¼ˆpthreadsï¼‰æ˜¯Linuxç³»ç»Ÿå®ç°çš„å¤šçº¿ç¨‹ç¼–ç¨‹æ ‡å‡†ï¼Œé€šè¿‡glibcåº“æä¾›çº¿ç¨‹ç®¡ç†åŠŸèƒ½ã€‚æ ¸å¿ƒå†…å®¹åŒ…æ‹¬ï¼šçº¿ç¨‹åˆ›å»ºï¼ˆpthread_createï¼‰éœ€æŒ‡å®šçº¿ç¨‹å‡½æ•°å’Œå‚æ•°ï¼Œç¼–è¯‘æ—¶éœ€é“¾æ¥-lpthreadï¼›çº¿ç¨‹ç»ˆæ­¢å¯é€šè¿‡returnã€pthread_exitæˆ–pthread_cancelå®ç°ï¼›èµ„æºå›æ”¶é€šè¿‡pthread_joinï¼ˆå¯è¿æ¥çº¿ç¨‹ï¼‰æˆ–pthread_detachï¼ˆåˆ†ç¦»çº¿ç¨‹ï¼‰å®Œæˆã€‚çº¿ç¨‹ç®¡ç†é‡‡ç”¨&amp;quot;å…ˆæè¿°åç»„ç»‡&amp;quot;ç­–ç•¥ï¼Œé€šè¿‡çº¿ç¨‹æ§åˆ¶å—ï¼ˆTCBï¼‰ç»´æŠ¤çº¿ç¨‹çŠ¶æ€ï¼Œå¹¶ä¸å†…æ ¸åä½œå®ç°çœŸæ­£"
keywords: "ã€Linuxç³»ç»Ÿã€‘çº¿ç¨‹æ§åˆ¶"
categories: ['æœªåˆ†ç±»']
tags: ['çº¿ç¨‹æ§åˆ¶', 'çº¿ç¨‹', 'Linux']
artid: "150932046"
arturl: "https://blog.csdn.net/2402_82670467/article/details/150932046"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=150932046
    alt: "Linuxç³»ç»Ÿçº¿ç¨‹æ§åˆ¶"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=150932046
featuredImagePreview: https://bing.ee123.net/img/rand?artid=150932046
cover: https://bing.ee123.net/img/rand?artid=150932046
image: https://bing.ee123.net/img/rand?artid=150932046
img: https://bing.ee123.net/img/rand?artid=150932046
---



# ã€Linuxç³»ç»Ÿã€‘çº¿ç¨‹æ§åˆ¶


[![](https://csdnimg.cn/release/blogv2/dist/pc/img/activeVector.png)
AIcodingÂ·å…«æœˆåˆ›ä½œä¹‹æ˜ŸæŒ‘æˆ˜èµ›
10w+äººæµè§ˆ
128äººå‚ä¸

![](https://csdnimg.cn/release/blogv2/dist/pc/img/arrowright-line-White.png)](https://activity.csdn.net/writing?id=10931)

## 1. POSIXçº¿ç¨‹åº“ (pthreads)

POSIXçº¿ç¨‹ï¼ˆé€šå¸¸ç§°ä¸ºpthreadsï¼‰æ˜¯IEEEåˆ¶å®šçš„æ“ä½œç³»ç»Ÿçº¿ç¨‹APIæ ‡å‡†ã€‚Linuxç³»ç»Ÿé€šè¿‡glibcåº“å®ç°äº†è¿™ä¸ªæ ‡å‡†ï¼Œæä¾›äº†åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹çš„ä¸€ç³»åˆ—å‡½æ•°ã€‚

**æ ¸å¿ƒç‰¹æ€§**

* **å‘½åçº¦å®š**ï¼šç»å¤§å¤šæ•°å‡½æ•°éƒ½ä»¥Â `pthread_`Â å¼€å¤´ï¼Œè¿™ä½¿å¾—ä»£ç ä¸­çº¿ç¨‹ç›¸å…³çš„æ“ä½œéå¸¸æ¸…æ™°æ˜“è¾¨ã€‚
* **å¤´æ–‡ä»¶**ï¼šä½¿ç”¨Â `#include <pthread.h>`Â æ¥åŒ…å«æ‰€æœ‰æ•°æ®ç±»å‹å’Œå‡½æ•°çš„å£°æ˜ã€‚
* **é“¾æ¥åº“**ï¼šç¼–è¯‘æ—¶å¿…é¡»æ·»åŠ Â `-lpthread`Â æˆ–Â `-pthread`Â é“¾æ¥é€‰é¡¹æ¥é“¾æ¥çº¿ç¨‹åº“ã€‚

  + **`-pthread`**Â é€šå¸¸æ˜¯æ›´æ¨èçš„é€‰æ‹©ï¼Œå› ä¸ºå®ƒé™¤äº†é“¾æ¥åº“ä¹‹å¤–ï¼Œè¿˜å¯èƒ½å®šä¹‰å¿…è¦çš„é¢„å¤„ç†å®ï¼Œç¡®ä¿ä»£ç çš„å¯ç§»æ¤æ€§ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦Â `-lpthread`Â é€‰é¡¹ï¼Ÿ**

è¿™æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„å®è·µç‚¹ã€‚Cè¯­è¨€çš„æ ‡å‡†åº“ï¼ˆlibcï¼‰é»˜è®¤ä¸åŒ…å«pthreadå‡½æ•°çš„å…·ä½“å®ç°ã€‚è¿™äº›å®ç°å­˜åœ¨äºä¸€ä¸ªç‹¬ç«‹çš„å…±äº«åº“æ–‡ä»¶ä¸­ï¼Œé€šå¸¸æ˜¯Â `libpthread.so`ã€‚

* `-l`Â é€‰é¡¹å‘Šè¯‰é“¾æ¥å™¨ï¼ˆldï¼‰è¦å»é“¾æ¥ä¸€ä¸ªåº“ã€‚
* `pthread`Â æ˜¯Â `libpthread.so`Â çš„ç®€å†™ï¼ˆé“¾æ¥å™¨ä¼šè‡ªåŠ¨æ·»åŠ Â `lib`Â å‰ç¼€å’ŒÂ `.so`Â åç¼€ï¼‰ã€‚

å› æ­¤ï¼Œ`-lpthread`Â çš„æœ¬è´¨æ˜¯ï¼š**â€œé“¾æ¥å™¨ï¼Œè¯·å°†æˆ‘ä»¬çš„ç¨‹åºä¸åä¸ºÂ `libpthread.so`Â çš„å…±äº«åº“é“¾æ¥èµ·æ¥ï¼Œä»¥ä¾¿è§£ææ‰€æœ‰ä»¥Â `pthread_`Â å¼€å¤´çš„å‡½æ•°ã€‚â€**

---

## 2. çº¿ç¨‹åˆ›å»º

### **å‡½æ•°åŸå‹ä¸æ ¸å¿ƒæœºåˆ¶**

```

#include <pthread.h>
int pthread_create(
    pthread_t *thread,               // çº¿ç¨‹æ ‡è¯†ç¬¦ï¼ˆè¾“å‡ºå‚æ•°ï¼‰
    const pthread_attr_t *attr,       // çº¿ç¨‹å±æ€§ï¼ˆå¯ä¸ºNULLï¼‰
    void *(*start_routine)(void *),  // çº¿ç¨‹å…¥å£å‡½æ•°æŒ‡é’ˆ
    void *arg                         // å…¥å£å‡½æ•°çš„å‚æ•°
);
```

**1.Â `pthread_t *thread`Â - çº¿ç¨‹æ ‡è¯†ç¬¦**

* **ç”¨é€”**ï¼šè¿™æ˜¯ä¸€ä¸ªè¾“å‡ºå‚æ•°ï¼Œå‡½æ•°æˆåŠŸè¿”å›åï¼Œä¼šåœ¨æ­¤å¤„å¡«å……æ–°åˆ›å»ºçº¿ç¨‹çš„æ ‡è¯†ç¬¦ã€‚
* **æœ¬è´¨**ï¼š`pthread_t`Â æ˜¯ä¸€ä¸ªä¸é€æ˜çš„æ•°æ®ç±»å‹ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªæ•´æ•°æˆ–ç»“æ„ä½“æŒ‡é’ˆï¼Œå…·ä½“å®ç°å–å†³äºç³»ç»Ÿï¼ˆLinuxä¸­ä¸º`unsigned long`ï¼ŒmacOSä¸­ä¸ºç»“æ„ä½“ï¼‰ã€‚
* **é‡è¦æç¤º**ï¼šä¸è¦å‡è®¾Â `pthread_t`Â æ˜¯æ•´æ•°ç±»å‹ï¼Œå¦‚æœéœ€è¦æ¯”è¾ƒçº¿ç¨‹IDï¼Œåº”ä½¿ç”¨Â `pthread_equal()`Â å‡½æ•°ã€‚è·å–å½“å‰çº¿ç¨‹IDä½¿ç”¨Â `pthread_self()`ã€‚

**2.Â `const pthread_attr_t *attr`Â - çº¿ç¨‹å±æ€§**

* **ç”¨é€”**ï¼šæŒ‡å®šæ–°çº¿ç¨‹çš„å±æ€§ã€‚å¦‚æœä¸ºÂ `NULL`ï¼Œåˆ™ä½¿ç”¨é»˜è®¤å±æ€§ã€‚
* **å¯é…ç½®å±æ€§**åŒ…æ‹¬ï¼š

  + åˆ†ç¦»çŠ¶æ€ï¼ˆdetached stateï¼‰
  + è°ƒåº¦ç­–ç•¥å’Œå‚æ•°ï¼ˆscheduling policy and parametersï¼‰
  + æ ˆå¤§å°ï¼ˆstack sizeï¼‰
  + æ ˆåœ°å€ï¼ˆstack addressï¼‰
  + å®ˆå«åŒºå¤§å°ï¼ˆguard sizeï¼‰
  + çº¿ç¨‹çš„ç«äº‰èŒƒå›´ï¼ˆcontention scopeï¼‰

**3.Â `void *(*start_routine)(void*)`Â - çº¿ç¨‹å‡½æ•°**

* **å½¢å¼**ï¼šçº¿ç¨‹å‡½æ•°å¿…é¡»ç¬¦åˆç‰¹å®šçš„ç­¾å - æ¥å—ä¸€ä¸ªÂ `void*`Â å‚æ•°å¹¶è¿”å›ä¸€ä¸ªÂ `void*`Â å€¼ã€‚
* **æ‰§è¡Œæµç¨‹**ï¼šæ–°çº¿ç¨‹ä»Â `start_routine`Â å‡½æ•°çš„å¼€å§‹å¤„æ‰§è¡Œï¼Œç›´åˆ°ï¼š

  1. å‡½æ•°è¿”å›ï¼ˆçº¿ç¨‹éšå¼ç»ˆæ­¢ï¼‰
  2. è°ƒç”¨Â `pthread_exit()`ï¼ˆçº¿ç¨‹æ˜¾å¼ç»ˆæ­¢ï¼‰
  3. è¢«å…¶ä»–çº¿ç¨‹å–æ¶ˆï¼ˆ`pthread_cancel()`ï¼‰
* **è¿”å›å€¼**ï¼šçº¿ç¨‹å‡½æ•°çš„è¿”å›å€¼å¯ä»¥é€šè¿‡Â `pthread_join()`Â è·å–ã€‚

**4.Â `void *arg`Â - çº¿ç¨‹å‚æ•°**

* **ç”¨é€”**ï¼šä¼ é€’ç»™çº¿ç¨‹å‡½æ•°çš„å‚æ•°ã€‚
* **çµæ´»æ€§**ï¼šç”±äºæ˜¯Â `void*`Â ç±»å‹ï¼Œå¯ä»¥ä¼ é€’ä»»ä½•æ•°æ®ç±»å‹çš„åœ°å€ã€‚
* **æ³¨æ„äº‹é¡¹**ï¼š

  + ç¡®ä¿å‚æ•°åœ¨çº¿ç¨‹ä½¿ç”¨æœŸé—´ä¿æŒæœ‰æ•ˆ
  + å¦‚æœä¼ é€’æ ˆä¸Šå˜é‡çš„åœ°å€ï¼Œè¦ç¡®ä¿åŸå‡½æ•°ä¸ä¼šåœ¨çº¿ç¨‹ä½¿ç”¨å‰è¿”å›
  + é€šå¸¸ä½¿ç”¨åŠ¨æ€åˆ†é…çš„å†…å­˜æˆ–å…¨å±€å˜é‡ä¼ é€’æ•°æ®

### è¿”å›å€¼ä¸é”™è¯¯å¤„ç†

* **æˆåŠŸ**ï¼šè¿”å› 0
* **å¤±è´¥**ï¼šè¿”å›é”™è¯¯ç ï¼ˆéé›¶å€¼ï¼‰ï¼Œ**ä¸è®¾ç½®**Â `errno`
* **å¸¸è§é”™è¯¯ç **ï¼š

  + `EAGAIN`ï¼šç³»ç»Ÿèµ„æºä¸è¶³ï¼Œæ— æ³•åˆ›å»ºçº¿ç¨‹ï¼Œæˆ–å·²è¶…è¿‡çº¿ç¨‹æ•°é‡é™åˆ¶
  + `EINVAL`ï¼š`attr`Â å‚æ•°æ— æ•ˆ
  + `EPERM`ï¼šæ²¡æœ‰æƒé™è®¾ç½®æŒ‡å®šçš„è°ƒåº¦ç­–ç•¥æˆ–å‚æ•°

**ç¤ºä¾‹ï¼š**

```

#include <iostream>
#include <string>
#include <pthread.h>
#include <sys/types.h>
#include <unistd.h>

void *routine(void *arg)
{
    std::string name = static_cast<const char*>(arg);
    int cnt = 5;
    while(cnt--)
    {
        std::cout << "æˆ‘æ˜¯ä¸€ä¸ªæ–°çº¿ç¨‹: " << name << ", pid: " << getpid() << std::endl;
        sleep(1);
    }
    return nullptr;
}

int main()
{
    pthread_t tid;
    pthread_create(&tid, nullptr, routine, (void *)"thread-1");

    while (true)
    {
        std::cout << "mainä¸»çº¿ç¨‹, pid: " << getpid() << std::endl;
        sleep(1);
    }
    return 0;
}
```

**è¿è¡Œç»“æœï¼š**

```

ltx@iv-ye1i2elts0wh2yp1ahah:~/gitLinux/Linux_system/lesson_thread/ThreadControl$ ./test
mainä¸»çº¿ç¨‹, pid: 221797
æˆ‘æ˜¯ä¸€ä¸ªæ–°çº¿ç¨‹: thread-1, pid: 221797
mainä¸»çº¿ç¨‹, pid: æˆ‘æ˜¯ä¸€ä¸ªæ–°çº¿ç¨‹: thread-1221797, pid: 
221797
mainä¸»çº¿ç¨‹, pid: 221797
æˆ‘æ˜¯ä¸€ä¸ªæ–°çº¿ç¨‹: thread-1, pid: 221797
mainä¸»çº¿ç¨‹, pid: 221797
æˆ‘æ˜¯ä¸€ä¸ªæ–°çº¿ç¨‹: thread-1, pid: 221797
mainä¸»çº¿ç¨‹, pid: 221797
æˆ‘æ˜¯ä¸€ä¸ªæ–°çº¿ç¨‹: thread-1, pid: 221797
mainä¸»çº¿ç¨‹, pid: 221797
mainä¸»çº¿ç¨‹, pid: 221797
mainä¸»çº¿ç¨‹, pid: 221797
mainä¸»çº¿ç¨‹, pid: 221797
mainä¸»çº¿ç¨‹, pid: 221797
mainä¸»çº¿ç¨‹, pid: 221797
```

æ³¨æ„ï¼šåˆ›å»ºæ–°çº¿ç¨‹åï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶å‘æ˜¾ç¤ºå±è¾“å‡ºï¼Œä¼šé€ æˆæ•°æ®ç«äº‰ï¼Œå¯¼è‡´æ‰“å°çš„è¾“å‡ºä¿¡æ¯æ··åœ¨äº†ä¸€èµ·

é€šè¿‡ ps -aL æŒ‡ä»¤å¯ä»¥æŸ¥çœ‹ï¼Œ-L é€‰é¡¹ï¼šæ‰“å°çº¿ç¨‹ä¿¡æ¯

```

ltx@iv-ye1i2elts0wh2yp1ahah:~/gitLinux/Linux_system/lesson_thread/ThreadControl$ while :; do ps -aL | head -1 && ps -aL | grep test ; sleep 1 ; done
    PID     LWP TTY          TIME CMD
    PID     LWP TTY          TIME CMD
    PID     LWP TTY          TIME CMD
 221797  221797 pts/4    00:00:00 test
 221797  221798 pts/4    00:00:00 test
    PID     LWP TTY          TIME CMD
 221797  221797 pts/4    00:00:00 test
 221797  221798 pts/4    00:00:00 test
    PID     LWP TTY          TIME CMD
 221797  221797 pts/4    00:00:00 test
 221797  221798 pts/4    00:00:00 test
    PID     LWP TTY          TIME CMD
 221797  221797 pts/4    00:00:00 test
 221797  221798 pts/4    00:00:00 test
    PID     LWP TTY          TIME CMD
 221797  221797 pts/4    00:00:00 test
 221797  221798 pts/4    00:00:00 test
    PID     LWP TTY          TIME CMD
 221797  221797 pts/4    00:00:00 test
    PID     LWP TTY          TIME CMD
 221797  221797 pts/4    00:00:00 test
    PID     LWP TTY          TIME CMD
 221797  221797 pts/4    00:00:00 test
    PID     LWP TTY          TIME CMD
 221797  221797 pts/4    00:00:00 test
    PID     LWP TTY          TIME CMD
 221797  221797 pts/4    00:00:00 test
    PID     LWP TTY          TIME CMD
    PID     LWP TTY          TIME CMD
    PID     LWP TTY          TIME CMD

```

**PID (è¿›ç¨‹ID)**: ä¸¤ä¸ªçº¿ç¨‹éƒ½æœ‰**ç›¸åŒçš„PID (221797)**ã€‚è¿™è¯æ˜äº†å®ƒä»¬å±äºåŒä¸€ä¸ªè¿›ç¨‹ã€‚

**LWP (è½»é‡çº§è¿›ç¨‹ID)**: æ¯ä¸ªçº¿ç¨‹æœ‰**ä¸åŒçš„LWP (221797 å’Œ 221798)**ã€‚

* LWPæ˜¯çº¿ç¨‹åœ¨å†…æ ¸ä¸­çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚
* ä¸»çº¿ç¨‹çš„LWPé€šå¸¸ç­‰äºPIDã€‚
* å…¶ä»–çº¿ç¨‹æœ‰è‡ªå·±å”¯ä¸€çš„LWPã€‚

**å¯ä»¥ç›´è§‚æ„Ÿå—åˆ°ï¼Œçº¿ç¨‹æœ¬è´¨ä¸Šå°±æ˜¯å…±äº«ç›¸åŒåœ°å€ç©ºé—´å’Œå…¶ä»–èµ„æºçš„"è½»é‡çº§è¿›ç¨‹"**ã€‚

é‚£tidæ˜¯å•¥å‘¢ï¼Ÿæˆ‘ä»¬ä¹Ÿå¯ä»¥å°†tidæ‰“å°å‡ºæ¥çœ‹ä¸€ä¸‹ï¼Œé€šè¿‡ pthread åº“ä¸­å‡½æ•° pthread_self çš„è¿”å›å€¼å¾—åˆ°

### pthread_selfÂ - è·å–å½“å‰çº¿ç¨‹ID

**å‡½æ•°åŸå‹**

```

#include <pthread.h>
pthread_t pthread_self(void);

```

* **å‚æ•°**ï¼šæ— 
* **è¿”å›å€¼**ï¼š`pthread_t`Â ç±»å‹ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†ç¬¦
* **é”™è¯¯ç **ï¼šæ°¸ä¸å¤±è´¥ï¼ˆæ€»æ˜¯æˆåŠŸï¼‰

**çº¿ç¨‹ ID (`pthread_t`) çš„æœ¬è´¨**

* **æ•°æ®ç±»å‹**ï¼š
  + é€šå¸¸ä¸ºÂ `unsigned long`ï¼ˆLinux å®ç°ï¼‰
  + å…·ä½“ç±»å‹ç”±æ“ä½œç³»ç»Ÿå®ç°å®šä¹‰ï¼Œå¯èƒ½æ˜¯æ•´å‹æˆ–ç»“æ„ä½“
* **ç”Ÿå‘½å‘¨æœŸ**ï¼š
  + æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ ID å”¯ä¸€
  + **ç»ˆæ­¢å ID å¯è¢«æ–°çº¿ç¨‹å¤ç”¨**ï¼ˆéæ°¸ä¹…å”¯ä¸€ï¼‰
* **ä½œç”¨åŸŸ**ï¼šä»…åœ¨åŒä¸€è¿›ç¨‹å†…æœ‰æ•ˆï¼Œè·¨è¿›ç¨‹æ— æ„ä¹‰

**ç¤ºä¾‹ï¼š**

```

#include <iostream>
#include <string>
#include <pthread.h>
#include <sys/types.h>
#include <unistd.h>

void showid()
{
    printf("tid: %lu\n", pthread_self());
}

void *routine(void *arg)
{
    std::string name = static_cast<const char*>(arg);
    int cnt = 5;
    while(cnt--)
    {
        std::cout << "æˆ‘æ˜¯ä¸€ä¸ªæ–°çº¿ç¨‹: " << name << ", pid: " << getpid() << std::endl;
        sleep(1);
    }
    return nullptr;
}

int main()
{
    pthread_t tid;
    pthread_create(&tid, nullptr, routine, (void *)"thread-1");
    showid();

    while (true)
    {
        std::cout << "mainä¸»çº¿ç¨‹, pid: " << getpid() << std::endl;
        sleep(1);
    }
    return 0;
}
```

**è¿è¡Œç»“æœï¼š**

![](https://i-blog.csdnimg.cn/direct/ee76f932165e442a9ee0d63f88949c0a.png)

### æ·±å…¥ç†è§£ä¸¤ç§â€œçº¿ç¨‹IDâ€

åœ¨Linuxç³»ç»Ÿä¸­ï¼Œå®é™…ä¸Šå­˜åœ¨**ä¸¤ç§ä¸åŒæ„ä¹‰ä¸Šçš„â€œçº¿ç¨‹IDâ€**ï¼Œå®ƒä»¬å¤„äºä¸åŒçš„æŠ½è±¡å±‚æ¬¡ï¼Œæœ‰ä¸åŒçš„ç”¨é€”ã€‚

#### 1.Â `pthread_t`Â (POSIXçº¿ç¨‹ID) -Â **ç”¨æˆ·æ€/åº“çº§åˆ«ID**

* **æ¥æº**ï¼šç”±**pthreadçº¿ç¨‹åº“**åˆ†é…å’Œç®¡ç†ã€‚
* **æœ¬è´¨**ï¼šåœ¨Linuxçš„glibcå®ç°ä¸­ï¼Œå®ƒç¡®å®æ˜¯ä¸€ä¸ª**å†…å­˜åœ°å€**ã€‚å…·ä½“æ¥è¯´ï¼Œå®ƒæ˜¯è¯¥çº¿ç¨‹çš„**çº¿ç¨‹æ§åˆ¶ç»“æ„ï¼ˆTCB, Thread Control Blockï¼‰åœ¨è¿›ç¨‹åœ°å€ç©ºé—´ä¸­çš„åœ°å€**ã€‚
* **ä½œç”¨åŸŸ**ï¼š**è¿›ç¨‹å†…æœ‰æ•ˆ**ã€‚å®ƒåªåœ¨å½“å‰è¿›ç¨‹å†…æœ‰æ„ä¹‰ï¼Œç”¨äºåœ¨pthreadåº“çš„å‡½æ•°ä¸­æ ‡è¯†çº¿ç¨‹ï¼ˆå¦‚`pthread_join`,Â `pthread_cancel`ç­‰ï¼‰ã€‚å†…æ ¸å®Œå…¨ä¸çŸ¥é“è¿™ä¸ªIDçš„å­˜åœ¨ã€‚
* **ç”¨é€”**ï¼šç”¨äº**åŒä¸€è¿›ç¨‹å†…**çš„çº¿ç¨‹é—´æ“ä½œå’ŒåŒæ­¥ã€‚
* **ç‰¹ç‚¹**ï¼š

  + å¯ç§»æ¤æ€§å·®ã€‚ä¸åŒæ“ä½œç³»ç»Ÿæˆ–ä¸åŒlibcå®ç°å¯èƒ½ç”¨ä¸åŒçš„æ–¹å¼è¡¨ç¤º`pthread_t`ï¼ˆç»“æ„ä½“ã€æ•´æ•°ç­‰ï¼‰ã€‚
  + ä½¿ç”¨`pthread_equal()`æ¥æ¯”è¾ƒï¼Œä¸è¦ç›´æ¥ç”¨`==`ï¼ˆä¸ºäº†å¯ç§»æ¤æ€§ï¼‰ã€‚
  + ä½¿ç”¨`pthread_self()`è·å–ã€‚

#### 2. LWP (Light Weight Process ID) / TID (Thread ID) -Â **å†…æ ¸æ€/ç³»ç»Ÿçº§åˆ«ID**

* **æ¥æº**ï¼šç”±**Linuxå†…æ ¸**åˆ†é…å’Œç®¡ç†ã€‚
* **æœ¬è´¨**ï¼šè¿™æ˜¯ä¸€ä¸ª`pid_t`ç±»å‹çš„æ•´æ•°ï¼Œä¸è¿›ç¨‹PIDå±äºåŒä¸€ç§ç±»å‹ã€‚å†…æ ¸ä¸ºæ¯ä¸€ä¸ªè°ƒåº¦å®ä½“ï¼ˆæ— è®ºæ˜¯è¿›ç¨‹è¿˜æ˜¯çº¿ç¨‹ï¼‰éƒ½åˆ†é…ä¸€ä¸ªå”¯ä¸€çš„IDã€‚
* **ä½œç”¨åŸŸ**ï¼š**ç³»ç»Ÿå…¨å±€æœ‰æ•ˆ**ã€‚åœ¨æ•´ä¸ªæ“ä½œç³»ç»ŸèŒƒå›´å†…å”¯ä¸€æ ‡è¯†ä¸€ä¸ªè°ƒåº¦ä»»åŠ¡ã€‚
* **ç”¨é€”**ï¼šç”¨äº**ç³»ç»Ÿçº§**çš„ç›‘æ§ã€è°ƒåº¦å’Œè°ƒè¯•ã€‚`top`,Â `ps`,Â `perf`ç­‰å·¥å…·çœ‹åˆ°å’Œä½¿ç”¨çš„å°±æ˜¯è¿™ä¸ªIDã€‚
* **ç‰¹ç‚¹**ï¼š

  + åœ¨Linuxä¸­ï¼Œå¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨`gettid()`æ¥è·å–ã€‚
  + ä¸»çº¿ç¨‹çš„LWPç­‰äºè¿›ç¨‹çš„PIDã€‚
  + å…¶ä»–çº¿ç¨‹çš„LWPæ˜¯å†…æ ¸åˆ†é…çš„æ–°IDã€‚

#### å…³é”®ç‚¹è¯¦è§£

**â€œpthread_self å¾—åˆ°çš„è¿™ä¸ªæ•°å®é™…ä¸Šæ˜¯ä¸€ä¸ªåœ°å€â€**

**â€œLWP å¾—åˆ°çš„æ˜¯çœŸæ­£çš„çº¿ç¨‹IDâ€**

ä»å†…æ ¸è§†è§’çœ‹ï¼ŒLWPï¼ˆç”±`gettid()`è¿”å›ï¼‰æ‰æ˜¯çº¿ç¨‹çš„â€œçœŸå®èº«ä»½â€ï¼Œæ˜¯è°ƒåº¦å’Œèµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ã€‚

**â€œä¸»çº¿ç¨‹å’Œå…¶ä»–çº¿ç¨‹çš„æ ˆä½ç½®â€**

å¯¹æ ˆä½ç½®çš„æè¿°æ˜¯Linuxçº¿ç¨‹å®ç°çš„å¦ä¸€ä¸ªå…³é”®ç‚¹ï¼

* **ä¸»çº¿ç¨‹çš„æ ˆ**ï¼šä½äºè¿›ç¨‹**è™šæ‹Ÿåœ°å€ç©ºé—´çš„æ ˆåŒºåŸŸ**ã€‚è¿™ä¸ªæ ˆæ˜¯åœ¨ç¨‹åºå¯åŠ¨æ—¶ç”±å†…æ ¸è‡ªåŠ¨è®¾ç½®çš„ï¼Œå¤§å°é€šå¸¸ç”±ç³»ç»Ÿé™åˆ¶å†³å®šï¼ˆå¯ä»¥ç”¨`ulimit -s`æŸ¥çœ‹ï¼‰ã€‚
* **å…¶ä»–çº¿ç¨‹çš„æ ˆ**ï¼šç”±**pthreadåº“**åœ¨è¿›ç¨‹çš„**å †å’Œæ ˆä¹‹é—´çš„å…±äº«åŒºåŸŸ**ä¸­**åŠ¨æ€åˆ†é…**ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ`pthread_create`å¯ä»¥æŒ‡å®šæ ˆå¤§å°çš„åŸå› ã€‚

  + çº¿ç¨‹æ ˆçš„åˆ†é…å’Œç®¡ç†æ˜¯pthreadåº“çš„èŒè´£ã€‚
  + å½“çº¿ç¨‹é€€å‡ºæ—¶ï¼Œpthreadåº“è´Ÿè´£å›æ”¶è¿™ç‰‡æ ˆå†…å­˜ã€‚

![](https://i-blog.csdnimg.cn/direct/d3cd09e4cf224f1ab75caba53d8bd76e.png)

#### ä¸ºä»€ä¹ˆè¦è®¾è®¡ä¸¤å±‚IDï¼Ÿ

è¿™ç§è®¾è®¡ä½“ç°äº†ä¼˜ç§€çš„**æŠ½è±¡åˆ†å±‚**æ€æƒ³ï¼š

1. **å¯ç§»æ¤æ€§**ï¼šPOSIXæ ‡å‡†åªå®šä¹‰äº†`pthread_t`ï¼Œä¸å…³å¿ƒåº•å±‚å®ç°ã€‚åº”ç”¨ç¨‹åºä½¿ç”¨`pthread_t`å¯ä»¥ä¿è¯åœ¨ä¸åŒUNIXç³»ç»Ÿä¹‹é—´çš„å¯ç§»æ¤æ€§ã€‚
2. **çµæ´»æ€§**ï¼špthreadåº“å¯ä»¥è‡ªç”±é€‰æ‹©å¦‚ä½•å®ç°å’Œç®¡ç†çº¿ç¨‹ï¼Œæ¯”å¦‚å°†TCBç»“æ„ä½“æ”¾åœ¨å †ä¸Šï¼Œå¹¶ç”¨å…¶åœ°å€ä½œä¸ºIDã€‚
3. **æ•ˆç‡**ï¼šç”¨æˆ·æ€çš„çº¿ç¨‹æ“ä½œï¼ˆå¦‚è·å–è‡ªèº«IDï¼‰éå¸¸å¿«ï¼Œæ— éœ€é™·å…¥å†…æ ¸ã€‚
4. **å†…æ ¸ç®€æ´æ€§**ï¼šå†…æ ¸ä¸éœ€è¦ç†è§£å¤æ‚çš„çº¿ç¨‹åº“æ•°æ®ç»“æ„ï¼Œå®ƒåªéœ€è¦ç®¡ç†å¥½è½»é‡çº§è¿›ç¨‹ï¼ˆLWPï¼‰çš„è°ƒåº¦å³å¯ã€‚

å› æ­¤ï¼š

* ç”¨`pthread_self()`å¾—åˆ°çš„IDæ˜¯**ç»™pthreadåº“ç”¨çš„**ï¼Œç”¨äºè¿›ç¨‹å†…çº¿ç¨‹ç®¡ç†ã€‚
* ç”¨`gettid()`æˆ–`ps -L`çœ‹åˆ°çš„LWPæ˜¯**ç»™å†…æ ¸ç”¨çš„**ï¼Œç”¨äºç³»ç»Ÿçº§ä»»åŠ¡è°ƒåº¦ã€‚
* ä¸¤è€…å„å¸å…¶èŒï¼Œå…±åŒæ„æˆäº†Linuxå¼ºå¤§è€Œçµæ´»çš„å¤šçº¿ç¨‹èƒ½åŠ›ã€‚

![](https://i-blog.csdnimg.cn/direct/32a8d0d03a9d4a5bb977864e5b045bee.png)

é‚£æ—¢ç„¶åœ¨å†…æ ¸ä¸­ï¼Œç”±åº“æ¥å®ç°å’Œç®¡ç†çº¿ç¨‹ï¼Œé‚£è¦å¦‚ä½•ç®¡ç†èµ·æ¥å‘¢ï¼Ÿå…ˆæè¿°å†ç»„ç»‡

### pthreadsåº“å¦‚ä½•"å…ˆæè¿°ï¼Œå†ç»„ç»‡"åœ°ç®¡ç†çº¿ç¨‹

pthreadsåº“è™½ç„¶è¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œä½†å®ƒé€šè¿‡ç²¾å·§çš„æ•°æ®ç»“æ„è®¾è®¡å’Œç³»ç»Ÿè°ƒç”¨å°è£…ï¼Œå®ç°äº†å®Œæ•´çš„çº¿ç¨‹ç®¡ç†åŠŸèƒ½ã€‚

#### 1. "å…ˆæè¿°" - å®šä¹‰çº¿ç¨‹æ§åˆ¶å—ï¼ˆTCBï¼‰

pthreadsåº“ä¸ºæ¯ä¸ªçº¿ç¨‹åˆ›å»ºä¸€ä¸ª**çº¿ç¨‹æ§åˆ¶å—ï¼ˆThread Control Block, TCBï¼‰**Â æ•°æ®ç»“æ„ï¼Œè¿™å°±æ˜¯å¯¹çº¿ç¨‹çš„"æè¿°"ã€‚TCBåŒ…å«äº†ç®¡ç†ä¸€ä¸ªçº¿ç¨‹æ‰€éœ€çš„å…¨éƒ¨ä¿¡æ¯ï¼š

```

// ç®€åŒ–çš„TCBç»“æ„ç¤ºæ„ï¼ˆå®é™…å®ç°æ›´å¤æ‚ï¼‰
struct pthread {
    /* çº¿ç¨‹æ ‡è¯†å’ŒçŠ¶æ€ */
    pthread_t thread_id;        // çº¿ç¨‹IDï¼ˆé€šå¸¸æ˜¯TCBè‡ªèº«çš„åœ°å€ï¼‰
    int detach_state;           // åˆ†ç¦»çŠ¶æ€
    int cancel_state;           // å–æ¶ˆçŠ¶æ€
    int cancel_type;            // å–æ¶ˆç±»å‹
    
    /* çº¿ç¨‹ä¸Šä¸‹æ–‡ */
    void *stack_base;           // æ ˆåŸºåœ°å€
    size_t stack_size;          // æ ˆå¤§å°
    void *(*start_routine)(void*); // çº¿ç¨‹å‡½æ•°
    void *arg;                  // çº¿ç¨‹å‚æ•°
    void *return_value;         // è¿”å›å€¼
    
    /* å¯„å­˜å™¨ä¸Šä¸‹æ–‡ï¼ˆç”¨äºåˆ‡æ¢æ—¶ä¿å­˜/æ¢å¤ï¼‰ */
    void *machine_context;      // å¹³å°ç›¸å…³çš„å¯„å­˜å™¨ä¿å­˜åŒº
    
    /* åŒæ­¥å’Œä¿¡å·å¤„ç† */
    // å„ç§äº’æ–¥é”ã€æ¡ä»¶å˜é‡ã€ä¿¡å·å¤„ç†ä¿¡æ¯
    
    /* é“¾æ¥ä¿¡æ¯ */
    struct pthread *prev, *next; // ç”¨äºç»„ç»‡åˆ°çº¿ç¨‹åˆ—è¡¨ä¸­
};
```

æ¯ä¸ªTCBå°±æ˜¯çº¿ç¨‹çš„"èº«ä»½è¯"å’Œ"æ¡£æ¡ˆ"ï¼Œå®Œæ•´æè¿°äº†çº¿ç¨‹çš„æ‰€æœ‰å±æ€§å’ŒçŠ¶æ€ã€‚

#### 2. "å†ç»„ç»‡" - ç®¡ç†æ‰€æœ‰TCB

pthreadåº“é€šè¿‡ä»¥ä¸‹æ•°æ®ç»“æ„ç»„ç»‡æ‰€æœ‰çº¿ç¨‹çš„TCBï¼Œå®ç°å¿«é€Ÿè®¿é—®ä¸è°ƒåº¦ï¼š

1. **TCBç´¢å¼•è¡¨**

   * å…¨å±€æ•°ç»„Â `struct pthread *__thread_list[MAX_THREADS]`
   * é€šè¿‡ç”¨æˆ·çº§çº¿ç¨‹IDï¼ˆ`pthread_t`ï¼‰ä½œä¸ºä¸‹æ ‡ç›´æ¥å®šä½TCB(#ref1)
   * ç¤ºä¾‹ï¼š`TCB = __thread_list[(unsigned long)pthread_self % MAX_THREADS]`
2. **LWP â†” TCB æ˜ å°„è¡¨**

   * å“ˆå¸Œè¡¨Â `hash_map<pid_t LWP, struct pthread* TCB>`
   * ç”¨é€”ï¼šå†…æ ¸é€šè¿‡LWPæŸ¥è¯¢TCBï¼ˆå¦‚å¤„ç†ä¿¡å·æ—¶éœ€ä¿®æ”¹TCBä¿¡å·æ©ç ï¼‰(#ref2)
3. **çº¿ç¨‹çŠ¶æ€é˜Ÿåˆ—**

   | **é˜Ÿåˆ—ç±»å‹** | æ•°æ®ç»“æ„ | ç”¨é€” |
   | --- | --- | --- |
   | å°±ç»ªé˜Ÿåˆ— | çº¢é»‘æ ‘ï¼ˆæŒ‰ä¼˜å…ˆçº§ï¼‰ | ç”¨æˆ·çº§è°ƒåº¦ï¼ˆé…åˆLWPå†…æ ¸è°ƒåº¦ï¼‰ |
   | ç­‰å¾…é˜Ÿåˆ— | é“¾è¡¨ | é˜»å¡åœ¨æ¡ä»¶å˜é‡/äº’æ–¥é”çš„çº¿ç¨‹ |
   | åˆ†ç¦»çº¿ç¨‹å›æ”¶é˜Ÿåˆ— | é“¾è¡¨ | è‡ªåŠ¨å›æ”¶å·²ç»ˆæ­¢çš„åˆ†ç¦»çº¿ç¨‹ |

#### 3. ä¸å†…æ ¸çš„åä½œ

è™½ç„¶pthreadsåº“åœ¨ç”¨æˆ·ç©ºé—´ç®¡ç†çº¿ç¨‹ï¼Œä½†å®ƒéœ€è¦å†…æ ¸çš„æ”¯æŒæ¥å®ç°çœŸæ­£çš„å¹¶å‘æ‰§è¡Œï¼š

1. **çº¿ç¨‹åˆ›å»º**ï¼šå½“è°ƒç”¨`pthread_create()`æ—¶ï¼š

   * åº“å‡½æ•°åˆ†é…TCBç»“æ„ä½“å’Œçº¿ç¨‹æ ˆ
   * åˆå§‹åŒ–TCBä¸­çš„å„ç§å­—æ®µ
   * å°†æ–°TCBæ·»åŠ åˆ°å…¨å±€çº¿ç¨‹åˆ—è¡¨ä¸­
   * è°ƒç”¨`clone()`ç³»ç»Ÿè°ƒç”¨ï¼Œè¯·æ±‚å†…æ ¸åˆ›å»ºçœŸæ­£çš„æ‰§è¡Œä¸Šä¸‹æ–‡
2. **çº¿ç¨‹è°ƒåº¦**ï¼šè™½ç„¶pthreadsåº“ç®¡ç†çº¿ç¨‹çŠ¶æ€ï¼Œä½†å®é™…çš„è°ƒåº¦å†³ç­–ç”±å†…æ ¸åšå‡ºã€‚åº“éœ€è¦ä¸å†…æ ¸åä½œå¤„ç†çº¿ç¨‹çš„é˜»å¡ã€å”¤é†’ç­‰çŠ¶æ€è½¬æ¢ã€‚
3. **åŒæ­¥åŸè¯­**ï¼šäº’æ–¥é”ã€æ¡ä»¶å˜é‡ç­‰åŒæ­¥æœºåˆ¶è™½ç„¶åœ¨ç”¨æˆ·ç©ºé—´å®ç°äº†ä¸€éƒ¨åˆ†ä¼˜åŒ–ï¼ˆå¦‚futexï¼‰ï¼Œä½†åœ¨éœ€è¦æ—¶ä»ç„¶ä¼šé€šè¿‡ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸ã€‚

**çº¿ç¨‹é€€å‡ºå’Œæ¸…ç†**

å½“çº¿ç¨‹ç»“æŸæ—¶ï¼Œpthreadsåº“éœ€è¦ï¼š

1. ä¿å­˜çº¿ç¨‹è¿”å›å€¼åˆ°TCBä¸­
2. å¦‚æœçº¿ç¨‹æ˜¯joinableçš„ï¼Œå°†å…¶æ ‡è®°ä¸ºå·²ç»ˆæ­¢ä½†èµ„æºå°šæœªå›æ”¶
3. å¦‚æœæ˜¯detachedçš„ï¼Œç«‹å³å›æ”¶TCBå’Œæ ˆç©ºé—´
4. ä»å…¨å±€çº¿ç¨‹åˆ—è¡¨ä¸­ç§»é™¤è¯¥TCB

#### æ€»ç»“ï¼šåˆ†å±‚æŠ½è±¡çš„è‰ºæœ¯

pthreadåº“çš„çº¿ç¨‹ç®¡ç†æ˜¯**ç”¨æˆ·æ€ä¸å†…æ ¸æ€åä½œçš„å…¸èŒƒ**ï¼š

1. **æè¿°å±‚**ï¼š
   * é€šè¿‡TCBç»“æ„ä½“**å°è£…çº¿ç¨‹å…¨ç”Ÿå‘½å‘¨æœŸçŠ¶æ€**
   * `pthread_t`Â ä½œä¸ºTCBæŒ‡é’ˆæä¾›è¿›ç¨‹å†…å”¯ä¸€æ ‡è¯†
2. **ç»„ç»‡å±‚**ï¼š
   * å…¨å±€ç´¢å¼•è¡¨å®ç°Â **O(1) å¤æ‚åº¦è®¿é—®**
   * é˜Ÿåˆ—ç»“æ„ç®¡ç†ä¸åŒçŠ¶æ€çº¿ç¨‹
3. **å†…æ ¸æ¡¥æ¥**ï¼š
   * å°†POSIX APIè½¬åŒ–ä¸ºÂ `clone`/`futex`Â ç­‰ç³»ç»Ÿè°ƒç”¨
   * ç»´æŠ¤LWPâ†”TCBæ˜ å°„ä¿è¯å†…æ ¸æ“ä½œå¯å®šä½ç”¨æˆ·æ€èµ„æº

---

## 3. çº¿ç¨‹ç»ˆæ­¢

### ä¸‰ç§çº¿ç¨‹ç»ˆæ­¢æ–¹æ³•è¯¦è§£

#### 1. ä»çº¿ç¨‹å‡½æ•° return

è¿™æ˜¯æœ€è‡ªç„¶ã€æœ€æ¨èçš„çº¿ç¨‹ç»ˆæ­¢æ–¹å¼ã€‚

**å·¥ä½œåŸç†**ï¼š

* å½“çº¿ç¨‹æ‰§è¡Œåˆ°å…¶å¯åŠ¨å‡½æ•°çš„Â `return`Â è¯­å¥æ—¶ï¼Œçº¿ç¨‹ä¼šæ­£å¸¸ç»“æŸ
* è¿”å›å€¼å¯ä»¥é€šè¿‡Â `pthread_join`Â è·å–

**æ³¨æ„äº‹é¡¹**ï¼š

* ä¸»çº¿ç¨‹ä¸­ä»Â `main`Â å‡½æ•° return ä¼šç»ˆæ­¢æ•´ä¸ªè¿›ç¨‹
* è¿”å›çš„æŒ‡é’ˆå¿…é¡»æŒ‡å‘å…¨å±€æ•°æ®æˆ–å †ä¸Šåˆ†é…çš„å†…å­˜ï¼Œä¸èƒ½æŒ‡å‘çº¿ç¨‹æ ˆä¸Šçš„å±€éƒ¨å˜é‡

#### 2. è°ƒç”¨ pthread_exit ç»ˆæ­¢è‡ªå·±

è¿™ç§æ–¹å¼å…è®¸çº¿ç¨‹åœ¨ä»»ä½•åœ°æ–¹ä¸»åŠ¨ç»ˆæ­¢è‡ªå·±ï¼Œè€Œä¸å¿…è¿”å›åˆ°å‡½æ•°å¼€å¤´ã€‚

**å‡½æ•°åŸå‹**ï¼š

```

void pthread_exit(void *value_ptr);
```

**ä½¿ç”¨åœºæ™¯**ï¼š

* åœ¨çº¿ç¨‹æ‰§è¡Œçš„ä»»ä½•åœ°æ–¹éœ€è¦ç«‹å³é€€å‡º
* å½“çº¿ç¨‹éœ€è¦è¿”å›ä¸€ä¸ªå€¼ï¼Œä½†æ— æ³•é€šè¿‡å‡½æ•°è¿”å›å®ç°æ—¶

**é‡è¦æ³¨æ„äº‹é¡¹**ï¼š

1. **å†…å­˜ç®¡ç†**ï¼š`value_ptr`Â ä¸èƒ½æŒ‡å‘çº¿ç¨‹æ ˆä¸Šçš„å±€éƒ¨å˜é‡ï¼Œå› ä¸ºçº¿ç¨‹é€€å‡ºåæ ˆä¼šè¢«é”€æ¯
2. **ä¸»çº¿ç¨‹ä½¿ç”¨**ï¼šåœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨Â `pthread_exit`Â ä¼šç»ˆæ­¢ä¸»çº¿ç¨‹ï¼Œä½†å…¶ä»–çº¿ç¨‹ä¼šç»§ç»­è¿è¡Œï¼Œç›´åˆ°æ‰€æœ‰çº¿ç¨‹éƒ½ç»“æŸ
3. **æ¸…ç†å¤„ç†ç¨‹åº**ï¼šè°ƒç”¨Â `pthread_exit`Â ä¼šæ‰§è¡Œçº¿ç¨‹çš„æ¸…ç†å¤„ç†ç¨‹åºï¼ˆé€šè¿‡Â `pthread_cleanup_push`Â æ³¨å†Œçš„ï¼‰

#### 3. è°ƒç”¨ pthread_cancel å–æ¶ˆå¦ä¸€ä¸ªçº¿ç¨‹

è¿™ç§æ–¹å¼å…è®¸ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚ç»ˆæ­¢åŒä¸€è¿›ç¨‹ä¸­çš„å¦ä¸€ä¸ªçº¿ç¨‹ã€‚

**å‡½æ•°åŸå‹**ï¼š

```

int pthread_cancel(pthread_t thread);
```

**å–æ¶ˆæœºåˆ¶çš„å·¥ä½œåŸç†**ï¼š  
çº¿ç¨‹å–æ¶ˆä¸æ˜¯ç«‹å³å‘ç”Ÿçš„ï¼Œè€Œæ˜¯ä¾èµ–äºç›®æ ‡çº¿ç¨‹çš„å–æ¶ˆçŠ¶æ€å’Œç±»å‹ï¼š

1. **å–æ¶ˆçŠ¶æ€**ï¼ˆé€šè¿‡Â `pthread_setcancelstate`Â è®¾ç½®ï¼‰ï¼š

   * `PTHREAD_CANCEL_ENABLE`ï¼šå…è®¸å–æ¶ˆï¼ˆé»˜è®¤ï¼‰
   * `PTHREAD_CANCEL_DISABLE`ï¼šç¦æ­¢å–æ¶ˆ
2. **å–æ¶ˆç±»å‹**ï¼ˆé€šè¿‡Â `pthread_setcanceltype`Â è®¾ç½®ï¼‰ï¼š

   * `PTHREAD_CANCEL_DEFERRED`ï¼šå»¶è¿Ÿå–æ¶ˆï¼ˆé»˜è®¤ï¼‰ï¼Œåªåœ¨å–æ¶ˆç‚¹æ£€æŸ¥å–æ¶ˆè¯·æ±‚
   * `PTHREAD_CANCEL_ASYNCHRONOUS`ï¼šå¼‚æ­¥å–æ¶ˆï¼Œå¯ä»¥åœ¨ä»»ä½•æ—¶é—´ç‚¹è¢«å–æ¶ˆ

**å–æ¶ˆç‚¹**ï¼šä¸€äº›ç‰¹å®šçš„å‡½æ•°è°ƒç”¨ä¼šæˆä¸ºå–æ¶ˆç‚¹ï¼Œå¦‚ï¼š

* `sleep()`,Â `usleep()`,Â `nanosleep()`
* `read()`,Â `write()`,Â `open()`,Â `close()`
* `pthread_join()`,Â `pthread_cond_wait()`
* ç­‰ç­‰

### å…³é”®æ³¨æ„äº‹é¡¹æ€»ç»“

1. **è¿”å›å€¼çš„å†…å­˜ç®¡ç†**ï¼š

   * æ— è®ºæ˜¯é€šè¿‡Â `return`Â è¿˜æ˜¯Â `pthread_exit`Â è¿”å›çš„å€¼ï¼Œéƒ½å¿…é¡»æŒ‡å‘å…¨å±€æ•°æ®æˆ–å †ä¸Šåˆ†é…çš„å†…å­˜
   * ç»å¯¹ä¸èƒ½æŒ‡å‘çº¿ç¨‹æ ˆä¸Šçš„å±€éƒ¨å˜é‡ï¼Œå› ä¸ºçº¿ç¨‹é€€å‡ºåæ ˆä¼šè¢«é”€æ¯
2. **èµ„æºæ¸…ç†**ï¼š

   * çº¿ç¨‹ç»ˆæ­¢æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é‡Šæ”¾çº¿ç¨‹ç‰¹æœ‰çš„èµ„æºï¼ˆå¦‚æ ˆç©ºé—´ï¼‰
   * ä½†çº¿ç¨‹åˆ†é…çš„å…¶ä»–èµ„æºï¼ˆå¦‚æ‰“å¼€çš„æ–‡ä»¶ã€åŠ¨æ€åˆ†é…çš„å†…å­˜ç­‰ï¼‰éœ€è¦ç¨‹åºå‘˜æ˜¾å¼æ¸…ç†
   * å¯ä»¥ä½¿ç”¨Â `pthread_cleanup_push`Â å’ŒÂ `pthread_cleanup_pop`Â æ³¨å†Œæ¸…ç†å‡½æ•°
3. **å–æ¶ˆçš„åä½œæ€§**ï¼š

   * çº¿ç¨‹å–æ¶ˆæ˜¯ä¸€ç§åä½œæœºåˆ¶ï¼Œç›®æ ‡çº¿ç¨‹å¿…é¡»é…åˆæ‰èƒ½è¢«å–æ¶ˆ
   * å¦‚æœçº¿ç¨‹ç¦ç”¨å–æ¶ˆæˆ–ä»ä¸åˆ°è¾¾å–æ¶ˆç‚¹ï¼Œå®ƒå°†æ— æ³•è¢«å–æ¶ˆ
4. **çº¿ç¨‹åˆ†ç¦»**ï¼š

   * å¦‚æœçº¿ç¨‹è¢«è®¾ç½®ä¸ºåˆ†ç¦»çŠ¶æ€ï¼ˆdetachedï¼‰ï¼Œåˆ™ä¸éœ€è¦å…¶ä»–çº¿ç¨‹è°ƒç”¨Â `pthread_join`Â æ¥å›æ”¶èµ„æº
   * åˆ†ç¦»çº¿ç¨‹ç»ˆæ­¢åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å›æ”¶å…¶èµ„æº

---

## 4. çº¿ç¨‹ç­‰å¾…

### ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹ç­‰å¾…ï¼Ÿ

1. **èµ„æºæ³„æ¼é˜²æ­¢**ï¼š

   * çº¿ç¨‹é€€å‡ºåï¼Œå…¶æ ˆç©ºé—´å’Œçº¿ç¨‹æ§åˆ¶å—ï¼ˆTCBï¼‰ç­‰èµ„æºä¸ä¼šè‡ªåŠ¨é‡Šæ”¾
   * è¿™äº›èµ„æºä¼šä¸€ç›´å ç”¨è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œå¯¼è‡´"åƒµå°¸çº¿ç¨‹"é—®é¢˜
   * ç±»ä¼¼äºè¿›ç¨‹ä¸­çš„åƒµå°¸è¿›ç¨‹ï¼Œå¦‚æœä¸å¤„ç†ï¼Œä¼šé€æ¸è€—å°½ç³»ç»Ÿèµ„æº
2. **åœ°å€ç©ºé—´å¤ç”¨**ï¼š

   * æ–°åˆ›å»ºçš„çº¿ç¨‹ä¸ä¼šå¤ç”¨å·²é€€å‡ºçº¿ç¨‹çš„åœ°å€ç©ºé—´
   * æ¯æ¬¡åˆ›å»ºæ–°çº¿ç¨‹éƒ½ä¼šåˆ†é…æ–°çš„æ ˆç©ºé—´å’Œæ§åˆ¶ç»“æ„
   * å¦‚æœä¸å›æ”¶æ—§çº¿ç¨‹çš„èµ„æºï¼Œè¿›ç¨‹çš„å†…å­˜å ç”¨ä¼šä¸æ–­å¢é•¿
3. **åŒæ­¥éœ€æ±‚**ï¼š

   * ä¸»çº¿ç¨‹å¯èƒ½éœ€è¦ç­‰å¾…å·¥ä½œçº¿ç¨‹å®Œæˆç‰¹å®šä»»åŠ¡åæ‰èƒ½ç»§ç»­æ‰§è¡Œ
   * çº¿ç¨‹é—´éœ€è¦åè°ƒæ‰§è¡Œé¡ºåºï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
4. **ç»“æœè·å–**ï¼š

   * å·¥ä½œçº¿ç¨‹å¯èƒ½éœ€è¦å°†æ‰§è¡Œç»“æœè¿”å›ç»™ä¸»çº¿ç¨‹æˆ–å…¶ä»–çº¿ç¨‹
   * `pthread_join`Â æ˜¯è·å–çº¿ç¨‹è¿”å›å€¼çš„æ ‡å‡†æœºåˆ¶

### pthread_join å‡½æ•°æ·±åº¦è§£æ

#### å‡½æ•°åŸå‹

```

int pthread_join(pthread_t thread, void **value_ptr);
```

* **thread**ï¼šç›®æ ‡çº¿ç¨‹çš„Â `pthread_t`Â æ ‡è¯†ç¬¦ï¼ˆç”±Â `pthread_create`Â è¿”å›ï¼‰
* **value_ptr**ï¼šäºŒçº§æŒ‡é’ˆï¼Œç”¨äºæ¥æ”¶çº¿ç¨‹é€€å‡ºçŠ¶æ€
  + è‹¥ä¼ é€’Â `NULL`ï¼Œè¡¨ç¤ºå¿½ç•¥é€€å‡ºçŠ¶æ€
  + éÂ `NULL`Â æ—¶ï¼Œ`*value_ptr`Â å­˜å‚¨é€€å‡ºä¿¡æ¯æŒ‡é’ˆ

#### è¿”å›å€¼å¤„ç†

**value_ptr**æ¥æ”¶çš„å€¼å–å†³äºçº¿ç¨‹ç»ˆæ­¢æ–¹å¼ï¼Œå½¢æˆ**çŠ¶æ€ä¸‰å…ƒç»„**ï¼š

| **ç»ˆæ­¢æ–¹å¼** | **value_ptr**æŒ‡å‘çš„å†…å®¹ | å…¸å‹åœºæ™¯ |
| --- | --- | --- |
| **return é€€å‡º** | çº¿ç¨‹å‡½æ•°è¿”å›å€¼ | `return (void*)42;` |
| **pthread_exit()** | `pthread_exit`Â çš„å‚æ•°å€¼ | `pthread_exit((void*)"done")` |
| **pthread_cancel() å–æ¶ˆ** | `PTHREAD_CANCELED`Â å®ï¼ˆ-1ï¼‰ | `pthread_cancel(tid)` |

> ğŸ“ŒÂ **å…³é”®ç»†èŠ‚**ï¼š
>
> * `PTHREAD_CANCELED`Â å®é™…ä¸ºÂ `(void*)-1`ï¼Œéœ€å¼ºè½¬Â `int`Â åˆ¤æ–­
> * é€šè¿‡Â `return`Â å’ŒÂ `pthread_exit`Â è¿”å›çš„å€¼å¿…é¡»ä½äº**å…¨å±€å†…å­˜æˆ–å †ä¸­**ï¼ˆç¦æ­¢æŒ‡å‘æ ˆå˜é‡ï¼‰

**ç»¼åˆç¤ºä¾‹ï¼š**

```

#include <iostream>
#include <string>
#include <cstdlib>
#include <pthread.h>
#include <sys/types.h>
#include <unistd.h>

void *thread1(void *arg)
{
    printf("thread 1 returning ... \n");
    int *p = (int *)malloc(sizeof(int));
    *p = 1;
    return (void *)p;
}
void *thread2(void *arg)
{
    printf("thread 2 exiting ...\n");
    int *p = (int *)malloc(sizeof(int));
    *p = 2;
    pthread_exit((void *)p);
}
void *thread3(void *arg)
{
    while (true)
    {
        printf("thread 3 is running ...\n");
        sleep(1);
    }
    return NULL;
}
int main()
{
    pthread_t tid;
    void *ret;
    // thread 1 return
    pthread_create(&tid, NULL, thread1, NULL);
    pthread_join(tid, &ret);
    printf("thread return, thread id %lX, return code:%d\n", tid, *(int *)ret);
    free(ret);

    // thread 2 exit
    pthread_create(&tid, NULL, thread2, NULL);
    pthread_join(tid, &ret);
    printf("thread return, thread id %lX, return code:%d\n", tid, *(int *)ret);
    free(ret);

    // thread 3 cancel by other
    pthread_create(&tid, NULL, thread3, NULL);
    sleep(3);
    pthread_cancel(tid);
    pthread_join(tid, &ret);
    if (ret == PTHREAD_CANCELED)
        printf("thread return, thread id %lX, return code:PTHREAD_CANCELED\n", tid);
    else
        printf("thread return, thread id %lX, return code:NULL\n", tid);
}
```

**è¿è¡Œç»“æœï¼š**

![](https://i-blog.csdnimg.cn/direct/68502579dc8946c8bc02ee4368520488.png)

![](https://i-blog.csdnimg.cn/direct/bbef794021084b69809f4e7d46675708.png)

### é‡è¦æ³¨æ„äº‹é¡¹å’Œæœ€ä½³å®è·µ

1. **çº¿ç¨‹çŠ¶æ€è¦æ±‚**ï¼š

   * åªèƒ½å¯¹éåˆ†ç¦»ï¼ˆjoinableï¼‰çŠ¶æ€çš„çº¿ç¨‹è°ƒç”¨Â `pthread_join`
   * å¦‚æœçº¿ç¨‹å¤„äºåˆ†ç¦»ï¼ˆdetachedï¼‰çŠ¶æ€ï¼Œè°ƒç”¨Â `pthread_join`Â ä¼šå¤±è´¥å¹¶è¿”å› EINVAL
2. **ä¸€å¯¹ä¸€å…³ç³»**ï¼š

   * æ¯ä¸ªçº¿ç¨‹åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹ join ä¸€æ¬¡
   * å¤šæ¬¡ join åŒä¸€ä¸ªçº¿ç¨‹ä¼šå¯¼è‡´æœªå®šä¹‰è¡Œä¸º
3. **å†…å­˜ç®¡ç†è´£ä»»**ï¼š

   * é€šè¿‡Â `pthread_join`Â è·å–çš„è¿”å›å€¼å†…å­˜å¿…é¡»ç”±è°ƒç”¨è€…è´Ÿè´£é‡Šæ”¾
   * çº¿ç¨‹ä¸åº”è¯¥è¿”å›æŒ‡å‘å…¶æ ˆä¸Šæ•°æ®çš„æŒ‡é’ˆ
4. **é”™è¯¯å¤„ç†**ï¼š

   * æ€»æ˜¯æ£€æŸ¥Â `pthread_join`Â çš„è¿”å›å€¼
   * å¸¸è§çš„é”™è¯¯ç ï¼š

     + `ESRCH`ï¼šæ²¡æœ‰æ‰¾åˆ°ä¸ç»™å®šçº¿ç¨‹IDå¯¹åº”çš„çº¿ç¨‹
     + `EINVAL`ï¼šçº¿ç¨‹ä¸æ˜¯å¯è¿æ¥çŠ¶æ€ï¼Œæˆ–è€…å¦ä¸€ä¸ªçº¿ç¨‹å·²ç»åœ¨ç­‰å¾…æ­¤çº¿ç¨‹
     + `EDEADLK`ï¼šæ­»é”æƒ…å†µï¼Œä¾‹å¦‚çº¿ç¨‹å°è¯•joinè‡ªå·±
5. **è¶…æ—¶å¤„ç†**ï¼š

   * `pthread_join`Â æ²¡æœ‰è¶…æ—¶æœºåˆ¶ï¼Œä¼šæ— é™æœŸç­‰å¾…
   * å¦‚æœéœ€è¦è¶…æ—¶åŠŸèƒ½ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨æ¡ä»¶å˜é‡æˆ–å…¶ä»–åŒæ­¥æœºåˆ¶

---

## 5. çº¿ç¨‹åˆ†ç¦»

**é»˜è®¤æƒ…å†µï¼šå¯è¿æ¥çº¿ç¨‹ï¼ˆJoinable Threadï¼‰**

* æ–°åˆ›å»ºçš„çº¿ç¨‹é»˜è®¤æ˜¯å¯è¿æ¥çš„ï¼ˆjoinableï¼‰
* è¿™ç±»çº¿ç¨‹ç»ˆæ­¢åï¼Œå¿…é¡»ç”±å…¶ä»–çº¿ç¨‹è°ƒç”¨Â `pthread_join`Â æ¥å›æ”¶èµ„æº
* å¦‚æœä¸è¿›è¡Œ join æ“ä½œï¼Œçº¿ç¨‹èµ„æºä¼šæ³„æ¼ï¼Œå½¢æˆ"åƒµå°¸çº¿ç¨‹"

**åˆ†ç¦»çº¿ç¨‹ï¼ˆDetached Threadï¼‰**

* åˆ†ç¦»çº¿ç¨‹åœ¨ç»ˆæ­¢æ—¶ä¼šè‡ªåŠ¨é‡Šæ”¾æ‰€æœ‰èµ„æº
* ä¸éœ€è¦ä¹Ÿä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹ join
* é€‚ç”¨äºä¸éœ€è¦è·å–çº¿ç¨‹è¿”å›å€¼çš„åœºæ™¯

### pthread_detach å‡½æ•°è¯¦è§£

#### å‡½æ•°åŸå‹

```

int pthread_detach(pthread_t thread);
```

**å‚æ•°è¯´æ˜**

* `thread`ï¼šè¦åˆ†ç¦»çš„çº¿ç¨‹ID

**è¿”å›å€¼**

* æˆåŠŸè¿”å› 0
* å¤±è´¥è¿”å›é”™è¯¯ç ï¼ˆå¦‚ ESRCH è¡¨ç¤ºçº¿ç¨‹ä¸å­˜åœ¨ï¼ŒEINVAL è¡¨ç¤ºçº¿ç¨‹å·²ç»æ˜¯åˆ†ç¦»çŠ¶æ€ï¼‰

#### ä½¿ç”¨æ–¹å¼

**1.Â åˆ›å»ºæ—¶åˆ†ç¦»ï¼ˆæ¨èï¼‰**

```

pthread_attr_t attr;
pthread_attr_init(&attr);
pthread_attr_setdetachstate(&attr, PTHREAD_CREATE_DETACHED);  // è®¾ç½®åˆ†ç¦»å±æ€§ 
pthread_create(&tid, &attr, worker, NULL);  // ç›´æ¥åˆ›å»ºåˆ†ç¦»çº¿ç¨‹
pthread_attr_destroy(&attr);

```

* **ä¼˜åŠ¿**ï¼šé¿å…è¿è¡Œæ—¶çŠ¶æ€åˆ‡æ¢ï¼Œç¡®ä¿èµ„æºå®‰å…¨

**2. å…¶ä»–çº¿ç¨‹åˆ†ç¦»ç›®æ ‡çº¿ç¨‹**

```

pthread_create(&tid, NULL, worker, NULL);
pthread_detach(tid);  // ä¸»çº¿ç¨‹ä¸»åŠ¨åˆ†ç¦»å­çº¿ç¨‹

```

* **é€‚ç”¨åœºæ™¯**ï¼šä¸»çº¿ç¨‹ä¸å…³å¿ƒå­çº¿ç¨‹ç»“æœï¼Œä½†éœ€æ§åˆ¶åˆ†ç¦»æ—¶æœº

**3. çº¿ç¨‹è‡ªæˆ‘åˆ†ç¦»**

```

void* worker(void* arg) {
    pthread_detach(pthread_self());  // çº¿ç¨‹å†…è‡ªè¡Œåˆ†ç¦» 
    // ... ä¸šåŠ¡é€»è¾‘
    return NULL;
}

```

* **ä¼˜åŠ¿**ï¼šé¿å…ä¸»çº¿ç¨‹å¿˜è®°åˆ†ç¦»ï¼Œé€‚åˆåŠ¨æ€çº¿ç¨‹æ± 

**ç¤ºä¾‹ï¼š**

```

void *thread_run(void *arg)
{
    pthread_detach(pthread_self());
    printf("%s\n", (char *)arg);
    return NULL;
}
int main(void)
{
    pthread_t tid;
    if (pthread_create(&tid, NULL, thread_run, (void*)"thread1 run...") != 0)
    {
        printf("create thread error\n");
        return 1;
    }
    int ret = 0;
    sleep(1); // å¾ˆé‡è¦ï¼Œè¦è®©çº¿ç¨‹å…ˆåˆ†ç¦»ï¼Œå†ç­‰å¾…
    if (pthread_join(tid, NULL) == 0)
    {
        printf("pthread wait success\n");
        ret = 0;
    }
    else
    {
        printf("pthread wait failed\n");
        ret = 1;
    }
    return ret;
}
```

**è¿è¡Œç»“æœï¼š**

![](https://i-blog.csdnimg.cn/direct/ff9c2e1002584c2fa4cb9949a1813253.png)

### é‡è¦æ³¨æ„äº‹é¡¹

**1. Joinable å’Œ Detached æ˜¯äº’æ–¥çš„**

* ä¸€ä¸ªçº¿ç¨‹ä¸èƒ½åŒæ—¶æ˜¯å¯è¿æ¥å’Œåˆ†ç¦»çš„
* å¦‚æœå°è¯• join ä¸€ä¸ªå·²åˆ†ç¦»çš„çº¿ç¨‹ï¼Œä¼šè¿”å› EINVAL é”™è¯¯
* å¦‚æœå°è¯•åˆ†ç¦»ä¸€ä¸ªå·²åˆ†ç¦»çš„çº¿ç¨‹ï¼Œä¹Ÿä¼šè¿”å› EINVAL é”™è¯¯

**2. åˆ†ç¦»æ—¶æœº**

* å¯ä»¥åœ¨çº¿ç¨‹åˆ›å»ºåçš„ä»»ä½•æ—¶é—´ç‚¹åˆ†ç¦»çº¿ç¨‹
* ä½†æœ€å¥½åœ¨çŸ¥é“ä¸éœ€è¦çº¿ç¨‹è¿”å›å€¼æ—¶ç«‹å³åˆ†ç¦»

**3. èµ„æºå›æ”¶**

* åˆ†ç¦»çº¿ç¨‹ç»ˆæ­¢æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å›æ”¶å…¶æ ˆç©ºé—´å’Œçº¿ç¨‹æ§åˆ¶å—
* ä½†çº¿ç¨‹åˆ†é…çš„å…¶ä»–èµ„æºï¼ˆå¦‚æ‰“å¼€çš„æ–‡ä»¶ã€åŠ¨æ€åˆ†é…çš„å†…å­˜ç­‰ï¼‰ä»éœ€ç¨‹åºå‘˜è´Ÿè´£æ¸…ç†

**4. é”™è¯¯å¤„ç†**

æ€»æ˜¯æ£€æŸ¥Â `pthread_detach`Â çš„è¿”å›å€¼ï¼š

```

int result = pthread_detach(thread);
if (result != 0) {
    // å¤„ç†é”™è¯¯
    if (result == EINVAL) {
        fprintf(stderr, "Thread is already detached or doesn't exist\n");
    } else if (result == ESRCH) {
        fprintf(stderr, "No thread with the ID could be found\n");
    }
}
```

### æ€»ç»“

çº¿ç¨‹åˆ†ç¦»æ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­çš„é‡è¦æ¦‚å¿µï¼Œå®ƒæä¾›äº†è‡ªåŠ¨èµ„æºå›æ”¶çš„æœºåˆ¶ï¼š

1. **ä½¿ç”¨åœºæ™¯**ï¼šé€‚ç”¨äºä¸éœ€è¦è·å–çº¿ç¨‹è¿”å›å€¼çš„åå°ä»»åŠ¡ã€äº‹ä»¶å¤„ç†ç­‰åœºæ™¯
2. **åˆ†ç¦»æ–¹å¼**ï¼š

   * å…¶ä»–çº¿ç¨‹è°ƒç”¨Â `pthread_detach(thread_id)`
   * çº¿ç¨‹è‡ªæˆ‘åˆ†ç¦»ï¼š`pthread_detach(pthread_self())`
   * åˆ›å»ºæ—¶æŒ‡å®šåˆ†ç¦»å±æ€§
3. **ä¼˜åŠ¿**ï¼š

   * é¿å…èµ„æºæ³„æ¼
   * ç®€åŒ–ä»£ç ï¼Œä¸éœ€è¦æ˜¾å¼è°ƒç”¨Â `pthread_join`
   * æé«˜ç¨‹åºçš„å¯ç»´æŠ¤æ€§
4. **æ³¨æ„äº‹é¡¹**ï¼š

   * åˆ†ç¦»åä¸èƒ½å† join
   * ä»éœ€è´Ÿè´£æ¸…ç†çº¿ç¨‹åˆ†é…çš„éçº¿ç¨‹ç‰¹æœ‰èµ„æº
   * æ€»æ˜¯æ£€æŸ¥åˆ†ç¦»æ“ä½œçš„è¿”å›å€¼

---

## 6. çº¿ç¨‹å°è£…

**ä»£ç å¦‚ä¸‹ï¼š**

**Thread.hpp:**

```

#pragma once

#include <iostream>
#include <string>
#include <pthread.h>
#include <cstdio>
#include <cstring>
#include <functional>

namespace ThreadModlue
{
    static uint32_t number = 1; // ä¸æ˜¯åŸå­å‹çš„ï¼Œå…ˆä¸å¤„ç†
    class Thread
    {
        using  func_t = std::function<void()>; 
    private:
        void Enabledetach()
        {
            std::cout << "çº¿ç¨‹è¢«åˆ†ç¦»äº†" << std::endl;
            _isdetach = true;
        }

        void EnableRunning()
        {
            _isrunning = true;
        }

        // æ–°çº¿ç¨‹æ‰§è¡Œ
        static void* Routine(void* args) // å±äºç±»å†…çš„æˆå‘˜å‡½æ•°ï¼Œé»˜è®¤åŒ…å«thisæŒ‡é’ˆï¼
        {
            Thread* self = static_cast<Thread*>(args);
            self->EnableRunning(); // ä¿®æ”¹è¿è¡Œæ ‡å¿—ä½
            if(self->_isdetach)
            {
                self->Detach();
            } 
            pthread_setname_np(self->_tid, self->_name.c_str());
            self->_func(); // å›è°ƒå¤„ç†
            return nullptr;
        }
    public:
        Thread(func_t func)
            : _tid(0), _isdetach(false), _isrunning(false), _ret(nullptr), _func(func)
        {
            _name = "thread-" + std::to_string(number);
        }

        void Detach()
        {
            if (_isdetach)
                return;
            if (_isrunning)
                pthread_detach(_tid);
            Enabledetach();
        }

        bool Start()
        {
            if (_isrunning)
                return false;
            int n = pthread_create(&_tid, nullptr, Routine, this); // ä¼ thisæŒ‡é’ˆ
            if (n != 0)
            {
                std::cerr << "create thread error : " << strerror(n) << std::endl;
                return false;
            }
            else
            {
                std::cout << "create thread success" << std::endl;
                return true;
            }
        }

        bool Stop()
        {
            if (_isrunning)
            {
                int n = pthread_cancel(_tid);
                if (n != 0)
                {
                    std::cerr << "cancel thread error : " << strerror(n) << std::endl;
                    return false;
                }
                else
                {
                    std::cout << _name << " stop!" << std::endl;
                    return true;
                }
            }
            return false;
        }

        void Join()
        {
            if(_isdetach)
            {
                std::cout << "ä½ çš„çº¿ç¨‹å·²ç»è¢«åˆ†ç¦»äº†, ä¸èƒ½join" << std::endl;
            }
            int n = pthread_join(_tid, &_ret);
            if(n != 0)
            {
                std::cerr << "pthread_join error : " << strerror(n) << std::endl;
                return;
            }
            else
            {
                std::cout << "join success" << std::endl;
            }
        }
        ~Thread() {}

    private:
        pthread_t _tid;
        std::string _name;
        bool _isdetach;  // åˆ†ç¦»æ ‡å¿—ä½
        bool _isrunning; // è¿è¡Œæ ‡å¿—ä½
        void* _ret;
        func_t _func;
    };
}
```

**Main.cc:**

```

#include "Thread.hpp"
#include <unistd.h>
using namespace ThreadModlue;

int main()
{
    Thread t([](){
        while(true)
        {
            char name[128];
            pthread_getname_np(pthread_self(), name, sizeof(name));
            std::cout << "æˆ‘æ˜¯ä¸€ä¸ªæ–°çº¿ç¨‹: " << name << std::endl;
            sleep(1);
        }
    });
    t.Start();
    t.Detach();
    sleep(5);

    t.Stop();

    sleep(5);

    t.Join();
    return 0;
}

```

**è¿è¡Œç»“æœï¼š**

![](https://i-blog.csdnimg.cn/direct/3412329a8be14a518e891ef658a5458a.png)

**æ³¨æ„ï¼š**

`pthread_setname_np` å’Œ `pthread_getname_np` æ˜¯ä¸¤ä¸ªç”¨äºç®¡ç†çº¿ç¨‹åç§°çš„éæ ‡å‡†å‡½æ•°ï¼ˆ"_np"åç¼€è¡¨ç¤º"non-portable"ï¼Œå³ä¸å¯ç§»æ¤ï¼‰ã€‚è¿™äº›å‡½æ•°ä¸»è¦é€‚ç”¨äºLinuxå’Œå…¶ä»–ç±»Unixç³»ç»Ÿï¼Œå¸¸ç”¨äºå¤šçº¿ç¨‹ç¨‹åºçš„è°ƒè¯•ä¸ç®¡ç†ã€‚

---



