---
layout: post
title: "K8S-集群搭建cri-dockerd版"
date: 2025-03-09 21:16:56 +0800
description: "openEuler 系统在跟换源后需要将/etc/yum.repos.d/kubernetes.repo 中的$release 跟换成 8。机器：3台机器【一台master（集群的控制平面，负责集群的决策/管理），两台node机器（集群的数据平面，负责为容器提供运行环境）】15行：criSocket: unix:///var/run/cri-dockerd.sock。永久关闭：sed -i 's/.*swap.*/#&/' /etc/fstab。然后重载 ==> 开机自启 ==> 检查组件状态。"
keywords: "K8S 集群搭建——cri-dockerd版"
categories: ['未分类']
tags: ['容器', 'Linux', 'Kubernetes']
artid: "146127436"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146127436
    alt: "K8S-集群搭建cri-dockerd版"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146127436
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146127436
cover: https://bing.ee123.net/img/rand?artid=146127436
image: https://bing.ee123.net/img/rand?artid=146127436
img: https://bing.ee123.net/img/rand?artid=146127436
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     K8S 集群搭建——cri-dockerd版
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <hr id="hr-toc" name="tableOfContents"/>
    <p>
    </p>
    <h2 id="%E4%B8%80%E3%80%81%E5%B7%A5%E4%BD%9C%E5%87%86%E5%A4%87" name="%E4%B8%80%E3%80%81%E5%B7%A5%E4%BD%9C%E5%87%86%E5%A4%87">
     一、工作准备
    </h2>
    <p>
     机器：3台机器【一台master（集群的控制平面，负责集群的决策/管理），两台node机器（集群的数据平面，负责为容器提供运行环境）】
    </p>
    <p>
     参数：2核1线程，4G内存，20G硬盘
    </p>
    <p>
     系统：OpenEuler
    </p>
    <p>
     IP分配：
    </p>
    <table>
     <thead>
      <tr>
       <th>
        主机名
       </th>
       <th>
        IP地址
       </th>
       <th>
        节点
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        k8s-master
       </td>
       <td>
        192.168.8.154
       </td>
       <td>
        master
       </td>
      </tr>
      <tr>
       <td>
        k8s-node-01
       </td>
       <td>
        192.168.8.157
       </td>
       <td>
        node1
       </td>
      </tr>
      <tr>
       <td>
        k8s-node-02
       </td>
       <td>
        192.168.8.158
       </td>
       <td>
        node2
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <span style="background-color:#ffd900">
      本实验除了备注只需在master操作外，其他的都需要在每个节点上面操作
     </span>
    </p>
    <h3 id="1.%E9%85%8D%E7%BD%AE%E4%B8%BB%E6%9C%BA%E5%90%8D" name="1.%E9%85%8D%E7%BD%AE%E4%B8%BB%E6%9C%BA%E5%90%8D">
     1.配置主机名
    </h3>
    <blockquote>
     <p>
      hostnamectl set-hostname k8s-master  /  k8s-node01  /  k8s-node02
     </p>
    </blockquote>
    <h3 id="2.%E9%85%8D%E7%BD%AEhosts%E8%A7%A3%E6%9E%90" name="2.%E9%85%8D%E7%BD%AEhosts%E8%A7%A3%E6%9E%90">
     2.配置hosts解析
    </h3>
    <blockquote>
     <p>
      cat &gt;&gt; /etc/hosts &lt;&lt;END
      <br/>
      192.168.8.154 k8s-master
      <br/>
      192.168.8.157 k8s-node01
      <br/>
      192.168.8.158 k8s-node02
      <br/>
      END
     </p>
    </blockquote>
    <h3 id="3.%E9%85%8D%E7%BD%AE%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95%EF%BC%88%E5%8F%AA%E9%9C%80%E8%A6%81%E5%9C%A8master%E4%B8%8A%E6%93%8D%E4%BD%9C%EF%BC%89" name="3.%E9%85%8D%E7%BD%AE%E5%85%8D%E5%AF%86%E7%99%BB%E5%BD%95%EF%BC%88%E5%8F%AA%E9%9C%80%E8%A6%81%E5%9C%A8master%E4%B8%8A%E6%93%8D%E4%BD%9C%EF%BC%89">
     3.配置免密登录（只需要在master上操作）
    </h3>
    <blockquote>
     <p>
      ssh-keygen -t rsa
     </p>
     <p>
      ssh-copy-id k8s-node01、k8s-node02  #复制给node机器
     </p>
    </blockquote>
    <h3 id="4.%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5%EF%BC%88%E6%AF%8F%E5%8F%B0%E8%8A%82%E7%82%B9%E9%83%BD%E8%A6%81%E5%81%9A%EF%BC%8C%E5%BF%85%E5%81%9A%EF%BC%8C%E5%90%A6%E5%88%99%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%9B%A0%E4%B8%BA%E6%97%B6%E9%97%B4%E4%B8%8D%E5%90%8C%E6%AD%A5%E5%AF%BC%E8%87%B4%E9%9B%86%E7%BE%A4%E5%88%9D%E5%A7%8B%E5%8C%96%E5%A4%B1%E8%B4%A5%EF%BC%89%C2%A0" name="4.%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5%EF%BC%88%E6%AF%8F%E5%8F%B0%E8%8A%82%E7%82%B9%E9%83%BD%E8%A6%81%E5%81%9A%EF%BC%8C%E5%BF%85%E5%81%9A%EF%BC%8C%E5%90%A6%E5%88%99%E5%8F%AF%E8%83%BD%E4%BC%9A%E5%9B%A0%E4%B8%BA%E6%97%B6%E9%97%B4%E4%B8%8D%E5%90%8C%E6%AD%A5%E5%AF%BC%E8%87%B4%E9%9B%86%E7%BE%A4%E5%88%9D%E5%A7%8B%E5%8C%96%E5%A4%B1%E8%B4%A5%EF%BC%89%C2%A0">
     4.时间同步（每台节点都要做，必做，否则可能会因为时间不同步导致集群初始化失败）
    </h3>
    <blockquote>
     <p>
      yum install chrony -y    #同步到同一时钟服务器上
     </p>
     <p>
      systemctl restart chronyd  #重启服务
     </p>
     <p>
      chronyc  sources  #验证时间同步
     </p>
    </blockquote>
    <h3 id="5.%E5%85%B3%E9%97%AD%E7%B3%BB%E7%BB%9F%E9%98%B2%E7%81%AB%E5%A2%99" name="5.%E5%85%B3%E9%97%AD%E7%B3%BB%E7%BB%9F%E9%98%B2%E7%81%AB%E5%A2%99">
     5.关闭系统防火墙
    </h3>
    <blockquote>
     <p>
      systemctl stop firewalld
     </p>
     <p>
      systemctl disable firewalld
     </p>
     <p>
      sed -i 's/enforcing/disabled/' /etc/selinux/config
     </p>
    </blockquote>
    <h3 id="6.%E9%85%8D%E7%BD%AE%E5%86%85%E6%A0%B8%E8%BD%AC%E5%8F%91%E5%8F%8A%E7%BD%91%E6%A1%A5%E8%BF%87%E6%BB%A4" name="6.%E9%85%8D%E7%BD%AE%E5%86%85%E6%A0%B8%E8%BD%AC%E5%8F%91%E5%8F%8A%E7%BD%91%E6%A1%A5%E8%BF%87%E6%BB%A4">
     6.配置内核转发及网桥过滤
    </h3>
    <blockquote>
     <p>
      #修改配置文件
     </p>
     <p>
      vim  /etc/sysctl.d/k8s.conf
     </p>
     <p>
      net.bridge.bridge-nf-call-ip6tables = 1
     </p>
     <p>
      net.bridge.bridge-nf-call-iptables = 1
     </p>
     <p>
      vm.swappiness = 0
     </p>
     <p>
      #加载 br_netfilter 模块
     </p>
     <p>
      modprobe  br_netfilter
     </p>
     <p>
      #查看是否加载
     </p>
     <p>
      lsmod | grep br_netfilter
     </p>
     <p>
      #使新添加的配置文件生效
     </p>
     <p>
      sysctl -p /etc/sysctl.d/k8s.conf
     </p>
    </blockquote>
    <h3 id="7.%E5%90%AF%E7%94%A8IPVS" name="7.%E5%90%AF%E7%94%A8IPVS">
     7.启用IPVS
    </h3>
    <blockquote>
     <p>
      vim /etc/sysconfig/modules/ipvs.modules
     </p>
     <p>
      #!/bin/bash
      <br/>
      ipvs_modules="ip_vs ip_vs_wlc ip_vs_wrr ip_vs_lblc ip_vs_lblcr ip_vs_dh ip_vs_sh ip_vs_nq ip_vs_sed ip_vs_ftp nf_conntrack"
      <br/>
      for kernel_module in ${ipvs_modules}
      <br/>
      do
      <br/>
      /usr/sbin/modinfo -F filename ${kernel_module} &gt;/dev/null 2&gt;&amp;1
      <br/>
      if [ $? -eq 0 ]
      <br/>
      then
      <br/>
      /usr/sbin/modprobe ${kernel_module}
      <br/>
      fi
      <br/>
      done
      <br/>
      然后给该文件添加执行权限
     </p>
     <p>
      chmod +x /etc/sysconfig/modules/ipvs.modules
     </p>
     <p>
      bash /etc/sysconfig/modules/ipvs.modules
     </p>
    </blockquote>
    <h3 id="8.%E5%85%B3%E9%97%ADSWAP%E5%88%86%E5%8C%BA" name="8.%E5%85%B3%E9%97%ADSWAP%E5%88%86%E5%8C%BA">
     8.关闭SWAP分区
    </h3>
    <blockquote>
     <p>
      临时关闭：swapoff  -a
     </p>
     <p>
      永久关闭：sed -i 's/.*swap.*/#&amp;/' /etc/fstab
     </p>
    </blockquote>
    <h2 id="%E4%BA%8C%E3%80%81%E5%AE%B9%E5%99%A8%E5%B7%A5%E4%BD%9C%E6%97%B6%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85" name="%E4%BA%8C%E3%80%81%E5%AE%B9%E5%99%A8%E5%B7%A5%E4%BD%9C%E6%97%B6%E5%B7%A5%E5%85%B7%E5%AE%89%E8%A3%85">
     二、容器工作时工具安装
    </h2>
    <h3 id="1.%E5%AE%89%E8%A3%85Docker" name="1.%E5%AE%89%E8%A3%85Docker">
     1.安装Docker
    </h3>
    <blockquote>
     <p>
      wget  https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
     </p>
     <p>
      #openEuler 系统在跟换源后需要将/etc/yum.repos.d/kubernetes.repo 中的$release 跟换成 8
     </p>
     <p>
     </p>
     <p>
      yum install docker-ce
     </p>
     <p>
      #开启docker 服务
     </p>
     <p>
      systemctl enable --now docker
     </p>
     <p>
      #然后配置国内镜像加速器
     </p>
     <p>
      vim /etc/docker/daemon.json
      <br/>
      {
      <!-- -->
     </p>
     <p>
      "exec-opts": ["native.cgroupdriver=systemd"],
      <br/>
      "registry-mirrors": [
      <br/>
      "https://docker.m.daocloud.io",
      <br/>
      "https://hub-mirror.c.163.com",
      <br/>
      "https://mirror.baidubce.com",
      <br/>
      "https://docker.nju.edu.cn"
      <br/>
      ]
      <br/>
      }
     </p>
    </blockquote>
    <h3 id="2.%E5%AE%89%E8%A3%85cri-dockerd" name="2.%E5%AE%89%E8%A3%85cri-dockerd">
     2.安装cri-dockerd
    </h3>
    <blockquote>
     <p>
      下载cri-dockerd 的rpm包  ==&gt;  上传 ==&gt;  yum  install ==&gt; 开机自启动
     </p>
     <p>
      然后修改里面的配置文件：
     </p>
     <p>
      vim  /usr/lib/systemd/system/cri-docker-service
     </p>
     <p>
      修改第11行：
     </p>
     <p>
      ExecStart=/usr/bin/cri-dockerd --network-plugin=cni --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.9
      <br/>
      然后重载 ==&gt; 开机自启 ==&gt; 检查组件状态
     </p>
     <p>
      systemctl daemon-reload &amp;&amp; systemctl enable cri-docker.socket &amp;&amp; systemctl status cri-docker.socket cri-docker docker
     </p>
    </blockquote>
    <h2 id="%E4%B8%89%E3%80%81%E5%AE%89%E8%A3%85%20k8s" name="%E4%B8%89%E3%80%81%E5%AE%89%E8%A3%85%20k8s">
     三、安装 k8s
    </h2>
    <blockquote>
     <p>
      更换kubernets的软件源  vim  /etc/yum.repo.d/kubernets.repo
     </p>
     <p>
      [kubernetes]
      <br/>
      name=Kubernetes
      <br/>
      baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.30/rpm/
      <br/>
      enabled=1
      <br/>
      gpgcheck=1
      <br/>
      gpgkey=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.30/rpm/repodata/repomd.xml.key
     </p>
     <p>
      yum clean all &amp;&amp; yum makecache
     </p>
     <p>
      #下载，重启
     </p>
     <ol>
      <li>
       <p>
        yum install  kubeadm-1.27.2 kubelet-1.27.2 kubectl-1.27.2 -y
       </p>
      </li>
      <li>
       <p>
        systemctl enable kubelet &amp;&amp; systemctl start kubelet
       </p>
      </li>
     </ol>
    </blockquote>
    <h2 id="%E5%9B%9B%E3%80%81k8s%E9%9B%86%E7%BE%A4%E5%88%9D%E5%A7%8B%E5%8C%96%20%EF%BC%88%E5%8F%AA%E5%9C%A8master%E8%8A%82%E7%82%B9%E4%B8%8A%E9%9D%A2%E6%93%8D%E4%BD%9C%EF%BC%89" name="%E5%9B%9B%E3%80%81k8s%E9%9B%86%E7%BE%A4%E5%88%9D%E5%A7%8B%E5%8C%96%20%EF%BC%88%E5%8F%AA%E5%9C%A8master%E8%8A%82%E7%82%B9%E4%B8%8A%E9%9D%A2%E6%93%8D%E4%BD%9C%EF%BC%89">
     四、k8s集群初始化 （只在master节点上面操作）
    </h2>
    <h3 id="1.%E5%88%9B%E5%BB%BA%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%87%E4%BB%B6" name="1.%E5%88%9B%E5%BB%BA%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%87%E4%BB%B6">
     1.创建初始化文件
    </h3>
    <blockquote>
     <p>
      [root@k8s-master ~]#kubeadm  config  print  init-defaultsb &gt; kubeadm-init.yaml
     </p>
    </blockquote>
    <h3 id="2.%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%87%E4%BB%B6" name="2.%E4%BF%AE%E6%94%B9%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%87%E4%BB%B6">
     2.修改初始化文件
    </h3>
    <blockquote>
     <p>
      [root@k8s-master ~]# vim kubeadm-init.yaml
     </p>
     <p>
      12行：advertiseAddress: 192.168.8.154    #master的ip地址
     </p>
     <p>
      15行：criSocket: unix:///var/run/cri-dockerd.sock
     </p>
     <p>
      17行：name: k8s-master    #master的主机名
     </p>
     <p>
      30行：imageRepository: registry.aliyuncs.com/google_containers #改成阿里云镜像代理地址
     </p>
    </blockquote>
    <h3 id="3.%E5%88%9D%E5%A7%8B%E5%8C%96" name="3.%E5%88%9D%E5%A7%8B%E5%8C%96">
     3.初始化
    </h3>
    <blockquote>
     <p>
      [root@k8s-master ~]# systemctl restart containerd
      <br/>
      [root@k8s-master ~]# systemctl restart kubelet
     </p>
     <p>
      [root@k8s-master ~]# kubeadm init --config=kubeadm-init.yaml --upload-certs --v=6
     </p>
    </blockquote>
    <h3 id="4.%E6%A0%B9%E6%8D%AE%E7%B3%BB%E7%BB%9F%E6%8F%90%E7%A4%BA%E5%88%9B%E5%BB%BA%E5%85%B7%E4%BD%93%E6%96%87%E4%BB%B6" name="4.%E6%A0%B9%E6%8D%AE%E7%B3%BB%E7%BB%9F%E6%8F%90%E7%A4%BA%E5%88%9B%E5%BB%BA%E5%85%B7%E4%BD%93%E6%96%87%E4%BB%B6">
     4.根据系统提示创建具体文件
    </h3>
    <p>
     <img alt="" height="542" src="https://i-blog.csdnimg.cn/direct/d2ae6ae6dccb4e4a8e6e882f9eb9892a.png" width="1329"/>
    </p>
    <p>
     <span style="background-color:#ffd900">
      然后根据初始化给的提示复制上面第一个到 node1 和 node2 节点上
     </span>
    </p>
    <h2 id="%E4%BA%94%E3%80%81k8s%20%E9%9B%86%E7%BE%A4%20node%20%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%EF%BC%88%E5%9C%A8node1%E5%92%8Cnode2%E4%B8%8A%E6%93%8D%E4%BD%9C%EF%BC%89" name="%E4%BA%94%E3%80%81k8s%20%E9%9B%86%E7%BE%A4%20node%20%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%EF%BC%88%E5%9C%A8node1%E5%92%8Cnode2%E4%B8%8A%E6%93%8D%E4%BD%9C%EF%BC%89">
     五、k8s 集群 node 节点加入（在node1和node2上操作）
    </h2>
    <p>
     执行
     <code>
      kubeadm join
     </code>
     命令将节点加入集群：
    </p>
    <p>
     <img alt="" height="442" src="https://i-blog.csdnimg.cn/direct/d130110cf821434cbdb80040d8a616ed.png" width="1330"/>
    </p>
    <h2 id="%E2%80%8B%E7%BC%96%E8%BE%91%E5%85%AD%E3%80%81%E6%B7%BB%E5%8A%A0%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%EF%BC%88%E5%9C%A8master%E4%B8%8A%E6%93%8D%E4%BD%9C%EF%BC%89" name="%E2%80%8B%E7%BC%96%E8%BE%91%E5%85%AD%E3%80%81%E6%B7%BB%E5%8A%A0%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%EF%BC%88%E5%9C%A8master%E4%B8%8A%E6%93%8D%E4%BD%9C%EF%BC%89">
     <img alt="" height="442" src="https://i-blog.csdnimg.cn/direct/e67fd9737fa3417488e04b08b7b09dff.png" width="1324">
      <br/>
      六、添加网络插件（在master上操作）
     </img>
    </h2>
    <h3 id="%E6%89%A7%E8%A1%8C%E5%AE%89%E8%A3%85Calico%EF%BC%9A" name="%E6%89%A7%E8%A1%8C%E5%AE%89%E8%A3%85Calico%EF%BC%9A">
     执行安装Calico：
    </h3>
    <p>
     kubernetes支持多种网络插件，比如flannel、calico、canal等，任选一种即可
    </p>
    <p>
     在Master节点上获取calico配置文件(可能会失败，如果失败，请下载到本地，然后安装)
    </p>
    <pre><code>kubectl create -f 
https://raw.githubusercontent.com/projectcalico/calico/v3.25.1/manifests/calico.yaml</code></pre>
    <p>
     1、比如我将下载好的配置文件上传到master节点上：
    </p>
    <p>
     <img alt="" height="105" src="https://i-blog.csdnimg.cn/direct/40810cbe347d42b3990651fe5d5fc514.png" width="1024"/>
    </p>
    <p>
     2、然后再进行安装：
     <span style="background-color:#ffd900">
      kubectl create -f  calico.yaml
     </span>
    </p>
    <p>
     <img alt="" height="921" src="https://i-blog.csdnimg.cn/direct/2cd7c66b346a4b0d849575ed7e03ab2f.png" width="1113"/>
    </p>
    <p>
     3、查看pod状态，如果是Running 状态就代表成功了，如果不是就代表有问题
    </p>
    <p>
     <img alt="" height="372" src="https://i-blog.csdnimg.cn/direct/f158bc06a1504c24a10397fdabde2c87.png" width="1044"/>
    </p>
    <h2 id="%E4%B8%83%E3%80%81%E6%9F%A5%E7%9C%8B" name="%E4%B8%83%E3%80%81%E6%9F%A5%E7%9C%8B" style="background-color:transparent">
     七、查看、验证
    </h2>
    <blockquote>
     <p>
      [root@k8s-master ~]# kubectl get no -o wide
      <br/>
      [root@k8s-master ~]# kubectl get pod -n kube-system
     </p>
     <p>
      [root@k8s-master ~]# kubectl get cs
     </p>
    </blockquote>
    <p>
     <img alt="" height="153" src="https://i-blog.csdnimg.cn/direct/877be62d9a7d41848529633d18b63900.png" width="2073"/>
    </p>
    <p>
     <img alt="" height="150" src="https://i-blog.csdnimg.cn/direct/4b7876b3d88b4902ae273695cccfd98c.png" width="747"/>
    </p>
    <p>
     <img alt="" height="535" src="https://i-blog.csdnimg.cn/direct/726d35b9d88f483888cbda9c5a3a6252.png" width="1017"/>
    </p>
    <h5>
     到这里一个一主两从的k8s集群已经搭建好了。
    </h5>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323430315f38333334323235312f:61727469636c652f64657461696c732f313436313237343336" class_="artid" style="display:none">
 </p>
</div>


