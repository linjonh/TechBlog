---
layout: post
title: "OpenGL实现场景编辑器"
date: 2025-03-09 12:11:03 +0800
description: "最近在使用Qt+OpenGL+glew+freeimage实现一个简单的场景编辑器，先看看他的功能是什么。这个是软件的界面，中间的widget是用来显示场景的，左侧上方的dockwidget可以拖动模型到显示场景中，左侧下方是dockwidget是用于显示场景中加载的模型列表，右侧的dockwidget是用于显示当前模型的信息，包括他的位置和缩放比例。选中模型后会显示他的包围盒，左侧上方点击scene Action可以切换模式，是拖动场景还是拖动模型，拖动模型的时候会将所有显示包围盒的模型都进行移动。"
keywords: "OpenGL实现场景编辑器"
categories: ['Qt', 'Opengl']
tags: ['游戏引擎', 'Qt']
artid: "146085099"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146085099
    alt: "OpenGL实现场景编辑器"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146085099
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146085099
cover: https://bing.ee123.net/img/rand?artid=146085099
image: https://bing.ee123.net/img/rand?artid=146085099
img: https://bing.ee123.net/img/rand?artid=146085099
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     OpenGL实现场景编辑器
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <br/>
    最近在使用Qt+OpenGL+glew+freeimage实现一个简单的场景编辑器，先看看他的功能是什么。
    <br/>
    <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c3c170e7fe2242d691fc9ba233da958e.png">
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/696670dcf4e34e8dbfdea0ac700304f2.png">
      <p>
      </p>
      <p>
       这个是软件的界面，中间的widget是用来显示场景的，左侧上方的dockwidget可以拖动模型到显示场景中，左侧下方是dockwidget是用于显示场景中加载的模型列表，右侧的dockwidget是用于显示当前模型的信息，包括他的位置和缩放比例。选中模型后会显示他的包围盒，左侧上方点击scene Action可以切换模式，是拖动场景还是拖动模型，拖动模型的时候会将所有显示包围盒的模型都进行移动。
      </p>
      <h2>
       <a id="_6">
       </a>
       界面模块
      </h2>
      <p>
       界面是使用QMainWindow，渲染界面是继承于QWidget，左右两侧有三个QDockWidget，左侧上方是一个QListWidget，用于显示所有xlm模型，左侧下方是一个QTreeWidget，用于显示所有在场景中的模型列表，右侧是用于显示模型的属性，这个是从Qt源码中拿出来的QtTreePropertyBrowser类。
       <br/>
       QtListWidget.h
      </p>
      <pre><code class="prism language-cpp">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">QTLISTWIDGET_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">QTLISTWIDGET_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QListWidget&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rapidxml.hpp"</span></span>

<span class="token keyword">class</span> <span class="token class-name">QtListWidget</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">QListWidget</span></span>
<span class="token punctuation">{<!-- --></span>
    Q_OBJECT

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">QtListWidget</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>parent <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">QtListWidget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> xmlFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">dragEnterEvent</span><span class="token punctuation">(</span>QDragEnterEvent <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">dragMoveEvent</span><span class="token punctuation">(</span>QDragMoveEvent <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">dropEvent</span><span class="token punctuation">(</span>QDropEvent <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">startDrag</span><span class="token punctuation">(</span>Qt<span class="token double-colon punctuation">::</span>DropActions supportedActions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre>
      <p>
       QtListWidget.cpp
      </p>
      <pre><code class="prism language-cpp">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QtGui&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"QtListWidget.h"</span></span>

<span class="token class-name">QtListWidget</span><span class="token double-colon punctuation">::</span><span class="token function">QtListWidget</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>parent<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">QListWidget</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">setDragEnabled</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setViewMode</span><span class="token punctuation">(</span>QListView<span class="token double-colon punctuation">::</span>IconMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setSpacing</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setAcceptDrops</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setDropIndicatorShown</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//for (int i = 0; i &lt; 10; ++i)</span>
    <span class="token comment">//{<!-- --></span>
    <span class="token comment">//    QString path = QCoreApplication::applicationDirPath();</span>
    <span class="token comment">//    QPixmap bmp;</span>
    <span class="token comment">//    bmp.load(path + "/images/example.jpg");</span>

    <span class="token comment">//    QListWidgetItem* item = new QListWidgetItem(this);</span>
    <span class="token comment">//    item-&gt;setIcon(QIcon(bmp));</span>
    <span class="token comment">//    item-&gt;setData(Qt::UserRole, QVariant(bmp));</span>
    <span class="token comment">//    item-&gt;setData(Qt::UserRole + 1, QPoint(1, 1));</span>
    <span class="token comment">//    item-&gt;setFlags(Qt::ItemIsEnabled | Qt::ItemIsSelectable | Qt::ItemIsDragEnabled);</span>
    <span class="token comment">//    item-&gt;setText("test-icon");</span>
    <span class="token comment">//}</span>
<span class="token punctuation">}</span>


<span class="token class-name">QtListWidget</span><span class="token double-colon punctuation">::</span><span class="token operator">~</span><span class="token function">QtListWidget</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token class-name">QtListWidget</span><span class="token double-colon punctuation">::</span><span class="token function">dragEnterEvent</span><span class="token punctuation">(</span>QDragEnterEvent <span class="token operator">*</span>event<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token operator">-&gt;</span><span class="token function">mimeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">hasFormat</span><span class="token punctuation">(</span><span class="token string">"image/x-puzzle-piece"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        event<span class="token operator">-&gt;</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        event<span class="token operator">-&gt;</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">QtListWidget</span><span class="token double-colon punctuation">::</span><span class="token function">dragMoveEvent</span><span class="token punctuation">(</span>QDragMoveEvent <span class="token operator">*</span>event<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token operator">-&gt;</span><span class="token function">mimeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">hasFormat</span><span class="token punctuation">(</span><span class="token string">"image/x-puzzle-piece"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        event<span class="token operator">-&gt;</span><span class="token function">setDropAction</span><span class="token punctuation">(</span>Qt<span class="token double-colon punctuation">::</span>MoveAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        event<span class="token operator">-&gt;</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        event<span class="token operator">-&gt;</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">QtListWidget</span><span class="token double-colon punctuation">::</span><span class="token function">dropEvent</span><span class="token punctuation">(</span>QDropEvent <span class="token operator">*</span>event<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    event<span class="token operator">-&gt;</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">QtListWidget</span><span class="token double-colon punctuation">::</span><span class="token function">startDrag</span><span class="token punctuation">(</span>Qt<span class="token double-colon punctuation">::</span>DropActions <span class="token comment">/*supportedActions*/</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QListWidgetItem <span class="token operator">*</span>item <span class="token operator">=</span> <span class="token function">currentItem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    QByteArray  itemData<span class="token punctuation">;</span>
    QDataStream <span class="token function">dataStream</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>itemData<span class="token punctuation">,</span> QIODevice<span class="token double-colon punctuation">::</span>WriteOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
    QPixmap     pixmap      <span class="token operator">=</span>   <span class="token generic-function"><span class="token function">qvariant_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>QPixmap<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>item<span class="token operator">-&gt;</span><span class="token function">data</span><span class="token punctuation">(</span>Qt<span class="token double-colon punctuation">::</span>UserRole<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QString     location <span class="token operator">=</span> item<span class="token operator">-&gt;</span><span class="token function">data</span><span class="token punctuation">(</span>Qt<span class="token double-colon punctuation">::</span>UserRole <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    dataStream <span class="token operator">&lt;&lt;</span> location<span class="token punctuation">;</span>

    QMimeData<span class="token operator">*</span>  mimeData    <span class="token operator">=</span>   <span class="token keyword">new</span> QMimeData<span class="token punctuation">;</span>
    mimeData<span class="token operator">-&gt;</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">"image/x-puzzle-piece"</span><span class="token punctuation">,</span> itemData<span class="token punctuation">)</span><span class="token punctuation">;</span>

    QDrag<span class="token operator">*</span>  drag    <span class="token operator">=</span>   <span class="token keyword">new</span> <span class="token function">QDrag</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    drag<span class="token operator">-&gt;</span><span class="token function">setMimeData</span><span class="token punctuation">(</span>mimeData<span class="token punctuation">)</span><span class="token punctuation">;</span>
    drag<span class="token operator">-&gt;</span><span class="token function">setHotSpot</span><span class="token punctuation">(</span><span class="token function">QPoint</span><span class="token punctuation">(</span>pixmap<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> pixmap<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    drag<span class="token operator">-&gt;</span><span class="token function">setPixmap</span><span class="token punctuation">(</span>pixmap<span class="token punctuation">)</span><span class="token punctuation">;</span>

    drag<span class="token operator">-&gt;</span><span class="token function">exec</span><span class="token punctuation">(</span>Qt<span class="token double-colon punctuation">::</span>MoveAction<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">QtListWidget</span><span class="token double-colon punctuation">::</span><span class="token function">load</span><span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> xmlFile <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FILE<span class="token operator">*</span>   pFile   <span class="token operator">=</span>   <span class="token function">fopen</span><span class="token punctuation">(</span>xmlFile<span class="token punctuation">,</span><span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pFile <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">fseek</span><span class="token punctuation">(</span>pFile<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">SEEK_END</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    size_t  len <span class="token operator">=</span>   <span class="token function">ftell</span><span class="token punctuation">(</span>pFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fseek</span><span class="token punctuation">(</span>pFile<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token constant">SEEK_SET</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">char</span><span class="token operator">*</span>   xml    <span class="token operator">=</span>   <span class="token keyword">new</span> <span class="token keyword">char</span><span class="token punctuation">[</span>len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">fread</span><span class="token punctuation">(</span>xml<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>len<span class="token punctuation">,</span>pFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    xml<span class="token punctuation">[</span>len<span class="token punctuation">]</span>   <span class="token operator">=</span>   <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>pFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span>
    <span class="token punctuation">{<!-- --></span>
        rapidxml<span class="token double-colon punctuation">::</span>xml_document<span class="token operator">&lt;</span><span class="token operator">&gt;</span>    doc<span class="token punctuation">;</span>
        doc<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">parse</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>xml<span class="token punctuation">)</span><span class="token punctuation">;</span>

        rapidxml<span class="token double-colon punctuation">::</span>xml_node<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span> root <span class="token operator">=</span> doc<span class="token punctuation">.</span><span class="token function">first_node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rapidxml<span class="token double-colon punctuation">::</span>xml_node<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span> model <span class="token operator">=</span> root<span class="token operator">-&gt;</span><span class="token function">first_node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> model <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span> model <span class="token operator">=</span> model<span class="token operator">-&gt;</span><span class="token function">next_sibling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            rapidxml<span class="token double-colon punctuation">::</span>xml_attribute<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span> attrIcon <span class="token operator">=</span> model<span class="token operator">-&gt;</span><span class="token function">first_attribute</span><span class="token punctuation">(</span><span class="token string">"icon"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rapidxml<span class="token double-colon punctuation">::</span>xml_attribute<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span> attrFile <span class="token operator">=</span> model<span class="token operator">-&gt;</span><span class="token function">first_attribute</span><span class="token punctuation">(</span><span class="token string">"file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rapidxml<span class="token double-colon punctuation">::</span>xml_attribute<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span> attrText <span class="token operator">=</span> model<span class="token operator">-&gt;</span><span class="token function">first_attribute</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            QString bmpPath <span class="token operator">=</span> <span class="token class-name">QCoreApplication</span><span class="token double-colon punctuation">::</span><span class="token function">applicationDirPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> attrIcon<span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            QPixmap bmp<span class="token punctuation">;</span>
            bmp<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>bmpPath<span class="token punctuation">)</span><span class="token punctuation">;</span>

            QListWidgetItem<span class="token operator">*</span> item <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QListWidgetItem</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            item<span class="token operator">-&gt;</span><span class="token function">setIcon</span><span class="token punctuation">(</span><span class="token function">QIcon</span><span class="token punctuation">(</span>bmp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            item<span class="token operator">-&gt;</span><span class="token function">setData</span><span class="token punctuation">(</span>Qt<span class="token double-colon punctuation">::</span>UserRole<span class="token punctuation">,</span> <span class="token function">QVariant</span><span class="token punctuation">(</span>bmp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            item<span class="token operator">-&gt;</span><span class="token function">setData</span><span class="token punctuation">(</span>Qt<span class="token double-colon punctuation">::</span>UserRole <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> attrFile<span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            item<span class="token operator">-&gt;</span><span class="token function">setFlags</span><span class="token punctuation">(</span>Qt<span class="token double-colon punctuation">::</span>ItemIsEnabled <span class="token operator">|</span> Qt<span class="token double-colon punctuation">::</span>ItemIsSelectable <span class="token operator">|</span> Qt<span class="token double-colon punctuation">::</span>ItemIsDragEnabled<span class="token punctuation">)</span><span class="token punctuation">;</span>
            item<span class="token operator">-&gt;</span><span class="token function">setText</span><span class="token punctuation">(</span>attrText<span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">delete</span>  <span class="token punctuation">[</span><span class="token punctuation">]</span>xml<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
      <h2>
       <a id="_177">
       </a>
       渲染模块
      </h2>
      <p>
       渲染模块主要是通过glew库和Qt的定时器来实现的。
      </p>
      <pre><code class="prism language-cpp"><span class="token function">connect</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_renderTimer<span class="token punctuation">,</span><span class="token operator">&amp;</span>QTimer<span class="token double-colon punctuation">::</span>timeout<span class="token punctuation">,</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>OGLWidget<span class="token double-colon punctuation">::</span>render<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      <p>
       这个项目加载的模型是用的xml格式。
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/3be5b3b7ccab4b068e39adedaa27b6c6.png">
        <br/>
        目前这个项目使用的固定管线来进行渲染的，所有没有写着色器。首先说一下记载纹理是用的FreeImage库
       </img>
      </p>
      <pre><code class="prism language-cpp"><span class="token keyword">unsigned</span> <span class="token class-name">Scene</span><span class="token double-colon punctuation">::</span><span class="token function">createTextureFromImage</span><span class="token punctuation">(</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> fileName <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1 获取图片格式</span>
    FREE_IMAGE_FORMAT       fifmt   <span class="token operator">=</span>   <span class="token function">FreeImage_GetFileType</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fifmt <span class="token operator">==</span> FIF_UNKNOWN<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span>  <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//2 加载图片</span>
    FIBITMAP<span class="token operator">*</span>               dib     <span class="token operator">=</span>   <span class="token function">FreeImage_Load</span><span class="token punctuation">(</span>fifmt<span class="token punctuation">,</span> fileName<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    FREE_IMAGE_COLOR_TYPE   type    <span class="token operator">=</span>   <span class="token function">FreeImage_GetColorType</span><span class="token punctuation">(</span>dib<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//! 获取数据指针</span>
    FIBITMAP<span class="token operator">*</span>   temp    <span class="token operator">=</span>   dib<span class="token punctuation">;</span>
    dib <span class="token operator">=</span>   <span class="token function">FreeImage_ConvertTo32Bits</span><span class="token punctuation">(</span>dib<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FreeImage_Unload</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    BYTE<span class="token operator">*</span>   pixels <span class="token operator">=</span>   <span class="token punctuation">(</span>BYTE<span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">FreeImage_GetBits</span><span class="token punctuation">(</span>dib<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span>     width   <span class="token operator">=</span>   <span class="token function">FreeImage_GetWidth</span><span class="token punctuation">(</span>dib<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span>     height  <span class="token operator">=</span>   <span class="token function">FreeImage_GetHeight</span><span class="token punctuation">(</span>dib<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>i <span class="token operator">&lt;</span> width <span class="token operator">*</span> height <span class="token operator">*</span> <span class="token number">4</span> <span class="token punctuation">;</span> i<span class="token operator">+=</span><span class="token number">4</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        BYTE temp       <span class="token operator">=</span>   pixels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        pixels<span class="token punctuation">[</span>i<span class="token punctuation">]</span>       <span class="token operator">=</span>   pixels<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        pixels<span class="token punctuation">[</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span>   <span class="token operator">=</span>   temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">unsigned</span>    res <span class="token operator">=</span>   <span class="token function">createTexture</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span>height<span class="token punctuation">,</span>pixels<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">FreeImage_Unload</span><span class="token punctuation">(</span>dib<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span>      res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">unsigned</span> <span class="token class-name">Scene</span><span class="token double-colon punctuation">::</span><span class="token function">createTexture</span><span class="token punctuation">(</span> <span class="token keyword">int</span> w<span class="token punctuation">,</span><span class="token keyword">int</span> h<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">void</span><span class="token operator">*</span> data <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span>    texId<span class="token punctuation">;</span>
    <span class="token function">glGenTextures</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>texId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span>texId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span>GL_TEXTURE_MAG_FILTER<span class="token punctuation">,</span>GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexParameteri</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span>GL_TEXTURE_MIN_FILTER<span class="token punctuation">,</span>GL_LINEAR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexImage2D</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>GL_RGBA<span class="token punctuation">,</span>w<span class="token punctuation">,</span>h<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>GL_RGBA<span class="token punctuation">,</span>GL_UNSIGNED_BYTE<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span>  texId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      <pre><code class="prism language-cpp">    V3U2    vertexs<span class="token punctuation">[</span><span class="token punctuation">]</span>   <span class="token operator">=</span>   
    <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">{<!-- --></span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>   <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>   <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>

        <span class="token punctuation">{<!-- --></span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>   <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">0</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>i  <span class="token operator">&lt;</span> <span class="token number">6</span> <span class="token punctuation">;</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        vertexs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>x    <span class="token operator">*=</span>   <span class="token number">100</span><span class="token punctuation">;</span>
        vertexs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>z    <span class="token operator">*=</span>   <span class="token number">100</span><span class="token punctuation">;</span>

        vertexs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>u    <span class="token operator">*=</span>   <span class="token number">10</span><span class="token punctuation">;</span>
        vertexs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>v    <span class="token operator">*=</span>   <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span>_texGround<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">glEnableClientState</span><span class="token punctuation">(</span>GL_VERTEX_ARRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glEnableClientState</span><span class="token punctuation">(</span>GL_TEXTURE_COORD_ARRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">glVertexPointer</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>GL_FLOAT<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>V3U2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>vertexs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glTexCoordPointer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>GL_FLOAT<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>V3U2<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>vertexs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">glDrawArrays</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">glDisableClientState</span><span class="token punctuation">(</span>GL_VERTEX_ARRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">glDisableClientState</span><span class="token punctuation">(</span>GL_TEXTURE_COORD_ARRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      <p>
       这个是渲染地面的代码，只需要传入顶点数据，纹理坐标和纹理即可。
       <br/>
       再说一下模型的渲染在当前项目中的架构：
       <br/>
       首先有有一个基类CELLObject，里面记录了名称和一些用户自定义的数据。
      </p>
      <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token keyword">namespace</span>   CELL
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">class</span>   <span class="token class-name">CELLObject</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">protected</span><span class="token operator">:</span>
        <span class="token keyword">void</span><span class="token operator">*</span>   _user<span class="token punctuation">;</span>
        <span class="token keyword">char</span> _name<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">CELLObject</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> user <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token operator">:</span><span class="token function">_user</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">CELLObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token keyword">void</span>    <span class="token function">setUserData</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> user<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _user   <span class="token operator">=</span>   user<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span><span class="token operator">*</span>   <span class="token function">getUserData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>  _user<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> _name<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">strncpy</span><span class="token punctuation">(</span>_name<span class="token punctuation">,</span> name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      <p>
       负责管理节点的是CELLNode类，里面存储了模型的一些信息，包括位置，缩放，旋转信息，包围盒，可绘制体。
      </p>
      <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"CELLMath.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"CELLRenderable.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"glew/glew.h"</span></span>

<span class="token keyword">namespace</span>   CELL
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">class</span>   <span class="token class-name">CELLNode</span>  <span class="token operator">:</span><span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">CELLObject</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">enum</span>
        <span class="token punctuation">{<!-- --></span>
            FLAG_NORMAL <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span>
            FLAG_SELECT <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">,</span>
            FLAG_VISIBLE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span>
            FLAG_UPDATE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span><span class="token operator">:</span>
        CELL<span class="token double-colon punctuation">::</span>quatr         _quat<span class="token punctuation">;</span>
        CELL<span class="token double-colon punctuation">::</span>real3         _scale<span class="token punctuation">;</span>
        CELL<span class="token double-colon punctuation">::</span>real3         _trans<span class="token punctuation">;</span>
        CELL<span class="token double-colon punctuation">::</span>aabb3d        _aabb<span class="token punctuation">;</span>
        CELL<span class="token double-colon punctuation">::</span>matrix4       _local<span class="token punctuation">;</span>
        CELLRenderable<span class="token operator">*</span>     _renderable<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span> _flag<span class="token punctuation">;</span>
        
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">CELLNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _flag <span class="token operator">=</span> FLAG_NORMAL <span class="token operator">|</span> FLAG_VISIBLE<span class="token punctuation">;</span>
            _scale  <span class="token operator">=</span>   <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _quat   <span class="token operator">=</span>   <span class="token function">angleAxis</span><span class="token punctuation">(</span><span class="token function">real</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">real3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _local  <span class="token operator">=</span>   <span class="token function">makeTransform</span><span class="token punctuation">(</span>_trans<span class="token punctuation">,</span>_scale<span class="token punctuation">,</span>_quat<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>_name<span class="token punctuation">,</span> <span class="token string">"CELLNode-%p"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">CELLNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token keyword">inline</span>  <span class="token keyword">void</span>    <span class="token function">setFlag</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> flag<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _flag <span class="token operator">|=</span> flag<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">inline</span>  <span class="token keyword">void</span>    <span class="token function">removeFlag</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> flag<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _flag <span class="token operator">&amp;=</span> <span class="token operator">~</span>flag<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">inline</span>  <span class="token keyword">bool</span>    <span class="token function">hasFlag</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> flag<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>  _flag <span class="token operator">&amp;</span> flag <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">inline</span>  <span class="token keyword">void</span>    <span class="token function">setAabb</span><span class="token punctuation">(</span><span class="token keyword">const</span> aabb3d<span class="token operator">&amp;</span> aabb<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _aabb   <span class="token operator">=</span>   aabb<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">inline</span>  aabb3d  <span class="token function">getAabb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>  _aabb<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">inline</span> CELL<span class="token double-colon punctuation">::</span>matrix4 <span class="token function">getLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> _local<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">setLocal</span><span class="token punctuation">(</span>CELL<span class="token double-colon punctuation">::</span>matrix4 matrix<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _local <span class="token operator">=</span> matrix<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">inline</span>  <span class="token keyword">void</span>    <span class="token function">setScale</span><span class="token punctuation">(</span><span class="token keyword">const</span> float3<span class="token operator">&amp;</span> scale<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _scale  <span class="token operator">=</span>   scale<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">inline</span>  float3  <span class="token function">getScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>  _scale<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">inline</span> float3 <span class="token function">getTrans</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> _trans<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">inline</span>  <span class="token keyword">void</span>    <span class="token function">setTranslation</span><span class="token punctuation">(</span><span class="token keyword">const</span> float3<span class="token operator">&amp;</span> trans<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _trans  <span class="token operator">=</span>   trans<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">inline</span>  <span class="token keyword">void</span>    <span class="token function">setQuat</span><span class="token punctuation">(</span><span class="token keyword">const</span> quatr<span class="token operator">&amp;</span> quat<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _quat   <span class="token operator">=</span>   quat<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">inline</span>  quatr    <span class="token function">getQuat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> _quat<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">inline</span>  <span class="token keyword">void</span>    <span class="token function">setAngle</span><span class="token punctuation">(</span><span class="token keyword">float</span> angle<span class="token punctuation">,</span>float3 axis <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _quat   <span class="token operator">=</span>   <span class="token class-name">CELL</span><span class="token double-colon punctuation">::</span><span class="token function">angleAxis</span><span class="token punctuation">(</span>angle<span class="token punctuation">,</span>axis<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span>CELLRenderable<span class="token operator">*</span> render<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _renderable <span class="token operator">=</span> render<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">inline</span> CELL<span class="token double-colon punctuation">::</span>CELLRenderable<span class="token operator">*</span> <span class="token function">getAttach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">const</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> _renderable<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _local <span class="token operator">=</span> <span class="token function">makeTransform</span><span class="token punctuation">(</span>_trans<span class="token punctuation">,</span> _scale<span class="token punctuation">,</span> _quat<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">render</span><span class="token punctuation">(</span>CELLCamera<span class="token operator">&amp;</span> camera<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            CELL<span class="token double-colon punctuation">::</span>matrix4 vp <span class="token operator">=</span> camera<span class="token punctuation">.</span><span class="token function">getProject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> camera<span class="token punctuation">.</span><span class="token function">getView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            CELL<span class="token double-colon punctuation">::</span>matrix4 mvp <span class="token operator">=</span> vp <span class="token operator">*</span> _local<span class="token punctuation">;</span>
            <span class="token function">glLoadMatrixf</span><span class="token punctuation">(</span>mvp<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _renderable<span class="token operator">-&gt;</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>_flag <span class="token operator">&amp;</span> FLAG_SELECT<span class="token punctuation">)</span>
                <span class="token function">renderAabb</span><span class="token punctuation">(</span>vp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">renderAabb</span><span class="token punctuation">(</span>CELL<span class="token double-colon punctuation">::</span>matrix4 <span class="token operator">&amp;</span>vp<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            float3          vertex<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            aabb3d  aabb <span class="token operator">=</span> _aabb<span class="token punctuation">;</span>
            aabb<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>_local<span class="token punctuation">)</span><span class="token punctuation">;</span>
            aabb<span class="token punctuation">.</span><span class="token function">getAllCorners</span><span class="token punctuation">(</span>vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">unsigned</span> <span class="token keyword">char</span>   index<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>    <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>    <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>    <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
                <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span>    <span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span>    <span class="token number">6</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span>    <span class="token number">7</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>
                <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span>    <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">,</span>    <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token function">glLoadMatrixf</span><span class="token punctuation">(</span>vp<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">glColor3f</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">glEnableClientState</span><span class="token punctuation">(</span>GL_VERTEX_ARRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">glVertexPointer</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> GL_FLOAT<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>float3<span class="token punctuation">)</span><span class="token punctuation">,</span> vertex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">glDrawElements</span><span class="token punctuation">(</span>GL_LINES<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span> GL_UNSIGNED_BYTE<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">glDisableClientState</span><span class="token punctuation">(</span>GL_VERTEX_ARRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">glColor3f</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      <p>
       最后负责渲染的是CELLRenderable类，其中有两个虚函数需要子类实现
      </p>
      <pre><code class="prism language-cpp">        <span class="token keyword">virtual</span> <span class="token keyword">bool</span>    <span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> fileName<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>  <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/**
        *   绘制函数
        */</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span>    <span class="token function">render</span><span class="token punctuation">(</span>CELLNode<span class="token operator">*</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre>
      <p>
       这两个函数分别是加载函数和渲染函数，由于目前是使用xml格式的数据进行渲染，所以实现了CELLModelXML类。
      </p>
      <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rapidxml.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"CELLRenderable.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"CELLFileReader.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"CELLTextureMgr.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QString&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;QCoreApplication&gt;</span></span>

<span class="token keyword">namespace</span>   CELL
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">class</span>   <span class="token class-name">CELLModelXML</span> <span class="token operator">:</span><span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">CELLRenderable</span></span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">struct</span>  <span class="token class-name">V3N3U2</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">float</span>   x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z<span class="token punctuation">;</span>
            <span class="token keyword">float</span>   nx<span class="token punctuation">,</span>ny<span class="token punctuation">,</span>nz<span class="token punctuation">;</span>
            <span class="token keyword">float</span>   u<span class="token punctuation">,</span>v<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">struct</span>  <span class="token class-name">Face</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">short</span>   x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>z<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span>  <span class="token class-name">Primitive</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span>     start<span class="token punctuation">;</span>
            <span class="token keyword">int</span>     count<span class="token punctuation">;</span>
            <span class="token keyword">int</span>     mode<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>V3N3U2<span class="token operator">&gt;</span>     ArrayVertex<span class="token punctuation">;</span>
        <span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Face<span class="token operator">&gt;</span>       ArrayFace<span class="token punctuation">;</span>
        <span class="token keyword">typedef</span> std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Primitive<span class="token operator">&gt;</span>  ArrayPri<span class="token punctuation">;</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token function">CELLModelXML</span><span class="token punctuation">(</span><span class="token keyword">const</span> CELLModelXML<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        CELLModelXML<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> CELLModelXML<span class="token operator">&amp;</span> rights<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        ArrayVertex _vertexs<span class="token punctuation">;</span>
        ArrayFace   _faces<span class="token punctuation">;</span>
        ArrayPri    _primitive<span class="token punctuation">;</span>
        <span class="token keyword">unsigned</span>    _texture<span class="token punctuation">;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">CELLModelXML</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">CELLModelXML</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token comment">/**
        *   加载文件
        */</span>
        <span class="token keyword">virtual</span> <span class="token keyword">bool</span>    <span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> fileName<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            CELLFileReader  <span class="token function">file</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isBad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span>  <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            file<span class="token punctuation">.</span><span class="token function">readAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                rapidxml<span class="token double-colon punctuation">::</span>xml_document<span class="token operator">&lt;</span><span class="token operator">&gt;</span>    doc<span class="token punctuation">;</span>
                rapidxml<span class="token double-colon punctuation">::</span>xml_node<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span>	    rootNode    <span class="token operator">=</span>   <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">char</span><span class="token operator">*</span>                       xmlData     <span class="token operator">=</span>   <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>file<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                doc<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">parse</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>xmlData<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                rootNode    <span class="token operator">=</span>	doc<span class="token punctuation">.</span><span class="token function">first_node</span><span class="token punctuation">(</span><span class="token string">"mesh"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>rootNode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span>  <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                rapidxml<span class="token double-colon punctuation">::</span>xml_node<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span>       node        <span class="token operator">=</span>   rootNode<span class="token operator">-&gt;</span><span class="token function">first_node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token punctuation">;</span> node <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">;</span> node <span class="token operator">=</span> node<span class="token operator">-&gt;</span><span class="token function">next_sibling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"vertex"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token function">parseVertexs</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"face"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token function">parseFace</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"primitive"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token function">parsePrimitive</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span>  <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span>  <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">render</span><span class="token punctuation">(</span>CELLNode<span class="token operator">*</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">glBindTexture</span><span class="token punctuation">(</span>GL_TEXTURE_2D<span class="token punctuation">,</span> _texture<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">glEnableClientState</span><span class="token punctuation">(</span>GL_VERTEX_ARRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">glEnableClientState</span><span class="token punctuation">(</span>GL_TEXTURE_COORD_ARRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">glVertexPointer</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span>GL_FLOAT<span class="token punctuation">,</span>         <span class="token keyword">sizeof</span><span class="token punctuation">(</span>V3N3U2<span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token operator">&amp;</span>_vertexs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">glTexCoordPointer</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span>GL_FLOAT<span class="token punctuation">,</span>       <span class="token keyword">sizeof</span><span class="token punctuation">(</span>V3N3U2<span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token operator">&amp;</span>_vertexs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">glDrawElements</span><span class="token punctuation">(</span>GL_TRIANGLES<span class="token punctuation">,</span>_faces<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">,</span>GL_UNSIGNED_SHORT<span class="token punctuation">,</span><span class="token operator">&amp;</span>_faces<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">glDisableClientState</span><span class="token punctuation">(</span>GL_VERTEX_ARRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">glDisableClientState</span><span class="token punctuation">(</span>GL_TEXTURE_COORD_ARRAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token keyword">protected</span><span class="token operator">:</span>

        <span class="token comment">/**
        *   内部调用，主要用来计算包围盒大小
        */</span>
        <span class="token keyword">void</span>    <span class="token function">updateAabb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            float3  vMin   <span class="token operator">=</span>   <span class="token function">float3</span><span class="token punctuation">(</span>FLT_MAX<span class="token punctuation">,</span>FLT_MAX<span class="token punctuation">,</span>FLT_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>
            float3  vMax   <span class="token operator">=</span>   <span class="token function">float3</span><span class="token punctuation">(</span><span class="token operator">-</span>FLT_MAX<span class="token punctuation">,</span><span class="token operator">-</span>FLT_MAX<span class="token punctuation">,</span><span class="token operator">-</span>FLT_MAX<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>i <span class="token operator">&lt;</span> _vertexs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                V3N3U2<span class="token operator">&amp;</span>     pData   <span class="token operator">=</span>   _vertexs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

                vMin<span class="token punctuation">.</span>x <span class="token operator">=</span>   <span class="token function">tmin</span><span class="token punctuation">(</span>pData<span class="token punctuation">.</span>x<span class="token punctuation">,</span>vMin<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                vMin<span class="token punctuation">.</span>y <span class="token operator">=</span>   <span class="token function">tmin</span><span class="token punctuation">(</span>pData<span class="token punctuation">.</span>y<span class="token punctuation">,</span>vMin<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                vMin<span class="token punctuation">.</span>z <span class="token operator">=</span>   <span class="token function">tmin</span><span class="token punctuation">(</span>pData<span class="token punctuation">.</span>z<span class="token punctuation">,</span>vMin<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>

                vMax<span class="token punctuation">.</span>x <span class="token operator">=</span>   <span class="token function">tmax</span><span class="token punctuation">(</span>pData<span class="token punctuation">.</span>x<span class="token punctuation">,</span>vMax<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                vMax<span class="token punctuation">.</span>y <span class="token operator">=</span>   <span class="token function">tmax</span><span class="token punctuation">(</span>pData<span class="token punctuation">.</span>y<span class="token punctuation">,</span>vMax<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
                vMax<span class="token punctuation">.</span>z <span class="token operator">=</span>   <span class="token function">tmax</span><span class="token punctuation">(</span>pData<span class="token punctuation">.</span>z<span class="token punctuation">,</span>vMax<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            _aabb<span class="token punctuation">.</span><span class="token function">setExtents</span><span class="token punctuation">(</span>vMin<span class="token punctuation">,</span>vMax<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">/**
        *   解析顶点信息
        */</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">parseVertexs</span><span class="token punctuation">(</span> rapidxml<span class="token double-colon punctuation">::</span>xml_node<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span> node <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            rapidxml<span class="token double-colon punctuation">::</span>xml_attribute<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span>  attrCount   <span class="token operator">=</span>   node<span class="token operator">-&gt;</span><span class="token function">first_attribute</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rapidxml<span class="token double-colon punctuation">::</span>xml_attribute<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span>  attrSizeOf  <span class="token operator">=</span>   node<span class="token operator">-&gt;</span><span class="token function">first_attribute</span><span class="token punctuation">(</span><span class="token string">"size"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rapidxml<span class="token double-colon punctuation">::</span>xml_node<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span>       cNode       <span class="token operator">=</span>   <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span>                 pValue      <span class="token operator">=</span>   <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">unsigned</span>                    dataSize    <span class="token operator">=</span>   <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>attrCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> attrSizeOf <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">int</span> dataCount   <span class="token operator">=</span>   <span class="token function">atoi</span><span class="token punctuation">(</span>attrCount<span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>dataCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            _vertexs<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>dataCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cNode       <span class="token operator">=</span>   node<span class="token operator">-&gt;</span><span class="token function">first_node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> cNode <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> dataCount<span class="token punctuation">;</span> cNode <span class="token operator">=</span> cNode<span class="token operator">-&gt;</span><span class="token function">next_sibling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                V3N3U2<span class="token operator">&amp;</span> vertex  <span class="token operator">=</span>   _vertexs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        pValue  <span class="token operator">=</span>   cNode<span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">sscanf</span><span class="token punctuation">(</span>
                    pValue
                    <span class="token punctuation">,</span><span class="token string">"%f %f %f %f %f %f %f %f"</span>
                    <span class="token punctuation">,</span><span class="token operator">&amp;</span>vertex<span class="token punctuation">.</span>x
                    <span class="token punctuation">,</span><span class="token operator">&amp;</span>vertex<span class="token punctuation">.</span>y
                    <span class="token punctuation">,</span><span class="token operator">&amp;</span>vertex<span class="token punctuation">.</span>z
                    <span class="token punctuation">,</span><span class="token operator">&amp;</span>vertex<span class="token punctuation">.</span>nx
                    <span class="token punctuation">,</span><span class="token operator">&amp;</span>vertex<span class="token punctuation">.</span>ny
                    <span class="token punctuation">,</span><span class="token operator">&amp;</span>vertex<span class="token punctuation">.</span>nz
                    <span class="token punctuation">,</span><span class="token operator">&amp;</span>vertex<span class="token punctuation">.</span>u
                    <span class="token punctuation">,</span><span class="token operator">&amp;</span>vertex<span class="token punctuation">.</span>v
                    <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">updateAabb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/**
        *   解析面信息
        */</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">parseFace</span><span class="token punctuation">(</span> rapidxml<span class="token double-colon punctuation">::</span>xml_node<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span> node <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            rapidxml<span class="token double-colon punctuation">::</span>xml_attribute<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span>  attrType    <span class="token operator">=</span>   node<span class="token operator">-&gt;</span><span class="token function">first_attribute</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rapidxml<span class="token double-colon punctuation">::</span>xml_attribute<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span>  attrCount   <span class="token operator">=</span>   node<span class="token operator">-&gt;</span><span class="token function">first_attribute</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rapidxml<span class="token double-colon punctuation">::</span>xml_attribute<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span> attrTexture <span class="token operator">=</span>    node<span class="token operator">-&gt;</span><span class="token function">first_attribute</span><span class="token punctuation">(</span><span class="token string">"texture"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rapidxml<span class="token double-colon punctuation">::</span>xml_node<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span>       cNode       <span class="token operator">=</span>   node<span class="token operator">-&gt;</span><span class="token function">first_node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>attrType <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> attrCount<span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> cNode    <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> dataCount   <span class="token operator">=</span>   <span class="token function">atoi</span><span class="token punctuation">(</span>attrCount<span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>dataCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>attrTexture<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> pTextureFile <span class="token operator">=</span> attrTexture<span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                QString path <span class="token operator">=</span> <span class="token class-name">QCoreApplication</span><span class="token double-colon punctuation">::</span><span class="token function">applicationDirPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> pTextureFile<span class="token punctuation">;</span>
                _texture <span class="token operator">=</span> <span class="token class-name">CELLTextureMgr</span><span class="token double-colon punctuation">::</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTexture</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">toLocal8Bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            _faces<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>dataCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span> cNode <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> dataCount <span class="token punctuation">;</span> cNode <span class="token operator">=</span> cNode<span class="token operator">-&gt;</span><span class="token function">next_sibling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">++</span> i<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span>     r<span class="token punctuation">,</span>g<span class="token punctuation">,</span>b<span class="token punctuation">;</span>
                Face<span class="token operator">&amp;</span>   face    <span class="token operator">=</span>   _faces<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token function">sscanf</span><span class="token punctuation">(</span>cNode<span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"%d %d %d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>r<span class="token punctuation">,</span><span class="token operator">&amp;</span>g<span class="token punctuation">,</span><span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
                face<span class="token punctuation">.</span>x <span class="token operator">=</span>   <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                face<span class="token punctuation">.</span>y <span class="token operator">=</span>   <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">(</span>g<span class="token punctuation">)</span><span class="token punctuation">;</span>
                face<span class="token punctuation">.</span>z <span class="token operator">=</span>   <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/**
        *   解析绘制的图元组
        */</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">parsePrimitive</span><span class="token punctuation">(</span> rapidxml<span class="token double-colon punctuation">::</span>xml_node<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span> node <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            rapidxml<span class="token double-colon punctuation">::</span>xml_attribute<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span>  attrCount   <span class="token operator">=</span>   node<span class="token operator">-&gt;</span><span class="token function">first_attribute</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            rapidxml<span class="token double-colon punctuation">::</span>xml_node<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span>       cNode       <span class="token operator">=</span>   node<span class="token operator">-&gt;</span><span class="token function">first_node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>attrCount <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> cNode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> priCount    <span class="token operator">=</span>   <span class="token function">atoi</span><span class="token punctuation">(</span>attrCount<span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         
            _primitive<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>priCount<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>cNode<span class="token punctuation">;</span> cNode <span class="token operator">=</span> cNode<span class="token operator">-&gt;</span><span class="token function">next_sibling</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">++</span> i <span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                rapidxml<span class="token double-colon punctuation">::</span>xml_attribute<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span>  attType     <span class="token operator">=</span>   cNode<span class="token operator">-&gt;</span><span class="token function">first_attribute</span><span class="token punctuation">(</span><span class="token string">"type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                rapidxml<span class="token double-colon punctuation">::</span>xml_attribute<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span>  attStart    <span class="token operator">=</span>   cNode<span class="token operator">-&gt;</span><span class="token function">first_attribute</span><span class="token punctuation">(</span><span class="token string">"start"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                rapidxml<span class="token double-colon punctuation">::</span>xml_attribute<span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">*</span>  attCount    <span class="token operator">=</span>   cNode<span class="token operator">-&gt;</span><span class="token function">first_attribute</span><span class="token punctuation">(</span><span class="token string">"count"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>attType <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> attStart <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> attCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                _primitive<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mode  <span class="token operator">=</span>   <span class="token function">atoi</span><span class="token punctuation">(</span>attType<span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                _primitive<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>start <span class="token operator">=</span>   <span class="token function">atoi</span><span class="token punctuation">(</span>attStart<span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                _primitive<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>count <span class="token operator">=</span>   <span class="token function">atoi</span><span class="token punctuation">(</span>attCount<span class="token operator">-&gt;</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      <p>
       这个类的作用是从xml文件读取出顶点数据，纹理坐标数据，纹理路径，顶点索引数据，根据这些信息进行渲染。
      </p>
      <h2>
       <a id="_738">
       </a>
       交互模块
      </h2>
      <p>
       交互模块主要指的是用户操作后鼠标，键盘事件后场景进行对应的操作。
      </p>
      <pre><code class="prism language-cpp">    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">dragEnterEvent</span><span class="token punctuation">(</span>QDragEnterEvent <span class="token operator">*</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">dragMoveEvent</span><span class="token punctuation">(</span>QDragMoveEvent <span class="token operator">*</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">dropEvent</span><span class="token punctuation">(</span>QDropEvent <span class="token operator">*</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
    *   窗口大小变化事件
    */</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">resizeEvent</span><span class="token punctuation">(</span>QResizeEvent <span class="token operator">*</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
    *   鼠标按下
    */</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">mousePressEvent</span><span class="token punctuation">(</span>QMouseEvent<span class="token operator">*</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">mouseReleaseEvent</span><span class="token punctuation">(</span>QMouseEvent<span class="token operator">*</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">mouseDoubleClickEvent</span><span class="token punctuation">(</span>QMouseEvent<span class="token operator">*</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">mouseMoveEvent</span><span class="token punctuation">(</span>QMouseEvent<span class="token operator">*</span>evt<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">wheelEvent</span><span class="token punctuation">(</span>QWheelEvent<span class="token operator">*</span> evt<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      <p>
       首先先说一下实现的摄像机。
      </p>
      <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span>    <span class="token string">"CELLMath.hpp"</span></span>

<span class="token keyword">namespace</span>   CELL
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">class</span> <span class="token class-name">CELLCamera</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        float3      _eye<span class="token punctuation">;</span>
        float3      _up<span class="token punctuation">;</span>
        float3      _right<span class="token punctuation">;</span>
        float3      _target<span class="token punctuation">;</span>
        float3      _dir<span class="token punctuation">;</span>
        matrix4     _matView<span class="token punctuation">;</span>
        matrix4     _matProj<span class="token punctuation">;</span>
        matrix4     _matWorld<span class="token punctuation">;</span>
        float2      _viewSize<span class="token punctuation">;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">CELLCamera</span><span class="token punctuation">(</span><span class="token keyword">const</span> float3<span class="token operator">&amp;</span> target <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">const</span> float3<span class="token operator">&amp;</span> eye <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">const</span> float3<span class="token operator">&amp;</span> right <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _viewSize   <span class="token operator">=</span>   <span class="token function">float2</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _matView    <span class="token operator">=</span>   <span class="token class-name">CELL</span><span class="token double-colon punctuation">::</span><span class="token function">matrix4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _matProj    <span class="token operator">=</span>   <span class="token class-name">CELL</span><span class="token double-colon punctuation">::</span><span class="token function">matrix4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            _matWorld   <span class="token operator">=</span>   <span class="token class-name">CELL</span><span class="token double-colon punctuation">::</span><span class="token function">matrix4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            _target     <span class="token operator">=</span>   target<span class="token punctuation">;</span>
            _eye        <span class="token operator">=</span>   eye<span class="token punctuation">;</span>
            _dir        <span class="token operator">=</span>   <span class="token function">normalize</span><span class="token punctuation">(</span>_target <span class="token operator">-</span> _eye<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _right      <span class="token operator">=</span>   right<span class="token punctuation">;</span>
            _up         <span class="token operator">=</span>   <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>_right<span class="token punctuation">,</span>_dir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">CELLCamera</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        float3 <span class="token function">getEye</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> 
        <span class="token punctuation">{<!-- --></span> 
            <span class="token keyword">return</span> _eye<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/**
        *   设置眼睛的位置
        */</span>
        <span class="token keyword">void</span>    <span class="token function">setEye</span><span class="token punctuation">(</span>CELL<span class="token double-colon punctuation">::</span>float3 val<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span> 
            _eye    <span class="token operator">=</span>   val<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
        
        float3 <span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> 
        <span class="token punctuation">{<!-- --></span> 
            <span class="token keyword">return</span> _target<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span>    <span class="token function">setTarget</span><span class="token punctuation">(</span>CELL<span class="token double-colon punctuation">::</span>float3 val<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span> 
            _target <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span>    <span class="token function">setRight</span><span class="token punctuation">(</span>CELL<span class="token double-colon punctuation">::</span>float3 val<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _right  <span class="token operator">=</span>   val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        float3 <span class="token function">getUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> 
        <span class="token punctuation">{<!-- --></span> 
            <span class="token keyword">return</span> _up<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span>    <span class="token function">setUp</span><span class="token punctuation">(</span>CELL<span class="token double-colon punctuation">::</span>float3 val<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _up <span class="token operator">=</span> val<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        float3  <span class="token function">getDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>  _dir<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        float3  <span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>  _right<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span>    <span class="token function">setViewSize</span><span class="token punctuation">(</span><span class="token keyword">const</span> float2<span class="token operator">&amp;</span> viewSize<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _viewSize   <span class="token operator">=</span>   viewSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span>    <span class="token function">setViewSize</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">,</span><span class="token keyword">float</span> y<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _viewSize   <span class="token operator">=</span>   <span class="token function">float2</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        float2  <span class="token function">getViewSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>  _viewSize<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">void</span>    <span class="token function">setProject</span><span class="token punctuation">(</span><span class="token keyword">const</span> matrix4<span class="token operator">&amp;</span> proj<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _matProj    <span class="token operator">=</span>   proj<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> matrix4<span class="token operator">&amp;</span> <span class="token function">getProject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>  _matProj<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> matrix4<span class="token operator">&amp;</span>  <span class="token function">getView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>  _matView<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
        *   正交投影
        */</span>
        <span class="token keyword">void</span>    <span class="token function">ortho</span><span class="token punctuation">(</span> <span class="token keyword">float</span> left<span class="token punctuation">,</span> <span class="token keyword">float</span> right<span class="token punctuation">,</span> <span class="token keyword">float</span> bottom<span class="token punctuation">,</span> <span class="token keyword">float</span> top<span class="token punctuation">,</span> <span class="token keyword">float</span> zNear<span class="token punctuation">,</span> <span class="token keyword">float</span> zFar <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _matProj    <span class="token operator">=</span>   <span class="token class-name">CELL</span><span class="token double-colon punctuation">::</span><span class="token function">ortho</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span>right<span class="token punctuation">,</span>bottom<span class="token punctuation">,</span>top<span class="token punctuation">,</span>zNear<span class="token punctuation">,</span>zFar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/**
        *   透视投影
        */</span>
        <span class="token keyword">void</span>    <span class="token function">perspective</span><span class="token punctuation">(</span><span class="token keyword">float</span> fovy<span class="token punctuation">,</span> <span class="token keyword">float</span> aspect<span class="token punctuation">,</span> <span class="token keyword">float</span> zNear<span class="token punctuation">,</span> <span class="token keyword">float</span> zFar<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _matProj    <span class="token operator">=</span>   CELL<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">perspective</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>fovy<span class="token punctuation">,</span>aspect<span class="token punctuation">,</span>zNear<span class="token punctuation">,</span>zFar<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

         <span class="token comment">/**
        *   世界坐标转化为窗口坐标
        */</span>
        <span class="token keyword">bool</span>    <span class="token function">project</span><span class="token punctuation">(</span> <span class="token keyword">const</span> float4<span class="token operator">&amp;</span> world<span class="token punctuation">,</span> float4<span class="token operator">&amp;</span> screen <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            screen  <span class="token operator">=</span>   <span class="token punctuation">(</span>_matProj <span class="token operator">*</span> _matView <span class="token operator">*</span> _matWorld<span class="token punctuation">)</span> <span class="token operator">*</span> world<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>screen<span class="token punctuation">.</span>w <span class="token operator">==</span> <span class="token number">0.0f</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            screen<span class="token punctuation">.</span>x    <span class="token operator">/=</span>  screen<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
            screen<span class="token punctuation">.</span>y    <span class="token operator">/=</span>  screen<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
            screen<span class="token punctuation">.</span>z    <span class="token operator">/=</span>  screen<span class="token punctuation">.</span>w<span class="token punctuation">;</span>

            <span class="token comment">// map to range 0 - 1</span>
            screen<span class="token punctuation">.</span>x    <span class="token operator">=</span>   screen<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">0.5f</span> <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
            screen<span class="token punctuation">.</span>y    <span class="token operator">=</span>   screen<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">0.5f</span> <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>
            screen<span class="token punctuation">.</span>z    <span class="token operator">=</span>   screen<span class="token punctuation">.</span>z <span class="token operator">*</span> <span class="token number">0.5f</span> <span class="token operator">+</span> <span class="token number">0.5f</span><span class="token punctuation">;</span>

            <span class="token comment">// map to viewport</span>
            screen<span class="token punctuation">.</span>x    <span class="token operator">=</span>   screen<span class="token punctuation">.</span>x <span class="token operator">*</span> _viewSize<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
            screen<span class="token punctuation">.</span>y    <span class="token operator">=</span>   _viewSize<span class="token punctuation">.</span>y <span class="token operator">-</span> <span class="token punctuation">(</span>screen<span class="token punctuation">.</span>y <span class="token operator">*</span> _viewSize<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span>  <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">/**
        *   世界坐标转化为窗口坐标
        */</span>
        float2  <span class="token function">worldToScreen</span><span class="token punctuation">(</span> <span class="token keyword">const</span> float3<span class="token operator">&amp;</span> world<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            float4  <span class="token function">worlds</span><span class="token punctuation">(</span>world<span class="token punctuation">.</span>x<span class="token punctuation">,</span>world<span class="token punctuation">.</span>y<span class="token punctuation">,</span>world<span class="token punctuation">.</span>z<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            float4  screens<span class="token punctuation">;</span>
            <span class="token function">project</span><span class="token punctuation">(</span>worlds<span class="token punctuation">,</span>screens<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span>  <span class="token function">float2</span><span class="token punctuation">(</span>screens<span class="token punctuation">.</span>x<span class="token punctuation">,</span>screens<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
        *   窗口坐标转化为世界坐标
        */</span>
        float3  <span class="token function">screenToWorld</span><span class="token punctuation">(</span><span class="token keyword">const</span> float2<span class="token operator">&amp;</span> screen<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            float4  <span class="token function">screens</span><span class="token punctuation">(</span>screen<span class="token punctuation">.</span>x<span class="token punctuation">,</span>screen<span class="token punctuation">.</span>y<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            float4  world<span class="token punctuation">;</span>
            <span class="token function">unProject</span><span class="token punctuation">(</span>screens<span class="token punctuation">,</span>world<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span>  <span class="token function">float3</span><span class="token punctuation">(</span>world<span class="token punctuation">.</span>x<span class="token punctuation">,</span>world<span class="token punctuation">.</span>y<span class="token punctuation">,</span>world<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        float3  <span class="token function">screenToWorld</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">,</span><span class="token keyword">float</span> y<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            float4  <span class="token function">screens</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            float4  world<span class="token punctuation">;</span>
            <span class="token function">unProject</span><span class="token punctuation">(</span>screens<span class="token punctuation">,</span>world<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span>  <span class="token function">float3</span><span class="token punctuation">(</span>world<span class="token punctuation">.</span>x<span class="token punctuation">,</span>world<span class="token punctuation">.</span>y<span class="token punctuation">,</span>world<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">/**
        *   窗口坐标转化为世界坐标
        */</span>
        <span class="token keyword">bool</span>    <span class="token function">unProject</span><span class="token punctuation">(</span> <span class="token keyword">const</span> float4<span class="token operator">&amp;</span> screen<span class="token punctuation">,</span> float4<span class="token operator">&amp;</span> world <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            float4 v<span class="token punctuation">;</span>
            v<span class="token punctuation">.</span>x <span class="token operator">=</span>   screen<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
            v<span class="token punctuation">.</span>y <span class="token operator">=</span>   screen<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            v<span class="token punctuation">.</span>z <span class="token operator">=</span>   screen<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
            v<span class="token punctuation">.</span>w <span class="token operator">=</span>   <span class="token number">1.0</span><span class="token punctuation">;</span>

            <span class="token comment">// map from viewport to 0 - 1</span>
            v<span class="token punctuation">.</span>x <span class="token operator">=</span>   <span class="token punctuation">(</span>v<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">/</span>_viewSize<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
            v<span class="token punctuation">.</span>y <span class="token operator">=</span>   <span class="token punctuation">(</span>_viewSize<span class="token punctuation">.</span>y <span class="token operator">-</span> v<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token operator">/</span>_viewSize<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
            <span class="token comment">//v.y = (v.y - _viewPort.Y) / _viewPort.Height;</span>

            <span class="token comment">// map to range -1 to 1</span>
            v<span class="token punctuation">.</span>x <span class="token operator">=</span>   v<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">2.0f</span> <span class="token operator">-</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>
            v<span class="token punctuation">.</span>y <span class="token operator">=</span>   v<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">2.0f</span> <span class="token operator">-</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>
            v<span class="token punctuation">.</span>z <span class="token operator">=</span>   v<span class="token punctuation">.</span>z <span class="token operator">*</span> <span class="token number">2.0f</span> <span class="token operator">-</span> <span class="token number">1.0f</span><span class="token punctuation">;</span>

            CELL<span class="token double-colon punctuation">::</span>matrix4  inverse <span class="token operator">=</span> <span class="token punctuation">(</span>_matProj <span class="token operator">*</span> _matView <span class="token operator">*</span> _matWorld<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            v   <span class="token operator">=</span>   v <span class="token operator">*</span> inverse<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span>w <span class="token operator">==</span> <span class="token number">0.0f</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            world   <span class="token operator">=</span>   v <span class="token operator">/</span> v<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Ray <span class="token function">createRayFromScreen</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span><span class="token keyword">int</span> y<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            float4  minWorld<span class="token punctuation">;</span>
            float4  maxWorld<span class="token punctuation">;</span>

            float4  <span class="token function">screen</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">float</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            float4  <span class="token function">screen1</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">float</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">unProject</span><span class="token punctuation">(</span>screen<span class="token punctuation">,</span>minWorld<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">unProject</span><span class="token punctuation">(</span>screen1<span class="token punctuation">,</span>maxWorld<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Ray     ray<span class="token punctuation">;</span>
            ray<span class="token punctuation">.</span><span class="token function">setOrigin</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>minWorld<span class="token punctuation">.</span>x<span class="token punctuation">,</span>minWorld<span class="token punctuation">.</span>y<span class="token punctuation">,</span>minWorld<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            float3  <span class="token function">dir</span><span class="token punctuation">(</span>maxWorld<span class="token punctuation">.</span>x <span class="token operator">-</span> minWorld<span class="token punctuation">.</span>x<span class="token punctuation">,</span>maxWorld<span class="token punctuation">.</span>y <span class="token operator">-</span> minWorld<span class="token punctuation">.</span>y<span class="token punctuation">,</span> maxWorld<span class="token punctuation">.</span>z <span class="token operator">-</span> minWorld<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ray<span class="token punctuation">.</span><span class="token function">setDirection</span><span class="token punctuation">(</span><span class="token function">normalize</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span>  ray<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/**
        *   下面的函数的功能是将摄像机的观察方向绕某个方向轴旋转一定的角度 
        *   改变观察者的位置，目标的位置不变化
        */</span>
        <span class="token keyword">virtual</span> <span class="token keyword">void</span>    <span class="token function">rotateViewY</span><span class="token punctuation">(</span><span class="token keyword">float</span> angle<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span> 
            _dir        <span class="token operator">=</span>   <span class="token generic-function"><span class="token function">rotateY</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_dir<span class="token punctuation">,</span>    angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _up         <span class="token operator">=</span>   <span class="token generic-function"><span class="token function">rotateY</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_up<span class="token punctuation">,</span>     angle<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _right      <span class="token operator">=</span>   <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>_dir<span class="token punctuation">,</span>_up<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">float</span>   len <span class="token operator">=</span>   <span class="token function">length</span><span class="token punctuation">(</span>_eye <span class="token operator">-</span> _target<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _eye        <span class="token operator">=</span>   _target <span class="token operator">-</span> _dir <span class="token operator">*</span> len<span class="token punctuation">;</span>
            _matView    <span class="token operator">=</span>   <span class="token class-name">CELL</span><span class="token double-colon punctuation">::</span><span class="token function">lookAt</span><span class="token punctuation">(</span>_eye<span class="token punctuation">,</span>_target<span class="token punctuation">,</span>_up<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">virtual</span> <span class="token keyword">void</span>    <span class="token function">rotateViewX</span><span class="token punctuation">(</span><span class="token keyword">float</span> angle<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span> 
            matrix4 <span class="token function">mat</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
            mat<span class="token punctuation">.</span><span class="token function">rotate</span><span class="token punctuation">(</span>angle<span class="token punctuation">,</span>_right<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _dir        <span class="token operator">=</span>   _dir <span class="token operator">*</span> mat<span class="token punctuation">;</span>
            _up         <span class="token operator">=</span>   _up <span class="token operator">*</span> mat<span class="token punctuation">;</span>
            _right      <span class="token operator">=</span>   <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">cross</span><span class="token punctuation">(</span>_dir<span class="token punctuation">,</span>_up<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">float</span>   len <span class="token operator">=</span>   <span class="token function">length</span><span class="token punctuation">(</span>_eye <span class="token operator">-</span> _target<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _eye        <span class="token operator">=</span>   _target <span class="token operator">-</span> _dir <span class="token operator">*</span> len<span class="token punctuation">;</span>
            _matView    <span class="token operator">=</span>   <span class="token class-name">CELL</span><span class="token double-colon punctuation">::</span><span class="token function">lookAt</span><span class="token punctuation">(</span>_eye<span class="token punctuation">,</span>_target<span class="token punctuation">,</span>_up<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">virtual</span> <span class="token keyword">void</span>    <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _matView    <span class="token operator">=</span>   <span class="token class-name">CELL</span><span class="token double-colon punctuation">::</span><span class="token function">lookAt</span><span class="token punctuation">(</span>_eye<span class="token punctuation">,</span>_target<span class="token punctuation">,</span>_up<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      <p>
       这是摄像机的代码，其中定义了一些摄像机的基本信息，包括，眼睛的位置，视点位置，向上的向量，由这三个元素就可以确定一个摄像机的坐标系，里面还将投影矩阵进行维护。
       <br/>
       下面说一下用户操作鼠标后模型是怎么进行变动的。首先是鼠标按下事件。
      </p>
      <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">OGLWidget</span><span class="token double-colon punctuation">::</span><span class="token function">mousePressEvent</span><span class="token punctuation">(</span> QMouseEvent<span class="token operator">*</span>evt <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">button</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> Qt<span class="token double-colon punctuation">::</span>LeftButton<span class="token operator">:</span>
        <span class="token punctuation">{<!-- --></span>
            _leftBtnFlag    <span class="token operator">=</span>   <span class="token boolean">true</span><span class="token punctuation">;</span>
            _mousePos       <span class="token operator">=</span>   <span class="token function">QPoint</span><span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>evt<span class="token operator">-&gt;</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>_optionMode <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                m_pickObj <span class="token operator">=</span> <span class="token function">pickNode</span><span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evt<span class="token operator">-&gt;</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> Qt<span class="token double-colon punctuation">::</span>RightButton<span class="token operator">:</span>
        <span class="token punctuation">{<!-- --></span>
            _rightBtnFlag   <span class="token operator">=</span>   <span class="token boolean">true</span><span class="token punctuation">;</span>
            _mousePos       <span class="token operator">=</span>   <span class="token function">QPoint</span><span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>evt<span class="token operator">-&gt;</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> Qt<span class="token double-colon punctuation">::</span>MidButton<span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      <p>
       这里面分为鼠标左击和鼠标右击，鼠标左击主要是用于控制场景的移动，鼠标的右击用于控制场景的旋转，左击的_optionMode是用于控制是移动模型还是移动场景的标志位，由于需要在移动的时候知道是左键按下的还是右键按下的，所以需要有一个标志位来进行判断。
       <br/>
       鼠标释放事件
      </p>
      <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">OGLWidget</span><span class="token double-colon punctuation">::</span><span class="token function">mouseReleaseEvent</span><span class="token punctuation">(</span> QMouseEvent<span class="token operator">*</span>evt <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">button</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> Qt<span class="token double-colon punctuation">::</span>LeftButton<span class="token operator">:</span>
        <span class="token punctuation">{<!-- --></span>
            _leftBtnFlag    <span class="token operator">=</span>   <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> Qt<span class="token double-colon punctuation">::</span>RightButton<span class="token operator">:</span>
        <span class="token punctuation">{<!-- --></span>
            _rightBtnFlag   <span class="token operator">=</span>   <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> Qt<span class="token double-colon punctuation">::</span>MidButton<span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      <p>
       用于取消标志位，说明用户已经不进行操作场景。
       <br/>
       鼠标移动事件
      </p>
      <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">OGLWidget</span><span class="token double-colon punctuation">::</span><span class="token function">mouseMoveEvent</span><span class="token punctuation">(</span> QMouseEvent<span class="token operator">*</span>evt <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_leftBtnFlag<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_optionMode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            CELL<span class="token double-colon punctuation">::</span>Ray       ray0 <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">createRayFromScreen</span><span class="token punctuation">(</span>_mousePos<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _mousePos<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            CELL<span class="token double-colon punctuation">::</span>Ray       ray1 <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">createRayFromScreen</span><span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evt<span class="token operator">-&gt;</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            CELL<span class="token double-colon punctuation">::</span>float3    pos1 <span class="token operator">=</span> <span class="token function">calcIntersectPoint</span><span class="token punctuation">(</span>ray0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            CELL<span class="token double-colon punctuation">::</span>float3    pos2 <span class="token operator">=</span> <span class="token function">calcIntersectPoint</span><span class="token punctuation">(</span>ray1<span class="token punctuation">)</span><span class="token punctuation">;</span>

            _mousePos <span class="token operator">=</span> <span class="token function">QPoint</span><span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evt<span class="token operator">-&gt;</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            CELL<span class="token double-colon punctuation">::</span>float3    offset <span class="token operator">=</span> pos1 <span class="token operator">-</span> pos2<span class="token punctuation">;</span>

            CELL<span class="token double-colon punctuation">::</span>float3    newEye <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">getEye</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">;</span>
            CELL<span class="token double-colon punctuation">::</span>float3    newTgt <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">;</span>

            _camera<span class="token punctuation">.</span><span class="token function">setEye</span><span class="token punctuation">(</span>newEye<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _camera<span class="token punctuation">.</span><span class="token function">setTarget</span><span class="token punctuation">(</span>newTgt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _camera<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_optionMode <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>m_pickObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                CELL<span class="token double-colon punctuation">::</span>Ray       ray0 <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">createRayFromScreen</span><span class="token punctuation">(</span>_mousePos<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _mousePos<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                CELL<span class="token double-colon punctuation">::</span>Ray       ray1 <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">createRayFromScreen</span><span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evt<span class="token operator">-&gt;</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                CELL<span class="token double-colon punctuation">::</span>float3    pos1 <span class="token operator">=</span> <span class="token function">calcIntersectPoint</span><span class="token punctuation">(</span>ray0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                CELL<span class="token double-colon punctuation">::</span>float3    pos2 <span class="token operator">=</span> <span class="token function">calcIntersectPoint</span><span class="token punctuation">(</span>ray1<span class="token punctuation">)</span><span class="token punctuation">;</span>

                _mousePos <span class="token operator">=</span> <span class="token function">QPoint</span><span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evt<span class="token operator">-&gt;</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                CELL<span class="token double-colon punctuation">::</span>float3    offset <span class="token operator">=</span> pos2 <span class="token operator">-</span> pos1<span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span>iterator itr <span class="token operator">=</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> itr <span class="token operator">!=</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>itr<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token operator">*</span>itr<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-&gt;</span><span class="token function">hasFlag</span><span class="token punctuation">(</span>CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token double-colon punctuation">::</span>FLAG_SELECT<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>

                        node<span class="token operator">-&gt;</span><span class="token function">setTranslation</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span><span class="token function">getTrans</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                CELL<span class="token double-colon punctuation">::</span>Ray       ray0 <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">createRayFromScreen</span><span class="token punctuation">(</span>_mousePos<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _mousePos<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                CELL<span class="token double-colon punctuation">::</span>Ray       ray1 <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">createRayFromScreen</span><span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evt<span class="token operator">-&gt;</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                CELL<span class="token double-colon punctuation">::</span>float3    pos1 <span class="token operator">=</span> <span class="token function">calcIntersectPoint</span><span class="token punctuation">(</span>ray0<span class="token punctuation">)</span><span class="token punctuation">;</span>
                CELL<span class="token double-colon punctuation">::</span>float3    pos2 <span class="token operator">=</span> <span class="token function">calcIntersectPoint</span><span class="token punctuation">(</span>ray1<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">float</span>   xMin <span class="token operator">=</span> CELL<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">tmin</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>pos1<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pos2<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span>   xMax <span class="token operator">=</span> CELL<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">tmax</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>pos1<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pos2<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">float</span>   zMin <span class="token operator">=</span> CELL<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">tmin</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>pos1<span class="token punctuation">.</span>z<span class="token punctuation">,</span> pos2<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span>   zMax <span class="token operator">=</span> CELL<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">tmax</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>pos1<span class="token punctuation">.</span>z<span class="token punctuation">,</span> pos2<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">float</span>   yMin <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span>   yMax <span class="token operator">=</span> <span class="token number">9999999</span><span class="token punctuation">;</span>

                CELL<span class="token double-colon punctuation">::</span>aabb3d    aabbMouse<span class="token punctuation">;</span>
                aabbMouse<span class="token punctuation">.</span><span class="token function">setExtents</span><span class="token punctuation">(</span>xMin<span class="token punctuation">,</span> yMin<span class="token punctuation">,</span> zMin<span class="token punctuation">,</span> xMax<span class="token punctuation">,</span> yMax<span class="token punctuation">,</span> zMax<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span>iterator itr <span class="token operator">=</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> itr <span class="token operator">!=</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>itr<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token operator">*</span>itr<span class="token punctuation">;</span>
                    CELL<span class="token double-colon punctuation">::</span>aabb3d    aabb <span class="token operator">=</span> node<span class="token operator">-&gt;</span><span class="token function">getAabb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    aabb<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span><span class="token function">getLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>aabbMouse<span class="token punctuation">.</span><span class="token function">intersects</span><span class="token punctuation">(</span>aabb<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        node<span class="token operator">-&gt;</span><span class="token function">setFlag</span><span class="token punctuation">(</span>CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token double-colon punctuation">::</span>FLAG_SELECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">else</span>
                    <span class="token punctuation">{<!-- --></span>
                        node<span class="token operator">-&gt;</span><span class="token function">removeFlag</span><span class="token punctuation">(</span>CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token double-colon punctuation">::</span>FLAG_SELECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>_rightBtnFlag<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        QPoint  ptCur       <span class="token operator">=</span>   <span class="token function">QPoint</span><span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>evt<span class="token operator">-&gt;</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        QPoint  offset      <span class="token operator">=</span>   ptCur <span class="token operator">-</span> _mousePos<span class="token punctuation">;</span>
                _mousePos   <span class="token operator">=</span>   ptCur<span class="token punctuation">;</span>
        _camera<span class="token punctuation">.</span><span class="token function">rotateViewY</span><span class="token punctuation">(</span>offset<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.3f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _camera<span class="token punctuation">.</span><span class="token function">rotateViewX</span><span class="token punctuation">(</span>offset<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.3f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
      <p>
       先介绍一下鼠标右键移动的事件，主要是根据鼠标移动的位置，重新计算摄像机的摄像机矩阵，核心的思想就是保持观察者的位置不变，然后重新计算视点向量和向上的向量，再根据_eye = _target - _dir * len;计算出观察者的位置再重新计算摄像机矩阵后即可。
       <br/>
       然后是鼠标左击事件，这里需要分为两部分来说，首先是移动场景的部分
      </p>
      <pre><code class="prism language-cpp">        <span class="token keyword">if</span> <span class="token punctuation">(</span>_optionMode <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            CELL<span class="token double-colon punctuation">::</span>Ray       ray0 <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">createRayFromScreen</span><span class="token punctuation">(</span>_mousePos<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _mousePos<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            CELL<span class="token double-colon punctuation">::</span>Ray       ray1 <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">createRayFromScreen</span><span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evt<span class="token operator">-&gt;</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            CELL<span class="token double-colon punctuation">::</span>float3    pos1 <span class="token operator">=</span> <span class="token function">calcIntersectPoint</span><span class="token punctuation">(</span>ray0<span class="token punctuation">)</span><span class="token punctuation">;</span>
            CELL<span class="token double-colon punctuation">::</span>float3    pos2 <span class="token operator">=</span> <span class="token function">calcIntersectPoint</span><span class="token punctuation">(</span>ray1<span class="token punctuation">)</span><span class="token punctuation">;</span>

            _mousePos <span class="token operator">=</span> <span class="token function">QPoint</span><span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evt<span class="token operator">-&gt;</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            CELL<span class="token double-colon punctuation">::</span>float3    offset <span class="token operator">=</span> pos1 <span class="token operator">-</span> pos2<span class="token punctuation">;</span>

            CELL<span class="token double-colon punctuation">::</span>float3    newEye <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">getEye</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">;</span>
            CELL<span class="token double-colon punctuation">::</span>float3    newTgt <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">;</span>

            _camera<span class="token punctuation">.</span><span class="token function">setEye</span><span class="token punctuation">(</span>newEye<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _camera<span class="token punctuation">.</span><span class="token function">setTarget</span><span class="token punctuation">(</span>newTgt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            _camera<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre>
      <p>
       这里是通过射线求交的方式计算出与模型的交点后，根据上一次的交点和这一次的交点计算出一个偏移量后，重新计算摄像机的视点位置和摄像机的位置更新到摄像机中即可。
       <br/>
       还有一种是根据鼠标左键移动模型
      </p>
      <pre><code class="prism language-cpp"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>_optionMode <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>m_pickObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        CELL<span class="token double-colon punctuation">::</span>Ray       ray0 <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">createRayFromScreen</span><span class="token punctuation">(</span>_mousePos<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _mousePos<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        CELL<span class="token double-colon punctuation">::</span>Ray       ray1 <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">createRayFromScreen</span><span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evt<span class="token operator">-&gt;</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        CELL<span class="token double-colon punctuation">::</span>float3    pos1 <span class="token operator">=</span> <span class="token function">calcIntersectPoint</span><span class="token punctuation">(</span>ray0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        CELL<span class="token double-colon punctuation">::</span>float3    pos2 <span class="token operator">=</span> <span class="token function">calcIntersectPoint</span><span class="token punctuation">(</span>ray1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        _mousePos <span class="token operator">=</span> <span class="token function">QPoint</span><span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evt<span class="token operator">-&gt;</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        CELL<span class="token double-colon punctuation">::</span>float3    offset <span class="token operator">=</span> pos2 <span class="token operator">-</span> pos1<span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>iterator itr <span class="token operator">=</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> itr <span class="token operator">!=</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>itr<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token operator">*</span>itr<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token operator">-&gt;</span><span class="token function">hasFlag</span><span class="token punctuation">(</span>CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token double-colon punctuation">::</span>FLAG_SELECT<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>

                node<span class="token operator">-&gt;</span><span class="token function">setTranslation</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span><span class="token function">getTrans</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        CELL<span class="token double-colon punctuation">::</span>Ray       ray0 <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">createRayFromScreen</span><span class="token punctuation">(</span>_mousePos<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> _mousePos<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        CELL<span class="token double-colon punctuation">::</span>Ray       ray1 <span class="token operator">=</span> _camera<span class="token punctuation">.</span><span class="token function">createRayFromScreen</span><span class="token punctuation">(</span>evt<span class="token operator">-&gt;</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evt<span class="token operator">-&gt;</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        CELL<span class="token double-colon punctuation">::</span>float3    pos1 <span class="token operator">=</span> <span class="token function">calcIntersectPoint</span><span class="token punctuation">(</span>ray0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        CELL<span class="token double-colon punctuation">::</span>float3    pos2 <span class="token operator">=</span> <span class="token function">calcIntersectPoint</span><span class="token punctuation">(</span>ray1<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">float</span>   xMin <span class="token operator">=</span> CELL<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">tmin</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>pos1<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pos2<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span>   xMax <span class="token operator">=</span> CELL<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">tmax</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>pos1<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pos2<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">float</span>   zMin <span class="token operator">=</span> CELL<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">tmin</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>pos1<span class="token punctuation">.</span>z<span class="token punctuation">,</span> pos2<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span>   zMax <span class="token operator">=</span> CELL<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">tmax</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>pos1<span class="token punctuation">.</span>z<span class="token punctuation">,</span> pos2<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">float</span>   yMin <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span>   yMax <span class="token operator">=</span> <span class="token number">9999999</span><span class="token punctuation">;</span>

        CELL<span class="token double-colon punctuation">::</span>aabb3d    aabbMouse<span class="token punctuation">;</span>
        aabbMouse<span class="token punctuation">.</span><span class="token function">setExtents</span><span class="token punctuation">(</span>xMin<span class="token punctuation">,</span> yMin<span class="token punctuation">,</span> zMin<span class="token punctuation">,</span> xMax<span class="token punctuation">,</span> yMax<span class="token punctuation">,</span> zMax<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>iterator itr <span class="token operator">=</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> itr <span class="token operator">!=</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>itr<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token operator">*</span>itr<span class="token punctuation">;</span>
            CELL<span class="token double-colon punctuation">::</span>aabb3d    aabb <span class="token operator">=</span> node<span class="token operator">-&gt;</span><span class="token function">getAabb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            aabb<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>node<span class="token operator">-&gt;</span><span class="token function">getLocal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>aabbMouse<span class="token punctuation">.</span><span class="token function">intersects</span><span class="token punctuation">(</span>aabb<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                node<span class="token operator">-&gt;</span><span class="token function">setFlag</span><span class="token punctuation">(</span>CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token double-colon punctuation">::</span>FLAG_SELECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                node<span class="token operator">-&gt;</span><span class="token function">removeFlag</span><span class="token punctuation">(</span>CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token double-colon punctuation">::</span>FLAG_SELECT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
      <p>
       这里也分为两个情况，如果这次点击的位置没有拾取到模型的话，就说明用户想要绘制一个区域来选中模型（目前没有实现绘制区域的矩形），根据这两个点生成一个包围盒，根据这个包围盒遍历所有的节点进行求交，有交点的话就将模型的标志位增加选中状态，如果拾取到模型的话就遍历节点如果是有选中状态的话就移动模型。
       <br/>
       改变窗口大小事件
      </p>
      <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">OGLWidget</span><span class="token double-colon punctuation">::</span><span class="token function">resizeEvent</span><span class="token punctuation">(</span> QResizeEvent <span class="token operator">*</span>evt <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">glViewport</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/没有写这个导致的问题</span>
    _camera<span class="token punctuation">.</span><span class="token function">setViewSize</span><span class="token punctuation">(</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _camera<span class="token punctuation">.</span><span class="token function">perspective</span><span class="token punctuation">(</span><span class="token number">60.0f</span><span class="token punctuation">,</span><span class="token keyword">float</span><span class="token punctuation">(</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">float</span><span class="token punctuation">(</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0.1f</span><span class="token punctuation">,</span><span class="token number">10000.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      <p>
       就是改变视口的大小和摄像机的投影矩阵就行。
      </p>
      <h2>
       <a id="_1287">
       </a>
       联动模块
      </h2>
      <p>
       这个模块主要是要实现，当模型拖入场景后左侧下方的树需要增加模型的列表，还有当点击左侧下方的树后需要在右侧显示对应模型的属性。
      </p>
      <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">OGLWidget</span><span class="token double-colon punctuation">::</span><span class="token function">dropEvent</span><span class="token punctuation">(</span> QDropEvent <span class="token operator">*</span>evt <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_frameWindow <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    QString     strFileName<span class="token punctuation">;</span>
    QByteArray  data    <span class="token operator">=</span>   evt<span class="token operator">-&gt;</span><span class="token function">mimeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token string">"image/x-puzzle-piece"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QDataStream <span class="token function">dataStream</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>data<span class="token punctuation">,</span> QIODevice<span class="token double-colon punctuation">::</span>ReadOnly<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
    dataStream <span class="token operator">&gt;&gt;</span> strFileName<span class="token punctuation">;</span>

    <span class="token keyword">int</span> iCnt <span class="token operator">=</span> _frameWindow<span class="token operator">-&gt;</span><span class="token function">getTreeWidget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">topLevelItemCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QTreeWidgetItem<span class="token operator">*</span> pFind <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    QTreeWidgetItem<span class="token operator">*</span> pItem <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> iCnt<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        QTreeWidgetItem<span class="token operator">*</span> pTop <span class="token operator">=</span> _frameWindow<span class="token operator">-&gt;</span><span class="token function">getTreeWidget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">topLevelItem</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        QString             text <span class="token operator">=</span> pTop<span class="token operator">-&gt;</span><span class="token function">text</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>text <span class="token operator">==</span> strFileName<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            pFind <span class="token operator">=</span> pTop<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token operator">*</span> node <span class="token operator">=</span> <span class="token function">createNode</span><span class="token punctuation">(</span>strFileName<span class="token punctuation">.</span><span class="token function">toStdString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evt<span class="token operator">-&gt;</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> evt<span class="token operator">-&gt;</span><span class="token function">pos</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>node <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pFind<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        pItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QTreeWidgetItem</span><span class="token punctuation">(</span>pFind<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pItem<span class="token operator">-&gt;</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Qt<span class="token double-colon punctuation">::</span>UserRole<span class="token punctuation">,</span> <span class="token function">QVariant</span><span class="token punctuation">(</span><span class="token punctuation">(</span>qlonglong<span class="token punctuation">)</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pItem<span class="token operator">-&gt;</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> node<span class="token operator">-&gt;</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        pFind <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QTreeWidgetItem</span><span class="token punctuation">(</span>_frameWindow<span class="token operator">-&gt;</span><span class="token function">getTreeWidget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pFind<span class="token operator">-&gt;</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> strFileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pItem <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">QTreeWidgetItem</span><span class="token punctuation">(</span>pFind<span class="token punctuation">)</span><span class="token punctuation">;</span>
        pItem<span class="token operator">-&gt;</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Qt<span class="token double-colon punctuation">::</span>UserRole<span class="token punctuation">,</span> <span class="token function">QVariant</span><span class="token punctuation">(</span><span class="token punctuation">(</span>qlonglong<span class="token punctuation">)</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pItem<span class="token operator">-&gt;</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> node<span class="token operator">-&gt;</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    evt<span class="token operator">-&gt;</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      <pre><code class="prism language-cpp"><span class="token comment">/// 模型列表槽函数处理过程</span>
<span class="token keyword">void</span> <span class="token class-name">GameDesigner</span><span class="token double-colon punctuation">::</span><span class="token function">slotItemChanged</span><span class="token punctuation">(</span>QListWidgetItem<span class="token operator">*</span> item<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QString file <span class="token operator">=</span> item<span class="token operator">-&gt;</span><span class="token function">data</span><span class="token punctuation">(</span>Qt<span class="token double-colon punctuation">::</span>UserRole <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QtVariantProperty<span class="token operator">*</span> prop <span class="token operator">=</span> _pModelAttrMgr<span class="token operator">-&gt;</span><span class="token function">addProperty</span><span class="token punctuation">(</span>QVariant<span class="token double-colon punctuation">::</span>String<span class="token punctuation">,</span> <span class="token string">"FileName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    prop<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ui<span class="token punctuation">.</span>_propertyTree<span class="token operator">-&gt;</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ui<span class="token punctuation">.</span>_propertyTree<span class="token operator">-&gt;</span><span class="token function">addProperty</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/// 场景树模型槽处理函数 </span>
<span class="token keyword">void</span> <span class="token class-name">GameDesigner</span><span class="token double-colon punctuation">::</span><span class="token function">slotitemClicked</span><span class="token punctuation">(</span>QTreeWidgetItem<span class="token operator">*</span> item<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token operator">*</span> pNode <span class="token operator">=</span> <span class="token punctuation">(</span>CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token operator">*</span><span class="token punctuation">)</span>item<span class="token operator">-&gt;</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> Qt<span class="token double-colon punctuation">::</span>UserRole<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLongLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pNode <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ui<span class="token punctuation">.</span>_propertyTree<span class="token operator">-&gt;</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        ui<span class="token punctuation">.</span>_renderWidget<span class="token operator">-&gt;</span><span class="token function">resetSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pNode<span class="token operator">-&gt;</span><span class="token function">setFlag</span><span class="token punctuation">(</span>CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token double-colon punctuation">::</span>FLAG_SELECT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        QtVariantProperty<span class="token operator">*</span> trans <span class="token operator">=</span> _pModelAttrMgr<span class="token operator">-&gt;</span><span class="token function">addProperty</span><span class="token punctuation">(</span>QVariant<span class="token double-colon punctuation">::</span>String<span class="token punctuation">,</span> <span class="token string">"Pos"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        QtVariantProperty<span class="token operator">*</span> transX <span class="token operator">=</span> _pModelAttrMgr<span class="token operator">-&gt;</span><span class="token function">addProperty</span><span class="token punctuation">(</span>QVariant<span class="token double-colon punctuation">::</span>Double<span class="token punctuation">,</span> <span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        QtVariantProperty<span class="token operator">*</span> transY <span class="token operator">=</span> _pModelAttrMgr<span class="token operator">-&gt;</span><span class="token function">addProperty</span><span class="token punctuation">(</span>QVariant<span class="token double-colon punctuation">::</span>Double<span class="token punctuation">,</span> <span class="token string">"y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        QtVariantProperty<span class="token operator">*</span> transZ <span class="token operator">=</span> _pModelAttrMgr<span class="token operator">-&gt;</span><span class="token function">addProperty</span><span class="token punctuation">(</span>QVariant<span class="token double-colon punctuation">::</span>Double<span class="token punctuation">,</span> <span class="token string">"z"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        trans<span class="token operator">-&gt;</span><span class="token function">addSubProperty</span><span class="token punctuation">(</span>transX<span class="token punctuation">)</span><span class="token punctuation">;</span>
        trans<span class="token operator">-&gt;</span><span class="token function">addSubProperty</span><span class="token punctuation">(</span>transY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        trans<span class="token operator">-&gt;</span><span class="token function">addSubProperty</span><span class="token punctuation">(</span>transZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
        transX<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span>pNode<span class="token operator">-&gt;</span><span class="token function">getTrans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        transY<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span>pNode<span class="token operator">-&gt;</span><span class="token function">getTrans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        transZ<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span>pNode<span class="token operator">-&gt;</span><span class="token function">getTrans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>

        transX<span class="token operator">-&gt;</span><span class="token function">setUserData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>pNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        transY<span class="token operator">-&gt;</span><span class="token function">setUserData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>pNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        transZ<span class="token operator">-&gt;</span><span class="token function">setUserData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>pNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        transX<span class="token operator">-&gt;</span><span class="token function">setUserData1</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>AttributeNodeType<span class="token double-colon punctuation">::</span>ANT_POS_X<span class="token punctuation">)</span><span class="token punctuation">;</span>
        transY<span class="token operator">-&gt;</span><span class="token function">setUserData1</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>AttributeNodeType<span class="token double-colon punctuation">::</span>ANT_POS_Y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        transZ<span class="token operator">-&gt;</span><span class="token function">setUserData1</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>AttributeNodeType<span class="token double-colon punctuation">::</span>ANT_POS_Z<span class="token punctuation">)</span><span class="token punctuation">;</span>

        QtVariantProperty<span class="token operator">*</span> scale <span class="token operator">=</span> _pModelAttrMgr<span class="token operator">-&gt;</span><span class="token function">addProperty</span><span class="token punctuation">(</span>QVariant<span class="token double-colon punctuation">::</span>String<span class="token punctuation">,</span> <span class="token string">"Scale"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        QtVariantProperty<span class="token operator">*</span> scaleX <span class="token operator">=</span> _pModelAttrMgr<span class="token operator">-&gt;</span><span class="token function">addProperty</span><span class="token punctuation">(</span>QVariant<span class="token double-colon punctuation">::</span>Double<span class="token punctuation">,</span> <span class="token string">"x"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        QtVariantProperty<span class="token operator">*</span> scaleY <span class="token operator">=</span> _pModelAttrMgr<span class="token operator">-&gt;</span><span class="token function">addProperty</span><span class="token punctuation">(</span>QVariant<span class="token double-colon punctuation">::</span>Double<span class="token punctuation">,</span> <span class="token string">"y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        QtVariantProperty<span class="token operator">*</span> scaleZ <span class="token operator">=</span> _pModelAttrMgr<span class="token operator">-&gt;</span><span class="token function">addProperty</span><span class="token punctuation">(</span>QVariant<span class="token double-colon punctuation">::</span>Double<span class="token punctuation">,</span> <span class="token string">"z"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        scale<span class="token operator">-&gt;</span><span class="token function">addSubProperty</span><span class="token punctuation">(</span>scaleX<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scale<span class="token operator">-&gt;</span><span class="token function">addSubProperty</span><span class="token punctuation">(</span>scaleY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scale<span class="token operator">-&gt;</span><span class="token function">addSubProperty</span><span class="token punctuation">(</span>scaleZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scaleX<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span>pNode<span class="token operator">-&gt;</span><span class="token function">getScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scaleY<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span>pNode<span class="token operator">-&gt;</span><span class="token function">getScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scaleZ<span class="token operator">-&gt;</span><span class="token function">setValue</span><span class="token punctuation">(</span>pNode<span class="token operator">-&gt;</span><span class="token function">getScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>

        scaleX<span class="token operator">-&gt;</span><span class="token function">setUserData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>pNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scaleY<span class="token operator">-&gt;</span><span class="token function">setUserData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>pNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scaleZ<span class="token operator">-&gt;</span><span class="token function">setUserData</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>pNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        scaleX<span class="token operator">-&gt;</span><span class="token function">setUserData1</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>AttributeNodeType<span class="token double-colon punctuation">::</span>ANT_SCALE_X<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scaleY<span class="token operator">-&gt;</span><span class="token function">setUserData1</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>AttributeNodeType<span class="token double-colon punctuation">::</span>ANT_SCALE_Y<span class="token punctuation">)</span><span class="token punctuation">;</span>
        scaleZ<span class="token operator">-&gt;</span><span class="token function">setUserData1</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>AttributeNodeType<span class="token double-colon punctuation">::</span>ANT_SCALE_Z<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ui<span class="token punctuation">.</span>_propertyTree<span class="token operator">-&gt;</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        ui<span class="token punctuation">.</span>_propertyTree<span class="token operator">-&gt;</span><span class="token function">addProperty</span><span class="token punctuation">(</span>trans<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ui<span class="token punctuation">.</span>_propertyTree<span class="token operator">-&gt;</span><span class="token function">addProperty</span><span class="token punctuation">(</span>scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">GameDesigner</span><span class="token double-colon punctuation">::</span><span class="token function">mySlotValueChanged</span><span class="token punctuation">(</span>QtProperty<span class="token operator">*</span> prop<span class="token punctuation">,</span> <span class="token keyword">const</span> QVariant<span class="token operator">&amp;</span> val<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QtVariantProperty<span class="token operator">*</span> propertys <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>QtVariantProperty<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token operator">*</span> pNode <span class="token operator">=</span> <span class="token punctuation">(</span>CELL<span class="token double-colon punctuation">::</span>CELLNode<span class="token operator">*</span><span class="token punctuation">)</span>propertys<span class="token operator">-&gt;</span><span class="token function">getUserData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>propertys <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">||</span> pNode <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    CELL<span class="token double-colon punctuation">::</span>float3    trans <span class="token operator">=</span> pNode<span class="token operator">-&gt;</span><span class="token function">getTrans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    CELL<span class="token double-colon punctuation">::</span>float3    scale <span class="token operator">=</span> pNode<span class="token operator">-&gt;</span><span class="token function">getScale</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>propertys<span class="token operator">-&gt;</span><span class="token function">getUserData1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> AttributeNodeType<span class="token double-colon punctuation">::</span>ANT_POS_X<span class="token operator">:</span>
    <span class="token punctuation">{<!-- --></span>
        trans<span class="token punctuation">.</span>x <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">toReal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> AttributeNodeType<span class="token double-colon punctuation">::</span>ANT_POS_Y<span class="token operator">:</span>
    <span class="token punctuation">{<!-- --></span>
        trans<span class="token punctuation">.</span>y <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">toReal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> AttributeNodeType<span class="token double-colon punctuation">::</span>ANT_POS_Z<span class="token operator">:</span>
    <span class="token punctuation">{<!-- --></span>
        trans<span class="token punctuation">.</span>z <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">toReal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> AttributeNodeType<span class="token double-colon punctuation">::</span>ANT_SCALE_X<span class="token operator">:</span>
    <span class="token punctuation">{<!-- --></span>
        scale<span class="token punctuation">.</span>x <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">toReal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> AttributeNodeType<span class="token double-colon punctuation">::</span>ANT_SCALE_Y<span class="token operator">:</span>
    <span class="token punctuation">{<!-- --></span>
        scale<span class="token punctuation">.</span>y <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">toReal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> AttributeNodeType<span class="token double-colon punctuation">::</span>ANT_SCALE_Z<span class="token operator">:</span>
    <span class="token punctuation">{<!-- --></span>
        scale<span class="token punctuation">.</span>z <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token function">toReal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    pNode<span class="token operator">-&gt;</span><span class="token function">setTranslation</span><span class="token punctuation">(</span>trans<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pNode<span class="token operator">-&gt;</span><span class="token function">setScale</span><span class="token punctuation">(</span>scale<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      <p>
       主要是这些函数，里面具体的逻辑可以看我分享的代码。
       <br/>
       <a href="https://gitee.com/chuzhongqaq/scene-editor" rel="nofollow">
        代码链接
       </a>
      </p>
     </img>
    </img>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34353532363430312f:61727469636c652f64657461696c732f313436303835303939" class_="artid" style="display:none">
 </p>
</div>


