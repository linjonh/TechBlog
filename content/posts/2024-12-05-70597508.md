---
layout: post
title: "Android-WebRTC-音视频开发总结四-webrtc传输模块"
date: 2024-12-05 18:35:17 +0800
description: "音视频数据采集->编码->发送->接收->解码->播放。编码、解码、以及会用到加密、解密、回声消除等"
keywords: "webrtc推送模块开发"
categories: ['Webrtc']
tags: ['无标签']
artid: "70597508"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=70597508
    alt: "Android-WebRTC-音视频开发总结四-webrtc传输模块"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=70597508
featuredImagePreview: https://bing.ee123.net/img/rand?artid=70597508
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Android WebRTC 音视频开发总结（四）-- webrtc传输模块
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      在介绍WebRTC通讯之前我们先来看一个P2P视频聊天包括的主要过程，转载请说明出处（博客园RTC.Blacker）：
     </span>
    </p>
    <p>
    </p>
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      音视频数据采集-&gt;编码-&gt;发送-&gt;接收-&gt;解码-&gt;播放。
     </span>
    </p>
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      编码、解码、以及会用到加密、解密、回声消除等针对不同系统处理方式都一样，与平台无关，
     </span>
    </p>
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      但像Socket通信涉及到的数据发送、接收不同平台则有不同的处理方式，
     </span>
     <span style="color:rgb(0,0,255); font-size:16px">
      如Socket模型，windows里面用的是WSASocket，
     </span>
    </p>
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      Linux下用的则是socket，所以他通过模版模式来创建不同类型，
     </span>
    </p>
    <p>
    </p>
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      下面主要是介绍WebRTC自带的一个传输模块，实际应用中您可以根据自己的需求注册不同的传输模块。
     </span>
    </p>
    <p>
     <span style="color:rgb(0,0,255)">
      <span style="line-height:24px; font-size:16px">
      </span>
     </span>
     <img alt="" src="http://images.cnitblog.com/i/77236/201403/270932437026700.png"/>
    </p>
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      其中:udp_socket_wrapper.h主要负责Socket相关操作，如Socket创建、启动、端口绑定、停止。
     </span>
    </p>
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      udp_socket2_windows.h主要负责windows平台上的Socket相关操作，与之对应的就是linux平台上的udp_socket_posix.h
     </span>
    </p>
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      udp_transport.h主要负责包的发送和接收，如果你想实现自己的数据包收发逻辑，可重写该类，如他里面的LoopBack方式就是通过重写该模块来实现的。
     </span>
    </p>
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      对客户端调用来说主要就是做四件事情：
     </span>
    </p>
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      1、设置音视频远端地址和端口（包括远端音视频的RTP、RTCP端口和本地接收音视频的RTP、RTCP端口）。
     </span>
    </p>
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      2、启动音视频数据的发送。
     </span>
    </p>
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      3、启动音视频数据的接收。
     </span>
    </p>
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      4、启动音视频数据的播放。
     </span>
    </p>
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      具体代码结构如下：
     </span>
    </p>
    <div class="cnblogs_code">
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy">
       <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/69c5a8ac3fa60e0848d784a6dd461da6.gif"/>
      </span>
     </div>
     <pre><span style="color:rgb(0,128,128)">1</span> <span style="color:rgb(0,0,255)">public</span> <span style="color:rgb(0,0,255)">void</span> start() {
<span style="color:rgb(0,128,128)">2</span>         <span style="color:rgb(0,0,255)">this</span>.setRemoteIp(WebRTCClient.str_remote_ip);WebRTCClient.str_to);
<span style="color:rgb(0,128,128)">3</span>         <span style="color:rgb(0,0,255)">if</span> (audioEnabled) {
<span style="color:rgb(0,128,128)">4</span>             startVoE();
<span style="color:rgb(0,128,128)">5</span>         }
<span style="color:rgb(0,128,128)">6</span>         <span style="color:rgb(0,0,255)">if</span> (receiveVideo || sendVideo) {
<span style="color:rgb(0,128,128)">7</span>             startViE();
<span style="color:rgb(0,128,128)">8</span>         }
<span style="color:rgb(0,128,128)">9</span>     }</pre>
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy">
       <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/69c5a8ac3fa60e0848d784a6dd461da6.gif"/>
      </span>
     </div>
    </div>
    <div class="cnblogs_code">
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy">
       <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/69c5a8ac3fa60e0848d784a6dd461da6.gif"/>
      </span>
     </div>
     <pre><span style="color:rgb(0,128,128)">1</span> <span style="color:rgb(0,0,255)">public</span> <span style="color:rgb(0,0,255)">void</span> startVoE() {
<span style="color:rgb(0,128,128)">2</span>         check(!voeRunning, "VoE already started");
<span style="color:rgb(0,128,128)">3</span>         check(voe.startListen(audioChannel) == 0, "Failed StartListen");
<span style="color:rgb(0,128,128)">4</span>         check(voe.startPlayout(audioChannel) == 0, "VoE start playout failed");
<span style="color:rgb(0,128,128)">5</span>         check(voe.startSend(audioChannel) == 0, "VoE start send failed");
<span style="color:rgb(0,128,128)">6</span>         voeRunning = <span style="color:rgb(0,0,255)">true</span>;
<span style="color:rgb(0,128,128)">7</span>     }</pre>
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy">
       <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/69c5a8ac3fa60e0848d784a6dd461da6.gif"/>
      </span>
     </div>
    </div>
    <div class="cnblogs_code">
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy">
       <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/69c5a8ac3fa60e0848d784a6dd461da6.gif"/>
      </span>
     </div>
     <pre><span style="color:rgb(0,128,128)"> 1</span> <span style="color:rgb(0,0,255)">public</span> <span style="color:rgb(0,0,255)">void</span> startViE() {
<span style="color:rgb(0,128,128)"> 2</span>         check(!vieRunning, "ViE already started");
<span style="color:rgb(0,128,128)"> 3</span> 
<span style="color:rgb(0,128,128)"> 4</span>         <span style="color:rgb(0,0,255)">if</span> (receiveVideo) {
<span style="color:rgb(0,128,128)"> 5</span>             <span style="color:rgb(0,0,255)">if</span> (viewSelection == context.getResources().getInteger(R.integer.openGl)) {
<span style="color:rgb(0,128,128)"> 6</span>                 svRemote = ViERenderer.CreateRenderer(context, <span style="color:rgb(0,0,255)">true</span>);
<span style="color:rgb(0,128,128)"> 7</span>             } <span style="color:rgb(0,0,255)">else</span> <span style="color:rgb(0,0,255)">if</span> (viewSelection == context.getResources().getInteger(R.integer.surfaceView)) {
<span style="color:rgb(0,128,128)"> 8</span>                 svRemote = ViERenderer.CreateRenderer(context, <span style="color:rgb(0,0,255)">false</span>);
<span style="color:rgb(0,128,128)"> 9</span>             } <span style="color:rgb(0,0,255)">else</span> {
<span style="color:rgb(0,128,128)">10</span>                 externalCodec = <span style="color:rgb(0,0,255)">new</span> MediaCodecVideoDecoder(context);
<span style="color:rgb(0,128,128)">11</span>                 svRemote = externalCodec.getView();
<span style="color:rgb(0,128,128)">12</span>             }
<span style="color:rgb(0,128,128)">13</span>             <span style="color:rgb(0,0,255)">if</span> (externalCodec != <span style="color:rgb(0,0,255)">null</span>) {
<span style="color:rgb(0,128,128)">14</span>                 check(vie.registerExternalReceiveCodec(videoChannel, VCM_VP8_PAYLOAD_TYPE,
<span style="color:rgb(0,128,128)">15</span>                         externalCodec, <span style="color:rgb(0,0,255)">true</span>) == 0, "Failed to register external decoder");
<span style="color:rgb(0,128,128)">16</span>             } <span style="color:rgb(0,0,255)">else</span> {
<span style="color:rgb(0,128,128)">17</span>                 check(vie.addRenderer(videoChannel, svRemote, 0, 0, 0, 1, 1) == 0,
<span style="color:rgb(0,128,128)">18</span>                         "Failed AddRenderer");
<span style="color:rgb(0,128,128)">19</span>                 check(vie.startRender(videoChannel) == 0, "Failed StartRender");
<span style="color:rgb(0,128,128)">20</span>             }
<span style="color:rgb(0,128,128)">21</span>             check(vie.startReceive(videoChannel) == 0, "Failed StartReceive");
<span style="color:rgb(0,128,128)">22</span>         }
<span style="color:rgb(0,128,128)">23</span>         <span style="color:rgb(0,0,255)">if</span> (sendVideo) {
<span style="color:rgb(0,128,128)">24</span>             startCamera();
<span style="color:rgb(0,128,128)">25</span>             check(vie.startSend(videoChannel) == 0, "Failed StartSend");
<span style="color:rgb(0,128,128)">26</span>         }
<span style="color:rgb(0,128,128)">27</span>         vieRunning = <span style="color:rgb(0,0,255)">true</span>;
<span style="color:rgb(0,128,128)">28</span>     }</pre>
     <div class="cnblogs_code_toolbar">
      <span class="cnblogs_code_copy">
       <img alt="复制代码" src="https://i-blog.csdnimg.cn/blog_migrate/69c5a8ac3fa60e0848d784a6dd461da6.gif"/>
      </span>
     </div>
    </div>
    <p>
     <span style="color:rgb(0,0,255)">
      <span style="line-height:24px; font-size:16px">
       希望查看这个调用过程能是您大概明白流媒体数据的发送过程，为后面自定能够以传输模块打下基础。
      </span>
     </span>
     <span style="line-height:1.5">
     </span>
    </p>
    <p>
     <span style="color:rgb(0,0,255); font-size:16px">
      请思考：WebRTC里面如何操作音视频设备？如打开扬声器，启动摄像头，后面会揭晓答案，请关注。
     </span>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f4269786977656e5f6c6975:2f61727469636c652f64657461696c732f3730353937353038" class_="artid" style="display:none">
 </p>
</div>


