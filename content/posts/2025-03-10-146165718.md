---
layout: post
title: "RabbitMQä½¿ç”¨å»¶è¿Ÿæ¶ˆæ¯"
date: 2025-03-10 23:03:02 +0800
description: "ä¸‹è½½å®Œå°†æ’ä»¶åœ¨dockerä¸­æ·»åŠ åˆ°RabbitMQçš„pluginsä¸­ï¼Œç„¶ådocker restart rabbitmqé‡å¯RabbitMQã€‚è¿™é‡Œè®¾ç½®å»¶è¿Ÿæ—¶é—´ä¸º10sï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰ï¼Œä¸‹å•10såä¼šå‘é€æ¶ˆæ¯åˆ°å»¶è¿Ÿæ¶ˆæ¯äº¤æ¢æœºï¼Œç„¶åå»åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ”¯ä»˜ï¼Œå¦‚æœæœªæ”¯ä»˜ï¼Œåˆ™å–æ¶ˆè®¢å•æ¢å¤åº“å­˜ã€‚æ§åˆ¶å°å¯ä»¥çœ‹åˆ°ï¼Œä¸‹å•åˆ°æ¶ˆè´¹æ¶ˆæ¯ä¸­é—´é—´éš”åç§’é’Ÿï¼Œè¡¨æ˜æˆ‘ä»¬è®¾ç½®çš„å»¶è¿Ÿæ¶ˆæ¯æˆåŠŸã€‚è¿™é‡Œä½¿ç”¨ç¬¬ä¸€ç§æƒ…å†µå®ç°(ä¸‹å•æœªä»˜æ¬¾ï¼Œç‰¹å®šæ—¶é—´å†…å–æ¶ˆè®¢å•ï¼Œæ¢å¤åº“å­˜)ç”¨æˆ·ä¸‹å•å®Œæ¯•åï¼Œæƒ³å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯ã€‚ï¼Œç³»ç»Ÿéœ€è¦è‡ªåŠ¨å–æ¶ˆè®¢å•ã€‚ï¼š ç”¨æˆ·ä¸‹å•åï¼Œå¦‚æœã€‚"
keywords: "RabbitMQä½¿ç”¨å»¶è¿Ÿæ¶ˆæ¯"
categories: ['æœªåˆ†ç±»']
tags: ['å»¶è¿Ÿæ¶ˆæ¯', 'Rabbitmq', 'Java']
artid: "146165718"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146165718
    alt: "RabbitMQä½¿ç”¨å»¶è¿Ÿæ¶ˆæ¯"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146165718
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146165718
cover: https://bing.ee123.net/img/rand?artid=146165718
image: https://bing.ee123.net/img/rand?artid=146165718
img: https://bing.ee123.net/img/rand?artid=146165718
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     RabbitMQä½¿ç”¨å»¶è¿Ÿæ¶ˆæ¯
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h3>
     RabbitMQä½¿ç”¨å»¶è¿Ÿæ¶ˆæ¯
    </h3>
    <h3>
     1.ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨å»¶è¿Ÿæ¶ˆæ¯
    </h3>
    <p>
     <strong>
      å»¶è¿Ÿæ¶ˆæ¯
     </strong>
     é€‚ç”¨äº
     <strong>
      éœ€è¦åœ¨ä¸€æ®µæ—¶é—´åæ‰§è¡ŒæŸäº›æ“ä½œ
     </strong>
     çš„åœºæ™¯ï¼Œå¸¸è§çš„æœ‰ä»¥ä¸‹å‡ ç±»ï¼š
    </p>
    <h4>
     <strong>
      1.1. è®¢å•è¶…æ—¶å–æ¶ˆï¼ˆæœªæ”¯ä»˜è‡ªåŠ¨å–æ¶ˆï¼‰
     </strong>
    </h4>
    <p>
     <strong>
      åœºæ™¯
     </strong>
     ï¼š ç”¨æˆ·ä¸‹å•åï¼Œå¦‚æœ
     <strong>
      30 åˆ†é’Ÿå†…æœªä»˜æ¬¾
     </strong>
     ï¼Œç³»ç»Ÿéœ€è¦è‡ªåŠ¨å–æ¶ˆè®¢å•ã€‚
    </p>
    <p>
     <strong>
      å®ç°æ–¹å¼
     </strong>
     ï¼š
    </p>
    <ul>
     <li>
      <p>
       è®¢å•åˆ›å»ºæ—¶ï¼Œå‘é€
       <strong>
        å»¶è¿Ÿæ¶ˆæ¯
       </strong>
       ï¼Œ
       <strong>
        30 åˆ†é’Ÿå
       </strong>
       æ£€æŸ¥è®¢å•çŠ¶æ€ã€‚
      </p>
     </li>
     <li>
      <p>
       è‹¥è®¢å•ä»æœªæ”¯ä»˜ï¼Œåˆ™
       <strong>
        è‡ªåŠ¨å–æ¶ˆ
       </strong>
       å¹¶
       <strong>
        é‡Šæ”¾åº“å­˜
       </strong>
       ã€‚
      </p>
     </li>
    </ul>
    <h4>
     2.
     <strong>
      æ”¯ä»˜åå»¶è¿Ÿå‘è´§
     </strong>
     ğŸšš
    </h4>
    <p>
     <strong>
      åœºæ™¯
     </strong>
     ï¼š æŸäº›å•†å“éœ€è¦
     <strong>
      å»¶è¿Ÿå‘è´§
     </strong>
     ï¼Œä¾‹å¦‚
     <strong>
      7 å¤©æ— ç†ç”±é€€æ¬¾
     </strong>
     æœŸé—´ä¸ç«‹å³å‘è´§ï¼Œç­‰å¾…ç”¨æˆ·æ˜¯å¦ç”³è¯·é€€æ¬¾ã€‚
    </p>
    <p>
     <strong>
      å®ç°æ–¹å¼
     </strong>
     ï¼š
    </p>
    <ul>
     <li>
      <p>
       ç”¨æˆ·ä»˜æ¬¾åï¼Œå‘é€
       <strong>
        å»¶è¿Ÿæ¶ˆæ¯
       </strong>
       ï¼Œ
       <strong>
        7 å¤©åæ£€æŸ¥
       </strong>
       è®¢å•çŠ¶æ€ã€‚
      </p>
     </li>
     <li>
      <p>
       å¦‚æœç”¨æˆ·æœªç”³è¯·é€€æ¬¾ï¼Œåˆ™å‘è´§ï¼›å¦åˆ™å–æ¶ˆå‘è´§ã€‚
      </p>
     </li>
    </ul>
    <h4>
     <strong>
      3. é™æ—¶æ´»åŠ¨ï¼ˆæŠ¢è´­ã€ç§’æ€ç­‰ï¼‰
     </strong>
     â³
    </h4>
    <p>
     <strong>
      åœºæ™¯
     </strong>
     ï¼š æŸäº›ä¿ƒé”€æ´»åŠ¨ï¼ˆå¦‚ç§’æ€ã€é™æ—¶æŠ¢è´­ï¼‰
     <strong>
      åœ¨ç‰¹å®šæ—¶é—´å¼€å§‹æˆ–ç»“æŸ
     </strong>
     ã€‚
    </p>
    <p>
     <strong>
      å®ç°æ–¹å¼
     </strong>
     ï¼š
    </p>
    <ul>
     <li>
      <p>
       <strong>
        æ´»åŠ¨å¼€å§‹
       </strong>
       å‰ï¼Œå‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼Œ
       <strong>
        å®šæ—¶å¼€æ”¾åº“å­˜
       </strong>
       ã€‚
      </p>
     </li>
     <li>
      <p>
       <strong>
        æ´»åŠ¨ç»“æŸ
       </strong>
       å‰ï¼Œå‘é€å»¶è¿Ÿæ¶ˆæ¯ï¼Œ
       <strong>
        ä¸‹æ¶å•†å“ï¼Œåœæ­¢æŠ¢è´­
       </strong>
       ã€‚
      </p>
     </li>
    </ul>
    <p>
    </p>
    <h3>
     2.å»¶è¿Ÿæ¶ˆæ¯å®ç°
    </h3>
    <p>
     è¿™é‡Œä½¿ç”¨ç¬¬ä¸€ç§æƒ…å†µå®ç°(ä¸‹å•æœªä»˜æ¬¾ï¼Œç‰¹å®šæ—¶é—´å†…å–æ¶ˆè®¢å•ï¼Œæ¢å¤åº“å­˜)
    </p>
    <h4>
     1.ä¸‹è½½RabbitMQçš„å»¶è¿Ÿæ¶ˆæ¯æ’ä»¶ï¼Œåœ°å€ï¼š
    </h4>
    <p>
     <a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases" title="Releases Â· rabbitmq/rabbitmq-delayed-message-exchange">
      Releases Â· rabbitmq/rabbitmq-delayed-message-exchange
     </a>
    </p>
    <p>
     ä¸‹è½½å®Œå°†æ’ä»¶åœ¨dockerä¸­æ·»åŠ åˆ°RabbitMQçš„pluginsä¸­ï¼Œç„¶ådocker restart rabbitmqé‡å¯RabbitMQ
    </p>
    <h4>
     2.åœ¨äº¤æ¢æœºä¸­æ·»åŠ æ–°çš„äº¤æ¢æœºï¼Œç±»å‹ä¸­å¤šäº†ä¸€ä¸ªx-delayed-message,è¿™è¡¨ç¤ºå»¶è¿Ÿæ¶ˆæ¯æ’ä»¶å®‰è£…æˆåŠŸ
     <img alt="" height="898" src="https://i-blog.csdnimg.cn/direct/b0b13ca30f264b7093ef3d462d8f9ef3.png" width="1197"/>
    </h4>
    <h4>
     <strong>
      3.ä½¿ç”¨æ³¨è§£å£°æ˜å»¶è¿Ÿæ¶ˆæ¯äº¤æ¢æœº
     </strong>
    </h4>
    <p>
     å®šä¹‰è¿œé©°æ¶ˆæ¯äº¤æ¢æœºåå­—ã€å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—å’Œroutingkey
    </p>
    <pre><code class="language-java">public interface MqConstants {
    String DELAY_EXCHANGE_NAME = "trade.delay.direct";
    String DELAY_ORDER_QUEUE_NAME = "trade.delay.order.queue";
    String DELAY_ORDER_KEY = "delay.order.query";
}</code></pre>
    <pre><code class="language-java">    /**
     * ç›‘å¬å»¶è¿Ÿé˜Ÿåˆ—ï¼Œå¦‚æœè®¢å•ä¸‹å•æœªæ”¯ä»˜ï¼Œåˆ™å–æ¶ˆè®¢å•ï¼Œæ¢å¤åº“å­˜
     * @param orderId
     */
    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = MqConstants.DELAY_ORDER_QUEUE_NAME), //å»¶è¿Ÿé˜Ÿåˆ—å
            exchange = @Exchange(name = MqConstants.DELAY_EXCHANGE_NAME, delayed = "true"), //å»¶è¿Ÿäº¤æ¢æœºå
            key = MqConstants.DELAY_ORDER_KEY //routingkey
    ))
    public void listenOrderDelayMessage(Long orderId){
        // 1.æŸ¥è¯¢è®¢å•
        Order order = orderService.getById(orderId);
        // 2.æ£€æµ‹è®¢å•çŠ¶æ€ï¼Œåˆ¤æ–­æ˜¯å¦å·²æ”¯ä»˜
        if(order == null || order.getStatus() != 1){
            // è®¢å•ä¸å­˜åœ¨æˆ–è€…å·²ç»æ”¯ä»˜
            return;
        }
        // 3.æœªæ”¯ä»˜ï¼Œéœ€è¦æŸ¥è¯¢æ”¯ä»˜æµæ°´çŠ¶æ€
        PayOrderDTO payOrder = payClient.queryPayOrderByBizOrderNo(orderId);
        // 4.åˆ¤æ–­æ˜¯å¦æ”¯ä»˜
        if(payOrder != null &amp;&amp; payOrder.getStatus() == 3){
            // 4.1.å·²æ”¯ä»˜ï¼Œæ ‡è®°è®¢å•çŠ¶æ€ä¸ºå·²æ”¯ä»˜
            orderService.markOrderPaySuccess(orderId);
        }else{
            // TODO 4.2.æœªæ”¯ä»˜ï¼Œå–æ¶ˆè®¢å•ï¼Œå›å¤åº“å­˜
            System.out.println("è®¢å•æœªæ”¯ä»˜ï¼Œå–æ¶ˆè®¢å•ï¼Œå›å¤åº“å­˜");
//            orderService.cancelOrder(orderId);
        }
    }
}</code></pre>
    <h4>
     4.å‘é€æ¶ˆæ¯
    </h4>
    <p>
     ç”¨æˆ·ä¸‹å•å®Œæ¯•åï¼Œæƒ³å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—å‘é€æ¶ˆæ¯
    </p>
    <pre><code class="language-java">//ä¸‹å•å®Œæ¯•å

        /**
         * TODO:å‘é€å»¶è¿Ÿæ¶ˆæ¯,æŸ¥è¯¢10ç§’åè®¢å•çš„çŠ¶æ€ï¼Œå¦‚æœæ²¡æ”¯ä»˜ï¼Œåˆ™å–æ¶ˆè®¢å•ï¼Œæ¢å¤åº“å­˜
         */
        rabbitTemplate.convertAndSend(
                MqConstants.DELAY_EXCHANGE_NAME,
                MqConstants.DELAY_ORDER_KEY,
                order.getId(),
                message -&gt; {
                    message.getMessageProperties().setDelay(1000 * 10);//å»¶è¿Ÿæ—¶é—´10s
                    return message;
                }
        );</code></pre>
    <p>
     é€šè¿‡è®¾ç½®äº¤æ¢æœº
     <strong>
      åå­—å’Œroutingkey
     </strong>
     å¯ä»¥ç»‘å®šåˆ°å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—
    </p>
    <p>
     è¿™é‡Œè®¾ç½®å»¶è¿Ÿæ—¶é—´ä¸º10sï¼ˆæ–¹ä¾¿æµ‹è¯•ï¼‰ï¼Œä¸‹å•10såä¼šå‘é€æ¶ˆæ¯åˆ°å»¶è¿Ÿæ¶ˆæ¯äº¤æ¢æœºï¼Œç„¶åå»åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ”¯ä»˜ï¼Œå¦‚æœæœªæ”¯ä»˜ï¼Œåˆ™å–æ¶ˆè®¢å•æ¢å¤åº“å­˜
    </p>
    <h3>
     3.å®è·µ
    </h3>
    <p>
     å‘é€ä¸‹å•è¯·æ±‚
    </p>
    <p>
     <img alt="" height="580" src="https://i-blog.csdnimg.cn/direct/8ccaa8660e754a09bfbf7ff7aa309e96.png" width="721"/>
    </p>
    <p>
     æ§åˆ¶å°å¯ä»¥çœ‹åˆ°ï¼Œä¸‹å•åˆ°æ¶ˆè´¹æ¶ˆæ¯ä¸­é—´é—´éš”åç§’é’Ÿï¼Œè¡¨æ˜æˆ‘ä»¬è®¾ç½®çš„å»¶è¿Ÿæ¶ˆæ¯æˆåŠŸ
    </p>
    <p>
     <img alt="" height="1117" src="https://i-blog.csdnimg.cn/direct/d0ab5efea61149b0a8a3854b82fccf51.png" width="1680"/>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f37343432313939302f:61727469636c652f64657461696c732f313436313635373138" class_="artid" style="display:none">
 </p>
</div>


