---
layout: post
title: "RabbitMQ使用延迟消息"
date: 2025-03-10 23:03:02 +0800
description: "下载完将插件在docker中添加到RabbitMQ的plugins中，然后docker restart rabbitmq重启RabbitMQ。这里设置延迟时间为10s（方便测试），下单10s后会发送消息到延迟消息交换机，然后去判断用户是否支付，如果未支付，则取消订单恢复库存。控制台可以看到，下单到消费消息中间间隔十秒钟，表明我们设置的延迟消息成功。这里使用第一种情况实现(下单未付款，特定时间内取消订单，恢复库存)用户下单完毕后，想延迟消息队列发送消息。，系统需要自动取消订单。： 用户下单后，如果。"
keywords: "RabbitMQ使用延迟消息"
categories: ['未分类']
tags: ['延迟消息', 'Rabbitmq', 'Java']
artid: "146165718"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146165718
    alt: "RabbitMQ使用延迟消息"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146165718
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146165718
cover: https://bing.ee123.net/img/rand?artid=146165718
image: https://bing.ee123.net/img/rand?artid=146165718
img: https://bing.ee123.net/img/rand?artid=146165718
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     RabbitMQ使用延迟消息
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h3>
     RabbitMQ使用延迟消息
    </h3>
    <h3>
     1.什么情况下使用延迟消息
    </h3>
    <p>
     <strong>
      延迟消息
     </strong>
     适用于
     <strong>
      需要在一段时间后执行某些操作
     </strong>
     的场景，常见的有以下几类：
    </p>
    <h4>
     <strong>
      1.1. 订单超时取消（未支付自动取消）
     </strong>
    </h4>
    <p>
     <strong>
      场景
     </strong>
     ： 用户下单后，如果
     <strong>
      30 分钟内未付款
     </strong>
     ，系统需要自动取消订单。
    </p>
    <p>
     <strong>
      实现方式
     </strong>
     ：
    </p>
    <ul>
     <li>
      <p>
       订单创建时，发送
       <strong>
        延迟消息
       </strong>
       ，
       <strong>
        30 分钟后
       </strong>
       检查订单状态。
      </p>
     </li>
     <li>
      <p>
       若订单仍未支付，则
       <strong>
        自动取消
       </strong>
       并
       <strong>
        释放库存
       </strong>
       。
      </p>
     </li>
    </ul>
    <h4>
     2.
     <strong>
      支付后延迟发货
     </strong>
     🚚
    </h4>
    <p>
     <strong>
      场景
     </strong>
     ： 某些商品需要
     <strong>
      延迟发货
     </strong>
     ，例如
     <strong>
      7 天无理由退款
     </strong>
     期间不立即发货，等待用户是否申请退款。
    </p>
    <p>
     <strong>
      实现方式
     </strong>
     ：
    </p>
    <ul>
     <li>
      <p>
       用户付款后，发送
       <strong>
        延迟消息
       </strong>
       ，
       <strong>
        7 天后检查
       </strong>
       订单状态。
      </p>
     </li>
     <li>
      <p>
       如果用户未申请退款，则发货；否则取消发货。
      </p>
     </li>
    </ul>
    <h4>
     <strong>
      3. 限时活动（抢购、秒杀等）
     </strong>
     ⏳
    </h4>
    <p>
     <strong>
      场景
     </strong>
     ： 某些促销活动（如秒杀、限时抢购）
     <strong>
      在特定时间开始或结束
     </strong>
     。
    </p>
    <p>
     <strong>
      实现方式
     </strong>
     ：
    </p>
    <ul>
     <li>
      <p>
       <strong>
        活动开始
       </strong>
       前，发送延迟消息，
       <strong>
        定时开放库存
       </strong>
       。
      </p>
     </li>
     <li>
      <p>
       <strong>
        活动结束
       </strong>
       前，发送延迟消息，
       <strong>
        下架商品，停止抢购
       </strong>
       。
      </p>
     </li>
    </ul>
    <p>
    </p>
    <h3>
     2.延迟消息实现
    </h3>
    <p>
     这里使用第一种情况实现(下单未付款，特定时间内取消订单，恢复库存)
    </p>
    <h4>
     1.下载RabbitMQ的延迟消息插件，地址：
    </h4>
    <p>
     <a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases" title="Releases · rabbitmq/rabbitmq-delayed-message-exchange">
      Releases · rabbitmq/rabbitmq-delayed-message-exchange
     </a>
    </p>
    <p>
     下载完将插件在docker中添加到RabbitMQ的plugins中，然后docker restart rabbitmq重启RabbitMQ
    </p>
    <h4>
     2.在交换机中添加新的交换机，类型中多了一个x-delayed-message,这表示延迟消息插件安装成功
     <img alt="" height="898" src="https://i-blog.csdnimg.cn/direct/b0b13ca30f264b7093ef3d462d8f9ef3.png" width="1197"/>
    </h4>
    <h4>
     <strong>
      3.使用注解声明延迟消息交换机
     </strong>
    </h4>
    <p>
     定义远驰消息交换机名字、延迟消息队列和routingkey
    </p>
    <pre><code class="language-java">public interface MqConstants {
    String DELAY_EXCHANGE_NAME = "trade.delay.direct";
    String DELAY_ORDER_QUEUE_NAME = "trade.delay.order.queue";
    String DELAY_ORDER_KEY = "delay.order.query";
}</code></pre>
    <pre><code class="language-java">    /**
     * 监听延迟队列，如果订单下单未支付，则取消订单，恢复库存
     * @param orderId
     */
    @RabbitListener(bindings = @QueueBinding(
            value = @Queue(name = MqConstants.DELAY_ORDER_QUEUE_NAME), //延迟队列名
            exchange = @Exchange(name = MqConstants.DELAY_EXCHANGE_NAME, delayed = "true"), //延迟交换机名
            key = MqConstants.DELAY_ORDER_KEY //routingkey
    ))
    public void listenOrderDelayMessage(Long orderId){
        // 1.查询订单
        Order order = orderService.getById(orderId);
        // 2.检测订单状态，判断是否已支付
        if(order == null || order.getStatus() != 1){
            // 订单不存在或者已经支付
            return;
        }
        // 3.未支付，需要查询支付流水状态
        PayOrderDTO payOrder = payClient.queryPayOrderByBizOrderNo(orderId);
        // 4.判断是否支付
        if(payOrder != null &amp;&amp; payOrder.getStatus() == 3){
            // 4.1.已支付，标记订单状态为已支付
            orderService.markOrderPaySuccess(orderId);
        }else{
            // TODO 4.2.未支付，取消订单，回复库存
            System.out.println("订单未支付，取消订单，回复库存");
//            orderService.cancelOrder(orderId);
        }
    }
}</code></pre>
    <h4>
     4.发送消息
    </h4>
    <p>
     用户下单完毕后，想延迟消息队列发送消息
    </p>
    <pre><code class="language-java">//下单完毕后

        /**
         * TODO:发送延迟消息,查询10秒后订单的状态，如果没支付，则取消订单，恢复库存
         */
        rabbitTemplate.convertAndSend(
                MqConstants.DELAY_EXCHANGE_NAME,
                MqConstants.DELAY_ORDER_KEY,
                order.getId(),
                message -&gt; {
                    message.getMessageProperties().setDelay(1000 * 10);//延迟时间10s
                    return message;
                }
        );</code></pre>
    <p>
     通过设置交换机
     <strong>
      名字和routingkey
     </strong>
     可以绑定到延迟消息队列
    </p>
    <p>
     这里设置延迟时间为10s（方便测试），下单10s后会发送消息到延迟消息交换机，然后去判断用户是否支付，如果未支付，则取消订单恢复库存
    </p>
    <h3>
     3.实践
    </h3>
    <p>
     发送下单请求
    </p>
    <p>
     <img alt="" height="580" src="https://i-blog.csdnimg.cn/direct/8ccaa8660e754a09bfbf7ff7aa309e96.png" width="721"/>
    </p>
    <p>
     控制台可以看到，下单到消费消息中间间隔十秒钟，表明我们设置的延迟消息成功
    </p>
    <p>
     <img alt="" height="1117" src="https://i-blog.csdnimg.cn/direct/d0ab5efea61149b0a8a3854b82fccf51.png" width="1680"/>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f37343432313939302f:61727469636c652f64657461696c732f313436313635373138" class_="artid" style="display:none">
 </p>
</div>


