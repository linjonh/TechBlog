---
arturl_encode: "68747470733a2f:2f626c6f672e6373646e2e6e65742f7a71665f6f6666696365:2f61727469636c652f64657461696c732f3536333131373232"
layout: post
title: "windows下ffmpeg音视频采集并推流"
date: 2024-12-31 11:29:05 +08:00
description: "1.windows下ffmpeg的编译：        可参考：在windows下编译ffmpeg的"
keywords: "win11 capdriverconnect失败"
categories: ['技术资料']
tags: ['无标签']
artid: "56311722"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=56311722
    alt: "windows下ffmpeg音视频采集并推流"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=56311722
featuredImagePreview: https://bing.ee123.net/img/rand?artid=56311722
---

# windows下ffmpeg音视频采集并推流

### 1. windows下ffmpeg的编译： 可参考： [在windows下编译ffmpeg的详细说明](http://www.codecoolie.com/ffmpeg/compile-ffmpeg-under-windows/) 如：./configure --disable-yasm --enable-static --enable-indev=dshow 如果装了yasm，x264，就：./configure --enable-static --enable-indev=dshow --enable-gpl --enable-libx264 2. windows下用ffmpeg采集视频： 可参考： [ffmpeg在windows下捕获摄像头视频](http://blog.sina.com.cn/s/blog_51396f890102dxei.html) 命令如： ffmpeg.exe -r 5 -f vfwcap -i 0 -s 176x144 -f rawvideo -pix\_fmt yuv420p ss.yuv 3. 如果要想深入下ffmpeg中vfwcap： 可参考： [ffmpeg源码分析之vfwcap](http://blog.csdn.net/nkmnkm/article/details/7035877) 4.记录一下遇到的问题 A connect设备失败 [Win7系统下使用capDriverConnect()连接失败的解决办法](http://bbs.2cto.com/read.php?tid=234870) 5. 前面提到的是VFW（video for windows）设备，现在摄像头都会支持vfw/wdm，但各系统并非有对应驱动 [程序](http://www.xuebuyuan.com/ "程序") 。 【电脑插上USB摄像头时，会为其安装通用驱动，测试其是VFW还是WDM，在设备管理查看驱动程序详细信息应该能辨别，或者直接上程序，编译测试。】 【根据使用的驱动程序的不同来分类，目前市场上大致有两种捕捉卡：VFW (Video for Windows)卡和WDM (Windows Driver Model)卡。VFW是DirectShow的前身，摄像头驱动未必支持。新的程序应该使用DirectShow。参考DirectShow SDK中的amcap示例。】 【视频捕捉卡的接口，可以是以PCI或AGP的方式插入PC机箱，也可以直接以USB接口的方式外挂；还有就是通过1394接口与PC机相连的数码摄像机等等。】 6.windows下用ffmpeg采集音频： 7.windows下使用ffmpeg中的dshow 如：ffmpeg -f dshow -i video="6RoomsCam" -y out.flv //用的六间房的虚拟摄像头 ffmpeg-f dshow -i audio="Realtek HD Audio Input" -y out.flv 上面是分开采集的，同时采集，合并就行了，两个输入文件是ffmpeg -f dshow -i video="6RoomsCam" -f dshow -i audio="Realtek HD Audio Input" -y out.flv。 若要查看本机有哪些设备，可以参考10. 8.null. 9.在linux下，如： ffmpeg  -f video4linux2 -s 320*240 -r 10 -i /dev/video0  test.asf ffmpeg -f oss -i /dev/dsp   /tmp/out.mpg 10. 最后可以参考这里： [how to capture a webcam input](http://ffmpeg.org/trac/ffmpeg/wiki/How%20to%20capture%20a%20webcam%20input) 记录一些命令，直接研究也可： ffmpeg - list\_devices true -f dshow -i dummy //可查看摄像头和声卡设备名称 ``` ffmpeg -y -f vfwcap -i list ``` ``` ffmpeg -y -f vfwcap -r 25 -i 0 out.mp4 ``` ``` ffmpeg -f video4linux2 -r 25 -s 640x480 -i /dev/video0 out.avi ``` ``` ffmpeg -f v4l2 -r 25 -s 640x480 -i /dev/video0 out.avi ``` ``` ffmpeg -f dshow -i video="Integrated Camera" out.mp4 ``` ffmpeg -f dshow -s 1280x720 -r 15 -vcodec mjpeg -i video="Integrated Camera" out.avi **dshow编译方面参考** ： [如何编译包含dshow设备的版本](http://blog.csdn.net/nkmnkm/article/details/7302936) 【编译遇到问题，就自己解决吧，不是很麻烦。】 ffplay -f dshow video="USB video capture 0" **【交代后期遇到的问题，以及提示】** 『用ffmpeg推音视频流（音视频皆用dshow为输入，视频编码用X264，以flv格式输出）的延迟问题，据我所看，有两点如下：』 1. 音频采样的带来的延迟，这个延迟很小。它是如何影响到延迟大小的呢？这样的：dshow中，音视频源filter的capture pin，数据包buffer大小是可设置的，假设它默认为1秒的数据，也就是每一秒才回调并向外投递出一包数据，此时（假设视频fps=15）编码器得到了15帧，在format的interleave（音视频包交错存放）处理里ff\_interleave\_packet\_per\_dts时，就缓存了接近1秒，即造成等量延迟。 如何修改capture pin呢？参考 [代码](http://www.xuebuyuan.com/ "代码") 如下： **[cpp]** [view plain](http://blog.csdn.net/fallenink/article/details/8556695# "view plain") [copy](http://blog.csdn.net/fallenink/article/details/8556695# "copy") 1. dshow\_cycle\_formats() 2. { 3. ...... 4. IAMBufferNegotiation *negotiate = NULL; 5. ALLOCATOR\_PROPERTIES prop = {0}; 6. if (devtype == AudioDevice) 7. if (IPin\_QueryInterface(pin, &, ( void **) &negotiate) != S\_OK) 8. return ; //IID\_IAMBufferNegotiation 9. ...... 10. if (devtype == AudioDevice) 11. { 12. { 13. prop.cbAlign = 1; 14. prop.cBuffers = 2; 15. prop.cbBuffer = ??; 16. } 17. if (IAMBufferNegotiation\_SuggestAllocatorProperties(negotiate, &prop) != S\_OK) 18. goto next; 19. } 20. ...... 21. if (devtype == AudioDevice) 22. IAMBufferNegotiation\_Release(negotiate); 23. ...... 24. } 至于该buffer设置多大，可以结合，音频编码的frame\_size、interleave是单帧视频对应多少音频包，来考虑 2. X264编码带来的延迟，在配置参数的时候，先参考下这篇文章： [如何计算x264编码延迟（转载如下）](http://blog.yikuyiku.com/?p=3161)