---
layout: post
title: "使用-Elastic-Agent-或-Beats-将-Journald-中的-syslog-和-auth-日志导入-Elastic-Stack"
date: 2025-03-09 09:50:38 +0800
description: "我们在 Elastic 一直努力将更多 Linux 发行版添加到我们的支持矩阵中，现在 Elastic-Agent 和 Beats 已正式支持 Debian 12！本文演示了我们正在开发的功能，以支持使用 Journald 存储系统和身份验证日志（auth logs）的 Linux 发行版。一些 Linux 发行版（如 Debian 12）已经完全放弃了传统的系统日志文件，因此现在获取这些日志的唯一方法是读取 Journald。"
keywords: "使用 Elastic-Agent 或 Beats 将 Journald 中的 syslog 和 auth 日志导入 Elastic Stack"
categories: ['Observability', 'Elastic']
tags: ['服务器', '搜索引擎', '大数据', '信息可视化', 'Linux', 'Elasticsearch', 'Debian']
artid: "146127694"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146127694
    alt: "使用-Elastic-Agent-或-Beats-将-Journald-中的-syslog-和-auth-日志导入-Elastic-Stack"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146127694
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146127694
cover: https://bing.ee123.net/img/rand?artid=146127694
image: https://bing.ee123.net/img/rand?artid=146127694
img: https://bing.ee123.net/img/rand?artid=146127694
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     使用 Elastic-Agent 或 Beats 将 Journald 中的 syslog 和 auth 日志导入 Elastic Stack
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     作者：来自 Elastic
     <a href="https://discuss.elastic.co/u/TiagoQueiroz" rel="nofollow" title="TiagoQueiroz">
      TiagoQueiroz
     </a>
    </p>
    <p>
     我们在 Elastic 一直努力将更多 Linux 发行版添加到我们的支持矩阵中，现在
     <strong>
      Elastic-Agent 和 Beats 已正式支持 Debian 12！
     </strong>
    </p>
    <p>
     本文演示了我们正在开发的功能，以支持使用
     <strong>
      Journald
     </strong>
     存储系统和身份验证日志（auth logs）的 Linux 发行版。
    </p>
    <p>
     一些 Linux 发行版（如
     <strong>
      Debian 12
     </strong>
     ）已经完全放弃了传统的系统日志文件，因此现在获取这些日志的唯一方法是读取
     <strong>
      Journald
     </strong>
     。
    </p>
    <p>
    </p>
    <h2>
     使用 Elastic-Agent 摄取系统日志
    </h2>
    <p>
     <strong>
      <a class="link-info" href="https://www.elastic.co/docs/current/en/integrations/system" rel="nofollow" title="Elastic-Agent 的系统集成">
       Elastic-Agent 的系统集成
      </a>
     </strong>
     可从服务器收集系统日志和指标。从
     <strong>
      1.63.0 版（Elastic-Agent 8.17.0）
     </strong>
     开始，它还支持从
     <strong>
      Journald
     </strong>
     摄取日志。
    </p>
    <p>
     我们将在
     <strong>
      Debian 12 VM
     </strong>
     上进行示例。不过，如果你想在其他 Linux 发行版上通过 Journald 收集系统日志，只需稍作配置调整即可。
    </p>
    <p>
    </p>
    <h5>
     简而言之：
    </h5>
    <p>
     只需在
     <strong>
      Debian 12 VM
     </strong>
     上安装
     <strong>
      Elastic-Agent 8.17.0
     </strong>
     ，添加系统集成，你就能从
     <strong>
      Journald
     </strong>
     获取日志。如果你在
     <strong>
      Debian 11
     </strong>
     等其他发行版上安装 Elastic-Agent，它将读取日志文件。就是这么简单！
    </p>
    <p>
    </p>
    <p>
     <strong>
      详细解析：
     </strong>
    </p>
    <p>
     这并不是 “魔法”，而是对
     <strong>
      Elastic-Agent
     </strong>
     功能的巧妙利用。在进入具体操作之前，先来了解它是如何工作的。
    </p>
    <p>
     <strong>
      系统集成中的
      <code>
       syslog
      </code>
      和
      <code>
       auth
      </code>
      数据流
     </strong>
     现在新增了一个
     <strong>
      Journald
     </strong>
     输入，该输入在默认配置下
     <strong>
      仅在 Debian 12 和 Amazon Linux 2023 上运行
     </strong>
     。现有的日志输入则相反，它不会在
     <strong>
      Debian 12 和 Amazon Linux 2023
     </strong>
     上运行。
    </p>
    <p>
     Elastic-Agent
     <strong>
      集成支持条件（
     </strong>
     <a href="https://www.elastic.co/guide/en/fleet/current/dynamic-input-configuration.html#conditions" rel="nofollow" title="conditions">
      conditions
     </a>
     <strong>
      ）判断
     </strong>
     ，用于决定是否运行某个输入。例如，系统集成已经使用此功能来防止
     <strong>
      winlog
     </strong>
     输入在
     <strong>
      Linux 或 macOS
     </strong>
     上运行。现在，我们利用它来决定在不同的
     <strong>
      Linux 发行版
     </strong>
     上运行
     <strong>
      Journald 还是传统日志输入
     </strong>
     。
    </p>
    <p>
     如果查看
     <strong>
      系统集成的配置
     </strong>
     ，你会发现一个新的
     <strong>
      conditions
     </strong>
     字段，其中
     <strong>
      Journald 输入的配置
     </strong>
     类似于：
    </p>
    <pre><code class="hljs">${host.os_version} == "12 (bookworm)" or (${host.os_platform} == "amzn" and ${host.os_version} == "2023")</code></pre>
    <p>
     如果该条件的评估结果为
     <strong>
      true
     </strong>
     ，则输入将运行；否则，输入不会运行。
    </p>
    <p>
     要在不同的 Linux 发行版上运行该输入，只需编辑条件以匹配你的需求。如果将其留空，输入将始终运行。
    </p>
    <blockquote>
     <p>
      ⚠
      <strong>
       注意！
      </strong>
      如果你在同时支持
      <strong>
       传统日志文件
      </strong>
      和
      <strong>
       Journald
      </strong>
      的 Linux 发行版上同时运行
      <strong>
       日志输入
      </strong>
      和
      <strong>
       Journald 输入
      </strong>
      ，你将会
      <strong>
       产生重复数据
      </strong>
      ，系统仪表板也会显示
      <strong>
       重复的数值！
      </strong>
     </p>
    </blockquote>
    <p>
     以下是
     <strong>
      集成配置
     </strong>
     的示例：
    </p>
    <p class="img-center">
     <img alt="" height="1709" src="https://i-blog.csdnimg.cn/direct/82449ec3afa544a38acef1c04f6dbc5d.png" width="800"/>
    </p>
    <p>
     配置完成后（或接受默认设置），选择是将其添加到
     <strong>
      新策略
     </strong>
     还是
     <strong>
      现有策略
     </strong>
     ：
    </p>
    <p style="text-align:center">
     <img alt="" src="https://i-blog.csdnimg.cn/direct/c07f924bedc74cfe9019bc28aef9153f.png"/>
    </p>
    <p>
     然后点击
     <strong>
      "Save and continue"（保存并继续）
     </strong>
     ，并继续执行
     <strong>
      "Add Elastic Agent to your hosts"（将 Elastic Agent 添加到你的主机）
     </strong>
     。
    </p>
    <p style="text-align:center">
     <img alt="" src="https://i-blog.csdnimg.cn/direct/2fd2c2ccb5a64c04bdbfe84bb7acaf6a.png"/>
    </p>
    <p>
     然后按照说明使用 Linux Tar 添加代理，你需要在主机上运行以下命令：
    </p>
    <pre><code class="hljs">curl -L -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.17.0-linux-x86_64.tar.gz 
tar xzvf elastic-agent-8.17.0-linux-x86_64.tar.gz
cd elastic-agent-8.17.0-linux-x86_64
sudo ./elastic-agent install --url=https://&lt;YOUR FLEET SERVER ADDRESS&gt;:8220 --enrollment-token=&lt;YOUR ENROLMENT TOKEN&gt;</code></pre>
    <p>
     安装
     <strong>
      Elastic-Agent
     </strong>
     后，进入其 Overview 页面，你会看到
     <strong>
      Journald 输入
     </strong>
     正在运行，而
     <strong>
      日志输入
     </strong>
     （log input）不可用：
    </p>
    <p style="text-align:center">
     <img alt="" src="https://i-blog.csdnimg.cn/direct/4ed7ce8f18fb4bc7b21234f1afb8424b.png"/>
    </p>
    <p>
    </p>
    <h2>
     如何为我的主机自定义条件（ condition）？
    </h2>
    <p>
     这很简单！
     <strong>
      主机提供商（
     </strong>
     <a href="https://www.elastic.co/guide/en/fleet/current/host-provider.html" rel="nofollow" title="host provider">
      host provider
     </a>
     <strong>
      ）的文档
     </strong>
     会列出它提供的键。例如，在上面的示例中，我们使用了
     <strong>
      <code>
       host.os_version
      </code>
     </strong>
     和
     <strong>
      <code>
       host.os_platform
      </code>
     </strong>
     。
    </p>
    <p>
     如果你想检查主机实际报告的值，可以按照以下步骤操作：
    </p>
    <ol>
     <li>
      <strong>
       进入 Kibana
      </strong>
      ，依次导航到：
      <br/>
      <strong>
       Management -&gt; Fleet -&gt; Agents
      </strong>
     </li>
     <li>
      选择你的代理，然后点击
      <strong>
       "Diagnostics"
      </strong>
     </li>
     <li>
      点击
      <strong>
       "Request diagnostics .zip"
      </strong>
      请求诊断文件
     </li>
     <li>
      诊断文件生成后，
      <strong>
       下载并解压 ZIP 压缩包
      </strong>
     </li>
     <li>
      找到
      <strong>
       <code>
        variables.yml
       </code>
      </strong>
      文件
     </li>
     <li>
      在
      <strong>
       <code>
        host
       </code>
      </strong>
      键下，你可以看到主机提供商报告的所有
      <strong>
       键值对
      </strong>
      ，例如：
     </li>
    </ol>
    <pre><code class="hljs">     host:
        architecture: x86_64
        id: ad88a1859979427ea1a7c24f0ae0320a
        ip:
            - 127.0.0.1/8
            - ::1/128
        mac:
            - 08:00:27:5e:8a:a5
        name: debian12
        os_family: debian
        os_platform: debian
        os_version: 12 (bookworm)
        platform: linux</code></pre>
    <p>
    </p>
    <h2>
     <strong>
      那么独立运行的 Beats 呢？
     </strong>
    </h2>
    <p>
     很高兴你问这个问题！是的，
     <strong>
      Filebeat 也支持 Debian 12 或任何使用 Journald 的 Linux 发行版
     </strong>
     。从
     <strong>
      8.17.0
     </strong>
     版本开始，
     <strong>
      system 模块
     </strong>
     （
     <a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-module-system.html" rel="nofollow" title="system module">
      system module
     </a>
     ）就已经支持 Journald。
    </p>
    <p>
     不过，
     <strong>
      Filebeat 的配置方式略有不同
     </strong>
     ，因为它是
     <strong>
      按主机配置
     </strong>
     的，需要手动编辑配置文件。因此，你需要：
    </p>
    <ol>
     <li>
      <strong>
       启用 system 模块
      </strong>
     </li>
     <li>
      <strong>
       在 syslog 和 auth 这两个 fileset 配置中，将
       <code>
        var.use_journald
       </code>
       设置为
       <code>
        true
       </code>
      </strong>
     </li>
    </ol>
    <blockquote>
     <p>
      ⚠
      <strong>
       注意：
      </strong>
      你需要以
      <strong>
       root
      </strong>
      身份执行这些步骤，因为读取部分 Journal 日志需要
      <strong>
       root 权限
      </strong>
      。
     </p>
    </blockquote>
    <h4>
     <strong>
      操作步骤
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       下载并解压
       <code>
        tar.gz
       </code>
       包
      </strong>
     </li>
     <li>
      <strong>
       配置
       <code>
        filebeat.yml
       </code>
      </strong>
      ，填写你的
      <strong>
       Elasticsearch 和 Kibana 凭据
      </strong>
      （Kibana 凭据用于设置数据视图、仪表板等）
     </li>
     <li>
      <strong>
       确保启用了相关模块
      </strong>
      ，例如：
     </li>
    </ul>
    <pre><code class="hljs">filebeat.config.modules:
  path: ${path.config}/modules.d/*.yml
  reload.enabled: false
  reload.period: 10s</code></pre>
    <ul>
     <li>
      通过运行
      <code>
       ./filebeat test output
      </code>
      来测试与输出的连接：
     </li>
    </ul>
    <pre><code class="hljs">root@Debian12:~/filebeat-8.17.0-linux-x86_64# ./filebeat test output
elasticsearch: https://advent-calendar-deployment.elastic-cloud.com:443...
  parse url... OK
  connection...
    parse host... OK
    dns lookup... OK
    addresses: 35.235.72.223
    dial up... OK
  TLS...
    security: server's certificate chain verification is enabled
    handshake... OK
    TLS version: TLSv1.3
    dial up... OK
  talk to server... OK
  version: 8.17.0
root@Debian12:~/filebeat-8.17.0-linux-x86_64#</code></pre>
    <ul>
     <li>
      通过运行
      <code>
       ./filebeat modules enable system
      </code>
      来启用
      <strong>
       system
      </strong>
      模块：
     </li>
    </ul>
    <pre><code class="hljs">root@Debian12:~/filebeat-8.17.0-linux-x86_64# ./filebeat modules enable system
Enabled system
root@Debian12:~/filebeat-8.17.0-linux-x86_64#</code></pre>
    <ul>
     <li>
      编辑
      <code>
       ./modules.d/system.yml
      </code>
      文件以启用
      <strong>
       filesets
      </strong>
      和
      <strong>
       Journald
      </strong>
      ：
     </li>
    </ul>
    <pre><code class="hljs"># Module: system
# Docs: https://www.elastic.co/guide/en/beats/filebeat/8.x/filebeat-module-system.html
- module: system
  syslog:
    enabled: true
    var.use_journald: true
  auth:
    enabled: true
    var.use_journald: true</code></pre>
    <ul>
     <li>
      设置
      <strong>
       system
      </strong>
      模块：
     </li>
    </ul>
    <p>
     运行以下命令来设置系统模块：
    </p>
    <pre><code class="hljs">./filebeat setup --modules system
</code></pre>
    <ul>
     <li>
      启动
      <strong>
       Filebeat
      </strong>
      ：
     </li>
    </ul>
    <p>
     使用以下命令启动
     <strong>
      Filebeat
     </strong>
     ，
     <code>
      -e
     </code>
     和
     <code>
      -v
     </code>
     标志将日志输出到
     <strong>
      stderr
     </strong>
     ，并以
     <strong>
      info
     </strong>
     级别记录：
    </p>
    <pre><code class="hljs">./filebeat -e -v</code></pre>
    <ul>
     <li>
      在
      <strong>
       Kibana
      </strong>
      中查看数据：
      <ul>
       <li>
        进入
        <strong>
         "Discover"
        </strong>
        页面，选择
        <strong>
         filebeat-
        </strong>
        * 数据视图，你应该能看到包含
        <code>
         event.dataset: system.syslog
        </code>
        和
        <code>
         event.dataset: system.auth
        </code>
        的事件。
       </li>
      </ul>
     </li>
     <li>
      访问
      <strong>
       "Dashboards"
      </strong>
      ：
      <ul>
       <li>
        搜索
        <strong>
         "[Logs System]"
        </strong>
        （使用引号以过滤掉 Windows 仪表板）。
       </li>
       <li>
        所有四个仪表板都应该工作，只需确保设置适当的时间区间，默认的 15 分钟有时对某些主机来说不足够。
       </li>
      </ul>
     </li>
    </ul>
    <p>
    </p>
    <p>
     原文：
     <a href="https://discuss.elastic.co/t/dec-21st-2024-en-ingesting-syslog-and-auth-logs-from-journald-into-elastic-stack-with-elastic-agent-or-beats/371047" rel="nofollow" title="Dec 21st, 2024: [EN] Ingesting syslog and auth logs from Journald into Elastic Stack with Elastic-Agent or Beats - Advent Calendar - Discuss the Elastic Stack">
      Dec 21st, 2024: [EN] Ingesting syslog and auth logs from Journald into Elastic Stack with Elastic-Agent or Beats - Advent Calendar - Discuss the Elastic Stack
     </a>
    </p>
   </div>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f5562756e7475546f7563682f:61727469636c652f64657461696c732f313436313237363934" class_="artid" style="display:none">
 </p>
</div>


