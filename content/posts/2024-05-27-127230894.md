---
layout: post
title: "WebRTC音视频通话三整合websocket"
date: 2024-05-27 10:51:17 +0800
description: "WebRTC音视频通话（三）整合websocket_webrtc整合asr"
keywords: "webrtc整合asr"
categories: ['音视频开发进阶']
tags: ['音视频开发', '音视频', 'Websocket', 'Webrtc', 'C']
artid: "127230894"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=127230894
    alt: "WebRTC音视频通话三整合websocket"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=127230894
featuredImagePreview: https://bing.ee123.net/img/rand?artid=127230894
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     WebRTC音视频通话（三）整合websocket
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     这里只写script部分，html和
     <code>
      webrtc-util.js
     </code>
     在上一篇有
     <a class="link-info" href="https://blog.csdn.net/m0_60259116/article/details/127230338" title="https://blog.csdn.net/m0_60259116/article/details/127230338">
      https://blog.csdn.net/m0_60259116/article/details/127230338
     </a>
    </p>
    <h2>
     一、引入js
    </h2>
    <pre><code class="hljs">&lt;script src="./js/webrtc-util.js" type="text/javascript"&gt;&lt;/script&gt;
</code></pre>
    <h3>
    </h3>
    <h2>
     二、整合websocket
    </h2>
    <p>
     需要注意的是，我这里用的是手机热点，所以wss地址是我本地的IP地址。之所以这样，是因为要两台设备访问，来测试音视频通话是否成功。
    </p>
    <p>
     <strong>
      特别提醒
     </strong>
    </p>
    <p>
     1、创建SDP对象之前，
     <strong>
      必须先打开本地音视频流
     </strong>
     <br/>
     2、打开音视频流之前，
     <strong>
      必须先绑定事件
     </strong>
     （bindOnIceCandidate、bindOnTrack）
     <br/>
     3、创建
     <strong>
      用于 answer 的 SDP 对象
     </strong>
     之前，必须
     <strong>
      先保存用于 offer 的 SDP 对象
     </strong>
     。
    </p>
    <pre><code class="hljs">&lt;script&gt;
    let webSocket;
    let url = 'wss://192.168.43.94:8080/webrtc';
    // let url = 'wss://192.168.12.113:8080/webrtc';
    
    $(function () {
      webSocket = new WebSocket(url);
      webSocket.onopen = function () {
        console.log('webSocket连接创建。。。');
      }
      webSocket.onclose = function () {
      }
      webSocket.onmessage = function (event) {
        let data = {
          operation: '',
          msg: ''
        };
        
        data = JSON.parse(event.data);
        // console.log(data);
        switch (data.operation) {
          case "into":
            //加入成功
            if (data.msg == 'offer' ||
                data.msg == 'answer') {
              // 1、创建端点
              createPeerConnection();
              // 2、绑定 收集 candidate 的回调
              bindOnIceCandidate(candidate =&gt; sendMsg('send-candidate', candidate));
              // 3、绑定 获得 远程视频流 的回调
              bindOnTrack(stream =&gt; {
                console.log('获得远程视频流');
                //显示 远程视频流
                let remoteVideo = document.getElementById("remoteVideo");
                remoteVideo.srcObject = stream;
                remoteVideo.play();
              });
              console.log(data.msg + '进入成功');
              
              // 如果是 answer, 说明 offer 和 answer 都已就绪, 触发开始消息
              if (data.msg == 'answer') {
                sendMsg('start', '')
              }
            } else if (data.msg == 'none') {
              alert('房间已满');
            }
            break;
          case "start":
            // 先打开视频流, 在创建用于 offer 的 SDP 对象
            openLocalMedia(stream =&gt; {
              // 显示本地视频流
              let localVideo = document.getElementById("localVideo");
              localVideo.srcObject = stream;
              localVideo.play();
              
              createOffer(sdp =&gt; {
                console.log('创建并发送 offer')
                sendMsg('send-offer', sdp);
              });
            });
            
            break;
          case "send-offer":
            //先保存收到的 offer
            saveSdp(data.msg, () =&gt; {
              console.log('offer 保存成功');
  
  			  //再打开音视频流
              openLocalMedia(stream =&gt; {
                let localVideo = document.getElementById("localVideo");
                localVideo.srcObject = stream;
                localVideo.play();
  
            	//最后创建用于 answer 的 SDP 对象
                createAnswer(sdp =&gt; {
                  console.log('创建并发送 answer')
                  sendMsg('send-answer', sdp);
                });
              });
            });
            break;
          case "send-answer":   
            // 保存收到的 answer
            saveSdp(data.msg, () =&gt; console.log('answer 保存成功'));
            break;
          case "send-candidate":
            //用于交换 candidate
            saveIceCandidate(data.msg);
            break;
        }
      }
      webSocket.onerror = function (event) {
        console.log(event)
        console.log('webSocket连接异常。。。');
      }
    });
    
    //发送消息
    function sendMsg(operation, msg) {
      let data = {
        operation: operation,
        msg: msg
      };
      webSocket.send(JSON.stringify(data));
    }
    
    //加入房间
    $('#addRoom').click(function () {
      sendMsg('into', '');
    });
  &lt;/script&gt;
</code></pre>
    <blockquote>
     <p>
      <strong>
       <span style="background-color:#eef0f4;">
        <span style="color:#FF0000;">
         本文福利，
        </span>
        <span style="background-color:#eef0f4;">
         <span style="color:#FF0000;">
          免费领取C++音视频学习资料包、技术视频
         </span>
        </span>
        <span style="color:#FF0000;">
         ，内容包括（音视频开发，面试题，FFmpeg ，webRTC ，rtmp ，hls ，rtsp ，ffplay ，srs）
        </span>
        <span style="background-color:#eef0f4;">
         <span style="color:#FF0000;">
          ↓↓↓↓↓↓见下面↓↓文章底部点击免费领取↓↓
         </span>
        </span>
       </span>
      </strong>
     </p>
    </blockquote>
    <h3>
     三、填坑
    </h3>
    <p>
     运行后可能会遇到如下报错：
     <img alt="" height="414" src="https://i-blog.csdnimg.cn/blog_migrate/d02651b17bacd6ddacd328c0eea230bf.png" width="868"/>
    </p>
    <p>
     这一点是因为这个导致的，只要将下图中框起来的部分，将true改为false即可，不过这会导致没有声音。
     <strong>
      总的来说，这不是bug。
     </strong>
    </p>
    <p>
     <img alt="" height="607" src="https://i-blog.csdnimg.cn/blog_migrate/9fe6c6d5cee185c0c7835d42d70fbd5f.png" width="973">
     </img>
    </p>
    <p>
     最后看下效果。（隔了很久才截的图，页面布局有点不一样哈，不过核心还是一样滴）
    </p>
    <p>
     <img alt="" height="568" src="https://i-blog.csdnimg.cn/blog_migrate/b4c9462f0003311da13aa6f4f1863d06.png" width="657">
     </img>
    </p>
    <p>
     如果你对音视频开发感兴趣，觉得文章对您有帮助，别忘了点赞、收藏哦！或者对本文的一些阐述有自己的看法，有任何问题，欢迎在下方评论区讨论！
    </p>
    <blockquote>
     <p>
      <span style="background-color:#eef0f4;">
       <strong>
        <span style="color:#FF0000;">
         本文福利，
        </span>
       </strong>
       <strong>
        <span style="background-color:#eef0f4;">
         <span style="color:#FF0000;">
          免费领取C++音视频学习资料包、技术视频
         </span>
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，内容包括（音视频开发，面试题，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         FFmpeg
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         webRTC
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         rtmp
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         hls
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         rtsp
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ffplay
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ，
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         srs
        </span>
       </strong>
       <strong>
        <span style="color:#FF0000;">
         ）
        </span>
       </strong>
       <strong>
        <span style="background-color:#eef0f4;">
         <span style="color:#FF0000;">
          ↓↓↓↓↓↓
         </span>
        </span>
       </strong>
       <strong>
        <span style="background-color:#eef0f4;">
         <span style="color:#FF0000;">
          见下面↓↓文章底部点击免费领取↓↓
         </span>
        </span>
       </strong>
      </span>
     </p>
    </blockquote>
   </div>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f36303235393131362f:61727469636c652f64657461696c732f313237323330383934" class_="artid" style="display:none">
 </p>
</div>


