---
layout: post
title: "ç¬¬ä¹è¯¾å¼‚æ­¥çˆ¬è™«è¿›é˜¶aiohttpä¸å¤šçº¿ç¨‹çš„æŠ€æœ¯åšå®¢"
date: 2025-03-11 22:55:23 +0800
description: "æ·±å…¥æ¢è®¨Pythonå¼‚æ­¥çˆ¬è™«è¿›é˜¶æŠ€æœ¯ï¼Œé‡ç‚¹ä»‹ç»aiohttpä¸å¤šçº¿ç¨‹çš„ç»“åˆä½¿ç”¨ï¼Œé€šè¿‡åŒæ­¥ä¸å¼‚æ­¥è¯·æ±‚å¯¹æ¯”ã€asyncioäº‹ä»¶å¾ªç¯åŸç†ã€çº¿ç¨‹æ± ThreadPoolExecutorä»¥åŠæ€§èƒ½ä¼˜åŒ–æŠ€å·§ç­‰æ–¹é¢ï¼Œå¸®åŠ©è¯»è€…æŒæ¡é«˜æ•ˆçˆ¬è™«çš„å¼€å‘æŠ€å·§ã€‚"
keywords: "ç¬¬ä¹è¯¾ï¼šå¼‚æ­¥çˆ¬è™«è¿›é˜¶ï¼šaiohttpä¸å¤šçº¿ç¨‹çš„æŠ€æœ¯åšå®¢"
categories: ['Python']
tags: ['çˆ¬è™«', 'Python', 'Http']
artid: "146177697"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146177697
    alt: "ç¬¬ä¹è¯¾å¼‚æ­¥çˆ¬è™«è¿›é˜¶aiohttpä¸å¤šçº¿ç¨‹çš„æŠ€æœ¯åšå®¢"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146177697
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146177697
cover: https://bing.ee123.net/img/rand?artid=146177697
image: https://bing.ee123.net/img/rand?artid=146177697
img: https://bing.ee123.net/img/rand?artid=146177697
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ç¬¬ä¹è¯¾ï¼šå¼‚æ­¥çˆ¬è™«è¿›é˜¶ï¼šaiohttpä¸å¤šçº¿ç¨‹çš„æŠ€æœ¯åšå®¢
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     åœ¨Pythonçˆ¬è™«å¼€å‘ä¸­ï¼Œæ€§èƒ½ä¼˜åŒ–å§‹ç»ˆæ˜¯ä¸€ä¸ªé‡è¦çš„è¯¾é¢˜ã€‚éšç€ç½‘ç»œæ•°æ®çš„çˆ†ç‚¸å¼å¢é•¿ï¼Œä¼ ç»Ÿçš„åŒæ­¥çˆ¬è™«åœ¨é¢å¯¹å¤§é‡è¯·æ±‚æ—¶æ˜¾å¾—åŠ›ä¸ä»å¿ƒã€‚å¼‚æ­¥çˆ¬è™«å’Œå¤šçº¿ç¨‹æŠ€æœ¯åº”è¿è€Œç”Ÿï¼Œæˆä¸ºæå‡çˆ¬è™«æ€§èƒ½çš„å…³é”®æ‰‹æ®µã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨Pythonå¼‚æ­¥çˆ¬è™«è¿›é˜¶æŠ€æœ¯ï¼Œé‡ç‚¹ä»‹ç»aiohttpä¸å¤šçº¿ç¨‹çš„ç»“åˆä½¿ç”¨ï¼Œé€šè¿‡åŒæ­¥ä¸å¼‚æ­¥è¯·æ±‚å¯¹æ¯”ã€asyncioäº‹ä»¶å¾ªç¯åŸç†ã€çº¿ç¨‹æ± ThreadPoolExecutorä»¥åŠæ€§èƒ½ä¼˜åŒ–æŠ€å·§ç­‰æ–¹é¢ï¼Œå¸®åŠ©è¯»è€…æŒæ¡é«˜æ•ˆçˆ¬è™«çš„å¼€å‘æŠ€å·§ã€‚
    </p>
    <h4>
     1. åŒæ­¥ä¸å¼‚æ­¥è¯·æ±‚å¯¹æ¯”
    </h4>
    <h5>
     åŒæ­¥è¯·æ±‚
    </h5>
    <p>
     åŒæ­¥è¯·æ±‚æ˜¯æŒ‡åœ¨å‘é€è¯·æ±‚åï¼Œç¨‹åºä¼šé˜»å¡ç­‰å¾…å“åº”ï¼Œç›´åˆ°å“åº”åˆ°è¾¾åæ‰ç»§ç»­æ‰§è¡Œåç»­ä»£ç ã€‚è¿™ç§æ–¹å¼åœ¨å¤„ç†å°‘é‡è¯·æ±‚æ—¶ç®€å•ç›´è§‚ï¼Œä½†åœ¨å¤„ç†å¤§é‡è¯·æ±‚æ—¶ï¼Œä¼šå¯¼è‡´ç¨‹åºæ•ˆç‡ä½ä¸‹ï¼Œå› ä¸ºå¤§é‡æ—¶é—´è¢«æµªè´¹åœ¨ç­‰å¾…å“åº”ä¸Šã€‚
    </p>
    <pre><code class="language-python">import requests

# åŒæ­¥è¯·æ±‚æ–¹å¼
def sync_request(url):
    response = requests.get(url)
    return response.text

# åŒæ­¥è¯·æ±‚å¤šä¸ªæ¥å£
urls = ['http://example.com/1', 'http://example.com/2', 'http://example.com/3']
results = [sync_request(url) for url in urls]
print(results)</code></pre>
    <h5>
     å¼‚æ­¥è¯·æ±‚
    </h5>
    <p>
     å¼‚æ­¥è¯·æ±‚åˆ™å…è®¸ç¨‹åºåœ¨ç­‰å¾…å“åº”çš„åŒæ—¶æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œé€šè¿‡äº‹ä»¶å¾ªç¯è°ƒåº¦å¼‚æ­¥ä»»åŠ¡ï¼Œæé«˜ç¨‹åºå¹¶å‘æ€§å’Œå“åº”é€Ÿåº¦ã€‚è¿™åœ¨å¤„ç†å¤§é‡ç½‘ç»œè¯·æ±‚æ—¶å°¤ä¸ºæœ‰æ•ˆã€‚
    </p>
    <pre><code class="language-python">import asyncio
import aiohttp

urls = ['http://example.com/1', 'http://example.com/2', 'http://example.com/3']

# å®šä¹‰å¼‚æ­¥è¯·æ±‚æ–¹æ³•
async def async_request(session, url):
    async with session.get(url) as response:
        return await response.text()
 
async def main():

    # è¯·æ±‚å¤šä¸ªæ¥å£
    async with aiohttp.ClientSession() as session:
        tasks = [async_request(session, url) for url in urls]
        results = await asyncio.gather(*tasks)
        print(results)
 
asyncio.run(main())</code></pre>
    <h4>
     2. asyncioäº‹ä»¶å¾ªç¯åŸç†
    </h4>
    <h5>
     äº‹ä»¶å¾ªç¯ç®€ä»‹
    </h5>
    <p>
     äº‹ä»¶å¾ªç¯æ˜¯asyncioåº“çš„æ ¸å¿ƒç»„ä»¶ï¼Œè´Ÿè´£è°ƒåº¦å’Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ã€‚å®ƒä¸æ–­åœ°æ£€æŸ¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œå½“æœ‰ä»»åŠ¡å‡†å¤‡å¥½ï¼ˆå¦‚I/Oæ“ä½œå®Œæˆï¼‰æ—¶ï¼Œä¾¿è°ƒåº¦è¯¥ä»»åŠ¡æ‰§è¡Œã€‚äº‹ä»¶å¾ªç¯ç¡®ä¿äº†å¼‚æ­¥ä»»åŠ¡çš„é«˜æ•ˆå¹¶å‘æ‰§è¡Œã€‚
    </p>
    <h5>
     å·¥ä½œåŸç†
    </h5>
    <ul>
     <li>
      <strong>
       äº‹ä»¶é˜Ÿåˆ—ï¼š
      </strong>
      å­˜å‚¨æ‰€æœ‰å¾…å¤„ç†çš„ä»»åŠ¡å’Œäº‹ä»¶ã€‚
     </li>
     <li>
      <strong>
       è½®è¯¢æ£€æŸ¥ï¼š
      </strong>
      äº‹ä»¶å¾ªç¯ä¸æ–­æ£€æŸ¥äº‹ä»¶é˜Ÿåˆ—ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰æ–°çš„äº‹ä»¶æˆ–ä»»åŠ¡éœ€è¦å¤„ç†ã€‚
     </li>
     <li>
      <strong>
       è°ƒåº¦æ‰§è¡Œï¼š
      </strong>
      ä¸€æ—¦æœ‰ä»»åŠ¡å‡†å¤‡å¥½ï¼Œäº‹ä»¶å¾ªç¯è°ƒåº¦è¯¥ä»»åŠ¡æ‰§è¡Œã€‚
     </li>
     <li>
      <strong>
       éé˜»å¡æ‰§è¡Œï¼š
      </strong>
      å¦‚æœæŸä¸ªä»»åŠ¡éœ€è¦ç­‰å¾…ï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ï¼‰ï¼Œäº‹ä»¶å¾ªç¯ä¸ä¼šé˜»å¡ï¼Œè€Œæ˜¯ç»§ç»­å¤„ç†å…¶ä»–ä»»åŠ¡ã€‚
     </li>
    </ul>
    <h5>
     ç¤ºä¾‹ä»£ç 
    </h5>
    <pre><code class="language-python">import asyncio
 
async def task1():
    print("Task 1 å¼€å§‹")

    # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    await asyncio.sleep(2)
    print("Task 1 å®Œæˆ")
 
async def task2():
    print("Task 2 å¼€å§‹")

    # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    await asyncio.sleep(1)
    print("Task 2 å®Œæˆ")
 
async def main():
    task_1 = asyncio.create_task(task1())
    task_2 = asyncio.create_task(task2())
    await asyncio.gather(task_1, task_2)
 
asyncio.run(main())</code></pre>
    <h4>
     3. çº¿ç¨‹æ± ThreadPoolExecutor
    </h4>
    <h5>
     çº¿ç¨‹æ± ç®€ä»‹
    </h5>
    <p>
     çº¿ç¨‹æ± æ˜¯ä¸€ç§çº¿ç¨‹ç®¡ç†æŠ€æœ¯ï¼Œé€šè¿‡é¢„å…ˆåˆ›å»ºä¸€å®šæ•°é‡çš„çº¿ç¨‹å¹¶æ”¾å…¥æ± ä¸­ï¼Œå½“æœ‰ä»»åŠ¡éœ€è¦æ‰§è¡Œæ—¶ï¼Œä»æ± ä¸­å–å‡ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œä»»åŠ¡å®Œæˆåçº¿ç¨‹å½’è¿˜æ± ä¸­ã€‚è¿™å‡å°‘äº†çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€ï¼Œæé«˜äº†ç¨‹åºæ€§èƒ½ã€‚
    </p>
    <h5>
     ThreadPoolExecutorä½¿ç”¨æ–¹æ³•
    </h5>
    <pre><code class="language-python">from concurrent.futures import ThreadPoolExecutor
 
def worker(num):
    print(f"Worker {num} is working")
 
with ThreadPoolExecutor(max_workers=5) as executor:
    futures = [executor.submit(worker, i) for i in range(10)]
    for future in futures:

        # ç­‰å¾…ä»»åŠ¡å®Œæˆ
        future.result()</code></pre>
    <h5>
     ç¤ºä¾‹ä»£ç 
    </h5>
    <pre><code class="language-python">import threading
from concurrent.futures import ThreadPoolExecutor
 
def task(n):
    print(f"Task {n} executed by {threading.current_thread().name}")
 
with ThreadPoolExecutor(max_workers=3) as executor:
    executor.map(task, range(1, 11))</code></pre>
    <h4>
     4. æ€§èƒ½ä¼˜åŒ–æŠ€å·§
    </h4>
    <h5>
     å¹¶å‘è¯·æ±‚ä¼˜åŒ–
    </h5>
    <p>
     ä½¿ç”¨aiohttpå’Œasyncioå®ç°å¹¶å‘è¯·æ±‚ï¼Œå¯ä»¥æ˜¾è‘—æé«˜çˆ¬è™«æ€§èƒ½ã€‚é€šè¿‡åˆ›å»ºå¤šä¸ªå¼‚æ­¥ä»»åŠ¡å¹¶åŒæ—¶å‘é€è¯·æ±‚ï¼Œå‡å°‘ç­‰å¾…æ—¶é—´ã€‚
    </p>
    <pre><code class="language-python">import asyncio
import aiohttp
 
async def fetch(session, url):
    async with session.get(url) as response:
        return await response.text()
 
async def main():
    urls = ['http://example.com/1', 'http://example.com/2', 'http://example.com/3']
    async with aiohttp.ClientSession() as session:
        tasks = [fetch(session, url) for url in urls]
        results = await asyncio.gather(*tasks)
        print(results)
 
asyncio.run(main())</code></pre>
    <h5>
     é™åˆ¶å¹¶å‘é‡
    </h5>
    <p>
     ä½¿ç”¨asyncioçš„Semaphoreé™åˆ¶å¹¶å‘é‡ï¼Œé¿å…å¯¹ç›®æ ‡æœåŠ¡å™¨é€ æˆè¿‡å¤§å‹åŠ›ï¼ŒåŒæ—¶ä¿è¯ç¨‹åºçš„ç¨³å®šæ€§å’Œæ•ˆç‡ã€‚
    </p>
    <pre><code class="language-python">import asyncio
import aiohttp
 
CONCURRENCY = 5
semaphore = asyncio.Semaphore(CONCURRENCY)
 
async def fetch(session, url):
    async with semaphore:
        async with session.get(url) as response:
            return await response.text()
 
async def main():
    urls = ['http://example.com/1', 'http://example.com/2', 'http://example.com/3']
    async with aiohttp.ClientSession() as session:
        tasks = [fetch(session, url) for url in urls]
        results = await asyncio.gather(*tasks)
        print(results)
 
asyncio.run(main())</code></pre>
    <h5>
     å¤šçº¿ç¨‹ä¸å¼‚æ­¥ç»“åˆ
    </h5>
    <p>
     åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå¯ä»¥ç»“åˆå¤šçº¿ç¨‹å’Œå¼‚æ­¥ç¼–ç¨‹ï¼Œè¿›ä¸€æ­¥æå‡æ€§èƒ½ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¤„ç†CPUå¯†é›†å‹ä»»åŠ¡ï¼Œä½¿ç”¨å¼‚æ­¥å¤„ç†I/Oå¯†é›†å‹ä»»åŠ¡ã€‚
    </p>
    <pre><code class="language-python">import asyncio
import aiohttp
from concurrent.futures import ThreadPoolExecutor
 
def cpu_bound_task(n):
    # æ¨¡æ‹ŸCPUå¯†é›†å‹ä»»åŠ¡
    total = 0
    for i in range(n):
        total += i
    return total
 
async def io_bound_task(session, url):
    async with session.get(url) as response:
        return await response.text()
 
async def main():
    urls = ['http://example.com/1', 'http://example.com/2', 'http://example.com/3']
    with ThreadPoolExecutor(max_workers=3) as executor:
        loop = asyncio.get_running_loop()
        cpu_tasks = [loop.run_in_executor(executor, cpu_bound_task, 10**6) for _ in range(3)]
        async with aiohttp.ClientSession() as session:
            io_tasks = [io_bound_task(session, url) for url in urls]
            cpu_results = await asyncio.gather(*cpu_tasks)
            io_results = await asyncio.gather(*io_tasks)
        print(f"CPU results: {cpu_results}")
        print(f"IO results: {io_results}")
 
asyncio.run(main())</code></pre>
    <h4>
     æ€»ç»“
    </h4>
    <p>
     é€šè¿‡æœ¬æ–‡çš„ä»‹ç»ï¼Œæˆ‘ä»¬æ·±å…¥äº†è§£äº†Pythonå¼‚æ­¥çˆ¬è™«è¿›é˜¶æŠ€æœ¯ï¼ŒåŒ…æ‹¬åŒæ­¥ä¸å¼‚æ­¥è¯·æ±‚çš„å¯¹æ¯”ã€asyncioäº‹ä»¶å¾ªç¯åŸç†ã€çº¿ç¨‹æ± ThreadPoolExecutorçš„ä½¿ç”¨ä»¥åŠæ€§èƒ½ä¼˜åŒ–æŠ€å·§ã€‚é€šè¿‡ç»“åˆaiohttpå’Œå¤šçº¿ç¨‹æŠ€æœ¯ï¼Œæˆ‘ä»¬å¯ä»¥æ„å»ºé«˜æ•ˆã€ç¨³å®šçš„çˆ¬è™«ç³»ç»Ÿï¼Œæ»¡è¶³å¤§è§„æ¨¡æ•°æ®æŠ“å–çš„éœ€æ±‚ã€‚å¸Œæœ›æœ¬æ–‡èƒ½ä¸ºè¯»è€…åœ¨Pythonçˆ¬è™«å¼€å‘é“è·¯ä¸Šæä¾›ä¸€äº›æœ‰ç›Šçš„å‚è€ƒå’Œå¯å‘ã€‚
    </p>
    <p>
     <strong>
      å…³æ³¨æˆ‘ï¼ï¼ğŸ«µ
     </strong>
     æŒç»­ä¸ºä½ å¸¦æ¥Pythonç›¸å…³å†…å®¹ã€‚
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f35373137393639362f:61727469636c652f64657461696c732f313436313737363937" class_="artid" style="display:none">
 </p>
</div>


