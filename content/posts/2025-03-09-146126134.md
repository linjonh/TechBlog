---
layout: post
title: "Makefilemake工具编译STM32工程"
date: 2025-03-09 01:19:05 +0800
description: "一、变量二、隐含规则三、通配符"
keywords: "Makefile——make工具编译STM32工程"
categories: ['嵌入式学习笔记']
tags: ['Stm', 'Makefile']
artid: "146126134"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146126134
    alt: "Makefilemake工具编译STM32工程"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146126134
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146126134
cover: https://bing.ee123.net/img/rand?artid=146126134
image: https://bing.ee123.net/img/rand?artid=146126134
img: https://bing.ee123.net/img/rand?artid=146126134
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Makefile——make工具编译STM32工程
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <strong>
      一、Makefile相关指令
     </strong>
     <br/>
     <strong>
      1.1、变量
     </strong>
    </p>
    <table>
     <thead>
      <tr>
       <th>
        符号
       </th>
       <th>
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        =
       </td>
       <td>
        替换
       </td>
      </tr>
      <tr>
       <td>
        +=
       </td>
       <td>
        追加
       </td>
      </tr>
      <tr>
       <td>
        :=
       </td>
       <td>
        恒等于
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <strong>
      1.2、隐含规则
     </strong>
    </p>
    <table>
     <thead>
      <tr>
       <th>
        符号
       </th>
       <th>
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        %.o
       </td>
       <td>
        任意的.o文件
       </td>
      </tr>
      <tr>
       <td>
        *.o
       </td>
       <td>
        所有的.o文件
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <strong>
      1.3、通配符
     </strong>
    </p>
    <table>
     <thead>
      <tr>
       <th>
        符号
       </th>
       <th>
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        $^
       </td>
       <td>
        所有依赖文件
       </td>
      </tr>
      <tr>
       <td>
        $@
       </td>
       <td>
        所有目标文件
       </td>
      </tr>
      <tr>
       <td>
        $&lt;
       </td>
       <td>
        所有依赖文件的第一个文件
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <strong>
      1.4、编译器指令常用参数功能说明
     </strong>
    </p>
    <table>
     <thead>
      <tr>
       <th>
        符号
       </th>
       <th>
        含义
       </th>
       <th>
        举例
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        -E
       </td>
       <td>
        预处理，主要是进行宏展开等步骤
       </td>
       <td>
        gcc -E test.c -&gt; test.i
       </td>
      </tr>
      <tr>
       <td>
        -S
       </td>
       <td>
        编译，生成汇编代码
       </td>
       <td>
        gcc -S test.c -&gt; test.S
       </td>
      </tr>
      <tr>
       <td>
        -c
       </td>
       <td>
        汇编：生成机器码
       </td>
       <td>
        gcc -c test.c -&gt; test.o
       </td>
      </tr>
      <tr>
       <td>
        -o
       </td>
       <td>
        指定文件名
       </td>
       <td>
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     二、Makefile文件
    </p>
    <pre><code>SHELL=cmd.exe
DIR = D:\LC\EE\Code\STM32F407\TEST
OBJ = OBJ
KEIL_PATH = D:\ProgramFiles\Keil_v5\Keil\ARM\ARMCC
ARMCC   = $(KEIL_PATH)\bin\armcc
ARMASM  = $(KEIL_PATH)\bin\armasm
ARMAR   = $(KEIL_PATH)\bin\armar  
ARMLINK = $(KEIL_PATH)\bin\armlink  
FROMELF = $(KEIL_PATH)\bin\fromelf  
  
TARGET = .\$(OBJ)\TEST
# OBJMAP := .\stm32.map 
OBJHTM := .\$(OBJ)\*.htm  
OBJAXF := .\$(OBJ)\*.axf  
 

CFLAGS := -c --cpu Cortex-M4.fp.sp -g -O1 --apcs=interwork --split_sections -D__UVISION_VERSION="541" -DSTM32F407xx -DSTM32F40_41xxx
CMACRO :=  
ASMFLAGS := --cpu Cortex-M4.fp.sp -g --apcs=interwork --pd "__UVISION_VERSION SETA 541" --pd "STM32F407xx SETA 1"
LINKFLAGS := --cpu=Cortex-M4.fp.sp
MAP := --summary_stderr --info summarysizes --map --load_addr_map_info --xref --callgraph --symbols
INFO := --info sizes --info totals --info unused --info veneers

		
SOURCE = .\SYSTEM\delay\delay.c .\SYSTEM\sys\sys.c .\SYSTEM\usart\usart.c .\HARDWARE\LED\led.c .\USER\test.c
START  = .\USER\startup_stm32f40_41xxx.s

SOURCE_OBJ = $(SOURCE:%.c=%.o)
START_OBJ  = $(START:%.s=%.o)

OBJS = .\$(OBJ)\delay.o       .\$(OBJ)\sys.o     .\$(OBJ)\usart.o       .\$(OBJ)\led.o       .\$(OBJ)\test.o   .\$(OBJ)\startup_stm32f40_41xxx.o

INC +=  -I .\SYSTEM\delay -I .\SYSTEM\sys -I .\SYSTEM\usart -I .\HARDWARE\LED


TEST:$(SOURCE_OBJ) $(START_OBJ) TEST1

TEST1:$(OBJS)
	@echo $(OBJS)
	$(ARMLINK) $(LINKFLAGS) $^  --strict --scatter .\$(OBJ)\TEST.sct $(MAP) $(INFO) --list $(TARGET).map -o $(TARGET).axf
	$(FROMELF) --i32combined -o $(TARGET).hex $(TARGET).axf


%.o:%.c
	$(ARMCC) $(CFLAGS) $(INC) $(CMACRO) -D__UVISION_VERSION="541" -DSTM32F407xx -DSTM32F40_41xxx  $&lt; -o $@ 
	move $@ $(DIR)\$(OBJ)

%.o:%.s
	$(ARMASM) $(ASMFLAGS) $&lt; -o $@ 
	move $@ $(DIR)\$(OBJ)

.PHONY : clean 
clean:  
	-del $(OBJS) .\output\*.map .\output\*.htm .\output\*.axf .\output\*.hex
</code></pre>
    <p>
     <strong>
      三、STM32F407工程
     </strong>
    </p>
    <pre><code>D:.
│  Makefile
│  README
│
├─HARDWARE
│  └─LED
│          led.c
│          led.h
│
├─OBJ
│      delay.o
│      led.o
│      startup_stm32f40_41xxx.o
│      sys.o
│      TEST.axf
│      TEST.hex
│      TEST.htm
│      TEST.map
│      test.o
│      TEST.sct
│      usart.o
│
├─SYSTEM
│  │  readme.txt
│  │
│  ├─delay
│  │      delay.c
│  │      delay.h
│  │
│  ├─sys
│  │      core_cm4.h
│  │      core_cm4_simd.h
│  │      core_cmFunc.h
│  │      core_cmInstr.h
│  │      stm32f4xx.h
│  │      sys.c
│  │      sys.h
│  │      system_stm32f4xx.h
│  │
│  └─usart
│          usart.c
│          usart.h
│
└─USER
        startup_stm32f40_41xxx.s
        test.c
</code></pre>
    <p>
     <strong>
      四、STM32启动过程
     </strong>
    </p>
    <ol>
     <li>
      初始化堆栈指针 SP = _initial_sp
     </li>
     <li>
      初始化程序计数器指针 PC = Reset_Handler
     </li>
     <li>
      设置堆和栈的大小
     </li>
     <li>
      初始化中断向量表
     </li>
     <li>
      配置外部SRAM作为数据存储器（可选）
     </li>
     <li>
      配置系统时钟，通过调用SystemInit函数（可选）
     </li>
     <li>
      调用C库中的 _main 函数初始化用户堆栈，最终调用 main 函数
     </li>
    </ol>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f7a65726f5f313737383339333230362f:61727469636c652f64657461696c732f313436313236313334" class_="artid" style="display:none">
 </p>
</div>


