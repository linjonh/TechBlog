---
layout: post
title: "FFMPEG音视频同步-音视频实时采集编码封装"
date: 2025-01-21 19:20:16 +0800
description: "FFMPEG-音视频实时采集编码封装//-------------"
keywords: "ffmpeg api 视频流重编码音频流复用"
categories: ['音视频处理', 'Ffmpeg']
tags: ['无标签']
artid: "90105795"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=90105795
    alt: "FFMPEG音视频同步-音视频实时采集编码封装"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=90105795
featuredImagePreview: https://bing.ee123.net/img/rand?artid=90105795
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     FFMPEG音视频同步-音视频实时采集编码封装
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="FFMPEG_0">
     </a>
     FFMPEG音视频同步-音视频实时采集编码封装
    </h2>
    <p>
     //-------------------------------------------------------------------------------------------------
     <br/>
     参考链接1、
     <a href="https://blog.csdn.net/leixiaohua1020/article/details/39702113">
      https://blog.csdn.net/leixiaohua1020/article/details/39702113
     </a>
     <br/>
     参考链接2、
     <a href="https://blog.csdn.net/li_wen01/article/details/67631687">
      https://blog.csdn.net/li_wen01/article/details/67631687
     </a>
    </p>
    <p>
     //-------------------------------------------------------------------------------------------------
     <br/>
     音视频同步录制相关文章
     <br/>
     //-------------------------------------------------------------------------------------------------
     <br/>
     <a href="https://blog.csdn.net/quange_style/article/details/90082114">
      1、 ffmpeg-摄像头采集保存
     </a>
     <br/>
     <a href="https://blog.csdn.net/quange_style/article/details/90082391">
      2、 ffmpeg-摄像头采集编码封装
     </a>
     <br/>
     <a href="https://blog.csdn.net/quange_style/article/details/90083019">
      3、 ffmpeg-音频正弦产生并编码封装
     </a>
     <br/>
     <a href="https://blog.csdn.net/quange_style/article/details/90082748">
      4、 ffmpeg-音频实时采集保存
     </a>
     <br/>
     <a href="https://blog.csdn.net/quange_style/article/details/90083173">
      5、 ffmpeg-音频实时采集编码封装
     </a>
     <br/>
     <a href="https://blog.csdn.net/quange_style/article/details/90105795">
      <strong>
       6、 ffmpeg-音视频实时采集编码封装
      </strong>
     </a>
     <br/>
     <a href="https://blog.csdn.net/quange_style/article/details/90213300">
      7、 ffmpeg音视频同步-音视频实时采集编码推流
     </a>
     <br/>
     <a href="https://blog.csdn.net/quange_style/article/details/90213392">
      8、 ffmpeg音视频同步-音视频实时采集编码推流-优化版本
     </a>
     <br/>
     //---------------------------------------------------------------
    </p>
    <p>
     <strong>
      系统环境：
     </strong>
     <br/>
     系统版本：lubuntu 16.04
     <br/>
     Ffmpge版本：ffmpeg version N-93527-g1125277
     <br/>
     摄像头：1.3M HD WebCan
     <br/>
     虚拟机：Oracle VM VirtualBox 5.2.22
    </p>
    <p>
     指令查看设备 ffmpeg -devices
    </p>
    <p>
     本章文档基于《ffmpeg-摄像头采集编码封装》和《ffmpeg-音频实时采集编码封装》。在同一进程中，判断其产生的time=pts*time_base,根据其视频的帧率，以及音频产生的采样率等，来比较当前帧时间time，来写入音视频。
    </p>
    <h2>
     <a id="1_28">
     </a>
     1.简介
    </h2>
    <p>
     FFmpeg中有一个和多媒体设备交互的类库：Libavdevice。使用这个库可以读取电脑（或者其他设备上）的多媒体设备的数据，或者输出数据到指定的多媒体设备上。
    </p>
    <h3>
     <a id="11_31">
     </a>
     1.1数据流程图
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5a194dc073b90bf786f2e6cef9ca1648.png"/>
    </p>
    <h3>
     <a id="12__34">
     </a>
     1.2 代码流程图
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/399db40ac019f5151419ab4b14d9be04.png"/>
    </p>
    <h3>
     <a id="13__37">
     </a>
     1.3 队列传输流程图
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/667901d235a70a7d547491d89e1ba58a.png"/>
    </p>
    <h2>
     <a id="2_40">
     </a>
     2.源码
    </h2>
    <p>
     最简单的基于Libavdevice的音频采集口数据读取一帧帧pcm数据，经过音频重采样获取目标AAC的音频源数据参数，同时基于Libavdevice的视频采集口，获取yuv420数据，再经过编码，封装等，保存成FLV文件。
     <br/>
     程序主要是参考/doc/example/muxing.c源码的音视频同步方法。
    </p>
    <h3>
     <a id="21_44">
     </a>
     2.1音频初始化
    </h3>
    <pre><code class="prism language-javascript"><span class="token number">1.</span>	 int <span class="token function">open_audio_capture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token number">2.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">3.</span>	  
<span class="token number">4.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open_audio_capture\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">5.</span>	  
<span class="token number">6.</span>	<span class="token comment">//********add alsa read***********//  </span>
<span class="token number">7.</span>	    AVCodecContext  <span class="token operator">*</span>pCodecCtx<span class="token punctuation">;</span>  
<span class="token number">8.</span>	    AVCodec         <span class="token operator">*</span>pCodec<span class="token punctuation">;</span>  
<span class="token number">9.</span>	       AVFormatContext <span class="token operator">*</span>a_ifmtCtx<span class="token punctuation">;</span>  
<span class="token number">10.</span>	    int i<span class="token punctuation">,</span>ret<span class="token punctuation">;</span>  
<span class="token number">11.</span>	<span class="token comment">//Register Device  </span>
<span class="token number">12.</span>	    <span class="token function">avdevice_register_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">13.</span>	  
<span class="token number">14.</span>	    a_ifmtCtx <span class="token operator">=</span> <span class="token function">avformat_alloc_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">15.</span>	  
<span class="token number">16.</span>	  
<span class="token number">17.</span>	     <span class="token comment">//Linux  </span>
<span class="token number">18.</span>	    AVInputFormat <span class="token operator">*</span>ifmt<span class="token operator">=</span><span class="token function">av_find_input_format</span><span class="token punctuation">(</span><span class="token string">"alsa"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">19.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a_ifmtCtx<span class="token punctuation">,</span><span class="token string">"default"</span><span class="token punctuation">,</span>ifmt<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">20.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Couldn't open input stream.default\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">21.</span>	        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">22.</span>	    <span class="token punctuation">}</span>  
<span class="token number">23.</span>	   
<span class="token number">24.</span>	   
<span class="token number">25.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>a_ifmtCtx<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>  
<span class="token number">26.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">27.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Couldn't find stream information.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">28.</span>	        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">29.</span>	    <span class="token punctuation">}</span>  
<span class="token number">30.</span>	  
<span class="token number">31.</span>	    int audioindex<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">32.</span>	    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>a_ifmtCtx<span class="token operator">-</span><span class="token operator">&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>   
<span class="token number">33.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span>a_ifmtCtx<span class="token operator">-</span><span class="token operator">&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>codec<span class="token operator">-</span><span class="token operator">&gt;</span>codec_type<span class="token operator">==</span><span class="token constant">AVMEDIA_TYPE_AUDIO</span><span class="token punctuation">)</span>  
<span class="token number">34.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">35.</span>	        audioindex<span class="token operator">=</span>i<span class="token punctuation">;</span>  
<span class="token number">36.</span>	        <span class="token keyword">break</span><span class="token punctuation">;</span>  
<span class="token number">37.</span>	    <span class="token punctuation">}</span>  
<span class="token number">38.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span>audioindex<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  
<span class="token number">39.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">40.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Couldn't find a video stream.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">41.</span>	        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">42.</span>	    <span class="token punctuation">}</span>  
<span class="token number">43.</span>	          
<span class="token number">44.</span>	    pCodecCtx<span class="token operator">=</span>a_ifmtCtx<span class="token operator">-</span><span class="token operator">&gt;</span>streams<span class="token punctuation">[</span>audioindex<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>codec<span class="token punctuation">;</span>  
<span class="token number">45.</span>	    pCodec<span class="token operator">=</span><span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">46.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span>pCodec<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>  
<span class="token number">47.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">48.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Codec not found.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">49.</span>	        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">50.</span>	    <span class="token punctuation">}</span>  
<span class="token number">51.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>pCodecCtx<span class="token punctuation">,</span> pCodec<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>  
<span class="token number">52.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">53.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Could not open codec.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">54.</span>	        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">55.</span>	    <span class="token punctuation">}</span>  
<span class="token number">56.</span>	  
<span class="token number">57.</span>	    AVPacket <span class="token operator">*</span>in_packet<span class="token operator">=</span><span class="token punctuation">(</span>AVPacket <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token function">sizeof</span><span class="token punctuation">(</span>AVPacket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">58.</span>	  
<span class="token number">59.</span>	    AVFrame <span class="token operator">*</span>pAudioFrame<span class="token operator">=</span><span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">60.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token operator">==</span>pAudioFrame<span class="token punctuation">)</span>  
<span class="token number">61.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">62.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"could not alloc pAudioFrame\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">63.</span>	        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">64.</span>	    <span class="token punctuation">}</span>  
<span class="token number">65.</span>	  
<span class="token number">66.</span>	    <span class="token comment">//audio output paramter //resample   </span>
<span class="token number">67.</span>	    uint64_t out_channel_layout <span class="token operator">=</span> <span class="token constant">AV_CH_LAYOUT_STEREO</span><span class="token punctuation">;</span>  
<span class="token number">68.</span>	    int out_sample_fmt <span class="token operator">=</span> <span class="token constant">AV_SAMPLE_FMT_S16</span><span class="token punctuation">;</span>  
<span class="token number">69.</span>	    int out_nb_samples <span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment">//pCodecCtx-&gt;frame_size;  </span>
<span class="token number">70.</span>	    int out_sample_rate <span class="token operator">=</span> <span class="token number">48000</span><span class="token punctuation">;</span>  
<span class="token number">71.</span>	    int out_nb_channels <span class="token operator">=</span> <span class="token function">av_get_channel_layout_nb_channels</span><span class="token punctuation">(</span>out_channel_layout<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">72.</span>	    int out_buffer_size <span class="token operator">=</span> <span class="token function">av_samples_get_buffer_size</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> out_nb_channels<span class="token punctuation">,</span> out_nb_samples<span class="token punctuation">,</span> out_sample_fmt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token number">73.</span>	    uint8_t <span class="token operator">*</span>dst_buffer<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>    
<span class="token number">74.</span>	    dst_buffer <span class="token operator">=</span> <span class="token punctuation">(</span>uint8_t <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token constant">MAX_AUDIO_FRAME_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token number">75.</span>	    int64_t in_channel_layout <span class="token operator">=</span> <span class="token function">av_get_default_channel_layout</span><span class="token punctuation">(</span>pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token number">76.</span>	  
<span class="token number">77.</span>	  
<span class="token number">78.</span>	    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"audio sample_fmt=%d size=%d channel=%d  sample_rate=%d in_channel_layout=%s\n"</span><span class="token punctuation">,</span>  
<span class="token number">79.</span>	        pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>sample_fmt<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>frame_size<span class="token punctuation">,</span>  
<span class="token number">80.</span>	        pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>channels<span class="token punctuation">,</span>pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>sample_rate<span class="token punctuation">,</span><span class="token function">av_ts2str</span><span class="token punctuation">(</span>in_channel_layout<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">81.</span>	  
<span class="token number">82.</span>	    struct SwrContext   <span class="token operator">*</span>audio_convert_ctx <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    
<span class="token number">83.</span>	    audio_convert_ctx <span class="token operator">=</span> <span class="token function">swr_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token number">84.</span>	    <span class="token keyword">if</span> <span class="token punctuation">(</span>audio_convert_ctx <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>    
<span class="token number">85.</span>	    <span class="token punctuation">{<!-- --></span>    
<span class="token number">86.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Could not allocate SwrContext\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
<span class="token number">87.</span>	        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>    
<span class="token number">88.</span>	    <span class="token punctuation">}</span>    
<span class="token number">89.</span>	  
<span class="token number">90.</span>	      <span class="token comment">/* set options */</span>  
<span class="token number">91.</span>	        <span class="token function">av_opt_set_int</span>       <span class="token punctuation">(</span>audio_convert_ctx<span class="token punctuation">,</span> <span class="token string">"in_channel_count"</span><span class="token punctuation">,</span>   pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>channels<span class="token punctuation">,</span>       <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">92.</span>	        <span class="token function">av_opt_set_int</span>       <span class="token punctuation">(</span>audio_convert_ctx<span class="token punctuation">,</span> <span class="token string">"in_sample_rate"</span><span class="token punctuation">,</span>     pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>sample_rate<span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">93.</span>	        <span class="token function">av_opt_set_sample_fmt</span><span class="token punctuation">(</span>audio_convert_ctx<span class="token punctuation">,</span> <span class="token string">"in_sample_fmt"</span><span class="token punctuation">,</span>      pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>sample_fmt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">94.</span>	        <span class="token function">av_opt_set_int</span>       <span class="token punctuation">(</span>audio_convert_ctx<span class="token punctuation">,</span> <span class="token string">"out_channel_count"</span><span class="token punctuation">,</span>  out_nb_channels<span class="token punctuation">,</span>       <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">95.</span>	        <span class="token function">av_opt_set_int</span>       <span class="token punctuation">(</span>audio_convert_ctx<span class="token punctuation">,</span> <span class="token string">"out_sample_rate"</span><span class="token punctuation">,</span>   out_sample_rate<span class="token punctuation">,</span>    <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">96.</span>	        <span class="token function">av_opt_set_sample_fmt</span><span class="token punctuation">(</span>audio_convert_ctx<span class="token punctuation">,</span> <span class="token string">"out_sample_fmt"</span><span class="token punctuation">,</span>     out_sample_fmt<span class="token punctuation">,</span>     <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">97.</span>	  
<span class="token number">98.</span>	        <span class="token comment">/* initialize the resampling context */</span>  
<span class="token number">99.</span>	        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">swr_init</span><span class="token punctuation">(</span>audio_convert_ctx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">100.</span>	            <span class="token function">fprintf</span><span class="token punctuation">(</span>stderr<span class="token punctuation">,</span> <span class="token string">"Failed to initialize the resampling context\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">101.</span>	            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">102.</span>	        <span class="token punctuation">}</span>  
<span class="token number">103.</span>	  
<span class="token number">104.</span>	  
<span class="token number">105.</span>	    alsa_input<span class="token punctuation">.</span>in_packet<span class="token operator">=</span>in_packet<span class="token punctuation">;</span>  
<span class="token number">106.</span>	    alsa_input<span class="token punctuation">.</span>pCodecCtx<span class="token operator">=</span>pCodecCtx<span class="token punctuation">;</span>  
<span class="token number">107.</span>	    alsa_input<span class="token punctuation">.</span>pCodec<span class="token operator">=</span>pCodec<span class="token punctuation">;</span>  
<span class="token number">108.</span>	       alsa_input<span class="token punctuation">.</span>a_ifmtCtx<span class="token operator">=</span>a_ifmtCtx<span class="token punctuation">;</span>  
<span class="token number">109.</span>	    alsa_input<span class="token punctuation">.</span>audioindex<span class="token operator">=</span>audioindex<span class="token punctuation">;</span>  
<span class="token number">110.</span>	    alsa_input<span class="token punctuation">.</span>pAudioFrame<span class="token operator">=</span>pAudioFrame<span class="token punctuation">;</span>  
<span class="token number">111.</span>	    alsa_input<span class="token punctuation">.</span>audio_convert_ctx<span class="token operator">=</span>audio_convert_ctx<span class="token punctuation">;</span>  
<span class="token number">112.</span>	    alsa_input<span class="token punctuation">.</span>dst_buffer<span class="token operator">=</span>dst_buffer<span class="token punctuation">;</span>  
<span class="token number">113.</span>	    alsa_input<span class="token punctuation">.</span>out_buffer_size<span class="token operator">=</span>out_buffer_size<span class="token punctuation">;</span>  
<span class="token number">114.</span>	    alsa_input<span class="token punctuation">.</span>bCap<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">115.</span>	   
<span class="token number">116.</span>	<span class="token comment">//******************************//  </span>
<span class="token number">117.</span>	<span class="token punctuation">}</span>  

</code></pre>
    <h3>
     <a id="22__166">
     </a>
     2.2 视频初始化
    </h3>
    <pre><code class="prism language-javascript"><span class="token number">1.</span>	int <span class="token function">open_video_capture</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  
<span class="token number">2.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">3.</span>	    int i<span class="token punctuation">,</span>ret<span class="token punctuation">;</span>  
<span class="token number">4.</span>	    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open_video_capture\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">5.</span>	  
<span class="token number">6.</span>	<span class="token comment">//********add camera read***********//  </span>
<span class="token number">7.</span>	    AVCodecContext  <span class="token operator">*</span>pCodecCtx<span class="token punctuation">;</span>  
<span class="token number">8.</span>	    AVCodec         <span class="token operator">*</span>pCodec<span class="token punctuation">;</span>  
<span class="token number">9.</span>	       AVFormatContext <span class="token operator">*</span>v_ifmtCtx<span class="token punctuation">;</span>  
<span class="token number">10.</span>	  
<span class="token number">11.</span>	<span class="token comment">//Register Device  </span>
<span class="token number">12.</span>	    <span class="token function">avdevice_register_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">13.</span>	  
<span class="token number">14.</span>	    v_ifmtCtx <span class="token operator">=</span> <span class="token function">avformat_alloc_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">15.</span>	  
<span class="token number">16.</span>	  
<span class="token number">17.</span>	     <span class="token comment">//Linux  </span>
<span class="token number">18.</span>	    AVInputFormat <span class="token operator">*</span>ifmt<span class="token operator">=</span><span class="token function">av_find_input_format</span><span class="token punctuation">(</span><span class="token string">"video4linux2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">19.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>v_ifmtCtx<span class="token punctuation">,</span><span class="token string">"/dev/video0"</span><span class="token punctuation">,</span>ifmt<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  
<span class="token number">20.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Couldn't open input stream./dev/video0\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">21.</span>	        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">22.</span>	    <span class="token punctuation">}</span>  
<span class="token number">23.</span>	   
<span class="token number">24.</span>	   
<span class="token number">25.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>v_ifmtCtx<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>  
<span class="token number">26.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">27.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Couldn't find stream information.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">28.</span>	        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">29.</span>	    <span class="token punctuation">}</span>  
<span class="token number">30.</span>	  
<span class="token number">31.</span>	    int videoindex<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">32.</span>	    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>v_ifmtCtx<span class="token operator">-</span><span class="token operator">&gt;</span>nb_streams<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>   
<span class="token number">33.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span>v_ifmtCtx<span class="token operator">-</span><span class="token operator">&gt;</span>streams<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>codec<span class="token operator">-</span><span class="token operator">&gt;</span>codec_type<span class="token operator">==</span><span class="token constant">AVMEDIA_TYPE_VIDEO</span><span class="token punctuation">)</span>  
<span class="token number">34.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">35.</span>	        videoindex<span class="token operator">=</span>i<span class="token punctuation">;</span>  
<span class="token number">36.</span>	        <span class="token keyword">break</span><span class="token punctuation">;</span>  
<span class="token number">37.</span>	    <span class="token punctuation">}</span>  
<span class="token number">38.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span>videoindex<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  
<span class="token number">39.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">40.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Couldn't find a video stream.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">41.</span>	        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">42.</span>	    <span class="token punctuation">}</span>  
<span class="token number">43.</span>	          
<span class="token number">44.</span>	    pCodecCtx<span class="token operator">=</span>v_ifmtCtx<span class="token operator">-</span><span class="token operator">&gt;</span>streams<span class="token punctuation">[</span>videoindex<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span>codec<span class="token punctuation">;</span>  
<span class="token number">45.</span>	    pCodec<span class="token operator">=</span><span class="token function">avcodec_find_decoder</span><span class="token punctuation">(</span>pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">46.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span>pCodec<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>  
<span class="token number">47.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">48.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Codec not found.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">49.</span>	        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">50.</span>	    <span class="token punctuation">}</span>  
<span class="token number">51.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">avcodec_open2</span><span class="token punctuation">(</span>pCodecCtx<span class="token punctuation">,</span> pCodec<span class="token punctuation">,</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>  
<span class="token number">52.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">53.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Could not open codec.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">54.</span>	        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">55.</span>	    <span class="token punctuation">}</span>  
<span class="token number">56.</span>	  
<span class="token number">57.</span>	    AVFrame <span class="token operator">*</span>pFrame<span class="token punctuation">,</span><span class="token operator">*</span>pFrameYUV<span class="token punctuation">;</span>  
<span class="token number">58.</span>	    pFrame<span class="token operator">=</span><span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">59.</span>	    pFrameYUV<span class="token operator">=</span><span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">60.</span>	    unsigned char <span class="token operator">*</span>out_buffer<span class="token operator">=</span><span class="token punctuation">(</span>unsigned char <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token function">avpicture_get_size</span><span class="token punctuation">(</span><span class="token constant">AV_PIX_FMT_YUV420P</span><span class="token punctuation">,</span> pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>width<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">61.</span>	    <span class="token function">avpicture_fill</span><span class="token punctuation">(</span><span class="token punctuation">(</span>AVPicture <span class="token operator">*</span><span class="token punctuation">)</span>pFrameYUV<span class="token punctuation">,</span> out_buffer<span class="token punctuation">,</span> <span class="token constant">AV_PIX_FMT_YUV420P</span><span class="token punctuation">,</span> pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>width<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">62.</span>	  
<span class="token number">63.</span>	    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"camera width=%d height=%d \n"</span><span class="token punctuation">,</span>pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>width<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">64.</span>	  
<span class="token number">65.</span>	  
<span class="token number">66.</span>	    struct SwsContext <span class="token operator">*</span>img_convert_ctx<span class="token punctuation">;</span>  
<span class="token number">67.</span>	    img_convert_ctx <span class="token operator">=</span> <span class="token function">sws_getContext</span><span class="token punctuation">(</span>pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>width<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>height<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>pix_fmt<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>width<span class="token punctuation">,</span> pCodecCtx<span class="token operator">-</span><span class="token operator">&gt;</span>height<span class="token punctuation">,</span> <span class="token constant">AV_PIX_FMT_YUV420P</span><span class="token punctuation">,</span> <span class="token constant">SWS_BICUBIC</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token number">68.</span>	    AVPacket <span class="token operator">*</span>in_packet<span class="token operator">=</span><span class="token punctuation">(</span>AVPacket <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">av_malloc</span><span class="token punctuation">(</span><span class="token function">sizeof</span><span class="token punctuation">(</span>AVPacket<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">69.</span>	  
<span class="token number">70.</span>	  
<span class="token number">71.</span>	    video_input<span class="token punctuation">.</span>img_convert_ctx<span class="token operator">=</span>img_convert_ctx<span class="token punctuation">;</span>  
<span class="token number">72.</span>	    video_input<span class="token punctuation">.</span>in_packet<span class="token operator">=</span>in_packet<span class="token punctuation">;</span>  
<span class="token number">73.</span>	  
<span class="token number">74.</span>	    video_input<span class="token punctuation">.</span>pCodecCtx<span class="token operator">=</span>pCodecCtx<span class="token punctuation">;</span>  
<span class="token number">75.</span>	    video_input<span class="token punctuation">.</span>pCodec<span class="token operator">=</span>pCodec<span class="token punctuation">;</span>  
<span class="token number">76.</span>	       video_input<span class="token punctuation">.</span>v_ifmtCtx<span class="token operator">=</span>v_ifmtCtx<span class="token punctuation">;</span>  
<span class="token number">77.</span>	    video_input<span class="token punctuation">.</span>videoindex<span class="token operator">=</span>videoindex<span class="token punctuation">;</span>  
<span class="token number">78.</span>	    video_input<span class="token punctuation">.</span>pFrame<span class="token operator">=</span>pFrame<span class="token punctuation">;</span>  
<span class="token number">79.</span>	    video_input<span class="token punctuation">.</span>pFrameYUV<span class="token operator">=</span>pFrameYUV<span class="token punctuation">;</span>  
<span class="token number">80.</span>	    video_input<span class="token punctuation">.</span>bCap<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">81.</span>	  
<span class="token number">82.</span>	<span class="token comment">//******************************//  </span>
<span class="token number">83.</span>	<span class="token punctuation">}</span>  

</code></pre>
    <h3>
     <a id="23_254">
     </a>
     2.3输出初始化
    </h3>
    <pre><code class="prism language-javascript"><span class="token number">1.</span>	int <span class="token function">open_output</span><span class="token punctuation">(</span>    <span class="token keyword">const</span> char <span class="token operator">*</span>filename<span class="token punctuation">,</span>AVDictionary <span class="token operator">*</span>opt<span class="token punctuation">)</span>  
<span class="token number">2.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">3.</span>	  
<span class="token number">4.</span>	    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open_output\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">5.</span>	    <span class="token keyword">static</span>  OutputStream video_st <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> audio_st <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  
<span class="token number">6.</span>	  
<span class="token number">7.</span>	    AVOutputFormat <span class="token operator">*</span>fmt<span class="token punctuation">;</span>  
<span class="token number">8.</span>	    AVFormatContext <span class="token operator">*</span>oc<span class="token punctuation">;</span>  
<span class="token number">9.</span>	    AVCodec <span class="token operator">*</span>audio_codec<span class="token punctuation">,</span> <span class="token operator">*</span>video_codec<span class="token punctuation">;</span>  
<span class="token number">10.</span>	    int ret<span class="token punctuation">;</span>  
<span class="token number">11.</span>	    int have_video <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> have_audio <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">12.</span>	    int encode_video <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> encode_audio <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">13.</span>	  
<span class="token number">14.</span>	      
<span class="token number">15.</span>	       <span class="token comment">/* allocate the output media context */</span>  
<span class="token number">16.</span>	    <span class="token function">avformat_alloc_output_context2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oc<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">17.</span>	    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">18.</span>	        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Could not deduce output format from file extension: using MPEG.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">19.</span>	        <span class="token function">avformat_alloc_output_context2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oc<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"mpeg"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">20.</span>	    <span class="token punctuation">}</span>  
<span class="token number">21.</span>	    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>oc<span class="token punctuation">)</span>  
<span class="token number">22.</span>	        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">23.</span>	  
<span class="token number">24.</span>	     fmt <span class="token operator">=</span> oc<span class="token operator">-</span><span class="token operator">&gt;</span>oformat<span class="token punctuation">;</span>  
<span class="token number">25.</span>	  
<span class="token number">26.</span>	    <span class="token comment">/* Add the audio and video streams using the default format codecs 
27.	     * and initialize the codecs. */</span>  
<span class="token number">28.</span>	    <span class="token keyword">if</span> <span class="token punctuation">(</span>fmt<span class="token operator">-</span><span class="token operator">&gt;</span>video_codec <span class="token operator">!=</span> <span class="token constant">AV_CODEC_ID_NONE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">29.</span>	        <span class="token function">add_stream</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>video_st<span class="token punctuation">,</span> oc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>video_codec<span class="token punctuation">,</span> fmt<span class="token operator">-</span><span class="token operator">&gt;</span>video_codec<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">30.</span>	        have_video <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">31.</span>	        encode_video <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">32.</span>	    <span class="token punctuation">}</span>  
<span class="token number">33.</span>	    <span class="token keyword">if</span> <span class="token punctuation">(</span>fmt<span class="token operator">-</span><span class="token operator">&gt;</span>audio_codec <span class="token operator">!=</span> <span class="token constant">AV_CODEC_ID_NONE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">34.</span>	        <span class="token function">add_stream</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>audio_st<span class="token punctuation">,</span> oc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>audio_codec<span class="token punctuation">,</span> <span class="token constant">AV_CODEC_ID_AAC</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//fmt-&gt;audio_codec);  </span>
<span class="token number">35.</span>	        have_audio <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">36.</span>	        encode_audio <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">37.</span>	    <span class="token punctuation">}</span>  
<span class="token number">38.</span>	  
<span class="token number">39.</span>	    <span class="token comment">/* Now that all the parameters are set, we can open the audio and 
40.	     * video codecs and allocate the necessary encode buffers. */</span>  
<span class="token number">41.</span>	    <span class="token keyword">if</span> <span class="token punctuation">(</span>have_video<span class="token punctuation">)</span>  
<span class="token number">42.</span>	        <span class="token function">open_video</span><span class="token punctuation">(</span>oc<span class="token punctuation">,</span> video_codec<span class="token punctuation">,</span> <span class="token operator">&amp;</span>video_st<span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">43.</span>	  
<span class="token number">44.</span>	    <span class="token keyword">if</span> <span class="token punctuation">(</span>have_audio<span class="token punctuation">)</span>  
<span class="token number">45.</span>	        <span class="token function">open_audio</span><span class="token punctuation">(</span>oc<span class="token punctuation">,</span> audio_codec<span class="token punctuation">,</span> <span class="token operator">&amp;</span>audio_st<span class="token punctuation">,</span> opt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">46.</span>	  
<span class="token number">47.</span>	    <span class="token function">av_dump_format</span><span class="token punctuation">(</span>oc<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">48.</span>	  
<span class="token number">49.</span>	    <span class="token comment">/* open the output file, if needed */</span>  
<span class="token number">50.</span>	    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>fmt<span class="token operator">-</span><span class="token operator">&gt;</span>flags <span class="token operator">&amp;</span> <span class="token constant">AVFMT_NOFILE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">51.</span>	        ret <span class="token operator">=</span> <span class="token function">avio_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>oc<span class="token operator">-</span><span class="token operator">&gt;</span>pb<span class="token punctuation">,</span> filename<span class="token punctuation">,</span> <span class="token constant">AVIO_FLAG_WRITE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">52.</span>	        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">53.</span>	            <span class="token function">fprintf</span><span class="token punctuation">(</span>stderr<span class="token punctuation">,</span> <span class="token string">"Could not open '%s': %s\n"</span><span class="token punctuation">,</span> filename<span class="token punctuation">,</span>  
<span class="token number">54.</span>	                    <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">55.</span>	            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">56.</span>	        <span class="token punctuation">}</span>  
<span class="token number">57.</span>	    <span class="token punctuation">}</span>  
<span class="token number">58.</span>	  
<span class="token number">59.</span>	    <span class="token comment">/* Write the stream header, if any. */</span>  
<span class="token number">60.</span>	    ret <span class="token operator">=</span> <span class="token function">avformat_write_header</span><span class="token punctuation">(</span>oc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>opt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">61.</span>	    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
<span class="token number">62.</span>	        <span class="token function">fprintf</span><span class="token punctuation">(</span>stderr<span class="token punctuation">,</span> <span class="token string">"Error occurred when opening output file: %s\n"</span><span class="token punctuation">,</span>  
<span class="token number">63.</span>	                <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">64.</span>	        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  
<span class="token number">65.</span>	    <span class="token punctuation">}</span>  
<span class="token number">66.</span>	  
<span class="token number">67.</span>	  
<span class="token number">68.</span>	    output_dev<span class="token punctuation">.</span>encode_audio<span class="token operator">=</span>encode_audio<span class="token punctuation">;</span>  
<span class="token number">69.</span>	    output_dev<span class="token punctuation">.</span>encode_video<span class="token operator">=</span>encode_video<span class="token punctuation">;</span>  
<span class="token number">70.</span>	    output_dev<span class="token punctuation">.</span>oc<span class="token operator">=</span>oc<span class="token punctuation">;</span>  
<span class="token number">71.</span>	    output_dev<span class="token punctuation">.</span>have_audio<span class="token operator">=</span>have_audio<span class="token punctuation">;</span>  
<span class="token number">72.</span>	    output_dev<span class="token punctuation">.</span>have_video<span class="token operator">=</span>have_video<span class="token punctuation">;</span>  
<span class="token number">73.</span>	    output_dev<span class="token punctuation">.</span>video_st<span class="token operator">=</span><span class="token operator">&amp;</span>video_st<span class="token punctuation">;</span>  
<span class="token number">74.</span>	    output_dev<span class="token punctuation">.</span>audio_st<span class="token operator">=</span><span class="token operator">&amp;</span>audio_st<span class="token punctuation">;</span>  
<span class="token number">75.</span>	  
<span class="token number">76.</span>	<span class="token punctuation">}</span>  

</code></pre>
    <h3>
     <a id="24_335">
     </a>
     2.4音频采集线程
    </h3>
    <pre><code class="prism language-javascript"><span class="token number">1.</span>	int <span class="token function">audioThreadProc</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>  
<span class="token number">2.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">3.</span>	    int got_pic<span class="token punctuation">;</span>  
<span class="token number">4.</span>	    <span class="token keyword">while</span><span class="token punctuation">(</span>alsa_input<span class="token punctuation">.</span>bCap<span class="token punctuation">)</span>  
<span class="token number">5.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">6.</span>	  
<span class="token number">7.</span>	        <span class="token comment">//printf("audioThreadProc running\n");  </span>
<span class="token number">8.</span>	  
<span class="token number">9.</span>	        AVPacket <span class="token operator">*</span>pkt<span class="token operator">=</span><span class="token function">get_audio_pkt</span><span class="token punctuation">(</span>output_dev<span class="token punctuation">.</span>audio_st<span class="token punctuation">,</span><span class="token operator">&amp;</span>alsa_input<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">10.</span>	        <span class="token keyword">if</span><span class="token punctuation">(</span>pkt<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>  <span class="token comment">//从alsa中获取pkt音频源数据包</span>
<span class="token number">11.</span>	        <span class="token punctuation">{<!-- --></span>  
<span class="token number">12.</span>	            alsa_input<span class="token punctuation">.</span>bCap <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">13.</span>	  
<span class="token number">14.</span>	        <span class="token punctuation">}</span>  
<span class="token number">15.</span>	        <span class="token keyword">else</span>  
<span class="token number">16.</span>	        <span class="token punctuation">{<!-- --></span>  
<span class="token number">17.</span>	            <span class="token function">packet_queue_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>output_dev<span class="token punctuation">.</span>audioq<span class="token punctuation">,</span>pkt<span class="token punctuation">,</span>output_dev<span class="token punctuation">.</span>audio_st<span class="token operator">-</span><span class="token operator">&gt;</span>next_pts<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将获取的数据包发送到传输队列当中</span>
<span class="token number">18.</span>	        <span class="token punctuation">}</span>  
<span class="token number">19.</span>	  
<span class="token number">20.</span>	  
<span class="token number">21.</span>	    <span class="token punctuation">}</span>  
<span class="token number">22.</span>	  
<span class="token number">23.</span>	    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"videoThreadProc exit\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">24.</span>	    <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">25.</span>	    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">26.</span>	      
<span class="token number">27.</span>	<span class="token punctuation">}</span>  

</code></pre>
    <h3>
     <a id="25_367">
     </a>
     2.5视频采集线程
    </h3>
    <pre><code class="prism language-javascript"><span class="token number">1.</span>	int <span class="token function">videoThreadProc</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>  
<span class="token number">2.</span>	<span class="token punctuation">{<!-- --></span>  
<span class="token number">3.</span>	    int got_pic<span class="token punctuation">;</span>  
<span class="token number">4.</span>	    <span class="token keyword">while</span><span class="token punctuation">(</span>video_input<span class="token punctuation">.</span>bCap<span class="token punctuation">)</span>  
<span class="token number">5.</span>	    <span class="token punctuation">{<!-- --></span>  
<span class="token number">6.</span>	  
<span class="token number">7.</span>	  
<span class="token number">8.</span>	        AVPacket <span class="token operator">*</span> pkt<span class="token operator">=</span><span class="token function">get_video_pkt</span><span class="token punctuation">(</span>output_dev<span class="token punctuation">.</span>video_st<span class="token punctuation">,</span><span class="token operator">&amp;</span>video_input<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">9.</span>	  		<span class="token comment">//从V4L中获取视频源数据包pkt</span>
<span class="token number">10.</span>	        <span class="token keyword">if</span><span class="token punctuation">(</span>pkt<span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span>  
<span class="token number">11.</span>	        <span class="token punctuation">{<!-- --></span>  
<span class="token number">12.</span>	            <span class="token comment">//packet_queue_put_nullpacket(&amp;output_dev.videoq,0);  </span>
<span class="token number">13.</span>	            video_input<span class="token punctuation">.</span>bCap <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">14.</span>	  
<span class="token number">15.</span>	        <span class="token punctuation">}</span>  
<span class="token number">16.</span>	        <span class="token keyword">else</span>  
<span class="token number">17.</span>	        <span class="token punctuation">{<!-- --></span>  
<span class="token number">18.</span>	            <span class="token function">packet_queue_put</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>output_dev<span class="token punctuation">.</span>videoq<span class="token punctuation">,</span>pkt<span class="token punctuation">,</span>output_dev<span class="token punctuation">.</span>video_st<span class="token operator">-</span><span class="token operator">&gt;</span>next_pts<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//将获取到的数据包发送到视频传输队列中</span>
<span class="token number">19.</span>	        <span class="token punctuation">}</span>  
<span class="token number">20.</span>	  
<span class="token number">21.</span>	  
<span class="token number">22.</span>	   
<span class="token number">23.</span>	    <span class="token punctuation">}</span>  
<span class="token number">24.</span>	  
<span class="token number">25.</span>	    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"videoThreadProc exit\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">26.</span>	    <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">27.</span>	    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token number">28.</span>	      
<span class="token number">29.</span>	<span class="token punctuation">}</span> 

</code></pre>
    <h3>
     <a id="26_401">
     </a>
     2.6主进程
    </h3>
    <pre><code class="prism language-javascript"><span class="token number">1.</span>	 <span class="token keyword">while</span> <span class="token punctuation">(</span>output_dev<span class="token punctuation">.</span>encode_video <span class="token operator">||</span> output_dev<span class="token punctuation">.</span>encode_audio<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">//判断进程是否退出  </span>
<span class="token number">2.</span>	    <span class="token keyword">if</span> <span class="token punctuation">(</span>output_dev<span class="token punctuation">.</span>encode_video <span class="token operator">&amp;&amp;</span>  
<span class="token number">3.</span>	        <span class="token punctuation">(</span><span class="token operator">!</span>output_dev<span class="token punctuation">.</span>encode_audio <span class="token operator">||</span> <span class="token function">av_compare_ts</span><span class="token punctuation">(</span>frame_pts<span class="token punctuation">,</span> output_dev<span class="token punctuation">.</span>video_st<span class="token operator">-</span><span class="token operator">&gt;</span>enc<span class="token operator">-</span><span class="token operator">&gt;</span>time_base<span class="token punctuation">,</span>  
<span class="token number">4.</span>	                frame_audio_pts<span class="token punctuation">,</span> output_dev<span class="token punctuation">.</span>audio_st<span class="token operator">-</span><span class="token operator">&gt;</span>enc<span class="token operator">-</span><span class="token operator">&gt;</span>time_base<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//比较音频视频产生是的pts* time_base大小，以音频pts*times_base为基准，若视频的pts*time_base小于音频，则写入视频帧，否则写入音频帧 </span>
<span class="token number">5.</span>	           <span class="token punctuation">{<!-- --></span>  
<span class="token number">6.</span>	    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">packet_queue_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>output_dev<span class="token punctuation">.</span>videoq<span class="token punctuation">,</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>frame_pts<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//获取队列中的视频pkt</span>
<span class="token number">7.</span>	            <span class="token punctuation">{<!-- --></span>  
<span class="token number">8.</span>	                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"packet_queue_get Error.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">9.</span>	                <span class="token keyword">break</span><span class="token punctuation">;</span>  
<span class="token number">10.</span>	            <span class="token punctuation">}</span>  
<span class="token number">11.</span>	  
<span class="token number">12.</span>	            <span class="token keyword">if</span><span class="token punctuation">(</span>flush_pkt<span class="token punctuation">.</span>data<span class="token operator">==</span> pkt<span class="token punctuation">.</span>data<span class="token punctuation">)</span>  
<span class="token number">13.</span>	            <span class="token punctuation">{<!-- --></span>  
<span class="token number">14.</span>	                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get pkt flush_pkt\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">15.</span>	                <span class="token keyword">continue</span><span class="token punctuation">;</span>  
<span class="token number">16.</span>	            <span class="token punctuation">}</span>  
<span class="token number">17.</span>	  
<span class="token number">18.</span>	  
<span class="token number">19.</span>	              vframe<span class="token operator">=</span><span class="token function">get_video_pkt2Frame</span><span class="token punctuation">(</span>output_dev<span class="token punctuation">.</span>video_st<span class="token punctuation">,</span><span class="token operator">&amp;</span>video_input<span class="token punctuation">,</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">,</span><span class="token operator">&amp;</span>got_pic<span class="token punctuation">,</span>frame_pts<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//解码pkt 成frame</span>
<span class="token number">20.</span>	            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>got_pic<span class="token punctuation">)</span>  
<span class="token number">21.</span>	            <span class="token punctuation">{<!-- --></span>  
<span class="token number">22.</span>	                <span class="token function">av_free_packet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">23.</span>	                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get_video_pkt2Frame error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">24.</span>	                <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">25.</span>	                <span class="token keyword">continue</span><span class="token punctuation">;</span>  
<span class="token number">26.</span>	            <span class="token punctuation">}</span>  
<span class="token number">27.</span>	            <span class="token function">av_free_packet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>             
<span class="token number">28.</span>	  
<span class="token number">29.</span>	<span class="token constant">WRITE_FRAME</span><span class="token punctuation">:</span>  
<span class="token number">30.</span>	            output_dev<span class="token punctuation">.</span>encode_video <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">write_video_frame1</span><span class="token punctuation">(</span>output_dev<span class="token punctuation">.</span>oc<span class="token punctuation">,</span> output_dev<span class="token punctuation">.</span>video_st<span class="token punctuation">,</span>vframe<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//编码frame成pkt,并且写入封装</span>
<span class="token number">31.</span>	            <span class="token comment">//usleep(300000);  </span>
<span class="token number">32.</span>	        <span class="token punctuation">}</span>  
<span class="token number">33.</span>	        <span class="token keyword">else</span><span class="token comment">//audio  </span>
<span class="token number">34.</span>	        <span class="token punctuation">{<!-- --></span><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">packet_queue_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>output_dev<span class="token punctuation">.</span>audioq<span class="token punctuation">,</span><span class="token operator">&amp;</span>audio_pkt<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>frame_audio_pts<span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment">//获取队列中的音频pkt</span>
<span class="token number">35.</span>	
<span class="token number">36.</span>	            <span class="token punctuation">{<!-- --></span>  
<span class="token number">37.</span>	                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"packet_queue_get Error.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">38.</span>	                <span class="token keyword">break</span><span class="token punctuation">;</span>  
<span class="token number">39.</span>	            <span class="token punctuation">}</span>  
<span class="token number">40.</span>	  
<span class="token number">41.</span>	            <span class="token keyword">if</span><span class="token punctuation">(</span>flush_pkt<span class="token punctuation">.</span>data<span class="token operator">==</span> audio_pkt<span class="token punctuation">.</span>data<span class="token punctuation">)</span>  
<span class="token number">42.</span>	            <span class="token punctuation">{<!-- --></span>  
<span class="token number">43.</span>	                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get pkt flush_pkt\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">44.</span>	                <span class="token keyword">continue</span><span class="token punctuation">;</span>  
<span class="token number">45.</span>	            <span class="token punctuation">}</span>  
<span class="token number">46.</span>	            <span class="token comment">//av_free_packet(&amp;audio_pkt);             </span>
<span class="token number">47.</span>	  
<span class="token number">48.</span>	#<span class="token keyword">if</span> <span class="token number">1</span>  
<span class="token number">49.</span>	  
<span class="token number">50.</span>	  
<span class="token number">51.</span>	              aframe<span class="token operator">=</span><span class="token function">get_audio_pkt2Frame</span><span class="token punctuation">(</span>output_dev<span class="token punctuation">.</span>audio_st<span class="token punctuation">,</span><span class="token operator">&amp;</span>alsa_input<span class="token punctuation">,</span><span class="token operator">&amp;</span>audio_pkt<span class="token punctuation">,</span><span class="token operator">&amp;</span>got_pcm<span class="token punctuation">,</span>frame_audio_pts<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//解码pkt 成frame</span>
<span class="token number">52.</span>	            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>got_pcm<span class="token punctuation">)</span>  
<span class="token number">53.</span>	            <span class="token punctuation">{<!-- --></span>  
<span class="token number">54.</span>	                <span class="token function">av_free_packet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>audio_pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">55.</span>	                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"get_video_pkt2Frame error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">56.</span>	                <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
<span class="token number">57.</span>	                <span class="token keyword">continue</span><span class="token punctuation">;</span>  
<span class="token number">58.</span>	            <span class="token punctuation">}</span>  
<span class="token number">59.</span>	            <span class="token function">av_free_packet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>audio_pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>           
<span class="token number">60.</span>	  
<span class="token number">61.</span>	<span class="token constant">WRITE_AUDIO_FRAME</span><span class="token punctuation">:</span>  
<span class="token number">62.</span>	            output_dev<span class="token punctuation">.</span>encode_audio <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">write_audio_frame1</span><span class="token punctuation">(</span>output_dev<span class="token punctuation">.</span>oc<span class="token punctuation">,</span> output_dev<span class="token punctuation">.</span>audio_st<span class="token punctuation">,</span>aframe<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//编码frame成pkt,并且写入封装</span>
<span class="token number">63.</span>	
<span class="token number">64.</span>	            <span class="token comment">//usleep(300000);  </span>
<span class="token number">65.</span>	#endif  
<span class="token number">66.</span>	    <span class="token punctuation">}</span>  
<span class="token number">67.</span>	  
<span class="token number">68.</span>	          
<span class="token number">69.</span>	  
<span class="token number">70.</span>	  
<span class="token number">71.</span>	    <span class="token punctuation">}</span>  

</code></pre>
    <h2>
     <a id="3_477">
     </a>
     3.验证
    </h2>
    <h3>
     <a id="31_479">
     </a>
     3.1编译
    </h3>
    <pre><code class="prism language-javascript"><span class="token number">1.</span>	#<span class="token operator">!</span><span class="token operator">/</span>bin<span class="token operator">/</span>sh  
<span class="token number">2.</span>	<span class="token constant">CC</span><span class="token operator">=</span>gcc  
<span class="token number">3.</span>	<span class="token constant">SRCS</span><span class="token operator">=</span><span class="token function">$</span><span class="token punctuation">(</span>wildcard <span class="token operator">*</span><span class="token punctuation">.</span>c <span class="token operator">*</span><span class="token comment">/*.c)  
4.	OBJS=$(patsubst %.c, %.o, $(SRCS))  
5.	FLAG=-g  
6.	#LIB=-lavutil -lavformat -lavcodec -lavutil -lswscale -lswresample -lSDL2  
7.	  
8.	  
9.	  
10.	LIB=-lSDL2 -lSDLmain  -I/usr/include/SDL -D_GNU_SOURCE=1 -D_REENTRANT -L/usr/lib/i386-linux-gnu -lSDL -I./\  
11.	    -I/home/quange/ffmpeg_build/include -L/home/quange/ffmpeg_build/lib -L/usr/local/lib -L/home/quange/ffmpeg_build/lib -lavcodec -lvpx -lm -lpthread -lvpx -lm -lpthread -lvpx -lm -lpthread -lvpx -lm -lpthread -pthread -lm -lz -lfdk-aac -lm -lmp3lame -lm -lopus -lm -lvorbis -lm -logg -lvorbisenc -lvorbis -lm -logg -lx264 -lpthread -lm -ldl -lx265 -lstdc++ -lm -lrt -ldl -lnuma -lswresample -lm -lavutil -pthread -lm -lXv -lX11 -lXext \  
12.	    -I/home/quange/ffmpeg_build/include -L/home/quange/ffmpeg_build/lib -L/usr/local/lib -L/home/quange/ffmpeg_build/lib -lavdevice -lm -lxcb -lXau -lXdmcp -lxcb-shape -lxcb -lXau -lXdmcp -lxcb-xfixes -lxcb-render -lxcb-shape -lxcb -lXau -lXdmcp -lasound -lm -ldl -lpthread -lrt -lSDL2 -Wl,--no-undefined -lm -ldl -lasound -lm -ldl -lpthread -lpulse-simple -lpulse -lsndio -lX11 -lXext -lXcursor -lXinerama -lXi -lXrandr -lXss -lXxf86vm -lwayland-egl -lwayland-client -lwayland-cursor -lxkbcommon -lpthread -lrt -lsndio -lXv -lX11 -lXext -lavfilter -pthread -lm -lfreetype -lz -lpng12 -lz -lm -lswscale -lm -lpostproc -lm -lavformat -lm -lz -lavcodec -lvpx -lm -lpthread -lvpx -lm -lpthread -lvpx -lm -lpthread -lvpx -lm -lpthread -pthread -lm -lz -lfdk-aac -lm -lmp3lame -lm -lopus -lm -lvorbis -lm -logg -lvorbisenc -lvorbis -lm -logg -lx264 -lpthread -lm -ldl -lx265 -lstdc++ -lm -lrt -ldl -lnuma -lswresample -lm -lavutil -pthread -lm -lXv -lX11 -lXext \  
13.	    -I/home/quange/ffmpeg_build/include -L/home/quange/ffmpeg_build/lib -L/usr/local/lib -L/home/quange/ffmpeg_build/lib -lavformat -lm -lz -lavcodec -lvpx -lm -lpthread -lvpx -lm -lpthread -lvpx -lm -lpthread -lvpx -lm -lpthread -pthread -lm -lz -lfdk-aac -lm -lmp3lame -lm -lopus -lm -lvorbis -lm -logg -lvorbisenc -lvorbis -lm -logg -lx264 -lpthread -lm -ldl -lx265 -lstdc++ -lm -lrt -ldl -lnuma -lswresample -lm -lavutil -pthread -lm -lXv -lX11 -lXext \  
14.	    -I/home/quange/ffmpeg_build/include -L/home/quange/ffmpeg_build/lib -L/usr/local/lib -L/home/quange/ffmpeg_build/lib -lavformat -lm -lz -lavcodec -lvpx -lm -lpthread -lvpx -lm -lpthread -lvpx -lm -lpthread -lvpx -lm -lpthread -pthread -lm -lz -lfdk-aac -lm -lmp3lame -lm -lopus -lm -lvorbis -lm -logg -lvorbisenc -lvorbis -lm -logg -lx264 -lpthread -lm -ldl -lx265 -lstdc++ -lm -lrt -ldl -lnuma -lswresample -lm -lavutil -pthread -lm -lXv -lX11 -lXext \  
15.	    -I/home/quange/ffmpeg_build/include -L/home/quange/ffmpeg_build/lib -lswscale -lm -lavutil -pthread -lm -lXv -lX11 -lXext \  
16.	      
17.	      
18.	      
19.	      
20.	      
21.	NAME=$(wildcard *.c)  
22.	TARGET=av_record  
23.	  
24.	$(TARGET):$(OBJS)  
25.	    
26.	    $(CC) $(FLAG) -o $@ $^  $(LIB)  
27.	    
28.	  
29.	%.o:%.c  
30.	    $(CC) $(FLAG) -c -o $@ $^ $(LIB)  
31.	  
32.	   
33.	  
34.	clean:  
35.	    rm -rf $(TARGET) $(OBJS)

</span></code></pre>
    <h3>
     <a id="32_519">
     </a>
     3.2结果
    </h3>
    <p>
     使用VLC打开test.flv,可以看到录制的实时音视频,音视频延时维持在200ms以内，更精确的有待测试优化。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/65c41d40d85976b81e3145b895c2fd97.png"/>
    </p>
    <h3>
     <a id="33_522">
     </a>
     3.3存在的问题
    </h3>
    <p>
     无
    </p>
    <h3>
     <a id="36__525">
     </a>
     3.6 思考
    </h3>
    <p>
     1、问：为啥不讲音视频数据的采集，编码，封装放在同一个进程里？
     <br/>
     答：
     <br/>
     1）、由于音视频的编码耗时比较久（特别是视频），所有操作都放在同一个进程里面，会影响到数据的采集，造成音频，视频数据采集丢失。
     <br/>
     2）、由于音视频在写入封装时，需要比较音频与视频的pts*time_base,若视频的实时时间小于音频，则获取音频写入封装频，否则获取视频写入封装；这样的判断方法，或影响到音频和视频的采集，造成大部分数据丢失。
    </p>
    <p>
     2、关于设备前端采集数据速度思考：
     <br/>
     一开始，我是将前端数据采集，获取视频帧frame，视频帧编码成pkt等三个步骤放在采集线程里，然后再发送数据到队列，主进程再获取队列中的pkt，直接写入封装。但是，考虑到视频编码耗时较久，会影响到数据采集，所以还是直接单线程运行获取数据，最大限度保证数据的采集。
    </p>
    <p>
     3、关于不同封装，编码数据的pts问题
     <br/>
     这方面的相关在《ffmpeg-摄像头采集编码封装》中有详细的讲解。总的来说pts*time_base的值在flv,mp4,ts等容器中，值都是一样的。不同的表现在编码生成的pts与编码器时基（1/frame_rate）,流时基有关。
    </p>
    <p>
     4、关于摄像头实时采集帧率与编码器设定的帧率关系？
     <br/>
     在本例中，摄像头采集的帧率为20帧，而由于将编码器时基设为（1/25）,就会录制下来的视频要比实际上跑的快（ps:10s的视频从采集手机屏幕5s开始，播放结束后，显示20s）。主要是因为录制下来每帧间隔为（1/25）,而实际摄像头是（1/20）。同样一秒的数据，写到封装里只有0.8s的数据。所以10s录制的视频，显示的是15s的时间。这问题，编码器时基改为实际帧率即可。
     <br/>
     指令ffmpeg -f video4linux2 -s 640*480 -i /dev/video0 -f flv test.flv可以显示实时帧率
    </p>
    <h2>
     <a id="4_541">
     </a>
     4.附件
    </h2>
    <p>
     无
    </p>
    <h2>
     <a id="5_544">
     </a>
     5.参考资料
    </h2>
    <p>
     [1] ffmpeg之PCM转AAC
     <br/>
     <a href="https://blog.csdn.net/mengzhengjie/article/details/78919067">
      https://blog.csdn.net/mengzhengjie/article/details/78919067
     </a>
    </p>
    <p>
     [2]官方Encode pcm file to aac
     <br/>
     <a href="http://ffmpeg.org/pipermail/ffmpeg-user/2014-January/019268.html" rel="nofollow">
      http://ffmpeg.org/pipermail/ffmpeg-user/2014-January/019268.html
     </a>
    </p>
    <p>
     [3]PCM编码AAC,参考其普通PCM格式与AAC转格式差异
     <a href="https://blog.csdn.net/mengzhengjie/article/details/78919067">
      https://blog.csdn.net/mengzhengjie/article/details/78919067
     </a>
    </p>
    <p>
     [4]
     <a href="https://cloud.tencent.com/developer/article/1194003" rel="nofollow">
      https://cloud.tencent.com/developer/article/1194003
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f7175616e67655f7374796c65:2f61727469636c652f64657461696c732f3930313035373935" class_="artid" style="display:none">
 </p>
</div>


