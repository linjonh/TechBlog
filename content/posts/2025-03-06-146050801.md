---
layout: post
title: "C20-协程异步编程的演进"
date: 2025-03-06 00:00:00 +0800
description: "协程是一种支持暂停和恢复的函数，允许在执行过程中将控制权交还给调用者，并在适当时候继续执行。co_await：暂停协程，等待异步操作完成。co_yield：生成值并暂停，适用于序列生成等场景。co_return：指定协程的返回值并结束执行。与线程不同，协程在用户态管理上下文切换，避免了内核态的开销，因而适用于高并发、低延迟的场景。"
keywords: "C++20 协程：异步编程的演进"
categories: ['C']
tags: ['服务器', 'Java', 'C']
artid: "146050801"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146050801
    alt: "C20-协程异步编程的演进"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146050801
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146050801
cover: https://bing.ee123.net/img/rand?artid=146050801
image: https://bing.ee123.net/img/rand?artid=146050801
img: https://bing.ee123.net/img/rand?artid=146050801
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     C++20 协程：异步编程的演进
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/img_convert/69a0b0293f0992c810ac930f25f1cde7.png"/>
    </p>
    <p>
    </p>
    <br/>
    C++20 引入的协程（Coroutines）为异步编程和并发任务提供了一种新的范式。与传统线程模型相比，协程以更低的切换开销和更直观的代码结构优化了资源密集型任务的处理。本文将探讨协程的机制、核心组件及其在现代 C++ 中的应用。
    <p>
    </p>
    <h3>
     <a id="_5">
     </a>
     协程机制概述
    </h3>
    <p>
     协程是一种支持暂停和恢复的函数，允许在执行过程中将控制权交还给调用者，并在适当时候继续执行。其核心特性通过以下关键字实现：
    </p>
    <ul>
     <li>
      <code>
       co_await
      </code>
      ：暂停协程，等待异步操作完成。
     </li>
     <li>
      <code>
       co_yield
      </code>
      ：生成值并暂停，适用于序列生成等场景。
     </li>
     <li>
      <code>
       co_return
      </code>
      ：指定协程的返回值并结束执行。
     </li>
    </ul>
    <p>
     与线程不同，协程在用户态管理上下文切换，避免了内核态的开销，因而适用于高并发、低延迟的场景。
    </p>
    <h3>
     <a id="_14">
     </a>
     核心组件剖析
    </h3>
    <h4>
     <a id="1_Promise__16">
     </a>
     1. Promise 类型
    </h4>
    <p>
     <code>
      promise_type
     </code>
     是协程的控制中枢，定义了协程的行为和状态。自定义
     <code>
      promise_type
     </code>
     需实现以下方法：
    </p>
    <ul>
     <li>
      <code>
       get_return_object()
      </code>
      ：构造协程的返回对象。
     </li>
     <li>
      <code>
       initial_suspend()
      </code>
      和
      <code>
       final_suspend()
      </code>
      ：分别决定协程在开始和结束时的暂停策略（
      <code>
       std::suspend_always
      </code>
      或
      <code>
       std::suspend_never
      </code>
      ）。
     </li>
     <li>
      <code>
       return_void()
      </code>
      或
      <code>
       return_value()
      </code>
      ：处理返回值逻辑。
     </li>
     <li>
      可选的
      <code>
       yield_value()
      </code>
      ：支持
      <code>
       co_yield
      </code>
      的值生成。
     </li>
    </ul>
    <h4>
     <a id="2__23">
     </a>
     2. 协程句柄
    </h4>
    <p>
     <code>
      std::coroutine_handle&lt;T&gt;
     </code>
     是协程的运行时接口，提供恢复（
     <code>
      resume()
     </code>
     ）、销毁（
     <code>
      destroy()
     </code>
     ）和状态查询（
     <code>
      done()
     </code>
     ）等功能。它通常由
     <code>
      promise_type
     </code>
     的
     <code>
      get_return_object()
     </code>
     返回。
    </p>
    <h4>
     <a id="3_Awaitable__26">
     </a>
     3. Awaitable 接口
    </h4>
    <p>
     <code>
      co_await
     </code>
     操作的对象需满足
     <code>
      Awaitable
     </code>
     要求，通常包含：
    </p>
    <ul>
     <li>
      <code>
       await_ready()
      </code>
      ：返回
      <code>
       bool
      </code>
      ，决定是否立即暂停。
     </li>
     <li>
      <code>
       await_suspend()
      </code>
      ：接受协程句柄，执行暂停逻辑。
     </li>
     <li>
      <code>
       await_resume()
      </code>
      ：返回恢复后的结果。
     </li>
    </ul>
    <p>
     这些组件共同构成了协程的灵活性和可扩展性。
    </p>
    <h3>
     <a id="_34">
     </a>
     典型应用场景
    </h3>
    <h4>
     <a id="_IO_36">
     </a>
     异步 I/O
    </h4>
    <p>
     协程通过
     <code>
      co_await
     </code>
     将网络请求或文件操作的等待过程封装为同步风格的代码，避免回调嵌套或线程池管理的复杂性。
    </p>
    <h4>
     <a id="_39">
     </a>
     序列生成
    </h4>
    <p>
     使用
     <code>
      co_yield
     </code>
     ，协程可按需生成数据序列，例如迭代器或流式计算，节省内存并提升响应性。
    </p>
    <h4>
     <a id="_42">
     </a>
     任务调度
    </h4>
    <p>
     协程的轻量切换特性使其适于实现用户态调度器，在事件循环或协程池中高效分配任务。
    </p>
    <h3>
     <a id="_45">
     </a>
     实现示例
    </h3>
    <h4>
     <a id="_1_47">
     </a>
     示例 1：基本协程
    </h4>
    <p>
     以下代码展示了一个简单的协程，演示
     <code>
      co_await
     </code>
     的暂停行为：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;coroutine&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">Task</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">promise_type</span> <span class="token punctuation">{<!-- --></span>
        Task <span class="token function">get_return_object</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>suspend_never <span class="token function">initial_suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>suspend_never <span class="token function">final_suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">return_void</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">unhandled_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> std<span class="token double-colon punctuation">::</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Task <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Start\n"</span><span class="token punctuation">;</span>
    <span class="token keyword">co_await</span> std<span class="token double-colon punctuation">::</span>suspend_always<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 显式暂停</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Resume\n"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> h <span class="token operator">=</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回协程句柄</span>
    <span class="token keyword">auto</span> handle <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token class-name">coroutine_handle</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">from_promise</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">;</span>
    handle<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 手动恢复</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     说明：
     <code>
      suspend_always
     </code>
     强制暂停，需通过句柄手动恢复。
     <code>
      suspend_never
     </code>
     表示立即执行。
    </p>
    <h4>
     <a id="_2_78">
     </a>
     示例 2：生成器
    </h4>
    <p>
     以下实现了一个整数序列生成器：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;coroutine&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">Generator</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">promise_type</span> <span class="token punctuation">{<!-- --></span>
        T value<span class="token punctuation">;</span>
        Generator <span class="token function">get_return_object</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>std<span class="token double-colon punctuation">::</span><span class="token class-name">coroutine_handle</span><span class="token operator">&lt;</span>promise_type<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">from_promise</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>suspend_always <span class="token function">initial_suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>suspend_always <span class="token function">final_suspend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">return_void</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">unhandled_exception</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> std<span class="token double-colon punctuation">::</span><span class="token function">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        std<span class="token double-colon punctuation">::</span>suspend_always <span class="token function">yield_value</span><span class="token punctuation">(</span>T val<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> value <span class="token operator">=</span> val<span class="token punctuation">;</span> <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>coroutine_handle<span class="token operator">&lt;</span>promise_type<span class="token operator">&gt;</span> handle<span class="token punctuation">;</span>
    <span class="token function">Generator</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>coroutine_handle<span class="token operator">&lt;</span>promise_type<span class="token operator">&gt;</span> h<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">handle</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">Generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> <span class="token punctuation">(</span>handle<span class="token punctuation">)</span> handle<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    T <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> handle<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">return</span> handle<span class="token punctuation">.</span><span class="token function">promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">bool</span> <span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> handle<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

Generator<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">range</span><span class="token punctuation">(</span><span class="token keyword">int</span> start<span class="token punctuation">,</span> <span class="token keyword">int</span> count<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> start <span class="token operator">+</span> count<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token keyword">co_yield</span> i<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> gen <span class="token operator">=</span> <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>gen<span class="token punctuation">.</span><span class="token function">done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> gen<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     说明：
     <code>
      co_yield
     </code>
     将值存储到
     <code>
      promise_type::value
     </code>
     ，每次
     <code>
      resume()
     </code>
     生成一个新值。
    </p>
    <h3>
     <a id="_119">
     </a>
     评估与展望
    </h3>
    <p>
     C++20 协程显著降低了异步编程的复杂度，尤其在高并发场景下，其性能优于线程模型。然而，其实现依赖复杂的模板元编程，调试和优化仍具挑战性。此外，标准库对协程的支持尚不完善，实际应用需结合第三方库（如
     <code>
      cppcoro
     </code>
     ）或自定义基础设施。
    </p>
    <p>
     未来，随着编译器支持的完善和生态的发展，协程有望在网络服务、实时应用和嵌入式系统中发挥更大作用。开发者应关注其与现有工具的集成，以及在性能敏感场景下的调优策略。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f5a5f6f696f69686f69692f:61727469636c652f64657461696c732f313436303530383031" class_="artid" style="display:none">
 </p>
</div>


