---
layout: post
title: "K8S中的etcd数据库备份与恢复"
date: 2025-03-11 10:57:20 +0800
description: "如何备份和恢复 **etcd** 数据？ "
keywords: "K8S中的etcd数据库备份与恢复"
categories: ['运维']
tags: ['运维', 'Kubernetes']
artid: "146173140"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146173140
    alt: "K8S中的etcd数据库备份与恢复"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146173140
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146173140
cover: https://bing.ee123.net/img/rand?artid=146173140
image: https://bing.ee123.net/img/rand?artid=146173140
img: https://bing.ee123.net/img/rand?artid=146173140
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     K8S中的etcd数据库备份与恢复
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     备份和恢复
     <strong>
      etcd
     </strong>
     数据是维护 Kubernetes 集群稳定性的关键操作。以下是详细步骤：
    </p>
    <hr/>
    <h4>
     <strong>
      一、备份 etcd 数据
     </strong>
    </h4>
    <h5>
     方法 1: 使用
     <code>
      etcdctl snapshot save
     </code>
    </h5>
    <ol>
     <li>
      <p>
       <strong>
        连接到 etcd 节点
       </strong>
       确保操作在 etcd 所在节点或能访问 etcd 的客户端进行。
      </p>
     </li>
     <li>
      <p>
       <strong>
        设置环境变量
       </strong>
       根据集群配置，设置证书和端点（如果是 kubeadm 部署，证书通常在
       <code>
        /etc/kubernetes/pki/etcd
       </code>
       ）：
      </p>
      <pre>export ETCDCTL_API=3
ETCD_ENDPOINTS="https://127.0.0.1:2379"
CERT_DIR="/etc/kubernetes/pki/etcd"</pre>
     </li>
     <li>
      <p>
       <strong>
        执行备份
       </strong>
       使用
       <code>
        etcdctl
       </code>
       创建快照（替换
       <code>
        snapshot.db
       </code>
       为备份文件名）：
      </p>
      <pre>etcdctl --endpoints=$ETCD_ENDPOINTS \
        --cacert=$CERT_DIR/ca.crt \
        --cert=$CERT_DIR/healthcheck-client.crt \
        --key=$CERT_DIR/healthcheck-client.key \
        snapshot save snapshot.db</pre>
      <ul>
       <li>
        <p>
         输出
         <code>
          Snapshot saved at snapshot.db
         </code>
         表示成功。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        验证备份完整性
       </strong>
      </p>
      <pre>etcdctl --write-out=table snapshot status snapshot.db</pre>
     </li>
    </ol>
    <h5>
     方法 2: 直接备份数据目录
    </h5>
    <ul>
     <li>
      <p>
       复制 etcd 数据目录（默认为
       <code>
        /var/lib/etcd
       </code>
       ）到安全位置：
      </p>
      <pre>cp -r /var/lib/etcd /backup/etcd-backup</pre>
     </li>
    </ul>
    <hr/>
    <h4>
     <strong>
      二、恢复 etcd 数据
     </strong>
    </h4>
    <h5>
     前提条件
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        停止 etcd 服务
       </strong>
       ：恢复前需停止所有 etcd 实例。
      </p>
     </li>
     <li>
      <p>
       <strong>
        备份当前数据
       </strong>
       ：防止恢复失败导致数据丢失。
      </p>
     </li>
    </ul>
    <h5>
     恢复步骤
    </h5>
    <ol>
     <li>
      <p>
       <strong>
        停止 Kubernetes 组件
       </strong>
      </p>
      <ul>
       <li>
        <p>
         停止 kube-apiserver 和 etcd：
        </p>
        <pre>systemctl stop kube-apiserver etcd</pre>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        删除旧数据
       </strong>
      </p>
      <pre>rm -rf /var/lib/etcd/*</pre>
     </li>
     <li>
      <p>
       <strong>
        使用快照恢复
       </strong>
      </p>
      <pre>ETCD_ENDPOINTS="https://127.0.0.1:2379"
CERT_DIR="/etc/kubernetes/pki/etcd"
​
etcdctl snapshot restore snapshot.db \
  --name=etcd-node1 \                # 节点名称（与原有配置一致）
  --initial-cluster="etcd-node1=https://10.0.0.1:2380" \
  --initial-cluster-token=etcd-cluster \
  --initial-advertise-peer-urls=https://10.0.0.1:2380 \
  --data-dir=/var/lib/etcd</pre>
      <ul>
       <li>
        <p>
         根据集群拓扑调整
         <code>
          --initial-cluster
         </code>
         和
         <code>
          --initial-advertise-peer-urls
         </code>
         。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        恢复数据目录权限
       </strong>
      </p>
      <pre>chown -R etcd:etcd /var/lib/etcd</pre>
     </li>
     <li>
      <p>
       <strong>
        重启 etcd 和 Kubernetes 服务
       </strong>
      </p>
      <pre>systemctl start etcd kube-apiserver</pre>
     </li>
     <li>
      <p>
       <strong>
        验证恢复结果
       </strong>
      </p>
      <ul>
       <li>
        <p>
         检查 etcd 集群健康状态：
        </p>
        <pre>etcdctl --endpoints=$ETCD_ENDPOINTS \
        --cacert=$CERT_DIR/ca.crt \
        --cert=$CERT_DIR/healthcheck-client.crt \
        --key=$CERT_DIR/healthcheck-client.key \
        endpoint health</pre>
       </li>
       <li>
        <p>
         检查 Kubernetes 资源：
        </p>
        <pre>kubectl get pods --all-namespaces</pre>
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h4>
     <strong>
      三、注意事项
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        集群环境恢复
       </strong>
      </p>
      <ul>
       <li>
        <p>
         如果是多节点 etcd 集群，需在所有节点执行类似操作，并确保
         <code>
          --initial-cluster
         </code>
         配置正确。
        </p>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        定时备份
       </strong>
      </p>
      <ul>
       <li>
        <p>
         建议通过 CronJob 定期备份，例如：
        </p>
        <pre>0 * * * * /usr/local/bin/etcd-backup-script.sh</pre>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        测试恢复流程
       </strong>
      </p>
      <ul>
       <li>
        <p>
         定期在测试环境中演练恢复流程，确保备份有效。
        </p>
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h4>
     <strong>
      四、常见问题
     </strong>
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        证书路径错误
       </strong>
       ：检查
       <code>
        --cacert
       </code>
       、
       <code>
        --cert
       </code>
       、
       <code>
        --key
       </code>
       参数是否正确。
      </p>
     </li>
     <li>
      <p>
       <strong>
        权限问题
       </strong>
       ：确保恢复后的数据目录属主是
       <code>
        etcd
       </code>
       用户。
      </p>
     </li>
     <li>
      <p>
       <strong>
        集群无法启动
       </strong>
       ：检查日志
       <code>
        journalctl -u etcd
       </code>
       排查配置错误。
      </p>
     </li>
    </ul>
    <p>
     通过以上步骤，可以安全地备份和恢复 etcd 数据，保障 Kubernetes 集群的稳定性。
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f626c747975323030302f:61727469636c652f64657461696c732f313436313733313430" class_="artid" style="display:none">
 </p>
</div>


