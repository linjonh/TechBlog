---
layout: post
title: "文件上传安全"
date: 2025-03-11 17:44:47 +0800
description: "此关有后缀白名单验证,但是验证方法在前端处理,解题方法关闭浏览器Javascript。该设置在右上角...中------>Cookie 和网站权限--------->JavaScript中关闭。考虑用 Burp Suite抓包修改后缀即可成功。"
keywords: "文件上传安全"
categories: ['未分类']
tags: ['安全']
artid: "146121520"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146121520
    alt: "文件上传安全"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146121520
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146121520
cover: https://bing.ee123.net/img/rand?artid=146121520
image: https://bing.ee123.net/img/rand?artid=146121520
img: https://bing.ee123.net/img/rand?artid=146121520
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     文件上传安全
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h2>
     uplabs靶场
    </h2>
    <h3>
     Pass1--前端验证
    </h3>
    <p>
     此关有后缀白名单验证,但是验证方法在前端处理,解题方法关闭浏览器Javascript。该设置在右上角...中------&gt;Cookie 和网站权限---------&gt;JavaScript中关闭。
    </p>
    <p>
     <img alt="" height="925" src="https://i-blog.csdnimg.cn/direct/33265c8b9f134d8f95801ac7e92f6d4b.png" width="1852"/>
    </p>
    <p>
     考虑用 Burp Suite抓包修改后缀即可成功。
    </p>
    <p>
     <img alt="" height="1000" src="https://i-blog.csdnimg.cn/direct/aa4041ed01bc4b4cacb9e2d6484296c0.png" width="1224"/>
    </p>
    <h3>
     Pass2-content-type
    </h3>
    <p>
     本关检测数据包头部里的content-tupe字段是否在白名单里，把抓到的包里的该字段改为白名单里的 image/jpeg即可。
    </p>
    <p>
     <img alt="" height="1000" src="https://i-blog.csdnimg.cn/direct/23d8e216c2fc4be8a7fa94f3ab5927b2.png" width="1224"/>
    </p>
    <h3>
     Pass3---黑名单
    </h3>
    <p>
     黑名单不允许上传这四种后缀的文件，那上传其他后缀的即可。这种方法生成的文件是随机名称文件，该如何访问呢？
    </p>
    <pre><code class="language-php"> $deny_ext = array('.asp','.aspx','.php','.jsp');</code></pre>
    <h3>
     <img alt="" height="1000" src="https://i-blog.csdnimg.cn/direct/0195cf4f2f9048ff8655e73a3b262e21.png" width="1224"/>
    </h3>
    <h3>
     Pass4---黑名单
    </h3>
    <p>
     此关黑名单过滤了更多的后缀，但是漏掉了.htaccess文件，这个文件会在Apache或者nginx的网站目录下自动生成，功能是里面存有的指令可以作用于该目录和子目录下的所有文件。
    </p>
    <pre><code class="language-php">php
&lt;FilesMatch "test.jpg"&gt;
  SetHandler application/x-httpd-php
&lt;/FilesMatch&gt;  //将该目录以及子目录下的test.jpg当作php文件执行</code></pre>
    <p>
     编写该文件上传后再上传带有恶意代码的test.jpg文件
    </p>
    <p>
     访问有问题，看起来文件没有生效。
    </p>
    <p>
     <img alt="" height="1029" src="https://i-blog.csdnimg.cn/direct/3454371202ef471fbabe24e3713238e1.png" width="1920"/>
    </p>
    <p>
     重启Nginx没有用，文件都上传成功。
    </p>
    <p>
     <img alt="" height="644" src="https://i-blog.csdnimg.cn/direct/3d791c0f7e704d54abeeadff4c7e84f2.png" width="1030"/>
    </p>
    <p>
     检查.htaccess文件内容：
    </p>
    <p>
     <img alt="" height="824" src="https://i-blog.csdnimg.cn/direct/abf855424ffa42808d493ed78de07ca8.png" width="1020">
      检查test.jpg文件，看起来也没有问题。
     </img>
    </p>
    <p>
     <img alt="" height="806" src="https://i-blog.csdnimg.cn/direct/c6ea4ea3f6cb4fc19c10f4756a86b021.png" width="1440"/>
    </p>
    <p>
     直接改为test.php访问测试，访问成功，应该是.htaccess没有生效。
    </p>
    <p>
     <img alt="" height="1029" src="https://i-blog.csdnimg.cn/direct/bd53aa1ff3ad4efdb783b8d4c0cc42b7.png" width="1920"/>
    </p>
    <p>
     nginx默认没有包含该文件进来，找到配置文件，添加：
    </p>
    <p>
     <img alt="" height="811" src="https://i-blog.csdnimg.cn/direct/579cd391484146268642317c6d2bfe31.png" width="1086"/>
    </p>
    <p>
     但是这里nginx重启动会失败，在Linux环境下才可以生效。就不浪费时间布置环境。
    </p>
    <h3>
     Pass5 ..与user.ini
    </h3>
    <p>
     测试..绕过,去掉一个.后剩余名称为tese.php.,在Windows下自动删除.,以达到绕过黑名单的目的。实际效果无效，原因未知。
    </p>
    <p>
     <img alt="" height="1000" src="https://i-blog.csdnimg.cn/direct/f8188451732c400e995c637851dca743.png" width="1280"/>
    </p>
    <p>
     尝试第二个方法，创建.user.ini文件:
    </p>
    <pre><code>auto_prepend_file string</code></pre>
    <p>
     上传.user.ini文件:
    </p>
    <p>
     <img alt="" height="169" src="https://i-blog.csdnimg.cn/direct/a17fc2e442e94e26a117f490032e4eee.png" width="1030"/>
    </p>
    <p>
     访问test.jpg文件测试:
    </p>
    <p>
     <img alt="" height="1029" src="https://i-blog.csdnimg.cn/direct/7fd1d5067bd343a09ba6daa07e1a30b1.png" width="1920"/>
    </p>
    <p>
     无法正常解析,与.htaccess文件相同,无法生效,应该是集成环境的问题。
    </p>
    <p>
     <img alt="" height="844" src="https://i-blog.csdnimg.cn/direct/9fe36552de75435fa0e1f04ebffe13b7.png" width="1400"/>
    </p>
    <h3>
     Pass6---大小写绕过
    </h3>
    <p>
     抓包修改后缀为大小写混合绕过黑名单限制。
    </p>
    <p>
     <img alt="" height="1000" src="https://i-blog.csdnimg.cn/direct/c27c78cb6327471aaf2f0b4ca2e3a722.png" width="1280"/>
    </p>
    <h3>
     Pass7----空格绕过
    </h3>
    <p>
     这一关缺少了前后去空格操作，抓包在后面添加空格以绕过黑名单。
    </p>
    <p>
     <img alt="" height="1000" src="https://i-blog.csdnimg.cn/direct/2fb653719d7147b7b044836cf54abec0.png" width="1280"/>
    </p>
    <h3>
     Pass8.绕过
    </h3>
    <p>
     缺少过滤后缀.的函数，抓包+.绕过黑名单。
    </p>
    <p>
     <img alt="" height="1000" src="https://i-blog.csdnimg.cn/direct/8ffa4a30d52f4567a0d1a42cf6ac7e6a.png" width="1280"/>
    </p>
    <h3>
     Pass9---::$DATA特殊字符绕过
    </h3>
    <p>
     在Windows下，::$DATA特殊字符和.相似,会自动去除,但是可以绕过php代码黑名单。
    </p>
    <p>
     <img alt="" height="1000" src="https://i-blog.csdnimg.cn/direct/12da24f814304ba0a6c4b3d92da8818b.png" width="1280"/>
    </p>
    <h3>
     Pass10---..绕过
    </h3>
    <p>
     修改后缀  .+空格+.绕过黑名单。
    </p>
    <p>
     <img alt="" height="1000" src="https://i-blog.csdnimg.cn/direct/ea2b032ff1c344c7807341ed6ac9363a.png" width="1280"/>
    </p>
    <h3>
     Pass11----双写绕过
    </h3>
    <p>
     双写后缀过滤后成为正确的后缀。
    </p>
    <h3>
     <img alt="" height="1000" src="https://i-blog.csdnimg.cn/direct/4495858dc714471eb89d7b1e855f3bd4.png" width="1280"/>
     Pass12---%00截断（get）
    </h3>
    <p>
     php代码底层为c语言，在C语言中字符串的截断符为/0,使用这个机制，让代码后面的部分被截断无法生效。
    </p>
    <p>
     <img alt="" height="1000" src="https://i-blog.csdnimg.cn/direct/4d9e5ba5959d47c38be820df222a042f.png" width="1280"/>
    </p>
    <p>
     这里应该是截断失败了，看文件名字是通过随机数+时间生成的，为什么截断没有生效？
    </p>
    <p>
     <img alt="" height="121" src="https://i-blog.csdnimg.cn/direct/3fcca5f1643e49df91110b5cd0cdff4a.png" width="1030"/>
     为什么会有上传出错，来分析一下代码。
    </p>
    <pre><code class="language-php"> if(move_uploaded_file($temp_file,$img_path)){
            $is_upload = true;
        } else {
            $msg = '上传出错！';
        }</code></pre>
    <p>
     这个函数返回值为否，要么上传的临时文件不存在，要么路径错误，显然刚刚上传成功了，应该是文件不存在导致的。
    </p>
    <p>
     试着修改php.ini文件magic_quotes_gpc属性测试：
    </p>
    <p>
     <img alt="" height="1020" src="https://i-blog.csdnimg.cn/direct/2bd1e1d15bc84b168757094ff983f271.png" width="1920"/>
    </p>
    <p>
     仍然不太行，可能是版本太高。下载一个低版本试试，网上下了5.2.9版本的测试：
    </p>
    <p>
     <img alt="" height="645" src="https://i-blog.csdnimg.cn/direct/95ede1a6d80f44d1926658f43dcb175d.png" width="1045"/>
     <img alt="" height="821" src="https://i-blog.csdnimg.cn/direct/c5830f6120f4403999d1b75a12bd94bd.png" width="1016"/>
    </p>
    <p>
     <img alt="" height="1020" src="https://i-blog.csdnimg.cn/direct/9afc8eb584bf4f6c8b6118e064775e8e.png" width="1920"/>
    </p>
    <h3>
     Pass13----%00截断（post）
    </h3>
    <p>
     post传参的情况下，想要使用%00截断程序，需要修改16进制下的数据包。
    </p>
    <p>
     <img alt="" height="1020" src="https://i-blog.csdnimg.cn/direct/8f9f4ec62514455e8d321eafac50e4fd.png" width="1920"/>
    </p>
    <p>
     <img alt="" height="1020" src="https://i-blog.csdnimg.cn/direct/151dafd7366d4afc96db1b3659212e54.png" width="1920"/>
    </p>
    <h3>
     Pass14-----图片码
    </h3>
    <p>
     将图片与恶意代码结合到一起，绕过黑名单限制。
    </p>
    <pre><code>C:\Windows\System32&gt;cd C:\Users\huang\Desktop

C:\Users\huang\Desktop&gt;copy 1.png /b + test.php /a web.php
1.png
test.php
已复制         1 个文件。

C:\Users\huang\Desktop&gt;</code></pre>
    <p>
     确保制作的图片能够正常打开，要想测试文件包含漏洞，需要PHP配置中allow_url_include选项打开远程包含。测试访问：
    </p>
    <p>
     <img alt="" height="56" src="https://i-blog.csdnimg.cn/direct/9ba7a47855bd4757aecd77303d92c690.png" width="1092"/>
    </p>
    <p>
     这里表示在制作的图片里，php代码损坏了，无法正常解析，换几张图再次尝试。
    </p>
    <p>
     <img alt="" height="44" src="https://i-blog.csdnimg.cn/direct/03b1d31e0af544668001c4a639d8c524.png" width="1332"/>
     重新制作上传测试：
    </p>
    <p>
     <img alt="" height="117" src="https://i-blog.csdnimg.cn/direct/712bd73f5f4e4fe2b28ffc782662d90f.png" width="1600"/>
    </p>
    <p>
     又失败了，看来运气不太眷顾。再换一张测试：
    </p>
    <p>
     <img alt="" height="1029" src="https://i-blog.csdnimg.cn/direct/1801112f777a4739b2247647f9cd00d4.png" width="1920"/>
    </p>
    <p>
     成功了，运气比老师好点，哈哈哈哈哈。
    </p>
    <h3>
     Pass15-----图片码2
    </h3>
    <p>
     15关没区别，把成功的图片再次上传测试：
    </p>
    <p>
     <img alt="" height="1029" src="https://i-blog.csdnimg.cn/direct/f365ac06b2744cacb16d326dff49b244.png" width="1920"/>
    </p>
    <h3>
     Pass16---图片码3
    </h3>
    <p>
     仍然测试：
    </p>
    <h3>
     <img alt="" height="1029" src="https://i-blog.csdnimg.cn/direct/b25b5d0e5cd54ecaa80b1639cea00d7b.png" width="1920"/>
     Pass17----二次渲染
    </h3>
    <p>
     17关讲的是在上传过程中使用了函数打乱了图片编码，在不破坏图片主体的情况下，恶意代码就被破坏掉了，解决思路是有没有一块区域是在该过程中不会被打乱的，使用010 Editor打开一张原图片和处理后的图片，对比区域。具体操作如下：
    </p>
    <p>
     打开010 Editor------&gt;选择Tools------&gt;compare file------&gt;选择高亮显示相同部分：
    </p>
    <p>
     <img alt="" height="689" src="https://i-blog.csdnimg.cn/direct/1d4d95783c10426f9cb1c3bb69a2cb78.png" width="999"/>
    </p>
    <p>
     很轻易就找到了相同部分，把恶意代码放到该区域就不会被破坏。
    </p>
    <p>
     <img alt="" height="689" src="https://i-blog.csdnimg.cn/direct/9a62ba47905c4b878a15fc1f67a4b0d6.png" width="999"/>
    </p>
    <p>
     改完之后测试能不能打开图片，可以看到虽然不一样了，但是仍然可以打开图片：
    </p>
    <p style="text-align:center">
     <img alt="" src="https://i-blog.csdnimg.cn/direct/bfc79566dc754190a76f535a1dacbc63.jpeg"/>
    </p>
    <p>
     上传测试：
    </p>
    <p>
     <img alt="" height="925" src="https://i-blog.csdnimg.cn/direct/7ae0f278ccc94079af30cdd5e5a62971.png" width="1852"/>
     很遗憾，图片改废了，因此换一个合适的方法。有php脚本代码可以直接生成完好的图片码。
    </p>
    <h3>
     Pass18----条件竞争
    </h3>
    <p>
     此关存在的代码逻辑问题，先上传判断文件是否合法，不合法即删除图片，合法重命名，在审查是否合法的过程中，有短暂的时间可以去访问上传的恶意代码。
    </p>
    <p>
     先制作一个恶意代码文件：
    </p>
    <pre><code class="language-php">&lt;?php file_put_contents(dirname(__DIR__) . '/web.php', '&lt;?php phpinfo();?&gt;');</code></pre>
    <p>
     抓包发送到intruder模块：
    </p>
    <p>
     <img alt="" height="1020" src="https://i-blog.csdnimg.cn/direct/2b0d3f77f301468b84cd3480ba8368f2.png" width="1920"/>
    </p>
    <p>
     然后再抓恶意代码文件同样多次访问，两者一起跑,发现有成功的数据包：
    </p>
    <p>
     <img alt="" height="1009" src="https://i-blog.csdnimg.cn/direct/6a06bfcab829498788290fc167cf76f0.png" width="1920"/>
    </p>
    <p>
     成功生成恶意代码文件：
    </p>
    <p>
     <img alt="" height="646" src="https://i-blog.csdnimg.cn/direct/6396ebe2c4ac452da574e6d80019d593.png" width="1029"/>
    </p>
    <h3>
     Pass19----解析漏洞+条件竞争
    </h3>
    <p>
     这关涉及到了acaphe的解析漏洞，意思是当解析时，在文件后放acaphe解析不了的后缀，程序就会自动往前解析，例如7Z，bz2等。此方法用来绕过白名单限制。
    </p>
    <p>
     当使用Nginx，没有解析漏洞时，有没有其他方法来绕过白名单限制，有的，在第三关有方法，叫做.user.ini文件，让程序解析jpg文件为php文件。然后利用条件竞争漏洞，在没有改名之前访问恶意文件。
    </p>
    <p>
     但是集成环境的原因.user.ini文件并不生效，测试acaphe后缀解析漏洞发现，没有看到解析7z文件，但是文件名被改掉了。
    </p>
    <p>
     <img alt="" height="669" src="https://i-blog.csdnimg.cn/direct/9fe74d9423ae40519e0797bf18e2fa63.png" width="1425"/>
    </p>
    <p>
     查看上传成功的文件：
    </p>
    <p>
     <img alt="" height="646" src="https://i-blog.csdnimg.cn/direct/435b818acc6b414d87d8c4bca803ef81.png" width="1029"/>
     这是成功上传会变为upload+time.7z，可是访问无法成功：发了10000多个都不成功，可能是包有问题。
    </p>
    <p>
     <img alt="" height="520" src="https://i-blog.csdnimg.cn/direct/6a3bbef5e22f4c4bb491ad83e6f94e9a.png" width="1865"/>
    </p>
    <p>
     检查恶意文件代码无误：
    </p>
    <p>
     <img alt="" height="79" src="https://i-blog.csdnimg.cn/direct/8333e02fd98d455e870e8963c4742ab0.png" width="900"/>
     可能是acaphe版本太高，切换低版本尝试可能会成功。
    </p>
    <h3>
     Pass20----大小写绕过
    </h3>
    <p>
     绕过黑名单限制使用大小写混合，会检测你保存的文件名，保存的后缀要过黑名单检验：
    </p>
    <pre><code class="language-php">if(!in_array($file_ext,$deny_ext)) {
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH . '/' .$file_name;
            if (move_uploaded_file($temp_file, $img_path)) { 
                $is_upload = true;
            }else{
                $msg = '上传出错！';
            }
        }else{
            $msg = '禁止保存为该类型文件！';
        }</code></pre>
    <p>
     利用Windows不识别点，PHP程序会的特点，加上点过黑名单，使保存weiphp文件：
    </p>
    <p>
     <img alt="" height="1020" src="https://i-blog.csdnimg.cn/direct/b288b3342674458db311075c86be0a26.png" width="1920"/>
    </p>
    <h3 style="background-color:transparent">
     Pass21----数组绕过
    </h3>
    <p>
     最关键的地方在于数组的分割规则:
    </p>
    <pre><code class="language-php">  if (!is_array($file)) {
            $file = explode('.', strtolower($file));
        }</code></pre>
    <p>
     用.将数组分割开,类型检测是白名单只有jpg,png,gif,考虑绕过白名单,肯定要让检测的文件类型就是白名单的。代码里检测的是数组的最后一个字段。
    </p>
    <pre><code class="language-php"> $ext = end($file);</code></pre>
    <p>
     然后拼接后缀时：
    </p>
    <pre><code class="language-php">  $file_name = reset($file) . '.' . $file[count($file) - 1];
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH . '/' .$file_name;</code></pre>
    <p>
     拼接的是用array[0]+array[len(array)-2],如果我们构造一个数组，最后一个为白名单的类型，然后array[len(array)-2]不给值，在拼接时只把array[0]内容有，可以通过嘛：
    </p>
    <p>
     <img alt="" height="1019" src="https://i-blog.csdnimg.cn/direct/356492e31efe44bf8614f7dc351cc2ab.png" width="1920"/>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f37343834383537302f:61727469636c652f64657461696c732f313436313231353230" class_="artid" style="display:none">
 </p>
</div>


