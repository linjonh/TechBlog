---
layout: post
title: "蓝桥杯嵌入式组第十二届省赛题目解析STM32G431RBT6实现源码"
date: 2025-03-12 08:00:00 +0800
description: "STM32G431RBT6实现嵌入式组第十二届题目解析+源码。文章末尾有第十二届题目。"
keywords: "蓝桥杯嵌入式组第十二届省赛题目解析+STM32G431RBT6实现源码"
categories: ['单片机']
tags: ['蓝桥杯', '学习', '单片机', 'Stm', 'C']
artid: "146176734"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146176734
    alt: "蓝桥杯嵌入式组第十二届省赛题目解析STM32G431RBT6实现源码"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146176734
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146176734
cover: https://bing.ee123.net/img/rand?artid=146176734
image: https://bing.ee123.net/img/rand?artid=146176734
img: https://bing.ee123.net/img/rand?artid=146176734
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     蓝桥杯嵌入式组第十二届省赛题目解析+STM32G431RBT6实现源码
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <br/>
    前言：STM32G431RBT6实现嵌入式组第十二届题目解析+源码，本文默认读者具备基础的stm32知识。文章末尾有第十二届题目。
    <p>
    </p>
    <h2>
     <a id="1_2">
     </a>
     1.题目解析
    </h2>
    <p>
     第十二届虽说题目长，难度集中体现在uart接收的数据处理上。
    </p>
    <h3>
     <a id="11__4">
     </a>
     1.1 分而治之，藕断丝连
    </h3>
    <p>
     还是那句话，将不同模块进行封装，通过变量进行模块间的合作。
     <br/>
     <strong>
      函数将模块分而治之，变量使模块间藕断丝连。
     </strong>
    </p>
    <h3>
     <a id="12__7">
     </a>
     1.2 模块化思维导图
    </h3>
    <p>
     下图根据题目梳理。还是使用思维导图。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/947f6ae1697044f4a0e635686e59fdc8.png"/>
    </p>
    <h3>
     <a id="13__11">
     </a>
     1.3 模块解析
    </h3>
    <h4>
     <a id="131_KEY_12">
     </a>
     1.3.1 KEY模块
    </h4>
    <p>
     还是控制按一次处理一次。老朋友了我们就不多说了，题目限制了按键消抖和单次处理，所以我们要加上消抖，和第十一届的处理一模一样。
     <br/>
     <em>
      具体实现看源码
     </em>
    </p>
    <h4>
     <a id="132_LED_15">
     </a>
     1.3.2 LED模块
    </h4>
    <p>
     ld1：有空闲车位亮，否则灭
     <br/>
     ld2：PWM占空比20%输出亮，输出低电平灭
     <br/>
     解决办法，设置一个标志位代表ld1~ld8，改变对应位的的值，再将标志位写入ODR寄存器中来控制led的亮灭。
     <br/>
     <em>
      具体实现看源码
     </em>
    </p>
    <h4>
     <a id="133_LCD_20">
     </a>
     1.3.3 LCD模块
    </h4>
    <p>
     lcd显示两个界面，注意首次切换的时候得清屏。
     <br/>
     根据B1界面1和界面2切换；
     <br/>
     状态0：参数界面；
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/08248f7c0fb74e43b5503b033ff2136e.png"/>
    </p>
    <p>
     状态1：费用设置界面；
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e84706b53f0547a79a77180241aa7b16.png">
      <br/>
      <em>
       具体实现看源码
      </em>
     </img>
    </p>
    <h4>
     <a id="134_TIM_29">
     </a>
     1.3.4 TIM模块
    </h4>
    <p>
     TIM2产生1s时基。PSC：16999，ARR：9999；
     <br/>
     TIM17通道1产生2kHzPWM。PSC：16，ARR：4999；
     <br/>
     PSC和ARR计算公式（计算周期就是频率的倒数）：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/880a2ccbbedc44999f2fcc019bc9ec26.png"/>
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* 定时开启uart接收中断1s */</span>
<span class="token keyword">void</span> <span class="token function">HAL_TIM_PeriodElapsedCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">HAL_UARTEx_ReceiveToIdle_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> uart_rx_data<span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* pa7pwm输出 */</span>
<span class="token keyword">void</span> <span class="token function">HAL_TIM_PWM_PulseFinishedCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pa7_pwm_ctrl <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> TIM17<span class="token operator">-&gt;</span>CCR1 <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> TIM17<span class="token operator">-&gt;</span>CCR1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="135_UART_47">
     </a>
     1.3.5 UART模块
    </h4>
    <p>
     12届题目的难度就在uart的数据处理上。
     <br/>
     1.单片机接收来自电脑固定格式的数据，我们就需要数据限制条件来写解析接收的数据，数据长度，停车类别，车牌格式，时间格式。
     <br/>
     2.如果格式错误返回Error，else判断是停车还是取车。
     <br/>
     2.1 应该先判断取车，这大家都能理解。如果是取车，计算收费，时间，返回给电脑。
     <br/>
     2.2 如果是存车，先要判断是否有空闲车位，如果有存车，如果没有不做处理。
     <br/>
     <em>
      具体其他涉及函数代码请看源码
     </em>
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* uart接收数据处理 */</span>
<span class="token keyword">void</span> <span class="token function">HAL_UARTEx_RxEventCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> Size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">analyze_uart_str</span><span class="token punctuation">(</span>uart_rx_data<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//分析数据格式是否正确，错误传输Error</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">HAL_UART_Transmit_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"Error"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token comment">/*
    格式正确处理顺序 ：
    判断是否是取车（停车场已有该车）-&gt; 是: 取车+计算收费, 否: 判断是否有空闲车位 -&gt; 是：停车计时，否：不做处理
    */</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>                                     
        <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token function">find_car_in_parking</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>   <span class="token comment">//表示取车</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>parking_type<span class="token punctuation">,</span> <span class="token string">"VNBR"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>    <span class="token comment">//计算停车费</span>
                parking_fee <span class="token operator">=</span> <span class="token function">caculate_parking_time</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">*</span>V_money<span class="token punctuation">;</span>
                parking_spaces<span class="token punctuation">.</span>VNBR<span class="token operator">--</span><span class="token punctuation">;</span>
                parking_spaces<span class="token punctuation">.</span>IDLE<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>parking_type<span class="token punctuation">,</span> <span class="token string">"CNBR"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                parking_fee <span class="token operator">=</span> <span class="token function">caculate_parking_time</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">*</span>C_money<span class="token punctuation">;</span>
                parking_spaces<span class="token punctuation">.</span>CNBR<span class="token operator">--</span><span class="token punctuation">;</span>
                parking_spaces<span class="token punctuation">.</span>IDLE<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>parking_fee_str<span class="token punctuation">,</span> <span class="token string">"%4s:%4s:%u:%.2f"</span><span class="token punctuation">,</span> parking_flag_temporary<span class="token punctuation">.</span>parking_type<span class="token punctuation">,</span>
                    parking_flag_temporary<span class="token punctuation">.</span>car_num<span class="token punctuation">,</span> <span class="token function">caculate_parking_time</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> parking_fee<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">HAL_UART_Transmit_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> parking_fee_str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>parking_fee_str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>parking_flag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>parking_flag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>parking_time<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>parking_time<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>        <span class="token comment">//停车          </span>
            i <span class="token operator">=</span> <span class="token function">find_free_parking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              
            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">!=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>               <span class="token comment">//有空闲车位</span>
                parking_flag<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> parking_flag_temporary<span class="token punctuation">;</span>
                parking_time<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> parking_time_temporary<span class="token punctuation">;</span>
                
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>parking_type<span class="token punctuation">,</span> <span class="token string">"CNBR"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    parking_spaces<span class="token punctuation">.</span>CNBR<span class="token operator">++</span><span class="token punctuation">;</span>
                    parking_spaces<span class="token punctuation">.</span>IDLE<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>parking_type<span class="token punctuation">,</span> <span class="token string">"VNBR"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    parking_spaces<span class="token punctuation">.</span>VNBR<span class="token operator">++</span><span class="token punctuation">;</span>
                    parking_spaces<span class="token punctuation">.</span>IDLE<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="1351_uart_106">
     </a>
     1.3.5.1 uart数据解析
    </h5>
    <p>
     我们可以使用指针加for单个字符判断，也可以使用string.h库中的字符处理函数，strcmp(), strcpy(),strncmp(), strncpy()等函数，将数据先切段，再通过各段的限制条件进行格式判断。
    </p>
    <pre><code class="prism language-c"><span class="token comment">/**
*   @brief 判断uart接收到的数据格式是否正确，这里只有长度判断、车位类型、车位号码、时间格式的判断，
*   还可以加时间的大小比如月份只能是1~12月。还有解析时间的时候，假如说要取车，那取车时间肯定大于停车时间……
*   @para str: uart接收数据
*   @retval 1：数据格式错误，0：正确
*/</span>
<span class="token class-name">uint8_t</span> <span class="token function">analyze_uart_str</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>str<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">//</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">uint8_t</span> <span class="token operator">*</span>p <span class="token operator">=</span> str<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'C'</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'V'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"NBR"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">strncpy</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>parking_type<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>str<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> str<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">;</span>p<span class="token operator">&lt;</span>str<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">;</span>p<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">*</span>p<span class="token operator">&gt;</span><span class="token number">127</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>car_num<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>str<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> str<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">*</span>p<span class="token operator">!=</span><span class="token char">'\0'</span><span class="token punctuation">;</span>p<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">&lt;</span><span class="token char">'0'</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">&gt;</span> <span class="token char">'9'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>time<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>str<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>time<span class="token punctuation">,</span><span class="token string">"%4hu%2hhu%2hhu%2hhu%2hhu%2hhu"</span><span class="token punctuation">,</span> 
                <span class="token operator">&amp;</span>parking_time_temporary<span class="token punctuation">.</span>years<span class="token punctuation">,</span> <span class="token operator">&amp;</span>parking_time_temporary<span class="token punctuation">.</span>dates<span class="token punctuation">,</span> <span class="token operator">&amp;</span>parking_time_temporary<span class="token punctuation">.</span>days<span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>parking_time_temporary<span class="token punctuation">.</span>hours<span class="token punctuation">,</span> <span class="token operator">&amp;</span>parking_time_temporary<span class="token punctuation">.</span>minutes<span class="token punctuation">,</span> <span class="token operator">&amp;</span>parking_time_temporary<span class="token punctuation">.</span>seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="2_141">
     </a>
     2.源码
    </h2>
    <p>
     我所有的实现都在main.c文件中。
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* USER CODE BEGIN Header */</span>
<span class="token comment">/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2025 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */</span>
<span class="token comment">/* USER CODE END Header */</span>
<span class="token comment">/* Includes ------------------------------------------------------------------*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"main.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"gpio.h"</span></span>

<span class="token comment">/* Private includes ----------------------------------------------------------*/</span>
<span class="token comment">/* USER CODE BEGIN Includes */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lcd.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdlib.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"string.h"</span></span>
<span class="token comment">/* USER CODE END Includes */</span>

<span class="token comment">/* Private typedef -----------------------------------------------------------*/</span>
<span class="token comment">/* USER CODE BEGIN PTD */</span>

<span class="token comment">/* USER CODE END PTD */</span>

<span class="token comment">/* Private define ------------------------------------------------------------*/</span>
<span class="token comment">/* USER CODE BEGIN PD */</span>

<span class="token comment">/* USER CODE END PD */</span>

<span class="token comment">/* Private macro -------------------------------------------------------------*/</span>
<span class="token comment">/* USER CODE BEGIN PM */</span>

<span class="token comment">/* USER CODE END PM */</span>

<span class="token comment">/* Private variables ---------------------------------------------------------*/</span>

<span class="token comment">/* USER CODE BEGIN PV */</span>

<span class="token comment">/* USER CODE END PV */</span>

<span class="token comment">/* Private function prototypes -----------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE BEGIN PFP */</span>

<span class="token comment">/* USER CODE END PFP */</span>

<span class="token comment">/* Private user code ---------------------------------------------------------*/</span>
<span class="token comment">/* USER CODE BEGIN 0 */</span>
<span class="token comment">//按键四种状态</span>
<span class="token keyword">enum</span><span class="token punctuation">{<!-- --></span>
    key_released <span class="token operator">=</span> <span class="token number">0U</span><span class="token punctuation">,</span>
    key_reduction<span class="token punctuation">,</span>
    key_pressed<span class="token punctuation">,</span>
    key_wait_released<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//停车位状态</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> CNBR<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> VNBR<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> IDLE<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">parking_t</span><span class="token punctuation">;</span>
<span class="token class-name">parking_t</span> parking_spaces <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//存储解析uart数据</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> parking_type<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> car_num<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> time<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token class-name">parking_flag_t</span><span class="token punctuation">;</span>
<span class="token class-name">parking_flag_t</span> parking_flag<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> parking_flag_temporary <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//将时间字符串解析成数据</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint16_t</span> years<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> dates<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> days<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> hours<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> minutes<span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> seconds<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token class-name">calendar_t</span><span class="token punctuation">;</span>
<span class="token class-name">calendar_t</span> parking_time<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>parking_time_temporary <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*
lcd_show_conv: lcd界面切换
pa7_pwm_ctrl: pwm输出控制
lcd_clear_flag: 清屏标志
ld_flag: ld状态标志
*/</span>
<span class="token class-name">uint8_t</span> lcd_show_conv <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> pa7_pwm_ctrl <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> lcd_clear_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ld_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">/*
uart_rx_data: 接收来自串口的24字节的数据
lcd_str: lcd显示
parking_fee_str: 串口回复收费信息buff
*/</span>
<span class="token class-name">uint8_t</span> uart_rx_data<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> lcd_str<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> parking_fee_str<span class="token punctuation">[</span><span class="token number">25</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">//消抖时间标记</span>
<span class="token class-name">uint32_t</span> key_redu_tim <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">/*
keys_volt: 按键电平信息
keys_state: 按键状态信息
*/</span>
<span class="token class-name">uint8_t</span> keys_volt<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> keys_state<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*
C_money: CNBR停车收费元/小时
V_money: VNBR停车收费元/小时
parking_fee: 计算停车费
*/</span>
<span class="token keyword">float</span> C_money <span class="token operator">=</span> <span class="token number">3.5f</span><span class="token punctuation">,</span> V_money <span class="token operator">=</span> <span class="token number">2.0f</span><span class="token punctuation">,</span> parking_fee <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">key_state_gain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">key_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">lcd_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">analyze_uart_str</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">find_free_parking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">find_car_in_parking</span><span class="token punctuation">(</span><span class="token class-name">parking_flag_t</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint32_t</span> <span class="token function">caculate_parking_time</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">led_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* USER CODE END 0 */</span>

<span class="token comment">/**
  * @brief  The application entry point.
  * @retval int
  */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

  <span class="token comment">/* USER CODE BEGIN 1 */</span>

  <span class="token comment">/* USER CODE END 1 */</span>

  <span class="token comment">/* MCU Configuration--------------------------------------------------------*/</span>

  <span class="token comment">/* Reset of all peripherals, Initializes the Flash interface and the Systick. */</span>
  <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* USER CODE BEGIN Init */</span>
    <span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_Clear</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_SetBackColor</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_SetTextColor</span><span class="token punctuation">(</span>White<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END Init */</span>

  <span class="token comment">/* Configure the system clock */</span>
  <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* USER CODE BEGIN SysInit */</span>

  <span class="token comment">/* USER CODE END SysInit */</span>

  <span class="token comment">/* Initialize all configured peripherals */</span>
  <span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_TIM2_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_TIM17_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN 2 */</span>
    <span class="token function">HAL_TIM_Base_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAL_TIM_PWM_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim17<span class="token punctuation">,</span> TIM_CHANNEL_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAL_UARTEx_ReceiveToIdle_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> uart_rx_data<span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END 2 */</span>

  <span class="token comment">/* Infinite loop */</span>
  <span class="token comment">/* USER CODE BEGIN WHILE */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* USER CODE END WHILE */</span>

    <span class="token comment">/* USER CODE BEGIN 3 */</span>
      <span class="token function">key_state_gain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">key_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">lcd_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">led_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* USER CODE END 3 */</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
  * @brief System Clock Configuration
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  RCC_OscInitTypeDef RCC_OscInitStruct <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  RCC_ClkInitTypeDef RCC_ClkInitStruct <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/** Configure the main internal regulator output voltage
  */</span>
  <span class="token function">HAL_PWREx_ControlVoltageScaling</span><span class="token punctuation">(</span>PWR_REGULATOR_VOLTAGE_SCALE1_BOOST<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>OscillatorType <span class="token operator">=</span> RCC_OSCILLATORTYPE_HSE<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>HSEState <span class="token operator">=</span> RCC_HSE_ON<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLState <span class="token operator">=</span> RCC_PLL_ON<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLSource <span class="token operator">=</span> RCC_PLLSOURCE_HSE<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLM <span class="token operator">=</span> RCC_PLLM_DIV6<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLN <span class="token operator">=</span> <span class="token number">85</span><span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLP <span class="token operator">=</span> RCC_PLLP_DIV2<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLQ <span class="token operator">=</span> RCC_PLLQ_DIV2<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLR <span class="token operator">=</span> RCC_PLLR_DIV2<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_RCC_OscConfig</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RCC_OscInitStruct<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/** Initializes the CPU, AHB and APB buses clocks
  */</span>
  RCC_ClkInitStruct<span class="token punctuation">.</span>ClockType <span class="token operator">=</span> RCC_CLOCKTYPE_HCLK<span class="token operator">|</span>RCC_CLOCKTYPE_SYSCLK
                              <span class="token operator">|</span>RCC_CLOCKTYPE_PCLK1<span class="token operator">|</span>RCC_CLOCKTYPE_PCLK2<span class="token punctuation">;</span>
  RCC_ClkInitStruct<span class="token punctuation">.</span>SYSCLKSource <span class="token operator">=</span> RCC_SYSCLKSOURCE_PLLCLK<span class="token punctuation">;</span>
  RCC_ClkInitStruct<span class="token punctuation">.</span>AHBCLKDivider <span class="token operator">=</span> RCC_SYSCLK_DIV1<span class="token punctuation">;</span>
  RCC_ClkInitStruct<span class="token punctuation">.</span>APB1CLKDivider <span class="token operator">=</span> RCC_HCLK_DIV1<span class="token punctuation">;</span>
  RCC_ClkInitStruct<span class="token punctuation">.</span>APB2CLKDivider <span class="token operator">=</span> RCC_HCLK_DIV1<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_RCC_ClockConfig</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RCC_ClkInitStruct<span class="token punctuation">,</span> FLASH_LATENCY_4<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* USER CODE BEGIN 4 */</span>
<span class="token comment">/* 获取按键状态 */</span>
<span class="token keyword">void</span> <span class="token function">key_state_gain</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    keys_volt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    keys_volt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    keys_volt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    keys_volt<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>keys_volt<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>keys_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> key_released<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                key_redu_tim <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                keys_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> key_reduction<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>keys_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> key_reduction<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> key_redu_tim<span class="token operator">&gt;=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    keys_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> key_pressed<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>keys_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> key_pressed<span class="token punctuation">)</span>
                keys_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> key_wait_released<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>keys_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> key_wait_released <span class="token operator">||</span> keys_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> key_pressed<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                key_redu_tim <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                keys_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> key_reduction<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>keys_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> key_reduction<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> key_redu_tim<span class="token operator">&gt;=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    keys_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> key_released<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> keys_state<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> key_released<span class="token punctuation">;</span>     
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 根据按键状态设置对应标志 */</span>
<span class="token keyword">void</span> <span class="token function">key_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>keys_state<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> key_pressed<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//界面切换</span>
        lcd_show_conv <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>lcd_show_conv <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>   <span class="token comment">//B2B3只在界面1起作用</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>keys_state<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> key_pressed<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">//++</span>
            C_money<span class="token operator">+=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
            V_money<span class="token operator">+=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>keys_state<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> key_pressed<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//--</span>
            C_money<span class="token operator">-=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
            V_money<span class="token operator">-=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>V_money <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                C_money <span class="token operator">=</span> <span class="token number">1.5</span><span class="token punctuation">;</span>
                V_money <span class="token operator">=</span> <span class="token number">0.0f</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>keys_state<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">==</span> key_pressed<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>   <span class="token comment">//pwm控制</span>
        pa7_pwm_ctrl <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/* lcd两种状态 */</span>
<span class="token keyword">void</span> <span class="token function">lcd_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>lcd_show_conv<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>lcd_clear_flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                lcd_clear_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token function">LCD_Clear</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_str<span class="token punctuation">,</span> <span class="token string">"        Data        "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line2<span class="token punctuation">,</span> lcd_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_str<span class="token punctuation">,</span> <span class="token string">"  CNBR:%d            "</span><span class="token punctuation">,</span> parking_spaces<span class="token punctuation">.</span>CNBR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line4<span class="token punctuation">,</span> lcd_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_str<span class="token punctuation">,</span> <span class="token string">"  VNBR:%d            "</span><span class="token punctuation">,</span> parking_spaces<span class="token punctuation">.</span>VNBR<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line6<span class="token punctuation">,</span> lcd_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_str<span class="token punctuation">,</span> <span class="token string">"  IDLE:%d            "</span><span class="token punctuation">,</span> parking_spaces<span class="token punctuation">.</span>IDLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line8<span class="token punctuation">,</span> lcd_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>lcd_clear_flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                lcd_clear_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token function">LCD_Clear</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_str<span class="token punctuation">,</span> <span class="token string">"        Data        "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line2<span class="token punctuation">,</span> lcd_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_str<span class="token punctuation">,</span> <span class="token string">"  CNBR:%.2f         "</span><span class="token punctuation">,</span> C_money<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line4<span class="token punctuation">,</span> lcd_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_str<span class="token punctuation">,</span> <span class="token string">"  VNBR:%.2f         "</span><span class="token punctuation">,</span> V_money<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line6<span class="token punctuation">,</span> lcd_str<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
*   @brief 判断uart接收到的数据格式是否正确，这里只有长度判断、车位类型、车位号码、时间格式的判断，
*   还可以加时间的大小比如月份只能是1~12月。还有解析时间的时候，假如说要取车，那取车时间肯定大于停车时间……
*   @para str: uart接收数据
*   @retval 1：数据格式错误，0：正确
*/</span>
<span class="token class-name">uint8_t</span> <span class="token function">analyze_uart_str</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>str<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>str<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  <span class="token comment">//</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">uint8_t</span> <span class="token operator">*</span>p <span class="token operator">=</span> str<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'C'</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'V'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"NBR"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">strncpy</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>parking_type<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>str<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> str<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">;</span>p<span class="token operator">&lt;</span>str<span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">;</span>p<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">*</span>p<span class="token operator">&gt;</span><span class="token number">127</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>car_num<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>str<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span>p <span class="token operator">=</span> str<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">*</span>p<span class="token operator">!=</span><span class="token char">'\0'</span><span class="token punctuation">;</span>p<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">*</span>p<span class="token operator">&lt;</span><span class="token char">'0'</span> <span class="token operator">||</span> <span class="token operator">*</span>p <span class="token operator">&gt;</span> <span class="token char">'9'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">strncpy</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>time<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>str<span class="token operator">+</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sscanf</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>time<span class="token punctuation">,</span><span class="token string">"%4hu%2hhu%2hhu%2hhu%2hhu%2hhu"</span><span class="token punctuation">,</span> 
                <span class="token operator">&amp;</span>parking_time_temporary<span class="token punctuation">.</span>years<span class="token punctuation">,</span> <span class="token operator">&amp;</span>parking_time_temporary<span class="token punctuation">.</span>dates<span class="token punctuation">,</span> <span class="token operator">&amp;</span>parking_time_temporary<span class="token punctuation">.</span>days<span class="token punctuation">,</span>
                <span class="token operator">&amp;</span>parking_time_temporary<span class="token punctuation">.</span>hours<span class="token punctuation">,</span> <span class="token operator">&amp;</span>parking_time_temporary<span class="token punctuation">.</span>minutes<span class="token punctuation">,</span> <span class="token operator">&amp;</span>parking_time_temporary<span class="token punctuation">.</span>seconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 查找是否有空闲车位 */</span>
<span class="token class-name">uint8_t</span> <span class="token function">find_free_parking</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>parking_flag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>parking_type<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'V'</span> <span class="token operator">&amp;&amp;</span> parking_flag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>parking_type<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'C'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 查找是否该车要取车 */</span>
<span class="token class-name">uint8_t</span> <span class="token function">find_car_in_parking</span><span class="token punctuation">(</span><span class="token class-name">parking_flag_t</span> p<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>parking_flag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>parking_type<span class="token punctuation">,</span> p<span class="token punctuation">.</span>parking_type<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> 
            <span class="token operator">!</span><span class="token function">strncasecmp</span><span class="token punctuation">(</span>parking_flag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>car_num<span class="token punctuation">,</span> p<span class="token punctuation">.</span>car_num<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> i<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 停车时间计算 */</span>
<span class="token class-name">uint32_t</span> <span class="token function">caculate_parking_time</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> i<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> hour <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    hour <span class="token operator">=</span> <span class="token punctuation">(</span>parking_time_temporary<span class="token punctuation">.</span>years <span class="token operator">-</span> parking_time<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>years<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">365</span><span class="token operator">*</span><span class="token number">24</span><span class="token punctuation">;</span>
    hour <span class="token operator">+=</span> <span class="token punctuation">(</span>parking_time_temporary<span class="token punctuation">.</span>dates <span class="token operator">-</span> parking_time<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>dates<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">30</span><span class="token operator">*</span><span class="token number">24</span><span class="token punctuation">;</span>
    hour <span class="token operator">+=</span> <span class="token punctuation">(</span>parking_time_temporary<span class="token punctuation">.</span>days <span class="token operator">-</span> parking_time<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>days<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">24</span><span class="token punctuation">;</span>
    hour <span class="token operator">+=</span> <span class="token punctuation">(</span>parking_time_temporary<span class="token punctuation">.</span>hours <span class="token operator">-</span> parking_time<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>hours<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>parking_time_temporary<span class="token punctuation">.</span>minutes<span class="token operator">-</span>parking_time<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>minutes<span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token number">0</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>parking_time_temporary<span class="token punctuation">.</span>seconds<span class="token operator">-</span>parking_time<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>seconds<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        hour<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> hour<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* led状态更新 */</span>
<span class="token keyword">void</span> <span class="token function">led_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>parking_spaces<span class="token punctuation">.</span>IDLE <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        ld_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> ld_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pa7_pwm_ctrl <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        ld_flag <span class="token operator">+=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> ld_flag <span class="token operator">+=</span> <span class="token number">0</span><span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span>GPIO_PIN_2<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xffff</span> <span class="token operator">^</span> ld_flag <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span>GPIO_PIN_2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 定时开启uart接收中断1s */</span>
<span class="token keyword">void</span> <span class="token function">HAL_TIM_PeriodElapsedCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">HAL_UARTEx_ReceiveToIdle_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> uart_rx_data<span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* pa7pwm输出 */</span>
<span class="token keyword">void</span> <span class="token function">HAL_TIM_PWM_PulseFinishedCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pa7_pwm_ctrl <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> TIM17<span class="token operator">-&gt;</span>CCR1 <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> TIM17<span class="token operator">-&gt;</span>CCR1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* uart接收数据处理 */</span>
<span class="token keyword">void</span> <span class="token function">HAL_UARTEx_RxEventCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> Size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">analyze_uart_str</span><span class="token punctuation">(</span>uart_rx_data<span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">//分析数据格式是否正确，错误传输Error</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">HAL_UART_Transmit_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"Error"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    <span class="token comment">/*
    格式正确处理顺序 ：
    判断是否是取车（停车场已有该车）-&gt; 是: 取车+计算收费, 否: 判断是否有空闲车位 -&gt; 是：停车计时，否：不做处理
    */</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>                                     
        <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token function">find_car_in_parking</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">!=</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>   <span class="token comment">//表示取车</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>parking_type<span class="token punctuation">,</span> <span class="token string">"VNBR"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>    <span class="token comment">//计算停车费</span>
                parking_fee <span class="token operator">=</span> <span class="token function">caculate_parking_time</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">*</span>V_money<span class="token punctuation">;</span>
                parking_spaces<span class="token punctuation">.</span>VNBR<span class="token operator">--</span><span class="token punctuation">;</span>
                parking_spaces<span class="token punctuation">.</span>IDLE<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>parking_type<span class="token punctuation">,</span> <span class="token string">"CNBR"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                parking_fee <span class="token operator">=</span> <span class="token function">caculate_parking_time</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">*</span>C_money<span class="token punctuation">;</span>
                parking_spaces<span class="token punctuation">.</span>CNBR<span class="token operator">--</span><span class="token punctuation">;</span>
                parking_spaces<span class="token punctuation">.</span>IDLE<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>parking_fee_str<span class="token punctuation">,</span> <span class="token string">"%4s:%4s:%u:%.2f"</span><span class="token punctuation">,</span> parking_flag_temporary<span class="token punctuation">.</span>parking_type<span class="token punctuation">,</span>
                    parking_flag_temporary<span class="token punctuation">.</span>car_num<span class="token punctuation">,</span> <span class="token function">caculate_parking_time</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> parking_fee<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">HAL_UART_Transmit_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> parking_fee_str<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>parking_fee_str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>parking_flag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>parking_flag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>parking_time<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>parking_time<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>        <span class="token comment">//停车          </span>
            i <span class="token operator">=</span> <span class="token function">find_free_parking</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              
            <span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">!=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>               <span class="token comment">//有空闲车位</span>
                parking_flag<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> parking_flag_temporary<span class="token punctuation">;</span>
                parking_time<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> parking_time_temporary<span class="token punctuation">;</span>
                
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>parking_type<span class="token punctuation">,</span> <span class="token string">"CNBR"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    parking_spaces<span class="token punctuation">.</span>CNBR<span class="token operator">++</span><span class="token punctuation">;</span>
                    parking_spaces<span class="token punctuation">.</span>IDLE<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>parking_flag_temporary<span class="token punctuation">.</span>parking_type<span class="token punctuation">,</span> <span class="token string">"VNBR"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    parking_spaces<span class="token punctuation">.</span>VNBR<span class="token operator">++</span><span class="token punctuation">;</span>
                    parking_spaces<span class="token punctuation">.</span>IDLE<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* USER CODE END 4 */</span>

<span class="token comment">/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* USER CODE BEGIN Error_Handler_Debug */</span>
  <span class="token comment">/* User can add his own implementation to report the HAL error return state */</span>
  <span class="token function">__disable_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* USER CODE END Error_Handler_Debug */</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span>  <span class="token expression">USE_FULL_ASSERT</span></span>
<span class="token comment">/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">assert_failed</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> line<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* USER CODE BEGIN 6 */</span>
  <span class="token comment">/* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */</span>
  <span class="token comment">/* USER CODE END 6 */</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* USE_FULL_ASSERT */</span></span>

</code></pre>
    <h2>
     <a id="3_652">
     </a>
     3.第十二届题目
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e71003bf9931454da3ea550716608e85.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/523456b10a18423ba406389a921e86d8.png">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5b9d652a70614d94b0b9ab932d13c2ab.png">
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/3b1180ef05d64c18b3847815a98259c8.png">
         <br/>
         <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e69cc78939114b62807d67a6a16b690a.png"/>
         <br/>
         <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/edd6acf4053e4d83884fdbbedc8b6804.png"/>
         <br/>
         <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8bbc41fab765481c9e700d16727a821e.png"/>
         <br/>
         <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/45e9247766f54e0eb754fb6db44d0d66.png"/>
        </img>
       </img>
      </img>
     </img>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f38303735343230332f:61727469636c652f64657461696c732f313436313736373334" class_="artid" style="display:none">
 </p>
</div>


