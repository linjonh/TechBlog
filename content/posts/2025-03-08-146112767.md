---
arturl_encode: "68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f36333934393230332f:61727469636c652f64657461696c732f313436313132373637"
layout: post
title: "Sentinel-ç¬”è®°"
date: 2025-03-08 11:03:56 +0800
description: "Sentinel ç¬”è®°"
keywords: "Sentinel ç¬”è®°"
categories: ['Springcloud', 'Springboot']
tags: ['ç¬”è®°', 'Sentinel']
artid: "146112767"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146112767
    alt: "Sentinel-ç¬”è®°"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146112767
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146112767
cover: https://bing.ee123.net/img/rand?artid=146112767
image: https://bing.ee123.net/img/rand?artid=146112767
img: https://bing.ee123.net/img/rand?artid=146112767
---

# Sentinel ç¬”è®°

## Sentinel ç¬”è®°

### 1 ä»‹ç»

**Sentinel**
æ˜¯é˜¿é‡Œå¼€æºçš„åˆ†å¸ƒå¼ç³»ç»Ÿæµé‡é˜²å«ç»„ä»¶ï¼Œä¸“æ³¨äº
**æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿä¿æŠ¤**
ã€‚

å®˜ç½‘ï¼šhttps://sentinelguard.io/zh-cn/index.html

wikiï¼š
[https://github.com/alibaba/Sentinel/wiki](https://github.com/alibaba/Sentinel/wiki/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8)

**å¯¹æ¯”åŒç±»äº§å“**
ï¼š

| äº§å“ | ç‰¹ç‚¹ |
| --- | --- |
| **Hystrix** | Netflix å¼€æºï¼ŒåŠŸèƒ½å…¨é¢ä½†å·²åœæ­¢ç»´æŠ¤ï¼ŒåŸºäºçº¿ç¨‹æ± éš”ç¦»ï¼Œèµ„æºæ¶ˆè€—è¾ƒå¤§ |
| **Resilience4j** | è½»é‡çº§ï¼ŒåŸºäºå‡½æ•°å¼ç¼–ç¨‹ï¼Œä½†éœ€è¦ç»“åˆå…¶ä»–ç»„ä»¶å®ç°å®Œæ•´åŠŸèƒ½ |
| **Sentinel** | è½»é‡çº§ï¼Œå®æ—¶ç›‘æ§å’Œæ§åˆ¶ï¼Œæ”¯æŒåŠ¨æ€è§„åˆ™é…ç½®ï¼Œä¸ Spring Cloud æ·±åº¦é›†æˆ |

---

### 2 æ¶æ„

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/da70899745fb42e2bc5ae3e1df55f8e3.png)

* **æ ¸å¿ƒæ¨¡å—**
  ï¼š
  + **èµ„æº**
    ï¼šè¢«ä¿æŠ¤çš„ä»£ç é€»è¾‘ï¼ˆå¦‚æ¥å£ã€æ–¹æ³•ï¼‰ã€‚
  + **è§„åˆ™**
    ï¼šæµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ç­‰ç­–ç•¥ã€‚
  + **æ§åˆ¶å°**
    ï¼šå¯è§†åŒ–è§„åˆ™é…ç½®ä¸å®æ—¶ç›‘æ§ã€‚

---

### 4 ç¯å¢ƒæ­å»º

#### 4.1 ä¾èµ–

```xml
<!-- Spring Cloud Alibaba Sentinel -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>

```

#### 4.2 å¯åŠ¨æ§åˆ¶å°

1. ä¸‹è½½ Sentinel Dashboard
   [å®˜æ–¹ Release](https://github.com/alibaba/Sentinel/releases)
   æˆ–
   [ğŸ“sentinel-dashboard-1.8.8.jar](https://www.yuque.com/attachments/yuque/0/2024/jar/1613913/1735526694103-89c12733-cc3f-4733-b128-c450a77f829f.jar)
2. å¯åŠ¨å‘½ä»¤ï¼š

   ä¸‹è½½å®Œæˆåï¼šåœ¨æ–‡ä»¶ç›®å½•è¾“å…¥cmdè¿›å…¥bashå‘½ä»¤è¡Œ

   åœ¨å‘½ä»¤è¡Œçª—å£è¾“å…¥ï¼šå³å¯å¯åŠ¨é¡¹ç›®

```bash
 java -jar sentinel-dashboard-1.8.8.jar

```

3.é€šè¿‡http://localhost:8080å³å¯è®¿é—®sentinelçš„æ§åˆ¶å°

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/f3216c4147934a76a01c6d8d6a304620.png)

æ­£å¸¸è®¿é—®åæ˜¾ç¤ºçš„ç•Œé¢ï¼š
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/4717c97de9db463f95884b863d0ada00.png)

#### 4.3 é…ç½®è¿æ¥

åœ¨
`application.yml`
ä¸­é…ç½®ï¼š

```yaml
# è®¢å•ä»¥åŠå•†å“éƒ½è¦é…ç½®
spring:
  cloud:
    sentinel:
      transport:
        dashboard: localhost:8080 # æ§åˆ¶å°åœ°å€
      eager: true # ç«‹å³åˆå§‹åŒ–

```

é…ç½®æˆåŠŸåï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/d4636f7c227141de99171148cead0e47.png)

å‡è®¾æˆ‘ä»¬è¦æŠŠcreateOrderæ³¨å†Œä¸ºæˆ‘ä»¬è¦ç®¡ç†çš„æœåŠ¡ã€‚

```java
    @SentinelResource(value = "createOrder")
    public Order createOrder(Long userId, Long productId) {
        //Product product = productFeignClient.getProductById(productId);
        //ä½¿ç”¨RestTemplateå®ç°è´Ÿè½½å‡è¡¡
        //Product product = getProductFromRemqteWithLoadBalanceAnnotation(productId);
        //ä½¿ç”¨feignClientå®ç°è¿œç¨‹è°ƒç”¨
        Product product = productFeignClient.getProductById(productId);
        Order order = new Order();
        order.setId(1L);
        order.setTotalAmount(product.getPrice().multiply(new BigDecimal(product.getNum())));
        //order.setTotalAmount(BigDecimal.valueOf(0));
        order.setUserId(userId);
        order.setNickName("zhangsan");
        order.setAddress("å°šç¡…è°·");
        order.setProductList(Arrays.asList(product));
        return order;
    }

```

åˆ›å»ºè®¢å•çš„è¯·æ±‚ï¼šhttp://localhost:8000/order/create?userId=1&productId=100

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/823e06f1c59c4044859ce5d074b72769.png)

æ¥ä¸‹æ¥å°±å¯ä»¥å¯¹èµ„æºè¿›è¡Œæµæ§ã€‚

QPSï¼šæ¯ç§’èƒ½æ¥æ”¶çš„è¯·æ±‚æ•°

### 5 å¼‚å¸¸å¤„ç†

![image.png](https://i-blog.csdnimg.cn/img_convert/e6c232f52208a58356e1e1acf427e19d.png)

#### 5.1 è‡ªå®šä¹‰ BlockExceptionHandler

ç›®çš„ï¼šå¤„ç†ä¸šåŠ¡å¼‚å¸¸ï¼Œå‡ºç°å¼‚å¸¸å¯ä»¥ç»™å‰ç«¯ä¼ é€’ä¸€äº›æ¶ˆæ¯ã€‚

å®ç°
`BlockExceptionHandler`
æ¥å£ï¼Œå¤„ç†æµæ§/ç†”æ–­å¼‚å¸¸ï¼š

```java
// orderæ¨¡å—ä¸‹
@Component
public class MyBlockExceptionHandler implements BlockExceptionHandler {
    private ObjectMapper objectMapper = new ObjectMapper();
    @Override
    public void handle(HttpServletRequest request, HttpServletResponse response,
                       String resourceName, BlockException e) throws Exception {
        response.setStatus(429); //too many requests
        response.setContentType("application/json;charset=utf-8");

        PrintWriter writer = response.getWriter();


        R error = R.error(500, resourceName + " è¢«Sentinelé™åˆ¶äº†ï¼ŒåŸå› ï¼š" + e.getClass());

        String json = objectMapper.writeValueAsString(error);
        writer.write(json);

        writer.flush();
        writer.close();
    }
}

```

#### 5.2 blockHandler

ä½¿ç”¨
`@SentinelResource`
æ³¨è§£æŒ‡å®šé™çº§æ–¹æ³•ï¼š

```java
 @SentinelResource(value = "createOrder",blockHandler = "createOrderFallback")
    @Override
    public Order createOrder(Long productId, Long userId) {
//        Product product = getProductFromRemoteWithLoadBalanceAnnotation(productId);

        //ä½¿ç”¨Feignå®Œæˆè¿œç¨‹è°ƒç”¨
        Product product = productFeignClient.getProductById(productId);
        Order order = new Order();
        order.setId(1L);


        // æ€»é‡‘é¢
        order.setTotalAmount(product.getPrice().multiply(new BigDecimal(product.getNum())));
        order.setUserId(userId);
        order.setNickName("zhangsan");
        order.setAddress("å°šç¡…è°·");
        //è¿œç¨‹æŸ¥è¯¢å•†å“åˆ—è¡¨
        order.setProductList(Arrays.asList(product));
        return order;
    }


    //å‡ºç°å¼‚å¸¸ï¼Œå…œåº•å›è°ƒ
    public Order createOrderFallback(Long productId, Long userId, BlockException e){
        Order order = new Order();
        order.setId(0L);
        order.setTotalAmount(new BigDecimal("0"));
        order.setUserId(userId);
        order.setNickName("æœªçŸ¥ç”¨æˆ·");
        order.setAddress("å¼‚å¸¸ä¿¡æ¯ï¼š"+e.getClass());
        return order;
    }
//æ²¡è‡ªå®šä¹‰å¼‚å¸¸ï¼Œå°±ä¼šè‡ªåŠ¨å‘ä¸ŠæŠ›ï¼Œæœ€åç»™Springçš„å…¨å±€æ‹¦æˆªå™¨æ•è·åˆ°ï¼Œç”±springå»å¤„ç†å¼‚å¸¸

```

#### 5.3 OpenFeign-å…œåº•å›è°ƒ

1. å®ç° Fallback ç±»ï¼š

```java
@FeignClient(value = "service-product",fallback = ProductFeignClientFallback.class) // feignå®¢æˆ·ç«¯
public interface ProductFeignClient {


    //mvcæ³¨è§£çš„ä¸¤å¥—ä½¿ç”¨é€»è¾‘
    //1ã€æ ‡æ³¨åœ¨Controllerä¸Šï¼Œæ˜¯æ¥å—è¿™æ ·çš„è¯·æ±‚
    //2ã€æ ‡æ³¨åœ¨FeignClientä¸Šï¼Œæ˜¯å‘é€è¿™æ ·çš„è¯·æ±‚
    @GetMapping("/product/{id}")
    Product getProductById(@PathVariable("id") Long id);


}

```

2.åœ¨ Feign æ¥å£ä¸­æŒ‡å®šï¼š

```java
@FeignClient(name = "user-service", fallback = UserServiceFallback.class)
public interface UserService { /* ... */ }

```

### 6 è§„åˆ™ - æµé‡æ§åˆ¶

![image.png](https://i-blog.csdnimg.cn/img_convert/00068ac67a04e7f75afdacc677b2c717.png)

#### 6.1 é˜ˆå€¼ç±»å‹

* **QPS**
  ï¼šæ¯ç§’è¯·æ±‚æ•°ã€‚
* **çº¿ç¨‹æ•°**
  ï¼šå¹¶å‘çº¿ç¨‹æ•°ã€‚

#### 6.2 æµæ§æ¨¡å¼

![img](https://i-blog.csdnimg.cn/img_convert/77abcd5bcedeb749dcea468955615ce8.png)

* **ç›´æ¥**
  ï¼šé’ˆå¯¹å½“å‰èµ„æºã€‚
* **å…³è”**
  ï¼šå…³è”èµ„æºè§¦å‘é˜ˆå€¼æ—¶é™æµã€‚
* **é“¾è·¯**
  ï¼šåŸºäºè°ƒç”¨é“¾è·¯é™æµã€‚

#### 6.3 æµæ§æ•ˆæœ

![image.png](https://i-blog.csdnimg.cn/img_convert/904fcb6a25720e81d69e2912070961e3.png)

* **å¿«é€Ÿå¤±è´¥**
  ï¼šç›´æ¥æ‹’ç»è¯·æ±‚ã€‚
* **Warm Up**
  ï¼šé¢„çƒ­æ¨¡å¼ï¼Œé€æ­¥å¢åŠ é˜ˆå€¼ã€‚
* **æ’é˜Ÿç­‰å¾…**
  ï¼šè¯·æ±‚è¿›å…¥é˜Ÿåˆ—ç­‰å¾…å¤„ç†ã€‚

---

### 7 è§„åˆ™ - ç†”æ–­é™çº§

#### 7.1 æ–­è·¯å™¨çŠ¶æ€

![image.png](https://i-blog.csdnimg.cn/img_convert/b1b617a3dd7bed7fc657fc07d1ea935a.png)

* **Closed**
  ï¼šæ­£å¸¸çŠ¶æ€ã€‚
* **Open**
  ï¼šç†”æ–­çŠ¶æ€ï¼Œæ‹’ç»æ‰€æœ‰è¯·æ±‚ã€‚
* **Half-Open**
  ï¼šå°è¯•æ”¾è¡Œéƒ¨åˆ†è¯·æ±‚æ¢æµ‹æ¢å¤æƒ…å†µã€‚

#### 7.2 å·¥ä½œåŸç†

![image.png](https://i-blog.csdnimg.cn/img_convert/f12fbe8e67b10b53de5cbb9b043a53a3.png)

* **æ…¢è°ƒç”¨æ¯”ä¾‹**
  ï¼šå“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼ä¸”æ¯”ä¾‹è¶…é™ã€‚
* **å¼‚å¸¸æ¯”ä¾‹**
  ï¼šå¼‚å¸¸æ¯”ä¾‹è¶…é™ã€‚
* **å¼‚å¸¸æ•°**
  ï¼šå¼‚å¸¸æ•°è¶…é™ã€‚

#### 7.3 ç†”æ–­ä¸å…œåº•

![image.png](https://i-blog.csdnimg.cn/img_convert/043bc37cd7508234f25ad1accd595d98.png)

---

### 8 è§„åˆ™ - çƒ­ç‚¹å‚æ•°

![image.png](https://i-blog.csdnimg.cn/img_convert/ec9509daddb8e8cc8ad51926e7e5628f.png)

#### 8.1 ç¯å¢ƒæ­å»º

1. æ·»åŠ çƒ­ç‚¹å‚æ•°é™æµè§„åˆ™ï¼š

```java
 @GetMapping("/seckill")
    @SentinelResource(value = "seckill-order",fallback = "seckillFallback")
    public Order seckill(@RequestParam(value = "userId",required = false) Long userId,
                         @RequestParam(value = "productId",defaultValue = "1000") Long productId){
        Order order = orderService.createOrder(productId, userId);
        order.setId(Long.MAX_VALUE);
        return order;
    }

    public Order seckillFallback(Long userId,Long productId, BlockException exception){
        System.out.println("seckillFallback....");
        Order order = new Order();
        order.setId(productId);
        order.setUserId(userId);
        order.setAddress("å¼‚å¸¸ä¿¡æ¯ï¼š"+exception.getClass());
        return order;
    }

```

---

### é‡ç‚¹æ€»ç»“

1. **æ ¸å¿ƒåŠŸèƒ½**
   ï¼š
   * æµé‡æ§åˆ¶ï¼ˆQPS/çº¿ç¨‹æ•°ï¼‰ã€ç†”æ–­é™çº§ï¼ˆæ…¢è°ƒç”¨/å¼‚å¸¸æ¯”ä¾‹ï¼‰ã€çƒ­ç‚¹å‚æ•°é™æµã€‚
2. **ä¼˜åŠ¿**
   ï¼š
   * åŠ¨æ€è§„åˆ™é…ç½®ï¼Œå®æ—¶ç›‘æ§ï¼Œä¸ Spring Cloud æ— ç¼é›†æˆã€‚
3. **å®æ“å…³é”®**
   ï¼š
   * æ§åˆ¶å°å¯åŠ¨åéœ€é…ç½®
     `spring.cloud.sentinel.transport.dashboard`
     ã€‚
   * ä½¿ç”¨
     `@SentinelResource`
     å®šä¹‰èµ„æºå’Œé™çº§é€»è¾‘ã€‚
   * OpenFeign éœ€ç»“åˆ Fallback ç±»å®ç°æœåŠ¡é™çº§ã€‚
4. **æ³¨æ„äº‹é¡¹**
   ï¼š
   * è§„åˆ™é…ç½®åéœ€æŒä¹…åŒ–åˆ° Nacos/Redisï¼Œé¿å…é‡å¯ä¸¢å¤±ã€‚
   * ç”Ÿäº§ç¯å¢ƒå»ºè®®å¼€å¯ Sentinel çš„é›†ç¾¤æµæ§åŠŸèƒ½ã€‚