---
layout: post
title: "redisredis持久化"
date: 2025-03-02 19:01:04 +0800
description: "两种持久化方式（1）RDB（Redis DataBase）：内存中数据直接写入文件中（2）AOF（Append Of File）：以追加的行为把内容写入文件中。"
keywords: "【redis】redis持久化"
categories: ['面试题汇总与解析']
tags: ['课程设计', 'Vue', 'Spring', 'Mysql', 'Java', 'Boot']
artid: "145968000"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145968000
    alt: "redisredis持久化"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145968000
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145968000
cover: https://bing.ee123.net/img/rand?artid=145968000
image: https://bing.ee123.net/img/rand?artid=145968000
img: https://bing.ee123.net/img/rand?artid=145968000
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【redis】redis持久化
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <div>
     <div class="note-content">
      <h2>
       1、简介
      </h2>
      <p>
       两种持久化方式
      </p>
      <p>
       （1）RDB（Redis DataBase）：内存中数据直接写入文件中
      </p>
      <p>
       （2）AOF（Append Of File）：以追加的行为把内容写入文件中
      </p>
      <h2>
       2、RDB
      </h2>
      <p>
       （1）概念：
      </p>
      <p>
       指定的时间间隔内讲内存中的数据集快照写入磁盘，它恢复时可以将快照文件直接读到内存里
      </p>
      <p>
       （2）RDB持久化流程：
      </p>
      <p>
       Redis会单独创建fork一个子进程来进行持久化，先将数据写入一个临时文件中，待持久化过程结束后，再用这个临时文件替换上次持久化的文件，RDB方式比AOF文件更加高效，缺点是最后一次持久化的数据可能丢失。
      </p>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 705px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/da213ea8bf12395ea7f0c90c9419ddbb.png">
         </img>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 396px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/deb335f89b903ce7f3dd5fa622df13d2.png">
         </img>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <p>
       （3）Fork：
      </p>
      <p>
       写时复制技术：新进程的所有数据（变量、环境变量、程序计数器等）数值都有原进程一致。
      </p>
      <p>
       Redis会在后台异步进行快照操作，快照同时还可以响应客户端请求。
       <br/>
       具体操作是Redis进程执行fork操作创建子进程，RDB持久化过程由子进程负责，完成后自动结束。
       <br/>
       阻塞只发生在fork阶段，一般时间很短。
      </p>
      <p>
       RDB依赖于主进程fork，在更大的数据集中，这可能会导致服务请求的瞬间延迟。
       <br/>
       fork的时候，内存中的数据备克隆了一份，大致2倍的膨胀性，需要考虑。
      </p>
      <p>
       （4）redis.conf配置内RDB相关配置（SNAPSHOTTING内配置）
      </p>
      <p>
       rdb文件名：dbfilename dump.rdb
      </p>
      <p>
       文件产生的路径，默认值(启动程序的位置)：dir ./
      </p>
      <div class="image-package">
       <div class="image-container" style="max-width: 643px; max-height: 422px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/ce1ec7590ff4feedf4490b27b149d756.png">
         </img>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 405px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/4a2d97479dd16d26d118e0673fcf5797.png">
         </img>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <p>
       快照的时间间隔：
      </p>
      <pre><code># save 3600 1
# save 300 100
# save 60 10000
</code></pre>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 317px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/fafeb77bc2787d6e8eaaa7c1dc235f77.png">
         </img>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 328px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/74122e562e87c4f33f17075836a0d33e.png">
         </img>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 494px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/d47783674cc917db019d5de4a4fa1685.png">
         </img>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <p>
       3、AOF
      </p>
      <p>
       （1）概念：
      </p>
      <p>
       以日志形式来记录每个写操作（增量保存），将Redis执行过的所有写指令记录下来（读操作不记录），只许追加文件但不可以改写文件，redis启动之初会读取该文件重新构建数。
      </p>
      <p>
       优点：备份机制更稳健，丢失数据概率更低，通过操作AOF文件可以处理误操作
       <br/>
       缺点：比RDB占用更多磁盘，恢复备份速度慢，每次读写都同步的话有性能压力
      </p>
      <p>
       （2）AOF持久化流程
      </p>
      <p>
       客户端在请求写命令时会被append追加到AOF缓冲区内
      </p>
      <p>
       AOF缓冲区根据AOF持久化策略[always,everysec,no]将操作sync同步到磁盘的AOF文件中
      </p>
      <p>
       AOF文件大小超过重写策略或手动重写时，会对AOF文件rewrite重写，压缩AOF文件容量
      </p>
      <p>
       Redis服务重启时，会重新load加载AOF文件中的写操作达到数据恢复的目的
      </p>
      <p>
       （2）AOF持久化流程
      </p>
      <p>
       客户端在请求写命令时会被append追加到AOF缓冲区内
      </p>
      <p>
       AOF缓冲区根据AOF持久化策略[always,everysec,no]将操作sync同步到磁盘的AOF文件中
      </p>
      <p>
       AOF文件大小超过重写策略或手动重写时，会对AOF文件rewrite重写，压缩AOF文件容量
      </p>
      <p>
       Redis服务重启时，会重新load加载AOF文件中的写操作达到数据恢复的目的
      </p>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 732px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/b23332e9b49ccb0103f835e622e8355d.png">
         </img>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 428px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/4cf60e0e601bbbc4ef5b85938446d15d.png"/>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <blockquote>
       <p>
        AOF文件rewrite重写
       </p>
      </blockquote>
      <p>
       AOF（Append Only File）是 Redis 中一种持久化数据的方式。
       <br/>
       当 Redis 将数据写入内存后，会将数据写入 AOF 文件中，以便在 Redis 重启时恢复数据。
       <br/>
       AOF 文件包含了一系列 Redis 命令，这些命令记录了 Redis 服务器所执行的所有操作。
      </p>
      <p>
       由于 AOF 文件会不断增长，所以 Redis 提供了 AOF 重写（rewrite）机制来优化 AOF 文件，减少文件大小。
       <br/>
       AOF 重写是通过读取内存中的数据并将其写入新的 AOF 文件来实现的。
       <br/>
       重写过程中，Redis 会将一些命令合并成一个命令，以减少 AOF 文件的大小。
      </p>
      <p>
       AOF 重写的触发条件有两个：
      </p>
      <ol>
       <li>
        <p>
         手动触发：可以通过执行 BGREWRITEAOF 命令手动触发 AOF 重写。
        </p>
       </li>
       <li>
        <p>
         自动触发：当 AOF 文件的大小超过了配置文件中指定的阈值时，Redis 会自动触发 AOF 重写。
        </p>
       </li>
      </ol>
      <p>
       AOF 重写的过程如下：
      </p>
      <ol>
       <li>
        <p>
         Redis 在后台创建一个子进程。
        </p>
       </li>
       <li>
        <p>
         子进程开始遍历 Redis 的所有键值对，并将其转换为一系列命令。
        </p>
       </li>
       <li>
        <p>
         子进程将这些命令写入新的 AOF 文件中。
        </p>
       </li>
       <li>
        <p>
         子进程完成后，将新的 AOF 文件重命名为原来的 AOF 文件，覆盖原来的 AOF 文件。
        </p>
       </li>
       <li>
        <p>
         Redis 继续将新的命令写入新的 AOF 文件中。
        </p>
       </li>
      </ol>
      <p>
       需要注意的是，AOF 重写是一个耗时的操作，可能会占用大量的 CPU 和内存资源。
       <br/>
       为了避免影响 Redis 的性能，可以通过配置 AOF 重写的触发条件和间隔时间来控制 AOF 重写的频率。
       <br/>
       总之，AOF 重写是 Redis 中一种优化 AOF 文件的机制，可以减少 AOF 文件的大小，提高 Redis 的性能和稳定性。
      </p>
      <p>
       （3） redis.conf关于AOF相关配置：
      </p>
      <p>
       开启AOF默认：，默认不开启no，开启需要修改为yes
      </p>
      <pre><code>appendonly no
</code></pre>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 388px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/9e0d1c350c3cb01be68d4dbaca7365ea.png"/>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <p>
       AOF生成文件名：默认为appendonly.aof，生成的路径同RDB
      </p>
      <pre><code>appendfilename "appendonly.aof"
</code></pre>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 462px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/851ffa13881e416fce7c6638a4aa2dd9.png"/>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <p>
       保存文件生成，同时开启AOF与RDB时，系统会使用AOF保存数据：
      </p>
      <br/>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 224px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/8e0249815b5e8862536e45039bce073d.png"/>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <p>
       当AOF文件损坏，可通过如下命令执行文件修复：
      </p>
      <pre><code>redis-check-aof --fix   appendonly.aof

</code></pre>
      <div class="image-package">
       <div class="image-container" style="max-width: 677px; max-height: 168px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/86a6806bb1386eb06c2289f75c2bbaa2.png"/>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <p>
       AOF同步频率设置
      </p>
      <p>
       设置始终同步：appendfsync always，性能较差，但是数据完整性好
      </p>
      <p>
       每秒同步：appendfsync everysec
       <br/>
       把同步时机交给操作系统：appendfsync no
      </p>
      <pre><code># appendfsync always
appendfsync everysec
# appendfsync no

</code></pre>
      <div class="image-package">
       <div class="image-container" style="max-width: 432px; max-height: 97px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/f32b782a287a57bb0825b6b080e1d759.png"/>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 346px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/73a753bc005c3281b7ae5108c01f19a4.png"/>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <p>
       rewrite压缩
      </p>
      <p>
       当AOF文件大小超过所设定的阈值时（&gt;=64M*2），Redis会启动AOF的内容压缩，只保留可以恢复数据的最小指令集，可以使用命令bgrewriteaof开启此功能。
      </p>
      <p>
       使用fork子进程将原来文件重写，把rdb的快照已二进制形式附在新的aof头部，作为已有的历史数据据，替换原有的流水账操作。
      </p>
      <pre><code>no-appendfsync-on-rewrite no
</code></pre>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 508px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/139faba93a2cdda7265b40b6d1ac1e3c.png"/>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <div class="image-package">
       <div class="image-container" style="max-width: 700px; max-height: 480px;">
        <div class="image-container-fill">
        </div>
        <div class="image-view">
         <img src="https://i-blog.csdnimg.cn/img_convert/d99a6b6ab0a2bb9a3c57c3d71d358674.png"/>
        </div>
       </div>
       <div class="image-caption">
        image.png
       </div>
      </div>
      <h2>
       参考
      </h2>
      <p>
       Redis持久化：RDB和AOF
       <br/>
       <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FIaJrBwUuJt_DFjIynIzF5g" rel="nofollow noopener noreferrer" target="_blank">
        https://mp.weixin.qq.com/s/IaJrBwUuJt_DFjIynIzF5g
       </a>
      </p>
      <p>
       Redis 持久化方式介绍 RDB+AOF，混合持久化
       <br/>
       <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FoKXR5-iLJcEqBYj8P36LyA" rel="nofollow noopener noreferrer" target="_blank">
        https://mp.weixin.qq.com/s/oKXR5-iLJcEqBYj8P36LyA
       </a>
      </p>
      <p>
       redis6.x使用指导完整版
       <br/>
       <a href="https://links.jianshu.com/go?to=https%3A%2F%2Fwww.cnblogs.com%2Fmrwhite2020%2Fp%2F14727548.html" rel="nofollow noopener noreferrer" target="_blank">
        https://www.cnblogs.com/mrwhite2020/p/14727548.html
       </a>
      </p>
     </div>
     <div class="note-meta-time">
      最后编辑于：2025-02-24 20:47:10
     </div>
     <div class="copyright">
      © 
   著作权归作者所有,转载或内容合作请联系作者
     </div>
    </div>
    <br/>
    <img src="https://img-blog.csdnimg.cn/direct/67c64049147741939b85489caefbb597.png" width="800px"/>
    <br/>
    <p style="font-weight: 700;">
     喜欢的朋友记得点赞、收藏、关注哦！！！
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f726974615f303536372f:61727469636c652f64657461696c732f313435393638303030" class_="artid" style="display:none">
 </p>
</div>


