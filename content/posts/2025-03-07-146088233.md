---
layout: post
title: "如何监控-Pod-的-CPU内存使用率,prometheusgrafana"
date: 2025-03-07 10:14:07 +0800
description: "如何监控 Pod 的 CPU/内存使用率？是否配置过 Prometheus + Grafana？ "
keywords: "如何监控 Pod 的 CPU/内存使用率，prometheus+grafana"
categories: ['运维']
tags: ['运维', 'Kubernetes']
artid: "146088233"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146088233
    alt: "如何监控-Pod-的-CPU内存使用率,prometheusgrafana"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146088233
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146088233
cover: https://bing.ee123.net/img/rand?artid=146088233
image: https://bing.ee123.net/img/rand?artid=146088233
img: https://bing.ee123.net/img/rand?artid=146088233
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     如何监控 Pod 的 CPU/内存使用率，prometheus+grafana
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h4>
     <strong>
      一、监控 Pod 的 CPU/内存使用率的方法
     </strong>
    </h4>
    <h5>
     <strong>
      1. 使用
      <code>
       kubectl top
      </code>
      命令（临时检查）
     </strong>
    </h5>
    <pre># 查看所有 Pod 的资源使用率（需安装 Metrics Server）
kubectl top pods --all-namespaces
​
# 查看指定命名空间的 Pod
kubectl top pods -n &lt;namespace&gt;
​
# 查看单个 Pod 的详细指标
kubectl top pod &lt;pod-name&gt; -n &lt;namespace&gt;</pre>
    <h5>
     <strong>
      2. 通过 Metrics Server 获取数据
     </strong>
    </h5>
    <p>
     •
     <strong>
      安装 Metrics Server
     </strong>
     （集群级监控核心组件）：
    </p>
    <pre>kubectl apply -f https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</pre>
    <p>
     •
     <strong>
      查询 Pod 资源使用率
     </strong>
     ：
    </p>
    <pre>  # 查看 Pod 列表并按 CPU 排序
  kubectl get pods --sort-by=cpu
​
  # 获取指定 Pod 的详细资源使用率
  kubectl describe pod &lt;pod-name&gt; -n &lt;namespace&gt; | grep -E "^Resource|cpu|memory"</pre>
    <hr/>
    <h4>
     <strong>
      二、配置 Prometheus + Grafana 监控（长期可视化方案）
     </strong>
    </h4>
    <h5>
     <strong>
      1. 部署 Prometheus（数据采集）
     </strong>
    </h5>
    <pre># 创建 Prometheus 配置文件 `prometheus.yaml`
apiVersion: monitoring.coreos.com/v1
kind: Prometheus
metadata:
  name: prometheus
  namespace: monitoring
spec:
  serviceAccountName: prometheus
  storage:
    configMap:
      name: prometheus-storage
  scrape_configs:
    - jobName: 'kubernetes-pods'
      kubernetes_sd_configs:
        - role: pod
      relabel_configs:
        - source_labels: [__meta_kubernetes_pod_label_app]
          action: keep
          regex: my-app.*</pre>
    <h5>
     <strong>
      2. 部署 Grafana（可视化界面）
     </strong>
    </h5>
    <pre># 创建 Grafana 配置文件 `grafana.yaml`
apiVersion: 1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: monitoring
data:
  grafana.ini: |
    [datasources]
    [datasources.prometheus]
      name = Prometheus
      type = prometheus
      url = http://prometheus-server.monitoring.svc.cluster.local:9090
​
# 部署 Grafana
kubectl apply -f https://raw.githubusercontent.com/grafana/grafana/master/k8s/deployments.yaml</pre>
    <h5>
     <strong>
      3. 访问 Grafana 并配置监控面板
     </strong>
    </h5>
    <ol>
     <li>
      <p>
       获取 Grafana 服务地址：
      </p>
      <pre>kubectl get svc -n monitoring grafana --output=jsonpath='{.status.loadBalancer.ingress[0].hostname}'</pre>
     </li>
     <li>
      <p>
       登录 Grafana（默认账号密码：
       <code>
        admin/admin
       </code>
       ），添加 Prometheus 数据源。
      </p>
     </li>
     <li>
      <p>
       <strong>
        创建 Pod 监控仪表盘
       </strong>
       ： • 添加新面板，选择 Prometheus 作为数据源。 • 查询语句：
      </p>
      <pre>  # CPU 使用率（按 Pod 名称分组）
  sum by (pod_name) (container_cpu_usage_seconds_total{container="app"} / 10^9)
​
  # 内存使用率（按 Pod 名称分组）
  sum by (pod_name) (container_memory_usage_bytes_total{container="app"} / 1024^3)</pre>
     </li>
    </ol>
    <hr/>
    <h4>
     <strong>
      三、关键配置与优化
     </strong>
    </h4>
    <h5>
     <strong>
      1. Prometheus 抓取 Pod 指标
     </strong>
    </h5>
    <p>
     •
     <strong>
      启用 Pod 级别监控
     </strong>
     ：
    </p>
    <pre># 在 Prometheus 配置中添加以下内容
scrape_configs:
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod</pre>
    <p>
     •
     <strong>
      通过标签过滤特定 Pod
     </strong>
     ：
    </p>
    <pre># 监控名称包含 "my-app" 的 Pod
sum by (pod_name) (container_cpu_usage_seconds_total{container="app", pod_name=~"my-app.*"})</pre>
    <h5>
     <strong>
      2. Grafana 仪表盘优化
     </strong>
    </h5>
    <p>
     •
     <strong>
      自动刷新
     </strong>
     ：设置面板刷新间隔为
     <code>
      10s
     </code>
     。
    </p>
    <p>
     •
     <strong>
      预警规则
     </strong>
     ：
    </p>
    <p>
     •
     <strong>
      CPU 高负载
     </strong>
     （示例）：
     <code>
      promql rate(container_cpu_usage_seconds_total{container="app"}[5m]) &gt; 0.8
     </code>
    </p>
    <p>
     •
     <strong>
      内存不足
     </strong>
     （示例）：
     <code>
      promql container_memory_usage_bytes_total{container="app"} &gt; 1024*1024*512 # 512MB
     </code>
    </p>
    <h5>
     <strong>
      3. 资源限制与成本控制
     </strong>
    </h5>
    <p>
     •
     <strong>
      为 Prometheus 设置资源限制
     </strong>
     ：
    </p>
    <pre>limits:
  cpu: '1'
  memory: '2Gi'</pre>
    <p>
     •
     <strong>
      启用持久化存储
     </strong>
     （根据需求选择）：
    </p>
    <pre>storage:
  persistentVolumeClaim:
    claimName: prometheus-pvc</pre>
    <hr/>
    <h4>
     <strong>
      四、验证监控效果
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        检查 Prometheus 数据
       </strong>
       ：
      </p>
      <pre>curl http://prometheus-server.monitoring.svc.cluster.local:9090/api/v1/query?query=sum(container_cpu_usage_seconds_total%7Bcontainer%3D%22app%22%7D)</pre>
     </li>
     <li>
      <p>
       <strong>
        在 Grafana 中验证面板
       </strong>
       ：
      </p>
     </li>
    </ol>
    <p>
     • 确保 Pod 的 CPU/内存曲线随负载变化实时更新。
     <br/>
     • 测试预警规则是否触发。
    </p>
    <hr/>
    <h4>
     <strong>
      五、常见问题排查
     </strong>
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        现象
       </th>
       <th>
        解决方案
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        Prometheus 无数据
       </td>
       <td>
        1. 检查 Metrics Server 是否正常运行 2. 确认 Prometheus 配置中的
        <code>
         kubernetes_sd_configs
        </code>
        正确指向 Pod
       </td>
      </tr>
      <tr>
       <td>
        Grafana 无法连接 Prometheus
       </td>
       <td>
        1. 检查防火墙规则 2. 确认 Prometheus 服务端口
        <code>
         9090
        </code>
        开放 3. 验证 RBAC 权限（Grafana 需要访问 Prometheus）
       </td>
      </tr>
      <tr>
       <td>
        数据延迟
       </td>
       <td>
        调整 Prometheus 抓取间隔（默认
        <code>
         10s
        </code>
        ）或增加历史数据保留时间。
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h4>
     <strong>
      总结
     </strong>
    </h4>
    <p>
     通过 Prometheus + Grafana 可以实现：
    </p>
    <p>
     •
     <strong>
      实时监控
     </strong>
     ：Pod 级 CPU/内存使用率可视化。
    </p>
    <p>
     •
     <strong>
      智能告警
     </strong>
     ：基于阈值自动触发通知（集成 Alertmanager）。
    </p>
    <p>
     •
     <strong>
      历史分析
     </strong>
     ：长期资源消耗趋势分析。
    </p>
    <p>
     •
     <strong>
      成本优化
     </strong>
     ：根据监控数据调整 Pod 数量和资源配额。
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f626c747975323030302f:61727469636c652f64657461696c732f313436303838323333" class_="artid" style="display:none">
 </p>
</div>


