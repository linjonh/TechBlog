---
layout: post
title: "Android-Espresso测试Intents,WebView"
date: 2022-11-28 10:29:25 +0800
description: "通过Espresso测试Intents,WebView(AndroidStudio)（一）Espre"
keywords: "espresso获取 页面intent"
categories: ['应用层开发', 'Android']
tags: ['测试', 'Webview', 'Espresso', 'Android']
artid: "51994135"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=51994135
    alt: "Android-Espresso测试Intents,WebView"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=51994135
featuredImagePreview: https://bing.ee123.net/img/rand?artid=51994135
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Android Espresso测试Intents，WebView
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <strong>
      上篇写了通过Espresso测试Button这样的普通view和AdpterView类型的view，及Espresso基本使用方式
     </strong>
    </p>
    <p>
     <a href="http://blog.csdn.net/hexingen/article/details/51971427">
      http://blog.csdn.net/hexingen/article/details/51971427
     </a>
     （有兴趣的可以查看）
    </p>
    <p>
     <strong>
      本篇写通过Espresso测试Intents,WebView
     </strong>
    </p>
    <p>
     <strong>
      （一）Espresso测试Intent的开启和返回值：
     </strong>
    </p>
    <pre><code> 使用配置：espresso-intents.jar
        espresso-intents包是  Espresso的一个扩展包。（介绍）
        espresso-intents包是用在Espresso 2.1+和0.3以上的testing library上（注意点）

 使用步骤：
    1.安装Espresso-Intents（前提是开发工具ide中已经安装Android Support Repository ） 

       在gradle中原本的依赖包上多添加：
      androidTestCompile 'com.android.support.test.espresso:espresso-intents:2.2.2'

    2.IntentsTestRule是替代 ActivityTestRule ，
           它是 ActivityTestRule的延伸（ 具备ActivityTestRule的特性），
           初始化 Espresso-Intents是在注解 @Test之前，释放是测试运行完后。 

    3.Intent validation：验证intent  

    4.Intent stubbing:给intent添加返回值

    5.Intent matchers：intending（）和intended （）中参数都是一个Matcher&lt;Intent&gt; 
</code></pre>
    <p>
     guithub上对应案例：
     <br/>
     <a href="https://github.com/googlesamples/android-testing/tree/master/ui/espresso/IntentsBasicSample">
      https://github.com/googlesamples/android-testing/tree/master/ui/espresso/IntentsBasicSample
     </a>
    </p>
    <p>
     开始编写：
     <br/>
     <strong>
      1.在项目的，xxx.gridle中添加依赖包：
     </strong>
    </p>
    <pre class="prettyprint"><code class="hljs cs">dependencies {
    testCompile <span class="hljs-string">'junit:junit:4.12'</span>
    compile <span class="hljs-string">'com.android.support:appcompat-v7:23.3.0'</span>
    <span class="hljs-comment">//添加注解，包含test</span>
    compile <span class="hljs-string">'com.android.support:support-annotations:23.3.0'</span>
    <span class="hljs-comment">//解决冲突</span>
    androidTestCompile <span class="hljs-string">'com.android.support:support-annotations:23.3.0'</span>
    <span class="hljs-comment">// Android JUnit Runner</span>
    androidTestCompile <span class="hljs-string">'com.android.support.test:runner:0.5'</span>
    <span class="hljs-comment">// JUnit4 Rules</span>
    androidTestCompile <span class="hljs-string">'com.android.support.test:rules:0.5'</span>
    <span class="hljs-comment">// Espresso core</span>
    androidTestCompile <span class="hljs-string">'com.android.support.test.espresso:espresso-core:2.2.2'</span>
    <span class="hljs-comment">//Espresso-Intents只支持 Espresso 2.1+和0.3以上版本的test包以上</span>
    androidTestCompile <span class="hljs-string">'com.android.support.test.espresso:espresso-intents:2.2.2'</span>

}</code></pre>
    <p>
     <strong>
      2.编写开启intent,和intent返回值的代码：
     </strong>
    </p>
    <p>
     MainActivity.java中代码：
    </p>
    <pre class="prettyprint"><code class="hljs java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> REQUESTCODE=<span class="hljs-number">1</span>;
    <span class="hljs-comment">//开启intent</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">openIntentActiivty</span>(View view){
        Intent intent=<span class="hljs-keyword">new</span> Intent(<span class="hljs-keyword">this</span>,IntentActivity.class);
        startActivityForResult(intent,REQUESTCODE);
    }
    <span class="hljs-comment">//接受intent的返回数据</span>
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onActivityResult</span>(<span class="hljs-keyword">int</span> requestCode, <span class="hljs-keyword">int</span> resultCode, Intent data) {
        <span class="hljs-keyword">switch</span> (requestCode){
            <span class="hljs-keyword">case</span> REQUESTCODE:
                <span class="hljs-keyword">if</span>(resultCode== AppCompatActivity.RESULT_OK){
                   String s= data.getStringExtra(IntentActivity.TAG);
                    showToas(<span class="hljs-string">"intent test "</span>+s);
                }
                <span class="hljs-keyword">break</span>;

        }
        <span class="hljs-keyword">super</span>.onActivityResult(requestCode, resultCode, data);
    }</code></pre>
    <p>
     IntentActivity.java：
    </p>
    <pre class="prettyprint"><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">IntentActivity</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span> {<!-- --></span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String TAG=IntentActivity.class.getSimpleName();
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span>(@Nullable Bundle savedInstanceState) {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);
        setContentView(<span class="hljs-keyword">new</span> TextView(<span class="hljs-keyword">this</span>));
        setResult(AppCompatActivity.RESULT_OK,createResultData(<span class="hljs-string">"sucess"</span>));
        <span class="hljs-keyword">this</span>.finish();
    }
    <span class="hljs-annotation">@VisibleForTesting</span>
    <span class="hljs-keyword">static</span> Intent  createResultData(String s){
        Intent intent  =<span class="hljs-keyword">new</span> Intent();
        intent.putExtra(TAG,s);
        <span class="hljs-keyword">return</span>  intent;
    }
}</code></pre>
    <p>
     <strong>
      3.最重要的步骤：编写测试代码：
     </strong>
    </p>
    <p>
     MainActivityTest.java:
    </p>
    <pre class="prettyprint"><code class="hljs java"><span class="hljs-annotation">@RunWith</span>(AndroidJUnit4.class)
<span class="hljs-annotation">@LargeTest</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainActivityTest</span> {<!-- --></span>
    <span class="hljs-javadoc">/**
     * IntentsTestRule替代ActivityTestRule
     *<span class="hljs-javadoctag"> @Rule</span>是在  <span class="hljs-javadoctag"> @Test</span>之前运行，进行初始化
     */</span>
    <span class="hljs-annotation">@Rule</span>
    <span class="hljs-keyword">public</span> IntentsTestRule&lt;MainActivity&gt; activityTestRule= 
             <span class="hljs-keyword">new</span> IntentsTestRule&lt;MainActivity&gt;(MainActivity.class);

    <span class="hljs-annotation">@Test</span> <span class="hljs-comment">//测试intent返回结果</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testIntentActivity</span>(){
        <span class="hljs-comment">//默认Intent是不带有返回值（两个actviity间互传数据）的</span>
        <span class="hljs-comment">//为IntentActivity添加存根，即返回值</span>
        intending(hasComponent(hasShortClassName(<span class="hljs-string">".IntentActivity"</span>)))  
                 .respondWith(<span class="hljs-keyword">new</span> Instrumentation.ActivityResult( 
                  Activity.RESULT_OK, 
                 IntentActivity.createResultData(<span class="hljs-string">"testIntent sucess"</span>))); 

        activityTestRule.getActivity().openIntentActiivty(<span class="hljs-keyword">null</span>);

       <span class="hljs-comment">// intended();记录app在调用intent的结果</span>
    }
}
</code></pre>
    <p>
     <strong>
      4.创建运行的Config（不懂的，看上一篇，有详细解说）,然后运行测试项目，结果如下：
     </strong>
     <br/>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20160722124139073" title="">
     </img>
    </p>
    <p>
     <strong>
      （二）Espresso测试Webview交互：
     </strong>
    </p>
    <pre><code>Espresso-web ： 是一个切入点，在webview中，通过Atoms来操作webview的交互（介绍）

使用步骤：
   1.安装Espresso-Web：

     在gradle中原本的依赖包上多添加：
     androidTestCompile 'com.android.support.test.espresso:espresso-web:2.2.2'

   2.Common WebInteractions（web交互）：

       用于获取webView中加载的html，html中的标签元素：
           withElement(ElementReference)：
           withContextualElement(Atom&lt;ElementReference&gt;) 

       查看标签的 assertion：
               check(WebAssertion)

       html中事件执行：
           perform(Atom)

       reset():当事先操作无效时，使用   
</code></pre>
    <p>
     guithub上对应案例：
     <br/>
     <a href="https://github.com/googlesamples/android-testing/tree/master/ui/espresso/WebBasicSample">
      https://github.com/googlesamples/android-testing/tree/master/ui/espresso/WebBasicSample
     </a>
    </p>
    <p>
     开始编写：
     <br/>
     <strong>
      1.在项目的，xxx.gridle中添加依赖包：
     </strong>
    </p>
    <pre class="prettyprint"><code class="hljs cs">dependencies {
    testCompile <span class="hljs-string">'junit:junit:4.12'</span>
    compile <span class="hljs-string">'com.android.support:appcompat-v7:23.3.0'</span>
    <span class="hljs-comment">//添加注解，包含test</span>
    compile <span class="hljs-string">'com.android.support:support-annotations:23.3.0'</span>
    <span class="hljs-comment">//解决冲突</span>
    androidTestCompile <span class="hljs-string">'com.android.support:support-annotations:23.3.0'</span>
    <span class="hljs-comment">// Android JUnit Runner</span>
    androidTestCompile <span class="hljs-string">'com.android.support.test:runner:0.5'</span>
    <span class="hljs-comment">// JUnit4 Rules</span>
    androidTestCompile <span class="hljs-string">'com.android.support.test:rules:0.5'</span>
    <span class="hljs-comment">// Espresso core</span>
    androidTestCompile <span class="hljs-string">'com.android.support.test.espresso:espresso-core:2.2.2'</span>

    <span class="hljs-comment">//Espresso web</span>
    androidTestCompile <span class="hljs-string">'com.android.support.test.espresso:espresso-web:2.2.2'</span>

}</code></pre>
    <p>
     <strong>
      2.编写WebView加载的html
     </strong>
     <br/>
     这里是本地加载html，进行js交互，在assets下创建一个html的文件：
    </p>
    <p>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20160722130816401" title="">
     </img>
    </p>
    <p>
     webTest.html:
    </p>
    <pre class="prettyprint"><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>Espresso test Web<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">charset</span>=<span class="hljs-value">"utf-8"</span>/&gt;</span>


<span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-title">h1</span>  &gt;</span>Hello Espresso Web!<span class="hljs-tag">&lt;/<span class="hljs-title">h1</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-title">p</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"changContent"</span>&gt;</span>没有改变<span class="hljs-tag">&lt;/<span class="hljs-title">p</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-title">input</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"button"</span> <span class="hljs-attribute">id</span>=<span class="hljs-value">"web_btn"</span> <span class="hljs-attribute">value</span>=<span class="hljs-value">"button"</span> <span class="hljs-attribute">onclick</span>=<span class="hljs-value">"testClick()"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">script</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/javascript"</span>&gt;</span><span class="javascript">
            <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testClick</span><span class="hljs-params">()</span> {<!-- --></span>
                document.getElementById(<span class="hljs-string">"changContent"</span>).innerHTML = <span class="hljs-string">"Espresso test"</span>;
                  android.showToast(<span class="hljs-string">"Espresso test"</span>);
            }
</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span></code></pre>
    <p>
     <strong>
      3. 设置webview可以js交互：
     </strong>
    </p>
    <p>
     WebActivity.java:
    </p>
    <pre class="prettyprint"><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebActivity</span>  <span class="hljs-keyword">extends</span> <span class="hljs-title">AppCompatActivity</span> {<!-- --></span> 

    <span class="hljs-keyword">private</span> WebView  webView;
    <span class="hljs-keyword">private</span>  <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String LOCAL_URL=<span class="hljs-string">"file:///android_asset/webTest.html"</span>;

    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">onCreate</span>(@Nullable Bundle savedInstanceState) {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);
        webView=<span class="hljs-keyword">new</span> WebView(<span class="hljs-keyword">this</span>);
        setContentView(webView);
        <span class="hljs-comment">//允许js交互</span>
        webView.getSettings().setJavaScriptEnabled(<span class="hljs-keyword">true</span>);
        webView.loadUrl(LOCAL_URL);
        webView.setWebViewClient(<span class="hljs-keyword">new</span> WebViewClient(){
            <span class="hljs-annotation">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">shouldOverrideUrlLoading</span>(WebView view, String url) {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
            }
        });

        <span class="hljs-comment">//设置js与android 交互的接口名，接口名为android </span>
        webView.addJavascriptInterface(<span class="hljs-keyword">new</span> WebInterface(),<span class="hljs-string">"android"</span>);
    }

    <span class="hljs-comment">//检查联网权限</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">checkPermission</span>(){
        <span class="hljs-comment">//获取到mamifest中的权限状态</span>
        <span class="hljs-keyword">int</span> permission=  ContextCompat.checkSelfPermission( 
                         <span class="hljs-keyword">this</span>, Manifest.permission.INTERNET);
        <span class="hljs-comment">//权限同意</span>
        <span class="hljs-keyword">int</span> granted= PackageManager.PERMISSION_GRANTED;
        <span class="hljs-keyword">return</span>(permission==granted);
    }

    <span class="hljs-keyword">protected</span>   <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">WebInterface</span>{<!-- --></span>
        <span class="hljs-keyword">public</span> <span class="hljs-title">WebInterface</span>(){}
        <span class="hljs-annotation">@JavascriptInterface</span><span class="hljs-comment">//js回调android端的方法</span>
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">showToast</span>(String s){
            Toast.makeText(WebActivity.<span class="hljs-keyword">this</span>, 
                  s , Toast.LENGTH_SHORT).show();
        }
    }

}</code></pre>
    <p>
     <strong>
      4. 最重要的步骤：编写测试代码：
     </strong>
     <br/>
     创建一个测试类，WebActivityTest.java:
    </p>
    <pre class="prettyprint"><code class="hljs avrasm">import android<span class="hljs-preprocessor">.content</span><span class="hljs-preprocessor">.Intent</span><span class="hljs-comment">;</span>
import android<span class="hljs-preprocessor">.support</span><span class="hljs-preprocessor">.test</span><span class="hljs-preprocessor">.espresso</span><span class="hljs-preprocessor">.web</span><span class="hljs-preprocessor">.webdriver</span><span class="hljs-preprocessor">.Locator</span><span class="hljs-comment">;</span>
import android<span class="hljs-preprocessor">.support</span><span class="hljs-preprocessor">.test</span><span class="hljs-preprocessor">.rule</span><span class="hljs-preprocessor">.ActivityTestRule</span><span class="hljs-comment">;</span>
import android<span class="hljs-preprocessor">.support</span><span class="hljs-preprocessor">.test</span><span class="hljs-preprocessor">.runner</span><span class="hljs-preprocessor">.AndroidJUnit</span>4<span class="hljs-comment">;</span>
import android<span class="hljs-preprocessor">.test</span><span class="hljs-preprocessor">.suitebuilder</span><span class="hljs-preprocessor">.annotation</span><span class="hljs-preprocessor">.LargeTest</span><span class="hljs-comment">;</span>

import org<span class="hljs-preprocessor">.junit</span><span class="hljs-preprocessor">.Rule</span><span class="hljs-comment">;</span>
import org<span class="hljs-preprocessor">.junit</span><span class="hljs-preprocessor">.Test</span><span class="hljs-comment">;</span>
import org<span class="hljs-preprocessor">.junit</span><span class="hljs-preprocessor">.runner</span><span class="hljs-preprocessor">.RunWith</span><span class="hljs-comment">;</span>

import static android<span class="hljs-preprocessor">.support</span><span class="hljs-preprocessor">.test</span><span class="hljs-preprocessor">.espresso</span><span class="hljs-preprocessor">.web</span><span class="hljs-preprocessor">.sugar</span><span class="hljs-preprocessor">.Web</span><span class="hljs-preprocessor">.onWebView</span><span class="hljs-comment">;</span>
import static android<span class="hljs-preprocessor">.support</span><span class="hljs-preprocessor">.test</span><span class="hljs-preprocessor">.espresso</span><span class="hljs-preprocessor">.web</span><span class="hljs-preprocessor">.webdriver</span><span class="hljs-preprocessor">.DriverAtoms</span><span class="hljs-preprocessor">.findElement</span><span class="hljs-comment">;</span>
import static android<span class="hljs-preprocessor">.support</span><span class="hljs-preprocessor">.test</span><span class="hljs-preprocessor">.espresso</span><span class="hljs-preprocessor">.web</span><span class="hljs-preprocessor">.webdriver</span><span class="hljs-preprocessor">.DriverAtoms</span><span class="hljs-preprocessor">.webClick</span><span class="hljs-comment">;</span>


@RunWith(AndroidJUnit4<span class="hljs-preprocessor">.class</span>) 

@LargeTest 

public class WebActivityTest { 

    @Rule
    public ActivityTestRule&lt;WebActivity&gt; activityTestRule=  
         new ActivityTestRule&lt;WebActivity&gt;(WebActivity<span class="hljs-preprocessor">.class</span>,false,false){
            @Override
            protected void afterActivityLaunched() {
              //Javascript能通过Espresso web 操作webview:
              //覆盖afterActivityLaunched()  

              // Enable JS!
              onWebView()<span class="hljs-preprocessor">.forceJavascriptEnabled</span>()<span class="hljs-comment">;</span>
          }
      }<span class="hljs-comment">; </span>

    @Test
    public void testWeb(){
         //开启WebActivity
         activityTestRule<span class="hljs-preprocessor">.launchActivity</span>(new Intent())<span class="hljs-comment">; </span>

         onWebView() <span class="hljs-preprocessor">.withElement</span>(findElement(Locator<span class="hljs-preprocessor">.ID</span>,<span class="hljs-string">"web_btn"</span>))
                     <span class="hljs-preprocessor">.perform</span>(webClick())<span class="hljs-comment">;//执行点击动作</span>
    }
}</code></pre>
    <p>
     <strong>
      4.创建运行的Config（不懂的，看上一篇，有详细解说）,然后运行测试项目，结果如下：
     </strong>
    </p>
    <pre><code>马上就要出成绩，结果运行时遇到异常：  

com.android.build.api.transform.TransformException: com.android.builder.packaging.DuplicateFileException: Duplicate files copied in APK META-INF/maven/com.google.guava/guava/pom.properties  
</code></pre>
    <p>
     解决方式： 忽略包中异常
    </p>
    <pre class="prettyprint"><code class="hljs scss"> <span class="hljs-comment">//在在gradle中添加：  </span>
 android {
     packagingOptions {
        <span class="hljs-function">exclude(<span class="hljs-string">'META-INF/maven/com.google.guava/guava/pom.properties'</span>)</span>;
        <span class="hljs-function">exclude(<span class="hljs-string">'META-INF/maven/com.google.guava/guava/pom.xml'</span>)</span>;
     }
  }</code></pre>
    <p>
     运行完成，展现成果：
     <br/>
     <img alt="这里写图片描述" src="https://img-blog.csdn.net/20160722133224677" title="">
     </img>
    </p>
    <p>
     <strong>
      本项目代码下载：
     </strong>
     <a href="http://download.csdn.net/detail/hexingen/9583268">
      http://download.csdn.net/detail/hexingen/9583268
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f686578696e67656e:2f61727469636c652f64657461696c732f3531393934313335" class_="artid" style="display:none">
 </p>
</div>


