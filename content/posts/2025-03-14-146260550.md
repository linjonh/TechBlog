---
layout: post
title: "html-to-image的使用及图片变形和无图问题修复"
date: 2025-03-14 16:24:03 +0800
description: "在使用过程中我发现部分生成的图片没有元素，起初我以为是元素中图片的问题，后来发现部分元素的偏移使用的是定位部分使用的是transform，定位的top、left等值是可以正常捕捉到元素的，但是当使用transform的时候，因为偏移是相对自身的，所以会导致元素可能超出了生成的图片范围，这里我使用的方法是转图片的时候手动清除transform，转换完毕后再设置回去。方法，使用的时候遇到了一些问题，不过已经是五个月前的事儿了所以这里就跳过，我使用的是。基础的使用方法说完了，下面说说使用过程中遇到的问题。"
keywords: "html-to-image的使用及图片变形和无图问题修复"
categories: ['未分类']
tags: ['前端']
artid: "146260550"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146260550
    alt: "html-to-image的使用及图片变形和无图问题修复"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146260550
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146260550
cover: https://bing.ee123.net/img/rand?artid=146260550
image: https://bing.ee123.net/img/rand?artid=146260550
img: https://bing.ee123.net/img/rand?artid=146260550
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     html-to-image的使用及图片变形和无图问题修复
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="htmltoimage_0">
     </a>
     html-to-image的使用及图片变形和无图问题修复
    </h3>
    <p>
     最近迭代的时候因为新增了一个需求，需要前端提供素材及样式给后端，后端同步渲染，但是因为部分样式问题后端无法实现所以决定前端将页面生成图片然后传递给后端使用，本文记录一下使用的过程及遇到的部分问题。
    </p>
    <h4>
     <a id="_4">
     </a>
     技术调研
    </h4>
    <p>
     现在将页面元素转换成图片的插件有很多，普遍使用的技术原理都是利用
     <strong>
      canvas
     </strong>
     或者
     <strong>
      SVG
     </strong>
     将页面元素转换成画布或者svg元素，然后再转成图片。这里我在考虑到速度、易用性、稳定性后选择使用
     <strong>
      html-to-imag
     </strong>
     ，
     <a href="https://github.com/bubkoo/html-to-image#readme">
      文档地址在这里🚩
     </a>
     ，本文使用html-to-image版本
     <strong>
      1.11.11
     </strong>
     。
    </p>
    <h4>
     <a id="_8">
     </a>
     使用
    </h4>
    <p>
     html-to-image的使用非常方便，内置了很多方法供我们使用：
    </p>
    <pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> toPng<span class="token punctuation">,</span> toJpeg<span class="token punctuation">,</span> toBlob<span class="token punctuation">,</span> toPixelData<span class="token punctuation">,</span> toSvg <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'html-to-image'</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     这里根据具体需求选择不同的使用方式就好了，最开始我是用的
     <code>
      toPng
     </code>
     方法，使用的时候遇到了一些问题，不过已经是五个月前的事儿了所以这里就跳过，我使用的是
     <strong>
      toBlob
     </strong>
     方法，个人也推荐使用toBlob方法。
    </p>
    <pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> toBlob <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'html-to-image'</span>

<span class="token function">toBlob</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span>config<span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token operator">...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     基础的使用如上所示，其中第二个参数是生成图片的一些配置，用于一些定制化的需求。
    </p>
    <ol>
     <li>
      <strong>
       <code>
        canvasWidth
       </code>
       和
       <code>
        canvasHeight
       </code>
      </strong>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：设置生成的 canvas 元素的宽度和高度。
       </li>
       <li>
        <strong>
         默认值
        </strong>
        ：根据 HTML 元素的尺寸自动计算。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       <code>
        style
       </code>
      </strong>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：添加额外的 CSS 样式到生成的 canvas 上。
       </li>
       <li>
        <strong>
         默认值
        </strong>
        ：无。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       <code>
        pixelRatio
       </code>
      </strong>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：设置生成图像的像素密度。值越大，图像质量越高，但文件大小也越大。
       </li>
       <li>
        <strong>
         默认值
        </strong>
        ：
        <code>
         window.devicePixelRatio
        </code>
        。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       <code>
        cacheBust
       </code>
      </strong>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：添加一个唯一的查询参数到图像 URL 中，以避免缓存问题。
       </li>
       <li>
        <strong>
         默认值
        </strong>
        ：
        <code>
         true
        </code>
        。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       <code>
        quality
       </code>
      </strong>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：设置生成图像的质量（仅适用于 JPEG 格式）。
       </li>
       <li>
        <strong>
         默认值
        </strong>
        ：
        <code>
         1.0
        </code>
        （最高质量）。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       <code>
        imagePlaceholder
       </code>
      </strong>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：设置图像加载失败时的占位符图像 URL。
       </li>
       <li>
        <strong>
         默认值
        </strong>
        ：
        <code>
         undefined
        </code>
        。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       <code>
        skipFonts
       </code>
      </strong>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：跳过字体加载，加快生成速度。
       </li>
       <li>
        <strong>
         默认值
        </strong>
        ：
        <code>
         false
        </code>
        。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       <code>
        fontEmbedCSS
       </code>
      </strong>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：自定义字体嵌入的 CSS 样式。
       </li>
       <li>
        <strong>
         默认值
        </strong>
        ：
        <code>
         undefined
        </code>
        。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       <code>
        filter
       </code>
      </strong>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：一个函数，用于过滤不需要转换的节点或额外处理。
       </li>
       <li>
        <strong>
         默认值
        </strong>
        ：
        <code>
         undefined
        </code>
        。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       <code>
        backgroundColor
       </code>
      </strong>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：设置生成图像的背景颜色。
       </li>
       <li>
        <strong>
         默认值
        </strong>
        ：
        <code>
         undefined
        </code>
        。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       <code>
        width
       </code>
       和
       <code>
        height
       </code>
      </strong>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：设置生成图像的宽度和高度。
       </li>
       <li>
        <strong>
         默认值
        </strong>
        ：根据 HTML 元素的尺寸自动计算。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       <code>
        type
       </code>
      </strong>
      <ul>
       <li>
        <strong>
         作用
        </strong>
        ：设置生成图片的类型。
       </li>
       <li>
        <strong>
         默认值
        </strong>
        ：
        <code>
         image/png
        </code>
       </li>
      </ul>
     </li>
    </ol>
    <p>
     上面是部分配置项，更多的配置项和使用方法可以移步文档。
    </p>
    <h4>
     <a id="_68">
     </a>
     问题记录
    </h4>
    <p>
     基础的使用方法说完了，下面说说使用过程中遇到的问题
    </p>
    <h5>
     <a id="transform_72">
     </a>
     transform导致的元素偏移
    </h5>
    <p>
     在使用过程中我发现部分生成的图片没有元素，起初我以为是元素中图片的问题，后来发现部分元素的偏移使用的是定位部分使用的是transform，定位的top、left等值是可以正常捕捉到元素的，但是当使用transform的时候，因为偏移是相对自身的，所以会导致元素可能超出了生成的图片范围，这里我使用的方法是转图片的时候手动清除transform，转换完毕后再设置回去。
    </p>
    <pre><code class="prism language-ts"><span class="token keyword">const</span> transformList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">const</span> nodeTransform <span class="token operator">=</span> node<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform
<span class="token keyword">const</span> rotateRegex <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">rotate\([-.\d]+deg\)</span><span class="token regex-delimiter">/</span></span>
<span class="token keyword">const</span> match <span class="token operator">=</span> nodeTransform<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>rotateRegex<span class="token punctuation">)</span>
<span class="token keyword">const</span> isRotate <span class="token operator">=</span> match <span class="token operator">&amp;&amp;</span> match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'rotate(0deg)'</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>nodeTransform<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   node<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token string">''</span> <span class="token comment">// 这里应该保留rotate，因为我这里不需要处理所以直接清除，rotate只作匹配展示</span>
<span class="token punctuation">}</span>
<span class="token function">toBlob</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">finally</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
   <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
     node<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> transformList<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token comment">// 我这里使用了nodeList遍历所以用到了index,具体使用看个人实际情况</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <h5>
     <a id="_94">
     </a>
     背景图渲染导致生成的图片变形
    </h5>
    <p>
     我们的页面中有部分元素是采用背景图然后设置background的方式实现的
    </p>
    <pre><code class="prism language-css"><span class="token property">background</span><span class="token punctuation">:</span> <span class="token url"><span class="token function">url</span><span class="token punctuation">(</span>...<span class="token punctuation">)</span></span> 0% 0% / 100% 100% no-repeat<span class="token punctuation">;</span>
</code></pre>
    <p>
     当时排查到是背景图元素会导致生成图片变形后我尝试了使用其他背景参数去设置，无论是设置
     <code>
      background-size
     </code>
     还是
     <code>
      background-position
     </code>
     的其他值生成的图片都是被拉伸的。所以这里我采用第二种方案，转图片前将背景图转成图片元素然后再恢复。
    </p>
    <pre><code class="prism language-ts"><span class="token comment">// 在调用toBolb方法前添加下面代码</span>
<span class="token keyword">let</span> backgroundImage <span class="token operator">=</span> node<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundImage
<span class="token keyword">let</span> isBgRenderEle <span class="token operator">=</span>
    backgroundImage <span class="token operator">!==</span> <span class="token string">''</span> <span class="token operator">&amp;&amp;</span> backgroundImage <span class="token operator">!==</span> <span class="token string">'url("")'</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>isBgRenderEle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> imgUrl <span class="token operator">=</span> backgroundImage
  <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^url\(["']?</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">["']?\)$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
  <span class="token keyword">const</span> imgNode <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'img'</span><span class="token punctuation">)</span>
  imgNode<span class="token punctuation">.</span>src <span class="token operator">=</span> imgUrl
  imgNode<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">'100%'</span>
  imgNode<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token string">'100%'</span>
  node<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundImage <span class="token operator">=</span> <span class="token string">''</span>
  node<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>imgNode<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 转成图片后添加下面代码</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>isBgRenderEle<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   node<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span>
   node<span class="token punctuation">.</span>style<span class="token punctuation">.</span>backgroundImage <span class="token operator">=</span> backgroundImage
   backgroundImage <span class="token operator">=</span> <span class="token string">''</span>
   isBgRenderEle <span class="token operator">=</span> <span class="token boolean">false</span>
 <span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34353237393138302f:61727469636c652f64657461696c732f313436323630353530" class_="artid" style="display:none">
 </p>
</div>


