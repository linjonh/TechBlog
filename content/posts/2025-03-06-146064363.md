---
layout: post
title: "jenkins配置连接k8s集群"
date: 2025-03-06 11:36:19 +0800
description: "我这边jenkins是在一个服务器里面，k8s集群在其他服务器"
keywords: "jenkins配置连接k8s集群"
categories: ['运维']
tags: ['Token', 'Kubernetes', 'Jenkins', 'Java', 'Hhtps', 'Docker']
artid: "146064363"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146064363
    alt: "jenkins配置连接k8s集群"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146064363
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146064363
cover: https://bing.ee123.net/img/rand?artid=146064363
image: https://bing.ee123.net/img/rand?artid=146064363
img: https://bing.ee123.net/img/rand?artid=146064363
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     jenkins配置连接k8s集群
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="jenkinsk8s_0">
     </a>
     jenkins配置连接k8s集群
    </h2>
    <h3>
     <a id="_2">
     </a>
     前言
    </h3>
    <p>
     我这边jenkins是在一个服务器里面，k8s集群在其他服务器，实现连接
    </p>
    <p>
     首先jenkins下载有k8s插件
    </p>
    <h3>
     <a id="_8">
     </a>
     进入配置页面
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8a28dabfc7084dbdb7df080a4247579c.png"/>
    </p>
    <h3>
     <a id="k8sapiserver_12">
     </a>
     获取k8s-api-server地址
    </h3>
    <p>
     对应k8s服务器执行
    </p>
    <pre><code class="prism language-bash">kubectl config view <span class="token parameter variable">--minify</span> <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{.clusters[0].cluster}'</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/36fe72d364044887b119e3b25411195b.png"/>
    </p>
    <h3>
     <a id="Service_Account_Tokenk8s_22">
     </a>
     生成Service Account Token（在k8s中执行）
    </h3>
    <h4>
     <a id="_Service_Account_24">
     </a>
     创建一个新的 Service Account
    </h4>
    <pre><code class="prism language-YAML">apiVersion: v1
kind: ServiceAccount
metadata:
  name: jenkins-sa
  namespace: kube-system
</code></pre>
    <pre><code>kubectl apply -f service-account.yaml
</code></pre>
    <h4>
     <a id="_38">
     </a>
     绑定角色
    </h4>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> jenkins<span class="token punctuation">-</span>admin
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
  <span class="token key atrule">name</span><span class="token punctuation">:</span> jenkins<span class="token punctuation">-</span>sa
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> kube<span class="token punctuation">-</span>system
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> cluster<span class="token punctuation">-</span>admin
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
</code></pre>
    <pre><code class="prism language-yaml">kubectl apply <span class="token punctuation">-</span>f role<span class="token punctuation">-</span>binding.yaml
</code></pre>
    <h3>
     <a id="_Service_Account_Token_59">
     </a>
     获取 Service Account Token
    </h3>
    <p>
     执行三条命令
    </p>
    <pre><code class="prism language-sql">SECRET_NAME<span class="token operator">=</span>$<span class="token punctuation">(</span>kubectl get serviceaccount jenkins<span class="token operator">-</span>sa <span class="token operator">-</span>n kube<span class="token operator">-</span>system <span class="token operator">-</span>o jsonpath<span class="token operator">=</span><span class="token string">"{.secrets[0].name}"</span><span class="token punctuation">)</span>
TOKEN<span class="token operator">=</span>$<span class="token punctuation">(</span>kubectl get secret $SECRET_NAME <span class="token operator">-</span>n kube<span class="token operator">-</span>system <span class="token operator">-</span>o jsonpath<span class="token operator">=</span><span class="token string">"{.data.token}"</span> <span class="token operator">|</span> base64 <span class="token comment">--decode)</span>
echo $TOKEN
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5ab33812f5ee46f083f5989235dea9a8.png"/>
    </p>
    <p>
     复制生成的Token
    </p>
    <h3>
     <a id="_73">
     </a>
     添加凭证
    </h3>
    <p>
     在 Credentials 字段中点击
     <code>
      Add -&gt; Jenkins
     </code>
     ，然后选择
     <strong>
      <code>
       Secret text
      </code>
     </strong>
     。
    </p>
    <p>
     将之前获取的 TOKEN 粘贴到 Secret 字段中，并给它一个描述性的 ID（例如 jenkins-sa-token）。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ad705e46d70d4d8c8873bceeca4e86d4.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/318c40e50cab4a56bda6ef36c5722710.png"/>
    </p>
    <h3>
     <a id="_82">
     </a>
     测试连接成功
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b7450c57747b4fb7a4d812cd4102ba73.png"/>
    </p>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f35313132363531312f:61727469636c652f64657461696c732f313436303634333633" class_="artid" style="display:none">
 </p>
</div>


