---
arturl_encode: "68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f35393539383032392f:61727469636c652f64657461696c732f313336383334343830"
layout: post
title: "安全mybatis中和导致sql注入问题及解决办法"
date: 2025-01-03 18:26:43 +08:00
description: "网络安全行业产业以来，随即新增加了几十个网络安全行业岗位︰网络安全专家、网络安全分析师、安全咨询师、"
keywords: "mybatis sql注入"
categories: ['未分类']
tags: ['安全', 'Sql', 'Mybatis']
artid: "136834480"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=136834480
  alt: "安全mybatis中和导致sql注入问题及解决办法"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=136834480
featuredImagePreview: https://bing.ee123.net/img/rand?artid=136834480
---

# 【安全】mybatis中#{}和${}导致sql注入问题及解决办法

### 0.问题

使用mybatis的时候遇到了#{}和${}可能导致sql注入的问题

### 1.预先了解

#### (1)#{}

* #{} 底层通过prepareStatement对当前传入的sql进行了预编译，一个 #{ } 被解析为一个参数占位符 ?;
* #{} 解析之后会将String类型的数据自动加上引号，其他数据类型不会
* #{} 很大程度上可以防止sql注入（sql注入是发生在编译的过程中，因为恶意注入了某些特殊字符，最后被编译成了恶意的执行操作）
* #{} 一般用在insert的字段和where条件中，用来防止sql注入

#### (2)${}

* ${}仅仅为一个纯粹的 string 替换，在动态sql解析阶段将会进行变量替换
* ${} 解析之后是什么就是什么
* ${} 用在sql字符串拼接中，使用时需要非常谨慎。但是像一些没有直接和系统用户接触的功能如动态切换表名，库名呀就不存在注入问题了。一旦要使用在要被用户直接接触的sql中，一定要注意！

### 2.举个栗子

#### (1)${}

##### 1）sql注入

```
@Select("select * from user where name = ${name}")
List<User> sqltest1(String name);

```

如果传进去的参数是

```
name = "1' OR 1='1";

```

那么数据库最后执行的语句则为

```
select * from user where name = '1' OR 1='1 ';

```

会直接导致sql注入，被攻击者成功登录

##### 2）语句堵塞

```
@Select("select * from user order by ${column}")
List<User> sqltest1(String column);

```

如果传进去的参数是

```
column = "id,(select 1 from (select sleep(1000))a)"

```

那么数据库最后执行的语句则为

```
select * from user order by id,(select 1 from (select sleep(1000))a)

```

可以发现程序会阻塞1000秒，被攻击者造成语句堵塞

#### (2)#{}

##### 1）无法执行

```
   @Select("select * from user order by #{column}")
    List<User> sqltest1(String column);

```

如果传进去的参数是

```
column = "name";

```

那么#{}会自动给参数加上单引号，数据库语句变成

```
select * from user order by 'name'

```

无法正常执行

##### 2）无法执行

```
@Select("select * from user where name like '%#{name}%'")
List<User> sqltest2(String name);

```

如果传入的参数为

```
name = "yin";

```

那么数据库语句就变成

```
select * from user where name like '%'name'%'

```

直接报错，无法执行

### 3.解决办法

正常来看，一般的解决方法可以使用#{}来代替
KaTeX parse error: Expected 'EOF', got '#' at position 14: {}，但是有的语句如果使用#̲{}会造成语句错误（因为#{}…
{}的有动态指定order
  
by 排序字段、和like模糊匹配，但是这种方式会带来sql注入问题。具体解决方法如下：

#### （1）动态指定order by 排序字段

自定义一个Map，存入的key为前端传过来的值，value则是参与自定义排序的字段名。真正进行自定义排序的时候使用这个map即可。

```
// key为前端传的值，value为数据库对应的列值
    public static Map<String,String> orderByKeyMap = new HashMap<String,String>(){
        {
            put("userId","id");
            put("name","name");
        }

@Select("select * from user order by #{column}")
List<User> sqltest1(String column);

List<User> users = mapper.sqltest3(User.orderByKeyMap.get("name"));

```

这样就不会出错了

#### （2）like 模糊匹配

可以使用 concat 来拼接#{}的字符串，这样就不会报错，也不会导致索引失效

```
 @Select("select _ from user where name like concat('%',#{name},'%')")
List<User> sqltest2(String name);

```

参入参数

```
name = "yin";

```

执行的语句就编程

```
select _ from user where name like concat('%','yin','%');

```

这样就解决问题了

### 4.如何防止 sql 注入？

#### 1. 使用预编译机制

尽量用预编译机制，少用字符串拼接的方式传参，它是 sql 注入问题的根源。

#### 2. 要对特殊字符转义

有些特殊字符，比如：%作为 like 语句中的参数时，要对其进行转义处理。

#### 3. 要捕获异常

需要对所有的异常情况进行捕获，切记接口直接返回异常信息，因为有些异常信息中包含了 sql 信息，包括：库名，表名，字段名等。攻击者拿着这些信息，就能通过 sql 注入随心所欲的攻击你的数据库了。目前比较主流的做法是，有个专门的网关服务，它统一暴露对外接口。用户请求接口时先经过它，再由它将请求转发给业务服务。这样做的好处是：能统一封装返回数据的返回体，并且如果出现异常，能返回统一的异常信息，隐藏敏感信息。此外还能做限流和权限控制。

#### 4. 使用代码检测工具

使用 sqlMap 等代码检测工具，它能检测 sql 注入漏洞。

#### 5. 要有监控

需要对数据库 sql 的执行情况进行监控，有异常情况，及时邮件或短信提醒。

#### 6. 数据库账号需控制权限

对生产环境的数据库建立单独的账号，只分配 DML 相关权限，且不能访问系统表。切勿在程序中直接使用管理员账号。

#### 7. 代码 review

建立代码 review 机制，能找出部分隐藏的问题，提升代码质量。

#### 8. 使用其他手段处理

对于不能使用预编译传参时，要么开启 druid 的 filter 防火墙，要么自己写代码逻辑过滤掉所有可能的注入关键字。

### 题外话

初入计算机行业的人或者大学计算机相关专业毕业生，很多因缺少实战经验，就业处处碰壁。下面我们来看两组数据：

2023 届全国高校毕业生预计达到 1158 万人，就业形势严峻；

国家网络安全宣传周公布的数据显示，到 2027 年我国网络安全人员缺口将达 327 万。

一方面是每年应届毕业生就业形势严峻，一方面是网络安全人才百万缺口。

6 月 9 日，麦可思研究 2023 年版就业蓝皮书（包括《2023 年中国本科生就业报告》《2023 年中国高职生就业报告》）正式发布。

2022 届大学毕业生月收入较高的前 10 个专业

本科计算机类、高职自动化类专业月收入较高。2022 届本科计算机类、高职自动化类专业月收入分别为 6863 元、5339 元。其中，本科计算机类专业起薪与 2021 届基本持平，高职自动化类月收入增长明显，2022 届反超铁道运输类专业（5295 元）排在第一位。

具体看专业，2022 届本科月收入较高的专业是信息安全（7579 元）。对比 2018 届，电子科学与技术、自动化等与人工智能相关的本科专业表现不俗，较五年前起薪涨幅均达到了 19%。数据科学与大数据技术虽是近年新增专业但表现亮眼，已跻身 2022 届本科毕业生毕业半年后月收入较高专业前三。五年前唯一进入本科高薪榜前 10 的人文社科类专业——法语已退出前 10 之列。
  
![](https://i-blog.csdnimg.cn/blog_migrate/58557e4d903876b5b74c21960bed3869.jpeg)

“没有网络安全就没有国家安全”。当前，网络安全已被提升到国家战略的高度，成为影响国家安全、社会稳定至关重要的因素之一。

#### **网络安全行业特点**

1、就业薪资非常高，涨薪快 2022 年猎聘网发布网络安全行业就业薪资行业最高人均 33.77 万！

![img](https://i-blog.csdnimg.cn/blog_migrate/3eee8b056e63572d53f1ce9aa0531723.png)

###### 2、人才缺口大，就业机会多

2019 年 9 月 18 日《中华人民共和国中央人民政府》官方网站发表：我国网络空间安全人才 需求 140 万人，而全国各大学校每年培养的人员不到 1.5W 人。猎聘网《2021 年上半年网络安全报告》预测 2027 年网安人才需求 300W，现在从事网络安全行业的从业人员只有 10W 人。
  
![img](https://i-blog.csdnimg.cn/blog_migrate/026650dbd8291f5e4e7452f5820f7709.png)

行业发展空间大，岗位非常多

网络安全行业产业以来，随即新增加了几十个网络安全行业岗位︰网络安全专家、网络安全分析师、安全咨询师、网络安全工程师、安全架构师、安全运维工程师、渗透工程师、信息安全管理员、数据安全工程师、网络安全运营工程师、网络安全应急响应工程师、数据鉴定师、网络安全产品经理、网络安全服务工程师、网络安全培训师、网络安全审计员、威胁情报分析工程师、灾难恢复专业人员、实战攻防专业人员…

职业增值潜力大

网络安全专业具有很强的技术特性，尤其是掌握工作中的核心网络架构、安全技术，在职业发展上具有不可替代的竞争优势。

随着个人能力的不断提升，所从事工作的职业价值也会随着自身经验的丰富以及项目运作的成熟，升值空间一路看涨，这也是为什么受大家欢迎的主要原因。

从某种程度来讲，在网络安全领域，跟医生职业一样，越老越吃香，因为技术愈加成熟，自然工作会受到重视，升职加薪则是水到渠成之事。

黑客&网络安全如何学习

今天只要你给我的文章点赞，我私藏的网安学习资料一样免费共享给你们，来看看有哪些东西。

###### 1.学习路线图

行业发展空间大，岗位非常多

网络安全行业产业以来，随即新增加了几十个网络安全行业岗位︰网络安全专家、网络安全分析师、安全咨询师、网络安全工程师、安全架构师、安全运维工程师、渗透工程师、信息安全管理员、数据安全工程师、网络安全运营工程师、网络安全应急响应工程师、数据鉴定师、网络安全产品经理、网络安全服务工程师、网络安全培训师、网络安全审计员、威胁情报分析工程师、灾难恢复专业人员、实战攻防专业人员…

职业增值潜力大

网络安全专业具有很强的技术特性，尤其是掌握工作中的核心网络架构、安全技术，在职业发展上具有不可替代的竞争优势。

随着个人能力的不断提升，所从事工作的职业价值也会随着自身经验的丰富以及项目运作的成熟，升值空间一路看涨，这也是为什么受大家欢迎的主要原因。

从某种程度来讲，在网络安全领域，跟医生职业一样，越老越吃香，因为技术愈加成熟，自然工作会受到重视，升职加薪则是水到渠成之事。

黑客&网络安全如何学习

今天只要你给我的文章点赞，我私藏的网安学习资料一样免费共享给你们，来看看有哪些东西。

##### 1.学习路线图

![外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传](https://i-blog.csdnimg.cn/blog_migrate/8ed63597ab979b84e424c7b858b604f7.png)

攻击和防守要学的东西也不少，具体要学的东西我都写在了上面的路线图，如果你能学完它们，你去就业和接私活完全没有问题。

##### 2.视频教程

网上虽然也有很多的学习资源，但基本上都残缺不全的，这是我自己录的网安视频教程，上面路线图的每一个知识点，我都有配套的视频讲解。

内容涵盖了网络安全法学习、网络安全运营等保测评、渗透测试基础、漏洞详解、计算机基础知识等，都是网络安全入门必知必会的学习内容。

##### **3.技术文档和电子书**

技术文档也是我自己整理的，包括我参加大型网安行动、CTF 和挖 SRC 漏洞的经验和技术要点，电子书也有 200 多本，由于内容的敏感性，我就不一一展示了。

##### 4.工具包、面试题和源码

“工欲善其事必先利其器”我为大家总结出了最受欢迎的几十款款黑客工具。涉及范围主要集中在 信息收集、Android 黑客工具、自动化工具、网络钓鱼等，感兴趣的同学不容错过。

还有我视频里讲的案例源码和对应的工具包，需要的话也可以拿走。

这些题目都是大家在面试深信服、奇安信、腾讯或者其它大厂面试时经常遇到的，如果大家有好的题目或者好的见解欢迎分享。

参考解析：深信服官网、奇安信官网、Freebuf、csdn 等

内容特点：条理清晰，含图像化表示更加易懂。

内容概要：包括 内网、操作系统、协议、渗透测试、安服、漏洞、注入、XSS、CSRF、SSRF、文件上传、文件下载、文件包含、XXE、逻辑漏洞、工具、SQLmap、NMAP、BP、MSF…

![img](https://i-blog.csdnimg.cn/blog_migrate/fcfc2d437bfcf8bde5dce80d515f83a9.png)

因篇幅有限，仅展示部分资料，需要点击下方链接即可前往获取

如果你对网络安全入门感兴趣，那么你需要的话可以点击这里
**👉**
[网络安全重磅福利：入门&进阶全套 282G 学习资源包免费分享！](https://mp.weixin.qq.com/s/BWb9OzaB-gVGVpkm161PMw)