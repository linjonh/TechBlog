---
layout: post
title: "使用ffmpeg叠加视频"
date: 2025-03-10 11:39:19 +0800
description: "使用 FFmpeg 的滤镜功能来实现视频叠加和参数调整"
keywords: "使用ffmpeg叠加视频"
categories: ['未分类']
tags: ['音视频', 'Ffmpeg']
artid: "146149191"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146149191
    alt: "使用ffmpeg叠加视频"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146149191
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146149191
cover: https://bing.ee123.net/img/rand?artid=146149191
image: https://bing.ee123.net/img/rand?artid=146149191
img: https://bing.ee123.net/img/rand?artid=146149191
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     使用ffmpeg叠加视频
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     使用 FFmpeg 的滤镜功能来实现视频叠加和参数调整。
    </p>
    <h4>
     <a id="font_stylecolorrgb64_64_64font_2">
     </a>
     版本要求
    </h4>
    <p>
     请确保 FFmpeg 版本 ≥ 4.0。
    </p>
    <h4>
     <a id="font_stylecolorrgb64_64_64font_5">
     </a>
     参数说明
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        <strong>
         参数名称
        </strong>
       </th>
       <th>
        <strong>
         作用
        </strong>
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        背景视频
       </td>
       <td>
        作为背景的视频文件
       </td>
      </tr>
      <tr>
       <td>
        上层视频
       </td>
       <td>
        叠加在上层的视频文件
       </td>
      </tr>
      <tr>
       <td>
        上层宽度
       </td>
       <td>
        上层视频的宽度（高度按比例自适应）
       </td>
      </tr>
      <tr>
       <td>
        时间偏移
       </td>
       <td>
        上层视频从第几秒开始显示
       </td>
      </tr>
      <tr>
       <td>
        透明度
       </td>
       <td>
        上层视频的透明度（0.0 完全透明，1.0 完全不透明）
       </td>
      </tr>
      <tr>
       <td>
        x比例
       </td>
       <td>
        上层视频的水平位置比例（0=左侧，1=右侧，0.5=居中）
       </td>
      </tr>
      <tr>
       <td>
        y比例
       </td>
       <td>
        上层视频的垂直位置比例（0=顶部，1=底部，0.5=居中）
       </td>
      </tr>
      <tr>
       <td>
        输出文件名
       </td>
       <td>
        最终生成的视频文件名
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="_18">
     </a>
    </h4>
    <p>
     运行示例
     <br/>
     假设：
    </p>
    <ul>
     <li>
      背景视频：
      <code>
       &lt;font style="color:rgb(64, 64, 64);"&gt;background.mp4&lt;/font&gt;
      </code>
     </li>
     <li>
      上层视频：
      <code>
       &lt;font style="color:rgb(64, 64, 64);"&gt;input1.mp4&lt;/font&gt;
      </code>
     </li>
     <li>
      上层宽度：
      <code>
       &lt;font style="color:rgb(64, 64, 64);"&gt;640&lt;/font&gt;
      </code>
      （宽度640，高度按比例自适应）
     </li>
     <li>
      时间偏移：
      <code>
       &lt;font style="color:rgb(64, 64, 64);"&gt;5&lt;/font&gt;
      </code>
      （从第5秒开始显示上层视频）
     </li>
     <li>
      透明度：
      <code>
       &lt;font style="color:rgb(64, 64, 64);"&gt;0.5&lt;/font&gt;
      </code>
      （50%透明度）
     </li>
     <li>
      x比例：
      <code>
       &lt;font style="color:rgb(64, 64, 64);"&gt;0.5&lt;/font&gt;
      </code>
      （水平居中）
     </li>
     <li>
      y比例：
      <code>
       &lt;font style="color:rgb(64, 64, 64);"&gt;0.2&lt;/font&gt;
      </code>
      （垂直位置在顶部20%处）
     </li>
     <li>
      输出文件名：
      <code>
       &lt;font style="color:rgb(64, 64, 64);"&gt;output.mp4&lt;/font&gt;
      </code>
     </li>
    </ul>
    <p>
     <code>
      ./merge_videos.sh background.mp4 input1.mp4 640 5 0.5 0.5 0.2 output.mp4
     </code>
    </p>
    <h4>
     <a id="font_stylecolorrgb64_64_64font_35">
     </a>
     脚本逻辑详解
    </h4>
    <ol>
     <li>
      <strong>
       位置比例计算
      </strong>
      <ul>
       <li>
        水平位置：
        <code>
         &lt;font style="color:rgb(64, 64, 64);"&gt;X=(W-w)*$x_ratio&lt;/font&gt;
        </code>
        <ul>
         <li>
          <code>
           &lt;font style="color:rgb(64, 64, 64);"&gt;W&lt;/font&gt;
          </code>
          是背景视频宽度，
          <code>
           &lt;font style="color:rgb(64, 64, 64);"&gt;w&lt;/font&gt;
          </code>
          是上层视频宽度。
         </li>
         <li>
          <code>
           &lt;font style="color:rgb(64, 64, 64);"&gt;$x_ratio&lt;/font&gt;
          </code>
          是水平比例系数（0~1）。
         </li>
        </ul>
       </li>
       <li>
        垂直位置：
        <code>
         &lt;font style="color:rgb(64, 64, 64);"&gt;Y=(H-h)*$y_ratio&lt;/font&gt;
        </code>
        <ul>
         <li>
          <code>
           &lt;font style="color:rgb(64, 64, 64);"&gt;H&lt;/font&gt;
          </code>
          是背景视频高度，
          <code>
           &lt;font style="color:rgb(64, 64, 64);"&gt;h&lt;/font&gt;
          </code>
          是上层视频高度。
         </li>
         <li>
          <code>
           &lt;font style="color:rgb(64, 64, 64);"&gt;$y_ratio&lt;/font&gt;
          </code>
          是垂直比例系数（0~1）。
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <strong>
       动态参数注入
      </strong>
      <br/>
      所有参数（如宽度、透明度、时间偏移、位置比例等）都会动态注入到 FFmpeg 命令中。
     </li>
     <li>
      <strong>
       上层视频时长计算
      </strong>
      <br/>
      使用
      <code>
       &lt;font style="color:rgb(64, 64, 64);"&gt;ffprobe&lt;/font&gt;
      </code>
      提取上层视频时长，确保叠加时间正确。
     </li>
     <li>
      <strong>
       FFmpeg 滤镜链
      </strong>
      <ul>
       <li>
        <code>
         &lt;font style="color:rgb(64, 64, 64);"&gt;scale=$overlay_width:-1&lt;/font&gt;
        </code>
        ：按指定宽度缩放上层视频。
       </li>
       <li>
        <code>
         &lt;font style="color:rgb(64, 64, 64);"&gt;colorchannelmixer=aa=$opacity&lt;/font&gt;
        </code>
        ：设置透明度。
       </li>
       <li>
        <code>
         &lt;font style="color:rgb(64, 64, 64);"&gt;setpts=PTS-STARTPTS+$time_offset/TB&lt;/font&gt;
        </code>
        ：调整上层视频的开始时间。
       </li>
       <li>
        <code>
         &lt;font style="color:rgb(64, 64, 64);"&gt;overlay=X=(W-w)*$x_ratio:Y=(H-h)*$y_ratio&lt;/font&gt;
        </code>
        ：根据比例系数计算实际位置。
       </li>
       <li>
        <code>
         &lt;font style="color:rgb(64, 64, 64);"&gt;enable='gte(t,$time_offset)*lte(t,$duration+$time_offset)'&lt;/font&gt;
        </code>
        ：控制上层视频的显示时间范围。
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="font_stylecolorrgb64_64_64font_54">
     </a>
     脚本
    </h4>
    <pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>

<span class="token comment"># 脚本功能：叠加背景视频和上层视频，支持调整上层视频的宽度、透明度、开始时间、位置比例等参数</span>
<span class="token comment"># 使用方法：./merge_videos.sh &lt;背景视频&gt; &lt;上层视频&gt; &lt;上层宽度&gt; &lt;时间偏移&gt; &lt;透明度&gt; &lt;x比例&gt; &lt;y比例&gt; &lt;输出文件名&gt;</span>

<span class="token comment"># 参数说明</span>
<span class="token comment"># ----------------------------------------------------------------------------------------------</span>
<span class="token comment"># | 参数名称       | 作用                                                                 |</span>
<span class="token comment"># ----------------------------------------------------------------------------------------------</span>
<span class="token comment"># | 背景视频       | 作为背景的视频文件                                                   |</span>
<span class="token comment"># | 上层视频       | 叠加在上层的视频文件                                                 |</span>
<span class="token comment"># | 上层宽度       | 上层视频的宽度（高度按比例自适应）                                   |</span>
<span class="token comment"># | 时间偏移       | 上层视频从第几秒开始显示                                             |</span>
<span class="token comment"># | 透明度         | 上层视频的透明度（0.0 完全透明，1.0 完全不透明）                     |</span>
<span class="token comment"># | x比例          | 上层视频的水平位置比例（0=左侧，1=右侧，0.5=居中）                   |</span>
<span class="token comment"># | y比例          | 上层视频的垂直位置比例（0=顶部，1=底部，0.5=居中）                   |</span>
<span class="token comment"># | 输出文件名     | 最终生成的视频文件名                                                 |</span>
<span class="token comment"># ----------------------------------------------------------------------------------------------</span>

<span class="token comment"># 检查参数数量</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">$#</span>"</span> <span class="token parameter variable">-ne</span> <span class="token number">8</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"错误：参数数量不正确！"</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"使用方法：<span class="token variable">$0</span> &lt;背景视频&gt; &lt;上层视频&gt; &lt;上层宽度&gt; &lt;时间偏移&gt; &lt;透明度&gt; &lt;x比例&gt; &lt;y比例&gt; &lt;输出文件名&gt;"</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">fi</span>

<span class="token comment"># 从命令行读取参数</span>
<span class="token assign-left variable">background_video</span><span class="token operator">=</span><span class="token variable">$1</span>      <span class="token comment"># 背景视频文件名</span>
<span class="token assign-left variable">overlay_video</span><span class="token operator">=</span><span class="token variable">$2</span>         <span class="token comment"># 上层视频文件名</span>
<span class="token assign-left variable">overlay_width</span><span class="token operator">=</span><span class="token variable">$3</span>         <span class="token comment"># 上层视频宽度</span>
<span class="token assign-left variable">time_offset</span><span class="token operator">=</span><span class="token variable">$4</span>           <span class="token comment"># 上层视频开始时间偏移（秒）</span>
<span class="token assign-left variable">opacity</span><span class="token operator">=</span><span class="token variable">$5</span>               <span class="token comment"># 上层视频透明度</span>
<span class="token assign-left variable">x_ratio</span><span class="token operator">=</span><span class="token variable">$6</span>               <span class="token comment"># 上层视频水平位置比例（0~1）</span>
<span class="token assign-left variable">y_ratio</span><span class="token operator">=</span><span class="token variable">$7</span>               <span class="token comment"># 上层视频垂直位置比例（0~1）</span>
<span class="token assign-left variable">output_file</span><span class="token operator">=</span><span class="token variable">$8</span>           <span class="token comment"># 输出文件名</span>

<span class="token comment"># 获取上层视频时长</span>
<span class="token assign-left variable">duration</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>ffprobe <span class="token parameter variable">-v</span> error <span class="token parameter variable">-show_entries</span> <span class="token assign-left variable">format</span><span class="token operator">=</span>duration <span class="token parameter variable">-of</span> <span class="token assign-left variable">default</span><span class="token operator">=</span>noprint_wrappers<span class="token operator">=</span><span class="token number">1</span>:nokey<span class="token operator">=</span><span class="token number">1</span> <span class="token string">"<span class="token variable">$overlay_video</span>"</span><span class="token variable">)</span></span>

<span class="token comment"># 合成视频</span>
ffmpeg <span class="token parameter variable">-i</span> <span class="token string">"<span class="token variable">$background_video</span>"</span> <span class="token parameter variable">-i</span> <span class="token string">"<span class="token variable">$overlay_video</span>"</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-filter_complex</span> <span class="token string">"
[1:v]scale=<span class="token variable">$overlay_width</span>:-1,colorchannelmixer=aa=<span class="token variable">$opacity</span>,format=rgba,setpts=PTS-STARTPTS+<span class="token variable">$time_offset</span>/TB[fg];
[0:v][fg]overlay=x='(W-w)*<span class="token variable">$x_ratio</span>':y='(H-h)*<span class="token variable">$y_ratio</span>':enable='gte(t,<span class="token variable">$time_offset</span>)*lte(t,<span class="token variable">$duration</span>+<span class="token variable">$time_offset</span>)'"</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-c:a</span> copy <span class="token string">"<span class="token variable">$output_file</span>"</span>

<span class="token comment"># 输出完成信息</span>
<span class="token builtin class-name">echo</span> <span class="token string">"视频合成完成！输出文件：<span class="token variable">$output_file</span>"</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33373935373832392f:61727469636c652f64657461696c732f313436313439313931" class_="artid" style="display:none">
 </p>
</div>


