---
layout: post
title: "第二十二篇-SQL优化之等价改写从青铜到王者"
date: 2025-03-13 08:16:45 +0800
description: "我是[随缘而动，随遇而安], 一个喜欢用生活案例讲技术的开发者。：书架重组后位置会变（表结构修改导致ROWID失效）：你在学习SQL时遇到过哪些坑？欢迎评论区留言讨论！：VIP通道会暂时封路（锁表），高峰期慎用！：查第100页数据时，别傻傻数前999条！：就像快递小哥合并配送路线，省时省力！：批量导入百万数据（如双11订单归档）：老板让你分别统计北京和上海的订单量。：明明有高速路，导航却导到乡间小道。：《SQL优化之过程函数优化》：已知数据物理地址时闪电查询。：传输数据量减少80%！"
keywords: "第二十二篇 SQL优化之等价改写：从青铜到王者"
categories: ['Sql']
tags: ['数据库', 'Sql']
artid: "146221177"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146221177
    alt: "第二十二篇-SQL优化之等价改写从青铜到王者"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146221177
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146221177
cover: https://bing.ee123.net/img/rand?artid=146221177
image: https://bing.ee123.net/img/rand?artid=146221177
img: https://bing.ee123.net/img/rand?artid=146221177
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     第二十二篇 SQL优化之等价改写：从青铜到王者
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h3>
     <a id="6__1">
     </a>
     一、新手村：减少数据扫描的6大绝招 🛠️
    </h3>
    <h4>
     <a id="11_CASE_WHEN___3">
     </a>
     1.1 CASE WHEN合并术 —— 快递合并配送
    </h4>
    <p>
     <strong>
      场景
     </strong>
     ：老板让你分别统计北京和上海的订单量
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- 青铜写法（跑两趟）</span>
<span class="token keyword">SELECT</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> orders <span class="token keyword">WHERE</span> city<span class="token operator">=</span><span class="token string">'北京'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> beijing<span class="token punctuation">,</span>
       <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">FROM</span> orders <span class="token keyword">WHERE</span> city<span class="token operator">=</span><span class="token string">'上海'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> shanghai<span class="token punctuation">;</span>

<span class="token comment">-- 王者写法（一趟搞定）</span>
<span class="token keyword">SELECT</span> 
    <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> city<span class="token operator">=</span><span class="token string">'北京'</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> beijing<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> city<span class="token operator">=</span><span class="token string">'上海'</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> shanghai
<span class="token keyword">FROM</span> orders<span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      原理
     </strong>
     ：就像快递小哥合并配送路线，省时省力！
    </p>
    <hr/>
    <h4>
     <a id="12____20">
     </a>
     1.2 分页优化秘籍 —— 图书馆找书技巧
    </h4>
    <p>
     <strong>
      问题
     </strong>
     ：查第100页数据时，别傻傻数前999条！
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- 错误示范（全楼找书）</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
<span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> t<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> ROWNUM rn <span class="token keyword">FROM</span> books <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> title<span class="token punctuation">)</span> 
<span class="token keyword">WHERE</span> rn <span class="token operator">BETWEEN</span> <span class="token number">9901</span> <span class="token operator">AND</span> <span class="token number">10000</span><span class="token punctuation">;</span>

<span class="token comment">-- 正确姿势（直达书架）</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> 
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> t<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> ROWNUM rn 
    <span class="token keyword">FROM</span> books t 
    <span class="token keyword">WHERE</span> ROWNUM <span class="token operator">&lt;=</span> <span class="token number">10000</span>  <span class="token comment">-- 先锁定范围</span>
    <span class="token keyword">ORDER</span> <span class="token keyword">BY</span> title
<span class="token punctuation">)</span> 
<span class="token keyword">WHERE</span> rn <span class="token operator">&gt;</span> <span class="token number">9900</span><span class="token punctuation">;</span>          <span class="token comment">-- 再跳过前9900</span>
</code></pre>
    <hr/>
    <h4>
     <a id="13___VIP_41">
     </a>
     1.3 直接路径插入 —— 老板的VIP通道
    </h4>
    <p>
     <strong>
      适用场景
     </strong>
     ：批量导入百万数据（如双11订单归档）
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token comment">/*+ APPEND */</span> <span class="token keyword">INTO</span> sales_archive   <span class="token comment">-- 走VIP通道</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sales <span class="token keyword">WHERE</span> sale_date <span class="token operator">&lt;</span> <span class="token string">'2023-01-01'</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     ⚠️
     <strong>
      注意
     </strong>
     ：VIP通道会暂时封路（锁表），高峰期慎用！
    </p>
    <hr/>
    <h4>
     <a id="14____51">
     </a>
     1.4 精准取件 —— 别搬整个快递柜
    </h4>
    <p>
     <strong>
      反面教材
     </strong>
     ：
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> products<span class="token punctuation">;</span>  <span class="token comment">-- 包含图片等大字段</span>
</code></pre>
    <p>
     <strong>
      正确做法
     </strong>
     ：
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> product_id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> price <span class="token keyword">FROM</span> products<span class="token punctuation">;</span>
</code></pre>
    <p>
     ✅
     <strong>
      效果
     </strong>
     ：传输数据量减少80%！
    </p>
    <hr/>
    <h4>
     <a id="15____64">
     </a>
     1.5 拒绝套娃查询 —— 让小哥一次问清楚
    </h4>
    <p>
     <strong>
      问题SQL
     </strong>
     ：
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> emp_name<span class="token punctuation">,</span> 
       <span class="token punctuation">(</span><span class="token keyword">SELECT</span> dept_name <span class="token keyword">FROM</span> dept <span class="token keyword">WHERE</span> dept_id<span class="token operator">=</span>emp<span class="token punctuation">.</span>dept_id<span class="token punctuation">)</span> 
<span class="token keyword">FROM</span> emp<span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      优化方案
     </strong>
     ：
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> e<span class="token punctuation">.</span>emp_name<span class="token punctuation">,</span> d<span class="token punctuation">.</span>dept_name 
<span class="token keyword">FROM</span> emp e 
<span class="token keyword">JOIN</span> dept d <span class="token keyword">ON</span> e<span class="token punctuation">.</span>dept_id <span class="token operator">=</span> d<span class="token punctuation">.</span>dept_id<span class="token punctuation">;</span>
</code></pre>
    <hr/>
    <h4>
     <a id="16_ROWID___80">
     </a>
     1.6 ROWID直达 —— 记住书的精确位置
    </h4>
    <p>
     <strong>
      适用场景
     </strong>
     ：已知数据物理地址时闪电查询
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> books <span class="token keyword">WHERE</span> ROWID <span class="token operator">=</span> <span class="token string">'AAAAB0AABAAAAOhAAA'</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     ⚠️
     <strong>
      注意
     </strong>
     ：书架重组后位置会变（表结构修改导致ROWID失效）
    </p>
    <hr/>
    <h3>
     <a id="3__89">
     </a>
     二、高手进阶：排除外部干扰的3大心法 🧙♂️
    </h3>
    <h4>
     <a id="21____91">
     </a>
     2.1 强制走索引 —— 给导航仪纠错
    </h4>
    <p>
     <strong>
      场景
     </strong>
     ：明明有高速路，导航却导到乡间小道
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token comment">/*+ INDEX(emp emp_name_idx) */</span> emp_id 
<span class="token keyword">FROM</span> emp 
<span class="token keyword">WHERE</span> emp_name <span class="token operator">LIKE</span> <span class="token string">'张%'</span><span class="token punctuation">;</span>  <span class="token comment">-- 强制走姓名索引</span>
</code></pre>
    <hr/>
    <h4>
     <a id="22____101">
     </a>
     2.2 子查询变形术 —— 拒绝低效循环
    </h4>
    <p>
     <strong>
      错误写法
     </strong>
     ：
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> orders 
<span class="token keyword">WHERE</span> customer_id <span class="token operator">IN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> id <span class="token keyword">FROM</span> customer <span class="token keyword">WHERE</span> vip_level <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      优化方案
     </strong>
     ：
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> o<span class="token punctuation">.</span><span class="token operator">*</span> 
<span class="token keyword">FROM</span> orders o 
<span class="token keyword">JOIN</span> customer c <span class="token keyword">ON</span> o<span class="token punctuation">.</span>customer_id <span class="token operator">=</span> c<span class="token punctuation">.</span>id 
<span class="token keyword">WHERE</span> c<span class="token punctuation">.</span>vip_level <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">;</span>
</code></pre>
    <hr/>
    <h4>
     <a id="23____117">
     </a>
     2.3 资源瓶颈诊断 —— 数据库体检指南
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        症状
       </th>
       <th>
        可能病因
       </th>
       <th>
        解决方案
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        硬盘灯狂闪
       </td>
       <td>
        I/O过高
       </td>
       <td>
        增加索引/优化全表扫描
       </td>
      </tr>
      <tr>
       <td>
        内存占用95%+
       </td>
       <td>
        缓存不足
       </td>
       <td>
        调整SGA/PGA参数
       </td>
      </tr>
      <tr>
       <td>
        CPU持续100%
       </td>
       <td>
        复杂计算太多
       </td>
       <td>
        优化排序/减少嵌套循环
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h3>
     <a id="__126">
     </a>
     三、闯关练习：测测你的优化段位 🎯
    </h3>
    <h4>
     <a id="1_128">
     </a>
     题目1：分页查询优化
    </h4>
    <p>
     请优化以下查询：
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> 
<span class="token keyword">FROM</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> t<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> ROWNUM rn <span class="token keyword">FROM</span> user_log t<span class="token punctuation">)</span> 
<span class="token keyword">WHERE</span> rn <span class="token operator">BETWEEN</span> <span class="token number">100001</span> <span class="token operator">AND</span> <span class="token number">100100</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      答案
     </strong>
     ：
    </p>
    <pre><code class="prism language-sql"><span class="token keyword">SELECT</span> <span class="token operator">*</span> 
<span class="token keyword">FROM</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> t<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> ROWNUM rn 
    <span class="token keyword">FROM</span> user_log t 
    <span class="token keyword">WHERE</span> ROWNUM <span class="token operator">&lt;=</span> <span class="token number">100100</span>  <span class="token comment">-- 先限制上限</span>
<span class="token punctuation">)</span> 
<span class="token keyword">WHERE</span> rn <span class="token operator">&gt;</span> <span class="token number">100000</span><span class="token punctuation">;</span>         <span class="token comment">-- 再跳过前10万</span>
</code></pre>
    <hr/>
    <h3>
     <a id="__149">
     </a>
     四、学习加油站 ⛽
    </h3>
    <p>
     <strong>
      推荐资源
     </strong>
     ：
    </p>
    <ul>
     <li>
      📚 入门必看：《SQL必知必会》
     </li>
     <li>
      🛠️ 工具神器：Oracle SQL Developer的执行计划功能
     </li>
     <li>
      🔧 实战宝典：《高性能MySQL》第6章
     </li>
    </ul>
    <p>
     <strong>
      学习建议
     </strong>
     ：
    </p>
    <ol>
     <li>
      多用
      <code>
       EXPLAIN
      </code>
      分析SQL执行路径
     </li>
     <li>
      每月检查一次慢查询日志
     </li>
     <li>
      在测试环境大胆尝试优化方案
     </li>
    </ol>
    <hr/>
    <blockquote>
     <p>
      <strong>
       🎯下期预告
      </strong>
      ：《SQL优化之过程函数优化》
      <br/>
      <strong>
       💬互动话题
      </strong>
      ：你在学习SQL时遇到过哪些坑？欢迎评论区留言讨论！
      <br/>
      <strong>
       🏷️温馨提示
      </strong>
      ：我是[随缘而动，随遇而安], 一个喜欢用生活案例讲技术的开发者。如果觉得有帮助，
      <strong>
       点赞关注不迷路
      </strong>
      🌟
     </p>
    </blockquote>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33393939313738382f:61727469636c652f64657461696c732f313436323231313737" class_="artid" style="display:none">
 </p>
</div>


