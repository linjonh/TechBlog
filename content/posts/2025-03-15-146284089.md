---
layout: post
title: "论文阅读笔记QLORA-Efficient-Finetuning-of-Quantized-LLMs"
date: 2025-03-15 19:33:21 +0800
description: "QLORA: Efficient Finetuning of Quantized LLMs 论文阅读笔记"
keywords: "论文阅读笔记——QLORA: Efficient Finetuning of Quantized LLMs"
categories: ['论文阅读笔记']
tags: ['语言模型', '论文阅读', '笔记', '深度学习', '人工智能']
artid: "146284089"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146284089
    alt: "论文阅读笔记QLORA-Efficient-Finetuning-of-Quantized-LLMs"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146284089
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146284089
cover: https://bing.ee123.net/img/rand?artid=146284089
image: https://bing.ee123.net/img/rand?artid=146284089
img: https://bing.ee123.net/img/rand?artid=146284089
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     论文阅读笔记——QLORA: Efficient Finetuning of Quantized LLMs
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <a href="https://arxiv.org/pdf/2305.14314" rel="nofollow">
      QLoRA 论文
     </a>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/05a24b5011ed40d3b269ff9504384af6.png#pic_center"/>
    </p>
    <h2>
     <a id="4bit__2">
     </a>
     4-bit 标准浮点数量化
    </h2>
    <p>
     常见的量化技术是最大绝对值量化：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         X 
          
          
          
            I 
           
          
            n 
           
          
            t 
           
          
            8 
           
          
         
        
          = 
         
        
          r 
         
        
          o 
         
        
          u 
         
        
          n 
         
        
          d 
         
        
          ( 
         
         
         
           127 
          
          
          
            a 
           
          
            b 
           
          
            s 
           
          
            m 
           
          
            a 
           
          
            x 
           
          
            ( 
           
           
           
             X 
            
            
            
              F 
             
            
              P 
             
            
              32 
             
            
           
          
            ) 
           
          
         
         
         
           X 
          
          
          
            F 
           
          
            P 
           
          
            32 
           
          
         
        
          ) 
         
        
          = 
         
        
          r 
         
        
          o 
         
        
          u 
         
        
          n 
         
        
          d 
         
        
          ( 
         
         
         
           c 
          
          
          
            F 
           
          
            P 
           
          
            32 
           
          
         
        
          , 
         
         
         
           X 
          
          
          
            F 
           
          
            P 
           
          
            32 
           
          
         
        
          ) 
         
         
         
        
          式(1) 
         
        
       
         X^{Int8}=round(\frac{127}{absmax(X^{FP32})}X^{FP32}) = round(c^{FP32},X^{FP32}) \qquad \qquad \text{式(1)}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8913em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0785em;">
            X
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8913em;">
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0785em;">
                   I
                  </span>
                  <span class="mord mathnormal mtight">
                   n
                  </span>
                  <span class="mord mathnormal mtight">
                   t
                  </span>
                  <span class="mord mtight">
                   8
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.2574em; vertical-align: -0.936em;">
          </span>
          <span class="mord mathnormal">
           ro
          </span>
          <span class="mord mathnormal">
           u
          </span>
          <span class="mord mathnormal">
           n
          </span>
          <span class="mord mathnormal">
           d
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mopen nulldelimiter">
           </span>
           <span class="mfrac">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.3214em;">
               <span class="" style="top: -2.314em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord mathnormal">
                  ab
                 </span>
                 <span class="mord mathnormal">
                  s
                 </span>
                 <span class="mord mathnormal">
                  ma
                 </span>
                 <span class="mord mathnormal">
                  x
                 </span>
                 <span class="mopen">
                  (
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal" style="margin-right: 0.0785em;">
                   X
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.7673em;">
                      <span class="" style="top: -2.989em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                          FP
                         </span>
                         <span class="mord mtight">
                          32
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mclose">
                  )
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.23em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="frac-line" style="border-bottom-width: 0.04em;">
                </span>
               </span>
               <span class="" style="top: -3.677em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  127
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.936em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose nulldelimiter">
           </span>
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0785em;">
            X
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8913em;">
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                   FP
                  </span>
                  <span class="mord mtight">
                   32
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1.1413em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           ro
          </span>
          <span class="mord mathnormal">
           u
          </span>
          <span class="mord mathnormal">
           n
          </span>
          <span class="mord mathnormal">
           d
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            c
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8913em;">
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                   FP
                  </span>
                  <span class="mord mtight">
                   32
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0785em;">
            X
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8913em;">
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                   FP
                  </span>
                  <span class="mord mtight">
                   32
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 2em;">
          </span>
          <span class="mspace" style="margin-right: 2em;">
          </span>
          <span class="mord text">
           <span class="mord cjk_fallback">
            式
           </span>
           <span class="mord">
            (1)
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     其中 c 是量化常数，为这个张量特征的绝对值最大值。
     <br/>
     反量化为：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         d 
         
        
          e 
         
        
          q 
         
        
          u 
         
        
          a 
         
        
          n 
         
        
          t 
         
        
          ( 
         
         
         
           c 
          
          
          
            F 
           
          
            P 
           
          
            32 
           
          
         
        
          , 
         
         
         
           X 
          
          
          
            I 
           
          
            n 
           
          
            t 
           
          
            8 
           
          
         
        
          ) 
         
        
          = 
         
         
          
          
            X 
           
           
           
             I 
            
           
             n 
            
           
             t 
            
           
             8 
            
           
          
          
          
            c 
           
           
           
             F 
            
           
             P 
            
           
             32 
            
           
          
         
        
          = 
         
         
         
           X 
          
          
          
            F 
           
          
            P 
           
          
            32 
           
          
         
         
         
        
          式(2) 
         
        
       
         dequant(c^{FP32},X^{Int8})=\frac{X^{Int8}}{c^{FP32}}=X^{FP32} \qquad \qquad \text{式(2)}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.1413em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           d
          </span>
          <span class="mord mathnormal">
           e
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           q
          </span>
          <span class="mord mathnormal">
           u
          </span>
          <span class="mord mathnormal">
           an
          </span>
          <span class="mord mathnormal">
           t
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            c
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8913em;">
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                   FP
                  </span>
                  <span class="mord mtight">
                   32
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0785em;">
            X
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8913em;">
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0785em;">
                   I
                  </span>
                  <span class="mord mathnormal mtight">
                   n
                  </span>
                  <span class="mord mathnormal mtight">
                   t
                  </span>
                  <span class="mord mtight">
                   8
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.2043em; vertical-align: -0.686em;">
          </span>
          <span class="mord">
           <span class="mopen nulldelimiter">
           </span>
           <span class="mfrac">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.5183em;">
               <span class="" style="top: -2.314em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mord mathnormal">
                   c
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.7673em;">
                      <span class="" style="top: -2.989em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                          FP
                         </span>
                         <span class="mord mtight">
                          32
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.23em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="frac-line" style="border-bottom-width: 0.04em;">
                </span>
               </span>
               <span class="" style="top: -3.677em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mord mathnormal" style="margin-right: 0.0785em;">
                   X
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.8413em;">
                      <span class="" style="top: -3.063em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight" style="margin-right: 0.0785em;">
                          I
                         </span>
                         <span class="mord mathnormal mtight">
                          n
                         </span>
                         <span class="mord mathnormal mtight">
                          t
                         </span>
                         <span class="mord mtight">
                          8
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.686em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose nulldelimiter">
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1.1413em; vertical-align: -0.25em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0785em;">
            X
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8913em;">
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                   FP
                  </span>
                  <span class="mord mtight">
                   32
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 2em;">
          </span>
          <span class="mspace" style="margin-right: 2em;">
          </span>
          <span class="mord text">
           <span class="mord cjk_fallback">
            式
           </span>
           <span class="mord">
            (2)
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <h3>
     <a id="_13">
     </a>
     分位数量化
    </h3>
    <p>
     <strong>
      分位数
     </strong>
     数学上的定义为把
     <strong>
      顺序排列
     </strong>
     的一组数据分割为若干个相等块的分割点的数值。在标准正态分布中，对于分布 X 给定的概率
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        α 
        
       
      
        \alpha
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0037em;">
          α
         </span>
        </span>
       </span>
      </span>
     </span>
     ，如果存在
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        u 
         
        
          a 
         
        
       
      
        u_a
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           u
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.1514em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 a
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，使得他的分布函数（CDF）
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        P 
        
       
         ( 
        
       
         X 
        
       
         &lt; 
        
        
        
          u 
         
        
          a 
         
        
       
         ) 
        
       
         = 
        
       
         α 
        
       
      
        P(X&lt;u_a)=\alpha
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.1389em;">
          P
         </span>
         <span class="mopen">
          (
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0785em;">
          X
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          &lt;
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           u
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.1514em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 a
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mclose">
          )
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0037em;">
          α
         </span>
        </span>
       </span>
      </span>
     </span>
     ，则称
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        u 
         
        
          a 
         
        
       
      
        u_a
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           u
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.1514em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 a
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     为标准正态分布的
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        α 
        
       
      
        \alpha
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0037em;">
          α
         </span>
        </span>
       </span>
      </span>
     </span>
     分位数，显然他是严格递增的，故存在反函数。CDF 的反函数的一个重要作用是用来生成该随机分布的随机变量。
     <br/>
     Time Dettmers 认为 k-bit 的有损最小熵编码具有以下特性：
     <strong>
      当将输入数据进行量化时，每个可能的 k-bit 整数值出现的概率是相等的
     </strong>
     。
     <br/>
     那么对于预训练模型（参数符合正态分布），可以通过 CDF 的反函数
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        Q 
         
        
          X 
         
        
       
         = 
        
        
        
          F 
         
        
          X 
         
         
         
           − 
          
         
           1 
          
         
        
       
      
        Q_X=F_X^{-1}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           Q
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3283em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.0785em;">
                 X
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1.1478em; vertical-align: -0.2935em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           F
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8542em;">
              <span class="" style="top: -2.4065em; margin-left: -0.1389em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.0785em;">
                 X
                </span>
               </span>
              </span>
              <span class="" style="top: -3.1031em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  −
                 </span>
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2935em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     简化分位数计算。对于两个分位点的中心
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        q 
         
        
          i 
         
        
       
      
        q_i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           q
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     有：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         q 
          
         
           i 
          
         
        
          = 
         
         
         
           1 
          
         
           2 
          
         
        
          ( 
         
         
         
           Q 
          
         
           X 
          
         
        
          ( 
         
         
         
           i 
          
          
           
           
             2 
            
           
             k 
            
           
          
            + 
           
          
            1 
           
          
         
        
          ) 
         
        
          + 
         
         
         
           Q 
          
         
           x 
          
         
        
          ( 
         
         
          
          
            i 
           
          
            + 
           
          
            1 
           
          
          
           
           
             2 
            
           
             k 
            
           
          
            + 
           
          
            1 
           
          
         
        
          ) 
         
        
          ) 
         
        
       
         q_i=\frac{1}{2}(Q_X(\frac{i}{2^k+1})+Q_x(\frac{i+1}{2^k+1}))
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0359em;">
            q
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.1059em; vertical-align: -0.7693em;">
          </span>
          <span class="mord">
           <span class="mopen nulldelimiter">
           </span>
           <span class="mfrac">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.3214em;">
               <span class="" style="top: -2.314em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  2
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.23em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="frac-line" style="border-bottom-width: 0.04em;">
                </span>
               </span>
               <span class="" style="top: -3.677em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  1
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.686em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose nulldelimiter">
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            Q
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0785em;">
                  X
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mopen nulldelimiter">
           </span>
           <span class="mfrac">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.3365em;">
               <span class="" style="top: -2.314em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mord">
                   2
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.7751em;">
                      <span class="" style="top: -2.989em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                         k
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mspace" style="margin-right: 0.2222em;">
                 </span>
                 <span class="mbin">
                  +
                 </span>
                 <span class="mspace" style="margin-right: 0.2222em;">
                 </span>
                 <span class="mord">
                  1
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.23em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="frac-line" style="border-bottom-width: 0.04em;">
                </span>
               </span>
               <span class="" style="top: -3.677em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord mathnormal">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.7693em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose nulldelimiter">
           </span>
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           +
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.1059em; vertical-align: -0.7693em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            Q
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1514em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  x
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mopen nulldelimiter">
           </span>
           <span class="mfrac">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.3365em;">
               <span class="" style="top: -2.314em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mord">
                   2
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.7751em;">
                      <span class="" style="top: -2.989em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                         k
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mspace" style="margin-right: 0.2222em;">
                 </span>
                 <span class="mbin">
                  +
                 </span>
                 <span class="mspace" style="margin-right: 0.2222em;">
                 </span>
                 <span class="mord">
                  1
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.23em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="frac-line" style="border-bottom-width: 0.04em;">
                </span>
               </span>
               <span class="" style="top: -3.677em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord mathnormal">
                  i
                 </span>
                 <span class="mspace" style="margin-right: 0.2222em;">
                 </span>
                 <span class="mbin">
                  +
                 </span>
                 <span class="mspace" style="margin-right: 0.2222em;">
                 </span>
                 <span class="mord">
                  1
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.7693em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose nulldelimiter">
           </span>
          </span>
          <span class="mclose">
           ))
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     然后量化计算得到：
    </p>
    <ol>
     <li>
      归一化常数
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         N 
         
        
          = 
         
        
          m 
         
        
          a 
         
        
          x 
         
        
          ( 
         
        
          ∣ 
         
        
          T 
         
        
          ∣ 
         
        
          ) 
         
        
       
         N=max(|T|)
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.109em;">
           N
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           ma
          </span>
          <span class="mord mathnormal">
           x
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           ∣
          </span>
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           T
          </span>
          <span class="mord">
           ∣
          </span>
          <span class="mclose">
           )
          </span>
         </span>
        </span>
       </span>
      </span>
      ，将输入张量映射到目标范围
     </li>
     <li>
      对于
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         T 
         
        
          / 
         
        
          N 
         
        
       
         T/N
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           T
          </span>
          <span class="mord">
           /
          </span>
          <span class="mord mathnormal" style="margin-right: 0.109em;">
           N
          </span>
         </span>
        </span>
       </span>
      </span>
      的每个元素，采用二进制搜索找到最接近阈值的
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         q 
          
         
           i 
          
         
        
       
         q_i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0359em;">
            q
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          T 
           
          
            i 
           
          
            Q 
           
          
         
           = 
          
         
           a 
          
         
           r 
          
         
           g 
          
         
           m 
          
         
           i 
          
          
          
            n 
           
           
           
             j 
            
           
             = 
            
           
             0 
            
           
           
           
             2 
            
           
             n 
            
           
          
         
           ∣ 
          
          
          
            Q 
           
          
            j 
           
           
           
             m 
            
           
             a 
            
           
             p 
            
           
          
         
           − 
          
          
           
           
             T 
            
           
             i 
            
           
          
            N 
           
          
         
           ∣ 
          
          
          
         
           式(3) 
          
         
        
          T_i^Q=argmin_{j=0}^{2^n}|Q_j^{map}-\frac{T_i}{N}| \qquad \qquad \text{式(3)}
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 1.2361em; vertical-align: -0.2769em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             T
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.9592em;">
                <span class="" style="top: -2.4231em; margin-left: -0.1389em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight">
                   i
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.1809em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight">
                   Q
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.2769em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 1.343em; vertical-align: -0.413em;">
           </span>
           <span class="mord mathnormal">
            a
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0278em;">
            r
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0359em;">
            g
           </span>
           <span class="mord mathnormal">
            mi
           </span>
           <span class="mord">
            <span class="mord mathnormal">
             n
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.93em;">
                <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                    j
                   </span>
                   <span class="mrel mtight">
                    =
                   </span>
                   <span class="mord mtight">
                    0
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.113em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    <span class="mord mtight">
                     2
                    </span>
                    <span class="msupsub">
                     <span class="vlist-t">
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.7385em;">
                        <span class="" style="top: -2.931em; margin-right: 0.0714em;">
                         <span class="pstrut" style="height: 2.5em;">
                         </span>
                         <span class="sizing reset-size3 size1 mtight">
                          <span class="mord mathnormal mtight">
                           n
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3831em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mord">
            ∣
           </span>
           <span class="mord">
            <span class="mord mathnormal">
             Q
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.7823em;">
                <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   j
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.1809em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight">
                    ma
                   </span>
                   <span class="mord mathnormal mtight">
                    p
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.413em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            −
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 2.0463em; vertical-align: -0.686em;">
           </span>
           <span class="mord">
            <span class="mopen nulldelimiter">
            </span>
            <span class="mfrac">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 1.3603em;">
                <span class="" style="top: -2.314em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal" style="margin-right: 0.109em;">
                   N
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.23em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="frac-line" style="border-bottom-width: 0.04em;">
                 </span>
                </span>
                <span class="" style="top: -3.677em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord mathnormal" style="margin-right: 0.1389em;">
                    T
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.686em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mclose nulldelimiter">
            </span>
           </span>
           <span class="mord">
            ∣
           </span>
           <span class="mspace" style="margin-right: 2em;">
           </span>
           <span class="mspace" style="margin-right: 2em;">
           </span>
           <span class="mord text">
            <span class="mord cjk_fallback">
             式
            </span>
            <span class="mord">
             (3)
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
    </ol>
    <h3>
     <a id="_k__26">
     </a>
     分块 k 位量化
    </h3>
    <p>
     在式（1）中
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        127 
         
         
         
           a 
          
         
           b 
          
         
           s 
          
         
           m 
          
         
           a 
          
         
           x 
          
         
           ( 
          
          
          
            X 
           
           
           
             F 
            
           
             P 
            
           
             32 
            
           
          
         
           ) 
          
         
        
       
      
        \frac{127}{absmax(X^{FP32})}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.372em; vertical-align: -0.5269em;">
         </span>
         <span class="mord">
          <span class="mopen nulldelimiter">
          </span>
          <span class="mfrac">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8451em;">
              <span class="" style="top: -2.6481em;">
               <span class="pstrut" style="height: 3em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  ab
                 </span>
                 <span class="mord mathnormal mtight">
                  s
                 </span>
                 <span class="mord mathnormal mtight">
                  ma
                 </span>
                 <span class="mord mathnormal mtight">
                  x
                 </span>
                 <span class="mopen mtight">
                  (
                 </span>
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0785em;">
                   X
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.7741em;">
                      <span class="" style="top: -2.786em; margin-right: 0.0714em;">
                       <span class="pstrut" style="height: 2.5em;">
                       </span>
                       <span class="sizing reset-size3 size1 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                          FP
                         </span>
                         <span class="mord mtight">
                          32
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mclose mtight">
                  )
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.23em;">
               <span class="pstrut" style="height: 3em;">
               </span>
               <span class="frac-line" style="border-bottom-width: 0.04em;">
               </span>
              </span>
              <span class="" style="top: -3.394em;">
               <span class="pstrut" style="height: 3em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  127
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.5269em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose nulldelimiter">
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     如果是个异常的极大值或者极小值，那么会造成整个张量的绝大多数值在量化后在 0 附近，破坏了量化特征的均匀性。
     <br/>
     <strong>
      分块 k 位量化
     </strong>
     通过将张量分成若干个块，让每个块有独立量化常数 c，解决了异常值问题，并减少了核之间的通信，有更好的并行性。
    </p>
    <p>
     4-bit 标准浮点数量化通过将数据分为负数和正数两部分分别量化：负数部分用7位表示（8个值，含0），正数部分用8位表示（9个值，含0）。合并时去掉一个重复的0，最终占满4比特的16个值。这种方法确保零点精确映射到0，并充分利用了4比特的全部信息
    </p>
    <h2>
     <a id="_32">
     </a>
     双重量化
    </h2>
    <p>
     当我们保存模型时我们不仅要保存量化后的结果，还要保存每个块的量化常数。虽然量化后的参数只有4bit的精度，但是这个量化常量的精度是 float32。在 QLoRA 中，每个块的大小是 64，因为块中的每个值占 4 比特。这相当于为了存储量化常数，模型要额外占用 32/(64∗4)=12.5% 的显存。QLoRA 的双重量化就是对这个量化常数再做一次 8 bit 的量化。
    </p>
    <h2>
     <a id="_35">
     </a>
     分页优化
    </h2>
    <p>
     分页优化是针对梯度检查点做的进一步优化，以防止在显存使用峰值时发生显存OOM的问题。QLoRA分页优化其实就是当显存不足是，将保存的部分梯度检查点转移到CPU内存上。
    </p>
    <blockquote>
     <p>
      QLoRA 核心工作在于模型量化，通过定义 4NF 的精度单位，大幅节约了训练时所用显存。因其作为 LoRA 系列被得到广泛应用，尽管本人对模型量化并没有太多研究，仅以此记录，如果有不对地方，还请各位给予批评指正。
     </p>
    </blockquote>
    <h2>
     <a id="_39">
     </a>
     实验结果
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5da9ece2143c4b2da964ae7c900b8896.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f4d756c7469706c655f782f:61727469636c652f64657461696c732f313436323834303839" class_="artid" style="display:none">
 </p>
</div>


