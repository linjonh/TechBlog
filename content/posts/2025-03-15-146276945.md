---
layout: post
title: "车载Android音频系统-AudioService"
date: 2025-03-15 18:32:09 +0800
description: "AudioService 是 Android 音频系统的核心服务类，该类的设计体现了异步消息处理（Handler 机制）、策略模式（音量/设备策略）和观察者模式（设备状态监听）等典型架构特点。"
keywords: "车载Android音频系统 AudioService"
categories: ['未分类']
tags: ['Android']
artid: "146276945"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146276945
    alt: "车载Android音频系统-AudioService"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146276945
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146276945
cover: https://bing.ee123.net/img/rand?artid=146276945
image: https://bing.ee123.net/img/rand?artid=146276945
img: https://bing.ee123.net/img/rand?artid=146276945
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     车载Android音频系统 AudioService
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="Android_AudioService_0">
     </a>
     车载Android音频系统 AudioService
    </h2>
    <hr/>
    <p>
     AudioService 是 Android 音频系统的核心服务类，该类的设计体现了异步消息处理（Handler 机制）、策略模式（音量/设备策略）和观察者模式（设备状态监听）等典型架构特点。主要功能可归纳为以下六大模块：
    </p>
    <h3>
     <a id="_4">
     </a>
     一、音量管理
    </h3>
    <p>
     <strong>
      1.多级音量控制
     </strong>
    </p>
    <ul>
     <li>
      管理 MAX_STREAM_VOLUME 数组定义各音频流（如音乐、铃声）的最大音量
     </li>
     <li>
      通过 VolumeStreamState 类实现流级别的独立音量控制（如 checkFixedVolumeDevices() 方法）
     </li>
     <li>
      支持安全音量逻辑（mSafeMediaVolumeIndex 变量控制安全阈值）
     </li>
    </ul>
    <p>
     <strong>
      2.持久化存储
     </strong>
    </p>
    <ul>
     <li>
      readPersistedSettings() 方法读取用户保存的音量设置
     </li>
     <li>
      MSG_PERSIST_VOLUME 消息实现异步音量持久化
     </li>
    </ul>
    <h3>
     <a id="_13">
     </a>
     二、设备管理
    </h3>
    <p>
     <strong>
      1.连接状态跟踪
     </strong>
    </p>
    <ul>
     <li>
      使用 mConnectedDevices ArrayMap 存储已连接设备信息
     </li>
     <li>
      makeDeviceListKey() 生成设备唯一标识（类型+地址）
     </li>
    </ul>
    <p>
     <strong>
      2.设备路由策略
     </strong>
    </p>
    <ul>
     <li>
      mFixedVolumeDevices 定义固定音量的设备类型（如 HDMI）
     </li>
     <li>
      处理蓝牙设备连接超时（BTA2DP_DOCK_TIMEOUT_MILLIS 常量）
     </li>
    </ul>
    <h3>
     <a id="_21">
     </a>
     三、音频焦点控制
    </h3>
    <ul>
     <li>
      MediaFocusControl 类实现焦点争夺机制
     </li>
     <li>
      通过 mPlaybackMonitor 监控播放活动状态
     </li>
    </ul>
    <h3>
     <a id="_24">
     </a>
     四、蓝牙音频处理
    </h3>
    <p>
     <strong>
      1.SCO 连接管理
     </strong>
    </p>
    <ul>
     <li>
      维护 mScoAudioState 状态机（如 SCO_STATE_ACTIVE_INTERNAL）
     </li>
     <li>
      处理 BluetoothHeadset 服务连接（getBluetoothHeadset() 方法）
     </li>
    </ul>
    <p>
     <strong>
      2.编解码器支持
     </strong>
    </p>
    <ul>
     <li>
      管理 mEncodedSurroundMode 环绕声编码格式
     </li>
     <li>
      sendEnabledSurroundFormats() 更新支持的格式
     </li>
    </ul>
    <h3>
     <a id="_32">
     </a>
     五、系统事件响应
    </h3>
    <p>
     <strong>
      1.生命周期管理
     </strong>
    </p>
    <ul>
     <li>
      onBootPhase() 处理系统启动阶段事件
     </li>
     <li>
      systemReady() 初始化完成后的系统准备
     </li>
    </ul>
    <p>
     <strong>
      2.状态广播
     </strong>
    </p>
    <ul>
     <li>
      发送 ACTION_AUDIO_BECOMING_NOISY 等系统广播
     </li>
     <li>
      处理屏幕旋转事件（mMonitorRotation 标志）
     </li>
    </ul>
    <h3>
     <a id="_40">
     </a>
     六、特殊功能
    </h3>
    <p>
     <strong>
      1.无障碍支持
     </strong>
    </p>
    <ul>
     <li>
      mAccessibilityServiceUids 跟踪无障碍服务 UID
     </li>
     <li>
      独立音量控制（sIndependentA11yVolume 标志）
     </li>
    </ul>
    <p>
     <strong>
      2.低内存优化
     </strong>
    </p>
    <ul>
     <li>
      readAndSetLowRamDevice() 根据设备配置优化资源
     </li>
     <li>
      典型代码特征举例：
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token comment">// 音量设置异步持久化</span>
<span class="token function">sendMsg</span><span class="token punctuation">(</span>mAudioHandler<span class="token punctuation">,</span> <span class="token constant">MSG_PERSIST_VOLUME</span><span class="token punctuation">,</span> <span class="token constant">SENDMSG_QUEUE</span><span class="token punctuation">,</span> streamType<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> device<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 蓝牙设备状态处理</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">BTA2DP_DOCK_TIMEOUT_MILLIS</span> <span class="token operator">=</span> <span class="token number">8000</span><span class="token punctuation">;</span>
<span class="token function">sendMessageDelayed</span><span class="token punctuation">(</span><span class="token function">obtainMessage</span><span class="token punctuation">(</span><span class="token constant">MSG_BTA2DP_DOCK_TIMEOUT</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">BTA2DP_DOCK_TIMEOUT_MILLIS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <hr/>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f7a68616e796168756976352f:61727469636c652f64657461696c732f313436323736393435" class_="artid" style="display:none">
 </p>
</div>


