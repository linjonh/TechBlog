---
layout: post
title: "ASP.NET-微服务网关-OcelotConsulSkywalking"
date: 2025-03-07 14:04:37 +0800
description: "Ocelot是一个轻量级的.NET API网关，结合Consul，Skywalking轻松实现可跟踪监控的网关和微服务。"
keywords: "ASP.NET 微服务网关 Ocelot+Consul+Skywalking"
categories: ['Dotnet']
tags: ['微服务', 'Consul', 'Asp']
artid: "146094216"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146094216
    alt: "ASP.NET-微服务网关-OcelotConsulSkywalking"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146094216
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146094216
cover: https://bing.ee123.net/img/rand?artid=146094216
image: https://bing.ee123.net/img/rand?artid=146094216
img: https://bing.ee123.net/img/rand?artid=146094216
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ASP.NET 微服务网关 Ocelot+Consul+Skywalking
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="APIGateWaySample_2">
     </a>
     APIGateWaySample
    </h2>
    <p>
     <strong>
      Ocelot + Consul + Skywalking
     </strong>
    </p>
    <h3>
     <a id="_4">
     </a>
     简介
    </h3>
    <p>
     系统设计图
     <br/>
     <img alt="System Design Diagram" src="https://i-blog.csdnimg.cn/img_convert/6997a1a2d097ea80798cb7ef6aea4bd1.png"/>
    </p>
    <h4>
     <a id="_7">
     </a>
     网关
    </h4>
    <p>
     API网关（Gateway）是一个服务器，是系统的唯一入口。从面向对象设计的角度看，它与外观模式类似。API网关封装了系统内部架构，为每个客户端提供一个定制的API。它可能还具有其它职责，如身份验证、监控、负载均衡、缓存、限流等。
    </p>
    <h4>
     <a id="_10">
     </a>
     相关技术
    </h4>
    <h6>
     <a id="_11">
     </a>
     核心
    </h6>
    <ul>
     <li>
      <strong>
       Ocelot
      </strong>
      ：轻量级的.NET API网关
     </li>
     <li>
      <strong>
       Consul
      </strong>
      ：服务发现和配置管理
     </li>
     <li>
      <strong>
       Skywalking
      </strong>
      ：分布式系统的APM（应用性能监控）工具
     </li>
    </ul>
    <h6>
     <a id="_15">
     </a>
     其它
    </h6>
    <ul>
     <li>
      <strong>
       Serilog
      </strong>
      ：日志。网关使用Serilog，将结构化的日志信息存储到ES(Elastic Search)，便于分析处理。
     </li>
     <li>
      <strong>
       Elasticsearch
      </strong>
      ：是一个分布式、RESTful风格的搜索和分析引擎，具有以下特点：
      <ul>
       <li>
        分布式实时文件存储，每个字段都被索引并可被搜索
       </li>
       <li>
        分布式实时分析搜索引擎
       </li>
       <li>
        可以扩展到上百台服务器，处理PB级结构化或非结构化数据
       </li>
       <li>
        在本项目中主要用于存储和分析系统日志数据
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="_22">
     </a>
     请求处理流程
    </h3>
    <ul>
     <li>
      用户请求API网关，网关根据Ocelot配置，处理和转发到下游服务（Service1,Service2…）。
     </li>
     <li>
      各个服务注册到Consul，API网关通过服务发现的方式，向Consul请求下游服务的信息，从来实现转发。
     </li>
     <li>
      网关等所有服务，集成到Skywalking，通过Skywalking监控应用的性能，包括调用链路，响应时间，异常等。
     </li>
    </ul>
    <h3>
     <a id="_26">
     </a>
     环境搭建
    </h3>
    <p>
     ES: 默认端口 9200
     <br/>
     ES Head: 默认端口 9100
     <br/>
     Skywalking: WEB默认端口 9091
     <br/>
     Consul: 默认端口8500，设置好环境变量后，本地开发模式启动命令：consul agent -dev -node=127.0.0.1
    </p>
    <h3>
     <a id="_31">
     </a>
     代码
    </h3>
    <p>
     包：
    </p>
    <ul>
     <li>
      <strong>
       Ocelot 23.4.3
      </strong>
      ：网关组件
      <br/>
      ocelot.json
     </li>
    </ul>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"Routes"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"UseServiceDiscovery"</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string-property property">"DownstreamPathTemplate"</span><span class="token operator">:</span> <span class="token string">"/{abc}"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"DownstreamScheme"</span><span class="token operator">:</span> <span class="token string">"http"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"ServiceName"</span><span class="token operator">:</span> <span class="token string">"service1"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"LoadBalancerOptions"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token string-property property">"Type"</span><span class="token operator">:</span> <span class="token string">"RoundRobin"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string-property property">"UpstreamPathTemplate"</span><span class="token operator">:</span> <span class="token string">"/service1/{abc}"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"UpstreamHttpMethod"</span><span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">"Get"</span><span class="token punctuation">,</span> <span class="token string">"Post"</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string-property property">"ReRoutesCaseSensitive"</span><span class="token operator">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string-property property">"GlobalConfiguration"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"BaseUrl"</span><span class="token operator">:</span> <span class="token string">"http://localhost:8000"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"ServiceDiscoveryProvider"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"Scheme"</span><span class="token operator">:</span> <span class="token string">"http"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"Host"</span><span class="token operator">:</span> <span class="token string">"localhost"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"Port"</span><span class="token operator">:</span> <span class="token number">8500</span><span class="token punctuation">,</span>
      <span class="token string-property property">"Type"</span><span class="token operator">:</span> <span class="token string">"Consul"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"ConfigurationKey"</span><span class="token operator">:</span> <span class="token string">"node-1"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Logging"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"LogLevel"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"Default"</span><span class="token operator">:</span> <span class="token string">"Trace"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <strong>
       Ocelot.Provider.Consul 23.4.3
      </strong>
      ：Consul服务发现，使网关可以通过Consul服务发现下游服务，从而正确转发请求
     </li>
     <li>
      <strong>
       Consul 1.7.14.7
      </strong>
      ：服务注册，将网关服务注册到Consul
     </li>
     <li>
      <strong>
       SkyAPM.Agent.AspNetCore 2.2.0
      </strong>
      ：集成到Skywalking
      <br/>
      skyapm.json
     </li>
    </ul>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"SkyWalking"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"ServiceName"</span><span class="token operator">:</span> <span class="token string">"api-gateway"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Namespace"</span><span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string-property property">"HeaderVersions"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token string">"sw8"</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Sampling"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"SamplePer3Secs"</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
      <span class="token string-property property">"Percentage"</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1.0</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Logging"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"Level"</span><span class="token operator">:</span> <span class="token string">"Information"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"FilePath"</span><span class="token operator">:</span> <span class="token string">"logs\\skyapm-{Date}.log"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string-property property">"Transport"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"Interval"</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
      <span class="token string-property property">"ProtocolVersion"</span><span class="token operator">:</span> <span class="token string">"v8"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"QueueSize"</span><span class="token operator">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
      <span class="token string-property property">"BatchSize"</span><span class="token operator">:</span> <span class="token number">3000</span><span class="token punctuation">,</span>
      <span class="token string-property property">"gRPC"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string-property property">"Servers"</span><span class="token operator">:</span> <span class="token string">"127.0.0.1:11800"</span><span class="token punctuation">,</span>
        <span class="token string-property property">"Timeout"</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
        <span class="token string-property property">"ConnectTimeout"</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span>
        <span class="token string-property property">"ReportTimeout"</span><span class="token operator">:</span> <span class="token number">600000</span><span class="token punctuation">,</span>
        <span class="token string-property property">"Authentication"</span><span class="token operator">:</span> <span class="token string">""</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     Program.cs引入配置文件
    </p>
    <pre><code class="prism language-csharp">builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token string">"ocelot.json"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"ocelot.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Environment<span class="token punctuation">.</span><span class="token function">GetEnvironmentVariable</span><span class="token punctuation">(</span><span class="token string">"ASPNETCORE_ENVIRONMENT"</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">.json"</span></span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">optional</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token string">"skyapm.json"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"skyapm.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Environment<span class="token punctuation">.</span><span class="token function">GetEnvironmentVariable</span><span class="token punctuation">(</span><span class="token string">"ASPNETCORE_ENVIRONMENT"</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">.json"</span></span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">optional</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token string">"serilog.json"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"serilog.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Environment<span class="token punctuation">.</span><span class="token function">GetEnvironmentVariable</span><span class="token punctuation">(</span><span class="token string">"ASPNETCORE_ENVIRONMENT"</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">.json"</span></span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">optional</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
builder<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token string">"consul.json"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"consul.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">Environment<span class="token punctuation">.</span><span class="token function">GetEnvironmentVariable</span><span class="token punctuation">(</span><span class="token string">"ASPNETCORE_ENVIRONMENT"</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string">.json"</span></span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">optional</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     使用网关和服务发现
    </p>
    <pre><code class="prism language-csharp">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddOcelot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">AddConsul</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//Consul 服务发现</span>
builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddHealthChecks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token range operator">..</span><span class="token punctuation">.</span>
<span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">UseOcelot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     使用skywalking
    </p>
    <pre><code class="prism language-csharp">builder<span class="token punctuation">.</span>Services<span class="token punctuation">.</span><span class="token function">AddSkyApmExtensions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="_126">
     </a>
     运行效果图
    </h3>
    <p>
     <img alt="Consul service list" src="https://i-blog.csdnimg.cn/img_convert/1707aad1a70a123f2efa82d4c420536b.png">
      <br/>
      <img alt="Consul service detail" src="https://i-blog.csdnimg.cn/img_convert/e430969722bf1c04f8cbbcd565e3f609.png">
       <br/>
       <img alt="Skywalking request trace" src="https://i-blog.csdnimg.cn/img_convert/fa07606dcb736c62d4fa3b4dd214dabc.png"/>
      </img>
     </img>
    </p>
    <p>
     源码:
     <a href="https://gitee.com/qx918/apigateway-sample" rel="nofollow">
      gitee地址
     </a>
     <a href="https://github.com/Xia-Qi/APIGatewaySample">
      git地址
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031303635333238312f:61727469636c652f64657461696c732f313436303934323136" class_="artid" style="display:none">
 </p>
</div>


