---
layout: post
title: "saltstack通过master下发脚本批量修改minion_id,修改为IP"
date: 2025-03-08 17:26:22 +0800
description: "【代码】saltstack通过master下发脚本批量修改minion_id，修改为IP。"
keywords: "saltstack通过master下发脚本批量修改minion_id，修改为IP"
categories: ['Saltstack']
tags: ['运维', 'Saltstack']
artid: "146119105"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146119105
    alt: "saltstack通过master下发脚本批量修改minion_id,修改为IP"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146119105
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146119105
cover: https://bing.ee123.net/img/rand?artid=146119105
image: https://bing.ee123.net/img/rand?artid=146119105
img: https://bing.ee123.net/img/rand?artid=146119105
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     saltstack通过master下发脚本批量修改minion_id，修改为IP
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <p>
     <strong>
      通过cmd.script远程执行shell脚本修改minion_id，步骤如下:
     </strong>
    </p>
    <pre><code class="prism language-shell"><span class="token comment"># 下发脚本并执行</span>
<span class="token operator">&gt;&gt;</span> salt <span class="token string">'old_minion_id'</span> cmd.script salt://modify_minion_id.sh <span class="token assign-left variable">saltenv</span><span class="token operator">=</span>dev
<span class="token comment">#输出结果</span>
old_minion_id:
    Minion did not return. <span class="token punctuation">[</span>Not connected<span class="token punctuation">]</span>
ERROR: Minions returned with non-zero <span class="token builtin class-name">exit</span> code
<span class="token comment"># minion端日志modify_minion_id.log</span>
<span class="token number">2025</span>-02-26 <span class="token number">10</span>:41:54 - <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> 开始修改 minion_id <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token number">2025</span>-02-26 <span class="token number">10</span>:41:54 - 备份 /etc/salt/minion_id 到 /etc/salt/minion_id.bak 成功.
<span class="token number">2025</span>-02-26 <span class="token number">10</span>:41:54 - 已将 /etc/salt/minion_id 修改为 IP: xx.xx.xx.xx
<span class="token number">2025</span>-02-26 <span class="token number">10</span>:41:54 - 正在重启 salt-minion 服务<span class="token punctuation">..</span>.
<span class="token number">2025</span>-02-26 <span class="token number">10</span>:43:24 - salt-minion 服务重启成功.
<span class="token number">2025</span>-02-26 <span class="token number">10</span>:43:29 - 执行 salt-call test.ping 检查通信<span class="token punctuation">..</span>.
<span class="token number">2025</span>-02-26 <span class="token number">10</span>:43:31 - 通信测试成功: local:
    True
<span class="token number">2025</span>-02-26 <span class="token number">10</span>:43:31 - <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span> 修改 minion_id 任务完成 <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

<span class="token comment"># 檢查minion_id是否修改成功</span>
<span class="token operator">&gt;&gt;</span> salt xx.xx.xx.xx test.ping
<span class="token operator">&gt;&gt;</span> salt xx.xx.xx.xx grains.get <span class="token function">id</span>
<span class="token comment"># 刪除舊的salt key</span>
<span class="token operator">&gt;&gt;</span> salt-key <span class="token parameter variable">-y</span> <span class="token parameter variable">-d</span> old_minion_id
</code></pre>
    <p>
     <strong>
      modify_minion_id.sh
     </strong>
    </p>
    <pre><code class="prism language-shell"><span class="token shebang important">#!/bin/bash</span>
<span class="token comment"># 定义日志文件</span>
<span class="token assign-left variable">LOGFILE</span><span class="token operator">=</span><span class="token string">"/etc/salt/modify_minion_id.log"</span>

<span class="token comment"># 定义日志输出函数，带时间戳</span>
<span class="token function-name function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token builtin class-name">local</span> <span class="token assign-left variable">msg</span><span class="token operator">=</span><span class="token string">"<span class="token variable">$1</span>"</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token variable">)</span></span> - <span class="token variable">${msg}</span>"</span> <span class="token operator">|</span> <span class="token function">tee</span> <span class="token parameter variable">-a</span> <span class="token string">"<span class="token variable">${LOGFILE}</span>"</span>
<span class="token punctuation">}</span>

log <span class="token string">"========== 开始修改 minion_id =========="</span>

<span class="token comment"># 1. 备份 /etc/salt/minion_id 文件</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-f</span> /etc/salt/minion_id <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token function">cp</span> /etc/salt/minion_id /etc/salt/minion_id.bak
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        log <span class="token string">"备份 /etc/salt/minion_id 到 /etc/salt/minion_id.bak 成功."</span>
    <span class="token keyword">else</span>
        log <span class="token string">"备份 /etc/salt/minion_id 失败."</span>
        <span class="token builtin class-name">exit</span> <span class="token number">1</span>
    <span class="token keyword">fi</span>
<span class="token keyword">else</span>
    log <span class="token string">"文件 /etc/salt/minion_id 不存在，跳过备份步骤."</span>
<span class="token keyword">fi</span>

<span class="token comment"># 2. 修改 minion_id 文件为本机 IP</span>
<span class="token assign-left variable">IP</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">hostname</span> <span class="token parameter variable">-I</span> <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'{print $1}'</span><span class="token variable">)</span></span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">$IP</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$IP</span>"</span> <span class="token operator">&gt;</span> /etc/salt/minion_id
    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
        log <span class="token string">"已将 /etc/salt/minion_id 修改为 IP: <span class="token variable">$IP</span>"</span>
    <span class="token keyword">else</span>
        log <span class="token string">"修改 /etc/salt/minion_id 失败."</span>
        <span class="token builtin class-name">exit</span> <span class="token number">1</span>
    <span class="token keyword">fi</span>
<span class="token keyword">else</span>
    log <span class="token string">"获取 IP 地址失败."</span>
    <span class="token builtin class-name">exit</span> <span class="token number">1</span>
<span class="token keyword">fi</span>

<span class="token comment"># 3. 延时并后台重启 salt-minion 服务，必須使用後台啟動</span>
log <span class="token string">"计划10秒后后台重启 salt-minion 服务..."</span>
<span class="token function">nohup</span> <span class="token function">bash</span> <span class="token parameter variable">-c</span> <span class="token string">"sleep 10; systemctl restart salt-minion"</span> <span class="token operator">&gt;</span>/dev/null <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>

<span class="token comment"># 等待几秒钟，确保服务启动稳定</span>
log <span class="token string">"等待15s，確保服務啟動穩定..."</span>
<span class="token function">sleep</span> <span class="token number">15</span>

<span class="token comment"># 4. 执行 salt-call test.ping 检查与 master 通信是否正常</span>
log <span class="token string">"执行 salt-call test.ping 检查通信..."</span>
<span class="token assign-left variable">PING_RESULT</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span>salt-call test.ping <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span><span class="token variable">)</span></span>
<span class="token keyword">if</span> <span class="token builtin class-name">echo</span> <span class="token string">"<span class="token variable">$PING_RESULT</span>"</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-q</span> <span class="token string">"True"</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    log <span class="token string">"通信测试成功: <span class="token variable">$PING_RESULT</span>"</span>
<span class="token keyword">else</span>
    log <span class="token string">"通信测试失败: <span class="token variable">$PING_RESULT</span>"</span>
<span class="token keyword">fi</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33313438393933332f:61727469636c652f64657461696c732f313436313139313035" class_="artid" style="display:none">
 </p>
</div>


