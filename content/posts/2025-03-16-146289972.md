---
layout: post
title: "System-V共享内存详解在Linux上实现内存共享的最佳实践"
date: 2025-03-16 17:09:06 +0800
description: "linux（system V）共享内存"
keywords: "System V共享内存详解：在Linux上实现内存共享的最佳实践"
categories: ['Linux']
tags: ['运维', '服务器', 'Linux']
artid: "146289972"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146289972
    alt: "System-V共享内存详解在Linux上实现内存共享的最佳实践"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146289972
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146289972
cover: https://bing.ee123.net/img/rand?artid=146289972
image: https://bing.ee123.net/img/rand?artid=146289972
img: https://bing.ee123.net/img/rand?artid=146289972
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     System V共享内存详解：在Linux上实现内存共享的最佳实践
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="chianoceanhttpsblogcsdnnetCayyyytypeblog_0">
     </a>
     <a href="https://blog.csdn.net/Cayyyy?type=blog">
      个人主页：chian-ocean
     </a>
    </h3>
    <h3>
     <a id="Linuxhttpsblogcsdnnetcayyyycategory_12826854html_2">
     </a>
     <a href="https://blog.csdn.net/cayyyy/category_12826854.html">
      文章专栏-Linux
     </a>
    </h3>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="_4">
     </a>
     前言：
    </h2>
    <blockquote>
     <p>
      System V的共享内存是Unix操作系统中一种进程间通信（IPC）机制，它允许不同的进程通过共享一块物理内存区域来交换数据。共享内存提供了高效的进程间通信方式，因为进程可以直接读写共享区域，而不需要通过内核或其他进程的中介。
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7be11ce7843d4c6d93904055fc44f062.png"/>
    </p>
    <h2>
     <a id="system_V_13">
     </a>
     <code>
      system V
     </code>
     共享内存
    </h2>
    <h3>
     <a id="System_V_15">
     </a>
     <code>
      System V
     </code>
     共享内存的特点：
    </h3>
    <ol>
     <li>
      <strong>
       高效性
      </strong>
      ：通过共享内存，不同进程可以直接访问和修改数据，而不需要经过数据复制的过程，减少了开销。
     </li>
     <li>
      <strong>
       持久性
      </strong>
      ：共享内存段在进程退出后仍然存在，直到显式地由进程删除。
     </li>
     <li>
      <strong>
       权限控制
      </strong>
      ：共享内存段可以设定访问权限，控制哪些进程可以读写共享内存。
     </li>
    </ol>
    <h3>
     <a id="System_V_21">
     </a>
     <code>
      System V
     </code>
     共享内存流程：
    </h3>
    <ol>
     <li>
      <strong>
       获取
       <code>
        key
       </code>
       值
      </strong>
      ：进程通过
      <code>
       ftok
      </code>
      系统调用来计算出
      <code>
       key
      </code>
      值.
     </li>
     <li>
      <strong>
       创建共享内存段
      </strong>
      ：进程使用
      <code>
       shmget
      </code>
      系统调用来创建或访问共享内存段。
     </li>
     <li>
      <strong>
       映射共享内存
      </strong>
      ：通过
      <code>
       shmat
      </code>
      系统调用，将共享内存段映射到进程的虚拟地址空间中。
     </li>
     <li>
      <strong>
       使用共享内存
      </strong>
      ：进程可以直接通过指针访问共享内存，就像访问普通内存一样。
     </li>
     <li>
      <strong>
       解除映射
      </strong>
      ：进程使用
      <code>
       shmdt
      </code>
      来解除对共享内存段的映射。
     </li>
     <li>
      <strong>
       删除共享内存
      </strong>
      ：当不再需要共享内存时，进程通过
      <code>
       shmctl
      </code>
      来删除共享内存段。
     </li>
    </ol>
    <h3>
     <a id="system_V_30">
     </a>
     <code>
      system V
     </code>
     共享内存函数：
    </h3>
    <p>
     在Unix系统中，System V共享内存的操作由一系列系统调用来管理。以下是常用的共享内存函数：
    </p>
    <h4>
     <a id="1_shmget_34">
     </a>
     1.
     <code>
      shmget
     </code>
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        功能
       </strong>
       ：创建一个共享内存段或获取已经存在的共享内存段。
      </p>
     </li>
     <li>
      <p>
       原型：
      </p>
      <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token class-name">key_t</span> key<span class="token punctuation">,</span> <span class="token class-name">size_t</span> size<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      <ul>
       <li>
        <code>
         key
        </code>
        ：共享内存段的键值，用于标识共享内存。如果是新创建的共享内存段，
        <code>
         key
        </code>
        是唯一的。
       </li>
       <li>
        <code>
         size
        </code>
        ：共享内存段的大小（字节数）。
       </li>
       <li>
        <code>
         shmflg
        </code>
        ：标志位，控制共享内存的访问权限。常用标志有：
        <ul>
         <li>
          <code>
           IPC_CREAT
          </code>
          ：如果共享内存段不存在，则创建一个新段。
         </li>
         <li>
          <code>
           IPC_EXCL
          </code>
          ：与
          <code>
           IPC_CREAT
          </code>
          一起使用，如果共享内存段已存在则调用失败。
         </li>
         <li>
          <code>
           0666
          </code>
          ：设置权限（可读可写）。
         </li>
        </ul>
       </li>
      </ul>
      <p>
       返回值：返回共享内存段的标识符（一个非负整数），如果出错，返回 -1。
      </p>
     </li>
    </ul>
    <h4>
     <a id="2_shmat_53">
     </a>
     2.
     <code>
      shmat
     </code>
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        功能
       </strong>
       ：将共享内存段映射到进程的虚拟地址空间。
      </p>
     </li>
     <li>
      <p>
       原型：
      </p>
      <pre><code class="prism language-c"><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">shmat</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>shmaddr<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      <ul>
       <li>
        <code>
         shmid
        </code>
        ：由
        <code>
         shmget
        </code>
        返回的共享内存段标识符。
       </li>
       <li>
        <code>
         shmaddr
        </code>
        ：期望的映射地址，通常设置为
        <code>
         NULL
        </code>
        ，让操作系统自动选择地址。
       </li>
       <li>
        <code>
         shmflg
        </code>
        ：标志位，常用的标志是
        <code>
         0
        </code>
        （表示默认映射），
        <code>
         SHM_RDONLY
        </code>
        （只读映射）。
       </li>
      </ul>
      <p>
       返回值：返回共享内存的指针（映射到进程地址空间中）。如果失败，则返回
       <code>
        (void*) -1
       </code>
       。
      </p>
     </li>
    </ul>
    <h4>
     <a id="3_shmdt_69">
     </a>
     3.
     <code>
      shmdt
     </code>
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        功能
       </strong>
       ：解除共享内存的映射。
      </p>
     </li>
     <li>
      <p>
       原型：
      </p>
      <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">shmdt</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>shmaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      <ul>
       <li>
        <code>
         shmaddr
        </code>
        ：共享内存的指针，通常是由
        <code>
         shmat
        </code>
        返回的指针。
       </li>
      </ul>
      <p>
       返回值：成功返回
       <code>
        0
       </code>
       ，失败返回
       <code>
        -1
       </code>
       。
      </p>
     </li>
    </ul>
    <h4>
     <a id="4_shmctl_83">
     </a>
     4.
     <code>
      shmctl
     </code>
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        功能
       </strong>
       ：控制共享内存段的各种操作，例如获取共享内存段的状态、删除共享内存段等。
      </p>
     </li>
     <li>
      <p>
       <strong>
        原型
       </strong>
       ：
      </p>
      <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">shmctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
      <ul>
       <li>
        <code>
         shmid
        </code>
        ：共享内存段的标识符。
       </li>
       <li>
        <code>
         cmd
        </code>
        ：控制命令，常用的命令有：
        <ul>
         <li>
          <code>
           IPC_STAT
          </code>
          ：获取共享内存段的状态。
         </li>
         <li>
          <code>
           IPC_RMID
          </code>
          ：删除共享内存段。
         </li>
         <li>
          <code>
           SHM_INFO
          </code>
          ：获取共享内存的统计信息。
         </li>
        </ul>
       </li>
       <li>
        <code>
         buf
        </code>
        ：用于存储共享内存信息的结构体，
        <code>
         shmid_ds
        </code>
        结构体定义了共享内存的状态信息。
       </li>
      </ul>
      <p>
       <strong>
        返回值
       </strong>
       ：成功返回
       <code>
        0
       </code>
       ，失败返回
       <code>
        -1
       </code>
       。
      </p>
     </li>
    </ul>
    <h4>
     <a id="5ftok_102">
     </a>
     5.
     <code>
      ftok
     </code>
    </h4>
    <pre><code class="prism language-cpp">key_t <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> proj_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <p>
       参数：
      </p>
      <ol>
       <li>
        <p>
         <strong>
          <code>
           pathname
          </code>
         </strong>
         ：文件路径名（文件或目录的路径），该文件必须存在且具有一定的权限。路径名用于生成一个唯一的标识符。
        </p>
       </li>
       <li>
        <p>
         <strong>
          <code>
           proj_id
          </code>
         </strong>
         ：一个项目标识符，通常是一个字符值（例如 ‘A’、‘B’ 等）。这用于区分同一文件的不同用途。
        </p>
       </li>
      </ol>
     </li>
     <li>
      <p>
       返回值：
      </p>
     </li>
     <li>
      <p>
       成功时返回一个
       <code>
        key_t
       </code>
       类型的唯一键值，可以用于标识 IPC 对象。
      </p>
     </li>
     <li>
      <p>
       失败时返回
       <code>
        -1
       </code>
       ，并设置
       <code>
        errno
       </code>
       为相应的错误代码。
      </p>
     </li>
    </ul>
    <h4>
     <a id="shmid_ds_120">
     </a>
     <code>
      shmid_ds
     </code>
     结构体
    </h4>
    <p>
     <code>
      shmctl
     </code>
     函数返回的
     <code>
      shmid_ds
     </code>
     结构体用于获取共享内存段的信息。它通常包含以下字段：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">ipc_perm</span> shm_perm<span class="token punctuation">;</span>  <span class="token comment">// 权限</span>
    <span class="token class-name">size_t</span> shm_segsz<span class="token punctuation">;</span>          <span class="token comment">// 共享内存段大小</span>
    <span class="token class-name">time_t</span> shm_atime<span class="token punctuation">;</span>          <span class="token comment">// 最近一次附加时间</span>
    <span class="token class-name">time_t</span> shm_dtime<span class="token punctuation">;</span>          <span class="token comment">// 最近一次分离时间</span>
    <span class="token class-name">time_t</span> shm_ctime<span class="token punctuation">;</span>          <span class="token comment">// 创建时间</span>
    <span class="token class-name">pid_t</span> shm_cpid<span class="token punctuation">;</span>            <span class="token comment">// 创建该共享内存段的进程ID</span>
    <span class="token class-name">pid_t</span> shm_lpid<span class="token punctuation">;</span>            <span class="token comment">// 最后操作该共享内存段的进程ID</span>
    <span class="token class-name">shmatt_t</span> shm_nattch<span class="token punctuation">;</span>       <span class="token comment">// 附加到共享内存的进程数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="shmif_ds_137">
     </a>
     观察
     <code>
      shmif_ds
     </code>
     结构体
    </h5>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"share.hpp"</span>  <span class="token comment">// 引入头文件，假设这是包含共享内存相关函数声明的头文件。</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>  <span class="token comment">// 使用标准命名空间，简化代码书写。</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取共享内存段的标识符</span>
    <span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">Getshmid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 使用shmat函数将共享内存映射到进程的地址空间</span>
    <span class="token keyword">char</span><span class="token operator">*</span> shaddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 定义一个shmid_ds结构体，用于存储共享内存段的状态信息</span>
    <span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> shmds<span class="token punctuation">;</span>
    
    <span class="token comment">// 调用shmctl函数获取共享内存段的状态</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">shmctl</span><span class="token punctuation">(</span><span class="token function">Getshmid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> IPC_STAT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shmds<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token comment">// 输出共享内存的权限</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"权限: "</span> <span class="token operator">&lt;&lt;</span> shmds<span class="token punctuation">.</span>shm_perm<span class="token punctuation">.</span>mode <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token comment">// 输出共享内存的大小（字节数）</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"共享内存大小: "</span> <span class="token operator">&lt;&lt;</span> shmds<span class="token punctuation">.</span>shm_segsz <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token comment">// 输出创建共享内存的进程ID</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"创建共享内存的进程ID: "</span> <span class="token operator">&lt;&lt;</span> shmds<span class="token punctuation">.</span>shm_perm<span class="token punctuation">.</span>mode <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token comment">// 输出共享内存的key值以及当前程序自定义的key值</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"共享内存的key值: "</span> <span class="token operator">&lt;&lt;</span> shmds<span class="token punctuation">.</span>shm_perm<span class="token punctuation">.</span>__key <span class="token operator">&lt;&lt;</span> <span class="token string">"  自己创建的值："</span> <span class="token operator">&lt;&lt;</span> <span class="token function">Get_key</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    
    <span class="token comment">// 使用shmdt解除共享内存的映射</span>
    <span class="token function">shmdt</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>shaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 结束程序</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_171">
     </a>
     代码的工作流程：
    </h4>
    <ol>
     <li>
      <strong>
       获取共享内存标识符 (
       <code>
        shmid
       </code>
       )
      </strong>
      ：通过
      <code>
       Getshmid()
      </code>
      获取共享内存的标识符。
      <code>
       Getshmid()
      </code>
      应该是用户自己定义的一个函数，返回有效的共享内存段ID。
     </li>
     <li>
      <strong>
       映射共享内存
      </strong>
      ：通过
      <code>
       shmat
      </code>
      函数将共享内存段映射到当前进程的地址空间。这里使用的是
      <code>
       nullptr
      </code>
      ，表示操作系统会自动选择一个合适的地址来映射共享内存。
     </li>
     <li>
      <strong>
       获取共享内存信息
      </strong>
      ：调用
      <code>
       shmctl
      </code>
      函数并使用
      <code>
       IPC_STAT
      </code>
      命令来获取共享内存段的状态，保存在
      <code>
       shmid_ds
      </code>
      结构体中。这个结构体包含了共享内存的权限、大小、创建进程ID、key值等信息。
     </li>
     <li>
      <strong>
       输出共享内存的信息
      </strong>
      ：输出共享内存的权限、大小、创建进程ID以及
      <code>
       key
      </code>
      值。注意，在输出创建共享内存的进程ID时，代码中有个小错误，应改为
      <code>
       shmds.shm_cpid
      </code>
      ，而不是
      <code>
       shmds.shm_perm.mode
      </code>
      ，因为
      <code>
       mode
      </code>
      字段是权限信息。
     </li>
     <li>
      <strong>
       解除共享内存映射
      </strong>
      ：调用
      <code>
       shmdt
      </code>
      函数解除映射，防止进程泄露资源。
     </li>
    </ol>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/42a1e3d614874ed998fde2d0d22a2908.png"/>
    </p>
    <h4>
     <a id="_182">
     </a>
     总结
    </h4>
    <ul>
     <li>
      <code>
       shmget
      </code>
      用于创建和访问共享内存段。
     </li>
     <li>
      <code>
       shmat
      </code>
      用于将共享内存段映射到进程的地址空间。
     </li>
     <li>
      <code>
       shmdt
      </code>
      用于解除共享内存的映射。
     </li>
     <li>
      <code>
       shmctl
      </code>
      用于控制共享内存段，例如删除或查看信息。
     </li>
    </ul>
    <h2>
     <a id="_189">
     </a>
     共享内存通信实例（管道控制同步）
    </h2>
    <h3>
     <a id="1__191">
     </a>
     1. 构建管道类
    </h3>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">FIFO</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token comment">// 构造函数：创建命名管道（FIFO）</span>
    <span class="token function">FIFO</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 调用 mkfifo 创建命名管道，MYFIFO_PATH 是管道的路径，MODE 是文件权限</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span>MYFIFO_PATH<span class="token punctuation">,</span> MODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 检查 mkfifo 是否成功，若返回值为 -1，则表示创建失败</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果创建失败，记录错误日志并退出程序</span>
            <span class="token function">log</span><span class="token punctuation">(</span>fatal<span class="token punctuation">,</span> <span class="token string">"mkfifo failure: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出错误日志，显示错误原因</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 返回 4 表示创建管道失败</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 如果创建成功，记录成功日志</span>
        <span class="token function">log</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token string">"mkfifo success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出成功日志</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 析构函数：删除命名管道</span>
    <span class="token operator">~</span><span class="token function">FIFO</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 调用 unlink 删除命名管道</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">unlink</span><span class="token punctuation">(</span>MYFIFO_PATH<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 检查 unlink 是否成功，若返回值为 -1，则表示删除失败</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果删除失败，记录错误日志并退出程序</span>
            <span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token string">"unlink failure: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出错误日志，显示错误原因</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 返回 4 表示删除管道失败</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 如果删除成功，记录成功日志</span>
        <span class="token function">log</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token string">"unlink success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出成功日志</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <code>
      FIFO
     </code>
     类用于创建和删除命名管道（FIFO）。
    </p>
    <p>
     <strong>
      构造函数
     </strong>
     ：在对象创建时，调用
     <code>
      mkfifo
     </code>
     创建命名管道。如果创建失败，记录错误并退出程序。
    </p>
    <p>
     <strong>
      析构函数
     </strong>
     ：在对象销毁时，调用
     <code>
      unlink
     </code>
     删除命名管道。如果删除失败，记录错误并退出程序。
    </p>
    <h3>
     <a id="2_key_241">
     </a>
     2. 获取
     <code>
      key
     </code>
     值
    </h3>
    <ul>
     <li>
      <strong>
       获取
       <code>
        key
       </code>
       值
      </strong>
      ：进程通过
      <code>
       ftok
      </code>
      系统调用来计算出
      <code>
       key
      </code>
      值.
     </li>
    </ul>
    <pre><code class="prism language-cpp">key_t <span class="token function">GetKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 调用 ftok 函数，使用 pathname 和 proj_id 生成唯一的 IPC 键值</span>
    key_t key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span>pathname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proj_id<span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token comment">// 检查 ftok 调用是否成功，key &lt; 0 表示失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果 ftok 失败，记录错误信息到日志，并返回 1</span>
        <span class="token function">log</span><span class="token punctuation">(</span>fatal<span class="token punctuation">,</span> <span class="token string">"ftok failure:%s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 错误日志输出，显示 errno 对应的错误信息</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 返回 1 表示错误</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果成功，记录成功信息到日志</span>
    <span class="token function">log</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token string">"GetKey success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 成功日志输出</span>
    <span class="token comment">// 返回生成的唯一 IPC 键值</span>
    <span class="token keyword">return</span> key<span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="3_263">
     </a>
     3.创建共享内存段
    </h3>
    <ul>
     <li>
      <strong>
       创建共享内存段
      </strong>
      ：进程使用
      <code>
       shmget
      </code>
      系统调用来创建或访问共享内存段。
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">GetShare_mm</span><span class="token punctuation">(</span><span class="token keyword">int</span> flag<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 使用获取的 IPC 键值（通过 GetKey 函数）和共享内存的大小（SIZE_MM）来调用 shmget 创建或获取共享内存</span>
    <span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span><span class="token function">GetKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SIZE_MM<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 检查 shmget 调用是否成功，如果返回值是 -1 表示创建或获取共享内存失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shmid <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果 shmget 失败，记录错误信息到日志，并返回 2 作为错误标识</span>
        <span class="token function">log</span><span class="token punctuation">(</span>fatal<span class="token punctuation">,</span> <span class="token string">"shmget failure: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 错误日志输出，显示 errno 对应的错误信息</span>
        <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 返回 2 表示共享内存获取失败</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 如果 shmget 成功，记录成功信息到日志</span>
    <span class="token function">log</span><span class="token punctuation">(</span>info<span class="token punctuation">,</span> <span class="token string">"shmget success"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 成功日志输出</span>
    <span class="token comment">// 返回获取的共享内存标识符</span>
    <span class="token keyword">return</span> shmid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="4_287">
     </a>
     4.映射、使用和销毁共享内存
    </h3>
    <h4>
     <a id="_289">
     </a>
     <strong>
      服务端：
     </strong>
    </h4>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建一个命名管道 FIFO</span>
    FIFO init<span class="token punctuation">;</span>  <span class="token comment">// 假设 FIFO 是一个类，它的构造函数用于初始化命名管道。</span>

    <span class="token comment">// 打开命名管道，打开模式是只读</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"myfifo"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果打开管道失败，记录错误并退出</span>
        <span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token string">"open failure: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 错误日志输出，显示 errno 对应的错误信息</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回 5 表示出现错误并退出</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建共享内存并获取共享内存标识符</span>
    <span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">CreateShmid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 假设 CreateShmid() 是创建共享内存的函数，它返回共享内存段的标识符。</span>

    <span class="token comment">// 将共享内存映射到进程的地址空间</span>
    <span class="token keyword">char</span><span class="token operator">*</span> shmaddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>shmaddr <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果共享内存映射失败，记录错误并返回</span>
        <span class="token function">log</span><span class="token punctuation">(</span>fatal<span class="token punctuation">,</span> <span class="token string">"shmat failure: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 错误日志输出</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 返回 1 表示出错</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 进入通信循环</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> ch<span class="token punctuation">;</span> 
</code></pre>
    <ul>
     <li>
      <strong>
       创建管道
      </strong>
      ：使用
      <code>
       FIFO
      </code>
      类创建命名管道。
     </li>
     <li>
      <strong>
       打开管道
      </strong>
      ：调用
      <code>
       open("myfifo", O_RDONLY)
      </code>
      打开管道进行读取。如果失败，记录错误并退出。
     </li>
     <li>
      <strong>
       创建共享内存
      </strong>
      ：使用
      <code>
       CreateShmid()
      </code>
      创建共享内存。、
     </li>
     <li>
      <strong>
       映射共享内存
      </strong>
      ：使用
      <code>
       shmat()
      </code>
      将共享内存映射到进程地址空间，检查映射是否成功。
     </li>
     <li>
      <strong>
       通信循环
      </strong>
      ：从管道读取字符，输出共享内存内容，直到读取结束。
     </li>
     <li>
      <strong>
       解除映射与清理
      </strong>
      ：使用
      <code>
       shmdt()
      </code>
      解除共享内存映射，调用
      <code>
       DeleteShare()
      </code>
      删除共享内存，释放资源。
     </li>
    </ul>
    <h4>
     <a id="_331">
     </a>
     客户端：
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"share.hpp"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 打开命名管道 "myfifo" 进行写操作 (O_WRONLY)</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"myfifo"</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">// 如果打开管道失败，fd 会是 -1</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 记录管道打开失败的错误信息并退出程序</span>
        <span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span> <span class="token string">"open failure: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 退出程序，返回错误码 5</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取共享内存的标识符</span>
    <span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">Getshmid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将共享内存映射到进程地址空间</span>
    <span class="token keyword">char</span><span class="token operator">*</span> shmaddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>shmaddr <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">// 检查映射是否成功</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果映射失败，记录错误信息并退出程序</span>
        <span class="token function">log</span><span class="token punctuation">(</span>fatal<span class="token punctuation">,</span> <span class="token string">"shmat failure: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">// 返回错误码 1</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 进入通信循环</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 提示用户输入</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Please Enter@ "</span><span class="token punctuation">;</span>
        <span class="token comment">// 从标准输入读取数据并存储到共享内存</span>
        <span class="token function">fgets</span><span class="token punctuation">(</span>shmaddr<span class="token punctuation">,</span> SIZE_MM<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

        <span class="token comment">// 向管道写入字符 'x'，表示有新的消息</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">"x"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>
    <span class="token comment">// 解除共享内存映射</span>
    <span class="token function">shmdt</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>shmaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// 正常退出</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <strong>
       打开管道
      </strong>
      ：通过
      <code>
       open("myfifo", O_WRONLY)
      </code>
      打开管道进行写操作。如果失败，记录错误并退出。
     </li>
     <li>
      <strong>
       获取共享内存
      </strong>
      ：使用
      <code>
       Getshmid()
      </code>
      获取共享内存标识符，使用
      <code>
       shmat()
      </code>
      将共享内存映射到进程地址空间。
     </li>
     <li>
      <strong>
       通信循环
      </strong>
      ：不断提示用户输入，将用户输入存储到共享内存中，并向管道写入字符
      <code>
       'x'
      </code>
      表示有新的数据。、
     </li>
     <li>
      <strong>
       解除映射并退出
      </strong>
      ：调用
      <code>
       shmdt()
      </code>
      解除共享内存映射，程序正常退出。
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1e90cf258ee94009a5087a125657a684.png"/>
    </p>
    <h2>
     <a id="httpsgiteecomchianoceanlinuxtreemastershare_memory_381">
     </a>
     <a href="https://gitee.com/chian-ocean/linux/tree/master/share_memory" rel="nofollow">
      源码网址
     </a>
    </h2>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f4361797979792f:61727469636c652f64657461696c732f313436323839393732" class_="artid" style="display:none">
 </p>
</div>


