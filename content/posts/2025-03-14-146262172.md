---
layout: post
title: "目标跟踪之DeepSort算法4"
date: 2025-03-14 17:19:31 +0800
description: "对检测特征和历史的轨迹特征先归一化，再1减去特征的矩阵相乘得到余弦距离。根据公式计算马氏距离。"
keywords: "目标跟踪之DeepSort算法(4)"
categories: ['未分类']
tags: ['Pytorch', 'Python']
artid: "146262172"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146262172
    alt: "目标跟踪之DeepSort算法4"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146262172
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146262172
cover: https://bing.ee123.net/img/rand?artid=146262172
image: https://bing.ee123.net/img/rand?artid=146262172
img: https://bing.ee123.net/img/rand?artid=146262172
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     目标跟踪之DeepSort算法(4)
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="1__3">
     </a>
     1 安装
    </h2>
    <p>
     参考：https://github.com/beeduchai/YOLOv8-DeepSORT-Object-Tracking
    </p>
    <h3>
     <a id="11__5">
     </a>
     1.1 代码下载与安装
    </h3>
    <p>
     1 创建一个全新的虚拟环境
    </p>
    <pre><code class="prism language-C">conda create -n yolov8_deepsort python=3.9
</code></pre>
    <p>
     2 激活虚拟环境
    </p>
    <pre><code class="prism language-C">conda activate yolov8_deepsort
</code></pre>
    <p>
     3 在当前地址创建一个文件夹存放将要下载的YOLOv8-DeepSORT-Object-Tracking
    </p>
    <pre><code class="prism language-C">mkdir my_yolov8_deepsort 
</code></pre>
    <p>
     4 跳转到yolov8_deepsort 文件夹
    </p>
    <pre><code class="prism language-C">cd my_yolov8_deepsort 
</code></pre>
    <p>
     5 下载代码
    </p>
    <pre><code class="prism language-C">git clone https://github.com/MuhammadMoinFaisal/YOLOv8-DeepSORT-Object-Tracking.git
</code></pre>
    <p>
     6 安装依赖库
    </p>
    <pre><code class="prism language-C">pip install -e .
</code></pre>
    <p>
     7 在https://drive.google.com/drive/folders/1kna8eWGrSfzaR6DtNJ8_GchGgPMv3VC8下载文件，将文件夹解压放在ultralytics/yolo/v8/detect目录下
    </p>
    <p>
     8 在ultralytics/yolo/v8/detect放一个视频，执行以下命令.首次执行以下代码，会自动取下载yolov8l.pt模型
    </p>
    <pre><code class="prism language-C">python predict.py model=yolov8l.pt source="traffic.mp4" show=True
</code></pre>
    <p>
     注释：如果出现错误，可能是库的版本不对，根据报错提示更改版本。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0dd562c8be6341258632e76e29a2fbef.png#pic_center"/>
    </p>
    <h3>
     <a id="1_2_DeepSort_40">
     </a>
     1. 2 DeepSort检测流程
    </h3>
    <p>
     DeepSort检测流程：
    </p>
    <ol>
     <li>
      模型初始化
     </li>
     <li>
      模型推理
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token comment"># ultralytics/yolo/v8/detect/predict.py</span>
<span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>cfg<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment"># cfg：ultralytics/yolo/configs/default.yaml  </span>
    <span class="token comment"># 1.模型初始化</span>
    init_tracker<span class="token punctuation">(</span><span class="token punctuation">)</span>   
    cfg<span class="token punctuation">.</span>model <span class="token operator">=</span> cfg<span class="token punctuation">.</span>model <span class="token keyword">or</span> <span class="token string">"yolov8n.pt"</span>
    cfg<span class="token punctuation">.</span>imgsz <span class="token operator">=</span> check_imgsz<span class="token punctuation">(</span>cfg<span class="token punctuation">.</span>imgsz<span class="token punctuation">,</span> min_dim<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># check image size</span>
    cfg<span class="token punctuation">.</span>source <span class="token operator">=</span> cfg<span class="token punctuation">.</span>source <span class="token keyword">if</span> cfg<span class="token punctuation">.</span>source <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> ROOT <span class="token operator">/</span> <span class="token string">"assets"</span>
    <span class="token comment"># 2. 模型推理</span>
    predictor <span class="token operator">=</span> DetectionPredictor<span class="token punctuation">(</span>cfg<span class="token punctuation">)</span>
    predictor<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
    <h3>
     <a id="13__57">
     </a>
     1.3 模型初始化流程
    </h3>
    <ol>
     <li>
      实例化对象获取"deep_sort_pytorch/configs/deep_sort.yaml"的参数。
     </li>
     <li>
      初始化跟踪器
      <br/>
      2.1 实例化特征提取器
      <br/>
      2.2 实例化匹配代价矩阵
      <br/>
      2.3 实例化跟踪器
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token comment"># ultralytics/yolo/v8/detect/predict.py </span>
<span class="token keyword">def</span> <span class="token function">init_tracker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> deepsort
    <span class="token comment"># 1 实例化对象获取"deep_sort_pytorch/configs/deep_sort.yaml"的参数</span>
    cfg_deep <span class="token operator">=</span> get_config<span class="token punctuation">(</span><span class="token punctuation">)</span>  
    cfg_deep<span class="token punctuation">.</span>merge_from_file<span class="token punctuation">(</span><span class="token string">"deep_sort_pytorch/configs/deep_sort.yaml"</span><span class="token punctuation">)</span>
    <span class="token comment"># 2 初始化跟踪器</span>
    deepsort<span class="token operator">=</span> DeepSort<span class="token punctuation">(</span>cfg_deep<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>REID_CKPT<span class="token punctuation">,</span>
                            max_dist<span class="token operator">=</span>cfg_deep<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>MAX_DIST<span class="token punctuation">,</span> min_confidence<span class="token operator">=</span>cfg_deep<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>MIN_CONFIDENCE<span class="token punctuation">,</span>
                            nms_max_overlap<span class="token operator">=</span>cfg_deep<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>NMS_MAX_OVERLAP<span class="token punctuation">,</span> max_iou_distance<span class="token operator">=</span>cfg_deep<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>MAX_IOU_DISTANCE<span class="token punctuation">,</span>
                            max_age<span class="token operator">=</span>cfg_deep<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>MAX_AGE<span class="token punctuation">,</span> n_init<span class="token operator">=</span>cfg_deep<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>N_INIT<span class="token punctuation">,</span> nn_budget<span class="token operator">=</span>cfg_deep<span class="token punctuation">.</span>DEEPSORT<span class="token punctuation">.</span>NN_BUDGET<span class="token punctuation">,</span>
                            use_cuda<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># ultralytics/yolo/v8/detect/deep_sort_pytorch/deep_sort/deep_sort.py</span>
<span class="token keyword">class</span> <span class="token class-name">DeepSort</span><span class="token punctuation">(</span><span class="token builtin">object</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model_path<span class="token punctuation">,</span> max_dist<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span> min_confidence<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span> nms_max_overlap<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span> max_iou_distance<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span> max_age<span class="token operator">=</span><span class="token number">70</span><span class="token punctuation">,</span> n_init<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> nn_budget<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">,</span> use_cuda<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>min_confidence <span class="token operator">=</span> min_confidence   <span class="token comment"># 检测物体的最小置信度</span>
        self<span class="token punctuation">.</span>nms_max_overlap <span class="token operator">=</span> nms_max_overlap <span class="token comment"># NMS时iou的最大值</span>
        <span class="token comment"># 2.1 实例化特征提取器</span>
        self<span class="token punctuation">.</span>extractor <span class="token operator">=</span> Extractor<span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> use_cuda<span class="token operator">=</span>use_cuda<span class="token punctuation">)</span>   <span class="token comment"># 提取检测到的物体的特征，用于计算轨迹与检测框的余弦距离</span>

        max_cosine_distance <span class="token operator">=</span> max_dist         <span class="token comment"># 计算距离的最大值</span>
        <span class="token number">2.2</span> 实例化匹配代价矩阵
        metric <span class="token operator">=</span> NearestNeighborDistanceMetric<span class="token punctuation">(</span>
            <span class="token string">"cosine"</span><span class="token punctuation">,</span> max_cosine_distance<span class="token punctuation">,</span> nn_budget<span class="token punctuation">)</span>   <span class="token comment"># metric计算匹配代价矩阵。在级联匹配中用欧式距离计算特级特征和检测特征的距离</span>
        <span class="token number">2.3</span> 实例化跟踪器
        self<span class="token punctuation">.</span>tracker <span class="token operator">=</span> Tracker<span class="token punctuation">(</span>
            metric<span class="token punctuation">,</span> max_iou_distance<span class="token operator">=</span>max_iou_distance<span class="token punctuation">,</span> max_age<span class="token operator">=</span>max_age<span class="token punctuation">,</span> n_init<span class="token operator">=</span>n_init<span class="token punctuation">)</span>
</code></pre>
    <h2>
     <a id="2__93">
     </a>
     2. 模型推理
    </h2>
    <p>
     模型推理流程：
    </p>
    <ol>
     <li>
      准备模型和数据，对数据进行预处理
      <br/>
      1.1 数据进行预处理
     </li>
     <li>
      数据带入模型得到预测结果
     </li>
     <li>
      处理预测结果
      <br/>
      3.1 处理预测结果
     </li>
     <li>
      对预测结果跟踪
     </li>
    </ol>
    <h3>
     <a id="21__102">
     </a>
     2.1 模型推理代码解析
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># ultralytics/yolo/engine/predictor.py</span>
    <span class="token decorator annotation punctuation">@smart_inference_mode</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">__call__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> source<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> model<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 1.准备模型和数据，对数据进行预处理</span>
        self<span class="token punctuation">.</span>run_callbacks<span class="token punctuation">(</span><span class="token string">"on_predict_start"</span><span class="token punctuation">)</span>
        model <span class="token operator">=</span> self<span class="token punctuation">.</span>model <span class="token keyword">if</span> self<span class="token punctuation">.</span>done_setup <span class="token keyword">else</span> self<span class="token punctuation">.</span>setup<span class="token punctuation">(</span>source<span class="token punctuation">,</span> model<span class="token punctuation">)</span>
        model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>seen<span class="token punctuation">,</span> self<span class="token punctuation">.</span>windows<span class="token punctuation">,</span> self<span class="token punctuation">.</span>dt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>ops<span class="token punctuation">.</span>Profile<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ops<span class="token punctuation">.</span>Profile<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ops<span class="token punctuation">.</span>Profile<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>all_outputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> batch <span class="token keyword">in</span> self<span class="token punctuation">.</span>dataset<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>run_callbacks<span class="token punctuation">(</span><span class="token string">"on_predict_batch_start"</span><span class="token punctuation">)</span>
            path<span class="token punctuation">,</span> im<span class="token punctuation">,</span> im0s<span class="token punctuation">,</span> vid_cap<span class="token punctuation">,</span> s <span class="token operator">=</span> batch
            visualize <span class="token operator">=</span> increment_path<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_dir <span class="token operator">/</span> Path<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span>stem<span class="token punctuation">,</span> mkdir<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>visualize <span class="token keyword">else</span> <span class="token boolean">False</span>
            <span class="token keyword">with</span> self<span class="token punctuation">.</span>dt<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                im <span class="token operator">=</span> self<span class="token punctuation">.</span>preprocess<span class="token punctuation">(</span>im<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>im<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
                    im <span class="token operator">=</span> im<span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span>  <span class="token comment"># expand for batch dim</span>
            <span class="token comment"># 2. 数据带入模型得到预测结果</span>
            <span class="token comment"># Inference</span>
            <span class="token keyword">with</span> self<span class="token punctuation">.</span>dt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                preds <span class="token operator">=</span> model<span class="token punctuation">(</span>im<span class="token punctuation">,</span> augment<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>augment<span class="token punctuation">,</span> visualize<span class="token operator">=</span>visualize<span class="token punctuation">)</span>

            <span class="token comment"># 3. 处理预测结果</span>
            <span class="token comment"># postprocess</span>
            <span class="token keyword">with</span> self<span class="token punctuation">.</span>dt<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                preds <span class="token operator">=</span> self<span class="token punctuation">.</span>postprocess<span class="token punctuation">(</span>preds<span class="token punctuation">,</span> im<span class="token punctuation">,</span> im0s<span class="token punctuation">)</span>

            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>webcam<span class="token punctuation">:</span>
                    path<span class="token punctuation">,</span> im0s <span class="token operator">=</span> path<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> im0s<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
                p <span class="token operator">=</span> Path<span class="token punctuation">(</span>path<span class="token punctuation">)</span>
                <span class="token comment"># 4. 对预测结果跟踪</span>
                s <span class="token operator">+=</span> self<span class="token punctuation">.</span>write_results<span class="token punctuation">(</span>i<span class="token punctuation">,</span> preds<span class="token punctuation">,</span> <span class="token punctuation">(</span>p<span class="token punctuation">,</span> im<span class="token punctuation">,</span> im0s<span class="token punctuation">)</span><span class="token punctuation">)</span>

                <span class="token keyword">if</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>show<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>show<span class="token punctuation">(</span>p<span class="token punctuation">)</span>

                <span class="token keyword">if</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>save<span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>save_preds<span class="token punctuation">(</span>vid_cap<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_dir <span class="token operator">/</span> p<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment"># Print time (inference-only)</span>
            LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>s<span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token string">''</span> <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>preds<span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'(no detections), '</span><span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>dt<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>dt <span class="token operator">*</span> <span class="token number">1E3</span><span class="token punctuation">:</span><span class="token format-spec">.1f</span><span class="token punctuation">}</span></span><span class="token string">ms"</span></span><span class="token punctuation">)</span>

            self<span class="token punctuation">.</span>run_callbacks<span class="token punctuation">(</span><span class="token string">"on_predict_batch_end"</span><span class="token punctuation">)</span>

        <span class="token comment"># Print results</span>
        t <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>t <span class="token operator">/</span> self<span class="token punctuation">.</span>seen <span class="token operator">*</span> <span class="token number">1E3</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> self<span class="token punctuation">.</span>dt<span class="token punctuation">)</span>  <span class="token comment"># speeds per image</span>
        LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span>
            <span class="token string-interpolation"><span class="token string">f'Speed: %.1fms pre-process, %.1fms inference, %.1fms postprocess per image at shape </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token operator">*</span>self<span class="token punctuation">.</span>imgsz<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">'</span></span>
            <span class="token operator">%</span> t<span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>save_txt <span class="token keyword">or</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>save<span class="token punctuation">:</span>
            s <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"\n</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_dir<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'labels/*.txt'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> labels saved to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>self<span class="token punctuation">.</span>save_dir <span class="token operator">/</span> <span class="token string">'labels'</span><span class="token punctuation">}</span></span><span class="token string">"</span></span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>save_txt <span class="token keyword">else</span> <span class="token string">''</span>
            LOGGER<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Results saved to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>colorstr<span class="token punctuation">(</span><span class="token string">'bold'</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>save_dir<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>s<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>run_callbacks<span class="token punctuation">(</span><span class="token string">"on_predict_end"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>all_outputs

<span class="token comment"># 1.1 数据进行预处理 ultralytics/yolo/v8/detect/predict.py</span>
    <span class="token keyword">def</span> <span class="token function">preprocess</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> img<span class="token punctuation">)</span><span class="token punctuation">:</span>
        img <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>device<span class="token punctuation">)</span>     <span class="token comment"># 图片数据转换成tensor格式</span>
        img <span class="token operator">=</span> img<span class="token punctuation">.</span>half<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>fp16 <span class="token keyword">else</span> img<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># uint8 to fp16/32  选择半精度还是双精度</span>
        img <span class="token operator">/=</span> <span class="token number">255</span>  <span class="token comment"># 0 - 255 to 0.0 - 1.0                    # 图片数据缩放到0～1之间</span>
        <span class="token keyword">return</span> img
        
<span class="token comment"># 3.1 处理预测结果 ultralytics/yolo/v8/detect/predict.py</span>
    <span class="token keyword">def</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> preds<span class="token punctuation">,</span> img<span class="token punctuation">,</span> orig_img<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 1 非极大值抑制</span>
        preds <span class="token operator">=</span> ops<span class="token punctuation">.</span>non_max_suppression<span class="token punctuation">(</span>preds<span class="token punctuation">,</span>
                                        self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>conf<span class="token punctuation">,</span>
                                        self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>iou<span class="token punctuation">,</span>
                                        agnostic<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>agnostic_nms<span class="token punctuation">,</span>
                                        max_det<span class="token operator">=</span>self<span class="token punctuation">.</span>args<span class="token punctuation">.</span>max_det<span class="token punctuation">)</span> 

        <span class="token keyword">for</span> i<span class="token punctuation">,</span> pred <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>preds<span class="token punctuation">)</span><span class="token punctuation">:</span>
            shape <span class="token operator">=</span> orig_img<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>shape <span class="token keyword">if</span> self<span class="token punctuation">.</span>webcam <span class="token keyword">else</span> orig_img<span class="token punctuation">.</span>shape
            <span class="token comment"># 2 把检测到的框映射到原图</span>
            pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> ops<span class="token punctuation">.</span>scale_boxes<span class="token punctuation">(</span>img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> pred<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> shape<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">round</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token keyword">return</span> preds
</code></pre>
    <h3>
     <a id="22__184">
     </a>
     2.2 对预测结果跟踪代码解析
    </h3>
    <p>
     把检测框的中心点宽高、置信度、类别、原图输入 deepsort.update()中进行跟踪，跟踪代码流程如下：
    </p>
    <ol>
     <li>
      提取特征。
     </li>
     <li>
      轨迹预测。
     </li>
     <li>
      轨迹跟踪。
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token comment"># ultralytics/yolo/v8/detect/predict.py--&gt;def write_results(self, idx, preds, batch)--&gt;outputs = deepsort.update(xywhs, confss, oids, im0)--&gt;  self.tracker.predict() self.tracker.update(detections)</span>

    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> bbox_xywh<span class="token punctuation">,</span> confidences<span class="token punctuation">,</span> oids<span class="token punctuation">,</span> ori_img<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>height<span class="token punctuation">,</span> self<span class="token punctuation">.</span>width <span class="token operator">=</span> ori_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token comment"># generate detections </span>
        <span class="token comment"># 1. 提取特征</span>
        features <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_features<span class="token punctuation">(</span>bbox_xywh<span class="token punctuation">,</span> ori_img<span class="token punctuation">)</span>  <span class="token comment"># 提取检测框对应物体的特征</span>
        bbox_tlwh <span class="token operator">=</span> self<span class="token punctuation">.</span>_xywh_to_tlwh<span class="token punctuation">(</span>bbox_xywh<span class="token punctuation">)</span> <span class="token comment"># 把框由中心点宽高的格式转换为左上角坐标和宽高的格式</span>
        detections <span class="token operator">=</span> <span class="token punctuation">[</span>Detection<span class="token punctuation">(</span>bbox_tlwh<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> conf<span class="token punctuation">,</span> features<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>oid<span class="token punctuation">)</span> <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>conf<span class="token punctuation">,</span>oid<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span><span class="token builtin">zip</span><span class="token punctuation">(</span>confidences<span class="token punctuation">,</span>oids<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">if</span> conf <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>min_confidence<span class="token punctuation">]</span>   <span class="token comment"># 删除资信度小于阈值的检测框，并把检测框的特征添加到detections中</span>

        <span class="token comment"># run on non-maximum supression</span>
        boxes <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>d<span class="token punctuation">.</span>tlwh <span class="token keyword">for</span> d <span class="token keyword">in</span> detections<span class="token punctuation">]</span><span class="token punctuation">)</span>
        scores <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>d<span class="token punctuation">.</span>confidence <span class="token keyword">for</span> d <span class="token keyword">in</span> detections<span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token comment"># update tracker</span>
        <span class="token comment"># 2. 轨迹预测</span>
        self<span class="token punctuation">.</span>tracker<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># 3. 轨迹跟踪</span>
        self<span class="token punctuation">.</span>tracker<span class="token punctuation">.</span>update<span class="token punctuation">(</span>detections<span class="token punctuation">)</span>

        <span class="token comment"># output bbox identities</span>
        outputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> track <span class="token keyword">in</span> self<span class="token punctuation">.</span>tracker<span class="token punctuation">.</span>tracks<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> track<span class="token punctuation">.</span>is_confirmed<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">or</span> track<span class="token punctuation">.</span>time_since_update <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span> 
            box <span class="token operator">=</span> track<span class="token punctuation">.</span>to_tlwh<span class="token punctuation">(</span><span class="token punctuation">)</span>
            x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> self<span class="token punctuation">.</span>_tlwh_to_xyxy<span class="token punctuation">(</span>box<span class="token punctuation">)</span>
            track_id <span class="token operator">=</span> track<span class="token punctuation">.</span>track_id
            track_oid <span class="token operator">=</span> track<span class="token punctuation">.</span>oid
            outputs<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2<span class="token punctuation">,</span> track_id<span class="token punctuation">,</span> track_oid<span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span><span class="token builtin">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>outputs<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            outputs <span class="token operator">=</span> np<span class="token punctuation">.</span>stack<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> outputs
</code></pre>
    <h3>
     <a id="23__224">
     </a>
     2.3 轨迹预测
    </h3>
    <p>
     ultralytics/yolo/v8/detect/deep_sort_pytorch/deep_sort/sort/kalman_filter.py
     <br/>
     self.tracker.predict()–&gt;track.predict(self.kf)–&gt;def predict(self, mean, covariance)
     <br/>
     轨迹预测预测流程：
    </p>
    <ol>
     <li>
      状态转移矩阵。
     </li>
     <li>
      根据状态转移矩阵获取下一状态和其协方差。
     </li>
    </ol>
    <pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mean<span class="token punctuation">,</span> covariance<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Run Kalman filter prediction step.

        Parameters
        ----------
        mean : ndarray
            The 8 dimensional mean vector of the object state at the previous
            time step.
        covariance : ndarray
            The 8x8 dimensional covariance matrix of the object state at the
            previous time step.

        Returns
        -------
        (ndarray, ndarray)
            Returns the mean vector and covariance matrix of the predicted
            state. Unobserved velocities are initialized to 0 mean.

        """</span>
        std_pos <span class="token operator">=</span> <span class="token punctuation">[</span>
            self<span class="token punctuation">.</span>_std_weight_position <span class="token operator">*</span> mean<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>_std_weight_position <span class="token operator">*</span> mean<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token number">1e-2</span><span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>_std_weight_position <span class="token operator">*</span> mean<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        std_vel <span class="token operator">=</span> <span class="token punctuation">[</span>
            self<span class="token punctuation">.</span>_std_weight_velocity <span class="token operator">*</span> mean<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>_std_weight_velocity <span class="token operator">*</span> mean<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token number">1e-5</span><span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>_std_weight_velocity <span class="token operator">*</span> mean<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
        <span class="token comment"># 1. 状态转移矩阵</span>
        motion_cov <span class="token operator">=</span> np<span class="token punctuation">.</span>diag<span class="token punctuation">(</span>np<span class="token punctuation">.</span>square<span class="token punctuation">(</span>np<span class="token punctuation">.</span>r_<span class="token punctuation">[</span>std_pos<span class="token punctuation">,</span> std_vel<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 2. 根据状态转移矩阵获取下一状态和其协方差</span>
        mean <span class="token operator">=</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_motion_mat<span class="token punctuation">,</span> mean<span class="token punctuation">)</span>
        covariance <span class="token operator">=</span> np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>multi_dot<span class="token punctuation">(</span><span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>_motion_mat<span class="token punctuation">,</span> covariance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_motion_mat<span class="token punctuation">.</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> motion_cov

        <span class="token keyword">return</span> mean<span class="token punctuation">,</span> covariance

</code></pre>
    <h3>
     <a id="24__272">
     </a>
     2.4 轨迹跟踪
    </h3>
    <p>
     ultralytics/yolo/v8/detect/deep_sort_pytorch/deep_sort/sort/tracker.py
     <br/>
     self.tracker.update(detections)
     <br/>
     轨迹跟踪步骤：
    </p>
    <ol>
     <li>
      轨迹与特征匹配
     </li>
     <li>
      更新匹配轨迹、未匹配轨迹和未匹配检测
     </li>
     <li>
      更新轨迹的特征
     </li>
    </ol>
    <pre><code class="prism language-python">
    <span class="token keyword">def</span> <span class="token function">update</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> detections<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Perform measurement update and track management.

        Parameters
        ----------   bbox_tlwh[i], conf, features[i],oid
        detections : List[deep_sort.detection.Detection]
            A list of detections at the current time step.

        """</span>
        <span class="token comment"># Run matching cascade.  1. 轨迹与特征 级联匹配和IOU匹配</span>
        matches<span class="token punctuation">,</span> unmatched_tracks<span class="token punctuation">,</span> unmatched_detections <span class="token operator">=</span> \
            self<span class="token punctuation">.</span>_match<span class="token punctuation">(</span>detections<span class="token punctuation">)</span>

        <span class="token comment"># Update track set. 2. 更新匹配轨迹、未匹配轨迹和未匹配检测</span>
        <span class="token keyword">for</span> track_idx<span class="token punctuation">,</span> detection_idx <span class="token keyword">in</span> matches<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>tracks<span class="token punctuation">[</span>track_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>kf<span class="token punctuation">,</span> detections<span class="token punctuation">[</span>detection_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>                   <span class="token comment"># 对匹配轨迹更新得到当前最优轨迹</span>
        <span class="token keyword">for</span> track_idx <span class="token keyword">in</span> unmatched_tracks<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>tracks<span class="token punctuation">[</span>track_idx<span class="token punctuation">]</span><span class="token punctuation">.</span>mark_missed<span class="token punctuation">(</span><span class="token punctuation">)</span>                      <span class="token comment"># 对未匹配轨迹进行标识</span>
        <span class="token keyword">for</span> detection_idx <span class="token keyword">in</span> unmatched_detections<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>_initiate_track<span class="token punctuation">(</span>detections<span class="token punctuation">[</span>detection_idx<span class="token punctuation">]</span><span class="token punctuation">)</span>           <span class="token comment"># 对新检测框初始化轨迹</span>
        self<span class="token punctuation">.</span>tracks <span class="token operator">=</span> <span class="token punctuation">[</span>t <span class="token keyword">for</span> t <span class="token keyword">in</span> self<span class="token punctuation">.</span>tracks <span class="token keyword">if</span> <span class="token keyword">not</span> t<span class="token punctuation">.</span>is_deleted<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>  <span class="token comment"># 剔除掉删除的轨迹</span>

        <span class="token comment"># Update distance metric. 3. 更新轨迹的历史特征</span>
        active_targets <span class="token operator">=</span> <span class="token punctuation">[</span>t<span class="token punctuation">.</span>track_id <span class="token keyword">for</span> t <span class="token keyword">in</span> self<span class="token punctuation">.</span>tracks <span class="token keyword">if</span> t<span class="token punctuation">.</span>is_confirmed<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>   <span class="token comment"># 存放确认状态轨迹的id</span>
        features<span class="token punctuation">,</span> targets <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 分别存放当前所有轨迹的特征和id</span>
        <span class="token keyword">for</span> track <span class="token keyword">in</span> self<span class="token punctuation">.</span>tracks<span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> track<span class="token punctuation">.</span>is_confirmed<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            features <span class="token operator">+=</span> track<span class="token punctuation">.</span>features
            targets <span class="token operator">+=</span> <span class="token punctuation">[</span>track<span class="token punctuation">.</span>track_id <span class="token keyword">for</span> _ <span class="token keyword">in</span> track<span class="token punctuation">.</span>features<span class="token punctuation">]</span>
            track<span class="token punctuation">.</span>features <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>partial_fit<span class="token punctuation">(</span>   <span class="token comment">#</span>
            np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>targets<span class="token punctuation">)</span><span class="token punctuation">,</span> active_targets<span class="token punctuation">)</span>



</code></pre>
    <h3>
     <a id="25___320">
     </a>
     2.5 轨迹与特征匹配
    </h3>
    <p>
     轨迹与特征匹配步骤：
    </p>
    <ol>
     <li>
      把轨迹分为确认状态和非确认状态。
     </li>
     <li>
      级联匹配。通过级联匹配得到确认匹配轨迹和检测的id
      <br/>
      matches_a,未匹配轨迹unmatched_tracks_a, 未匹配检测unmatched_detections
     </li>
     <li>
      IOU匹配。把级联匹配步骤中只有一次未匹配的轨迹并如非确认轨迹用于IOU匹配；保留级联匹配步骤中未匹配的轨迹中连续2帧或2帧以上没有匹配的轨迹。
     </li>
     <li>
      更新级联匹配和IOU匹配的结果。
     </li>
    </ol>
    <pre><code class="prism language-python">    <span class="token keyword">def</span> <span class="token function">_match</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> detections<span class="token punctuation">)</span><span class="token punctuation">:</span>

        <span class="token keyword">def</span> <span class="token function">gated_metric</span><span class="token punctuation">(</span>tracks<span class="token punctuation">,</span> dets<span class="token punctuation">,</span> track_indices<span class="token punctuation">,</span> detection_indices<span class="token punctuation">)</span><span class="token punctuation">:</span>
            features <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>dets<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>feature <span class="token keyword">for</span> i <span class="token keyword">in</span> detection_indices<span class="token punctuation">]</span><span class="token punctuation">)</span>   <span class="token comment"># 检测框的特征</span>
            targets <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>tracks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>track_id <span class="token keyword">for</span> i <span class="token keyword">in</span> track_indices<span class="token punctuation">]</span><span class="token punctuation">)</span>     <span class="token comment"># 轨迹的id</span>
            cost_matrix <span class="token operator">=</span> self<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>distance<span class="token punctuation">(</span>features<span class="token punctuation">,</span> targets<span class="token punctuation">)</span>               <span class="token comment"># 计算轨迹与检测的特征余弦距离</span>
            cost_matrix <span class="token operator">=</span> linear_assignment<span class="token punctuation">.</span>gate_cost_matrix<span class="token punctuation">(</span>                   <span class="token comment"># 用轨迹与检测的马氏距离跟新cost_matrix矩阵</span>
                self<span class="token punctuation">.</span>kf<span class="token punctuation">,</span> cost_matrix<span class="token punctuation">,</span> tracks<span class="token punctuation">,</span> dets<span class="token punctuation">,</span> track_indices<span class="token punctuation">,</span>
                detection_indices<span class="token punctuation">)</span>

            <span class="token keyword">return</span> cost_matrix

        <span class="token comment"># Split track set into confirmed and unconfirmed tracks.</span>
        <span class="token comment"># 1 把轨迹分为确认状态和非确认状态</span>
        confirmed_tracks <span class="token operator">=</span> <span class="token punctuation">[</span>
            i <span class="token keyword">for</span> i<span class="token punctuation">,</span> t <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>tracks<span class="token punctuation">)</span> <span class="token keyword">if</span> t<span class="token punctuation">.</span>is_confirmed<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        unconfirmed_tracks <span class="token operator">=</span> <span class="token punctuation">[</span>
            i <span class="token keyword">for</span> i<span class="token punctuation">,</span> t <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>tracks<span class="token punctuation">)</span> <span class="token keyword">if</span> <span class="token keyword">not</span> t<span class="token punctuation">.</span>is_confirmed<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token comment"># Associate confirmed tracks using appearance features. </span>
        <span class="token comment"># 2 级联匹配</span>
        matches_a<span class="token punctuation">,</span> unmatched_tracks_a<span class="token punctuation">,</span> unmatched_detections <span class="token operator">=</span> \
            linear_assignment<span class="token punctuation">.</span>matching_cascade<span class="token punctuation">(</span>
                gated_metric<span class="token punctuation">,</span> self<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>matching_threshold<span class="token punctuation">,</span> self<span class="token punctuation">.</span>max_age<span class="token punctuation">,</span>
                self<span class="token punctuation">.</span>tracks<span class="token punctuation">,</span> detections<span class="token punctuation">,</span> confirmed_tracks<span class="token punctuation">)</span>

        <span class="token comment"># Associate remaining tracks together with unconfirmed tracks using IOU.</span>
        <span class="token comment"># 3 IOU匹配</span>
        iou_track_candidates <span class="token operator">=</span> unconfirmed_tracks <span class="token operator">+</span> <span class="token punctuation">[</span>
            k <span class="token keyword">for</span> k <span class="token keyword">in</span> unmatched_tracks_a <span class="token keyword">if</span>
            self<span class="token punctuation">.</span>tracks<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>time_since_update <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">]</span>   <span class="token comment"># 如果级联未匹配轨迹上一帧匹配成功，这一帧匹配失败，则把其添加到不确认轨迹中</span>
        unmatched_tracks_a <span class="token operator">=</span> <span class="token punctuation">[</span>
            k <span class="token keyword">for</span> k <span class="token keyword">in</span> unmatched_tracks_a <span class="token keyword">if</span>
            self<span class="token punctuation">.</span>tracks<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>time_since_update <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">]</span>   <span class="token comment"># 跟新unmatched_tracks_a，只保留大于等于连续两帧没有被匹配上的</span>
        matches_b<span class="token punctuation">,</span> unmatched_tracks_b<span class="token punctuation">,</span> unmatched_detections <span class="token operator">=</span> \
            linear_assignment<span class="token punctuation">.</span>min_cost_matching<span class="token punctuation">(</span>
                iou_matching<span class="token punctuation">.</span>iou_cost<span class="token punctuation">,</span> self<span class="token punctuation">.</span>max_iou_distance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>tracks<span class="token punctuation">,</span>
                detections<span class="token punctuation">,</span> iou_track_candidates<span class="token punctuation">,</span> unmatched_detections<span class="token punctuation">)</span>  <span class="token comment"># IOU匹配</span>
        <span class="token comment"># 4 更新级联匹配和IOU匹配的结果</span>
        matches <span class="token operator">=</span> matches_a <span class="token operator">+</span> matches_b
        unmatched_tracks <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>unmatched_tracks_a <span class="token operator">+</span> unmatched_tracks_b<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> matches<span class="token punctuation">,</span> unmatched_tracks<span class="token punctuation">,</span> unmatched_detections

    <span class="token keyword">def</span> <span class="token function">_initiate_track</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> detection<span class="token punctuation">)</span><span class="token punctuation">:</span>
        mean<span class="token punctuation">,</span> covariance <span class="token operator">=</span> self<span class="token punctuation">.</span>kf<span class="token punctuation">.</span>initiate<span class="token punctuation">(</span>detection<span class="token punctuation">.</span>to_xyah<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 根据新检测到的框初始化轨迹的数值和协方差</span>
        self<span class="token punctuation">.</span>tracks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>Track<span class="token punctuation">(</span>
            mean<span class="token punctuation">,</span> covariance<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_next_id<span class="token punctuation">,</span> self<span class="token punctuation">.</span>n_init<span class="token punctuation">,</span> self<span class="token punctuation">.</span>max_age<span class="token punctuation">,</span>detection<span class="token punctuation">.</span>oid<span class="token punctuation">,</span>
            detection<span class="token punctuation">.</span>feature<span class="token punctuation">)</span><span class="token punctuation">)</span>               <span class="token comment"># 添加新的轨迹</span>
        self<span class="token punctuation">.</span>_next_id <span class="token operator">+=</span> <span class="token number">1</span>

<span class="token comment"># 2 级联匹配</span>
级联匹配步骤：
<span class="token number">2.1</span> 获取（<span class="token number">1</span> <span class="token operator">+</span> level）次没有被匹配上的轨迹
<span class="token number">2.2</span> 计算轨迹特征和检测特征的代价矩阵
    <span class="token number">2.2</span><span class="token number">.1</span> 计算轨迹与检测的特征余弦距离
    <span class="token number">2.2</span><span class="token number">.2</span> 用轨迹与检测的马氏距离跟新cost_matrix矩阵

<span class="token keyword">def</span> <span class="token function">matching_cascade</span><span class="token punctuation">(</span>
        distance_metric<span class="token punctuation">,</span> max_distance<span class="token punctuation">,</span> cascade_depth<span class="token punctuation">,</span> tracks<span class="token punctuation">,</span> detections<span class="token punctuation">,</span>
        track_indices<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> detection_indices<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Run matching cascade.

    Parameters
    ----------
    distance_metric : Callable[List[Track], List[Detection], List[int], List[int]) -&gt; ndarray
        The distance metric is given a list of tracks and detections as well as
        a list of N track indices and M detection indices. The metric should
        return the NxM dimensional cost matrix, where element (i, j) is the
        association cost between the i-th track in the given track indices and
        the j-th detection in the given detection indices.
    max_distance : float
        Gating threshold. Associations with cost larger than this value are
        disregarded.
    cascade_depth: int
        The cascade depth, should be se to the maximum track age.
    tracks : List[track.Track]
        A list of predicted tracks at the current time step.
    detections : List[detection.Detection]
        A list of detections at the current time step.
    track_indices : Optional[List[int]]
        List of track indices that maps rows in `cost_matrix` to tracks in
        `tracks` (see description above). Defaults to all tracks.
    detection_indices : Optional[List[int]]
        List of detection indices that maps columns in `cost_matrix` to
        detections in `detections` (see description above). Defaults to all
        detections.

    Returns
    -------
    (List[(int, int)], List[int], List[int])
        Returns a tuple with the following three entries:
        * A list of matched track and detection indices.
        * A list of unmatched track indices.
        * A list of unmatched detection indices.

    """</span>
    <span class="token keyword">if</span> track_indices <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        track_indices <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>tracks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> detection_indices <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        detection_indices <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>detections<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    unmatched_detections <span class="token operator">=</span> detection_indices              <span class="token comment"># 初始所有的检测都没有匹配</span>
    matches <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> level <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>cascade_depth<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>unmatched_detections<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                <span class="token comment"># No detections left</span>
            <span class="token keyword">break</span>
        <span class="token comment"># 1 获取（1 + level）次没有被匹配上的轨迹</span>
        track_indices_l <span class="token operator">=</span> <span class="token punctuation">[</span>
            k <span class="token keyword">for</span> k <span class="token keyword">in</span> track_indices
            <span class="token keyword">if</span> tracks<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>time_since_update <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">+</span> level   
        <span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>track_indices_l<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>                     <span class="token comment"># Nothing to match at this level</span>
            <span class="token keyword">continue</span>
        <span class="token comment"># 2 计算轨迹特征和检测特征的马氏距离</span>
        matches_l<span class="token punctuation">,</span> _<span class="token punctuation">,</span> unmatched_detections <span class="token operator">=</span> \
            min_cost_matching<span class="token punctuation">(</span>
                distance_metric<span class="token punctuation">,</span> max_distance<span class="token punctuation">,</span> tracks<span class="token punctuation">,</span> detections<span class="token punctuation">,</span>  <span class="token comment"># max_distance阈值</span>
                track_indices_l<span class="token punctuation">,</span> unmatched_detections<span class="token punctuation">)</span>
        matches <span class="token operator">+=</span> matches_l
    unmatched_tracks <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>track_indices<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token builtin">set</span><span class="token punctuation">(</span>k <span class="token keyword">for</span> k<span class="token punctuation">,</span> _ <span class="token keyword">in</span> matches<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> matches<span class="token punctuation">,</span> unmatched_tracks<span class="token punctuation">,</span> unmatched_detections
</code></pre>
    <h3>
     <a id="26__450">
     </a>
     2.6 计算轨迹与检测的特征余弦距离
    </h3>
    <p>
     对检测特征和历史的轨迹特征先归一化，再1减去特征的矩阵相乘得到余弦距离
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">_cosine_distance</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> data_is_normalized<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Compute pair-wise cosine distance between points in `a` and `b`.

    Parameters
    ----------
    a : array_like
        An NxM matrix of N samples of dimensionality M.
    b : array_like
        An LxM matrix of L samples of dimensionality M.
    data_is_normalized : Optional[bool]
        If True, assumes rows in a and b are unit length vectors.
        Otherwise, a and b are explicitly normalized to lenght 1.

    Returns
    -------
    ndarray
        Returns a matrix of size len(a), len(b) such that element (i, j)
        contains the squared distance between `a[i]` and `b[j]`.

    """</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> data_is_normalized<span class="token punctuation">:</span>
        a <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">/</span> np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>a<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> keepdims<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># a是轨迹特征归一化</span>
        b <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">/</span> np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>norm<span class="token punctuation">(</span>b<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> keepdims<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># b是检测特征归一化</span>
    <span class="token keyword">return</span> <span class="token number">1.</span> <span class="token operator">-</span> np<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">.</span>T<span class="token punctuation">)</span>

</code></pre>
    <h3>
     <a id="27_cost_matrix_480">
     </a>
     2.7 用轨迹与检测的马氏距离跟新cost_matrix矩阵
    </h3>
    <p>
     根据公式计算马氏距离
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">gate_cost_matrix</span><span class="token punctuation">(</span>
        kf<span class="token punctuation">,</span> cost_matrix<span class="token punctuation">,</span> tracks<span class="token punctuation">,</span> detections<span class="token punctuation">,</span> track_indices<span class="token punctuation">,</span> detection_indices<span class="token punctuation">,</span>
        gated_cost<span class="token operator">=</span>INFTY_COST<span class="token punctuation">,</span> only_position<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""Invalidate infeasible entries in cost matrix based on the state
    distributions obtained by Kalman filtering.

    Parameters
    ----------
    kf : The Kalman filter.
    cost_matrix : ndarray
        The NxM dimensional cost matrix, where N is the number of track indices
        and M is the number of detection indices, such that entry (i, j) is the
        association cost between `tracks[track_indices[i]]` and
        `detections[detection_indices[j]]`.
    tracks : List[track.Track]
        A list of predicted tracks at the current time step.
    detections : List[detection.Detection]
        A list of detections at the current time step.
    track_indices : List[int]
        List of track indices that maps rows in `cost_matrix` to tracks in
        `tracks` (see description above).
    detection_indices : List[int]
        List of detection indices that maps columns in `cost_matrix` to
        detections in `detections` (see description above).
    gated_cost : Optional[float]
        Entries in the cost matrix corresponding to infeasible associations are
        set this value. Defaults to a very large value.
    only_position : Optional[bool]
        If True, only the x, y position of the state distribution is considered
        during gating. Defaults to False.

    Returns
    -------
    ndarray
        Returns the modified cost matrix.

    """</span>
    gating_dim <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">if</span> only_position <span class="token keyword">else</span> <span class="token number">4</span>
    gating_threshold <span class="token operator">=</span> kalman_filter<span class="token punctuation">.</span>chi2inv95<span class="token punctuation">[</span>gating_dim<span class="token punctuation">]</span>
    measurements <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>
        <span class="token punctuation">[</span>detections<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>to_xyah<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">for</span> i <span class="token keyword">in</span> detection_indices<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> row<span class="token punctuation">,</span> track_idx <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>track_indices<span class="token punctuation">)</span><span class="token punctuation">:</span>
        track <span class="token operator">=</span> tracks<span class="token punctuation">[</span>track_idx<span class="token punctuation">]</span>               <span class="token comment"># gating_distance马氏距离</span>
        gating_distance <span class="token operator">=</span> kf<span class="token punctuation">.</span>gating_distance<span class="token punctuation">(</span>   <span class="token comment"># track.mean, track.covariance是轨迹的均值和协方差。measurements是检测框</span>
            track<span class="token punctuation">.</span>mean<span class="token punctuation">,</span> track<span class="token punctuation">.</span>covariance<span class="token punctuation">,</span> measurements<span class="token punctuation">,</span> only_position<span class="token punctuation">)</span>
        cost_matrix<span class="token punctuation">[</span>row<span class="token punctuation">,</span> gating_distance <span class="token operator">&gt;</span> gating_threshold<span class="token punctuation">]</span> <span class="token operator">=</span> gated_cost  <span class="token comment"># 如果马氏距离大于阈值，则赋值为极大值。</span>
    <span class="token keyword">return</span> cost_matrix
    
    <span class="token comment"># 马氏距离</span>
    <span class="token keyword">def</span> <span class="token function">gating_distance</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mean<span class="token punctuation">,</span> covariance<span class="token punctuation">,</span> measurements<span class="token punctuation">,</span>
                        only_position<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""Compute gating distance between state distribution and measurements.

        A suitable distance threshold can be obtained from `chi2inv95`. If
        `only_position` is False, the chi-square distribution has 4 degrees of
        freedom, otherwise 2.

        Parameters
        ----------
        mean : ndarray
            Mean vector over the state distribution (8 dimensional).
        covariance : ndarray
            Covariance of the state distribution (8x8 dimensional).
        measurements : ndarray
            An Nx4 dimensional matrix of N measurements, each in
            format (x, y, a, h) where (x, y) is the bounding box center
            position, a the aspect ratio, and h the height.
        only_position : Optional[bool]
            If True, distance computation is done with respect to the bounding
            box center position only.

        Returns
        -------
        ndarray
            Returns an array of length N, where the i-th element contains the
            squared Mahalanobis distance between (mean, covariance) and
            `measurements[i]`.

        """</span>
        mean<span class="token punctuation">,</span> covariance <span class="token operator">=</span> self<span class="token punctuation">.</span>project<span class="token punctuation">(</span>mean<span class="token punctuation">,</span> covariance<span class="token punctuation">)</span>  <span class="token comment"># 轨迹特征</span>
        <span class="token keyword">if</span> only_position<span class="token punctuation">:</span>                                  <span class="token comment"># 计算马氏距离用几个值</span>
            mean<span class="token punctuation">,</span> covariance <span class="token operator">=</span> mean<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> covariance<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
            measurements <span class="token operator">=</span> measurements<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>

        cholesky_factor <span class="token operator">=</span> np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>cholesky<span class="token punctuation">(</span>covariance<span class="token punctuation">)</span>   <span class="token comment"># 对轨迹的协方差分解成下三角矩阵和，前提covariance正定</span>
        d <span class="token operator">=</span> measurements <span class="token operator">-</span> mean                            <span class="token comment">#（det-track）.T *track's covariance.INV *（det-track）</span>
        z <span class="token operator">=</span> scipy<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>solve_triangular<span class="token punctuation">(</span>    <span class="token comment"># 求线性方程组的解    mash = d.T *covariance^{-1} *d = d.T *(L.T*L) *d = (Ld).T*(Ld)</span>
            cholesky_factor<span class="token punctuation">,</span> d<span class="token punctuation">.</span>T<span class="token punctuation">,</span> lower<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> check_finite<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>  <span class="token comment"># L.T*? = d.T--&gt; ? = ((L.T)^{-1} d.T=(dL^{-1}).T</span>
            overwrite_b<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        squared_maha <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>z <span class="token operator">*</span> z<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> squared_maha

</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33353733323332312f:61727469636c652f64657461696c732f313436323632313732" class_="artid" style="display:none">
 </p>
</div>


