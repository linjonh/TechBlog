---
layout: post
title: "OpenCV-dlib换脸操作"
date: 2025-03-04 19:42:25 +0800
description: "dlib 换脸是基于 dlib 库实现的一种人脸替换技术，以下是关于它的详细介绍：原理人脸检测：dlib 库中包含先进的人脸检测器，如基于 HOG（方向梯度直方图）特征和线性分类器的方法，能够在图像或视频帧中快速定位人脸的位置，确定人脸的边界框。关键点检测：利用 dlib 预训练的形状预测模型，如shape_predictor_68_face_landmarks.dat，可以精准定位出人脸的 68 个关键点，这些点分布在眼睛、眉毛、鼻子、嘴巴、下巴等部位，精确描述了人脸的形状和表情。"
keywords: "import cv2import dlibimport numpy as np# 加载照片image = cv2.imread('pho"
categories: ['未分类']
tags: ['计算机视觉', '人工智能', 'Opencv']
artid: "146024809"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146024809
    alt: "OpenCV-dlib换脸操作"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146024809
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146024809
cover: https://bing.ee123.net/img/rand?artid=146024809
image: https://bing.ee123.net/img/rand?artid=146024809
img: https://bing.ee123.net/img/rand?artid=146024809
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     《OpenCV》—— dlib（换脸操作）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h3>
     <a id="dlib_3">
     </a>
     dlib换脸介绍
    </h3>
    <ul>
     <li>
      dlib 换脸是基于 dlib 库实现的一种人脸替换技术，以下是关于它的详细介绍：
      <ul>
       <li>
        原理
        <ul>
         <li>
          人脸检测：dlib 库中包含先进的人脸检测器，如基于 HOG（方向梯度直方图）特征和线性分类器的方法，能够在图像或视频帧中快速定位人脸的位置，确定人脸的边界框。
         </li>
         <li>
          关键点检测：利用 dlib 预训练的形状预测模型，如shape_predictor_68_face_landmarks.dat，可以精准定位出人脸的 68 个关键点，这些点分布在眼睛、眉毛、鼻子、嘴巴、下巴等部位，精确描述了人脸的形状和表情。
         </li>
         <li>
          图像变换与融合：通过计算源人脸和目标人脸关键点之间的变换关系，如仿射变换、Delaunay 三角剖分等，将源人脸的形状和姿态调整到与目标人脸匹配。然后，采用图像融合技术，将调整后的源人脸与目标图像进行融合，使换脸效果更加自然。
         </li>
        </ul>
       </li>
       <li>
        实现步骤
        <ul>
         <li>
          安装相关库：主要安装 dlib 库，还可能需要 opencv、numpy 等库配合。在 Python 中可以使用pip install dlib等命令安装。
         </li>
         <li>
          人脸检测与关键点提取：使用 dlib 的人脸检测器和形状预测器，加载图像或视频帧，检测其中的人脸并提取关键点。
         </li>
         <li>
          计算变换关系：根据源人脸和目标人脸的关键点，计算出两者之间的变换矩阵，确定如何将源人脸变换到目标人脸的位置和姿态。
         </li>
         <li>
          人脸替换：将源人脸按照计算出的变换关系进行变形和调整，然后将其融合到目标图像的对应位置上。
         </li>
         <li>
          后处理：对换脸后的图像进行一些后处理操作，如调整颜色、亮度、对比度等，使换脸效果更加自然逼真。
         </li>
        </ul>
       </li>
       <li>
        优缺点
        <ul>
         <li>
          优点：具有较高的人脸检测和关键点定位精度，能够处理不同姿态、表情和光照条件下的人脸；提供了丰富的函数和工具，方便开发者进行二次开发和集成；在处理速度上相对较快，能够满足一些实时性要求不高的应用场景。
         </li>
         <li>
          缺点：对图像和视频的质量要求较高，如果输入的图像分辨率低、模糊或存在遮挡，可能会影响换脸效果；对于复杂的场景和特殊的光照条件，换脸效果可能不够自然；在实时性要求较高的场景中，如实时视频通话换脸，可能需要进一步优化才能满足性能要求。
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="_18">
     </a>
     仿射变换
    </h3>
    <p>
     仿射变换（Affine Transformation）是一种在二维或三维空间中广泛应用的线性变换，它能够保持图像的 “平直性” 和 “平行性”，在计算机视觉、图形学等领域有诸多应用，比如在 dlib 换脸中就用于调整源人脸的形状和姿态以匹配目标人脸。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b7b77c9006f94a24ab95e6e70e78f5c3.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f75ed9a5ad1c40cd936b9529b33d2d98.png"/>
    </p>
    <h4>
     <a id="_dlib__23">
     </a>
     在 dlib 换脸中的应用
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/805fdf6dfcce4aaa8ec30b80dd35c484.png"/>
    </p>
    <blockquote>
     <p>
      图片：
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a18d5ef10d5242cc87cea658eddc80fc.png"/>
     </p>
    </blockquote>
    <p>
     <mark>
      仿射变换代码：
     </mark>
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token comment"># 读取图像，这里读取的图像文件名为 'c_luo.png'</span>
<span class="token comment"># cv2.imread 函数用于从指定路径读取图像，返回一个表示图像的 NumPy 数组</span>
img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'c_luo.png'</span><span class="token punctuation">)</span>

<span class="token comment"># 获取图像的高度和宽度</span>
<span class="token comment"># img.shape 返回一个包含图像维度信息的元组，元组的前两个元素分别是图像的高度和宽度</span>
height<span class="token punctuation">,</span> width <span class="token operator">=</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>

<span class="token comment"># 定义源图像的三个关键点</span>
<span class="token comment"># 这里使用 np.float32 创建一个 3x2 的浮点型 NumPy 数组</span>
<span class="token comment"># 三个点分别是图像的左上角 (0, 0)、左下角 (0, height - 1) 和右上角 (width - 1, 0)</span>
mat_src <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> height <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>width <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 定义目标图像对应的三个关键点</span>
<span class="token comment"># 同样是一个 3x2 的浮点型 NumPy 数组</span>
<span class="token comment"># 这里的三个点是经过变换后源图像三个关键点对应的目标位置</span>
mat_dst <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">,</span> height <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>width <span class="token operator">-</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 计算仿射变换矩阵</span>
<span class="token comment"># cv2.getAffineTransform 函数根据源图像和目标图像的三个对应关键点，计算仿射变换矩阵</span>
<span class="token comment"># 该矩阵用于描述从源图像到目标图像的仿射变换关系</span>
M <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getAffineTransform<span class="token punctuation">(</span>mat_src<span class="token punctuation">,</span> mat_dst<span class="token punctuation">)</span>

<span class="token comment"># 应用仿射变换</span>
<span class="token comment"># cv2.warpAffine 函数将仿射变换应用到输入图像 img 上</span>
<span class="token comment"># M 是前面计算得到的仿射变换矩阵</span>
<span class="token comment"># (width, height) 是输出图像的大小</span>
dst <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>img<span class="token punctuation">,</span> M<span class="token punctuation">,</span> <span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 将原始图像和经过仿射变换后的图像水平拼接在一起</span>
<span class="token comment"># np.hstack 函数用于将多个数组水平堆叠，方便同时显示原始图像和变换后的图像</span>
imgs <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">[</span>img<span class="token punctuation">,</span> dst<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 创建一个可调整大小的窗口</span>
<span class="token comment"># cv2.namedWindow 函数用于创建一个指定名称的窗口，cv2.WINDOW_NORMAL 表示窗口可以调整大小</span>
cv2<span class="token punctuation">.</span>namedWindow<span class="token punctuation">(</span><span class="token string">'imgs'</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>WINDOW_NORMAL<span class="token punctuation">)</span>

<span class="token comment"># 在创建的窗口中显示拼接后的图像</span>
cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'imgs'</span><span class="token punctuation">,</span> imgs<span class="token punctuation">)</span>

<span class="token comment"># 等待用户按下任意按键</span>
<span class="token comment"># cv2.waitKey(0) 表示无限期等待用户按键，按键后程序继续执行</span>
cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre>
    <blockquote>
     <p>
      这段代码的主要功能是对一张图像进行仿射变换，并将原始图像和变换后的图像拼接在一起显示。通过指定源图像和目标图像的三个对应关键点，计算出仿射变换矩阵，然后将该变换应用到图像上。
     </p>
    </blockquote>
    <p>
     <mark>
      结果：
     </mark>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/63016a0bd8e14f56be2fb4efdeb16a08.png"/>
    </p>
    <h3>
     <a id="_82">
     </a>
     换脸操作
    </h3>
    <blockquote>
     <p>
      对下方图片进行换脸操作：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f3f59273bdba4d058db4bb6e05a18583.png">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f1eb795e572b4b3387dd6b4c4102c806.png">
        <br/>
        <mark>
         实现代码：
        </mark>
       </img>
      </img>
     </p>
    </blockquote>
    <pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> dlib
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token comment"># 定义人脸关键点的索引范围</span>
<span class="token comment"># 下巴关键点索引</span>
JAW_POINTS <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 右眉毛关键点索引</span>
RIGHT_BROW_POINTS <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 左眉毛关键点索引</span>
LEFT_BROW_POINTS <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 鼻子关键点索引</span>
NOSE_POINTS <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">27</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 右眼关键点索引</span>
RIGHT_EYE_POINTS <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">36</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 左眼关键点索引</span>
LEFT_EYE_POINTS <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 嘴巴关键点索引</span>
MOUTH_POINTS <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 脸部关键点索引（不包括下巴）</span>
FACE_POINTS <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 选取用于变换的关键点集合</span>
POINTS <span class="token operator">=</span> <span class="token punctuation">[</span>LEFT_BROW_POINTS <span class="token operator">+</span> RIGHT_EYE_POINTS <span class="token operator">+</span> LEFT_EYE_POINTS <span class="token operator">+</span> RIGHT_BROW_POINTS <span class="token operator">+</span> NOSE_POINTS <span class="token operator">+</span> MOUTH_POINTS<span class="token punctuation">]</span>
<span class="token comment"># 将关键点集合转换为元组</span>
POINTStuple <span class="token operator">=</span> <span class="token builtin">tuple</span><span class="token punctuation">(</span>POINTS<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">getFaceMask</span><span class="token punctuation">(</span>im<span class="token punctuation">,</span> keyPoints<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    生成人脸掩码
    :param im: 输入图像
    :param keyPoints: 人脸关键点
    :return: 人脸掩码图像
    """</span>
    <span class="token comment"># 创建一个与输入图像高度和宽度相同的零矩阵</span>
    im <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>im<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>float64<span class="token punctuation">)</span>
    <span class="token keyword">for</span> p <span class="token keyword">in</span> POINTS<span class="token punctuation">:</span>
        <span class="token comment"># 计算关键点的凸包</span>
        points <span class="token operator">=</span> cv2<span class="token punctuation">.</span>convexHull<span class="token punctuation">(</span>keyPoints<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 填充凸包区域为 1</span>
        cv2<span class="token punctuation">.</span>fillConvexPoly<span class="token punctuation">(</span>im<span class="token punctuation">,</span> points<span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># 将单通道掩码扩展为三通道</span>
    im <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>im<span class="token punctuation">,</span> im<span class="token punctuation">,</span> im<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 对掩码进行高斯模糊处理</span>
    im <span class="token operator">=</span> cv2<span class="token punctuation">.</span>GaussianBlur<span class="token punctuation">(</span>im<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> im

<span class="token keyword">def</span> <span class="token function">getM</span><span class="token punctuation">(</span>points1<span class="token punctuation">,</span> points2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    计算仿射变换矩阵
    :param points1: 源图像的关键点
    :param points2: 目标图像的关键点
    :return: 仿射变换矩阵
    """</span>
    points1 <span class="token operator">=</span> points1<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float64<span class="token punctuation">)</span>
    points2 <span class="token operator">=</span> points2<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>float64<span class="token punctuation">)</span>

    <span class="token comment"># 计算关键点的均值</span>
    c1 <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>points1<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    c2 <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>points2<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># 减去均值进行中心化</span>
    points1 <span class="token operator">-=</span> c1
    points2 <span class="token operator">-=</span> c2

    <span class="token comment"># 计算关键点的标准差</span>
    s1 <span class="token operator">=</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>points1<span class="token punctuation">)</span>
    s2 <span class="token operator">=</span> np<span class="token punctuation">.</span>std<span class="token punctuation">(</span>points2<span class="token punctuation">)</span>

    <span class="token comment"># 归一化关键点</span>
    points1 <span class="token operator">/=</span> s1
    points2 <span class="token operator">/=</span> s2

    <span class="token comment"># 进行奇异值分解</span>
    U<span class="token punctuation">,</span> S<span class="token punctuation">,</span> Vt <span class="token operator">=</span> np<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>svd<span class="token punctuation">(</span>points1<span class="token punctuation">.</span>T <span class="token operator">*</span> points2<span class="token punctuation">)</span>
    <span class="token comment"># 计算旋转矩阵</span>
    R <span class="token operator">=</span> <span class="token punctuation">(</span>U <span class="token operator">*</span> Vt<span class="token punctuation">)</span><span class="token punctuation">.</span>T
    <span class="token keyword">return</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s2 <span class="token operator">/</span> s1<span class="token punctuation">)</span> <span class="token operator">*</span> R<span class="token punctuation">,</span> c2<span class="token punctuation">.</span>T <span class="token operator">-</span> <span class="token punctuation">(</span>s2 <span class="token operator">/</span> s1<span class="token punctuation">)</span> <span class="token operator">*</span> R <span class="token operator">*</span> c1<span class="token punctuation">.</span>T<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">getKeyPoints</span><span class="token punctuation">(</span>im<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    检测图像中的人脸关键点
    :param im: 输入图像
    :return: 人脸关键点矩阵
    """</span>
    <span class="token comment"># 使用 dlib 的人脸检测器检测人脸</span>
    rects <span class="token operator">=</span> detector<span class="token punctuation">(</span>im<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token comment"># 使用 dlib 的形状预测器预测关键点</span>
    shape <span class="token operator">=</span> predictor<span class="token punctuation">(</span>im<span class="token punctuation">,</span> rects<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token comment"># 将关键点转换为矩阵形式</span>
    s <span class="token operator">=</span> np<span class="token punctuation">.</span>matrix<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>p<span class="token punctuation">.</span>x<span class="token punctuation">,</span> p<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> shape<span class="token punctuation">.</span>parts<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> s

<span class="token keyword">def</span> <span class="token function">normalColor</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    颜色校正
    :param a: 源图像
    :param b: 目标图像
    :return: 颜色校正后的目标图像
    """</span>
    <span class="token comment"># 定义高斯核大小</span>
    ksize <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">71</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">)</span>
    <span class="token comment"># 对源图像和目标图像进行高斯模糊</span>
    aGauss <span class="token operator">=</span> cv2<span class="token punctuation">.</span>GaussianBlur<span class="token punctuation">(</span>a<span class="token punctuation">,</span> ksize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    bGauss <span class="token operator">=</span> cv2<span class="token punctuation">.</span>GaussianBlur<span class="token punctuation">(</span>b<span class="token punctuation">,</span> ksize<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment"># 避免除以零</span>
    bGauss <span class="token operator">=</span> np<span class="token punctuation">.</span>where<span class="token punctuation">(</span>bGauss <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1e-8</span><span class="token punctuation">,</span> bGauss<span class="token punctuation">)</span>
    <span class="token comment"># 计算权重</span>
    weight <span class="token operator">=</span> aGauss <span class="token operator">/</span> bGauss
    <span class="token keyword">return</span> b <span class="token operator">*</span> weight

<span class="token comment"># 读取源图像和目标图像</span>
a <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'c_luo.png'</span><span class="token punctuation">)</span>
b <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'mu_ba_pei.png'</span><span class="token punctuation">)</span>

<span class="token comment"># 初始化 dlib 的人脸检测器</span>
detector <span class="token operator">=</span> dlib<span class="token punctuation">.</span>get_frontal_face_detector<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 初始化 dlib 的形状预测器，需要提前下载 shape_predictor_68_face_landmarks.dat 文件</span>
predictor <span class="token operator">=</span> dlib<span class="token punctuation">.</span>shape_predictor<span class="token punctuation">(</span><span class="token string">'shape_predictor_68_face_landmarks.dat'</span><span class="token punctuation">)</span>

<span class="token comment"># 检测源图像和目标图像的人脸关键点</span>
aKeyPoints <span class="token operator">=</span> getKeyPoints<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
bKeyPoints <span class="token operator">=</span> getKeyPoints<span class="token punctuation">(</span>b<span class="token punctuation">)</span>

<span class="token comment"># 保存目标图像的原始副本</span>
bOriginal <span class="token operator">=</span> b<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 生成源图像的人脸掩码</span>
aMask <span class="token operator">=</span> getFaceMask<span class="token punctuation">(</span>a<span class="token punctuation">,</span> aKeyPoints<span class="token punctuation">)</span>
<span class="token comment"># 显示源图像的人脸掩码</span>
cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'aMask'</span><span class="token punctuation">,</span> aMask<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 生成目标图像的人脸掩码（使用源图像的关键点）</span>
bMask <span class="token operator">=</span> getFaceMask<span class="token punctuation">(</span>b<span class="token punctuation">,</span> aKeyPoints<span class="token punctuation">)</span>
<span class="token comment"># 显示目标图像的人脸掩码</span>
cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'bMask'</span><span class="token punctuation">,</span> bMask<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 计算仿射变换矩阵</span>
M <span class="token operator">=</span> getM<span class="token punctuation">(</span>aKeyPoints<span class="token punctuation">[</span>POINTStuple<span class="token punctuation">]</span><span class="token punctuation">,</span> bKeyPoints<span class="token punctuation">[</span>POINTStuple<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 获取源图像的尺寸（宽度和高度）</span>
dsize <span class="token operator">=</span> a<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

<span class="token comment"># 对目标图像的掩码进行仿射变换</span>
bMaskWarp <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>bMask<span class="token punctuation">,</span> M<span class="token punctuation">,</span> dsize<span class="token punctuation">,</span>
                           borderMode<span class="token operator">=</span>cv2<span class="token punctuation">.</span>BORDER_TRANSPARENT<span class="token punctuation">,</span>
                           flags<span class="token operator">=</span>cv2<span class="token punctuation">.</span>WARP_INVERSE_MAP<span class="token punctuation">)</span>
<span class="token comment"># 显示变换后的目标图像掩码</span>
cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'bMaskWarp'</span><span class="token punctuation">,</span> bMaskWarp<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 合并源图像掩码和变换后的目标图像掩码</span>
mask <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">[</span>aMask<span class="token punctuation">,</span> bMaskWarp<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token comment"># 显示合并后的掩码</span>
cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'mask'</span><span class="token punctuation">,</span> mask<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 对目标图像进行仿射变换</span>
bWrap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>warpAffine<span class="token punctuation">(</span>b<span class="token punctuation">,</span> M<span class="token punctuation">,</span> dsize<span class="token punctuation">,</span>
                       borderMode<span class="token operator">=</span>cv2<span class="token punctuation">.</span>BORDER_TRANSPARENT<span class="token punctuation">,</span>
                       flags<span class="token operator">=</span>cv2<span class="token punctuation">.</span>WARP_INVERSE_MAP<span class="token punctuation">)</span>
<span class="token comment"># 显示变换后的目标图像</span>
cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'bWrap'</span><span class="token punctuation">,</span> bWrap<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 对变换后的目标图像进行颜色校正</span>
bcolor <span class="token operator">=</span> normalColor<span class="token punctuation">(</span>a<span class="token punctuation">,</span> bWrap<span class="token punctuation">)</span>
<span class="token comment"># 显示颜色校正后的目标图像</span>
cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'bcolor'</span><span class="token punctuation">,</span> bcolor<span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 融合源图像和颜色校正后的目标图像</span>
out <span class="token operator">=</span> a <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> mask<span class="token punctuation">)</span> <span class="token operator">+</span> bcolor <span class="token operator">*</span> mask
<span class="token comment"># 显示源图像</span>
cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">,</span> a<span class="token punctuation">)</span>
<span class="token comment"># 显示目标图像的原始副本</span>
cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'b'</span><span class="token punctuation">,</span> bOriginal<span class="token punctuation">)</span>
<span class="token comment"># 显示换脸后的结果图像</span>
cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'out'</span><span class="token punctuation">,</span> out <span class="token operator">/</span> <span class="token number">255</span><span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment"># 关闭所有 OpenCV 窗口</span>
cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <mark>
      结果：
     </mark>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0cbd7f85bbdf41bf9bd5a4f082c39626.png"/>
     <br/>
     可通过结果看出换脸成功。
    </p>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f6c6f75303732302f:61727469636c652f64657461696c732f313436303234383039" class_="artid" style="display:none">
 </p>
</div>


