---
layout: post
title: "ç”¨æˆ·æ¨¡å—æ¡æ‰‹éªŒè¯"
date: 2025-03-14 16:17:44 +0800
description: "åœ¨å½“å‰å®ç°ä¸­ï¼Œæ¯æ¬¡ WebSocket æ¡æ‰‹æ—¶ï¼ŒæœåŠ¡å™¨éƒ½éœ€è¦è§£æå¹¶éªŒè¯ Tokenã€‚æœåŠ¡å™¨åœ¨ Netty ä¸­è§£æ WebSocket æ¡æ‰‹è¯·æ±‚çš„ URLï¼Œæå– Token è¿›è¡Œèº«ä»½è®¤è¯ï¼Œè®¤è¯æˆåŠŸåç»‘å®š Token åˆ°ç”¨æˆ·çš„ WebSocket ä¼šè¯ä¸­ã€‚ä¸ºäº†å‡å°‘ WebSocket è®¤è¯çš„é¢å¤–å¼€é”€ï¼Œæˆ‘ä»¬éœ€è¦ä¼˜åŒ–ä¼ ç»Ÿçš„è®¤è¯æµç¨‹ï¼Œè®©ç”¨æˆ·åœ¨åˆ·æ–°é¡µé¢æ—¶ä¸éœ€è¦é¢å¤–å‘é€è®¤è¯è¯·æ±‚ï¼Œè€Œæ˜¯ã€‚ï¼ˆRTTï¼ŒRound Trip Timeï¼‰ï¼Œä¸ä»…å¢åŠ äº†æœåŠ¡å™¨å‹åŠ›ï¼Œè¿˜ä¼šå½±å“ç”¨æˆ·ä½“éªŒï¼Œå°¤å…¶æ˜¯åœ¨ç½‘ç»œå»¶è¿Ÿè¾ƒé«˜çš„ç¯å¢ƒä¸‹ï¼Œè®¤è¯é€Ÿåº¦ä¼šæ˜æ˜¾å˜æ…¢ã€‚"
keywords: "ç”¨æˆ·æ¨¡å—â€”â€”æ¡æ‰‹éªŒè¯"
categories: ['Im']
tags: ['å¼€å‘è¯­è¨€', 'Java']
artid: "146259604"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146259604
    alt: "ç”¨æˆ·æ¨¡å—æ¡æ‰‹éªŒè¯"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146259604
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146259604
cover: https://bing.ee123.net/img/rand?artid=146259604
image: https://bing.ee123.net/img/rand?artid=146259604
img: https://bing.ee123.net/img/rand?artid=146259604
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ç”¨æˆ·æ¨¡å—â€”â€”æ¡æ‰‹éªŒè¯
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h2>
     <span style="color:#0d0016">
      <strong>
       1. å¼•è¨€
      </strong>
     </span>
    </h2>
    <p>
     <span style="color:#0d0016">
      åœ¨ç°ä»£ Web åº”ç”¨ä¸­ï¼Œ
      <strong>
       WebSocket
      </strong>
      ä»¥å…¶
      <strong>
       å…¨åŒå·¥é€šä¿¡ã€ä½å»¶è¿Ÿã€å‡å°‘ HTTP å¼€é”€
      </strong>
      ç­‰ä¼˜åŠ¿ï¼Œè¢«å¹¿æ³›åº”ç”¨äºå³æ—¶é€šè®¯ã€åœ¨çº¿æ¸¸æˆã€å®æ—¶æ•°æ®æ¨é€ç­‰åœºæ™¯ã€‚ç„¶è€Œï¼Œåœ¨æ¶‰åŠ
      <strong>
       ç”¨æˆ·è®¤è¯
      </strong>
      æ—¶ï¼ŒWebSocket å­˜åœ¨ä¸€ä¸ªå¸¸è§é—®é¢˜â€”â€”
      <strong>
       æ¯æ¬¡åˆ·æ–°é¡µé¢éƒ½ä¼šé‡æ–°å»ºç«‹ WebSocket è¿æ¥ï¼Œå¯¼è‡´ç”¨æˆ·éœ€è¦é‡æ–°è®¤è¯
      </strong>
      ã€‚
     </span>
    </p>
    <h3>
     <span style="color:#0d0016">
      <strong>
       1.1 WebSocket è¿æ¥ä¸ç”¨æˆ·è®¤è¯çš„æŒ‘æˆ˜
      </strong>
     </span>
    </h3>
    <p>
     <span style="color:#0d0016">
      WebSocket è¿æ¥æ˜¯
      <strong>
       é•¿è¿æ¥
      </strong>
      ï¼Œä¸ä¼ ç»Ÿ HTTP è¯·æ±‚ä¸åŒï¼Œå®ƒå¹¶ä¸ä¼šåœ¨æ¯æ¬¡é€šä¿¡æ—¶éƒ½è‡ªåŠ¨æºå¸¦èº«ä»½è®¤è¯ä¿¡æ¯ï¼ˆå¦‚ Cookieã€Sessionï¼‰ã€‚è¿™æ„å‘³ç€ï¼š
     </span>
    </p>
    <ol>
     <li>
      <span style="color:#0d0016">
       <strong>
        é¡µé¢åˆ·æ–°åï¼ŒWebSocket è¿æ¥ä¼šæ–­å¼€å¹¶é‡æ–°å»ºç«‹
       </strong>
       ï¼ŒæœåŠ¡å™¨æ— æ³•è‡ªåŠ¨è¯†åˆ«ç”¨æˆ·èº«ä»½ï¼Œå¿…é¡»é‡æ–°è¿›è¡Œè®¤è¯ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        ä¼ ç»Ÿçš„ WebSocket è®¤è¯æµç¨‹è¾ƒé•¿
       </strong>
       ï¼Œé€šå¸¸æ˜¯ï¼š
      </span>
      <ul>
       <li>
        <span style="color:#0d0016">
         å‰ç«¯å»ºç«‹ WebSocket è¿æ¥ï¼›
        </span>
       </li>
       <li>
        <span style="color:#0d0016">
         è¿æ¥æˆåŠŸåï¼Œå‰ç«¯å‘é€ Token è¿›è¡Œèº«ä»½éªŒè¯ï¼›
        </span>
       </li>
       <li>
        <span style="color:#0d0016">
         æœåŠ¡å™¨éªŒè¯ Tokenï¼Œè¿”å›è®¤è¯ç»“æœã€‚
        </span>
       </li>
      </ul>
     </li>
    </ol>
    <p>
     <span style="color:#0d0016">
      è¿™æ ·ä¸‹æ¥ï¼Œæ•´ä¸ªè®¤è¯è¿‡ç¨‹æ¶‰åŠ
      <strong>
       ä¸‰æ¬¡æ•°æ®å¾€è¿”
      </strong>
      ï¼ˆRTTï¼ŒRound Trip Timeï¼‰ï¼Œä¸ä»…å¢åŠ äº†æœåŠ¡å™¨å‹åŠ›ï¼Œè¿˜ä¼šå½±å“ç”¨æˆ·ä½“éªŒï¼Œå°¤å…¶æ˜¯åœ¨ç½‘ç»œå»¶è¿Ÿè¾ƒé«˜çš„ç¯å¢ƒä¸‹ï¼Œè®¤è¯é€Ÿåº¦ä¼šæ˜æ˜¾å˜æ…¢ã€‚
     </span>
    </p>
    <h3>
     <span style="color:#0d0016">
      <strong>
       1.2 ç›®æ ‡ï¼šå‡å°‘è®¤è¯å›åˆï¼Œæé«˜ç”¨æˆ·ä½“éªŒ
      </strong>
     </span>
    </h3>
    <p>
     <span style="color:#0d0016">
      ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¸Œæœ›ä¼˜åŒ– WebSocket è®¤è¯æµç¨‹ï¼Œç›®æ ‡æ˜¯ï¼š
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       <strong>
        å‡å°‘è®¤è¯æ•°æ®å¾€è¿”æ¬¡æ•°
       </strong>
       ï¼Œä»ä¸‰æ¬¡ç¼©å‡ä¸ºä¸¤æ¬¡ç”šè‡³ä¸€æ¬¡ï¼›
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        åœ¨ WebSocket è¿æ¥å»ºç«‹æ—¶å°±å®Œæˆè®¤è¯
       </strong>
       ï¼Œé¿å…é¢å¤–çš„è®¤è¯æ¶ˆæ¯äº¤äº’ï¼›
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        ç¡®ä¿è®¤è¯æ–¹å¼å®‰å…¨å¯é 
       </strong>
       ï¼Œé˜²æ­¢ Token æ³„éœ²æˆ–è¢«åŠ«æŒã€‚
      </span>
     </li>
    </ul>
    <p>
     <span style="color:#0d0016">
      é€šè¿‡å¯¹ WebSocket è¿æ¥å»ºç«‹è¿‡ç¨‹çš„æ·±å…¥ç ”ç©¶ï¼Œæˆ‘ä»¬å‘ç°å¯ä»¥åœ¨
      <strong>
       WebSocket æ¡æ‰‹é˜¶æ®µ
      </strong>
      ï¼ˆä»ç„¶æ˜¯ HTTP è¯·æ±‚ï¼‰ç›´æ¥ä¼ é€’ Tokenï¼Œä»è€Œè®©æœåŠ¡å™¨
      <strong>
       åœ¨æ¡æ‰‹æ—¶å°±å®Œæˆèº«ä»½è®¤è¯
      </strong>
      ã€‚è¿™æ ·å¯ä»¥å¤§å¤§å‡å°‘é€šä¿¡å›åˆï¼Œæé«˜ç”¨æˆ·ä½“éªŒã€‚
     </span>
    </p>
    <h2>
     <span style="color:#0d0016">
      <strong>
       2. WebSocket è®¤è¯ä¼˜åŒ–æ€è·¯
      </strong>
     </span>
    </h2>
    <p>
     <span style="color:#0d0016">
      ä¸ºäº†å‡å°‘ WebSocket è®¤è¯çš„é¢å¤–å¼€é”€ï¼Œæˆ‘ä»¬éœ€è¦ä¼˜åŒ–ä¼ ç»Ÿçš„è®¤è¯æµç¨‹ï¼Œè®©ç”¨æˆ·åœ¨åˆ·æ–°é¡µé¢æ—¶ä¸éœ€è¦é¢å¤–å‘é€è®¤è¯è¯·æ±‚ï¼Œè€Œæ˜¯
      <strong>
       åœ¨ WebSocket è¿æ¥å»ºç«‹çš„åŒæ—¶å®Œæˆè®¤è¯
      </strong>
      ã€‚æœ¬èŠ‚å°†è¯¦ç»†ä»‹ç» WebSocket è®¤è¯çš„ä¼˜åŒ–æ–¹å‘ï¼Œå¹¶å¯¹æ¯”ä¸åŒæ–¹æ¡ˆçš„ä¼˜ç¼ºç‚¹ã€‚
     </span>
    </p>
    <h3>
     <span style="color:#0d0016">
      <strong>
       2.1 ä¼ ç»Ÿ WebSocket è®¤è¯æ–¹å¼åŠå…¶é—®é¢˜
      </strong>
     </span>
    </h3>
    <p>
     <span style="color:#0d0016">
      åœ¨æ ‡å‡†çš„ WebSocket è¿æ¥æµç¨‹ä¸­ï¼Œå‰ç«¯é€šå¸¸æŒ‰ç…§ä»¥ä¸‹æ–¹å¼è¿›è¡Œèº«ä»½è®¤è¯ï¼š
     </span>
    </p>
    <ol>
     <li>
      <span style="color:#0d0016">
       <strong>
        å»ºç«‹ WebSocket è¿æ¥
       </strong>
       ï¼ˆ
       <code>
        new WebSocket(url)
       </code>
       ï¼‰ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        WebSocket è¿æ¥å»ºç«‹åï¼Œå‰ç«¯å‘é€ Token
       </strong>
       ï¼ˆ
       <code>
        ws.send(token)
       </code>
       ï¼‰ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        æœåŠ¡å™¨æ¥æ”¶ Token å¹¶è¿›è¡Œèº«ä»½éªŒè¯
       </strong>
       ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        æœåŠ¡å™¨è¿”å›è®¤è¯ç»“æœï¼Œå‰ç«¯å†³å®šæ˜¯å¦ç»§ç»­é€šä¿¡
       </strong>
       ã€‚
      </span>
     </li>
    </ol>
    <p>
     <span style="color:#0d0016">
      è¿™ç§æ–¹å¼çš„ä¸»è¦é—®é¢˜æ˜¯ï¼š
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       <strong>
        å¢åŠ äº†ä¸å¿…è¦çš„é€šä¿¡å›åˆ
       </strong>
       ã€‚è¿æ¥å»ºç«‹åï¼Œè¿˜éœ€è¦é¢å¤–çš„æ¶ˆæ¯å¾€è¿”è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¯¼è‡´
       <strong>
        ä¸‰æ¬¡é€šä¿¡
       </strong>
       ï¼ˆRTT3ï¼‰ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        å½±å“ç”¨æˆ·ä½“éªŒ
       </strong>
       ã€‚ç½‘ç»œå»¶è¿Ÿé«˜æ—¶ï¼Œç”¨æˆ·å¯èƒ½éœ€è¦ç­‰å¾…è¾ƒé•¿æ—¶é—´æ‰èƒ½å®Œæˆè®¤è¯ï¼Œä½“éªŒä¸å¤Ÿæµç•…ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        å®‰å…¨æ€§é—®é¢˜
       </strong>
       ã€‚Token é€šè¿‡ WebSocket å‘é€ï¼Œå¯èƒ½è¢«æ¶æ„ä¸­é—´äººåŠ«æŒï¼Œå­˜åœ¨ä¸€å®šçš„å®‰å…¨é£é™©ï¼ˆè™½ç„¶ WebSocket è¿æ¥ä¸€èˆ¬æ˜¯
       <code>
        wss://
       </code>
       åŠ å¯†çš„ï¼Œä½†ä»éœ€è°¨æ…ï¼‰ã€‚
      </span>
     </li>
    </ul>
    <h3>
     <span style="color:#0d0016">
      <strong>
       2.2 ç›®æ ‡ï¼šè®© WebSocket è®¤è¯æ›´é«˜æ•ˆ
      </strong>
     </span>
    </h3>
    <p>
     <span style="color:#0d0016">
      ä¸ºäº†ä¼˜åŒ– WebSocket è®¤è¯ï¼Œæˆ‘ä»¬å¸Œæœ›è¾¾åˆ°ä»¥ä¸‹ç›®æ ‡ï¼š
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       <strong>
        å‡å°‘é€šä¿¡å›åˆ
       </strong>
       ï¼Œæœ€å¥½åœ¨
       <strong>
        WebSocket è¿æ¥å»ºç«‹çš„åŒæ—¶å®Œæˆè®¤è¯
       </strong>
       ï¼Œé¿å…é¢å¤–çš„è®¤è¯æ•°æ®äº¤äº’ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        ä¸ä¾èµ–é¢å¤–çš„ WebSocket æ¶ˆæ¯
       </strong>
       è¿›è¡Œè®¤è¯ï¼Œè€Œæ˜¯åœ¨
       <strong>
        æ¡æ‰‹é˜¶æ®µï¼ˆWebSocket Upgrade è¯·æ±‚ï¼‰
       </strong>
       ç›´æ¥å®Œæˆ Token è®¤è¯ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        å…¼å®¹æ€§å¼ºï¼Œå®‰å…¨æ€§é«˜
       </strong>
       ï¼Œé¿å… Token é€šè¿‡ WebSocket å‘é€ï¼Œå‡å°‘è¢«åŠ«æŒçš„é£é™©ã€‚
      </span>
     </li>
    </ul>
    <p>
     <span style="color:#0d0016">
      åŸºäºä»¥ä¸Šç›®æ ‡ï¼Œæˆ‘ä»¬æå‡ºä¸¤ç§ä¼˜åŒ–æ–¹æ¡ˆï¼š
     </span>
    </p>
    <h3>
     <span style="color:#0d0016">
      <strong>
       2.3 æ–¹æ¡ˆä¸€ï¼šé€šè¿‡ URL ä¼ é€’ Tokenï¼ˆæ¨èæ–¹æ¡ˆï¼‰
      </strong>
     </span>
    </h3>
    <p>
     <span style="color:#0d0016">
      <strong>
       å®ç°æ€è·¯ï¼š
      </strong>
      <br/>
      åœ¨ WebSocket è¿æ¥ URL ä¸­ç›´æ¥æ‹¼æ¥ Tokenï¼Œä¾‹å¦‚ï¼š
     </span>
    </p>
    <pre><code class="language-java">const ws = new WebSocket("wss://example.com/ws?token=your_token_here");
</code></pre>
    <p>
     <span style="color:#0d0016">
      æœåŠ¡å™¨åœ¨ Netty ä¸­è§£æ WebSocket æ¡æ‰‹è¯·æ±‚çš„ URLï¼Œæå– Token è¿›è¡Œèº«ä»½è®¤è¯ï¼Œè®¤è¯æˆåŠŸåç»‘å®š Token åˆ°ç”¨æˆ·çš„ WebSocket ä¼šè¯ä¸­ã€‚
     </span>
    </p>
    <p>
     <span style="color:#0d0016">
      <strong>
       ä¼˜ç‚¹ï¼š
      </strong>
      <br/>
      âœ…
      <strong>
       å‡å°‘ä¸€æ¬¡å¾€è¿”
      </strong>
      ï¼Œä»
      <strong>
       RTT3 é™ä½ä¸º RTT2
      </strong>
      ï¼ˆæ¡æ‰‹ + æœåŠ¡å™¨è¿”å›è®¤è¯ç»“æœï¼‰ã€‚
      <br/>
      âœ…
      <strong>
       æ— éœ€é¢å¤– WebSocket æ¶ˆæ¯
      </strong>
      è¿›è¡Œè®¤è¯ï¼Œè®¤è¯é€»è¾‘æ¸…æ™°ã€‚
      <br/>
      âœ…
      <strong>
       æ˜“äºå®ç°
      </strong>
      ï¼Œåªéœ€åœ¨ WebSocket æ¡æ‰‹é˜¶æ®µè§£æ URL å‚æ•°å³å¯ã€‚
     </span>
    </p>
    <p>
     <span style="color:#0d0016">
      <strong>
       æ³¨æ„äº‹é¡¹ï¼š
      </strong>
      <br/>
      âš 
      <strong>
       å®‰å…¨æ€§é—®é¢˜
      </strong>
      ï¼š
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       <strong>
        é¿å… Token é•¿æœŸå­˜ç•™åœ¨ URL è®°å½•
       </strong>
       ï¼ˆå¦‚æµè§ˆå™¨å†å²ã€æœåŠ¡å™¨æ—¥å¿—ç­‰ï¼‰ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        å¯ä»¥åœ¨æœåŠ¡å™¨è§£æ Token åç«‹å³ä» URL ä¸­åˆ é™¤
       </strong>
       ï¼Œé¿å… Token æ³„éœ²ã€‚
      </span>
     </li>
    </ul>
    <h3>
     <span style="color:#0d0016">
      <strong>
       2.4 æ–¹æ¡ˆäºŒï¼šåˆ©ç”¨ HTTP å¤´ä¼ é€’ Tokenï¼ˆæ›´å®‰å…¨ä½†å…¼å®¹æ€§ç¨å·®ï¼‰
      </strong>
     </span>
    </h3>
    <p>
     <span style="color:#0d0016">
      <strong>
       å®ç°æ€è·¯ï¼š
      </strong>
      <br/>
      WebSocket çš„åˆå§‹æ¡æ‰‹æ˜¯åŸºäº HTTP è¿›è¡Œçš„ï¼Œå› æ­¤å¯ä»¥åˆ©ç”¨
      <strong>
       HTTP å¤´éƒ¨ï¼ˆAuthorizationï¼‰
      </strong>
      ä¼ é€’ Tokenï¼Œä¾‹å¦‚ï¼š
     </span>
    </p>
    <pre><code class="language-java">const ws = new WebSocket("wss://example.com/ws", [], {
  headers: { Authorization: "Bearer your_token_here" }
});
</code></pre>
    <p>
     <span style="color:#0d0016">
      ç„¶åï¼Œåœ¨ Netty æœåŠ¡å™¨ä¸­è§£æ
      <code>
       Authorization
      </code>
      å¤´ï¼Œæå– Token è¿›è¡Œèº«ä»½è®¤è¯ã€‚
     </span>
    </p>
    <p>
     <span style="color:#0d0016">
      <strong>
       ä¼˜ç‚¹ï¼š
      </strong>
      <br/>
      âœ…
      <strong>
       å®‰å…¨æ€§æ›´é«˜
      </strong>
      ï¼ŒToken ä¸ä¼šå‡ºç°åœ¨ URL ä¸­ï¼Œé¿å…æ³„éœ²é£é™©ã€‚
      <br/>
      âœ…
      <strong>
       å‡å°‘ WebSocket æ¶ˆæ¯è®¤è¯ï¼Œç›´æ¥åœ¨æ¡æ‰‹æ—¶å®Œæˆèº«ä»½æ ¡éªŒ
      </strong>
      ã€‚
     </span>
    </p>
    <p>
     <span style="color:#0d0016">
      <strong>
       ç¼ºç‚¹ï¼š
      </strong>
      <br/>
      âš 
      <strong>
       å‰ç«¯å—é™
      </strong>
      ï¼šæµè§ˆå™¨åŸç”Ÿ
      <code>
       WebSocket
      </code>
      API
      <strong>
       ä¸æ”¯æŒè‡ªå®šä¹‰ HTTP å¤´
      </strong>
      ï¼Œå¿…é¡»é€šè¿‡
      <strong>
       è‡ªå®šä¹‰ WebSocket å®¢æˆ·ç«¯
      </strong>
      ï¼ˆå¦‚ Node.js æˆ– JavaScript WebSocket åº“ï¼‰å®ç°ã€‚
      <br/>
      âš 
      <strong>
       å…¼å®¹æ€§é—®é¢˜
      </strong>
      ï¼šéƒ¨åˆ† WebSocket æœåŠ¡å™¨å’Œä»£ç†å¯èƒ½ä¸ä¼šè½¬å‘è‡ªå®šä¹‰ HTTP å¤´ï¼Œéœ€è¦é¢å¤–é…ç½®ã€‚
     </span>
    </p>
    <h3>
     <span style="color:#0d0016">
      <strong>
       2.5 æ–¹æ¡ˆä¸‰ï¼ˆå¤±è´¥æ–¹æ¡ˆï¼‰ï¼šåˆ©ç”¨ WebSocket
       <code>
        protocols
       </code>
       ä¼ é€’ Token
      </strong>
     </span>
    </h3>
    <p>
     <span style="color:#0d0016">
      WebSocket è¿æ¥æ—¶æ”¯æŒ
      <code>
       protocols
      </code>
      å‚æ•°ï¼ŒåŸæœ¬å¸Œæœ›ä½¿ç”¨å®ƒæ¥ä¼ é€’ Tokenï¼Œä¾‹å¦‚ï¼š
     </span>
    </p>
    <pre><code class="language-java">const ws = new WebSocket("wss://example.com/ws", ["token_your_token_here"]);
</code></pre>
    <p>
     <span style="color:#0d0016">
      ç„¶è€Œï¼ŒWebSocket
      <code>
       protocols
      </code>
      çš„ä½œç”¨æ˜¯
      <strong>
       æŒ‡å®šå­åè®®
      </strong>
      ï¼ˆå¦‚
      <code>
       graphql-ws
      </code>
      ï¼‰ï¼Œå¹¶ä¸æ˜¯è®¾è®¡æ¥ä¼ é€’ Tokenï¼Œå› æ­¤
      <strong>
       æœåŠ¡å™¨ç«¯ Netty è§£æ
       <code>
        protocols
       </code>
       æ—¶æ— æ³•æ­£ç¡®è·å– Token
      </strong>
      ã€‚
     </span>
    </p>
    <p>
     <span style="color:#0d0016">
      <strong>
       æœ€ç»ˆç»“è®ºï¼š
      </strong>
      è¯¥æ–¹æ¡ˆä¸å¯è¡Œï¼Œä¸æ¨èä½¿ç”¨ã€‚
     </span>
    </p>
    <h3>
     <span style="color:#0d0016">
      <strong>
       2.6 æ–¹æ¡ˆå¯¹æ¯”ä¸æœ€ç»ˆé€‰æ‹©
      </strong>
     </span>
    </h3>
    <table>
     <thead>
      <tr>
       <th>
        <span style="color:#0d0016">
         æ–¹æ¡ˆ
        </span>
       </th>
       <th>
        <span style="color:#0d0016">
         ä¼ é€’æ–¹å¼
        </span>
       </th>
       <th>
        <span style="color:#0d0016">
         å…¼å®¹æ€§
        </span>
       </th>
       <th>
        <span style="color:#0d0016">
         å®‰å…¨æ€§
        </span>
       </th>
       <th>
        <span style="color:#0d0016">
         ä¼˜åŠ¿
        </span>
       </th>
       <th>
        <span style="color:#0d0016">
         é€‚ç”¨åœºæ™¯
        </span>
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <span style="color:#0d0016">
         <strong>
          URL æ‹¼æ¥ Token
         </strong>
        </span>
       </td>
       <td>
        <span style="color:#0d0016">
         URL å‚æ•°
        </span>
       </td>
       <td>
        <span style="color:#0d0016">
         âœ… æµè§ˆå™¨æ”¯æŒ
        </span>
       </td>
       <td>
        <span style="color:#0d0016">
         âš  éœ€è¦åˆ é™¤ Token
        </span>
       </td>
       <td>
        <span style="color:#0d0016">
         ğŸš€ ç®€å•æ˜“ç”¨ï¼Œå‡å°‘ä¸€æ¬¡é€šä¿¡
        </span>
       </td>
       <td>
        <span style="color:#0d0016">
         <strong>
          æ¨èï¼Œé€‚åˆå¤§å¤šæ•°æƒ…å†µ
         </strong>
        </span>
       </td>
      </tr>
      <tr>
       <td>
        <span style="color:#0d0016">
         <strong>
          HTTP å¤´éƒ¨ Token
         </strong>
        </span>
       </td>
       <td>
        <span style="color:#0d0016">
         <code>
          Authorization
         </code>
         å¤´
        </span>
       </td>
       <td>
        <span style="color:#0d0016">
         âŒ éœ€è‡ªå®šä¹‰å®¢æˆ·ç«¯
        </span>
       </td>
       <td>
        <span style="color:#0d0016">
         âœ… å®‰å…¨æ€§é«˜
        </span>
       </td>
       <td>
        <span style="color:#0d0016">
         ğŸš€ æœåŠ¡å™¨ç«¯è®¤è¯ç›´æ¥å®Œæˆ
        </span>
       </td>
       <td>
        <span style="color:#0d0016">
         <strong>
          é€‚åˆæœåŠ¡å™¨æˆ–éæµè§ˆå™¨ç¯å¢ƒ
         </strong>
        </span>
       </td>
      </tr>
      <tr>
       <td>
        <span style="color:#0d0016">
         <strong>
          WebSocket
          <code>
           protocols
          </code>
         </strong>
        </span>
       </td>
       <td>
        <span style="color:#0d0016">
         <code>
          protocols
         </code>
        </span>
       </td>
       <td>
        <span style="color:#0d0016">
         âŒ ä¸æ”¯æŒ
        </span>
       </td>
       <td>
        <span style="color:#0d0016">
         âŒ ä¸å®‰å…¨
        </span>
       </td>
       <td>
        <span style="color:#0d0016">
         âŒ æ— æ³•æ­£ç¡®ä¼ é€’ Token
        </span>
       </td>
       <td>
        <span style="color:#0d0016">
         <strong>
          å¤±è´¥æ–¹æ¡ˆï¼Œä¸æ¨è
         </strong>
        </span>
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <span style="color:#0d0016">
      ç»¼åˆæ¥çœ‹ï¼Œ
      <strong>
       "URL æ‹¼æ¥ Token" æ˜¯æœ€ç®€å•ã€æœ€æ˜“ç”¨ã€ä¸”å…¼å®¹æ€§æœ€å¥½çš„æ–¹æ¡ˆ
      </strong>
      ï¼Œå› æ­¤æ¨èä½œä¸ºä¸»è¦ä¼˜åŒ–æ–¹å¼ã€‚
     </span>
    </p>
    <h3>
     <span style="color:#0d0016">
      <strong>
       2.7 ç»“è®ºä¸ä¸‹ä¸€æ­¥
      </strong>
     </span>
    </h3>
    <p>
     <span style="color:#0d0016">
      é€šè¿‡åœ¨
      <strong>
       WebSocket è¿æ¥æ¡æ‰‹é˜¶æ®µ
      </strong>
      ç›´æ¥ä¼ é€’ Tokenï¼Œæˆ‘ä»¬å¯ä»¥æœ‰æ•ˆå‡å°‘ä¸å¿…è¦çš„è®¤è¯å›åˆï¼Œä¼˜åŒ–ç”¨æˆ·ä½“éªŒã€‚åœ¨æ¥ä¸‹æ¥çš„ç« èŠ‚ï¼Œæˆ‘ä»¬å°†æ·±å…¥è®²è§£å¦‚ä½•åœ¨
      <strong>
       Netty æœåŠ¡å™¨ç«¯
      </strong>
      è§£æ Token å¹¶å®Œæˆèº«ä»½è®¤è¯ï¼Œç¡®ä¿ WebSocket è®¤è¯çš„å®‰å…¨æ€§å’Œç¨³å®šæ€§ã€‚
     </span>
    </p>
    <h2>
     <span style="color:#0d0016">
      <strong>
       3. WebSocket æ¡æ‰‹é˜¶æ®µä¼ é€’ Token çš„æŠ€æœ¯å®ç°
      </strong>
     </span>
    </h2>
    <p>
     <span style="color:#0d0016">
      åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬ç¡®å®šäº†
      <strong>
       åœ¨ WebSocket è¿æ¥æ¡æ‰‹é˜¶æ®µä¼ é€’ Token
      </strong>
      æ˜¯ä¼˜åŒ– WebSocket è®¤è¯çš„æœ€ä½³æ–¹æ¡ˆã€‚æœ¬èŠ‚å°†è¯¦ç»†è®²è§£å¦‚ä½•
      <strong>
       åœ¨å‰ç«¯ä¼ é€’ Token
      </strong>
      ï¼Œä»¥åŠ
      <strong>
       å¦‚ä½•åœ¨ Netty æœåŠ¡å™¨ç«¯è§£æå’ŒéªŒè¯ Token
      </strong>
      ï¼Œç¡®ä¿ WebSocket è¿æ¥çš„å®‰å…¨æ€§å’Œé«˜æ•ˆæ€§ã€‚
     </span>
    </p>
    <h3>
     <span style="color:#0d0016">
      <strong>
       3.1 å‰ç«¯å¦‚ä½•åœ¨ WebSocket æ¡æ‰‹æ—¶ä¼ é€’ Token
      </strong>
     </span>
    </h3>
    <h4>
     <span style="color:#0d0016">
      <strong>
       æ–¹æ¡ˆä¸€ï¼šé€šè¿‡ URL ä¼ é€’ Tokenï¼ˆæ¨èï¼‰
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      åœ¨ WebSocket è¿æ¥ URL ä¸­ç›´æ¥æ‹¼æ¥ Tokenï¼Œä¾‹å¦‚ï¼š
     </span>
    </p>
    <pre><code class="language-java">const token = "your_token_here"; // è¿™ä¸ª Token ä¸€èˆ¬ä» localStorage æˆ– cookies è·å–
const ws = new WebSocket(`wss://example.com/ws?token=${encodeURIComponent(token)}`);
</code></pre>
    <p>
     <span style="color:#0d0016">
      ğŸ“Œ
      <strong>
       æ³¨æ„äº‹é¡¹ï¼š
      </strong>
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       <code>
        encodeURIComponent(token)
       </code>
       ä½œç”¨æ˜¯å¯¹ Token è¿›è¡Œ URL ç¼–ç ï¼Œé¿å…ç‰¹æ®Šå­—ç¬¦å½±å“ URL è§£æã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        ä¸è¦è®© Token é•¿æ—¶é—´å­˜ç•™åœ¨ URL è®°å½•ä¸­
       </strong>
       ï¼ŒæœåŠ¡å™¨ç«¯æ‹¿åˆ° Token åè¦å°½å¿«æ¸…ç†ï¼Œé˜²æ­¢ Token æ³„éœ²ã€‚
      </span>
     </li>
    </ul>
    <h4>
     <span style="color:#0d0016">
      <strong>
       æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ HTTP å¤´ä¼ é€’ Tokenï¼ˆä»…é€‚ç”¨äºéæµè§ˆå™¨ç¯å¢ƒï¼‰
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      å¦‚æœ WebSocket è¿æ¥æ˜¯ç”±
      <strong>
       Node.js æˆ–å…¶ä»–åç«¯æœåŠ¡
      </strong>
      å‘èµ·çš„ï¼Œå¯ä»¥ä½¿ç”¨ HTTP å¤´ä¼ é€’ Tokenï¼Œä¾‹å¦‚ï¼š
     </span>
    </p>
    <pre><code class="language-java">const WebSocket = require('ws');

const ws = new WebSocket("wss://example.com/ws", {
  headers: {
    Authorization: `Bearer your_token_here`
  }
});
</code></pre>
    <p>
     <span style="color:#0d0016">
      ğŸ“Œ
      <strong>
       æ³¨æ„äº‹é¡¹ï¼š
      </strong>
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       è¿™ç§æ–¹å¼
       <strong>
        æµè§ˆå™¨åŸç”Ÿ WebSocket API ä¸æ”¯æŒ
       </strong>
       ï¼Œé€‚ç”¨äºåç«¯å¯¹åç«¯ï¼ˆServer-to-Serverï¼‰WebSocket è¿æ¥ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       æœåŠ¡å™¨ç«¯éœ€è¦åœ¨ HTTP å¤´ä¸­æå–
       <code>
        Authorization
       </code>
       å¹¶è§£æ Tokenã€‚
      </span>
     </li>
    </ul>
    <h3>
     <span style="color:#0d0016">
      <strong>
       3.2 Netty æœåŠ¡å™¨ç«¯å¦‚ä½•è§£æ Token
      </strong>
     </span>
    </h3>
    <p>
     <span style="color:#0d0016">
      æ— è®º Token æ˜¯é€šè¿‡
      <strong>
       URL ä¼ é€’
      </strong>
      è¿˜æ˜¯
      <strong>
       HTTP å¤´ä¼ é€’
      </strong>
      ï¼ŒNetty æœåŠ¡å™¨ç«¯çš„é€»è¾‘ä¸»è¦åˆ†ä¸ºä¸‰æ­¥ï¼š
     </span>
    </p>
    <ol>
     <li>
      <span style="color:#0d0016">
       <strong>
        åœ¨ WebSocket æ¡æ‰‹é˜¶æ®µæ‹¦æˆª HTTP è¯·æ±‚
       </strong>
       ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        æå– Token å¹¶è¿›è¡Œèº«ä»½è®¤è¯
       </strong>
       ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        è®¤è¯æˆåŠŸåï¼Œå°† Token ç»‘å®šåˆ° WebSocket è¿æ¥ï¼ˆChannelï¼‰
       </strong>
       ï¼Œç”¨äºåç»­é€šä¿¡ã€‚
      </span>
     </li>
    </ol>
    <h4>
     <span style="color:#0d0016">
      <strong>
       3.2.1 Netty æœåŠ¡å™¨ç«¯ä»£ç å®ç°
      </strong>
     </span>
    </h4>
    <h5>
     <span style="color:#0d0016">
      <strong>
       ï¼ˆ1ï¼‰è‡ªå®šä¹‰ WebSocket æ¡æ‰‹å¤„ç†å™¨
      </strong>
     </span>
    </h5>
    <p>
     <span style="color:#0d0016">
      æˆ‘ä»¬éœ€è¦åœ¨ WebSocket æ¡æ‰‹é˜¶æ®µè§£æ Tokenï¼Œå¹¶å­˜å‚¨åˆ° Channel çš„
      <code>
       Attributes
      </code>
      ä¸­ï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ã€‚
     </span>
    </p>
    <pre><code class="language-java">import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.SimpleChannelInboundHandler;
import io.netty.handler.codec.http.FullHttpRequest;
import io.netty.handler.codec.http.QueryStringDecoder;
import java.util.List;
import java.util.Map;

public class WebSocketHandshakeHandler extends SimpleChannelInboundHandler&lt;FullHttpRequest&gt; {

    @Override
    protected void channelRead0(ChannelHandlerContext ctx, FullHttpRequest req) {
        // è§£æ Token
        String token = extractToken(req);

        if (token == null || !isValidToken(token)) {
            // è®¤è¯å¤±è´¥ï¼Œå…³é—­è¿æ¥
            ctx.close();
            return;
        }

        // è®¤è¯æˆåŠŸï¼Œå°† Token ç»‘å®šåˆ° Channel
        ctx.channel().attr(AttributeKey.valueOf("token")).set(token);

        // ç»§ç»­å¤„ç† WebSocket æ¡æ‰‹
        ctx.fireChannelRead(req.retain());
    }

    // è§£æ URL ä¸­çš„ Token
    private String extractToken(FullHttpRequest req) {
        QueryStringDecoder decoder = new QueryStringDecoder(req.uri());
        Map&lt;String, List&lt;String&gt;&gt; params = decoder.parameters();
        if (params.containsKey("token")) {
            return params.get("token").get(0);
        }
        return null;
    }

    // è¿™é‡Œå¯ä»¥è°ƒç”¨è‡ªå·±çš„ Token è®¤è¯é€»è¾‘ï¼Œä¾‹å¦‚ JWT è§£æ
    private boolean isValidToken(String token) {
        return "your_token_here".equals(token); // è¿™é‡Œæ›¿æ¢æˆå®é™…çš„ Token éªŒè¯é€»è¾‘
    }
}
</code></pre>
    <p>
     <span style="color:#0d0016">
      ğŸ“Œ
      <strong>
       ä»£ç è§£è¯»ï¼š
      </strong>
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       <code>
        channelRead0()
       </code>
       æ–¹æ³•ä¼šåœ¨ WebSocket æ¡æ‰‹é˜¶æ®µæ‹¦æˆª HTTP è¯·æ±‚ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <code>
        extractToken(req)
       </code>
       æ–¹æ³•ç”¨äºä» URL è§£æ Tokenã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <code>
        isValidToken(token)
       </code>
       æ–¹æ³•ç”¨äºéªŒè¯ Token çš„æœ‰æ•ˆæ€§ï¼ˆè¿™é‡Œå¯ä»¥æ¢æˆ JWT è§£æï¼‰ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <code>
        ctx.channel().attr(AttributeKey.valueOf("token")).set(token);
       </code>
       ç”¨äºå°† Token ç»‘å®šåˆ° Channelï¼Œæ–¹ä¾¿åç»­ä½¿ç”¨ã€‚
      </span>
     </li>
    </ul>
    <h5>
     <span style="color:#0d0016">
      <strong>
       ï¼ˆ2ï¼‰WebSocket æ¡æ‰‹å®Œæˆåï¼Œç»§ç»­å¤„ç† WebSocket æ¶ˆæ¯
      </strong>
     </span>
    </h5>
    <p>
     <span style="color:#0d0016">
      WebSocket æ¡æ‰‹å®Œæˆåï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»º WebSocket å¤„ç†å™¨ï¼Œç¡®ä¿åç»­é€šä¿¡æ—¶èƒ½å¤Ÿè·å–ç”¨æˆ·èº«ä»½ã€‚
     </span>
    </p>
    <pre><code class="language-java">import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.SimpleChannelInboundHandler;
import io.netty.handler.codec.http.websocketx.TextWebSocketFrame;
import io.netty.util.AttributeKey;

public class WebSocketFrameHandler extends SimpleChannelInboundHandler&lt;TextWebSocketFrame&gt; {

    @Override
    protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) {
        // è¯»å–ç”¨æˆ· Tokenï¼ˆä¹‹å‰å­˜å‚¨åœ¨ Channel çš„ Attribute ä¸­ï¼‰
        String token = (String) ctx.channel().attr(AttributeKey.valueOf("token")).get();

        if (token == null) {
            ctx.close();
            return;
        }

        // å¤„ç† WebSocket æ¶ˆæ¯
        System.out.println("Received message: " + msg.text());
        ctx.writeAndFlush(new TextWebSocketFrame("Server received your message: " + msg.text()));
    }
}
</code></pre>
    <p>
     <span style="color:#0d0016">
      ğŸ“Œ
      <strong>
       ä»£ç è§£è¯»ï¼š
      </strong>
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       <code>
        ctx.channel().attr(AttributeKey.valueOf("token")).get();
       </code>
       è¯»å– WebSocket æ¡æ‰‹é˜¶æ®µå­˜å‚¨çš„ Tokenã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       å¦‚æœ Token ä¸ºç©ºï¼Œè¯´æ˜è®¤è¯å¤±è´¥ï¼Œå…³é—­è¿æ¥ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       è®¤è¯æˆåŠŸåï¼Œç»§ç»­å¤„ç† WebSocket æ¶ˆæ¯ã€‚
      </span>
     </li>
    </ul>
    <h3>
     <span style="color:#0d0016">
      <strong>
       3.3 Netty æœåŠ¡å™¨ç«¯å®Œæ•´ Pipeline ç»„è£…
      </strong>
     </span>
    </h3>
    <p>
     <span style="color:#0d0016">
      åœ¨ Netty æœåŠ¡å™¨å¯åŠ¨æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ­£ç¡®ç»„è£… WebSocket æ¡æ‰‹å¤„ç†å™¨å’Œæ¶ˆæ¯å¤„ç†å™¨ã€‚
     </span>
    </p>
    <pre><code class="language-java">import io.netty.channel.ChannelInitializer;
import io.netty.channel.socket.SocketChannel;
import io.netty.handler.codec.http.HttpServerCodec;
import io.netty.handler.codec.http.HttpObjectAggregator;
import io.netty.handler.codec.http.websocketx.WebSocketServerProtocolHandler;

public class WebSocketServerInitializer extends ChannelInitializer&lt;SocketChannel&gt; {

    @Override
    protected void initChannel(SocketChannel ch) {
        ch.pipeline().addLast(new HttpServerCodec()); // HTTP è§£æ
        ch.pipeline().addLast(new HttpObjectAggregator(65536)); // å¤„ç†å®Œæ•´ HTTP è¯·æ±‚
        ch.pipeline().addLast(new WebSocketHandshakeHandler()); // è§£æ Token å¹¶è®¤è¯
        ch.pipeline().addLast(new WebSocketServerProtocolHandler("/ws")); // WebSocket æ¡æ‰‹
        ch.pipeline().addLast(new WebSocketFrameHandler()); // å¤„ç† WebSocket æ¶ˆæ¯
    }
}
</code></pre>
    <p>
     <span style="color:#0d0016">
      ğŸ“Œ
      <strong>
       ä»£ç è§£è¯»ï¼š
      </strong>
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       <code>
        HttpServerCodec
       </code>
       å¤„ç† HTTP è¯·æ±‚å’Œå“åº”ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <code>
        HttpObjectAggregator
       </code>
       å¤„ç† HTTP å®Œæ•´è¯·æ±‚ï¼ˆåŒ…æ‹¬ WebSocket æ¡æ‰‹ï¼‰ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <code>
        WebSocketHandshakeHandler
       </code>
       è§£æ Token å¹¶è¿›è¡Œè®¤è¯ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <code>
        WebSocketServerProtocolHandler("/ws")
       </code>
       å¤„ç† WebSocket åè®®å‡çº§ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <code>
        WebSocketFrameHandler
       </code>
       å¤„ç† WebSocket æ¶ˆæ¯ä¼ è¾“ã€‚
      </span>
     </li>
    </ul>
    <h2>
     <span style="color:#0d0016">
      <strong>
       4. Netty æœåŠ¡å™¨ç«¯ WebSocket è®¤è¯ä¼˜åŒ–
      </strong>
     </span>
    </h2>
    <p>
     <span style="color:#0d0016">
      åœ¨ä¸Šä¸€èŠ‚ä¸­ï¼Œæˆ‘ä»¬å®ç°äº†
      <strong>
       WebSocket æ¡æ‰‹é˜¶æ®µçš„ Token ä¼ é€’å’ŒéªŒè¯
      </strong>
      ï¼Œç¡®ä¿ WebSocket è¿æ¥åœ¨å»ºç«‹æ—¶å®Œæˆèº«ä»½è®¤è¯ã€‚ç„¶è€Œï¼Œç°æœ‰æ–¹æ¡ˆä»ç„¶å­˜åœ¨ä¼˜åŒ–ç©ºé—´ï¼ŒåŒ…æ‹¬ï¼š
     </span>
    </p>
    <ol>
     <li>
      <span style="color:#0d0016">
       <strong>
        Token è®¤è¯é€»è¾‘çš„ä¼˜åŒ–
       </strong>
       ï¼šå‡å°‘é‡å¤è§£æ Tokenï¼Œæé«˜è®¤è¯æ•ˆç‡ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        Token ç»­æœŸæœºåˆ¶
       </strong>
       ï¼šå½“ Token å³å°†è¿‡æœŸæ—¶ï¼Œæ”¯æŒåœ¨çº¿ç»­æœŸï¼Œé¿å…ç”¨æˆ·è¢«å¼ºåˆ¶ä¸‹çº¿ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        å¤šç«¯ç™»å½•ç®¡ç†
       </strong>
       ï¼šç¡®ä¿åŒä¸€è´¦å·å¯ä»¥å®‰å…¨åœ°åœ¨å¤šä¸ªè®¾å¤‡ç™»å½•ï¼Œæˆ–é™åˆ¶å•è®¾å¤‡ç™»å½•ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        æƒé™æ§åˆ¶ä¼˜åŒ–
       </strong>
       ï¼šä¸åŒç”¨æˆ·ç±»å‹å¯è®¿é—®ä¸åŒçš„ WebSocket é€šé“ï¼Œæé«˜å®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
      </span>
     </li>
    </ol>
    <p>
     <span style="color:#0d0016">
      æœ¬èŠ‚å°†é’ˆå¯¹è¿™äº›ä¼˜åŒ–ç‚¹ï¼Œè¯¦ç»†è®²è§£ Netty æœåŠ¡å™¨ç«¯çš„ä¼˜åŒ–æ–¹æ¡ˆå’Œå®ç°æ–¹æ³•ã€‚
     </span>
    </p>
    <h3>
     <span style="color:#0d0016">
      <strong>
       4.1 Token è®¤è¯é€»è¾‘ä¼˜åŒ–
      </strong>
     </span>
    </h3>
    <h4>
     <span style="color:#0d0016">
      <strong>
       ğŸ”¹ é—®é¢˜ï¼šæ¯æ¬¡æ¡æ‰‹éƒ½è¦è§£æ Tokenï¼Œå¯¼è‡´æ€§èƒ½æŸè€—
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      åœ¨å½“å‰å®ç°ä¸­ï¼Œæ¯æ¬¡ WebSocket æ¡æ‰‹æ—¶ï¼ŒæœåŠ¡å™¨éƒ½éœ€è¦è§£æå¹¶éªŒè¯ Tokenã€‚å¦‚æœ Token è§£æé€»è¾‘å¤æ‚ï¼ˆå¦‚ JWT è§£æã€æ•°æ®åº“æŸ¥è¯¢ç­‰ï¼‰ï¼Œå¯èƒ½ä¼šå½±å“æœåŠ¡å™¨æ€§èƒ½ã€‚
     </span>
    </p>
    <h4>
     <span style="color:#0d0016">
      <strong>
       âœ… è§£å†³æ–¹æ¡ˆï¼šå¼•å…¥ç¼“å­˜ï¼ŒåŠ é€Ÿ Token è§£æ
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      å¯ä»¥ä½¿ç”¨
      <strong>
       æœ¬åœ°ç¼“å­˜ï¼ˆå¦‚ Caffeineï¼‰æˆ–åˆ†å¸ƒå¼ç¼“å­˜ï¼ˆå¦‚ Redisï¼‰
      </strong>
      ï¼Œå­˜å‚¨å·²éªŒè¯çš„ Tokenï¼Œé¿å…é‡å¤è§£æã€‚ä¾‹å¦‚ï¼š
     </span>
    </p>
    <pre><code class="language-java">import com.github.benmanes.caffeine.cache.Cache;
import com.github.benmanes.caffeine.cache.Caffeine;

import java.util.concurrent.TimeUnit;

public class TokenCache {
    // ä½¿ç”¨ Caffeine ä½œä¸ºæœ¬åœ°ç¼“å­˜ï¼ŒToken è¿‡æœŸæ—¶é—´è®¾ä¸º 10 åˆ†é’Ÿ
    private static final Cache&lt;String, Boolean&gt; tokenCache = Caffeine.newBuilder()
            .expireAfterWrite(10, TimeUnit.MINUTES)
            .maximumSize(10_000)
            .build();

    // æ ¡éªŒ Token
    public static boolean isValidToken(String token) {
        // å…ˆæŸ¥ç¼“å­˜
        Boolean isValid = tokenCache.getIfPresent(token);
        if (isValid != null) {
            return isValid;
        }

        // è‹¥ç¼“å­˜ä¸­ä¸å­˜åœ¨ï¼Œåˆ™è¿›è¡Œ Token è§£æï¼ˆå¯ä»¥æ˜¯ JWT è§£æã€æ•°æ®åº“æŸ¥è¯¢ç­‰ï¼‰
        boolean valid = verifyTokenFromDatabaseOrJWT(token);

        // ç¼“å­˜ç»“æœï¼Œé¿å…é‡å¤è§£æ
        tokenCache.put(token, valid);
        return valid;
    }

    // è¿™é‡Œæ¨¡æ‹Ÿä¸€ä¸ª Token éªŒè¯é€»è¾‘
    private static boolean verifyTokenFromDatabaseOrJWT(String token) {
        return "valid_token".equals(token); // å®é™…ä¸Šåº”è°ƒç”¨æ•°æ®åº“æˆ– JWT è§£æåº“
    }
}
</code></pre>
    <p>
     <span style="color:#0d0016">
      ğŸ“Œ
      <strong>
       ä¼˜åŒ–æ•ˆæœ
      </strong>
      ï¼š
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       ç¬¬ä¸€æ¬¡éªŒè¯ Token ä»ç„¶æ‰§è¡Œå®Œæ•´çš„è§£æé€»è¾‘ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       ä¹‹åçš„è¯·æ±‚å°†ç›´æ¥ä»ç¼“å­˜è¯»å–ï¼Œå‡å°‘è®¡ç®—é‡ï¼Œæé«˜è®¤è¯æ•ˆç‡ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       10 åˆ†é’Ÿå Token è¿‡æœŸï¼Œé˜²æ­¢é•¿æœŸç¼“å­˜å¯¼è‡´å®‰å…¨éšæ‚£ã€‚
      </span>
     </li>
    </ul>
    <h3>
     <span style="color:#0d0016">
      <strong>
       4.2 Token ç»­æœŸæœºåˆ¶
      </strong>
     </span>
    </h3>
    <h4>
     <span style="color:#0d0016">
      <strong>
       ğŸ”¹ é—®é¢˜ï¼šToken è¿‡æœŸåï¼ŒWebSocket è¿æ¥è¢«å¼ºåˆ¶æ–­å¼€ï¼Œç”¨æˆ·ä½“éªŒå·®
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      å¦‚æœ Token æœ‰æ•ˆæœŸè¾ƒçŸ­ï¼Œç”¨æˆ·éœ€è¦é¢‘ç¹é‡æ–°è¿æ¥ WebSocketï¼Œå½±å“ä½“éªŒã€‚
     </span>
    </p>
    <h4>
     <span style="color:#0d0016">
      <strong>
       âœ… è§£å†³æ–¹æ¡ˆï¼šæ”¯æŒ Token ç»­æœŸ
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      å¯ä»¥åœ¨
      <strong>
       WebSocket è¿æ¥ä¸­å®šæœŸæ£€æŸ¥ Token æ˜¯å¦å³å°†è¿‡æœŸ
      </strong>
      ï¼Œå¹¶åœ¨å³å°†è¿‡æœŸæ—¶è®©å®¢æˆ·ç«¯è‡ªåŠ¨æ›´æ–° Tokenï¼Œé¿å…æ–­å¼€è¿æ¥ã€‚ä¾‹å¦‚ï¼š
     </span>
    </p>
    <h5>
     <span style="color:#0d0016">
      <strong>
       1ï¸âƒ£ æœåŠ¡å™¨ç«¯å®ç° Token ç»­æœŸæ£€æµ‹
      </strong>
     </span>
    </h5>
    <pre><code class="language-java">import io.netty.channel.Channel;
import io.netty.util.AttributeKey;

import java.util.concurrent.ConcurrentHashMap;

public class TokenManager {
    private static final ConcurrentHashMap&lt;Channel, String&gt; channelTokenMap = new ConcurrentHashMap&lt;&gt;();

    // ç»‘å®š Token åˆ° Channel
    public static void bindToken(Channel channel, String token) {
        channel.attr(AttributeKey.valueOf("token")).set(token);
        channelTokenMap.put(channel, token);
    }

    // æ£€æŸ¥ Token æ˜¯å¦å³å°†è¿‡æœŸ
    public static boolean isTokenExpiringSoon(String token) {
        return token.equals("expiring_token"); // æ¨¡æ‹Ÿ Token è¿‡æœŸæ£€æŸ¥
    }

    // æ›´æ–° Token
    public static void refreshToken(Channel channel, String newToken) {
        channel.attr(AttributeKey.valueOf("token")).set(newToken);
        channelTokenMap.put(channel, newToken);
    }
}
</code></pre>
    <h5>
     <span style="color:#0d0016">
      <strong>
       2ï¸âƒ£ å®¢æˆ·ç«¯å®šæœŸæ£€æŸ¥ Token è¿‡æœŸï¼Œå¹¶æ›´æ–° Token
      </strong>
     </span>
    </h5>
    <pre><code class="language-java">function checkTokenExpiry() {
    setInterval(() =&gt; {
        fetch('/api/check-token')  // è¯¢é—®æœåŠ¡å™¨ Token æ˜¯å¦å³å°†è¿‡æœŸ
            .then(response =&gt; response.json())
            .then(data =&gt; {
                if (data.expiring) {
                    refreshToken(); // å¦‚æœå¿«è¿‡æœŸäº†ï¼Œå°±åˆ·æ–° Token
                }
            });
    }, 30000); // æ¯ 30 ç§’æ£€æŸ¥ä¸€æ¬¡
}

function refreshToken() {
    fetch('/api/refresh-token')
        .then(response =&gt; response.json())
        .then(data =&gt; {
            ws.close(); // å…³é—­å½“å‰ WebSocket è¿æ¥
            ws = new WebSocket(`wss://example.com/ws?token=${encodeURIComponent(data.newToken)}`);
        });
}
</code></pre>
    <p>
     <span style="color:#0d0016">
      ğŸ“Œ
      <strong>
       ä¼˜åŒ–æ•ˆæœ
      </strong>
      ï¼š
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       <strong>
        é¿å… Token è¿‡æœŸå¯¼è‡´ WebSocket æ–­å¼€
       </strong>
       ï¼Œæå‡ç”¨æˆ·ä½“éªŒã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        ä»…åœ¨ Token éœ€è¦ç»­æœŸæ—¶è¿›è¡Œåˆ·æ–°
       </strong>
       ï¼Œå‡å°‘ä¸å¿…è¦çš„ Token è§£ææ“ä½œã€‚
      </span>
     </li>
    </ul>
    <h3>
     <span style="color:#0d0016">
      <strong>
       4.3 å¤šç«¯ç™»å½•ç®¡ç†
      </strong>
     </span>
    </h3>
    <h4>
     <span style="color:#0d0016">
      <strong>
       ğŸ”¹ é—®é¢˜ï¼šåŒä¸€è´¦å·å¯èƒ½åœ¨å¤šä¸ªè®¾å¤‡ç™»å½•ï¼Œå¯¼è‡´ Token è¢«æ»¥ç”¨
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      ä¾‹å¦‚ï¼Œç”¨æˆ·åœ¨ PC å’Œæ‰‹æœºåŒæ—¶ä½¿ç”¨ WebSocketï¼Œå¯èƒ½å¯¼è‡´ Token é‡å¤ä½¿ç”¨ï¼Œå¸¦æ¥å®‰å…¨é£é™©ã€‚
     </span>
    </p>
    <h4>
     <span style="color:#0d0016">
      <strong>
       âœ… è§£å†³æ–¹æ¡ˆï¼šé™åˆ¶åŒä¸€è´¦å·çš„ WebSocket è¿æ¥æ•°é‡
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      å¯ä»¥ä½¿ç”¨
      <strong>
       Redis è®°å½•å½“å‰åœ¨çº¿çš„ Token
      </strong>
      ï¼Œå¦‚æœå‘ç°åŒä¸€è´¦å·çš„ Token åœ¨å¤šä¸ªè®¾å¤‡ç™»å½•ï¼Œåˆ™ä¸»åŠ¨è¸¢æ‰æ—§è¿æ¥ã€‚
     </span>
    </p>
    <h5>
     <span style="color:#0d0016">
      <strong>
       Netty æœåŠ¡å™¨ç«¯å®ç°
      </strong>
     </span>
    </h5>
    <pre><code class="language-java">import java.util.concurrent.ConcurrentHashMap;
import io.netty.channel.Channel;

public class WebSocketSessionManager {
    private static final ConcurrentHashMap&lt;String, Channel&gt; userSessions = new ConcurrentHashMap&lt;&gt;();

    public static void bindUser(String userId, Channel channel) {
        if (userSessions.containsKey(userId)) {
            // è¸¢æ‰ä¹‹å‰çš„è¿æ¥
            userSessions.get(userId).close();
        }
        userSessions.put(userId, channel);
    }

    public static void removeUser(String userId) {
        userSessions.remove(userId);
    }
}
</code></pre>
    <p>
     <span style="color:#0d0016">
      ğŸ“Œ
      <strong>
       ä¼˜åŒ–æ•ˆæœ
      </strong>
      ï¼š
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       <strong>
        é˜²æ­¢ Token è¢«ç›—ç”¨
       </strong>
       ï¼Œé™åˆ¶åŒæ—¶åœ¨çº¿çš„ WebSocket è¿æ¥æ•°é‡ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        ç¡®ä¿ WebSocket è¿æ¥å§‹ç»ˆæ˜¯æœ€æ–°çš„
       </strong>
       ï¼Œé¿å…åŒä¸€ç”¨æˆ·åœ¨å¤šä¸ªè®¾å¤‡ä¸Šé€ æˆæ•°æ®ä¸ä¸€è‡´ã€‚
      </span>
     </li>
    </ul>
    <h3>
     <span style="color:#0d0016">
      <strong>
       4.4 æƒé™æ§åˆ¶ä¼˜åŒ–
      </strong>
     </span>
    </h3>
    <h4>
     <span style="color:#0d0016">
      <strong>
       ğŸ”¹ é—®é¢˜ï¼šä¸åŒç”¨æˆ·ç±»å‹éœ€è¦è®¿é—®ä¸åŒçš„ WebSocket é€šé“
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      ä¾‹å¦‚ï¼š
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       æ™®é€šç”¨æˆ·åªèƒ½è®¢é˜…
       <code>
        public_chat
       </code>
       é¢‘é“ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       ç®¡ç†å‘˜å¯ä»¥è®¢é˜…
       <code>
        admin_dashboard
       </code>
       é¢‘é“ã€‚
      </span>
     </li>
    </ul>
    <h4>
     <span style="color:#0d0016">
      <strong>
       âœ… è§£å†³æ–¹æ¡ˆï¼šåŸºäºè§’è‰²çš„ WebSocket é¢‘é“ç®¡ç†
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      åœ¨æœåŠ¡å™¨ç«¯ï¼Œè§£æ Token åï¼Œå°†
      <strong>
       ç”¨æˆ·è§’è‰²ä¿¡æ¯ç»‘å®šåˆ° Channel
      </strong>
      ï¼Œé™åˆ¶ç”¨æˆ·è®¿é—®çš„ WebSocket é¢‘é“ã€‚
     </span>
    </p>
    <pre><code class="language-java">public class WebSocketAuthHandler extends SimpleChannelInboundHandler&lt;TextWebSocketFrame&gt; {
    @Override
    protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) {
        String role = ctx.channel().attr(AttributeKey.valueOf("role")).get().toString();
        if (!"admin".equals(role) &amp;&amp; msg.text().contains("admin_dashboard")) {
            ctx.writeAndFlush(new TextWebSocketFrame("Permission denied"));
            return;
        }
        ctx.fireChannelRead(msg.retain());
    }
}
</code></pre>
    <p>
     <span style="color:#0d0016">
      ğŸ“Œ
      <strong>
       ä¼˜åŒ–æ•ˆæœ
      </strong>
      ï¼š
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       <strong>
        åŸºäº Token è§’è‰²é™åˆ¶ WebSocket é¢‘é“è®¿é—®
       </strong>
       ï¼Œæé«˜å®‰å…¨æ€§ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        ç¡®ä¿ä¸åŒç”¨æˆ·ç±»å‹åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
       </strong>
       ï¼Œé˜²æ­¢æƒé™æ³„éœ²ã€‚
      </span>
     </li>
    </ul>
    <h3>
     <span style="color:#0d0016">
      <strong>
       æ€»ç»“
      </strong>
     </span>
    </h3>
    <p>
     <span style="color:#0d0016">
      æœ¬èŠ‚ä¼˜åŒ–äº† WebSocket è®¤è¯ï¼ŒåŒ…æ‹¬ï¼š
      <br/>
      âœ”
      <strong>
       ç¼“å­˜ Token æé«˜è®¤è¯æ•ˆç‡
      </strong>
      <br/>
      âœ”
      <strong>
       æ”¯æŒ Token ç»­æœŸï¼Œé¿å…è¿æ¥æ–­å¼€
      </strong>
      <br/>
      âœ”
      <strong>
       é™åˆ¶å¤šç«¯ç™»å½•ï¼Œæå‡å®‰å…¨æ€§
      </strong>
      <br/>
      âœ”
      <strong>
       åŸºäºè§’è‰²çš„æƒé™ç®¡ç†
      </strong>
     </span>
    </p>
    <h2>
     <span style="color:#0d0016">
      <strong>
       5. è®¤è¯é€šè¿‡åçš„ç”¨æˆ·ä¿¡æ¯æ¨é€ä¸åˆ·æ–°
      </strong>
     </span>
    </h2>
    <p>
     <span style="color:#0d0016">
      åœ¨ WebSocket è®¤è¯æˆåŠŸåï¼Œç”¨æˆ·çš„èº«ä»½ä¿¡æ¯å·²ç»ç¡®å®šï¼Œæ­¤æ—¶å¯ä»¥è¿›è¡Œ
      <strong>
       ç”¨æˆ·ä¿¡æ¯çš„æ¨é€å’Œåˆ·æ–°
      </strong>
      ã€‚è¿™ä¸€ç¯èŠ‚ä¸»è¦æ¶‰åŠï¼š
     </span>
    </p>
    <ol>
     <li>
      <span style="color:#0d0016">
       <strong>
        ç”¨æˆ·è¿æ¥åï¼Œä¸»åŠ¨æ¨é€ç”¨æˆ·çš„æœ€æ–°ä¿¡æ¯
       </strong>
       ï¼Œç¡®ä¿å‰ç«¯æ‹¿åˆ°æœ€æ–°çŠ¶æ€ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        ç”¨æˆ·ä¿¡æ¯å‘ç”Ÿå˜åŒ–ï¼ˆå¦‚æ˜µç§°ã€å¤´åƒã€æƒé™ç­‰ï¼‰æ—¶ï¼Œè‡ªåŠ¨æ¨é€æ›´æ–°
       </strong>
       ï¼Œé¿å…å‰ç«¯æ•°æ®æ»åã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        æ”¯æŒå‰ç«¯ä¸»åŠ¨è¯·æ±‚åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
       </strong>
       ï¼Œä¿è¯å®¢æˆ·ç«¯åœ¨éœ€è¦æ—¶èƒ½å¤Ÿè·å–æœ€æ–°æ•°æ®ã€‚
      </span>
     </li>
    </ol>
    <p>
     <span style="color:#0d0016">
      ä¸‹é¢ï¼Œæˆ‘ä»¬é€æ­¥åˆ†æå¦‚ä½•åœ¨
      <strong>
       Netty æœåŠ¡å™¨ç«¯
      </strong>
      å®ç°è¿™äº›åŠŸèƒ½ã€‚
     </span>
    </p>
    <h3>
     <span style="color:#0d0016">
      <strong>
       5.1 ç”¨æˆ·è¿æ¥åä¸»åŠ¨æ¨é€ä¿¡æ¯
      </strong>
     </span>
    </h3>
    <h4>
     <span style="color:#0d0016">
      <strong>
       ğŸ”¹ é—®é¢˜ï¼šç”¨æˆ· WebSocket è¿æ¥æˆåŠŸåï¼Œå‰ç«¯éœ€è¦è·å–æœ€æ–°ç”¨æˆ·ä¿¡æ¯
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      å½“ WebSocket è¿æ¥å»ºç«‹åï¼Œå‰ç«¯å¯èƒ½éœ€è¦ï¼š
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       è·å–ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼ˆå¦‚ç”¨æˆ·åã€å¤´åƒã€æƒé™ç­‰ï¼‰ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       è·å–ç”¨æˆ·çš„æœªè¯»æ¶ˆæ¯æ•°é‡ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       è·å–å…¶ä»–åº”ç”¨çŠ¶æ€æ•°æ®ï¼ˆå¦‚å¥½å‹åœ¨çº¿çŠ¶æ€ã€ç³»ç»Ÿé€šçŸ¥ç­‰ï¼‰ã€‚
      </span>
     </li>
    </ul>
    <h4>
     <span style="color:#0d0016">
      <strong>
       âœ… è§£å†³æ–¹æ¡ˆï¼šåœ¨ WebSocket æ¡æ‰‹æˆåŠŸåï¼ŒæœåŠ¡å™¨ä¸»åŠ¨æ¨é€ç”¨æˆ·ä¿¡æ¯
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      æˆ‘ä»¬å¯ä»¥åœ¨
      <strong>
       WebSocket æ¡æ‰‹å®Œæˆæ—¶
      </strong>
      ï¼Œä»æ•°æ®åº“æˆ–ç¼“å­˜ä¸­è¯»å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¹¶ä¸»åŠ¨æ¨é€ç»™å‰ç«¯ã€‚
     </span>
    </p>
    <h5>
     <span style="color:#0d0016">
      <strong>
       Netty æœåŠ¡å™¨ç«¯å®ç°
      </strong>
     </span>
    </h5>
    <pre><code class="language-java">import io.netty.channel.Channel;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.SimpleChannelInboundHandler;
import io.netty.handler.codec.http.websocketx.TextWebSocketFrame;
import com.fasterxml.jackson.databind.ObjectMapper;

public class UserInfoPushHandler extends SimpleChannelInboundHandler&lt;TextWebSocketFrame&gt; {
    private static final ObjectMapper objectMapper = new ObjectMapper();

    @Override
    public void channelActive(ChannelHandlerContext ctx) {
        Channel channel = ctx.channel();
        String userId = channel.attr(AttributeKey.valueOf("userId")).get().toString();

        // æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯
        UserInfo userInfo = getUserInfoFromDatabase(userId);

        // å‘é€ç”¨æˆ·ä¿¡æ¯åˆ°å‰ç«¯
        try {
            String userInfoJson = objectMapper.writeValueAsString(userInfo);
            channel.writeAndFlush(new TextWebSocketFrame(userInfoJson));
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    private UserInfo getUserInfoFromDatabase(String userId) {
        // è¿™é‡Œåº”è¯¥æ˜¯æ•°æ®åº“æŸ¥è¯¢æˆ–ç¼“å­˜è·å–
        return new UserInfo(userId, "å¼ ä¸‰", "/avatar.png", "admin");
    }
}
</code></pre>
    <p>
     <span style="color:#0d0016">
      ğŸ“Œ
      <strong>
       ä¼˜åŒ–æ•ˆæœ
      </strong>
      ï¼š
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       <strong>
        ç”¨æˆ·è¿æ¥åç«‹å³è·å–æœ€æ–°ä¿¡æ¯
       </strong>
       ï¼Œæ— éœ€å‰ç«¯ä¸»åŠ¨è¯·æ±‚ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        é¿å…å‰ç«¯é¡µé¢å‡ºç°æ•°æ®ç¼ºå¤±æˆ–å»¶è¿ŸåŠ è½½çš„é—®é¢˜
       </strong>
       ã€‚
      </span>
     </li>
    </ul>
    <h3>
     <span style="color:#0d0016">
      <strong>
       5.2 ç”¨æˆ·ä¿¡æ¯å˜åŒ–æ—¶è‡ªåŠ¨æ¨é€æ›´æ–°
      </strong>
     </span>
    </h3>
    <h4>
     <span style="color:#0d0016">
      <strong>
       ğŸ”¹ é—®é¢˜ï¼šå¦‚æœç”¨æˆ·ä¿¡æ¯åœ¨å…¶ä»–åœ°æ–¹ä¿®æ”¹äº†ï¼ŒWebSocket è¿æ¥çš„å‰ç«¯ä¸ä¼šè‡ªåŠ¨æ›´æ–°
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      ä¾‹å¦‚ï¼š
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       ç”¨æˆ·ä¿®æ”¹äº†å¤´åƒæˆ–æ˜µç§°ï¼Œå‰ç«¯ä¸ä¼šè‡ªåŠ¨æ›´æ–°ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       ç®¡ç†å‘˜ä¿®æ”¹äº†ç”¨æˆ·æƒé™ï¼Œä½† WebSocket è¿æ¥ä¸­çš„ç”¨æˆ·æƒé™ä»ç„¶æ˜¯æ—§çš„ã€‚
      </span>
     </li>
    </ul>
    <h4>
     <span style="color:#0d0016">
      <strong>
       âœ… è§£å†³æ–¹æ¡ˆï¼šæœåŠ¡å™¨ç›‘å¬ç”¨æˆ·ä¿¡æ¯å˜æ›´ï¼Œä¸»åŠ¨é€šçŸ¥æ‰€æœ‰åœ¨çº¿ WebSocket å®¢æˆ·ç«¯
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      å¯ä»¥ä½¿ç”¨
      <strong>
       æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚ Redis Pub/Subã€Kafkaï¼‰æˆ–äº‹ä»¶é©±åŠ¨æœºåˆ¶
      </strong>
      ï¼Œå½“ç”¨æˆ·ä¿¡æ¯æ›´æ–°æ—¶ï¼Œé€šçŸ¥ WebSocket æœåŠ¡å™¨æ¨é€æ¶ˆæ¯ã€‚
     </span>
    </p>
    <h5>
     <span style="color:#0d0016">
      <strong>
       1ï¸âƒ£ ç›‘å¬ç”¨æˆ·ä¿¡æ¯å˜æ›´äº‹ä»¶
      </strong>
     </span>
    </h5>
    <pre><code class="language-java">import java.util.concurrent.ConcurrentHashMap;
import io.netty.channel.Channel;

public class UserSessionManager {
    private static final ConcurrentHashMap&lt;String, Channel&gt; userChannelMap = new ConcurrentHashMap&lt;&gt;();

    public static void bindUser(String userId, Channel channel) {
        userChannelMap.put(userId, channel);
    }

    public static void unbindUser(String userId) {
        userChannelMap.remove(userId);
    }

    // å½“ç”¨æˆ·ä¿¡æ¯æ›´æ–°æ—¶ï¼Œæ¨é€æœ€æ–°æ•°æ®
    public static void pushUserInfoUpdate(String userId, UserInfo newUserInfo) {
        Channel channel = userChannelMap.get(userId);
        if (channel != null &amp;&amp; channel.isActive()) {
            try {
                String json = new ObjectMapper().writeValueAsString(newUserInfo);
                channel.writeAndFlush(new TextWebSocketFrame(json));
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }
}
</code></pre>
    <h5>
     <span style="color:#0d0016">
      <strong>
       2ï¸âƒ£ ç”¨æˆ·ä¿¡æ¯ä¿®æ”¹æ—¶è§¦å‘æ¨é€
      </strong>
     </span>
    </h5>
    <pre><code>public class UserService {
    public void updateUserInfo(String userId, String newNickname, String newAvatar) {
        // æ›´æ–°æ•°æ®åº“ä¸­çš„ç”¨æˆ·ä¿¡æ¯
        UserInfo updatedUser = updateUserInDatabase(userId, newNickname, newAvatar);

        // è§¦å‘ WebSocket æ¨é€
        UserSessionManager.pushUserInfoUpdate(userId, updatedUser);
    }

    private UserInfo updateUserInDatabase(String userId, String nickname, String avatar) {
        return new UserInfo(userId, nickname, avatar, "admin"); // æ¨¡æ‹Ÿæ•°æ®åº“æ›´æ–°
    }
}
</code></pre>
    <p>
     <span style="color:#0d0016">
      ğŸ“Œ
      <strong>
       ä¼˜åŒ–æ•ˆæœ
      </strong>
      ï¼š
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       <strong>
        å½“ç”¨æˆ·ä¿¡æ¯å˜æ›´æ—¶ï¼ŒWebSocket æœåŠ¡å™¨è‡ªåŠ¨æ¨é€æœ€æ–°ä¿¡æ¯
       </strong>
       ï¼Œç¡®ä¿å‰ç«¯æ•°æ®ä¸€è‡´ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        æ— éœ€å‰ç«¯è½®è¯¢ï¼Œå¤§å¹…é™ä½æœåŠ¡å™¨è´Ÿè½½
       </strong>
       ã€‚
      </span>
     </li>
    </ul>
    <h3>
     <span style="color:#0d0016">
      <strong>
       5.3 å‰ç«¯ä¸»åŠ¨è¯·æ±‚åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
      </strong>
     </span>
    </h3>
    <h4>
     <span style="color:#0d0016">
      <strong>
       ğŸ”¹ é—®é¢˜ï¼šæŸäº›æƒ…å†µä¸‹ï¼Œå‰ç«¯å¯èƒ½éœ€è¦ä¸»åŠ¨åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      ä¾‹å¦‚ï¼š
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       ç”¨æˆ·å¸Œæœ›æ‰‹åŠ¨åˆ·æ–°ä¸ªäººèµ„æ–™ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       WebSocket è¿æ¥å¼‚å¸¸åé‡æ–°åŒæ­¥æ•°æ®ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       ç”¨æˆ·åˆ‡æ¢é¡µé¢åï¼Œå¸Œæœ›é‡æ–°è·å–æœ€æ–°æ•°æ®ã€‚
      </span>
     </li>
    </ul>
    <h4>
     <span style="color:#0d0016">
      <strong>
       âœ… è§£å†³æ–¹æ¡ˆï¼šå‰ç«¯å‘é€è¯·æ±‚ï¼ŒæœåŠ¡å™¨è¿”å›æœ€æ–°çš„ç”¨æˆ·ä¿¡æ¯
      </strong>
     </span>
    </h4>
    <p>
     <span style="color:#0d0016">
      æˆ‘ä»¬å¯ä»¥åœ¨ WebSocket æœåŠ¡å™¨ç«¯ç›‘å¬
      <strong>
       "refreshUserInfo"
      </strong>
      äº‹ä»¶ï¼Œå½“æ”¶åˆ°è¯¥æ¶ˆæ¯æ—¶ï¼Œè¿”å›æœ€æ–°çš„ç”¨æˆ·ä¿¡æ¯ã€‚
     </span>
    </p>
    <h5>
     <span style="color:#0d0016">
      <strong>
       Netty æœåŠ¡å™¨ç«¯å¤„ç†ç”¨æˆ·åˆ·æ–°è¯·æ±‚
      </strong>
     </span>
    </h5>
    <pre><code class="language-java">public class UserInfoRefreshHandler extends SimpleChannelInboundHandler&lt;TextWebSocketFrame&gt; {
    @Override
    protected void channelRead0(ChannelHandlerContext ctx, TextWebSocketFrame msg) {
        if ("refreshUserInfo".equals(msg.text())) {
            String userId = ctx.channel().attr(AttributeKey.valueOf("userId")).get().toString();
            UserInfo userInfo = getUserInfoFromDatabase(userId);
            
            try {
                String json = new ObjectMapper().writeValueAsString(userInfo);
                ctx.channel().writeAndFlush(new TextWebSocketFrame(json));
            } catch (Exception e) {
                e.printStackTrace();
            }
        } else {
            ctx.fireChannelRead(msg.retain());
        }
    }
}
</code></pre>
    <h5>
     <span style="color:#0d0016">
      <strong>
       å‰ç«¯è¯·æ±‚åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
      </strong>
     </span>
    </h5>
    <pre><code class="language-java">// å‘é€åˆ·æ–°è¯·æ±‚
function requestUserInfoRefresh() {
    ws.send("refreshUserInfo");
}

// ç›‘å¬ WebSocket è¿”å›çš„æ–°ç”¨æˆ·ä¿¡æ¯
ws.onmessage = function(event) {
    const userInfo = JSON.parse(event.data);
    console.log("ç”¨æˆ·ä¿¡æ¯æ›´æ–°ï¼š", userInfo);
};
</code></pre>
    <p>
     <span style="color:#0d0016">
      ğŸ“Œ
      <strong>
       ä¼˜åŒ–æ•ˆæœ
      </strong>
      ï¼š
     </span>
    </p>
    <ul>
     <li>
      <span style="color:#0d0016">
       <strong>
        å‰ç«¯å¯ä»¥åœ¨ä»»æ„æ—¶é—´ä¸»åŠ¨è¯·æ±‚æœ€æ–°ç”¨æˆ·ä¿¡æ¯
       </strong>
       ï¼Œæå‡çµæ´»æ€§ã€‚
      </span>
     </li>
     <li>
      <span style="color:#0d0016">
       <strong>
        æœåŠ¡å™¨åªåœ¨å¿…è¦æ—¶è¿”å›æ•°æ®ï¼Œå‡å°‘ä¸å¿…è¦çš„æ¨é€ï¼Œæé«˜æ•ˆç‡
       </strong>
       ã€‚
      </span>
     </li>
    </ul>
    <h3>
     <span style="color:#0d0016">
      <strong>
       æ€»ç»“
      </strong>
     </span>
    </h3>
    <p>
     <span style="color:#0d0016">
      æœ¬èŠ‚ä»‹ç»äº†
      <strong>
       WebSocket è®¤è¯é€šè¿‡åï¼Œå¦‚ä½•æ¨é€å’Œåˆ·æ–°ç”¨æˆ·ä¿¡æ¯
      </strong>
      ï¼Œä¸»è¦ä¼˜åŒ–ç‚¹åŒ…æ‹¬ï¼š
     </span>
    </p>
    <p>
     <span style="color:#0d0016">
      âœ”
      <strong>
       WebSocket è¿æ¥å»ºç«‹åï¼ŒæœåŠ¡å™¨ä¸»åŠ¨æ¨é€ç”¨æˆ·æœ€æ–°ä¿¡æ¯
      </strong>
      ï¼Œé¿å…å‰ç«¯ç­‰å¾…ã€‚
      <br/>
      âœ”
      <strong>
       å½“ç”¨æˆ·ä¿¡æ¯å‘ç”Ÿå˜æ›´æ—¶ï¼ŒæœåŠ¡å™¨è‡ªåŠ¨æ¨é€æ›´æ–°
      </strong>
      ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´ã€‚
      <br/>
      âœ”
      <strong>
       å‰ç«¯å¯ä»¥ä¸»åŠ¨è¯·æ±‚åˆ·æ–°ç”¨æˆ·ä¿¡æ¯
      </strong>
      ï¼Œé¿å…æ•°æ®æ»åã€‚
     </span>
    </p>
    <h4>
    </h4>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f35333932363131332f:61727469636c652f64657461696c732f313436323539363034" class_="artid" style="display:none">
 </p>
</div>


