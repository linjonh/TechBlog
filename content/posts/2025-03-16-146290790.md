---
layout: post
title: "Android-Kotlin-高版本-DownloadManager-封装工具类,支持-APK-断点续传与自动安装"
date: 2025-03-16 09:27:39 +0800
description: "以下是一个针对 Android 高版本的封装工具类，支持和功能。该工具类兼容 Android 10 及以上版本的文件存储策略，并适配了和未知来源应用安装权限。"
keywords: "Android (Kotlin) 高版本 DownloadManager 封装工具类，支持 APK 断点续传与自动安装"
categories: ['Kotlin']
tags: ['Kotlin', 'Android']
artid: "146290790"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146290790
    alt: "Android-Kotlin-高版本-DownloadManager-封装工具类,支持-APK-断点续传与自动安装"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146290790
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146290790
cover: https://bing.ee123.net/img/rand?artid=146290790
image: https://bing.ee123.net/img/rand?artid=146290790
img: https://bing.ee123.net/img/rand?artid=146290790
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Android (Kotlin) 高版本 DownloadManager 封装工具类，支持 APK 断点续传与自动安装
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     以下是一个针对 Android 高版本的
     <code>
      DownloadManager
     </code>
     封装工具类，支持
     <strong>
      断点续传
     </strong>
     和
     <strong>
      自动安装 APK
     </strong>
     功能。该工具类兼容 Android 10 及以上版本的文件存储策略，并适配了
     <code>
      FileProvider
     </code>
     和未知来源应用安装权限。
    </p>
    <hr/>
    <h3>
     <a id="DownloadUtils_6">
     </a>
     工具类：
     <code>
      DownloadUtils
     </code>
    </h3>
    <pre><code class="prism language-kotlin"><span class="token keyword">import</span> android<span class="token punctuation">.</span>app<span class="token punctuation">.</span>DownloadManager
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>BroadcastReceiver
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Context
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>Intent
<span class="token keyword">import</span> android<span class="token punctuation">.</span>content<span class="token punctuation">.</span>IntentFilter
<span class="token keyword">import</span> android<span class="token punctuation">.</span>database<span class="token punctuation">.</span>Cursor
<span class="token keyword">import</span> android<span class="token punctuation">.</span>net<span class="token punctuation">.</span>Uri
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Build
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Environment
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Handler
<span class="token keyword">import</span> android<span class="token punctuation">.</span>os<span class="token punctuation">.</span>Looper
<span class="token keyword">import</span> android<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Log
<span class="token keyword">import</span> androidx<span class="token punctuation">.</span>core<span class="token punctuation">.</span>content<span class="token punctuation">.</span>FileProvider
<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>File

<span class="token keyword">class</span> DownloadUtils <span class="token keyword">private</span> <span class="token keyword">constructor</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">companion</span> <span class="token keyword">object</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">val</span> TAG <span class="token operator">=</span> <span class="token string-literal singleline"><span class="token string">"DownloadUtils"</span></span>
        <span class="token keyword">private</span> <span class="token keyword">var</span> instance<span class="token operator">:</span> DownloadUtils<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

        <span class="token comment">/**
         * 获取单例实例
         */</span>
        <span class="token keyword">fun</span> <span class="token function">getInstance</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">)</span><span class="token operator">:</span> DownloadUtils <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> instance <span class="token operator">?:</span> <span class="token function">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                instance <span class="token operator">?:</span> <span class="token function">DownloadUtils</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>applicationContext<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">{<!-- --></span> instance <span class="token operator">=</span> it <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> context<span class="token operator">:</span> Context <span class="token operator">=</span> context<span class="token punctuation">.</span>applicationContext
    <span class="token keyword">private</span> <span class="token keyword">val</span> downloadManager<span class="token operator">:</span> DownloadManager <span class="token operator">=</span>
        context<span class="token punctuation">.</span><span class="token function">getSystemService</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>DOWNLOAD_SERVICE<span class="token punctuation">)</span> <span class="token keyword">as</span> DownloadManager
    <span class="token keyword">private</span> <span class="token keyword">var</span> downloadId<span class="token operator">:</span> Long <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> progressListener<span class="token operator">:</span> DownloadProgressListener<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">private</span> <span class="token keyword">var</span> downloadObserver<span class="token operator">:</span> DownloadObserver<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>

    <span class="token comment">/**
     * 下载文件
     *
     * @param url 文件下载地址
     * @param fileName 保存的文件名
     * @param listener 下载进度监听器
     */</span>
    <span class="token keyword">fun</span> <span class="token function">downloadFile</span><span class="token punctuation">(</span>url<span class="token operator">:</span> String<span class="token punctuation">,</span> fileName<span class="token operator">:</span> String<span class="token punctuation">,</span> listener<span class="token operator">:</span> DownloadProgressListener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>progressListener <span class="token operator">=</span> listener

        <span class="token comment">// 创建下载请求</span>
        <span class="token keyword">val</span> request <span class="token operator">=</span> DownloadManager<span class="token punctuation">.</span><span class="token function">Request</span><span class="token punctuation">(</span>Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"文件下载"</span></span><span class="token punctuation">)</span>
            <span class="token function">setDescription</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"正在下载文件..."</span></span><span class="token punctuation">)</span>
            <span class="token function">setNotificationVisibility</span><span class="token punctuation">(</span>DownloadManager<span class="token punctuation">.</span>Request<span class="token punctuation">.</span>VISIBILITY_VISIBLE_NOTIFY_COMPLETED<span class="token punctuation">)</span>

            <span class="token comment">// 设置下载路径</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>Q<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Android 10 及以上版本，使用应用专属目录</span>
                <span class="token function">setDestinationInExternalFilesDir</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> Environment<span class="token punctuation">.</span>DIRECTORY_DOWNLOADS<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Android 10 以下版本，使用公共下载目录</span>
                <span class="token function">setDestinationInExternalPublicDir</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span>DIRECTORY_DOWNLOADS<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 支持断点续传</span>
            <span class="token function">setAllowedOverMetered</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 允许使用移动网络</span>
            <span class="token function">setAllowedOverRoaming</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 允许漫游时下载</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 开始下载</span>
        downloadId <span class="token operator">=</span> downloadManager<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>

        <span class="token comment">// 注册下载完成监听</span>
        context<span class="token punctuation">.</span><span class="token function">registerReceiver</span><span class="token punctuation">(</span>downloadCompleteReceiver<span class="token punctuation">,</span> <span class="token function">IntentFilter</span><span class="token punctuation">(</span>DownloadManager<span class="token punctuation">.</span>ACTION_DOWNLOAD_COMPLETE<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment">// 注册下载进度监听</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>progressListener <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            downloadObserver <span class="token operator">=</span> <span class="token function">DownloadObserver</span><span class="token punctuation">(</span><span class="token function">Handler</span><span class="token punctuation">(</span>Looper<span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> downloadId<span class="token punctuation">)</span>
            context<span class="token punctuation">.</span>contentResolver<span class="token punctuation">.</span><span class="token function">registerContentObserver</span><span class="token punctuation">(</span>
                Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"content://downloads/my_downloads"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> downloadObserver<span class="token operator">!!</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 安装 APK 文件
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">installApk</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> apkFile <span class="token operator">=</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>Q<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Android 10 及以上版本，使用应用专属目录</span>
            <span class="token function">File</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getExternalFilesDir</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span>DIRECTORY_DOWNLOADS<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"app-update.apk"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Android 10 以下版本，使用公共下载目录</span>
            <span class="token function">File</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span><span class="token function">getExternalStoragePublicDirectory</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span>DIRECTORY_DOWNLOADS<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"app-update.apk"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>apkFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"APK 文件不存在"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 使用 FileProvider 获取文件的 Uri</span>
        <span class="token keyword">val</span> apkUri <span class="token operator">=</span> FileProvider<span class="token punctuation">.</span><span class="token function">getUriForFile</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">context<span class="token punctuation">.</span>packageName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.fileprovider"</span></span><span class="token punctuation">,</span> apkFile<span class="token punctuation">)</span>

        <span class="token comment">// 创建安装 Intent</span>
        <span class="token keyword">val</span> installIntent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_VIEW<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">setDataAndType</span><span class="token punctuation">(</span>apkUri<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"application/vnd.android.package-archive"</span></span><span class="token punctuation">)</span>
            <span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_GRANT_READ_URI_PERMISSION<span class="token punctuation">)</span>
            <span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span>

            <span class="token comment">// 适配 Android 7.0 及以上版本</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_GRANT_READ_URI_PERMISSION<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 适配 Android 8.0 及以上版本，允许安装未知来源的应用</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&gt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>O<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>context<span class="token punctuation">.</span>packageManager<span class="token punctuation">.</span><span class="token function">canRequestPackageInstalls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 跳转到设置页面，允许安装未知来源应用</span>
                    <span class="token keyword">val</span> intent <span class="token operator">=</span> <span class="token function">Intent</span><span class="token punctuation">(</span>android<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>Settings<span class="token punctuation">.</span>ACTION_MANAGE_UNKNOWN_APP_SOURCES<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">data</span> <span class="token operator">=</span> Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"package:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token expression">context<span class="token punctuation">.</span>packageName</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                        <span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                    context<span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span>
                    <span class="token keyword">return</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        context<span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>installIntent<span class="token punctuation">)</span>

        <span class="token comment">// 注销广播接收器和内容观察者</span>
        context<span class="token punctuation">.</span><span class="token function">unregisterReceiver</span><span class="token punctuation">(</span>downloadCompleteReceiver<span class="token punctuation">)</span>
        downloadObserver<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{<!-- --></span>
            context<span class="token punctuation">.</span>contentResolver<span class="token punctuation">.</span><span class="token function">unregisterContentObserver</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 下载完成广播接收器
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> downloadCompleteReceiver <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> <span class="token function">BroadcastReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onReceive</span><span class="token punctuation">(</span>context<span class="token operator">:</span> Context<span class="token punctuation">,</span> intent<span class="token operator">:</span> Intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> id <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getLongExtra</span><span class="token punctuation">(</span>DownloadManager<span class="token punctuation">.</span>EXTRA_DOWNLOAD_ID<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> downloadId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                progressListener<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">onDownloadComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token function">installApk</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 下载进度观察者
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">inner</span> <span class="token keyword">class</span> <span class="token function">DownloadObserver</span><span class="token punctuation">(</span>handler<span class="token operator">:</span> Handler<span class="token punctuation">,</span> <span class="token keyword">private</span> <span class="token keyword">val</span> downloadId<span class="token operator">:</span> Long<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ContentObserver</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onChange</span><span class="token punctuation">(</span>selfChange<span class="token operator">:</span> Boolean<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onChange</span><span class="token punctuation">(</span>selfChange<span class="token punctuation">)</span>
            <span class="token function">queryDownloadProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">queryDownloadProgress</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">val</span> query <span class="token operator">=</span> DownloadManager<span class="token punctuation">.</span><span class="token function">Query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">setFilterById</span><span class="token punctuation">(</span>downloadId<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            context<span class="token punctuation">.</span>contentResolver<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>
                Uri<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"content://downloads/my_downloads"</span></span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token keyword">null</span><span class="token punctuation">,</span>
                <span class="token keyword">null</span><span class="token punctuation">,</span>
                <span class="token keyword">null</span><span class="token punctuation">,</span>
                <span class="token keyword">null</span>
            <span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">use</span> <span class="token punctuation">{<!-- --></span> cursor <span class="token operator">-&gt;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cursor<span class="token punctuation">.</span><span class="token function">moveToFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">val</span> status <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>cursor<span class="token punctuation">.</span><span class="token function">getColumnIndex</span><span class="token punctuation">(</span>DownloadManager<span class="token punctuation">.</span>COLUMN_STATUS<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">val</span> bytesDownloaded <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>cursor<span class="token punctuation">.</span><span class="token function">getColumnIndex</span><span class="token punctuation">(</span>DownloadManager<span class="token punctuation">.</span>COLUMN_BYTES_DOWNLOADED_SO_FAR<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">val</span> bytesTotal <span class="token operator">=</span> cursor<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span>cursor<span class="token punctuation">.</span><span class="token function">getColumnIndex</span><span class="token punctuation">(</span>DownloadManager<span class="token punctuation">.</span>COLUMN_TOTAL_SIZE_BYTES<span class="token punctuation">)</span><span class="token punctuation">)</span>

                    <span class="token keyword">when</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        DownloadManager<span class="token punctuation">.</span>STATUS_RUNNING <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">if</span> <span class="token punctuation">(</span>bytesTotal <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token keyword">val</span> progress <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bytesDownloaded <span class="token operator">*</span> <span class="token number">100L</span><span class="token punctuation">)</span> <span class="token operator">/</span> bytesTotal<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                progressListener<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">onProgress</span><span class="token punctuation">(</span>progress<span class="token punctuation">)</span>
                            <span class="token punctuation">}</span>
                        <span class="token punctuation">}</span>
                        DownloadManager<span class="token punctuation">.</span>STATUS_FAILED <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                            progressListener<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"下载失败"</span></span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 下载进度监听器
     */</span>
    <span class="token keyword">interface</span> DownloadProgressListener <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">fun</span> <span class="token function">onProgress</span><span class="token punctuation">(</span>progress<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token comment">// 下载进度（0-100）</span>
        <span class="token keyword">fun</span> <span class="token function">onError</span><span class="token punctuation">(</span>message<span class="token operator">:</span> String<span class="token punctuation">)</span>  <span class="token comment">// 下载失败</span>
        <span class="token keyword">fun</span> <span class="token function">onDownloadComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token comment">// 下载完成</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_214">
     </a>
     主要功能
    </h3>
    <ol>
     <li>
      <p>
       <strong>
        断点续传
       </strong>
       ：
      </p>
      <ul>
       <li>
        支持网络中断后继续下载。
       </li>
       <li>
        通过
        <code>
         DownloadManager
        </code>
        的
        <code>
         setAllowedOverMetered
        </code>
        和
        <code>
         setAllowedOverRoaming
        </code>
        方法实现。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        自动安装 APK
       </strong>
       ：
      </p>
      <ul>
       <li>
        下载完成后自动触发安装流程。
       </li>
       <li>
        适配 Android 7.0 及以上版本的
        <code>
         FileProvider
        </code>
        。
       </li>
       <li>
        处理 Android 8.0 及以上版本的未知来源应用安装权限。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        下载进度监听
       </strong>
       ：
      </p>
      <ul>
       <li>
        通过
        <code>
         ContentObserver
        </code>
        监听下载进度，实时回调进度值。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        高版本兼容
       </strong>
       ：
      </p>
      <ul>
       <li>
        适配 Android 10 及以上版本的文件存储策略，使用应用专属目录。
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h3>
     <a id="_233">
     </a>
     使用方法
    </h3>
    <h4>
     <a id="1__235">
     </a>
     1. 初始化并下载文件
    </h4>
    <pre><code class="prism language-kotlin"><span class="token keyword">val</span> downloadUtils <span class="token operator">=</span> DownloadUtils<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span>
downloadUtils<span class="token punctuation">.</span><span class="token function">downloadFile</span><span class="token punctuation">(</span>
    <span class="token string-literal singleline"><span class="token string">"https://example.com/file.apk"</span></span><span class="token punctuation">,</span>
    <span class="token string-literal singleline"><span class="token string">"app-update.apk"</span></span><span class="token punctuation">,</span>
    <span class="token keyword">object</span> <span class="token operator">:</span> DownloadUtils<span class="token punctuation">.</span><span class="token function">DownloadProgressListener</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onProgress</span><span class="token punctuation">(</span>progress<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"下载进度: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">progress</span></span><span class="token string">%"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onError</span><span class="token punctuation">(</span>message<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"下载失败: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">$</span><span class="token expression">message</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onDownloadComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"下载完成"</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="2__FileProvider_258">
     </a>
     2. 配置
     <code>
      FileProvider
     </code>
    </h4>
    <p>
     在
     <code>
      AndroidManifest.xml
     </code>
     中添加以下配置：
    </p>
    <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>provider</span>
    <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>androidx.core.content.FileProvider<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>authorities</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>${applicationId}.fileprovider<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>exported</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>false<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>grantUriPermissions</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta-data</span>
        <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.support.FILE_PROVIDER_PATHS<span class="token punctuation">"</span></span>
        <span class="token attr-name"><span class="token namespace">android:</span>resource</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>@xml/file_paths<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>provider</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
     在
     <code>
      res/xml/file_paths.xml
     </code>
     中定义文件路径：
    </p>
    <pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>paths</span> <span class="token attr-name"><span class="token namespace">xmlns:</span>android</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://schemas.android.com/apk/res/android<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>external-files-path</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>downloads<span class="token punctuation">"</span></span> <span class="token attr-name">path</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Download/<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>paths</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h4>
     <a id="3__283">
     </a>
     3. 添加权限
    </h4>
    <p>
     在
     <code>
      AndroidManifest.xml
     </code>
     中添加以下权限：
    </p>
    <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.INTERNET<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.WRITE_EXTERNAL_STORAGE<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>uses-permission</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.permission.REQUEST_INSTALL_PACKAGES<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre>
    <hr/>
    <h3>
     <a id="_295">
     </a>
     注意事项
    </h3>
    <ol>
     <li>
      <p>
       <strong>
        存储权限
       </strong>
       ：
      </p>
      <ul>
       <li>
        在 Android 10 及以上版本中，使用应用专属目录无需申请
        <code>
         WRITE_EXTERNAL_STORAGE
        </code>
        权限。
       </li>
       <li>
        在 Android 10 以下版本中，需要动态申请
        <code>
         WRITE_EXTERNAL_STORAGE
        </code>
        权限。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        未知来源应用安装
       </strong>
       ：
      </p>
      <ul>
       <li>
        在 Android 8.0 及以上版本中，需要引导用户开启“允许安装未知来源应用”权限。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        文件路径
       </strong>
       ：
      </p>
      <ul>
       <li>
        确保
        <code>
         file_paths.xml
        </code>
        中定义的路径与代码中的路径一致。
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <p>
     通过以上工具类，你可以轻松实现 APK 下载、断点续传和自动安装功能，同时兼容 Android 高版本的文件存储策略和权限要求。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e637364:6e2e6e65742f74616e6777656967756f30333035313938372f:61727469636c652f64657461696c732f313436323930373930" class_="artid" style="display:none">
 </p>
</div>


