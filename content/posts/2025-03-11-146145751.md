---
layout: post
title: "Javaå®ç”¨æ³¨è§£ç¯‡Transactional-äº‹åŠ¡å¤±æ•ˆçš„åœºæ™¯æ·±åº¦è§£æ"
date: 2025-03-11 08:59:06 +0800
description: "åœ¨ä½¿ç”¨æ˜æ˜åŠ äº†äº‹åŠ¡æ³¨è§£ï¼Œä½†äº‹åŠ¡å´æ²¡æœ‰ç”Ÿæ•ˆï¼Œæ•°æ®åº“æ“ä½œä»ç„¶è¢«æäº¤äº†ï¼è¿™æ˜¯å› ä¸ºäº‹åŠ¡æœºåˆ¶çš„è§¦å‘æœ‰ä¸€äº›å‰ææ¡ä»¶ï¼Œåªè¦è§¦ç¢°åˆ°äº‹åŠ¡å¤±æ•ˆçš„â€œé›·åŒºâ€ï¼Œå°±ä¼šè®©äº‹åŠ¡å˜æˆâ€œæ‘†è®¾â€ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†å‰–æå‡ ç§å¸¸è§çš„äº‹åŠ¡å¤±æ•ˆåœºæ™¯ä»¥åŠè§£å†³æ–¹æ¡ˆï¼"
keywords: "Javaå®ç”¨æ³¨è§£ç¯‡ï¼š@Transactional äº‹åŠ¡å¤±æ•ˆçš„åœºæ™¯æ·±åº¦è§£æ"
categories: ['æœªåˆ†ç±»']
tags: ['æ•°æ®åº“', 'å¼€å‘è¯­è¨€', 'Java']
artid: "146145751"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146145751
    alt: "Javaå®ç”¨æ³¨è§£ç¯‡Transactional-äº‹åŠ¡å¤±æ•ˆçš„åœºæ™¯æ·±åº¦è§£æ"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146145751
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146145751
cover: https://bing.ee123.net/img/rand?artid=146145751
image: https://bing.ee123.net/img/rand?artid=146145751
img: https://bing.ee123.net/img/rand?artid=146145751
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Javaå®ç”¨æ³¨è§£ç¯‡ï¼š@Transactional äº‹åŠ¡å¤±æ•ˆçš„åœºæ™¯æ·±åº¦è§£æ
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h3>
     å‰è¨€
    </h3>
    <p>
     åœ¨ä½¿ç”¨
     <code>
      @Transactional
     </code>
     æ—¶ï¼Œå¾ˆå¤šå¼€å‘è€…éƒ½ä¼šé‡åˆ°ä¸€ä¸ªå¸¸è§å›°æƒ‘ï¼š
     <strong>
      æ˜æ˜åŠ äº†äº‹åŠ¡æ³¨è§£ï¼Œä½†äº‹åŠ¡å´æ²¡æœ‰ç”Ÿæ•ˆï¼Œæ•°æ®åº“æ“ä½œä»ç„¶è¢«æäº¤äº†ï¼
     </strong>
     <br/>
     è¿™æ˜¯å› ä¸ºäº‹åŠ¡æœºåˆ¶çš„è§¦å‘æœ‰ä¸€äº›
     <strong>
      å‰ææ¡ä»¶
     </strong>
     ï¼Œåªè¦è§¦ç¢°åˆ°äº‹åŠ¡å¤±æ•ˆçš„â€œé›·åŒºâ€ï¼Œå°±ä¼šè®©äº‹åŠ¡å˜æˆâ€œæ‘†è®¾â€ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†å‰–æå‡ ç§å¸¸è§çš„
     <strong>
      äº‹åŠ¡å¤±æ•ˆåœºæ™¯
     </strong>
     ä»¥åŠ
     <strong>
      è§£å†³æ–¹æ¡ˆ
     </strong>
     ï¼
    </p>
    <p>
    </p>
    <h3>
     âœ…
     <strong>
      1ï¸âƒ£ åŒä¸€ä¸ªç±»ä¸­æ–¹æ³•ç›´æ¥è°ƒç”¨ï¼Œäº‹åŠ¡å¤±æ•ˆ
     </strong>
    </h3>
    <h4>
     <strong>
      é—®é¢˜å¤ç°ï¼š
     </strong>
    </h4>
    <pre><code class="language-java">@Service
public class UserService {

    @Autowired
    private UserRepository userRepository;

    @Transactional
    public void methodA() {
        userRepository.save(new User("UserA"));
        methodB(); // å†…éƒ¨è°ƒç”¨ï¼Œä¸è§¦å‘äº‹åŠ¡
    }

    @Transactional
    public void methodB() {
        userRepository.save(new User("UserB"));
        throw new RuntimeException("Test rollback"); // æœŸæœ›å›æ»š
    }
}</code></pre>
    <h4>
     <strong>
      æ‰§è¡Œç»“æœï¼š
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       UserA ä¼šè¢«æ’å…¥æ•°æ®åº“
      </strong>
     </li>
     <li>
      <strong>
       UserB æ²¡æœ‰æ’å…¥ï¼Œå› ä¸ºæŠ›å‡ºäº†å¼‚å¸¸
      </strong>
     </li>
     <li>
      ğŸš¨
      <strong>
       äº‹åŠ¡æ²¡æœ‰å›æ»šï¼
      </strong>
     </li>
    </ul>
    <h4>
     <strong>
      ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ
     </strong>
    </h4>
    <p>
     Spring çš„äº‹åŠ¡æ˜¯åŸºäº
     <strong>
      AOP ä»£ç†æœºåˆ¶
     </strong>
     å®ç°çš„ï¼Œè€Œä»£ç†å¯¹è±¡åªæœ‰åœ¨
     <strong>
      å¤–éƒ¨è°ƒç”¨
     </strong>
     æ—¶æ‰ä¼šè§¦å‘æ‹¦æˆªå™¨é€»è¾‘ï¼Œä»è€Œå¼€å¯äº‹åŠ¡ã€‚
     <br/>
     <strong>
      åŒä¸€ä¸ªç±»å†…çš„æ–¹æ³•è°ƒç”¨ä¸ä¼šç»è¿‡ä»£ç†å¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡
      <code>
       this.methodB()
      </code>
      è°ƒç”¨çš„ï¼Œå› æ­¤ä¸ä¼šè§¦å‘äº‹åŠ¡æœºåˆ¶ï¼
     </strong>
    </p>
    <h4>
    </h4>
    <h4>
     âœ…
     <strong>
      è§£å†³æ–¹æ¡ˆï¼š
     </strong>
    </h4>
    <p>
     <strong>
      æ–¹æ¡ˆä¸€ï¼šé€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨äº‹åŠ¡æ–¹æ³•
     </strong>
    </p>
    <pre><code class="language-java">@Autowired
private UserService userService;

@Transactional
public void methodA() {
    userRepository.save(new User("UserA"));
    userService.methodB(); // é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨ï¼Œè§¦å‘äº‹åŠ¡
}
</code></pre>
    <p>
     <strong>
      æ–¹æ¡ˆäºŒï¼šä½¿ç”¨
      <code>
       AopContext
      </code>
      è·å–å½“å‰ä»£ç†å¯¹è±¡
     </strong>
    </p>
    <p>
     Spring æä¾›äº†
     <code>
      AopContext
     </code>
     å·¥å…·ç±»ï¼Œå¯ä»¥è·å–å½“å‰ä»£ç†å¯¹è±¡ï¼š
    </p>
    <pre><code class="language-java">import org.springframework.aop.framework.AopContext;

@Transactional
public void methodA() {
    userRepository.save(new User("UserA"));
    ((UserService) AopContext.currentProxy()).methodB();
}</code></pre>
    <p>
     <strong>
      æ³¨æ„ï¼š
     </strong>
    </p>
    <ul>
     <li>
      éœ€è¦åœ¨é…ç½®ç±»ä¸­å¼€å¯
      <strong>
       æš´éœ²ä»£ç†å¯¹è±¡åŠŸèƒ½
      </strong>
      æ‰èƒ½ä½¿ç”¨
      <code>
       AopContext
      </code>
      ï¼š
     </li>
    </ul>
    <pre><code class="language-java">@EnableAspectJAutoProxy(exposeProxy = true)</code></pre>
    <h3>
     âœ…
     <strong>
      2ï¸âƒ£ é
      <code>
       public
      </code>
      æ–¹æ³•ä¸Šçš„ @Transactional æ³¨è§£æ— æ•ˆ
     </strong>
    </h3>
    <h4>
     <strong>
      é—®é¢˜å¤ç°ï¼š
     </strong>
    </h4>
    <pre><code class="language-java">@Service
public class UserService {

    @Autowired
    private UserRepository userRepository;

    @Transactional
    private void addUser() {
        userRepository.save(new User("PrivateUser"));
        throw new RuntimeException("Test rollback");
    }
}</code></pre>
    <h4>
     <strong>
      æ‰§è¡Œç»“æœï¼š
     </strong>
    </h4>
    <ul>
     <li>
      æ•°æ®æˆåŠŸæ’å…¥ï¼Œäº‹åŠ¡
      <strong>
       æ²¡æœ‰å›æ»š
      </strong>
      ï¼
     </li>
    </ul>
    <h4>
     <strong>
      ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ
     </strong>
    </h4>
    <p>
     Spring çš„äº‹åŠ¡æ˜¯åŸºäº
     <strong>
      åŠ¨æ€ä»£ç†æœºåˆ¶
     </strong>
     ï¼Œåªæœ‰
     <strong>
      <code>
       public
      </code>
      æ–¹æ³•
     </strong>
     æ‰ä¼šè¢«ä»£ç†ï¼Œ
     <strong>
      <code>
       private
      </code>
      ã€
      <code>
       protected
      </code>
      ã€
      <code>
       default
      </code>
      ä¿®é¥°çš„æ–¹æ³•ä¸ä¼šè¢«ä»£ç†
     </strong>
     ï¼Œå› æ­¤ä¸ä¼šè§¦å‘äº‹åŠ¡æœºåˆ¶ã€‚
    </p>
    <h4>
     âœ…
     <strong>
      è§£å†³æ–¹æ¡ˆï¼š
     </strong>
    </h4>
    <p>
     <strong>
      æ”¹ä¸º
      <code>
       public
      </code>
      æ–¹æ³•ï¼š
     </strong>
    </p>
    <pre><code class="language-java">@Transactional
public void addUser() {
    userRepository.save(new User("PublicUser"));
    throw new RuntimeException("Test rollback");
}</code></pre>
    <h3>
     âœ…
     <strong>
      3ï¸âƒ£ æ•°æ®åº“å¼•æ“ä¸æ”¯æŒäº‹åŠ¡
     </strong>
    </h3>
    <h4>
     <strong>
      é—®é¢˜å¤ç°ï¼š
     </strong>
    </h4>
    <p>
     å¦‚æœä½ çš„æ•°æ®åº“è¡¨ä½¿ç”¨çš„æ˜¯ MySQL çš„
     <strong>
      MyISAM å¼•æ“
     </strong>
     è€Œä¸æ˜¯
     <strong>
      InnoDB
     </strong>
     ï¼Œäº‹åŠ¡æœºåˆ¶æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ï¼
    </p>
    <p>
     <strong>
      æ£€æŸ¥è¡¨å¼•æ“ï¼š
     </strong>
    </p>
    <pre><code class="language-java">SHOW TABLE STATUS WHERE Name = 'your_table';</code></pre>
    <p>
     å¦‚æœçœ‹åˆ°
     <strong>
      <code>
       Engine=MyISAM
      </code>
     </strong>
     ï¼š
    </p>
    <pre><code class="language-java">+------------+--------+ ...
| Name       | Engine | ...
+------------+--------+ ...
| user_table | MyISAM | ...
+------------+--------+ ...</code></pre>
    <h4>
     <strong>
      ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       MyISAM
      </strong>
      æ˜¯ MySQL çš„æ—©æœŸå­˜å‚¨å¼•æ“ï¼Œä¸æ”¯æŒäº‹åŠ¡å›æ»šã€å¤–é”®ç­‰ç‰¹æ€§ã€‚
     </li>
     <li>
      <strong>
       InnoDB
      </strong>
      æ‰æ˜¯æ”¯æŒäº‹åŠ¡ã€è¡Œçº§é”ç­‰åŠŸèƒ½çš„å­˜å‚¨å¼•æ“ã€‚
     </li>
    </ul>
    <h4>
     âœ…
     <strong>
      è§£å†³æ–¹æ¡ˆï¼š
     </strong>
    </h4>
    <p>
     <strong>
      æŠŠè¡¨å¼•æ“æ”¹ä¸º InnoDBï¼š
     </strong>
    </p>
    <pre><code class="language-java">ALTER TABLE your_table ENGINE=InnoDB;</code></pre>
    <p>
     <strong>
      æŸ¥çœ‹æ‰€æœ‰ MyISAM è¡¨ï¼š
     </strong>
    </p>
    <pre><code class="language-java">SELECT table_schema, table_name, engine
FROM information_schema.tables
WHERE engine = 'MyISAM';</code></pre>
    <h3>
     âœ…
     <strong>
      4ï¸âƒ£ æ•è·äº†å¼‚å¸¸ï¼Œå¯¼è‡´äº‹åŠ¡æ— æ³•å›æ»š
     </strong>
    </h3>
    <h4>
     <strong>
      é—®é¢˜å¤ç°ï¼š
     </strong>
    </h4>
    <pre><code class="language-java">@Transactional
public void addUser() {
    try {
        userRepository.save(new User("TryCatchUser"));
        int result = 1 / 0; // æŠ›å‡º ArithmeticException
    } catch (Exception e) {
        // å¼‚å¸¸è¢«æ•è·
        System.out.println("Exception caught: " + e.getMessage());
    }
}</code></pre>
    <h4>
     <strong>
      æ‰§è¡Œç»“æœï¼š
     </strong>
    </h4>
    <ul>
     <li>
      æ•°æ®è¢«æ’å…¥
     </li>
     <li>
      ğŸš¨
      <strong>
       äº‹åŠ¡æ²¡æœ‰å›æ»šï¼
      </strong>
     </li>
    </ul>
    <h4>
     <strong>
      ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ
     </strong>
    </h4>
    <ul>
     <li>
      Spring é»˜è®¤åªæœ‰
      <strong>
       æœªæ•è·çš„è¿è¡Œæ—¶å¼‚å¸¸
      </strong>
      ï¼ˆç»§æ‰¿è‡ª
      <code>
       RuntimeException
      </code>
      ï¼‰æ‰ä¼šè§¦å‘å›æ»šã€‚
     </li>
     <li>
      <strong>
       å—æ£€å¼‚å¸¸
      </strong>
      ï¼ˆå¦‚
      <code>
       IOException
      </code>
      ï¼‰æˆ–è€…
      <strong>
       è¢«æ•è·çš„å¼‚å¸¸
      </strong>
      ä¸ä¼šè§¦å‘äº‹åŠ¡å›æ»šï¼
     </li>
    </ul>
    <h4>
     âœ…
     <strong>
      è§£å†³æ–¹æ¡ˆï¼š
     </strong>
    </h4>
    <p>
     <strong>
      æ–¹æ¡ˆä¸€ï¼šæ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œè®© Spring æ„ŸçŸ¥åˆ°äº‹åŠ¡éœ€è¦å›æ»šï¼š
     </strong>
    </p>
    <pre><code class="language-java">@Transactional
public void addUser() {
    try {
        userRepository.save(new User("User"));
        int result = 1 / 0;
    } catch (Exception e) {
        throw new RuntimeException(e); // æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸è§¦å‘å›æ»š
    }
}</code></pre>
    <p>
     <strong>
      æ–¹æ¡ˆäºŒï¼šä½¿ç”¨
      <code>
       rollbackFor
      </code>
      æ˜ç¡®æŒ‡å®šå“ªäº›å¼‚å¸¸è§¦å‘å›æ»šï¼š
     </strong>
    </p>
    <pre><code class="language-java">@Transactional(rollbackFor = Exception.class)
public void addUser() {
    try {
        userRepository.save(new User("User"));
        int result = 1 / 0;
    } catch (Exception e) {
        // å¼‚å¸¸ä¾ç„¶è¢«æ•è·ï¼Œä½†äº‹åŠ¡ä»ç„¶ä¼šå›æ»š
        System.out.println("Caught exception, but rollback still happens!");
    }
}</code></pre>
    <h3>
     âœ…
     <strong>
      5ï¸âƒ£ å¤šçº¿ç¨‹ç¯å¢ƒä¸‹äº‹åŠ¡å¤±æ•ˆ
     </strong>
    </h3>
    <h4>
     <strong>
      é—®é¢˜å¤ç°ï¼š
     </strong>
    </h4>
    <pre><code class="language-java">@Transactional
public void addUser() {
    new Thread(() -&gt; {
        userRepository.save(new User("AsyncUser"));
        throw new RuntimeException("Test rollback");
    }).start();
}</code></pre>
    <h4>
     <strong>
      æ‰§è¡Œç»“æœï¼š
     </strong>
    </h4>
    <ul>
     <li>
      æ•°æ®è¢«æ’å…¥
     </li>
     <li>
      ğŸš¨
      <strong>
       äº‹åŠ¡æ²¡æœ‰å›æ»šï¼
      </strong>
     </li>
    </ul>
    <h4>
     <strong>
      ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ
     </strong>
    </h4>
    <p>
     Spring çš„äº‹åŠ¡æ˜¯
     <strong>
      çº¿ç¨‹ç»‘å®šçš„
     </strong>
     ï¼ˆåŸºäº
     <code>
      ThreadLocal
     </code>
     å®ç°ï¼‰ï¼Œ
     <br/>
     <strong>
      æ–°çº¿ç¨‹ä¸ä¼šç»§æ‰¿åŸçº¿ç¨‹çš„äº‹åŠ¡ä¸Šä¸‹æ–‡
     </strong>
     ï¼Œå› æ­¤æ–°çº¿ç¨‹æ— æ³•æ„ŸçŸ¥åˆ°åŸçº¿ç¨‹çš„äº‹åŠ¡è¾¹ç•Œã€‚
    </p>
    <h4>
     âœ…
     <strong>
      è§£å†³æ–¹æ¡ˆï¼š
     </strong>
    </h4>
    <p>
     <strong>
      ä½¿ç”¨
      <code>
       @Async
      </code>
      é…åˆäº‹åŠ¡ï¼š
     </strong>
    </p>
    <pre><code class="language-java">@Service
public class UserService {

    @Autowired
    private UserRepository userRepository;

    @Async
    @Transactional
    public void addUserAsync() {
        userRepository.save(new User("AsyncUser"));
        throw new RuntimeException("Test rollback");
    }
}</code></pre>
    <p>
     <strong>
      æ³¨æ„ï¼š
     </strong>
    </p>
    <ul>
     <li>
      éœ€è¦åœ¨å¯åŠ¨ç±»ä¸ŠåŠ ä¸Š
      <strong>
       <code>
        @EnableAsync
       </code>
      </strong>
      ï¼š
     </li>
    </ul>
    <pre><code class="language-java">@SpringBootApplication
@EnableAsync
public class Application {
}</code></pre>
    <h3>
     âœ…
     <strong>
      6ï¸âƒ£ æ•°æ®åº“è¿æ¥çš„è‡ªåŠ¨æäº¤æœªå…³é—­
     </strong>
    </h3>
    <h4>
     <strong>
      é—®é¢˜å¤ç°ï¼š
     </strong>
    </h4>
    <p>
     å¦‚æœä½ çš„æ•°æ®åº“è¿æ¥æ± é…ç½®äº†
     <strong>
      è‡ªåŠ¨æäº¤
     </strong>
     ï¼Œé‚£ä¹ˆäº‹åŠ¡æ§åˆ¶ä¼šè¢«ç»•è¿‡ï¼
    </p>
    <p>
     <strong>
      å¯èƒ½çš„é…ç½®ï¼š
     </strong>
    </p>
    <pre><code class="language-java">spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/test_db
    username: root
    password: 123456
    hikari:
      auto-commit: true  # ğŸš¨è‡ªåŠ¨æäº¤ä¸ºtrue</code></pre>
    <h4>
     <strong>
      ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ
     </strong>
    </h4>
    <ul>
     <li>
      Spring äº‹åŠ¡ä¼šé€šè¿‡
      <strong>
       DataSource
      </strong>
      è·å–è¿æ¥ï¼Œå¦‚æœè¿æ¥çš„
      <code>
       autoCommit=true
      </code>
      ï¼Œæ¯æ¬¡ SQL æ‰§è¡Œéƒ½ä¼šç«‹åˆ»æäº¤ã€‚
     </li>
     <li>
      <strong>
       äº‹åŠ¡æ³¨è§£æ§åˆ¶çš„æäº¤/å›æ»šè¡Œä¸ºè¢«ç»•è¿‡
      </strong>
      ã€‚
     </li>
    </ul>
    <h4>
     âœ…
     <strong>
      è§£å†³æ–¹æ¡ˆï¼š
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       ç¡®ä¿æ•°æ®åº“è¿æ¥æ± å…³é—­è‡ªåŠ¨æäº¤
      </strong>
      ï¼š
     </li>
    </ul>
    <pre><code class="language-java">spring:
  datasource:
    hikari:
      auto-commit: false</code></pre>
    <ul>
     <li>
      æˆ–è€…æ‰‹åŠ¨å…³é—­è‡ªåŠ¨æäº¤ï¼š
     </li>
    </ul>
    <pre><code class="language-java">Connection conn = dataSource.getConnection();
conn.setAutoCommit(false);</code></pre>
    <h3>
     âœ…
     <strong>
      7ï¸âƒ£ ä»£ç†å¯¹è±¡è¢«ç»•è¿‡ï¼ˆæ¯”å¦‚ä½¿ç”¨ this å…³é”®å­—ï¼‰
     </strong>
    </h3>
    <h4>
     <strong>
      é—®é¢˜å¤ç°ï¼š
     </strong>
    </h4>
    <pre><code class="language-java">@Service
public class UserService {

    @Autowired
    private UserRepository userRepository;

    @Transactional
    public void outerMethod() {
        userRepository.save(new User("OuterMethod"));
        this.innerMethod(); // ğŸš¨ä¸ä¼šè§¦å‘äº‹åŠ¡
    }

    @Transactional
    public void innerMethod() {
        userRepository.save(new User("InnerMethod"));
        throw new RuntimeException("Test rollback");
    }
}</code></pre>
    <h4>
     <strong>
      ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       Spring çš„äº‹åŠ¡æ˜¯åŸºäºä»£ç†å¯¹è±¡å®ç°çš„
      </strong>
      ï¼Œ
      <code>
       this.innerMethod()
      </code>
      æ˜¯ç›´æ¥è°ƒç”¨è‡ªèº«æ–¹æ³•ï¼Œç»•è¿‡äº†ä»£ç†å¯¹è±¡ã€‚
     </li>
     <li>
      <strong>
       äº‹åŠ¡æ‹¦æˆªå™¨ä¸ä¼šç”Ÿæ•ˆ
      </strong>
      ï¼Œå› æ­¤å†…éƒ¨æ–¹æ³•ä¸ä¼šèµ°äº‹åŠ¡é€»è¾‘ã€‚
     </li>
    </ul>
    <h4>
     âœ…
     <strong>
      è§£å†³æ–¹æ¡ˆï¼š
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨äº‹åŠ¡æ–¹æ³•ï¼š
      </strong>
     </li>
    </ul>
    <pre><code class="language-java">@Autowired
private UserService userService;

public void outerMethod() {
    userRepository.save(new User("OuterMethod"));
    userService.innerMethod(); // ğŸš€è§¦å‘äº‹åŠ¡
}</code></pre>
    <h3>
     âœ…
     <strong>
      8ï¸âƒ£ åµŒå¥—äº‹åŠ¡è®¾ç½®ä¸å½“
     </strong>
    </h3>
    <h4>
     <strong>
      é—®é¢˜å¤ç°ï¼š
     </strong>
    </h4>
    <p>
     å½“ä½ æœ‰åµŒå¥—äº‹åŠ¡æ—¶ï¼Œå¦‚æœ
     <strong>
      ä¼ æ’­æœºåˆ¶ï¼ˆPropagationï¼‰
     </strong>
     é…ç½®ä¸å½“ï¼Œä¹Ÿå¯èƒ½é€ æˆäº‹åŠ¡å¤±æ•ˆã€‚
    </p>
    <p>
     <strong>
      ä¾‹å¦‚ï¼š
     </strong>
    </p>
    <pre><code class="language-java">@Transactional
public void outerMethod() {
    userRepository.save(new User("Outer"));
    innerMethod();
}

@Transactional(propagation = Propagation.REQUIRES_NEW)
public void innerMethod() {
    userRepository.save(new User("Inner"));
    throw new RuntimeException("Test rollback");
}</code></pre>
    <h4>
     <strong>
      ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ
     </strong>
    </h4>
    <pre><code class="language-java">@Transactional(propagation = Propagation.NESTED)</code></pre>
    <ul>
     <li>
      <strong>
       <code>
        Propagation.REQUIRES_NEW
       </code>
      </strong>
      è¡¨ç¤ºå¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œ
      <br/>
      <strong>
       å¤–å±‚äº‹åŠ¡å’Œå†…å±‚äº‹åŠ¡æ˜¯ç‹¬ç«‹çš„
      </strong>
      ï¼Œå³ä½¿å†…å±‚å›æ»šï¼Œå¤–å±‚ä¸ä¼šå—å½±å“ã€‚
     </li>
     <li>
      æ‰€ä»¥
      <strong>
       <code>
        Outer
       </code>
       æ•°æ®ä»ç„¶ä¼šè¢«æäº¤ï¼
      </strong>
     </li>
    </ul>
    <h4>
     âœ…
     <strong>
      è§£å†³æ–¹æ¡ˆï¼š
     </strong>
    </h4>
    <ul>
     <li>
      å¦‚æœä½ æœŸæœ›äº‹åŠ¡ç»Ÿä¸€å›æ»šï¼Œæ”¹æˆé»˜è®¤çš„
      <code>
       Propagation.REQUIRED
      </code>
      ï¼š
     </li>
    </ul>
    <pre><code class="language-java">@Transactional(propagation = Propagation.REQUIRED)
public void innerMethod() {
    userRepository.save(new User("Inner"));
    throw new RuntimeException("Test rollback");
}</code></pre>
    <ul>
     <li>
      å¦‚æœä½ æƒ³å®ç°åµŒå¥—äº‹åŠ¡ï¼Œå¯ä»¥è€ƒè™‘
      <strong>
       <code>
        NESTED
       </code>
       ä¼ æ’­æœºåˆ¶
      </strong>
      ï¼š
     </li>
    </ul>
    <h3>
     âœ…
     <strong>
      9ï¸âƒ£ äº‹åŠ¡ç®¡ç†å™¨é…ç½®é”™è¯¯
     </strong>
    </h3>
    <h4>
     <strong>
      é—®é¢˜å¤ç°ï¼š
     </strong>
    </h4>
    <p>
     å½“ä½ ä½¿ç”¨äº†å¤šä¸ªæ•°æ®æºæ—¶ï¼Œå¦‚æœäº‹åŠ¡ç®¡ç†å™¨æ²¡æœ‰æ­£ç¡®é…ç½®ï¼Œä¹Ÿä¼šé€ æˆäº‹åŠ¡å¤±æ•ˆï¼š
    </p>
    <pre><code class="language-java">@Bean
public PlatformTransactionManager transactionManager(DataSource dataSource) {
    return new DataSourceTransactionManager(dataSource);
}</code></pre>
    <h4>
     <strong>
      ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ
     </strong>
    </h4>
    <ul>
     <li>
      å¦‚æœä½ çš„æ•°æ®æºå’Œäº‹åŠ¡ç®¡ç†å™¨ä¸åŒ¹é…ï¼Œæ¯”å¦‚æœ‰å¤šä¸ªæ•°æ®æºï¼Œä½†äº‹åŠ¡ç®¡ç†å™¨åªç»‘å®šäº†ä¸€ä¸ªæ•°æ®æºï¼Œ
      <br/>
      <strong>
       å…¶ä»–æ•°æ®æºçš„äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆ
      </strong>
      ã€‚
     </li>
     <li>
      <strong>
       æ²¡æœ‰å£°æ˜äº‹åŠ¡ç®¡ç†å™¨
      </strong>
      æ—¶ï¼ŒSpring ä¼šä½¿ç”¨
      <strong>
       é»˜è®¤äº‹åŠ¡ç®¡ç†å™¨
      </strong>
      ï¼Œå¯èƒ½ä¸æ˜¯ä½ æƒ³è¦çš„é‚£ä¸ªã€‚
     </li>
    </ul>
    <h4>
     âœ…
     <strong>
      è§£å†³æ–¹æ¡ˆï¼š
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨ï¼š
      </strong>
     </li>
    </ul>
    <pre><code class="language-java">@Transactional(transactionManager = "transactionManager")</code></pre>
    <ul>
     <li>
      <strong>
       å¤šæ•°æ®æºäº‹åŠ¡ç®¡ç†å™¨é…ç½®ï¼š
      </strong>
     </li>
    </ul>
    <pre><code class="language-java">@Bean("transactionManager1")
public PlatformTransactionManager transactionManager1(@Qualifier("dataSource1") DataSource dataSource) {
    return new DataSourceTransactionManager(dataSource);
}

@Bean("transactionManager2")
public PlatformTransactionManager transactionManager2(@Qualifier("dataSource2") DataSource dataSource) {
    return new DataSourceTransactionManager(dataSource);
}</code></pre>
    <h3>
     âœ…
     <strong>
      ğŸ”Ÿ è¢«ä»£ç†ç±»ä¸æ˜¯ Spring ç®¡ç†çš„ Bean
     </strong>
    </h3>
    <h4>
     <strong>
      é—®é¢˜å¤ç°ï¼š
     </strong>
    </h4>
    <pre><code class="language-java">public class UserService {

    @Autowired
    private UserRepository userRepository;

    @Transactional
    public void addUser() {
        userRepository.save(new User("User"));
        throw new RuntimeException("Test rollback");
    }
}</code></pre>
    <p>
     <strong>
      è°ƒç”¨ï¼š
     </strong>
    </p>
    <pre><code class="language-java">UserService userService = new UserService();
userService.addUser(); // ğŸš¨äº‹åŠ¡å¤±æ•ˆ</code></pre>
    <h4>
     <strong>
      ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       Spring äº‹åŠ¡ä¾èµ–äº AOP ä»£ç†
      </strong>
      ï¼Œåªæœ‰è¢« Spring æ‰˜ç®¡çš„ Bean æ‰ä¼šå¯ç”¨ä»£ç†æœºåˆ¶ã€‚
     </li>
     <li>
      <strong>
       æ‰‹åŠ¨ new å¯¹è±¡ä¸ä¼šè§¦å‘äº‹åŠ¡æœºåˆ¶
      </strong>
      ã€‚
     </li>
    </ul>
    <h4>
     âœ…
     <strong>
      è§£å†³æ–¹æ¡ˆï¼š
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       è®© Spring æ‰˜ç®¡ Beanï¼š
      </strong>
     </li>
    </ul>
    <pre><code class="language-java">@Service
public class UserService {
    ...
}</code></pre>
    <ul>
     <li>
      <strong>
       ä½¿ç”¨
       <code>
        ApplicationContext
       </code>
       è·å–ä»£ç†å¯¹è±¡ï¼š
      </strong>
     </li>
    </ul>
    <pre><code class="language-java">@Autowired
private ApplicationContext applicationContext;

public void addUser() {
    UserService proxy = applicationContext.getBean(UserService.class);
    proxy.addUser(); // ğŸš€äº‹åŠ¡ç”Ÿæ•ˆ
}</code></pre>
    <h3>
     âœ…
     <strong>
      1ï¸âƒ£1ï¸âƒ£ SpringBoot çš„
      <code>
       @EnableTransactionManagement
      </code>
      æœªç”Ÿæ•ˆ
     </strong>
    </h3>
    <h4>
     <strong>
      é—®é¢˜å¤ç°ï¼š
     </strong>
    </h4>
    <p>
     å¦‚æœä½ åœ¨é¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯ SpringBootï¼Œä½†æ˜¯
     <code>
      @Transactional
     </code>
     å´å®Œå…¨æ²¡ååº”ï¼Œ
     <br/>
     å¯èƒ½æ˜¯å› ä¸ºäº‹åŠ¡ç®¡ç†å™¨æ²¡æœ‰å¯ç”¨ï¼
    </p>
    <h4>
     <strong>
      ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ
     </strong>
    </h4>
    <ul>
     <li>
      SpringBoot é»˜è®¤å¼€å¯äº‹åŠ¡ç®¡ç†ï¼ˆè‡ªåŠ¨é…ç½®ï¼‰ï¼Œä½†å¦‚æœä½ è‡ªå·±åˆ›å»ºäº†é…ç½®ç±»ï¼Œå¹¶å…³é—­äº†è‡ªåŠ¨é…ç½®ï¼Œå°±å¯èƒ½å¯¼è‡´äº‹åŠ¡å¤±æ•ˆã€‚
     </li>
    </ul>
    <h4>
     âœ…
     <strong>
      è§£å†³æ–¹æ¡ˆï¼š
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       æ˜¾å¼å¼€å¯äº‹åŠ¡ç®¡ç†å™¨ï¼š
      </strong>
     </li>
    </ul>
    <pre><code class="language-java">@Configuration
@EnableTransactionManagement
public class TransactionConfig {
}</code></pre>
    <ul>
     <li>
      <strong>
       ç¡®è®¤äº‹åŠ¡ç®¡ç†å™¨æ˜¯å¦ç”Ÿæ•ˆï¼š
      </strong>
     </li>
    </ul>
    <pre><code class="language-java">@Autowired
private PlatformTransactionManager transactionManager;

@PostConstruct
public void checkTransactionManager() {
    System.out.println("Transaction Manager: " + transactionManager);
}</code></pre>
    <h3>
     âœ…
     <strong>
      1ï¸âƒ£2ï¸âƒ£ æ•°æ®åº“æœ¬èº«çš„é—®é¢˜
     </strong>
    </h3>
    <p>
     æœ€åï¼Œæœ‰æ—¶å€™
     <strong>
      ä¸æ˜¯ä»£ç é—®é¢˜
     </strong>
     ï¼Œè€Œæ˜¯
     <strong>
      æ•°æ®åº“å±‚é¢çš„é…ç½®é—®é¢˜
     </strong>
     å¯¼è‡´äº‹åŠ¡å¤±æ•ˆï¼š
    </p>
    <ul>
     <li>
      <p>
       <strong>
        æ•°æ®åº“æƒé™ä¸è¶³
       </strong>
       ï¼š
       <br/>
       å¦‚æœæ•°æ®åº“ç”¨æˆ·æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œ
       <code>
        ROLLBACK
       </code>
       æ“ä½œï¼Œä¹Ÿä¼šè®©äº‹åŠ¡æ— æ³•å›æ»šã€‚
      </p>
     </li>
     <li>
      <p>
       <strong>
        è§¦å‘å™¨ (Trigger)
       </strong>
       ï¼š
       <br/>
       å¦‚æœè¡¨æœ‰è§¦å‘å™¨ï¼Œä¼šå¯¼è‡´æŸäº›æ•°æ®åœ¨è§¦å‘å™¨æ‰§è¡Œåç›´æ¥æäº¤ï¼Œç»•è¿‡äº‹åŠ¡ç®¡ç†ã€‚
      </p>
     </li>
    </ul>
    <p>
    </p>
    <h3>
     ğŸ¯
     <strong>
      æ€»ç»“ï¼šäº‹åŠ¡å¤±æ•ˆåœºæ™¯å¤§å…¨
     </strong>
    </h3>
    <table>
     <thead>
      <tr>
       <th>
        äº‹åŠ¡å¤±æ•ˆåœºæ™¯
       </th>
       <th>
        å¤±æ•ˆåŸå› 
       </th>
       <th>
        è§£å†³æ–¹æ¡ˆ
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        åŒç±»æ–¹æ³•è°ƒç”¨
       </td>
       <td>
        æ²¡æœ‰ä»£ç†
       </td>
       <td>
        é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨
       </td>
      </tr>
      <tr>
       <td>
        é public æ–¹æ³•
       </td>
       <td>
        åªæœ‰ public æ–¹æ³•æ‰ä¼šè¢«ä»£ç†
       </td>
       <td>
        æ”¹ä¸º public
       </td>
      </tr>
      <tr>
       <td>
        æ•°æ®åº“å¼•æ“ä¸æ”¯æŒäº‹åŠ¡
       </td>
       <td>
        ä½¿ç”¨ MyISAM è€Œä¸æ˜¯ InnoDB
       </td>
       <td>
        ä¿®æ”¹ä¸º InnoDB
       </td>
      </tr>
      <tr>
       <td>
        å¼‚å¸¸è¢«æ•è·
       </td>
       <td>
        Spring é»˜è®¤åªå›æ»š RuntimeException
       </td>
       <td>
        æ˜¾å¼æŒ‡å®š rollbackFor
       </td>
      </tr>
      <tr>
       <td>
        å¤šçº¿ç¨‹è°ƒç”¨
       </td>
       <td>
        æ–°çº¿ç¨‹ä¸ä¼šç»§æ‰¿åŸçº¿ç¨‹çš„äº‹åŠ¡
       </td>
       <td>
        ä½¿ç”¨ @Async ç»“åˆäº‹åŠ¡
       </td>
      </tr>
      <tr>
       <td>
        è‡ªåŠ¨æäº¤æœªå…³é—­
       </td>
       <td>
        æ•°æ®æº autoCommit=true
       </td>
       <td>
        å…³é—­è‡ªåŠ¨æäº¤
       </td>
      </tr>
      <tr>
       <td>
        ä»£ç†å¯¹è±¡è¢«ç»•è¿‡
       </td>
       <td>
        this è°ƒç”¨è‡ªèº«æ–¹æ³•
       </td>
       <td>
        ä½¿ç”¨ä»£ç†å¯¹è±¡è°ƒç”¨
       </td>
      </tr>
      <tr>
       <td>
        åµŒå¥—äº‹åŠ¡ä¼ æ’­æœºåˆ¶è®¾ç½®ä¸å½“
       </td>
       <td>
        REQUIRES_NEW å¯¼è‡´äº‹åŠ¡éš”ç¦»
       </td>
       <td>
        ä½¿ç”¨ NESTED æˆ– REQUIRED
       </td>
      </tr>
      <tr>
       <td>
        äº‹åŠ¡ç®¡ç†å™¨é…ç½®é”™è¯¯
       </td>
       <td>
        æ•°æ®æºå’Œäº‹åŠ¡ç®¡ç†å™¨ä¸åŒ¹é…
       </td>
       <td>
        ç¡®ä¿äº‹åŠ¡ç®¡ç†å™¨æ­£ç¡®ç»‘å®šæ•°æ®æº
       </td>
      </tr>
      <tr>
       <td>
        Bean é Spring æ‰˜ç®¡
       </td>
       <td>
        new å¯¹è±¡ä¸ä¼šè§¦å‘ä»£ç†æœºåˆ¶
       </td>
       <td>
        è®© Spring æ‰˜ç®¡ Bean
       </td>
      </tr>
      <tr>
       <td>
        @EnableTransactionManagement æœªå¼€å¯
       </td>
       <td>
        æ²¡æœ‰å¯ç”¨äº‹åŠ¡ç®¡ç†å™¨
       </td>
       <td>
        æ˜¾å¼å¼€å¯äº‹åŠ¡ç®¡ç†å™¨
       </td>
      </tr>
      <tr>
       <td>
        æ•°æ®åº“å±‚é¢é—®é¢˜
       </td>
       <td>
        MySQL è§¦å‘å™¨æˆ–æƒé™é—®é¢˜
       </td>
       <td>
        æ£€æŸ¥æ•°æ®åº“é…ç½®
       </td>
      </tr>
     </tbody>
    </table>
    <p>
    </p>
    <p>
     âœ¨
     <strong>
      æ€è€ƒé¢˜ï¼š
     </strong>
    </p>
    <ol>
     <li>
      å¦‚ä½•åœ¨åŒä¸€ç±»æ–¹æ³•è°ƒç”¨æ—¶ï¼Œç¡®ä¿äº‹åŠ¡èƒ½å¤Ÿç”Ÿæ•ˆï¼Ÿ
     </li>
     <li>
      ä¸ºä»€ä¹ˆæ•è·å¼‚å¸¸åäº‹åŠ¡ä¸ä¼šå›æ»šï¼Ÿ
     </li>
     <li>
      äº‹åŠ¡å’Œçº¿ç¨‹ä¹‹é—´çš„å…³ç³»æ˜¯æ€æ ·çš„ï¼Ÿ
     </li>
    </ol>
    <p>
    </p>
    <p>
     å¦‚æœè§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè®°å¾—ç‚¹èµâ­ã€æ”¶è—ğŸ“Œã€å…³æ³¨ğŸš€ï¼
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34353237373036382f:61727469636c652f64657461696c732f313436313435373531" class_="artid" style="display:none">
 </p>
</div>


