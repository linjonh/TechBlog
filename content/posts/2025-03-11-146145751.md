---
arturl_encode: "68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34353237373036382f:61727469636c652f64657461696c732f313436313435373531"
layout: post
title: "Javaå®ç”¨æ³¨è§£ç¯‡Transactional-äº‹åŠ¡å¤±æ•ˆçš„åœºæ™¯æ·±åº¦è§£æ"
date: 2025-03-11 08:59:06 +0800
description: "åœ¨ä½¿ç”¨æ˜æ˜åŠ äº†äº‹åŠ¡æ³¨è§£ï¼Œä½†äº‹åŠ¡å´æ²¡æœ‰ç”Ÿæ•ˆï¼Œæ•°æ®åº“æ“ä½œä»ç„¶è¢«æäº¤äº†ï¼è¿™æ˜¯å› ä¸ºäº‹åŠ¡æœºåˆ¶çš„è§¦å‘æœ‰ä¸€äº›å‰ææ¡ä»¶ï¼Œåªè¦è§¦ç¢°åˆ°äº‹åŠ¡å¤±æ•ˆçš„â€œé›·åŒºâ€ï¼Œå°±ä¼šè®©äº‹åŠ¡å˜æˆâ€œæ‘†è®¾â€ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†å‰–æå‡ ç§å¸¸è§çš„äº‹åŠ¡å¤±æ•ˆåœºæ™¯ä»¥åŠè§£å†³æ–¹æ¡ˆï¼"
keywords: "Javaå®ç”¨æ³¨è§£ç¯‡ï¼š@Transactional äº‹åŠ¡å¤±æ•ˆçš„åœºæ™¯æ·±åº¦è§£æ"
categories: ['æœªåˆ†ç±»']
tags: ['æ•°æ®åº“', 'å¼€å‘è¯­è¨€', 'Java']
artid: "146145751"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146145751
    alt: "Javaå®ç”¨æ³¨è§£ç¯‡Transactional-äº‹åŠ¡å¤±æ•ˆçš„åœºæ™¯æ·±åº¦è§£æ"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146145751
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146145751
cover: https://bing.ee123.net/img/rand?artid=146145751
image: https://bing.ee123.net/img/rand?artid=146145751
img: https://bing.ee123.net/img/rand?artid=146145751
---

# Javaå®ç”¨æ³¨è§£ç¯‡ï¼š@Transactional äº‹åŠ¡å¤±æ•ˆçš„åœºæ™¯æ·±åº¦è§£æ

### å‰è¨€

åœ¨ä½¿ç”¨
`@Transactional`
æ—¶ï¼Œå¾ˆå¤šå¼€å‘è€…éƒ½ä¼šé‡åˆ°ä¸€ä¸ªå¸¸è§å›°æƒ‘ï¼š
**æ˜æ˜åŠ äº†äº‹åŠ¡æ³¨è§£ï¼Œä½†äº‹åŠ¡å´æ²¡æœ‰ç”Ÿæ•ˆï¼Œæ•°æ®åº“æ“ä½œä»ç„¶è¢«æäº¤äº†ï¼**
  
è¿™æ˜¯å› ä¸ºäº‹åŠ¡æœºåˆ¶çš„è§¦å‘æœ‰ä¸€äº›
**å‰ææ¡ä»¶**
ï¼Œåªè¦è§¦ç¢°åˆ°äº‹åŠ¡å¤±æ•ˆçš„â€œé›·åŒºâ€ï¼Œå°±ä¼šè®©äº‹åŠ¡å˜æˆâ€œæ‘†è®¾â€ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ¥è¯¦ç»†å‰–æå‡ ç§å¸¸è§çš„
**äº‹åŠ¡å¤±æ•ˆåœºæ™¯**
ä»¥åŠ
**è§£å†³æ–¹æ¡ˆ**
ï¼

### âœ… **1ï¸âƒ£ åŒä¸€ä¸ªç±»ä¸­æ–¹æ³•ç›´æ¥è°ƒç”¨ï¼Œäº‹åŠ¡å¤±æ•ˆ**

#### **é—®é¢˜å¤ç°ï¼š**

```java
@Service
public class UserService {

    @Autowired
    private UserRepository userRepository;

    @Transactional
    public void methodA() {
        userRepository.save(new User("UserA"));
        methodB(); // å†…éƒ¨è°ƒç”¨ï¼Œä¸è§¦å‘äº‹åŠ¡
    }

    @Transactional
    public void methodB() {
        userRepository.save(new User("UserB"));
        throw new RuntimeException("Test rollback"); // æœŸæœ›å›æ»š
    }
}
```

#### **æ‰§è¡Œç»“æœï¼š**

* **UserA ä¼šè¢«æ’å…¥æ•°æ®åº“**
* **UserB æ²¡æœ‰æ’å…¥ï¼Œå› ä¸ºæŠ›å‡ºäº†å¼‚å¸¸**
* ğŸš¨
  **äº‹åŠ¡æ²¡æœ‰å›æ»šï¼**

#### **ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ**

Spring çš„äº‹åŠ¡æ˜¯åŸºäº
**AOP ä»£ç†æœºåˆ¶**
å®ç°çš„ï¼Œè€Œä»£ç†å¯¹è±¡åªæœ‰åœ¨
**å¤–éƒ¨è°ƒç”¨**
æ—¶æ‰ä¼šè§¦å‘æ‹¦æˆªå™¨é€»è¾‘ï¼Œä»è€Œå¼€å¯äº‹åŠ¡ã€‚
  
**åŒä¸€ä¸ªç±»å†…çš„æ–¹æ³•è°ƒç”¨ä¸ä¼šç»è¿‡ä»£ç†å¯¹è±¡ï¼Œè€Œæ˜¯é€šè¿‡
`this.methodB()`
è°ƒç”¨çš„ï¼Œå› æ­¤ä¸ä¼šè§¦å‘äº‹åŠ¡æœºåˆ¶ï¼**

#### 

#### âœ… **è§£å†³æ–¹æ¡ˆï¼š**

**æ–¹æ¡ˆä¸€ï¼šé€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨äº‹åŠ¡æ–¹æ³•**

```java
@Autowired
private UserService userService;

@Transactional
public void methodA() {
    userRepository.save(new User("UserA"));
    userService.methodB(); // é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨ï¼Œè§¦å‘äº‹åŠ¡
}

```

**æ–¹æ¡ˆäºŒï¼šä½¿ç”¨
`AopContext`
è·å–å½“å‰ä»£ç†å¯¹è±¡**

Spring æä¾›äº†
`AopContext`
å·¥å…·ç±»ï¼Œå¯ä»¥è·å–å½“å‰ä»£ç†å¯¹è±¡ï¼š

```java
import org.springframework.aop.framework.AopContext;

@Transactional
public void methodA() {
    userRepository.save(new User("UserA"));
    ((UserService) AopContext.currentProxy()).methodB();
}
```

**æ³¨æ„ï¼š**

* éœ€è¦åœ¨é…ç½®ç±»ä¸­å¼€å¯
  **æš´éœ²ä»£ç†å¯¹è±¡åŠŸèƒ½**
  æ‰èƒ½ä½¿ç”¨
  `AopContext`
  ï¼š

```java
@EnableAspectJAutoProxy(exposeProxy = true)
```

### âœ… **2ï¸âƒ£ é `public` æ–¹æ³•ä¸Šçš„ @Transactional æ³¨è§£æ— æ•ˆ**

#### **é—®é¢˜å¤ç°ï¼š**

```java
@Service
public class UserService {

    @Autowired
    private UserRepository userRepository;

    @Transactional
    private void addUser() {
        userRepository.save(new User("PrivateUser"));
        throw new RuntimeException("Test rollback");
    }
}
```

#### **æ‰§è¡Œç»“æœï¼š**

* æ•°æ®æˆåŠŸæ’å…¥ï¼Œäº‹åŠ¡
  **æ²¡æœ‰å›æ»š**
  ï¼

#### **ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ**

Spring çš„äº‹åŠ¡æ˜¯åŸºäº
**åŠ¨æ€ä»£ç†æœºåˆ¶**
ï¼Œåªæœ‰
**`public`
æ–¹æ³•**
æ‰ä¼šè¢«ä»£ç†ï¼Œ
**`private`
ã€
`protected`
ã€
`default`
ä¿®é¥°çš„æ–¹æ³•ä¸ä¼šè¢«ä»£ç†**
ï¼Œå› æ­¤ä¸ä¼šè§¦å‘äº‹åŠ¡æœºåˆ¶ã€‚

#### âœ… **è§£å†³æ–¹æ¡ˆï¼š**

**æ”¹ä¸º
`public`
æ–¹æ³•ï¼š**

```java
@Transactional
public void addUser() {
    userRepository.save(new User("PublicUser"));
    throw new RuntimeException("Test rollback");
}
```

### âœ… **3ï¸âƒ£ æ•°æ®åº“å¼•æ“ä¸æ”¯æŒäº‹åŠ¡**

#### **é—®é¢˜å¤ç°ï¼š**

å¦‚æœä½ çš„æ•°æ®åº“è¡¨ä½¿ç”¨çš„æ˜¯ MySQL çš„
**MyISAM å¼•æ“**
è€Œä¸æ˜¯
**InnoDB**
ï¼Œäº‹åŠ¡æœºåˆ¶æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ï¼

**æ£€æŸ¥è¡¨å¼•æ“ï¼š**

```java
SHOW TABLE STATUS WHERE Name = 'your_table';
```

å¦‚æœçœ‹åˆ°
**`Engine=MyISAM`**
ï¼š

```java
+------------+--------+ ...
| Name       | Engine | ...
+------------+--------+ ...
| user_table | MyISAM | ...
+------------+--------+ ...
```

#### **ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ**

* **MyISAM**
  æ˜¯ MySQL çš„æ—©æœŸå­˜å‚¨å¼•æ“ï¼Œä¸æ”¯æŒäº‹åŠ¡å›æ»šã€å¤–é”®ç­‰ç‰¹æ€§ã€‚
* **InnoDB**
  æ‰æ˜¯æ”¯æŒäº‹åŠ¡ã€è¡Œçº§é”ç­‰åŠŸèƒ½çš„å­˜å‚¨å¼•æ“ã€‚

#### âœ… **è§£å†³æ–¹æ¡ˆï¼š**

**æŠŠè¡¨å¼•æ“æ”¹ä¸º InnoDBï¼š**

```java
ALTER TABLE your_table ENGINE=InnoDB;
```

**æŸ¥çœ‹æ‰€æœ‰ MyISAM è¡¨ï¼š**

```java
SELECT table_schema, table_name, engine
FROM information_schema.tables
WHERE engine = 'MyISAM';
```

### âœ… **4ï¸âƒ£ æ•è·äº†å¼‚å¸¸ï¼Œå¯¼è‡´äº‹åŠ¡æ— æ³•å›æ»š**

#### **é—®é¢˜å¤ç°ï¼š**

```java
@Transactional
public void addUser() {
    try {
        userRepository.save(new User("TryCatchUser"));
        int result = 1 / 0; // æŠ›å‡º ArithmeticException
    } catch (Exception e) {
        // å¼‚å¸¸è¢«æ•è·
        System.out.println("Exception caught: " + e.getMessage());
    }
}
```

#### **æ‰§è¡Œç»“æœï¼š**

* æ•°æ®è¢«æ’å…¥
* ğŸš¨
  **äº‹åŠ¡æ²¡æœ‰å›æ»šï¼**

#### **ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ**

* Spring é»˜è®¤åªæœ‰
  **æœªæ•è·çš„è¿è¡Œæ—¶å¼‚å¸¸**
  ï¼ˆç»§æ‰¿è‡ª
  `RuntimeException`
  ï¼‰æ‰ä¼šè§¦å‘å›æ»šã€‚
* **å—æ£€å¼‚å¸¸**
  ï¼ˆå¦‚
  `IOException`
  ï¼‰æˆ–è€…
  **è¢«æ•è·çš„å¼‚å¸¸**
  ä¸ä¼šè§¦å‘äº‹åŠ¡å›æ»šï¼

#### âœ… **è§£å†³æ–¹æ¡ˆï¼š**

**æ–¹æ¡ˆä¸€ï¼šæ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œè®© Spring æ„ŸçŸ¥åˆ°äº‹åŠ¡éœ€è¦å›æ»šï¼š**

```java
@Transactional
public void addUser() {
    try {
        userRepository.save(new User("User"));
        int result = 1 / 0;
    } catch (Exception e) {
        throw new RuntimeException(e); // æŠ›å‡ºè¿è¡Œæ—¶å¼‚å¸¸è§¦å‘å›æ»š
    }
}
```

**æ–¹æ¡ˆäºŒï¼šä½¿ç”¨
`rollbackFor`
æ˜ç¡®æŒ‡å®šå“ªäº›å¼‚å¸¸è§¦å‘å›æ»šï¼š**

```java
@Transactional(rollbackFor = Exception.class)
public void addUser() {
    try {
        userRepository.save(new User("User"));
        int result = 1 / 0;
    } catch (Exception e) {
        // å¼‚å¸¸ä¾ç„¶è¢«æ•è·ï¼Œä½†äº‹åŠ¡ä»ç„¶ä¼šå›æ»š
        System.out.println("Caught exception, but rollback still happens!");
    }
}
```

### âœ… **5ï¸âƒ£ å¤šçº¿ç¨‹ç¯å¢ƒä¸‹äº‹åŠ¡å¤±æ•ˆ**

#### **é—®é¢˜å¤ç°ï¼š**

```java
@Transactional
public void addUser() {
    new Thread(() -> {
        userRepository.save(new User("AsyncUser"));
        throw new RuntimeException("Test rollback");
    }).start();
}
```

#### **æ‰§è¡Œç»“æœï¼š**

* æ•°æ®è¢«æ’å…¥
* ğŸš¨
  **äº‹åŠ¡æ²¡æœ‰å›æ»šï¼**

#### **ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ**

Spring çš„äº‹åŠ¡æ˜¯
**çº¿ç¨‹ç»‘å®šçš„**
ï¼ˆåŸºäº
`ThreadLocal`
å®ç°ï¼‰ï¼Œ
  
**æ–°çº¿ç¨‹ä¸ä¼šç»§æ‰¿åŸçº¿ç¨‹çš„äº‹åŠ¡ä¸Šä¸‹æ–‡**
ï¼Œå› æ­¤æ–°çº¿ç¨‹æ— æ³•æ„ŸçŸ¥åˆ°åŸçº¿ç¨‹çš„äº‹åŠ¡è¾¹ç•Œã€‚

#### âœ… **è§£å†³æ–¹æ¡ˆï¼š**

**ä½¿ç”¨
`@Async`
é…åˆäº‹åŠ¡ï¼š**

```java
@Service
public class UserService {

    @Autowired
    private UserRepository userRepository;

    @Async
    @Transactional
    public void addUserAsync() {
        userRepository.save(new User("AsyncUser"));
        throw new RuntimeException("Test rollback");
    }
}
```

**æ³¨æ„ï¼š**

* éœ€è¦åœ¨å¯åŠ¨ç±»ä¸ŠåŠ ä¸Š
  **`@EnableAsync`**
  ï¼š

```java
@SpringBootApplication
@EnableAsync
public class Application {
}
```

### âœ… **6ï¸âƒ£ æ•°æ®åº“è¿æ¥çš„è‡ªåŠ¨æäº¤æœªå…³é—­**

#### **é—®é¢˜å¤ç°ï¼š**

å¦‚æœä½ çš„æ•°æ®åº“è¿æ¥æ± é…ç½®äº†
**è‡ªåŠ¨æäº¤**
ï¼Œé‚£ä¹ˆäº‹åŠ¡æ§åˆ¶ä¼šè¢«ç»•è¿‡ï¼

**å¯èƒ½çš„é…ç½®ï¼š**

```java
spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/test_db
    username: root
    password: 123456
    hikari:
      auto-commit: true  # ğŸš¨è‡ªåŠ¨æäº¤ä¸ºtrue
```

#### **ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ**

* Spring äº‹åŠ¡ä¼šé€šè¿‡
  **DataSource**
  è·å–è¿æ¥ï¼Œå¦‚æœè¿æ¥çš„
  `autoCommit=true`
  ï¼Œæ¯æ¬¡ SQL æ‰§è¡Œéƒ½ä¼šç«‹åˆ»æäº¤ã€‚
* **äº‹åŠ¡æ³¨è§£æ§åˆ¶çš„æäº¤/å›æ»šè¡Œä¸ºè¢«ç»•è¿‡**
  ã€‚

#### âœ… **è§£å†³æ–¹æ¡ˆï¼š**

* **ç¡®ä¿æ•°æ®åº“è¿æ¥æ± å…³é—­è‡ªåŠ¨æäº¤**
  ï¼š

```java
spring:
  datasource:
    hikari:
      auto-commit: false
```

* æˆ–è€…æ‰‹åŠ¨å…³é—­è‡ªåŠ¨æäº¤ï¼š

```java
Connection conn = dataSource.getConnection();
conn.setAutoCommit(false);
```

### âœ… **7ï¸âƒ£ ä»£ç†å¯¹è±¡è¢«ç»•è¿‡ï¼ˆæ¯”å¦‚ä½¿ç”¨ this å…³é”®å­—ï¼‰**

#### **é—®é¢˜å¤ç°ï¼š**

```java
@Service
public class UserService {

    @Autowired
    private UserRepository userRepository;

    @Transactional
    public void outerMethod() {
        userRepository.save(new User("OuterMethod"));
        this.innerMethod(); // ğŸš¨ä¸ä¼šè§¦å‘äº‹åŠ¡
    }

    @Transactional
    public void innerMethod() {
        userRepository.save(new User("InnerMethod"));
        throw new RuntimeException("Test rollback");
    }
}
```

#### **ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ**

* **Spring çš„äº‹åŠ¡æ˜¯åŸºäºä»£ç†å¯¹è±¡å®ç°çš„**
  ï¼Œ
  `this.innerMethod()`
  æ˜¯ç›´æ¥è°ƒç”¨è‡ªèº«æ–¹æ³•ï¼Œç»•è¿‡äº†ä»£ç†å¯¹è±¡ã€‚
* **äº‹åŠ¡æ‹¦æˆªå™¨ä¸ä¼šç”Ÿæ•ˆ**
  ï¼Œå› æ­¤å†…éƒ¨æ–¹æ³•ä¸ä¼šèµ°äº‹åŠ¡é€»è¾‘ã€‚

#### âœ… **è§£å†³æ–¹æ¡ˆï¼š**

* **é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨äº‹åŠ¡æ–¹æ³•ï¼š**

```java
@Autowired
private UserService userService;

public void outerMethod() {
    userRepository.save(new User("OuterMethod"));
    userService.innerMethod(); // ğŸš€è§¦å‘äº‹åŠ¡
}
```

### âœ… **8ï¸âƒ£ åµŒå¥—äº‹åŠ¡è®¾ç½®ä¸å½“**

#### **é—®é¢˜å¤ç°ï¼š**

å½“ä½ æœ‰åµŒå¥—äº‹åŠ¡æ—¶ï¼Œå¦‚æœ
**ä¼ æ’­æœºåˆ¶ï¼ˆPropagationï¼‰**
é…ç½®ä¸å½“ï¼Œä¹Ÿå¯èƒ½é€ æˆäº‹åŠ¡å¤±æ•ˆã€‚

**ä¾‹å¦‚ï¼š**

```java
@Transactional
public void outerMethod() {
    userRepository.save(new User("Outer"));
    innerMethod();
}

@Transactional(propagation = Propagation.REQUIRES_NEW)
public void innerMethod() {
    userRepository.save(new User("Inner"));
    throw new RuntimeException("Test rollback");
}
```

#### **ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ**

```java
@Transactional(propagation = Propagation.NESTED)
```

* **`Propagation.REQUIRES_NEW`**
  è¡¨ç¤ºå¼€å¯ä¸€ä¸ªæ–°çš„äº‹åŠ¡ï¼Œ
    
  **å¤–å±‚äº‹åŠ¡å’Œå†…å±‚äº‹åŠ¡æ˜¯ç‹¬ç«‹çš„**
  ï¼Œå³ä½¿å†…å±‚å›æ»šï¼Œå¤–å±‚ä¸ä¼šå—å½±å“ã€‚
* æ‰€ä»¥
  **`Outer`
  æ•°æ®ä»ç„¶ä¼šè¢«æäº¤ï¼**

#### âœ… **è§£å†³æ–¹æ¡ˆï¼š**

* å¦‚æœä½ æœŸæœ›äº‹åŠ¡ç»Ÿä¸€å›æ»šï¼Œæ”¹æˆé»˜è®¤çš„
  `Propagation.REQUIRED`
  ï¼š

```java
@Transactional(propagation = Propagation.REQUIRED)
public void innerMethod() {
    userRepository.save(new User("Inner"));
    throw new RuntimeException("Test rollback");
}
```

* å¦‚æœä½ æƒ³å®ç°åµŒå¥—äº‹åŠ¡ï¼Œå¯ä»¥è€ƒè™‘
  **`NESTED`
  ä¼ æ’­æœºåˆ¶**
  ï¼š

### âœ… **9ï¸âƒ£ äº‹åŠ¡ç®¡ç†å™¨é…ç½®é”™è¯¯**

#### **é—®é¢˜å¤ç°ï¼š**

å½“ä½ ä½¿ç”¨äº†å¤šä¸ªæ•°æ®æºæ—¶ï¼Œå¦‚æœäº‹åŠ¡ç®¡ç†å™¨æ²¡æœ‰æ­£ç¡®é…ç½®ï¼Œä¹Ÿä¼šé€ æˆäº‹åŠ¡å¤±æ•ˆï¼š

```java
@Bean
public PlatformTransactionManager transactionManager(DataSource dataSource) {
    return new DataSourceTransactionManager(dataSource);
}
```

#### **ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ**

* å¦‚æœä½ çš„æ•°æ®æºå’Œäº‹åŠ¡ç®¡ç†å™¨ä¸åŒ¹é…ï¼Œæ¯”å¦‚æœ‰å¤šä¸ªæ•°æ®æºï¼Œä½†äº‹åŠ¡ç®¡ç†å™¨åªç»‘å®šäº†ä¸€ä¸ªæ•°æ®æºï¼Œ
    
  **å…¶ä»–æ•°æ®æºçš„äº‹åŠ¡ä¸ä¼šç”Ÿæ•ˆ**
  ã€‚
* **æ²¡æœ‰å£°æ˜äº‹åŠ¡ç®¡ç†å™¨**
  æ—¶ï¼ŒSpring ä¼šä½¿ç”¨
  **é»˜è®¤äº‹åŠ¡ç®¡ç†å™¨**
  ï¼Œå¯èƒ½ä¸æ˜¯ä½ æƒ³è¦çš„é‚£ä¸ªã€‚

#### âœ… **è§£å†³æ–¹æ¡ˆï¼š**

* **æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨ï¼š**

```java
@Transactional(transactionManager = "transactionManager")
```

* **å¤šæ•°æ®æºäº‹åŠ¡ç®¡ç†å™¨é…ç½®ï¼š**

```java
@Bean("transactionManager1")
public PlatformTransactionManager transactionManager1(@Qualifier("dataSource1") DataSource dataSource) {
    return new DataSourceTransactionManager(dataSource);
}

@Bean("transactionManager2")
public PlatformTransactionManager transactionManager2(@Qualifier("dataSource2") DataSource dataSource) {
    return new DataSourceTransactionManager(dataSource);
}
```

### âœ… **ğŸ”Ÿ è¢«ä»£ç†ç±»ä¸æ˜¯ Spring ç®¡ç†çš„ Bean**

#### **é—®é¢˜å¤ç°ï¼š**

```java
public class UserService {

    @Autowired
    private UserRepository userRepository;

    @Transactional
    public void addUser() {
        userRepository.save(new User("User"));
        throw new RuntimeException("Test rollback");
    }
}
```

**è°ƒç”¨ï¼š**

```java
UserService userService = new UserService();
userService.addUser(); // ğŸš¨äº‹åŠ¡å¤±æ•ˆ
```

#### **ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ**

* **Spring äº‹åŠ¡ä¾èµ–äº AOP ä»£ç†**
  ï¼Œåªæœ‰è¢« Spring æ‰˜ç®¡çš„ Bean æ‰ä¼šå¯ç”¨ä»£ç†æœºåˆ¶ã€‚
* **æ‰‹åŠ¨ new å¯¹è±¡ä¸ä¼šè§¦å‘äº‹åŠ¡æœºåˆ¶**
  ã€‚

#### âœ… **è§£å†³æ–¹æ¡ˆï¼š**

* **è®© Spring æ‰˜ç®¡ Beanï¼š**

```java
@Service
public class UserService {
    ...
}
```

* **ä½¿ç”¨
  `ApplicationContext`
  è·å–ä»£ç†å¯¹è±¡ï¼š**

```java
@Autowired
private ApplicationContext applicationContext;

public void addUser() {
    UserService proxy = applicationContext.getBean(UserService.class);
    proxy.addUser(); // ğŸš€äº‹åŠ¡ç”Ÿæ•ˆ
}
```

### âœ… **1ï¸âƒ£1ï¸âƒ£ SpringBoot çš„ `@EnableTransactionManagement` æœªç”Ÿæ•ˆ**

#### **é—®é¢˜å¤ç°ï¼š**

å¦‚æœä½ åœ¨é¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯ SpringBootï¼Œä½†æ˜¯
`@Transactional`
å´å®Œå…¨æ²¡ååº”ï¼Œ
  
å¯èƒ½æ˜¯å› ä¸ºäº‹åŠ¡ç®¡ç†å™¨æ²¡æœ‰å¯ç”¨ï¼

#### **ä¸ºä»€ä¹ˆä¼šå¤±æ•ˆï¼Ÿ**

* SpringBoot é»˜è®¤å¼€å¯äº‹åŠ¡ç®¡ç†ï¼ˆè‡ªåŠ¨é…ç½®ï¼‰ï¼Œä½†å¦‚æœä½ è‡ªå·±åˆ›å»ºäº†é…ç½®ç±»ï¼Œå¹¶å…³é—­äº†è‡ªåŠ¨é…ç½®ï¼Œå°±å¯èƒ½å¯¼è‡´äº‹åŠ¡å¤±æ•ˆã€‚

#### âœ… **è§£å†³æ–¹æ¡ˆï¼š**

* **æ˜¾å¼å¼€å¯äº‹åŠ¡ç®¡ç†å™¨ï¼š**

```java
@Configuration
@EnableTransactionManagement
public class TransactionConfig {
}
```

* **ç¡®è®¤äº‹åŠ¡ç®¡ç†å™¨æ˜¯å¦ç”Ÿæ•ˆï¼š**

```java
@Autowired
private PlatformTransactionManager transactionManager;

@PostConstruct
public void checkTransactionManager() {
    System.out.println("Transaction Manager: " + transactionManager);
}
```

### âœ… **1ï¸âƒ£2ï¸âƒ£ æ•°æ®åº“æœ¬èº«çš„é—®é¢˜**

æœ€åï¼Œæœ‰æ—¶å€™
**ä¸æ˜¯ä»£ç é—®é¢˜**
ï¼Œè€Œæ˜¯
**æ•°æ®åº“å±‚é¢çš„é…ç½®é—®é¢˜**
å¯¼è‡´äº‹åŠ¡å¤±æ•ˆï¼š

* **æ•°æ®åº“æƒé™ä¸è¶³**
  ï¼š
    
  å¦‚æœæ•°æ®åº“ç”¨æˆ·æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œ
  `ROLLBACK`
  æ“ä½œï¼Œä¹Ÿä¼šè®©äº‹åŠ¡æ— æ³•å›æ»šã€‚
* **è§¦å‘å™¨ (Trigger)**
  ï¼š
    
  å¦‚æœè¡¨æœ‰è§¦å‘å™¨ï¼Œä¼šå¯¼è‡´æŸäº›æ•°æ®åœ¨è§¦å‘å™¨æ‰§è¡Œåç›´æ¥æäº¤ï¼Œç»•è¿‡äº‹åŠ¡ç®¡ç†ã€‚

### ğŸ¯ **æ€»ç»“ï¼šäº‹åŠ¡å¤±æ•ˆåœºæ™¯å¤§å…¨**

| äº‹åŠ¡å¤±æ•ˆåœºæ™¯ | å¤±æ•ˆåŸå›  | è§£å†³æ–¹æ¡ˆ |
| --- | --- | --- |
| åŒç±»æ–¹æ³•è°ƒç”¨ | æ²¡æœ‰ä»£ç† | é€šè¿‡ä»£ç†å¯¹è±¡è°ƒç”¨ |
| é public æ–¹æ³• | åªæœ‰ public æ–¹æ³•æ‰ä¼šè¢«ä»£ç† | æ”¹ä¸º public |
| æ•°æ®åº“å¼•æ“ä¸æ”¯æŒäº‹åŠ¡ | ä½¿ç”¨ MyISAM è€Œä¸æ˜¯ InnoDB | ä¿®æ”¹ä¸º InnoDB |
| å¼‚å¸¸è¢«æ•è· | Spring é»˜è®¤åªå›æ»š RuntimeException | æ˜¾å¼æŒ‡å®š rollbackFor |
| å¤šçº¿ç¨‹è°ƒç”¨ | æ–°çº¿ç¨‹ä¸ä¼šç»§æ‰¿åŸçº¿ç¨‹çš„äº‹åŠ¡ | ä½¿ç”¨ @Async ç»“åˆäº‹åŠ¡ |
| è‡ªåŠ¨æäº¤æœªå…³é—­ | æ•°æ®æº autoCommit=true | å…³é—­è‡ªåŠ¨æäº¤ |
| ä»£ç†å¯¹è±¡è¢«ç»•è¿‡ | this è°ƒç”¨è‡ªèº«æ–¹æ³• | ä½¿ç”¨ä»£ç†å¯¹è±¡è°ƒç”¨ |
| åµŒå¥—äº‹åŠ¡ä¼ æ’­æœºåˆ¶è®¾ç½®ä¸å½“ | REQUIRES\_NEW å¯¼è‡´äº‹åŠ¡éš”ç¦» | ä½¿ç”¨ NESTED æˆ– REQUIRED |
| äº‹åŠ¡ç®¡ç†å™¨é…ç½®é”™è¯¯ | æ•°æ®æºå’Œäº‹åŠ¡ç®¡ç†å™¨ä¸åŒ¹é… | ç¡®ä¿äº‹åŠ¡ç®¡ç†å™¨æ­£ç¡®ç»‘å®šæ•°æ®æº |
| Bean é Spring æ‰˜ç®¡ | new å¯¹è±¡ä¸ä¼šè§¦å‘ä»£ç†æœºåˆ¶ | è®© Spring æ‰˜ç®¡ Bean |
| @EnableTransactionManagement æœªå¼€å¯ | æ²¡æœ‰å¯ç”¨äº‹åŠ¡ç®¡ç†å™¨ | æ˜¾å¼å¼€å¯äº‹åŠ¡ç®¡ç†å™¨ |
| æ•°æ®åº“å±‚é¢é—®é¢˜ | MySQL è§¦å‘å™¨æˆ–æƒé™é—®é¢˜ | æ£€æŸ¥æ•°æ®åº“é…ç½® |

âœ¨
**æ€è€ƒé¢˜ï¼š**

1. å¦‚ä½•åœ¨åŒä¸€ç±»æ–¹æ³•è°ƒç”¨æ—¶ï¼Œç¡®ä¿äº‹åŠ¡èƒ½å¤Ÿç”Ÿæ•ˆï¼Ÿ
2. ä¸ºä»€ä¹ˆæ•è·å¼‚å¸¸åäº‹åŠ¡ä¸ä¼šå›æ»šï¼Ÿ
3. äº‹åŠ¡å’Œçº¿ç¨‹ä¹‹é—´çš„å…³ç³»æ˜¯æ€æ ·çš„ï¼Ÿ

å¦‚æœè§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè®°å¾—ç‚¹èµâ­ã€æ”¶è—ğŸ“Œã€å…³æ³¨ğŸš€ï¼