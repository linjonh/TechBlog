---
layout: post
title: "强大的向量数据库Milvus"
date: 2021-09-01 21:50:59 +0800
description: "在推荐系统中，向量的最邻近检索是极为关键的一步，特别是在召回流程中。一般常用的如Annoy、fais"
keywords: "Milvus,向量数据库,AI应用"
categories: ['深度学习', '推荐系统', 'Python']
tags: ['深度学习', '数据库', '推荐系统', '向量检索', 'Milvus']
artid: "120049574"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=120049574
    alt: "强大的向量数据库Milvus"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=120049574
featuredImagePreview: https://bing.ee123.net/img/rand?artid=120049574
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     强大的向量数据库：Milvus
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/cf7d091db2e3b38a9cd1465831631508.png">
      <br/>
      在推荐系统中，向量的最邻近检索是极为关键的一步，特别是在召回流程中。一般常用的如Annoy、faiss都可以满足大部分的需求，今天再来介绍另外一个：
      <strong>
       Milvus
      </strong>
     </img>
    </p>
    <h2>
     <a id="Milvus_3">
     </a>
     Milvus
    </h2>
    <p>
     Milvus不同于Annoy、faiss这类型的向量检索工具，它更是一款开源向量数据库，赋能 AI 应用和向量相似度搜索。
    </p>
    <h3>
     <a id="_7">
     </a>
     涉及的术语
    </h3>
    <ol>
     <li>
      <strong>
       Field
      </strong>
      ：类似表字段，可以是结构化数据，当然还可以是向量；
     </li>
     <li>
      <strong>
       Entity
      </strong>
      ：一组Field，类似表的一条数据；
     </li>
     <li>
      <strong>
       Collection
      </strong>
      ：一组Entity，类似于表；
     </li>
    </ol>
    <h3>
     <a id="_13">
     </a>
     亮点
    </h3>
    <ol>
     <li>
      Milvus不单单是向量检索工具，而是向量数据库，能对不同业务的向量隔离，分开存储；
     </li>
     <li>
      提供可视化管理工具；
     </li>
     <li>
      支持带过滤条件的向量混合检索。
     </li>
    </ol>
    <h3>
     <a id="_19">
     </a>
     前言提示
    </h3>
    <p>
     本文介绍的是官方最新版本
     <code>
      2.0.0rc4
     </code>
     ：https://milvus.io/cn/docs/v2.0.0/home，因为新增了许多强大的功能，所以尝鲜实验了一把。但2.x还在迭代中，并不是稳定版本。实验后，也发现存在一些问题，如有时无法查询，而1.x则不存在这些问题。
    </p>
    <p>
     所以，大家实际使用最好是用最新的稳定版本
     <code>
      1.1.1
     </code>
     ，不过缺少一些功能。https://milvus.io/cn/docs/v1.1.1/home
    </p>
    <p>
     具官网表明，2.x的稳定版本也即将上线，到时再更新2.X版本投入生产环境。
    </p>
    <table>
     <thead>
      <tr>
       <th align="left">
       </th>
       <th align="left">
        Milvus 2.0
       </th>
       <th>
        Milvus 1.x
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="left">
        架构
       </td>
       <td align="left">
        云原生
       </td>
       <td>
        共享存储
       </td>
      </tr>
      <tr>
       <td align="left">
        可扩展性
       </td>
       <td align="left">
        500+ 个节点
       </td>
       <td>
        1 - 32 个读节点，1 个写节点
       </td>
      </tr>
      <tr>
       <td align="left">
        持久性
       </td>
       <td align="left">
        对象存储 (OSS)、分布式文件系统 (DFS)
       </td>
       <td>
        本地磁盘、网络文件系统 (NFS)
       </td>
      </tr>
      <tr>
       <td align="left">
        可用性
       </td>
       <td align="left">
        99.9%
       </td>
       <td>
        99%
       </td>
      </tr>
      <tr>
       <td align="left">
        数据一致性
       </td>
       <td align="left">
        多种一致性StrongBounded StalenessSessionConsistent prefix
       </td>
       <td>
        最终一致
       </td>
      </tr>
      <tr>
       <td align="left">
        数据类型支持
       </td>
       <td align="left">
        向量数据标量数据字符串与文本 (开发中)
       </td>
       <td>
        向量数据
       </td>
      </tr>
      <tr>
       <td align="left">
        基本操作
       </td>
       <td align="left">
        插入数据删除数据 (开发中)、数据查询相似最邻近（ANN）、搜索基于半径的最近邻算法（RNN） (开发中)
       </td>
       <td>
        插入数据删除数据相似最邻近（ANN）搜索
       </td>
      </tr>
      <tr>
       <td align="left">
        高级功能
       </td>
       <td align="left">
        标量字段过滤Time Travel多云/地域部署数据管理工具
       </td>
       <td>
        MishardsMilvus DM 数据迁移工具
       </td>
      </tr>
      <tr>
       <td align="left">
        索引类型
       </td>
       <td align="left">
        Faiss、Annoy、Hnswlib、RNSG、ScaNN (开发中)、On-disk index (开发中)
       </td>
       <td>
        Faiss、Annoy、Hnswlib、RNSG
       </td>
      </tr>
      <tr>
       <td align="left">
        SDK
       </td>
       <td align="left">
        PythonGo (开发中)Java (开发中)RESTful (开发中)C++ (开发中)
       </td>
       <td>
        Python、Java、Go、RESTful、C++
       </td>
      </tr>
      <tr>
       <td align="left">
        当前状态
       </td>
       <td align="left">
        预览版本。预计 2021 年 8 月发布稳定版本。
       </td>
       <td>
        长期支持（LTS）版本
       </td>
      </tr>
     </tbody>
    </table>
    <h2>
     <a id="Docker_41">
     </a>
     Docker安装
    </h2>
    <p>
     安装milvus之前：
     <a href="https://docs.docker.com/engine/install/" rel="nofollow">
      docker安装
     </a>
    </p>
    <p>
     如果安装了docker，但没有docker-compose的话，可以通过pip进行安装。https://docs.docker.com/compose/install/
    </p>
    <pre><code class="prism language-shell">pip <span class="token function">install</span> <span class="token function">docker-compose</span>
</code></pre>
    <h2>
     <a id="_51">
     </a>
     单机版安装
    </h2>
    <p>
     这里介绍docker的安装方式，官方还提供了
     <a href="https://milvus.io/cn/docs/v2.0.0/install_standalone-helm.md" rel="nofollow">
      使用Kubernetes安装
     </a>
    </p>
    <ol>
     <li>
      <p>
       <strong>
        下载docker镜像文件
       </strong>
      </p>
      <pre><code class="prism language-shell"><span class="token function">wget</span> https://raw.githubusercontent.com/milvus-io/milvus/ecfebff801291934a3e6c5955e53637b993ab41a/deployments/docker/standalone/docker-compose.yml <span class="token parameter variable">-O</span> docker-compose.yml
</code></pre>
      <p>
       没办法翻墙的可以自己新建
       <strong>
        docker-compose.yml
       </strong>
       文件，然后填入以下内容：
      </p>
      <pre><code class="prism language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.5'</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">etcd</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> milvus<span class="token punctuation">-</span>etcd
    <span class="token key atrule">image</span><span class="token punctuation">:</span> quay.io/coreos/etcd<span class="token punctuation">:</span>v3.5.0
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> $<span class="token punctuation">{<!-- --></span>DOCKER_VOLUME_DIRECTORY<span class="token punctuation">:</span><span class="token punctuation">-</span>.<span class="token punctuation">}</span>/volumes/etcd<span class="token punctuation">:</span>/etcd
    <span class="token key atrule">command</span><span class="token punctuation">:</span> etcd <span class="token punctuation">-</span>advertise<span class="token punctuation">-</span>client<span class="token punctuation">-</span>urls=http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>2379 <span class="token punctuation">-</span>listen<span class="token punctuation">-</span>client<span class="token punctuation">-</span>urls http<span class="token punctuation">:</span>//0.0.0.0<span class="token punctuation">:</span>2379 <span class="token punctuation">-</span><span class="token punctuation">-</span>data<span class="token punctuation">-</span>dir /etcd

  <span class="token key atrule">minio</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> milvus<span class="token punctuation">-</span>minio
    <span class="token key atrule">image</span><span class="token punctuation">:</span> minio/minio<span class="token punctuation">:</span>RELEASE.2020<span class="token punctuation">-</span>12<span class="token punctuation">-</span>03T00<span class="token punctuation">-</span>03<span class="token punctuation">-</span>10Z
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">MINIO_ACCESS_KEY</span><span class="token punctuation">:</span> minioadmin
      <span class="token key atrule">MINIO_SECRET_KEY</span><span class="token punctuation">:</span> minioadmin
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> $<span class="token punctuation">{<!-- --></span>DOCKER_VOLUME_DIRECTORY<span class="token punctuation">:</span><span class="token punctuation">-</span>.<span class="token punctuation">}</span>/volumes/minio<span class="token punctuation">:</span>/minio_data
    <span class="token key atrule">command</span><span class="token punctuation">:</span> minio server /minio_data
    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span>
      <span class="token key atrule">test</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"CMD"</span><span class="token punctuation">,</span> <span class="token string">"curl"</span><span class="token punctuation">,</span> <span class="token string">"-f"</span><span class="token punctuation">,</span> <span class="token string">"http://localhost:9000/minio/health/live"</span><span class="token punctuation">]</span>
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 30s
      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 20s
      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">3</span>

  <span class="token key atrule">standalone</span><span class="token punctuation">:</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> milvus<span class="token punctuation">-</span>standalone
    <span class="token key atrule">image</span><span class="token punctuation">:</span> milvusdb/milvus<span class="token punctuation">:</span>v2.0.0<span class="token punctuation">-</span>rc4<span class="token punctuation">-</span>20210811<span class="token punctuation">-</span>bdb8396
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"milvus"</span><span class="token punctuation">,</span> <span class="token string">"run"</span><span class="token punctuation">,</span> <span class="token string">"standalone"</span><span class="token punctuation">]</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">ETCD_ENDPOINTS</span><span class="token punctuation">:</span> etcd<span class="token punctuation">:</span><span class="token number">2379</span>
      <span class="token key atrule">MINIO_ADDRESS</span><span class="token punctuation">:</span> minio<span class="token punctuation">:</span><span class="token number">9000</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> $<span class="token punctuation">{<!-- --></span>DOCKER_VOLUME_DIRECTORY<span class="token punctuation">:</span><span class="token punctuation">-</span>.<span class="token punctuation">}</span>/volumes/milvus<span class="token punctuation">:</span>/var/lib/milvus
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"19530:19530"</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"etcd"</span>
      <span class="token punctuation">-</span> <span class="token string">"minio"</span>

<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">default</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> milvus
</code></pre>
     </li>
     <li>
      <p>
       <strong>
        拉取镜像并启动
       </strong>
      </p>
     </li>
    </ol>
    <pre><code class="prism language-shell"><span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span>
</code></pre>
    <p>
     这条是启动命令，第一次运行时需要联网拉取以下三个镜像：
     <br/>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/61412cd88d066d56edb119bea634ccd3.png"/>
    </p>
    <p>
     启动的服务默认端口是19530，包括以下三个docker容器：
     <br/>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/22f3b6b3b1dbbd2dd37e01d2fc048428.png"/>
    </p>
    <h2>
     <a id="_123">
     </a>
     分布式版安装
    </h2>
    <p>
     https://milvus.io/cn/docs/v2.0.0/install_cluster-docker.md
    </p>
    <h2>
     <a id="Python_SDK_127">
     </a>
     Python SDK
    </h2>
    <h3>
     <a id="_129">
     </a>
     安装依赖
    </h3>
    <pre><code class="prism language-shell">pip <span class="token function">install</span> pymilvus-orm<span class="token operator">==</span><span class="token number">2.0</span>.0rc4
</code></pre>
    <p>
     官网说明最新版本需要python3.6以上，但实际测试，需要python3.8才能成功安装（主要是pandas的版本要求比较高）
    </p>
    <h3>
     <a id="milvus_137">
     </a>
     连接milvus服务
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">from</span> pymilvus_orm <span class="token keyword">import</span> connections<span class="token punctuation">,</span> FieldSchema<span class="token punctuation">,</span> CollectionSchema<span class="token punctuation">,</span> DataType<span class="token punctuation">,</span> Collection

<span class="token comment"># 连接milvus服务器</span>
connections<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token string">'19530'</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     ##创建collection
    </p>
    <p>
     collection必须要有一个field是主键，一个field是存储向量，另外还可以创建其他类型的field
    </p>
    <pre><code class="prism language-python">field_name <span class="token operator">=</span> <span class="token string">"example_field"</span>


<span class="token keyword">def</span> <span class="token function">create_collection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    创建集合collection
    :return:
    """</span>
    collection_name <span class="token operator">=</span> <span class="token string">"example_collection"</span>
    <span class="token keyword">from</span> pymilvus_orm <span class="token keyword">import</span> Collection<span class="token punctuation">,</span> CollectionSchema<span class="token punctuation">,</span> FieldSchema<span class="token punctuation">,</span> DataType
    <span class="token comment"># 主键</span>
    field_id <span class="token operator">=</span> FieldSchema<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"field_id"</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>DataType<span class="token punctuation">.</span>INT64<span class="token punctuation">,</span> is_primary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> auto_id<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token comment"># 向量检索的field</span>
    field <span class="token operator">=</span> FieldSchema<span class="token punctuation">(</span>name<span class="token operator">=</span>field_name<span class="token punctuation">,</span> dtype<span class="token operator">=</span>DataType<span class="token punctuation">.</span>FLOAT_VECTOR<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span>
    cat_id <span class="token operator">=</span> FieldSchema<span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">"cat_id"</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>DataType<span class="token punctuation">.</span>INT64<span class="token punctuation">)</span>
    schema <span class="token operator">=</span> CollectionSchema<span class="token punctuation">(</span>fields<span class="token operator">=</span><span class="token punctuation">[</span>field_id<span class="token punctuation">,</span> field<span class="token punctuation">,</span> cat_id<span class="token punctuation">]</span><span class="token punctuation">,</span> description<span class="token operator">=</span><span class="token string">"example collection"</span><span class="token punctuation">)</span>

    collection <span class="token operator">=</span> Collection<span class="token punctuation">(</span>name<span class="token operator">=</span>collection_name<span class="token punctuation">,</span> schema<span class="token operator">=</span>schema<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>pymilvus_orm<span class="token punctuation">.</span>utility<span class="token punctuation">.</span>get_connection<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>has_collection<span class="token punctuation">(</span>collection_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>pymilvus_orm<span class="token punctuation">.</span>utility<span class="token punctuation">.</span>get_connection<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>list_collections<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> collection
</code></pre>
    <p>
     collection还可以将数据存储在不同的分区。默认是有一个"Default partition"的分区，不指定分区的话，都会存储在default分区。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">create_partition</span><span class="token punctuation">(</span>collection<span class="token punctuation">:</span> Collection<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    为collection创建分区
    :param collection:
    :return:
    """</span>
    partition_name <span class="token operator">=</span> <span class="token string">"example_partition"</span>
    partition <span class="token operator">=</span> collection<span class="token punctuation">.</span>create_partition<span class="token punctuation">(</span>partition_name<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>collection<span class="token punctuation">.</span>partitions<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span>collection<span class="token punctuation">.</span>has_partition<span class="token punctuation">(</span>partition_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_192">
     </a>
     插入数据
    </h3>
    <p>
     插入数据可以根据实际需要，是否插入到特定的分区。
    </p>
    <ol>
     <li>
      当前版本数据格式只能是list，numpy的ndarray也不行；
     </li>
     <li>
      如果主键设置自增
      <code>
       auto_id=True
      </code>
      ，则无需添加主键的值了；
     </li>
     <li>
      数据插入之后，它是存储在内存中，还需要将其传输到磁盘中，下次可以继续使用。
     </li>
    </ol>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">insert</span><span class="token punctuation">(</span>collection<span class="token punctuation">:</span> Collection<span class="token punctuation">,</span> partition_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    插入数据
    :param partition_name: 指定插入的分区
    :param collection:
    :return:
    """</span>
    <span class="token comment"># 由于主键field_id设置自增，所以无需插入</span>
    mr <span class="token operator">=</span> collection<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token comment"># 只能是list</span>
        np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 向量</span>
        np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">10000</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># cat_id</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span> partition_name<span class="token operator">=</span>partition_name<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>mr<span class="token punctuation">.</span>primary_keys<span class="token punctuation">)</span>

    <span class="token comment"># 插入的数据存储在内存，需要传输到磁盘</span>
    pymilvus_orm<span class="token punctuation">.</span>utility<span class="token punctuation">.</span>get_connection<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>flush<span class="token punctuation">(</span><span class="token punctuation">[</span>collection<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_220">
     </a>
     创建索引
    </h3>
    <p>
     为向量对应的field创建索引，目的就是实现高效的向量邻近搜索。
    </p>
    <p>
     目前支持的索引类型包括：
     <br/>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/cb52b4827712100139329e8074db0c5d.png"/>
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">create_index</span><span class="token punctuation">(</span>collection<span class="token punctuation">:</span> Collection<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    为向量检索的field 创建索引
    :param collection:
    :return:
    """</span>
    index_param <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"metric_type"</span><span class="token punctuation">:</span> <span class="token string">"L2"</span><span class="token punctuation">,</span>
        <span class="token string">"index_type"</span><span class="token punctuation">:</span> <span class="token string">"IVF_FLAT"</span><span class="token punctuation">,</span>
        <span class="token string">"params"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"nlist"</span><span class="token punctuation">:</span> <span class="token number">1024</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    collection<span class="token punctuation">.</span>create_index<span class="token punctuation">(</span>field_name<span class="token operator">=</span>field_name<span class="token punctuation">,</span> index_params<span class="token operator">=</span>index_param<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>collection<span class="token punctuation">.</span>index<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>params<span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_243">
     </a>
     查询
    </h3>
    <p>
     除了一般的向量搜索，milvus还支持带表达式的标量过滤功能。
    </p>
    <p>
     例如下方代码中，就增加
     <code>
      expr="cat_id==2"
     </code>
     条件：即只在cat_id为2的向量中进行检索（上面创建了名称为cat_id的field）。
    </p>
    <p>
     但是目前还不支持字符串的过滤功能，官方后续会增加；
    </p>
    <p>
     支持关系运算符（如==, &gt;）、逻辑运算符(AND &amp;&amp;, OR ||)和IN运算符。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">search</span><span class="token punctuation">(</span>collection<span class="token punctuation">:</span> Collection<span class="token punctuation">,</span> partition_name<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    向量检索
    :param collection:
    :param partition_name: 检索指定分区的向量
    :return:
    """</span>
    <span class="token comment"># 将collection加载到内存</span>
    collection<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
    search_params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"metric_type"</span><span class="token punctuation">:</span> <span class="token string">"L2"</span><span class="token punctuation">,</span> <span class="token string">"params"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"nprobe"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token comment"># 向量搜索</span>
    result <span class="token operator">=</span> collection<span class="token punctuation">.</span>search<span class="token punctuation">(</span>data<span class="token operator">=</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               anns_field<span class="token operator">=</span>field_name<span class="token punctuation">,</span> param<span class="token operator">=</span>search_params<span class="token punctuation">,</span> limit<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
                               partition_names<span class="token operator">=</span><span class="token punctuation">[</span>partition_name<span class="token punctuation">]</span> <span class="token keyword">if</span> partition_name <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ids<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>distances<span class="token punctuation">)</span>

    <span class="token comment"># 表达式：只检索cat_id为2的向量</span>
    result <span class="token operator">=</span> collection<span class="token punctuation">.</span>search<span class="token punctuation">(</span>data<span class="token operator">=</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                               anns_field<span class="token operator">=</span>field_name<span class="token punctuation">,</span> param<span class="token operator">=</span>search_params<span class="token punctuation">,</span> limit<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
                               expr<span class="token operator">=</span><span class="token string">"cat_id==2"</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>ids<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>distances<span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_279">
     </a>
     删除数据
    </h3>
    <p>
     目前支持以下三种删除操作
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">drop</span><span class="token punctuation">(</span>collection<span class="token punctuation">:</span> Collection<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 删除collection</span>
    collection<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 删除索引</span>
    collection<span class="token punctuation">.</span>drop_index<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 删除分区</span>
    collection<span class="token punctuation">.</span>drop_partition<span class="token punctuation">(</span><span class="token string">"partition_name"</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_293">
     </a>
     释放
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">release</span><span class="token punctuation">(</span>collection<span class="token punctuation">:</span> Collection <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 从内存中释放collection</span>
    <span class="token keyword">if</span> collection<span class="token punctuation">:</span>
        collection<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 断开与服务器的连接，释放资源</span>
    connections<span class="token punctuation">.</span>disconnect<span class="token punctuation">(</span><span class="token string">"default"</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="SDK_305">
     </a>
     其他SDK
    </h3>
    <p>
     <strong>
      1.x版本支持：
     </strong>
     <br/>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/fc547e1857bbbcc8e51ea334c4755263.png"/>
    </p>
    <p>
     <strong>
      2.x版本目前只有python，其他还在开发中
     </strong>
    </p>
    <h2>
     <a id="_312">
     </a>
     <strong>
      可视化管理
     </strong>
    </h2>
    <p>
     milvus的强大之处，还在于它提供了可视化的管理工具。
    </p>
    <p>
     也是以docker的形式进行安装和启动：
    </p>
    <pre><code class="prism language-shell"><span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">8000</span>:3000 <span class="token parameter variable">-e</span> <span class="token assign-left variable">HOST_URL</span><span class="token operator">=</span>http://<span class="token punctuation">{<!-- --></span> your machine IP <span class="token punctuation">}</span>:8000 <span class="token parameter variable">-e</span> <span class="token assign-left variable">MILVUS_URL</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>your machine IP<span class="token punctuation">}</span>:19530 milvusdb/milvus-insight:latest
</code></pre>
    <p>
     <strong>
      注意：这里的IP不能写localhost，否则可能会出现连接问题。
     </strong>
    </p>
    <ol>
     <li>
      <p>
       查看load到内存的collection
       <br/>
       <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/83cac6208cb5048ce9117b9e4fa0e5d7.png"/>
      </p>
     </li>
     <li>
      <p>
       查看collection的结构和分区，还支持删除和导入操作
       <br/>
       <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e203686d2e6aa991ed9dca734d19cdd1.png"/>
      </p>
     </li>
    </ol>
    <p>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/9f0a68e859b820bcf2041e9f2bbe0a47.png"/>
    </p>
    <ol start="3">
     <li>
      在线向量检索
     </li>
    </ol>
    <p>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c206294f1b6de14bf7a26650c3722e46.png"/>
    </p>
    <h2>
     <a id="_337">
     </a>
     后续功能
    </h2>
    <p>
     其实，到这里，milvus已经足够强大，但他们还在持续支持许多强大的新功能。
     <br/>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/532f5807159f9150b14bd1510cbf6bb4.png">
      <br/>
      <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3321cf4aca9c254f6b923edc05ff4609.png">
       <br/>
       <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/aa78c47d933f7b9c17f3e1a0a6ae0e2c.png"/>
      </img>
     </img>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f73677975616e7368692f:61727469636c652f64657461696c732f313230303439353734" class_="artid" style="display:none">
 </p>
</div>


