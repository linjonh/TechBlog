---
layout: post
title: "Java-集合遍历过程中修改数据触发-Fail-Fast-机制-,导致报ConcurrentModificationException异常"
date: 2025-03-14 17:12:32 +0800
description: "Fail-Fast 机制是 Java 集合框架中的一种错误检测机制，用于在遍历集合时检测结构修改。如果在迭代器创建之后，集合被修改（例如添加或删除元素），并且这种修改不是通过迭代器自身的 remove() 方法进行的，那么迭代器会立即抛出 ConcurrentModificationException 异常，以防止不一致或不可预测的行为"
keywords: "Java 集合遍历过程中修改数据触发 Fail-Fast 机制 ，导致报ConcurrentModificationException异常"
categories: ['基础整理', 'Java']
tags: ['Windows', 'Python', 'Java']
artid: "146262052"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146262052
    alt: "Java-集合遍历过程中修改数据触发-Fail-Fast-机制-,导致报ConcurrentModificationException异常"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146262052
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146262052
cover: https://bing.ee123.net/img/rand?artid=146262052
image: https://bing.ee123.net/img/rand?artid=146262052
img: https://bing.ee123.net/img/rand?artid=146262052
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Java 集合遍历过程中修改数据触发 Fail-Fast 机制 ，导致报ConcurrentModificationException异常
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h4>
     <a id="Java_FailFast__0">
     </a>
     Java Fail-Fast 机制
    </h4>
    <p>
     <strong>
      Fail-Fast
     </strong>
     机制是 Java 集合框架中的一种错误检测机制，用于在遍历集合时检测结构修改。如果在迭代器创建之后，集合被修改（例如添加或删除元素），并且这种修改不是通过迭代器自身的
     <code>
      remove()
     </code>
     方法进行的，那么迭代器会立即抛出
     <code>
      ConcurrentModificationException
     </code>
     异常，以防止不一致或不可预测的行为。
    </p>
    <h5>
     <a id="_4">
     </a>
     <strong>
      工作原理
     </strong>
    </h5>
    <ol>
     <li>
      <p>
       <strong>
        修改计数器
       </strong>
       ：
      </p>
      <ul>
       <li>
        集合类（如
        <code>
         ArrayList
        </code>
        、
        <code>
         HashMap
        </code>
        等）内部维护一个
        <code>
         modCount
        </code>
        计数器，记录集合被结构性修改的次数（结构性修改包括添加或删除元素，但不包括通过迭代器自身的
        <code>
         remove()
        </code>
        方法进行的删除）。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        迭代器的预期修改计数
       </strong>
       ：
      </p>
      <ul>
       <li>
        当创建迭代器时，迭代器会记录当前集合的
        <code>
         modCount
        </code>
        值，作为其
        <code>
         expectedModCount
        </code>
        。
       </li>
       <li>
        在每次调用迭代器的
        <code>
         next()
        </code>
        方法时，迭代器会检查
        <code>
         expectedModCount
        </code>
        是否与集合的当前
        <code>
         modCount
        </code>
        一致。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        检测不一致
       </strong>
       ：
      </p>
      <ul>
       <li>
        如果在迭代过程中，集合的
        <code>
         modCount
        </code>
        发生变化（即
        <code>
         expectedModCount
        </code>
        不等于
        <code>
         modCount
        </code>
        ），迭代器会立即抛出
        <code>
         ConcurrentModificationException
        </code>
        异常。
       </li>
      </ul>
     </li>
    </ol>
    <h5>
     <a id="_16">
     </a>
     <strong>
      示例代码
     </strong>
    </h5>
    <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Iterator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FailFastExample</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> element <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 在迭代过程中修改集合，会抛出 ConcurrentModificationException</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"D"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      输出
     </strong>
     ：
    </p>
    <pre><code>A
Exception in thread "main" java.util.ConcurrentModificationException
    at java.util.ArrayList$Itr.checkForComodification(ArrayList.java:909)
    at java.util.ArrayList$Itr.next(ArrayList.java:859)
    at FailFastExample.main(FailFastExample.java:13)
</code></pre>
    <h5>
     <a id="_52">
     </a>
     <strong>
      解决方法
     </strong>
    </h5>
    <ol>
     <li>
      <p>
       <strong>
        使用迭代器自身的
        <code>
         remove()
        </code>
        方法
       </strong>
       ：
      </p>
      <ul>
       <li>
        如果需要在遍历过程中删除元素，应使用迭代器的
        <code>
         remove()
        </code>
        方法，而不是直接操作集合。
       </li>
      </ul>
      <pre><code class="prism language-java"><span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> element <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        iterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 安全删除元素</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
     <li>
      <p>
       <strong>
        使用线程安全的集合类
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用
        <code>
         java.util.concurrent
        </code>
        包中的线程安全集合类，如
        <code>
         CopyOnWriteArrayList
        </code>
        、
        <code>
         ConcurrentHashMap
        </code>
        等。
       </li>
      </ul>
      <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CopyOnWriteArrayList</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConcurrentExample</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> element <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 在迭代过程中修改集合，不会抛出 ConcurrentModificationException</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"D"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
     <li>
      <p>
       <strong>
        使用
        <code>
         Collections.synchronizedList()
        </code>
        或
        <code>
         Collections.synchronizedSet()
        </code>
       </strong>
       ：
      </p>
      <ul>
       <li>
        将集合包装为线程安全的集合。
       </li>
      </ul>
      <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Iterator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizedExample</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"A"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"C"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> list<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">String</span> element <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 在迭代过程中修改集合，不会抛出 ConcurrentModificationException</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"D"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
    </ol>
    <h5>
     <a id="_122">
     </a>
     <strong>
      注意事项
     </strong>
    </h5>
    <ol>
     <li>
      <p>
       <strong>
        单线程环境
       </strong>
       ：
      </p>
      <ul>
       <li>
        在单线程环境中，Fail-Fast 机制有助于及时发现集合被意外修改的问题。
       </li>
       <li>
        但需要注意在迭代过程中不要直接修改集合，除非使用迭代器自身的
        <code>
         remove()
        </code>
        方法。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        多线程环境
       </strong>
       ：
      </p>
      <ul>
       <li>
        Fail-Fast 机制在多线程环境中可能会导致
        <code>
         ConcurrentModificationException
        </code>
        异常。
       </li>
       <li>
        应使用线程安全的集合类或同步机制来避免此类问题。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        性能影响
       </strong>
       ：
      </p>
      <ul>
       <li>
        Fail-Fast 机制本身对性能的影响较小，主要体现在每次迭代时的
        <code>
         modCount
        </code>
        检查。
       </li>
       <li>
        但在多线程环境下，频繁的同步操作可能会显著影响性能。
       </li>
      </ul>
     </li>
    </ol>
    <h5>
     <a id="_136">
     </a>
     <strong>
      总结
     </strong>
    </h5>
    <ul>
     <li>
      <strong>
       Fail-Fast 机制
      </strong>
      是 Java 集合框架中用于检测集合在迭代过程中被修改的一种机制。
     </li>
     <li>
      通过在迭代过程中抛出
      <code>
       ConcurrentModificationException
      </code>
      异常，Fail-Fast 机制可以及时发现不一致的行为，确保集合的完整性和一致性。
     </li>
     <li>
      在使用 Fail-Fast 机制时，需要注意在迭代过程中不要直接修改集合，除非使用迭代器自身的
      <code>
       remove()
      </code>
      方法。
     </li>
     <li>
      对于多线程环境，建议使用线程安全的集合类或同步机制来避免
      <code>
       ConcurrentModificationException
      </code>
      异常。
     </li>
    </ul>
    <p>
     通过合理使用 Fail-Fast 机制，可以提高代码的健壮性和可靠性。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f7a703335373235323533392f:61727469636c652f64657461696c732f313436323632303532" class_="artid" style="display:none">
 </p>
</div>


