---
layout: post
title: "微信小程序-用户信息encryptedData"
date: 2025-01-05 10:31:04 +0800
description: "之前做过一个版本是根据encryptData和Session_key解密得到完整的用户信息（包含un"
keywords: "微信公众号 测试 encrypteddata"
categories: ['微信开发']
tags: ['解密', '数据', '微信']
artid: "53736747"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=53736747
    alt: "微信小程序-用户信息encryptedData"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=53736747
featuredImagePreview: https://bing.ee123.net/img/rand?artid=53736747
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     微信小程序--用户信息encryptedData
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     之前做过一个版本是根据encryptData和Session_key解密得到完整的用户信息（包含union_id）的方法去获取用户信息，由于小程序升级，如今需要废弃encryptData的方式去获取用户信息，改成使用encryptedData的方式获取用户信息。
    </p>
    <p>
     <strong>
      新的数据解密方法
     </strong>
     <br/>
     接口如果涉及敏感数据（如wx.getUserInfo当中的 openId 和unionId ），接口的明文内容将不包含这些敏感数据。开发者如需要获取敏感数据，需要对接口返回的加密数据( encryptedData )进行对称解密。 解密算法如下：
    </p>
    <pre><code>对称解密使用的算法为 AES-128-CBC，数据采用PKCS#7填充。
对称解密的目标密文为 Base64_Decode(encryptedData),
对称解密秘钥 aeskey = Base64_Decode(session_key), aeskey 是16字节
对称解密算法初始向量 iv 会在数据接口中返回。 
</code></pre>
    <p>
     微信官方提供了多种编程语言的示例代码。每种语言类型的接口名字均一致。调用方式可以参照示例。
    </p>
    <p>
     另外，为了应用能校验数据的有效性，我们会在敏感数据加上数据水印( watermark )
    </p>
    <pre class="prettyprint"><code class="hljs json">{
    "<span class="hljs-attribute">openId</span>": <span class="hljs-value"><span class="hljs-string">"OPENID"</span></span>,
    "<span class="hljs-attribute">nickName</span>": <span class="hljs-value"><span class="hljs-string">"NICKNAME"</span></span>,
    "<span class="hljs-attribute">gender</span>": <span class="hljs-value">GENDER</span>,
    "<span class="hljs-attribute">city</span>": <span class="hljs-value"><span class="hljs-string">"CITY"</span></span>,
    "<span class="hljs-attribute">province</span>": <span class="hljs-value"><span class="hljs-string">"PROVINCE"</span></span>,
    "<span class="hljs-attribute">country</span>": <span class="hljs-value"><span class="hljs-string">"COUNTRY"</span></span>,
    "<span class="hljs-attribute">avatarUrl</span>": <span class="hljs-value"><span class="hljs-string">"AVATARURL"</span></span>,
    "<span class="hljs-attribute">unionId</span>": <span class="hljs-value"><span class="hljs-string">"UNIONID"</span></span>,
    "<span class="hljs-attribute">watermark</span>":
    <span class="hljs-value">{
        "<span class="hljs-attribute">appid</span>":<span class="hljs-value"><span class="hljs-string">"APPID"</span></span>,
        "<span class="hljs-attribute">timestamp</span>":<span class="hljs-value">TIMESTAMP
    </span>}
</span>}</code></pre>
    <p>
     总的来说还是原来的算法，还是原来的逻辑结构，不同的是解密方式，以前是通过session_key得到iv，现如今是直接从前台接口处得到iv来解密，所改变的也只是传输的数据
    </p>
    <pre class="prettyprint"><code class="hljs avrasm">@RequestMapping(value = <span class="hljs-string">"/web/wechatapp/jscode2session"</span>, method = RequestMethod<span class="hljs-preprocessor">.POST</span>)
    @ResponseBody
    public String getSessionByCode(@RequestBody String jsonStr, HttpServletRequest request) {
        JSONObject jsonObj = JSONObject<span class="hljs-preprocessor">.fromObject</span>(jsonStr)<span class="hljs-comment">;</span>
        String code = (String) jsonObj<span class="hljs-preprocessor">.get</span>(<span class="hljs-string">"code"</span>)<span class="hljs-comment">;</span>
        JSONObject wechatAppUserInfo = jsonObj<span class="hljs-preprocessor">.getJSONObject</span>(<span class="hljs-string">"wechatAppUserInfo"</span>)<span class="hljs-comment">;</span>
        String encryptedData = (String) wechatAppUserInfo<span class="hljs-preprocessor">.get</span>(<span class="hljs-string">"encryptedData"</span>)<span class="hljs-comment">;</span>
        String iv = (String) wechatAppUserInfo<span class="hljs-preprocessor">.get</span>(<span class="hljs-string">"iv"</span>)<span class="hljs-comment">;</span>

        WechatUserInfo wechatUserInfo = wechatAppManager<span class="hljs-preprocessor">.doOAuth</span>(code, encryptedData, iv)<span class="hljs-comment">;</span>
        if (wechatUserInfo == null) {
            throw new BusinessException(BusinessException<span class="hljs-preprocessor">.Code</span><span class="hljs-preprocessor">.WECHAT</span>_OAUTH_ERROR, <span class="hljs-string">"微信小程序授权失败！！！"</span>)<span class="hljs-comment">;</span>
        }
        HttpSession session = request<span class="hljs-preprocessor">.getSession</span>(true)<span class="hljs-comment">;</span>
        User user = wechatUserInfo<span class="hljs-preprocessor">.getUser</span>()<span class="hljs-comment">;</span>
        logger<span class="hljs-preprocessor">.debug</span>(<span class="hljs-string">"微信小程序用户 union id: {}, 对应车车用户{}"</span>, wechatUserInfo<span class="hljs-preprocessor">.getUnionid</span>(), user<span class="hljs-preprocessor">.getId</span>())<span class="hljs-comment">;</span>
        session<span class="hljs-preprocessor">.setAttribute</span>(WebConstants<span class="hljs-preprocessor">.SESSION</span>_KEY_USER, CacheUtil<span class="hljs-preprocessor">.doJacksonSerialize</span>(user))<span class="hljs-comment">;</span>
        ClientTypeUtil<span class="hljs-preprocessor">.cacheClientType</span>(request, ClientType<span class="hljs-preprocessor">.WE</span>_CHAT_APP)<span class="hljs-comment">;</span>
        return session<span class="hljs-preprocessor">.getId</span>()<span class="hljs-comment">;</span>
    }</code></pre>
    <p>
     解密的算法
    </p>
    <pre class="prettyprint"><code class="hljs avrasm">public static byte[] decrypt(String dataStr,String keyStr, String ivStr) throws Exception{
        Security<span class="hljs-preprocessor">.addProvider</span>(new org<span class="hljs-preprocessor">.bouncycastle</span><span class="hljs-preprocessor">.jce</span><span class="hljs-preprocessor">.provider</span><span class="hljs-preprocessor">.BouncyCastleProvider</span>())<span class="hljs-comment">;</span>
        byte[] encryptedData = Base64<span class="hljs-preprocessor">.decode</span>(dataStr)<span class="hljs-comment">;</span>
        byte[] keyBytes = Base64<span class="hljs-preprocessor">.decode</span>(keyStr)<span class="hljs-comment">;</span>
        AlgorithmParameters iv = WechatAppDecryptor<span class="hljs-preprocessor">.generateIV</span>(Base64<span class="hljs-preprocessor">.decode</span>(ivStr))<span class="hljs-comment">;</span>
        Key key = convertToKey(keyBytes)<span class="hljs-comment">;</span>
        Cipher cipher = Cipher<span class="hljs-preprocessor">.getInstance</span>(CIPHER_ALGORITHM)<span class="hljs-comment">;</span>
        //设置为解密模式
        cipher<span class="hljs-preprocessor">.init</span>(Cipher<span class="hljs-preprocessor">.DECRYPT</span>_MODE, key,iv)<span class="hljs-comment">;</span>
        return cipher<span class="hljs-preprocessor">.doFinal</span>(encryptedData)<span class="hljs-comment">;</span>
    }</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f75303133383033343939:2f61727469636c652f64657461696c732f3533373336373437" class_="artid" style="display:none">
 </p>
</div>


