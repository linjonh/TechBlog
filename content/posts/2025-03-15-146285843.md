---
layout: post
title: "洛谷-P2801-教主的魔法-题解"
date: 2025-03-15 22:10:45 +0800
description: "之前学过 莫队 算法，其运用了分块思想；但是我居然是第一次写纯种的分块题目。"
keywords: "洛谷 P2801 教主的魔法 题解"
categories: ['未分类']
tags: ['算法']
artid: "146285843"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146285843
    alt: "洛谷-P2801-教主的魔法-题解"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146285843
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146285843
cover: https://bing.ee123.net/img/rand?artid=146285843
image: https://bing.ee123.net/img/rand?artid=146285843
img: https://bing.ee123.net/img/rand?artid=146285843
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     洛谷 P2801 教主的魔法 题解
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     之前学过 莫队 算法，其运用了分块思想；但是我居然是第一次写纯种的分块题目。
    </p>
    <h3>
     <a id="_1">
     </a>
     题意
    </h3>
    <p>
     给你一个长度为
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        n 
        
       
      
        n
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal">
          n
         </span>
        </span>
       </span>
      </span>
     </span>
     的序列
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        a 
        
       
      
        a
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal">
          a
         </span>
        </span>
       </span>
      </span>
     </span>
     （一开始
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        ∀ 
        
        
        
          a 
         
        
          i 
         
        
       
         ∈ 
        
       
         [ 
        
       
         1 
        
       
         , 
        
       
         1000 
        
       
         ] 
        
       
      
        \forall a_i\in[1,1000]
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          ∀
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           a
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ∈
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mopen">
          [
         </span>
         <span class="mord">
          1
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord">
          1000
         </span>
         <span class="mclose">
          ]
         </span>
        </span>
       </span>
      </span>
     </span>
     ）。要求执行
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        q 
        
       
      
        q
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0359em;">
          q
         </span>
        </span>
       </span>
      </span>
     </span>
     次操作，操作有两种，每次形如
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        o 
        
       
         p 
        
       
         , 
        
       
         l 
        
       
         , 
        
       
         r 
        
       
         , 
        
       
         w 
        
       
         / 
        
       
         c 
        
       
      
        op,l,r,w/c
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord mathnormal">
          o
         </span>
         <span class="mord mathnormal">
          p
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0197em;">
          l
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          r
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0269em;">
          w
         </span>
         <span class="mord">
          /
         </span>
         <span class="mord mathnormal">
          c
         </span>
        </span>
       </span>
      </span>
     </span>
     ：
    </p>
    <ul>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         o 
         
        
          p 
         
        
       
         op
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           o
          </span>
          <span class="mord mathnormal">
           p
          </span>
         </span>
        </span>
       </span>
      </span>
      为
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         M 
         
        
       
         \rm M
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord">
           <span class="mord mathrm">
            M
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ，将
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         a 
          
         
           l 
          
         
        
          , 
         
         
         
           a 
          
          
          
            l 
           
          
            + 
           
          
            1 
           
          
         
        
          , 
         
        
          ⋯ 
          
        
          , 
         
         
         
           a 
          
         
           r 
          
         
        
       
         a_l,a_{l+1},\cdots,a_r
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6389em; vertical-align: -0.2083em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            a
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                  l
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            a
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                  <span class="mbin mtight">
                   +
                  </span>
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2083em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="minner">
           ⋯
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            a
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1514em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                  r
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      分别加上
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         w 
         
        
       
         w
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.4306em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0269em;">
           w
          </span>
         </span>
        </span>
       </span>
      </span>
      ；
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         o 
         
        
          p 
         
        
       
         op
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           o
          </span>
          <span class="mord mathnormal">
           p
          </span>
         </span>
        </span>
       </span>
      </span>
      为
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         A 
         
        
       
         \rm A
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord">
           <span class="mord mathrm">
            A
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ，查询
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         a 
          
         
           l 
          
         
        
          , 
         
         
         
           a 
          
          
          
            l 
           
          
            + 
           
          
            1 
           
          
         
        
          , 
         
        
          ⋯ 
          
        
          , 
         
         
         
           a 
          
         
           r 
          
         
        
       
         a_l,a_{l+1},\cdots,a_r
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6389em; vertical-align: -0.2083em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            a
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                  l
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            a
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                  <span class="mbin mtight">
                   +
                  </span>
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2083em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="minner">
           ⋯
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            a
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1514em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                  r
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      中，有多少个数大于
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         c 
         
        
       
         c
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.4306em;">
          </span>
          <span class="mord mathnormal">
           c
          </span>
         </span>
        </span>
       </span>
      </span>
      。
     </li>
    </ul>
    <p>
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        n 
        
       
         ≤ 
        
       
         1 
        
        
        
          0 
         
        
          6 
         
        
       
         , 
        
       
         q 
        
       
         ≤ 
        
       
         3000 
        
       
         , 
        
       
         w 
        
       
         ≤ 
        
       
         1000 
        
       
         , 
        
       
         c 
        
       
         ≤ 
        
       
         1 
        
        
        
          0 
         
        
          9 
         
        
       
      
        n\le10^6,q\le3000,w\le1000,c\le10^9
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7719em; vertical-align: -0.136em;">
         </span>
         <span class="mord mathnormal">
          n
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ≤
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1.0085em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          1
         </span>
         <span class="mord">
          <span class="mord">
           0
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8141em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 6
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0359em;">
          q
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ≤
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8389em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          3000
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0269em;">
          w
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ≤
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8389em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          1000
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal">
          c
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ≤
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8141em;">
         </span>
         <span class="mord">
          1
         </span>
         <span class="mord">
          <span class="mord">
           0
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8141em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 9
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <h3>
     <a id="_8">
     </a>
     思路
    </h3>
    <p>
     主席树？是我早就不会打的。
    </p>
    <p>
     如果我们把它变成一道分块练习题呢？
    </p>
    <p>
     考虑对序列
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        a 
        
       
      
        a
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal">
          a
         </span>
        </span>
       </span>
      </span>
     </span>
     分块，对于每一块内，使用辅助数组
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        b 
        
       
      
        b
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6944em;">
         </span>
         <span class="mord mathnormal">
          b
         </span>
        </span>
       </span>
      </span>
     </span>
     以保证块内数有序。不妨设
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        b 
        
        
        
          l 
         
        
          t 
         
        
       
         , 
        
       
         b 
        
        
        
          r 
         
        
          t 
         
        
       
      
        bl_t,br_t
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal">
          b
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2806em;">
              <span class="" style="top: -2.55em; margin-left: -0.0197em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 t
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal">
          b
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           r
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2806em;">
              <span class="" style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 t
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     表示块
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        t 
        
       
      
        t
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6151em;">
         </span>
         <span class="mord mathnormal">
          t
         </span>
        </span>
       </span>
      </span>
     </span>
     的左右端点，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        b 
        
       
         e 
        
        
        
          l 
         
        
          i 
         
        
       
      
        bel_i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
         </span>
         <span class="mord mathnormal">
          b
         </span>
         <span class="mord mathnormal">
          e
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: -0.0197em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     表示下标
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        i 
        
       
      
        i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6595em;">
         </span>
         <span class="mord mathnormal">
          i
         </span>
        </span>
       </span>
      </span>
     </span>
     所在的块的编号。
    </p>
    <p>
     对于修改操作
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        l 
        
       
         , 
        
       
         r 
        
       
         , 
        
       
         w 
        
       
      
        l,r,w
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0197em;">
          l
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          r
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0269em;">
          w
         </span>
        </span>
       </span>
      </span>
     </span>
     ，如果
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        ∃ 
        
       
         t 
        
       
         , 
        
       
         b 
        
        
        
          l 
         
        
          t 
         
        
       
         ≤ 
        
       
         l 
        
       
         &lt; 
        
       
         r 
        
       
         ≤ 
        
       
         b 
        
        
        
          r 
         
        
          t 
         
        
       
      
        \exist t,bl_t\le l&lt;r\le br_t
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          ∃
         </span>
         <span class="mord mathnormal">
          t
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal">
          b
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2806em;">
              <span class="" style="top: -2.55em; margin-left: -0.0197em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 t
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ≤
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.7335em; vertical-align: -0.0391em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0197em;">
          l
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          &lt;
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.7719em; vertical-align: -0.136em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          r
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ≤
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
         </span>
         <span class="mord mathnormal">
          b
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           r
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2806em;">
              <span class="" style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 t
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，即同一块，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        t 
        
       
         = 
        
       
         b 
        
       
         e 
        
        
        
          l 
         
        
          l 
         
        
       
         = 
        
       
         b 
        
       
         e 
        
        
        
          l 
         
        
          r 
         
        
       
      
        t=bel_l=bel_r
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6151em;">
         </span>
         <span class="mord mathnormal">
          t
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
         </span>
         <span class="mord mathnormal">
          b
         </span>
         <span class="mord mathnormal">
          e
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3361em;">
              <span class="" style="top: -2.55em; margin-left: -0.0197em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                 l
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
         </span>
         <span class="mord mathnormal">
          b
         </span>
         <span class="mord mathnormal">
          e
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.1514em;">
              <span class="" style="top: -2.55em; margin-left: -0.0197em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                 r
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，如果其不在左右端点上，那么块内的排序性质就会被破坏；反之如果它们不在同一块，说明它们中间跨过了若干块整块的区间，我们发现
     <strong>
      被跨过的区间仍然保持有序
     </strong>
     。
    </p>
    <p>
     那么我们得到一个初步的修改方法：
    </p>
    <ul>
     <li>
      设左右端点所在的块分别在
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         l 
         
        
          b 
         
        
          = 
         
        
          b 
         
        
          e 
         
         
         
           l 
          
         
           l 
          
         
        
          , 
         
        
          r 
         
        
          b 
         
        
          = 
         
        
          b 
         
        
          e 
         
         
         
           l 
          
         
           r 
          
         
        
       
         lb=bel_l,rb=bel_r
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6944em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="mord mathnormal">
           b
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           b
          </span>
          <span class="mord mathnormal">
           e
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0197em;">
            l
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: -0.0197em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                  l
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           r
          </span>
          <span class="mord mathnormal">
           b
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
          </span>
          <span class="mord mathnormal">
           b
          </span>
          <span class="mord mathnormal">
           e
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0197em;">
            l
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1514em;">
               <span class="" style="top: -2.55em; margin-left: -0.0197em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                  r
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ，如果
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         l 
         
        
          b 
         
        
          = 
         
        
          r 
         
        
          b 
         
        
       
         lb=rb
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6944em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="mord mathnormal">
           b
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6944em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           r
          </span>
          <span class="mord mathnormal">
           b
          </span>
         </span>
        </span>
       </span>
      </span>
      ，就块内暴力加
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         w 
         
        
       
         w
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.4306em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0269em;">
           w
          </span>
         </span>
        </span>
       </span>
      </span>
      并快排更新；
     </li>
     <li>
      否则即
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         l 
         
        
          b 
         
        
          &lt; 
         
        
          r 
         
        
          b 
         
        
       
         lb&lt;rb
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7335em; vertical-align: -0.0391em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="mord mathnormal">
           b
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           &lt;
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6944em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           r
          </span>
          <span class="mord mathnormal">
           b
          </span>
         </span>
        </span>
       </span>
      </span>
      ，我们发现块
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         l 
         
        
          b 
         
        
          + 
         
        
          1 
         
        
          ∼ 
         
        
          r 
         
        
          b 
         
        
          − 
         
        
          1 
         
        
       
         lb+1\sim rb-1
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7778em; vertical-align: -0.0833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="mord mathnormal">
           b
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           +
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6444em;">
          </span>
          <span class="mord">
           1
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           ∼
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.7778em; vertical-align: -0.0833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           r
          </span>
          <span class="mord mathnormal">
           b
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           −
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6444em;">
          </span>
          <span class="mord">
           1
          </span>
         </span>
        </span>
       </span>
      </span>
      内仍然有序，那么不妨想线段树引入懒惰标记一样，我们搞一个加法标记，把整一块
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         t 
         
        
       
         t
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6151em;">
          </span>
          <span class="mord mathnormal">
           t
          </span>
         </span>
        </span>
       </span>
      </span>
      内所有元素同时加的数，用
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         t 
         
        
          a 
         
         
         
           g 
          
         
           t 
          
         
        
       
         tag_t
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8095em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           t
          </span>
          <span class="mord mathnormal">
           a
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0359em;">
            g
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2806em;">
               <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  t
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      记录下来，等到查询时再处理；只强制更新更新
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         l 
         
        
          ∼ 
         
        
          b 
         
         
         
           r 
          
          
          
            l 
           
          
            b 
           
          
         
        
       
         l\sim br_{lb}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6944em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           ∼
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
          </span>
          <span class="mord mathnormal">
           b
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0278em;">
            r
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                  <span class="mord mathnormal mtight">
                   b
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      和
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         b 
         
         
         
           l 
          
          
          
            r 
           
          
            b 
           
          
         
        
          ∼ 
         
        
          r 
         
        
       
         bl_{rb}\sim r
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
          </span>
          <span class="mord mathnormal">
           b
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0197em;">
            l
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: -0.0197em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                   r
                  </span>
                  <span class="mord mathnormal mtight">
                   b
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           ∼
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.4306em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           r
          </span>
         </span>
        </span>
       </span>
      </span>
      的数据和块
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         l 
         
        
          b 
         
        
          , 
         
        
          r 
         
        
          b 
         
        
       
         lb,rb
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="mord mathnormal">
           b
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           r
          </span>
          <span class="mord mathnormal">
           b
          </span>
         </span>
        </span>
       </span>
      </span>
      。
     </li>
    </ul>
    <p>
     <strong>
      这样子大大减少了排序的次数
     </strong>
     ，每次修改操作顶多
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        2 
        
       
         × 
        
        
         
         
           log 
          
         
           ⁡ 
          
         
        
          2 
         
        
       
         n 
        
       
      
        2\times \log_2n
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;">
         </span>
         <span class="mord">
          2
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          ×
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.9386em; vertical-align: -0.2441em;">
         </span>
         <span class="mop">
          <span class="mop">
           lo
           <span style="margin-right: 0.0139em;">
            g
           </span>
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.207em;">
              <span class="" style="top: -2.4559em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 2
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2441em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal">
          n
         </span>
        </span>
       </span>
      </span>
     </span>
     ，瓶颈在于快排。
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">modify</span><span class="token punctuation">(</span>ll t<span class="token punctuation">)</span><span class="token comment">//更新t块内数据</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>bl<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>br<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">sort</span><span class="token punctuation">(</span>b<span class="token operator">+</span>bl<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">,</span>b<span class="token operator">+</span>br<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>ll ql<span class="token punctuation">,</span>ll qr<span class="token punctuation">,</span>ll x<span class="token punctuation">)</span><span class="token comment">//l,r,w</span>
<span class="token punctuation">{<!-- --></span>
    ll lb<span class="token operator">=</span>bel<span class="token punctuation">[</span>ql<span class="token punctuation">]</span><span class="token punctuation">,</span>rb<span class="token operator">=</span>bel<span class="token punctuation">[</span>qr<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//左右端所在块</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>lb<span class="token operator">==</span>rb<span class="token punctuation">)</span><span class="token comment">//同一块</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>ql<span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>qr<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+=</span>x<span class="token punctuation">;</span>
        <span class="token function">modify</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//不同块</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>ql<span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>br<span class="token punctuation">[</span>lb<span class="token punctuation">]</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+=</span>x<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>bl<span class="token punctuation">[</span>rb<span class="token punctuation">]</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>qr<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+=</span>x<span class="token punctuation">;</span>
    <span class="token function">modify</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">modify</span><span class="token punctuation">(</span>rb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>lb<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>rb<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//lb+1~rb-1块打标记</span>
    tag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+=</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     接下来就是查询，其实就和修改所运用的思想差不多了。同样讨论
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        l 
        
       
         , 
        
       
         r 
        
       
      
        l,r
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0197em;">
          l
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          r
         </span>
        </span>
       </span>
      </span>
     </span>
     在或不在同一块的两种情况。如果同一块就直接
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        q 
        
       
         l 
        
       
         ∼ 
        
       
         q 
        
       
         r 
        
       
      
        ql\sim qr
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0197em;">
          ql
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ∼
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0359em;">
          q
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          r
         </span>
        </span>
       </span>
      </span>
     </span>
     扫过去（倒着枚举体检 break 凹时间也行、甚至乎二分，反正块内就是有序的），不同块就搜左右两边
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        l 
        
       
         ∼ 
        
       
         b 
        
        
        
          r 
         
         
         
           r 
          
         
           b 
          
         
        
       
      
        l\sim br_{rb}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0197em;">
          l
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ∼
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
         </span>
         <span class="mord mathnormal">
          b
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           r
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3361em;">
              <span class="" style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                  r
                 </span>
                 <span class="mord mathnormal mtight">
                  b
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     和
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        b 
        
        
        
          l 
         
         
         
           r 
          
         
           b 
          
         
        
       
         ∼ 
        
       
         r 
        
       
      
        bl_{rb}\sim r
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
         </span>
         <span class="mord mathnormal">
          b
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3361em;">
              <span class="" style="top: -2.55em; margin-left: -0.0197em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                  r
                 </span>
                 <span class="mord mathnormal mtight">
                  b
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ∼
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          r
         </span>
        </span>
       </span>
      </span>
     </span>
     ，至于中间的整块整块的，按块二分就好。
    </p>
    <pre><code class="prism language-cpp">ll <span class="token function">find</span><span class="token punctuation">(</span>ll ql<span class="token punctuation">,</span>ll qr<span class="token punctuation">,</span>ll x<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	ll l<span class="token operator">=</span>ql<span class="token punctuation">,</span>r<span class="token operator">=</span>qr<span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>l<span class="token operator">&lt;=</span>r<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		ll mid<span class="token operator">=</span><span class="token punctuation">(</span>l<span class="token operator">+</span>r<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span>mid<span class="token punctuation">]</span><span class="token operator">&lt;</span>x<span class="token punctuation">)</span>l<span class="token operator">=</span>mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> r<span class="token operator">=</span>mid<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> qr<span class="token operator">-</span>l<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
ll <span class="token function">query</span><span class="token punctuation">(</span>ll ql<span class="token punctuation">,</span>ll qr<span class="token punctuation">,</span>ll x<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ll ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>lb<span class="token operator">=</span>bel<span class="token punctuation">[</span>ql<span class="token punctuation">]</span><span class="token punctuation">,</span>rb<span class="token operator">=</span>bel<span class="token punctuation">[</span>qr<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>lb<span class="token operator">==</span>rb<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ret<span class="token operator">+=</span><span class="token function">find</span><span class="token punctuation">(</span>ql<span class="token punctuation">,</span>qr<span class="token punctuation">,</span>x<span class="token operator">-</span>tag<span class="token punctuation">[</span>lb<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>ql<span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>br<span class="token punctuation">[</span>lb<span class="token punctuation">]</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span>tag<span class="token punctuation">[</span>lb<span class="token punctuation">]</span><span class="token operator">&gt;=</span>x<span class="token punctuation">)</span>ret<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>bl<span class="token punctuation">[</span>rb<span class="token punctuation">]</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>qr<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span>tag<span class="token punctuation">[</span>rb<span class="token punctuation">]</span><span class="token operator">&gt;=</span>x<span class="token punctuation">)</span>ret<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>lb<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>rb<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    ret<span class="token operator">+=</span><span class="token function">find</span><span class="token punctuation">(</span>bl<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>br<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token operator">-</span>tag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_82">
     </a>
     代码
    </h3>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;bits/stdc++.h&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ll</span> <span class="token expression"><span class="token keyword">long</span> <span class="token keyword">long</span></span></span>
<span class="token keyword">const</span> ll N<span class="token operator">=</span><span class="token number">1e6</span><span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">;</span>
ll n<span class="token punctuation">,</span>q<span class="token punctuation">,</span>a<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
ll tag<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//加法标记</span>
ll bSize<span class="token punctuation">,</span>cnt_b<span class="token punctuation">,</span>bel<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span>bl<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span>br<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">,</span>b<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    bSize<span class="token operator">=</span><span class="token function">sqrt</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cnt_b<span class="token operator">=</span>n<span class="token operator">/</span>bSize<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>n<span class="token operator">%</span>bSize<span class="token punctuation">)</span>cnt_b<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        bel<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span>bSize<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>cnt_b<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        bl<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">(</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>bSize<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        br<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>i<span class="token operator">*</span>bSize<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    br<span class="token punctuation">[</span>cnt_b<span class="token punctuation">]</span><span class="token operator">=</span>n<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>cnt_b<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token function">sort</span><span class="token punctuation">(</span>b<span class="token operator">+</span>bl<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>b<span class="token operator">+</span>br<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">modify</span><span class="token punctuation">(</span>ll t<span class="token punctuation">)</span><span class="token comment">//更新t块内数据</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>bl<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>br<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    b<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">sort</span><span class="token punctuation">(</span>b<span class="token operator">+</span>bl<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">,</span>b<span class="token operator">+</span>br<span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span>ll ql<span class="token punctuation">,</span>ll qr<span class="token punctuation">,</span>ll x<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ll lb<span class="token operator">=</span>bel<span class="token punctuation">[</span>ql<span class="token punctuation">]</span><span class="token punctuation">,</span>rb<span class="token operator">=</span>bel<span class="token punctuation">[</span>qr<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//左右端所在块</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>lb<span class="token operator">==</span>rb<span class="token punctuation">)</span><span class="token comment">//同一块</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>ql<span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>qr<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+=</span>x<span class="token punctuation">;</span>
        <span class="token function">modify</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//不同块</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>ql<span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>br<span class="token punctuation">[</span>lb<span class="token punctuation">]</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+=</span>x<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>bl<span class="token punctuation">[</span>rb<span class="token punctuation">]</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>qr<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+=</span>x<span class="token punctuation">;</span>
    <span class="token function">modify</span><span class="token punctuation">(</span>lb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">modify</span><span class="token punctuation">(</span>rb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>lb<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>rb<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//lb+1~rb-1块打标记</span>
    tag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+=</span>x<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
ll <span class="token function">find</span><span class="token punctuation">(</span>ll ql<span class="token punctuation">,</span>ll qr<span class="token punctuation">,</span>ll x<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	ll l<span class="token operator">=</span>ql<span class="token punctuation">,</span>r<span class="token operator">=</span>qr<span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>l<span class="token operator">&lt;=</span>r<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		ll mid<span class="token operator">=</span><span class="token punctuation">(</span>l<span class="token operator">+</span>r<span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>b<span class="token punctuation">[</span>mid<span class="token punctuation">]</span><span class="token operator">&lt;</span>x<span class="token punctuation">)</span>l<span class="token operator">=</span>mid<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> r<span class="token operator">=</span>mid<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> qr<span class="token operator">-</span>l<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
ll <span class="token function">query</span><span class="token punctuation">(</span>ll ql<span class="token punctuation">,</span>ll qr<span class="token punctuation">,</span>ll x<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ll ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>lb<span class="token operator">=</span>bel<span class="token punctuation">[</span>ql<span class="token punctuation">]</span><span class="token punctuation">,</span>rb<span class="token operator">=</span>bel<span class="token punctuation">[</span>qr<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>lb<span class="token operator">==</span>rb<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ret<span class="token operator">+=</span><span class="token function">find</span><span class="token punctuation">(</span>ql<span class="token punctuation">,</span>qr<span class="token punctuation">,</span>x<span class="token operator">-</span>tag<span class="token punctuation">[</span>lb<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>ql<span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>br<span class="token punctuation">[</span>lb<span class="token punctuation">]</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span>tag<span class="token punctuation">[</span>lb<span class="token punctuation">]</span><span class="token operator">&gt;=</span>x<span class="token punctuation">)</span>ret<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>bl<span class="token punctuation">[</span>rb<span class="token punctuation">]</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>qr<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span>tag<span class="token punctuation">[</span>rb<span class="token punctuation">]</span><span class="token operator">&gt;=</span>x<span class="token punctuation">)</span>ret<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span>lb<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>rb<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    ret<span class="token operator">+=</span><span class="token function">find</span><span class="token punctuation">(</span>bl<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>br<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>x<span class="token operator">-</span>tag<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%lld%lld"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>n<span class="token punctuation">,</span><span class="token operator">&amp;</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&lt;=</span>n<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%lld"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>q<span class="token operator">--</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> op<span class="token punctuation">;</span>
        ll l<span class="token punctuation">,</span>r<span class="token punctuation">,</span>x<span class="token punctuation">;</span>
        cin<span class="token operator">&gt;&gt;</span>op<span class="token punctuation">;</span>
        <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%lld%lld%lld"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>l<span class="token punctuation">,</span><span class="token operator">&amp;</span>r<span class="token punctuation">,</span><span class="token operator">&amp;</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>op<span class="token operator">==</span><span class="token char">'M'</span><span class="token punctuation">)</span><span class="token function">add</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span>r<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%lld\n"</span><span class="token punctuation">,</span><span class="token function">query</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span>r<span class="token punctuation">,</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f36303530363130352f:61727469636c652f64657461696c732f313436323835383433" class_="artid" style="display:none">
 </p>
</div>


