---
arturl_encode: "6874747073:3a2f2f626c6f672e6373646e2e6e65742f74797573746c692f:61727469636c652f64657461696c732f313436323836353034"
layout: post
title: "IP-协议"
date: 2025-03-15 22:29:01 +0800
description: "IP 协议是 TCP/IP 协议簇中的核心协议，也是 TCP/IP 协议的载体，IP 协议规定了数据传输时的基本单元和格式。从前面介绍的可以看出，IP 协议位于以太网 MAC 帧格式的数据段，IP 协议内容由IP 首部和数据字段组成。所有的 TCP、UDP 及 ICMP 数据都以 IP 数据报格式传输。"
keywords: "IP 协议"
categories: ['计算机网络']
tags: ['Wireshark', 'Tcp', 'Ip', 'Ip']
artid: "146286504"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146286504
    alt: "IP-协议"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146286504
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146286504
cover: https://bing.ee123.net/img/rand?artid=146286504
image: https://bing.ee123.net/img/rand?artid=146286504
img: https://bing.ee123.net/img/rand?artid=146286504
---

# IP 协议

## IP 协议

### 概述

IP 协议是 TCP/IP 协议簇中的核心协议，也是 TCP/IP 协议的载体，IP 协议规定了数据传输时的基本单元和格式。从前面介绍的可以看出，IP 协议位于以太网 MAC 帧格式的数据段，IP 协议内容由IP 首部和数据字段组成。所有的 TCP、UDP 及 ICMP 数据都以 IP 数据报格式传输

### 数据包格式

IP 数据包格式如图所示。
  
![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/09a839a583864335837b568e0a7652bd.png)
  
前 20 个字节和紧跟其后的可选字段是 IP 数据报的首部，前 20 个字节是固定的，后面可选字段是可有可无的，首部的每一行以 32 位（4 个字节）为单位。每个字节传输规则为由比特最高位到最低位的顺序逐一进行发送，4 字节的 32bit 值按照以下次序传输：首先 7-0bit，其次 15-8 bit，然后 23-16bit，最后是 31- 24bit。

* 版本：4 位 IP 版本号（Version），这个值设置为二进制的 0100 时表示 IPv4，设置为 0110 时表示 IPv6，目前使用比较多的 IP 协议版本号是 4。
* 首部长度：4 位首部长度（IHL，Internet Header Length），表示 IP 首部一共有多少个 32 位（4 个字节）。在没有可选字段时，IP 首部长度为 20 个字节，因此首部长度的值为 5。
* 服务类型：8 位服务类型（TOS，Type of service），该字段被划分成两个子字段：3 位优先级字段（现在已经基本忽略掉了）和 4 位 TOS 字段，最后一位固定为 0。服务类型为 0 时表示一般服务。
* 总长度：16 位 IP 数据报总长度（Total Length），包括 IP 首部和 IP 数据部分，以字节为单位。我们利用 IP 首部长度和 IP 数据报总长度，就可以知道 IP 数据报中数据内容的起始位置和长度。由于该字段长16bit，所以 IP 数据报最长可达 65535 字节。尽管理论上可以传输长达 65535 字节的 IP 数据报，但实际上还要考虑网络的最大承载能力等因素。
* 标识：16 位标识（Identification）字段，用来标识主机发送的每一份数据报。通常每发送一份报文它的值就会加 1。
* 标志：3 位标志（Flags）字段，
  + 第 1 位为保留位；
  + 第 2 位表示禁止分片
    - 1：表示不分片，用来cesium接口的 MTU 大小的，例如以太网就是 1500
    - 0：允许分片；
  + 第 3 位标识更多分片（除了数据报的最后一个分片外，其它分片都为 1）
    - 1：表示还有分片，
    - 0：最后一个分片。
* 片偏移：13 位片偏移（Fragment Offset），在接收方进行数据报重组时用来标识分片的顺序。
* 生存时间：8 位生存时间字段，TTL（Time To Live）域防止丢失的数据包在无休止的传播，一般被设置为 64 或者 128。
* 协议：8 位协议（Protocol）类型，表示此数据报所携带上层数据使用的协议类型，ICMP 为 1，TCP为 6，UDP 为 17。
* 首部校验和：16 位首部校验和（Header Checksum），该字段只校验数据报的首部，不包含数据部分；校验 IP 数据报头部是否被破坏、篡改和丢失等。
* 源 IP 地址：32 位源 IP 地址（Source Address），即发送端的 IP 地址，如 192.168.1.123。
* 目的 IP 地址：32 位目的 IP 地址（Destination Address），即接收端的 IP 地址，如 192.168.1.102。
* 可选字段：是数据报中的一个可变长度的可选信息，选项字段以 32bit 为界，不足时插入值为 0 的填充字节，保证 IP 首部始终是 32bit 的整数倍。

### 首部校验和

以上内容是对 IP 首部格式的详细阐述，还需要补充的内容是 IP 首部校验和的计算方法，其计算步骤
  
如下：

* 将 16 位检验和字段置为 0，然后将 IP 首部按照 16 位分成多个单元；
* 对各个单元采用反码加法运算（即高位溢出位会加到低位，通常的补码运算是直接丢掉溢出的高位）；
* 此时仍然可能出现进位的情况，将得到的和再次分成高 16 位和低 16 位进行累加；
* 最后将得到的和的反码填入校验和字段。

### 实例分析

#### 实例一

例如，我们使用 IP 协议发送一个 IP 数据报总长度为 60 个字节（有效数据为 40 个字节）的数据包，

* 发送端 IP 地址为 192.168.1.10，
* 接收端 IP 地址为 192.168.1.102，则 IP 首部数据如下

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/89b6430d3ecc495d8439a49cbc985919.png)
  
按照上述提到的 IP 首部校验和的方法计算 IP 首部校验和，即：
  
0x4500 + 0x003C + 0x0000 + 0x4000 + 0x4001 + 0x0000(计算时强制置 0) + 0xc0a8 + 0x010a + 0xc0a8 +0x0166 = 0x248FD
  
0x0002 + 0x48FD = 0x000048FF（此种情况并未出现进位）
  
0x0000+ 0x48FF= 0x48FF（此种情况并未出现进位）
  
check\_sum = ~0x48FF（按位取反）= 0xb700

### 分片

一个主机打算发送4000字节的IP数据报（20字节IP首部加上3980字节IP数据区域，假设没有IP数据报首部选项字段），且该数据报必须通过一条MTU为1500字节的以太网链路。这就意味着源始IP数据报中3980字节数据必须被分配为3个独立的数据报分片（其中的每个分片也是一个IP数据报）。假定初始IP数据报贴上的标识号为666，那么

1. 第一个分片的数据报总大小为1500字节（1480字节数据大小+20字节IP数据报首部），
   `3 位标志的值为 b001 表示允许分片，并且还有更多分片`
   ，分片偏移量为0。
2. 第二个分片的数据报大小也为1500字节，
   `3 位标志的值为 b001 表示允许分片，并且还有更多分片`
   ，分片偏移量为185（185\*8=1480）。
3. 第三个分片的数据报大小为1040（3980-1480-1480+20），
   `3 位标志的值为 b000 表示允许分片，但是没有更多分片`
   ，分片偏移量为370（185+185）。
4. ![请添加图片描述](https://i-blog.csdnimg.cn/direct/f75f7e30eb2449198656b1a2cb1e5b66.png)

### 抓包分析

![请添加图片描述](https://i-blog.csdnimg.cn/direct/563ef13e76e94835a010b09af791a7e3.png)

### 参考

* 正点原子《开拓者之FPGA开发指南V3.2》
* LwIP应用开发实战指南—基于STM32