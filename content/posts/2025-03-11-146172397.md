---
layout: post
title: "Spring-Boot中利用Redis解决接口幂等性问题"
date: 2025-03-11 10:36:13 +0800
description: "通过上述方案，可有效避免重复请求导致的数据不一致问题，适用于支付、下单等高风险接口。"
keywords: "Spring Boot中利用Redis解决接口幂等性问题"
categories: ['未分类']
tags: ['Spring', 'Spring', 'Redis', 'Java', 'Boot']
artid: "146172397"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146172397
    alt: "Spring-Boot中利用Redis解决接口幂等性问题"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146172397
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146172397
cover: https://bing.ee123.net/img/rand?artid=146172397
image: https://bing.ee123.net/img/rand?artid=146172397
img: https://bing.ee123.net/img/rand?artid=146172397
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Spring Boot中利用Redis解决接口幂等性问题
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     在Spring Boot中利用Redis解决接口幂等性问题，可以通过以下步骤实现：
    </p>
    <hr/>
    <h4>
     <a id="1__4">
     </a>
     <strong>
      1. 核心思路
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       唯一标识
      </strong>
      ：每次请求生成唯一ID（如UUID或业务标识），作为Redis的Key。
     </li>
     <li>
      <strong>
       原子操作
      </strong>
      ：使用Redis的
      <code>
       SETNX
      </code>
      （SET if Not Exists）命令，确保同一请求只能执行一次。
     </li>
     <li>
      <strong>
       过期机制
      </strong>
      ：为Key设置合理过期时间，避免无效数据堆积。
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="2__11">
     </a>
     <strong>
      2. 实现步骤
     </strong>
    </h4>
    <h5>
     <a id="21__13">
     </a>
     <strong>
      2.1 添加依赖
     </strong>
    </h5>
    <pre><code class="prism language-xml"><span class="token comment">&lt;!-- Spring Boot Starter Data Redis --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h5>
     <a id="22_RedisTemplate_22">
     </a>
     <strong>
      2.2 配置RedisTemplate
     </strong>
    </h5>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> <span class="token function">redisTemplate</span><span class="token punctuation">(</span><span class="token class-name">RedisConnectionFactory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> template <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setKeySerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StringRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        template<span class="token punctuation">.</span><span class="token function">setValueSerializer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GenericJackson2JsonRedisSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> template<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="23__37">
     </a>
     <strong>
      2.3 定义幂等性注解
     </strong>
    </h5>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Idempotent</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> <span class="token function">keyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">"idempotent:"</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> <span class="token function">expireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token number">5000</span><span class="token punctuation">;</span> <span class="token comment">// 过期时间（毫秒）</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="24_AOP_47">
     </a>
     <strong>
      2.4 AOP切面处理
     </strong>
    </h5>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Aspect</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IdempotentAspect</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Around</span><span class="token punctuation">(</span><span class="token string">"@annotation(idempotent)"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">handleIdempotent</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">Idempotent</span> idempotent<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> uniqueKey <span class="token operator">=</span> <span class="token function">generateUniqueKey</span><span class="token punctuation">(</span>joinPoint<span class="token punctuation">,</span> idempotent<span class="token punctuation">.</span><span class="token function">keyPrefix</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> expireTime <span class="token operator">=</span> idempotent<span class="token punctuation">.</span><span class="token function">expireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 尝试设置Redis Key（原子操作）</span>
        <span class="token class-name">Boolean</span> isSet <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setIfAbsent</span><span class="token punctuation">(</span>uniqueKey<span class="token punctuation">,</span> <span class="token string">"LOCK"</span><span class="token punctuation">,</span> expireTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>isSet <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span>isSet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"重复请求，请稍后再试"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> joinPoint<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 业务完成后可选延长过期时间或保留原设置</span>
            <span class="token comment">// redisTemplate.expire(uniqueKey, 60, TimeUnit.SECONDS);</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">generateUniqueKey</span><span class="token punctuation">(</span><span class="token class-name">ProceedingJoinPoint</span> joinPoint<span class="token punctuation">,</span> <span class="token class-name">String</span> prefix<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 从请求参数或Header中提取唯一ID（示例从参数获取）</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> requestId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>arg <span class="token operator">-&gt;</span> arg <span class="token keyword">instanceof</span> <span class="token class-name">String</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> arg<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">"req_"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> prefix <span class="token operator">+</span> requestId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="25__86">
     </a>
     <strong>
      2.5 控制器使用示例
     </strong>
    </h5>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/pay"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Idempotent</span><span class="token punctuation">(</span>keyPrefix <span class="token operator">=</span> <span class="token string">"order:pay:"</span><span class="token punctuation">,</span> expireTime <span class="token operator">=</span> <span class="token number">60000</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">payOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> orderId<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> reqId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 业务逻辑（如扣款、更新订单状态）</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token string">"支付成功"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <h4>
     <a id="3__101">
     </a>
     <strong>
      3. 关键点说明
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        唯一ID生成
       </strong>
       ：
      </p>
      <ul>
       <li>
        客户端生成唯一
        <code>
         reqId
        </code>
        （如UUID），或服务端根据业务参数生成（如
        <code>
         userId+orderId
        </code>
        ）。
       </li>
       <li>
        避免使用时间戳，防止碰撞。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        过期时间设置
       </strong>
       ：
      </p>
      <ul>
       <li>
        根据业务耗时设置合理过期时间，避免因业务未完成导致Key提前过期。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        异常处理
       </strong>
       ：
      </p>
      <ul>
       <li>
        业务异常需回滚操作，但幂等性Key保留，防止重复提交。
       </li>
       <li>
        可结合
        <code>
         @Transactional
        </code>
        管理事务与Redis操作的一致性。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        高并发优化
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用Redis集群提升吞吐量。
       </li>
       <li>
        对极高频请求可考虑本地缓存（如Caffeine）+ Redis双校验。
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h4>
     <a id="4__119">
     </a>
     <strong>
      4. 扩展场景
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       返回缓存结果
      </strong>
      ：首次请求处理完成后，将结果存入Redis，后续相同请求直接返回缓存结果。
     </li>
     <li>
      <strong>
       结合数据库
      </strong>
      ：关键操作在数据库层面添加唯一约束（如订单号唯一索引）。
     </li>
    </ul>
    <hr/>
    <p>
     通过上述方案，可有效避免重复请求导致的数据不一致问题，适用于支付、下单等高风险接口。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323530315f39303431373734332f:61727469636c652f64657461696c732f313436313732333937" class_="artid" style="display:none">
 </p>
</div>


