---
layout: post
title: "Docker-学习四Dockerfile-创建镜像-详细版"
date: 2025-03-06 16:21:15 +0800
description: "有了Dockerfile，当我们需要定制自己额外的需求时，只需在Dockerfile上添加或者修改指令，重新生成 image 即可， 省去了敲命令的麻烦。多个容器共享一个基础镜像，当某个容器修改了基础镜像的内容，例如/etc下的文件，其他容器的/etc不会改变，因为只有当使用镜像运行一个容器实例时，才会在rootfs只读层上挂载一层可读可写层，下面的都是可读层，原来的镜像不会被修改。： 在所基于的镜像上执行命令，并提交到新的的镜像中，会叠加一层，叠加的命令都会在其中。镜像的分层结构最大的好处就是共享资源。"
keywords: "Docker 学习（四）——Dockerfile 创建镜像 （详细版）"
categories: ['未分类']
tags: ['容器', '学习', 'Docker']
artid: "146064869"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146064869
    alt: "Docker-学习四Dockerfile-创建镜像-详细版"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146064869
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146064869
cover: https://bing.ee123.net/img/rand?artid=146064869
image: https://bing.ee123.net/img/rand?artid=146064869
img: https://bing.ee123.net/img/rand?artid=146064869
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Docker 学习（四）——Dockerfile 创建镜像 （详细版）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <hr id="hr-toc" name="tableOfContents"/>
    <p>
    </p>
    <p>
     <img alt="" height="538" src="https://i-blog.csdnimg.cn/direct/38f764ce8ec94b79a108f522656a97bd.png" width="871"/>
    </p>
    <h2 id="%E4%B8%80%E3%80%81Dockerfile%20%E7%AE%80%E4%BB%8B" name="%E4%B8%80%E3%80%81Dockerfile%20%E7%AE%80%E4%BB%8B">
     一、Dockerfile 简介
    </h2>
    <h3 id="1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFDockerfile" name="1%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFDockerfile">
     1、什么是Dockerfile
    </h3>
    <p>
     Dockerfile是一
     <span style="color:#515151">
      个
      <span style="background-color:#ffd900">
       文本格式的配置文件
      </span>
     </span>
     ，其内包含了一条条的指令(Instruction)，每一条指令构建一层，因此每一条指令的内容，就是描述该层应当如何构建。有了Dockerfile，当我们需要定制自己额外的需求时，只需在Dockerfile上添加或者修改指令，重新生成 image 即可， 省去了敲命令的麻烦。
    </p>
    <p>
     <strong>
      Dockerfile结构大致分为四个部分：
      <span style="background-color:#ffd900">
       基础镜像信息、维护者信息、镜像操作指令和容器启动时执行指令
      </span>
      。Dockerfile每行支持一条指令，每条指令可携带多个参数，支持使用以“#“号开头的注释。
     </strong>
    </p>
    <p>
     <span style="color:#494948">
      Dockerfile 中指令的一般格式为
     </span>
     <span style="color:#494948">
      INSTRUCTION arguments,
     </span>
     <span style="color:#494948">
      包括
     </span>
     <span style="color:#494948">
      “
     </span>
     <span style="color:#494948">
      配置指令" (配置镜像信息）和 “操作指令" (具体执行操作）
     </span>
    </p>
    <h3 id="2%E3%80%81Docker%20%E9%95%9C%E5%83%8F%E7%BB%93%E6%9E%84%E7%9A%84%E5%88%86%E5%B1%82" name="2%E3%80%81Docker%20%E9%95%9C%E5%83%8F%E7%BB%93%E6%9E%84%E7%9A%84%E5%88%86%E5%B1%82">
     <span style="color:#494948">
      2、Docker 镜像结构的分层
     </span>
    </h3>
    <p>
     <img alt="" height="771" src="https://i-blog.csdnimg.cn/direct/a248077987b948f2a231b70309161786.png" width="1708"/>
    </p>
    <p>
     Docker 镜像采用
     <strong>
      联合文件系统（UnionFS）
     </strong>
     ，通过分层叠加实现高效存储和构建。
     <span style="background-color:#ffd900">
      每层都是只读文件系统，最终容器运行时在最上层添加可写层
     </span>
     。
    </p>
    <p>
     ockerfile中的每一个run命令，都会生成一层镜像，新镜像是从base镜像上一层层叠加起来生成的，
     <span style="background-color:#ffd900">
      镜像的分层结构最大的好处就是共享资源
     </span>
     。多个容器共享一个基础镜像，当某个容器修改了基础镜像的内容，例如/etc下的文件，其他容器的/etc不会改变，因为只有当使用镜像运行一个容器实例时，才会在rootfs只读层上挂载一层可读可写层，下面的都是可读层，原来的镜像不会被修改。
    </p>
    <h3 id="3%E3%80%81Dockerfile%E6%9E%84%E9%80%A0%E9%95%9C%E5%83%8F%E5%8E%9F%E5%88%99%EF%BC%9A" name="3%E3%80%81Dockerfile%E6%9E%84%E9%80%A0%E9%95%9C%E5%83%8F%E5%8E%9F%E5%88%99%EF%BC%9A">
     3、Dockerfile构造镜像原则：
    </h3>
    <p>
     （1）
     <strong>
      单一职责
     </strong>
     ：每个层级只做每个层级的事
    </p>
    <p>
     （2）
     <strong>
      提供注释信息
     </strong>
     ：最好提供注释信息，以便他人理解
    </p>
    <p>
     （3）
     <strong>
      保持容器最小化
     </strong>
    </p>
    <p>
     （4）
     <strong>
      合理选择基础镜像
     </strong>
     ：基础镜像的选择很重要，尽量选择成熟易用的基础镜像版本
    </p>
    <p>
     （5）
     <strong>
      最小化镜像层数
     </strong>
     ：镜像层数不宜过多，尽量精简，否则容易出错，也可能会影响加载速度
    </p>
    <h3 id="4%E3%80%81Dockerfile%20%E6%8C%87%E4%BB%A4%E4%B8%8E%E5%B1%82%E7%94%9F%E6%88%90%E5%85%B3%E7%B3%BB%EF%BC%9A" name="4%E3%80%81Dockerfile%20%E6%8C%87%E4%BB%A4%E4%B8%8E%E5%B1%82%E7%94%9F%E6%88%90%E5%85%B3%E7%B3%BB%EF%BC%9A">
     <strong>
      4、Dockerfile 指令与层生成关系：
     </strong>
    </h3>
    <table border="1" cellpadding="1" cellspacing="1" style="width:700px">
     <tbody>
      <tr>
       <td>
        指令类型
       </td>
       <td>
        是否生成新层
       </td>
       <td>
        典型指令
       </td>
       <td>
        优化建议
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         基础层
        </strong>
       </td>
       <td>
        是
       </td>
       <td>
        <strong>
         FROM
        </strong>
       </td>
       <td>
        选择体积小的基础镜像（如 busybox、alpine）
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         文件操作
        </strong>
       </td>
       <td>
        是
       </td>
       <td>
        <strong>
         COPY / ADD/RUN
        </strong>
       </td>
       <td>
        合并文件操作到 RUN 指令
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         配置指令
        </strong>
       </td>
       <td>
        否（元数据层）
       </td>
       <td>
        <strong>
         ENV / LABEL / EXPOSE
        </strong>
       </td>
       <td>
        集中声明式配置
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         构建阶段
        </strong>
       </td>
       <td>
        独立层组
       </td>
       <td>
        <strong>
         FROM ... AS builder
        </strong>
       </td>
       <td>
        使用多阶段减少最终层数
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         入口指令
        </strong>
       </td>
       <td>
        是
       </td>
       <td>
        <strong>
         CMD / ENTRYOINT
        </strong>
       </td>
       <td>
        保持单一入口点
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <img alt="" height="232" src="https://i-blog.csdnimg.cn/direct/343f1a2d84534421bc42f9495b05edf2.png" width="1365"/>
    </p>
    <h2 id="%E4%BA%8C%E3%80%81Dockerfile%20%E6%93%8D%E4%BD%9C%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4" name="%E4%BA%8C%E3%80%81Dockerfile%20%E6%93%8D%E4%BD%9C%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4">
     <span style="color:#494948">
      二、Dockerfile 操作常用指令
     </span>
    </h2>
    <p>
     <img alt="" height="678" src="https://i-blog.csdnimg.cn/direct/4c0e366ceac14f19b63560fcbc795cc1.png" width="1215"/>
    </p>
    <p>
     <span style="color:#494948">
      <span style="background-color:#ffd900">
       FROM 镜像
      </span>
      ：
      <strong>
       指定新镜像的基础镜像
      </strong>
      ，
     </span>
     <strong>
      第一条指令必须为FROM 指令，每创建一个镜像就需要一条 FROM 指令。
     </strong>
    </p>
    <p>
     <span style="background-color:#ffd900">
      <strong>
       RUN 命令
      </strong>
     </span>
     ： 在所基于的镜像上执行命令，并提交到新的的镜像中，会叠加一层，叠加的命令都会在其中。
    </p>
    <p>
     <span style="background-color:#ffd900">
      <strong>
       COPY
      </strong>
      源文件/目录  目标文件/目录
     </span>
     ： （只复制本地主机上的文件/目录复制到目标地点，源文件/目录要与Dockerfile 在相同的目录中
    </p>
    <p>
     <span style="background-color:#ffd900">
      <strong>
       ADD
      </strong>
      源文件/目录 目标文件/目录 ：
     </span>
     增强版COPY，支持URL自动下载和压缩包
     <span style="background-color:#ffd900">
      自动解压
     </span>
     （tar/gzip等）。
     <span style="color:#373736">
      COPY与 ADD 指令功能类似，当使用本地目录为源目录时，推荐使用 COPY。
     </span>
    </p>
    <p>
     <span style="background-color:#ffd900">
      ENV 环境变量 变量值
     </span>
     ：设置环境变量（运行时持久生效）
    </p>
    <p>
     <span style="background-color:#ffd900">
      WORKDIR 路径
     </span>
     <strong>
      <span style="background-color:#ffd900">
       /home
      </span>
      ：
     </strong>
     为后续的 RUN、CMD、ENTRYPOINT 指定工作目录
    </p>
    <p>
     <span style="background-color:#ffd900">
      VOLUME [“目录”]
     </span>
     ：在容器中创建一个挂载点
    </p>
    <p>
     <span style="background-color:#ffd900">
      ENTRYPOINT ["要运行的程序", "参数 1", "参数 2"] ：
     </span>
     设定容器启动时第一个运行的命令及其参
     <strong>
      数
     </strong>
     。
    </p>
    <p>
     <span style="background-color:#ffd900">
      <strong>
       CMD
      </strong>
      ["要运行的程序", "参数1", "参数2"]
     </span>
     ：
     <span style="color:#4d4d4c">
      每个 Dockerfile 只能有 CMD 命令
     </span>
     <span style="color:#373736">
      如果指定了多条命令，只有最后一条会被执行 如果用户启动容器时候手动指定了运行的命令（作为 run口命令的参数），则会覆盖掉 CMD 指定的命令。
     </span>
     <span style="color:#be191c">
      <strong>
       注意优先级：RUN&gt;ENTRYPOINT&gt;CMD
      </strong>
     </span>
    </p>
    <p>
     <span style="background-color:#ffd900">
      EXPOSE 端口号
     </span>
     :指定新镜像加载到 Docker 时要开启的端口
    </p>
    <p>
     <span style="background-color:#ffd900">
      LABEL &lt;key&gt;=&lt;value&gt;
     </span>
     :添加元数据（镜像作者、版本等）
    </p>
    <h3 id="Dockerfile%20%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E%EF%BC%9A" name="Dockerfile%20%E6%96%87%E4%BB%B6%E8%AF%B4%E6%98%8E%EF%BC%9A">
     <strong>
      Dockerfile 文件说明：
     </strong>
    </h3>
    <ul>
     <li>
      每一行以Dockerfile的指令开头，指令不区分大小写，但是惯例使用大写
     </li>
     <li>
      使用 # 开始作为注释
     </li>
     <li>
      每一行只支持一条指令，每条指令可以携带多个参数
     </li>
     <li>
      指令按文件的顺序从上+
     </li>
     <li>
      至下进行执行
     </li>
     <li>
      每个指令的执行会生成一个新的镜像层，为了减少分层和镜像大小，尽可能将多条指令合并成一条指令
     </li>
     <li>
      制作镜像一般可能需要反复多次，每次执行dockfile都按顺序执行，从头开始，已经执行过的指令已经缓存，不需要再执行，后续有一行指令没执行过，再往后的指令将会重新执行，所以为加速镜像制作，将最常变化的内容放下dockerfile的文件的后面
     </li>
    </ul>
    <h2 id="%E4%B8%89%E3%80%81%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F%C2%A0" name="%E4%B8%89%E3%80%81%E5%88%B6%E4%BD%9C%E9%95%9C%E5%83%8F%C2%A0">
     三、制作镜像
    </h2>
    <h3 id="1%E3%80%81%E5%A6%82%E4%BD%95%E5%88%B6%E4%BD%9CDocker%20%E9%95%9C%E5%83%8F" name="1%E3%80%81%E5%A6%82%E4%BD%95%E5%88%B6%E4%BD%9CDocker%20%E9%95%9C%E5%83%8F">
     1、如何制作Docker 镜像？
    </h3>
    <p>
     制作docker镜像主要有两种方式：
     <span style="background-color:#ffd900">
      基于容器提交（docker commit）
     </span>
     和
     <span style="background-color:#ffd900">
      基于Dockerfile构建（docker build）。
     </span>
    </p>
    <h5 id="%C2%A0%C2%A0%C2%A0%E4%B8%8B%E9%9D%A2%E5%B0%86%E5%85%B7%E4%BD%93%E4%BB%8B%E7%BB%8D%E5%A6%82%E4%BD%95%E8%87%AA%E8%A1%8C%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%B8%A6%E6%9C%89%20SSH%20%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%95%9C%E5%83%8F%E3%80%82" name="%C2%A0%C2%A0%C2%A0%E4%B8%8B%E9%9D%A2%E5%B0%86%E5%85%B7%E4%BD%93%E4%BB%8B%E7%BB%8D%E5%A6%82%E4%BD%95%E8%87%AA%E8%A1%8C%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%B8%A6%E6%9C%89%20SSH%20%E6%9C%8D%E5%8A%A1%E7%9A%84%E9%95%9C%E5%83%8F%E3%80%82">
     <strong>
      下面将具体介绍如何自行创建一个带有 SSH 服务的镜像。
     </strong>
    </h5>
    <h3 id="2.%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9Adocker%20commit%20%E6%89%8B%E5%8A%A8%E6%8F%90%E4%BA%A4%E5%AE%B9%E5%99%A8%E4%B8%BA%E9%95%9C%E5%83%8F" name="2.%E6%96%B9%E6%B3%95%E4%B8%80%EF%BC%9Adocker%20commit%20%E6%89%8B%E5%8A%A8%E6%8F%90%E4%BA%A4%E5%AE%B9%E5%99%A8%E4%B8%BA%E9%95%9C%E5%83%8F">
     2.方法一：docker commit 手动提交容器为镜像
    </h3>
    <p>
     <strong>
      适用场景：
     </strong>
    </p>
    <ul>
     <li>
      <p>
       快速测试：临时修改容器并保存为镜像，用于调试或验证配置。
      </p>
     </li>
     <li>
      <p>
       简单实验：无需编写复杂脚本，适合新手入门。
      </p>
     </li>
    </ul>
    <p>
     <strong>
      优点：
     </strong>
     操作简单，适合快速测试，无需学习Dockerfile
    </p>
    <p>
     <strong>
      缺点：
     </strong>
     臃肿，维护困难
    </p>
    <h4 id="%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4%EF%BC%9A" name="%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4%EF%BC%9A">
     具体步骤：
    </h4>
    <h5 id="%EF%BC%881%EF%BC%89%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F" name="%EF%BC%881%EF%BC%89%E6%8B%89%E5%8F%96%E9%95%9C%E5%83%8F">
     （1）拉取镜像
    </h5>
    <pre><code class="language-cpp">[root@localhost ~]# docker pull ubuntu:18.04
[root@localhost ~]# docker images
REPOSITORY   TAG       IMAGE ID       CREATED         SIZE
ubuntu       18.04     f9a80a55f492   21 months ago   63.2MB
</code></pre>
    <h5 id="%EF%BC%882%EF%BC%89%E9%85%8D%E7%BD%AE%E8%BD%AF%E4%BB%B6%E6%BA%90" name="%EF%BC%882%EF%BC%89%E9%85%8D%E7%BD%AE%E8%BD%AF%E4%BB%B6%E6%BA%90">
     （2）配置软件源
    </h5>
    <pre><code class="language-cpp">[root@localhost ~]# docker run --name c1 -it --rm ubuntu:18.04 bash

root@b5c47f7812be:/# mv /etc/apt/sources.list{,.bak}
root@b5c47f7812be:/#  echo deb http://mirrors.163.com/ubuntu/ bionic main restricted universe multiverse &gt; /etc/apt/sources.list.d/163.list
        echo deb http://mirrors.163.com/ubuntu/ bionic-security main restricted universe multiverse &gt;&gt; /etc/apt/sources.list.d/163.list
        echo deb http://mirrors.163.com/ubuntu/ bionic-updates main restricted universe multiverse &gt;&gt; /etc/apt/sources.list.d/163.list
        echo deb http://mirrors.163.com/ubuntu/ bionic-proposed main restricted universe multiverse &gt;&gt; /etc/apt/sources.list.d/163.list
        echo deb http://mirrors.163.com/ubuntu/ bionic-backports main restricted universe multiverse &gt;&gt; /etc/apt/sources.list.d/163.list
        echo deb-src http://mirrors.163.com/ubuntu/ bionic main restricted universe multiverse &gt;&gt; /etc/apt/sources.list.d/163.list
        echo deb-src http://mirrors.163.com/ubuntu/ bionic-security main restricted universe multiverse &gt;&gt; /etc/apt/sources.list.d/163.list
        echo deb-src http://mirrors.163.com/ubuntu/ bionic-updates main restricted universe multiverse &gt;&gt; /etc/apt/sources.list.d/163.list
        echo deb-src http://mirrors.163.com/ubuntu/ bionic-proposed main restricted universe multiverse &gt;&gt; /etc/apt/sources.list.d/163.list
        echo deb-src http://mirrors.163.com/ubuntu/ bionic-backports main restricted universe multiverse &gt;&gt; /etc/apt/sources.list.d/163.list</code></pre>
    <h5 id="%EF%BC%883%EF%BC%89%20%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEssh%E6%9C%8D%E5%8A%A1" name="%EF%BC%883%EF%BC%89%20%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AEssh%E6%9C%8D%E5%8A%A1">
     （3） 安装配置ssh服务
    </h5>
    <pre><code class="language-cpp">root@b5c47f7812be:/# apt update
root@b5c47f7812be:/# apt install openssh-server -y
root@b5c47f7812be:/# mkdir -p /var/run/sshd
rot@b5c47f7812be:/# /usr/sbin/sshd -D &amp;
取消pam登录限制：
root@b5c47f7812be:/# sed -ri 's/session    required     pam_loginuid.so/#session    required     pam_loginuid.so/' /etc/pam.d/sshd</code></pre>
    <h5 id="%EF%BC%884%EF%BC%89%E9%85%8D%E7%BD%AE%E5%85%8D%E5%AF%86%E9%92%A5%E7%99%BB%E5%BD%95" name="%EF%BC%884%EF%BC%89%E9%85%8D%E7%BD%AE%E5%85%8D%E5%AF%86%E9%92%A5%E7%99%BB%E5%BD%95">
     （4）配置免密钥登录
    </h5>
    <pre><code class="language-cpp">[root@localhost ~]#  ssh-keygen -f ~/.ssh/id_rsa -P '' -q  #宿主机上面生成一对密钥对
[root@localhost ~]# cd ~/.ssh
[root@localhost .ssh]# cat id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC0tumSdw229Qtqmr07OOv6B1M3YH34Dso2ZJaQpWtBVrOFCt2mVESzjtf8roQkb0ESUWGAxqmCIMchtmL04LfCSYMlx6CkrReBCaBBjHg8EURTnIgHNC+qkXIhmVIxLiOFfhKZ4+NUWuZHpdVZE4zlKkEceCUaTplvFSAcBMdeQxb3dQeGnYAJyT+7HXBALuXEzumDts/6zkhfr5ejTbo3cSBy1zIIA6hgSaq38wPYMmwpxW8dqsXWtJhiNa1IXF1csbZdVKIko383DBh+KsdrjUW4HOkicrJoT6jZSn2MxggSfAIWkRp4d4G5497TaTz9h9I/EWZT3NRbIvP1z4Yh1JWaNjCwXfmTzZT7sdo0IcimNGtB0K2JBbqSJ8k9uoDi9q3SurfDzE2NvmfBYBgD26ZyycKJeoUS6RmbtkHUiFxSFoiX9fIjSz6oN0pR7htl/N/hsXi3UZzaV/63imgOEZ80pMz5EGCViDQxV/2H/kPL14hpdWKxi9xq6H1Z6+U= root@localhost.localdomain

root@b5c47f7812be:/# mkdir ~/.ssh
root@b5c47f7812be:/# echo ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC0tumSdw229Qtqmr07OOv6B1M3YH34Dso2ZJaQpWtBVrOFCt2mVESzjtf8roQkb0ESUWGAxqmCIMchtmL04LfCSYMlx6CkrReBCaBBjHg8EURTnIgHNC+qkXIhmVIxLiOFfhKZ4+NUWuZHpdVZE4zlKkEceCUaTplvFSAcBMdeQxb3dQeGnYAJyT+7HXBALuXEzumDts/6zkhfr5ejTbo3cSBy1zIIA6hgSaq38wPYMmwpxW8dqsXWtJhiNa1IXF1csbZdVKIko383DBh+KsdrjUW4HOkicrJoT6jZSn2MxggSfAIWkRp4d4G5497TaTz9h9I/EWZT3NRbIvP1z4Yh1JWaNjCwXfmTzZT7sdo0IcimNGtB0K2JBbqSJ8k9uoDi9q3SurfDzE2NvmfBYBgD26ZyycKJeoUS6RmbtkHUiFxSFoiX9fIjSz6oN0pR7htl/N/hsXi3UZzaV/63imgOEZ80pMz5EGCViDQxV/2H/kPL14hpdWKxi9xq6H1Z6+U= root@localhost.localdomain &gt;  ~/.ssh/authorized_keys

服务启动脚本：
root@b5c47f7812be:/# echo '#!/bin/bash' &gt; /run.sh
root@b5c47f7812be:/# echo /usr/sbin/sshd -D &gt;&gt; /run.sh
root@b5c47f7812be:/# chmod +x /run.sh
root@b5c47f7812be:/#
</code></pre>
    <h5 id="%EF%BC%885%EF%BC%89%E6%8F%90%E4%BA%A4%E9%95%9C%E5%83%8F" name="%EF%BC%885%EF%BC%89%E6%8F%90%E4%BA%A4%E9%95%9C%E5%83%8F">
     （5）提交镜像
    </h5>
    <pre><code class="language-cpp">[root@localhost .ssh]# docker commit c1 ssh:ubuntu_v1
sha256:96ed9e0701e36c933449c56f956cff2cabe87ad153321dc55d8baf9cbcb7fd0d
[root@localhost .ssh]# docker push ssh:ubuntu_v1
The push refers to repository [docker.io/library/ssh]
Get "https://registry-1.docker.io/v2/": net/http: request canceled while waiting for connection (Client.Timeout exceeded while awaiting headers)
[root@localhost .ssh]# docker images
REPOSITORY   TAG         IMAGE ID       CREATED          SIZE
ssh          ubuntu_v1   96ed9e0701e3   58 seconds ago   250MB
ubuntu       18.04       f9a80a55f492   21 months ago    63.2MB
</code></pre>
    <h5 id="%EF%BC%886%EF%BC%89%E9%AA%8C%E8%AF%81%E9%95%9C%E5%83%8F" name="%EF%BC%886%EF%BC%89%E9%AA%8C%E8%AF%81%E9%95%9C%E5%83%8F">
     （6）验证镜像
    </h5>
    <pre><code class="language-cpp">[root@localhost .ssh]# docker run -d -p 10022:22 ssh:ubuntu_v1 /run.sh
80a16ea16612f90a869ebf60120f685892a1707277697f7cde167ded4f7f0f4b

[root@localhost .ssh]# ssh 192.168.8.161 -p 10022     
The authenticity of host '[192.168.8.161]:10022 ([192.168.8.161]:10022)' can't be established.
ECDSA key fingerprint is SHA256:mMyHF3hJnJ5ogyvA7fyJsvWfVFKlCcGsK92IQSEoJYE.
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
Warning: Permanently added '[192.168.8.161]:10022' (ECDSA) to the list of known hosts.
Welcome to Ubuntu 18.04.6 LTS (GNU/Linux 4.18.0-553.el8_10.x86_64 x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage
This system has been minimized by removing packages and content that are
not required on a system that users do not log into.

To restore this content, you can run the 'unminimize' command.

The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

root@80a16ea16612:~#
</code></pre>
    <p>
     <img alt="" height="558" src="https://i-blog.csdnimg.cn/direct/d3e74d3188bf4334b42c89fbe935f1aa.png" width="1153"/>
    </p>
    <h3 id="3.Dockerfile%20%E6%A0%87%E5%87%86%E5%8C%96%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F" name="3.Dockerfile%20%E6%A0%87%E5%87%86%E5%8C%96%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F">
     3.Dockerfile 标准化构建镜像
    </h3>
    <p>
     <strong>
      适用场景：
     </strong>
    </p>
    <ul>
     <li>
      <p>
       标准化、可重复的镜像构建流程。
      </p>
     </li>
     <li>
      <p>
       需要版本控制、分层优化和自动化部署。
      </p>
     </li>
    </ul>
    <p>
     <strong>
      优点：
     </strong>
     镜像轻级，可版本控制，易于维护，支持自动化构建
    </p>
    <p>
     <strong>
      缺点：
     </strong>
     需要学习Dockerfile语法，编写较难且耗时
    </p>
    <h4 id="%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4%EF%BC%9A" name="%E5%85%B7%E4%BD%93%E6%AD%A5%E9%AA%A4%EF%BC%9A">
     具体步骤：
    </h4>
    <h5 id="%EF%BC%881%EF%BC%89%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95" name="%EF%BC%881%EF%BC%89%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95">
     （1）创建目录
    </h5>
    <pre><code class="language-cpp">[root@localhost ~]# mkdir ubuntu
[root@localhost ~]# cd ubuntu
</code></pre>
    <h5 id="%EF%BC%882%EF%BC%89%E7%BC%96%E8%BE%91Dockerfile%E6%96%87%E4%BB%B6" name="%EF%BC%882%EF%BC%89%E7%BC%96%E8%BE%91Dockerfile%E6%96%87%E4%BB%B6">
     （2）编辑Dockerfile文件
    </h5>
    <pre><code class="language-cpp">[root@localhost ubuntu]# vim Dockerfile
FROM ubuntu:18.04
LABEL Mail=admin@qq.com
RUN mv /etc/apt/sources.list /etc/apt/sources.list.bak
COPY 163.list /etc/apt/sources.list.d/163.list
RUN apt update &amp;&amp; apt install -y openssh-server &amp;&amp; mkdir -p /var/run/sshd
RUN  sed -ri 's/session    required     pam_loginuid.so/#session    required     pam_loginuid.so/' /etc/pam.d/sshd
COPY run.sh /run.sh
RUN chmod +x /run.sh &amp;&amp; mkdir /root/.ssh
COPY authorized_keys /root/.ssh/authorized_keys
EXPOSE 22/tcp
CMD ["/run.sh"]
</code></pre>
    <h5 id="%EF%BC%883%EF%BC%89%E6%8A%8A%E9%9C%80%E8%A6%81%E7%9A%84%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6%E5%88%B0%E5%88%9B%E5%BB%BA%E7%9A%84%E7%9B%AE%E5%BD%95%E4%B8%8B" name="%EF%BC%883%EF%BC%89%E6%8A%8A%E9%9C%80%E8%A6%81%E7%9A%84%E6%96%87%E4%BB%B6%E5%A4%8D%E5%88%B6%E5%88%B0%E5%88%9B%E5%BB%BA%E7%9A%84%E7%9B%AE%E5%BD%95%E4%B8%8B">
     （3）把需要的文件复制到创建的目录下
    </h5>
    <pre><code class="language-cpp">[root@localhost ubuntu]# vim 163.list
deb http://mirrors.163.com/ubuntu/ bionic main restricted universe multiverse
deb http://mirrors.163.com/ubuntu/ bionic-security main restricted universe multiverse
deb http://mirrors.163.com/ubuntu/ bionic-updates main restricted universe multiverse
deb http://mirrors.163.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb http://mirrors.163.com/ubuntu/ bionic-backports main restricted universe multiverse
deb-src http://mirrors.163.com/ubuntu/ bionic main restricted universe multiverse
deb-src http://mirrors.163.com/ubuntu/ bionic-security main restricted universe multiverse
deb-src http://mirrors.163.com/ubuntu/ bionic-updates main restricted universe multiverse
deb-src http://mirrors.163.com/ubuntu/ bionic-proposed main restricted universe multiverse
deb-src http://mirrors.163.com/ubuntu/ bionic-backports main restricted universe multiverse
[root@localhost ubuntu]# vim run.sh
#!/bin/bash
/usr/sbin/sshd -D
[root@localhost ubuntu]# vim authorized_keys
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC0tumSdw229Qtqmr07OOv6B1M3YH34Dso2ZJaQpWtBVrOFCt2mVESzjtf8roQkb0ESUWGAxqmCIMchtmL04LfCSYMlx6CkrReBCaBBjHg8EURTnIgHNC+qkXIhmVIxLiOFfhKZ4+NUWuZHpdVZE4zlKkEceCUaTplvFSAcBMdeQxb3dQeGnYAJyT+7HXBALuXEzumDts/6zkhfr5ejTbo3cSBy1zIIA6hgSaq38wPYMmwpxW8dqsXWtJhiNa1IXF1csbZdVKIko383DBh+KsdrjUW4HOkicrJoT6jZSn2MxggSfAIWkRp4d4G5497TaTz9h9I/EWZT3NRbIvP1z4Yh1JWaNjCwXfmTzZT7sdo0IcimNGtB0K2JBbqSJ8k9uoDi9q3SurfDzE2NvmfBYBgD26ZyycKJeoUS6RmbtkHUiFxSFoiX9fIjSz6oN0pR7htl/N/hsXi3UZzaV/63imgOEZ80pMz5EGCViDQxV/2H/kPL14hpdWKxi9xq6H1Z6+U= root@localhost.localdomain
</code></pre>
    <h5 id="%EF%BC%884%EF%BC%89%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F" name="%EF%BC%884%EF%BC%89%E6%9E%84%E5%BB%BA%E9%95%9C%E5%83%8F">
     （4）构建镜像
    </h5>
    <p>
     <img alt="" height="535" src="https://i-blog.csdnimg.cn/direct/1518eafc728a4dd0acf3f74979b67dab.png" width="1152"/>
    </p>
    <p>
     <img alt="" height="168" src="https://i-blog.csdnimg.cn/direct/ebd668a3b76b4499a5d504a1451a06e5.png" width="864"/>
    </p>
    <h5 id="%EF%BC%885%EF%BC%89%E9%AA%8C%E8%AF%81%E9%95%9C%E5%83%8F" name="%EF%BC%885%EF%BC%89%E9%AA%8C%E8%AF%81%E9%95%9C%E5%83%8F">
     （5）验证镜像
    </h5>
    <p>
     <img alt="" height="685" src="https://i-blog.csdnimg.cn/direct/59aa0fc8638740fa84a4037cd6beeb66.png" width="1692"/>
    </p>
    <h2 id="%E5%9B%9B%E3%80%81Dockerfile%20%E5%AE%9E%E6%88%98%20%E2%80%94%E2%80%94%E5%88%B6%E4%BD%9Cnginx%E9%95%9C%E5%83%8F" name="%E5%9B%9B%E3%80%81Dockerfile%20%E5%AE%9E%E6%88%98%20%E2%80%94%E2%80%94%E5%88%B6%E4%BD%9Cnginx%E9%95%9C%E5%83%8F">
     四、Dockerfile 实战 ——制作nginx镜像
    </h2>
    <pre><code class="language-cpp">[root@localhost ~]# mkdir docker/
[root@localhost ~]# cd docker/
[root@localhost ~]# wget http://nginx.org/download/nginx-1.26.3.tar.gz

[root@localhost docker]# vim Dockerfile
FROM centos:7
LABEL Mail=admin@qq.com
ADD nginx-1.26.3.tar.gz /mnt
WORKDIR /mnt/nginx-1.26.3
RUN yum install gcc make pcre-devel openssl-devel -y  &amp;&amp; \
./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-http_stub_status_module &amp;&amp; \
make &amp;&amp; make install &amp;&amp; \
rm -rf /mnt/nginx-1.26.3 &amp;&amp; \
yum clean all
EXPOSE 80 443
VOLUME ["/usr/local/nginx/html"]
CMD ["/usr/local/nginx/sbin/nginx","-g","daemon off"]</code></pre>
    <p>
     生成nginx镜像：
    </p>
    <p>
     <img alt="" height="793" src="https://i-blog.csdnimg.cn/direct/7725e888e797442790092a36b819149f.png" width="1269"/>
    </p>
    <p>
     根据错误日志，主要因 CentOS 7 官方软件源失效导致
     <code>
      yum
     </code>
     操作失败。我们可以编辑 Dockerfile，在执行
     <code>
      yum install
     </code>
     命令前，替换 CentOS 7 的默认软件源为可用镜像源（如阿里云源）
    </p>
    <pre><code class="language-cpp">FROM centos:7
LABEL Mail=admin@qq.com
ADD nginx-1.26.3.tar.gz /mnt
WORKDIR /mnt/nginx-1.26.3
#替换 CentOS 7 的默认软件源为阿里云源
RUN rm -rf /etc/yum.repos.d/CentOS-* \
    &amp;&amp; curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo \
    &amp;&amp; yum clean all &amp;&amp; yum makecache

RUN yum install gcc make pcre-devel openssl-devel -y  &amp;&amp; \
./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-http_stub_status_module &amp;&amp; \
make &amp;&amp; make install &amp;&amp; \
rm -rf /mnt/nginx-1.26.3 &amp;&amp; \
yum clean all
EXPOSE 80 443
VOLUME ["/usr/local/nginx/html"]
CMD ["/usr/local/nginx/sbin/nginx","-g","daemon off"]</code></pre>
    <p>
     可以发现生成的镜像体积较大
    </p>
    <h2 id="%E2%80%8B%E7%BC%96%E8%BE%91" name="%E2%80%8B%E7%BC%96%E8%BE%91">
     <img alt="" height="585" src="https://i-blog.csdnimg.cn/direct/1f47c19cc75e4e1da652750ab9c9dbfe.png" width="1297"/>
    </h2>
    <h4 id="%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87Dockerfile%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E5%B9%B6%E4%BC%98%E5%8C%96%E9%95%9C%E5%83%8F%EF%BC%8C%E5%90%8C%E6%97%B6%E7%A1%AE%E4%BF%9D%E9%95%9C%E5%83%8F%E5%AE%89%E5%85%A8%E6%80%A7%E5%92%8C%E6%9C%80%E5%B0%8F%E5%8C%96%E4%BD%93%E7%A7%AF%EF%BC%9F" name="%E5%A6%82%E4%BD%95%E9%80%9A%E8%BF%87Dockerfile%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E5%B9%B6%E4%BC%98%E5%8C%96%E9%95%9C%E5%83%8F%EF%BC%8C%E5%90%8C%E6%97%B6%E7%A1%AE%E4%BF%9D%E9%95%9C%E5%83%8F%E5%AE%89%E5%85%A8%E6%80%A7%E5%92%8C%E6%9C%80%E5%B0%8F%E5%8C%96%E4%BD%93%E7%A7%AF%EF%BC%9F">
     <span style="background-color:#ffd900">
      如何通过Dockerfile自动化构建并优化镜像，同时确保镜像安全性和最小化体积？
     </span>
    </h4>
    <p>
     （1）选择最小化基础镜像、合并指令减少镜像层数
    </p>
    <p>
     （2）多阶段构建（核心优化手段）
    </p>
    <p>
     （3）安全加固措施：非 Root 用户运行、定期更新基础镜像、漏洞扫描集成
    </p>
    <p>
     （4）高级优化技巧：依赖精准控制、压缩构建上下文、 二进制文件瘦身
    </p>
    <p>
     以下我通过
     <span style="background-color:#ffd900">
      多阶段构建
     </span>
     来实例制作nginx:v2
    </p>
    <pre><code class="language-cpp">[root@localhost docker]# cat Dockerfile
FROM centos:7 AS build
ADD nginx-1.26.3.tar.gz /mnt
WORKDIR /mnt/nginx-1.26.3
RUN rm -rf /etc/yum.repos.d/CentOS-* \
    &amp;&amp; curl -o /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo \
    &amp;&amp; yum clean all &amp;&amp; yum makecache
RUN yum install gcc make pcre-devel openssl-devel -y  &amp;&amp; \
./configure --prefix=/usr/local/nginx --with-http_ssl_module --with-http_stub_status_module &amp;&amp; \
make &amp;&amp; make install &amp;&amp; \
rm -rf /mnt/nginx-1.26.3 &amp;&amp; \
yum clean all


FROM centos:7
LABEL Mail=admin@qq.com
COPY --from=build /usr/local/nginx /usr/local/nginx
EXPOSE 80
VOLUME ["/usr/local/nginx/html"]
CMD ["/usr/local/nginx/sbin/nginx","-g","daemon off;"]

</code></pre>
    <p>
     <img alt="" height="637" src="https://i-blog.csdnimg.cn/direct/ab9f446b3feb481fa0889cac45cbce64.png" width="1294"/>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323430315f38333334323235312f:61727469636c652f64657461696c732f313436303634383639" class_="artid" style="display:none">
 </p>
</div>


