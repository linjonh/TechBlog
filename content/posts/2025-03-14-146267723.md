---
layout: post
title: "使用OpenAI-Agents实现流式输出"
date: 2025-03-14 21:33:54 +0800
description: "通过装饰器，我们创建了一个简单的工具函数，用于随机决定生成笑话的数量。通过OpenAI Agents框架实现的流式输出功能，不仅提供了更好的用户体验，还为AI应用开发提供了新的可能性。这种方法特别适合需要实时反馈的应用场景。"
keywords: "使用OpenAI Agents实现流式输出"
categories: ['Oi']
tags: ['深度学习', '人工智能', 'Python']
artid: "146267723"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146267723
    alt: "使用OpenAI-Agents实现流式输出"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146267723
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146267723
cover: https://bing.ee123.net/img/rand?artid=146267723
image: https://bing.ee123.net/img/rand?artid=146267723
img: https://bing.ee123.net/img/rand?artid=146267723
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     使用OpenAI Agents实现流式输出
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h3>
     <a id="_2">
     </a>
     引言
    </h3>
    <p>
     在AI应用开发中，流式输出（Stream Output）是提升用户体验的重要特性。本文将介绍如何使用OpenAI Agents框架实现一个能够实时生成笑话的智能助手，并通过流式输出实现交互式的响应效果。
    </p>
    <h3>
     <a id="_6">
     </a>
     完整代码
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> random

<span class="token keyword">from</span> agents <span class="token keyword">import</span> Agent<span class="token punctuation">,</span> ItemHelpers<span class="token punctuation">,</span> Runner<span class="token punctuation">,</span> function_tool


<span class="token decorator annotation punctuation">@function_tool</span>
<span class="token keyword">def</span> <span class="token function">how_many_jokes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>

<span class="token keyword">from</span> agents <span class="token keyword">import</span> Agent<span class="token punctuation">,</span> Runner<span class="token punctuation">,</span>RunConfig<span class="token punctuation">,</span>OpenAIProvider
run_config <span class="token operator">=</span> RunConfig<span class="token punctuation">(</span>model_provider <span class="token operator">=</span> OpenAIProvider<span class="token punctuation">(</span>
    api_key<span class="token operator">=</span><span class="token string">"your api key"</span><span class="token punctuation">,</span>
    base_url<span class="token operator">=</span><span class="token string">"https://open.bigmodel.cn/api/paas/v4/"</span><span class="token punctuation">,</span>
    use_responses<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span>


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    agent <span class="token operator">=</span> Agent<span class="token punctuation">(</span>
        name<span class="token operator">=</span><span class="token string">"Joker"</span><span class="token punctuation">,</span>
        instructions<span class="token operator">=</span><span class="token string">"First call the `how_many_jokes` tool, then tell that many jokes."</span><span class="token punctuation">,</span>
        tools<span class="token operator">=</span><span class="token punctuation">[</span>how_many_jokes<span class="token punctuation">]</span><span class="token punctuation">,</span>
        model<span class="token operator">=</span><span class="token string">"glm-4"</span>
    <span class="token punctuation">)</span>

    result <span class="token operator">=</span> Runner<span class="token punctuation">.</span>run_streamed<span class="token punctuation">(</span>
        agent<span class="token punctuation">,</span>
        <span class="token builtin">input</span><span class="token operator">=</span><span class="token string">"Hello"</span><span class="token punctuation">,</span>
        run_config<span class="token operator">=</span>run_config
    <span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=== Run starting ==="</span><span class="token punctuation">)</span>
    <span class="token keyword">async</span> <span class="token keyword">for</span> event <span class="token keyword">in</span> result<span class="token punctuation">.</span>stream_events<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># We'll ignore the raw responses event deltas</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"raw_response_event"</span><span class="token punctuation">:</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">elif</span> event<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"agent_updated_stream_event"</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Agent updated: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>event<span class="token punctuation">.</span>new_agent<span class="token punctuation">.</span>name<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token keyword">elif</span> event<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"run_item_stream_event"</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> event<span class="token punctuation">.</span>item<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"tool_call_item"</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-- Tool was called"</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> event<span class="token punctuation">.</span>item<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"tool_call_output_item"</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"-- Tool output: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>event<span class="token punctuation">.</span>item<span class="token punctuation">.</span>output<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> event<span class="token punctuation">.</span>item<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"message_output_item"</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"-- Message output:\n </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ItemHelpers<span class="token punctuation">.</span>text_message_output<span class="token punctuation">(</span>event<span class="token punctuation">.</span>item<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">pass</span>  <span class="token comment"># Ignore other event types</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"=== Run complete ==="</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">"""
$python .My_test\stream_itemstest.py  
=== Run starting ===
Agent updated: Joker
Agent updated: Joker
-- Tool was called
-- Message output:
 Here are 9 jokes for you:
1. Why don't scientists trust atoms? Because they make up everything!
2. Why did the scarecrow win an award? Because he was outstanding in his field!
3. Why did the math book look sad? Because it had too many problems!
4. Why did the cookie go to the doctor? Because it was feeling crummy!
5. Why did the bicycle fall over? Because it was two-tired!
6. Why did the cat sit on the computer? Because it wanted to keep an eye on the mouse!
7. Why did the teacher wear sunglasses? Because her students were so bright!
8. Why did the chicken cross the playground? To get to the other slide!
9. Why did the bookworm go to the gym? Because it heard the exercise was good for the mind!     
=== Run complete ===
OPENAI_API_KEY is not set, skipping trace export
"""</span>

</code></pre>
    <h3>
     <a id="_86">
     </a>
     核心功能实现
    </h3>
    <h4>
     <a id="1__88">
     </a>
     1. 自定义工具函数
    </h4>
    <pre><code class="prism language-python"><span class="token decorator annotation punctuation">@function_tool</span>
<span class="token keyword">def</span> <span class="token function">how_many_jokes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     通过装饰器
     <code>
      @function_tool
     </code>
     ，我们创建了一个简单的工具函数，用于随机决定生成笑话的数量。
    </p>
    <h4>
     <a id="2__96">
     </a>
     2. 智能代理配置
    </h4>
    <pre><code class="prism language-python">agent <span class="token operator">=</span> Agent<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">"Joker"</span><span class="token punctuation">,</span>
    instructions<span class="token operator">=</span><span class="token string">"First call the `how_many_jokes` tool, then tell that many jokes."</span><span class="token punctuation">,</span>
    tools<span class="token operator">=</span><span class="token punctuation">[</span>how_many_jokes<span class="token punctuation">]</span><span class="token punctuation">,</span>
    model<span class="token operator">=</span><span class="token string">"glm-4"</span>
<span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_106">
     </a>
     技术特点
    </h3>
    <h4>
     <a id="1__108">
     </a>
     1. 异步流式处理
    </h4>
    <ul>
     <li>
      使用
      <code>
       asyncio
      </code>
      实现异步操作
     </li>
     <li>
      通过
      <code>
       stream_events()
      </code>
      获取实时事件
     </li>
     <li>
      支持多种事件类型的处理
     </li>
    </ul>
    <h4>
     <a id="2__113">
     </a>
     2. 事件类型处理
    </h4>
    <p>
     主要处理三种类型的事件：
    </p>
    <ol>
     <li>
      raw_response_event：原始响应事件
     </li>
     <li>
      agent_updated_stream_event：代理更新事件
     </li>
     <li>
      run_item_stream_event：运行项目事件
     </li>
    </ol>
    <h4>
     <a id="3__119">
     </a>
     3. 实时反馈机制
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">async</span> <span class="token keyword">for</span> event <span class="token keyword">in</span> result<span class="token punctuation">.</span>stream_events<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> event<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"run_item_stream_event"</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> event<span class="token punctuation">.</span>item<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"tool_call_item"</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-- Tool was called"</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> event<span class="token punctuation">.</span>item<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> <span class="token string">"message_output_item"</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"-- Message output:\n </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ItemHelpers<span class="token punctuation">.</span>text_message_output<span class="token punctuation">(</span>event<span class="token punctuation">.</span>item<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_129">
     </a>
     应用场景
    </h3>
    <ol>
     <li>
      <p>
       <strong>
        娱乐应用
       </strong>
      </p>
      <ul>
       <li>
        智能笑话生成器
       </li>
       <li>
        互动式故事创作
       </li>
       <li>
        实时对话系统
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        教育领域
       </strong>
      </p>
      <ul>
       <li>
        趣味学习助手
       </li>
       <li>
        互动式教学工具
       </li>
       <li>
        学生参与度提升
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        客户服务
       </strong>
      </p>
      <ul>
       <li>
        实时响应系统
       </li>
       <li>
        智能客服助手
       </li>
       <li>
        用户体验优化
       </li>
      </ul>
     </li>
    </ol>
    <h3>
     <a id="_146">
     </a>
     实现效果
    </h3>
    <p>
     运行效果展示：
    </p>
    <pre><code class="prism language-plaintext">=== Run starting ===
Agent updated: Joker
-- Tool was called
-- Message output:
 Here are 9 jokes for you:
1. Why don't scientists trust atoms? ...
2. Why did the scarecrow win an award? ...
[更多笑话...]
=== Run complete ===
</code></pre>
    <h3>
     <a id="_161">
     </a>
     最佳实践
    </h3>
    <ol>
     <li>
      <p>
       <strong>
        事件处理
       </strong>
      </p>
      <ul>
       <li>
        合理分类事件类型
       </li>
       <li>
        优雅处理异常情况
       </li>
       <li>
        清晰的日志输出
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        性能优化
       </strong>
      </p>
      <ul>
       <li>
        异步处理提升效率
       </li>
       <li>
        合理的事件过滤
       </li>
       <li>
        资源使用优化
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        用户体验
       </strong>
      </p>
      <ul>
       <li>
        实时反馈
       </li>
       <li>
        清晰的输出格式
       </li>
       <li>
        友好的交互方式
       </li>
      </ul>
     </li>
    </ol>
    <h3>
     <a id="_178">
     </a>
     总结
    </h3>
    <p>
     通过OpenAI Agents框架实现的流式输出功能，不仅提供了更好的用户体验，还为AI应用开发提供了新的可能性。这种方法特别适合需要实时反馈的应用场景。
    </p>
    <h3>
     <a id="_182">
     </a>
     注意事项
    </h3>
    <p>
     由于智谱AI的API返回的用量统计格式与OpenAI的格式不同导致的。错误显示 CompletionUsage 对象没有 input_tokens 属性。
    </p>
    <p>
     智谱的usage token为
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d94f2423ea61433cadc3c1e2d7673f67.png">
      <br/>
      修改成
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/94903d8ffeb34697aed7896dc2821fe4.png"/>
     </img>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34313437323230352f:61727469636c652f64657461696c732f313436323637373233" class_="artid" style="display:none">
 </p>
</div>


