---
layout: post
title: "Linux驱动开发-pinctrl-和-gpio-子系统并发和竞争内核定时器"
date: 2025-03-16 23:10:21 +0800
description: "②中断可以用，因为中断不能休眠。信号量就相当于设置一个变量，初始值，我进行这个操作时，这个变量会设置为另一个值，其他线程或者内核看到这个变量不是初始值，不会在外面一直等待，而是去执行其他操作，等我执行完这个操作后，会将这个变量变回初始值，然后通知线程和内核来执行这个操作，适合锁持有时间较长的情况。执行这一步，不被其他线程或者内核影响，相当于我在执行这个操作时候，让一个标准位置0，其他线程或者内核想执行这个操作，一看这个标志位为0，就执行不了，等到这个操作被我执行完后，把标志位置1，从而其他可以去执行。"
keywords: "Linux驱动开发-①pinctrl 和 gpio 子系统②并发和竞争③内核定时器"
categories: ['未分类']
tags: ['驱动开发', '单片机', 'Linux']
artid: "146282931"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146282931
    alt: "Linux驱动开发-pinctrl-和-gpio-子系统并发和竞争内核定时器"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146282931
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146282931
cover: https://bing.ee123.net/img/rand?artid=146282931
image: https://bing.ee123.net/img/rand?artid=146282931
img: https://bing.ee123.net/img/rand?artid=146282931
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Linux驱动开发-①pinctrl 和 gpio 子系统②并发和竞争③内核定时器
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="pinctrl__gpio__1">
     </a>
     一，pinctrl 和 gpio 子系统
    </h2>
    <h3>
     <a id="1pinctrl_2">
     </a>
     1.pinctrl子系统
    </h3>
    <p>
     在linux内核中用于管理和配置
     <strong>
      引脚复用
     </strong>
     （比如复用为GPIO,I2C，SPI,UART等）和
     <strong>
      引脚属性
     </strong>
     （电气属性：上拉，下拉，驱动强度等）的框架，通过设备树描述引脚配置。MX6UL_PAD_GPIO1_IO03__GPIO1_IO03宏定义格式 &lt;mux_reg conf_reg input_reg mux_mode input_val&gt;，mux_reg寄存器偏移地址，如果值为0x01，因为 iomux基地址为0x020e0000,因此MUX复用功能寄存器的地址为0x020e0001这样，同理conf_reg 和input_reg 。mux_mode即mux复用寄存器设置的值。
    </p>
    <pre><code class="prism language-c"><span class="token operator">&amp;</span>iomuxc <span class="token punctuation">{<!-- --></span>
	pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
	pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_hog_1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
	imx6ul<span class="token operator">-</span>evk <span class="token punctuation">{<!-- --></span>
		pinctrl_hog_1<span class="token operator">:</span> hoggrp<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
			fsl<span class="token punctuation">,</span>pins <span class="token operator">=</span> <span class="token operator">&lt;</span>
				MX6UL_PAD_UART1_RTS_B__GPIO1_IO19	<span class="token number">0x17059</span> <span class="token comment">/* SD1 CD */</span>
				MX6UL_PAD_GPIO1_IO05__USDHC1_VSELECT	<span class="token number">0x17059</span> <span class="token comment">/* SD1 VSELECT */</span>
				MX6UL_PAD_GPIO1_IO09__GPIO1_IO09        <span class="token number">0x17059</span> <span class="token comment">/* SD1 RESET */</span>
			<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>

		<span class="token comment">/*LED*/</span>
		pinctrl_led<span class="token operator">:</span> ledgrp<span class="token punctuation">{<!-- --></span>
			fsl<span class="token punctuation">,</span>pins <span class="token operator">=</span> <span class="token operator">&lt;</span>
				MX6UL_PAD_GPIO1_IO03__GPIO1_IO03  <span class="token number">0X10B0</span>  <span class="token comment">/*led设置复用为GOIO1_IO03，电气属性设置为0x10B0*/</span>
			<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="2GPIO_27">
     </a>
     2.GPIO子系统
    </h3>
    <p>
     pinctrl将一个pin复用为GPIO的话，使用GPIO子系统控制，作用是
     <strong>
      不用操作寄存器就能配置和操作GPIO
     </strong>
     。首先在设备树中添加这个led的节点，让这个节点使用上面配置的属性并且连接好对应的引脚。在设备树的根目录下设置gpled节点，并且用pinctrl-0 = &lt;&amp;pinctrl_led&gt;;使得复用和电器属性得到设置，led-gpio = &lt;&amp;gpio1 3 GPIO_ACTIVE_LOW&gt;让这个驱动和GPIO1_IO03进行关联。
    </p>
    <pre><code class="prism language-c"><span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
	gpioled<span class="token punctuation">{<!-- --></span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">adress</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
		<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
		compatible <span class="token operator">=</span> <span class="token string">"atkalpha-gpioled"</span><span class="token punctuation">;</span>
		princtrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
		pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_led<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		led<span class="token operator">-</span>gpio <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio1 <span class="token number">3</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
		status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     驱动实现主要利用到设置的这些内容：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">pgled_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span><span class="token class-name">size_t</span> cnt<span class="token punctuation">,</span><span class="token class-name">loff_t</span> <span class="token operator">*</span>offt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> databuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> let_status<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">led_dev</span> <span class="token operator">*</span>pgled_dev <span class="token operator">=</span> filp<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span>databuf<span class="token punctuation">,</span>buf<span class="token punctuation">,</span>cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    let_status <span class="token operator">=</span> databuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>let_status <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>pgled_dev<span class="token operator">-&gt;</span>led_gpio<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开灯</span>

    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>let_status <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>pgled_dev<span class="token operator">-&gt;</span>led_gpio<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关灯</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">pgled_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    
    led<span class="token punctuation">.</span>nd <span class="token operator">=</span> <span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token string">"/gpioled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在设备树中获取节点</span>
    led<span class="token punctuation">.</span>led_gpio <span class="token operator">=</span> <span class="token function">of_get_named_gpio</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>nd<span class="token punctuation">,</span><span class="token string">"beep-gpio"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得到gpio引脚</span>
    ret <span class="token operator">=</span> <span class="token function">gpio_direction_output</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>led_gpio<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置GPIO1-03为输出，并且设置为1,高点平关闭</span>
    
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"从设备树读取节点和gpio正确\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*注册*/</span>
    <span class="token comment">/*1.设备号*/</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>major<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        led<span class="token punctuation">.</span>led_hao <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>major<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>led_hao<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> LED_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主动注册</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>led_hao<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> LED_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//自动注册</span>
    <span class="token punctuation">}</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"major = %d,minor = %d"</span><span class="token punctuation">,</span><span class="token function">MAJOR</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>led_hao<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">MINOR</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>led_hao<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*2.注册函数*/</span>
    led<span class="token punctuation">.</span>cdev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
    <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>cdev<span class="token punctuation">,</span><span class="token operator">&amp;</span>pgled_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>cdev<span class="token punctuation">,</span>led<span class="token punctuation">.</span>led_hao<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*3.节点申请*/</span> 
    led<span class="token punctuation">.</span>class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span>LED_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    led<span class="token punctuation">.</span>device <span class="token operator">=</span> <span class="token function">device_create</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>led<span class="token punctuation">.</span>led_hao<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>LED_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*4.具体实现*/</span>  
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="_108">
     </a>
     二，并发和竞争
    </h2>
    <p>
     并发：指多个任务（线程、进程或协程）在同一时间段内交替执行的现象。这些任务可能是同时运行的（在多核 CPU 上），也可能是通过时间片轮转的方式交替运行的（在单核 CPU 上）。
     <br/>
     竞争：指多个并发任务在访问共享资源时，由于执行顺序的不确定性，导致程序的最终结果依赖于任务的执行顺序。如果未正确同步，可能会导致数据不一致或程序行为异常。下面四种操作就是为了避免访问共享资源时候出现混乱。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bd4f57bdd6644e4c9efdc78109375bdd.png"/>
    </p>
    <h3>
     <a id="1_113">
     </a>
     1.原子操作
    </h3>
    <p>
     执行这一步，不被其他线程或者内核影响，相当于我在执行这个操作时候，让一个标准位置0，其他线程或者内核想执行这个操作，一看这个标志位为0，就执行不了，等到这个操作被我执行完后，把标志位置1，从而其他可以去执行。原子操作即不可分割的操作意思。
    </p>
    <h3>
     <a id="2_115">
     </a>
     2.自旋锁
    </h3>
    <p>
     当一个线程或核心尝试获取锁时，如果锁已被其他线程或核心持有，则该线程或核心会一直“自旋”（即忙等待），直到锁被释放。由此可以看出，其他线程或核心在一直自旋，这个时候是浪费cpu的处理能力的，因此自旋锁适合持锁时间很短的操作。特点是①不进入休眠，即其它线程或核心要一直等待着，而不是先去执行其他操作，等这个锁解了再通知回来。②中断可以用，因为中断不能休眠。
    </p>
    <h3>
     <a id="3_117">
     </a>
     3.信号量
    </h3>
    <p>
     信号量就相当于设置一个变量，初始值，我进行这个操作时，这个变量会设置为另一个值，其他线程或者内核看到这个变量不是初始值，不会在外面一直等待，而是去执行其他操作，等我执行完这个操作后，会将这个变量变回初始值，然后通知线程和内核来执行这个操作，适合锁持有时间较长的情况。
    </p>
    <h3>
     <a id="4_119">
     </a>
     4.互斥体
    </h3>
    <p>
     互斥体是确保同一时间只有一个线程或进程可以访问共享资源，从而避免竞态条件，当一个线程或进程尝试获取互斥体时，如果互斥体已被其他线程或进程持有，则该线程或进程会进入睡眠状态，直到互斥体被释放，和信号量基本上一样，但是互斥体是两种情况即0 1，信号量是计数器，阔以大于1。
    </p>
    <p>
     具体使用：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">led_dev</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>device<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>nd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev<span class="token punctuation">;</span>
    <span class="token class-name">dev_t</span> led_hao<span class="token punctuation">;</span>
    <span class="token keyword">int</span> major<span class="token punctuation">;</span><span class="token comment">//主设备号</span>
    <span class="token keyword">int</span> minor<span class="token punctuation">;</span><span class="token comment">//次设备号</span>
    <span class="token keyword">int</span> led_gpio<span class="token punctuation">;</span><span class="token comment">//led的gpio</span>

    <span class="token class-name">atomic_t</span> lock_yuan<span class="token punctuation">;</span><span class="token comment">//原子操作</span>

    <span class="token class-name">spinlock_t</span> lock_spin<span class="token punctuation">;</span><span class="token comment">//自旋操作</span>
    <span class="token keyword">int</span> dev_status<span class="token punctuation">;</span><span class="token comment">//0可用 1不可用</span>

    <span class="token keyword">struct</span> <span class="token class-name">semaphore</span> sem<span class="token punctuation">;</span><span class="token comment">//信号量</span>

    <span class="token keyword">struct</span> <span class="token class-name">mutex</span> lock_huci<span class="token punctuation">;</span><span class="token comment">//互斥体</span>

    
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">led_dev</span> led<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pgled_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>innode<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*信号量*/</span>
     <span class="token function">down</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token comment">/*自旋锁*/</span>
     <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
     <span class="token function">spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>lock_spin<span class="token punctuation">,</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//上锁</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>dev_status<span class="token punctuation">)</span>
     <span class="token punctuation">{<!-- --></span>
         <span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>lock_spin<span class="token punctuation">,</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     led<span class="token punctuation">.</span>dev_status<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//为0，则让lock——spin为1标志设备已经被使用了</span>
     <span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>lock_spin<span class="token punctuation">,</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
     <span class="token comment">/*原子操作*/</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>lock_yuan<span class="token punctuation">)</span><span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//被操作了</span>
     <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EBUSY<span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
         <span class="token function">atomic_dec</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>lock_yuan<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

    <span class="token comment">/*互斥体*/</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mutex_lock_interruptible</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>lock_huci<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ERESTARTSYS<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

    filp<span class="token operator">-&gt;</span>private_data <span class="token operator">=</span> <span class="token operator">&amp;</span>led<span class="token punctuation">;</span><span class="token comment">//将led结构体数据设为私有数据</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pgled_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>innode<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>   
    <span class="token function">up</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>sem<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//信号量</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>lock_huci<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//互斥体</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
    <span class="token comment">/*自旋锁*/</span>
    <span class="token function">spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>lock_spin<span class="token punctuation">,</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//上锁</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>dev_status<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
         led<span class="token punctuation">.</span>dev_status<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>lock_spin<span class="token punctuation">,</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">atomic_inc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>lock_yuan<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//原子操作</span>
   
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">pgled_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>lock_yuan<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//原子操作，锁设置 当为1可以操作，否则不可以操作</span>
    <span class="token function">spin_lock_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>lock_spin<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//自旋</span>
    <span class="token function">sema_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>sem<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//信号量</span>
    <span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>lock_huci<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//互斥体</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="_208">
     </a>
     三，按键实验
    </h2>
    <p>
     驱动：
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_gpio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kdev_t.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/mach/map.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span>  <span class="token comment">// 包含 register_chrdev_region 的定义</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_address.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_irq.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/semaphore.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_NAME</span> <span class="token string">"key"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_VALUE</span>  <span class="token expression"><span class="token number">0X01</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_NOVALUE</span> <span class="token expression"><span class="token number">0X00</span></span></span>



<span class="token keyword">struct</span> <span class="token class-name">key_dev</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>device<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>nd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev<span class="token punctuation">;</span>
    <span class="token class-name">dev_t</span> key_hao<span class="token punctuation">;</span>
    <span class="token keyword">int</span> major<span class="token punctuation">;</span><span class="token comment">//主设备号</span>
    <span class="token keyword">int</span> minor<span class="token punctuation">;</span><span class="token comment">//次设备号</span>
    <span class="token keyword">int</span> key_gpio<span class="token punctuation">;</span><span class="token comment">//key的gpio</span>

     <span class="token class-name">atomic_t</span> key_value<span class="token punctuation">;</span><span class="token comment">//原子操作</span>

    <span class="token comment">// spinlock_t lock_spin;//自旋操作</span>
    <span class="token comment">// int dev_status;//0可用 1不可用</span>

    <span class="token comment">// struct semaphore sem;//信号量</span>

    <span class="token comment">// struct mutex lock_huci;//互斥体</span>

    
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">key_dev</span> key<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span>  <span class="token function">keyio_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    key<span class="token punctuation">.</span>nd <span class="token operator">=</span> <span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token string">"/gpiokey"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在设备树中获取节点</span>
    key<span class="token punctuation">.</span>key_gpio <span class="token operator">=</span> <span class="token function">of_get_named_gpio</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>nd<span class="token punctuation">,</span><span class="token string">"key-gpio"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得到gpio引脚</span>

    <span class="token function">gpio_request</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>key_gpio<span class="token punctuation">,</span><span class="token string">"key0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">gpio_direction_input</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>key_gpio<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置为输入</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"从设备树读取节点和gpio正确\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pgkey_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>innode<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token function">keyio_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化IO</span>
    filp<span class="token operator">-&gt;</span>private_data <span class="token operator">=</span> <span class="token operator">&amp;</span>key<span class="token punctuation">;</span><span class="token comment">//将key结构体数据设为私有数据</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pgkey_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>innode<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>   
    <span class="token comment">// up(&amp;key.sem);</span>


    <span class="token comment">//mutex_unlock(&amp;key.lock_huci);</span>
    <span class="token comment">// unsigned long flags;</span>
    <span class="token comment">// /*自旋锁*/</span>
    <span class="token comment">// spin_lock_irqsave(&amp;key.lock_spin,flags);//上锁</span>
    <span class="token comment">// if(key.dev_status)</span>
    <span class="token comment">// {<!-- --></span>
    <span class="token comment">//      key.dev_status--;</span>
    <span class="token comment">// }</span>
    <span class="token comment">// spin_unlock_irqrestore(&amp;key.lock_spin,flags);</span>


    <span class="token comment">// atomic_inc(&amp;key.lock_yuan);</span>
    <span class="token comment">// printk("打开后  关闭：close_file  lock_yuan = %d\r\n",key.lock_yuan);</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">pgkey_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">char</span> __user <span class="token operator">*</span>buf<span class="token punctuation">,</span><span class="token class-name">size_t</span> cnt<span class="token punctuation">,</span><span class="token class-name">loff_t</span> <span class="token operator">*</span>offt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">key_dev</span> <span class="token operator">*</span>key1 <span class="token operator">=</span> filp<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">gpio_get_value</span><span class="token punctuation">(</span>key1<span class="token operator">-&gt;</span>key_gpio<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//0按下，否则没按下</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">gpio_get_value</span><span class="token punctuation">(</span>key1<span class="token operator">-&gt;</span>key_gpio<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待按键释放，相当于判断上升沿触发</span>
        <span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key1<span class="token operator">-&gt;</span>key_value<span class="token punctuation">,</span>KEY_VALUE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//原子操作 数据保护</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>                                    <span class="token comment">//未按下</span>
        <span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key1<span class="token operator">-&gt;</span>key_value<span class="token punctuation">,</span>KEY_NOVALUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    value <span class="token operator">=</span> <span class="token function">atomic_read</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key1<span class="token operator">-&gt;</span>key_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__copy_to_user</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token operator">&amp;</span>value<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token operator">/</span>APP <span class="token operator">/</span>dev<span class="token operator">/</span>pgled <span class="token number">1</span><span class="token operator">&amp;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> pgkey_fops<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>owner<span class="token operator">=</span>THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read<span class="token operator">=</span>pgkey_read<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open<span class="token operator">=</span>pgkey_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release<span class="token operator">=</span>pgkey_release<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">pgkey_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   

    
    <span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">.</span>key_value<span class="token punctuation">,</span>KEY_NOVALUE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//原子操作，锁设置 值为0,说明未按下</span>


    <span class="token comment">// spin_lock_init(&amp;key.lock_spin);//自旋</span>

    <span class="token comment">// sema_init(&amp;key.sem,1);//信号量</span>
    <span class="token comment">//mutex_init(&amp;key.lock_huci);//互斥体</span>

    <span class="token comment">/*注册*/</span>
    <span class="token comment">/*1.设备号*/</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>major<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        key<span class="token punctuation">.</span>key_hao <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>major<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>key_hao<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> KEY_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主动注册</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">.</span>key_hao<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> KEY_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//自动注册</span>
    <span class="token punctuation">}</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"major = %d,minor = %d"</span><span class="token punctuation">,</span><span class="token function">MAJOR</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>key_hao<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">MINOR</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>key_hao<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*2.注册函数*/</span>
    key<span class="token punctuation">.</span>cdev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
    <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">.</span>cdev<span class="token punctuation">,</span><span class="token operator">&amp;</span>pgkey_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">.</span>cdev<span class="token punctuation">,</span>key<span class="token punctuation">.</span>key_hao<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*3.节点申请*/</span> 
    key<span class="token punctuation">.</span>class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span>KEY_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    key<span class="token punctuation">.</span>device <span class="token operator">=</span> <span class="token function">device_create</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>key<span class="token punctuation">.</span>key_hao<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>KEY_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*4.具体实现*/</span>  
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>  __exit <span class="token function">pgkey_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">gpio_free</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>key_gpio<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放gpio</span>
    <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key<span class="token punctuation">.</span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先删除设备</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>key_hao<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//删除设备号</span>
    <span class="token function">device_destroy</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>class<span class="token punctuation">,</span>key<span class="token punctuation">.</span>key_hao<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先删除和设备第关系</span>
    <span class="token function">class_destroy</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//再删除类</span>
   
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token operator">/</span>APP <span class="token operator">/</span>dev<span class="token operator">/</span>pgled <span class="token number">1</span><span class="token operator">&amp;</span>

<span class="token comment">/*驱动入口和出口*/</span>
<span class="token function">module_init</span><span class="token punctuation">(</span>pgkey_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>pgkey_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"wyt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



</code></pre>
    <p>
     应用：
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> argc<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> rel <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span>read_buff<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    filename <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WARNING!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open file error\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>read_buff<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>read_buff<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">" 按下了! \r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>


</code></pre>
    <h2>
     <a id="_426">
     </a>
     四，内核定时器
    </h2>
    <h3>
     <a id="1_427">
     </a>
     1.关于定时器的有关概念
    </h3>
    <h4>
     <a id="11_HZ_428">
     </a>
     1.1 节拍HZ
    </h4>
    <p>
     硬件定时器提供时钟源，时钟源的频率可以设置，设置好以后就能周期性的产生中断，系统时钟定时中断来计时，中断的这个频率就是系统频率，称为节拍，单位是HZ，比如100HZ，就是一秒有100个中断产生。
    </p>
    <h4>
     <a id="12_jiffies_430">
     </a>
     1.2 jiffies
    </h4>
    <p>
     linux内核中使用全局变量jiffies来记录系统从启动以来的节拍数，系统启动的时候会将其初始化为0，然后系统运行，就开始计数。有32位的和64位的，内核中设置时间，比如想设置定时两秒，那么
     <strong>
      目标时间
     </strong>
     =jiffies（此时的节拍数）+（2*节拍数HZ），当现在的节拍数jiffies大于目标时间，就认为到达设定时间两秒。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0738b1f7aba8490b966d17d708b2f5a0.png"/>
    </p>
    <h3>
     <a id="2_434">
     </a>
     2.定时器实验
    </h3>
    <p>
     能够用定时器控制led灯的闪烁频率，并且能够开关定时器，修改定时器周期。static void led_timer_function(unsigned long arg)定时器调回函数中，unsigned long arg是通用的参数传递机制，传递的是用户定义的数据，将结构体指针&amp;led强制转化为unsigned long ,放到led.timer.data中，在放到arg中，意思就是arg传递的是led结构体的数据。
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/errno.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/gpio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_gpio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kdev_t.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/mach/map.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/uaccess.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_address.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_irq.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/jiffies.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/ioctl.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TIMER_NAME</span> <span class="token string">"led_timer"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CLOSE_TIMER_CMD</span> <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span><span class="token number">0xef</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  </span><span class="token comment">//1设置为关闭</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OPEN_TIMER_CMD</span> <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span><span class="token number">0xef</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  </span><span class="token comment">//2设置为开</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PERIOD_TIMER_CMD</span> <span class="token expression"><span class="token function">_IOW</span><span class="token punctuation">(</span><span class="token number">0xef</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span>  </span><span class="token comment">//3设置修改周期</span></span>


<span class="token keyword">struct</span> <span class="token class-name">led_dev</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">class</span> <span class="token operator">*</span>class<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>device<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>nd<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">cdev</span> cdev<span class="token punctuation">;</span>
    <span class="token class-name">dev_t</span> led_hao<span class="token punctuation">;</span>
    <span class="token keyword">int</span> major<span class="token punctuation">;</span><span class="token comment">//主设备号</span>
    <span class="token keyword">int</span> minor<span class="token punctuation">;</span><span class="token comment">//次设备号</span>
    <span class="token keyword">int</span> led_gpio<span class="token punctuation">;</span><span class="token comment">//led的gpio</span>
    <span class="token keyword">int</span> timer_period<span class="token punctuation">;</span><span class="token comment">//定时器周期  利用原子操作保护</span>
    <span class="token class-name">atomic_t</span> lock_yuan<span class="token punctuation">;</span><span class="token comment">//原子操作</span>
    <span class="token keyword">struct</span> <span class="token class-name">timer_list</span> timer<span class="token punctuation">;</span><span class="token comment">//定义定时器</span>
    
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">led_dev</span> led<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pgled_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>innode<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    filp<span class="token operator">-&gt;</span>private_data <span class="token operator">=</span> <span class="token operator">&amp;</span>led<span class="token punctuation">;</span><span class="token comment">//将led结构体数据设为私有数据</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">pgled_release</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span> <span class="token operator">*</span>innode<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">timer_ioctl</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span> <span class="token operator">*</span>filp<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> cmd <span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">led_dev</span> <span class="token operator">*</span>led_ioctl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">led_dev</span><span class="token operator">*</span><span class="token punctuation">)</span>filp<span class="token operator">-&gt;</span>private_data<span class="token punctuation">;</span>
    <span class="token keyword">int</span> period <span class="token operator">=</span>led_ioctl<span class="token operator">-&gt;</span>timer_period<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> CLOSE_TIMER_CMD<span class="token operator">:</span><span class="token comment">//关闭定时器</span>
        <span class="token function">del_timer_sync</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led_ioctl<span class="token operator">-&gt;</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> OPEN_TIMER_CMD<span class="token operator">:</span><span class="token comment">//打开定时器</span>
        <span class="token function">mod_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led_ioctl<span class="token operator">-&gt;</span>timer<span class="token punctuation">,</span> jiffies <span class="token operator">+</span> <span class="token function">msecs_to_jiffies</span><span class="token punctuation">(</span>led_ioctl<span class="token operator">-&gt;</span>timer_period<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span> 
    <span class="token keyword">case</span> PERIOD_TIMER_CMD<span class="token operator">:</span><span class="token comment">//从新配置定时器时间</span>
        ret <span class="token operator">=</span> <span class="token function">__copy_from_user</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>period<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这个arg是输入第周期值。</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"111period =%d, led_ioctl-&gt;timer_period =%d,led.timer_period=%d\r\n"</span><span class="token punctuation">,</span>
        period<span class="token punctuation">,</span>led_ioctl<span class="token operator">-&gt;</span>timer_period<span class="token punctuation">,</span>led<span class="token punctuation">.</span>timer_period<span class="token punctuation">)</span><span class="token punctuation">;</span>
        led_ioctl<span class="token operator">-&gt;</span>timer_period <span class="token operator">=</span>  period<span class="token punctuation">;</span>
        <span class="token function">mod_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led_ioctl<span class="token operator">-&gt;</span>timer<span class="token punctuation">,</span> jiffies <span class="token operator">+</span> <span class="token function">msecs_to_jiffies</span><span class="token punctuation">(</span>led_ioctl<span class="token operator">-&gt;</span>timer_period<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"222period =%d, led_ioctl-&gt;timer_period =%d,led.timer_period=%d\r\n"</span><span class="token punctuation">,</span>
        period<span class="token punctuation">,</span>led_ioctl<span class="token operator">-&gt;</span>timer_period<span class="token punctuation">,</span>led<span class="token punctuation">.</span>timer_period<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>         
    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> pgled_fops<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>owner<span class="token operator">=</span>THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unlocked_ioctl<span class="token operator">=</span> timer_ioctl<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open<span class="token operator">=</span>pgled_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release<span class="token operator">=</span>pgled_release<span class="token punctuation">,</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">led_timer_function</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> arg<span class="token punctuation">)</span><span class="token comment">//定时结束后会执行第操作，</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">led_dev</span> <span class="token operator">*</span>led_timer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">led_dev</span><span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span><span class="token comment">//这个arg和上面的不一样，上面是中端输入数据的首地址，这个数据</span>
                                                    <span class="token comment">//是整形变量周期值，不是输入的第一个数据，而这个是结构体变量led首地址</span>
    <span class="token keyword">static</span> <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    status <span class="token operator">=</span> <span class="token operator">!</span>status<span class="token punctuation">;</span>
    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>led_timer<span class="token operator">-&gt;</span>led_gpio<span class="token punctuation">,</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">mod_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led_timer<span class="token operator">-&gt;</span>timer<span class="token punctuation">,</span> jiffies <span class="token operator">+</span> <span class="token function">msecs_to_jiffies</span><span class="token punctuation">(</span>led_timer<span class="token operator">-&gt;</span>timer_period<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//让定时器再从新加载</span>

<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">pgled_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    led<span class="token punctuation">.</span>nd <span class="token operator">=</span> <span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token string">"/gpioled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//在设备树中获取节点</span>
    led<span class="token punctuation">.</span>led_gpio <span class="token operator">=</span> <span class="token function">of_get_named_gpio</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>nd<span class="token punctuation">,</span><span class="token string">"led-gpio"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得到gpio引脚</span>
    ret <span class="token operator">=</span> <span class="token function">gpio_direction_output</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>led_gpio<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置GPIO1-03为输出，并且设置为1,高点平关闭</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"从设备树读取节点和gpio正确\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*注册*/</span>
    <span class="token comment">/*1.设备号*/</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>major<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        led<span class="token punctuation">.</span>led_hao <span class="token operator">=</span> <span class="token function">MKDEV</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>major<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">register_chrdev_region</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>led_hao<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> TIMER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主动注册</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">alloc_chrdev_region</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>led_hao<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> TIMER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//自动注册</span>
    <span class="token punctuation">}</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"major = %d,minor = %d"</span><span class="token punctuation">,</span><span class="token function">MAJOR</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>led_hao<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">MINOR</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>led_hao<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*2.注册函数*/</span>
    led<span class="token punctuation">.</span>cdev<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
    <span class="token function">cdev_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>cdev<span class="token punctuation">,</span><span class="token operator">&amp;</span>pgled_fops<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cdev_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>cdev<span class="token punctuation">,</span>led<span class="token punctuation">.</span>led_hao<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*3.节点申请*/</span> 
    led<span class="token punctuation">.</span>class <span class="token operator">=</span> <span class="token function">class_create</span><span class="token punctuation">(</span>THIS_MODULE<span class="token punctuation">,</span>TIMER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    led<span class="token punctuation">.</span>device <span class="token operator">=</span> <span class="token function">device_create</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>class<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>led<span class="token punctuation">.</span>led_hao<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>TIMER_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/*初始化定时器*/</span>
    led<span class="token punctuation">.</span>timer_period<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token function">init_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化定时器</span>
    led<span class="token punctuation">.</span>timer<span class="token punctuation">.</span>function <span class="token operator">=</span> led_timer_function<span class="token punctuation">;</span>
    led<span class="token punctuation">.</span>timer<span class="token punctuation">.</span>expires <span class="token operator">=</span> jiffies <span class="token operator">+</span> <span class="token function">msecs_to_jiffies</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>timer_period<span class="token punctuation">)</span><span class="token punctuation">;</span>
    led<span class="token punctuation">.</span>timer<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>led<span class="token punctuation">;</span>
    <span class="token function">add_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//添加定时器</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span>  __exit <span class="token function">pgled_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">gpio_set_value</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>led_gpio<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">del_timer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">gpio_free</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>led_gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cdev_del</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">.</span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先删除设备</span>
    <span class="token function">unregister_chrdev_region</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>led_hao<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//删除设备号</span>
    <span class="token function">device_destroy</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>class<span class="token punctuation">,</span>led<span class="token punctuation">.</span>led_hao<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先删除和设备第关系</span>
    <span class="token function">class_destroy</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//再删除类</span>
   
<span class="token punctuation">}</span>


<span class="token comment">/*驱动入口和出口*/</span>
<span class="token function">module_init</span><span class="token punctuation">(</span>pgled_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>pgled_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"wyt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



</code></pre>
    <p>
     应用：
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ioctl.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CLOSE_TIMER_CMD</span> <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span><span class="token number">0xef</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  </span><span class="token comment">//1设置为关闭</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OPEN_TIMER_CMD</span> <span class="token expression"><span class="token function">_IO</span><span class="token punctuation">(</span><span class="token number">0xef</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  </span><span class="token comment">//2设置为开</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PERIOD_TIMER_CMD</span> <span class="token expression"><span class="token function">_IOW</span><span class="token punctuation">(</span><span class="token number">0xef</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span><span class="token keyword">int</span><span class="token punctuation">)</span>  </span><span class="token comment">//3设置修改周期</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> argc<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> rel <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>fd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>arg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> cmd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>filename<span class="token punctuation">,</span>str<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    filename <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span>O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fd<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"open file error\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"INPUT CMD:\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rel <span class="token operator">=</span> <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>rel<span class="token operator">!=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">gets</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
                <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>CLOSE_TIMER_CMD<span class="token punctuation">,</span><span class="token operator">&amp;</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
                <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>OPEN_TIMER_CMD<span class="token punctuation">,</span><span class="token operator">&amp;</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"input period:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                rel <span class="token operator">=</span> <span class="token function">scanf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"arg1 = %d"</span><span class="token punctuation">,</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>rel<span class="token operator">!=</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">gets</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">ioctl</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span>PERIOD_TIMER_CMD<span class="token punctuation">,</span><span class="token operator">&amp;</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    rel <span class="token operator">=</span> <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>rel<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"close in  APP error\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>


</code></pre>
    <h2>
     <a id="_666">
     </a>
     五，相关问题
    </h2>
    <h3>
     <a id="1pingpio_667">
     </a>
     1.pin和gpio
    </h3>
    <p>
     PIN 是芯片或电路板上的物理引脚，用于连接芯片与外部电路。GPIO 是一种通用的引脚功能，允许引脚通过软件配置为输入或输出模式。在输入模式下，GPIO 可以读取外部信号；在输出模式下，GPIO 可以驱动外部设备。pin是个大类，gpio是其中的一部分，比如pin可以设置为多种功能（如 GPIO、UART、I2C、SPI 等）。
    </p>
    <h3>
     <a id="2depmod_669">
     </a>
     2.depmod作用
    </h3>
    <p>
     depmod： Linux 系统中用于生成模块依赖关系文件的工具。会扫描 /lib/modules/&lt;内核版本&gt;/ 目录下的所有内核模块，分析它们之间的依赖关系，依赖关系包括模块之间的符号引用（如函数、变量等）。
    </p>
    <h4>
     <a id="3gpiorequest_671">
     </a>
     3.得到gpio后，使用request申请的作用
    </h4>
    <p>
     request函数用于申请 GPIO 引脚的使用权，它的主要作用是确保 GPIO 引脚不会被多个驱动程序或模块同时使用，从而避免资源冲突，具体就是标记 GPIO 引脚为“已使用”状态，防止其他驱动程序或模块重复使用该引脚。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f787878783132333434352f:61727469636c652f64657461696c732f313436323832393331" class_="artid" style="display:none">
 </p>
</div>


