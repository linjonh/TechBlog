---
arturl_encode: "68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f37373935343936372f:61727469636c652f64657461696c732f313436323537373733"
layout: post
title: "Linuxä»äº’æ–¥åŸç†åˆ°C-RAIIå°è£…å®è·µ"
date: 2025-03-14 15:46:18 +0800
description: "ç´§æ¥ä¸Šå›çš„çº¿ç¨‹C++å°è£…ï¼Œè¿™å›ç¬”è€…ç€é‡ä»‹ç»ä¸€ä¸‹äº’æ–¥çš„åŸç†å’Œå…¶å¿…è¦æ€§ï¼Œå¹¶æ‰‹æŠŠæ‰‹ä½¿ç”¨C++å°è£…ä¸€ä¸ªRAIIæ¨¡å‹ã€‚è¿˜æœ‰ä¸€ç‚¹ï¼Œç¬”è€…ä¹‹åçš„å°è£…éƒ½ä¼šä½¿ç”¨ä¹‹å‰åšå®¢ä¸­å°è£…å¥½çš„å®¹å™¨ï¼Œéœ€è¦çš„å¯ä»¥å»ä»“åº“æˆ–è€…å‰é¢çš„åšå®¢ä¸­è‡ªå–ã€‚RAIIçš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†èµ„æºçš„è·å–å’Œåˆå§‹åŒ–æ”¾åœ¨å¯¹è±¡çš„æ„é€ å‡½æ•°ä¸­è¿›è¡Œï¼Œè€Œèµ„æºçš„é‡Šæ”¾æ”¾åœ¨å¯¹è±¡çš„ææ„å‡½æ•°ä¸­è¿›è¡Œã€‚å½“å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œå…¶æ„é€ å‡½æ•°ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œä»è€Œå®Œæˆèµ„æºçš„è·å–ï¼›å½“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶ï¼Œå…¶ææ„å‡½æ•°ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ï¼Œä»è€Œå®Œæˆèµ„æºçš„é‡Šæ”¾ã€‚"
keywords: "ã€Linuxã€‘ä»äº’æ–¥åŸç†åˆ°C++ RAIIå°è£…å®è·µ"
categories: ['æœªåˆ†ç±»']
tags: ['Linux', 'C']
artid: "146257773"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146257773
    alt: "Linuxä»äº’æ–¥åŸç†åˆ°C-RAIIå°è£…å®è·µ"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146257773
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146257773
cover: https://bing.ee123.net/img/rand?artid=146257773
image: https://bing.ee123.net/img/rand?artid=146257773
img: https://bing.ee123.net/img/rand?artid=146257773
---

# ã€Linuxã€‘ä»äº’æ–¥åŸç†åˆ°C++ RAIIå°è£…å®è·µ

> ğŸ“¢åšå®¢ä¸»é¡µï¼š
> [https://blog.csdn.net/2301\_779549673](https://blog.csdn.net/2301_77954967?spm=1011.2444.3001.5343)
>   
> ğŸ“¢æ¬¢è¿ç‚¹èµ ğŸ‘ æ”¶è— â­ç•™è¨€ ğŸ“ å¦‚æœ‰é”™è¯¯æ•¬è¯·æŒ‡æ­£ï¼
>   
> ğŸ“¢æœ¬æ–‡ç”±
> ***JohnKi***
> åŸåˆ›ï¼Œé¦–å‘äº CSDNğŸ™‰
>   
> ğŸ“¢æœªæ¥å¾ˆé•¿ï¼Œå€¼å¾—æˆ‘ä»¬å…¨åŠ›å¥”èµ´æ›´ç¾å¥½çš„ç”Ÿæ´»âœ¨

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/direct/9393ea55f0d5414da8e09bd55eb82f4f.gif#pic_center)

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/direct/b55982b2fa5b47dda351a719b325c9e1.gif#pic_center)

---

## ğŸ“¢å‰è¨€

ç´§æ¥ä¸Šå›çš„
`çº¿ç¨‹C++å°è£…`
ï¼Œè¿™å›ç¬”è€…ç€é‡ä»‹ç»ä¸€ä¸‹äº’æ–¥çš„åŸç†å’Œå…¶å¿…è¦æ€§ï¼Œå¹¶æ‰‹æŠŠæ‰‹ä½¿ç”¨C++å°è£…ä¸€ä¸ªRAIIæ¨¡å‹ã€‚

è¿˜æœ‰ä¸€ç‚¹ï¼Œç¬”è€…ä¹‹åçš„å°è£…éƒ½ä¼šä½¿ç”¨ä¹‹å‰åšå®¢ä¸­å°è£…å¥½çš„å®¹å™¨ï¼Œéœ€è¦çš„å¯ä»¥å»ä»“åº“æˆ–è€…å‰é¢çš„åšå®¢ä¸­è‡ªå–ã€‚

`RAII`
çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†èµ„æºçš„è·å–å’Œåˆå§‹åŒ–æ”¾åœ¨å¯¹è±¡çš„æ„é€ å‡½æ•°ä¸­è¿›è¡Œï¼Œè€Œèµ„æºçš„é‡Šæ”¾æ”¾åœ¨å¯¹è±¡çš„ææ„å‡½æ•°ä¸­è¿›è¡Œã€‚å½“å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œå…¶æ„é€ å‡½æ•°ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œä»è€Œå®Œæˆèµ„æºçš„è·å–ï¼›å½“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶ï¼Œå…¶ææ„å‡½æ•°ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ï¼Œä»è€Œå®Œæˆèµ„æºçš„é‡Šæ”¾ã€‚è¿™æ ·ï¼Œèµ„æºçš„ç”Ÿå‘½å‘¨æœŸå°±ä¸å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šåœ¨ä¸€èµ·ï¼Œåˆ©ç”¨ C++ ç­‰è¯­è¨€çš„å¯¹è±¡è‡ªåŠ¨é”€æ¯æœºåˆ¶æ¥ç¡®ä¿èµ„æºçš„æ­£ç¡®é‡Šæ”¾ã€‚

---

## ğŸ³ï¸â€ğŸŒˆä¸€ã€ä»åœºæ™¯çœ‹äº’æ–¥ï¼šä¸ºä»€ä¹ˆéœ€è¦é”ï¼Ÿ

**å‡è®¾ä½ çš„é“¶è¡Œè´¦æˆ·ä½™é¢æ˜¯1000å…ƒï¼ŒåŒæ—¶æœ‰ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œè½¬è´¦æ“ä½œï¼š**

* â€‹çº¿ç¨‹Aï¼šå­˜å…¥200å…ƒ â†’ balance += 200
* â€‹çº¿ç¨‹Bï¼šå–å‡º300å…ƒ â†’ balance -= 300
    
  **æ— é”æƒ…å†µä¸‹å¯èƒ½çš„æ‰§è¡Œé¡ºåºï¼š**

```cpp
çº¿ç¨‹Aè¯»å–balance(1000) â†’ çº¿ç¨‹Bè¯»å–balance(1000) â†’ 
çº¿ç¨‹Aå†™å…¥1200 â†’ çº¿ç¨‹Bå†™å…¥700  
æœ€ç»ˆç»“æœï¼š700å…ƒï¼ˆæ­£ç¡®åº”ä¸º900å…ƒï¼‰

```

## ğŸ³ï¸â€ğŸŒˆäºŒã€äº’æ–¥é”æ ¸å¿ƒæ¦‚å¿µå›¾è§£

### 2.1 ä¸´ç•ŒåŒºä¸éä¸´ç•ŒåŒº

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/11f6297af1ca40baba191298248094b7.png)

```cpp
void* thread_func(void* arg) {
    // éä¸´ç•ŒåŒºï¼ˆå¯å¹¶å‘æ‰§è¡Œï¼‰
    prepare_data();  
    
    // ä¸´ç•ŒåŒºï¼ˆéœ€äº’æ–¥è®¿é—®ï¼‰
    pthread_mutex_lock(&mtx);
    update_shared_resource();  
    pthread_mutex_unlock(&mtx);
    
    // éä¸´ç•ŒåŒºï¼ˆå¯å¹¶å‘æ‰§è¡Œï¼‰
    post_process();
}

```

å…³é”®ç‰¹å¾ï¼š

ğŸ”µ â€‹éä¸´ç•ŒåŒºï¼šå…è®¸å¤šçº¿ç¨‹å¹¶è¡Œï¼ˆå¦‚å›¾ä¸­ç»¿è‰²åŒºåŸŸï¼‰
  
ğŸ”´ â€‹ä¸´ç•ŒåŒºï¼šåŒä¸€æ—¶åˆ»ä»…ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼ˆçº¢è‰²åŒºåŸŸï¼‰

### 2. 2 è¿›ç¨‹çº¿ç¨‹é—´çš„äº’æ–¥ç›¸å…³èƒŒæ™¯æ¦‚å¿µ

* **ä¸´ç•Œèµ„æº**
  :å¤šçº¿ç¨‹æ‰§è¡Œæµå…±äº«çš„èµ„æºå°±å«åšä¸´ç•Œèµ„æº
* **ä¸´ç•ŒåŒº**
  :æ¯ä¸ªçº¿ç¨‹å†…éƒ¨ï¼Œè®¿é—®ä¸´ç•Œèµ„æºçš„ä»£ç ï¼Œå°±å«åšä¸´ç•ŒåŒº
* **äº’æ–¥**
  :ä»»ä½•æ—¶åˆ»ï¼Œäº’æ–¥ä¿è¯æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ‰§è¡Œæµè¿›å…¥ä¸´ç•ŒåŒºï¼Œè®¿é—®ä¸´ç•Œèµ„æºï¼Œé€šå¸¸å¯¹ä¸´ç•Œèµ„æºèµ·ä¿æŠ¤ä½œç”¨
* **åŸå­æ€§**
  :(åé¢è®¨è®ºå¦‚ä½•å®ç°):ä¸ä¼šè¢«ä»»ä½•è°ƒåº¦æœºåˆ¶æ‰“æ–­çš„æ“ä½œï¼Œè¯¥æ“ä½œåªæœ‰ä¸¤æ€ï¼Œè¦ä¹ˆå®Œæˆï¼Œè¦ä¹ˆæœªå®Œæˆ

## ğŸ³ï¸â€ğŸŒˆä¸‰ã€Linuxäº’æ–¥é”åŸç†å‰–æ

**æ ¸å¿ƒæ“ä½œæµç¨‹ï¼š**

```cpp
sequenceDiagram
    participant çº¿ç¨‹A
    participant äº’æ–¥é”
    participant å†…æ ¸
    
    çº¿ç¨‹A->>äº’æ–¥é”: pthread_mutex_lock()
    alt é”ç©ºé—²
        äº’æ–¥é”-->>çº¿ç¨‹A: ç«‹å³è·å¾—é”
    else é”è¢«å 
        çº¿ç¨‹A->>å†…æ ¸: è¿›å…¥ä¼‘çœ é˜Ÿåˆ—
        å†…æ ¸-->>çº¿ç¨‹A: å”¤é†’å¹¶è·å–é”
    end
    çº¿ç¨‹A->>ä¸´ç•ŒåŒº: æ‰§è¡Œæ“ä½œ
    çº¿ç¨‹A->>äº’æ–¥é”: pthread_mutex_unlock()

```

### 3.2 åˆå§‹åŒ–äº’æ–¥é‡

**æ–¹æ³•ä¸€ï¼šé™æ€åˆ†å¸ƒ**

```cpp
pthread_mutex_t mutex = PTHREAD_MUTEX_INITIALIZER

```

**æ–¹æ³•äºŒï¼šåŠ¨æ€åˆ†å¸ƒ**

```cpp
int pthread_mutex_init(pthread_mutex_t *restrict mutex, const pthread_mutexattr_t *restrict attr);

```

**mutex**
ï¼šè¦åˆå§‹åŒ–çš„äº’æ–¥é‡
  
**attr**
ï¼šNULL

### 3.3 é”€æ¯äº’æ–¥é‡

**é”€æ¯äº’æ–¥é‡éœ€è¦æ³¨æ„ï¼š**

* ä½¿ç”¨ PTHREAD\_MUTEXINITIALIZER åˆå§‹åŒ–çš„äº’æ–¥é‡ä¸éœ€è¦é”€æ¯
* ä¸è¦é”€æ¯ä¸€ä¸ªå·²ç»åŠ é”çš„äº’æ–¥é‡
* å·²ç»é”€æ¯çš„äº’æ–¥é‡ï¼Œè¦ç¡®ä¿åé¢ä¸ä¼šæœ‰çº¿ç¨‹å†å°è¯•åŠ é”

```cpp
int pthread_mutex_destroy(pthread_mutex_t *mutex)ï¼›

```

**äº’æ–¥é‡åŠ é”å’Œè§£é”**

```cpp
int pthread_mutex_lock(pthread_mutex_t *mutex);
int pthread_mutex_unlock(pthread_mutex_t *mutex);
è¿”å›å€¼:æˆåŠŸè¿”å›0,å¤±è´¥è¿”å›é”™è¯¯å·

```

**è°ƒâ½¤ pthread\_mutex\_lock æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°ä»¥ä¸‹æƒ…å†µ:**

* äº’æ–¥é‡å¤„äºæœªé”çŠ¶æ€ï¼Œè¯¥å‡½æ•°ä¼šå°†äº’æ–¥é‡é”å®šï¼ŒåŒæ—¶è¿”å›æˆåŠŸ
* å‘èµ·å‡½æ•°è°ƒç”¨æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å·²ç»é”å®šäº’æ–¥é‡ï¼Œæˆ–è€…å­˜åœ¨å…¶ä»–çº¿ç¨‹åŒæ—¶ç”³è¯·äº’æ–¥é‡ï¼Œä½†æ²¡æœ‰ç«äº‰åˆ°äº’æ–¥é‡ï¼Œé‚£ä¹ˆpthread lockè°ƒç”¨ä¼šé™·å…¥é˜»å¡(æ‰§è¡Œæµè¢«æŒ‚èµ·)ï¼Œç­‰å¾…äº’æ–¥é‡è§£é”ã€‚

### 3.3 pthread\_mutex åº•å±‚å®ç°

```cpp
// é”ç»“æ„ï¼ˆç®€åŒ–ä¸ºx86å®ç°ï¼‰
struct pthread_mutex {
    int __lock;          // é”çŠ¶æ€æ ‡è¯†
    int __count;         // é€’å½’é”è®¡æ•°å™¨
    int __owner;         // æŒæœ‰è€…çº¿ç¨‹ID
    int __kind;          // é”ç±»å‹æ ‡è¯†
    // ... å…¶ä»–å­—æ®µ
};

```

## ğŸ³ï¸â€ğŸŒˆå››ã€C++ RAIIå°è£…å®æˆ˜

### 4.1 åŸºç¡€äº’æ–¥ç±»ï¼ˆMutexï¼‰

```cpp
// äº’æ–¥é”å°è£…ç±»ï¼ˆä¸å¯æ‹·è´æ„é€ /èµ‹å€¼ï¼‰
    class Mutex
    {
    public:
        // ç¦æ­¢æ‹·è´ï¼ˆä¿æŠ¤ç³»ç»Ÿé”èµ„æºï¼‰
        Mutex(const Mutex&) = delete;
        const Mutex& operator = (const Mutex&) = delete;

        // æ„é€ å‡½æ•°ï¼šåˆå§‹åŒ–POSIXäº’æ–¥é”
        Mutex()
        {
            // åˆå§‹åŒ–äº’æ–¥é”å±æ€§ä¸ºé»˜è®¤å€¼
            int n = ::pthread_mutex_init(&_lock, nullptr);
            (void)n; // å®é™…å¼€å‘å»ºè®®å¤„ç†é”™è¯¯ç 
        }

        // ææ„å‡½æ•°ï¼šé”€æ¯é”èµ„æº
        ~Mutex()
        {
            // ç¡®ä¿é”å·²å¤„äºæœªé”å®šçŠ¶æ€
            int n = ::pthread_mutex_destroy(&_lock);
            (void)n; // ç”Ÿäº§ç¯å¢ƒåº”æ£€æŸ¥è¿”å›å€¼
        }

        // åŠ é”æ“ä½œï¼ˆé˜»å¡ç›´è‡³è·å–é”ï¼‰
        void Lock()
        {
            // å¯èƒ½è¿”å›EDEADLKï¼ˆæ­»é”æ£€æµ‹ï¼‰ç­‰é”™è¯¯ç 
            int n = ::pthread_mutex_lock(&_lock);
            (void)n; // ç®€åŒ–å¤„ç†ï¼Œå®é™…å»ºè®®æŠ›å¼‚å¸¸æˆ–è®°å½•æ—¥å¿—
        }

        // è§£é”æ“ä½œï¼ˆå¿…é¡»ç”±é”æŒæœ‰è€…è°ƒç”¨ï¼‰
        void Unlock()
        {
            // æœªæŒæœ‰é”æ—¶è§£é”å°†è¿”å›EPERM
            int n = ::pthread_mutex_unlock(&_lock);
            (void)n; 
        }

    private:
        pthread_mutex_t _lock; // åº•å±‚é”å¯¹è±¡
    };

```

### 4.2 å®ˆå«é”ï¼ˆLockGuardï¼‰

å®ˆå«é”ä¸æ˜¯æ–°çš„é”ç±»å‹ï¼Œè€Œæ˜¯å¯¹å·²æœ‰é”çš„è‡ªåŠ¨åŒ–ç”Ÿå‘½å‘¨æœŸç®¡ç†å·¥å…·ã€‚è¿™ç§è®¾è®¡æ¨¡å¼å®Œç¾å¥‘åˆå›¾ç¤ºä¸­"Lock-unlock"è¾¹ç•Œéœ€è¦ä¸¥æ ¼åŒ¹é…çš„æ ¸å¿ƒè¯‰æ±‚

**å®ˆå«é”å·¥ä½œæµç¨‹**

```cpp
sequenceDiagram
    participant çº¿ç¨‹
    participant å®ˆå«é”
    participant äº’æ–¥é”
    
    çº¿ç¨‹->>å®ˆå«é”: åˆ›å»ºLockGuardå¯¹è±¡
    å®ˆå«é”->>äº’æ–¥é”: è°ƒç”¨Lock()
    äº’æ–¥é”-->>å®ˆå«é”: è·å¾—é”
    çº¿ç¨‹->>ä¸´ç•ŒåŒº: æ‰§è¡Œæ“ä½œ
    çº¿ç¨‹->>å®ˆå«é”: å¯¹è±¡ç¦»å¼€ä½œç”¨åŸŸ
    å®ˆå«é”->>äº’æ–¥é”: è°ƒç”¨Unlock()
    äº’æ–¥é”-->>å…¶ä»–çº¿ç¨‹: é‡Šæ”¾é”èµ„æº

```

**å®ç°**

```cpp
// RAIIé”å®ˆå«ï¼ˆè‡ªåŠ¨ç®¡ç†é”ç”Ÿå‘½å‘¨æœŸï¼‰
    class LockGuard
    {
    public:
        // æ„é€ æ—¶åŠ é”ï¼ˆå¿…é¡»ä¼ å…¥å·²åˆå§‹åŒ–çš„Mutexå¼•ç”¨ï¼‰
        LockGuard(Mutex &mtx):_mtx(mtx)
        {
            _mtx.Lock(); // è¿›å…¥ä¸´ç•ŒåŒº
        }

        // ææ„æ—¶è‡ªåŠ¨è§£é”ï¼ˆå¼‚å¸¸å®‰å…¨ä¿è¯ï¼‰
        ~LockGuard()
        {
            _mtx.Unlock(); // ç¦»å¼€ä½œç”¨åŸŸè‡ªåŠ¨é‡Šæ”¾
        }

    private:
        Mutex &_mtx; // å¼•ç”¨æ–¹å¼æŒæœ‰ï¼Œé¿å…æ‹·è´å¯¼è‡´æœªå®šä¹‰è¡Œä¸º
    };

```

## ğŸ³ï¸â€ğŸŒˆäº”ã€å®Œæ•´ä»£ç 

### 5.1 Mutex.hpp

```cpp
#pragma once
#include <iostream>
#include <pthread.h> // POSIXçº¿ç¨‹åº“å¤´æ–‡ä»¶

namespace LockModule
{
    // äº’æ–¥é”å°è£…ç±»ï¼ˆä¸å¯æ‹·è´æ„é€ /èµ‹å€¼ï¼‰
    class Mutex
    {
    public:
        // ç¦æ­¢æ‹·è´ï¼ˆä¿æŠ¤ç³»ç»Ÿé”èµ„æºï¼‰
        Mutex(const Mutex&) = delete;
        const Mutex& operator = (const Mutex&) = delete;

        // æ„é€ å‡½æ•°ï¼šåˆå§‹åŒ–POSIXäº’æ–¥é”
        Mutex()
        {
            // åˆå§‹åŒ–äº’æ–¥é”å±æ€§ä¸ºé»˜è®¤å€¼
            int n = ::pthread_mutex_init(&_lock, nullptr);
            (void)n; // å®é™…å¼€å‘å»ºè®®å¤„ç†é”™è¯¯ç 
        }

        // ææ„å‡½æ•°ï¼šé”€æ¯é”èµ„æº
        ~Mutex()
        {
            // ç¡®ä¿é”å·²å¤„äºæœªé”å®šçŠ¶æ€
            int n = ::pthread_mutex_destroy(&_lock);
            (void)n; // ç”Ÿäº§ç¯å¢ƒåº”æ£€æŸ¥è¿”å›å€¼
        }

        // åŠ é”æ“ä½œï¼ˆé˜»å¡ç›´è‡³è·å–é”ï¼‰
        void Lock()
        {
            // å¯èƒ½è¿”å›EDEADLKï¼ˆæ­»é”æ£€æµ‹ï¼‰ç­‰é”™è¯¯ç 
            int n = ::pthread_mutex_lock(&_lock);
            (void)n; // ç®€åŒ–å¤„ç†ï¼Œå®é™…å»ºè®®æŠ›å¼‚å¸¸æˆ–è®°å½•æ—¥å¿—
        }

        // è§£é”æ“ä½œï¼ˆå¿…é¡»ç”±é”æŒæœ‰è€…è°ƒç”¨ï¼‰
        void Unlock()
        {
            // æœªæŒæœ‰é”æ—¶è§£é”å°†è¿”å›EPERM
            int n = ::pthread_mutex_unlock(&_lock);
            (void)n; 
        }

    private:
        pthread_mutex_t _lock; // åº•å±‚é”å¯¹è±¡
    };

    // RAIIé”å®ˆå«ï¼ˆè‡ªåŠ¨ç®¡ç†é”ç”Ÿå‘½å‘¨æœŸï¼‰
    class LockGuard
    {
    public:
        // æ„é€ æ—¶åŠ é”ï¼ˆå¿…é¡»ä¼ å…¥å·²åˆå§‹åŒ–çš„Mutexå¼•ç”¨ï¼‰
        LockGuard(Mutex &mtx):_mtx(mtx)
        {
            _mtx.Lock(); // è¿›å…¥ä¸´ç•ŒåŒº
        }

        // ææ„æ—¶è‡ªåŠ¨è§£é”ï¼ˆå¼‚å¸¸å®‰å…¨ä¿è¯ï¼‰
        ~LockGuard()
        {
            _mtx.Unlock(); // ç¦»å¼€ä½œç”¨åŸŸè‡ªåŠ¨é‡Šæ”¾
        }

    private:
        Mutex &_mtx; // å¼•ç”¨æ–¹å¼æŒæœ‰ï¼Œé¿å…æ‹·è´å¯¼è‡´æœªå®šä¹‰è¡Œä¸º
    };
}

```

### 5.2 Mutex.cc

```cpp
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <pthread.h>
#include <sched.h>

int ticket = 0;
pthread_mutex_t mutex;
pthread_cond_t cond = PTHREAD_COND_INITIALIZER;

void *route(void *arg)
{
    char *id = (char *)arg;
    while (1)
    {
        pthread_mutex_lock(&mutex);
        if (ticket > 0)
        {
            usleep(1000);
            printf("%s sells ticket:%d\n", id, ticket);
            ticket--;
            pthread_mutex_unlock(&mutex);
        }
        else
        {
            printf("%s wait on cond!\n", id);
            pthread_cond_wait(&cond, &mutex); //é†’æ¥çš„æ—¶å€™ï¼Œä¼šé‡æ–°ç”³è¯·é”ï¼ï¼
            printf("%s è¢«å«é†’äº†\n", id);
        }
        pthread_mutex_unlock(&mutex);
    }
    return nullptr;
}

int main(void)
{
    pthread_t t1, t2, t3, t4;

    pthread_mutex_init(&mutex, NULL);

    pthread_create(&t1, NULL, route, (void *)"thread 1");
    pthread_create(&t2, NULL, route, (void *)"thread 2");
    pthread_create(&t3, NULL, route, (void *)"thread 3");
    pthread_create(&t4, NULL, route, (void *)"thread 4");

    int cnt = 10;

    while(true)
    {
        sleep(5);
        ticket += cnt;
        printf("ä¸»çº¿ç¨‹æ”¾ç¥¨å–½, ticket: %d\n", ticket);
        pthread_cond_signal(&cond);
    }


    pthread_join(t1, NULL);
    pthread_join(t2, NULL);
    pthread_join(t3, NULL);
    pthread_join(t4, NULL);
    pthread_mutex_destroy(&mutex);
}

```

### 5.3 Makefile

```cpp
bin=testMutex
cc=g++
src=$(wildcard *.cc)
obj=$(src:.cc=.o)

$(bin):$(obj)
	$(cc) -o $@ $^ -lpthread
%.o:%.cc
	$(cc) -c $< -std=c++17

.PHONY:clean
clean:
	rm -f $(bin) $(obj)

.PHONY:test
test:
	echo $(src)
	echo $(obj)

```

---

## ğŸ‘¥æ€»ç»“

æœ¬ç¯‡åšæ–‡å¯¹
**ä»äº’æ–¥åŸç†åˆ°C++ RAIIå°è£…å®è·µ**
åšäº†ä¸€ä¸ªè¾ƒä¸ºè¯¦ç»†çš„ä»‹ç»ï¼Œä¸çŸ¥é“å¯¹ä½ æœ‰æ²¡æœ‰å¸®åŠ©å‘¢

è§‰å¾—åšä¸»å†™å¾—è¿˜ä¸é”™çš„ä¸‰è¿æ”¯æŒä¸‹å§ï¼ä¼šç»§ç»­åŠªåŠ›çš„~

![è¯·æ·»åŠ å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/direct/ccd277ddb2e84277b6970d9cc24da8bd.jpeg#pic_center)