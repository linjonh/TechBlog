---
layout: post
title: "Linuxä»äº’æ–¥åŸç†åˆ°C-RAIIå°è£…å®è·µ"
date: 2025-03-14 15:46:18 +0800
description: "ç´§æ¥ä¸Šå›çš„çº¿ç¨‹C++å°è£…ï¼Œè¿™å›ç¬”è€…ç€é‡ä»‹ç»ä¸€ä¸‹äº’æ–¥çš„åŸç†å’Œå…¶å¿…è¦æ€§ï¼Œå¹¶æ‰‹æŠŠæ‰‹ä½¿ç”¨C++å°è£…ä¸€ä¸ªRAIIæ¨¡å‹ã€‚è¿˜æœ‰ä¸€ç‚¹ï¼Œç¬”è€…ä¹‹åçš„å°è£…éƒ½ä¼šä½¿ç”¨ä¹‹å‰åšå®¢ä¸­å°è£…å¥½çš„å®¹å™¨ï¼Œéœ€è¦çš„å¯ä»¥å»ä»“åº“æˆ–è€…å‰é¢çš„åšå®¢ä¸­è‡ªå–ã€‚RAIIçš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†èµ„æºçš„è·å–å’Œåˆå§‹åŒ–æ”¾åœ¨å¯¹è±¡çš„æ„é€ å‡½æ•°ä¸­è¿›è¡Œï¼Œè€Œèµ„æºçš„é‡Šæ”¾æ”¾åœ¨å¯¹è±¡çš„ææ„å‡½æ•°ä¸­è¿›è¡Œã€‚å½“å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œå…¶æ„é€ å‡½æ•°ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œä»è€Œå®Œæˆèµ„æºçš„è·å–ï¼›å½“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶ï¼Œå…¶ææ„å‡½æ•°ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ï¼Œä»è€Œå®Œæˆèµ„æºçš„é‡Šæ”¾ã€‚"
keywords: "ã€Linuxã€‘ä»äº’æ–¥åŸç†åˆ°C++ RAIIå°è£…å®è·µ"
categories: ['æœªåˆ†ç±»']
tags: ['Linux', 'C']
artid: "146257773"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146257773
    alt: "Linuxä»äº’æ–¥åŸç†åˆ°C-RAIIå°è£…å®è·µ"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146257773
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146257773
cover: https://bing.ee123.net/img/rand?artid=146257773
image: https://bing.ee123.net/img/rand?artid=146257773
img: https://bing.ee123.net/img/rand?artid=146257773
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ã€Linuxã€‘ä»äº’æ–¥åŸç†åˆ°C++ RAIIå°è£…å®è·µ
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      ğŸ“¢åšå®¢ä¸»é¡µï¼š
      <a href="https://blog.csdn.net/2301_77954967?spm=1011.2444.3001.5343">
       https://blog.csdn.net/2301_779549673
      </a>
      <br/>
      ğŸ“¢æ¬¢è¿ç‚¹èµ ğŸ‘ æ”¶è— â­ç•™è¨€ ğŸ“ å¦‚æœ‰é”™è¯¯æ•¬è¯·æŒ‡æ­£ï¼
      <br/>
      ğŸ“¢æœ¬æ–‡ç”±
      <em>
       <strong>
        JohnKi
       </strong>
      </em>
      åŸåˆ›ï¼Œé¦–å‘äº CSDNğŸ™‰
      <br/>
      ğŸ“¢æœªæ¥å¾ˆé•¿ï¼Œå€¼å¾—æˆ‘ä»¬å…¨åŠ›å¥”èµ´æ›´ç¾å¥½çš„ç”Ÿæ´»âœ¨
     </p>
    </blockquote>
    <p>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/direct/9393ea55f0d5414da8e09bd55eb82f4f.gif#pic_center"/>
    </p>
    <p>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://img-blog.csdnimg.cn/direct/b55982b2fa5b47dda351a719b325c9e1.gif#pic_center"/>
    </p>
    <p>
    </p>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="_20">
     </a>
     ğŸ“¢å‰è¨€
    </h2>
    <p>
     ç´§æ¥ä¸Šå›çš„
     <code>
      çº¿ç¨‹C++å°è£…
     </code>
     ï¼Œè¿™å›ç¬”è€…ç€é‡ä»‹ç»ä¸€ä¸‹äº’æ–¥çš„åŸç†å’Œå…¶å¿…è¦æ€§ï¼Œå¹¶æ‰‹æŠŠæ‰‹ä½¿ç”¨C++å°è£…ä¸€ä¸ªRAIIæ¨¡å‹ã€‚
    </p>
    <p>
     è¿˜æœ‰ä¸€ç‚¹ï¼Œç¬”è€…ä¹‹åçš„å°è£…éƒ½ä¼šä½¿ç”¨ä¹‹å‰åšå®¢ä¸­å°è£…å¥½çš„å®¹å™¨ï¼Œéœ€è¦çš„å¯ä»¥å»ä»“åº“æˆ–è€…å‰é¢çš„åšå®¢ä¸­è‡ªå–ã€‚
    </p>
    <p>
     <code>
      RAII
     </code>
     çš„æ ¸å¿ƒæ€æƒ³æ˜¯å°†èµ„æºçš„è·å–å’Œåˆå§‹åŒ–æ”¾åœ¨å¯¹è±¡çš„æ„é€ å‡½æ•°ä¸­è¿›è¡Œï¼Œè€Œèµ„æºçš„é‡Šæ”¾æ”¾åœ¨å¯¹è±¡çš„ææ„å‡½æ•°ä¸­è¿›è¡Œã€‚å½“å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œå…¶æ„é€ å‡½æ•°ä¼šè‡ªåŠ¨æ‰§è¡Œï¼Œä»è€Œå®Œæˆèµ„æºçš„è·å–ï¼›å½“å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶ï¼Œå…¶ææ„å‡½æ•°ä¼šè¢«è‡ªåŠ¨è°ƒç”¨ï¼Œä»è€Œå®Œæˆèµ„æºçš„é‡Šæ”¾ã€‚è¿™æ ·ï¼Œèµ„æºçš„ç”Ÿå‘½å‘¨æœŸå°±ä¸å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸç»‘å®šåœ¨ä¸€èµ·ï¼Œåˆ©ç”¨ C++ ç­‰è¯­è¨€çš„å¯¹è±¡è‡ªåŠ¨é”€æ¯æœºåˆ¶æ¥ç¡®ä¿èµ„æºçš„æ­£ç¡®é‡Šæ”¾ã€‚
    </p>
    <hr/>
    <h2>
     <a id="_31">
     </a>
     ğŸ³ï¸â€ğŸŒˆä¸€ã€ä»åœºæ™¯çœ‹äº’æ–¥ï¼šä¸ºä»€ä¹ˆéœ€è¦é”ï¼Ÿ
    </h2>
    <p>
     <strong>
      å‡è®¾ä½ çš„é“¶è¡Œè´¦æˆ·ä½™é¢æ˜¯1000å…ƒï¼ŒåŒæ—¶æœ‰ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œè½¬è´¦æ“ä½œï¼š
     </strong>
    </p>
    <ul>
     <li>
      â€‹çº¿ç¨‹Aï¼šå­˜å…¥200å…ƒ â†’ balance += 200
     </li>
     <li>
      â€‹çº¿ç¨‹Bï¼šå–å‡º300å…ƒ â†’ balance -= 300
      <br/>
      <strong>
       æ— é”æƒ…å†µä¸‹å¯èƒ½çš„æ‰§è¡Œé¡ºåºï¼š
      </strong>
     </li>
    </ul>
    <pre><code class="prism language-cpp">çº¿ç¨‹Aè¯»å–<span class="token function">balance</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> â†’ çº¿ç¨‹Bè¯»å–<span class="token function">balance</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> â†’ 
çº¿ç¨‹Aå†™å…¥<span class="token number">1200</span> â†’ çº¿ç¨‹Bå†™å…¥<span class="token number">700</span>  
æœ€ç»ˆç»“æœï¼š<span class="token number">700</span>å…ƒï¼ˆæ­£ç¡®åº”ä¸º<span class="token number">900</span>å…ƒï¼‰
</code></pre>
    <h2>
     <a id="_44">
     </a>
     ğŸ³ï¸â€ğŸŒˆäºŒã€äº’æ–¥é”æ ¸å¿ƒæ¦‚å¿µå›¾è§£
    </h2>
    <h3>
     <a id="21__45">
     </a>
     2.1 ä¸´ç•ŒåŒºä¸éä¸´ç•ŒåŒº
    </h3>
    <p>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/11f6297af1ca40baba191298248094b7.png"/>
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">thread_func</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// éä¸´ç•ŒåŒºï¼ˆå¯å¹¶å‘æ‰§è¡Œï¼‰</span>
    <span class="token function">prepare_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    
    <span class="token comment">// ä¸´ç•ŒåŒºï¼ˆéœ€äº’æ–¥è®¿é—®ï¼‰</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">update_shared_resource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// éä¸´ç•ŒåŒºï¼ˆå¯å¹¶å‘æ‰§è¡Œï¼‰</span>
    <span class="token function">post_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     å…³é”®ç‰¹å¾ï¼š
    </p>
    <p>
     ğŸ”µ â€‹éä¸´ç•ŒåŒºï¼šå…è®¸å¤šçº¿ç¨‹å¹¶è¡Œï¼ˆå¦‚å›¾ä¸­ç»¿è‰²åŒºåŸŸï¼‰
     <br/>
     ğŸ”´ â€‹ä¸´ç•ŒåŒºï¼šåŒä¸€æ—¶åˆ»ä»…ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼ˆçº¢è‰²åŒºåŸŸï¼‰
    </p>
    <h3>
     <a id="2_2__67">
     </a>
     2. 2 è¿›ç¨‹çº¿ç¨‹é—´çš„äº’æ–¥ç›¸å…³èƒŒæ™¯æ¦‚å¿µ
    </h3>
    <ul>
     <li>
      <strong>
       ä¸´ç•Œèµ„æº
      </strong>
      :å¤šçº¿ç¨‹æ‰§è¡Œæµå…±äº«çš„èµ„æºå°±å«åšä¸´ç•Œèµ„æº
     </li>
     <li>
      <strong>
       ä¸´ç•ŒåŒº
      </strong>
      :æ¯ä¸ªçº¿ç¨‹å†…éƒ¨ï¼Œè®¿é—®ä¸´ç•Œèµ„æºçš„ä»£ç ï¼Œå°±å«åšä¸´ç•ŒåŒº
     </li>
     <li>
      <strong>
       äº’æ–¥
      </strong>
      :ä»»ä½•æ—¶åˆ»ï¼Œäº’æ–¥ä¿è¯æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ‰§è¡Œæµè¿›å…¥ä¸´ç•ŒåŒºï¼Œè®¿é—®ä¸´ç•Œèµ„æºï¼Œé€šå¸¸å¯¹ä¸´ç•Œèµ„æºèµ·ä¿æŠ¤ä½œç”¨
     </li>
     <li>
      <strong>
       åŸå­æ€§
      </strong>
      :(åé¢è®¨è®ºå¦‚ä½•å®ç°):ä¸ä¼šè¢«ä»»ä½•è°ƒåº¦æœºåˆ¶æ‰“æ–­çš„æ“ä½œï¼Œè¯¥æ“ä½œåªæœ‰ä¸¤æ€ï¼Œè¦ä¹ˆå®Œæˆï¼Œè¦ä¹ˆæœªå®Œæˆ
     </li>
    </ul>
    <h2>
     <a id="Linux_72">
     </a>
     ğŸ³ï¸â€ğŸŒˆä¸‰ã€Linuxäº’æ–¥é”åŸç†å‰–æ
    </h2>
    <p>
     <strong>
      æ ¸å¿ƒæ“ä½œæµç¨‹ï¼š
     </strong>
    </p>
    <pre><code class="prism language-cpp">sequenceDiagram
    participant çº¿ç¨‹A
    participant äº’æ–¥é”
    participant å†…æ ¸
    
    çº¿ç¨‹A<span class="token operator">-&gt;</span><span class="token operator">&gt;</span>äº’æ–¥é”<span class="token operator">:</span> <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    alt é”ç©ºé—²
        äº’æ–¥é”<span class="token operator">--</span><span class="token operator">&gt;&gt;</span>çº¿ç¨‹A<span class="token operator">:</span> ç«‹å³è·å¾—é”
    <span class="token keyword">else</span> é”è¢«å 
        çº¿ç¨‹A<span class="token operator">-&gt;</span><span class="token operator">&gt;</span>å†…æ ¸<span class="token operator">:</span> è¿›å…¥ä¼‘çœ é˜Ÿåˆ—
        å†…æ ¸<span class="token operator">--</span><span class="token operator">&gt;&gt;</span>çº¿ç¨‹A<span class="token operator">:</span> å”¤é†’å¹¶è·å–é”
    end
    çº¿ç¨‹A<span class="token operator">-&gt;</span><span class="token operator">&gt;</span>ä¸´ç•ŒåŒº<span class="token operator">:</span> æ‰§è¡Œæ“ä½œ
    çº¿ç¨‹A<span class="token operator">-&gt;</span><span class="token operator">&gt;</span>äº’æ–¥é”<span class="token operator">:</span> <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="32__93">
     </a>
     3.2 åˆå§‹åŒ–äº’æ–¥é‡
    </h3>
    <p>
     <strong>
      æ–¹æ³•ä¸€ï¼šé™æ€åˆ†å¸ƒ
     </strong>
    </p>
    <pre><code class="prism language-cpp">pthread_mutex_t mutex <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER
</code></pre>
    <p>
     <strong>
      æ–¹æ³•äºŒï¼šåŠ¨æ€åˆ†å¸ƒ
     </strong>
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span>pthread_mutex_t <span class="token operator">*</span>restrict mutex<span class="token punctuation">,</span> <span class="token keyword">const</span> pthread_mutexattr_t <span class="token operator">*</span>restrict attr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      mutex
     </strong>
     ï¼šè¦åˆå§‹åŒ–çš„äº’æ–¥é‡
     <br/>
     <strong>
      attr
     </strong>
     ï¼šNULL
    </p>
    <h3>
     <a id="33__108">
     </a>
     3.3 é”€æ¯äº’æ–¥é‡
    </h3>
    <p>
     <strong>
      é”€æ¯äº’æ–¥é‡éœ€è¦æ³¨æ„ï¼š
     </strong>
    </p>
    <ul>
     <li>
      ä½¿ç”¨ PTHREAD_MUTEXINITIALIZER åˆå§‹åŒ–çš„äº’æ–¥é‡ä¸éœ€è¦é”€æ¯
     </li>
     <li>
      ä¸è¦é”€æ¯ä¸€ä¸ªå·²ç»åŠ é”çš„äº’æ–¥é‡
     </li>
     <li>
      å·²ç»é”€æ¯çš„äº’æ–¥é‡ï¼Œè¦ç¡®ä¿åé¢ä¸ä¼šæœ‰çº¿ç¨‹å†å°è¯•åŠ é”
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span>pthread_mutex_t <span class="token operator">*</span>mutex<span class="token punctuation">)</span>ï¼›
</code></pre>
    <p>
     <strong>
      äº’æ–¥é‡åŠ é”å’Œè§£é”
     </strong>
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>pthread_mutex_t <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span>pthread_mutex_t <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
è¿”å›å€¼<span class="token operator">:</span>æˆåŠŸè¿”å›<span class="token number">0</span><span class="token punctuation">,</span>å¤±è´¥è¿”å›é”™è¯¯å·
</code></pre>
    <p>
     <strong>
      è°ƒâ½¤ pthread_mutex_lock æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°ä»¥ä¸‹æƒ…å†µ:
     </strong>
    </p>
    <ul>
     <li>
      äº’æ–¥é‡å¤„äºæœªé”çŠ¶æ€ï¼Œè¯¥å‡½æ•°ä¼šå°†äº’æ–¥é‡é”å®šï¼ŒåŒæ—¶è¿”å›æˆåŠŸ
     </li>
     <li>
      å‘èµ·å‡½æ•°è°ƒç”¨æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å·²ç»é”å®šäº’æ–¥é‡ï¼Œæˆ–è€…å­˜åœ¨å…¶ä»–çº¿ç¨‹åŒæ—¶ç”³è¯·äº’æ–¥é‡ï¼Œä½†æ²¡æœ‰ç«äº‰åˆ°äº’æ–¥é‡ï¼Œé‚£ä¹ˆpthread lockè°ƒç”¨ä¼šé™·å…¥é˜»å¡(æ‰§è¡Œæµè¢«æŒ‚èµ·)ï¼Œç­‰å¾…äº’æ–¥é‡è§£é”ã€‚
     </li>
    </ul>
    <h3>
     <a id="33_pthread_mutex__132">
     </a>
     3.3 pthread_mutex åº•å±‚å®ç°
    </h3>
    <pre><code class="prism language-cpp"><span class="token comment">// é”ç»“æ„ï¼ˆç®€åŒ–ä¸ºx86å®ç°ï¼‰</span>
<span class="token keyword">struct</span> <span class="token class-name">pthread_mutex</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> __lock<span class="token punctuation">;</span>          <span class="token comment">// é”çŠ¶æ€æ ‡è¯†</span>
    <span class="token keyword">int</span> __count<span class="token punctuation">;</span>         <span class="token comment">// é€’å½’é”è®¡æ•°å™¨</span>
    <span class="token keyword">int</span> __owner<span class="token punctuation">;</span>         <span class="token comment">// æŒæœ‰è€…çº¿ç¨‹ID</span>
    <span class="token keyword">int</span> __kind<span class="token punctuation">;</span>          <span class="token comment">// é”ç±»å‹æ ‡è¯†</span>
    <span class="token comment">// ... å…¶ä»–å­—æ®µ</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h2>
     <a id="C_RAII_144">
     </a>
     ğŸ³ï¸â€ğŸŒˆå››ã€C++ RAIIå°è£…å®æˆ˜
    </h2>
    <h3>
     <a id="41_Mutex_145">
     </a>
     4.1 åŸºç¡€äº’æ–¥ç±»ï¼ˆMutexï¼‰
    </h3>
    <pre><code class="prism language-cpp"><span class="token comment">// äº’æ–¥é”å°è£…ç±»ï¼ˆä¸å¯æ‹·è´æ„é€ /èµ‹å€¼ï¼‰</span>
    <span class="token keyword">class</span> <span class="token class-name">Mutex</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token comment">// ç¦æ­¢æ‹·è´ï¼ˆä¿æŠ¤ç³»ç»Ÿé”èµ„æºï¼‰</span>
        <span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token keyword">const</span> Mutex<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> Mutex<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Mutex<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

        <span class="token comment">// æ„é€ å‡½æ•°ï¼šåˆå§‹åŒ–POSIXäº’æ–¥é”</span>
        <span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// åˆå§‹åŒ–äº’æ–¥é”å±æ€§ä¸ºé»˜è®¤å€¼</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>n<span class="token punctuation">;</span> <span class="token comment">// å®é™…å¼€å‘å»ºè®®å¤„ç†é”™è¯¯ç </span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ææ„å‡½æ•°ï¼šé”€æ¯é”èµ„æº</span>
        <span class="token operator">~</span><span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// ç¡®ä¿é”å·²å¤„äºæœªé”å®šçŠ¶æ€</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>n<span class="token punctuation">;</span> <span class="token comment">// ç”Ÿäº§ç¯å¢ƒåº”æ£€æŸ¥è¿”å›å€¼</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// åŠ é”æ“ä½œï¼ˆé˜»å¡ç›´è‡³è·å–é”ï¼‰</span>
        <span class="token keyword">void</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// å¯èƒ½è¿”å›EDEADLKï¼ˆæ­»é”æ£€æµ‹ï¼‰ç­‰é”™è¯¯ç </span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>n<span class="token punctuation">;</span> <span class="token comment">// ç®€åŒ–å¤„ç†ï¼Œå®é™…å»ºè®®æŠ›å¼‚å¸¸æˆ–è®°å½•æ—¥å¿—</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è§£é”æ“ä½œï¼ˆå¿…é¡»ç”±é”æŒæœ‰è€…è°ƒç”¨ï¼‰</span>
        <span class="token keyword">void</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// æœªæŒæœ‰é”æ—¶è§£é”å°†è¿”å›EPERM</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>n<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        pthread_mutex_t _lock<span class="token punctuation">;</span> <span class="token comment">// åº•å±‚é”å¯¹è±¡</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="42_LockGuard_192">
     </a>
     4.2 å®ˆå«é”ï¼ˆLockGuardï¼‰
    </h3>
    <p>
     å®ˆå«é”ä¸æ˜¯æ–°çš„é”ç±»å‹ï¼Œè€Œæ˜¯å¯¹å·²æœ‰é”çš„è‡ªåŠ¨åŒ–ç”Ÿå‘½å‘¨æœŸç®¡ç†å·¥å…·ã€‚è¿™ç§è®¾è®¡æ¨¡å¼å®Œç¾å¥‘åˆå›¾ç¤ºä¸­"Lock-unlock"è¾¹ç•Œéœ€è¦ä¸¥æ ¼åŒ¹é…çš„æ ¸å¿ƒè¯‰æ±‚
    </p>
    <p>
     <strong>
      å®ˆå«é”å·¥ä½œæµç¨‹
     </strong>
    </p>
    <pre><code class="prism language-cpp">sequenceDiagram
    participant çº¿ç¨‹
    participant å®ˆå«é”
    participant äº’æ–¥é”
    
    çº¿ç¨‹<span class="token operator">-&gt;</span><span class="token operator">&gt;</span>å®ˆå«é”<span class="token operator">:</span> åˆ›å»ºLockGuardå¯¹è±¡
    å®ˆå«é”<span class="token operator">-&gt;</span><span class="token operator">&gt;</span>äº’æ–¥é”<span class="token operator">:</span> è°ƒç”¨<span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    äº’æ–¥é”<span class="token operator">--</span><span class="token operator">&gt;&gt;</span>å®ˆå«é”<span class="token operator">:</span> è·å¾—é”
    çº¿ç¨‹<span class="token operator">-&gt;</span><span class="token operator">&gt;</span>ä¸´ç•ŒåŒº<span class="token operator">:</span> æ‰§è¡Œæ“ä½œ
    çº¿ç¨‹<span class="token operator">-&gt;</span><span class="token operator">&gt;</span>å®ˆå«é”<span class="token operator">:</span> å¯¹è±¡ç¦»å¼€ä½œç”¨åŸŸ
    å®ˆå«é”<span class="token operator">-&gt;</span><span class="token operator">&gt;</span>äº’æ–¥é”<span class="token operator">:</span> è°ƒç”¨<span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    äº’æ–¥é”<span class="token operator">--</span><span class="token operator">&gt;&gt;</span>å…¶ä»–çº¿ç¨‹<span class="token operator">:</span> é‡Šæ”¾é”èµ„æº
</code></pre>
    <p>
     <strong>
      å®ç°
     </strong>
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// RAIIé”å®ˆå«ï¼ˆè‡ªåŠ¨ç®¡ç†é”ç”Ÿå‘½å‘¨æœŸï¼‰</span>
    <span class="token keyword">class</span> <span class="token class-name">LockGuard</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token comment">// æ„é€ æ—¶åŠ é”ï¼ˆå¿…é¡»ä¼ å…¥å·²åˆå§‹åŒ–çš„Mutexå¼•ç”¨ï¼‰</span>
        <span class="token function">LockGuard</span><span class="token punctuation">(</span>Mutex <span class="token operator">&amp;</span>mtx<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">_mtx</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _mtx<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è¿›å…¥ä¸´ç•ŒåŒº</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ææ„æ—¶è‡ªåŠ¨è§£é”ï¼ˆå¼‚å¸¸å®‰å…¨ä¿è¯ï¼‰</span>
        <span class="token operator">~</span><span class="token function">LockGuard</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _mtx<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç¦»å¼€ä½œç”¨åŸŸè‡ªåŠ¨é‡Šæ”¾</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        Mutex <span class="token operator">&amp;</span>_mtx<span class="token punctuation">;</span> <span class="token comment">// å¼•ç”¨æ–¹å¼æŒæœ‰ï¼Œé¿å…æ‹·è´å¯¼è‡´æœªå®šä¹‰è¡Œä¸º</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h2>
     <a id="_234">
     </a>
     ğŸ³ï¸â€ğŸŒˆäº”ã€å®Œæ•´ä»£ç 
    </h2>
    <h3>
     <a id="51_Mutexhpp_235">
     </a>
     5.1 Mutex.hpp
    </h3>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span> <span class="token comment">// POSIXçº¿ç¨‹åº“å¤´æ–‡ä»¶</span></span>

<span class="token keyword">namespace</span> LockModule
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// äº’æ–¥é”å°è£…ç±»ï¼ˆä¸å¯æ‹·è´æ„é€ /èµ‹å€¼ï¼‰</span>
    <span class="token keyword">class</span> <span class="token class-name">Mutex</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token comment">// ç¦æ­¢æ‹·è´ï¼ˆä¿æŠ¤ç³»ç»Ÿé”èµ„æºï¼‰</span>
        <span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token keyword">const</span> Mutex<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> Mutex<span class="token operator">&amp;</span> <span class="token keyword">operator</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Mutex<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

        <span class="token comment">// æ„é€ å‡½æ•°ï¼šåˆå§‹åŒ–POSIXäº’æ–¥é”</span>
        <span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// åˆå§‹åŒ–äº’æ–¥é”å±æ€§ä¸ºé»˜è®¤å€¼</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>n<span class="token punctuation">;</span> <span class="token comment">// å®é™…å¼€å‘å»ºè®®å¤„ç†é”™è¯¯ç </span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ææ„å‡½æ•°ï¼šé”€æ¯é”èµ„æº</span>
        <span class="token operator">~</span><span class="token function">Mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// ç¡®ä¿é”å·²å¤„äºæœªé”å®šçŠ¶æ€</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>n<span class="token punctuation">;</span> <span class="token comment">// ç”Ÿäº§ç¯å¢ƒåº”æ£€æŸ¥è¿”å›å€¼</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// åŠ é”æ“ä½œï¼ˆé˜»å¡ç›´è‡³è·å–é”ï¼‰</span>
        <span class="token keyword">void</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// å¯èƒ½è¿”å›EDEADLKï¼ˆæ­»é”æ£€æµ‹ï¼‰ç­‰é”™è¯¯ç </span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>n<span class="token punctuation">;</span> <span class="token comment">// ç®€åŒ–å¤„ç†ï¼Œå®é™…å»ºè®®æŠ›å¼‚å¸¸æˆ–è®°å½•æ—¥å¿—</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è§£é”æ“ä½œï¼ˆå¿…é¡»ç”±é”æŒæœ‰è€…è°ƒç”¨ï¼‰</span>
        <span class="token keyword">void</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// æœªæŒæœ‰é”æ—¶è§£é”å°†è¿”å›EPERM</span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>n<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        pthread_mutex_t _lock<span class="token punctuation">;</span> <span class="token comment">// åº•å±‚é”å¯¹è±¡</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// RAIIé”å®ˆå«ï¼ˆè‡ªåŠ¨ç®¡ç†é”ç”Ÿå‘½å‘¨æœŸï¼‰</span>
    <span class="token keyword">class</span> <span class="token class-name">LockGuard</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token comment">// æ„é€ æ—¶åŠ é”ï¼ˆå¿…é¡»ä¼ å…¥å·²åˆå§‹åŒ–çš„Mutexå¼•ç”¨ï¼‰</span>
        <span class="token function">LockGuard</span><span class="token punctuation">(</span>Mutex <span class="token operator">&amp;</span>mtx<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">_mtx</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _mtx<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è¿›å…¥ä¸´ç•ŒåŒº</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ææ„æ—¶è‡ªåŠ¨è§£é”ï¼ˆå¼‚å¸¸å®‰å…¨ä¿è¯ï¼‰</span>
        <span class="token operator">~</span><span class="token function">LockGuard</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _mtx<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç¦»å¼€ä½œç”¨åŸŸè‡ªåŠ¨é‡Šæ”¾</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        Mutex <span class="token operator">&amp;</span>_mtx<span class="token punctuation">;</span> <span class="token comment">// å¼•ç”¨æ–¹å¼æŒæœ‰ï¼Œé¿å…æ‹·è´å¯¼è‡´æœªå®šä¹‰è¡Œä¸º</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="52_Mutexcc_310">
     </a>
     5.2 Mutex.cc
    </h3>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sched.h&gt;</span></span>

<span class="token keyword">int</span> ticket <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
pthread_mutex_t mutex<span class="token punctuation">;</span>
pthread_cond_t cond <span class="token operator">=</span> PTHREAD_COND_INITIALIZER<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> <span class="token operator">*</span>id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s sells ticket:%d\n"</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ticket<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s wait on cond!\n"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pthread_cond_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//é†’æ¥çš„æ—¶å€™ï¼Œä¼šé‡æ–°ç”³è¯·é”ï¼ï¼</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s è¢«å«é†’äº†\n"</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    pthread_t t1<span class="token punctuation">,</span> t2<span class="token punctuation">,</span> t3<span class="token punctuation">,</span> t4<span class="token punctuation">;</span>

    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread 1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread 2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t3<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread 3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>t4<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> route<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread 4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ticket <span class="token operator">+=</span> cnt<span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ä¸»çº¿ç¨‹æ”¾ç¥¨å–½, ticket: %d\n"</span><span class="token punctuation">,</span> ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_cond_signal</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>cond<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token function">pthread_join</span><span class="token punctuation">(</span>t1<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>t2<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>t3<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>t4<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="53_Makefile_378">
     </a>
     5.3 Makefile
    </h3>
    <pre><code class="prism language-cpp">bin<span class="token operator">=</span>testMutex
cc<span class="token operator">=</span>g<span class="token operator">++</span>
src<span class="token operator">=</span>$<span class="token punctuation">(</span>wildcard <span class="token operator">*</span><span class="token punctuation">.</span>cc<span class="token punctuation">)</span>
obj<span class="token operator">=</span>$<span class="token punctuation">(</span>src<span class="token operator">:</span><span class="token punctuation">.</span>cc<span class="token operator">=</span><span class="token punctuation">.</span>o<span class="token punctuation">)</span>

$<span class="token punctuation">(</span>bin<span class="token punctuation">)</span><span class="token operator">:</span>$<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
	$<span class="token punctuation">(</span>cc<span class="token punctuation">)</span> <span class="token operator">-</span>o $@ $<span class="token operator">^</span> <span class="token operator">-</span>lpthread
<span class="token operator">%</span><span class="token punctuation">.</span>o<span class="token operator">:</span><span class="token operator">%</span><span class="token punctuation">.</span>cc
	$<span class="token punctuation">(</span>cc<span class="token punctuation">)</span> <span class="token operator">-</span>c $<span class="token operator">&lt;</span> <span class="token operator">-</span>std<span class="token operator">=</span>c<span class="token operator">++</span><span class="token number">17</span>

<span class="token punctuation">.</span>PHONY<span class="token operator">:</span>clean
clean<span class="token operator">:</span>
	rm <span class="token operator">-</span>f $<span class="token punctuation">(</span>bin<span class="token punctuation">)</span> $<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>

<span class="token punctuation">.</span>PHONY<span class="token operator">:</span>test
test<span class="token operator">:</span>
	echo $<span class="token punctuation">(</span>src<span class="token punctuation">)</span>
	echo $<span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h2>
     <a id="_405">
     </a>
     ğŸ‘¥æ€»ç»“
    </h2>
    <p>
     æœ¬ç¯‡åšæ–‡å¯¹
     <strong>
      ä»äº’æ–¥åŸç†åˆ°C++ RAIIå°è£…å®è·µ
     </strong>
     åšäº†ä¸€ä¸ªè¾ƒä¸ºè¯¦ç»†çš„ä»‹ç»ï¼Œä¸çŸ¥é“å¯¹ä½ æœ‰æ²¡æœ‰å¸®åŠ©å‘¢
    </p>
    <p>
     è§‰å¾—åšä¸»å†™å¾—è¿˜ä¸é”™çš„ä¸‰è¿æ”¯æŒä¸‹å§ï¼ä¼šç»§ç»­åŠªåŠ›çš„~
    </p>
    <p>
     <img alt="è¯·æ·»åŠ å›¾ç‰‡æè¿°" height="400" src="https://img-blog.csdnimg.cn/direct/ccd277ddb2e84277b6970d9cc24da8bd.jpeg#pic_center" width="600"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f37373935343936372f:61727469636c652f64657461696c732f313436323537373733" class_="artid" style="display:none">
 </p>
</div>


