---
layout: post
title: "k8s-v1.28.15部署kubeadm方式"
date: 2025-03-06 19:02:26 +0800
description: "k8s v1.28.15部署（kubeadm方式）"
keywords: "kubeadm 修改kubelet参数"
categories: ['云原生']
tags: ['容器', '云原生', 'Kubernetes']
artid: "146077828"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146077828
    alt: "k8s-v1.28.15部署kubeadm方式"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146077828
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146077828
cover: https://bing.ee123.net/img/rand?artid=146077828
image: https://bing.ee123.net/img/rand?artid=146077828
img: https://bing.ee123.net/img/rand?artid=146077828
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     k8s v1.28.15部署（kubeadm方式）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="k8skubeadm_0">
     </a>
     k8s部署（kubeadm方式）
    </h2>
    <h3>
     <a id="_2">
     </a>
     部署环境及版本
    </h3>
    <pre><code class="prism language-bash">系统版本：CentOS Linux release <span class="token number">7.9</span>.2009
k8s版本：v1.28.15
docker版本：26.1.4
containerd版本：1.6.33
calico版本：v3.25.0
</code></pre>
    <h3>
     <a id="_12">
     </a>
     准备
    </h3>
    <table>
     <thead>
      <tr>
       <th>
        主机ip
       </th>
       <th>
        主机名
       </th>
       <th>
        角色
       </th>
       <th>
        配置
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        192.168.1.131
       </td>
       <td>
        vm131
       </td>
       <td>
        master
       </td>
       <td>
        2核4G，50G
       </td>
      </tr>
      <tr>
       <td>
        192.168.1.132
       </td>
       <td>
        vm132
       </td>
       <td>
        node1
       </td>
       <td>
        2核4G，50G
       </td>
      </tr>
      <tr>
       <td>
        192.168.1.133
       </td>
       <td>
        vm133
       </td>
       <td>
        node2
       </td>
       <td>
        2核4G，50G
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="1_20">
     </a>
     1、修改主机名
    </h4>
    <pre><code class="prism language-bash"><span class="token comment">#master</span>
hostnamectl set-hostname vm131
<span class="token comment">#node1</span>
hostnamectl set-hostname vm132
<span class="token comment">#node2</span>
hostnamectl set-hostname vm133

<span class="token comment">#修改hosts文件</span>
<span class="token function">vim</span> /etc/hosts
<span class="token number">192.168</span>.1.131 vm131
<span class="token number">192.168</span>.1.132 vm132
<span class="token number">192.168</span>.1.133 vm133
</code></pre>
    <h4>
     <a id="2_37">
     </a>
     2、关闭自带防火墙
    </h4>
    <pre><code class="prism language-bash"><span class="token comment"># 关闭SELinux</span>
setenforce <span class="token number">0</span> 
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s/SELINUX=enforcing/SELINUX=disabled/g'</span> /etc/selinux/config

<span class="token comment"># 关闭Firewalld并禁止自启动</span>
systemctl stop firewalld
systemctl disable firewalld

<span class="token comment"># 设置iptables规则</span>
iptables <span class="token parameter variable">-F</span> <span class="token operator">&amp;&amp;</span> iptables <span class="token parameter variable">-X</span> <span class="token operator">&amp;&amp;</span> iptables <span class="token parameter variable">-F</span> <span class="token parameter variable">-t</span> nat <span class="token operator">&amp;&amp;</span> iptables <span class="token parameter variable">-X</span> <span class="token parameter variable">-t</span> nat <span class="token operator">&amp;&amp;</span> iptables <span class="token parameter variable">-P</span> FORWARD ACCEPT

<span class="token comment"># 设置iptables，解决iptables而导致流量无法正确路由的问题</span>
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span><span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;</span>  /etc/sysctl.d/k8s.conf</span>
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
net.ipv4.ip_nonlocal_bind = 1
net.ipv4.ip_forward = 1
vm.swappiness = 0
vm.overcommit_memory = 1
EOF</span>
<span class="token function">sysctl</span> <span class="token parameter variable">--system</span>

<span class="token comment"># 关闭swap</span>
swapoff <span class="token parameter variable">-a</span> <span class="token operator">&amp;&amp;</span> <span class="token function">free</span> –h
<span class="token function">sed</span> <span class="token parameter variable">-i</span> <span class="token string">'s@/dev/mapper/centos-swap@#/dev/mapper/centos-swap@g'</span> /etc/fstab
</code></pre>
    <h4>
     <a id="3_67">
     </a>
     3、时间同步
    </h4>
    <pre><code class="prism language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> ntp
systemctl <span class="token builtin class-name">enable</span> ntpd
systemctl start ntpd
timedatectl set-timezone Asia/Shanghai
ntpdate <span class="token parameter variable">-u</span> time.nist.gov
<span class="token function">date</span>

<span class="token comment">#如果遇到yum源的问题，可以通过以下方式解决</span>
<span class="token function">curl</span> <span class="token parameter variable">-o</span> /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
yum clean all <span class="token comment">#清除缓存</span>
yum makecache <span class="token comment">#生成缓存</span>
</code></pre>
    <h3>
     <a id="docker_83">
     </a>
     一、安装docker
    </h3>
    <pre><code class="prism language-bash"><span class="token comment">#安装编译器环境</span>
yum <span class="token parameter variable">-y</span> <span class="token function">install</span> gcc gcc-c++
<span class="token comment">#卸载之前下载的docker（防止和之前安装过的docker出现冲突）</span>
 yum remove <span class="token function">docker</span> <span class="token punctuation">\</span>
                  docker-client <span class="token punctuation">\</span>
                  docker-client-latest <span class="token punctuation">\</span>
                  docker-common <span class="token punctuation">\</span>
                  docker-latest <span class="token punctuation">\</span>
                  docker-latest-logrotate <span class="token punctuation">\</span>
                  docker-logrotate <span class="token punctuation">\</span>
                  docker-engine
<span class="token comment">#安装yum-utils</span>
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils
<span class="token comment">#将docker-ce.repo添加到/etc/yum.repos.d/</span>
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
<span class="token comment">#提升yum安装的速度</span>
yum makecache fast
<span class="token comment">#安装docker</span>
yum <span class="token function">install</span> docker-ce docker-ce-cli containerd.io <span class="token parameter variable">-y</span>
<span class="token comment">#启动docker</span>
systemctl start <span class="token function">docker</span>
<span class="token comment">#开机自启动</span>
systemctl <span class="token builtin class-name">enable</span> <span class="token function">docker</span>
</code></pre>
    <h3>
     <a id="containerd_111">
     </a>
     二、安装containerd
    </h3>
    <pre><code class="prism language-bash">yum <span class="token function">install</span> containerd <span class="token parameter variable">-y</span>

<span class="token comment">#配置/etc/containerd/config.toml </span>
<span class="token comment">#如果你不打算使用跟踪功能，可以在 containerd 配置文件中禁用该插件。</span>

<span class="token function">vim</span> /etc/containerd/config.toml
<span class="token comment">#disabled_plugins = ["cri"]</span>
<span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">]</span>
disable <span class="token operator">=</span> <span class="token boolean">false</span>

<span class="token comment">#配置完成后，重启 containerd：</span>
systemctl restart containerd
<span class="token comment">#如果你需要启用 tracing，可以配置跟踪端点。在 containerd 的配置文件中，提供正确的 tracing 端点配置：</span>
<span class="token comment">#[plugins."io.containerd.tracing.processor.v1.otlp"]</span>
<span class="token comment">#  endpoint = "your-tracing-endpoint:port"</span>
<span class="token comment">#根据你所使用的 tracing 服务（如 OpenTelemetry Collector）来提供适当的端点信息。</span>
<span class="token comment">#配置完成后，重启 containerd：</span>
<span class="token comment">#systemctl restart containerd</span>
</code></pre>
    <h3>
     <a id="Masterkubeadm_134">
     </a>
     三、Master节点安装kubeadm
    </h3>
    <h4>
     <a id="1kubelet_kubeadmkubectl_136">
     </a>
     1、安装kubelet 和kubeadm以及kubectl
    </h4>
    <pre><code class="prism language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> kubelet kubeadm kubectl <span class="token parameter variable">--disableexcludes</span><span class="token operator">=</span>kubernetes
systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> kubelet
</code></pre>
    <h4>
     <a id="2_143">
     </a>
     2、下载所需要的镜像
    </h4>
    <pre><code class="prism language-bash"><span class="token comment">#查看需要下载的镜像</span>
kubeadm config images list
<span class="token comment">#查看结果</span>
I0306 <span class="token number">11</span>:27:12.886721   <span class="token number">21939</span> version.go:256<span class="token punctuation">]</span> remote version is much newer: v1.32.2<span class="token punctuation">;</span> falling back to: stable-1.28
registry.k8s.io/kube-apiserver:v1.28.15
registry.k8s.io/kube-controller-manager:v1.28.15
registry.k8s.io/kube-scheduler:v1.28.15
registry.k8s.io/kube-proxy:v1.28.15
registry.k8s.io/pause:3.9
registry.k8s.io/etcd:3.5.9-0
registry.k8s.io/coredns/coredns:v1.10.1
<span class="token comment">#下载镜像（注意：namespace是k8s.io）</span>
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.9-0
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.10.1
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6
<span class="token comment">#重新打标签</span>
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.28.15 registry.k8s.io/kube-apiserver:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.28.15 registry.k8s.io/kube-controller-manager:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.28.15 registry.k8s.io/kube-scheduler:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.28.15 registry.k8s.io/kube-proxy:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9 registry.k8s.io/pause:3.9
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6 registry.k8s.io/pause:3.6
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.9-0 registry.k8s.io/etcd:3.5.9-0
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.10.1 registry.k8s.io/coredns/coredns:v1.10.1
<span class="token comment">#删除aliyun镜像</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">item</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span>ctr <span class="token parameter variable">-n</span> k8s.io images list <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'$1 ~ /registry.cn-hangzhou.aliyuncs.com/ {print $1}'</span><span class="token variable">`</span></span><span class="token punctuation">;</span><span class="token keyword">do</span> ctr <span class="token parameter variable">-n</span> k8s.io images <span class="token function">rm</span> <span class="token variable">${item}</span><span class="token punctuation">;</span><span class="token keyword">done</span>
</code></pre>
    <h4>
     <a id="3kubelet_179">
     </a>
     3、更改kubelet参数
    </h4>
    <pre><code class="prism language-bash"><span class="token function">vim</span> /etc/sysconfig/kubelet

<span class="token comment">#改为如下参数</span>
<span class="token assign-left variable">KUBELET_EXTRA_ARGS</span><span class="token operator">=</span>--cgroup-driver<span class="token operator">=</span>systemd
</code></pre>
    <h4>
     <a id="4kubeadm_188">
     </a>
     4、kubeadm初始化
    </h4>
    <pre><code class="prism language-bash">kubeadm init
<span class="token comment">#出现Your Kubernetes control-plane has initialized successfully!说明初始化成功</span>
<span class="token comment">#根据提示执行如下命令</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> <span class="token environment constant">$HOME</span>/.kube
<span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-i</span> /etc/kubernetes/admin.conf <span class="token environment constant">$HOME</span>/.kube/config
<span class="token function">sudo</span> <span class="token function">chown</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-u</span><span class="token variable">)</span></span><span class="token builtin class-name">:</span><span class="token variable"><span class="token variable">$(</span><span class="token function">id</span> <span class="token parameter variable">-g</span><span class="token variable">)</span></span> <span class="token environment constant">$HOME</span>/.kube/config
</code></pre>
    <h3>
     <a id="Nodekubeadm_199">
     </a>
     四、Node节点安装kubeadm
    </h3>
    <h4>
     <a id="1kubeadm_kubelet_201">
     </a>
     1、安装kubeadm kubelet
    </h4>
    <pre><code class="prism language-bash">yum <span class="token parameter variable">-y</span> <span class="token function">install</span> kubeadm kubelet
systemctl <span class="token builtin class-name">enable</span> kubelet.service
</code></pre>
    <h4>
     <a id="2_208">
     </a>
     2、下载所需要的镜像
    </h4>
    <pre><code class="prism language-bash"><span class="token comment">#查看需要下载的镜像</span>
kubeadm config images list
<span class="token comment">#查看结果</span>
I0306 <span class="token number">11</span>:27:12.886721   <span class="token number">21939</span> version.go:256<span class="token punctuation">]</span> remote version is much newer: v1.32.2<span class="token punctuation">;</span> falling back to: stable-1.28
registry.k8s.io/kube-apiserver:v1.28.15
registry.k8s.io/kube-controller-manager:v1.28.15
registry.k8s.io/kube-scheduler:v1.28.15
registry.k8s.io/kube-proxy:v1.28.15
registry.k8s.io/pause:3.9
registry.k8s.io/etcd:3.5.9-0
registry.k8s.io/coredns/coredns:v1.10.1
<span class="token comment">#下载镜像（注意：namespace是k8s.io）</span>
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.9-0
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.10.1
ctr <span class="token parameter variable">-n</span> k8s.io images pull registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6
<span class="token comment">#重新打标签</span>
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-apiserver:v1.28.15 registry.k8s.io/kube-apiserver:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-controller-manager:v1.28.15 registry.k8s.io/kube-controller-manager:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-scheduler:v1.28.15 registry.k8s.io/kube-scheduler:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/kube-proxy:v1.28.15 registry.k8s.io/kube-proxy:v1.28.15
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.9 registry.k8s.io/pause:3.9
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6 registry.k8s.io/pause:3.6
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/etcd:3.5.9-0 registry.k8s.io/etcd:3.5.9-0
ctr <span class="token parameter variable">-n</span> k8s.io images tag registry.cn-hangzhou.aliyuncs.com/google_containers/coredns:v1.10.1 registry.k8s.io/coredns/coredns:v1.10.1
<span class="token comment">#删除aliyun镜像</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">item</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span>ctr <span class="token parameter variable">-n</span> k8s.io images list <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'$1 ~ /registry.cn-hangzhou.aliyuncs.com/ {print $1}'</span><span class="token variable">`</span></span><span class="token punctuation">;</span><span class="token keyword">do</span> ctr <span class="token parameter variable">-n</span> k8s.io images <span class="token function">rm</span> <span class="token variable">${item}</span><span class="token punctuation">;</span><span class="token keyword">done</span>
</code></pre>
    <h4>
     <a id="3kubelet_244">
     </a>
     3、更改kubelet参数
    </h4>
    <pre><code class="prism language-bash"><span class="token function">vim</span> /etc/sysconfig/kubelet

<span class="token comment">#改为如下参数</span>
<span class="token assign-left variable">KUBELET_EXTRA_ARGS</span><span class="token operator">=</span>--cgroup-driver<span class="token operator">=</span>systemd
</code></pre>
    <h4>
     <a id="4Master_253">
     </a>
     4、加入Master
    </h4>
    <pre><code class="prism language-bash"><span class="token comment">#token来自master节点执行kubeinit的结果</span>
kubeadm <span class="token function">join</span> <span class="token number">192.168</span>.1.131:6443 <span class="token parameter variable">--token</span> 51lpgy.tue7o5rnwi3h62ql <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> --discovery-token-ca-cert-hash sha256:200ad4e8f13649b3cd14db97cdaf842d97f4dbbca0cbec123c06b2a3c687ede1
</code></pre>
    <h3>
     <a id="_261">
     </a>
     五、安装网络插件
    </h3>
    <h4>
     <a id="1Mastercalicoyml_263">
     </a>
     1、在Master节点拉取并修改calico.yml文件
    </h4>
    <pre><code class="prism language-bash"><span class="token comment">#下载calico的yaml文件（Master节点操作）</span>
yum <span class="token function">install</span> <span class="token function">wget</span> <span class="token parameter variable">-y</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-pv</span> /data/yaml <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> /data/yaml
<span class="token function">wget</span> https://docs.tigera.io/archive/v3.25/manifests/calico.yaml
<span class="token comment">#修改calico的yaml文件</span>
- name: CALICO_IPV4POOL_CIDR
  value: <span class="token string">"10.244.0.0/16"</span>
<span class="token comment">#在CLUSTER_TYPE那行，下面添加（interface根据自己的主机网卡名修改）</span>
- name: IP_AUTODETECTION_METHOD
  value: <span class="token string">"interface=ens192"</span>
</code></pre>
    <h4>
     <a id="2MasterNode_278">
     </a>
     2、下载所需要的镜像（Master和Node都要操作）
    </h4>
    <pre><code class="prism language-bash"><span class="token function">mkdir</span> <span class="token parameter variable">-pv</span> /data/tar <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">cd</span> /data/tar
<span class="token comment">#需要先用docker下载，用ctr测试下载不下来</span>
<span class="token function">docker</span> pull calico/cni:v3.25.0
<span class="token function">docker</span> pull calico/node:v3.25.0
<span class="token function">docker</span> pull calico/kube-controllers:v3.25.0
<span class="token comment">#导出docker镜像</span>
<span class="token function">docker</span> save <span class="token parameter variable">-o</span> cni.tar calico/cni:v3.25.0
<span class="token function">docker</span> save <span class="token parameter variable">-o</span> node.tar calico/node:v3.25.0
<span class="token function">docker</span> save <span class="token parameter variable">-o</span> kube-controllers.tar calico/kube-controllers:v3.25.0
<span class="token comment">#用ctr导入镜像（namespace是k8s.io）（前面两步可以在一台服务器上操作，最后这步都要操作）</span>
ctr <span class="token parameter variable">-n</span> k8s.io images <span class="token function">import</span> cni.tar
ctr <span class="token parameter variable">-n</span> k8s.io images <span class="token function">import</span> node.tar
ctr <span class="token parameter variable">-n</span> k8s.io images <span class="token function">import</span> kube-controllers.tar
<span class="token comment">#验证是否导入成功</span>
ctr <span class="token parameter variable">-n</span> k8s.io images list<span class="token operator">|</span><span class="token function">grep</span> calico
</code></pre>
    <h4>
     <a id="3calico_298">
     </a>
     3、安装calico插件
    </h4>
    <pre><code class="prism language-bash"><span class="token comment">#只在Master节点操作即可</span>
<span class="token builtin class-name">cd</span> /data/yaml
kubectl apply <span class="token parameter variable">-f</span> calico.yaml
</code></pre>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@vm131 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -A</span>
NAMESPACE     NAME                                       READY   STATUS    RESTARTS       AGE
kube-system   calico-kube-controllers-658d97c59c-fc46q   <span class="token number">1</span>/1     Running   <span class="token number">0</span>              46m
kube-system   calico-node-4cc9q                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>              46m
kube-system   calico-node-l6ch2                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>              46m
kube-system   calico-node-r27jj                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>              46m
kube-system   coredns-5dd5756b68-84cww                   <span class="token number">0</span>/1     Running   <span class="token number">0</span>              4h
kube-system   coredns-5dd5756b68-nd9v8                   <span class="token number">0</span>/1     Running   <span class="token number">0</span>              4h
kube-system   etcd-vm131                                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h1m
kube-system   kube-apiserver-vm131                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h1m
kube-system   kube-controller-manager-vm131              <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>3h9m ago<span class="token punctuation">)</span>   4h1m
kube-system   kube-proxy-26qwm                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>              3h44m
kube-system   kube-proxy-bj5xg                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h
kube-system   kube-proxy-wgfnz                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>              3h43m
kube-system   kube-scheduler-vm131                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>              4h1m

<span class="token comment">#出现上面情况可以尝试，重启coreDNS</span>
<span class="token comment">#plugin/kubernetes: Kubernetes API connection failure: Get "https://10.96.0.1:443/version": dial tcp 10.96.0.1:443: i/o timeout</span>
kubectl rollout restart deployment coredns <span class="token parameter variable">-n</span> kube-system
</code></pre>
    <h3>
     <a id="_328">
     </a>
     六、验证
    </h3>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@vm131 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get pods -A</span>
NAMESPACE     NAME                                       READY   STATUS    RESTARTS        AGE
kube-system   calico-kube-controllers-658d97c59c-t678p   <span class="token number">1</span>/1     Running   <span class="token number">0</span>               5m26s
kube-system   calico-node-5zj2n                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>               5m26s
kube-system   calico-node-hjdcm                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>               5m26s
kube-system   calico-node-hrwh4                          <span class="token number">1</span>/1     Running   <span class="token number">0</span>               5m26s
kube-system   coredns-967d5bb69-sb9xx                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>               31m
kube-system   coredns-967d5bb69-sngxg                    <span class="token number">1</span>/1     Running   <span class="token number">0</span>               31m
kube-system   etcd-vm131                                 <span class="token number">1</span>/1     Running   <span class="token number">0</span>               4h34m
kube-system   kube-apiserver-vm131                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>               4h34m
kube-system   kube-controller-manager-vm131              <span class="token number">1</span>/1     Running   <span class="token number">1</span> <span class="token punctuation">(</span>3h43m ago<span class="token punctuation">)</span>   4h34m
kube-system   kube-proxy-26qwm                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>               4h17m
kube-system   kube-proxy-bj5xg                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>               4h34m
kube-system   kube-proxy-wgfnz                           <span class="token number">1</span>/1     Running   <span class="token number">0</span>               4h16m
kube-system   kube-scheduler-vm131                       <span class="token number">1</span>/1     Running   <span class="token number">0</span>               4h34m
<span class="token punctuation">[</span>root@vm131 ~<span class="token punctuation">]</span><span class="token comment"># kubectl get node</span>
NAME    STATUS   ROLES           AGE     VERSION
vm131   Ready    control-plane   4h34m   v1.28.2
vm132   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          4h16m   v1.28.2
vm133   Ready    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          4h17m   v1.28.2
</code></pre>
    <h3>
     <a id="_353">
     </a>
     七、问题记录
    </h3>
    <pre><code class="prism language-bash">crictl images 报错：
WARN<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> image connect using default endpoints: <span class="token punctuation">[</span>unix:///var/run/dockershim.sock unix:///run/containerd/containerd.sock unix:///run/crio/crio.sock unix:///var/run/cri-dockerd.sock<span class="token punctuation">]</span>. As the default settings are now deprecated, you should <span class="token builtin class-name">set</span> the endpoint instead. 
E0305 <span class="token number">16</span>:42:46.922252   <span class="token number">22812</span> remote_image.go:119<span class="token punctuation">]</span> <span class="token string">"ListImages with filter from image service failed"</span> <span class="token assign-left variable">err</span><span class="token operator">=</span><span class="token string">"rpc error: code = Unavailable desc = connection error: desc = <span class="token entity" title='\"'>\"</span>transport: Error while dialing dial unix /var/run/dockershim.sock: connect: no such file or directory<span class="token entity" title='\"'>\"</span>"</span> <span class="token assign-left variable">filter</span><span class="token operator">=</span><span class="token string">"&amp;ImageFilter{Image:&amp;ImageSpec{Image:,Annotations:map[string]string{},},}"</span>
FATA<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> listing images: rpc error: code <span class="token operator">=</span> Unavailable desc <span class="token operator">=</span> connection error: desc <span class="token operator">=</span> <span class="token string">"transport: Error while dialing dial unix /var/run/dockershim.sock: connect: no such file or directory"</span>
解决：
<span class="token builtin class-name">export</span> <span class="token assign-left variable">CONTAINER_RUNTIME_ENDPOINT</span><span class="token operator">=</span>unix:///run/containerd/containerd.sock
<span class="token builtin class-name">export</span> <span class="token assign-left variable">IMAGE_SERVICE_ENDPOINT</span><span class="token operator">=</span>unix:///run/containerd/containerd.sock
配置 crictl 默认连接 containerd
编辑 crictl 配置文件：
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /etc/crictl
<span class="token builtin class-name">echo</span> <span class="token string">'runtime-endpoint: unix:///run/containerd/containerd.sock'</span> <span class="token operator">&gt;</span> /etc/crictl.yaml

<span class="token function">vim</span> /etc/containerd/config.toml
<span class="token comment">#disabled_plugins = ["cri"]</span>
<span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">]</span>
disable <span class="token operator">=</span> <span class="token boolean">false</span>

禁用跟踪插件： 如果你不打算使用跟踪功能，可以在 containerd 配置文件中禁用该插件。在 /etc/containerd/config.toml 文件中，查找并禁用跟踪插件：
<span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.tracing.processor.v1.otlp"</span><span class="token punctuation">]</span>
  enabled <span class="token operator">=</span> <span class="token boolean">false</span>
然后重启 containerd：
<span class="token function">sudo</span> systemctl restart containerd
配置 tracing endpoint： 如果你需要启用 tracing，可以配置跟踪端点。在 containerd 的配置文件中，提供正确的 tracing 端点配置：

<span class="token punctuation">[</span>plugins.<span class="token string">"io.containerd.tracing.processor.v1.otlp"</span><span class="token punctuation">]</span>
  endpoint <span class="token operator">=</span> <span class="token string">"your-tracing-endpoint:port"</span>
根据你所使用的 tracing 服务（如 OpenTelemetry Collector）来提供适当的端点信息。

配置完成后，重启 containerd：
<span class="token function">sudo</span> systemctl restart containerd
总结：
如果不使用跟踪功能，可以简单地忽略这个信息或禁用该插件。
如果需要启用跟踪功能，确保配置了正确的 tracing endpoint
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34333531303131312f:61727469636c652f64657461696c732f313436303737383238" class_="artid" style="display:none">
 </p>
</div>


