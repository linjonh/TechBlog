---
layout: post
title: "MQ-消息发送可靠性保证-整合-Spring-Retry-重试框架-补偿发送方案"
date: 2025-03-08 13:02:42 +0800
description: "RocketMQ Starter 本身提供重试机制较为简单，无法指定较复杂的重试策略Spring Retry 是一个用于为应用程序提供自动重试功能的框架，特别适用于执行可能会因暂时性问题失败的操作（如网络请求、数据库操作、消息队列操作等）。通过配置，Spring Retry 能够在失败时自动重试指定次数，且每次重试可以配置不同的延迟和间隔。"
keywords: "MQ 消息发送可靠性保证 —— 整合 Spring Retry 重试框架 + 补偿发送方案"
categories: ['项目实战技巧']
tags: ['Spring', 'Spring', 'Rocketmq', 'Rocketmq', 'Java', 'Boot']
artid: "146114686"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146114686
    alt: "MQ-消息发送可靠性保证-整合-Spring-Retry-重试框架-补偿发送方案"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146114686
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146114686
cover: https://bing.ee123.net/img/rand?artid=146114686
image: https://bing.ee123.net/img/rand?artid=146114686
img: https://bing.ee123.net/img/rand?artid=146114686
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     MQ 消息发送可靠性保证 —— 整合 Spring Retry 重试框架 + 补偿发送方案
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="MQ____Spring_Retry____0">
     </a>
     MQ 消息发送可靠性保证 —— 整合 Spring Retry 重试框架 + 补偿发送方案
    </h2>
    <p>
     RocketMQ Starter 本身提供重试机制较为简单，无法指定较复杂的重试策略
    </p>
    <p>
     复杂的重试策略 RocketMQ 无法直接配置：
    </p>
    <ol>
     <li>
      <strong>
       间隔和延迟策略：
      </strong>
      RocketMQ 本身的重试机制没有内建对重试间隔和延迟时间的高级控制。例如，你不能简单地配置每次重试的延迟时间和间隔时间，或者实现指数级回退的策略。所有的重试都是在一个固定的时间内进行的，缺少对每次重试间隔的控制。
     </li>
     <li>
      <strong>
       定制化重试规则：
      </strong>
      如果你想要一个更复杂的重试规则（如重试间隔时间逐步增加、使用不同的间隔策略等），RocketMQ 的默认重试机制就比较难以满足。这种情况下，你需要自定义重试逻辑，比如使用 Spring Retry 来实现更复杂的策略。
     </li>
    </ol>
    <p>
     Spring Retry 是一个用于为应用程序提供自动重试功能的框架，特别适用于执行可能会因暂时性问题失败的操作（如网络请求、数据库操作、消息队列操作等）。通过配置，Spring Retry 能够在失败时自动重试指定次数，且每次重试可以配置不同的延迟和间隔。
    </p>
    <h3>
     <a id="_Spring_Retry_11">
     </a>
     为什么使用 Spring Retry：
    </h3>
    <p>
     Spring Retry 的优势在于它能够提供比 RocketMQ 更细粒度的控制。你可以使用 Spring Retry 来设置如下复杂的策略：
    </p>
    <ul>
     <li>
      <strong>
       自定义重试次数：
      </strong>
      你可以灵活设置最大重试次数。
     </li>
     <li>
      <strong>
       延迟策略：
      </strong>
      可以配置不同的延迟时间，支持指数回退、固定间隔、随机延迟等。
     </li>
     <li>
      <strong>
       重试间隔的乘法：
      </strong>
      支持每次重试间隔成倍增加的策略（如 2x、3x 等）。
     </li>
     <li>
      <strong>
       失败回调：
      </strong>
      可以定义失败后执行的回调，如写入数据库等操作。
     </li>
    </ul>
    <p>
     因此，RocketMQ 的内建重试机制在某些特定场景下，尤其是需要复杂间隔、延迟或其他高级控制时，可能不如 Spring Retry 这么灵活。在这种情况下，结合 Spring Retry 进行二次封装，能够提供更强大、更灵活的重试控制。
    </p>
    <h3>
     <a id="1_22">
     </a>
     1.添加依赖
    </h3>
    <pre><code class="prism language-xml">     <span class="token comment">&lt;!-- Spring Retry 重试框架  --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.retry<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-retry<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        
        <span class="token comment">&lt;!-- AOP 切面（Spring Retry 重试框架需要） --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-aop<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h3>
     <a id="2retry_38">
     </a>
     2.启用retry
    </h3>
    <p>
     启动类上加上@EnableRetry
    </p>
    <h3>
     <a id="3_44">
     </a>
     3.重试配置
    </h3>
    <h4>
     <a id="Retryyaml_46">
     </a>
     Retry-yaml
    </h4>
    <pre><code class="prism language-yaml"><span class="token key atrule">retry</span><span class="token punctuation">:</span>
  <span class="token key atrule">max-attempts</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 最大重试次数</span>
  <span class="token key atrule">init-interval</span><span class="token punctuation">:</span> <span class="token number">1000</span> <span class="token comment"># 初始延迟时间，单位 ms</span>
  <span class="token key atrule">multiplier</span><span class="token punctuation">:</span> <span class="token number">2</span> <span class="token comment"># 每次重试间隔加倍（每次乘以 2）</span>
</code></pre>
    <h4>
     <a id="RetryProperties_55">
     </a>
     RetryProperties
    </h4>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token class-name">RetryProperties</span><span class="token punctuation">.</span><span class="token constant">PREFIX</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RetryProperties</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">PREFIX</span> <span class="token operator">=</span> <span class="token string">"retry"</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 最大重试次数
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> maxAttempts <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 初始间隔时间，单位 ms
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> initInterval <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 乘积（每次乘以 2）
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Double</span> multiplier <span class="token operator">=</span> <span class="token number">2.0</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="RetryTemplate_83">
     </a>
     RetryTemplate
    </h4>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RetryConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RetryProperties</span> retryProperties<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RetryTemplate</span> <span class="token function">retryTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RetryTemplate</span> retryTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RetryTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 定义重试策略（最多重试 3 次）</span>
        <span class="token class-name">SimpleRetryPolicy</span> retryPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleRetryPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        retryPolicy<span class="token punctuation">.</span><span class="token function">setMaxAttempts</span><span class="token punctuation">(</span>retryProperties<span class="token punctuation">.</span><span class="token function">getMaxAttempts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最大重试次数</span>

        <span class="token comment">// 定义间隔策略</span>
        <span class="token class-name">ExponentialBackOffPolicy</span> backOffPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExponentialBackOffPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        backOffPolicy<span class="token punctuation">.</span><span class="token function">setInitialInterval</span><span class="token punctuation">(</span>retryProperties<span class="token punctuation">.</span><span class="token function">getInitInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始间隔 2000ms</span>
        backOffPolicy<span class="token punctuation">.</span><span class="token function">setMultiplier</span><span class="token punctuation">(</span>retryProperties<span class="token punctuation">.</span><span class="token function">getMultiplier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 每次乘以 2</span>

        retryTemplate<span class="token punctuation">.</span><span class="token function">setRetryPolicy</span><span class="token punctuation">(</span>retryPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        retryTemplate<span class="token punctuation">.</span><span class="token function">setBackOffPolicy</span><span class="token punctuation">(</span>backOffPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> retryTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="4_115">
     </a>
     4.配置线程池
    </h3>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"taskExecutor"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">taskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ThreadPoolTaskExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 核心线程数</span>
        executor<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 最大线程数</span>
        executor<span class="token punctuation">.</span><span class="token function">setMaxPoolSize</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 队列容量</span>
        executor<span class="token punctuation">.</span><span class="token function">setQueueCapacity</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 线程活跃时间（秒）</span>
        executor<span class="token punctuation">.</span><span class="token function">setKeepAliveSeconds</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 线程名前缀</span>
        executor<span class="token punctuation">.</span><span class="token function">setThreadNamePrefix</span><span class="token punctuation">(</span><span class="token string">"NoteExecutor-"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 拒绝策略：由调用线程处理（一般为主线程）</span>
        executor<span class="token punctuation">.</span><span class="token function">setRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 等待所有任务结束后再关闭线程池</span>
        executor<span class="token punctuation">.</span><span class="token function">setWaitForTasksToCompleteOnShutdown</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置等待时间，如果超过这个时间还没有销毁就强制销毁，以确保应用最后能够被关闭，而不是被没有完成的任务阻塞</span>
        executor<span class="token punctuation">.</span><span class="token function">setAwaitTerminationSeconds</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        executor<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> executor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="5mq_151">
     </a>
     5.配置mq异步发送工具类
    </h3>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SendMqRetryHelper</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RocketMQTemplate</span> rocketMQTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">RetryTemplate</span> retryTemplate<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Resource</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"taskExecutor"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">ThreadPoolTaskExecutor</span> threadPoolTaskExecutor<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 异步发送 MQ
     * @param topic
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">asyncSend</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">String</span> body<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"==&gt; 开始异步发送 MQ, Topic: {}, Body: {}"</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 构建消息对象，并将 DTO 转成 Json 字符串设置到消息体中</span>
        <span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> message <span class="token operator">=</span> <span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 异步发送 MQ 消息，提升接口响应速度</span>
        rocketMQTemplate<span class="token punctuation">.</span><span class="token function">asyncSend</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SendCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">SendResult</span> sendResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"==&gt; 【评论发布】MQ 发送成功，SendResult: {}"</span><span class="token punctuation">,</span> sendResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"==&gt; 【评论发布】MQ 发送异常: "</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">handleRetry</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 重试处理
     * @param topic
     * @param message
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleRetry</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Message</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 异步处理</span>
        threadPoolTaskExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 通过 retryTemplate 执行重试</span>
                retryTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RetryCallback</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">,</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> context <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"==&gt; 开始重试 MQ 发送, 当前重试次数: {}, 时间: {}"</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span><span class="token function">getRetryCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 同步发送 MQ</span>
                    rocketMQTemplate<span class="token punctuation">.</span><span class="token function">syncSend</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 多次重试失败，进入兜底方案</span>
                <span class="token function">fallback</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> message<span class="token punctuation">.</span><span class="token function">getPayload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 兜底方案: 将发送失败的 MQ 写入数据库，之后，通过定时任务扫表，将发送失败的 MQ 再次发送，最终发送成功后，将该记录物理删除
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">fallback</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">,</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">String</span> bodyJson<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"==&gt; 多次发送失败, 进入兜底方案, Topic: {}, bodyJson: {}"</span><span class="token punctuation">,</span> topic<span class="token punctuation">,</span> bodyJson<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// TODO:</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     首先，RocketMQ 会异步发送消息并进行重试（取决于你的配置）。
    </p>
    <p>
     如果 RocketMQ 异步发送失败并且重试 3 次后依然失败，
     <code>
      onException
     </code>
     方法被调用。
    </p>
    <p>
     在
     <code>
      onException
     </code>
     中，
     <code>
      handleRetry
     </code>
     方法会被触发，该方法会调用
     <code>
      retryTemplate.execute(...)
     </code>
     来进行同步重试（取决于你的配置）。
    </p>
    <p>
     如果所有重试失败，则会调用
     <code>
      fallback
     </code>
     方法进行兜底处理。
    </p>
    <p>
     通常的话,这里mq的重试就配置成0了因为我们已经自己封装了重试机制
    </p>
    <h3>
     <a id="6_237">
     </a>
     6.服务层使用
    </h3>
    <pre><code class="prism language-java"><span class="token comment">// 发送 MQ (包含重试机制)</span>
        sendMqRetryHelper<span class="token punctuation">.</span><span class="token function">asyncSend</span><span class="token punctuation">(</span><span class="token class-name">MQConstants</span><span class="token punctuation">.</span><span class="token constant">TOPIC</span><span class="token punctuation">,</span> <span class="token class-name">JsonUtils</span><span class="token punctuation">.</span><span class="token function">toJsonString</span><span class="token punctuation">(</span><span class="token class-name">MqDTO</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f736a736a7362627362736e2f:61727469636c652f64657461696c732f313436313134363836" class_="artid" style="display:none">
 </p>
</div>


