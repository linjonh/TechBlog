---
layout: post
title: "SegRNN-源码理解图示理解-forward的过程"
date: 2025-03-05 17:57:03 +0800
description: "这种设计使SegRNN能高效处理长序列预测问题，特别是在多变量时间序列中，不同特征具有不同时间模式的情况。"
keywords: "【SegRNN 源码理解】图示理解 forward的过程"
categories: ['扒代码']
tags: ['机器学习']
artid: "146049312"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146049312
    alt: "SegRNN-源码理解图示理解-forward的过程"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146049312
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146049312
cover: https://bing.ee123.net/img/rand?artid=146049312
image: https://bing.ee123.net/img/rand?artid=146049312
img: https://bing.ee123.net/img/rand?artid=146049312
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【SegRNN 源码理解】图示理解 forward的过程
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
    </p>
    <pre><code class="hljs">输入: x [16, 60, 7]
(16个批次，每个60个时间步，每步7个特征)
            │
            ▼
┌──────────────────────────────┐
│      RevIN 标准化 + 维度置换     │
│   x = revinLayer(x, 'norm')   │
│      .permute(0, 2, 1)       │
└──────────────┬───────────────┘
               │
               ▼
          x [16, 7, 60]
(16个批次，7个特征，每个特征60个时间步)
            │
            ▼
┌──────────────────────────────┐
│         重塑为分段格式          │
│ x.reshape(-1, seg_num_x, seg_len) │
└──────────────┬───────────────┘
               │
               ▼
          x [112, 5, 12]
(112个序列=16批次×7特征，每个分5段，每段12步)
            │
            ▼
┌──────────────────────────────┐
│          段值嵌入             │
│     x = valueEmbedding(x)     │
│  (Linear: 12 → 512 + ReLU)    │
└──────────────┬───────────────┘
               │
               ▼
          x [112, 5, 512]
(112个序列，5个段，每段表示为512维向量)
            │
            ▼
┌──────────────────────────────┐
│           GRU 编码            │
│      _, hn = self.rnn(x)      │
└──────────────┬───────────────┘
               │
               ▼
          hn [1, 112, 512]
(1层GRU，112个序列的最终隐藏状态)
            │
            ▼
┌────────────────┬─────────────┐
│    RMF 解码     │    PMF 解码   │
└────────┬───────┴──────┬──────┘
         │              │
┌────────▼───────┐  ┌───▼──────────┐
│  循环多步预测    │  │  并行多步预测   │
│(逐段自回归预测)  │  │(一次性预测所有段)│
└────────┬───────┘  └───┬──────────┘
         │              │
         │       ┌──────▼─────────┐
         │       │  位置和通道嵌入   │
         │       │   组合成条件     │
         │       └──────┬─────────┘
         │              │
         │       ┌──────▼─────────┐
         │       │ pos_emb [224, 1, 512] │
         │       │ (224=16×7×2)   │
         │       └──────┬─────────┘
         │              │
         │       ┌──────▼─────────┐
         │       │   条件GRU解码    │
         │       │ _, hy = rnn(pos_emb, hn) │
         │       └──────┬─────────┘
         │              │
         │       ┌──────▼─────────┐
         │       │ hy [1, 224, 512] │
         │       └──────┬─────────┘
         │              │
┌────────▼───────┐ ┌────▼──────────┐
│ 预测 + 堆叠各段  │ │     预测       │
└────────┬───────┘ │ y = predict(hy) │
         │         └────┬───────────┘
         │              │
         └──────┬───────┘
                │
                ▼
           y [16, 7, 24]
 (预测结果: 16个批次，7个特征，预测24个时间步)
                │
                ▼
┌───────────────────────────────┐
│      维度置换 + RevIN反标准化    │
│   y = revinLayer(y.permute(0, 2, 1), 'denorm')   │
└───────────────┬───────────────┘
                │
                ▼
       最终输出 y [16, 24, 7]
(16个批次，预测未来24个时间步，每步7个特征)</code></pre>
    <h3>
     SegRNN 前向传播的关键处理阶段解释
    </h3>
    <h4>
     1. 数据预处理和视角转换
    </h4>
    <ul>
     <li>
      <strong>
       输入形状
      </strong>
      ：
      <code>
       [16, 60, 7]
      </code>
      (批次, 时间步, 特征)
     </li>
     <li>
      <strong>
       RevIN标准化
      </strong>
      ：对每个特征序列进行可逆实例标准化，消除分布偏移
     </li>
     <li>
      <strong>
       维度置换
      </strong>
      ：将视角从"时间优先"转为"特征优先" →
      <code>
       [16, 7, 60]
      </code>
     </li>
     <li>
      <strong>
       作用
      </strong>
      ：为每个特征序列建立独立处理路径
     </li>
    </ul>
    <h4>
     2. 序列分段和嵌入
    </h4>
    <ul>
     <li>
      <strong>
       重塑和分段
      </strong>
      ：
      <code>
       [16, 7, 60]
      </code>
      →
      <code>
       [112, 5, 12]
      </code>
      <ul>
       <li>
        112 = 16(批次) × 7(特征)
       </li>
       <li>
        每个序列分为5段，每段12个时间步
       </li>
      </ul>
     </li>
     <li>
      <strong>
       线性嵌入
      </strong>
      ：将每个12维的段映射到512维空间
     </li>
     <li>
      <strong>
       作用
      </strong>
      ：引入层次化表示，捕获不同时间尺度的模式
     </li>
    </ul>
    <h4>
     3. GRU序列编码
    </h4>
    <ul>
     <li>
      <strong>
       序列编码
      </strong>
      ：GRU处理5个段之间的时间依赖关系
     </li>
     <li>
      <strong>
       输出隐藏状态
      </strong>
      ：
      <code>
       hn [1, 112, 512]
      </code>
     </li>
     <li>
      <strong>
       作用
      </strong>
      ：将历史信息压缩到一个固定长度向量
     </li>
    </ul>
    <h4>
     4. 解码阶段（PMF模式）
    </h4>
    <ul>
     <li>
      <strong>
       位置和通道嵌入组合
      </strong>
      ：
      <ul>
       <li>
        位置嵌入：
        <code>
         [2, 256]
        </code>
        → 预测的2个段
       </li>
       <li>
        通道嵌入：
        <code>
         [7, 256]
        </code>
        → 7个不同特征
       </li>
       <li>
        组合后：
        <code>
         [224, 1, 512]
        </code>
        (224 = 16×7×2)
       </li>
      </ul>
     </li>
     <li>
      <strong>
       条件GRU解码
      </strong>
      ：
      <ul>
       <li>
        输入：位置嵌入序列
       </li>
       <li>
        条件：复制并重塑的编码器隐藏状态
       </li>
       <li>
        输出：
        <code>
         hy [1, 224, 512]
        </code>
       </li>
      </ul>
     </li>
     <li>
      <strong>
       预测
      </strong>
      ：线性层
      <code>
       [224, 512]
      </code>
      →
      <code>
       [224, 12]
      </code>
      → 重塑为
      <code>
       [16, 7, 24]
      </code>
     </li>
     <li>
      <strong>
       作用
      </strong>
      ：基于历史信息和位置/通道条件，一次生成所有预测段
     </li>
    </ul>
    <h4>
     5. 输出处理
    </h4>
    <ul>
     <li>
      <strong>
       维度置换
      </strong>
      ：
      <code>
       [16, 7, 24]
      </code>
      →
      <code>
       [16, 24, 7]
      </code>
     </li>
     <li>
      <strong>
       RevIN反标准化
      </strong>
      ：将标准化的数据转换回原始分布
     </li>
     <li>
      <strong>
       最终输出
      </strong>
      ：
      <code>
       [16, 24, 7]
      </code>
      (16个批次，预测24个时间步，每步7个特征)
     </li>
    </ul>
    <h3>
     模型设计亮点
    </h3>
    <ol>
     <li>
      <strong>
       层次化架构
      </strong>
      ：通过分段+RNN的两级架构，有效处理不同时间尺度
     </li>
     <li>
      <strong>
       特征独立处理
      </strong>
      ：每个特征有独立的处理路径，减少干扰
     </li>
     <li>
      <strong>
       可逆标准化
      </strong>
      ：RevIN处理分布偏移，保留原始分布特性
     </li>
     <li>
      <strong>
       条件生成
      </strong>
      ：位置嵌入+通道嵌入提供细粒度控制的条件生成
     </li>
    </ol>
    <p>
     这种设计使SegRNN能高效处理长序列预测问题，特别是在多变量时间序列中，不同特征具有不同时间模式的情况。
    </p>
    <ul>
    </ul>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f37373534393937372f:61727469636c652f64657461696c732f313436303439333132" class_="artid" style="display:none">
 </p>
</div>


