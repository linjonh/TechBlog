---
layout: post
title: "详细解析-ListView_GetEditControl"
date: 2025-03-13 13:49:16 +0800
description: "书籍：《Visual C++ 2017从入门到精通》的2.3.8 Win32控件编程环境：visual studio 2022内容：【例2.28】支持主项可编辑的列表视图控件说明：以下内容大部分来自腾讯元宝。​。"
keywords: "详细解析 ListView_GetEditControl()"
categories: ['从入门到精通', 'Visual', 'C', '2017']
tags: ['列表视图', 'Win']
artid: "146228863"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146228863
    alt: "详细解析-ListView_GetEditControl"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146228863
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146228863
cover: https://bing.ee123.net/img/rand?artid=146228863
image: https://bing.ee123.net/img/rand?artid=146228863
img: https://bing.ee123.net/img/rand?artid=146228863
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     详细解析 ListView_GetEditControl()
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     书籍：《Visual C++ 2017从入门到精通》的2.3.8 Win32控件编程
    </p>
    <p>
     环境：visual studio 2022
    </p>
    <p>
     内容：【例2.28】支持主项可编辑的列表视图控件
    </p>
    <p>
     说明：以下内容大部分来自腾讯元宝。
    </p>
    <p>
    </p>
    <p>
     ​
     <strong>
      函数原型
     </strong>
    </p>
    <pre><code class="language-cpp">HWND ListView_GetEditControl(HWND hwndList);</code></pre>
    <h5>
     ​
     <strong>
      功能说明
     </strong>
    </h5>
    <ul>
     <li>
      ​
      <strong>
       作用
      </strong>
      ：获取当前处于编辑模式的列表视图项（
      <strong>
       主项
      </strong>
      ）的编辑控件句柄（
      <code>
       HWND
      </code>
      ）。
     </li>
     <li>
      ​
      <strong>
       适用场景
      </strong>
      ：
      <span style="color:#fe2c24">
       当用户点击列表项标签并进入编辑模式时，通过此函数操作编辑框（如读取或设置文本）。
      </span>
     </li>
     <li>
      ​
      <strong>
       返回值
      </strong>
      ：
      <ul>
       <li>
        成功：返回编辑控件的句柄。
       </li>
       <li>
        失败：返回
        <code>
         NULL
        </code>
        （例如未启用标签编辑、未进入编辑模式、控件无效等）。
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     ​
     <strong>
      核心机制
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       ​
       <strong>
        标签编辑触发
       </strong>
       ：
      </p>
      <ul>
       <li>
        用户点击列表项标签时，若列表视图控件启用了标签编辑（通过
        <span style="color:#fe2c24">
         样式
         <code>
          LVS_EDITLABELS
         </code>
         或
         <code>
          LVM_SETITEMCOUNT
         </code>
         启用
        </span>
        ），系统会
        <span style="color:#fe2c24">
         自动创建一个编辑框
        </span>
        （通常为
        <code>
         CEdit
        </code>
        类）。
       </li>
       <li>
        ​
        <strong>
         函数调用时机
        </strong>
        ：仅在
        <code>
         LVN_BEGINLABELEDIT
        </code>
        消息触发时有效。
       </li>
      </ul>
     </li>
     <li>
      <p>
       ​
       <strong>
        内部实现
       </strong>
       ：
      </p>
      <ul>
       <li>
        列表视图控件通过子窗口管理编辑框，
        <code>
         ListView_GetEditControl
        </code>
        内部通过遍历子窗口或直接关联控件句柄返回编辑框指针。
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h4>
     ​
     <strong>
      使用注意事项
     </strong>
    </h4>
    <h5>
     ​
     <strong>
      1. 启用标签编辑
     </strong>
    </h5>
    <ul>
     <li>
      ​
      <strong>
       必须设置样式
      </strong>
      ：在创建列表视图控件时，
      <span style="color:#fe2c24">
       需启用
       <code>
        LVS_EDITLABELS
       </code>
       样式
      </span>
      。
      <pre><code class="language-cpp">HWND hListView = CreateWindowEx(
    0, WC_LISTVIEW, _T("List View"),
    LVS_EDITLABELS | /* 其他样式 */, ... );</code></pre>
     </li>
     <li>
      ​
      <strong>
       动态启用
      </strong>
      ：可通过
      <code>
       ListView_SetStyle
      </code>
      动态启用。
      <pre><code class="language-cpp">ListView_SetStyle(hListView, LVS_EDITLABELS);</code></pre>
     </li>
    </ul>
    <h5>
     ​
     <strong>
      2. 调用时机限制
     </strong>
    </h5>
    <ul>
     <li>
      ​
      <strong>
       仅限
       <code>
        LVN_BEGINLABELEDIT
       </code>
       事件
      </strong>
      ：在用户开始编辑标签时调用，其他时刻可能返回无效句柄。
      <pre><code class="language-cpp">case LVN_BEGINLABELEDIT:
    hEdit = ListView_GetEditControl(hListView); // 正确时机
    break;</code></pre>
     </li>
    </ul>
    <h5>
     ​
     <strong>
      3. 检查句柄有效性
     </strong>
    </h5>
    <ul>
     <li>
      ​
      <strong>
       避免空指针操作
      </strong>
      ：调用后需检查
      <code>
       hEdit
      </code>
      是否为
      <code>
       NULL
      </code>
      。
      <pre><code class="language-cpp">hEdit = ListView_GetEditControl(hListView);
if (!hEdit) {
    // 处理错误（如日志输出或返回）
    return;
}</code></pre>
     </li>
    </ul>
    <h5>
     ​
     <strong>
      4. 编辑控件生命周期
     </strong>
    </h5>
    <ul>
     <li>
      ​
      <strong>
       及时操作
      </strong>
      ：获取句柄后需尽快完成操作（如读取文本），因为编辑控件可能在用户取消编辑（按
      <code>
       ESC
      </code>
      ）或完成编辑（按回车）后被销毁。
     </li>
     <li>
      ​
      <strong>
       禁止延迟操作
      </strong>
      ：不要在异步线程或长时间耗时操作中保留句柄。
     </li>
    </ul>
    <h5>
     ​
     <strong>
      5. 多列列表视图的局限性
     </strong>
    </h5>
    <ul>
     <li>
      ​
      <strong>
       仅支持主项编辑
      </strong>
      ：
      <code>
       ListView_GetEditControl
      </code>
      <span style="color:#fe2c24">
       仅返回主项的编辑控件句柄
      </span>
      ，子项编辑需其他方法（如自定义控件或消息处理）。
     </li>
     <li>
      ​
      <strong>
       子项编辑方案
      </strong>
      ：需监听
      <code>
       LVN_BEGINLABELEDIT
      </code>
      ，并通过
      <span style="color:#fe2c24">
       <code>
        iSubItem
       </code>
       字段判断编辑的子项
      </span>
      ，但无法直接获取子项编辑框句柄。
     </li>
    </ul>
    <h5>
     ​
     <strong>
      6. 与
      <code>
       LVN_ENDLABELEDIT
      </code>
      的协作
     </strong>
    </h5>
    <ul>
     <li>
      ​
      <strong>
       避免重复读取
      </strong>
      ：在
      <code>
       LVN_ENDLABELEDIT
      </code>
      事件中，编辑控件已销毁，​
      <strong>
       不要调用
       <code>
        GetWindowText(hEdit, ...)
       </code>
      </strong>
      。
      <ul>
       <li>
        ​
        <strong>
         正确做法
        </strong>
        ：在
        <code>
         LVN_BEGINLABELEDIT
        </code>
        中保存原始文本，在
        <code>
         LVN_ENDLABELEDIT
        </code>
        中直接使用事件参数
        <code>
         pszText
        </code>
        。
       </li>
      </ul>
      <pre><code class="language-cpp">case LVN_ENDLABELEDIT:
    NMLVENDLABELEDIT* pEndEdit = (NMLVENDLABELEDIT*)lParam;
    if (!gbPreeEscKey) {
        // 使用用户输入的文本（pEndEdit-&gt;pszText）
        item.pszText = pEndEdit-&gt;pszText;
    } else {
        // 使用保存的原始文本（strRaw）
        item.pszText = strRaw;
    }
    break;</code></pre>
     </li>
    </ul>
    <h5>
     ​
     <strong>
      7. 线程安全
     </strong>
    </h5>
    <ul>
     <li>
      ​
      <strong>
       UI线程专属
      </strong>
      ：必须在
      <span style="color:#fe2c24">
       创建列表视图控件的线程中调用
      </span>
      ，跨线程操作会导致崩溃。
     </li>
    </ul>
    <h5>
     ​
     <strong>
      8. 兼容性
     </strong>
    </h5>
    <ul>
     <li>
      ​
      <strong>
       Windows 版本
      </strong>
      ：支持 Windows XP 及以上版本，但建议使用
      <code>
       LVM_GETEDITCONTROL
      </code>
      宏（兼容性更强）。
      <pre><code class="language-cpp">#define ListView_GetEditControl(hwndList) \
    ((HWND)(SendMessage(hwndList, LVM_GETEDITCONTROL, 0, 0)))</code></pre>
     </li>
    </ul>
    <hr/>
    <h4>
     ​
     <strong>
      示例代码改进
     </strong>
    </h4>
    <pre><code class="language-cpp">// LVN_BEGINLABELEDIT 处理
case LVN_BEGINLABELEDIT:
    hEdit = ListView_GetEditControl(hListView);
    if (hEdit) {
        GetWindowText(hEdit, strRaw, sizeof(strRaw)); // 保存原始文本
    }
    break;

// LVN_ENDLABELEDIT 处理
case LVN_ENDLABELEDIT:
    NMLVENDLABELEDIT* pEndEdit = (NMLVENDLABELEDIT*)lParam;
    int iIndex = pEndEdit-&gt;iItem;
    if (!gbPreeEscKey &amp;&amp; pEndEdit-&gt;pszText) {
        // 使用用户输入的文本
        item.iSubItem = 0;
        item.pszText = pEndEdit-&gt;pszText;
    } else {
        // 恢复原始文本
        item.iSubItem = 0;
        item.pszText = strRaw;
    }
    SendMessage(hListView, LVM_SETITEMTEXT, (WPARAM)iIndex, (LPARAM)&amp;item);
    break;</code></pre>
    <hr/>
    <h4>
     ​
     <strong>
      常见问题与调试
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       ​
       <strong>
        句柄为
        <code>
         NULL
        </code>
       </strong>
       ：
      </p>
      <ul>
       <li>
        未启用标签编辑？检查样式
        <code>
         LVS_EDITLABELS
        </code>
        。
       </li>
       <li>
        调用时机错误？确保在
        <code>
         LVN_BEGINLABELEDIT
        </code>
        中调用。
       </li>
      </ul>
     </li>
     <li>
      <p>
       ​
       <strong>
        文本无法恢复
       </strong>
       ：
      </p>
      <ul>
       <li>
        全局变量
        <code>
         gbPreeEscKey
        </code>
        未正确设置？检查键盘事件处理逻辑。
       </li>
      </ul>
     </li>
     <li>
      <p>
       ​
       <strong>
        多列编辑失效
       </strong>
       ：
      </p>
      <ul>
       <li>
        <code>
         ListView_GetEditControl
        </code>
        仅支持主项，子项需自定义实现。
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h4>
     ​
     <strong>
      总结
     </strong>
    </h4>
    <p>
     <code>
      ListView_GetEditControl()
     </code>
     是操作列表视图标签编辑的核心函数，需严格遵循以下原则：
    </p>
    <ol>
     <li>
      ​
      <strong>
       启用标签编辑
      </strong>
      ：样式
      <code>
       LVS_EDITLABELS
      </code>
      必不可少。
     </li>
     <li>
      ​
      <strong>
       时机精准
      </strong>
      ：仅在
      <code>
       LVN_BEGINLABELEDIT
      </code>
      中调用。
     </li>
     <li>
      ​
      <strong>
       句柄有效性检查
      </strong>
      ：防止空指针操作。
     </li>
     <li>
      ​
      <strong>
       协作事件处理
      </strong>
      ：结合
      <code>
       LVN_ENDLABELEDIT
      </code>
      的
      <code>
       pszText
      </code>
      成员，避免间接访问已销毁控件。
     </li>
    </ol>
    <p>
     通过合理使用该函数，可高效实现列表视图项的标签编辑与状态管理。
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f32303732353232312f:61727469636c652f64657461696c732f313436323238383633" class_="artid" style="display:none">
 </p>
</div>


