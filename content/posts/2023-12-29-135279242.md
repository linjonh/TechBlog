---
layout: post
title: "18-基于WebRTC实现音视频通话"
date: 2023-12-29 21:24:58 +0800
description: "经过上述三个步骤，则完成了 P2P 通信过程中的媒体协商部分，实际上在呼叫端以及接收端调用setLo"
keywords: "webrtc语音通话"
categories: ['前端']
tags: ['音视频', '前端框架', '前端', 'Webrtc', 'Vue', 'Vue']
artid: "135279242"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=135279242
    alt: "18-基于WebRTC实现音视频通话"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=135279242
featuredImagePreview: https://bing.ee123.net/img/rand?artid=135279242
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     18 基于WebRTC实现音视频通话
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      基于WebRTC实现音视频通话
     </h4>
     <ul>
      <li>
       <ul>
        <li>
         <a href="#WebRTC_3" rel="nofollow">
          基于WebRTC实现音视频通话
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#_5" rel="nofollow">
            背景
           </a>
          </li>
          <li>
           <a href="#_9" rel="nofollow">
            应用场景
           </a>
          </li>
          <li>
           <a href="#P2P_16" rel="nofollow">
            P2P通信原理
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#_32" rel="nofollow">
              如何发现对方？
             </a>
            </li>
            <li>
             <a href="#_44" rel="nofollow">
              不同的音视频编解码能力如何沟通？
             </a>
            </li>
            <li>
             <a href="#_54" rel="nofollow">
              如何联系上对方？
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#API_74" rel="nofollow">
            常用的API
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#getUserMedia_76" rel="nofollow">
              音视频采集`getUserMedia`
             </a>
            </li>
            <li>
             <a href="#_RTCPeerConnection_94" rel="nofollow">
              核心对象 `RTCPeerConnection`
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#_138" rel="nofollow">
            实践
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#_140" rel="nofollow">
              项目搭建
             </a>
            </li>
            <li>
             <ul>
              <li>
               <a href="#_142" rel="nofollow">
                前端项目
               </a>
              </li>
              <li>
               <a href="#_249" rel="nofollow">
                后端项目
               </a>
              </li>
             </ul>
            </li>
            <li>
             <a href="#_293" rel="nofollow">
              前端连接信令服务器
             </a>
            </li>
            <li>
             <a href="#_321" rel="nofollow">
              发起视频请求
             </a>
            </li>
            <li>
             <ul>
              <li>
               <a href="#_327" rel="nofollow">
                连接成功时加入房间：
               </a>
              </li>
              <li>
               <a href="#AB_344" rel="nofollow">
                用户A发起视频请求并通知用户B：
               </a>
              </li>
              <li>
               <a href="#_SDP__candidate__370" rel="nofollow">
                开始交换 SDP 信息和 candidate 信息：
               </a>
              </li>
              <li>
               <a href="#_537" rel="nofollow">
                挂断视频
               </a>
              </li>
             </ul>
            </li>
            <li>
             <a href="#peerjs_559" rel="nofollow">
              拓展：peerjs
             </a>
            </li>
           </ul>
          </li>
         </ul>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h3>
     <a id="WebRTC_3">
     </a>
     基于WebRTC实现音视频通话
    </h3>
    <h4>
     <a id="_5">
     </a>
     背景
    </h4>
    <p>
     随着互联网技术的飞速发展，实时音视频通话已经成为在线教育、远程办公、社交媒体等领域的核心且常用的功能。WebRTC（Web Real-Time Communication）作为一项开放的实时通信标准，为开发者提供了快速构建实时音视频通话系统的能力。在本中，我们将从0到1使用 WebRTC 构建一个基于 P2P 架构的音视频通话的应用案例。
    </p>
    <h4>
     <a id="_9">
     </a>
     应用场景
    </h4>
    <ul>
     <li>
      点对点视频聊天：如 微信视频 等实时视频通话应用。
     </li>
     <li>
      多人视频会议：企业级多人视频会议系统，如飞书、钉钉、腾讯会议等。
     </li>
     <li>
      在线教育：如腾讯课堂、网易云课堂等。
     </li>
     <li>
      直播：游戏直播、直播等。
     </li>
    </ul>
    <h4>
     <a id="P2P_16">
     </a>
     P2P通信原理
    </h4>
    <p>
     P2P 通信即点对点通信。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3f1082f50c23afd7ecfbd4bcd30d9b1e.png"/>
    </p>
    <p>
     要实现两个客户端的实时音视频通信，并且这两个客户端可能处于不同网络环境，使用不同的设备，都需要解决哪些问题？
    </p>
    <p>
     主要是下面这 3 个问题：
    </p>
    <ul>
     <li>
      <p>
       如何发现对方？
      </p>
     </li>
     <li>
      <p>
       不同的音视频编解码能力如何沟通？
      </p>
     </li>
     <li>
      <p>
       如何联系上对方？
      </p>
     </li>
    </ul>
    <p>
     下面我们将逐个讨论这 3 个问题。
    </p>
    <h5>
     <a id="_32">
     </a>
     如何发现对方？
    </h5>
    <p>
     在 P2P 通信的过程中，双方需要交换一些元数据比如媒体信息、网络数据等等信息,我们通常称这一过程叫做“信令(signaling)”。
    </p>
    <p>
     对应的服务器即“信令服务器 (signaling server)”，通常也有人将之称为“房间服务器”，因为它不仅可以交换彼此的媒体信息和网络信息，同样也可以管理房间信息。
    </p>
    <p>
     比如：
    </p>
    <p>
     1）通知彼此 who 加入了房间；2）who 离开了房间 3）告诉第三方房间人数是否已满是否可以加入房间。
    </p>
    <p>
     为了避免出现冗余，并最大限度地提高与已有技术的兼容性，WebRTC 标准并没有规定信令方法和协议。使用websocket来搭建一个信令服务器
    </p>
    <h5>
     <a id="_44">
     </a>
     不同的音视频编解码能力如何沟通？
    </h5>
    <p>
     不同浏览器对于音视频的编解码能力是不同的。
    </p>
    <p>
     比如: 以日常生活中的例子来讲，小李会讲汉语和英语，而小王会讲汉语和法语。为了保证双方都可以正确的理解对方的意思，最简单的办法即取他们都会的语言，也就是汉语来沟通。
    </p>
    <p>
     在 WebRTC 中：有一个专门的协议，称为 Session Description Protocol(SDP)，可以用于描述上述这类信息。
    </p>
    <p>
     因此：参与音视频通讯的双方想要了解对方支持的媒体格式，必须要交换 SDP 信息。而交换 SDP 的过程，通常称之为媒体协商。
    </p>
    <h5>
     <a id="_54">
     </a>
     如何联系上对方？
    </h5>
    <p>
     其实就是网络协商的过程，即参与音视频实时通信的双方要了解彼此的网络情况，这样才有可能找到一条相互通讯的链路。
    </p>
    <p>
     理想的网络情况是每个客户端都有自己的私有公网 IP 地址，这样的话就可以直接进行点对点连接。实际上呢，出于网络安全和其他原因的考虑，大多数客户端之间都是在某个局域网内，需要网络地址转换（NAT）。
    </p>
    <p>
     在 WebRTC 中我们使用 ICE 机制建立网络连接。ICE 协议通过一系列的技术（如 STUN、TURN 服务器）帮助通信双方发现和协商可用的公共网络地址，从而实现 NAT 穿越。
    </p>
    <p>
     ICE 的工作原理如下：
    </p>
    <ol>
     <li>
      首先，通信双方收集本地网络地址（包括私有地址和公共地址）以及通过 STUN 和 TURN 服务器获取的候选地址。
     </li>
     <li>
      接下来，双方通过信令服务器交换这些候选地址。
     </li>
     <li>
      通信双方使用这些候选地址进行连接测试，确定最佳的可用地址。
     </li>
     <li>
      一旦找到可用的地址，通信双方就可以开始实时音视频通话。
     </li>
    </ol>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/41bbc5947ac166c00780735c60f5c98f.png">
      <br/>
      在 WebRTC 中网络信息通常用
      <strong>
       candidate
      </strong>
      来描述
     </img>
    </p>
    <p>
     针对上面三个问题的总结：就是通过 WebRTC 提供的 API 获取各端的媒体信息
     <strong>
      SDP
     </strong>
     以及 网络信息
     <strong>
      candidate
     </strong>
     ，并通过
     <strong>
      信令服务器
     </strong>
     交换，进而建立了两端的连接通道完成实时视频语音通话。
    </p>
    <h4>
     <a id="API_74">
     </a>
     常用的API
    </h4>
    <h5>
     <a id="getUserMedia_76">
     </a>
     音视频采集
     <code>
      getUserMedia
     </code>
    </h5>
    <pre><code class="prism language-js"><span class="token keyword">const</span> localStream <span class="token operator">=</span> ref<span class="token operator">&lt;</span>MediaStream<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 本地流</span>
<span class="token comment">// 获取本地音视频流</span>
<span class="token keyword">const</span> <span class="token function-variable function">getLocalStream</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> navigator<span class="token punctuation">.</span>mediaDevices<span class="token punctuation">.</span><span class="token function">getUserMedia</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token comment">// 获取音视频流</span>
    <span class="token literal-property property">audio</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">video</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  localVideo<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span>srcObject <span class="token operator">=</span> stream
  localVideo<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> stream
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="_RTCPeerConnection_94">
     </a>
     核心对象
     <code>
      RTCPeerConnection
     </code>
    </h5>
    <p>
     <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/RTCPeerConnection" rel="nofollow">
      RTCPeerConnection
     </a>
     作为创建点对点连接的 API,是我们实现音视频实时通信的关键。
    </p>
    <pre><code class="prism language-js"><span class="token keyword">const</span> peer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RTCPeerConnection</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token comment">// iceServers: [</span>
  <span class="token comment">//   { url: "stun:stun.l.google.com:19302" }, // 谷歌的公共服务</span>
  <span class="token comment">//   {<!-- --></span>
  <span class="token comment">//     urls: "turn:***",</span>
  <span class="token comment">//     credential: "***",</span>
  <span class="token comment">//     username: "***",</span>
  <span class="token comment">//   },</span>
  <span class="token comment">// ],</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     主要会用到以下几个方法：
    </p>
    <p>
     媒体协商方法：
    </p>
    <ul>
     <li>
      createOffer
     </li>
     <li>
      createAnswer
     </li>
     <li>
      setLocalDesccription
     </li>
     <li>
      setRemoteDesccription
     </li>
    </ul>
    <p>
     重要事件：
    </p>
    <ul>
     <li>
      <p>
       onicecandidate
      </p>
     </li>
     <li>
      <p>
       onaddstream
      </p>
      <p>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/62cf8a09fd1223474390e58998f637bf.png">
        <br/>
        整个媒体协商过程可以简化为三个步骤对应上述四个媒体协商方法：
       </img>
      </p>
     </li>
    </ul>
    <ol>
     <li>
      <p>
       呼叫端创建 Offer(createOffer)并将 offer 消息（内容是呼叫端的 SDP 信息）通过信令服务器传送给接收端,同时调用 setLocalDesccription 将含有本地 SDP 信息的 Offer 保存起来
      </p>
     </li>
     <li>
      <p>
       接收端收到对端的 Offer 信息后调用 setRemoteDesccription 方法将含有对端 SDP 信息的 Offer 保存起来，并创建 Answer(createAnswer)并将 Answer 消息（内容是接收端的 SDP 信息）通过信令服务器传送给呼叫端
      </p>
     </li>
     <li>
      <p>
       呼叫端收到对端的 Answer 信息后调用 setRemoteDesccription 方法将含有对端 SDP 信息的 Answer 保存起来
      </p>
     </li>
    </ol>
    <p>
     经过上述三个步骤，则完成了 P2P 通信过程中的媒体协商部分，实际上在呼叫端以及接收端调用setLocalDesccription 同时也开始了收集各端自己的网络信息(candidate)，然后各端通过监听事件 onicecandidate 收集到各自的 candidate 并通过信令服务器传送给对端，进而打通 P2P 通信的网络通道，并通过监听 onaddstream 事件拿到对方的视频流进而完成了整个视频通话过程。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/eda7f78798d1eefa03243f5e21c4b914.png"/>
    </p>
    <h4>
     <a id="_138">
     </a>
     实践
    </h4>
    <h5>
     <a id="_140">
     </a>
     项目搭建
    </h5>
    <h6>
     <a id="_142">
     </a>
     前端项目
    </h6>
    <ol>
     <li>
      项目使用
      <code>
       vue3+ts
      </code>
      ，运行如下命令：
     </li>
    </ol>
    <pre><code class="prism language-bash"><span class="token function">npm</span> create vite@latest webrtc-client -- <span class="token parameter variable">--template</span> vue-ts
</code></pre>
    <p>
     <strong>
      这里报错的可能解决方式，确保你使用的是支持ES模块的Node.js版本。Node.js在12.17.0之后的版本开始支持ES模块。你可以通过运行node -v来检查你的Node.js版本。如果版本过低，你可以考虑升级Node.js。
     </strong>
     <br/>
     2. cd webrtc-client 并且引入
     <code>
      tailwindcss
     </code>
     :
    </p>
    <pre><code class="prism language-bash"><span class="token function">npm</span> <span class="token function">install</span> <span class="token parameter variable">-D</span> tailwindcss postcss autoprefixer
npx tailwindcss init <span class="token parameter variable">-p</span>
</code></pre>
    <ol start="3">
     <li>
      在生成的
      <code>
       tailwind.config.js
      </code>
      配置文件中添加所有模板文件的路径。
     </li>
    </ol>
    <pre><code class="prism language-js"><span class="token comment">/** @type {import('tailwindcss').Config} */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">content</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"./index.html"</span><span class="token punctuation">,</span>
    <span class="token string">"./src/**/*.{vue,js,ts,jsx,tsx}"</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">theme</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">extend</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
    <ol start="4">
     <li>
      修改
      <code>
       style.css
      </code>
      中的内容如下：
     </li>
    </ol>
    <pre><code class="prism language-css"><span class="token atrule"><span class="token rule">@tailwind</span> base<span class="token punctuation">;</span></span>
<span class="token atrule"><span class="token rule">@tailwind</span> components<span class="token punctuation">;</span></span>
<span class="token atrule"><span class="token rule">@tailwind</span> utilities<span class="token punctuation">;</span></span>
</code></pre>
    <ol start="5">
     <li>
      自定义修改
      <code>
       App.vue
      </code>
      中的内容如下：
     </li>
    </ol>
    <pre><code class="prism language-vue">&lt;script lang="ts" setup&gt;
import { ref } from 'vue'

const called = ref&lt;boolean&gt;(false) // 是否是接收方
const caller = ref&lt;boolean&gt;(false) // 是否是发起方
const calling = ref&lt;boolean&gt;(false) // 呼叫中
const communicating = ref&lt;boolean&gt;(false) // 视频通话中
const localVideo = ref&lt;HTMLVideoElement&gt;() // video标签实例，播放本人的视频
const remoteVideo = ref&lt;HTMLVideoElement&gt;() // video标签实例，播放对方的视频

// 发起方发起视频请求
const callRemote = () =&gt; {
  console.log('发起视频');
}

// 接收方同意视频请求
const acceptCall = () =&gt; {
  console.log('同意视频邀请');
}

// 挂断视频
const hangUp = () =&gt; {
  console.log('挂断视频');
}
&lt;/script&gt;

&lt;template&gt;
  &lt;div class="flex items-center flex-col text-center p-12 h-screen"&gt;
    &lt;div class="relative h-full mb-4"&gt;
      &lt;video
        ref="localVideo" 
        class="w-96 h-full bg-gray-200 mb-4 object-cover"
      &gt;&lt;/video&gt;
      &lt;video
        ref="remoteVideo"
        class="w-32 h-48 absolute bottom-0 right-0 object-cover"
      &gt;&lt;/video&gt;
      &lt;div v-if="caller &amp;&amp; calling" class="absolute top-2/3 left-36 flex flex-col items-center"&gt;
        &lt;p class="mb-4 text-white"&gt;等待对方接听...&lt;/p&gt;
        &lt;img @click="hangUp" src="/refuse.svg" class="w-16 cursor-pointer" alt=""&gt;
      &lt;/div&gt;
      &lt;div v-if="called &amp;&amp; calling" class="absolute top-2/3 left-32 flex flex-col items-center"&gt;
        &lt;p class="mb-4 text-white"&gt;收到视频邀请...&lt;/p&gt;
        &lt;div class="flex"&gt;
          &lt;img @click="hangUp" src="/refuse.svg" class="w-16 cursor-pointer mr-4" alt=""&gt;
          &lt;img @click="acceptCall" src="/accept.svg" class="w-16 cursor-pointer" alt=""&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class="flex gap-2 mb-4"&gt;
      &lt;button 
        class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white" 
        @click="callRemote"
      &gt;发起视频&lt;/button&gt;
      &lt;button 
        class="rounded-md bg-red-600 px-4 py-2 text-sm font-semibold text-white" 
        @click="hangUp"
      &gt;挂断视频&lt;/button&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;
</code></pre>
    <p>
     执行完上面的步骤就可以运行
     <code>
      npm run dev
     </code>
     来在本地启动项目了
    </p>
    <h6>
     <a id="_249">
     </a>
     后端项目
    </h6>
    <p>
     创建一个
     <code>
      webrtc-server
     </code>
     的文件夹，执行
     <code>
      npm init
     </code>
     ，一路回车即可，然后运行如下命令安装
     <code>
      socket.io
     </code>
     和
     <code>
      nodemon
     </code>
     ：
    </p>
    <pre><code class="prism language-bash"><span class="token function">npm</span> <span class="token function">install</span> socket.io nodemon
</code></pre>
    <p>
     创建
     <code>
      index.js
     </code>
     的文件，并添加如下内容：
    </p>
    <pre><code class="prism language-js"><span class="token keyword">const</span> socket <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'socket.io'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> io <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">cors</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">origin</span><span class="token operator">:</span> <span class="token string">'*'</span> <span class="token comment">// 配置跨域</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

io<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connection'</span><span class="token punctuation">,</span> <span class="token parameter">sock</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'连接成功...'</span><span class="token punctuation">)</span>
  <span class="token comment">// 向客户端发送连接成功的消息</span>
  sock<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'connectionSuccess'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务器启动成功'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     在
     <code>
      package.json
     </code>
     中添加
     <code>
      start
     </code>
     命令，使用
     <code>
      nodemon
     </code>
     启动项目：
    </p>
    <pre><code class="prism language-json"><span class="token string-property property">"scripts"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"test"</span><span class="token operator">:</span> <span class="token string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"start"</span><span class="token operator">:</span> <span class="token string">"nodemon index.js"</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
    <p>
     执行完后运行
     <code>
      npm run start
     </code>
     即在3000端口可启动node服务了
    </p>
    <h5>
     <a id="_293">
     </a>
     前端连接信令服务器
    </h5>
    <p>
     前端需要安装
     <code>
      socket.io-client
     </code>
     , 并连接信令服务器：
    </p>
    <pre><code class="prism language-vue">&lt;script setup lang="ts"&gt;
  // App.vue
  import { ref, onMounted, onUnmounted } from 'vue'
	import { io, Socket } from "socket.io-client";
  
  // ...
  const socket = ref&lt;Socket&gt;() // Socket实例
  
  onMounted(() =&gt; {
    const sock = io('localhost:3000'); // 对应服务的端口
    
    // 连接成功
    sock.on('connectionSuccess', () =&gt; {
      console.log('连接成功')
    });
    
    socket.value = sock;
  })
  
  // ...
&lt;/script&gt;
</code></pre>
    <h5>
     <a id="_321">
     </a>
     发起视频请求
    </h5>
    <p>
     角色：用户A–发起方，用户B–接收方
    </p>
    <p>
     房间：类比聊天窗口
    </p>
    <h6>
     <a id="_327">
     </a>
     连接成功时加入房间：
    </h6>
    <pre><code class="prism language-js"><span class="token comment">// 前端代码</span>
<span class="token keyword">const</span> roomId <span class="token operator">=</span> <span class="token string">'001'</span>

sock<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connectionSuccess'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'连接服务器成功...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  sock<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'joinRoom'</span><span class="token punctuation">,</span> roomId<span class="token punctuation">)</span> <span class="token comment">// 前端发送加入房间事件</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 服务端代码</span>
sock<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'joinRoom'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">roomId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  sock<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>roomId<span class="token punctuation">)</span> <span class="token comment">// 加入房间</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <h6>
     <a id="AB_344">
     </a>
     用户A发起视频请求并通知用户B：
    </h6>
    <ol>
     <li>
      用户A发起视频请求，并且通过信令服务器通知用户B
     </li>
    </ol>
    <pre><code class="prism language-js"><span class="token comment">// 发起方发起视频请求</span>
<span class="token keyword">const</span> <span class="token function-variable function">callRemote</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'发起视频'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  caller<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  calling<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">getLocalStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// 向信令服务器发送发起请求的事件</span>
  socket<span class="token punctuation">.</span>value<span class="token operator">?.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'callRemote'</span><span class="token punctuation">,</span> roomId<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <ol start="2">
     <li>
      用户B同意视频请求，并且通过信令服务器通知用户A
     </li>
    </ol>
    <pre><code class="prism language-js"><span class="token comment">// 接收方同意视频请求</span>
<span class="token keyword">const</span> <span class="token function-variable function">acceptCall</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'同意视频邀请'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  socket<span class="token punctuation">.</span>value<span class="token operator">?.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'acceptCall'</span><span class="token punctuation">,</span> roomId<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="_SDP__candidate__370">
     </a>
     开始交换 SDP 信息和 candidate 信息：
    </h6>
    <ol>
     <li>
      用户A创建创建RTCPeerConnection，添加本地音视频流，生成offer，并且通过信令服务器将offer发送给用户B
     </li>
    </ol>
    <pre><code class="prism language-js">
<span class="token keyword">const</span> peer <span class="token operator">=</span> ref<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// RTCPeerConnection实例</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>caller<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 发送方</span>
  <span class="token comment">// 发送方收到同意视频事件</span>
  sock<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'acceptCall'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">// 创建RTCPeerConnection</span>
peer<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RTCPeerConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 添加本地音视频流</span>
peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">addStream</span><span class="token punctuation">(</span>localStream<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token comment">// 生成offer</span>
<span class="token keyword">const</span> offer <span class="token operator">=</span> <span class="token keyword">await</span> peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">createOffer</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">offerToReceiveAudio</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token literal-property property">offerToReceiveVideo</span><span class="token operator">:</span> <span class="token number">1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'offer'</span><span class="token punctuation">,</span> offer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置本地描述的offer</span>
<span class="token keyword">await</span> peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span>offer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 通过信令服务器将offer发送给用户B</span>
socket<span class="token punctuation">.</span>value<span class="token operator">?.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'sendOffer'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> offer<span class="token punctuation">,</span> roomId <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>）
</code></pre>
    <ol start="2">
     <li>
      用户B收到用户A的offer
     </li>
    </ol>
    <pre><code class="prism language-js">sock<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'sendOffer'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">offer</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 判断接收方</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'收到offer'</span><span class="token punctuation">,</span> offer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <ol start="3">
     <li>
      用户B需要创建自己的RTCPeerConnection，添加本地音视频流，设置远端描述信息，生成answer，并且通过信令服务器发送给用户A
     </li>
    </ol>
    <pre><code class="prism language-js">  <span class="token comment">// 接收方收到offer</span>
  sock<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'sendOffer'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">offer</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getLocalStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token comment">// 接收方创建自己的RTCPeerConnection对象</span>
      peer<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RTCPeerConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 添加本地音视频流</span>
      peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">addStream</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 获取candidate信息</span>
      peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function-variable function">onicecandidate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">event</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>candidate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 向服务器发送candidate信息</span>
          sock<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'sendCandidate'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> roomId<span class="token punctuation">,</span> <span class="token literal-property property">candidate</span><span class="token operator">:</span> event<span class="token punctuation">.</span>candidate <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 获取对方的音视频流</span>
      peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function-variable function">onaddstream</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">event</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 拿到对方的视频流</span>
        calling<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
        communicating<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span>
        remoteVideo<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span>srcObject <span class="token operator">=</span> event<span class="token punctuation">.</span>stream<span class="token punctuation">;</span>
        remoteVideo<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>

      <span class="token comment">// 设置远端描述信息</span>
      <span class="token keyword">await</span> peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span>offer<span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// 生成answer</span>
      <span class="token keyword">const</span> answer <span class="token operator">=</span> <span class="token keyword">await</span> peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">createAnswer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 设置本地描述信息</span>
      <span class="token keyword">await</span> peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 发送answer</span>
      sock<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'sendAnswer'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> roomId<span class="token punctuation">,</span> answer <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <ol start="4">
     <li>
      用户A收到用户B的answer
      <br/>
      . 服务端
      <br/>
      . // 收到接收方的answer
      <br/>
      sock.on(‘sendAnswer’, ({ roomId, answer }) =&gt; {
      <!-- -->
      <br/>
      // 向这个房间中的人广播这个事件
      <br/>
      io.to(roomId).emit(‘receiveAnswer’, answer)
      <br/>
      })
     </li>
    </ol>
    <pre><code class="prism language-js">  <span class="token comment">// 发送方收到接收方的answer</span>
  sock<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'receiveAnswer'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">answer</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>caller<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// 设置远端描述信息</span>
      peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <ol start="5">
     <li>
      用户A获取candidate信息并且通过信令服务器发送candidate给用户B
     </li>
    </ol>
    <pre><code class="prism language-js"><span class="token comment">// 通过监听onicecandidate事件获取candidate信息</span>
peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function-variable function">onicecandidate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">event</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>candidate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'用户A获取candidate信息'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过信令服务器发送candidate信息给用户B</span>
    socket<span class="token punctuation">.</span>value<span class="token operator">?.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'sendCandidate'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      roomId<span class="token punctuation">,</span>
      <span class="token literal-property property">candidate</span><span class="token operator">:</span> event<span class="token punctuation">.</span>candidate
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ol start="6">
     <li>
      用户B添加用户A的candidate信息
      <br/>
      // 收到发送方的candidate信息
      <br/>
      sock.on(‘sendCandidate’, ({ roomId, candidate }) =&gt; {
      <!-- -->
      <br/>
      // 向这个房间中的人广播candidate信息
      <br/>
      io.to(roomId).emit(‘receiveCandidate’, candidate)
      <br/>
      })
     </li>
    </ol>
    <pre><code class="prism language-js">  <span class="token comment">// 接收candidate信息</span>
  sock<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'receiveCandidate'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">candidate</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">await</span> peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">addIceCandidate</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <ol start="7">
     <li>
      用户B获取candidate信息并且通过信令服务器发送candidate给用户A（如上）
     </li>
    </ol>
    <pre><code class="prism language-js">peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function-variable function">onicecandidate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">event</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>candidate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'用户B获取candidate信息'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 通过信令服务器发送candidate信息给用户A</span>
    socket<span class="token punctuation">.</span>value<span class="token operator">?.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'sendCandidate'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      roomId<span class="token punctuation">,</span>
      <span class="token literal-property property">candidate</span><span class="token operator">:</span> event<span class="token punctuation">.</span>candidate
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ol start="8">
     <li>
      用户A添加用户B的candidate信息（如上）
     </li>
    </ol>
    <pre><code class="prism language-js"><span class="token comment">// 添加candidate信息</span>
  <span class="token comment">// 接收candidate信息</span>
  sock<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'receiveCandidate'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">candidate</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">await</span> peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">addIceCandidate</span><span class="token punctuation">(</span>candidate<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <ol start="9">
     <li>
      接下来用户A和用户B就可以进行P2P通信流
     </li>
    </ol>
    <pre><code class="prism language-js"><span class="token comment">// 监听onaddstream来获取对方的音视频流</span>
peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function-variable function">onaddstream</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">event</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  calling<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  communicating<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  remoteVideo<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span>srcObject <span class="token operator">=</span> event<span class="token punctuation">.</span>stream
  remoteVideo<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="_537">
     </a>
     挂断视频
    </h6>
    <pre><code class="prism language-js"><span class="token comment">// 挂断视频</span>
<span class="token keyword">const</span> <span class="token function-variable function">hangUp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'挂断视频'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  socket<span class="token punctuation">.</span>value<span class="token operator">?.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'hangUp'</span><span class="token punctuation">,</span> roomId<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 状态复原</span>
<span class="token keyword">const</span> <span class="token function-variable function">reset</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  called<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
  caller<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
  calling<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
  communicating<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
  peer<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">null</span>
  localVideo<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span>srcObject <span class="token operator">=</span> <span class="token keyword">null</span>
  remoteVideo<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span>srcObject <span class="token operator">=</span> <span class="token keyword">null</span>
  localStream<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="peerjs_559">
     </a>
     拓展：peerjs
    </h5>
    <p>
     文档：https://peerjs.com/docs/#start
    </p>
    <p>
     服务端实现
    </p>
    <pre><code class="prism language-js"><span class="token comment">// 使用peer搭建信令服务器</span>
<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> PeerServer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'peer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> peerServer <span class="token operator">=</span> <span class="token function">PeerServer</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">3001</span><span class="token punctuation">,</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/myPeerServer'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     前端实现
    </p>
    <pre><code class="prism language-js"><span class="token operator">&lt;</span>script setup lang<span class="token operator">=</span><span class="token string">"ts"</span><span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> ref<span class="token punctuation">,</span> onMounted <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> Peer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"peerjs"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> url <span class="token operator">=</span> ref<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> localVideo <span class="token operator">=</span> ref<span class="token operator">&lt;</span>HTMLVideoElement<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> remoteVideo <span class="token operator">=</span> ref<span class="token operator">&lt;</span>HTMLVideoElement<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> peerId <span class="token operator">=</span> ref<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> remoteId <span class="token operator">=</span> ref<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> peer <span class="token operator">=</span> ref<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> caller <span class="token operator">=</span> ref<span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> called <span class="token operator">=</span> ref<span class="token operator">&lt;</span>boolean<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> callObj <span class="token operator">=</span> ref<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>

<span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// </span>
  peer<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Peer</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token comment">// 连接信令服务器</span>
    <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">port</span><span class="token operator">:</span> <span class="token number">3001</span><span class="token punctuation">,</span>
    <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token string">'/myPeerServer'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">id</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    peerId<span class="token punctuation">.</span>value <span class="token operator">=</span> id
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 接收视频请求</span>
  peer<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'call'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">call</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    called<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span>
    callObj<span class="token punctuation">.</span>value <span class="token operator">=</span> call
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 获取本地音视频流</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getLocalStream</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">constraints</span><span class="token operator">:</span> MediaStreamConstraints</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 获取媒体流</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> navigator<span class="token punctuation">.</span>mediaDevices<span class="token punctuation">.</span><span class="token function">getUserMedia</span><span class="token punctuation">(</span>constraints<span class="token punctuation">)</span>
  <span class="token comment">// 将媒体流设置到 video 标签上播放</span>
  localVideo<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span>srcObject <span class="token operator">=</span> stream<span class="token punctuation">;</span>
  localVideo<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> stream
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">acceptCalled</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 接收视频</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getLocalStream</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">video</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">audio</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
  callObj<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">answer</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  callObj<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">remoteStream</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    called<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// 将远程媒体流添加到 video 元素中</span>
    remoteVideo<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span>srcObject <span class="token operator">=</span> remoteStream<span class="token punctuation">;</span>
    remoteVideo<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 开启视频</span>
<span class="token keyword">const</span> <span class="token function-variable function">callRemote</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>remoteId<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'请输入对方ID'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> stream <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">getLocalStream</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">video</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token literal-property property">audio</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token comment">// 将本地媒体流发送给远程 Peer</span>
  <span class="token keyword">const</span> call <span class="token operator">=</span> peer<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>remoteId<span class="token punctuation">.</span>value<span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
  caller<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span>
  call<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">remoteStream</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    caller<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// 将远程媒体流添加到 video 元素中</span>
    remoteVideo<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span>srcObject <span class="token operator">=</span> remoteStream<span class="token punctuation">;</span>
    remoteVideo<span class="token punctuation">.</span>value<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34343439383132372f:61727469636c652f64657461696c732f313335323739323432" class_="artid" style="display:none">
 </p>
</div>


