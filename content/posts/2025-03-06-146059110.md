---
layout: post
title: "加油站小程序实战教程08动态获取城市和站点信息"
date: 2025-03-06 11:27:20 +0800
description: "在自定义代码中我们可以通过调用数据源的获取多条方法得到主表信息，然后进行一定的转换得到我们需要的数据结构，具体代码如下params: {// 排序orderBy: [xh: \"asc\", // 创建时间，倒序},],// 返回字段选择select: {xh:true,_id:true,},// 返回total字段// 页面大小// 当前页面},});return {"
keywords: "加油站小程序实战教程08动态获取城市和站点信息"
categories: ['未分类']
tags: ['小程序', '低代码']
artid: "146059110"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146059110
    alt: "加油站小程序实战教程08动态获取城市和站点信息"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146059110
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146059110
cover: https://bing.ee123.net/img/rand?artid=146059110
image: https://bing.ee123.net/img/rand?artid=146059110
img: https://bing.ee123.net/img/rand?artid=146059110
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     加油站小程序实战教程08动态获取城市和站点信息
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="_1">
     </a>
     引言
    </h2>
    <p>
     在《加油站小程序实战教程07城市管理》中，我们介绍了如何在后台维护城市的基础信息并且站点和城市进行了关联。有了基础信息之后，我们就要用地图要求的数据结构进行组装。本篇我们介绍如何利用API封装数据，让城市列表和地图里的站点信息都来源于数据库。
    </p>
    <h2>
     <a id="1_API_4">
     </a>
     1 创建API
    </h2>
    <p>
     切换到APIs，点击创建图标，新建API
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/999f25bf4cf4465584318e5329ac337c.png">
      <br/>
      选择自定义代码
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b84efcd0d7b64f04b88be6d35472b66d.png">
       <br/>
       录入名称和标识
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/83dd2c105ca74f2e95f1a7a1ff01c64d.png">
        <br/>
        修改方法名称和标识
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/61229d51572c45afb83630cf521e7df7.png"/>
       </img>
      </img>
     </img>
    </p>
    <h2>
     <a id="2__13">
     </a>
     2 实现业务逻辑
    </h2>
    <p>
     首先看一下我们组件要求的数据结构
    </p>
    <pre><code class="prism language-bash">const cities <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span> name: <span class="token string">"北京"</span>, location: <span class="token punctuation">[</span><span class="token number">116.397428</span>, <span class="token number">39.90923</span><span class="token punctuation">]</span>, stations: <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span> name: <span class="token string">"天安门"</span>, location: <span class="token punctuation">[</span><span class="token number">116.397428</span>, <span class="token number">39.90923</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>, <span class="token punctuation">{<!-- --></span> name: <span class="token string">"鸟巢"</span>, location: <span class="token punctuation">[</span><span class="token number">116.397524</span>, <span class="token number">39.992424</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
        <span class="token punctuation">{<!-- --></span> name: <span class="token string">"上海"</span>, location: <span class="token punctuation">[</span><span class="token number">121.473701</span>, <span class="token number">31.230416</span><span class="token punctuation">]</span>, stations: <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span> name: <span class="token string">"外滩"</span>, location: <span class="token punctuation">[</span><span class="token number">121.490317</span>, <span class="token number">31.241638</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>, <span class="token punctuation">{<!-- --></span> name: <span class="token string">"陆家嘴"</span>, location: <span class="token punctuation">[</span><span class="token number">121.502771</span>, <span class="token number">31.238068</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
        <span class="token punctuation">{<!-- --></span> name: <span class="token string">"广州"</span>, location: <span class="token punctuation">[</span><span class="token number">113.264385</span>, <span class="token number">23.129112</span><span class="token punctuation">]</span>, stations: <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span> name: <span class="token string">"广州塔"</span>, location: <span class="token punctuation">[</span><span class="token number">113.330863</span>, <span class="token number">23.113455</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>, <span class="token punctuation">{<!-- --></span> name: <span class="token string">"白云山"</span>, location: <span class="token punctuation">[</span><span class="token number">113.28848</span>, <span class="token number">23.168778</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
        <span class="token punctuation">{<!-- --></span> name: <span class="token string">"深圳市"</span>, location: <span class="token punctuation">[</span><span class="token number">114.057868</span>, <span class="token number">22.543099</span><span class="token punctuation">]</span>, stations: <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span> name: <span class="token string">"世界之窗"</span>, location: <span class="token punctuation">[</span><span class="token number">113.976373</span>, <span class="token number">22.53332</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>, <span class="token punctuation">{<!-- --></span> name: <span class="token string">"欢乐谷"</span>, location: <span class="token punctuation">[</span><span class="token number">113.998048</span>, <span class="token number">22.546054</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
        <span class="token punctuation">{<!-- --></span> name: <span class="token string">"成都"</span>, location: <span class="token punctuation">[</span><span class="token number">104.066541</span>, <span class="token number">30.572269</span><span class="token punctuation">]</span>, stations: <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span> name: <span class="token string">"宽窄巷子"</span>, location: <span class="token punctuation">[</span><span class="token number">104.062837</span>, <span class="token number">30.667493</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>, <span class="token punctuation">{<!-- --></span> name: <span class="token string">"大熊猫基地"</span>, location: <span class="token punctuation">[</span><span class="token number">104.138817</span>, <span class="token number">30.735778</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
        <span class="token punctuation">{<!-- --></span> name: <span class="token string">"呼和浩特市"</span>, location: <span class="token punctuation">[</span><span class="token number">111.75199</span>, <span class="token number">40.84211</span><span class="token punctuation">]</span>, stations: <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span> name: <span class="token string">"大召寺"</span>, location: <span class="token punctuation">[</span><span class="token number">111.692018</span>, <span class="token number">40.812225</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
            <span class="token punctuation">{<!-- --></span> name: <span class="token string">"昭君墓"</span>, location: <span class="token punctuation">[</span><span class="token number">111.930514</span>, <span class="token number">40.718719</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
            <span class="token punctuation">{<!-- --></span> name: <span class="token string">"呼和浩特火车站"</span>, location: <span class="token punctuation">[</span><span class="token number">111.75199</span>, <span class="token number">40.841939</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
            <span class="token punctuation">{<!-- --></span> name: <span class="token string">"五塔寺"</span>, location: <span class="token punctuation">[</span><span class="token number">111.695302</span>, <span class="token number">40.809052</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
            <span class="token punctuation">{<!-- --></span> name: <span class="token string">"敕勒川草原"</span>, location: <span class="token punctuation">[</span><span class="token number">111.81666</span>, <span class="token number">40.88189</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
            <span class="token punctuation">{<!-- --></span> name: <span class="token string">"内蒙古博物院"</span>, location: <span class="token punctuation">[</span><span class="token number">111.704164</span>, <span class="token number">40.818445</span><span class="token punctuation">]</span> <span class="token punctuation">}</span>,
        <span class="token punctuation">]</span> <span class="token punctuation">}</span>,
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     我们的结构要求先是城市，城市里再显示站点信息。原来我们没办法一次性得到这个结构，新版数据源在主表里就可以获取到这些信息。我们先获取一下城市信息
    </p>
    <h3>
     <a id="21__34">
     </a>
     2.1 自定义代码中获取主表信息
    </h3>
    <p>
     在自定义代码中我们可以通过调用数据源的获取多条方法得到主表信息，然后进行一定的转换得到我们需要的数据结构，具体代码如下
    </p>
    <pre><code class="prism language-bash">module.exports <span class="token operator">=</span> async <span class="token keyword">function</span> <span class="token punctuation">(</span>params, context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  const result <span class="token operator">=</span> await context.callModel<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    name:<span class="token string">'City'</span>,
    methodName: <span class="token string">"wedaGetRecordsV2"</span>,
      params: <span class="token punctuation">{<!-- --></span>
        // 排序
        orderBy: <span class="token punctuation">[</span>
          <span class="token punctuation">{<!-- --></span>
            xh: <span class="token string">"asc"</span>, // 创建时间，倒序
          <span class="token punctuation">}</span>,
        <span class="token punctuation">]</span>,
        // 返回字段选择
        select: <span class="token punctuation">{<!-- --></span>
          name: true, 
          longitude:true,
          latitude:true,
          xh:true,
          _id:true,
          ctiyGasStation:true
        <span class="token punctuation">}</span>,
        // 返回total字段
        getCount: true,
        // 页面大小
        pageSize: <span class="token number">200</span>,
        // 当前页面
        pageNumber: <span class="token number">1</span>,
        compatibleWithV1: true,
      <span class="token punctuation">}</span>,
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const city <span class="token operator">=</span> result.records.map<span class="token variable"><span class="token punctuation">((</span>record<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
    return {
        name<span class="token operator">:</span> record.name<span class="token punctuation">,</span>
        location<span class="token operator">:</span> [record.longitude<span class="token punctuation">,</span> record.latitude]<span class="token punctuation">,</span>
        stations<span class="token operator">:</span> record.ctiyGasStation.map<span class="token punctuation">((</span>station<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>{
            name<span class="token operator">:</span> station.name<span class="token punctuation">,</span>
            location<span class="token operator">:</span> [record.longitude<span class="token punctuation">,</span> record.latitude]<span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> 使用城市的经纬度替代，因为原数据中站点没有单独经纬度
        }<span class="token punctuation">))</span></span>,
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
  <span class="token builtin class-name">return</span> city<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     贴入代码后，点击方法测试，可以看到结果，点击出参自动映射完成我们API的编写
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/59e46daed0d44c9885286679aec68955.png"/>
    </p>
    <h3>
     <a id="22_API_83">
     </a>
     2.2 创建变量读取API数据
    </h3>
    <p>
     API编写好之后，我们在页面上需要通过变量读取一下数据。在代码区新建一个外部API查询
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/517c98c99d0b41d3910550e8b41a44e2.png">
      <br/>
      选择我们的API，触发方式要设置为手动触发
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a9ba08057aa74267a7436d3e29bcb6a7.png"/>
     </img>
    </p>
    <h3>
     <a id="23__88">
     </a>
     2.3 修改组件初始化城市数据
    </h3>
    <p>
     在上一个版本，我们的城市信息是通过变量设置的默认值，像这种需要通过外部API去加载数据的，在react中需要通过设置状态变量来读取，先创建一个状态变量
    </p>
    <pre><code class="prism language-bash">const <span class="token punctuation">[</span>cities, setCities<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> // 存储城市数据
</code></pre>
    <p>
     然后添加一个钩子函数，来动态的设置我们的城市数据
    </p>
    <pre><code class="prism language-bash">useEffect<span class="token punctuation">((</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        // 模拟触发 API 并获取数据
        const fetchCityStations <span class="token operator">=</span> async <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
            try <span class="token punctuation">{<!-- --></span>
                // 调用你的 API 获取城市数据
                const result <span class="token operator">=</span> await <span class="token variable">$w</span>.getCityStation.trigger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                console.log<span class="token punctuation">(</span><span class="token string">"城市数据"</span>,result<span class="token punctuation">)</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    setCities<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> // 更新城市数据
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    console.error<span class="token punctuation">(</span><span class="token string">"获取城市数据失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                console.error<span class="token punctuation">(</span><span class="token string">"API 调用失败"</span>, error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        fetchCityStations<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>, <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> // 只在组件加载时触发一次
</code></pre>
    <h2>
     <a id="_117">
     </a>
     完整代码
    </h2>
    <pre><code class="prism language-bash"><span class="token function">import</span> React, <span class="token punctuation">{<!-- --></span> useRef, useEffect, useState <span class="token punctuation">}</span> from <span class="token string">"react"</span><span class="token punctuation">;</span>

<span class="token builtin class-name">export</span> default <span class="token keyword">function</span> CitySwitcherMap<span class="token punctuation">(</span>props<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    const <span class="token punctuation">{<!-- --></span> style <span class="token punctuation">}</span> <span class="token operator">=</span> props<span class="token punctuation">;</span>
    const mapContainerRef <span class="token operator">=</span> useRef<span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    const <span class="token punctuation">[</span>selectedCity, setSelectedCity<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    const <span class="token punctuation">[</span>defaultCityLocation, setDefaultCityLocation<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">116.397428</span>, <span class="token number">39.90923</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> // 默认北京
    const <span class="token punctuation">[</span>mapInstance, setMapInstance<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    const <span class="token punctuation">[</span>userLocation, setUserLocation<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">116.397428</span>, <span class="token number">39.90923</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> // 默认用户位置为北京
    const <span class="token punctuation">[</span>nearestStation, setNearestStation<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token punctuation">(</span>null<span class="token punctuation">)</span><span class="token punctuation">;</span>
    const <span class="token punctuation">[</span>cities, setCities<span class="token punctuation">]</span> <span class="token operator">=</span> useState<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> // 存储城市数据

    useEffect<span class="token variable"><span class="token punctuation">((</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
        <span class="token operator">/</span><span class="token operator">/</span> 模拟触发 API 并获取数据
        const fetchCityStations <span class="token operator">=</span> async <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
            try {
                <span class="token operator">/</span><span class="token operator">/</span> 调用你的 API 获取城市数据
                const result <span class="token operator">=</span> await $w.getCityStation.trigger<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                console.log<span class="token punctuation">(</span>"城市数据"<span class="token punctuation">,</span>result<span class="token punctuation">)</span>
                if <span class="token punctuation">(</span>result<span class="token punctuation">)</span> {
                    setCities<span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">/</span> 更新城市数据
                } else {
                    console.error<span class="token punctuation">(</span>"获取城市数据失败"<span class="token punctuation">)</span><span class="token punctuation">;</span>
                }
            } catch <span class="token punctuation">(</span>error<span class="token punctuation">)</span> {
                console.error<span class="token punctuation">(</span>"API 调用失败"<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            }
        }<span class="token punctuation">;</span>

        fetchCityStations<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    }<span class="token punctuation">,</span> []<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">/</span> 只在组件加载时触发一次

    useEffect<span class="token punctuation">((</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
        const loadAMap <span class="token operator">=</span> async <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
            if <span class="token punctuation">(</span><span class="token operator">!</span>window.AMap<span class="token punctuation">)</span> {
                const script <span class="token operator">=</span> document.createElement<span class="token punctuation">(</span>"script"<span class="token punctuation">)</span><span class="token punctuation">;</span>
                script.src <span class="token operator">=</span> "https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>webapi.amap.com<span class="token operator">/</span>maps<span class="token operator">?</span>v<span class="token operator">=</span><span class="token number">2.0</span><span class="token operator">&amp;</span>key<span class="token operator">=</span><span class="token number">6</span>bd36e95532ee2800d841762601420f5"<span class="token punctuation">;</span>
                script.async <span class="token operator">=</span> true<span class="token punctuation">;</span>
                script.onload <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
                    initMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                }<span class="token punctuation">;</span>
                document.body.appendChild<span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
            } else {
                initMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            }
        }<span class="token punctuation">;</span>

        const initMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
            if <span class="token punctuation">(</span>window.AMap<span class="token punctuation">)</span> {
                const map <span class="token operator">=</span> new window.AMap.Map<span class="token punctuation">(</span>mapContainerRef.current<span class="token punctuation">,</span> {
                    center<span class="token operator">:</span> defaultCityLocation<span class="token punctuation">,</span>
                    zoom<span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
                    mapStyle<span class="token operator">:</span> "amap<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>styles<span class="token operator">/</span>normal"<span class="token punctuation">,</span>
                }<span class="token punctuation">)</span><span class="token punctuation">;</span>
                setMapInstance<span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            }
        }<span class="token punctuation">;</span>

        loadAMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    }<span class="token punctuation">,</span> []<span class="token punctuation">)</span><span class="token punctuation">;</span>

    useEffect<span class="token punctuation">((</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
        if <span class="token punctuation">(</span>mapInstance<span class="token punctuation">)</span> {
            const selectedCityData <span class="token operator">=</span> cities.find<span class="token punctuation">((</span>city<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> city.name <span class="token operator">==</span><span class="token operator">=</span> selectedCity<span class="token punctuation">)</span><span class="token punctuation">;</span>
            if <span class="token punctuation">(</span>selectedCityData<span class="token punctuation">)</span> {
                mapInstance.setCenter<span class="token punctuation">(</span>selectedCityData.location<span class="token punctuation">)</span><span class="token punctuation">;</span>
                addMarkers<span class="token punctuation">(</span>selectedCityData.stations<span class="token punctuation">)</span><span class="token punctuation">;</span>
                calculateNearestStation<span class="token punctuation">(</span>selectedCityData.stations<span class="token punctuation">)</span><span class="token punctuation">;</span>
            }
        }
    }<span class="token punctuation">,</span> [selectedCity<span class="token punctuation">,</span> mapInstance<span class="token punctuation">,</span> cities]<span class="token punctuation">)</span><span class="token punctuation">;</span>

    const addMarkers <span class="token operator">=</span> <span class="token punctuation">(</span>stations<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
        mapInstance.clearMap<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        stations.forEach<span class="token punctuation">((</span>station<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
            const marker <span class="token operator">=</span> new window.AMap.Marker<span class="token punctuation">(</span>{
                position<span class="token operator">:</span> station.location<span class="token punctuation">,</span>
                map<span class="token operator">:</span> mapInstance<span class="token punctuation">,</span>
            }<span class="token punctuation">)</span><span class="token punctuation">;</span>

            const distance <span class="token operator">=</span> calculateDistance<span class="token punctuation">(</span>userLocation<span class="token punctuation">,</span> station.location<span class="token punctuation">)</span><span class="token punctuation">;</span>

            const infoWindow <span class="token operator">=</span> new window.AMap.InfoWindow<span class="token punctuation">(</span>{
                content<span class="token operator">:</span> `<span class="token operator">&lt;</span>div style<span class="token operator">=</span>"padding<span class="token operator">:</span> <span class="token number">10</span>px<span class="token punctuation">;</span> font<span class="token operator">-</span>size<span class="token operator">:</span> <span class="token number">14</span>px<span class="token punctuation">;</span> white<span class="token operator">-</span>space<span class="token operator">:</span> nowrap<span class="token punctuation">;</span> overflow<span class="token operator">:</span> hidden<span class="token punctuation">;</span> text<span class="token operator">-</span>overflow<span class="token operator">:</span> ellipsis<span class="token punctuation">;</span>"<span class="token operator">&gt;</span>
                             <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span><span class="token operator">&lt;</span>strong<span class="token operator">&gt;</span>${station.name}<span class="token operator">&lt;</span><span class="token operator">/</span>strong<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                             <span class="token operator">&lt;</span>div style<span class="token operator">=</span>"color<span class="token operator">:</span> #<span class="token number">666</span><span class="token punctuation">;</span>"<span class="token operator">&gt;</span>距当前站点 ${distance.toFixed<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>} km<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                          <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>`<span class="token punctuation">,</span>
                offset<span class="token operator">:</span> new window.AMap.Pixel<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> 调整偏移，避免遮挡标记
            }<span class="token punctuation">)</span><span class="token punctuation">;</span>

            marker.on<span class="token punctuation">(</span>"click"<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
                infoWindow.open<span class="token punctuation">(</span>mapInstance<span class="token punctuation">,</span> marker.getPosition<span class="token punctuation">(</span><span class="token punctuation">))</span></span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>nearestStation <span class="token operator">&amp;&amp;</span> nearestStation.name <span class="token operator">==</span><span class="token operator">=</span> station.name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                infoWindow.open<span class="token punctuation">(</span>mapInstance, marker.getPosition<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    const calculateNearestStation <span class="token operator">=</span> <span class="token punctuation">(</span>stations<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin class-name">let</span> nearest <span class="token operator">=</span> null<span class="token punctuation">;</span>
        <span class="token builtin class-name">let</span> minDistance <span class="token operator">=</span> Infinity<span class="token punctuation">;</span>

        stations.forEach<span class="token variable"><span class="token punctuation">((</span>station<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
            const distance <span class="token operator">=</span> calculateDistance<span class="token punctuation">(</span>userLocation<span class="token punctuation">,</span> station.location<span class="token punctuation">)</span><span class="token punctuation">;</span>
            if <span class="token punctuation">(</span>distance <span class="token operator">&lt;</span> minDistance<span class="token punctuation">)</span> {
                minDistance <span class="token operator">=</span> distance<span class="token punctuation">;</span>
                nearest <span class="token operator">=</span> station<span class="token punctuation">;</span>
            }
        }<span class="token punctuation">)</span><span class="token punctuation">;</span>

        setNearestStation<span class="token punctuation">(</span>nearest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    }<span class="token punctuation">;</span>

    const calculateDistance <span class="token operator">=</span> <span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
        const startLngLat <span class="token operator">=</span> new window.AMap.LngLat<span class="token punctuation">(</span>start[<span class="token number">0</span>]<span class="token punctuation">,</span> start[<span class="token number">1</span>]<span class="token punctuation">)</span><span class="token punctuation">;</span>
        const endLngLat <span class="token operator">=</span> new window.AMap.LngLat<span class="token punctuation">(</span>end[<span class="token number">0</span>]<span class="token punctuation">,</span> end[<span class="token number">1</span>]<span class="token punctuation">)</span><span class="token punctuation">;</span>
        return startLngLat.distance<span class="token punctuation">(</span>endLngLat<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">/</span> 返回公里数
    }<span class="token punctuation">;</span>

    const getUserLocation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
        if <span class="token punctuation">(</span>navigator.geolocation<span class="token punctuation">)</span> {
            navigator.geolocation.getCurrentPosition<span class="token punctuation">(</span>
                <span class="token punctuation">(</span>position<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
                    const { latitude<span class="token punctuation">,</span> longitude } <span class="token operator">=</span> position.coords<span class="token punctuation">;</span>
                    setUserLocation<span class="token punctuation">(</span>[longitude<span class="token punctuation">,</span> latitude]<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fetchCityNameFromCoords<span class="token punctuation">(</span>longitude<span class="token punctuation">,</span> latitude<span class="token punctuation">)</span><span class="token punctuation">;</span>
                }<span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
                    setUserLocation<span class="token punctuation">(</span>[<span class="token number">111.75199</span><span class="token punctuation">,</span> <span class="token number">40.84211</span>]<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">/</span><span class="token operator">/</span> 呼和浩特
                    setSelectedCity<span class="token punctuation">(</span>"呼和浩特市"<span class="token punctuation">)</span><span class="token punctuation">;</span>
                }
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
        }
    }<span class="token punctuation">;</span>

    const fetchCityNameFromCoords <span class="token operator">=</span> async <span class="token punctuation">(</span>lng<span class="token punctuation">,</span> lat<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
        try {
            const response <span class="token operator">=</span> await fetch<span class="token punctuation">(</span>
                `https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>restapi.amap.com<span class="token operator">/</span>v3<span class="token operator">/</span>geocode<span class="token operator">/</span>regeo<span class="token operator">?</span>key<span class="token operator">=</span><span class="token number">154</span>efad008972a03ecac218a844959a9<span class="token operator">&amp;</span>location<span class="token operator">=</span>${lng}<span class="token punctuation">,</span>${lat}`
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            const data <span class="token operator">=</span> await response.json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            if <span class="token punctuation">(</span>data.status <span class="token operator">==</span><span class="token operator">=</span> "<span class="token number">1</span>" <span class="token operator">&amp;&amp;</span> data.regeocode<span class="token punctuation">)</span> {
                const cityName <span class="token operator">=</span> data.regeocode.addressComponent.city <span class="token operator">||</span> data.regeocode.addressComponent.province<span class="token punctuation">;</span>
                setSelectedCity<span class="token punctuation">(</span>cityName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            }
        } catch {
            console.error<span class="token punctuation">(</span>"获取城市名称失败"<span class="token punctuation">)</span><span class="token punctuation">;</span>
        }
    }<span class="token punctuation">;</span>

    useEffect<span class="token punctuation">((</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> {
        getUserLocation<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    }<span class="token punctuation">,</span> []<span class="token punctuation">)</span><span class="token punctuation">;</span>

    return <span class="token punctuation">(</span>
        <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div style<span class="token operator">=</span>{<!-- -->{ marginBottom<span class="token operator">:</span> "<span class="token number">10</span>px"<span class="token punctuation">,</span> zIndex<span class="token operator">:</span> <span class="token number">999</span> }}<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>select
                    value<span class="token operator">=</span>{selectedCity}
                    onChange<span class="token operator">=</span>{<!-- --><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> setSelectedCity<span class="token punctuation">(</span>e.target.value<span class="token punctuation">)</span>}
                    style<span class="token operator">=</span>{<!-- -->{
                        padding<span class="token operator">:</span> "<span class="token number">8</span>px"<span class="token punctuation">,</span>
                        fontSize<span class="token operator">:</span> "<span class="token number">14</span>px"<span class="token punctuation">,</span>
                        borderRadius<span class="token operator">:</span> "<span class="token number">4</span>px"<span class="token punctuation">,</span>
                        border<span class="token operator">:</span> "<span class="token number">1</span>px solid #ccc"<span class="token punctuation">,</span>
                    }}
                <span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>option value<span class="token operator">=</span>""<span class="token operator">&gt;</span>请选择城市<span class="token operator">&lt;</span><span class="token operator">/</span>option<span class="token operator">&gt;</span>
                    {cities.map<span class="token punctuation">((</span>city<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span>
                        <span class="token operator">&lt;</span>option key<span class="token operator">=</span>{city.name} value<span class="token operator">=</span>{city.name}<span class="token operator">&gt;</span>
                            {city.name}
                        <span class="token operator">&lt;</span><span class="token operator">/</span>option<span class="token operator">&gt;</span>
                    <span class="token punctuation">))</span></span><span class="token punctuation">}</span>
                <span class="token operator">&lt;</span>/select<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>/div<span class="token operator">&gt;</span>

            <span class="token operator">&lt;</span>div
                <span class="token assign-left variable">ref</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span>mapContainerRef<span class="token punctuation">}</span>
                <span class="token assign-left variable">style</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>
                    position: <span class="token string">"relative"</span>,
                    width: <span class="token string">"100%"</span>,
                    height: <span class="token string">"500px"</span>,
                    marginTop: <span class="token string">"0px"</span>,
                    <span class="token punctuation">..</span>.style,
                <span class="token punctuation">}</span><span class="token punctuation">}</span>
            /<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>/div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <h2>
     <a id="_314">
     </a>
     最终效果
    </h2>
    <p>
     程序运行后，会自动读取数据库里的城市及站点信息，渲染到地图里
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/de39a464da0b499ba8182c892377b445.png"/>
    </p>
    <h2>
     <a id="_317">
     </a>
     总结
    </h2>
    <p>
     本篇我们介绍了如何通过API去将主子表的数据一并取出，并且重新改造成我们需要的数据结构。前端通过变量读取API，并且讲解了react中的状态变量及钩子函数的具体用法。有粉丝像举一反三实现他自己的应用，这就需要理解教程里涉及的知识点，只有掌握了才能做出自己需要的应用来。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031323837373231372f:61727469636c652f64657461696c732f313436303539313130" class_="artid" style="display:none">
 </p>
</div>


