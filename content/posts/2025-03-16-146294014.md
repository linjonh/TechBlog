---
layout: post
title: "Linux驱动开发实战六设备树升级插件设备树点灯"
date: 2025-03-16 16:14:41 +0800
description: "插件设备树极大地提高了Linux嵌入式系统的灵活性和可扩展性。通过允许动态修改硬件描述，它使得系统能够适应更广泛的使用场景，特别是在需要热插拔和动态配置的应用中。掌握插件设备树的开发，将使您的嵌入式Linux系统开发能力更上一层楼。"
keywords: "Linux驱动开发实战（六）：设备树升级！插件设备树点灯！"
categories: ['Linux']
tags: ['驱动开发', '嵌入式硬件', '单片机', 'Ubuntu', 'Mcu', 'Linux', 'C']
artid: "146294014"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146294014
    alt: "Linux驱动开发实战六设备树升级插件设备树点灯"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146294014
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146294014
cover: https://bing.ee123.net/img/rand?artid=146294014
image: https://bing.ee123.net/img/rand?artid=146294014
img: https://bing.ee123.net/img/rand?artid=146294014
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Linux驱动开发实战（六）：设备树升级！插件设备树点灯！
    </h1>
   </div>
  </div>
 </div>
 <a data-report-click='{"spm":"1001.2101.3001.8632"}' data-report-query="spm=1001.2101.3001.8632" data-report-view='{"spm":"1001.2101.3001.8632"}' href="https://activity.csdn.net/writing?id=10858" id="creatActivityHref" style="display:block;margin-top:16px;font-size:16px;color:#5094d5;font-weight:500" target="_blank">
  #新星杯·14天创作挑战营·第9期#
 </a>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="Linux_0">
     </a>
     Linux驱动开发实战（六）：设备树升级！插件设备树点灯！
    </h2>
    <hr/>
    <p>
    </p>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="1__11">
     </a>
     1. 为什么需要插件设备树
    </h2>
    <p>
     在嵌入式Linux开发中，设备树(Device Tree)已经成为描述硬件平台的标准方式。然而，传统的设备树存在一些局限性，尤其是在需要动态修改系统硬件配置的场景下。这就是插件设备树(Device Tree Overlay)出现的原因。
    </p>
    <h3>
     <a id="_14">
     </a>
     传统设备树的局限性
    </h3>
    <p>
     传统设备树在系统启动时一次性加载，描述了整个系统的硬件配置。这种方式存在以下问题：
    </p>
    <ol>
     <li>
      <strong>
       静态性
      </strong>
      ：一旦系统启动，设备树就被锁定，无法动态修改
     </li>
     <li>
      <strong>
       重启需求
      </strong>
      ：任何硬件配置的变更都需要修改设备树文件并重启系统
     </li>
     <li>
      <strong>
       不适合热插拔
      </strong>
      ：对于可热插拔设备，传统设备树难以支持实时响应
     </li>
     <li>
      <strong>
       冗余配置
      </strong>
      ：为了支持多种可能的硬件配置，往往需要在设备树中包含所有可能的配置
     </li>
    </ol>
    <h3>
     <a id="_23">
     </a>
     插件设备树的优势
    </h3>
    <p>
     插件设备树解决了上述问题，它具有以下优势：
    </p>
    <ol>
     <li>
      <strong>
       动态加载
      </strong>
      ：可以在系统运行时动态加载和卸载硬件描述
     </li>
     <li>
      <strong>
       无需重启
      </strong>
      ：修改硬件配置无需重启整个系统
     </li>
     <li>
      <strong>
       热插拔支持
      </strong>
      ：可以实时响应硬件变化
     </li>
     <li>
      <strong>
       模块化配置
      </strong>
      ：可以根据实际需求选择性地加载硬件描述
     </li>
     <li>
      <strong>
       灵活性
      </strong>
      ：支持定制化的硬件配置而无需修改核心设备树
     </li>
    </ol>
    <h2>
     <a id="2__33">
     </a>
     2. 传统设备树与插件设备树的区别
    </h2>
    <table>
     <thead>
      <tr>
       <th>
        特性
       </th>
       <th>
        传统设备树
       </th>
       <th>
        插件设备树
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        加载时机
       </td>
       <td>
        系统启动时
       </td>
       <td>
        系统运行时
       </td>
      </tr>
      <tr>
       <td>
        修改方式
       </td>
       <td>
        静态(需重启)
       </td>
       <td>
        动态(无需重启)
       </td>
      </tr>
      <tr>
       <td>
        文件格式
       </td>
       <td>
        <code>
         .dtb
        </code>
        (编译后)
       </td>
       <td>
        <code>
         .dtbo
        </code>
        (编译后)
       </td>
      </tr>
      <tr>
       <td>
        灵活性
       </td>
       <td>
        低
       </td>
       <td>
        高
       </td>
      </tr>
      <tr>
       <td>
        适用场景
       </td>
       <td>
        固定硬件配置
       </td>
       <td>
        可变硬件配置，热插拔设备
       </td>
      </tr>
      <tr>
       <td>
        实现复杂度
       </td>
       <td>
        相对简单
       </td>
       <td>
        相对复杂
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h2>
     <a id="3__45">
     </a>
     3. 插件设备树的语法
    </h2>
    <p>
     插件设备树有其特定的语法结构，主要包括以下几个关键部分：
    </p>
    <h3>
     <a id="_48">
     </a>
     基本结构
    </h3>
    <pre><code class="prism language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span>plugin<span class="token operator">/</span><span class="token punctuation">;</span>

<span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
fragment@n <span class="token punctuation">{<!-- --></span>
target <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>目标节点<span class="token operator">&gt;</span><span class="token punctuation">;</span>
overlay <span class="token punctuation">{<!-- --></span>
<span class="token comment">/* 要添加的节点和属性 */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     下面以rgb插件设备树为例
    </p>
    <pre><code class="prism language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>          <span class="token comment">// 设备树版本声明</span>
<span class="token operator">/</span>plugin<span class="token operator">/</span><span class="token punctuation">;</span>          <span class="token comment">// 标记这是一个设备树插件(overlay)文件</span>

<span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>                <span class="token comment">// 根节点</span>
    fragment@<span class="token number">0</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">// 设备树片段，索引为0</span>
        target<span class="token operator">-</span>path <span class="token operator">=</span> <span class="token string">"/"</span><span class="token punctuation">;</span>  <span class="token comment">// 目标路径，指定覆盖将应用到根节点</span>
        
        __overlay__ <span class="token punctuation">{<!-- --></span>      <span class="token comment">// 覆盖内容开始</span>
            <span class="token comment">/* bar peripheral */</span>
            rgb_led<span class="token punctuation">{<!-- --></span>       <span class="token comment">// 创建一个rgb_led节点</span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>  </span><span class="token comment">// 地址单元格数量</span></span>
                <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>     </span><span class="token comment">// 大小单元格数量</span></span>
                compatible <span class="token operator">=</span> <span class="token string">"fire,rgb_led"</span><span class="token punctuation">;</span>  <span class="token comment">// 兼容性字符串，用于匹配驱动</span>
                
                ranges<span class="token punctuation">;</span>    <span class="token comment">// 子地址空间与父地址空间直接映射</span>
                
                <span class="token comment">// 红灯子节点</span>
                rgb_led_red@<span class="token number">0x020C406C</span><span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 寄存器映射，包含5组地址和大小</span>
                    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x020C406C</span> <span class="token number">0x00000004</span>
                          <span class="token number">0x020E006C</span> <span class="token number">0x00000004</span>
                          <span class="token number">0x020E02F8</span> <span class="token number">0x00000004</span>
                          <span class="token number">0x0209C000</span> <span class="token number">0x00000004</span>
                          <span class="token number">0x0209C004</span> <span class="token number">0x00000004</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
                    status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>  <span class="token comment">// 启用状态</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                
                <span class="token comment">// 绿灯子节点</span>
                rgb_led_green@<span class="token number">0x020C4074</span><span class="token punctuation">{<!-- --></span>
                    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x020C4074</span> <span class="token number">0x00000004</span>
                          <span class="token number">0x020E01E0</span> <span class="token number">0x00000004</span>
                          <span class="token number">0x020E046C</span> <span class="token number">0x00000004</span>
                          <span class="token number">0x020A8000</span> <span class="token number">0x00000004</span>
                          <span class="token number">0x020A8004</span> <span class="token number">0x00000004</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
                    status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                
                <span class="token comment">// 蓝灯子节点</span>
                rgb_led_blue@<span class="token number">0x020C4074</span><span class="token punctuation">{<!-- --></span>
                    reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x020C4074</span> <span class="token number">0x00000004</span>
                          <span class="token number">0x020E01DC</span> <span class="token number">0x00000004</span>
                          <span class="token number">0x020E0468</span> <span class="token number">0x00000004</span>
                          <span class="token number">0x020A8000</span> <span class="token number">0x00000004</span>
                          <span class="token number">0x020A8004</span> <span class="token number">0x00000004</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
                    status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="_118">
     </a>
     关键语法元素
    </h3>
    <ol>
     <li>
      <strong>
       <code>
        /dts-v1/
       </code>
      </strong>
      : 设备树版本声明
     </li>
     <li>
      <strong>
       <code>
        /plugin/
       </code>
      </strong>
      : 标记这是一个插件设备树，允许引用未定义的节点
     </li>
     <li>
      <strong>
       <code>
        fragment@n
       </code>
      </strong>
      : 定义一个覆盖片段，
      <code>
       n
      </code>
      是一个索引数字
     </li>
     <li>
      <strong>
       <code>
        target
       </code>
      </strong>
      : 指定覆盖的目标节点，有两种形式：
      <ul>
       <li>
        <code>
         target = &lt;&amp;节点标签&gt;
        </code>
        : 通过标签引用目标节点
       </li>
       <li>
        <code>
         target-path = "节点路径"
        </code>
        : 通过路径引用目标节点
       </li>
      </ul>
     </li>
     <li>
      <strong>
       <code>
        __overlay__
       </code>
      </strong>
      : 定义要覆盖/添加的内容
     </li>
    </ol>
    <h2>
     <a id="4__129">
     </a>
     4. 实验步骤
    </h2>
    <p>
     在本实验中，我们通过修改之前
     <strong>
      写过的设备树
     </strong>
     基础上加插件设备树，我们将展示如何使用插件设备树来动态添加LED设备。
    </p>
    <h3>
     <a id="rgb_131">
     </a>
     修改原本的设备树（原来没有rgb节点的可以不改）
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/067f2046b8954923856555b7d6f8fdab.png"/>
    </p>
    <p>
     编译原本的设备树
    </p>
    <p>
     配置内核
    </p>
    <pre><code class="prism language-c">make ARCH<span class="token operator">=</span>arm CROSS_COMPILE<span class="token operator">=</span>arm<span class="token operator">-</span>linux<span class="token operator">-</span>gnueabihf<span class="token operator">-</span> npi_v7_defconfig
</code></pre>
    <p>
     编译dts
    </p>
    <pre><code class="prism language-c">sudo make ARCH<span class="token operator">=</span>arm <span class="token operator">-</span>j4 CROSS_COMPILE<span class="token operator">=</span>arm<span class="token operator">-</span>linux<span class="token operator">-</span>gnueabihf<span class="token operator">-</span> dtbs
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/970b71bfb62043c3bce35a1cbb8b7d11.png">
      <br/>
      传到共享文件夹
     </img>
    </p>
    <pre><code class="prism language-c">sudo cp arch<span class="token operator">/</span>arm<span class="token operator">/</span>boot<span class="token operator">/</span>dts<span class="token operator">/</span>imx6ull<span class="token operator">-</span>mmc<span class="token operator">-</span>npi<span class="token punctuation">.</span>dtb <span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>home<span class="token operator">/</span>embedfire<span class="token operator">/</span>workdir<span class="token operator">/</span>imx6ull<span class="token operator">-</span>mmc<span class="token operator">-</span>npi<span class="token punctuation">.</span>dtb
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7b88010821584d79a561eff3a6547b6c.png">
      <br/>
      cd /usr/lib/linux-image-4.19.35-imx6/ 这里是开发板设备树的路径
      <br/>
      将共享文件夹的设备树dtb文件替换掉开发板里面的dtb文件
     </img>
    </p>
    <pre><code class="prism language-c">sudo cp <span class="token operator">/</span>mnt<span class="token operator">/</span>imx6ull<span class="token operator">-</span>mmc<span class="token operator">-</span>npi<span class="token punctuation">.</span>dtb <span class="token operator">/</span>usr<span class="token operator">/</span>lib<span class="token operator">/</span>linux<span class="token operator">-</span>image<span class="token operator">-</span><span class="token number">4.19</span><span class="token number">.35</span><span class="token operator">-</span>imx6<span class="token operator">/</span>imx6ull<span class="token operator">-</span>mmc<span class="token operator">-</span>npi<span class="token punctuation">.</span>dtb
</code></pre>
    <p>
     重启开发板
    </p>
    <pre><code class="prism language-c">ls <span class="token operator">/</span>proc<span class="token operator">/</span>device<span class="token operator">-</span>tree
</code></pre>
    <p>
     命令查看是否增加了节点
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bcfba5d2d44648498886133e90c2acb2.png">
      <br/>
      发现原本的rgb_led是已经没有了，现在开始插件设备树的工作
     </img>
    </p>
    <h3>
     <a id="_169">
     </a>
     编译插件设备树
    </h3>
    <p>
     这里的插件设备树就是上面rgb代码示例
     <br/>
     编译 dts 为 dtbo
    </p>
    <pre><code class="prism language-c"><span class="token punctuation">.</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>home<span class="token operator">/</span>pi<span class="token operator">/</span>build<span class="token operator">/</span>scripts<span class="token operator">/</span>dtc<span class="token operator">/</span>dtc <span class="token operator">-</span>I dts <span class="token operator">-</span>O dtb <span class="token operator">-</span>o rgb<span class="token punctuation">.</span>dtbo led<span class="token punctuation">.</span>dts
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/100667d6a67846078ef58a432a7d2ee9.png">
      <br/>
      把rgb.dtbo复制到共享文件夹
     </img>
    </p>
    <h3>
     <a id="_178">
     </a>
     方法一：内核运行状态加载
    </h3>
    <p>
     先在/usr/lib/linux-image-4.19.35-imx6/overlays/目录下创建xxx文件夹
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/768bfd6b678049418e7a39cf362da411.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/54068e7920e44a12886a3940d2d168b0.png"/>
    </p>
    <p>
     发现这个方法好像设备树没有加载出来
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/54579b86eb904f6d99893ba8173803da.png">
      <br/>
      可是overlays的文件夹只有在这个目录下
      <br/>
      看了官方的文档发现，应该是内核版本问题但是没关系，我们可以采用另一种方法
     </img>
    </p>
    <h3>
     <a id="uboot_190">
     </a>
     方法二：uboot加载（强推）
    </h3>
    <p>
     先把rgb.dtbo文件复制到/usr/lib/linux-image-4.19.35-imx6/overlays下
     <br/>
     然后在/boot/uEnv.txt修改添加
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a637c223dd3b4d189bf0d143803fd68f.png"/>
     <br/>
     我们重启开发板
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b641618f81e34ebf9ceb92d6cf434695.png"/>
     <br/>
     发现是有的这个驱动的
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d2206b731d834657b96a925b769cc6cc.png"/>
     <br/>
     我们加载驱动然后使用qt应用程序（
     <a href="https://blog.csdn.net/m0_71304252/article/details/146249563?spm=1001.2014.3001.5501">
      qt程序点灯
     </a>
     ）去点灯是没有问题的
     <br/>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/direct/0da96a4970974556b8a7ab38b81dbd9e.jpeg"/>
    </p>
    <hr/>
    <h2>
     <a id="_205">
     </a>
     总结
    </h2>
    <p>
     插件设备树极大地提高了Linux嵌入式系统的灵活性和可扩展性。通过允许动态修改硬件描述，它使得系统能够适应更广泛的使用场景，特别是在需要热插拔和动态配置的应用中。掌握插件设备树的开发，将使您的嵌入式Linux系统开发能力更上一层楼。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f37313330343235322f:61727469636c652f64657461696c732f313436323934303134" class_="artid" style="display:none">
 </p>
</div>


