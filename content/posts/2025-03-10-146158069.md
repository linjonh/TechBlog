---
layout: post
title: "Goland如何玩依赖注入基于gonev2创建一个service"
date: 2025-03-10 18:59:14 +0800
description: "经过多天的工作，终于把gone2的beta版本发布出去了。在v2版本中，做了很多更新，最大的改进是将一些不必要的概念给隐藏起来了，提供了Provider机制……"
keywords: "Goland如何玩依赖注入——基于gone@v2创建一个service"
categories: ['Gone']
tags: ['微服务', '依赖注入', 'Golang']
artid: "146158069"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146158069
    alt: "Goland如何玩依赖注入基于gonev2创建一个service"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146158069
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146158069
cover: https://bing.ee123.net/img/rand?artid=146158069
image: https://bing.ee123.net/img/rand?artid=146158069
img: https://bing.ee123.net/img/rand?artid=146158069
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Goland如何玩依赖注入——基于gone@v2创建一个service
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      经过多天的工作，终于把gone2的beta版本发布出去了。在v2版本中，做了很多更新，最大的改进是将一些不必要的概念给隐藏起来了，提供了Provider机制……
      <br/>
     </p>
     <p>
     </p>
    </blockquote>
    <h3>
     <a id="1_gonectr_4">
     </a>
     1. 安装
     <strong>
      gonectr
     </strong>
    </h3>
    <pre><code class="prism language-bash">go <span class="token function">install</span> github.com/gone-io/gonectr@latest
gonectr <span class="token parameter variable">-v</span>
</code></pre>
    <pre><code class="prism language-log">Gonectr version: v0.0.17
</code></pre>
    <p>
     版本应该大于：v0.0.17
    </p>
    <h3>
     <a id="2_14">
     </a>
     2.创建项目
    </h3>
    <pre><code class="prism language-bash">gonectr create <span class="token parameter variable">-t</span> v2+web+mysql demo
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4f7a8849f4234a1bb789debdb2057e73.png">
      <br/>
      项目是以https://github.com/gone-io/template-v2-web-mysql 为模板创建的。
     </img>
    </p>
    <h4>
     <a id="21__21">
     </a>
     2.1 项目结构
    </h4>
    <pre><code class="prism language-log">├── go.mod
├── go.sum
├── Dockerfile
├── docker-compose.yaml
├── Makefile
├── README.md
├── cmd
│   └── server
│       ├── import.gone.go
│       └── main.go
├── config
│   └── default.properties
├── internal
│   ├── controller
│   │   ├── init.gone.go
│   │   └── user.go
│   ├── interface
│   │   ├── entity
│   │   │   └── user.go
│   │   ├── mock
│   │   │   ├── i_depenendent.gone.go
│   │   │   ├── i_user.gone.go
│   │   │   ├── i_user_token.gone.go
│   │   │   └── priest.gone.go
│   │   ├── package.go
│   │   └── service
│   │       ├── i_depenendent.go
│   │       ├── i_user.go
│   │       └── i_user_token.go
│   ├── loader.go
│   ├── module
│   │   ├── dependent
│   │   │   ├── dependent.go
│   │   │   └── init.gone.go
│   │   └── user
│   │       ├── init.gone.go
│   │       ├── token.go
│   │       ├── user.go
│   │       └── user_test.go
│   ├── pkg
│   │   ├── e
│   │   │   └── error.go
│   │   └── utils
│   │       ├── ctx.go
│   │       ├── password.go
│   │       └── token.go
│   └── router
│       ├── auth_router.go
│       ├── init.gone.go
│       └── pub_router.go
├── scripts
│   └── mysql
│       └── initdb.d
│           └── user.sql
└── tests
    └── api
        ├── http-client.env.json
        └── user.http
</code></pre>
    <h3>
     <a id="22__83">
     </a>
     2.2 简单说明
    </h3>
    <ul>
     <li>
      <strong>
       cmd/server/main.go
      </strong>
      是服务的入口文件：
     </li>
    </ul>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"demo/internal"</span>
	<span class="token string">"github.com/gone-io/gone/v2"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	gone<span class="token punctuation">.</span>
		<span class="token function">Loads</span><span class="token punctuation">(</span>internal<span class="token punctuation">.</span>Load<span class="token punctuation">)</span><span class="token punctuation">.</span>
		<span class="token function">Serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <strong>
       config
      </strong>
      是配置文件目录，支持多种配置文件格式，包括：JSON, TOML, YAML, HCL, INI, envfile or Java properties，配置文件的读取的底层是使用viper实现的。
     </li>
     <li>
      <strong>
       internal
      </strong>
      是业务代码目录，包括webController、 业务接口定义 和 业务逻辑实现等
      <ul>
       <li>
        <strong>
         internal/router
        </strong>
        路由分组
       </li>
       <li>
        <strong>
         internal/controller
        </strong>
        web接口定义
       </li>
       <li>
        <strong>
         internal/interface
        </strong>
        业务接口定义
       </li>
       <li>
        <strong>
         internal/module
        </strong>
        业务逻辑实现
       </li>
      </ul>
     </li>
     <li>
      <strong>
       scripts
      </strong>
      项目脚本
     </li>
     <li>
      <strong>
       tests
      </strong>
      接口测试的http文件，可以直接使用goland打开
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/76b4bbca798645d4b5ffccdd5adfddda.png"/>
     </li>
    </ul>
    <h3>
     <a id="3__109">
     </a>
     3. 启动项目
    </h3>
    <h4>
     <a id="31__110">
     </a>
     3.1 数据库
    </h4>
    <p>
     该项目使用的mysql数据库，需要：
    </p>
    <ol>
     <li>
      创建数据库，然后导入位于
      <code>
       scripts/mysql/initdb.d/user.sql
      </code>
      的SQL文件
     </li>
     <li>
      按实际情况修改配置文件
      <code>
       config/properties
      </code>
     </li>
    </ol>
    <pre><code class="prism language-ini"># 使用mysql
database.driver-name=mysql

db.host=localhost
db.port=3306
db.name=demo
db.username=root
db.password=123456

# 数据源配置 配置中，使用${key}来引用配置文件中的值
database.dsn=${db.username}:${db.password}@tcp(${db.host}:${db.port})/${db.name}?charset=utf8mb4&amp;loc=Local
</code></pre>
    <p>
     如果本地安装了docker-desktop，只需要执行：
    </p>
    <pre><code>docker compose up -d mysql
</code></pre>
    <h4>
     <a id="32__131">
     </a>
     3.2 本地开发启动
    </h4>
    <p>
     首先，下载依赖：
    </p>
    <pre><code class="prism language-bash">go mod tidy
</code></pre>
    <p>
     有多种方式：
    </p>
    <ul>
     <li>
      <strong>
       1.
      </strong>
      使用
      <strong>
       gonectr
      </strong>
      来启动项目：
     </li>
    </ul>
    <pre><code class="prism language-bash">gonectr run ./cmd/server
</code></pre>
    <p>
     会看到屏幕打印内容如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/dd63418e2ce648bfae93b6d3b710d4f0.png"/>
    </p>
    <ul>
     <li>
      <strong>
       2.
      </strong>
      使用
      <code>
       go run
      </code>
      命令来启动
      <br/>
      **但是请注意，需要先执行
      <code>
       go generate ./...
      </code>
      来生成辅助代码，这些辅助代码包含用于将 组件(Goner)注册到框架和用于mock测试。
     </li>
    </ul>
    <pre><code class="prism language-bash">go generate ./<span class="token punctuation">..</span>.
go run ./cmd/server
</code></pre>
    <ul>
     <li>
      <strong>
       3.
      </strong>
      使用
      <strong>
       goland
      </strong>
      <br/>
      点开
      <strong>
       Edit Configurations
      </strong>
      ，可以已经默认添加了一个启动项，并且在
      <strong>
       Before launch
      </strong>
      配置 了
      <code>
       go generate ./...
      </code>
      ，所以直接点击”运行“就可以了。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a64c2a48420e4033845b66d9a05b6381.png">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/79cbf097696b499795f82f0bea957c0e.png"/>
      </img>
     </li>
     <li>
      <strong>
       3.
      </strong>
      使用
      <strong>
       vs code
      </strong>
      <br/>
      在vscode中已经配置了启动项和启动前的任务，所以侧边栏切换到"运行和调试"点击 运行即可。
     </li>
     <li>
      .vscode/launch.json
     </li>
    </ul>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"version"</span><span class="token operator">:</span> <span class="token string">"0.2.0"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"configurations"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"name"</span><span class="token operator">:</span> <span class="token string">"server"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"go"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"request"</span><span class="token operator">:</span> <span class="token string">"launch"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"mode"</span><span class="token operator">:</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"cwd"</span><span class="token operator">:</span> <span class="token string">"${workspaceFolder}"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"program"</span><span class="token operator">:</span> <span class="token string">"${workspaceFolder}/cmd/server"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"preLaunchTask"</span><span class="token operator">:</span> <span class="token string">"generate"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      .vscode/tasks.json
     </li>
    </ul>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"version"</span><span class="token operator">:</span> <span class="token string">"2.0.0"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"tasks"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">"label"</span><span class="token operator">:</span> <span class="token string">"generate"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"type"</span><span class="token operator">:</span> <span class="token string">"shell"</span><span class="token punctuation">,</span>
            <span class="token string-property property">"command"</span><span class="token operator">:</span> <span class="token string">"go generate ./..."</span><span class="token punctuation">,</span>
            <span class="token string-property property">"problemMatcher"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5eb9ba91d33243bf86f4892f2cb9b4a0.png"/>
    </p>
    <h4>
     <a id="33__188">
     </a>
     3.3 服务部署
    </h4>
    <p>
     项目同时提供了docker-compose.yaml 和 Dockerfile，方便生成镜像部署到服务器上。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f7761697464656e672f:61727469636c652f64657461696c732f313436313538303639" class_="artid" style="display:none">
 </p>
</div>


