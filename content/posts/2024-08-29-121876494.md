---
layout: post
title: "iOS模拟器发送通知和UI测试"
date: 2024-08-29 08:49:55 +0800
description: "我们可能通过点击通知直接跳转到页面指定页面，或者点击通知打开web页面，更或者通过其他应用启动 ap"
keywords: "iosapp通知测试用例"
categories: ['测试', '开发问题踩坑', 'Ios']
tags: ['通知', 'Uitest', 'Ios']
artid: "121876494"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=121876494
    alt: "iOS模拟器发送通知和UI测试"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=121876494
featuredImagePreview: https://bing.ee123.net/img/rand?artid=121876494
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     iOS模拟器发送通知和UI测试
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p align="center">
     iOS模拟器发送通知和UI测试
    </p>
    <h3>
     <a id="_4">
     </a>
     背景
    </h3>
    <p>
     我们可能通过点击通知直接跳转到页面指定页面，或者点击通知打开web页面，更或者通过其他应用启动 app打开指定页面。面对这种跳转指定页面我们应该如何做 UI测试了？
    </p>
    <h3>
     <a id="_8">
     </a>
     向模拟器发送通知
    </h3>
    <p>
     从 Xcode11.4中，用户可以想 iOS 模拟器推送通知，包含以下两种方式：
    </p>
    <ul>
     <li>
      终端使用 Xcode 命令执行，发送通知。
     </li>
     <li>
      将 apns 文件拖放到目标模拟器。
     </li>
    </ul>
    <h4>
     <a id="apns__15">
     </a>
     apns 文件
    </h4>
    <p>
     首先我们需要定义 apns 发送文件,并命名
     <code>
      ExamplePush.apns
     </code>
     。
    </p>
    <p>
     定义格式如下：
    </p>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
   <span class="token string">"Simulator Target Bundle"</span><span class="token operator">:</span> <span class="token string">"xxxx(包名)"</span><span class="token punctuation">,</span>

   <span class="token string">"aps"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
       <span class="token string">"badge"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
       <span class="token string">"alert"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
           <span class="token string">"title"</span><span class="token operator">:</span> <span class="token string">"打开百度"</span><span class="token punctuation">,</span>
           <span class="token string">"subtitle"</span><span class="token operator">:</span> <span class="token string">"url加载测试"</span><span class="token punctuation">,</span>
           <span class="token string">"body"</span><span class="token operator">:</span> <span class="token string">"点击跳转App web 容器并且打开百度搜索"</span><span class="token punctuation">,</span>
       <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token string">"sound"</span><span class="token operator">:</span><span class="token string">"default"</span><span class="token punctuation">,</span>
   <span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token string">"route"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
       <span class="token string">"url"</span><span class="token operator">:</span><span class="token string">"https://www.baidu.com/"</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     至此，你可以填写正确的应用包名，通过拖拽到模拟器来发送通知了。
    </p>
    <h4>
     <a id="Xcode__43">
     </a>
     Xcode 命令发送
    </h4>
    <p>
     在项目已经正确配置好通知所需要的条件后，保证待测模拟器的通知权限已经开启。
    </p>
    <p>
     发送命令如下：
    </p>
    <pre><code class="prism language-shell">xcrun simctl push <span class="token operator">&lt;</span>device<span class="token operator">&gt;</span> com.example.my-app ExamplePush.apns
</code></pre>
    <p>
     如命令所见，我们需要模拟器标识符，应用包名和 apns 文件。
    </p>
    <blockquote>
     <p>
      同理，我们还可以通过
      <code>
       xcrun simctl openurl booted &lt;Universal Link&gt;
      </code>
      来发送通用链接和 scheme 跳转，请参考文章
      <a href="https://medium.com/wolox/ios-deep-linking-url-scheme-vs-universal-links-50abd3802f97" rel="nofollow">
       IOS Deep linking: URL Scheme vs Universal Links
      </a>
     </p>
    </blockquote>
    <ol>
     <li>
      获取模拟器设备标识符
     </li>
    </ol>
    <p>
     <img alt="img" src="https://i-blog.csdnimg.cn/blog_migrate/afd621d14db55d0c6027736818b6e070.gif#pic_center"/>
    </p>
    <ol start="2">
     <li>
      应用包名
     </li>
    </ol>
    <p>
     <img alt="img" src="https://i-blog.csdnimg.cn/blog_migrate/c0d723c152542f51f1bad1f953782767.png"/>
    </p>
    <p>
     在结合之前我们定义的 apns 文件，发送通知的命令如下：
    </p>
    <pre><code class="prism language-shell">xcrun simctl push 942A6B1C-BE29-4E05-A075-5146088F7C9E com.compass.MusselExample PushNotificationTest.apns
</code></pre>
    <h3>
     <a id="UI__78">
     </a>
     UI 测试发送通知
    </h3>
    <p>
     可惜的是 XCodeTest 并没有提供在测试中发送通知的方式。
    </p>
    <p>
     接下来该怎么办了？
    </p>
    <p>
     方法1:【推荐】借助其他库实现，比如
     <a href="https://github.com/UrbanCompass/Mussel">
      Mussel
     </a>
     （可以在测试用例中发送通知、Scheme Link 和通用链接，最低支持 iOS11）、
     <a href="https://github.com/noodlewerk/NWPusher">
      NWPush
     </a>
     （配置麻烦，需要各种证书，
     <a href="https://www.pixeldock.com/blog/testing-push-notifications-with-xcode-uitests/" rel="nofollow">
      教程示例
     </a>
     ）等库
    </p>
    <p>
     方法2:自己写 shell 脚本和命令
    </p>
    <h4>
     <a id="_Mussel__88">
     </a>
     使用 Mussel 发送通知
    </h4>
    <p>
     Mussel github 仓库：
     <a href="https://github.com/UrbanCompass/Mussel">
      https://github.com/UrbanCompass/Mussel
     </a>
    </p>
    <h4>
     <a id="_92">
     </a>
     自定义脚本发送通知
    </h4>
    <p>
     原理：在编译 UI测试 target 期间，添加运行脚本来发送通知
    </p>
    <p>
     缺点：每次编译都会发送通知(需要手动控制参数)
    </p>
    <h5>
     <a id="_98">
     </a>
     编写推送通知脚本
    </h5>
    <pre><code class="prism language-shell"><span class="token shebang important">#!/bin/bash</span>
<span class="token comment">#推送和通用链接</span>
<span class="token comment">#是否运行推送（以便关闭通知）1：打开 0关闭</span>
<span class="token assign-left variable">isAllowPushNotification</span><span class="token operator">=</span><span class="token number">1</span>
<span class="token comment"># 获取脚本所在路径</span>
<span class="token assign-left variable">DIR</span><span class="token operator">=</span><span class="token string">"$( cd "<span class="token variable"><span class="token variable">$(</span> <span class="token function">dirname</span> <span class="token string">"<span class="token variable">$0</span>"</span>  <span class="token variable">)</span></span>"</span> <span class="token operator">&amp;&amp;</span> <span class="token builtin class-name">pwd</span>  <span class="token punctuation">)</span>" 
<span class="token comment">#进入目录，以便发送 apns 文件</span>
<span class="token builtin class-name">echo</span> <span class="token variable">${DIR}</span>

<span class="token function-name function">pushNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment"># 模拟器 id</span>
    <span class="token assign-left variable">diviceId</span><span class="token operator">=</span>xxxxx
    <span class="token comment"># 应用包名</span>
    <span class="token assign-left variable">appName</span><span class="token operator">=</span>xxxx
    xcrun simctl push <span class="token variable">$diviceId</span> <span class="token variable">$appName</span> ./ExamplePush.apns
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$isAllowPushNotification</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
pushNotification
<span class="token keyword">fi</span>

</code></pre>
    <p>
     暂且命名为 pushNotification.sh 并把相应的权限修改了
     <code>
      chmod +x pushNotification.s
     </code>
     (不然没有执行权限)。
    </p>
    <h5>
     <a id="_UITest__126">
     </a>
     为 UITest 添加运行脚本
    </h5>
    <p>
     将所需的脚本和 apns 文件都添加到测试 target 目录下后，选中UI 测试 target。 添加脚本。
    </p>
    <p>
     <img alt="添加脚本示例" src="https://i-blog.csdnimg.cn/blog_migrate/275cae6be86a58079e3f9adbd8f55a30.png"/>
    </p>
    <p>
     这样每次编译 UI 测试 target 就会发送通知了。
    </p>
    <h3>
     <a id="_138">
     </a>
     打开通知页面的测试操作
    </h3>
    <p>
     注意：我这里为了方便测试，关闭了通知以组显示的方式。
    </p>
    <p>
     参数和setUp 方法
    </p>
    <pre><code class="prism language-objective-c">@interface OpentNotificationUITests : XCTestCase
@property(nonatomic, strong) XCUIApplication *app; //当前应用
@property(nonatomic, strong) XCUIApplication *springboard; //系统页面
@end

@implementation OpentNotificationUITests

- (void)setUp {
    // Put setup code here. This method is called before the invocation of each test method in the class.
    
    // In UI tests it is usually best to stop immediately when a failure occurs.
    self.continueAfterFailure = NO;

    // UI tests must launch the application that they test. Doing this in setup will make sure it happens for each test method.
    self.app = [[XCUIApplication alloc] init];
    self.springboard = [[XCUIApplication alloc] initWithBundleIdentifier:@"com.apple.springboard"];
    
    [self.app launch];

    // In UI tests it’s important to set the initial state - such as interface orientation - required for your tests before they run. The setUp method is a good place to do this.
}

</code></pre>
    <p>
     测试方法
    </p>
    <pre><code class="prism language-objective-c">- (void)testOpenUrlFromNotification{
    [self openNotificationCenterTitle:@"打开百度"];
    NSArray&lt;XCUIElement *&gt; *webViews = [[self.app webViews] allElementsBoundByIndex];  //业务中已处理（点击会通过 webViewController 去加载 url）
    XCTAssertTrue((webViews.count &gt;= 1), @"应该打开 web 页面"); //  或者使用XCTAssertTrue([webViews[0] waitForExistenceWithTimeout:10], @"应该打开 web 页面");
}

</code></pre>
    <p>
     辅助方法
    </p>
    <p>
     我这里是通过通知的标题来获取对应通知，然后进行点击打开。
    </p>
    <pre><code class="prism language-objective-c">#pragma mark - helper
/// 相当于按  Home 键
- (void)toHome{
    [[XCUIDevice sharedDevice] pressButton:XCUIDeviceButtonHome];
}
/// 打开通知, 注意 需要保证模拟器通知方式[取消以组显示通知]，通知 title 也需要不一致。
- (void)openNotificationCenterTitle:(NSString * _Nonnull)title {
    [self toHome];
    XCUIApplication *app = self.springboard;
    XCUICoordinate *coord1 = [app coordinateWithNormalizedOffset:CGVectorMake(0.1, 0.01)];
    XCUICoordinate *coord2 = [app coordinateWithNormalizedOffset:CGVectorMake(0.1, 0.8)];
    [coord1 pressForDuration:0.1 thenDragToCoordinate:coord2]; // 滑动显示通知
    
    
    XCUIElement *mainWindow = [[app windows] elementMatchingType:XCUIElementTypeWindow identifier:@"SBCoverSheetWindow"];
    NSArray&lt;XCUIElement *&gt; *notiCells = [[mainWindow scrollViews] allElementsBoundByIndex];
    XCUIElement *scroll = notiCells[0];
    NSArray&lt;XCUIElement *&gt; *allNotiCells = [[scroll scrollViews] allElementsBoundByIndex];
    
    XCUIElement *aimElement = nil;
    for (int i=0; i &lt; allNotiCells.count; i++) {
        XCUIElement *cell = allNotiCells[i];
        NSLog(@"cellLabel:%@",cell.label);
        if ([cell.label containsString:title]) { // title = 打开百度 这里我是通过是否包含来找到某个通知。
            aimElement = cell;
            break;
        }
    }
    XCTAssertNotNil(aimElement,@"应该存在待测通知");
    [aimElement tap];
    
    XCUICoordinate *openCoordinate = [aimElement coordinateWithNormalizedOffset:CGVectorMake(0.2, 0.35)];
    [openCoordinate tap]; // 位置点击（模拟器通知 有 open按钮，相当点击了open）
}

</code></pre>
    <p>
     消息点击效果
    </p>
    <p>
     <img alt="模拟器点击通知" src="https://i-blog.csdnimg.cn/blog_migrate/f173a9c48d6e20fae917b4ac7b9eafbe.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f31343932303633352f:61727469636c652f64657461696c732f313231383736343934" class_="artid" style="display:none">
 </p>
</div>


