---
layout: post
title: "详解小程序常见的登录方式"
date: 2023-12-05 14:57:55 +0800
description: "本文详细介绍了微信小程序的两种登录方式，包括基于openid的登录流程、获取openid的代码示例以"
keywords: "小程序登录"
categories: ['小程序', 'Vue', 'Nodejs']
tags: ['小程序', 'Notepad']
artid: "134807040"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=134807040
    alt: "详解小程序常见的登录方式"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=134807040
featuredImagePreview: https://bing.ee123.net/img/rand?artid=134807040
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     详解小程序常见的登录方式
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="1__0">
     </a>
     1. 小程序登录
    </h3>
    <p>
     小程序有两种登录方式，一种基于手机号码进行登录，另一种是使用用户在公众号下的唯一标识（openid）进行登录(小程序是公众号的一种).
    </p>
    <p>
     接下来先讲解下，基于 openid 登录。
    </p>
    <h4>
     <a id="11__openid__4">
     </a>
     1.1 基于 openid 登录
    </h4>
    <p>
     先看下图，描述通过微信小程序提供的 code 换取当前用户在小程序中的唯一标识，详细流程可以参数下图：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/61dd44d602e2f8d4574fc97ae184dc07.jpeg#pic_center"/>
    </p>
    <p>
     接下来通过代码实现下大概流程:
    </p>
    <ul>
     <li>
      获取 code
     </li>
    </ul>
    <pre><code class="prism language-js">uni<span class="token punctuation">.</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>errMsg <span class="token operator">===</span> <span class="token string">'login:ok'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">code</span><span class="token operator">:</span> res<span class="token punctuation">.</span>code<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 保存用户信息</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">fail</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    uni<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">title</span><span class="token operator">:</span> e<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      服务端接收 code 去微信后台换取对应 openid
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token comment">// nodejs 部分代码</span>
<span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> appid<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> grant_type <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config/wx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> code <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> appid<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> grant_type <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config/wx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> openid <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/sns/jscode2session'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    appid<span class="token punctuation">,</span>
    secret<span class="token punctuation">,</span>
    <span class="token literal-property property">js_code</span><span class="token operator">:</span> code<span class="token punctuation">,</span>
    grant_type<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      在数据库中查找对应 openid 是否存在
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> appid<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> grant_type <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config/wx'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 1. 获取 code</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> code <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
  <span class="token comment">// 2. 通过 code 获取 openid 和 session_key</span>
  <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> openid <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/sns/jscode2session'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    appid<span class="token punctuation">,</span>
    secret<span class="token punctuation">,</span>
    <span class="token literal-property property">js_code</span><span class="token operator">:</span> code<span class="token punctuation">,</span>
    grant_type<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3. 查找用户是否已经注册</span>
  models<span class="token punctuation">.</span>user
    <span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        openid<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 3.2 如果用户已经注册，返回用户信息</span>
        res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
          <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">data</span><span class="token operator">:</span> user<span class="token punctuation">,</span>
            <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'登录成功'</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 3.3 如果用户没有注册，创建用户并返回用户信息</span>
        <span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token function">randomUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        models<span class="token punctuation">.</span>user
          <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">nickname</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
            openid<span class="token punctuation">,</span>
            <span class="token literal-property property">avatar</span><span class="token operator">:</span> <span class="token string">'/uploads/default-avatar.png'</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
              <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">data</span><span class="token operator">:</span> user<span class="token punctuation">,</span>
                <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'登录成功'</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     上面就是一个基于
     <code>
      code
     </code>
     获取
     <code>
      openid
     </code>
     ，并通过
     <code>
      openid
     </code>
     创建新的用户，并将创建好的用户返回。
    </p>
    <p>
     为了方便理解，这里简化描述了登录逻辑。在实际业务代码中，通常会使用
     <code>
      openid
     </code>
     、
     <code>
      session key
     </code>
     和用户信息来创建自定义登录凭证（token），并在登录时将用户信息和
     <code>
      token
     </code>
     一起返回给前端。前端会将
     <code>
      token
     </code>
     存储在本地，并在下一次需要登录的业务请求中携带
     <code>
      token
     </code>
     ，从而实现业务鉴权的功能。这种方式通常使用
     <code>
      JWT（JSON Web Token）
     </code>
     等工具来实现。在后续的讲解中，我们将详细介绍这些概念和技术细节。
    </p>
    <h4>
     <a id="12__105">
     </a>
     1.2 手机号码快捷登录
    </h4>
    <p>
     获取手机号码的前提：
    </p>
    <ul>
     <li>
      非个人小程序
     </li>
     <li>
      认证的小程序
     </li>
     <li>
      非海外的企业认证
     </li>
    </ul>
    <p>
     下面是大概业务流程图：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b7037069fd182f4921ac039c3c324be0.png#pic_center"/>
    </p>
    <h5>
     <a id="121__code_116">
     </a>
     1.2.1 获取对应 code
    </h5>
    <pre><code class="prism language-vue">&lt;template&gt;
  &lt;button
    class="login-btn"
    open-type="getPhoneNumber"
    @getphonenumber="getPhoneNumber"
  &gt;
    手机号码登录
  &lt;/button&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  setup() {
    // 目前该接口针对非个人开发者，且完成了认证的小程序开放（不包含海外主体）
    const getPhoneNumber = (e) =&gt; {
      const { code, errMsg } = e.detail;
      if (errMsg === 'getPhoneNumber:ok') {
        const { data } = await loginByPhone({
          code,
        });
      } else {
        uni.showToast({
          title: errMsg,
        });
      }
    };

    return {
      getPhoneNumber,
    };
  },
};
&lt;/script&gt;
</code></pre>
    <h5>
     <a id="122__154">
     </a>
     1.2.2 后端处理逻辑
    </h5>
    <pre><code class="prism language-js"><span class="token comment">// 基于手机号登录</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/loginByPhone'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 获取 code 和 loginCode</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> code <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token comment">// 2. 获取接口调用凭据，理论上这里需要缓存 access_token，避免频繁调用接口</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> access_token <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/cgi-bin/token'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">grant_type</span><span class="token operator">:</span> <span class="token string">'client_credential'</span><span class="token punctuation">,</span>
      appid<span class="token punctuation">,</span>
      secret<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 3. 获取手机号</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> phone_info <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/wxa/business/getuserphonenumber?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">{<!-- --></span>
        code<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 4. 查找用户是否已经注册</span>
    <span class="token comment">// 4.1 根据 phone 查找用户</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> purePhoneNumber <span class="token punctuation">}</span> <span class="token operator">=</span> phone_info<span class="token punctuation">;</span>
    models<span class="token punctuation">.</span>user
      <span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          purePhoneNumber<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 4.2 如果用户已经注册，返回用户信息</span>
          res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
              <span class="token literal-property property">data</span><span class="token operator">:</span> user<span class="token punctuation">,</span>
              <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'登录成功'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 4.3 如果用户没有注册，创建用户并返回用户信息</span>
          <span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token function">randomUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          models<span class="token punctuation">.</span>user
            <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
              <span class="token literal-property property">nickname</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
              <span class="token literal-property property">avatar</span><span class="token operator">:</span> <span class="token string">'/uploads/default-avatar.png'</span><span class="token punctuation">,</span>
              <span class="token literal-property property">phone</span><span class="token operator">:</span> phone_info<span class="token punctuation">.</span>purePhoneNumber<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
              res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                  <span class="token literal-property property">data</span><span class="token operator">:</span> user<span class="token punctuation">,</span>
                  <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'登录成功'</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token string">'BIZ_ERROR'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">msg</span><span class="token operator">:</span> error<span class="token punctuation">.</span>errmsg <span class="token operator">||</span> error<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     上面代码，实现获取手机号码并使用手机号码作为唯一标识，进行用户创建和查找的操作。
    </p>
    <p>
     从登录的角度来看，使用手机号码作为唯一标识符是没有问题的。然而，如果用户尝试使用非手机号码（例如
     <code>
      OpenID
     </code>
     ）进行登录，并在数据库中找不到匹配的记录时，系统会创建一个新的账号。这可能导致同一个用户在系统中存在多个账号的情况。
    </p>
    <p>
     为了优化这种情况，可以考虑以下几种方法：
    </p>
    <ul>
     <li>
      当用户使用
      <code>
       openid
      </code>
      登录后，检测未绑定手机号码时，进行号码绑定
     </li>
     <li>
      当用户使用手机号码登录时，提前调用
      <code>
       wx.login
      </code>
      获取对应
      <code>
       code
      </code>
      ，换取
      <code>
       openid
      </code>
      把他与手机号码进行关联
     </li>
    </ul>
    <p>
     现在基于上面的代码，采用第二种方案，只需要微调下代码就能解决这个问题。
    </p>
    <ul>
     <li>
      登录时把
      <code>
       wx.login
      </code>
      获取
      <code>
       code
      </code>
      传递给后端
     </li>
    </ul>
    <pre><code class="prism language-vue">&lt;template&gt;
  &lt;button
    class="login-btn"
    open-type="getPhoneNumber"
    @getphonenumber="getPhoneNumber"
  &gt;
    手机号码登录
  &lt;/button&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  setup() {
    // 目前该接口针对非个人开发者，且完成了认证的小程序开放（不包含海外主体）
    const getPhoneNumber = (e) =&gt; {
      const { code, errMsg } = e.detail;
      if (errMsg === 'getPhoneNumber:ok') {
        uni.login({
          success: async (res) =&gt; {
            if (res.errMsg === 'login:ok') {
              const { data } = await loginByPhone({
                code,
                loginCode: res.code,
              });
              userStore.setUserInfo(data);
              uni.navigateBack();
            }
          },
          fail(e) {
            uni.showToast({
              title: e.message,
            });
          },
        });
      } else {
        uni.showToast({
          title: errMsg,
        });
      }
    };

    return {
      getPhoneNumber,
    };
  },
};
&lt;/script&gt;
</code></pre>
    <ul>
     <li>
      服务端基于 loginCode 换取 openid
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token comment">// 基于手机号登录</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/loginByPhone'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 获取 code 和 loginCode</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> code<span class="token punctuation">,</span> loginCode <span class="token punctuation">}</span> <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>

    <span class="token comment">// 2. 获取接口调用凭据，理论上这里需要缓存 access_token，避免频繁调用接口</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> access_token <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/cgi-bin/token'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">grant_type</span><span class="token operator">:</span> <span class="token string">'client_credential'</span><span class="token punctuation">,</span>
      appid<span class="token punctuation">,</span>
      secret<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 3. 获取 openid</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> openid <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'/sns/jscode2session'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      appid<span class="token punctuation">,</span>
      secret<span class="token punctuation">,</span>
      <span class="token literal-property property">js_code</span><span class="token operator">:</span> loginCode<span class="token punctuation">,</span>
      grant_type<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 4. 获取手机号</span>
    <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> phone_info <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> request<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/wxa/business/getuserphonenumber?access_token=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>access_token<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      <span class="token punctuation">{<!-- --></span>
        code<span class="token punctuation">,</span>
        openid<span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 5. 查找用户是否已经注册</span>
    <span class="token comment">// 5.1 根据 openid 查找用户</span>
    models<span class="token punctuation">.</span>user
      <span class="token punctuation">.</span><span class="token function">findOne</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">where</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          openid<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 5.2 如果用户已经注册，返回用户信息</span>
          res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
              <span class="token literal-property property">data</span><span class="token operator">:</span> user<span class="token punctuation">,</span>
              <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'登录成功'</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 5.3 如果用户没有注册，创建用户并返回用户信息</span>
          <span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token function">randomUserName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          models<span class="token punctuation">.</span>user
            <span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
              <span class="token literal-property property">nickname</span><span class="token operator">:</span> username<span class="token punctuation">,</span>
              openid<span class="token punctuation">,</span>
              <span class="token literal-property property">avatar</span><span class="token operator">:</span> <span class="token string">'/uploads/default-avatar.png'</span><span class="token punctuation">,</span>
              <span class="token literal-property property">phone</span><span class="token operator">:</span> phone_info<span class="token punctuation">.</span>purePhoneNumber<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">user</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
              res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                  <span class="token literal-property property">data</span><span class="token operator">:</span> user<span class="token punctuation">,</span>
                  <span class="token literal-property property">msg</span><span class="token operator">:</span> <span class="token string">'登录成功'</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
              <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>
      <span class="token keyword">new</span> <span class="token class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">code</span><span class="token operator">:</span> <span class="token string">'BIZ_ERROR'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">msg</span><span class="token operator">:</span> error<span class="token punctuation">.</span>errmsg <span class="token operator">||</span> error<span class="token punctuation">.</span>message<span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     这种方案被视为最佳的解决方案，能够有效解决多账号和绑定手机号码等问题。 实际上，采用哪种方式取决于具体的业务场景，因为在某些情况下，用户可能会担心手机号码泄露而不愿采用这种方式。
    </p>
    <h5>
     <a id="123__369">
     </a>
     1.2.3 注意
    </h5>
    <ul>
     <li>
      获取手机号码是需要收费，每次调用需要
      <code>
       0.03
      </code>
      元。
     </li>
     <li>
      <code>
       wx.login
      </code>
      与
      <code>
       getPhoneNumber
      </code>
      中获取的
      <code>
       code
      </code>
      不是同一个
     </li>
    </ul>
    <h3>
     <a id="_374">
     </a>
     总结
    </h3>
    <ul>
     <li>
      基于 openid 或 手机号码快捷登录
     </li>
     <li>
      获取手机号码前置条件
     </li>
     <li>
      如何解决多账号的问题
     </li>
     <li>
      讲解前端、后端、微信登录过程中完整交互流程，方便更好去理解小程序登录
     </li>
    </ul>
    <p>
     <strong>
      如果您有任何疑问，请随时在评论区留言。
     </strong>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f31363539333933392f:61727469636c652f64657461696c732f313334383037303430" class_="artid" style="display:none">
 </p>
</div>


