---
layout: post
title: "AgentOpenManus-Prompt组件详细分析"
date: 2025-03-16 23:45:43 +0800
description: "openManus Prompt组件的详细分析"
keywords: "【Agent】OpenManus-Prompt组件详细分析"
categories: ['Ai']
tags: ['架构', 'Prompt', 'Openmanus', 'Manus', 'Ai', 'Agi', 'Agent']
artid: "146304050"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146304050
    alt: "AgentOpenManus-Prompt组件详细分析"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146304050
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146304050
cover: https://bing.ee123.net/img/rand?artid=146304050
image: https://bing.ee123.net/img/rand?artid=146304050
img: https://bing.ee123.net/img/rand?artid=146304050
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【Agent】OpenManus-Prompt组件详细分析
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="1__0">
     </a>
     1. 提示词架构概述
    </h3>
    <p>
     OpenManus 的提示词组件采用了模块化设计，为不同类型的智能体提供专门的提示词模板。每个提示词模块通常包含两种核心提示词：系统提示词（System Prompt）和下一步提示词（Next Step Prompt）。这种设计使得提示词可以独立于智能体代码进行管理和优化，同时保持了提示词与智能体之间的紧密集成。
    </p>
    <h3>
     <a id="2__4">
     </a>
     2. 提示词类型与设计
    </h3>
    <h4>
     <a id="21__System_Prompt_6">
     </a>
     2.1 系统提示词 (System Prompt)
    </h4>
    <p>
     <strong>
      设计特点
     </strong>
     ：
    </p>
    <ul>
     <li>
      定义智能体的角色、能力和行为边界
     </li>
     <li>
      设置智能体的整体行为模式和交互风格
     </li>
     <li>
      通常较为简洁，专注于角色定义
     </li>
     <li>
      在智能体初始化时设置，整个会话期间保持不变
     </li>
    </ul>
    <p>
     <strong>
      使用场景
     </strong>
     ：
    </p>
    <ul>
     <li>
      在智能体初始化时设置基础行为模式
     </li>
     <li>
      在 LLM 调用时作为系统消息传递
     </li>
    </ul>
    <h4>
     <a id="22__Next_Step_Prompt_18">
     </a>
     2.2 下一步提示词 (Next Step Prompt)
    </h4>
    <p>
     <strong>
      设计特点
     </strong>
     ：
    </p>
    <ul>
     <li>
      指导智能体在每个步骤中的决策和行动
     </li>
     <li>
      提供可用工具的详细说明和使用指南
     </li>
     <li>
      通常较为详细，包含具体指令和约束
     </li>
     <li>
      在每个思考步骤中使用，可以动态更新
     </li>
    </ul>
    <p>
     <strong>
      使用场景
     </strong>
     ：
    </p>
    <ul>
     <li>
      在每个
      <code>
       think
      </code>
      方法调用前添加到消息历史
     </li>
     <li>
      引导智能体选择合适的工具和行动
     </li>
     <li>
      提供上下文信息和决策指南
     </li>
    </ul>
    <h4>
     <a id="23__Template_Prompt_31">
     </a>
     2.3 模板提示词 (Template Prompt)
    </h4>
    <p>
     <strong>
      设计特点
     </strong>
     ：
    </p>
    <ul>
     <li>
      包含占位符，可以在运行时动态填充
     </li>
     <li>
      支持格式化字符串语法
     </li>
     <li>
      适用于需要动态内容的场景
     </li>
    </ul>
    <p>
     <strong>
      使用场景
     </strong>
     ：
    </p>
    <ul>
     <li>
      SWE 智能体中的工作目录和文件信息
     </li>
     <li>
      规划流程中的步骤执行提示
     </li>
    </ul>
    <h3>
     <a id="3__42">
     </a>
     3. 提示词调用流程
    </h3>
    <h4>
     <a id="31__44">
     </a>
     3.1 智能体初始化
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># 在智能体类定义中设置提示词</span>
<span class="token keyword">class</span> <span class="token class-name">Manus</span><span class="token punctuation">(</span>ToolCallAgent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    system_prompt<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> SYSTEM_PROMPT
    next_step_prompt<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> NEXT_STEP_PROMPT
</code></pre>
    <ol>
     <li>
      提示词常量从相应模块导入
     </li>
     <li>
      在智能体类定义中设置为类属性
     </li>
     <li>
      可以在子类中覆盖或扩展
     </li>
    </ol>
    <h4>
     <a id="32__57">
     </a>
     3.2 思考过程中的提示词使用
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># ToolCallAgent.think 方法中的提示词使用</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">think</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> self<span class="token punctuation">.</span>next_step_prompt<span class="token punctuation">:</span>
        user_msg <span class="token operator">=</span> Message<span class="token punctuation">.</span>user_message<span class="token punctuation">(</span>self<span class="token punctuation">.</span>next_step_prompt<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>messages <span class="token operator">+=</span> <span class="token punctuation">[</span>user_msg<span class="token punctuation">]</span>
    
    response <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>ask_tool<span class="token punctuation">(</span>
        messages<span class="token operator">=</span>self<span class="token punctuation">.</span>messages<span class="token punctuation">,</span>
        system_msgs<span class="token operator">=</span><span class="token punctuation">[</span>Message<span class="token punctuation">.</span>system_message<span class="token punctuation">(</span>self<span class="token punctuation">.</span>system_prompt<span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>system_prompt
        <span class="token keyword">else</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        tools<span class="token operator">=</span>self<span class="token punctuation">.</span>available_tools<span class="token punctuation">.</span>to_params<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        tool_choice<span class="token operator">=</span>self<span class="token punctuation">.</span>tool_choices<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre>
    <ol>
     <li>
      如果存在下一步提示词，创建用户消息并添加到消息历史
     </li>
     <li>
      调用 LLM 时，将系统提示词作为系统消息传递
     </li>
     <li>
      同时传递工具参数和工具选择模式
     </li>
    </ol>
    <h4>
     <a id="33__80">
     </a>
     3.3 动态提示词处理
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># SWEAgent.think 方法中的动态提示词处理</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">think</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    <span class="token comment"># Update working directory</span>
    self<span class="token punctuation">.</span>working_dir <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>bash<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"pwd"</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>next_step_prompt <span class="token operator">=</span> self<span class="token punctuation">.</span>next_step_prompt<span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
        current_dir<span class="token operator">=</span>self<span class="token punctuation">.</span>working_dir
    <span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>think<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <ol>
     <li>
      获取当前工作目录
     </li>
     <li>
      使用 format 方法填充提示词模板中的占位符
     </li>
     <li>
      调用父类的 think 方法继续处理
     </li>
    </ol>
    <h4>
     <a id="34__98">
     </a>
     3.4 规划流程中的提示词使用
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># PlanningFlow._create_initial_plan 方法中的提示词使用</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_create_initial_plan</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> request<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
    <span class="token comment"># Create a system message for plan creation</span>
    system_message <span class="token operator">=</span> Message<span class="token punctuation">.</span>system_message<span class="token punctuation">(</span>
        <span class="token string">"You are a planning assistant. Create a concise, actionable plan with clear steps. "</span>
        <span class="token string">"Focus on key milestones rather than detailed sub-steps. "</span>
        <span class="token string">"Optimize for clarity and efficiency."</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># Create a user message with the request</span>
    user_message <span class="token operator">=</span> Message<span class="token punctuation">.</span>user_message<span class="token punctuation">(</span>
        <span class="token string-interpolation"><span class="token string">f"Create a reasonable plan with clear steps to accomplish the task: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>request<span class="token punctuation">}</span></span><span class="token string">"</span></span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># Call LLM with PlanningTool</span>
    response <span class="token operator">=</span> <span class="token keyword">await</span> self<span class="token punctuation">.</span>llm<span class="token punctuation">.</span>ask_tool<span class="token punctuation">(</span>
        messages<span class="token operator">=</span><span class="token punctuation">[</span>user_message<span class="token punctuation">]</span><span class="token punctuation">,</span>
        system_msgs<span class="token operator">=</span><span class="token punctuation">[</span>system_message<span class="token punctuation">]</span><span class="token punctuation">,</span>
        tools<span class="token operator">=</span><span class="token punctuation">[</span>self<span class="token punctuation">.</span>planning_tool<span class="token punctuation">.</span>to_param<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        tool_choice<span class="token operator">=</span>ToolChoice<span class="token punctuation">.</span>REQUIRED<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre>
    <ol>
     <li>
      创建特定于任务的系统消息
     </li>
     <li>
      创建包含用户请求的用户消息
     </li>
     <li>
      调用 LLM 时传递这些消息和工具参数
     </li>
    </ol>
    <h3>
     <a id="4_LLM__128">
     </a>
     4. LLM 接口中的提示词处理
    </h3>
    <h4>
     <a id="41__130">
     </a>
     4.1 消息格式化
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># LLM.ask 方法中的消息处理</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">ask</span><span class="token punctuation">(</span>
    self<span class="token punctuation">,</span>
    messages<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Union<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">,</span> Message<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    system_msgs<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>Union<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">,</span> Message<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    stream<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
    temperature<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
    <span class="token comment"># Format system and user messages</span>
    <span class="token keyword">if</span> system_msgs<span class="token punctuation">:</span>
        system_msgs <span class="token operator">=</span> self<span class="token punctuation">.</span>format_messages<span class="token punctuation">(</span>system_msgs<span class="token punctuation">)</span>
        messages <span class="token operator">=</span> system_msgs <span class="token operator">+</span> self<span class="token punctuation">.</span>format_messages<span class="token punctuation">(</span>messages<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        messages <span class="token operator">=</span> self<span class="token punctuation">.</span>format_messages<span class="token punctuation">(</span>messages<span class="token punctuation">)</span>
</code></pre>
    <ol>
     <li>
      接收消息和系统消息作为参数
     </li>
     <li>
      使用 format_messages 方法将消息转换为标准格式
     </li>
     <li>
      将系统消息添加到消息列表的开头
     </li>
    </ol>
    <h4>
     <a id="42__153">
     </a>
     4.2 工具调用提示词处理
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># LLM.ask_tool 方法中的工具提示词处理</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">ask_tool</span><span class="token punctuation">(</span>
    self<span class="token punctuation">,</span>
    messages<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Union<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">,</span> Message<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    system_msgs<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>Union<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">,</span> Message<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    timeout<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">,</span>
    tools<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span><span class="token builtin">dict</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    tool_choice<span class="token punctuation">:</span> TOOL_CHOICE_TYPE <span class="token operator">=</span> ToolChoice<span class="token punctuation">.</span>AUTO<span class="token punctuation">,</span>
    temperature<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    <span class="token operator">**</span>kwargs<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 类似的消息处理逻辑</span>
    <span class="token comment"># 加上工具参数和工具选择模式</span>
    <span class="token keyword">if</span> system_msgs<span class="token punctuation">:</span>
        system_msgs <span class="token operator">=</span> self<span class="token punctuation">.</span>format_messages<span class="token punctuation">(</span>system_msgs<span class="token punctuation">)</span>
        messages <span class="token operator">=</span> system_msgs <span class="token operator">+</span> self<span class="token punctuation">.</span>format_messages<span class="token punctuation">(</span>messages<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        messages <span class="token operator">=</span> self<span class="token punctuation">.</span>format_messages<span class="token punctuation">(</span>messages<span class="token punctuation">)</span>
</code></pre>
    <ol>
     <li>
      与 ask 方法类似的消息处理
     </li>
     <li>
      额外传递工具参数和工具选择模式
     </li>
     <li>
      支持超时和温度等参数
     </li>
    </ol>
    <hr/>
    <p>
     OpenManus 的提示词组件设计了一个灵活、模块化的提示词。通过将提示词与代码分离，同时保持紧密集成，它实现了提示词的可维护性和可扩展性。系统提示词和下一步提示词的组合，加上动态模板能力，使智能体能够适应各种任务和环境，同时保持一致的行为模式和交互风格。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34303234323834352f:61727469636c652f64657461696c732f313436333034303530" class_="artid" style="display:none">
 </p>
</div>


