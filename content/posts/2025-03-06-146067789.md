---
layout: post
title: "实战指南构建高可用生产级Kafka集群的完整教程"
date: 2025-03-06 13:28:08 +0800
description: "本文详细讲解了从零开始部署多节点Kafka集群的全流程，涵盖环境准备、ZooKeeper集群搭建、Kafka多节点配置、性能优化、监控集成及容灾验证等关键环节。教程以3台服务器为例，指导用户完成ZooKeeper集群的选举配置与同步测试，并通过调整server.properties实现Kafka节点的协同工作。文章重点解析了参数优化技巧（如JVM调优、网络线程配置）以提升集群性能，并引入EFAK可视化工具实现集群状态监控。此外，通过模拟Broker宕机、数据持久化验证及分区恢复测试，确保集群的高可用性与容灾"
keywords: "实战指南：构建高可用生产级Kafka集群的完整教程"
categories: ['Linux', 'Devops']
tags: ['分布式', 'Zookeeper', 'Linq', 'Kafka', 'Efak']
artid: "146067789"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146067789
    alt: "实战指南构建高可用生产级Kafka集群的完整教程"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146067789
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146067789
cover: https://bing.ee123.net/img/rand?artid=146067789
image: https://bing.ee123.net/img/rand?artid=146067789
img: https://bing.ee123.net/img/rand?artid=146067789
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     实战指南：构建高可用生产级Kafka集群的完整教程
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <br/>
    <img alt="" height="120" src="https://i-blog.csdnimg.cn/img_convert/d5c972ce42e8b2c88ad860580cb3ef89.gif#pic_center" width="120">
     <p>
     </p>
     <blockquote>
      <p>
       前文教程：
       <a href="https://blog.csdn.net/qq_43479188/article/details/146017446?spm=1001.2014.3001.5502">
        Apache Kafka单节点极速部署指南：10分钟搭建开发单节点环境-CSDN博客
       </a>
      </p>
     </blockquote>
     <h4>
      <a id="_Kafka__4">
      </a>
      <strong>
       一、多节点 Kafka 集群部署
      </strong>
     </h4>
     <h5>
      <a id="1__6">
      </a>
      1. 环境准备
     </h5>
     <blockquote>
      <p>
       此处需注意，如已经安装测试过
       <code>
        Kafka
       </code>
       单节点，请在安装集群之前清空之前配置的目录
      </p>
      <pre><code>sudo rm -r /var/lib/zookeeper
sudo rm -r /var/lib/kafka-logs
sudo mkdir -p /var/lib/{zookeeper,kafka-logs}
sudo chown -R kafka:kafka /var/lib/{zookeeper,kafka-logs} /opt/kafka
</code></pre>
     </blockquote>
     <ul>
      <li>
       <strong>
        3台服务器
       </strong>
       ：假设 IP 为
       <code>
        192.168.1.101
       </code>
       ,
       <code>
        192.168.1.102
       </code>
       ,
       <code>
        192.168.1.103
       </code>
      </li>
      <li>
       <strong>
        统一安装 Kafka
       </strong>
       ：在每台服务器重复 之前的安装步骤，但是暂时不启动各个服务，确保路径一致（如
       <code>
        /opt/kafka
       </code>
       ）
      </li>
      <li>
       <strong>
        同步配置
       </strong>
       ：确保所有节点配置文件的
       <code>
        zookeeper.connect
       </code>
       指向相同的
       <code>
        ZooKeeper
       </code>
       集群
      </li>
     </ul>
     <h5>
      <a id="2_ZooKeeper__21">
      </a>
      2. ZooKeeper 集群配置
     </h5>
     <ol>
      <li>
       <p>
        <strong>
         每台
         <code>
          ZooKeeper
         </code>
         节点配置
        </strong>
       </p>
       <p>
        <code>
         config/zookeeper.properties
        </code>
       </p>
       <pre><code class="prism language-properties"># 基础时间单位（毫秒），默认 2000
tickTime=2000

# Leader 等待 Follower 初始连接的最长时间（tickTime 的倍数）
initLimit=5

# Leader 与 Follower 心跳同步的最大延迟时间（tickTime 的倍数）
syncLimit=2

# 其他原有配置保持不变
dataDir=/var/lib/zookeeper
clientPort=2181
maxClientCnxns=0
admin.enableServer=false
# 集群节点列表（所有 ZooKeeper 节点需一致）
server.1=192.168.1.101:2888:3888
server.2=192.168.1.102:2888:3888
server.3=192.168.1.103:2888:3888
</code></pre>
      </li>
      <li>
       <p>
        <strong>
         创建
         <code>
          myid
         </code>
         文件
        </strong>
        （每个节点唯一）：
       </p>
       <pre><code class="prism language-bash"><span class="token comment"># 在 192.168.1.101 上执行</span>
<span class="token builtin class-name">echo</span> <span class="token string">"1"</span> <span class="token operator">&gt;</span> /var/lib/zookeeper/myid

<span class="token comment"># 在 192.168.1.102 上执行</span>
<span class="token builtin class-name">echo</span> <span class="token string">"2"</span> <span class="token operator">&gt;</span> /var/lib/zookeeper/myid

<span class="token comment"># 在 192.168.1.103 上执行</span>
<span class="token builtin class-name">echo</span> <span class="token string">"3"</span> <span class="token operator">&gt;</span> /var/lib/zookeeper/myid
</code></pre>
       <p>
        此处要确认
        <code>
         myid
        </code>
        ，对于用户
        <code>
         kafka
        </code>
        有权限。
       </p>
       <p>
        <img alt="image-20250304181404183" src="https://i-blog.csdnimg.cn/img_convert/0babe8b5344048fd6efb53d8a9618bf0.png"/>
       </p>
      </li>
      <li>
       <p>
        <strong>
         启动
         <code>
          ZooKeeper
         </code>
         集群
        </strong>
        ：
       </p>
       <pre><code class="prism language-bash"><span class="token comment"># 所有节点执行</span>
<span class="token function">sudo</span> systemctl start zookeeper
<span class="token comment"># 检查集群状态（任一节点执行）</span>
<span class="token builtin class-name">echo</span> srvr <span class="token operator">|</span> <span class="token function">nc</span> <span class="token operator">&lt;</span>服务器IP<span class="token operator">&gt;</span> <span class="token number">2181</span> <span class="token operator">|</span> <span class="token function">grep</span> Mode
<span class="token comment"># 应输出 "leader" 或 "follower"</span>
</code></pre>
       <p>
        <img alt="img_v3_02k3_727f6e38-598c-47c5-b5da-2f7c2c938a3g" src="https://i-blog.csdnimg.cn/img_convert/42907ab1495a01a3706825d83fd79098.jpeg"/>
       </p>
       <p>
        <img alt="img_v3_02k3_8f01b6f5-202c-47a0-b59e-61de268511fg" src="https://i-blog.csdnimg.cn/img_convert/fe569e42dbdbd0245b912c373c50c357.jpeg"/>
       </p>
      </li>
      <li>
       <p>
        <strong>
         测试集群是否创建成功
        </strong>
       </p>
       <pre><code class="prism language-bash"><span class="token comment">#模拟选举事件</span>
<span class="token comment"># 停止当前 Leader</span>
<span class="token function">sudo</span> systemctl stop zookeeper

<span class="token comment"># 查看其他节点日志</span>
<span class="token builtin class-name">echo</span> srvr <span class="token operator">|</span> <span class="token function">nc</span> <span class="token operator">&lt;</span>服务器IP<span class="token operator">&gt;</span> <span class="token number">2181</span> <span class="token operator">|</span> <span class="token function">grep</span> Mode
</code></pre>
       <p>
        <img alt="img_v3_02k3_d0453183-b72c-486f-a394-6bace7d388fg" src="https://i-blog.csdnimg.cn/img_convert/4faa656d5285cfdc998189afef812307.jpeg"/>
       </p>
       <p>
        可以看到
        <code>
         Leader
        </code>
        已经从133转到了134节点。
       </p>
       <pre><code class="prism language-bash"><span class="token comment">#数据同步验证</span>
<span class="token comment">#在Leader节点创建临时节点并写入数据data</span>
/opt/kafka/bin/zookeeper-shell.sh <span class="token number">192.168</span>.6.134:2181 <span class="token operator">&lt;&lt;&lt;</span> <span class="token string">"create -e /test-node 'data'"</span>
<span class="token comment">## 在 Follower 节点检查数据</span>
/opt/kafka/bin/zookeeper-shell.sh <span class="token number">192.168</span>.6.133:2181 <span class="token operator">&lt;&lt;&lt;</span> <span class="token string">"get /test-node"</span>
</code></pre>
       <p>
        <img alt="img_v3_02k3_05158fc0-be96-412e-b1c5-7719a89560cg" src="https://i-blog.csdnimg.cn/img_convert/21efa5cc863147bd9b49ddb4eba53654.jpeg"/>
       </p>
       <p>
        <img alt="img_v3_02k3_a4435d6f-8aae-43fe-8d44-a915b092026g" src="https://i-blog.csdnimg.cn/img_convert/08398ee4fe8d16ee6508e43ad8dd8e48.jpeg"/>
       </p>
      </li>
     </ol>
     <h5>
      <a id="3_Kafka__106">
      </a>
      3. Kafka 集群配置
     </h5>
     <ol>
      <li>
       <p>
        <strong>
         修改每台
         <code>
          Kafka
         </code>
         节点的
         <code>
          server.properties
         </code>
        </strong>
        ：
        <br/>
        此处的其他配置于上一个教程一样即可。
       </p>
       <pre><code class="prism language-properties"># 节点1 (192.168.1.101)
broker.id=1
listeners=PLAINTEXT://192.168.1.101:9092
advertised.listeners=PLAINTEXT://192.168.1.101:9092
zookeeper.connect=192.168.1.101:2181,192.168.1.102:2181,192.168.1.103:2181

# 节点2 (192.168.1.102)
broker.id=2
listeners=PLAINTEXT://192.168.1.102:9092
advertised.listeners=PLAINTEXT://192.168.1.102:9092
zookeeper.connect=同上

# 节点3 (192.168.1.103)
broker.id=3
listeners=PLAINTEXT://192.168.1.103:9092
advertised.listeners=PLAINTEXT://192.168.1.103:9092
zookeeper.connect=同上
</code></pre>
       <p>
        <strong>
         关键参数解释
        </strong>
        ：
       </p>
       <ul>
        <li>
         <code>
          advertised.listeners
         </code>
         ：客户端实际连接的地址（如果跨网络需配置公网IP或域名）
        </li>
        <li>
         <code>
          zookeeper.connect
         </code>
         ：所有
         <code>
          ZooKeeper
         </code>
         节点地址，用逗号分隔
        </li>
       </ul>
      </li>
      <li>
       <p>
        <strong>
         启动
         <code>
          Kafka
         </code>
         集群
        </strong>
        ：
       </p>
       <pre><code class="prism language-bash"><span class="token comment"># 所有节点执行</span>
<span class="token function">sudo</span> systemctl start kafka

<span class="token comment"># 检查 Broker 是否注册到 ZooKeeper</span>
/opt/kafka/bin/zookeeper-shell.sh <span class="token operator">&lt;</span>服务器IP<span class="token operator">&gt;</span>:2181 <span class="token function">ls</span> /brokers/ids
<span class="token comment"># 应输出 [1,2,3]</span>
</code></pre>
       <p>
        <img alt="image-20250305111129936" src="https://i-blog.csdnimg.cn/img_convert/02e66f297d0bb3d8cd9dab19f98f5a4d.png"/>
       </p>
      </li>
      <li>
       <p>
        <strong>
         创建 Topic（验证集群）
        </strong>
        ：
       </p>
       <pre><code class="prism language-bash"><span class="token comment"># 在任意节点执行</span>
/opt/kafka/bin/kafka-topics.sh <span class="token parameter variable">--create</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--topic</span> cluster-test <span class="token punctuation">\</span>
  --bootstrap-server <span class="token number">192.168</span>.1.101:9092 <span class="token punctuation">\</span>
  <span class="token parameter variable">--partitions</span> <span class="token number">3</span> <span class="token punctuation">\</span>
  --replication-factor <span class="token number">3</span>  <span class="token comment"># 副本数≤Broker数量</span>

<span class="token comment"># 查看 Topic 详情</span>
/opt/kafka/bin/kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--topic</span> cluster-test <span class="token punctuation">\</span>
  --bootstrap-server <span class="token number">192.168</span>.1.101:9092
</code></pre>
       <p>
        <strong>
         期望输出
        </strong>
        ：每个分区的
        <code>
         Leader
        </code>
        和
        <code>
         Replicas
        </code>
        分布在多个 Broker 上。
       </p>
      </li>
     </ol>
     <hr/>
     <h4>
      <a id="_169">
      </a>
      <strong>
       二、性能调优
      </strong>
     </h4>
     <h5>
      <a id="1_JVM__171">
      </a>
      1. JVM 参数优化
     </h5>
     <p>
      编辑 Kafka 启动脚本
      <code>
       bin/kafka-server-start.sh
      </code>
      ：
     </p>
     <pre><code class="prism language-bash"><span class="token comment"># 修改这一行</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">KAFKA_HEAP_OPTS</span><span class="token operator">=</span><span class="token string">"-Xms3G -Xmx3G -XX:MetaspaceSize=96m -XX:+UseG1GC"</span>
</code></pre>
     <ul>
      <li>
       <code>
        Xms/Xmx
       </code>
       ：堆内存（建议不超过物理内存的 50%）
      </li>
      <li>
       <code>
        UseG1GC
       </code>
       ：G1 垃圾回收器（适合大内存）
      </li>
     </ul>
     <h5>
      <a id="2_Kafka__183">
      </a>
      2. Kafka 参数优化
     </h5>
     <pre><code class="prism language-properties"># server.properties
num.network.threads=8  # 网络线程数（默认3）
num.io.threads=16      # IO 线程数（默认8）
log.flush.interval.messages=10000  # 累积多少消息后刷盘
log.flush.interval.ms=1000         # 最多等待多久刷盘
</code></pre>
     <hr/>
     <h4>
      <a id="_195">
      </a>
      <strong>
       三、集群监控与管理
      </strong>
     </h4>
     <h5>
      <a id="1__EFAKkafka_eagle_197">
      </a>
      1. 使用 EFAK（kafka eagle）（可视化工具）
     </h5>
     <ol>
      <li>
       <p>
        <strong>
         安装
        </strong>
        ：
       </p>
       <p>
        访问官网下载安装包：
        <a href="https://www.kafka-eagle.org/" rel="nofollow">
         EFAK
        </a>
       </p>
       <p>
        <img alt="image-20250306104505835" src="https://i-blog.csdnimg.cn/img_convert/c517ac734b0dd70e8b4152a5104bb7bc.png"/>
       </p>
       <p>
        下载后上传至服务器解压
       </p>
       <pre><code class="prism language-bash"><span class="token function">tar</span> <span class="token parameter variable">-zvxf</span> kafka-eagle-bin-3.0.1.tar.gz
<span class="token builtin class-name">cd</span> kafka-eagle-bin-3.0.1/
<span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> efak-web-3.0.1-bin.tar.gz
<span class="token function">mv</span> efak-web-3.0.1 /opt/efak
</code></pre>
      </li>
      <li>
       <p>
        <strong>
         配置
         <code>
          Mysql
         </code>
         用来储存元数据
        </strong>
        ：
       </p>
       <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> ke_paco <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">DEFAULT</span> <span class="token keyword">COLLATE</span> utf8_general_ci<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">USER</span> <span class="token string">'ke_paco'</span><span class="token variable">@'%'</span> IDENTIFIED <span class="token keyword">BY</span> <span class="token string">'paco123'</span><span class="token punctuation">;</span>
<span class="token keyword">GRANT</span> <span class="token keyword">ALL</span> <span class="token keyword">PRIVILEGES</span> <span class="token keyword">ON</span> ke_paco<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">TO</span> <span class="token string">'ke_paco'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>
FLUSH <span class="token keyword">PRIVILEGES</span><span class="token punctuation">;</span> <span class="token comment">-- 刷新权限生效</span>
</code></pre>
      </li>
      <li>
       <p>
        <strong>
         设置环境变量
        </strong>
        ：
       </p>
       <pre><code class="prism language-bash"><span class="token function">vim</span> /etc/profile
</code></pre>
       <p>
        写入如下内容，配置
        <code>
         jdk
        </code>
        和
        <code>
         EFAK
        </code>
        的环境变量：
       </p>
       <pre><code class="prism language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">KE_HOME</span><span class="token operator">=</span>/opt/efak
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$KE_HOME</span>/bin

<span class="token builtin class-name">export</span> <span class="token assign-left variable">JAVA_HOME</span><span class="token operator">=</span>/usr/lib/jvm/java-11-openjdk-amd64
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token environment constant">$PATH</span>
</code></pre>
      </li>
      <li>
       <p>
        <strong>
         修改配置文件
        </strong>
       </p>
       <pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /opt/efak/conf
<span class="token function">vim</span> system-config.properties
</code></pre>
       <p>
        配置
        <code>
         zookeeper
        </code>
        地址：
       </p>
       <pre><code class="prism language-properties">efak.zk.cluster.alias=cluster1
cluster1.zk.list=192.168.6.131:2181,192.168.6.133:2181,192.168.6.134:2181
</code></pre>
       <p>
        此处建议复制kafka配置文件的zookeeper配置。
       </p>
       <p>
        配置
        <code>
         Mysql
        </code>
        :
       </p>
       <pre><code class="prism language-properties">efak.driver=com.mysql.cj.jdbc.Driver
efak.url=jdbc:mysql://&lt;mysql ip&gt;:3306/ke_paco?useUnicode=true&amp;characterEncoding=UTF-8&amp;zeroDateTimeBehavior=convertToNull
efak.username=ke_paco
efak.password=paco123
</code></pre>
      </li>
      <li>
       <p>
        <strong>
         开启JMX监控
        </strong>
        <br/>
        修改
        <code>
         Kafka
        </code>
        启动配置，参考如下，按自己需要修改：
       </p>
       <pre><code class="prism language-bash"><span class="token function">vi</span> /opt/kafka/bin/kafka-server-start.sh
</code></pre>
       <pre><code class="prism language-properties">    export KAFKA_HEAP_OPTS="-server -Xms2G -Xmx2G -XX:PermSize=128m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=8 -XX:ConcGCThreads=5 -XX:InitiatingHeapOccupancyPercent=70 -Djava.rmi.server.hostname=&lt;改为当前节点IP&gt; -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=9999 -Dcom.sun.management.jmxremote.local.only=false -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false"
    export JMX_PORT="9999"
</code></pre>
       <p>
        <img alt="image-20250306111826958" src="https://i-blog.csdnimg.cn/img_convert/ccd371e880afffff9c168dd5f2a424b8.png"/>
       </p>
      </li>
      <li>
       <p>
        <strong>
         启动EFAK
        </strong>
        <br/>
        如若Kakfa未作任何其他配置，则可直接启动
       </p>
       <pre><code>$KE_HOME/bin/ke.sh start
</code></pre>
       <p>
        启动成功后如图：
       </p>
       <p>
        <img alt="image-20250306114521739" src="https://i-blog.csdnimg.cn/img_convert/8a6d93b3b51d307f31f958e6de152686.png"/>
       </p>
       <p>
        访问UI界面：
       </p>
       <p>
        <img alt="img_v3_02k4_c4694e2d-5c4d-47b4-b37f-8fc8ec75303g" src="https://i-blog.csdnimg.cn/img_convert/fca2ad17511845eb20c3860a9dacd300.jpeg"/>
       </p>
       <p>
        <img alt="img_v3_02k4_fcd27012-fa82-4d39-9f37-dab21e3c00cg" src="https://i-blog.csdnimg.cn/img_convert/bed0daf9a52c3396223ccf4e9b7237a3.jpeg"/>
       </p>
       <p>
        <img alt="image-20250306114509512" src="https://i-blog.csdnimg.cn/img_convert/fe812ecec8b4539e65437fbd0c1d691a.png"/>
       </p>
      </li>
     </ol>
     <hr/>
     <h4>
      <a id="_299">
      </a>
      <strong>
       四、灾难恢复验证
      </strong>
     </h4>
     <ol>
      <li>
       <p>
        <strong>
         创建 Topic
        </strong>
        <br/>
        在 Kafka 集群中创建一个测试 Topic，用于后续的测试。
       </p>
       <pre><code class="prism language-bash"><span class="token comment"># 创建 Topic，指定分区数和副本因子</span>
/opt/kafka/bin/kafka-topics.sh <span class="token parameter variable">--create</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--topic</span> cluster-test <span class="token punctuation">\</span>
  --bootstrap-server <span class="token number">192.168</span>.6.131:9092 <span class="token punctuation">\</span>
  <span class="token parameter variable">--partitions</span> <span class="token number">3</span> <span class="token punctuation">\</span>
  --replication-factor <span class="token number">2</span>

<span class="token comment"># 查看 Topic 详情，确认创建成功</span>
/opt/kafka/bin/kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--topic</span> cluster-test <span class="token punctuation">\</span>
  --bootstrap-server <span class="token number">192.168</span>.6.131:9092
</code></pre>
       <p>
        <strong>
         输出示例
        </strong>
        ：
        <br/>
        <img alt="835bfce2-a162-4cb5-8f8b-59c4e5625983" src="https://i-blog.csdnimg.cn/img_convert/0672288a61343df474b070b9c2029a23.jpeg"/>
       </p>
      </li>
      <li>
       <p>
        <strong>
         写入消息
        </strong>
        <br/>
        向 Topic 中写入测试消息，用于验证数据持久化和消费。
        <br/>
        <strong>
         操作步骤
        </strong>
        ：
       </p>
       <pre><code class="prism language-bash"><span class="token comment"># 使用 kafka-console-producer 写入消息</span>
<span class="token builtin class-name">echo</span> <span class="token string">"test message 1"</span> <span class="token operator">|</span> /opt/kafka/bin/kafka-console-producer.sh <span class="token punctuation">\</span>
  <span class="token parameter variable">--topic</span> cluster-test <span class="token punctuation">\</span>
  --bootstrap-server <span class="token number">192.168</span>.6.131:9092

<span class="token comment"># 写入多条消息</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">..</span><span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token keyword">do</span>
  <span class="token builtin class-name">echo</span> <span class="token string">"test message <span class="token variable">$i</span>"</span> <span class="token operator">|</span> /opt/kafka/bin/kafka-console-producer.sh <span class="token punctuation">\</span>
    <span class="token parameter variable">--topic</span> cluster-test <span class="token punctuation">\</span>
    --bootstrap-server <span class="token number">192.168</span>.6.131:9092
<span class="token keyword">done</span>
</code></pre>
       <p>
        <img alt="f8392450-0e53-4e78-91c8-612661727aa6" src="https://i-blog.csdnimg.cn/img_convert/eb34733f7d65aa6e325f82f3a716dd6d.jpeg"/>
       </p>
      </li>
      <li>
       <p>
        <strong>
         消费消息
        </strong>
        <br/>
        启动一个消费者（任意其他节点），验证消息是否成功写入。
        <br/>
        <strong>
         操作步骤
        </strong>
        ：
       </p>
       <pre><code class="prism language-bash"><span class="token comment"># 使用 kafka-console-consumer 消费消息</span>
/opt/kafka/bin/kafka-console-consumer.sh <span class="token punctuation">\</span>
  <span class="token parameter variable">--topic</span> cluster-test <span class="token punctuation">\</span>
  --bootstrap-server <span class="token number">192.168</span>.6.131:9092 <span class="token punctuation">\</span>
  --from-beginning
</code></pre>
       <p>
        <img alt="25e404b8-8ba7-4528-9b4a-62509d490bbc" src="https://i-blog.csdnimg.cn/img_convert/b7b452e05d7dde7ba0a50fac9fa9aa59.jpeg"/>
       </p>
      </li>
      <li>
       <p>
        <strong>
         模拟 Broker 宕机
        </strong>
       </p>
       <p>
        停止一个 Broker，观察分区 Leader 是否切换。
       </p>
       <p>
        <strong>
         操作步骤
        </strong>
        ：
       </p>
       <pre><code class="prism language-bash"><span class="token comment"># 停止 Broker 2</span>
<span class="token function">sudo</span> systemctl stop kafka  <span class="token comment"># 假设 Broker 2 的 ID 是 2</span>

<span class="token comment"># 查看 Topic 分区状态，确认 Leader 切换</span>
/opt/kafka/bin/kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--topic</span> cluster-test <span class="token punctuation">\</span>
  --bootstrap-server <span class="token number">192.168</span>.6.131:9092
</code></pre>
       <p>
        <img alt="faa4ff58-a327-494e-a480-d3d38a1b5028" src="https://i-blog.csdnimg.cn/img_convert/b357cad48c7dbf98ce1bcffb56cae0fb.jpeg"/>
        <strong>
         说明
        </strong>
        ：
       </p>
       <ul>
        <li>
         停止 Broker 2 后，分区 0 的 Leader 仍然是 Broker 1，分区 1 的 Leader 从 Broker 2 切换到了 Broker 3。
        </li>
       </ul>
      </li>
      <li>
       <p>
        <strong>
         验证数据持久化
        </strong>
       </p>
       <p>
        重启所有 Broker，验证消息是否仍然可以消费。
       </p>
       <p>
        <strong>
         操作步骤
        </strong>
        ：
       </p>
       <pre><code class="prism language-bash"><span class="token comment"># 重启所有 Broker</span>
<span class="token function">sudo</span> systemctl restart kafka

<span class="token comment"># 等待 Broker 重新启动（约 30 秒）</span>
<span class="token function">sleep</span> <span class="token number">30</span>

<span class="token comment"># 再次消费消息，验证数据是否保留</span>
/opt/kafka/bin/kafka-console-consumer.sh <span class="token punctuation">\</span>
  <span class="token parameter variable">--topic</span> cluster-test <span class="token punctuation">\</span>
  --bootstrap-server <span class="token number">192.168</span>.6.131:9092 <span class="token punctuation">\</span>
  --from-beginning
</code></pre>
       <p>
        <strong>
         输出示例
        </strong>
        ：
       </p>
       <p>
        <img alt="f803bb1a-e543-463c-8871-cc5763de16d7" src="https://i-blog.csdnimg.cn/img_convert/0ee2451637c38b01c7e9f497fae57923.jpeg"/>
       </p>
      </li>
      <li>
       <p>
        <strong>
         验证分区恢复
        </strong>
       </p>
       <p>
        确认停止的 Broker 重新加入集群后，分区状态恢复正常。
       </p>
       <p>
        <strong>
         操作步骤
        </strong>
        ：
       </p>
       <pre><code class="prism language-bash"><span class="token comment"># 查看 Topic 分区状态</span>
/opt/kafka/bin/kafka-topics.sh <span class="token parameter variable">--describe</span> <span class="token punctuation">\</span>
  <span class="token parameter variable">--topic</span> cluster-test <span class="token punctuation">\</span>
  --bootstrap-server <span class="token number">192.168</span>.6.131:9092
</code></pre>
       <p>
        <img alt="image-20250306131951590" src="https://i-blog.csdnimg.cn/img_convert/0706fe4bcb53389f4d4f5f124d64d66d.png"/>
       </p>
      </li>
     </ol>
     <hr/>
     <h4>
      <a id="_416">
      </a>
      <strong>
       五、关键注意事项
      </strong>
     </h4>
     <ol>
      <li>
       <p>
        <strong>
         网络防火墙
        </strong>
        ：
       </p>
       <ul>
        <li>
         开放
         <code>
          ZooKeeper
         </code>
         端口：
         <code>
          2181
         </code>
         （客户端）,
         <code>
          2888
         </code>
         （节点间通信）,
         <code>
          3888
         </code>
         （选举）
        </li>
        <li>
         开放
         <code>
          Kafka
         </code>
         端口：
         <code>
          9092
         </code>
         （明文）,
         <code>
          999
         </code>
         9（JMX）
        </li>
       </ul>
      </li>
      <li>
       <p>
        <strong>
         时间同步
        </strong>
        ：
       </p>
       <pre><code class="prism language-bash"><span class="token comment"># 所有节点安装 NTP</span>
<span class="token function">sudo</span> yum <span class="token function">install</span> ntp <span class="token parameter variable">-y</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sudo</span> systemctl <span class="token builtin class-name">enable</span> <span class="token parameter variable">--now</span> ntpd
</code></pre>
      </li>
      <li>
       <p>
        <strong>
         定期清理日志
        </strong>
        ：
       </p>
       <pre><code class="prism language-bash"><span class="token comment"># 手动触发日志删除</span>
/opt/kafka/bin/kafka-log-dirs.sh <span class="token punctuation">\</span>
  --bootstrap-server <span class="token number">192.168</span>.1.101:9092 <span class="token punctuation">\</span>
  <span class="token parameter variable">--describe</span> --topic-list cluster-test
</code></pre>
      </li>
     </ol>
     <hr/>
     <p>
      通过以上步骤，您将获得一个高可用、安全的 Kafka 生产级集群，并具备基础的监控和容灾能力。
     </p>
    </img>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34333437393138382f:61727469636c652f64657461696c732f313436303637373839" class_="artid" style="display:none">
 </p>
</div>


