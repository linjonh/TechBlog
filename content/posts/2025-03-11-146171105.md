---
layout: post
title: "表索引统计信息锁定和解锁"
date: 2025-03-11 09:58:32 +0800
description: "查看字段的统计信息：select table_name,column_name,num_distinct,low_value,high_value,density from user_tab_columns;truncate命令不会修改数据的统计信息,也就是如果我们想让CBO利用合理利用数据的统计信息的时候,需要我们及时的使用analyze命令或者dbms_stats重新统计数据的统计信息。统计信息产生在user_tables、user_tab_columns、user_indexes中。"
keywords: "表、索引统计信息锁定和解锁"
categories: ['运维', 'Oracle']
tags: ['数据库', 'Oracle']
artid: "146171105"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146171105
    alt: "表索引统计信息锁定和解锁"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146171105
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146171105
cover: https://bing.ee123.net/img/rand?artid=146171105
image: https://bing.ee123.net/img/rand?artid=146171105
img: https://bing.ee123.net/img/rand?artid=146171105
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     表、索引统计信息锁定和解锁
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     零、查看数据库的统计信息收集是否开启
    </p>
    <p>
     select * from dba_autotask_client;
    </p>
    <p>
     auto optimizer stats collection 是表示开启数据库自动统计信息收集。
    </p>
    <p>
    </p>
    <p>
     一、查看统计信息是否锁定
    </p>
    <p>
     select stattype_locked,last_analyzed,a.* from dba_tab_statistics a where a.stattype_locked is not null;
    </p>
    <p>
     <img alt="" height="105" src="https://i-blog.csdnimg.cn/direct/7aff7d3fcfd14c15abd2ec9cf7265901.png" width="621"/>
    </p>
    <p>
     该字段值为空表示 没有锁定，ALL则表示统计信息收集被锁定。
    </p>
    <p>
    </p>
    <p>
     二、解锁、统计信息收集、锁定
    </p>
    <p>
     exec dbms_stats.unlock_table_stats(ownname =&gt; 'USER1',tabname =&gt; 'TABLE1');
    </p>
    <p>
     exec dbms_stats.gather_table_stats('USER1','TABLE1');
    </p>
    <p>
     exec dbms_stats.lock_table_stats('USER1','TABLE1');
    </p>
    <p>
    </p>
    <p>
     三、其他
    </p>
    <p>
     --analyze命令已经过时
    </p>
    <p>
     – 无法提供灵活的分析选项
    </p>
    <p>
     – 无法提供并行的分析
    </p>
    <p>
     – 无法对分析数据进行管理
    </p>
    <p>
     --DBMS_STATS
    </p>
    <p>
     – 专门为CBO提供信息来源
    </p>
    <p>
     – 可以进行数据分析的多种组合
    </p>
    <p>
     – 可以对分区进行分析
    </p>
    <p>
     – 可以进行分析数据管理
    </p>
    <p>
     • 备份，恢复，删除，设置....
    </p>
    <p>
     不能收集行迁移，行迁移需要使用analyze
    </p>
    <p>
     analyze table productuser.supplymessage validate structure cascade;
    </p>
    <p>
     --创建统计信息历史保留表
    </p>
    <p>
     begin
    </p>
    <p>
     dbms_stats.create_stat_table(ownname =&gt; 'productuser',stattab =&gt; 'stat_tableofproduct') ;
    </p>
    <p>
     end;
    </p>
    <p>
     --导出整个scheme的统计信息
    </p>
    <p>
     begin
    </p>
    <p>
     dbms_stats.export_schema_stats(ownname =&gt; 'productuser',stattab =&gt; 'stat_tableofproduct') ;
    </p>
    <p>
     end;
    </p>
    <p>
     --删除表的统计信息
    </p>
    <p>
     begin
    </p>
    <p>
     dbms_stats.delete_table_stats(ownname =&gt; 'productuser',tabname =&gt; 'product') ;
    </p>
    <p>
     end;
    </p>
    <p>
     select * from user_tables where table_name='PRODUCT'
    </p>
    <p>
     --导入表的历史统计信息
    </p>
    <p>
     begin
    </p>
    <p>
     dbms_stats.import_table_stats(ownname =&gt; 'productuser',tabname =&gt; 'product',stattab =&gt; 'stat_tableofproduct') ;
    </p>
    <p>
     end;
    </p>
    <p>
     --如果进行分析后，大部分表的执行计划都走错，需要导回整个scheme的统计信息
    </p>
    <p>
     begin
    </p>
    <p>
     dbms_stats.import_schema_stats(ownname =&gt; 'productuser',stattab =&gt; 'stat_tableofproduct');
    </p>
    <p>
     end;
    </p>
    <p>
     --导入索引的统计信息
    </p>
    <p>
     begin
    </p>
    <p>
     dbms_stats.import_index_stats(ownname =&gt; 'productuser',indname =&gt; 'xxx',stattab =&gt; 'stat_tableofproduct')
    </p>
    <p>
     end;
    </p>
    <p>
     analyze table 可以指定分析： 表、所有字段、所有索引字段、所有索引。 若不指定则全部都分析。
    </p>
    <p>
     1、全分析
    </p>
    <p>
     说明：全分析，包括表、字段、索引。统计信息产生在user_tables、user_tab_columns、user_indexes中。
    </p>
    <p>
     analyze table my_table compute statistics for table for all indexes for all columns;
    </p>
    <p>
     2、指定表分析
    </p>
    <p>
     说明：只分析表。统计信息只产生在user_tables中。
    </p>
    <p>
     analyze table my_table compute statistics for table;
    </p>
    <p>
     查看表的统计信息：select table_name,num_rows,blocks,empty_blocks from user_table;
    </p>
    <p>
     3、指定所有字段分析
    </p>
    <p>
     说明：只分析字段。统计信息只产生在user_tab_columns中，且全字段有。
    </p>
    <p>
     analyze table my_table compute statistics for all columns;
    </p>
    <p>
     查看字段的统计信息：select table_name,column_name,num_distinct,low_value,high_value,density from user_tab_columns;
    </p>
    <p>
     4、指定有索引的字段分析
    </p>
    <p>
     说明：只分析有索引的字段。统计信息只产生在user_tab_columns中，且只有含索引的字段有。
    </p>
    <p>
     analyze table my_table compute statistics for all indexed columns;
    </p>
    <p>
     5、指定索引分析
    </p>
    <p>
     说明：只分析索引。统计信息只产生在user_indexes中。
    </p>
    <p>
     analyze table my_table compute statistics for all indexes;
    </p>
    <p>
     查看索引的统计信息
    </p>
    <p>
     select table_name,index_name,blevel,leaf_blocks,distinct_keys,avg_leaf_blocks_per_key,avg_data_blocks_per_key,clustering_factor,num_rows from user_indexes;
    </p>
    <p>
     另外，可以删除分析数据：
    </p>
    <p>
     SQL&gt; analyze table my_table delete statistics;
    </p>
    <p>
     SQL&gt; analyze table my_table delete statistics for table for all indexes for all indexed columns;
    </p>
    <p>
     特别需要注意的：
    </p>
    <p>
     truncate命令不会修改数据的统计信息,也就是如果我们想让CBO利用合理利用数据的统计信息的时候,需要我们及时的使用analyze命令或者dbms_stats重新统计数据的统计信息。
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f7a656e677869616e67626f2f:61727469636c652f64657461696c732f313436313731313035" class_="artid" style="display:none">
 </p>
</div>


