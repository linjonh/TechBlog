---
layout: post
title: "C设计模式第十八篇备忘录模式Memento"
date: 2025-03-10 09:36:32 +0800
description: "对象状态快照与回溯"
keywords: "​【C++设计模式】第十八篇：备忘录模式（Memento）"
categories: ['C']
tags: ['设计模式', '备忘录模式', 'C']
artid: "146144331"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146144331
    alt: "C设计模式第十八篇备忘录模式Memento"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146144331
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146144331
cover: https://bing.ee123.net/img/rand?artid=146144331
image: https://bing.ee123.net/img/rand?artid=146144331
img: https://bing.ee123.net/img/rand?artid=146144331
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ​【C++设计模式】第十八篇：备忘录模式（Memento）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <code>
      注意：复现代码时，确保 VS2022 使用 C++17/20 标准以支持现代特性。
     </code>
    </p>
    <h3>
     <a id="_2">
     </a>
     对象状态快照与回溯
    </h3>
    <hr/>
    <h3>
     <a id="1__4">
     </a>
     1. 模式定义与用途
    </h3>
    <h4>
     <a id="_5">
     </a>
     核心思想
    </h4>
    <ul>
     <li>
      ​
      <strong>
       备忘录模式
      </strong>
      ：在不破坏对象封装的前提下，捕获其
      <strong>
       内部状态快照
      </strong>
      ，并在需要时
      <strong>
       恢复状态
      </strong>
      。
     </li>
     <li>
      <strong>
       关键用途
      </strong>
      ：
      <br/>
      1.​
      <strong>
       撤销/重做操作
      </strong>
      ：支持用户回退到之前的操作状态。
      <br/>
      ​2.
      <strong>
       状态持久化
      </strong>
      ：保存对象状态至内存或磁盘（如游戏存档）。
      <br/>
      ​3.
      <strong>
       事务回滚
      </strong>
      ：确保操作失败时能恢复至一致状态。
     </li>
    </ul>
    <h4>
     <a id="_11">
     </a>
     经典场景
    </h4>
    <ul>
     <li>
      文本编辑器的撤销功能。
     </li>
     <li>
      游戏角色存档与读档。
     </li>
     <li>
      数据库事务的原子性保证。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="2__16">
     </a>
     2. 模式结构解析
    </h3>
    <h4>
     <a id="UML_17">
     </a>
     UML类图
    </h4>
    <pre><code class="prism language-cpp"><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>           <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>  
<span class="token operator">|</span>      Originator     <span class="token operator">|</span>           <span class="token operator">|</span>       Memento       <span class="token operator">|</span>  
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>           <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>  
<span class="token operator">|</span> <span class="token operator">-</span> state<span class="token operator">:</span> State      <span class="token operator">|</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">&gt;</span><span class="token operator">|</span> <span class="token operator">-</span> state<span class="token operator">:</span> State      <span class="token operator">|</span>  
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>          <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>  
<span class="token operator">|</span> <span class="token operator">+</span> <span class="token function">createMemento</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token operator">|</span>          <span class="token operator">|</span> <span class="token operator">+</span> <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token operator">|</span>  
<span class="token operator">|</span> <span class="token operator">+</span> <span class="token function">restore</span><span class="token punctuation">(</span>m<span class="token operator">:</span> Memento<span class="token punctuation">)</span><span class="token operator">|</span>          <span class="token operator">|</span> <span class="token operator">+</span> <span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token operator">|</span>  
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>          <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>  
                                          <span class="token operator">^</span>  
                                          <span class="token operator">|</span>  
                                  <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">+</span>  
                                  <span class="token operator">|</span>               <span class="token operator">|</span>  
                          <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span> <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>  
                          <span class="token operator">|</span>    Caretaker     <span class="token operator">|</span> <span class="token operator">|</span>   Client       <span class="token operator">|</span>  
                          <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span> <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>  
                          <span class="token operator">|</span> <span class="token operator">-</span> mementos<span class="token operator">:</span> list <span class="token operator">|</span> <span class="token operator">|</span> 触发保存与恢复  <span class="token operator">|</span>  
                          <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span> <span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>  
</code></pre>
    <h4>
     <a id="_38">
     </a>
     角色说明
    </h4>
    <ol>
     <li>
      <code>
       Originator
      </code>
      ：原发器，生成状态快照（
      <code>
       createMemento
      </code>
      ）并从快照恢复（
      <code>
       restore
      </code>
      ）。
     </li>
     <li>
      <code>
       ​Memento
      </code>
      ：备忘录，存储原发器的内部状态（仅允许原发器访问）。
     </li>
     <li>
      <code>
       Caretaker
      </code>
      ：管理者，保存备忘录历史，但不修改其内容。
     </li>
    </ol>
    <hr/>
    <h3>
     <a id="3_C_43">
     </a>
     3. 现代C++实现示例
    </h3>
    <h4>
     <a id="_44">
     </a>
     场景：文本编辑器撤销功能
    </h4>
    <h5>
     <a id="1_45">
     </a>
     ​步骤1：定义备忘录类（严格封装）​
    </h5>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span>  </span>

<span class="token comment">// 前向声明  </span>
<span class="token keyword">class</span> <span class="token class-name">TextEditor</span><span class="token punctuation">;</span>  

<span class="token comment">// 备忘录（仅允许TextEditor访问私有成员）  </span>
<span class="token keyword">class</span> <span class="token class-name">TextMemento</span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">public</span><span class="token operator">:</span>  
    <span class="token keyword">friend</span> <span class="token keyword">class</span> <span class="token class-name">TextEditor</span><span class="token punctuation">;</span>  <span class="token comment">// 原发器为友元类  </span>

    <span class="token comment">// 仅提供读取状态的公开接口  </span>
    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> <span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> text_<span class="token punctuation">;</span> <span class="token punctuation">}</span>  

<span class="token keyword">private</span><span class="token operator">:</span>  
    <span class="token function">TextMemento</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> text<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">text_</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>  
    <span class="token keyword">void</span> <span class="token function">setText</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> text<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> text_ <span class="token operator">=</span> text<span class="token punctuation">;</span> <span class="token punctuation">}</span>  

    std<span class="token double-colon punctuation">::</span>string text_<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
    <h5>
     <a id="2_71">
     </a>
     步骤2：实现原发器（文本编辑器）​
    </h5>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">TextEditor</span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">public</span><span class="token operator">:</span>  
    <span class="token comment">// 保存状态  </span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>TextMemento<span class="token operator">&gt;</span> <span class="token function">createMemento</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>TextMemento<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>text_<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    <span class="token comment">// 恢复状态  </span>
    <span class="token keyword">void</span> <span class="token function">restore</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>TextMemento<span class="token operator">&gt;</span><span class="token operator">&amp;</span> memento<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        text_ <span class="token operator">=</span> memento<span class="token operator">-&gt;</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    <span class="token comment">// 编辑操作  </span>
    <span class="token keyword">void</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        text_ <span class="token operator">+=</span> str<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>  
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"当前文本: "</span> <span class="token operator">&lt;&lt;</span> text_ <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

<span class="token keyword">private</span><span class="token operator">:</span>  
    std<span class="token double-colon punctuation">::</span>string text_<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
    <h5>
     <a id="3_99">
     </a>
     步骤3：实现管理者（历史记录）
    </h5>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">History</span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">public</span><span class="token operator">:</span>  
    <span class="token keyword">void</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>TextMemento<span class="token operator">&gt;</span><span class="token operator">&amp;</span> memento<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        history_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>memento<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>TextMemento<span class="token operator">&gt;</span> <span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">if</span> <span class="token punctuation">(</span>history_<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>  
        <span class="token keyword">auto</span> last <span class="token operator">=</span> history_<span class="token punctuation">.</span><span class="token function">back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        history_<span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">return</span> last<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

<span class="token keyword">private</span><span class="token operator">:</span>  
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>TextMemento<span class="token operator">&gt;&gt;</span> history_<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
    <h5>
     <a id="4_119">
     </a>
     步骤4：客户端代码
    </h5>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    TextEditor editor<span class="token punctuation">;</span>  
    History history<span class="token punctuation">;</span>  

    <span class="token comment">// 编辑并保存状态  </span>
    editor<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"Hello"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    history<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span><span class="token function">createMemento</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    editor<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：当前文本: Hello  </span>

    editor<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" World"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    history<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>editor<span class="token punctuation">.</span><span class="token function">createMemento</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    editor<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：当前文本: Hello World  </span>

    <span class="token comment">// 撤销到上一个状态  </span>
    <span class="token keyword">auto</span> memento <span class="token operator">=</span> history<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span>memento<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        editor<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span>memento<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        editor<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 输出：当前文本: Hello  </span>
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre>
    <hr/>
    <h3>
     <a id="4__144">
     </a>
     4. 应用场景示例
    </h3>
    <h4>
     <a id="1_145">
     </a>
     场景1：游戏角色存档
    </h4>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">GameCharacter</span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">public</span><span class="token operator">:</span>  
    <span class="token keyword">struct</span> <span class="token class-name">State</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">int</span> health<span class="token punctuation">;</span> <span class="token keyword">float</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>  

    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Memento<span class="token operator">&gt;</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>CharacterMemento<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>state_<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    <span class="token keyword">void</span> <span class="token function">restore</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Memento<span class="token operator">&gt;</span><span class="token operator">&amp;</span> memento<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">auto</span> cm <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">dynamic_pointer_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>CharacterMemento<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>memento<span class="token punctuation">)</span><span class="token punctuation">;</span>  
        state_ <span class="token operator">=</span> cm<span class="token operator">-&gt;</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

<span class="token keyword">private</span><span class="token operator">:</span>  
    State state_<span class="token punctuation">;</span>  

    <span class="token keyword">class</span> <span class="token class-name">CharacterMemento</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Memento</span></span> <span class="token punctuation">{<!-- --></span>  
    <span class="token keyword">public</span><span class="token operator">:</span>  
        <span class="token function">CharacterMemento</span><span class="token punctuation">(</span><span class="token keyword">const</span> State<span class="token operator">&amp;</span> state<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">state_</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>  
        State <span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> state_<span class="token punctuation">;</span> <span class="token punctuation">}</span>  
    <span class="token keyword">private</span><span class="token operator">:</span>  
        State state_<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
    <h4>
     <a id="2_173">
     </a>
     场景2：数据库事务回滚
    </h4>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">DatabaseTransaction</span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">public</span><span class="token operator">:</span>  
    <span class="token keyword">void</span> <span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* 提交事务 */</span> <span class="token punctuation">}</span>  
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Memento<span class="token operator">&gt;</span> <span class="token function">saveCheckpoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>Checkpoint<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>data_<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    <span class="token keyword">void</span> <span class="token function">rollback</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>Memento<span class="token operator">&gt;</span><span class="token operator">&amp;</span> memento<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        data_ <span class="token operator">=</span> memento<span class="token operator">-&gt;</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

<span class="token keyword">private</span><span class="token operator">:</span>  
    std<span class="token double-colon punctuation">::</span>string data_<span class="token punctuation">;</span>  

    <span class="token keyword">class</span> <span class="token class-name">Checkpoint</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Memento</span></span> <span class="token punctuation">{<!-- --></span>  
    <span class="token keyword">public</span><span class="token operator">:</span>  
        <span class="token function">Checkpoint</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> data<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">data_</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>  
        std<span class="token double-colon punctuation">::</span>string <span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> data_<span class="token punctuation">;</span> <span class="token punctuation">}</span>  
    <span class="token keyword">private</span><span class="token operator">:</span>  
        std<span class="token double-colon punctuation">::</span>string data_<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
    <hr/>
    <h3>
     <a id="5__199">
     </a>
     5. 优缺点分析（表格形式）
    </h3>
    <table>
     <thead>
      <tr>
       <th align="left">
        ​优点
       </th>
       <th align="left">
        ​缺点
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="left">
        状态保存与恢复逻辑解耦
       </td>
       <td align="left">
        频繁保存大对象可能导致内存占用高
       </td>
      </tr>
      <tr>
       <td align="left">
        严格封装，不破坏原发器内部实现
       </td>
       <td align="left">
        需要深拷贝，复杂对象复制成本高
       </td>
      </tr>
      <tr>
       <td align="left">
        支持多级撤销与历史管理
       </td>
       <td align="left">
        Caretaker需维护大量备忘录对象
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h3>
     <a id="6__206">
     </a>
     6. 调试与优化策略
    </h3>
    <h4>
     <a id="VS2022_207">
     </a>
     调试技巧（VS2022）​
    </h4>
    <h5>
     <a id="1__208">
     </a>
     1. ​跟踪备忘录状态：
    </h5>
    <ul>
     <li>
      在createMemento()和restore()中设置断点，验证保存和恢复的数据一致性。
     </li>
    </ul>
    <h5>
     <a id="2__210">
     </a>
     2. ​检查深拷贝正确性：
    </h5>
    <ul>
     <li>
      确保备忘录与原发器的状态完全独立，修改原发器不影响已保存的备忘录。
     </li>
    </ul>
    <h4>
     <a id="_212">
     </a>
     性能优化
    </h4>
    <h5>
     <a id="1__213">
     </a>
     1.​ 增量保存：
    </h5>
    <ul>
     <li>
      仅保存状态的变化部分（如差异快照），而非完整状态。
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">DiffMemento</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Memento</span></span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">public</span><span class="token operator">:</span>  
    <span class="token function">DiffMemento</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> diff<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">diff_</span><span class="token punctuation">(</span>diff<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>  
    std<span class="token double-colon punctuation">::</span>string <span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> base<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> base <span class="token operator">+</span> diff_<span class="token punctuation">;</span> <span class="token punctuation">}</span>  
<span class="token keyword">private</span><span class="token operator">:</span>  
    std<span class="token double-colon punctuation">::</span>string diff_<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
    <h5>
     <a id="2__225">
     </a>
     2. 懒加载备忘录：
    </h5>
    <ul>
     <li>
      仅在需要恢复时生成快照，结合持久化存储（如磁盘缓存）。
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e637364:6e2e6e65742f4a7569637941637469766547696c626572742f:61727469636c652f64657461696c732f313436313434333331" class_="artid" style="display:none">
 </p>
</div>


