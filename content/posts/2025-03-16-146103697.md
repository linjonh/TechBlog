---
layout: post
title: "deepseek-GRPO算法保姆级讲解数学原理源码解析案例实战"
date: 2025-03-16 23:06:33 +0800
description: "GRPO（Groupwise relative policy optimization）群组相对策略优化是deepseek提出的一种RLHF(基于人类反馈的强化学习)技术。首次提出是在DeepSeekMath中，RL被证明在SFT阶段后能有效提升LLM的数学推理能力。在GRPO提出之前，有两种流行的RLHF技术被广泛用于大模型的对齐过程中，分别是PPO和DPO。"
keywords: "deepseek GRPO算法保姆级讲解(数学原理+源码解析+案例实战)"
categories: ['Llm']
tags: ['算法', '人工智能']
artid: "146103697"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146103697
    alt: "deepseek-GRPO算法保姆级讲解数学原理源码解析案例实战"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146103697
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146103697
cover: https://bing.ee123.net/img/rand?artid=146103697
image: https://bing.ee123.net/img/rand?artid=146103697
img: https://bing.ee123.net/img/rand?artid=146103697
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     deepseek GRPO算法保姆级讲解(数学原理+源码解析+案例实战)
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-github-gist" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="GRPO_1">
     </a>
     什么是GRPO
    </h2>
    <p>
     <strong>
      GRPO（Groupwise relative policy optimization）群组相对策略优化
     </strong>
     是deepseek提出的一种RLHF(基于人类反馈的强化学习)技术。首次提出是在DeepSeekMath中，RL被证明在SFT阶段后能有效提升LLM的数学推理能力。
     <br/>
     在GRPO提出之前，有两种流行的RLHF技术被广泛用于大模型的对齐过程中，分别是PPO和DPO。
    </p>
    <h3>
     <a id="Group_Formation_5">
     </a>
     群组形成(Group Formation):让大模型创建多种解决方案
    </h3>
    <p>
     GRPO算法的第一步非常直观，类似于学生尝试多种解法去解决同一个问题。对于给定的prompt，让大模型尝试生成多种解答(attempt)来解决同一个问题(通常4、8或16种的不同解答)。不同的解答示例如下图所示。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7c9539204d83475e9d220a57b8134784.png"/>
    </p>
    <h3>
     <a id="Preference_Learning_8">
     </a>
     偏好学习(Preference Learning)：让大模型理解何为好的解答
    </h3>
    <p>
     与其他的RLHF方法需要一个单独的奖励模型(reward model)不同，GRPO方法可以使用任何函数或模型来评估LLM解答(Solution)的质量。例如，可以使用一个长度函数作为评估器来奖励模型生成更简短的解答，或是使用一个数学求解器，来奖励模型生成更准确的数学解答方案。
     <br/>
     评估过程会从多个角度来衡量大模型生成解答方案的质量，包括：
     <br/>
     1）最终答案是否正确；2）答案是否按指定的格式输出（如XML标签格式正确性）；3）推理过程与提供的答案是否一致。
    </p>
    <h4>
     <a id="_12">
     </a>
     组内相对优势
    </h4>
    <p>
     这种处理方式的巧妙之处还在于评分机制，GRPO不是简单的给出绝对分数，而是对每个组内的奖励进行归一化处理。它采用了一个简单但有效的方法来计算组内相对优势：
    </p>
    <p>
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        A 
        
       
         d 
        
       
         v 
        
       
         a 
        
       
         t 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         = 
        
       
         ( 
        
       
         r 
        
       
         e 
        
       
         w 
        
       
         a 
        
       
         r 
        
       
         d 
        
       
         − 
        
       
         m 
        
       
         e 
        
       
         a 
        
       
         n 
        
       
         ( 
        
       
         g 
        
       
         r 
        
       
         o 
        
       
         u 
        
        
        
          p 
         
        
          r 
         
        
       
         e 
        
       
         w 
        
       
         a 
        
       
         r 
        
       
         d 
        
       
         s 
        
       
         ) 
        
       
         / 
        
       
         s 
        
       
         t 
        
       
         d 
        
       
         ( 
        
       
         g 
        
       
         r 
        
       
         o 
        
       
         u 
        
        
        
          p 
         
        
          r 
         
        
       
         e 
        
       
         w 
        
       
         a 
        
       
         r 
        
       
         d 
        
       
         s 
        
       
         ) 
        
       
      
        Advatage = (reward- mean(group_rewards)/ std(group_rewards)
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal">
          A
         </span>
         <span class="mord mathnormal">
          d
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0359em;">
          v
         </span>
         <span class="mord mathnormal">
          a
         </span>
         <span class="mord mathnormal">
          t
         </span>
         <span class="mord mathnormal">
          a
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0359em;">
          g
         </span>
         <span class="mord mathnormal">
          e
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mopen">
          (
         </span>
         <span class="mord mathnormal">
          re
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0269em;">
          w
         </span>
         <span class="mord mathnormal">
          a
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          r
         </span>
         <span class="mord mathnormal">
          d
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          −
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord mathnormal">
          m
         </span>
         <span class="mord mathnormal">
          e
         </span>
         <span class="mord mathnormal">
          an
         </span>
         <span class="mopen">
          (
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0359em;">
          g
         </span>
         <span class="mord mathnormal">
          ro
         </span>
         <span class="mord mathnormal">
          u
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           p
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.1514em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                 r
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mord mathnormal">
          e
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0269em;">
          w
         </span>
         <span class="mord mathnormal">
          a
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          r
         </span>
         <span class="mord mathnormal">
          d
         </span>
         <span class="mord mathnormal">
          s
         </span>
         <span class="mclose">
          )
         </span>
         <span class="mord">
          /
         </span>
         <span class="mord mathnormal">
          s
         </span>
         <span class="mord mathnormal">
          t
         </span>
         <span class="mord mathnormal">
          d
         </span>
         <span class="mopen">
          (
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0359em;">
          g
         </span>
         <span class="mord mathnormal">
          ro
         </span>
         <span class="mord mathnormal">
          u
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           p
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.1514em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                 r
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mord mathnormal">
          e
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0269em;">
          w
         </span>
         <span class="mord mathnormal">
          a
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          r
         </span>
         <span class="mord mathnormal">
          d
         </span>
         <span class="mord mathnormal">
          s
         </span>
         <span class="mclose">
          )
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     这种归一化方法帮助大模型理解，哪些解答方案比同组内其他解答方案更好或更差，而不是简单的反馈绝对得分给大模型。
    </p>
    <h3>
     <a id="optimization_learning_from_experience_19">
     </a>
     优化(optimization): 让大模型从经验中学习(learning from experience)
    </h3>
    <p>
     GRPO的最后一步是根据解决方案组的评估结果，指导大模型进行改进。这一过程基于两个主要原则：
    </p>
    <ol>
     <li>
      鼓励模型生成更多类似成功案例的解决方案，同时远离效果不佳的方法；
     </li>
     <li>
      使用KL散度惩罚作为安全机制，防止模型在训练中一次发生过于剧烈的变化；
     </li>
    </ol>
    <p>
     这种方法在实践中被证明比传统方法更稳定，原因在于：
    </p>
    <ul>
     <li>
      同时考虑多个解决方案，而不局限于两两比较；
     </li>
     <li>
      基于组的归一化有助于避免奖励缩放问题（reward scaling）
     </li>
     <li>
      KL散度惩罚作为安全网，保证模型在学习新知识的同时，不会忘记已经掌握的内容；
     </li>
    </ul>
    <blockquote>
     <p>
      总结GRPO的关键创新在于：
     </p>
     <ol>
      <li>
       直接从任何函数或模型中学习，消除了对单独奖励模型的依赖。
      </li>
      <li>
       基于组的学习方式，比传统的成对比较等方法更加稳定和高效。
      </li>
     </ol>
    </blockquote>
    <h4>
     <a id="_33">
     </a>
     目标函数
    </h4>
    <p>
     GRPO算法从旧的策略模型中采样一组输出
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        o 
         
        
          1 
         
        
       
         , 
        
        
        
          o 
         
        
          2 
         
        
       
         , 
        
       
         . 
        
       
         . 
        
       
         . 
        
       
         , 
        
        
        
          o 
         
        
          G 
         
        
       
      
        {o_1,o_2,...,o_G}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          <span class="mord">
           <span class="mord mathnormal">
            o
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            o
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  2
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           ...
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            o
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  G
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，并通过下面的目标函数来优化策略模型：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/241a8b2622fa4df6840a75a02c0630f3.png">
      <br/>
      GRPO的目标函数通过组内相对优势估计替代传统优势函数，并结合PPO的裁剪机制（限制策略更新幅度）和KL散度正则化（约束策略与参考模型的偏离），在最大化奖励的同时确保策略稳定性：
     </img>
    </p>
    <ol>
     <li>
      函数中通过最大化组内相对优势，增加生成优质结果的概率，减少生成劣质结果的概率；
     </li>
     <li>
      通过KL散度惩罚项，确保模型策略不会过度偏离参考策略，从而保证优化过程的稳定性。
     </li>
    </ol>
    <p>
     式中参数注释如下：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         θ 
             
            
           
          
          
           
            
           
          
          
           
            
             
            
              : 
             
            
              当前策略模型的可学习参数，通过优化目标函数更新 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              q 
             
            
              ∼ 
             
            
              P 
             
            
              ( 
             
            
              Q 
             
            
              ) 
             
            
           
          
          
           
            
           
          
          
           
            
             
            
              : 
             
            
              从问题分布中采样的输入（如用户指令） 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              G 
             
            
           
          
          
           
            
           
          
          
           
            
             
            
              : 
             
            
              每个输入生成的样本数（组内样本数） 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
             
             
               o 
              
             
               i 
              
             
            
              ∼ 
             
             
             
               π 
              
              
              
                θ 
               
              
                old 
               
              
             
            
              ( 
             
            
              O 
             
            
              ∣ 
             
            
              q 
             
            
              ) 
             
            
           
          
          
           
            
           
          
          
           
            
             
            
              : 
             
            
              旧策略生成的第  
             
            
              i 
             
            
               个输出样本 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
             
             
               π 
              
              
              
                θ 
               
              
                old 
               
              
             
            
           
          
          
           
            
           
          
          
           
            
             
            
              : 
             
            
              旧策略模型（生成样本时固定） 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
             
             
               π 
              
             
               θ 
              
             
            
           
          
          
           
            
           
          
          
           
            
             
            
              : 
             
            
              当前策略模型（通过优化更新） 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              O 
             
            
              ∣ 
             
            
              q 
             
            
           
          
          
           
            
           
          
          
           
            
             
            
              : 
             
            
              输入  
             
            
              q 
             
            
               条件下策略生成的输出分布 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              ∣ 
             
             
             
               o 
              
             
               i 
              
             
            
              ∣ 
             
            
           
          
          
           
            
           
          
          
           
            
             
            
              : 
             
            
              输出序列  
             
             
             
               o 
              
             
               i 
              
             
            
               的长度（token数量） 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              t 
             
            
           
          
          
           
            
           
          
          
           
            
             
            
              : 
             
            
              序列生成的时间步（第  
             
            
              t 
             
            
               个token位置） 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
             
              
              
                A 
               
              
                ^ 
               
              
              
              
                i 
               
              
                , 
               
              
                t 
               
              
             
            
           
          
          
           
            
           
          
          
           
            
             
            
              : 
             
            
              组内相对优势（基于组内奖励差值计算） 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              ϵ 
             
            
           
          
          
           
            
           
          
          
           
            
             
            
              : 
             
            
              裁剪范围参数（限制策略更新幅度） 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
            
              β 
             
            
           
          
          
           
            
           
          
          
           
            
             
            
              : 
             
            
              KL散度正则化系数（控制策略与参考模型偏离） 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
             
             
               D 
              
             
               KL 
              
             
            
              ( 
             
             
             
               π 
              
             
               θ 
              
             
            
              ∣ 
             
            
              ∣ 
             
             
             
               π 
              
             
               ref 
              
             
            
              ) 
             
            
           
          
          
           
            
           
          
          
           
            
             
            
              : 
             
            
              当前策略与参考模型的KL散度 
             
            
           
          
         
         
          
           
            
           
          
          
           
            
             
             
             
               π 
              
             
               ref 
              
             
            
           
          
          
           
            
           
          
          
           
            
             
            
              : 
             
            
              参考模型（如初始SFT模型） 
             
            
           
          
         
        
       
         \begin{aligned} &amp;\theta &amp;&amp;: \text{当前策略模型的可学习参数，通过优化目标函数更新} \\ &amp;q \sim P(Q) &amp;&amp;: \text{从问题分布中采样的输入（如用户指令）} \\ &amp;G &amp;&amp;: \text{每个输入生成的样本数（组内样本数）} \\ &amp;o_i \sim \pi_{\theta_{\text{old}}}(O|q) &amp;&amp;: \text{旧策略生成的第 }i\text{ 个输出样本} \\ &amp;\pi_{\theta_{\text{old}}} &amp;&amp;: \text{旧策略模型（生成样本时固定）} \\ &amp;\pi_{\theta} &amp;&amp;: \text{当前策略模型（通过优化更新）} \\ &amp;O|q &amp;&amp;: \text{输入 }q\text{ 条件下策略生成的输出分布} \\ &amp;|o_i| &amp;&amp;: \text{输出序列 }o_i\text{ 的长度（token数量）} \\ &amp;t &amp;&amp;: \text{序列生成的时间步（第 }t\text{ 个token位置）} \\ &amp;\hat{A}_{i,t} &amp;&amp;: \text{组内相对优势（基于组内奖励差值计算）} \\ &amp;\epsilon &amp;&amp;: \text{裁剪范围参数（限制策略更新幅度）} \\ &amp;\beta &amp;&amp;: \text{KL散度正则化系数（控制策略与参考模型偏离）} \\ &amp;D_{\text{KL}}(\pi_{\theta}||\pi_{\text{ref}}) &amp;&amp;: \text{当前策略与参考模型的KL散度} \\ &amp;\pi_{\text{ref}} &amp;&amp;: \text{参考模型（如初始SFT模型）} \end{aligned}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 21.1068em; vertical-align: -10.3034em;">
          </span>
          <span class="mord">
           <span class="mtable">
            <span class="col-align-r">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 10.8034em;">
                <span class="" style="top: -12.9102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -11.4102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -9.9102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -8.4102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -6.9102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -5.4102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -3.9102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -2.4102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -0.9102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: 0.6966em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: 2.1966em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: 3.6966em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: 5.1966em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: 6.6966em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 10.3034em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="col-align-l">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 10.8034em;">
                <span class="" style="top: -12.9634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.0278em;">
                   θ
                  </span>
                 </span>
                </span>
                <span class="" style="top: -11.4634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.0359em;">
                   q
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   ∼
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.1389em;">
                   P
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord mathnormal">
                   Q
                  </span>
                  <span class="mclose">
                   )
                  </span>
                 </span>
                </span>
                <span class="" style="top: -9.9634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mord mathnormal">
                   G
                  </span>
                 </span>
                </span>
                <span class="" style="top: -8.4634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    o
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   ∼
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal" style="margin-right: 0.0359em;">
                    π
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3361em;">
                       <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                            θ
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3448em;">
                               <span class="" style="top: -2.3488em; margin-left: -0.0278em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mtight">
                                  <span class="mord text mtight">
                                   <span class="mord mtight">
                                    old
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.1512em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.2559em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.0278em;">
                   O
                  </span>
                  <span class="mord">
                   ∣
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.0359em;">
                   q
                  </span>
                  <span class="mclose">
                   )
                  </span>
                 </span>
                </span>
                <span class="" style="top: -6.9634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal" style="margin-right: 0.0359em;">
                    π
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3361em;">
                       <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                            θ
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3448em;">
                               <span class="" style="top: -2.3488em; margin-left: -0.0278em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mtight">
                                  <span class="mord text mtight">
                                   <span class="mord mtight">
                                    old
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.1512em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.2559em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -5.4634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal" style="margin-right: 0.0359em;">
                    π
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3361em;">
                       <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                           θ
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.9634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.0278em;">
                   O
                  </span>
                  <span class="mord">
                   ∣
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.0359em;">
                   q
                  </span>
                 </span>
                </span>
                <span class="" style="top: -2.4634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mord">
                   ∣
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    o
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mord">
                   ∣
                  </span>
                 </span>
                </span>
                <span class="" style="top: -0.9634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mord mathnormal">
                   t
                  </span>
                 </span>
                </span>
                <span class="" style="top: 0.6434em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mord">
                   <span class="mord accent">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.9468em;">
                       <span class="" style="top: -3em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="mord mathnormal">
                         A
                        </span>
                       </span>
                       <span class="" style="top: -3.2523em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="accent-body" style="left: -0.1111em;">
                         <span class="mord">
                          ^
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                          <span class="mpunct mtight">
                           ,
                          </span>
                          <span class="mord mathnormal mtight">
                           t
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.2861em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: 2.1434em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mord mathnormal">
                   ϵ
                  </span>
                 </span>
                </span>
                <span class="" style="top: 3.6434em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.0528em;">
                   β
                  </span>
                 </span>
                </span>
                <span class="" style="top: 5.1434em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal" style="margin-right: 0.0278em;">
                    D
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3283em;">
                       <span class="" style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord text mtight">
                           <span class="mord mtight">
                            KL
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal" style="margin-right: 0.0359em;">
                    π
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3361em;">
                       <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                           θ
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mord">
                   ∣∣
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal" style="margin-right: 0.0359em;">
                    π
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3361em;">
                       <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord text mtight">
                           <span class="mord mtight">
                            ref
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mclose">
                   )
                  </span>
                 </span>
                </span>
                <span class="" style="top: 6.6434em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal" style="margin-right: 0.0359em;">
                    π
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3361em;">
                       <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord text mtight">
                           <span class="mord mtight">
                            ref
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 10.3034em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="arraycolsep" style="width: 1em;">
            </span>
            <span class="col-align-r">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 10.8034em;">
                <span class="" style="top: -12.9102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -11.4102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -9.9102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -8.4102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -6.9102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -5.4102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -3.9102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -2.4102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: -0.9102em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: 0.6966em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: 2.1966em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: 3.6966em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: 5.1966em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
                <span class="" style="top: 6.6966em;">
                 <span class="pstrut" style="height: 2.9468em;">
                 </span>
                 <span class="mord">
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 10.3034em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="col-align-l">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 10.8034em;">
                <span class="" style="top: -12.9634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord text">
                   <span class="mord cjk_fallback">
                    当前策略模型的可学习参数，通过优化目标函数更新
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -11.4634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord text">
                   <span class="mord cjk_fallback">
                    从问题分布中采样的输入（如用户指令）
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -9.9634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord text">
                   <span class="mord cjk_fallback">
                    每个输入生成的样本数（组内样本数）
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -8.4634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord text">
                   <span class="mord cjk_fallback">
                    旧策略生成的第
                   </span>
                   <span class="mord">
                   </span>
                  </span>
                  <span class="mord mathnormal">
                   i
                  </span>
                  <span class="mord text">
                   <span class="mord">
                   </span>
                   <span class="mord cjk_fallback">
                    个输出样本
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -6.9634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord text">
                   <span class="mord cjk_fallback">
                    旧策略模型（生成样本时固定）
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -5.4634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord text">
                   <span class="mord cjk_fallback">
                    当前策略模型（通过优化更新）
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.9634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord text">
                   <span class="mord cjk_fallback">
                    输入
                   </span>
                   <span class="mord">
                   </span>
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.0359em;">
                   q
                  </span>
                  <span class="mord text">
                   <span class="mord">
                   </span>
                   <span class="mord cjk_fallback">
                    条件下策略生成的输出分布
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -2.4634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord text">
                   <span class="mord cjk_fallback">
                    输出序列
                   </span>
                   <span class="mord">
                   </span>
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    o
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mord text">
                   <span class="mord">
                   </span>
                   <span class="mord cjk_fallback">
                    的长度（
                   </span>
                   <span class="mord">
                    token
                   </span>
                   <span class="mord cjk_fallback">
                    数量）
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -0.9634em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord text">
                   <span class="mord cjk_fallback">
                    序列生成的时间步（第
                   </span>
                   <span class="mord">
                   </span>
                  </span>
                  <span class="mord mathnormal">
                   t
                  </span>
                  <span class="mord text">
                   <span class="mord">
                   </span>
                   <span class="mord cjk_fallback">
                    个
                   </span>
                   <span class="mord">
                    token
                   </span>
                   <span class="mord cjk_fallback">
                    位置）
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: 0.6434em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord text">
                   <span class="mord cjk_fallback">
                    组内相对优势（基于组内奖励差值计算）
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: 2.1434em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord text">
                   <span class="mord cjk_fallback">
                    裁剪范围参数（限制策略更新幅度）
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: 3.6434em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord text">
                   <span class="mord">
                    KL
                   </span>
                   <span class="mord cjk_fallback">
                    散度正则化系数（控制策略与参考模型偏离）
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: 5.1434em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord text">
                   <span class="mord cjk_fallback">
                    当前策略与参考模型的
                   </span>
                   <span class="mord">
                    KL
                   </span>
                   <span class="mord cjk_fallback">
                    散度
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: 6.6434em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord text">
                   <span class="mord cjk_fallback">
                    参考模型（如初始
                   </span>
                   <span class="mord">
                    SFT
                   </span>
                   <span class="mord cjk_fallback">
                    模型）
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 10.3034em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     其中​两个超参数：𝜀是PPO机制中的裁剪范围参数，限制策略更新幅度；𝛽是KL散度正则化系数，控制当前策略与参考模型
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        π 
         
         
         
           r 
          
         
           e 
          
         
           f 
          
         
        
       
      
        π_{ref}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           π
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3361em;">
              <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  re
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.1076em;">
                  f
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2861em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     的偏离程度。
    </p>
    <p>
     这里的KL散度与传统的KL散度计算方式不同，使用Schulman提出的无偏估计，确保结果是正数：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e9c464e2662f42d9971d9d487ee0ce26.png">
      <br/>
      式中
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         o 
         
         
         
           &lt; 
          
         
           t 
          
         
        
       
      
        o_{&lt;t}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6079em; vertical-align: -0.1774em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            o
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2806em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mrel mtight">
                   &lt;
                  </span>
                  <span class="mord mathnormal mtight">
                   t
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1774em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      表示在时间步 t 之前的所有观测（或输出）序列 。
     </img>
    </p>
    <h3>
     <a id="GRPO_65">
     </a>
     GRPO算法的伪码表示
    </h3>
    <p>
     DeepSeekMath论文里给出了GRPO迭代优化的步骤：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8e060d26b3bf41b598f753f55e451bd1.png"/>
    </p>
    <p>
     基于上述流程，GRPO算法的伪码可表示为：
    </p>
    <pre><code class="prism language-py">Input<span class="token punctuation">:</span> 
<span class="token operator">-</span> initial_policy<span class="token punctuation">:</span> Starting model to be trained
<span class="token operator">-</span> reward_function<span class="token punctuation">:</span> Function that evaluates outputs
<span class="token operator">-</span> training_prompts<span class="token punctuation">:</span> Set of training examples
<span class="token operator">-</span> group_size<span class="token punctuation">:</span> Number of outputs per prompt <span class="token punctuation">(</span>typically <span class="token number">4</span><span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">)</span>

Algorithm GRPO<span class="token punctuation">:</span>
<span class="token number">1.</span> For each training iteration<span class="token punctuation">:</span>
   a<span class="token punctuation">.</span> Set reference_policy <span class="token operator">=</span> initial_policy <span class="token punctuation">(</span>snapshot current policy<span class="token punctuation">)</span>
   b<span class="token punctuation">.</span> For each prompt <span class="token keyword">in</span> batch<span class="token punctuation">:</span>
      i<span class="token punctuation">.</span> Generate group_size different outputs using initial_policy
      ii<span class="token punctuation">.</span> Compute rewards <span class="token keyword">for</span> each output using reward_function
      iii<span class="token punctuation">.</span> Normalize rewards within group<span class="token punctuation">:</span>
           normalized_advantage <span class="token operator">=</span> <span class="token punctuation">(</span>reward <span class="token operator">-</span> mean<span class="token punctuation">(</span>rewards<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> std<span class="token punctuation">(</span>rewards<span class="token punctuation">)</span>
      iv<span class="token punctuation">.</span> Update policy by maximizing the clipped ratio<span class="token punctuation">:</span>
          <span class="token builtin">min</span><span class="token punctuation">(</span>prob_ratio <span class="token operator">*</span> normalized_advantage<span class="token punctuation">,</span> 
              clip<span class="token punctuation">(</span>prob_ratio<span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">-</span>epsilon<span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">+</span>epsilon<span class="token punctuation">)</span> <span class="token operator">*</span> normalized_advantage<span class="token punctuation">)</span>
          <span class="token operator">-</span> kl_weight <span class="token operator">*</span> KL<span class="token punctuation">(</span>initial_policy <span class="token operator">|</span><span class="token operator">|</span> reference_policy<span class="token punctuation">)</span>
          
          where prob_ratio <span class="token keyword">is</span> current_prob <span class="token operator">/</span> reference_prob

Output<span class="token punctuation">:</span> Optimized policy model
</code></pre>
    <h3>
     <a id="GRPO_94">
     </a>
     GRPO算法的局限与挑战
    </h3>
    <p>
     GRPO算法在实践中也面临一些挑战：
    </p>
    <ol>
     <li>
      生成成本。为每个提示词生成多个补全（4-16个）相比只生成一个或两个补全的方法，显著增加了计算需求。
     </li>
     <li>
      批量大小限制。需要一起处理一组补全，这可能会限制有效的批量大小，增加训练过程的复杂性，并可能减缓训练速度。
     </li>
     <li>
      奖励函数的设计。训练质量在很大程度上依赖于精心设计的奖励函数。设计不佳的奖励可能导致意外行为或优化错误的目标。
     </li>
     <li>
      组大小的权衡。选择最优的组大小需要在解决方案的多样性与计算成本之间进行平衡。组内样本太少可能无法提供足够的多样性，而样本太多则会增加训练时间和资源需求。
     </li>
     <li>
      KL散度调参。找到合适的KL散度惩罚平衡需要谨慎调整——过高会导致模型无法有效学习，过低则可能使其偏离初始能力过远。
     </li>
    </ol>
    <hr/>
    <h2>
     <a id="_102">
     </a>
     代码实现
    </h2>
    <h3>
     <a id="GRPO_103">
     </a>
     GRPO训练参数配置
    </h3>
    <p>
     TRL库中将GRPO算法封装为
     <code>
      GRPOConfig
     </code>
     参数配置器和
     <code>
      GRPOTrainer
     </code>
     训练器。
     <br/>
     这里参考TRL库的源码，给出简化版的代码解读。
     <br/>
     将GRPO训练所需参数封装成 GRPOConfig数据类。用@dataclass装饰器将 GRPOConfig定义为一个数据类，并通过field函数为类中的字段指定默认值、默认工厂函数、元数据等。
     <br/>
     原代码过长，这里只贴出控制GRPO训练的参数：
    </p>
    <pre><code class="prism language-py"><span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">GRPOConfig</span><span class="token punctuation">(</span>TrainingArguments<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token comment"># Parameters that control the training</span>
    learning_rate<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> field<span class="token punctuation">(</span>
        default<span class="token operator">=</span><span class="token number">1e-6</span><span class="token punctuation">,</span>
        metadata<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">"help"</span><span class="token punctuation">:</span> <span class="token string">"Initial learning rate for `AdamW` optimizer. The default value replaces that of "</span>
            <span class="token string">"`transformers.TrainingArguments`."</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    beta<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> field<span class="token punctuation">(</span>
        default<span class="token operator">=</span><span class="token number">0.04</span><span class="token punctuation">,</span>
        metadata<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">"help"</span><span class="token punctuation">:</span> <span class="token string">"KL coefficient. If `0.0`, the reference model is not loaded, reducing memory usage and improving "</span>
            <span class="token string">"training speed, but may be numerically unstable for long training runs."</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token comment"># KL散度部分的超参数$\beta$,控制KL散度惩罚项的大小</span>
    num_iterations<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> field<span class="token punctuation">(</span>
        default<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>
        metadata<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"help"</span><span class="token punctuation">:</span> <span class="token string">"Number of iterations per batch (denoted as μ in the algorithm)."</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
     epsilon<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> field<span class="token punctuation">(</span>
        default<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">,</span>
        metadata<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"help"</span><span class="token punctuation">:</span> <span class="token string">"Epsilon value for clipping."</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token comment"># clip部分超参数，控制裁剪的范围</span>
</code></pre>
    <p>
     控制每个奖励函数的权重占比的参数：
    </p>
    <pre><code class="prism language-py">reward_weights<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> field<span class="token punctuation">(</span>
        default<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
        metadata<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">"help"</span><span class="token punctuation">:</span> <span class="token string">"Weights for each reward function. Must match the number of reward functions. If `None`, all "</span>
            <span class="token string">"rewards are weighted equally with weight `1.0`."</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token comment"># 每个奖励函数的权重占比</span>
</code></pre>
    <p>
     TR-DPO论文中提出的
     <strong>
      控制参考模型动态更新
     </strong>
     的三个参数, 当前策略模型与旧参考模型的混合比例、是否启用参考模型与当前策略模型的同步机制、参考模型与当前策略模型同步的频率:
    </p>
    <pre><code class="prism language-py"><span class="token comment">## &gt;TR-DPO论文中提出的控制参考模型与当前策略模型同步机制以动态更新的三个参数</span>
    <span class="token comment"># 是否启用参考模型与当前策略模型的同步机制</span>
    sync_ref_model<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> field<span class="token punctuation">(</span>
        default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
        metadata<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">"help"</span><span class="token punctuation">:</span> <span class="token string">"Whether to synchronize the reference model with the active model every `ref_model_sync_steps` "</span>
            <span class="token string">"steps, using the `ref_model_mixup_alpha` parameter."</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> 
    <span class="token comment"># 控制参考模型更新时，当前策略模型与旧参考模型的混合比例</span>
    <span class="token comment"># 加权因子alpha控制软更新（soft update）；aplha=1时更新方法变为硬更新（hard update），即将参考策略模型替换为当前策略模型</span>
    ref_model_mixup_alpha<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> field<span class="token punctuation">(</span>
        default<span class="token operator">=</span><span class="token number">0.6</span><span class="token punctuation">,</span>
        metadata<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">"help"</span><span class="token punctuation">:</span> <span class="token string">"α parameter from the TR-DPO paper, which controls the mix between the current policy and the "</span>
            <span class="token string">"previous reference policy during updates. The reference policy is updated according to the equation: "</span>
            <span class="token string">"`π_ref = α * π_θ + (1 - α) * π_ref_prev`. To use this parameter, you must set `sync_ref_model=True`."</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token comment"># 控制参考模型与当前策略模型同步的频率</span>
    <span class="token comment"># 每隔 ref_model_sync_steps 步，参考模型会根据 ref_model_mixup_alpha 的规则与当前策略模型进行同步更新。</span>
    ref_model_sync_steps<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> field<span class="token punctuation">(</span>
        default<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>
        metadata<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">"help"</span><span class="token punctuation">:</span> <span class="token string">"τ parameter from the TR-DPO paper, which determines how frequently the current policy is "</span>
            <span class="token string">"synchronized with the reference policy. To use this parameter, you must set `sync_ref_model=True`."</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="GRPO_176">
     </a>
     GRPO训练器
    </h3>
    <p>
     将GRPO训练过程封装为一个
     <code>
      Trainer
     </code>
     的一个子类。
    </p>
    <pre><code class="prism language-py"><span class="token keyword">class</span> <span class="token class-name">GRPOtrainer</span><span class="token punctuation">(</span>Trainer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
            self<span class="token punctuation">,</span>
        model<span class="token punctuation">,</span>
        reward_funcs<span class="token punctuation">,</span>
        args<span class="token punctuation">,</span>
        train_dataset<span class="token punctuation">,</span>
        eval_dataset<span class="token punctuation">,</span>
        processing_class<span class="token punctuation">,</span>
        reward_processing_classes<span class="token punctuation">,</span>
        callbacks<span class="token punctuation">,</span>
        optimizers<span class="token punctuation">,</span>
        peft_config<span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
         <span class="token comment"># Training arguments</span>
        self<span class="token punctuation">.</span>max_prompt_length <span class="token operator">=</span> args<span class="token punctuation">.</span>max_prompt_length
        self<span class="token punctuation">.</span>max_completion_length <span class="token operator">=</span> args<span class="token punctuation">.</span>max_completion_length  <span class="token comment"># = |o_i| in the GRPO paper</span>
        self<span class="token punctuation">.</span>num_generations <span class="token operator">=</span> args<span class="token punctuation">.</span>num_generations  <span class="token comment"># = G in the GRPO paper</span>

         <span class="token comment"># Multi-step</span>
        self<span class="token punctuation">.</span>num_iterations <span class="token operator">=</span> args<span class="token punctuation">.</span>num_iterations  <span class="token comment"># = 𝜇 in the GRPO paper</span>
        self<span class="token punctuation">.</span>epsilon <span class="token operator">=</span> args<span class="token punctuation">.</span>epsilon <span class="token comment"># $\epsilon$超参数用于梯度clip</span>
        <span class="token comment"># Tracks the number of iterations (forward + backward passes), including those within a gradient accumulation cycle.</span>
        self<span class="token punctuation">.</span>_step <span class="token operator">=</span> <span class="token number">0</span>

        self<span class="token punctuation">.</span>_buffered_inputs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">]</span> <span class="token operator">*</span> args<span class="token punctuation">.</span>gradient_accumulation_steps
         <span class="token comment"># Initialize the metrics</span>
        self<span class="token punctuation">.</span>_metrics <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"train"</span><span class="token punctuation">:</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"eval"</span><span class="token punctuation">:</span> defaultdict<span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>log_completions <span class="token operator">=</span> args<span class="token punctuation">.</span>log_completions

        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>
            model<span class="token operator">=</span>model<span class="token punctuation">,</span>
            args<span class="token operator">=</span>args<span class="token punctuation">,</span>
            data_collator<span class="token operator">=</span>data_collator<span class="token punctuation">,</span>
            train_dataset<span class="token operator">=</span>train_dataset<span class="token punctuation">,</span>
            eval_dataset<span class="token operator">=</span>eval_dataset<span class="token punctuation">,</span>
            processing_class<span class="token operator">=</span>processing_class<span class="token punctuation">,</span>
            callbacks<span class="token operator">=</span>callbacks<span class="token punctuation">,</span>
            optimizers<span class="token operator">=</span>optimizers<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>generation_config <span class="token operator">=</span> GenerationConfig<span class="token punctuation">(</span>
            max_new_tokens<span class="token operator">=</span>self<span class="token punctuation">.</span>max_completion_length<span class="token punctuation">,</span>
            do_sample<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            pad_token_id<span class="token operator">=</span>processing_class<span class="token punctuation">.</span>pad_token_id<span class="token punctuation">,</span>
            temperature<span class="token operator">=</span>args<span class="token punctuation">.</span>temperature<span class="token punctuation">,</span>
            top_p<span class="token operator">=</span>args<span class="token punctuation">.</span>top_p<span class="token punctuation">,</span>
            top_k<span class="token operator">=</span>args<span class="token punctuation">.</span>top_k<span class="token punctuation">,</span>
            min_p<span class="token operator">=</span>args<span class="token punctuation">.</span>min_p<span class="token punctuation">,</span>
            repetition_penalty<span class="token operator">=</span>args<span class="token punctuation">.</span>repetition_penalty<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="token_231">
     </a>
     token对数概率计算
    </h4>
    <p>
     计算模型生成的每个token的对数概率,以控制模型在训练中的策略更新：
    </p>
    <pre><code class="prism language-py"><span class="token comment"># Get the per-token log probabilities for the completions for the model and the reference model</span>
    <span class="token decorator annotation punctuation">@profiling_decorator</span> <span class="token comment"># 性能分析</span>
    <span class="token keyword">def</span> <span class="token function">_get_per_token_logps</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model<span class="token punctuation">,</span> input_ids<span class="token punctuation">,</span> attention_mask<span class="token punctuation">,</span> logits_to_keep<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># We add 1 to `logits_to_keep` because the last logits of the sequence is later excluded</span>
        logits <span class="token operator">=</span> model<span class="token punctuation">(</span>input_ids<span class="token operator">=</span>input_ids<span class="token punctuation">,</span> attention_mask<span class="token operator">=</span>attention_mask<span class="token punctuation">,</span> logits_to_keep<span class="token operator">=</span>logits_to_keep <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>logits
        logits <span class="token operator">=</span> logits<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># (B, L-1, V), 排除最后一个 logit: 对应下一个token的预测</span>

        input_ids <span class="token operator">=</span> input_ids<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span>logits_to_keep<span class="token punctuation">:</span><span class="token punctuation">]</span>
        logits <span class="token operator">=</span> logits<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token operator">-</span>logits_to_keep<span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> selective_log_softmax<span class="token punctuation">(</span>logits<span class="token punctuation">,</span> input_ids<span class="token punctuation">)</span>  <span class="token comment">#  计算每个输入token的对数概率</span>
</code></pre>
    <h4>
     <a id="_245">
     </a>
     奖励矩阵计算
    </h4>
    <p>
     初始化奖励矩阵后，遍历所有预定义的奖励函数（可灵活定义为pytorch模型或普通python函数），分别计算奖励值后更新奖励矩阵：
    </p>
    <pre><code class="prism language-py"> rewards_per_func <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>prompts<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reward_funcs<span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span> <span class="token comment"># 初始化奖励矩阵</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>reward_func<span class="token punctuation">,</span> reward_processing_class<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>
            <span class="token builtin">zip</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reward_funcs<span class="token punctuation">,</span> self<span class="token punctuation">.</span>reward_processing_classes<span class="token punctuation">)</span> <span class="token comment"># 遍历所有的奖励函数</span>
        <span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>reward_func<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Module instead of PretrainedModel for compat with compiled models</span>
                reward_func_name <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"reward </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>reward_func<span class="token punctuation">.</span>config<span class="token punctuation">.</span>_name_or_path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                reward_func_name <span class="token operator">=</span> reward_func<span class="token punctuation">.</span>__name__
            <span class="token keyword">with</span> profiling_context<span class="token punctuation">(</span>self<span class="token punctuation">,</span> reward_func_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span> <span class="token comment"># 基于pytorch模型计算奖励值</span>
                    reward_func<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module 
                <span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># Module instead of PretrainedModel for compat with compiled models</span>
                    <span class="token keyword">if</span> is_conversational<span class="token punctuation">(</span>inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                        messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"messages"</span><span class="token punctuation">:</span> p <span class="token operator">+</span> c<span class="token punctuation">}</span> <span class="token keyword">for</span> p<span class="token punctuation">,</span> c <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>prompts<span class="token punctuation">,</span> completions<span class="token punctuation">)</span><span class="token punctuation">]</span>
                        texts <span class="token operator">=</span> <span class="token punctuation">[</span>apply_chat_template<span class="token punctuation">(</span>x<span class="token punctuation">,</span> reward_processing_class<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">"text"</span><span class="token punctuation">]</span> <span class="token keyword">for</span> x <span class="token keyword">in</span> messages<span class="token punctuation">]</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        texts <span class="token operator">=</span> <span class="token punctuation">[</span>p <span class="token operator">+</span> c <span class="token keyword">for</span> p<span class="token punctuation">,</span> c <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>prompts<span class="token punctuation">,</span> completions<span class="token punctuation">)</span><span class="token punctuation">]</span>
                    reward_inputs <span class="token operator">=</span> reward_processing_class<span class="token punctuation">(</span>
                        texts<span class="token punctuation">,</span> return_tensors<span class="token operator">=</span><span class="token string">"pt"</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> padding_side<span class="token operator">=</span><span class="token string">"right"</span><span class="token punctuation">,</span> add_special_tokens<span class="token operator">=</span><span class="token boolean">False</span>
                    <span class="token punctuation">)</span>
                    reward_inputs <span class="token operator">=</span> <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>_prepare_inputs<span class="token punctuation">(</span>reward_inputs<span class="token punctuation">)</span>
                    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>inference_mode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                        rewards_per_func<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> reward_func<span class="token punctuation">(</span><span class="token operator">**</span>reward_inputs<span class="token punctuation">)</span><span class="token punctuation">.</span>logits<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># Shape (B*G,)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token comment"># 基于python函数计算奖励值</span>
                    <span class="token comment"># Repeat all input columns (but "prompt" and "completion") to match the number of generations</span>
                    keys <span class="token operator">=</span> <span class="token punctuation">[</span>key <span class="token keyword">for</span> key <span class="token keyword">in</span> inputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">if</span> key <span class="token keyword">not</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">"prompt"</span><span class="token punctuation">,</span> <span class="token string">"completion"</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
                    reward_kwargs <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>key<span class="token punctuation">:</span> <span class="token punctuation">[</span>example<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">for</span> example <span class="token keyword">in</span> inputs<span class="token punctuation">]</span> <span class="token keyword">for</span> key <span class="token keyword">in</span> keys<span class="token punctuation">}</span>
                    output_reward_func <span class="token operator">=</span> reward_func<span class="token punctuation">(</span>prompts<span class="token operator">=</span>prompts<span class="token punctuation">,</span> completions<span class="token operator">=</span>completions<span class="token punctuation">,</span> <span class="token operator">**</span>reward_kwargs<span class="token punctuation">)</span>
                    rewards_per_func<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>output_reward_func<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> device<span class="token operator">=</span>device<span class="token punctuation">)</span>

</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0e8f6705c84447aba6e923efb43e5701.png"/>
    </p>
    <h4>
     <a id="_280">
     </a>
     组内优势计算
    </h4>
    <p>
     根据组内解答数(
     <code>
      num_generations
     </code>
     )，计算组内优势：
    </p>
    <pre><code class="prism language-py">		rewards_per_func <span class="token operator">=</span> gather<span class="token punctuation">(</span>rewards_per_func<span class="token punctuation">)</span>

        <span class="token comment"># Apply weights to each reward function's output and sum</span>
        rewards <span class="token operator">=</span> <span class="token punctuation">(</span>rewards_per_func <span class="token operator">*</span> self<span class="token punctuation">.</span>reward_weights<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment"># Compute grouped-wise rewards</span>
        mean_grouped_rewards <span class="token operator">=</span> rewards<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_generations<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        std_grouped_rewards <span class="token operator">=</span> rewards<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>num_generations<span class="token punctuation">)</span><span class="token punctuation">.</span>std<span class="token punctuation">(</span>dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment"># Normalize the rewards to compute the advantages</span>
        mean_grouped_rewards <span class="token operator">=</span> mean_grouped_rewards<span class="token punctuation">.</span>repeat_interleave<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_generations<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        std_grouped_rewards <span class="token operator">=</span> std_grouped_rewards<span class="token punctuation">.</span>repeat_interleave<span class="token punctuation">(</span>self<span class="token punctuation">.</span>num_generations<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
        advantages <span class="token operator">=</span> <span class="token punctuation">(</span>rewards <span class="token operator">-</span> mean_grouped_rewards<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>std_grouped_rewards <span class="token operator">+</span> <span class="token number">1e-4</span><span class="token punctuation">)</span>

</code></pre>
    <h4>
     <a id="_299">
     </a>
     计算损失函数
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5d2653ac5700471e831a5a4969d7ba38.png"/>
    </p>
    <p>
     根据deepseek math论文中公式(4), 计算
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        D 
         
         
         
           K 
          
         
           L 
          
         
        
       
      
        D_{KL}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           D
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3283em;">
              <span class="" style="top: -2.55em; margin-left: -0.0278em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0715em;">
                  K
                 </span>
                 <span class="mord mathnormal mtight">
                  L
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     的无偏估计：
    </p>
    <pre><code class="prism language-py"> <span class="token comment"># 计算参考模型与当前模型之间的KL散度</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>beta <span class="token operator">!=</span> <span class="token number">0.0</span><span class="token punctuation">:</span> <span class="token comment"># 当KL散度正则项的参数$beta$不为0时</span>
            ref_per_token_logps <span class="token operator">=</span> inputs<span class="token punctuation">[</span><span class="token string">"ref_per_token_logps"</span><span class="token punctuation">]</span>
            per_token_kl <span class="token operator">=</span> <span class="token punctuation">(</span>
                torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>ref_per_token_logps <span class="token operator">-</span> per_token_logps<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>ref_per_token_logps <span class="token operator">-</span> per_token_logps<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
            <span class="token punctuation">)</span> <span class="token comment"># KL散度的无偏估计，,deepseek math论文中公式(4)</span>

</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1f1ee8515461400aba7ec26a30d2ce11.png"/>
    </p>
    <p>
     根据deepseek math 论文中的公式(3),计算损失函数：
    </p>
    <pre><code class="prism language-py"> <span class="token comment"># Compute the loss</span>
        advantages <span class="token operator">=</span> inputs<span class="token punctuation">[</span><span class="token string">"advantages"</span><span class="token punctuation">]</span>
       
        old_per_token_logps <span class="token operator">=</span> inputs<span class="token punctuation">[</span><span class="token string">"old_per_token_logps"</span><span class="token punctuation">]</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>num_iterations <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">else</span> per_token_logps<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>
        coef_1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>per_token_logps <span class="token operator">-</span> old_per_token_logps<span class="token punctuation">)</span> <span class="token comment"># 新旧模型token概率的比值(先取log再取指数便于计算)</span>
        coef_2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>coef_1<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>epsilon<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">+</span> self<span class="token punctuation">.</span>epsilon<span class="token punctuation">)</span> <span class="token comment">#clip截断部分</span>
        per_token_loss1 <span class="token operator">=</span> coef_1 <span class="token operator">*</span> advantages<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 未截断的概率比值计算的损失</span>
        per_token_loss2 <span class="token operator">=</span> coef_2 <span class="token operator">*</span> advantages<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment"># 截断的概率比值计算的损失</span>
        per_token_loss <span class="token operator">=</span> <span class="token operator">-</span>torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>per_token_loss1<span class="token punctuation">,</span> per_token_loss2<span class="token punctuation">)</span> <span class="token comment"># 损失部分计算，最小化损失(最大化奖励)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>beta <span class="token operator">!=</span> <span class="token number">0.0</span><span class="token punctuation">:</span>
            per_token_loss <span class="token operator">=</span> per_token_loss <span class="token operator">+</span> self<span class="token punctuation">.</span>beta <span class="token operator">*</span> per_token_kl <span class="token comment"># deepseek math 论文中的公式(3)，GRPO目标函数</span>
        loss <span class="token operator">=</span> <span class="token punctuation">(</span>per_token_loss <span class="token operator">*</span> completion_mask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> completion_mask<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
    <p>
     记录KL散度平均值：
    </p>
    <pre><code class="prism language-py"> <span class="token comment"># 记录KL散度的平均值</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>beta <span class="token operator">!=</span> <span class="token number">0.0</span><span class="token punctuation">:</span>
            mean_kl <span class="token operator">=</span> <span class="token punctuation">(</span>per_token_kl <span class="token operator">*</span> completion_mask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> completion_mask<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>_metrics<span class="token punctuation">[</span>mode<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"kl"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>accelerator<span class="token punctuation">.</span>gather_for_metrics<span class="token punctuation">(</span>mean_kl<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     计算截断比例(clip ratio)：
    </p>
    <pre><code class="prism language-py"> <span class="token comment"># 计算截断比例</span>
        is_clipped <span class="token operator">=</span> <span class="token punctuation">(</span>per_token_loss1 <span class="token operator">&lt;</span> per_token_loss2<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        clip_ratio <span class="token operator">=</span> <span class="token punctuation">(</span>is_clipped <span class="token operator">*</span> completion_mask<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> completion_mask<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        self<span class="token punctuation">.</span>_metrics<span class="token punctuation">[</span>mode<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"clip_ratio"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>self<span class="token punctuation">.</span>accelerator<span class="token punctuation">.</span>gather_for_metrics<span class="token punctuation">(</span>clip_ratio<span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h2>
     <a id="TRLGRPO_347">
     </a>
     案例实战：使用TRL库实现GRPO训练文本生成模型
    </h2>
    <p>
     这里给出一个用GRPO算法，在smoltldr数据集上训练SmolLM135M文本生成模型的demo例子。使用trl、peft库实现GRPO和LORA微调。
     <br/>
     <strong>
      数据集介绍
     </strong>
     <br/>
     mlabonne/smoltldr 是一个包含短篇小说列表的数据集，由用户 mlabonne 在 Hugging Face 上创建并维护。该数据集主要用于自然语言处理任务，例如文本生成、故事创作等。数据集中的每个样本通常是一个短篇故事，内容可能涵盖多种主题和风格。这些故事经过清洗和格式化，适合用于训练语言模型。SmolLM-135M则是用于文本生成的小模型。
    </p>
    <p>
     <strong>
      数据和模型加载
     </strong>
    </p>
    <pre><code class="prism language-py"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> wandb
<span class="token keyword">from</span> datasets <span class="token keyword">import</span> load_dataset
<span class="token keyword">from</span> peft <span class="token keyword">import</span> LoraConfig<span class="token punctuation">,</span>get_peft_model
<span class="token keyword">from</span> transformers <span class="token keyword">import</span> AutoModelForCausalLM<span class="token punctuation">,</span>AutoTokenizer
<span class="token keyword">from</span> trl <span class="token keyword">import</span> GRPOConfig<span class="token punctuation">,</span>GRPOTrainer


wandb<span class="token punctuation">.</span>login<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 登录wandb，输入api key，保存训练结果到wandb</span>

<span class="token comment"># 加载huggingface上的数据集</span>
dataset <span class="token operator">=</span> load_dataset<span class="token punctuation">(</span><span class="token string">"mlabonne/smoltldr"</span><span class="token punctuation">)</span>

<span class="token comment"># 加载huggingface上的模型</span>
model_id <span class="token operator">=</span> <span class="token string">"HuggingFaceTB/SmolLM-135M-Instruct"</span>
model <span class="token operator">=</span> AutoModelForCausalLM<span class="token punctuation">(</span>
    model_id<span class="token punctuation">,</span>
    torch_dtype <span class="token operator">=</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
    device_map <span class="token operator">=</span> <span class="token string">"auto"</span><span class="token punctuation">,</span>
    <span class="token comment"># attn_implementation = "flash_attention_2",</span>
    attn_implementation <span class="token operator">=</span> <span class="token string">"eager"</span><span class="token punctuation">,</span><span class="token comment"># GPU不支持flashattention时改用标准注意力</span>
<span class="token punctuation">)</span>
tokenizer <span class="token operator">=</span> AutoTokenizer<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>model_id<span class="token punctuation">)</span>

</code></pre>
    <p>
     <strong>
      LORA微调配置
     </strong>
    </p>
    <pre><code class="prism language-py">
<span class="token comment"># 加载PEFT库中的lora配置</span>
lora_config <span class="token operator">=</span> LoraConfig<span class="token punctuation">(</span>
    task_type <span class="token operator">=</span> <span class="token string">"CAUSAL_LM"</span><span class="token punctuation">,</span> <span class="token comment"># 生成式任务</span>
    r<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token comment"># 秩为16</span>
    lora_alpha<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> <span class="token comment"># 低秩矩阵权重贡献的缩放因子设为32</span>
    target_modules <span class="token operator">=</span> <span class="token string">"all-linear"</span><span class="token punctuation">,</span><span class="token comment"># 模型中的线性层应用lora</span>
<span class="token punctuation">)</span>
model <span class="token operator">=</span> get_peft_model<span class="token punctuation">(</span>model<span class="token punctuation">,</span>lora_config<span class="token punctuation">)</span> <span class="token comment"># 冻结预训练模型的所有参数，根据lora_config在模型中添加低秩矩阵</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>print_trainable_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 打印模型中可训练参数的数量及占总参数的比例</span>

</code></pre>
    <p>
     <strong>
      定义奖励函数
     </strong>
    </p>
    <pre><code class="prism language-py">
<span class="token comment"># 定义奖励函数</span>
<span class="token keyword">def</span> <span class="token function">reward_len</span><span class="token punctuation">(</span>completions<span class="token punctuation">,</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token operator">-</span><span class="token builtin">len</span><span class="token punctuation">(</span>completion<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> completion <span class="token keyword">in</span> completions<span class="token punctuation">]</span>

</code></pre>
    <p>
     <strong>
      GRPO训练参数设置
     </strong>
    </p>
    <pre><code class="prism language-py">
<span class="token comment"># GRPO训练参数配置</span>
training_args <span class="token operator">=</span> GRPOConfig<span class="token punctuation">(</span>
    output_dir<span class="token operator">=</span><span class="token string">"GRPO"</span><span class="token punctuation">,</span>
    run_name<span class="token operator">=</span><span class="token string">"GRPO_experi_0308_01"</span><span class="token punctuation">,</span><span class="token comment"># wandb保存的实验名称</span>
    learning_rate<span class="token operator">=</span><span class="token number">2e-5</span><span class="token punctuation">,</span>
    per_device_train_batch_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token comment"># 批量大小设小一点减少显存占用</span>
    gradient_accumulation_steps<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment"># 梯度累积步数</span>
    max_prompt_length<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>
    max_completion_length<span class="token operator">=</span><span class="token number">96</span><span class="token punctuation">,</span>
    num_generations<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token comment"># GRPO每组生成的解答数</span>
    optim<span class="token operator">=</span><span class="token string">"adamW_8bit"</span><span class="token punctuation">,</span>
    num_train_epochs<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token comment"># 训练数据集训练的总轮数</span>
    bf16<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    report_to<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"wandb"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    remove_unused_columns<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span><span class="token comment"># 不移除数据集中未使用的列</span>
    logging_steps<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token comment"># 每隔一步记录一次日志</span>
<span class="token punctuation">)</span>
<span class="token comment"># 设置训练器</span>
trainer <span class="token operator">=</span> GRPOTrainer<span class="token punctuation">(</span>
    model<span class="token operator">=</span>model<span class="token punctuation">,</span>
    reward_funcs <span class="token operator">=</span> <span class="token punctuation">[</span>reward_len<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token comment"># 自定义的奖励函数</span>
    agrs<span class="token operator">=</span>training_args<span class="token punctuation">,</span><span class="token comment"># GRPO的训练配置</span>
    train_dataset <span class="token operator">=</span> dataset<span class="token punctuation">[</span><span class="token string">"train"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

</code></pre>
    <p>
     <strong>
      训练模型
     </strong>
    </p>
    <pre><code class="prism language-py"><span class="token comment"># 训练模型</span>
wandb<span class="token punctuation">.</span>init<span class="token punctuation">(</span>project<span class="token operator">=</span><span class="token string">"GRPO"</span><span class="token punctuation">)</span> <span class="token comment"># 初始化wandb日志环境</span>
trainer<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 开始训练</span>

</code></pre>
    <p>
     <strong>
      上传训练完成的模型参数
     </strong>
    </p>
    <pre><code class="prism language-py">
<span class="token comment"># 保存模型参数，上传到huggingface hub</span>
merged_model <span class="token operator">=</span> trainer<span class="token punctuation">.</span>model<span class="token punctuation">.</span>merge_and_unload<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 合并lora权重和预训练权重</span>
merged_model<span class="token punctuation">.</span>push_to_hub<span class="token punctuation">(</span><span class="token string">"&lt;your_username/your_modelname&gt;"</span><span class="token punctuation">,</span>private<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># 模型公开可见</span>

</code></pre>
    <p>
     <strong>
      下载训练好的模型参数进行文本生成
     </strong>
    </p>
    <pre><code class="prism language-py">
prompt <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
# A long document about the Cat

The cat (Felis catus), also referred to as the domestic cat or house cat, is a small
domesticated carnivorous mammal. It is the only domesticated species of the family Felidae.
Advances in archaeology and genetics have shown that the domestication of the cat occurred
in the Near East around 7500 BC. It is commonly kept as a pet and farm cat, but also ranges
freely as a feral cat avoiding human contact. It is valued by humans for companionship and
its ability to kill vermin. Its retractable claws are adapted to killing small prey species
such as mice and rats. It has a strong, flexible body, quick reflexes, and sharp teeth,
and its night vision and sense of smell are well developed. It is a social species,
but a solitary hunter and a crepuscular predator. Cat communication includes
vocalizations—including meowing, purring, trilling, hissing, growling, and grunting—as
well as body language. It can hear sounds too faint or too high in frequency for human ears,
such as those made by small mammals. It secretes and perceives pheromones.
"""</span>
messages <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span><span class="token string">"user"</span><span class="token punctuation">,</span><span class="token string">"content"</span><span class="token punctuation">:</span>prompt<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>

<span class="token keyword">from</span> transformers <span class="token keyword">import</span> pipeline
generator <span class="token operator">=</span> pipeline<span class="token punctuation">(</span><span class="token string">"text-generation"</span><span class="token punctuation">,</span>model<span class="token operator">=</span><span class="token string">"&lt;your_username/your_modelname&gt;"</span><span class="token punctuation">)</span>
generate_kwargs <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"max_new_tokens"</span><span class="token punctuation">:</span> <span class="token number">256</span><span class="token punctuation">,</span>
    <span class="token string">"do_sample"</span><span class="token punctuation">:</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token comment"># 启用采样生成模式</span>
    <span class="token string">"temperature"</span><span class="token punctuation">:</span><span class="token number">0.5</span><span class="token punctuation">,</span> 
    <span class="token string">"min_p"</span><span class="token punctuation">:</span><span class="token number">0.1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
generated_text <span class="token operator">=</span> generator<span class="token punctuation">(</span>messages<span class="token punctuation">,</span>generate_kwargs<span class="token operator">=</span>generate_kwargs<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>generated_text<span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      训练结果分析
     </strong>
     <br/>
     随着模型的学习，奖励函数的奖励值逐渐接近0。这表明模型正在学习生成正确长度的文本。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f306dd6a38eb43a7b866b16a20752da3.png">
      <br/>
      在GRPO中，损失函数的初始值为零，然后在训练过程中增加。GRPO中的损失与KL散度（相对于原始策略的上限）成正比。随着训练的进行，模型学会了生成更好地符合奖励函数的文本，导致它与初始策略的偏差越来越大。这种增加的偏差反映在上升的损失值中，实际上表明模型正在成功地适应以优化奖励函数。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0960cfed54f04d9a94c7d9fa5349c73c.png"/>
     </img>
    </p>
    <hr/>
    <h2>
     <a id="_488">
     </a>
     推荐阅读
    </h2>
    <ul>
     <li>
      抱抱脸25年3月更新中的深度推理课程： https://huggingface.co/reasoning-course
     </li>
     <li>
      DeepSeekMath: Pushing the Limits of Mathematical Reasoning in Open Language Models： https://arxiv.org/pdf/2402.03300
     </li>
    </ul>
    <h2>
     <a id="REF_491">
     </a>
     REF
    </h2>
    <ol>
     <li>
      DeepSeekMath: Pushing the Limits of Mathematical Reasoning in Open Language Models： https://arxiv.org/pdf/2402.03300
     </li>
     <li>
      https://github.com/huggingface/trl/blob/main/trl/trainer/grpo_trainer.py#L98
     </li>
     <li>
      https://github.com/huggingface/open-r1/blob/main/src/open_r1/grpo.py
     </li>
     <li>
      https://open-r1.com/#:~:text=Open%20R1%20is%20an%20open-source%20reproduction%20of%20DeepSeek-R1%2C,MIT%20license%2C%20though%20original%20training%20data%20remains%20proprietary.
     </li>
     <li>
      DeepSeek-R1: Incentivizing Reasoning Capability in LLMs via Reinforcement Learning https://arxiv.org/abs/2501.12948
     </li>
     <li>
      https://huggingface.co/learn/nlp-course/en/chapter12/1?fw=pt
     </li>
    </ol>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f7370617469616c5f636f6465722f:61727469636c652f64657461696c732f313436313033363937" class_="artid" style="display:none">
 </p>
</div>


