---
layout: post
title: "即插即用模块-KANLinear"
date: 2025-03-15 23:00:58 +0800
description: "KAN网络即Kolmogorov-Arnold 网络，是一类基于 Kolmogorov-Arnold 表示定理的神经网络架构，具有强大的非线性表达能力。在相同迭代次数下超越传统MLP，不仅训练速度更快，收敛性更好，而且在拟合复杂函数时的精度也明显提高。，使用时import这个代码文件，然后模型中的nn.Linear换成这个KANLinear即可。"
keywords: "即插即用模块--KANLinear"
categories: ['模型训练']
tags: ['深度学习', '人工智能', 'Python']
artid: "146287108"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146287108
    alt: "即插即用模块-KANLinear"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146287108
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146287108
cover: https://bing.ee123.net/img/rand?artid=146287108
image: https://bing.ee123.net/img/rand?artid=146287108
img: https://bing.ee123.net/img/rand?artid=146287108
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     即插即用模块--KANLinear
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="KAN_0">
     </a>
     KAN网络
    </h3>
    <p>
     KAN网络即Kolmogorov-Arnold 网络，是一类基于 Kolmogorov-Arnold 表示定理的神经网络架构，具有强大的非线性表达能力。在相同迭代次数下超越传统MLP，不仅训练速度更快，收敛性更好，而且在拟合复杂函数时的精度也明显提高。
    </p>
    <p>
     这是一个
     <strong>
      即插即用模块–KANLinear
     </strong>
     ，使用时import这个代码文件，然后模型中的nn.Linear换成这个KANLinear即可
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">import</span> math
<span class="token keyword">from</span> torchinfo <span class="token keyword">import</span> summary


<span class="token keyword">class</span> <span class="token class-name">KANLinear</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        in_features<span class="token punctuation">,</span>
        out_features<span class="token punctuation">,</span>
        grid_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
        spline_order<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
        scale_noise<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span>
        scale_base<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
        scale_spline<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
        enable_standalone_scale_spline<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
        base_activation<span class="token operator">=</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>SiLU<span class="token punctuation">,</span>
        grid_eps<span class="token operator">=</span><span class="token number">0.02</span><span class="token punctuation">,</span>
        grid_range<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>KANLinear<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>in_features <span class="token operator">=</span> in_features  <span class="token comment"># 输入特征数</span>
        self<span class="token punctuation">.</span>out_features <span class="token operator">=</span> out_features  <span class="token comment"># 输出特征数</span>
        self<span class="token punctuation">.</span>grid_size <span class="token operator">=</span> grid_size  <span class="token comment"># 网格大小</span>
        self<span class="token punctuation">.</span>spline_order <span class="token operator">=</span> spline_order  <span class="token comment"># 样条阶数</span>

        <span class="token comment"># 计算网格步长，并生成网格</span>
        <span class="token comment">#         网格的作用</span>
        <span class="token comment"># 定义B样条基函数的位置：</span>

        <span class="token comment"># B样条基函数是在特定的支持点上进行计算的，这些支持点由网格确定。</span>
        <span class="token comment"># 样条基函数在这些网格点上具有特定的值和形状。</span>
        <span class="token comment"># 确定样条基函数的间隔：</span>

        <span class="token comment"># 网格步长（h）决定了网格点之间的距离，从而影响样条基函数的平滑程度和覆盖范围。</span>
        <span class="token comment"># 网格越密集，样条基函数的分辨率越高，可以更精细地拟合数据。</span>
        <span class="token comment"># 构建用于插值和拟合的基础：</span>

        <span class="token comment"># 样条基函数利用这些网格点进行插值，能够构建出连续的、平滑的函数。</span>
        <span class="token comment"># 通过这些基函数，可以实现输入特征的复杂非线性变换。</span>
        h <span class="token operator">=</span> <span class="token punctuation">(</span>grid_range<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> grid_range<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> grid_size
        grid <span class="token operator">=</span> <span class="token punctuation">(</span>
            <span class="token punctuation">(</span>
                torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token operator">-</span>spline_order<span class="token punctuation">,</span> grid_size <span class="token operator">+</span> spline_order <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> h
                <span class="token operator">+</span> grid_range<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
            <span class="token punctuation">.</span>expand<span class="token punctuation">(</span>in_features<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>register_buffer<span class="token punctuation">(</span><span class="token string">"grid"</span><span class="token punctuation">,</span> grid<span class="token punctuation">)</span>  <span class="token comment"># 注册网格作为模型的buffer</span>
        <span class="token comment">#         在PyTorch中，buffer是一种特殊类型的张量，它在模型中起到辅助作用，但不会作为模型参数进行更新。buffer通常用于存储一些在前向和后向传播过程中需要用到的常量或中间结果。buffer和模型参数一样，会被包含在模型的状态字典中（state dictionary），可以与模型一起保存和加载。</span>

        <span class="token comment"># register_buffer 的作用</span>
        <span class="token comment"># self.register_buffer("grid", grid) 的作用是将 grid 注册为模型的一个buffer。这样做有以下几个好处：</span>

        <span class="token comment"># 持久化：buffer会被包含在模型的状态字典中，可以通过 state_dict 方法保存模型时一并保存，加载模型时也会一并恢复。这对于训练和推理阶段都很有用，确保所有相关的常量都能正确加载。</span>

        <span class="token comment"># 无需梯度更新：buffer不会在反向传播过程中计算梯度和更新。它们是固定的，只在前向传播中使用。这对于像网格点这样的常量非常适合，因为这些点在训练过程中是固定的，不需要更新。</span>

        <span class="token comment"># 易于使用：注册为 buffer 的张量可以像模型参数一样方便地访问和使用，而不必担心它们会被优化器错误地更新。</span>

        <span class="token comment"># 初始化网络参数和超参数</span>

        <span class="token comment"># 初始化基础权重参数，形状为 (out_features, in_features)</span>
        self<span class="token punctuation">.</span>base_weight <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>out_features<span class="token punctuation">,</span> in_features<span class="token punctuation">)</span><span class="token punctuation">)</span>

        <span class="token comment"># 初始化样条权重参数，形状为 (out_features, in_features, grid_size + spline_order)</span>
        self<span class="token punctuation">.</span>spline_weight <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>
            torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>out_features<span class="token punctuation">,</span> in_features<span class="token punctuation">,</span> grid_size <span class="token operator">+</span> spline_order<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

        <span class="token comment"># 如果启用了独立缩放样条功能，初始化样条缩放参数，形状为 (out_features, in_features)</span>
        <span class="token keyword">if</span> enable_standalone_scale_spline<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>spline_scaler <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>
                torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">(</span>out_features<span class="token punctuation">,</span> in_features<span class="token punctuation">)</span>
            <span class="token punctuation">)</span>

        <span class="token comment"># 噪声缩放系数，用于初始化样条权重时添加噪声</span>
        self<span class="token punctuation">.</span>scale_noise <span class="token operator">=</span> scale_noise

        <span class="token comment"># 基础权重的缩放系数，用于初始化基础权重时的缩放因子</span>
        self<span class="token punctuation">.</span>scale_base <span class="token operator">=</span> scale_base

        <span class="token comment"># 样条权重的缩放系数，用于初始化样条权重时的缩放因子</span>
        self<span class="token punctuation">.</span>scale_spline <span class="token operator">=</span> scale_spline

        <span class="token comment"># 是否启用独立的样条缩放功能</span>
        self<span class="token punctuation">.</span>enable_standalone_scale_spline <span class="token operator">=</span> enable_standalone_scale_spline

        <span class="token comment"># 基础激活函数实例，用于对输入进行非线性变换</span>
        self<span class="token punctuation">.</span>base_activation <span class="token operator">=</span> base_activation<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 网格更新时的小偏移量，用于在更新网格时引入微小变化，避免过拟合</span>
        self<span class="token punctuation">.</span>grid_eps <span class="token operator">=</span> grid_eps

        self<span class="token punctuation">.</span>reset_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">reset_parameters</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 使用kaiming_uniform_方法初始化基础权重参数base_weight</span>
        <span class="token comment"># 这个方法基于何凯明初始化，适用于具有ReLU等非线性激活函数的网络</span>
        torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>kaiming_uniform_<span class="token punctuation">(</span>self<span class="token punctuation">.</span>base_weight<span class="token punctuation">,</span> a<span class="token operator">=</span>math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>scale_base<span class="token punctuation">)</span>
        
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 为样条权重参数spline_weight添加噪声进行初始化</span>
            noise <span class="token operator">=</span> <span class="token punctuation">(</span>
                <span class="token punctuation">(</span>
                    torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>self<span class="token punctuation">.</span>grid_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>in_features<span class="token punctuation">,</span> self<span class="token punctuation">.</span>out_features<span class="token punctuation">)</span>
                    <span class="token operator">-</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">2</span>
                <span class="token punctuation">)</span>
                <span class="token operator">*</span> self<span class="token punctuation">.</span>scale_noise
                <span class="token operator">/</span> self<span class="token punctuation">.</span>grid_size
            <span class="token punctuation">)</span>
            
            <span class="token comment"># 计算样条权重参数的初始值，结合了scale_spline的缩放因子</span>
            self<span class="token punctuation">.</span>spline_weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>copy_<span class="token punctuation">(</span>
                <span class="token punctuation">(</span>self<span class="token punctuation">.</span>scale_spline <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>enable_standalone_scale_spline <span class="token keyword">else</span> <span class="token number">1.0</span><span class="token punctuation">)</span>
                <span class="token operator">*</span> self<span class="token punctuation">.</span>curve2coeff<span class="token punctuation">(</span>
                    self<span class="token punctuation">.</span>grid<span class="token punctuation">.</span>T<span class="token punctuation">[</span>self<span class="token punctuation">.</span>spline_order <span class="token punctuation">:</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>spline_order<span class="token punctuation">]</span><span class="token punctuation">,</span>
                    noise<span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
            
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>enable_standalone_scale_spline<span class="token punctuation">:</span>
                <span class="token comment"># torch.nn.init.constant_(self.spline_scaler, self.scale_spline)</span>
                <span class="token comment"># 作者此前使用了一般的初始化，效果不佳</span>
                <span class="token comment"># 使用kaiming_uniform_方法初始化样条缩放参数spline_scaler</span>
                torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>kaiming_uniform_<span class="token punctuation">(</span>self<span class="token punctuation">.</span>spline_scaler<span class="token punctuation">,</span> a<span class="token operator">=</span>math<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>scale_spline<span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">b_splines</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        计算给定输入张量的B样条基函数。
        B样条（B-splines）是一种用于函数逼近和插值的基函数。
        它们具有局部性、平滑性和数值稳定性等优点，广泛应用于计算机图形学、数据拟合和机器学习中。
        在这段代码中，B样条基函数用于在输入张量上进行非线性变换，以提高模型的表达能力。
        在KAN（Kolmogorov-Arnold Networks）模型中，B样条基函数用于将输入特征映射到高维空间中，以便在该空间中进行线性变换。
        具体来说，B样条基函数能够在给定的网格点上对输入数据进行插值和逼近，从而实现复杂的非线性变换。

        参数:
            x (torch.Tensor): 输入张量，形状为 (batch_size, in_features)。

        返回:
            torch.Tensor: B样条基函数张量，形状为 (batch_size, in_features, grid_size + spline_order)。
        """</span>
        <span class="token comment"># 确保输入张量的维度是2，并且其列数等于输入特征数</span>
        <span class="token keyword">assert</span> x<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token keyword">and</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>in_features

        <span class="token comment"># 获取网格点（包含在buffer中的self.grid）</span>
        grid<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor <span class="token operator">=</span> <span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>grid
        <span class="token punctuation">)</span>  <span class="token comment"># (in_features, grid_size + 2 * spline_order + 1)</span>

        <span class="token comment"># 为了进行逐元素操作，将输入张量的最后一维扩展一维</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token comment"># 初始化B样条基函数的基矩阵</span>
        bases <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">&gt;=</span> grid<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> grid<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>x<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>
        
        <span class="token comment"># 迭代计算样条基函数</span>
        <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>spline_order <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            bases <span class="token operator">=</span> <span class="token punctuation">(</span>
                <span class="token punctuation">(</span>x <span class="token operator">-</span> grid<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token operator">/</span> <span class="token punctuation">(</span>grid<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> k<span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> grid<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span> <span class="token operator">-</span><span class="token punctuation">(</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token operator">*</span> bases<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>
                <span class="token punctuation">(</span>grid<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> k <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">-</span> x<span class="token punctuation">)</span>
                <span class="token operator">/</span> <span class="token punctuation">(</span>grid<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> k <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">-</span> grid<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token operator">-</span>k<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token operator">*</span> bases<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>

        <span class="token comment"># 确保B样条基函数的输出形状正确</span>
        <span class="token keyword">assert</span> bases<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>
            x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>in_features<span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>grid_size <span class="token operator">+</span> self<span class="token punctuation">.</span>spline_order<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        <span class="token keyword">return</span> bases<span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">curve2coeff</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span> y<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        计算插值给定点的曲线的系数。
        curve2coeff 方法用于计算插值给定点的曲线的系数。
        这些系数用于表示插值曲线在特定点的形状和位置。
        具体来说，该方法通过求解线性方程组来找到B样条基函数在给定点上的插值系数。
        此方法的作用是根据输入和输出点计算B样条基函数的系数，
        使得这些基函数能够精确插值给定的输入输出点对。
        这样可以用于拟合数据或在模型中应用非线性变换。
        
        参数:
            x (torch.Tensor): 输入张量，形状为 (batch_size, in_features)。
            y (torch.Tensor): 输出张量，形状为 (batch_size, in_features, out_features)。

        返回:
            torch.Tensor: 系数张量，形状为 (out_features, in_features, grid_size + spline_order)。
        """</span>
        <span class="token comment"># 确保输入张量的维度是2，并且其列数等于输入特征数</span>
        <span class="token keyword">assert</span> x<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token keyword">and</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>in_features
        
        <span class="token comment"># 确保输出张量的形状正确</span>
        <span class="token keyword">assert</span> y<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>in_features<span class="token punctuation">,</span> self<span class="token punctuation">.</span>out_features<span class="token punctuation">)</span>

        <span class="token comment"># 计算B样条基函数</span>
        A <span class="token operator">=</span> self<span class="token punctuation">.</span>b_splines<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># (in_features, batch_size, grid_size + spline_order)</span>
        
        <span class="token comment"># 转置输出张量</span>
        B <span class="token operator">=</span> y<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># (in_features, batch_size, out_features)</span>
        
        <span class="token comment"># 使用线性代数方法求解线性方程组，找到系数</span>
        solution <span class="token operator">=</span> torch<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>lstsq<span class="token punctuation">(</span>A<span class="token punctuation">,</span> B<span class="token punctuation">)</span><span class="token punctuation">.</span>solution  <span class="token comment"># (in_features, grid_size + spline_order, out_features)</span>
        
        <span class="token comment"># 调整结果的形状</span>
        result <span class="token operator">=</span> solution<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># (out_features, in_features, grid_size + spline_order)</span>

        <span class="token comment"># 确保结果张量的形状正确</span>
        <span class="token keyword">assert</span> result<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>out_features<span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>in_features<span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>grid_size <span class="token operator">+</span> self<span class="token punctuation">.</span>spline_order<span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        
        <span class="token comment"># 返回连续存储的结果张量</span>
        <span class="token keyword">return</span> result<span class="token punctuation">.</span>contiguous<span class="token punctuation">(</span><span class="token punctuation">)</span>


    <span class="token decorator annotation punctuation">@property</span>
    <span class="token keyword">def</span> <span class="token function">scaled_spline_weight</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        计算带有缩放因子的样条权重。

        样条缩放：如果启用了 enable_standalone_scale_spline，
        则将 spline_scaler 张量扩展一维后与 spline_weight 相乘，
        否则直接返回 spline_weight。

        具体来说，spline_weight 是一个三维张量，形状为 (out_features, in_features, grid_size + spline_order)。
        而 spline_scaler 是一个二维张量，形状为 (out_features, in_features)。
        为了使 spline_scaler 能够与 spline_weight 逐元素相乘，
        需要将 spline_scaler 的最后一维扩展，以匹配 spline_weight 的第三维。

        返回:
            torch.Tensor: 带有缩放因子的样条权重张量。
        """</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>spline_weight <span class="token operator">*</span> <span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>spline_scaler<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>enable_standalone_scale_spline
            <span class="token keyword">else</span> <span class="token number">1.0</span>
        <span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        实现模型的前向传播。

        参数:
            x (torch.Tensor): 输入张量，形状为 (batch_size, in_features)。

        返回:
            torch.Tensor: 输出张量，形状为 (batch_size, out_features)。
        """</span>
        <span class="token comment"># 确保输入张量的最后一维大小等于输入特征数</span>
        <span class="token keyword">assert</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>in_features
        
        <span class="token comment"># 保存输入张量的原始形状</span>
        original_shape <span class="token operator">=</span> x<span class="token punctuation">.</span>shape
        
        <span class="token comment"># 将输入张量展平为二维</span>
        x <span class="token operator">=</span> x<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>in_features<span class="token punctuation">)</span>

        <span class="token comment"># 计算基础线性变换的输出</span>
        base_output <span class="token operator">=</span> F<span class="token punctuation">.</span>linear<span class="token punctuation">(</span>self<span class="token punctuation">.</span>base_activation<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>base_weight<span class="token punctuation">)</span>
        
        <span class="token comment"># 计算B样条基函数的输出</span>
        spline_output <span class="token operator">=</span> F<span class="token punctuation">.</span>linear<span class="token punctuation">(</span>
            self<span class="token punctuation">.</span>b_splines<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            self<span class="token punctuation">.</span>scaled_spline_weight<span class="token punctuation">.</span>view<span class="token punctuation">(</span>self<span class="token punctuation">.</span>out_features<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        
        <span class="token comment"># 合并基础输出和样条输出</span>
        output <span class="token operator">=</span> base_output <span class="token operator">+</span> spline_output
        
        <span class="token comment"># 恢复输出张量的形状</span>
        output <span class="token operator">=</span> output<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">*</span>original_shape<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>out_features<span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> output


    <span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>no_grad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">update_grid</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span> margin<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        update_grid 方法用于根据输入数据动态更新B样条的网格点，从而适应输入数据的分布。
        该方法通过重新计算和调整网格点，确保B样条基函数能够更好地拟合数据。
        这在训练过程中可能会提高模型的精度和稳定性。

        参数:
            x (torch.Tensor): 输入张量，形状为 (batch_size, in_features)。
            margin (float): 网格更新的边缘大小，用于在更新网格时引入微小变化。
        """</span>
        <span class="token comment"># 确保输入张量的维度正确</span>
        <span class="token keyword">assert</span> x<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token keyword">and</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> self<span class="token punctuation">.</span>in_features
        batch <span class="token operator">=</span> x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 获取批量大小</span>

        <span class="token comment"># 计算输入张量的B样条基函数</span>
        splines <span class="token operator">=</span> self<span class="token punctuation">.</span>b_splines<span class="token punctuation">(</span>x<span class="token punctuation">)</span>  <span class="token comment"># (batch, in, coeff)</span>
        splines <span class="token operator">=</span> splines<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 转置为 (in, batch, coeff)</span>

        <span class="token comment"># 获取当前的样条权重</span>
        orig_coeff <span class="token operator">=</span> self<span class="token punctuation">.</span>scaled_spline_weight  <span class="token comment"># (out, in, coeff)</span>
        orig_coeff <span class="token operator">=</span> orig_coeff<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 转置为 (in, coeff, out)</span>

        <span class="token comment"># 计算未缩减的样条输出</span>
        unreduced_spline_output <span class="token operator">=</span> torch<span class="token punctuation">.</span>bmm<span class="token punctuation">(</span>splines<span class="token punctuation">,</span> orig_coeff<span class="token punctuation">)</span>  <span class="token comment"># (in, batch, out)</span>
        unreduced_spline_output <span class="token operator">=</span> unreduced_spline_output<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token comment"># 转置为 (batch, in, out)</span>

        <span class="token comment"># 为了收集数据分布，对每个通道分别进行排序</span>
        x_sorted <span class="token operator">=</span> torch<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>x<span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        grid_adaptive <span class="token operator">=</span> x_sorted<span class="token punctuation">[</span>
            torch<span class="token punctuation">.</span>linspace<span class="token punctuation">(</span>
                <span class="token number">0</span><span class="token punctuation">,</span> batch <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>grid_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>int64<span class="token punctuation">,</span> device<span class="token operator">=</span>x<span class="token punctuation">.</span>device
            <span class="token punctuation">)</span>
        <span class="token punctuation">]</span>

        <span class="token comment"># 计算均匀步长，并生成均匀网格</span>
        uniform_step <span class="token operator">=</span> <span class="token punctuation">(</span>x_sorted<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> x_sorted<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> margin<span class="token punctuation">)</span> <span class="token operator">/</span> self<span class="token punctuation">.</span>grid_size
        grid_uniform <span class="token operator">=</span> <span class="token punctuation">(</span>
            torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>
                self<span class="token punctuation">.</span>grid_size <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">,</span> device<span class="token operator">=</span>x<span class="token punctuation">.</span>device
            <span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token operator">*</span> uniform_step
            <span class="token operator">+</span> x_sorted<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token operator">-</span> margin
        <span class="token punctuation">)</span>

        <span class="token comment"># 混合均匀网格和自适应网格</span>
        grid <span class="token operator">=</span> self<span class="token punctuation">.</span>grid_eps <span class="token operator">*</span> grid_uniform <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>grid_eps<span class="token punctuation">)</span> <span class="token operator">*</span> grid_adaptive

        <span class="token comment"># 扩展网格以包括样条边界</span>
        grid <span class="token operator">=</span> torch<span class="token punctuation">.</span>concatenate<span class="token punctuation">(</span>
            <span class="token punctuation">[</span>
                grid<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">]</span>
                <span class="token operator">-</span> uniform_step
                <span class="token operator">*</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span>self<span class="token punctuation">.</span>spline_order<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>x<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                grid<span class="token punctuation">,</span>
                grid<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
                <span class="token operator">+</span> uniform_step
                <span class="token operator">*</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>spline_order <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> device<span class="token operator">=</span>x<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

        <span class="token comment"># 更新模型中的网格点</span>
        self<span class="token punctuation">.</span>grid<span class="token punctuation">.</span>copy_<span class="token punctuation">(</span>grid<span class="token punctuation">.</span>T<span class="token punctuation">)</span>

        <span class="token comment"># 重新计算样条权重</span>
        self<span class="token punctuation">.</span>spline_weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>copy_<span class="token punctuation">(</span>self<span class="token punctuation">.</span>curve2coeff<span class="token punctuation">(</span>x<span class="token punctuation">,</span> unreduced_spline_output<span class="token punctuation">)</span><span class="token punctuation">)</span>


    <span class="token keyword">def</span> <span class="token function">regularization_loss</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> regularize_activation<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span> regularize_entropy<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        计算正则化损失。

        这是对论文中提到的原始L1正则化的一种简单模拟，因为原始方法需要从
        展开的 (batch, in_features, out_features) 中间张量计算绝对值和熵，
        但如果我们想要一个高效的内存实现，这些张量会被隐藏在F.linear函数后面。

        现在的L1正则化计算为样条权重的平均绝对值。
        作者的实现还包括这个项，此外还有基于样本的正则化。
        """</span>
        <span class="token comment"># 计算样条权重的绝对值的平均值</span>
        l1_fake <span class="token operator">=</span> self<span class="token punctuation">.</span>spline_weight<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 计算激活正则化损失，即所有样条权重绝对值的和</span>
        regularization_loss_activation <span class="token operator">=</span> l1_fake<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 计算每个权重占总和的比例</span>
        p <span class="token operator">=</span> l1_fake <span class="token operator">/</span> regularization_loss_activation
        
        <span class="token comment"># 计算熵正则化损失，即上述比例的负熵</span>
        regularization_loss_entropy <span class="token operator">=</span> <span class="token operator">-</span>torch<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>p <span class="token operator">*</span> p<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 返回总的正则化损失，包含激活正则化和熵正则化</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            regularize_activation <span class="token operator">*</span> regularization_loss_activation
            <span class="token operator">+</span> regularize_entropy <span class="token operator">*</span> regularization_loss_entropy
        <span class="token punctuation">)</span>


<span class="token comment">########################################################## 类定义</span>
<span class="token keyword">class</span> <span class="token class-name">KAN</span><span class="token punctuation">(</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        layers_hidden<span class="token punctuation">,</span>
        grid_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
        spline_order<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
        scale_noise<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span>
        scale_base<span class="token operator">=</span><span class="token number">0.3</span><span class="token punctuation">,</span>
        scale_spline<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
        base_activation<span class="token operator">=</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>SiLU<span class="token punctuation">,</span>
        grid_eps<span class="token operator">=</span><span class="token number">0.02</span><span class="token punctuation">,</span>
        grid_range<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        初始化KAN模型。

        参数:
            layers_hidden (list): 每层的输入和输出特征数列表。
            grid_size (int): 网格大小。
            spline_order (int): 样条阶数。
            scale_noise (float): 样条权重初始化时的噪声缩放系数。
            scale_base (float): 基础权重初始化时的缩放系数。
            scale_spline (float): 样条权重初始化时的缩放系数。
            base_activation (nn.Module): 基础激活函数类。
            grid_eps (float): 网格更新时的小偏移量。
            grid_range (list): 网格范围。
        """</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>KAN<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>grid_size <span class="token operator">=</span> grid_size  <span class="token comment"># 网格大小</span>
        self<span class="token punctuation">.</span>spline_order <span class="token operator">=</span> spline_order  <span class="token comment"># 样条阶数</span>

        <span class="token comment"># 初始化模型层</span>
        self<span class="token punctuation">.</span>layers <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>ModuleList<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> in_features<span class="token punctuation">,</span> out_features <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>layers_hidden<span class="token punctuation">,</span> layers_hidden<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>layers<span class="token punctuation">.</span>append<span class="token punctuation">(</span>
                KANLinear<span class="token punctuation">(</span>
                    in_features<span class="token punctuation">,</span>
                    out_features<span class="token punctuation">,</span>
                    grid_size<span class="token operator">=</span>grid_size<span class="token punctuation">,</span>
                    spline_order<span class="token operator">=</span>spline_order<span class="token punctuation">,</span>
                    scale_noise<span class="token operator">=</span>scale_noise<span class="token punctuation">,</span>
                    scale_base<span class="token operator">=</span>scale_base<span class="token punctuation">,</span>
                    scale_spline<span class="token operator">=</span>scale_spline<span class="token punctuation">,</span>
                    base_activation<span class="token operator">=</span>base_activation<span class="token punctuation">,</span>
                    grid_eps<span class="token operator">=</span>grid_eps<span class="token punctuation">,</span>
                    grid_range<span class="token operator">=</span>grid_range<span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span> update_grid<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        实现模型的前向传播。

        参数:
            x (torch.Tensor): 输入张量，形状为 (batch_size, in_features)。
            update_grid (bool): 是否在前向传播过程中更新网格。

        返回:
            torch.Tensor: 输出张量，形状为 (batch_size, out_features)。
        """</span>
        <span class="token keyword">for</span> layer <span class="token keyword">in</span> self<span class="token punctuation">.</span>layers<span class="token punctuation">:</span>
            <span class="token keyword">if</span> update_grid<span class="token punctuation">:</span>
                layer<span class="token punctuation">.</span>update_grid<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
            x <span class="token operator">=</span> layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> x

    <span class="token keyword">def</span> <span class="token function">regularization_loss</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> regularize_activation<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span> regularize_entropy<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        计算模型的正则化损失。

        参数:
            regularize_activation (float): 激活正则化系数。
            regularize_entropy (float): 熵正则化系数。

        返回:
            float: 总的正则化损失。
        """</span>
        <span class="token keyword">return</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>
            layer<span class="token punctuation">.</span>regularization_loss<span class="token punctuation">(</span>regularize_activation<span class="token punctuation">,</span> regularize_entropy<span class="token punctuation">)</span>
            <span class="token keyword">for</span> layer <span class="token keyword">in</span> self<span class="token punctuation">.</span>layers
        <span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">demo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 定义模型的隐藏层结构，每层的输入和输出维度</span>
    layers_hidden <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span>

    <span class="token comment"># 创建5层的FourierKAN模型</span>
    model <span class="token operator">=</span> KAN<span class="token punctuation">(</span>
        layers_hidden<span class="token punctuation">,</span>
        grid_size<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
        spline_order<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>
        scale_noise<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
        scale_base<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span>
        scale_spline<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span>
        base_activation<span class="token operator">=</span>torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>SiLU<span class="token punctuation">,</span>
        grid_eps<span class="token operator">=</span><span class="token number">0.02</span><span class="token punctuation">,</span>
        grid_range<span class="token operator">=</span><span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>

    <span class="token comment"># 打印模型结构</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    <span class="token comment"># 使用torchsummary输出模型结构</span>
    summary<span class="token punctuation">(</span>model<span class="token punctuation">,</span> input_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 假设输入特征为64维</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    demo<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># ==========================================================================================</span>
<span class="token comment"># Layer (type:depth-idx)                   Output Shape              Param #</span>
<span class="token comment"># ==========================================================================================</span>
<span class="token comment"># KAN                                      [32]                      --</span>
<span class="token comment"># ├─ModuleList: 1-1                        --                        --</span>
<span class="token comment"># │    └─KANLinear: 2-1                    [128]                     81,920</span>
<span class="token comment"># │    │    └─SiLU: 3-1                    [1, 64]                   --</span>
<span class="token comment"># │    └─KANLinear: 2-2                    [256]                     327,680</span>
<span class="token comment"># │    │    └─SiLU: 3-2                    [1, 128]                  --</span>
<span class="token comment"># │    └─KANLinear: 2-3                    [128]                     327,680</span>
<span class="token comment"># │    │    └─SiLU: 3-3                    [1, 256]                  --</span>
<span class="token comment"># │    └─KANLinear: 2-4                    [64]                      81,920</span>
<span class="token comment"># │    │    └─SiLU: 3-4                    [1, 128]                  --</span>
<span class="token comment"># │    └─KANLinear: 2-5                    [32]                      20,480</span>
<span class="token comment"># │    │    └─SiLU: 3-5                    [1, 64]                   --</span>
<span class="token comment"># ==========================================================================================</span>
<span class="token comment"># Total params: 839,680</span>
</code></pre>
    <p>
     更多详细代码详情请移步GitHub：
     <br/>
     <a href="https://github.com/lgy112112/Efficient-KAN-in-Chinese">
      lgy112112 Efficient-KAN-in-Chinese
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f73676c643939352f:61727469636c652f64657461696c732f313436323837313038" class_="artid" style="display:none">
 </p>
</div>


