---
layout: post
title: "Flink-SQL-读取-Kafka-数据到-Mysql-实战"
date: 2025-03-08 10:37:48 +0800
description: "通过Flinksql使用DDL的方式，实现读取kafka用户行为数据，对数据进行实时处理，根据时间分组，求PV 和UV ，然后输出到 mysql 中。5、观察mysql数据库中。"
keywords: "Flink SQL 读取 Kafka 数据到 Mysql 实战"
categories: ['大数据技术学习']
tags: ['Sql', 'Kafka', 'Flink']
artid: "146112299"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146112299
    alt: "Flink-SQL-读取-Kafka-数据到-Mysql-实战"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146112299
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146112299
cover: https://bing.ee123.net/img/rand?artid=146112299
image: https://bing.ee123.net/img/rand?artid=146112299
img: https://bing.ee123.net/img/rand?artid=146112299
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Flink SQL 读取 Kafka 数据到 Mysql 实战
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="Flink_192__SQL__Kafka__Mysql__0">
     </a>
     Flink 1.9.2 SQL 读取 Kafka 数据到 Mysql 实战
    </h3>
    <h4>
     <a id="_2">
     </a>
     案例需求
    </h4>
    <blockquote>
     <p>
      通过Flinksql使用DDL的方式，实现读取kafka用户行为数据，对数据进行实时处理，根据时间分组，求PV 和UV ，然后输出到 mysql 中。
     </p>
    </blockquote>
    <h5>
     <a id="1kafka_8">
     </a>
     1、kafka中的消息的格式
    </h5>
    <ul>
     <li>
      数据以 JSON 格式编码，格式如下：
     </li>
    </ul>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span><span class="token string-property property">"user_id"</span><span class="token operator">:</span><span class="token number">1101</span><span class="token punctuation">,</span><span class="token string-property property">"item_id"</span><span class="token operator">:</span><span class="token number">1875</span><span class="token punctuation">,</span><span class="token string-property property">"category_id"</span><span class="token operator">:</span><span class="token number">456876</span><span class="token punctuation">,</span><span class="token string-property property">"behavior"</span><span class="token operator">:</span><span class="token string">"pv"</span><span class="token punctuation">,</span><span class="token string-property property">"ts"</span><span class="token operator">:</span><span class="token string">"2017-12-13T11:27:50Z"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string-property property">"user_id"</span><span class="token operator">:</span><span class="token number">1101</span><span class="token punctuation">,</span><span class="token string-property property">"item_id"</span><span class="token operator">:</span><span class="token number">1875</span><span class="token punctuation">,</span><span class="token string-property property">"category_id"</span><span class="token operator">:</span><span class="token number">456876</span><span class="token punctuation">,</span><span class="token string-property property">"behavior"</span><span class="token operator">:</span><span class="token string">"pv"</span><span class="token punctuation">,</span><span class="token string-property property">"ts"</span><span class="token operator">:</span><span class="token string">"2017-12-13T11:27:51Z"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string-property property">"user_id"</span><span class="token operator">:</span><span class="token number">1102</span><span class="token punctuation">,</span><span class="token string-property property">"item_id"</span><span class="token operator">:</span><span class="token number">1876</span><span class="token punctuation">,</span><span class="token string-property property">"category_id"</span><span class="token operator">:</span><span class="token number">456876</span><span class="token punctuation">,</span><span class="token string-property property">"behavior"</span><span class="token operator">:</span><span class="token string">"pv"</span><span class="token punctuation">,</span><span class="token string-property property">"ts"</span><span class="token operator">:</span><span class="token string">"2017-12-13T11:27:54Z"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string-property property">"user_id"</span><span class="token operator">:</span><span class="token number">1103</span><span class="token punctuation">,</span><span class="token string-property property">"item_id"</span><span class="token operator">:</span><span class="token number">1877</span><span class="token punctuation">,</span><span class="token string-property property">"category_id"</span><span class="token operator">:</span><span class="token number">456876</span><span class="token punctuation">,</span><span class="token string-property property">"behavior"</span><span class="token operator">:</span><span class="token string">"pv"</span><span class="token punctuation">,</span><span class="token string-property property">"ts"</span><span class="token operator">:</span><span class="token string">"2017-12-13T11:27:55Z"</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token string-property property">"user_id"</span><span class="token operator">:</span><span class="token number">1104</span><span class="token punctuation">,</span><span class="token string-property property">"item_id"</span><span class="token operator">:</span><span class="token number">1878</span><span class="token punctuation">,</span><span class="token string-property property">"category_id"</span><span class="token operator">:</span><span class="token number">456876</span><span class="token punctuation">,</span><span class="token string-property property">"behavior"</span><span class="token operator">:</span><span class="token string">"pv"</span><span class="token punctuation">,</span><span class="token string-property property">"ts"</span><span class="token operator">:</span><span class="token string">"2017-12-13T11:28:01Z"</span><span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="2maven_22">
     </a>
     2、构建maven工程引入相关依赖
    </h5>
    <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.scala-lang<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>scala-library<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.11.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span> 

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-streaming-scala_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-connector-kafka_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-table-api-scala-bridge_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-table-planner-blink_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.flink/flink-json --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-json<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.flink/flink-jdbc --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-jdbc_2.11<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.38<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

</code></pre>
    <h5>
     <a id="3_81">
     </a>
     3、代码开发
    </h5>
    <ul>
     <li>
      <p>
       驱动主类
       <code>
        FlinkSqlConnectKafka
       </code>
      </p>
      <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>kafka</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>DataStream<span class="token punctuation">,</span> StreamExecutionEnvironment<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>EnvironmentSettings<span class="token punctuation">,</span> Table<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>StreamTableEnvironment
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span>Row
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>log4j<span class="token punctuation">.</span></span><span class="token punctuation">{<!-- --></span>Level<span class="token punctuation">,</span> Logger<span class="token punctuation">}</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span></span>_

<span class="token comment">//todo： Flinksql使用DDL的方式，读取kafka数据，进行数据实时处理，写结果到mysql表中</span>

<span class="token keyword">object</span> FlinkSqlConnectKafka <span class="token punctuation">{<!-- --></span>

  Logger<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">"org"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>setLevel<span class="token punctuation">(</span>Level<span class="token punctuation">.</span>ERROR<span class="token punctuation">)</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//todo:1、构建流处理环境</span>
    <span class="token keyword">val</span> streamEnv<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    streamEnv<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

    <span class="token comment">//todo:2、构建TableEnvironment</span>
        <span class="token keyword">val</span> settings<span class="token operator">:</span> EnvironmentSettings <span class="token operator">=</span> EnvironmentSettings<span class="token punctuation">.</span>newInstance<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>useBlinkPlanner<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>build<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">val</span> tableEnvironment<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>streamEnv<span class="token punctuation">,</span>settings<span class="token punctuation">)</span>


    <span class="token comment">//todo: 3、通过DDL，注册kafka数据源表</span>
    tableEnvironment<span class="token punctuation">.</span>sqlUpdate<span class="token punctuation">(</span>SqlContext<span class="token punctuation">.</span>kafkaSourceSql<span class="token punctuation">)</span>

    <span class="token comment">//todo: 4、执行查询任务</span>
     <span class="token keyword">val</span> result<span class="token operator">:</span> Table <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>sqlQuery<span class="token punctuation">(</span><span class="token string">"select * from kafkaTable"</span><span class="token punctuation">)</span>

    <span class="token comment">//todo: 5、table转换成流</span>
     <span class="token keyword">val</span> dataStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span> <span class="token operator">=</span> tableEnvironment<span class="token punctuation">.</span>toAppendStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

    dataStream<span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">"数据流结果："</span><span class="token punctuation">)</span>


    <span class="token comment">//todo: 6、通过DDL，注册mysql sink表</span>
    tableEnvironment<span class="token punctuation">.</span>sqlUpdate<span class="token punctuation">(</span>SqlContext<span class="token punctuation">.</span>mysqlSinkSql<span class="token punctuation">)</span>


    <span class="token comment">//todo: 7、计算指标落地到mysql表</span>
    tableEnvironment<span class="token punctuation">.</span>sqlUpdate<span class="token punctuation">(</span>SqlContext<span class="token punctuation">.</span>pvuvSql<span class="token punctuation">)</span>


    <span class="token comment">//todo: 8、启动任务</span>
    tableEnvironment<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"FlinkSqlConnectKafka"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
     </li>
     <li>
      <p>
       封装sql的类
       <code>
        SqlContext
       </code>
      </p>
      <pre><code class="prism language-scala"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kaikeba<span class="token punctuation">.</span>connector<span class="token punctuation">.</span>kafka</span>

<span class="token comment">//todo：定义sql语句</span>
<span class="token keyword">object</span> SqlContext <span class="token punctuation">{<!-- --></span>

  <span class="token comment">//todo: 连接kafka构建源表的sql语句</span>

    <span class="token keyword">lazy</span> <span class="token keyword">val</span> kafkaSourceSql <span class="token operator">=</span>
      <span class="token triple-quoted-string string">"""
        |create table kafkaTable
        |(
        |    user_id BIGINT,
        |    item_id BIGINT,
        |    category_id BIGINT,
        |    behavior STRING,
        |    ts TIMESTAMP(3)
        |) with (
        |	'connector.type' = 'kafka',                                                 -- 使用 kafka connector
        |	'connector.version' = 'universal',                                          -- kafka 版本，universal 支持 0.11 以上的版本
        |	'connector.topic' = 'user_behavior',                                        -- kafka topic
        |	'connector.properties.0.key' = 'group.id',                                  -- kafka consumer group.id参数名
        |	'connector.properties.0.value' = 'testGroup',                               -- kafka consumer group.id参数值
        |	'connector.properties.1.key' = 'bootstrap.servers',                         -- kafka 集群参数名
        |	'connector.properties.1.value' = 'node01:9092,node02:9092,node03:9092',     -- kafka 集群参数值
        |	'connector.startup-mode' = 'latest-offset',                                 -- 从最新 offset 开始读取
        |	'format.type' = 'json',                                                     -- 数据源格式为 json
        |	'format.derive-schema' = 'true',                                            -- 从 DDL schema 确定 json 解析规则
        |	'update-mode' = 'append')                                                   -- 仅支持 append
      """</span><span class="token punctuation">.</span>stripMargin


  <span class="token comment">//todo: 定义要输出的表的sql语句</span>
  <span class="token keyword">lazy</span> <span class="token keyword">val</span> mysqlSinkSql  <span class="token operator">=</span>
    <span class="token triple-quoted-string string">"""
      |CREATE TABLE pvuv(
      |    dt VARCHAR,
      |    pv BIGINT,
      |    uv BIGINT
      |) WITH (
      |    'connector.type' = 'jdbc',                                 -- 使用 jdbc connector
      |    'connector.url' = 'jdbc:mysql://node03:3306/flink',        -- mysql jdbc url
      |    'connector.table' = 'pvuv',                                -- 表名
      |    'connector.username' = 'root',                             -- 用户名
      |    'connector.password' = '123456',                           -- 密码
      |    'connector.write.flush.max-rows' = '1'                     -- 默认5000条，为了演示改为1条，表示多少条数据写入一次
      |)
    """</span><span class="token punctuation">.</span>stripMargin



  <span class="token comment">//todo: 业务分析处理的sql，求取pv和uv</span>
  <span class="token keyword">lazy</span> <span class="token keyword">val</span> pvuvSql  <span class="token operator">=</span>
    <span class="token triple-quoted-string string">"""
      |INSERT INTO pvuv
      |SELECT
      |  DATE_FORMAT(ts, 'yyyy-MM-dd HH:00') dt,
      |  COUNT(*) AS pv,
      |  COUNT(DISTINCT user_id) AS uv
      |FROM kafkaTable
      |GROUP BY DATE_FORMAT(ts, 'yyyy-MM-dd HH:00')
    """</span><span class="token punctuation">.</span>stripMargin

<span class="token punctuation">}</span>

</code></pre>
     </li>
    </ul>
    <h5>
     <a id="4_210">
     </a>
     4、操作流程
    </h5>
    <ul>
     <li>
      <p>
       1、创建名称为
       <code>
        user_behavior
       </code>
       的topic
      </p>
      <pre><code class="prism language-shell">kafka-topics.sh <span class="token parameter variable">--create</span> <span class="token parameter variable">--topic</span> user_behavior <span class="token parameter variable">--partitions</span> <span class="token number">3</span> --replication-factor <span class="token number">2</span> <span class="token parameter variable">--zookeeper</span> node01:2181,node02:2181,node03:2181
</code></pre>
     </li>
     <li>
      <p>
       2、在mysql的
       <code>
        flink
       </code>
       数据库中创建
       <code>
        pvuv
       </code>
       表
      </p>
      <pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> <span class="token comment">/*!32312 IF NOT EXISTS*/</span><span class="token identifier"><span class="token punctuation">`</span>flink<span class="token punctuation">`</span></span> <span class="token comment">/*!40100 DEFAULT CHARACTER SET utf8 */</span><span class="token punctuation">;</span>

<span class="token keyword">USE</span> <span class="token identifier"><span class="token punctuation">`</span>flink<span class="token punctuation">`</span></span><span class="token punctuation">;</span>

<span class="token comment">/*Table structure for table `pvuv` */</span>

<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>pvuv<span class="token punctuation">`</span></span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>pvuv<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>pv<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>uv<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>dt<span class="token punctuation">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre>
     </li>
     <li>
      <p>
       3、启动驱动主类
       <code>
        FlinkSqlConnectKafka
       </code>
      </p>
     </li>
     <li>
      <p>
       4、通过
       <code>
        kafka-topic.sh
       </code>
       命令模拟数据产生
      </p>
      <pre><code class="prism language-shell">kafka-console-producer.sh <span class="token parameter variable">--topic</span> user_behavior --broker-list node01:9092,node02:9092,node03:9092
</code></pre>
     </li>
     <li>
      <p>
       5、观察mysql数据库中
       <code>
        pvuv
       </code>
       表结果数据
      </p>
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031303334323231332f:61727469636c652f64657461696c732f313436313132323939" class_="artid" style="display:none">
 </p>
</div>


