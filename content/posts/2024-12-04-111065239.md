---
layout: post
title: "Android音视频一H264编码基础"
date: 2024-12-04 20:27:21 +0800
description: "音视频编码解码就是指通过特定的压缩/解压技术，将某个音视频格式的数据转换为另一种音视频格式数据。目前"
keywords: "android h264帧处理"
categories: ['音视频', 'Android']
tags: ['音视频', 'H', 'H', 'Android', 'Android']
artid: "111065239"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=111065239
    alt: "Android音视频一H264编码基础"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=111065239
featuredImagePreview: https://bing.ee123.net/img/rand?artid=111065239
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Android音视频【一】H264编码基础
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      <strong>
       人间观察
      </strong>
     </p>
     <p>
      <strong>
       岁月催人，时间过的太快了
      </strong>
     </p>
    </blockquote>
    <p>
     音视频编码解码就是指通过特定的压缩/解压技术，将某个音视频格式的数据转换为另一种音视频格式数据。目前在Android中的音视频用的最多的就是H264+aac的方式进行编码和解码，其实不止Android，H264在整个音视频领域都是使用最广泛的编码方式。H264是新一代的编码标准，以高压缩高质量和支持多种网络的流媒体传输。当然还有比H264更好的H265编码，H265是基于H264优化的。
    </p>
    <h2>
     <a id="1H264_7">
     </a>
     1.H264标准的演进
    </h2>
    <p>
     国际上主流制定视频编解码技术的组织有两个，一个是
     <strong>
      国际电联（ITU-T）
     </strong>
     ，它制定的标准有H.261、H.263、H.263+、H.264等。
     <br/>
     一个是**国际标准化组织（ISO）**它制定的标准有MPEG-1、MPEG-2、MPEG-4等。他们各自发展，随着时间的推移这两个基友融在一起了，推出了H.264/MPEG-4 AVC，他们都保留了各自的叫法，在ITU-T这边叫做H.264，在ISO那边叫MPEG-4 AVC。所以你在电脑上看视频文件（如果是h264编码的话）的简介都是H.264/MPEG-4 AVC，但是在代码中不是
     <code>
      h264
     </code>
     而是
     <code>
      avc
     </code>
     ，哈哈。简单了解下h264标准的形成就行。
    </p>
    <h2>
     <a id="2_12">
     </a>
     2.前提
    </h2>
    <p>
     我们为什么要进行编码呢？这个要搞清楚，因为原始数据太大了，举个例子比如android 摄像头采集视频的分辨率是720*1280，帧率是30fps，YCbCr_420_SP(NV21) ，那1s的数据大小是：
     <br/>
     <code>
      720 *1280*1.5byte(12 bits per pixel)*30（张图片）/1024/1024=40mb
     </code>
     。如果这1s的数据进行网络传输和磁盘保存是非常不合理的，除非电影院的视频，电影院的视频都是原始的，一部电影上1000G，好家伙，简直就是在放高清图片。666
    </p>
    <p>
     所以我们要经过压缩，其中就是h264的压缩，编码的时候经过去掉图像内的冗余和保留图像之间的差异的数据进行传输/保存，解码的时候进行还原即可。这就是我们的先辈们努力了10多年的成果。
    </p>
    <p>
     这篇是理论，尽可能的保留所谓的官方概念。也会加入自己的理解。
    </p>
    <h2>
     <a id="3H264_21">
     </a>
     3.H264相关概念
    </h2>
    <p>
     h264中有很多很多的概念，这些很重要。下面的3个帧的总结来自有关书籍也加入了自己的理解，如果我只写自己的理解可能会导致真正意义上的丢失，所以我这里还是保留了，大家可以细细品读这3个帧的描述。
    </p>
    <h3>
     <a id="31__Frame_24">
     </a>
     3.1 帧 Frame
    </h3>
    <p>
     简单的理解帧就是为视频或者动画中的每一张画面，而视频和动画特效就是由无数张画面组合而成，每一张画面都是一帧。
    </p>
    <h3>
     <a id="32__28">
     </a>
     3.2 三种视频帧
    </h3>
    <p>
     分为I 帧 B帧 P帧，当然是编码后数据。
    </p>
    <h4>
     <a id="321__I__30">
     </a>
     3.2.1 I 帧
    </h4>
    <p>
     I 帧是帧内编码帧，I 帧是完整帧，可以理解为一副画面的完整保留，当然也不是保留最原始数据，删掉了人眼不敏感的数据（人眼对色度不敏感对亮度敏感），解码时只需要本帧数据就可以完成，就可以出来画面，直播秒开就是这个原理，首帧为I帧，配合云端缓存最近的I帧。
    </p>
    <p>
     I 帧特点：
    </p>
    <ul>
     <li>
      它是一个全帧压缩编码帧，它将全帧的图像进行jpeg压缩编码
     </li>
     <li>
      既然是完整的图像那所占数据的信息量比较大
     </li>
     <li>
      解码时仅用I帧的数据就可以重构完整图像
     </li>
     <li>
      不需要参考其他画面进行编码生成
     </li>
     <li>
      I 帧是序列gop的基础帧（第一帧），在一个gop里只有一个I 帧
     </li>
     <li>
      I 帧是P帧和B帧的参考帧（其质量直接影响到同组中以后各帧的质量），如果I帧质量不行，那这个序列质量都不行。
     </li>
     <li>
      I 帧描述了图像背景和运动主体的详情
     </li>
    </ul>
    <p>
     总之，I 帧很nb，I 帧越多说明该视频画面变换多越复杂。
    </p>
    <h4>
     <a id="322__P_45">
     </a>
     3.2.2 P帧-前向预测编码帧
    </h4>
    <p>
     P帧表示的是这一帧跟之前的一个关键帧（或P帧）的差别，解码时需要之前缓存的画面叠加上本帧定义的差别，生成最终画面。（也就是差别帧，P帧没有完整画面数据，只有与前一帧的画面差别的数据）。
    </p>
    <p>
     ​ P帧的预测与重构：P帧是以 I 帧为参考帧，在 I 帧中找出P帧“某点”的预测值和运动矢量，取预测差值和运动矢量一起传送。在接收端根据运行矢量从 I 帧找出P帧“某点”的预测值并与差值相加以得到P帧“某点”样值，从而可得到完整的P帧。
     <br/>
     ​
     <br/>
     P帧的特点：
    </p>
    <ul>
     <li>
      P帧是 I 帧后面相隔1~2帧的编码帧
     </li>
     <li>
      P帧采用运动补偿的方法传送它与前面的I或P帧的差值及运动矢量（预测误差）
     </li>
     <li>
      解码时必须将i帧中的预测值与预测误差求和后才能重构完整的P帧图像
     </li>
     <li>
      P帧属于前向预测的帧间编码。它只参考前面最靠近它的 I 帧或P帧
     </li>
     <li>
      由于P帧是参考帧，它可能造成解码错误的扩散。也就是说如果p帧解码失败了，一组内的gop后面的b帧/p帧失败。它最多也就影响一个gop序列。
     </li>
     <li>
      由于是差值传送，P帧的压缩比较高。
     </li>
    </ul>
    <p>
     总之，p帧就是差别帧，p帧越多，说明画面变化不多。
    </p>
    <h4>
     <a id="323__B_61">
     </a>
     3.2.3 B帧-双向预测内插编码帧
    </h4>
    <p>
     B帧是双向差别帧，也就是B帧记录的是本帧与前后帧的差别，要解码B帧。不仅要取得之前的缓存画面，还要解码之后的画面，通过前后画面的与本帧数据的叠加取得最终的画面。B帧压缩率高，但是解码时费时间，如果是软解码就耗cpu了。
    </p>
    <p>
     B帧的预测与重构
    </p>
    <p>
     ​ B帧以前面的 I 或P帧和后面的P帧为参考帧，“找出”B帧“某点”的预测值和两个运动矢量，并取预测差值和运动矢量传送。接收端根据运动矢量在两个参考帧中“找出（算出）”预测值并与差值求和，得到B帧“某点”样值，从而可得到完整的B帧。
    </p>
    <p>
     B帧的特点：
    </p>
    <ul>
     <li>
      B帧是由前面的 I 或P帧和后面的P帧进行预测的
     </li>
     <li>
      B帧传送的是它与前面的 I 或P帧和后面的P帧之间的预测误差及运动矢量
     </li>
     <li>
      B帧是双向预测编码帧
     </li>
     <li>
      B帧压缩比最高，因为它只反映并参考帧间运动主体的变化情况，预测比较准确
     </li>
     <li>
      B帧不是参考帧，不会造成解码错误的扩散
     </li>
    </ul>
    <p>
     总之，b帧数据较小，b帧越多，视频越小。
    </p>
    <blockquote>
     <p>
      注：I、B、P帧是根据压缩算法是人为定义的，一般来说，帧的压缩率是7（跟JPG差不多），P帧是20，B帧可以达到50。
     </p>
    </blockquote>
    <h4>
     <a id="33_GOP_80">
     </a>
     3.3 GOP/序列
    </h4>
    <p>
     Group of picture(图像组)。
     <br/>
     在相邻几幅图像画面中，一般有差别的像素只有10%以内的点,亮度差值变化不超过2%，而色度差值的变化只有1%以内，我们认为这样的图可以分到一组。在这样一组帧中，经过h264编码后，只保留第一帧的完整数据，其它帧都通过参考上一帧计算出来。我们称第一帧为IDR／I帧，其它帧我们称为P／B帧，这样编码后的数据帧组我们称为GOP。GOP如下，图片来源网络：
    </p>
    <p>
     <img alt="gop" src="https://i-blog.csdnimg.cn/blog_migrate/e260e7321dfc24c823233a9f37a33190.png#pic_center"/>
    </p>
    <p>
     当视频的元素运动变化比较少时，一个序列可以很长，因为运动变化少就代表图像画面内容的变动很小，所以就可以是一个I帧，然后是P帧B帧。如果变化很大，比如图片形成的视频，一个序列可能就比较短了，可能就包含一个i帧，几个P帧B帧了。
    </p>
    <h4>
     <a id="34_IDR_89">
     </a>
     3.4 IDR图像
    </h4>
    <p>
     1个序列的第一个图像叫做IDR图像（立刻刷新图像），IDR图像都是I帧图像。h264引入IDR图像是为了解码的重新同步，当解码器解码到IDR图像时，立刻将参考帧队列清空，将已经解码的全部输出或者抛弃，重新查找下一个参数集，开始解码下一个新的序列。这样当钱一个序列出现重大错误，在这里可以重新获得同步的机会。IDR图像之后的图像不会使用IDR之前图像的数据进行解码。
    </p>
    <p>
     所以说IDR图像都是I帧，但是I帧不一定是IDR图像。
    </p>
    <h4>
     <a id="35_DTSPTS_94">
     </a>
     3.5 DTS和PTS
    </h4>
    <p>
     DTS: Decode Time Stamp,表示读入内存的比特流在什么时候开始送入解码器中进行解码。解码的顺序
    </p>
    <p>
     PTS: Presentation Time Stamp,表示解码后的视频帧什么时候被显示出来，显示顺序。
    </p>
    <p>
     图片来源网络：
     <br/>
     <img alt="gop解码" src="https://i-blog.csdnimg.cn/blog_migrate/8daf7d28b7e2d990bf8a57ae41e09fef.jpeg#pic_center"/>
    </p>
    <p>
     因为B帧需要前后的帧（前面的 I 或P帧和后面的P帧）才能解出图像。也就是说一组GOP必须解码出I帧P帧后才能解码出来B帧，并不是B帧的数据先到了就先解码b帧的数据
    </p>
    <h4>
     <a id="36_MBMacroblock_106">
     </a>
     3.6 宏块/MB（Macroblock）
    </h4>
    <p>
     就是图像中的一小块区域。h264位了压缩而采用的一种划分方法。
     <br/>
     H264编码器为每一幅图片划分宏块，默认是使用 16X16 大小的区域作为一个宏块，也可以划分成 8X8 大小。一般比较平坦的图像使用 16X16 大小的宏块，为了更高的压缩率在在16X16 的宏块上分出更小的子块。子块的大小可以是 8X16､ 16X8､ 8X8､ 4X8､ 8X4､ 4X4
    </p>
    <h2>
     <a id="4H264_110">
     </a>
     4.H264的压缩原理
    </h2>
    <p>
     我个人理解这个代码实现是很复杂的，发展了10几年才稳定成熟。不用你手写实现也不用关注特别细的实现，但是需要了解下它的基本原理，压缩的过程，采用的方法进行的视频压缩。
    </p>
    <h4>
     <a id="41_113">
     </a>
     4.1压缩技术
    </h4>
    <p>
     简单点说就是：视频数据主要分为两类数据冗余，一个是时间上的冗余，一个是空间上的冗余。分别对其进行压缩，压缩技术我们分别叫做帧间压缩技术和帧内压缩技术。
    </p>
    <p>
     时间上： 将一定时间内视频图像运动变化不大关联性性很强的进行分组（GOP），然后对这组序列进行编码，只保留第一帧的完整数据，其它帧都通过参考上一帧计算出来。那第一帧为IDR／I帧，其它帧为P／B帧，这样编码后的数据帧组我们称为GOP。压缩过程中有运动矢量与补偿算法和划分宏块（MB）以及对宏块的处理压缩。当下一组视频内的图像变化很大的时候又是一组新的GOP，反复循环。这种我们就叫帧间压缩技术，解决的是时域数据冗余问题。
    </p>
    <p>
     空间上：对视频图像划分宏块，H264对比较平坦的图像使用 16X16 大小的宏块，可以在16x16的基础上更细粒度的划分，这样再经过帧内压缩，得到更高效的数据。这种我们就叫帧内压缩技术，解决的是空域数据冗余问题。
    </p>
    <p>
     帧间压缩和帧内压缩后还需要进行压缩，比如：
     <br/>
     还有编码上冗余：根据不同像素值出现的概率不同进行算法处理
     <br/>
     还有视觉冗余：人的视觉系统对某些细节不敏感就可以适当的删减
    </p>
    <p>
     基本原理参考这篇文章
     <a href="https://zhuanlan.zhihu.com/p/31056455" rel="nofollow">
      https://zhuanlan.zhihu.com/p/31056455
     </a>
    </p>
    <p>
     介绍了些h264的基本知识和有关概念，h264的知识远远不止这些。如有描述不准确欢迎指正。下篇介绍h264数据流格式以及如何在Android中硬解码播放h264码流。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f74613839333131353837312f:61727469636c652f64657461696c732f313131303635323339" class_="artid" style="display:none">
 </p>
</div>


