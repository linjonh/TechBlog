---
layout: post
title: "å·¥ç¨‹åŒ–ä¸æ¡†æ¶ç³»åˆ—35-å‰ç«¯å¾®æœåŠ¡æ¶æ„å®è·µ"
date: 2025-03-15 22:20:44 +0800
description: "å·¥ç¨‹åŒ–ä¸æ¡†æ¶ä¹‹æ—…ç¬¬ä¸‰åäº”ç«™"
keywords: "å·¥ç¨‹åŒ–ä¸æ¡†æ¶ç³»åˆ—ï¼ˆ35ï¼‰--å‰ç«¯å¾®æœåŠ¡æ¶æ„å®è·µ"
categories: ['å‰ç«¯å·¥ç¨‹åŒ–ä¸æ¡†æ¶']
tags: ['æ¶æ„', 'å¾®æœåŠ¡', 'å‰ç«¯']
artid: "146286660"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146286660
    alt: "å·¥ç¨‹åŒ–ä¸æ¡†æ¶ç³»åˆ—35-å‰ç«¯å¾®æœåŠ¡æ¶æ„å®è·µ"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146286660
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146286660
cover: https://bing.ee123.net/img/rand?artid=146286660
image: https://bing.ee123.net/img/rand?artid=146286660
img: https://bing.ee123.net/img/rand?artid=146286660
---

# å·¥ç¨‹åŒ–ä¸æ¡†æ¶ç³»åˆ—ï¼ˆ35ï¼‰--å‰ç«¯å¾®æœåŠ¡æ¶æ„å®è·µ

## å‰ç«¯å¾®æœåŠ¡æ¶æ„å®è·µ ğŸ—ï¸

### å¼•è¨€

éšç€å‰ç«¯åº”ç”¨è§„æ¨¡çš„ä¸æ–­æ‰©å¤§ï¼Œå¾®æœåŠ¡æ¶æ„åœ¨å‰ç«¯é¢†åŸŸçš„åº”ç”¨è¶Šæ¥è¶Šå¹¿æ³›ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨å‰ç«¯å¾®æœåŠ¡æ¶æ„çš„å®ç°æ–¹æ¡ˆã€æœ€ä½³å®è·µå’Œç›¸å…³å·¥å…·ã€‚

### å¾®æœåŠ¡æ¶æ„æ¦‚è¿°

å‰ç«¯å¾®æœåŠ¡æ¶æ„ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹æ–¹é¢ï¼š

  * **åº”ç”¨æ‹†åˆ†** ï¼šåŸºäºä¸šåŠ¡åŸŸçš„åº”ç”¨æ‹†åˆ†ç­–ç•¥
  * **ç‹¬ç«‹éƒ¨ç½²** ï¼šå„ä¸ªå¾®åº”ç”¨çš„ç‹¬ç«‹å¼€å‘ã€æ„å»ºå’Œéƒ¨ç½²
  * **è¿è¡Œæ—¶é›†æˆ** ï¼šå¾®åº”ç”¨çš„åŠ è½½ã€é€šä¿¡å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†
  * **å…±äº«èµ„æº** ï¼šå…¬å…±ä¾èµ–ã€ç»„ä»¶åº“ã€å·¥å…·å‡½æ•°ç­‰çš„å…±äº«ç­–ç•¥
  * **ç»Ÿä¸€ç®¡ç†** ï¼šè·¯ç”±ã€çŠ¶æ€ã€æƒé™ç­‰çš„ç»Ÿä¸€ç®¡ç†æ–¹æ¡ˆ

### å¾®æœåŠ¡æ¶æ„å®ç°

#### å¾®å‰ç«¯å®¹å™¨

    
    
    // å¾®å‰ç«¯å®¹å™¨ç±»
    class MicroFrontendContainer {
        private static instance: MicroFrontendContainer;
        private apps: Map<string, MicroApp>;
        private config: ContainerConfig;
        
        private constructor() {
            this.apps = new Map();
            this.config = {
                sandbox: true,
                prefetch: true,
                isolation: 'iframe',
                timeout: 3000
            };
        }
        
        // è·å–å•ä¾‹å®ä¾‹
        static getInstance(): MicroFrontendContainer {
            if (!MicroFrontendContainer.instance) {
                MicroFrontendContainer.instance = new MicroFrontendContainer();
            }
            return MicroFrontendContainer.instance;
        }
        
        // æ³¨å†Œå¾®åº”ç”¨
        registerApp(appConfig: MicroAppConfig): void {
            const app = new MicroApp(appConfig);
            this.apps.set(appConfig.name, app);
            
            // é¢„åŠ è½½é…ç½®
            if (this.config.prefetch) {
                this.prefetchApp(app);
            }
        }
        
        // å¯åŠ¨å¾®åº”ç”¨
        async startApp(name: string): Promise<void> {
            const app = this.apps.get(name);
            if (!app) {
                throw new Error(`App ${name} not found`);
            }
            
            try {
                // åŠ è½½å¾®åº”ç”¨èµ„æº
                await this.loadApp(app);
                
                // åˆ›å»ºæ²™ç®±ç¯å¢ƒ
                const sandbox = this.createSandbox(app);
                
                // æŒ‚è½½å¾®åº”ç”¨
                await this.mountApp(app, sandbox);
                
                // åˆå§‹åŒ–é€šä¿¡
                this.initCommunication(app);
                
            } catch (error) {
                console.error(`Failed to start app ${name}:`, error);
                throw error;
            }
        }
        
        // åœæ­¢å¾®åº”ç”¨
        async stopApp(name: string): Promise<void> {
            const app = this.apps.get(name);
            if (!app) {
                throw new Error(`App ${name} not found`);
            }
            
            try {
                // å¸è½½å¾®åº”ç”¨
                await this.unmountApp(app);
                
                // æ¸…ç†æ²™ç®±
                this.cleanupSandbox(app);
                
                // æ¸…ç†èµ„æº
                this.cleanupResources(app);
                
            } catch (error) {
                console.error(`Failed to stop app ${name}:`, error);
                throw error;
            }
        }
        
        // é¢„åŠ è½½å¾®åº”ç”¨
        private async prefetchApp(app: MicroApp): Promise<void> {
            try {
                const resources = await this.loadResources(app.config.entry);
                app.setResources(resources);
            } catch (error) {
                console.warn(`Failed to prefetch app ${app.config.name}:`, error);
            }
        }
        
        // åŠ è½½å¾®åº”ç”¨èµ„æº
        private async loadApp(app: MicroApp): Promise<void> {
            if (app.isLoaded()) {
                return;
            }
            
            const resources = app.getResources() || 
                             await this.loadResources(app.config.entry);
                             
            await this.injectResources(resources);
            app.setLoaded(true);
        }
        
        // åŠ è½½èµ„æº
        private async loadResources(entry: string): Promise<AppResources> {
            const response = await fetch(entry);
            const html = await response.text();
            
            return {
                scripts: this.extractScripts(html),
                styles: this.extractStyles(html),
                templates: this.extractTemplates(html)
            };
        }
        
        // æ³¨å…¥èµ„æº
        private async injectResources(resources: AppResources): Promise<void> {
            // æ³¨å…¥æ ·å¼
            await Promise.all(
                resources.styles.map(style => this.loadStyle(style))
            );
            
            // æ³¨å…¥è„šæœ¬
            await Promise.all(
                resources.scripts.map(script => this.loadScript(script))
            );
        }
        
        // åˆ›å»ºæ²™ç®±ç¯å¢ƒ
        private createSandbox(app: MicroApp): Sandbox {
            if (this.config.isolation === 'iframe') {
                return new IframeSandbox(app);
            } else {
                return new JsSandbox(app);
            }
        }
        
        // æŒ‚è½½å¾®åº”ç”¨
        private async mountApp(
            app: MicroApp,
            sandbox: Sandbox
        ): Promise<void> {
            const mountPoint = document.querySelector(app.config.container);
            if (!mountPoint) {
                throw new Error(
                    `Mount point ${app.config.container} not found`
                );
            }
            
            // æ‰§è¡Œç”Ÿå‘½å‘¨æœŸé’©å­
            await app.beforeMount();
            
            // åœ¨æ²™ç®±ä¸­æ‰§è¡ŒæŒ‚è½½
            await sandbox.mount(mountPoint);
            
            // æ›´æ–°åº”ç”¨çŠ¶æ€
            app.setMounted(true);
            
            // æ‰§è¡Œç”Ÿå‘½å‘¨æœŸé’©å­
            await app.afterMount();
        }
        
        // å¸è½½å¾®åº”ç”¨
        private async unmountApp(app: MicroApp): Promise<void> {
            if (!app.isMounted()) {
                return;
            }
            
            // æ‰§è¡Œç”Ÿå‘½å‘¨æœŸé’©å­
            await app.beforeUnmount();
            
            // ç§»é™¤DOM
            const container = document.querySelector(app.config.container);
            if (container) {
                container.innerHTML = '';
            }
            
            // æ›´æ–°åº”ç”¨çŠ¶æ€
            app.setMounted(false);
            
            // æ‰§è¡Œç”Ÿå‘½å‘¨æœŸé’©å­
            await app.afterUnmount();
        }
        
        // æ¸…ç†æ²™ç®±
        private cleanupSandbox(app: MicroApp): void {
            const sandbox = app.getSandbox();
            if (sandbox) {
                sandbox.cleanup();
            }
        }
        
        // æ¸…ç†èµ„æº
        private cleanupResources(app: MicroApp): void {
            const resources = app.getResources();
            if (resources) {
                // ç§»é™¤æ ·å¼
                resources.styles.forEach(style => {
                    const element = document.querySelector(
                        `link[href="${style}"]`
                    );
                    element?.remove();
                });
                
                // ç§»é™¤è„šæœ¬
                resources.scripts.forEach(script => {
                    const element = document.querySelector(
                        `script[src="${script}"]`
                    );
                    element?.remove();
                });
            }
        }
        
        // åˆå§‹åŒ–åº”ç”¨é—´é€šä¿¡
        private initCommunication(app: MicroApp): void {
            const eventBus = EventBus.getInstance();
            
            // æ³¨å†Œåº”ç”¨é€šä¿¡å¤„ç†å™¨
            app.setMessageHandler(message => {
                eventBus.emit(`${app.config.name}:message`, message);
            });
            
            // ç›‘å¬å…¶ä»–åº”ç”¨æ¶ˆæ¯
            this.apps.forEach(otherApp => {
                if (otherApp !== app) {
                    eventBus.on(
                        `${otherApp.config.name}:message`,
                        message => {
                            app.postMessage(message);
                        }
                    );
                }
            });
        }
    }
    
    // å¾®åº”ç”¨ç±»
    class MicroApp {
        private loaded: boolean = false;
        private mounted: boolean = false;
        private resources: AppResources | null = null;
        private sandbox: Sandbox | null = null;
        private messageHandler: MessageHandler | null = null;
        
        constructor(public config: MicroAppConfig) {}
        
        // ç”Ÿå‘½å‘¨æœŸé’©å­
        async beforeMount(): Promise<void> {
            await this.invokeLifecycle('beforeMount');
        }
        
        async afterMount(): Promise<void> {
            await this.invokeLifecycle('afterMount');
        }
        
        async beforeUnmount(): Promise<void> {
            await this.invokeLifecycle('beforeUnmount');
        }
        
        async afterUnmount(): Promise<void> {
            await this.invokeLifecycle('afterUnmount');
        }
        
        // è°ƒç”¨ç”Ÿå‘½å‘¨æœŸå‡½æ•°
        private async invokeLifecycle(name: string): Promise<void> {
            const lifecycle = (window as any)[
                `${this.config.name}:${name}`
            ];
            if (typeof lifecycle === 'function') {
                await lifecycle();
            }
        }
        
        // çŠ¶æ€ç®¡ç†
        isLoaded(): boolean {
            return this.loaded;
        }
        
        setLoaded(loaded: boolean): void {
            this.loaded = loaded;
        }
        
        isMounted(): boolean {
            return this.mounted;
        }
        
        setMounted(mounted: boolean): void {
            this.mounted = mounted;
        }
        
        // èµ„æºç®¡ç†
        getResources(): AppResources | null {
            return this.resources;
        }
        
        setResources(resources: AppResources): void {
            this.resources = resources;
        }
        
        // æ²™ç®±ç®¡ç†
        getSandbox(): Sandbox | null {
            return this.sandbox;
        }
        
        setSandbox(sandbox: Sandbox): void {
            this.sandbox = sandbox;
        }
        
        // æ¶ˆæ¯é€šä¿¡
        setMessageHandler(handler: MessageHandler): void {
            this.messageHandler = handler;
        }
        
        postMessage(message: any): void {
            this.messageHandler?.(message);
        }
    }
    
    // æ²™ç®±åŸºç±»
    abstract class Sandbox {
        constructor(protected app: MicroApp) {}
        
        abstract mount(container: Element): Promise<void>;
        abstract cleanup(): void;
    }
    
    // iframeæ²™ç®±
    class IframeSandbox extends Sandbox {
        private iframe: HTMLIFrameElement | null = null;
        
        async mount(container: Element): Promise<void> {
            this.iframe = document.createElement('iframe');
            this.iframe.src = 'about:blank';
            this.iframe.style.width = '100%';
            this.iframe.style.height = '100%';
            this.iframe.style.border = 'none';
            
            container.appendChild(this.iframe);
            
            // æ³¨å…¥èµ„æºåˆ°iframe
            await this.injectResources();
        }
        
        cleanup(): void {
            this.iframe?.remove();
            this.iframe = null;
        }
        
        private async injectResources(): Promise<void> {
            if (!this.iframe) return;
            
            const resources = this.app.getResources();
            if (!resources) return;
            
            const doc = this.iframe.contentDocument;
            if (!doc) return;
            
            // æ³¨å…¥æ ·å¼
            resources.styles.forEach(style => {
                const link = doc.createElement('link');
                link.rel = 'stylesheet';
                link.href = style;
                doc.head.appendChild(link);
            });
            
            // æ³¨å…¥è„šæœ¬
            for (const script of resources.scripts) {
                await new Promise((resolve, reject) => {
                    const scriptElement = doc.createElement('script');
                    scriptElement.src = script;
                    scriptElement.onload = resolve;
                    scriptElement.onerror = reject;
                    doc.head.appendChild(scriptElement);
                });
            }
        }
    }
    
    // JSæ²™ç®±
    class JsSandbox extends Sandbox {
        private proxy: Window | null = null;
        
        async mount(container: Element): Promise<void> {
            // åˆ›å»ºä»£ç†å¯¹è±¡
            this.proxy = new Proxy(window, {
                get: (target, property) => {
                    // å¤„ç†ç‰¹æ®Šå±æ€§
                    if (this.isProtected(property)) {
                        return target[property as keyof Window];
                    }
                    
                    // è¿”å›æ²™ç®±ä¸­çš„å€¼
                    return (this.app as any)[property];
                },
                set: (target, property, value) => {
                    // ç¦æ­¢ä¿®æ”¹ä¿æŠ¤å±æ€§
                    if (this.isProtected(property)) {
                        return false;
                    }
                    
                    // è®¾ç½®å€¼åˆ°æ²™ç®±
                    (this.app as any)[property] = value;
                    return true;
                }
            });
            
            // åœ¨æ²™ç®±ç¯å¢ƒä¸­æ‰§è¡Œä»£ç 
            this.executeInSandbox(() => {
                const resources = this.app.getResources();
                if (!resources) return;
                
                // æ‰§è¡Œè„šæœ¬
                resources.scripts.forEach(script => {
                    const scriptElement = document.createElement('script');
                    scriptElement.src = script;
                    container.appendChild(scriptElement);
                });
            });
        }
        
        cleanup(): void {
            this.proxy = null;
        }
        
        private executeInSandbox(code: Function): void {
            if (!this.proxy) return;
            
            // ä¿å­˜åŸå§‹window
            const originalWindow = window;
            
            // æ›¿æ¢ä¸ºä»£ç†å¯¹è±¡
            (window as any) = this.proxy;
            
            try {
                // æ‰§è¡Œä»£ç 
                code();
            } finally {
                // æ¢å¤åŸå§‹window
                (window as any) = originalWindow;
            }
        }
        
        private isProtected(property: string | symbol): boolean {
            // ä¿æŠ¤çš„å…¨å±€å±æ€§åˆ—è¡¨
            const protectedProps = [
                'window',
                'document',
                'location',
                'history'
            ];
            
            return protectedProps.includes(property.toString());
        }
    }
    
    // äº‹ä»¶æ€»çº¿
    class EventBus {
        private static instance: EventBus;
        private handlers: Map<string, Set<Function>>;
        
        private constructor() {
            this.handlers = new Map();
        }
        
        static getInstance(): EventBus {
            if (!EventBus.instance) {
                EventBus.instance = new EventBus();
            }
            return EventBus.instance;
        }
        
        on(event: string, handler: Function): void {
            if (!this.handlers.has(event)) {
                this.handlers.set(event, new Set());
            }
            
            this.handlers.get(event)?.add(handler);
        }
        
        off(event: string, handler: Function): void {
            this.handlers.get(event)?.delete(handler);
        }
        
        emit(event: string, data?: any): void {
            this.handlers.get(event)?.forEach(handler => {
                handler(data);
            });
        }
    }
    
    // æ¥å£å®šä¹‰
    interface ContainerConfig {
        sandbox: boolean;
        prefetch: boolean;
        isolation: 'iframe' | 'js';
        timeout: number;
    }
    
    interface MicroAppConfig {
        name: string;
        entry: string;
        container: string;
        props?: Record<string, any>;
    }
    
    interface AppResources {
        scripts: string[];
        styles: string[];
        templates: string[];
    }
    
    type MessageHandler = (message: any) => void;
    
    // ä½¿ç”¨ç¤ºä¾‹
    const container = MicroFrontendContainer.getInstance();
    
    // æ³¨å†Œå¾®åº”ç”¨
    container.registerApp({
        name: 'app1',
        entry: 'http://localhost:3001',
        container: '#app1'
    });
    
    container.registerApp({
        name: 'app2',
        entry: 'http://localhost:3002',
        container: '#app2'
    });
    
    // å¯åŠ¨å¾®åº”ç”¨
    await container.startApp('app1');
    
    // åœæ­¢å¾®åº”ç”¨
    await container.stopApp('app1');
    

### æœ€ä½³å®è·µä¸å»ºè®®

  1. **åº”ç”¨æ‹†åˆ†**

     * åŸºäºä¸šåŠ¡åŸŸåˆ’åˆ†
     * åˆç†ç²’åº¦
     * ç‹¬ç«‹æ¼”è¿›
     * æŠ€æœ¯æ ˆçµæ´»
  2. **ä¾èµ–ç®¡ç†**

     * å…±äº«ä¾èµ–
     * ç‰ˆæœ¬æ§åˆ¶
     * æ„å»ºä¼˜åŒ–
     * è¿è¡Œæ—¶åŠ è½½
  3. **é€šä¿¡æœºåˆ¶**

     * äº‹ä»¶æ€»çº¿
     * çŠ¶æ€å…±äº«
     * æ•°æ®éš”ç¦»
     * å®‰å…¨æ§åˆ¶
  4. **éƒ¨ç½²ç­–ç•¥**

     * ç‹¬ç«‹éƒ¨ç½²
     * ç°åº¦å‘å¸ƒ
     * ç‰ˆæœ¬æ§åˆ¶
     * å›æ»šæœºåˆ¶

### æ€»ç»“

å‰ç«¯å¾®æœåŠ¡æ¶æ„éœ€è¦è€ƒè™‘ä»¥ä¸‹æ–¹é¢ï¼š

  1. åº”ç”¨æ‹†åˆ†å’Œé›†æˆç­–ç•¥
  2. èµ„æºåŠ è½½å’Œæ€§èƒ½ä¼˜åŒ–
  3. åº”ç”¨é€šä¿¡å’ŒçŠ¶æ€ç®¡ç†
  4. éƒ¨ç½²å’Œè¿ç»´æ”¯æŒ
  5. å¼€å‘å’Œåä½œæµç¨‹

é€šè¿‡åˆç†çš„å¾®æœåŠ¡æ¶æ„è®¾è®¡ï¼Œå¯ä»¥æé«˜å‰ç«¯åº”ç”¨çš„å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ã€‚

### å­¦ä¹ èµ„æº

  1. å¾®å‰ç«¯æ¶æ„è®¾è®¡
  2. æ¨¡å—è”é‚¦å®è·µ
  3. æ²™ç®±éš”ç¦»æ–¹æ¡ˆ
  4. æ€§èƒ½ä¼˜åŒ–æŒ‡å—
  5. éƒ¨ç½²è¿ç»´å®è·µ

* * *

å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« æœ‰å¸®åŠ©ï¼Œæ¬¢è¿ç‚¹èµæ”¶è—ï¼Œä¹ŸæœŸå¾…åœ¨è¯„è®ºåŒºçœ‹åˆ°ä½ çš„æƒ³æ³•å’Œå»ºè®®ï¼ğŸ‘‡

_**ç»ˆèº«å­¦ä¹ ï¼Œå…±åŒæˆé•¿ã€‚**_

å’±ä»¬ä¸‹ä¸€æœŸè§

ğŸ’»



