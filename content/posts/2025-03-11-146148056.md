---
layout: post
title: "数据库系统概论第十章-数据库恢复技术"
date: 2025-03-11 10:08:57 +0800
description: "数据库的恢复：数据库管理系统必须具有把数据库从错误状态恢复到某一已知的正确状态(亦称为一致状态或完整状态)的功能，这就是数据库的恢复管理系统对故障的对策。"
keywords: "【数据库系统概论】第十章 数据库恢复技术"
categories: ['数据库']
tags: ['数据库', 'Oracle']
artid: "146148056"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146148056
    alt: "数据库系统概论第十章-数据库恢复技术"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146148056
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146148056
cover: https://bing.ee123.net/img/rand?artid=146148056
image: https://bing.ee123.net/img/rand?artid=146148056
img: https://bing.ee123.net/img/rand?artid=146148056
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【数据库系统概论】第十章 数据库恢复技术
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="101___2">
     </a>
     10.1 事务的基本概念
    </h2>
    <h3>
     <a id="1011__3">
     </a>
     10.1.1 事务
    </h3>
    <ul>
     <li>
      <p>
       事务(Transaction)是用户定义的一个数据库操作序列，这些操作要么全做，要么全不做，是一个不可分割的工作单位。
      </p>
     </li>
     <li>
      <p>
       <strong>
        事务是恢复和并发控制的基本单位
       </strong>
      </p>
     </li>
     <li>
      <p>
       事务和程序是两个概念
       <br/>
       在关系数据库中，一个事务可以是一条SQL语句，一组SQL语句或整个程序
       <br/>
       一个程序通常包含多个事务
      </p>
     </li>
    </ul>
    <h3>
     <a id="1012_ACID_13">
     </a>
     10.1.2 事务的ACID特性
    </h3>
    <ul>
     <li>
      <p>
       <strong>
        原子性
       </strong>
       （Atomicity）：事务中包括的诸操作要么都做，要么都不做
      </p>
     </li>
     <li>
      <p>
       <strong>
        一致性
       </strong>
       （Consistency）：事务执行的结果必须是使数据库从一个一致性状态变到另一个一致性状态
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/3028f187571f4a10b85712d20715451a.png"/>
      </p>
     </li>
     <li>
      <p>
       <strong>
        隔离性
       </strong>
       （Isolation）：一个事务的执行不能被其他事务干扰
      </p>
     </li>
     <li>
      <p>
       <strong>
        持续性
       </strong>
       （Durability ）：一个事务一旦提交，它对数据库中数据的改变就应该是永久性的。
      </p>
     </li>
    </ul>
    <h2>
     <a id="102___21">
     </a>
     10.2 数据库恢复概述
    </h2>
    <p>
     数据库的恢复：数据库管理系统必须具有把数据库
     <strong>
      从错误状态恢复到某一已知的正确状态
     </strong>
     (亦称为一致状态或完整状态)的功能，这就是数据库的恢复管理系统对故障的对策
    </p>
    <h2>
     <a id="103___28">
     </a>
     10.3 故障的种类
    </h2>
    <h3>
     <a id="1_29">
     </a>
     （1）事务内部的故障
    </h3>
    <ul>
     <li>
      事务内部的故障类型，分为两类：
      <strong>
       可以通过事务程序本身发现的故障
      </strong>
      和
      <strong>
       非预期的、不能由事务程序处理的故障
      </strong>
      。
      <ol>
       <li>
        <p>
         <strong>
          可以通过事务程序本身发现的故障
         </strong>
         ：这类故障是事务在执行过程中遇到的
         <strong>
          预期错误
         </strong>
         ，通常可以通过事务程序中的逻辑检测和处理。
        </p>
        <pre><code class="prism language-sql">转账事务：从账户 A 转账 <span class="token number">100</span> 元到账户 B。
事务程序可以检查账户 A 的余额是否足够。
如果余额不足，事务程序可以主动回滚事务，并返回错误信息。
</code></pre>
       </li>
       <li>
        <p>
         <strong>
          非预期的、不能由事务程序处理的故障
         </strong>
         ：这类故障是事务在执行过程中遇到的
         <strong>
          意外错误
         </strong>
         ，通常无法通过事务程序的逻辑检测和处理，
         <strong>
          需要数据库系统的恢复机制来解决
         </strong>
         。
        </p>
        <pre><code class="prism language-sql">系统崩溃：在事务执行过程中，数据库系统突然崩溃。
事务程序无法处理这种情况，需要数据库系统在重启后通过日志恢复机制来回滚未完成的事务。

硬件故障：例如磁盘损坏导致数据丢失。
事务程序无法处理这种情况，需要数据库系统通过备份和日志恢复机制来恢复数据。

死锁：多个事务相互等待资源，导致事务无法继续执行。
事务程序无法主动检测死锁，需要数据库系统的死锁检测机制来解除死锁。
</code></pre>
       </li>
      </ol>
     </li>
    </ul>
    <h3>
     <a id="2_65">
     </a>
     （2）系统故障
    </h3>
    <ul>
     <li>
      系统故障：称为软故障，是指
      <strong>
       造成系统停止运转的任何事件
      </strong>
      ，使得系统要重新启动。
     </li>
     <li>
      <strong>
       系统故障的常见原因
      </strong>
      <br/>
      特定类型的硬件错误（如CPU故障）
      <br/>
      操作系统故障
      <br/>
      数据库管理系统代码错误
      <br/>
      系统断电
     </li>
    </ul>
    <h3>
     <a id="3_73">
     </a>
     （3）介质故障
    </h3>
    <ul>
     <li>
      <strong>
       介质故障称为硬故障，指外存故障
      </strong>
     </li>
     <li>
      介质故障的常见原因
      <br/>
      磁盘损坏
      <br/>
      磁头碰撞
      <br/>
      瞬时强磁场干扰
     </li>
    </ul>
    <h3>
     <a id="4_83">
     </a>
     （4）计算机病毒
    </h3>
    <ul>
     <li>
      计算机病毒：一种人为的故障或破坏，是一些恶作剧者研制的一种计算机程序
      <br/>
      <strong>
       可以繁殖和传播
      </strong>
      ，造成对计算机系统包括数据库的危害
     </li>
    </ul>
    <h2>
     <a id="104___86">
     </a>
     10.4 恢复的实现技术
    </h2>
    <ul>
     <li>
      <p>
       <strong>
        恢复操作的基本原理：
        <font color="red">
         冗余
        </font>
       </strong>
       <br/>
       利用存储在系统别处的冗余数据来重建数据库中已被破坏或不正确的那部分数据
      </p>
      <blockquote>
       <p>
        <strong>
         冗余
        </strong>
        是指在系统中存储额外的数据，以便在数据丢失或损坏时能够恢复原始数据。
       </p>
      </blockquote>
     </li>
     <li>
      <p>
       <strong>
        如何建立冗余数据?
       </strong>
      </p>
      <ul>
       <li>
        <strong>
         数据转储（backup）
        </strong>
       </li>
       <li>
        <strong>
         登记日志文件（logging）
        </strong>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        如何利用这些冗余数据实施数据库恢复?
       </strong>
      </p>
     </li>
    </ul>
    <h3>
     <a id="1041___100">
     </a>
     10.4.1 数据转储
    </h3>
    <h4>
     <a id="10411__103">
     </a>
     10.4.1.1 数据转储的概念
    </h4>
    <p>
     <strong>
      转储是指数据库管理员定期地将整个数据库复制到磁带、磁盘或其他存储介质上保存起来的过程
     </strong>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/25305b8fdd704feea46f544491005e19.png"/>
    </p>
    <ul>
     <li>
      系统在Ta时刻停止运行事务，进行数据库转储
     </li>
     <li>
      在Tb时刻转储完毕，得到Tb时刻的数据库一致性副本
     </li>
     <li>
      系统运行到Tf时刻发生故障
     </li>
     <li>
      为恢复数据库，首先由数据库管理员重装数据库后备副本，将数据库恢复至Tb时刻的状态
     </li>
     <li>
      重新运行自Tb～Tf时刻的所有更新事务，把数据库恢复到故障发生前的一致状态
     </li>
    </ul>
    <h4>
     <a id="10412__113">
     </a>
     10.4.1.2 转储方法
    </h4>
    <h5>
     <a id="1_114">
     </a>
     （1）静态转储与动态转储
    </h5>
    <ul>
     <li>
      静态转储
      <ul>
       <li>
        在系统中无运行事务时进行的转储操作
       </li>
       <li>
        转储开始时数据库处于一致性状态
       </li>
       <li>
        转储期间不允许对数据库的任何存取、修改活动
       </li>
       <li>
        得到的一定是一个数据一致性的副本
       </li>
       <li>
        优点：实现简单
       </li>
       <li>
        缺点：降低了数据库的可用性，转储必须等待正运行的用户事务结束 ，新的事务必须等转储结束
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <ul>
     <li>
      <p>
       动态转储
      </p>
      <ul>
       <li>
        转储操作与用户事务并发进行
       </li>
       <li>
        转储期间允许对数据库进行存取或修改
       </li>
       <li>
        优点：不用等待正在运行的用户事务结束，不会影响新事务的运行
       </li>
       <li>
        缺点：不能保证副本中的数据正确有效
       </li>
      </ul>
      <pre><code class="prism language-sql">例在转储期间的某时刻Tc，系统把数据A<span class="token operator">=</span><span class="token number">100</span>转储到磁带上，而在下一时刻Td，某一事务将A改为<span class="token number">200</span>。
后备副本上的A过时了
</code></pre>
     </li>
     <li>
      <p>
       动态转储的故障恢复过程：
      </p>
      <ol>
       <li>
        <strong>
         动态转储
        </strong>
        ：在数据库运行期间进行转储，得到一个
        <strong>
         后备副本
        </strong>
        （即某一时刻的数据库快照）。
       </li>
       <li>
        <strong>
         记录日志
        </strong>
        ：在转储期间，所有事务对数据库的修改操作都会被记录到
        <strong>
         日志文件
        </strong>
        中。日志文件包含了事务的开始、提交、回滚以及具体的修改操作（如更新、插入、删除）。
       </li>
       <li>
        <strong>
         故障恢复
        </strong>
        ：
        <ul>
         <li>
          当数据库发生故障时，可以使用
          <strong>
           后备副本
          </strong>
          和
          <strong>
           日志文件
          </strong>
          来恢复数据库。
         </li>
         <li>
          首先，将数据库恢复到后备副本的状态（即转储开始时的状态）。
         </li>
         <li>
          然后，根据日志文件中的记录，重新执行（Redo）转储之后所有已提交的事务，撤销（Undo）未提交的事务，最终将数据库恢复到故障发生前的某一正确状态。
         </li>
        </ul>
       </li>
      </ol>
     </li>
    </ul>
    <pre><code class="prism language-sql">假设你是一个图书管理员，负责管理图书馆的书籍。这次你决定在图书馆开放期间记录书籍的状态（动态转储），而不是闭馆后记录（静态转储）。

<span class="token number">1.</span> 动态转储：
   <span class="token operator">-</span> 你开始记录书籍的状态（后备副本），但图书馆仍然开放，读者可以继续借书或还书。
   <span class="token operator">-</span> 在记录期间，你用一个本子（日志文件）记下每一位读者的借书和还书操作。

<span class="token number">2.</span> 故障发生：
   <span class="token operator">-</span> 突然，图书馆的电脑系统崩溃了，导致书籍的最新状态丢失。

<span class="token number">3.</span> 故障恢复：
   <span class="token operator">-</span> 你首先根据之前记录的书籍状态（后备副本）恢复图书馆的基本状态。
   <span class="token operator">-</span> 然后，你翻开本子（日志文件），查看在记录期间所有读者的借书和还书操作。
   <span class="token operator">-</span> 对于已经完成的借书和还书操作（已提交的事务），你重新执行这些操作，更新书籍的状态。
   <span class="token operator">-</span> 对于未完成的操作（未提交的事务），你忽略或撤销这些操作。
   <span class="token operator">-</span> 最终，图书馆的书籍状态被恢复到系统崩溃前的正确状态。
</code></pre>
    <h5>
     <a id="2_164">
     </a>
     （2）海量转储与增量转储
    </h5>
    <ul>
     <li>
      海量转储: 每次转储全部数据库
     </li>
     <li>
      增量转储: 只转储上次转储后更新过的数据
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a776e59f2e7c4840b651cf8f8d1c3b82.png"/>
    </p>
    <h3>
     <a id="1042___174">
     </a>
     10.4.2 登记日志文件
    </h3>
    <h4>
     <a id="10421__175">
     </a>
     10.4.2.1 日志文件的格式和内容
    </h4>
    <ul>
     <li>
      <strong>
       日志文件(log file)是用来记录事务对数据库的更新操作的文件
      </strong>
     </li>
     <li>
      日志文件的格式
      <ul>
       <li>
        以记录为单位的日志文件
       </li>
       <li>
        以数据块为单位的日志文件
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="10422__183">
     </a>
     10.4.2.2 日志文件的作用
    </h3>
    <ul>
     <li>
      事务故障恢复和系统故障恢复必须用日志文件。
     </li>
     <li>
      在动态转储方式中必须建立日志文件，后备副本和日志文件结合起来才能有效地恢复数据库。
     </li>
    </ul>
    <h3>
     <a id="10423__189">
     </a>
     10.4.2.3 登记日志文件
    </h3>
    <ul>
     <li>
      为保证数据库是可恢复的，登记日志文件时必须遵循两条原则
      <ol>
       <li>
        登记的次序严格按并发事务执行的时间次序
       </li>
       <li>
        必须先写日志文件，后写数据库
       </li>
      </ol>
     </li>
    </ul>
    <h2>
     <a id="105___195">
     </a>
     10.5 恢复策略
    </h2>
    <h3>
     <a id="1051___197">
     </a>
     10.5.1 事务故障的恢复
    </h3>
    <ul>
     <li>
      <p>
       事务故障：事务在运行至正常终止点前被终止
      </p>
     </li>
     <li>
      <p>
       <strong>
        事务故障的恢复
       </strong>
       ：事务故障的恢复是通过
       <strong>
        日志文件
       </strong>
       和
       <strong>
        撤销（UNDO）操作
       </strong>
       来实现的。
      </p>
     </li>
     <li>
      <p>
       <strong>
        事务故障的恢复步骤
       </strong>
      </p>
      <ul>
       <li>
        <strong>
         反向扫描文件日志
        </strong>
        ，对这些操作执行
        <strong>
         逆向操作
        </strong>
        （即撤销），将数据库恢复到事务执行前的状态。
        <ul>
         <li>
          如果事务修改了某条记录，恢复子系统会将记录的值改回原来的值。
         </li>
         <li>
          如果事务插入了一条新记录，恢复子系统会删除这条记录。
         </li>
         <li>
          如果事务删除了某条记录，恢复子系统会重新插入这条记录。
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="1052___218">
     </a>
     10.5.2 系统故障的恢复
    </h3>
    <ul>
     <li>
      <p>
       系统故障造成数据库不一致状态的原因
      </p>
      <ol>
       <li>
        未完成事务对数据库的更新可能已写入数据库
       </li>
       <li>
        已提交事务对数据库的更新可能还留在缓冲区没来得及写入数据库
       </li>
      </ol>
     </li>
     <li>
      <p>
       <strong>
        系统故障的恢复
       </strong>
      </p>
      <ol>
       <li>
        <strong>
         Undo 故障发生时未完成的事务
        </strong>
       </li>
       <li>
        <strong>
         Redo 已完成的事务
        </strong>
       </li>
      </ol>
     </li>
     <li>
      <p>
       <strong>
        系统故障的恢复步骤
       </strong>
      </p>
      <ol>
       <li>
        <strong>
         正向扫描日志文件
        </strong>
        <br/>
        重做(REDO) 队列: 在故障发生前已经提交的事务
        <br/>
        撤销 (UNDO)队列:故障发生时尚未完成的事务
       </li>
       <li>
        <strong>
         对撤销(UNDO)队列事务进行撤销(UNDO)处理
        </strong>
        <br/>
        <strong>
         反向扫描日志文件，对每个撤销事务的更新操作执行逆操作
        </strong>
       </li>
       <li>
        <strong>
         对重做(REDO)队列事务进行重做(REDO)处理
        </strong>
        <br/>
        <strong>
         正向扫描日志文件，对每个重做事务重新执行登记的操作
        </strong>
       </li>
      </ol>
     </li>
    </ul>
    <h3>
     <a id="1053___238">
     </a>
     10.5.3 介质故障的恢复
    </h3>
    <ul>
     <li>
      <strong>
       介质故障的恢复
      </strong>
      <ol>
       <li>
        重装数据库
       </li>
       <li>
        重做已完成的事务
       </li>
      </ol>
     </li>
    </ul>
    <h2>
     <a id="106___243">
     </a>
     10.6 具有检查点的恢复技术
    </h2>
    <h3>
     <a id="1061__244">
     </a>
     10.6.1 检查点技术
    </h3>
    <p>
     具有检查点（checkpoint）的恢复技术：
     <br/>
     ①
     <strong>
      在日志文件中增加检查点记录（checkpoint）
     </strong>
     <br/>
     ②增加重新开始文件：记录各个检查点记录在日志文件中的地址
     <br/>
     ③恢复子系统在登录日志文件期间动态地维护日志：建立检查点，保存数据库状态。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7847015ecf644c9d88854584c04ddf26.png"/>
    </p>
    <h3>
     <a id="1062___250">
     </a>
     10.6.2 利用检查点的恢复策略
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/90aebe2f49a24c5d869b4d947c6eb24c.png"/>
    </p>
    <ul>
     <li>
      T3和T5在故障发生时还未完成，所以予以撤销
     </li>
     <li>
      T2和T4在检查点之后才提交，它们对数据库所做的修改在故障发生时可能还在缓冲区中，尚未写入数据库，所以要重做
     </li>
     <li>
      T1在检查点之前已提交，所以不必执行重做操作
     </li>
    </ul>
    <h2>
     <a id="107___259">
     </a>
     10.7 数据库镜像
    </h2>
    <ul>
     <li>
      数据库管理系统自动把整个数据库或其中的
      <strong>
       关键数据+日志文件
      </strong>
      复制到另一个磁盘上
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e1e0a4e45d2d4ade8a3beaf252879ee3.png"/>
    </p>
    <ul>
     <li>
      <strong>
       出现介质故障时
      </strong>
      <ul>
       <li>
        可由镜像磁盘继续提供使用
       </li>
       <li>
        同时数据库管理系统自动利用镜像磁盘数据进行数据库的恢复
       </li>
       <li>
        不需要关闭系统和重装数据库副本
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7b5d4ae21aba493586846e03f24afc3c.png"/>
       </li>
      </ul>
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f35313335303332362f:61727469636c652f64657461696c732f313436313438303536" class_="artid" style="display:none">
 </p>
</div>


