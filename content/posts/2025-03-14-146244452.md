---
layout: post
title: "网络层协议"
date: 2025-03-14 12:20:10 +0800
description: "如果你的10台主机不是每一时刻都要使用，则可以让路由器给当前在使用的主机分配一个主机号，而当前没有使用的主机则不分配主机号，从而达到动态分配主机号（IP）的效果，提高IP地址的使用率。在网络发展的前期没有那么多主机使用，所以这样的划分方式是可行的，但是随着网络的迅猛发展，人们很快发现IP竟然不够用了。他的意思是IP报文的序号，如果IP报文不用分片就是一个单独的序号，一旦IP报文分片了，则这些小片的16位标识全都必须是一样的序号，这样对端在收到IP报文的时候就能把同一个数据报的小片拼接起来，并向上层传递。"
keywords: "网络层协议"
categories: ['Linux']
tags: ['运维', '服务器']
artid: "146244452"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146244452
    alt: "网络层协议"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146244452
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146244452
cover: https://bing.ee123.net/img/rand?artid=146244452
image: https://bing.ee123.net/img/rand?artid=146244452
img: https://bing.ee123.net/img/rand?artid=146244452
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     网络层协议
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <hr id="hr-toc" name="tableOfContents"/>
    <p>
    </p>
    <h2 id="%E4%B8%80%E3%80%81%E7%BD%91%E6%AE%B5%E5%88%92%E5%88%86%E7%9A%84%E5%8F%91%E5%B1%95%E8%BF%87%E7%A8%8B" name="%E4%B8%80%E3%80%81%E7%BD%91%E6%AE%B5%E5%88%92%E5%88%86%E7%9A%84%E5%8F%91%E5%B1%95%E8%BF%87%E7%A8%8B" style="background-color:transparent">
     一、网段划分的发展过程
    </h2>
    <h3 id="%EF%BC%881%EF%BC%89%E5%9B%BA%E5%AE%9A%E9%95%BF%E5%BA%A6%E7%9A%84%E7%BD%91%E7%BB%9C%E5%8F%B7" name="%EF%BC%881%EF%BC%89%E5%9B%BA%E5%AE%9A%E9%95%BF%E5%BA%A6%E7%9A%84%E7%BD%91%E7%BB%9C%E5%8F%B7">
     （1）固定长度的网络号
    </h3>
    <p>
     在讲IP协议之前，我们要了解一件事：在网络刚开始被设计出来的时候，是只有公网IP的，采取的是IPv4（Internet Protocol version 4）即互联网协议第4版，IPv4地址采用32位地址长度，分为四组8位二进制数，每组以十进制表示，范围从0到255，例如192.168.1.1。
    </p>
    <p>
     而路由器工作的原理是，在某一个路由器下的主机的IP地址配置成前面若干位数相同，这个我们称之为网络号，在同一个路由器下的主机使用IP地址的后若干位数来区分，这个我们叫做主机号。
    </p>
    <p>
     <img alt="" height="823" src="https://i-blog.csdnimg.cn/direct/dd19cd6dc83949028c3979ce0dd25532.png" width="960"/>
    </p>
    <p>
     那么根据路由器的工作原理，我们天然就需要把IP地址分组，供路由器们使用。在网络前期，人们采取的是把IP地址分为5类，根据子网的大小来选择合适位数的网络号和主机数量。
    </p>
    <p>
     <img alt="" height="578" src="https://i-blog.csdnimg.cn/direct/b4a2ef37a4714b71a80c639b95afc5bd.png" width="1044"/>
    </p>
    <p>
     <img alt="" height="329" src="https://i-blog.csdnimg.cn/direct/ff9cab03ef304f1bb651ff195fc93f4e.png" width="623"/>
    </p>
    <p>
     比如你是一个大公司，你的子网下的主机数量肯定很多，那么你就申请A类或者B类IP，这样你网络号占据的比特位就很少，而留给主机号的位数就很多。同理，小公司或者家庭的主机数量很少，所以需要的主机号也很少，只需要申请C类IP也够使用了。
    </p>
    <p>
     在网络发展的前期没有那么多主机使用，所以这样的划分方式是可行的，但是随着网络的迅猛发展，人们很快发现IP竟然不够用了。为什么呢？因为这种方式划分的网段（子网）太过于死板，很多情况下某一个网络号的主机号都没有被使用干净，就比如你一个家庭明明只有三台主机，但是你却申请到了一个A类IP，那么你就浪费了许多的IP地址。
    </p>
    <p>
    </p>
    <h3 id="%EF%BC%882%EF%BC%89%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81---%E7%BD%91%E7%BB%9C%E5%8F%B7%E9%95%BF%E5%BA%A6%E4%B8%8D%E5%86%8D%E5%9B%BA%E5%AE%9A" name="%EF%BC%882%EF%BC%89%E5%AD%90%E7%BD%91%E6%8E%A9%E7%A0%81---%E7%BD%91%E7%BB%9C%E5%8F%B7%E9%95%BF%E5%BA%A6%E4%B8%8D%E5%86%8D%E5%9B%BA%E5%AE%9A">
     （2）子网掩码---网络号长度不再固定
    </h3>
    <p>
     于是人们想了一个办法-----子网掩码。子网掩码能有效的缓解IP地址浪费的问题。
    </p>
    <p>
     <img alt="" height="289" src="https://i-blog.csdnimg.cn/direct/bf606e6027a046f9b8501f66fca21161.png" width="1113"/>
    </p>
    <p>
     <img alt="" height="880" src="https://i-blog.csdnimg.cn/direct/f8d2f123e7af4745aa742af74a511f08.png" width="1207"/>
    </p>
    <p>
     可见,IP 地址与子网掩码做与运算可以得到网络号, 主机号从全 0 到全 1 就是子网的地
     <br/>
     址范围。
    </p>
    <p>
     IP 地址和子网掩码还有一种更简洁的表示方法,例如 140.252.20.68/24,表示 IP 地址为
     <br/>
     140.252.20.68, 子网掩码的高 24 位是 1,也就是 255.255.255.0
    </p>
    <p>
     因为子网掩码的32个比特位中的前若干位都可以为1，即网络号不再和以前一样是固定的大小，而是任意的个数。只要IP地址按位与上子网掩码得到的就是网络号。子网掩码的网络划分方式极大程度上的缓解了IP地址浪费的问题。
    </p>
    <p>
     在此时，主机的数量仍然不是很多，如果每一个主机都有一个IP地址的话似乎也够用。
    </p>
    <p>
     但是随着网络的发展，人们很快意识到，全球的主机数量已经远远超过IPv4的2的32次方个了。那么如果一台主机仍然分配一个固定的IP地址，是显然不可取的。在此基础上，人们优化了IP地址的分配规则，不再是固定分配的，而是根据主机的联网使用情况动态分配主机号（即IP地址），我们把这个技术叫做DHCP。
    </p>
    <p>
     <img alt="" height="222" src="https://i-blog.csdnimg.cn/direct/2c39e559fb0f4cf1b66e5d8bf9d1473d.png" width="1254"/>
    </p>
    <p>
     DHCP是技术是集成在路由器中的，打个比方说：你这个路由器下有3位可以用作主机号，那么你最多就可以有8台主机（实际上要减去2台，0号表示网络号，主机号全1表示向该子网做广播）即最多可以连接6台主机，但是你现在有10台主机要连接怎么办呢？如果你的10台主机不是每一时刻都要使用，则可以让路由器给当前在使用的主机分配一个主机号，而当前没有使用的主机则不分配主机号，从而达到动态分配主机号（IP）的效果，提高IP地址的使用率。
    </p>
    <blockquote>
     <p>
      <strong>
       DHCP技术，是一种锦上添花的技术。实际上真正能解决的问题的策略只有两种：
      </strong>
     </p>
     <p>
      （1）使用IPV6协议，扩大IP地址的位数至128位，这样能表示的主机号就非常大了。
     </p>
     <p>
      （2）采取公有IP/私有IP的办法，使得同一个IP在不同的子网内可以重复利用。
     </p>
    </blockquote>
    <p>
     由于网络发展的原因，IPv6协议并没有得到广泛的使用，且IPv6和IPv4并不兼容，推广起来比较困难，所以现实生活中全球都是采取的公有IP和私有IP来解决IPv4中IP地址不够用的问题的。
    </p>
    <p>
    </p>
    <h2 id="%E4%BA%8C%E3%80%81%E5%85%AC%E6%9C%89IP%E5%92%8C%E7%A7%81%E6%9C%89IP" name="%E4%BA%8C%E3%80%81%E5%85%AC%E6%9C%89IP%E5%92%8C%E7%A7%81%E6%9C%89IP">
     二、公有IP和私有IP
    </h2>
    <h3 id="%EF%BC%881%EF%BC%89%E7%A7%81%E6%9C%89IP" name="%EF%BC%881%EF%BC%89%E7%A7%81%E6%9C%89IP">
     （1）私有IP
    </h3>
    <p>
     如果一个组织内部组建局域网,IP 地址只用于局域网内的通信,而不直接连到 Internet 上,理论上 使用任意的 IP 地址都可以,但是 RFC 1918 规定了用于组建局域网的私有 IP 地址。
    </p>
    <p>
     <img alt="" height="281" src="https://i-blog.csdnimg.cn/direct/52e08419bf80452d827c08942d2f80d7.png" width="1065"/>
    </p>
    <p>
     可以根据我要建立的子网的大小来选择是使用功能10开头还是172开头亦或者是192开头，这取决于我的主机数量。
    </p>
    <p>
     <strong>
      而私有IP的特点是，不能入公网，且在不同的私网下IP是可以重复的。
     </strong>
     即今天在我家的路由器下，我可以使用192.168.0.1作为我电脑的IP，别人也可以在自己的路由器下使用192.168.0.1作为他电脑的IP。（因为私有IP不入公网，如果要进行不同子网的网络通信会采取NAT技术，后面再讲）
    </p>
    <p>
     <img alt="" height="821" src="https://i-blog.csdnimg.cn/direct/fc38a1247c614ca88955fc2908475b3a.png" width="1055"/>
    </p>
    <p>
    </p>
    <h3 id="%EF%BC%882%EF%BC%89NAT%E6%8A%80%E6%9C%AF" name="%EF%BC%882%EF%BC%89NAT%E6%8A%80%E6%9C%AF" style="background-color:transparent">
     （2）NAT技术
    </h3>
    <p>
     前面我们说了两个子网可以使用相同的私有IP地址，那么两个子网的主机如果想要进行通信呢？怎么解决私有IP相同而找不到目标主机的问题呢？这就是我们的NAT技术。
    </p>
    <p>
     <img alt="" height="825" src="https://i-blog.csdnimg.cn/direct/9bbacca534f241fc99254f7285e5d91b.png" width="1295"/>
    </p>
    <p>
     <strong>
      比方说我现在要访问一个公网ip地址122.77.241.3
     </strong>
    </p>
    <blockquote>
     <p>
      <strong>
       路由器要做的事情：
      </strong>
     </p>
     <p>
      <strong>
       （1）接收自己子网的私有IP地址，将其替换成路由器WAN口的IP
      </strong>
     </p>
     <p>
      <strong>
       （2）在自己路由器的路由表中查看，有没有和目的IP网络号相同的，如果没有将IP报文向下一个缺省路由器做转发。（这个路由器我们称为内网（私网）路由器）
      </strong>
     </p>
     <p>
      <strong>
       （3）当某个路由器在自己的路由表中发现了公网IP且和我目的的IP的网络号相同，则转发给改公网IP。（这个路由器我们称为出入口路由器，用来进行公网和私网的数据传递）
      </strong>
     </p>
    </blockquote>
    <p>
     也就是说，世界上的所有主机都是在一层层的私网中的，这些个私网由运营商来统一管理，当我们要进行网络通信的时候，本质是把数据报发给运营商的路由器，由运营商一步步往上层传递，直到传递到公网IP中。
    </p>
    <p>
     <img alt="" height="575" src="https://i-blog.csdnimg.cn/direct/5759e98c115d47e59af1b68c3913f935.jpeg" width="944"/>
    </p>
    <p>
     在了解了网络的基础原理后，我们再来看看真正的IP报头。
    </p>
    <p>
    </p>
    <h2 id="%E4%B8%89%E3%80%81IP%E5%8D%8F%E8%AE%AE%E6%8A%A5%E5%A4%B4" name="%E4%B8%89%E3%80%81IP%E5%8D%8F%E8%AE%AE%E6%8A%A5%E5%A4%B4">
     三、IP协议报头
    </h2>
    <p>
     <img alt="" height="638" src="https://i-blog.csdnimg.cn/direct/20b7d9d131774cb99a8c124d28a35e90.png" width="964"/>
    </p>
    <p>
     <img alt="" height="1601" src="https://i-blog.csdnimg.cn/direct/9c7cc9896030488f97f9248ab198ff70.png" width="1280"/>
    </p>
    <p>
     <strong>
      这些字段都比较好理解，不过我们要注意其中的：16位标识，3位标志，和13位片偏移。
     </strong>
    </p>
    <p>
     <strong>
      这涉及到分片和重组操作。
     </strong>
    </p>
    <h3 id="%E5%88%86%E7%89%87%E6%93%8D%E4%BD%9C" name="%E5%88%86%E7%89%87%E6%93%8D%E4%BD%9C" style="background-color:transparent">
     分片操作
    </h3>
    <blockquote>
     <p>
      由于数据链路层的物理特性，一般在最底层无法转发太大的数据，一次性可以转发到交换机中的网络报文限制是1500字节（这个我们称为MTU），但是实际上由于有IP报头，TCP/UDP报头的存在，实际上留给应用层的空间会小于1500字节。比如IP报头和TCP报头都是20个字节的话，那么应用层的空间就是1500-20*2=1460个字节。这个我们称为MSS，而MSS是在刚开始通信的时候，双方要进行协商达成的。
     </p>
     <p>
      所以一旦数据包太大，在网络层就会将TCP/UDP报文分片，给每一个报文一个序号，序号相同的要组装到一起。
     </p>
    </blockquote>
    <p>
     首先我们来看看这个
     <span style="color:null">
      <span style="background-color:#ffd900">
       16位标识
      </span>
     </span>
     。
    </p>
    <p>
     他的意思是IP报文的序号，如果IP报文不用分片就是一个单独的序号，一旦IP报文分片了，则这些小片的16位标识全都必须是一样的序号，这样对端在收到IP报文的时候就能把同一个数据报的小片拼接起来，并向上层传递。
    </p>
    <p>
     而
     <span style="background-color:#ffd900">
      13位片偏移
     </span>
     就好像TCP协议中的32位序号，表示该小片在原本的数据中的偏移量，这样对方在收到数据后就能根据偏移量一个个还原到原本的位置。
    </p>
    <p>
     <span style="background-color:#ffd900">
      3位标志
     </span>
     中的第一位是没有使用的，第二位为 1 表示禁止分片, 这时候如果报文长度超过 MTU, IP 模块就会丢弃报文。 第三位表示"更多分片", 如果分片了的话, 最后一个分片置为 0, 其他是 1.。类似于一个结束标记。
    </p>
    <p>
    </p>
    <h2 id="%E5%9B%9B%E3%80%81%E6%9F%A5%E7%9C%8B%E4%B8%80%E4%B8%8Blinux%E4%B8%AD%E7%9A%84%E8%B7%AF%E7%94%B1%E8%A1%A8" name="%E5%9B%9B%E3%80%81%E6%9F%A5%E7%9C%8B%E4%B8%80%E4%B8%8Blinux%E4%B8%AD%E7%9A%84%E8%B7%AF%E7%94%B1%E8%A1%A8">
     四、查看一下linux中的路由表
    </h2>
    <p>
     <img alt="" height="720" src="https://i-blog.csdnimg.cn/direct/0f1fe9c5e9074b4db3866bfbdef14824.png" width="1273"/>
    </p>
    <p>
     <img alt="" height="267" src="https://i-blog.csdnimg.cn/direct/59d2fa0581dc4060a39f1675c6f885dc.png" width="1238"/>
    </p>
    <p>
     <img alt="" height="407" src="https://i-blog.csdnimg.cn/direct/b742f1d564d944e2967d02415189176f.png" width="1251"/>
    </p>
    <p>
     <strong>
      Gateway是网关的意思，表示从Destination主机可以发送到另外哪一个主机的IP地址
     </strong>
    </p>
    <p>
     <img alt="" height="386" src="https://i-blog.csdnimg.cn/direct/046fa9da93a7472590af8259dc6f1aa7.png" width="1245"/>
    </p>
    <p>
     <img alt="" height="540" src="https://i-blog.csdnimg.cn/direct/754d5c9d84ab4d9b9572027f13bf9826.png" width="1288"/>
    </p>
    <p>
     <img alt="" height="327" src="https://i-blog.csdnimg.cn/direct/3c06b262056f4280a2abedf1496acf46.png" width="1078"/>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330335f37393333363832302f:61727469636c652f64657461696c732f313436323434343532" class_="artid" style="display:none">
 </p>
</div>


