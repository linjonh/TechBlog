---
layout: post
title: "Spring-Boot-实现多数据源配置"
date: 2025-03-15 10:18:47 +0800
description: "在application.properties或application.yml中配置多个数据源的连接信息。在 Spring Boot 中实现多数据源配置通常用于需要连接多个数据库的场景。首先，在pom.xml中添加MyBatis、数据库驱动和Spring Boot的JDBC依赖。在Spring Boot中，通过@Configuration类来配置多个数据源的Bean。将Mapper接口和XML文件分别放在不同的包中，以区分不同的数据源。主数据源Mapper XML文件。次数据源Mapper XML文件。"
keywords: "Spring Boot 实现多数据源配置"
categories: ['Springboot']
tags: ['后端', 'Spring', 'Java', 'Boot']
artid: "145923546"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145923546
    alt: "Spring-Boot-实现多数据源配置"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145923546
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145923546
cover: https://bing.ee123.net/img/rand?artid=145923546
image: https://bing.ee123.net/img/rand?artid=145923546
img: https://bing.ee123.net/img/rand?artid=145923546
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Spring Boot 实现多数据源配置
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h4>
     <a id="_0">
     </a>
     一、配置流程
    </h4>
    <p>
     在 Spring Boot 中实现多数据源配置通常用于需要连接多个数据库的场景。主要有以下几个步骤：
    </p>
    <ol>
     <li>
      配置多个数据源的连接信息。
     </li>
     <li>
      定义多个数据源的 Bean。
     </li>
     <li>
      为每个数据源配置MyBatis的SqlSessionFactory和事务管理器。
     </li>
     <li>
      为每个数据源定义Mapper接口和Mapper XML文件。
     </li>
     <li>
      在服务类中使用不同的Mapper接口操作对应的数据源。
     </li>
    </ol>
    <h4>
     <a id="_8">
     </a>
     二、详细步骤
    </h4>
    <h5>
     <a id="21__9">
     </a>
     2.1 添加依赖
    </h5>
    <p>
     首先，在pom.xml中添加MyBatis、数据库驱动和Spring Boot的JDBC依赖。
    </p>
    <pre><code class="prism language-bash"><span class="token operator">&lt;</span>dependencies<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span>-- Spring Boot Starter Web <span class="token punctuation">(</span>可选，如果需要使用Web功能<span class="token punctuation">)</span> --<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.springframework.boot<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring-boot-starter-web<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">!</span>-- MyBatis Starter --<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.mybatis.spring.boot<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>mybatis-spring-boot-starter<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">2.2</span>.<span class="token operator"><span class="token file-descriptor important">2</span>&lt;</span>/version<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">!</span>-- MySQL 驱动 --<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>mysql<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>mysql-connector-java<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">!</span>-- Spring Boot Starter JDBC --<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.springframework.boot<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>spring-boot-starter-jdbc<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependencies<span class="token operator">&gt;</span>
</code></pre>
    <h5>
     <a id="22__40">
     </a>
     2.2 配置多数据源
    </h5>
    <p>
     在application.properties或application.yml中配置多个数据源的连接信息。
    </p>
    <pre><code class="prism language-bash">spring:
  datasource:
    primary:
      jdbc-url: jdbc:mysql://localhost:3306/db1
      username: root
      password: password
      driver-class-name: com.mysql.cj.jdbc.Driver
    secondary:
      jdbc-url: jdbc:mysql://localhost:3306/db2
      username: root
      password: password
      driver-class-name: com.mysql.cj.jdbc.Driver
</code></pre>
    <h5>
     <a id="23_Bean_57">
     </a>
     2.3 配置数据源Bean
    </h5>
    <p>
     在Spring Boot中，通过@Configuration类来配置多个数据源的Bean。
    </p>
    <pre><code class="prism language-bash"><span class="token function">import</span> org.springframework.boot.context.properties.ConfigurationProperties<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.boot.jdbc.DataSourceBuilder<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.context.annotation.Bean<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.context.annotation.Configuration<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.context.annotation.Primary<span class="token punctuation">;</span>

<span class="token function">import</span> javax.sql.DataSource<span class="token punctuation">;</span>

@Configuration
public class DataSourceConfig <span class="token punctuation">{<!-- --></span>

    // 主数据源
    @Bean<span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"primaryDataSource"</span><span class="token punctuation">)</span>
    @Primary
    @ConfigurationProperties<span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.datasource.primary"</span><span class="token punctuation">)</span>
    public DataSource <span class="token function-name function">primaryDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin class-name">return</span> DataSourceBuilder.create<span class="token punctuation">(</span><span class="token punctuation">)</span>.build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    // 次数据源
    @Bean<span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"secondaryDataSource"</span><span class="token punctuation">)</span>
    @ConfigurationProperties<span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"spring.datasource.secondary"</span><span class="token punctuation">)</span>
    public DataSource <span class="token function-name function">secondaryDataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin class-name">return</span> DataSourceBuilder.create<span class="token punctuation">(</span><span class="token punctuation">)</span>.build<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="24_MyBatisSqlSessionFactory_88">
     </a>
     2.4 配置MyBatis的SqlSessionFactory和事务管理器
    </h5>
    <p>
     为每个数据源配置独立的SqlSessionFactory和DataSourceTransactionManager。
    </p>
    <ul>
     <li>
      <p>
       PrimaryDataSourceConfig .java
      </p>
      <pre><code class="prism language-bash"><span class="token function">import</span> org.apache.ibatis.session.SqlSessionFactory<span class="token punctuation">;</span>
<span class="token function">import</span> org.mybatis.spring.SqlSessionFactoryBean<span class="token punctuation">;</span>
<span class="token function">import</span> org.mybatis.spring.annotation.MapperScan<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.beans.factory.annotation.Qualifier<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.context.annotation.Bean<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.context.annotation.Configuration<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.context.annotation.Primary<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.core.io.support.PathMatchingResourcePatternResolver<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.jdbc.datasource.DataSourceTransactionManager<span class="token punctuation">;</span>

<span class="token function">import</span> javax.sql.DataSource<span class="token punctuation">;</span>

@Configuration
@MapperScan<span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.example.mapper.primary"</span>, sqlSessionFactoryRef <span class="token operator">=</span> 	<span class="token string">"primarySqlSessionFactory"</span><span class="token punctuation">)</span>
public class PrimaryDataSourceConfig <span class="token punctuation">{<!-- --></span>

	@Bean<span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"primarySqlSessionFactory"</span><span class="token punctuation">)</span>
	@Primary
	public SqlSessionFactory primarySqlSessionFactory<span class="token punctuation">(</span>@Qualifier<span class="token punctuation">(</span><span class="token string">"primaryDataSource"</span><span class="token punctuation">)</span> DataSource dataSource<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
    	SqlSessionFactoryBean sessionFactory <span class="token operator">=</span> new SqlSessionFactoryBean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	sessionFactory.setDataSource<span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	// 设置MyBatis的Mapper XML文件路径
    	sessionFactory.setMapperLocations<span class="token punctuation">(</span>new PathMatchingResourcePatternResolver<span class="token punctuation">(</span><span class="token punctuation">)</span>
            	.getResources<span class="token punctuation">(</span><span class="token string">"classpath:mapper/primary/*.xml"</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
    	<span class="token builtin class-name">return</span> sessionFactory.getObject<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	@Bean<span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"primaryTransactionManager"</span><span class="token punctuation">)</span>
	@Primary
    public DataSourceTransactionManager primaryTransactionManager<span class="token punctuation">(</span>@Qualifier<span class="token punctuation">(</span><span class="token string">"primaryDataSource"</span><span class="token punctuation">)</span> DataSource dataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token builtin class-name">return</span> new DataSourceTransactionManager<span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
     <li>
      <p>
       SecondaryDataSourceConfig.java
      </p>
      <pre><code class="prism language-bash"><span class="token function">import</span> org.apache.ibatis.session.SqlSessionFactory<span class="token punctuation">;</span>
<span class="token function">import</span> org.mybatis.spring.SqlSessionFactoryBean<span class="token punctuation">;</span>
<span class="token function">import</span> org.mybatis.spring.annotation.MapperScan<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.beans.factory.annotation.Qualifier<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.context.annotation.Bean<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.context.annotation.Configuration<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.core.io.support.PathMatchingResourcePatternResolver<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.jdbc.datasource.DataSourceTransactionManager<span class="token punctuation">;</span>

<span class="token function">import</span> javax.sql.DataSource<span class="token punctuation">;</span>

@Configuration
@MapperScan<span class="token punctuation">(</span>basePackages <span class="token operator">=</span> <span class="token string">"com.example.mapper.secondary"</span>, sqlSessionFactoryRef <span class="token operator">=</span> <span class="token string">"secondarySqlSessionFactory"</span><span class="token punctuation">)</span>
public class SecondaryDataSourceConfig <span class="token punctuation">{<!-- --></span>

	@Bean<span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"secondarySqlSessionFactory"</span><span class="token punctuation">)</span>
	public SqlSessionFactory secondarySqlSessionFactory<span class="token punctuation">(</span>@Qualifier<span class="token punctuation">(</span><span class="token string">"secondaryDataSource"</span><span class="token punctuation">)</span> DataSource dataSource<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
    	SqlSessionFactoryBean sessionFactory <span class="token operator">=</span> new SqlSessionFactoryBean<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	sessionFactory.setDataSource<span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	// 设置MyBatis的Mapper XML文件路径
    	sessionFactory.setMapperLocations<span class="token punctuation">(</span>new PathMatchingResourcePatternResolver<span class="token punctuation">(</span><span class="token punctuation">)</span>
            	.getResources<span class="token punctuation">(</span><span class="token string">"classpath:mapper/secondary/*.xml"</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
    	<span class="token builtin class-name">return</span> sessionFactory.getObject<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	@Bean<span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"secondaryTransactionManager"</span><span class="token punctuation">)</span>
	public DataSourceTransactionManager secondaryTransactionManager<span class="token punctuation">(</span>@Qualifier<span class="token punctuation">(</span><span class="token string">"secondaryDataSource"</span><span class="token punctuation">)</span> DataSource dataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token builtin class-name">return</span> new DataSourceTransactionManager<span class="token punctuation">(</span>dataSource<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
    </ul>
    <h5>
     <a id="25_MapperXML_160">
     </a>
     2.5 配置Mapper接口和XML文件
    </h5>
    <p>
     将Mapper接口和XML文件分别放在不同的包中，以区分不同的数据源。
    </p>
    <ul>
     <li>
      <p>
       主数据源Mapper接口
      </p>
      <pre><code class="prism language-bash">package com.example.mapper.primary<span class="token punctuation">;</span>

<span class="token function">import</span> com.example.model.User<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.ibatis.annotations.Mapper<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.List<span class="token punctuation">;</span>

@Mapper
public interface PrimaryUserMapper <span class="token punctuation">{<!-- --></span>
	List<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> findAll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
     <li>
      <p>
       次数据源Mapper接口
      </p>
      <pre><code class="prism language-bash">package com.example.mapper.secondary<span class="token punctuation">;</span>

<span class="token function">import</span> com.example.model.Product<span class="token punctuation">;</span>
<span class="token function">import</span> org.apache.ibatis.annotations.Mapper<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.List<span class="token punctuation">;</span>

@Mapper
public interface SecondaryProductMapper <span class="token punctuation">{<!-- --></span>
	List<span class="token operator">&lt;</span>Product<span class="token operator">&gt;</span> findAll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
     <li>
      <p>
       主数据源Mapper XML文件
       <br/>
       在src/main/resources/mapper/primary目录下创建UserMapper.xml：
      </p>
      <pre><code class="prism language-bash"><span class="token operator">&lt;</span>?xml <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">"1.0"</span> <span class="token assign-left variable">encoding</span><span class="token operator">=</span><span class="token string">"UTF-8"</span> ?<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE mapper
PUBLIC <span class="token string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>
<span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>mapper <span class="token assign-left variable">namespace</span><span class="token operator">=</span><span class="token string">"com.example.mapper.primary.PrimaryUserMapper"</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>select <span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token string">"findAll"</span> <span class="token assign-left variable">resultType</span><span class="token operator">=</span><span class="token string">"com.example.model.User"</span><span class="token operator">&gt;</span>
    	SELECT * FROM user
	<span class="token operator">&lt;</span>/select<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/mapper<span class="token operator">&gt;</span>
</code></pre>
     </li>
     <li>
      <p>
       次数据源Mapper XML文件
       <br/>
       在src/main/resources/mapper/secondary目录下创建ProductMapper.xml：
      </p>
      <pre><code class="prism language-bash"><span class="token operator">&lt;</span>?xml <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">"1.0"</span> <span class="token assign-left variable">encoding</span><span class="token operator">=</span><span class="token string">"UTF-8"</span> ?<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE mapper
PUBLIC <span class="token string">"-//mybatis.org//DTD Mapper 3.0//EN"</span>
<span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>mapper <span class="token assign-left variable">namespace</span><span class="token operator">=</span><span class="token string">"com.example.mapper.secondary.SecondaryProductMapper"</span><span class="token operator">&gt;</span>
	<span class="token operator">&lt;</span>select <span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token string">"findAll"</span> <span class="token assign-left variable">resultType</span><span class="token operator">=</span><span class="token string">"com.example.model.Product"</span><span class="token operator">&gt;</span>
    	SELECT * FROM product
	<span class="token operator">&lt;</span>/select<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/mapper<span class="token operator">&gt;</span>
</code></pre>
     </li>
    </ul>
    <h5>
     <a id="26__217">
     </a>
     2.6 使用多数据源
    </h5>
    <p>
     在Service中注入对应的Mapper接口，并使用@Transactional注解指定事务管理器。
    </p>
    <pre><code class="prism language-bash"><span class="token function">import</span> com.example.mapper.primary.PrimaryUserMapper<span class="token punctuation">;</span>
<span class="token function">import</span> com.example.mapper.secondary.SecondaryProductMapper<span class="token punctuation">;</span>
<span class="token function">import</span> com.example.model.User<span class="token punctuation">;</span>
<span class="token function">import</span> com.example.model.Product<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.beans.factory.annotation.Autowired<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.stereotype.Service<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.transaction.annotation.Transactional<span class="token punctuation">;</span>

<span class="token function">import</span> java.util.List<span class="token punctuation">;</span>

@Service
public class MyService <span class="token punctuation">{<!-- --></span>

    @Autowired
    private PrimaryUserMapper primaryUserMapper<span class="token punctuation">;</span>

    @Autowired
    private SecondaryProductMapper secondaryProductMapper<span class="token punctuation">;</span>

    @Transactional<span class="token punctuation">(</span><span class="token string">"primaryTransactionManager"</span><span class="token punctuation">)</span>
    public List<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> <span class="token function-name function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin class-name">return</span> primaryUserMapper.findAll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Transactional<span class="token punctuation">(</span><span class="token string">"secondaryTransactionManager"</span><span class="token punctuation">)</span>
    public List<span class="token operator">&lt;</span>Product<span class="token operator">&gt;</span> <span class="token function-name function">getProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin class-name">return</span> secondaryProductMapper.findAll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_251">
     </a>
     三、动态数据源切换
    </h4>
    <p>
     如果需要动态切换数据源，可以通过以下步骤：
    </p>
    <ol>
     <li>
      动态数据源配置
      <pre><code class="prism language-bash"><span class="token function">import</span> org.springframework.jdbc.datasource.lookup.AbstractRoutingDataSource<span class="token punctuation">;</span>

public class DynamicDataSource extends AbstractRoutingDataSource <span class="token punctuation">{<!-- --></span>

	@Override
	protected Object <span class="token function-name function">determineCurrentLookupKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token builtin class-name">return</span> DataSourceContextHolder.getDataSourceType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
     <li>
      数据源上下文持有者
      <pre><code class="prism language-bash">public class DataSourceContextHolder <span class="token punctuation">{<!-- --></span>

	private static final ThreadLocal<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> contextHolder <span class="token operator">=</span> new ThreadLocal<span class="token operator">&lt;&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	public static void setDataSourceType<span class="token punctuation">(</span>String dataSourceType<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	contextHolder.set<span class="token punctuation">(</span>dataSourceType<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	public static String <span class="token function-name function">getDataSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token builtin class-name">return</span> contextHolder.get<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	public static void <span class="token function-name function">clearDataSourceType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	contextHolder.remove<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
     <li>
      AOP切面
      <pre><code class="prism language-bash"><span class="token function">import</span> org.aspectj.lang.annotation.Aspect<span class="token punctuation">;</span>
<span class="token function">import</span> org.aspectj.lang.annotation.Before<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.stereotype.Component<span class="token punctuation">;</span>

@Aspect
@Component
public class DataSourceAspect <span class="token punctuation">{<!-- --></span>

	@Before<span class="token punctuation">(</span><span class="token string">"@annotation(dataSource)"</span><span class="token punctuation">)</span>
	public void switchDataSource<span class="token punctuation">(</span>DataSource dataSource<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	DataSourceContextHolder.setDataSourceType<span class="token punctuation">(</span>dataSource.value<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
     <li>
      自定义注解
      <pre><code class="prism language-bash"><span class="token function">import</span> java.lang.annotation.ElementType<span class="token punctuation">;</span>
<span class="token function">import</span> java.lang.annotation.Retention<span class="token punctuation">;</span>
<span class="token function">import</span> java.lang.annotation.RetentionPolicy<span class="token punctuation">;</span>
<span class="token function">import</span> java.lang.annotation.Target<span class="token punctuation">;</span>

@Target<span class="token punctuation">(</span>ElementType.METHOD<span class="token punctuation">)</span>
@Retention<span class="token punctuation">(</span>RetentionPolicy.RUNTIME<span class="token punctuation">)</span>
public @interface DataSource <span class="token punctuation">{<!-- --></span>
	String value<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
     <li>
      使用动态数据源
      <pre><code class="prism language-bash">@Service
public class MyService <span class="token punctuation">{<!-- --></span>

	@DataSource<span class="token punctuation">(</span><span class="token string">"primary"</span><span class="token punctuation">)</span>
	public List<span class="token operator">&lt;</span>User<span class="token operator">&gt;</span> <span class="token function-name function">getUsers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token builtin class-name">return</span> primaryUserMapper.findAll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	@DataSource<span class="token punctuation">(</span><span class="token string">"secondary"</span><span class="token punctuation">)</span>
	public List<span class="token operator">&lt;</span>Product<span class="token operator">&gt;</span> <span class="token function-name function">getProducts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token builtin class-name">return</span> secondaryProductMapper.findAll<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
    </ol>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33333830373338302f:61727469636c652f64657461696c732f313435393233353436" class_="artid" style="display:none">
 </p>
</div>


