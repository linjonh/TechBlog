---
layout: post
title: "如何在Django中有效地使用Celery进行定时任务"
date: 2025-03-14 09:33:18 +0800
description: "Celery是一个异步任务队列/作业队列，主要用于处理异步任务。也就是说，当你有一些需要花费较长时间的任务时，可以把它们放到Celery处理，而不阻塞用户的请求。在Django中，Celery的使用能帮助我们更好地管理后台任务。使用Celery的另一个强大功能是可以定义定时任务。，它是Celery的调度器。安装完成后，在中添加它到...现在，我们可以通过Django Admin界面来管理我们的定时任务了！在Admin界面中，你会看到一个名为“Periodic tasks”的选项。"
keywords: "如何在Django中有效地使用Celery进行定时任务？"
categories: ['技术分享']
tags: ['Sqlite', 'Python', 'Django']
artid: "146249373"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146249373
    alt: "如何在Django中有效地使用Celery进行定时任务"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146249373
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146249373
cover: https://bing.ee123.net/img/rand?artid=146249373
image: https://bing.ee123.net/img/rand?artid=146249373
img: https://bing.ee123.net/img/rand?artid=146249373
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     如何在Django中有效地使用Celery进行定时任务？
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-dracula" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     当我们谈到Web开发时，Django无疑是一个非常流行的框架。而Celery则是与Django配合使用的强大任务队列工具。今天，我们来聊聊如何在Django中使用Celery来实现定时任务。定时任务在很多场景下都非常有用，比如定期发送邮件、清理数据库、执行数据备份等等。下面就带你走进这个话题！
    </p>
    <h3>
     <a id="Celery_4">
     </a>
     什么是Celery？
    </h3>
    <p>
     Celery是一个异步任务队列/作业队列，主要用于处理异步任务。也就是说，当你有一些需要花费较长时间的任务时，可以把它们放到Celery处理，而不阻塞用户的请求。在Django中，Celery的使用能帮助我们更好地管理后台任务。
    </p>
    <h3>
     <a id="DjangoCelery_8">
     </a>
     如何在Django中集成Celery？
    </h3>
    <p>
     要在Django项目中使用Celery，首先需要安装Celery。你可以通过pip来安装它：
    </p>
    <pre><code class="prism language-bash">pip <span class="token function">install</span> celery
</code></pre>
    <p>
     安装完成后，需要在Django项目中进行配置。首先，在你的Django项目目录中创建一个名为
     <code>
      celery.py
     </code>
     的文件。这个文件通常放在与
     <code>
      settings.py
     </code>
     文件相同的目录下。
    </p>
    <p>
     接下来，打开
     <code>
      celery.py
     </code>
     ，并添加以下代码：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> celery <span class="token keyword">import</span> Celery

os<span class="token punctuation">.</span>environ<span class="token punctuation">.</span>setdefault<span class="token punctuation">(</span><span class="token string">'DJANGO_SETTINGS_MODULE'</span><span class="token punctuation">,</span> <span class="token string">'your_project_name.settings'</span><span class="token punctuation">)</span>

app <span class="token operator">=</span> Celery<span class="token punctuation">(</span><span class="token string">'your_project_name'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config_from_object<span class="token punctuation">(</span><span class="token string">'django.conf:settings'</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'CELERY'</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span>autodiscover_tasks<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     确保将
     <code>
      your_project_name
     </code>
     替换为你的实际项目名称。这段代码的意义在于，它会加载Django的设置，并自动发现任务。
    </p>
    <p>
     接着，在你的
     <code>
      settings.py
     </code>
     中添加以下配置：
    </p>
    <pre><code class="prism language-python">CELERY_BROKER_URL <span class="token operator">=</span> <span class="token string">'redis://localhost:6379/0'</span>  <span class="token comment"># 使用Redis作为消息代理</span>
CELERY_ACCEPT_CONTENT <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'json'</span><span class="token punctuation">]</span>
CELERY_TASK_SERIALIZER <span class="token operator">=</span> <span class="token string">'json'</span>
</code></pre>
    <p>
     这里我们使用Redis作为消息代理，当然，你也可以选择RabbitMQ等其他代理。
    </p>
    <h3>
     <a id="_43">
     </a>
     创建任务
    </h3>
    <p>
     有了基本的配置之后，我们可以开始创建任务了。首先，在你的应用程序目录中创建一个名为
     <code>
      tasks.py
     </code>
     的文件。在这个文件里，我们可以定义我们的任务。例如，下面是一个发送邮件的任务：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> celery <span class="token keyword">import</span> shared_task
<span class="token keyword">from</span> django<span class="token punctuation">.</span>core<span class="token punctuation">.</span>mail <span class="token keyword">import</span> send_mail

<span class="token decorator annotation punctuation">@shared_task</span>
<span class="token keyword">def</span> <span class="token function">send_email_task</span><span class="token punctuation">(</span>subject<span class="token punctuation">,</span> message<span class="token punctuation">,</span> recipient_list<span class="token punctuation">)</span><span class="token punctuation">:</span>
    send_mail<span class="token punctuation">(</span>subject<span class="token punctuation">,</span> message<span class="token punctuation">,</span> <span class="token string">'from@example.com'</span><span class="token punctuation">,</span> recipient_list<span class="token punctuation">)</span>
</code></pre>
    <p>
     这个任务使用了
     <code>
      @shared_task
     </code>
     装饰器，这样我们可以在其他文件中引用这个任务。
    </p>
    <h3>
     <a id="_58">
     </a>
     定义定时任务
    </h3>
    <p>
     使用Celery的另一个强大功能是可以定义定时任务。为了实现这一点，我们需要安装一个额外的库：
     <code>
      celery-beat
     </code>
     ，它是Celery的调度器。可以通过以下命令安装：
    </p>
    <pre><code class="prism language-bash">pip <span class="token function">install</span> django-celery-beat
</code></pre>
    <p>
     安装完成后，在
     <code>
      settings.py
     </code>
     中添加它到
     <code>
      INSTALLED_APPS
     </code>
     ：
    </p>
    <pre><code class="prism language-python">INSTALLED_APPS <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token string">'django_celery_beat'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre>
    <p>
     接下来，我们需要进行数据库迁移，以便创建必要的表：
    </p>
    <pre><code class="prism language-bash">python manage.py migrate django_celery_beat
</code></pre>
    <p>
     现在，我们可以通过Django Admin界面来管理我们的定时任务了！在Admin界面中，你会看到一个名为“Periodic tasks”的选项。在这里，你可以添加新的定时任务，比如设置一个任务每隔5分钟执行一次。
    </p>
    <p>
     如果你想用代码来添加定时任务，可以在项目的启动文件中添加以下代码：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> django_celery_beat<span class="token punctuation">.</span>models <span class="token keyword">import</span> PeriodicTask<span class="token punctuation">,</span> IntervalSchedule
<span class="token keyword">from</span> django<span class="token punctuation">.</span>utils <span class="token keyword">import</span> timezone

<span class="token comment"># 创建一个每5分钟执行一次的任务</span>
schedule<span class="token punctuation">,</span> created <span class="token operator">=</span> IntervalSchedule<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>get_or_create<span class="token punctuation">(</span>
    every<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">,</span>
    period<span class="token operator">=</span>IntervalSchedule<span class="token punctuation">.</span>MINUTES<span class="token punctuation">,</span>
<span class="token punctuation">)</span>

PeriodicTask<span class="token punctuation">.</span>objects<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
    interval<span class="token operator">=</span>schedule<span class="token punctuation">,</span>
    name<span class="token operator">=</span><span class="token string">'Send email every 5 minutes'</span><span class="token punctuation">,</span>
    task<span class="token operator">=</span><span class="token string">'your_app_name.tasks.send_email_task'</span><span class="token punctuation">,</span>
    args<span class="token operator">=</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'Hello'</span><span class="token punctuation">,</span> <span class="token string">'This is a test email'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">'to@example.com'</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
</code></pre>
    <p>
     这里的
     <code>
      args
     </code>
     字段是用JSON格式传递给任务的参数。
    </p>
    <h3>
     <a id="Celery_105">
     </a>
     启动Celery
    </h3>
    <p>
     一切就绪后，接下来是启动Celery。可以通过以下命令启动Celery工作进程：
    </p>
    <pre><code class="prism language-bash">celery <span class="token parameter variable">-A</span> your_project_name worker <span class="token parameter variable">--loglevel</span><span class="token operator">=</span>info
</code></pre>
    <p>
     同时还需要启动Celery Beat调度器：
    </p>
    <pre><code class="prism language-bash">celery <span class="token parameter variable">-A</span> your_project_name beat <span class="token parameter variable">--loglevel</span><span class="token operator">=</span>info
</code></pre>
    <p>
     这两个命令会在不同的终端中运行。Celery工作进程会处理任务，而Celery Beat会根据你设定的时间间隔来调度任务。
    </p>
    <h3>
     <a id="_121">
     </a>
     监控任务
    </h3>
    <p>
     在生产环境中，监控任务的状态也是很重要的。Celery提供了一些工具，比如Flower，这是一个可视化的Web界面，可以用来监控Celery任务。通过以下命令安装Flower：
    </p>
    <pre><code class="prism language-bash">pip <span class="token function">install</span> flower
</code></pre>
    <p>
     然后启动Flower：
    </p>
    <pre><code class="prism language-bash">celery <span class="token parameter variable">-A</span> your_project_name flower
</code></pre>
    <p>
     打开浏览器，访问
     <code>
      http://localhost:5555
     </code>
     ，你就可以看到任务的状态、执行历史等信息。
    </p>
    <h3>
     <a id="_137">
     </a>
     结论
    </h3>
    <p>
     使用Celery进行定时任务的管理是非常高效的，尤其是在Django项目中。通过简单的配置和代码，你可以实现复杂的任务调度，提升应用的性能和用户体验。无论是发送定期邮件，还是清理数据库，Celery都能帮助你轻松实现。
    </p>
    <p>
     希望这篇文章能帮助你更好地理解如何在Django中使用Celery进行定时任务！是不是觉得很简单呢？快去试试吧！
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f32343733343331312f:61727469636c652f64657461696c732f313436323439333733" class_="artid" style="display:none">
 </p>
</div>


