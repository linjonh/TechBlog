---
layout: post
title: "é«˜å¹¶å‘å†…å­˜æ± é‡Šæ”¾å†…å­˜-ç”³è¯·å’Œé‡Šæ”¾æ€»ç»“"
date: 2025-03-09 10:30:54 +08:00
description: "é‡Šæ”¾å†…å­˜ + ç”³è¯·å’Œé‡Šæ”¾æ€»ç»“"
keywords: "ã€é«˜å¹¶å‘å†…å­˜æ± ã€‘é‡Šæ”¾å†…å­˜ + ç”³è¯·å’Œé‡Šæ”¾æ€»ç»“"
categories: ['é«˜å¹¶å‘å†…å­˜æ± ']
tags: ['ç¼“å­˜', 'å¼€å‘è¯­è¨€', 'C']
artid: "145934568"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145934568
    alt: "é«˜å¹¶å‘å†…å­˜æ± é‡Šæ”¾å†…å­˜-ç”³è¯·å’Œé‡Šæ”¾æ€»ç»“"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145934568
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145934568
cover: https://bing.ee123.net/img/rand?artid=145934568
image: https://bing.ee123.net/img/rand?artid=145934568
img: https://bing.ee123.net/img/rand?artid=145934568
---

# ã€é«˜å¹¶å‘å†…å­˜æ± ã€‘é‡Šæ”¾å†…å­˜ + ç”³è¯·å’Œé‡Šæ”¾æ€»ç»“
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/blog_migrate/a7a0a92dc5bbb18299c7e7e9b2c1abe2.jpeg#pic_center)
> **ç‚¹èµ** ğŸ‘ğŸ‘**æ”¶è—** ğŸŒŸğŸŒŸ**å…³æ³¨** ğŸ’–ğŸ’–
> **ä½ çš„æ”¯æŒæ˜¯å¯¹æˆ‘æœ€å¤§çš„é¼“åŠ±ï¼Œæˆ‘ä»¬ä¸€èµ·åŠªåŠ›å§!ğŸ˜ƒğŸ˜ƒ**
## 1 é‡Šæ”¾å†…å­˜
### 1.1 thread cache
é‡Šæ”¾å†…å­˜ï¼š
1. å½“é‡Šæ”¾å†…å­˜å°äº256kæ—¶å°†å†…å­˜é‡Šæ”¾å›thread cacheï¼Œè®¡ç®—sizeæ˜ å°„è‡ªç”±é“¾è¡¨æ¡¶ä½ç½®iï¼Œå°†å¯¹è±¡Pushåˆ°_freelists[i]ã€‚
2. å½“é“¾è¡¨çš„é•¿åº¦è¿‡é•¿ï¼Œåˆ™å›æ”¶â¼€éƒ¨åˆ†å†…å­˜å¯¹è±¡åˆ°central cacheã€‚
//ConcurrentAlloc.h
static void ConcurrentFree(void* ptr,size_t size)
{
assert(pTLSThreadCache);
pTLSThreadCache->Deallocate(ptr, size);
}
ä»¥ä»€ä¹ˆæ ‡å‡†æ¥åˆ¤æ–­ThradCacheå½“å‰æŸä¸ªæ¡¶çš„è‡ªç”±é“¾è¡¨çš„é•¿åº¦è¿‡é•¿äº†å‘¢ï¼Ÿ
æˆ‘ä»¬åœ¨ç»™ThreadCacheçš„æ¡¶åŠ ä¸€ä¸ªSizeæˆå‘˜ï¼Œè®°å½•å½“å‰è¿™ä¸ªæ¡¶ç©ºé—²å†…å­˜å—çš„ä¸ªæ•°ã€‚å¦‚æœå½“å‰è¿™ä¸ªæ¡¶ç©ºé—²å†…å­˜å—çš„ä¸ªæ•°å¤§äºç­‰äºè¿™ä¸ªæ¡¶ä¸‹ä¸€æ¬¡æ‰¾CentralCacheè¦çš„ä¸€æ‰¹é‡çš„å†…å­˜å—ä¸ªæ•°ã€‚é‚£å°±æŠŠè¿™ä¸€æ‰¹é‡ä»å½“å‰æ¡¶æ‹¿åˆ°ç„¶åè¿˜ç»™CentralCacheã€‚
å…¶å®è¿˜å¯ä»¥ç»™ThreadCacheä¸€ä¸ªè®°å½•å®ƒå äº†å¤šå¤§å†…å­˜çš„æˆå‘˜ï¼Œå¦‚æœè¿™ä¸ªéå†å¤§äº2Mï¼Œå°±ä»ä¸Šåˆ°ä¸‹éå†æ¡¶è¿˜ä¸€éƒ¨åˆ†ç©ºé—²å†…å­˜å—å›å»ï¼Œé¿å…ä¸€ä¸ªThreadCacheå æ®å¤ªå¤šå†…å­˜ã€‚æˆ‘ä»¬è¿™ä¸ªé¡¹ç›®çš„åŸå‹è€ƒè™‘äº†æ›´å¤šè¿™é‡Œçš„ç»†èŠ‚ã€‚æˆ‘ä»¬å°±ç®€å•ä¸€ä¸‹ç”¨ä¸ªSizeè®°å½•å½“å‰æ¡¶ç©ºé—²å†…å­˜å—ä¸ªæ•°å°±è¡Œäº†ã€‚
//Common.h
static void*& NextObj(void* obj)
{
return *(void**)obj;
}
class Freelist
{
public:
//é‡Šæ”¾å†…å­˜
void Push(void* obj)
{
//å¤´æ’
assert(obj);
NextObj(obj) = _freelist;
_freelist = obj;
++_size;
}
//ç”³è¯·å†…å­˜
void* Pop()
{
//å¤´åˆ 
assert(_freelist);
void* obj = _freelist;
_freelist = NextObj(obj);
--_size;
return obj;
}
//ä¸€æ¬¡æŒ‚ä¸€æ‰¹
void PushRange(void* start,void* end,size_t n)
{
NextObj(end) = _freelist;
_freelist = start;
_size += n;
}
//ä¸€æ¬¡æ‹¿ä¸€æ‰¹
void PopRange(void*& start, void*& end, size_t n)
{
assert(_size >= n);
start = end = _freelist;
for (size_t i = 0; i < n - 1; ++i)
{
end = NextObj(end);
}
_freelist = NextObj(end);
NextObj(end) = nullptr;
_size -= n;
}
//é“¾è¡¨æ˜¯å¦ä¸ºç©º
bool IsEmpty()
{
return _freelist == nullptr;
}
//è·å–å½“å‰æ¡¶è·å–ä¸‹ä¸€æ‰¹å†…å­˜å—çš„ä¸ªæ•°
size_t& GetMaxSize()
{
return _maxSize;
}
//å½“å‰æ¡¶çš„ç©ºé—²å†…å­˜å—çš„ä¸ªæ•°
size_t GetSize()
{
return _size;
}
private:
void* _freelist = nullptr;
size_t _maxSize = 1;//è®°å½•å½“å‰æ¡¶ä¸‹ä¸€æ¬¡æ‰¾ContraltCacheä¸€æ¬¡è¦ä¸€æ‰¹é‡æ˜¯å¤šå°‘ä¸ªå†…å­˜å¯¹è±¡
size_t _size = 0;//å½“å‰æ¡¶ç©ºé—²å†…å­˜å—ä¸ªæ•°
};
//ThreadCache.h
class ThreadCache
{
public:
//ç”³è¯·å’Œé‡Šæ”¾å†…å­˜å¯¹è±¡
void* Allocate(size_t size);
void Deallocate(void* ptr, size_t size);
// ä»ä¸­å¿ƒç¼“å­˜è·å–å¯¹è±¡
void* FetchFromCentralCache(size_t index, size_t size);
// é‡Šæ”¾å¯¹è±¡æ—¶ï¼Œé“¾è¡¨è¿‡é•¿æ—¶ï¼Œå›æ”¶å†…å­˜å›åˆ°ä¸­å¿ƒç¼“å­˜
void ListTooLong(Freelist& list, size_t size);
private:
Freelist _freelists[NFREELIST];
};
// TLS thread local storage çº¿ç¨‹å±€éƒ¨å­˜å‚¨
static _declspec(thread) ThreadCache* pTLSThreadCache = nullptr;
//ThreadCache.hpp
void ThreadCache::Deallocate(void* ptr, size_t size)
{
assert(ptr);
assert(size <= MAX_BYTES);
size_t index = SizeClass::Index(size);
_freelists[index].Push(ptr);
//å½“å‰æ¡¶ç©ºé—²å†…å­˜å—ä¸ªæ•°å¤§äºç­‰äºä¸‹ä¸€æ¬¡ç”³è¯·ä¸€æ‰¹é‡å†…å­˜å—ä¸ªæ•°
//å°±è¿˜ä¸‹ä¸€æ‰¹é‡å†…å­˜å—çš„ä¸ªæ•°ç»™CentralCache
if (_freelists[index].GetSize() >= _freelists[index].GetMaxSize())
{
//ä»å½“å‰æ¡¶è·å–ä¸€æ‰¹é‡å†…å­˜å—
ListTooLong(_freelists[index], size);
}
}
void ThreadCache::ListTooLong(Freelist& list, size_t size)
{
void* start = nullptr;
void* end = nullptr;
//è·å–ä¸€æ‰¹é‡å†…å­˜å—å¯¹è±¡
list.PopRange(start, end, list.GetMaxSize());
//å°†è¿™ä¸€æ‰¹å†…å­˜å—å¯¹è±¡è¿˜ç»™CentralCacheå¯¹åº”æ¡¶ä¸‹çš„å¯¹åº”Spanå¯¹è±¡
CentralCache::GetInstance()->ReleaseListToSpans(start, size);
}
### 1.2 central cache
é‡Šæ”¾å†…å­˜ï¼š
1. å½“thread_cacheè¿‡é•¿æˆ–è€…çº¿ç¨‹é”€æ¯ï¼Œåˆ™ä¼šå°†å†…å­˜é‡Šæ”¾å›central cacheä¸­çš„ï¼Œé‡Šæ”¾å›æ¥æ—¶ --use_countã€‚å½“use_countå‡åˆ°0æ—¶åˆ™è¡¨ç¤ºæ‰€æœ‰å¯¹è±¡éƒ½å›åˆ°äº†spanï¼Œåˆ™å°†spané‡Šæ”¾å›page cacheï¼Œpage cacheä¸­ä¼šå¯¹å‰åç›¸é‚»çš„ç©ºé—²é¡µè¿›è¡Œåˆå¹¶ã€‚
//CentralCache.h
//æ‰€æœ‰çº¿ç¨‹å…±äº«,æ•´ä¸ªè¿›ç¨‹ä»…æœ‰ä¸€ä¸ª,æ‰€æœ‰å¼„æˆå•ä¾‹æ¨¡ä¸Š:é¥¿æ±‰(é™æ€å¯¹è±¡)
class CentralCache
{
public:
//è·å–å•ä¾‹å¯¹è±¡
static CentralCache* GetInstance()
{
return &_sInst;
}
// è·å–ä¸€ä¸ªéç©ºçš„span
Span* GetOneSpan(Spanlist& list, size_t size);
// ä»ä¸­å¿ƒç¼“å­˜è·å–ä¸€å®šæ•°é‡çš„å†…å­˜å—å¯¹è±¡ç»™thread cache
size_t FetchRangeObj(void*& start, void*& end, size_t batchNum, size_t size);
// å°†ä¸€å®šæ•°é‡çš„å†…å­˜å—å¯¹è±¡é‡Šæ”¾åˆ°å¯¹åº”æ¡¶ä¸‹çš„å¯¹åº”spanå¯¹è±¡ä¸­
void ReleaseListToSpans(void* start, size_t size);
private:
CentralCache()
{}
CentralCache(const CentralCache&) = delete;
CentralCache& operator=(const CentralCache&) = delete;
private:
Spanlist _spanlists[NFREELIST];
static CentralCache _sInst;
};
è€ƒè™‘è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼ŒThreadCacheè¿˜å›æ¥çš„å†…å­˜å—è¿˜åˆ°CentralCacheå¯¹åº”æ¡¶ä¸­ï¼Œä½†æ˜¯å¯¹åº”æ¡¶å¯èƒ½æœ‰å¤šä¸ªSpanå¯¹è±¡ï¼Œé‚£è¿™äº›è¿˜å›æ¥çš„å†…å­˜å—å¯¹è±¡æ˜¯å±äºé‚£ä¸ªSpanå‘¢ï¼Ÿ
æ¯”å¦‚è¯´ç›®å‰æœ‰ä¸¤ä¸ªSpanå¯¹è±¡ï¼Œåˆ†åˆ«ç®¡ç†ä¸€é¡µï¼Œ2000æ˜¯Span1ç®¡ç†ï¼Œ2001æ˜¯Span2ç®¡ç†ã€‚ä¸‹é¢æœ‰å››ä¸ªå†…å­˜å—è¿˜å›æ¥äº†ï¼Ÿå‡è®¾1ã€2å†…å­˜å—æ˜¯ä»Span1æ‹¿çš„ï¼Œ3ã€4æ˜¯ä»Span2æ‹¿çš„ã€‚é‚£æ€ä¹ˆç¡®å®šå¯¹åº”å†…å­˜å—æ˜¯ä»é‚£ä¸ªSpanä¸­æ‹¿çš„å‘¢ï¼Ÿ
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/37445ea6cadf4ec3a7de23117ce3f65a.png)
ä»¥1ã€2å†…å­˜å—ä»Span1æ‹¿çš„ä¸ºä¾‹ï¼Œæ—¢ç„¶æ˜¯ä»Span1ç®¡ç†2000è¿™ä¸€é¡µæ‹¿ï¼Œè¿™ä¸€é¡µæ˜¯åˆ’åˆ†ä¸ºå›ºå®šå¤§å°çš„å°å†…å­˜å—ä½ æ‰æ‹¿çš„ã€‚é‚£1ã€2è¿™ä¸ªå†…å­˜å—çš„åœ°å€æ˜¯ä¸æ˜¯å°±åœ¨FA000å’ŒFA2000ä¹‹é—´çš„ï¼Œæ‹¿å®ƒä»¬çš„åœ°å€/8KBç®—å‡ºçš„æ•´æ•°è¿˜æ˜¯2000ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/ada2f22fa0364a398f12db2d0acf0018.png)
å› æ­¤æˆ‘ä»¬å¯ä»¥ç”¨**unordered_mapæˆ–è€…mapå»ºç«‹ä¸€ä¸ªé¡µå·ä¸Spanä¸€å¯¹ä¸€çš„æ˜ å°„å…³ç³»** ã€‚æ‹¿åˆ°å†…å­˜å—çš„åœ°å€/8KB
çœ‹å®ƒæ˜¯é‚£ä¸€é¡µçš„ï¼Œç„¶åæ ¹æ®é¡µå·å°±å¯ä»¥çŸ¥é“å®ƒæ˜¯é‚£ä¸ªSpanäº†ã€‚
è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨unordered_mapæŸ¥æ‰¾æ›´å¿«ä¸€äº›ï¼Œè¿™ä¸ªå“ˆå¸Œæ¡¶ç­‰ä¼šPageCacheä¹Ÿè¦ç”¨ï¼Œå› æ­¤æ”¾åœ¨PageCacheé‡Œã€‚
//PageCache.h
#include"Common.h"
//æ‰€æœ‰çº¿ç¨‹å…±äº«ä¸€ä¸ªPageCache
class PageCache
{
public:
static PageCache* GetInstance()
{
return &_sInst;
}
//ä»PageCacheç¬¬kå·æ¡¶ä¸­è·å–ä¸€ä¸ªspanå¯¹è±¡
Span* NewSpan(size_t k);
// è·å–ä»å¯¹è±¡åˆ°spançš„æ˜ å°„
Span* MapObjectToSpan(void* obj);
// é‡Šæ”¾ç©ºé—²spanå›åˆ°Pagecacheï¼Œå¹¶åˆå¹¶ç›¸é‚»çš„span
void ReleaseSpanToPageCache(Span* span);
private:
PageCache()
{}
PageCache(const PageCache&) = delete;
PageCache& operator=(const PageCache&) = delete;
static PageCache _sInst;
private:
Spanlist _spanlists[NPAGES];
std::unordered_map _idSpanMap;//è®°å½•é¡µå·å’Œspanä¸€ä¸€å¯¹åº”å…³ç³»
public:
std::mutex _pageMtx; //æ•´ä¸ªé”
};
ç„¶ååœ¨å¤„ç†ä¸€ä¸‹ï¼Œå½“CentralCacheä»PageCacheæ‹¿åˆ°ä¸€ä¸ªSpanï¼Œè¿”å›ä¹‹å‰ï¼Œæˆ‘ä»¬è¦æŠŠè¿™ä¸ªSpanç®¡ç†çš„é¡µå·ä¸Spanå»ºç«‹å…³ç³»ã€‚
//ä»PageCacheç¬¬kå·æ¡¶ä¸­è·å–ä¸€ä¸ªspanå¯¹è±¡
Span* PageCache::NewSpan(size_t k)
{
assert(k > 0 && k < NPAGES);
//è¿™é‡ŒåŠ é”é€’å½’ä¼šæœ‰æ­»é”é—®é¢˜ï¼Œé™¤éç”¨é€’å½’äº’æ–¥é”ï¼Œè¿˜æœ‰åœ¨å¤–é¢è°ƒç”¨è¿™ä¸ªå‡½æ•°ä¹‹å‰åŠ é”
// å…ˆæ£€æŸ¥ç¬¬kä¸ªæ¡¶é‡Œé¢æœ‰æ²¡æœ‰span
if (!_spanlists[k].Empty())
{
Span* Kspan = _spanlists[k].PopFront();
//å°†Kspanç»™CentralCacheä¹‹å‰,å…ˆå°†é¡µå·å’Œspanå¯¹åº”å…³ç³»è®°å½•
for (size_t i = 0; i < Kspan->_n; ++i)
{
_idSpanMap[Kspan->_pageid + i] = Kspan;
}
//å°†ç®¡ç†ké¡µçš„spanç»™Central Cache
return Kspan;
}
//èµ°åˆ°è¿™é‡Œç¬¬kä¸ªæ¡¶æ²¡æœ‰spanï¼Œé‚£å°±ç»§ç»­å¾€ä¸‹é¢çš„æ¡¶æ‰¾
for (size_t i = k + 1; i < NPAGES; ++i)
{
if (!_spanlists[i].Empty())
{
//å°†ä¸€ä¸ªç®¡ç†æ›´å¤šé¡µçš„spanï¼Œå˜æˆä¸¤ä¸ªspanï¼Œä¸€ä¸ªç®¡ç†ké¡µï¼Œä¸€ä¸ªç®¡ç†i-ké¡µ
Span* Ispan = _spanlists[i].PopFront();
//Span* Kspan = new Span;
Span* Kspan = _spanPool.New();
Kspan->_pageid = Ispan->_pageid;
Kspan->_n = k;
Ispan->_pageid += k;
Ispan->_n -= k;
//å°†IspanæŒ‚åœ¨å¯¹åº”å¤§å°çš„æ¡¶
_spanlists[Ispan->_n].PushFront(Ispan);
//å°†Kspanç»™CentralCacheä¹‹å‰,å…ˆå°†é¡µå·å’Œspanå¯¹åº”å…³ç³»è®°å½•
for (size_t i = 0; i < Kspan->_n; ++i)
{
_idSpanMap[Kspan->_pageid + i] = Kspan;
}
//å°†ç®¡ç†ké¡µçš„spanç»™Central Cache
return Kspan;
}
}
//èµ°åˆ°è¿™é‡Œè¯´æ˜ï¼Œåé¢çš„ä½ç½®éƒ½æ²¡æœ‰å¤§é¡µçš„span
//é‚£å°±å»æ‰¾å †ç”³è¯·ä¸€ä¸ª128pageçš„span
Span* bigSpan = new Span;
void* ptr = SystemAlloc(NPAGES - 1);
bigSpan->_pageid = (PAGE_ID)ptr >> PAGE_SHIFT;
bigSpan->_n = NPAGES - 1;
//spanæŒ‚åœ¨å¯¹åº”æ¡¶ä¸‹
_spanlists[bigSpan->_n].PushFront(bigSpan);
//é‡å¤ä¸Šè¿°è¿‡ç¨‹å¯»æ‰¾kå·æ¡¶çš„spanï¼Œä¸€å®šè¿˜å›ä¸€ä¸ªspan
return NewSpan(k);
}
åœ¨å¢åŠ ä¸€ä¸ªåœ°å€è½¬æˆé¡µå·æ‰¾åˆ°å¯¹åº”Spançš„å‡½æ•°
// è·å–ä»å¯¹è±¡åˆ°spançš„æ˜ å°„
Span* PageCache::MapObjectToSpan(void* obj)
{
PAGE_ID id = ((PAGE_ID)obj >> PAGE_SHIFT);
auto ret = _idSpanMap.find(id);
if (ret != _idSpanMap.end())
{
return ret->second;
}
else
{
assert(false);
return nullptr;
}
}
æ¥ä¸‹æ¥CentralCacheå°±å¯ä»¥æŠŠä¸€æ‰¹å†…å­˜å—è¿˜ç»™PageCacheäº†ã€‚è¿™é‡Œä¹Ÿéœ€è¦è®°ä½åœ¨å–PageCacheä¹‹å‰å…ˆæŠŠå¯¹åº”æ¡¶é”è§£æ‰ã€‚ä¸å¦‚åˆ«çš„çº¿ç¨‹æ¥å¯¹åº”æ¡¶ä¸Šç”³è¯·é‡Šæ”¾å°±é˜»å¡äº†ã€‚
// å°†ä¸€å®šæ•°é‡çš„å†…å­˜å—å¯¹è±¡é‡Šæ”¾åˆ°å¯¹åº”æ¡¶ä¸‹çš„å¯¹åº”spanå¯¹è±¡ä¸­
void CentralCache::ReleaseListToSpans(void* start, size_t size)
{
size_t index = SizeClass::Index(size);
_spanlists[index]._mtx.lock();
//éå†å°†å†…å­˜å—å¯¹è±¡è¿˜ç»™å¯¹åº”çš„span
//å¦‚ä½•çŸ¥é“ä¸€ä¸ªå†…å­˜å—å¯¹è±¡æ˜¯ä»é‚£ä¸ªspanå¯¹è±¡ä¸­æ‹¿èµ°çš„?
//ç”¨å†…å­˜å—ä¸­çš„åœ°å€/8kb,å¾—åˆ°å¯¹åº”çš„é¡µå·,æ ¹æ®é¡µå·èµ°åˆ°å¯¹åº”çš„span
//å¦‚ä½•æ ¹æ®é¡µå·æ‰¾åˆ°å¯¹åº”span,ç”¨unordered_mapè®°å½•é¡µå·å’Œspanä¸€ä¸€å¯¹åº”å…³ç³»
//å› ä¸ºPageCacheç­‰ä¼šä¹Ÿè¦ç”¨åˆ°è¿™ä¸ªå“ˆå¸Œæ¡¶,å› ä¸ºå“ˆå¸Œæ¡¶å®šä¹‰åˆ°PageCacheä¸­
while (start)
{
void* next = NextObj(start);
Span* span = PageCache::GetInstance()->MapObjectToSpan(start);
//å°†startå¤´æ’è¿›å¯¹åº”spanä¸­
NextObj(start) = span->_freelist;
span->_freelist = start;
span->_usecount--;
//æ£€æŸ¥å½“å‰spanä¸­åˆ‡åˆ†çš„å†…å­˜å—ä¸ªæ•°æ˜¯å¦å·²ç»è¢«è¿˜å®Œäº†
//å¦‚æœè¿˜å®Œ,å°±å°†è¯¥spanä»CentralCacheä¸­åˆ é™¤,ç„¶åè¿˜ç»™PageCache
//PageCacheçœ‹æ˜¯å¦èƒ½å°†è¯¥spanå‰åç©ºé—²spanåˆå¹¶,å‡å°‘å†…å­˜ç¢ç‰‡
if (span->_usecount == 0)
{
//å°†è¯¥spanä»æ¡¶ä¸­åˆ é™¤
_spanlists[index].Erase(span);
span->_freelist = nullptr;
span->_prev = nullptr;
span->_next = nullptr;
//ä»CentarlCacheå»PageCacheä¹‹å‰å…ˆæŠŠæ¡¶é”é‡Šæ”¾
//å¦‚æœä¸é‡Šæ”¾,ä¸‡ä¸€å…¶ä»–çº¿ç¨‹æ¥è¿™ä¸ªæ¡¶æ‰¾spanç”³è¯·æˆ–è€…é‡Šæ”¾å†…å­˜å—,å°±é˜»å¡ä½
_spanlists[index]._mtx.unlock();
//æ‰€æœ‰çº¿ç¨‹å…±äº«PageCache,æ‰€ä»¥å…ˆåŠ é”
PageCache::GetInstance()->_pageMtx.lock();
PageCache::GetInstance()->ReleaseSpanToPageCache(span);
PageCache::GetInstance()->_pageMtx.unlock();
//å›æ¥å†æŠŠå¯¹åº”æ¡¶é”åŠ ä¸Š
_spanlists[index]._mtx.lock();
}
start = next;
}
_spanlists[index]._mtx.unlock();
}
### 1.3 page cache
é‡Šæ”¾å†…å­˜ï¼š
1. å¦‚æœcentral cacheé‡Šæ”¾å›ä¸€ä¸ªspanï¼Œåˆ™ä¾æ¬¡å¯»æ‰¾spançš„å‰åpage idçš„æ²¡æœ‰åœ¨ä½¿ç”¨çš„ç©ºé—²spanï¼Œçœ‹æ˜¯å¦å¯ä»¥åˆå¹¶ï¼Œå¦‚æœåˆå¹¶ç»§ç»­å‘å‰å¯»æ‰¾ã€‚è¿™æ ·å°±å¯ä»¥å°†åˆ‡å°çš„å†…å­˜åˆå¹¶æ”¶ç¼©æˆå¤§çš„spanï¼Œå‡å°‘å†…å­˜ç¢ç‰‡ã€‚
å‡è®¾Spanç®¡ç†çš„é¡µæ˜¯èµ·å§‹é¡µæ˜¯2000ï¼Œä¸€å…±ç®¡ç†5é¡µï¼Œå’Œå®ƒç›¸é‚»çš„å‰åSpanå¦‚ä½•æ‰¾åˆ°ï¼Ÿ
å’Œå®ƒçš„å‰ä¸€ä¸ªç›¸é‚»çš„Spanæœ€åä¸€é¡µå°±æ˜¯1999ï¼Œåä¸€ä¸ªç›¸é‚»çš„Spançš„é¦–å…ˆå°±æ˜¯2005ã€‚æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥é€šè¿‡æ‰¾åˆ°é¡µå·å°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„Spanã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/b3aea167f04a42aca2f91fe0898fb1fc.png)
åˆå¹¶ç›¸é‚»çš„é¡µï¼Œé€šè¿‡é¡µå·æ‰¾åˆ°ç›¸é‚»çš„é¡µçœ‹æ˜¯å¦èƒ½åˆå¹¶ï¼Œå¦‚æœè¯¥é¡µçš„Spanåœ¨PageCacheè¯´æ˜è¯¥Spanè¿˜æ²¡è¢«ä½¿ç”¨å¯ä»¥åˆå¹¶ã€‚å¦‚æœåœ¨CentralCacheè¯´æ˜è¯¥Spanæ­£åœ¨è¢«ä½¿ç”¨ä¸èƒ½åˆå¹¶ã€‚
é‚£å¦‚ä½•ç¡®å®šä¸€ä¸ªSpanæ˜¯å¦åœ¨è¢«ä½¿ç”¨å‘¢ï¼Ÿèƒ½ä¸èƒ½ç”¨Spanä¸­çš„_usecount==0æ¥åˆ¤æ–­ï¼Ÿ
ä¸èƒ½ï¼å› ä¸ºæœ‰æ—¶é—´é—´éš”ã€‚å¦‚æœçº¿ç¨‹thread1æ‰¾PageCacheæ‹¿åˆ°ä¸€ä¸ªSpanï¼Œè®°ä½_usecountåˆå§‹å¯æ˜¯0ï¼Œç„¶ååˆ‡åˆ†æˆä¸€å—å—å°å†…å­˜å—ï¼Œåœ¨æŒ‚åˆ°CentralCacheå¯¹åº”æ¡¶ä¸­ï¼Œç„¶åæ­£å‡†å¤‡ä»è¿™ä¸ªSpanæ‹¿ä¸€æ‰¹å†…å­˜å—ï¼Œè¿™ä¸ªæ—¶å€™_usecountå¯è¿˜æ˜¯0ï¼Œåªæœ‰çœŸæ­£æ‹¿åˆ°äº†æ‰ä¼š++ã€‚å¦ä¸€ä¸ªçº¿ç¨‹thread2åœ¨PageCacheåˆå¹¶ç›¸é‚»çš„ç©ºé—²çš„Spanï¼Œå¦‚æœç›¸é‚»çš„å°±æ˜¯thread1æ­£å‡†å¤‡æ‹¿çš„Spanï¼Œä½ ç”¨_usecount==0åˆ¤æ–­æ˜¯å¦è¢«ä½¿ç”¨ï¼Œé‚£ä¸å°±é€ æˆçº¿ç¨‹å®‰å…¨çš„é—®é¢˜äº†å—ï¼ï¼
æ‰€ä»¥ä¸èƒ½ç”¨Spanä¸­çš„_usecount==0åˆ¤æ–­ä¸€ä¸ªSpanæ˜¯å¦åœ¨ä½¿ç”¨ã€‚æˆ‘ä»¬å†ç»™SpanåŠ ä¸€ä¸ª_isuseæˆå‘˜æ¥åˆ¤æ–­Spanæ˜¯å¦åœ¨ä½¿ç”¨ï¼Œæ‹¿åˆ°CentralCacheçš„Spanå°±åœ¨ä½¿ç”¨ï¼Œåœ¨PageCacheçš„Spanå°±æ²¡æœ‰åœ¨ä½¿ç”¨ã€‚
//Spanç®¡ç†ä¸€ä¸ªè·¨åº¦çš„å¤§å—å†…å­˜
//ç®¡ç†ä»¥é¡µä¸ºå•ä½çš„å¤§å¿«å†…å­˜
struct Span
{
PAGE_ID _pageid = 0;//ç®¡ç†ä¸€å¤§å—è¿ç»­å†…å­˜å—çš„èµ·å§‹é¡µçš„é¡µå·
size_t _n = 0;//ç®¡ç†å‡ é¡µ
Span* _prev = nullptr;//å¸¦å¤´åŒå‘å¾ªç¯é“¾è¡¨å‰æŒ‡é’ˆ
Span* _next = nullptr;//å¸¦å¤´åŒå‘å¾ªç¯é“¾è¡¨åæŒ‡é’ˆ
size_t _usecount = 0;//è®°å½•Spanå¯¹è±¡ä¸­è‡ªç”±é“¾è¡¨æŒ‚çš„å†…å­˜å—å¯¹è±¡ä½¿ç”¨æ•°é‡
void* _freelist = nullptr;//è‡ªç”±é“¾è¡¨æŒ‚çš„æ˜¯Spanå¯¹è±¡ä¸€å—å¤§è¿ç»­å†…å­˜å—æŒ‰ç…§æ¡¶ä½ç½®å¤§å°åˆ‡åˆ†çš„ä¸€å—å—å°çš„å†…å­˜å—
bool _isuse = false;//å½“å‰Spanæ˜¯å¦è¢«ä½¿ç”¨
};
å½“CentralPageä»PageCacheè·å–åˆ°ä¸€ä¸ªæ–°çš„Spanå°±å·²ç»è¢«ç”¨äº†ï¼Œå¢åŠ ä¸€å¥ä»£ç ã€‚
// è·å–ä¸€ä¸ªéç©ºçš„span
Span* CentralCache::GetOneSpan(Spanlist& list, size_t size)
{
//éå†å¯¹åº”æ¡¶ä¸­æ˜¯å¦æœ‰spanæˆ–è€…spanä¸­æ˜¯å¦æœ‰å†…å­˜å¯¹è±¡
Span* it = list.Begin();
while (it != list.End())
{
if (it->_freelist)
{
return it;
}
else
{
it = it->_next;
}
}
//å½“Central Cacheå¯¹åº”æ¡¶ä¸‹é¢æ²¡æœ‰spanï¼Œé‚£å°±å¾€ä¸‹ä¸€å±‚Page Cacheæ‰¾ï¼Œä½†æ˜¯é¦–å…ˆè¦å…ˆæŠŠå¯¹åº”æ¡¶é”é‡Šæ”¾
//å¦‚æœå†æ¥ä¸€ä¸ªçº¿ç¨‹æ˜¯ç”³è¯·å†…å­˜ä½†æ˜¯æ²¡æœ‰å†…å­˜é”ä½ä¹Ÿæ²¡é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœè¿™ä¸ªçº¿ç¨‹æ˜¯æ¥è¿˜å†…å­˜çš„å‘¢ï¼Ÿ
//é”ä½é‚£ä¸å°±è¿˜ä¸äº†äº†ï¼Œå› æ­¤å¾€ä¸‹èµ°ä¹‹å‰å…ˆæŠŠæ¡¶é”é‡Šæ”¾
list._mtx.unlock();
//èµ°åˆ°è¿™é‡Œè¯´æ˜è¯¥æ¡¶ä¸­å¹¶æ²¡æœ‰spanæˆ–è€…spanä¸­æ²¡æœ‰å†…å­˜å¯¹è±¡,Central Cacheé‚£å°±æ‰¾åˆ°ä¸‹ä¸€å±‚Page Cacheè¦ä¸€ä¸ªspan
//Page Cache æ˜¯ä¸€ä¸ªæŒ‰æ¡¶ä¸‹æ ‡æ˜ å°„çš„å“ˆå¸Œæ¡¶ï¼Œç¬¬iå·æ¡¶è¡¨ç¤ºè¿™ä¸ªæ¡¶ä¸‹é¢çš„spanç®¡ç†çš„éƒ½æ˜¯ié¡µpage
//centralæ‰¾pageè¦ï¼Œå…³æ³¨çš„æ˜¯è¦çš„spanæ˜¯ç®¡ç†ké¡µçš„spanï¼Œç„¶åå°±å»kå·æ¡¶å»è¦
//PageCacheçš„é”æ˜¯ä¸€æŠŠæ•´é”ï¼Œè™½ç„¶ä¹Ÿå¯ä»¥æ˜¯æ¡¶é”ä½†æ˜¯æ¶ˆè€—æ€§èƒ½
//å½“PageCacheå¯¹åº”æ¡¶æ²¡æœ‰spanå°±å¾€ä¸‹é¢æ¡¶ç»§ç»­æ‰¾ï¼Œå°±æ¶‰åŠå¤šä¸ªæ¡¶åŠ é”è§£é”ï¼Œ
//å› æ­¤æˆ‘ä»¬åœ¨æœ€å¤–é¢ç›´æ¥æŠŠPageCacheé”ä½ï¼ŒåªåŠ é”è§£é”ä¸€æ¬¡å³å¯
PageCache::GetInstance()->_pageMtx.lock();
Span* span = PageCache::GetInstance()->NewSpan(SizeClass::NumMovePage(size));
//åœ¨CentralCacheä¸­çš„spanæ˜¯å·²ç»è¢«ä½¿ç”¨çš„span
span->_isuse = true;//spanè¢«ä½¿ç”¨
PageCache::GetInstance()->_pageMtx.unlock();
//ä»PageCacheæ‹¿ä¸Šæ¥çš„spanæ˜¯æ¯ä¸€ä¸ªçº¿ç¨‹ç‹¬äº«çš„ï¼Œå› æ­¤åˆ‡ç‰‡æ—¶ä¸éœ€è¦åŠ é”
//æŠŠä»PageCacheæ‹¿å›çš„spanåˆ‡åˆ†æˆsizeå¤§å°çš„ä¸€ä¸ªä¸ªå†…å­˜å—æŒ‚åœ¨è‡ªç”±é“¾è¡¨ï¼Œæœ€åå†æŠŠspanæŒ‚åœ¨å¯¹åº”çš„æ¡¶ä¸­
//æ ¹æ®é¡µå·æ‰¾åˆ°spanç®¡ç†çš„ä¸€å¤§å—å†…å­˜çš„èµ·å§‹åœ°å€
//åœ°å€ç”¨char* æ–¹ä¾¿ä¸‹é¢åœ°å€++
char* start = (char*)(span->_pageid << PAGE_SHIFT);
//è®¡ç®—è¿™å—å†…å­˜æœ‰å¤šå¤§
size_t bytes = span->_n << PAGE_SHIFT;
//ç»“å°¾åœ°å€
char* end = start + bytes;
//ä½¿ç”¨å°¾æ’æ³•å°†å¤§å†…å­˜å˜æˆå¤§å°ä¸ºsizeçš„ä¸€å¿«å¿«å°å†…å­˜æŒ‚åœ¨è‡ªç”±é“¾è¡¨ä¸Š
span->_freelist = start;
start += size;
void* tail = span->_freelist;
while (start < end)
{
NextObj(tail) = start;
tail = start;
start += size;
}
//è‡ªç”±é“¾è¡¨æœ€åä¸ºnullptr
NextObj(tail) = nullptr;
//åˆ‡å¥½spanä»¥åï¼Œéœ€è¦æŠŠspanæŒ‚åˆ°æ¡¶é‡Œé¢å»çš„æ—¶å€™ï¼Œå†åŠ é”
list._mtx.lock();
//å†æŠŠspanæŒ‚åœ¨å¯¹åº”æ¡¶
list.PushFront(span);
return span;
}
ç°åœ¨å…ˆåˆ«æ€¥ç€å°±å»unordered_mapå»æ‰¾åœ¨PageCacheä¸­ç›¸é‚»çš„Spanï¼Œä½ ç°åœ¨è‚¯å®šä¹Ÿæ‰¾ä¸åˆ°ï¼Œè¿˜è®°å¾—unordered_mapç›®å‰è®°å½•çš„æ˜¯ä»€ä¹ˆå—ï¼Ÿå®ƒå½“å‰åªè®°å½•äº†åœ¨CentralCacheä¸­çš„Spanç®¡ç†çš„é¡µå·ä¸Spançš„å¯¹åº”å…³ç³»ï¼Œä¹Ÿå°±æ˜¯å·²ç»ä½¿ç”¨çš„Spançš„é¡µå·å’ŒSpançš„å…³ç³»ï¼Œæ ¹æœ¬å°±æ²¡æœ‰è®°å½•åœ¨PageCacheä¸­Spanç®¡ç†çš„é¡µå·SPanå¯¹åº”çš„å…³ç³»ã€‚å› æ­¤è¿˜è¦åœ¨ä¿®æ”¹ä¸€ä¸‹ä»£ç ã€‚
**åœ¨PageCacheçš„Spanï¼Œåªéœ€è¦è®°å½•å®ƒç®¡ç†çš„é¦–é¡µå’Œå°¾é¡µä¸Spançš„æ˜ å°„å…³ç³»å°±è¡Œäº†**
ã€‚åˆå¹¶æˆ‘ä»¬å°±æ‰¾ç›¸é‚»Spançš„é¦–é¡µå’Œå°¾é¡µå°±æ‰¾åˆ°å¯¹åº”çš„Spanäº†ã€‚å¯¹äºåœ¨CentralCacheä¸­Spanå› ä¸ºè¦è¢«åˆ‡åˆ†æˆä¸€å—å—å°å†…å­˜ç„¶åæ‰ç»™ThreadCacheç”¨ï¼Œå½“å°å†…å­˜å—å›æ¥çš„æ—¶å€™ï¼Œå¯èƒ½æ˜¯è¿™ä¸ªSpanä¸­ä»»æ„ä¸€é¡µçš„å°å†…å—ï¼Œç„¶å/8KBï¼Œæ‰¾åˆ°é¡µå·ï¼Œåœ¨æ‰¾åˆ°å¯¹åº”çš„SPanã€‚å› æ­¤è¦æŠŠSpanä¸­æ¯ä¸€é¡µå’ŒSpanå¯¹åº”å…³ç³»éƒ½ä¿å­˜ã€‚
//ä»PageCacheç¬¬kå·æ¡¶ä¸­è·å–ä¸€ä¸ªspanå¯¹è±¡
Span* PageCache::NewSpan(size_t k)
{
assert(k > 0 && k < NPAGES);
//è¿™é‡ŒåŠ é”é€’å½’ä¼šæœ‰æ­»é”é—®é¢˜ï¼Œé™¤éç”¨é€’å½’äº’æ–¥é”ï¼Œè¿˜æœ‰åœ¨å¤–é¢è°ƒç”¨è¿™ä¸ªå‡½æ•°ä¹‹å‰åŠ é”
// å…ˆæ£€æŸ¥ç¬¬kä¸ªæ¡¶é‡Œé¢æœ‰æ²¡æœ‰span
if (!_spanlists[k].Empty())
{
Span* Kspan = _spanlists[k].PopFront();
//å°†Kspanç»™CentralCacheä¹‹å‰,å…ˆå°†é¡µå·å’Œspanå¯¹åº”å…³ç³»è®°å½•
for (size_t i = 0; i < Kspan->_n; ++i)
{
_idSpanMap[Kspan->_pageid + i] = Kspan;
}
//å°†ç®¡ç†ké¡µçš„spanç»™Central Cache
return Kspan;
}
//èµ°åˆ°è¿™é‡Œç¬¬kä¸ªæ¡¶æ²¡æœ‰spanï¼Œé‚£å°±ç»§ç»­å¾€ä¸‹é¢çš„æ¡¶æ‰¾
for (size_t i = k + 1; i < NPAGES; ++i)
{
if (!_spanlists[i].Empty())
{
//å°†ä¸€ä¸ªç®¡ç†æ›´å¤šé¡µçš„spanï¼Œå˜æˆä¸¤ä¸ªspanï¼Œä¸€ä¸ªç®¡ç†ké¡µï¼Œä¸€ä¸ªç®¡ç†i-ké¡µ
Span* Ispan = _spanlists[i].PopFront();
//Span* Kspan = new Span;
Span* Kspan = _spanPool.New();
Kspan->_pageid = Ispan->_pageid;
Kspan->_n = k;
Ispan->_pageid += k;
Ispan->_n -= k;
//å°†IspanæŒ‚åœ¨å¯¹åº”å¤§å°çš„æ¡¶
_spanlists[Ispan->_n].PushFront(Ispan);
//è®°å½•æŒ‚åœ¨PageCacheä¸­è¿˜æœªè¢«ä½¿ç”¨çš„Ispançš„é¡µå·å’Œspanå¯¹åº”å…³ç³»
//è¿™é‡Œä»…éœ€è®°å½•è¿™ä¸ªspançš„é¦–é¡µå’Œå°¾é¡µä¸Ispançš„å¯¹åº”å…³ç³»å³å¯,
//ä¸åƒè¿”å›ç»™CentralCacheçš„Kspançš„éœ€è¦æŠŠè¿™ä¸ªKspanç®¡ç†çš„æ¯ä¸€é¡µéƒ½å’ŒKspanå»ºç«‹æ˜ å°„å…³ç³»
//å› ä¸ºåˆå¹¶ä»…éœ€çŸ¥é“æ¯ä¸ªIspançš„é¦–é¡µå’Œå°¾é¡µå°±å¯ä»¥æ‰¾åˆ°Ispan,è€Œè¿”å›ç»™CentralCacheçš„Kspan,
//é¦–å…ˆéœ€è¦å°†Kspanåˆ‡æˆä¸€å—å—å°å†…å­˜æ‰è¡Œæ‰èƒ½å†ç»™ThreadCacheç”¨,
//å½“å°å†…å­˜å›æ¥/8kbå¯èƒ½æ˜¯Kspanç®¡ç†çš„å…¶ä¸­æŸä¸€é¡µ,æ‰èƒ½çŸ¥é“è¯¥é¡µå¯¹åº”span
//_idSpanMap[Ispan->_pageid] = Ispan;
//_idSpanMap[Ispan->_pageid + Ispan->_n - 1] = Ispan;
_idSpanMap.set(Ispan->_pageid, Ispan);
_idSpanMap.set(Ispan->_pageid + Ispan->_n - 1, Ispan);
//å°†Kspanç»™CentralCacheä¹‹å‰,å…ˆå°†é¡µå·å’Œspanå¯¹åº”å…³ç³»è®°å½•
for (size_t i = 0; i < Kspan->_n; ++i)
{
_idSpanMap[Kspan->_pageid + i] = Kspan;
}
//å°†ç®¡ç†ké¡µçš„spanç»™Central Cache
return Kspan;
}
}
//èµ°åˆ°è¿™é‡Œè¯´æ˜ï¼Œåé¢çš„ä½ç½®éƒ½æ²¡æœ‰å¤§é¡µçš„span
//é‚£å°±å»æ‰¾å †ç”³è¯·ä¸€ä¸ª128pageçš„span
Span* bigSpan = new Span;
void* ptr = SystemAlloc(NPAGES - 1);
bigSpan->_pageid = (PAGE_ID)ptr >> PAGE_SHIFT;
bigSpan->_n = NPAGES - 1;
//spanæŒ‚åœ¨å¯¹åº”æ¡¶ä¸‹
_spanlists[bigSpan->_n].PushFront(bigSpan);
//é‡å¤ä¸Šè¿°è¿‡ç¨‹å¯»æ‰¾kå·æ¡¶çš„spanï¼Œä¸€å®šè¿˜å›ä¸€ä¸ªspan
return NewSpan(k);
}
å‡†å¤‡å·¥ä½œåšå®Œäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯CentralPageè¿˜å›æ¥ä¸€ä¸ªSpanï¼Œçœ‹ç›¸é‚»çš„Spanæ˜¯å¦èƒ½åˆå¹¶ï¼Œè§£å†³å†…å­˜ç¢ç‰‡çš„é—®é¢˜ã€‚
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/5b2e260af03c4e429cf9e465ce4c16bf.png)
// é‡Šæ”¾ç©ºé—²spanå›åˆ°Pagecacheï¼Œå¹¶åˆå¹¶ç›¸é‚»çš„span
void PageCache::ReleaseSpanToPageCache(Span* span)
{
// å¦‚ä½•çŸ¥é“ç›¸é‚»çš„spanæ˜¯å¦èƒ½åˆå¹¶?
// é€šè¿‡è‡ªå·±çš„é¡µå·æ‰¾åˆ°ç›¸é‚»çš„spançœ‹æ˜¯å¦èƒ½åˆå¹¶,å¦‚æœè¯¥é¡µçš„spanåœ¨PageCacheè¯´æ˜è¯¥spanè¿˜æ²¡æœ‰è¢«ä½¿ç”¨,å¯ä»¥åˆå¹¶
// å¦‚æœåœ¨CentralCacheè¯´æ˜è¯¥spanæ­£åœ¨è¢«ä½¿ç”¨,ä¸èƒ½åˆå¹¶
// å¦‚ä½•çŸ¥é“ä¸€ä¸ªspanæ˜¯å¦è¢«ä½¿ç”¨? æ˜¯ç”¨spanä¸­çš„usecountæ˜¯å¦ç­‰äº0å—? ä¸èƒ½!!
// è¿™é‡Œæœ‰ä¸€ä¸ªç©ºæ¡£æ—¶é—´,å½“thread1çº¿ç¨‹é€šè¿‡TLSæ‰¾åˆ°è‡ªå·±threadcacheç”³è¯·å†…å­˜å—,ä½†æ˜¯æ²¡æœ‰,
// å°±å»æ‰¾CentralCache,ä½†æ˜¯CentralCacheå¯¹åº”æ¡¶ä¸‹ä¹Ÿæ²¡æœ‰,é‚£å°±åªèƒ½å»æ‰¾PageCacheäº†
// PageCacheè¿”å›ç»™CentralCacheä¸€ä¸ªspan,è¿™ä¸ªspançš„usecountåˆå§‹å¯æ˜¯0,
// CentralCacheæ‹¿åˆ°åå¯¹spanè¿™ä¸€å¤§å—å†…å­˜åˆ‡æˆä¸€å—å—å°å†…å­˜
// åœ¨æŒ‚åˆ°å¯¹åº”æ¡¶ä¸‹,ä½†æ˜¯è¿™æ—¶å€™thread2,è¦åˆå¹¶è¿™ä¸ªspan,é‚£å°±æœ‰é—®é¢˜äº†,thread1æ­£å‡†å¤‡ä»è¿™spanæ‹¿ä¸€æ‰¹é‡
// ä½†æ˜¯è¿˜æ²¡æœ‰æ‹¿åˆ°,è¿™ä¸ªspançš„usecountå¯è¿˜æ˜¯0,åªæœ‰æ‹¿èµ°äº†usecountæ‰ä¼š++
// thread2æŠŠè¿™ä¸ªspanå’Œè‡ªå·±spanåˆå¹¶äº†,é‚£å°±é€ æˆçº¿ç¨‹å®‰å…¨çš„é—®é¢˜!!
// å› æ­¤éœ€è¦ç»™spanå¯¹è±¡åŠ ä¸€ä¸ªisuseæˆå‘˜è®°å½•è¿™ä¸ªspanæ˜¯å¦è¢«ä½¿ç”¨
// å¦‚ä½•é€šè¿‡é¡µå·æ‰¾åˆ°ç›¸é‚»çš„é¡µ? è¿˜æ˜¯å¾—ç”¨unordered_mapè®°å½•é¡µå·åˆspanå¯¹åº”å…³ç³»
// ä½†æ˜¯ç›®å‰çš„unordered_mapåªè®°å½•äº†ç»™CentralCacheå·²ç»è¢«ä½¿ç”¨çš„spançš„é¡µå·å’Œspanå¯¹åº”å…³ç³»
// å¹¶æ²¡æœ‰è®°å½•åœ¨PageCacheçš„spançš„é¡µå·å’Œspanå¯¹åº”å…³ç³»
// å› æ­¤éœ€è¦æŠŠåœ¨PageCacheçš„spançš„é¡µå·å’Œspanå¯¹åº”å…³ç³»ä¹Ÿè¦è®°å½•åœ¨unordered_mapä¸­
//å…ˆèµ°å‰é¢ç›¸é‚»çš„spanæ˜¯å¦èƒ½åˆå¹¶,èƒ½åˆå¹¶å°±ä¸€ç›´åˆ
while (1)
{
PAGE_ID prevId = span->_pageid - 1;
auto ret = _idSpanMap.find(prevId);
// å‰é¢çš„é¡µå·æ²¡æœ‰ï¼Œä¸åˆå¹¶äº†(å †ç”³è¯·å†…å­˜å·²ç»åˆ°äº†èµ·å§‹åœ°å€)
if (ret == _idSpanMap.end())
{
break;
}
Span* prevSpan = ret->second;
// å‰é¢ç›¸é‚»é¡µçš„spanåœ¨ä½¿ç”¨ï¼Œä¸åˆå¹¶äº†
if (prevSpan->_isuse == true)
{
break;
}
// åˆå¹¶å‡ºè¶…è¿‡128é¡µçš„spanæ²¡åŠæ³•æŒ‚åœ¨æ¡¶ä¸‹ï¼Œä¸åˆå¹¶äº†
if (prevSpan->_n + span->_n > NPAGES - 1)
{
break;
}
// ç”¨spanåˆå¹¶prevSpan
span->_pageid = prevSpan->_pageid;
span->_n += prevSpan->_n;
// å°†pevSpanä»å¯¹åº”çš„æ¡¶ä¸­åˆ é™¤
_spanlists[prevSpan->_n].Erase(prevSpan);
delete prevSpan;
// è¿™é‡Œå¯èƒ½æœ‰ç–‘é—®,é‚£é—ç•™unordered_mapä¸­è¢«åˆå¹¶çš„å¯¹åº”é¡µå’ŒprevSpanä¹‹é—´ä¸€å¯¹ä¸€çš„å…³ç³»éš¾é“ä¸åˆ é™¤å—?
// å› ä¸ºprevSpanå·²ç»è¢«åˆ é™¤äº†,åœ¨å»é€šè¿‡å·²æœ‰é¡µå»æ‰¾spané‚£å°±æ˜¯é‡æŒ‡é’ˆäº†! ä½†å…¶å®å¹¶ä¸ç”¨åˆ é™¤.
// é¦–å…ˆè¢«åˆå¹¶çš„é¡µå·²ç»è¢«spanç®¡ç†èµ·æ¥äº†,åˆå¹¶ç»“æŸä¹‹åä¼šè¢«æŒ‚åœ¨å¯¹åº”æ¡¶ä¸‹,å¹¶ä¸”è®°å½•è¯¥spané¦–é¡µå’Œå°¾é¡µä¸spançš„å¯¹åº”å…³ç³».
// å½“CentralCacheè¦çš„æ—¶å€™,åœ¨æŠŠspanåˆ‡åˆ†æˆä¸¤ä¸ªspan,è¿”å›ç»™CentralCacheçš„Kspanæ¯é¡µéƒ½å’ŒKspané‡æ–°è¿›è¡Œæ˜ å°„
// ç•™åœ¨PageCacheçš„Ispançš„é¦–é¡µå’Œå°¾é¡µä¹Ÿä¼šå’ŒIspané‡æ–°æ˜ å°„
// è¿™æ ·çš„è¯,ä»¥å‰è¢«åˆå¹¶,é—ç•™ä¸‹æ¥çš„é¡µåˆå’Œæ–°å¾—spanå»ºç«‹äº†æ˜ å°„å…³ç³»,å°±ä¸ä¼šæœ‰é€šè¿‡é¡µæ‰¾spanä¼šæœ‰é‡æŒ‡é’ˆçš„é—®é¢˜
}
//æ‰¾åé¢ç›¸é‚»çš„spanåˆå¹¶
while (1)
{
PAGE_ID nextId = span->_pageid + span->_n;
auto ret = _idSpanMap.find(nextId);
// åé¢çš„é¡µå·æ²¡æœ‰ï¼Œä¸åˆå¹¶äº†(å †ç”³è¯·å†…å­˜å·²ç»åˆ°äº†ç»“å°¾åœ°å€)
if (ret == _idSpanMap.end())
{
break;
}
Span* nextSpan = ret->second;
// åé¢ç›¸é‚»é¡µçš„spanåœ¨ä½¿ç”¨ï¼Œä¸åˆå¹¶äº†
if (nextSpan->_isuse == true)
{
break;
}
// åˆå¹¶å‡ºè¶…è¿‡128é¡µçš„spanæ²¡åŠæ³•æŒ‚åœ¨æ¡¶ä¸‹ï¼Œä¸åˆå¹¶äº†
if (nextSpan->_n + span->_n > NPAGES - 1)
{
break;
}
span->_n += nextSpan->_n;
_spanlists[nextSpan->_n].Erase(nextSpan);
delete nextSpan;
}
//åˆå¹¶å¥½çš„spanæŒ‚åœ¨å¯¹åº”æ¡¶ä¸‹
_spanlists[span->_n].PushFront(span);
span->_isuse = false;
//é‡æ–°æ˜ å°„åœ¨PageCaceçš„Spançš„é¦–é¡µå’Œå°¾é¡µä¸Spanæ˜ å°„å…³ç³»
_idSpanMap[span->_pageid] = span;
_idSpanMap[span->_pageid + span->_n - 1] = span;
}
å…³äºé‡Šæ”¾å†…å­˜å°±åˆ°è¿™é‡Œäº†ï¼Œä¸‹é¢æˆ‘ä»¬åœ¨å¯¹ç»†èŠ‚è¿›è¡Œä¼˜åŒ–ã€‚
## 2 ç”³è¯·å’Œé‡Šæ”¾å‰©ä½™è¡¥å……
å½“è¦çš„å†…å­˜**å°äº256KB** ï¼Œ**æ¯ä¸ªçº¿ç¨‹é€šè¿‡TLSæ‰¾åˆ°è‡ªå·±çš„ThreadCacheè¦**
ï¼Œå¦‚æœæ²¡æœ‰å°±æ‰¾CentralCacheè¦ï¼Œåœ¨æ²¡æœ‰å°±æ‰¾PageCacheè¦ï¼Œåœ¨æ²¡æœ‰å°±æ‰¾å †å»è¦ã€‚
ä¹‹å‰æˆ‘ä»¬ä¸€ç›´æ²¡è°ˆçš„æ˜¯å¤§äº256KBæ€ä¹ˆåŠï¼Ÿ
å…¶å®è¿™é‡Œåˆ†ä¸ºåˆ†æˆä¸¤ç§æƒ…å†µï¼Œ256KB/8KB=32Pageï¼ŒPageCacheæœ€å¤§çš„æ¡¶æ˜¯128Pageã€‚å› æ­¤å°±æœ‰ **å¤§äº32Page
å°äºç­‰äº128Pageï¼Œæ‰¾PageCacheè¦** ã€‚**å¤§äº128Pageç›´æ¥æ‰¾å †è¦** ã€‚
ä¸ç®¡æ˜¯æ‰¾PageCacheè¦è¿˜æ˜¯æ‰¾å †è¦ï¼Œéƒ½æ˜¯æŒ‰é¡µä¸ºå•ä½å¯¹é½çš„ã€‚
//Common.h
class SizeClass
{
//...
static inline size_t _RoundUp(size_t bytes, size_t alignNum)
{
return ((bytes + alignNum - 1) & ~(alignNum - 1));
}
static inline size_t RoundUp(size_t size)
{
if (size <= 128)
{
return _RoundUp(size, 8);
}
else if (size <= 1024)
{
return _RoundUp(size, 16);
}
else if (size <= 8 * 1024)
{
return _RoundUp(size, 128);
}
else if (size <= 64 * 1024)
{
return _RoundUp(size, 1024);
}
else if (size <= 256 * 1024)
{
return _RoundUp(size, 8 * 1024);
}
else//æ‰¾PageCacheæˆ–è€…å †æŒ‰é¡µä¸ºå•ä½å¯¹é½
{
return _RoundUp(size, 1 << PAGE_SHIFT);
}
return -1;
}
};
//ConcurrentAlloc.h
static void* ConcurrentAlloc(size_t size)
{
//å¤§äº256KB/8KB=13page å°äºç­‰äº128page æ‰¾PageCacheè¦
//å¤§äº128pageæ‰¾å †è¦
if (size > MAX_BYTES)
{
//æ‰¾PageCacheæˆ–è€…å †è¦éƒ½æ˜¯ä»¥é¡µä¸ºå•ä½å¯¹é½
size_t alignnum = SizeClass::RoundUp(size);
//åœ¨PageCacheé‚£ä¸ªæ¡¶
size_t kpage = alignnum >> PAGE_SHIFT;
//åœ¨PageCacheå†…éƒ¨å¤„ç†æ‰¾æ˜¯å¦æ‰¾å †è¦
PageCache::GetInstance()->_pageMtx.lock();
Span* span = PageCache::GetInstance()->NewSpan(kpage);
//è¿™é‡Œä¸éœ€è¦è®°å½•è¿™ä¸ªspanå·²ç»è¢«ä½¿ç”¨,å› ä¸ºè¿˜å¾—æ—¶å€™åˆå¹¶çš„è¿™ä¸ªspanç›¸é‚»é¡µçš„spançœ‹æ˜¯å¦åœ¨ä½¿ç”¨
PageCache::GetInstance()->_pageMtx.unlock();
//å¾—åˆ°åœ°å€è¿”å›
void* ptr = (void*)(span->_pageid << PAGE_SHIFT);
return ptr;
}
else//å°äº256KBé€šè¿‡ä¸‰å±‚ç¼“å­˜è¦
{
//é€šè¿‡TLS æ¯ä¸ªçº¿ç¨‹æ— é”çš„è·å–è‡ªå·±çš„ä¸“å±çš„ThreadCacheå¯¹è±¡
if (pTLSThreadCache == nullptr)
{
pTLSThreadCache = new ThreadCache;
}
return pTLSThreadCache->Allocate(size);
}
}
è¿™é‡Œåœ¨æŠŠæ‰¾PageCacheè¦ä¸€ä¸ªSpanå¤„ç†ä¸€ä¸‹
//ä»PageCacheç¬¬kå·æ¡¶ä¸­è·å–ä¸€ä¸ªspanå¯¹è±¡
Span* PageCache::NewSpan(size_t k)
{
assert(k > 0);
//å¤§äº 128pageæ‰¾å †è¦
if (k > NPAGES - 1)
{
void* ptr = SystemAlloc(k);
//ç”³è¯·ä¸€ä¸ªspanå¯¹è±¡ç®¡ç†è¿™å—å†…å­˜,é‡Šæ”¾å†…å­˜çš„æ—¶å€™è¦å¯¹åº”çš„span
Span* span = new Span;
span->_pageid = (PAGE_ID)ptr >> PAGE_SHIFT;
span->_n = k;
_idSpanMap[span->_pageid] = span;
return span;
}
//è¿™é‡ŒåŠ é”é€’å½’ä¼šæœ‰æ­»é”é—®é¢˜ï¼Œé™¤éç”¨é€’å½’äº’æ–¥é”ï¼Œè¿˜æœ‰åœ¨å¤–é¢è°ƒç”¨è¿™ä¸ªå‡½æ•°ä¹‹å‰åŠ é”
// å…ˆæ£€æŸ¥ç¬¬kä¸ªæ¡¶é‡Œé¢æœ‰æ²¡æœ‰span
if (!_spanlists[k].Empty())
{
Span* Kspan = _spanlists[k].PopFront();
//å°†Kspanç»™CentralCacheä¹‹å‰,å…ˆå°†é¡µå·å’Œspanå¯¹åº”å…³ç³»è®°å½•
for (size_t i = 0; i < Kspan->_n; ++i)
{
_idSpanMap[Kspan->_pageid + i] = Kspan;
}
//å°†ç®¡ç†ké¡µçš„spanç»™Central Cache
return Kspan;
}
//èµ°åˆ°è¿™é‡Œç¬¬kä¸ªæ¡¶æ²¡æœ‰spanï¼Œé‚£å°±ç»§ç»­å¾€ä¸‹é¢çš„æ¡¶æ‰¾
for (size_t i = k + 1; i < NPAGES; ++i)
{
if (!_spanlists[i].Empty())
{
//å°†ä¸€ä¸ªç®¡ç†æ›´å¤šé¡µçš„spanï¼Œå˜æˆä¸¤ä¸ªspanï¼Œä¸€ä¸ªç®¡ç†ké¡µï¼Œä¸€ä¸ªç®¡ç†i-ké¡µ
Span* Ispan = _spanlists[i].PopFront();
Span* Kspan = new Span;
Kspan->_pageid = Ispan->_pageid;
Kspan->_n = k;
Ispan->_pageid += k;
Ispan->_n -= k;
//å°†IspanæŒ‚åœ¨å¯¹åº”å¤§å°çš„æ¡¶
_spanlists[Ispan->_n].PushFront(Ispan);
//è®°å½•æŒ‚åœ¨PageCacheä¸­è¿˜æœªè¢«ä½¿ç”¨çš„Ispançš„é¡µå·å’Œspanå¯¹åº”å…³ç³»
//è¿™é‡Œä»…éœ€è®°å½•è¿™ä¸ªspançš„é¦–é¡µå’Œå°¾é¡µä¸Ispançš„å¯¹åº”å…³ç³»å³å¯,
//ä¸åƒè¿”å›ç»™CentralCacheçš„Kspançš„éœ€è¦æŠŠè¿™ä¸ªKspanç®¡ç†çš„æ¯ä¸€é¡µéƒ½å’ŒKspanå»ºç«‹æ˜ å°„å…³ç³»
//å› ä¸ºåˆå¹¶ä»…éœ€çŸ¥é“æ¯ä¸ªIspançš„é¦–é¡µå’Œå°¾é¡µå°±å¯ä»¥æ‰¾åˆ°Ispan,è€Œè¿”å›ç»™CentralCacheçš„Kspan,
//é¦–å…ˆéœ€è¦å°†Kspanåˆ‡æˆä¸€å—å—å°å†…å­˜æ‰è¡Œæ‰èƒ½å†ç»™ThreadCacheç”¨,
//å½“å°å†…å­˜å›æ¥/8kbå¯èƒ½æ˜¯Kspanç®¡ç†çš„å…¶ä¸­æŸä¸€é¡µ,æ‰èƒ½çŸ¥é“è¯¥é¡µå¯¹åº”span
_idSpanMap[Ispan->_pageid] = Ispan;
_idSpanMap[Ispan->_pageid + Ispan->_n - 1] = Ispan;
//å°†Kspanç»™CentralCacheä¹‹å‰,å…ˆå°†é¡µå·å’Œspanå¯¹åº”å…³ç³»è®°å½•
for (size_t i = 0; i < Kspan->_n; ++i)
{
_idSpanMap[Kspan->_pageid + i] = Kspan;
}
//å°†ç®¡ç†ké¡µçš„spanç»™Central Cache
return Kspan;
}
}
//èµ°åˆ°è¿™é‡Œè¯´æ˜ï¼Œåé¢çš„ä½ç½®éƒ½æ²¡æœ‰å¤§é¡µçš„span
//é‚£å°±å»æ‰¾å †ç”³è¯·ä¸€ä¸ª128pageçš„span
Span* bigSpan = new Span;
void* ptr = SystemAlloc(NPAGES - 1);
bigSpan->_pageid = (PAGE_ID)ptr >> PAGE_SHIFT;
bigSpan->_n = NPAGES - 1;
//spanæŒ‚åœ¨å¯¹åº”æ¡¶ä¸‹
_spanlists[bigSpan->_n].PushFront(bigSpan);
//é‡å¤ä¸Šè¿°è¿‡ç¨‹å¯»æ‰¾kå·æ¡¶çš„spanï¼Œä¸€å®šè¿˜å›ä¸€ä¸ªspan
return NewSpan(k);
}
é‡Šæ”¾ä¹Ÿæ˜¯ä¸€æ ·ï¼Œ**å°äº256KBçš„é€šè¿‡TLSæ‰¾è‡ªå·±çš„ThreadCacheé‡Šæ”¾ï¼Œå¤§äº32Pageå°äºç­‰äº128Pageè¿˜ç»™PageCacheï¼Œå¤§äº128Pageè¿˜ç›´æ¥è¿”ç»™å †ã€‚**
static void ConcurrentFree(void* ptr,size_t size)
{
//å¤§äº32pageå°äºç­‰äº128pageç›´æ¥è¿˜ç»™PageCache,
//å¤§äº128pageç›´æ¥è¿˜ç»™å †
if (size > MAX_BYTES)
{
//æ ¹æ®åœ°å€æ‰¾è½¬æ¢ä¸ºå¯¹åº”çš„é¡µå·,é€šè¿‡é¡µå·æ‰¾åˆ°å¯¹åº”çš„span,åœ¨æ‰¾åˆ°å¯¹åº”å†…å­˜å¤§å°
Span* span = PageCache::GetInstance()->MapObjectToSpan(ptr);
PageCache::GetInstance()->_pageMtx.lock();
PageCache::GetInstance()->ReleaseSpanToPageCache(span);
PageCache::GetInstance()->_pageMtx.unlock();
}
else
{
assert(pTLSThreadCache);
pTLSThreadCache->Deallocate(ptr, size);
}
}