---
layout: post
title: "unityGPU顶点动画"
date: 2025-03-16 23:35:48 +0800
description: "[unity]GPU顶点动画"
keywords: "【unity】GPU顶点动画"
categories: ['Unity', 'Shader']
tags: ['游戏引擎', 'Unity']
artid: "146297520"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146297520
    alt: "unityGPU顶点动画"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146297520
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146297520
cover: https://bing.ee123.net/img/rand?artid=146297520
image: https://bing.ee123.net/img/rand?artid=146297520
img: https://bing.ee123.net/img/rand?artid=146297520
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【unity】GPU顶点动画
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="_1">
     </a>
     工具篇
    </h2>
    <h3>
     <a id="_2">
     </a>
     模型合并
    </h3>
    <p>
     <strong>
      根据原模型创建预制件：
     </strong>
     <br/>
     清理旧的合并结果，创建新容器对象
     <br/>
     PS：注意 DestroyImmediate仅在 Editor 模式下有效，运行时需用Destroy
    </p>
    <pre><code>var targetObj = GameObject.Find("targetObj");
if (targetObj != null)
{
    GameObject.DestroyImmediate(targetObj);
}
targetObj = new GameObject("targetObj");
targetObj.transform.localPosition = Vector3.zero;
// ... 其他变换重置 ...
</code></pre>
    <p>
     <strong>
      收集网格和材质信息
     </strong>
     <br/>
     获取所有需要合并的网格组件，包含静态和蒙皮网格。
    </p>
    <pre><code>MeshRenderer[] allMeshRender = sourceObj.GetComponentsInChildren&lt;MeshRenderer&gt;();
SkinnedMeshRenderer[] SkinnedMeshRenderer = sourceObj.GetComponentsInChildren&lt;SkinnedMeshRenderer&gt;();
MeshFilter[] allfilter = sourceObj.GetComponentsInChildren&lt;MeshFilter&gt;();
</code></pre>
    <p>
     <strong>
      填充 MeshInfo 列表
     </strong>
     <br/>
     PS: 必须添加：subMeshIndex 因为需要用于处理多材质网格的分段合并。
    </p>
    <pre><code class="prism language-cs"><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token keyword">in</span> allfilter<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> subMeshIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> subMeshIndex <span class="token operator">&lt;</span> filter<span class="token punctuation">.</span>sharedMesh<span class="token punctuation">.</span>subMeshCount<span class="token punctuation">;</span> subMeshIndex<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">MeshInfo</span> meshInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MeshInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        meshInfo<span class="token punctuation">.</span>mesh <span class="token operator">=</span> filter<span class="token punctuation">.</span>sharedMesh<span class="token punctuation">;</span>
        meshInfo<span class="token punctuation">.</span>subIndex <span class="token operator">=</span> subMeshIndex<span class="token punctuation">;</span>
        meshInfo<span class="token punctuation">.</span>matrix4x4 <span class="token operator">=</span> filter<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>localToWorldMatrix<span class="token punctuation">;</span>
        meshInfos<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>meshInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     SkinnedMeshRenderer也需要处理
    </p>
    <p>
     <strong>
      贴图合并
     </strong>
     <br/>
     需要创建一个大的贴图Texture2D，获取所有materials材质球的_MainTex（我只处理了_MainTex，当然也可以处理法线贴图这些其他内容）
     <br/>
     PS: COMBINE_TEXTURE_WIDTH是有问题的，后续需要修改，不能这样累加
    </p>
    <p>
     使用的Texture2D.PackTextures进行打包到图集中的
    </p>
    <pre><code class="prism language-cs"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> materials<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Texture2D</span> maintexture <span class="token operator">=</span> materials<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">GetTexture</span><span class="token punctuation">(</span><span class="token string">"_MainTex"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token class-name">Texture2D</span><span class="token punctuation">;</span>
    COMBINE_TEXTURE_WIDTH <span class="token operator">+=</span> maintexture<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
    COMBINE_TEXTURE_HEIGHT <span class="token operator">+=</span> maintexture<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
    MainTexs<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>maintexture<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">Texture2D</span> newMainTex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Texture2D</span><span class="token punctuation">(</span>COMBINE_TEXTURE_WIDTH<span class="token punctuation">,</span> COMBINE_TEXTURE_HEIGHT<span class="token punctuation">,</span> TextureFormat<span class="token punctuation">.</span>RGBA32<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Rect<span class="token punctuation">[</span><span class="token punctuation">]</span></span> uvs <span class="token operator">=</span> newMainTex<span class="token punctuation">.</span><span class="token function">PackTextures</span><span class="token punctuation">(</span>MainTexs<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      UV需要进行偏移
     </strong>
    </p>
    <pre><code class="prism language-cs"><span class="token class-name">List<span class="token punctuation">&lt;</span>Vector2<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span> oldUV <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Vector2<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Vector2<span class="token punctuation">[</span><span class="token punctuation">]</span></span> uva<span class="token punctuation">,</span> uvb<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> combines<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    uva <span class="token operator">=</span> combines<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>uv<span class="token punctuation">;</span>
    uvb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector2</span><span class="token punctuation">[</span>uva<span class="token punctuation">.</span>Length<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> uva<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        uvb<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uva<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">*</span> uvs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token operator">+</span> uvs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span>uva<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">*</span> uvs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token operator">+</span> uvs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    oldUV<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>uva<span class="token punctuation">)</span><span class="token punctuation">;</span>
    combines<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>uv <span class="token operator">=</span> uvb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     最后保存后记得还原uv：
    </p>
    <pre><code class="prism language-cs"><span class="token comment">//重新赋值，以免影响其他对象的Mesh</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> combines<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    combines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>uv <span class="token operator">=</span> oldUV<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     最后将贴图赋值到一个新建的材质球上进行保存就好了
    </p>
    <pre><code class="prism language-cs"><span class="token class-name">Material</span> newMaterial <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Material</span><span class="token punctuation">(</span>mainShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
newMaterial<span class="token punctuation">.</span><span class="token function">SetTexture</span><span class="token punctuation">(</span><span class="token string">"_MainTex"</span><span class="token punctuation">,</span> newMainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      合并网格设置
     </strong>
    </p>
    <pre><code class="prism language-cs"><span class="token class-name">List<span class="token punctuation">&lt;</span>CombineInstance<span class="token punctuation">&gt;</span></span> combines <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>CombineInstance<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> i <span class="token keyword">in</span> meshInfos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token keyword">var</span></span> ci <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CombineInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ci<span class="token punctuation">.</span>mesh <span class="token operator">=</span> i<span class="token punctuation">.</span>mesh<span class="token punctuation">;</span>
    ci<span class="token punctuation">.</span>subMeshIndex <span class="token operator">=</span> i<span class="token punctuation">.</span>subIndex<span class="token punctuation">;</span>
    ci<span class="token punctuation">.</span>transform <span class="token operator">=</span> i<span class="token punctuation">.</span>matrix4x4<span class="token punctuation">;</span>
    combines<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>ci<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     需要用到CombineInstance方法进行储存
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4846e134dabf4f5a8bb58be8d430325d.png">
      <br/>
      然后使用CombineMeshes方法进行合并
     </img>
    </p>
    <pre><code class="prism language-cs"><span class="token class-name">Mesh</span> mesh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Mesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
mesh<span class="token punctuation">.</span><span class="token function">CombineMeshes</span><span class="token punctuation">(</span>combines<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     最后进行保存到对应路径：
    </p>
    <pre><code class="prism language-cs">AssetDatabase<span class="token punctuation">.</span><span class="token function">CreateAsset</span><span class="token punctuation">(</span>newMainTex<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">MaterialTexturePath</span><span class="token punctuation">}</span></span><span class="token string">CombineTexture.asset"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AssetDatabase<span class="token punctuation">.</span><span class="token function">CreateAsset</span><span class="token punctuation">(</span>newMaterial<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">MaterialTexturePath</span><span class="token punctuation">}</span></span><span class="token string">CombineMaterial.mat"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
AssetDatabase<span class="token punctuation">.</span><span class="token function">CreateAsset</span><span class="token punctuation">(</span>mesh<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">MaterialTexturePath</span><span class="token punctuation">}</span></span><span class="token string">CombineMaterial.asset"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      完整代码：
     </strong>
    </p>
    <pre><code class="prism language-cs">
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Unity<span class="token punctuation">.</span>VisualScripting</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">UnityEditor</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">struct</span> <span class="token class-name">MeshInfo</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">Mesh</span> mesh<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name">Matrix4x4</span> matrix4x4<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">int</span></span> subIndex<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CombineVertexTool</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">string</span></span> MaterialTexturePath <span class="token operator">=</span> <span class="token string">"Assets/Resources/Material/"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CombineFilter</span><span class="token punctuation">(</span><span class="token class-name">GameObject</span> sourceObj<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">var</span></span> targetObj <span class="token operator">=</span> GameObject<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token string">"targetObj"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>targetObj <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            GameObject<span class="token punctuation">.</span><span class="token function">DestroyImmediate</span><span class="token punctuation">(</span>targetObj<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        targetObj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">GameObject</span><span class="token punctuation">(</span><span class="token string">"targetObj"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        targetObj<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>localPosition <span class="token operator">=</span> Vector3<span class="token punctuation">.</span>zero<span class="token punctuation">;</span>
        targetObj<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>localRotation <span class="token operator">=</span> Quaternion<span class="token punctuation">.</span>identity<span class="token punctuation">;</span>
        targetObj<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>localScale <span class="token operator">=</span> Vector3<span class="token punctuation">.</span>one<span class="token punctuation">;</span>

        <span class="token class-name">MeshRenderer<span class="token punctuation">[</span><span class="token punctuation">]</span></span> allMeshRender <span class="token operator">=</span> sourceObj<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponentsInChildren</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MeshRenderer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//包含MeshRenderer和SkinnedMeshRenderer</span>
        <span class="token class-name">SkinnedMeshRenderer<span class="token punctuation">[</span><span class="token punctuation">]</span></span> SkinnedMeshRenderer <span class="token operator">=</span> sourceObj<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponentsInChildren</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SkinnedMeshRenderer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">MeshFilter<span class="token punctuation">[</span><span class="token punctuation">]</span></span> allfilter <span class="token operator">=</span> sourceObj<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponentsInChildren</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MeshFilter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//网格</span>

       
        <span class="token class-name">List<span class="token punctuation">&lt;</span>MeshInfo<span class="token punctuation">&gt;</span></span> meshInfos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>MeshInfo<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> filter <span class="token keyword">in</span> allfilter<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> subMeshIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> subMeshIndex <span class="token operator">&lt;</span> filter<span class="token punctuation">.</span>sharedMesh<span class="token punctuation">.</span>subMeshCount<span class="token punctuation">;</span> subMeshIndex<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">MeshInfo</span> meshInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MeshInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                meshInfo<span class="token punctuation">.</span>mesh <span class="token operator">=</span> filter<span class="token punctuation">.</span>sharedMesh<span class="token punctuation">;</span>
                meshInfo<span class="token punctuation">.</span>subIndex <span class="token operator">=</span> subMeshIndex<span class="token punctuation">;</span>
                meshInfo<span class="token punctuation">.</span>matrix4x4 <span class="token operator">=</span> filter<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>localToWorldMatrix<span class="token punctuation">;</span>
                meshInfos<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>meshInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//材质球数组</span>
        <span class="token class-name">List<span class="token punctuation">&lt;</span>Material<span class="token punctuation">&gt;</span></span> materials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Material<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> i <span class="token keyword">in</span> allMeshRender<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> j <span class="token keyword">in</span> i<span class="token punctuation">.</span>sharedMaterials<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                materials<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">SkinnedMeshRenderer</span> i <span class="token keyword">in</span> SkinnedMeshRenderer<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> j <span class="token keyword">in</span> i<span class="token punctuation">.</span>sharedMaterials<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                materials<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> subMeshIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> subMeshIndex <span class="token operator">&lt;</span> i<span class="token punctuation">.</span>sharedMesh<span class="token punctuation">.</span>subMeshCount<span class="token punctuation">;</span> subMeshIndex<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">MeshInfo</span> meshInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MeshInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                meshInfo<span class="token punctuation">.</span>mesh <span class="token operator">=</span> i<span class="token punctuation">.</span>sharedMesh<span class="token punctuation">;</span>
                meshInfo<span class="token punctuation">.</span>subIndex <span class="token operator">=</span> subMeshIndex<span class="token punctuation">;</span>
                meshInfo<span class="token punctuation">.</span>matrix4x4 <span class="token operator">=</span> i<span class="token punctuation">.</span>transform<span class="token punctuation">.</span>localToWorldMatrix<span class="token punctuation">;</span>
                meshInfos<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>meshInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> 
        <span class="token punctuation">}</span>

        <span class="token class-name">Shader</span> mainShader <span class="token operator">=</span> materials<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>shader<span class="token punctuation">;</span> <span class="token comment">//要求所有shader都必须使用同一个shader</span>


        <span class="token comment">// 合并 Mesh</span>
        <span class="token comment">// 后去自身和子物体中所有 MsehFilter 组件</span>
        <span class="token class-name">List<span class="token punctuation">&lt;</span>CombineInstance<span class="token punctuation">&gt;</span></span> combines <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>CombineInstance<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> i <span class="token keyword">in</span> meshInfos<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> ci <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">CombineInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ci<span class="token punctuation">.</span>mesh <span class="token operator">=</span> i<span class="token punctuation">.</span>mesh<span class="token punctuation">;</span>
            ci<span class="token punctuation">.</span>subMeshIndex <span class="token operator">=</span> i<span class="token punctuation">.</span>subIndex<span class="token punctuation">;</span>
            <span class="token comment">//ci.mesh.triangles = i.mesh.triangles; //添加会改变原模型的网格</span>
            ci<span class="token punctuation">.</span>transform <span class="token operator">=</span> i<span class="token punctuation">.</span>matrix4x4<span class="token punctuation">;</span>
            combines<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>ci<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">//收集所有材质贴图</span>
        <span class="token class-name">List<span class="token punctuation">&lt;</span>Texture2D<span class="token punctuation">&gt;</span></span> MainTexs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Texture2D<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">int</span></span> COMBINE_TEXTURE_WIDTH <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token class-name"><span class="token keyword">int</span></span> COMBINE_TEXTURE_HEIGHT <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> materials<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Texture2D</span> maintexture <span class="token operator">=</span> materials<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">GetTexture</span><span class="token punctuation">(</span><span class="token string">"_MainTex"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token class-name">Texture2D</span><span class="token punctuation">;</span>
            COMBINE_TEXTURE_WIDTH <span class="token operator">+=</span> maintexture<span class="token punctuation">.</span>width<span class="token punctuation">;</span>
            COMBINE_TEXTURE_HEIGHT <span class="token operator">+=</span> maintexture<span class="token punctuation">.</span>height<span class="token punctuation">;</span>
            MainTexs<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>maintexture<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//所有贴图合并到newDiffuseTex这张大贴图上</span>
        <span class="token class-name">Texture2D</span> newMainTex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Texture2D</span><span class="token punctuation">(</span>COMBINE_TEXTURE_WIDTH<span class="token punctuation">,</span> COMBINE_TEXTURE_HEIGHT<span class="token punctuation">,</span> TextureFormat<span class="token punctuation">.</span>RGBA32<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Rect<span class="token punctuation">[</span><span class="token punctuation">]</span></span> uvs <span class="token operator">=</span> newMainTex<span class="token punctuation">.</span><span class="token function">PackTextures</span><span class="token punctuation">(</span>MainTexs<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List<span class="token punctuation">&lt;</span>Vector2<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span> oldUV <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span>Vector2<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Vector2<span class="token punctuation">[</span><span class="token punctuation">]</span></span> uva<span class="token punctuation">,</span> uvb<span class="token punctuation">;</span>
        <span class="token comment">// 遍历所有合并实例（CombineInstance）</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> combines<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 获取当前网格的原始UV数组</span>
            uva <span class="token operator">=</span> combines<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>uv<span class="token punctuation">;</span>
            <span class="token comment">// 创建新UV数组（长度与原始UV相同）</span>
            uvb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector2</span><span class="token punctuation">[</span>uva<span class="token punctuation">.</span>Length<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> uva<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                uvb<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Vector2</span><span class="token punctuation">(</span><span class="token punctuation">(</span>uva<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">*</span> uvs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token operator">+</span> uvs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span>uva<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">*</span> uvs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token operator">+</span> uvs<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            oldUV<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>uva<span class="token punctuation">)</span><span class="token punctuation">;</span>
            combines<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>uv <span class="token operator">=</span> uvb<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Material</span> newMaterial <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Material</span><span class="token punctuation">(</span>mainShader<span class="token punctuation">)</span><span class="token punctuation">;</span>
        newMaterial<span class="token punctuation">.</span><span class="token function">SetTexture</span><span class="token punctuation">(</span><span class="token string">"_MainTex"</span><span class="token punctuation">,</span> newMainTex<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Mesh</span> mesh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Mesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mesh<span class="token punctuation">.</span><span class="token function">CombineMeshes</span><span class="token punctuation">(</span>combines<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 合并实例数组</span>
            <span class="token boolean">true</span><span class="token punctuation">,</span>              <span class="token comment">// mergeSubMeshes：是否合并子网格</span>
            <span class="token boolean">false</span>              <span class="token comment">// useMatrices：是否应用变换矩阵</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        AssetDatabase<span class="token punctuation">.</span><span class="token function">CreateAsset</span><span class="token punctuation">(</span>newMainTex<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">MaterialTexturePath</span><span class="token punctuation">}</span></span><span class="token string">CombineTexture.asset"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        AssetDatabase<span class="token punctuation">.</span><span class="token function">CreateAsset</span><span class="token punctuation">(</span>newMaterial<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">MaterialTexturePath</span><span class="token punctuation">}</span></span><span class="token string">CombineMaterial.mat"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        AssetDatabase<span class="token punctuation">.</span><span class="token function">CreateAsset</span><span class="token punctuation">(</span>mesh<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">MaterialTexturePath</span><span class="token punctuation">}</span></span><span class="token string">CombineMaterial.asset"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">MeshFilter</span> meshFilter <span class="token operator">=</span> targetObj<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MeshFilter<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        meshFilter<span class="token punctuation">.</span>sharedMesh <span class="token operator">=</span> mesh<span class="token punctuation">;</span>

        <span class="token class-name">MeshRenderer</span> meshRenderer <span class="token operator">=</span> targetObj<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MeshRenderer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        meshRenderer<span class="token punctuation">.</span>sharedMaterial <span class="token operator">=</span> newMaterial<span class="token punctuation">;</span>

        <span class="token comment">//重新赋值，以免影响其他对象的Mesh</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> combines<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            combines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mesh<span class="token punctuation">.</span>uv <span class="token operator">=</span> oldUV<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        AssetDatabase<span class="token punctuation">.</span><span class="token function">SaveAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        AssetDatabase<span class="token punctuation">.</span><span class="token function">Refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     PS：需要开启纹理贴图，模型可读写：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/403d76f602df44edb420a00626a42847.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0b944dd9d0964af2936f46b50283e1fe.png"/>
     </img>
    </p>
    <h3>
     <a id="_272">
     </a>
     生成动画数据
    </h3>
    <p>
     根据动画时长和帧率计算总帧数，确定纹理尺寸
    </p>
    <pre><code class="prism language-cs"><span class="token class-name">AnimationClip</span> clip <span class="token operator">=</span> clips<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//foreach (var clip in clips)</span>
<span class="token comment">//{<!-- --></span>
<span class="token comment">//根据动画时长和帧率计算总帧数，确定纹理尺寸</span>
<span class="token class-name"><span class="token keyword">int</span></span> animLength <span class="token operator">=</span> Mathf<span class="token punctuation">.</span><span class="token function">CeilToInt</span><span class="token punctuation">(</span>clip<span class="token punctuation">.</span>frameRate <span class="token operator">*</span> clip<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">int</span></span> texwidth <span class="token operator">=</span> meshRenderer<span class="token punctuation">.</span>sharedMesh<span class="token punctuation">.</span>vertexCount<span class="token punctuation">;</span>
texwidth <span class="token operator">=</span> Mathf<span class="token punctuation">.</span><span class="token function">NextPowerOfTwo</span><span class="token punctuation">(</span>texwidth<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取顶点数的下一个二次幂（适配 GPU 纹理要求）</span>
<span class="token class-name"><span class="token keyword">int</span></span> texHeight <span class="token operator">=</span> animLength<span class="token punctuation">;</span>
</code></pre>
    <p>
     生成一张纹理：
    </p>
    <pre><code class="prism language-cs"><span class="token class-name">Texture2D</span> tex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Texture2D</span><span class="token punctuation">(</span>texwidth<span class="token punctuation">,</span> texHeight<span class="token punctuation">,</span> TextureFormat<span class="token punctuation">.</span>RGBAHalf<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     逐帧写入纹理
    </p>
    <pre><code class="prism language-cs"><span class="token comment">// 步骤3：逐帧处理</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> animLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token keyword">float</span></span> time <span class="token operator">=</span> i <span class="token operator">/</span> clip<span class="token punctuation">.</span>frameRate<span class="token punctuation">;</span>
    <span class="token comment">//Clip.SampleAnimation(GameObject, time)。Clip是我们需要采样的动画剪辑，输入游戏对象后和采样的时间后，就可以在不运行的情况下直接播放动画，加速烘焙过程</span>
    clip<span class="token punctuation">.</span><span class="token function">SampleAnimation</span><span class="token punctuation">(</span>sourceObj<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// B. 烘焙网格</span>
    <span class="token class-name">Mesh</span> bakedMesh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Mesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//烘焙当前帧顶点数据</span>
    meshRenderer<span class="token punctuation">.</span><span class="token function">BakeMesh</span><span class="token punctuation">(</span>bakedMesh<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Vector3<span class="token punctuation">[</span><span class="token punctuation">]</span></span> vertices <span class="token operator">=</span> bakedMesh<span class="token punctuation">.</span>vertices<span class="token punctuation">;</span>

    <span class="token comment">// 写入纹理行（将没一帧顶点数据转换成color数据保存到图片）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> frame <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> frame <span class="token operator">&lt;</span> meshRenderer<span class="token punctuation">.</span>sharedMesh<span class="token punctuation">.</span>vertexCount<span class="token punctuation">;</span> frame<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 超出原始顶点数的部分填充黑色</span>
        <span class="token class-name">Color</span> pixel <span class="token operator">=</span> Color<span class="token punctuation">.</span>black<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>frame <span class="token operator">&lt;=</span> vertices<span class="token punctuation">.</span>Length<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Vector3</span> pos <span class="token operator">=</span> vertices<span class="token punctuation">[</span>frame<span class="token punctuation">]</span><span class="token punctuation">;</span>
            pixel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Color</span><span class="token punctuation">(</span>pos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pos<span class="token punctuation">.</span>y<span class="token punctuation">,</span> pos<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        tex<span class="token punctuation">.</span><span class="token function">SetPixel</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> i<span class="token punctuation">,</span> pixel<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//x要设置的像素的 x 坐标。范围为 0 到（纹理宽度 - 1）,y要设置的像素的 y 坐标。范围为 0 到（纹理高度 - 1）,color要设置的颜色。</span>
        tex<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可选：分批提交数据（当设置为 true 时，将重新计算多级渐进纹理级别）</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     完整代码
    </p>
    <pre><code class="prism language-cs"><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 生成动画数据（顶点动画）</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CreateVertexAnimaSettingData</span><span class="token punctuation">(</span><span class="token class-name">GameObject</span> sourceObj<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name"><span class="token keyword">var</span></span> animator <span class="token operator">=</span> sourceObj<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponent</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Animator<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> clips <span class="token operator">=</span> animator<span class="token punctuation">.</span>runtimeAnimatorController<span class="token punctuation">.</span>animationClips<span class="token punctuation">;</span><span class="token comment">//检索控制器使用的所有 AnimationClip</span>
    animator<span class="token punctuation">.</span>speed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">//MeshFilter meshFilter = sourceObj.GetComponentInChildren&lt;MeshFilter&gt;();</span>
    <span class="token class-name">SkinnedMeshRenderer</span> meshRenderer <span class="token operator">=</span> sourceObj<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetComponentInChildren</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SkinnedMeshRenderer<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">AnimationClip</span> clip <span class="token operator">=</span> clips<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">//foreach (var clip in clips)</span>
    <span class="token comment">//{<!-- --></span>
    <span class="token comment">//根据动画时长和帧率计算总帧数，确定纹理尺寸</span>
    <span class="token class-name"><span class="token keyword">int</span></span> animLength <span class="token operator">=</span> Mathf<span class="token punctuation">.</span><span class="token function">CeilToInt</span><span class="token punctuation">(</span>clip<span class="token punctuation">.</span>frameRate <span class="token operator">*</span> clip<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">int</span></span> texwidth <span class="token operator">=</span> meshRenderer<span class="token punctuation">.</span>sharedMesh<span class="token punctuation">.</span>vertexCount<span class="token punctuation">;</span>
    texwidth <span class="token operator">=</span> Mathf<span class="token punctuation">.</span><span class="token function">NextPowerOfTwo</span><span class="token punctuation">(</span>texwidth<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//取顶点数的下一个二次幂（适配 GPU 纹理要求）</span>
    <span class="token class-name"><span class="token keyword">int</span></span> texHeight <span class="token operator">=</span> animLength<span class="token punctuation">;</span>


    <span class="token class-name">Texture2D</span> tex <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Texture2D</span><span class="token punctuation">(</span>texwidth<span class="token punctuation">,</span> texHeight<span class="token punctuation">,</span> TextureFormat<span class="token punctuation">.</span>RGBAHalf<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 步骤3：逐帧处理</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> animLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">float</span></span> time <span class="token operator">=</span> i <span class="token operator">/</span> clip<span class="token punctuation">.</span>frameRate<span class="token punctuation">;</span>
        <span class="token comment">//Clip.SampleAnimation(GameObject, time)。Clip是我们需要采样的动画剪辑，输入游戏对象后和采样的时间后，就可以在不运行的情况下直接播放动画，加速烘焙过程</span>
        clip<span class="token punctuation">.</span><span class="token function">SampleAnimation</span><span class="token punctuation">(</span>sourceObj<span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// B. 烘焙网格</span>
        <span class="token class-name">Mesh</span> bakedMesh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Mesh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//烘焙当前帧顶点数据</span>
        meshRenderer<span class="token punctuation">.</span><span class="token function">BakeMesh</span><span class="token punctuation">(</span>bakedMesh<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Vector3<span class="token punctuation">[</span><span class="token punctuation">]</span></span> vertices <span class="token operator">=</span> bakedMesh<span class="token punctuation">.</span>vertices<span class="token punctuation">;</span>

        <span class="token comment">// 写入纹理行（将没一帧顶点数据转换成color数据保存到图片）</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> frame <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> frame <span class="token operator">&lt;</span> meshRenderer<span class="token punctuation">.</span>sharedMesh<span class="token punctuation">.</span>vertexCount<span class="token punctuation">;</span> frame<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 超出原始顶点数的部分填充黑色</span>
            <span class="token class-name">Color</span> pixel <span class="token operator">=</span> Color<span class="token punctuation">.</span>black<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>frame <span class="token operator">&lt;=</span> vertices<span class="token punctuation">.</span>Length<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Vector3</span> pos <span class="token operator">=</span> vertices<span class="token punctuation">[</span>frame<span class="token punctuation">]</span><span class="token punctuation">;</span>
                pixel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Color</span><span class="token punctuation">(</span>pos<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pos<span class="token punctuation">.</span>y<span class="token punctuation">,</span> pos<span class="token punctuation">.</span>z<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            tex<span class="token punctuation">.</span><span class="token function">SetPixel</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> i<span class="token punctuation">,</span> pixel<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//x要设置的像素的 x 坐标。范围为 0 到（纹理宽度 - 1）,y要设置的像素的 y 坐标。范围为 0 到（纹理高度 - 1）,color要设置的颜色。</span>
            tex<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 可选：分批提交数据（当设置为 true 时，将重新计算多级渐进纹理级别）</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    tex<span class="token punctuation">.</span><span class="token function">Apply</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最终提交</span>
    tex<span class="token punctuation">.</span>name <span class="token operator">=</span> sourceObj<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token comment">//}</span>
    AssetDatabase<span class="token punctuation">.</span><span class="token function">CreateAsset</span><span class="token punctuation">(</span>tex<span class="token punctuation">,</span> <span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">MaterialTexturePath</span><span class="token punctuation">}</span></span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">sourceObj<span class="token punctuation">.</span>name</span><span class="token punctuation">}</span></span><span class="token string">_VerTex.asset"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AssetDatabase<span class="token punctuation">.</span><span class="token function">SaveAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    AssetDatabase<span class="token punctuation">.</span><span class="token function">Refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     我的动画计算出来是19帧，所以height为19像素
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/43335385b5a147a58e22e63466ca1305.png"/>
    </p>
    <h3>
     <a id="_381">
     </a>
     工具调用：
    </h3>
    <pre><code class="prism language-cs"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">UnityEditor</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">UnityEngine</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">static</span> <span class="token class-name">Unity<span class="token punctuation">.</span>VisualScripting<span class="token punctuation">.</span>Member</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BuildGpuAnimaEditorVertex</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">EditorWindow</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">MenuItem</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">"Tools/GPU动画处理工具(顶点动画)"</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">CreateSecetionData</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        EditorWindow<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetWindow</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>BuildGpuAnimaEditorVertex<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token string">"GPU动画处理工具(顶点动画)"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">private</span> <span class="token class-name">GameObject</span> source<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnGUI</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        EditorGUILayout<span class="token punctuation">.</span><span class="token function">BeginHorizontal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        EditorGUILayout<span class="token punctuation">.</span><span class="token function">LabelField</span><span class="token punctuation">(</span><span class="token string">"源资源:"</span><span class="token punctuation">,</span> GUILayout<span class="token punctuation">.</span><span class="token function">Width</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        source <span class="token operator">=</span> EditorGUILayout<span class="token punctuation">.</span><span class="token function">ObjectField</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> <span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">GameObject</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token class-name">GameObject</span><span class="token punctuation">;</span>
        EditorGUILayout<span class="token punctuation">.</span><span class="token function">EndHorizontal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        EditorGUILayout<span class="token punctuation">.</span><span class="token function">Space</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        EditorGUILayout<span class="token punctuation">.</span><span class="token function">LabelField</span><span class="token punctuation">(</span><span class="token string">"根据源资源生成对应动画数据贴图资源"</span><span class="token punctuation">,</span> GUILayout<span class="token punctuation">.</span><span class="token function">Width</span><span class="token punctuation">(</span><span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        EditorGUILayout<span class="token punctuation">.</span><span class="token function">Space</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>GUILayout<span class="token punctuation">.</span><span class="token function">Button</span><span class="token punctuation">(</span><span class="token string">"开始"</span><span class="token punctuation">,</span> GUILayout<span class="token punctuation">.</span><span class="token function">Height</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            CombineVertexTool<span class="token punctuation">.</span><span class="token function">CreateVertexAnimaSettingData</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        EditorGUILayout<span class="token punctuation">.</span><span class="token function">Space</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        EditorGUILayout<span class="token punctuation">.</span><span class="token function">LabelField</span><span class="token punctuation">(</span><span class="token string">"根据shader和模型生成材质贴图和合并网格"</span><span class="token punctuation">,</span> GUILayout<span class="token punctuation">.</span><span class="token function">Width</span><span class="token punctuation">(</span><span class="token number">240</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        EditorGUILayout<span class="token punctuation">.</span><span class="token function">Space</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>GUILayout<span class="token punctuation">.</span><span class="token function">Button</span><span class="token punctuation">(</span><span class="token string">"开始"</span><span class="token punctuation">,</span> GUILayout<span class="token punctuation">.</span><span class="token function">Height</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            CombineVertexTool<span class="token punctuation">.</span><span class="token function">CombineFilter</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="Shader_423">
     </a>
     Shader处理
    </h3>
    <p>
     需要添加 #pragma multi_compile_instancing开启GPU 实例化
     <br/>
     可以参考这位
     <a href="https://zhuanlan.zhihu.com/p/82102092" rel="nofollow">
      大佬讲解（UnityShader支持GPU Instance的方法）
     </a>
    </p>
    <pre><code class="prism language-cginc">Shader"XXX"{
    Properties{
        ...
    }
    SubShader{
        ...
        Pass{
            ...
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            #pragma multi_compile_instancing //这里,第一步
            ...
            struct a2v{
                ...
                UNITY_VERTEX_INPUT_INSTANCE_ID //这里,第二步
            };
            struct v2f{
                ...
                UNITY_VERTEX_INPUT_INSTANCE_ID //这里,第二步
            };
            v2f vert(a2v v){
                v2f o;
                UNITY_SETUP_INSTANCE_ID(v); //
  这里第三步
                UNITY_TRANSFER_INSTANCE_ID(v,o); //第三步
                ...
                return o;
            }
            fixed4 frag(v2f i):SV_Target{
                UNITY_SETUP_INSTANCE_ID(i); //最后一步
                ...
            }
            ENDCG
        }
    }
    FallBack"Diffuse"
}
</code></pre>
    <p>
     <strong>
      完整代码：
     </strong>
    </p>
    <pre><code class="prism language-shader">Shader "Unlit/yu2"
{
    Properties
    {
        _MainTex ("Texture", 2D) = "white" {} // 主纹理，用于基础颜色
        _AnimTex ("Texture", 2D) = "white" {}// 动画纹理，存储顶点位置
        _AnimTime ("AnimTime", float) = 1// 动画速度控制参数
    }
    SubShader
    {
        Tags { "RenderType"="Opaque" }// 不透明渲染类型
        LOD 100 // 细节层级
 
        Pass
        {
            CGPROGRAM
            #pragma target 3.5      //使用Shader Model 3.5
            #pragma vertex vert    // 顶点着色器
            #pragma fragment frag  // 像素着色器
            // make fog work
            #pragma multi_compile_instancing // 启用GPU实例化
 
            #include "UnityCG.cginc" //引用unity自带的UnityCG
 
            //顶点输入与输出结构
            struct appdata
            {
                float4 vertex : POSITION;
                float2 uv : TEXCOORD0;
                uint vid : SV_VERTEXID;
                UNITY_VERTEX_INPUT_INSTANCE_ID
            };
 
            struct v2f
            {
                float2 uv : TEXCOORD0;
                UNITY_FOG_COORDS(1)
                float4 vertex : SV_POSITION; //通过vid在动画纹理中定位顶点位置
                UNITY_VERTEX_INPUT_INSTANCE_ID
            };
 
            //CBUFFER_START 常量缓冲区：使用后才会允许支持我们的Shader被SRP Batcher（可编程渲染管线合批）允许，从而节省渲染上的性能
            CBUFFER_START(UnityPerMaterial)
            sampler2D _MainTex;
            sampler2D _AnimTex;
            //float4 _MainTex_ST;
            //必须在特殊命名的常量缓冲区中定义每个实例的属性。使用这对宏来包装对每个实例唯一的属性。
			UNITY_INSTANCING_BUFFER_START(Props)
				UNITY_DEFINE_INSTANCED_PROP(float4, _AnimTex_TexelSize)//_TexelSize 是一个内置变量，用于获取纹理的像素尺寸信息。这个变量是一个 Vector4，包含了纹理的宽度、高度以及它们的倒数 _AnimTex_TexelSize.xyzw = (1/width, 1/height, width, height)
				UNITY_DEFINE_INSTANCED_PROP(float4, _MainTex_ST)//是贴图_MainTex的tiling和offset的四元数,_MainTex_ST.xy 是tiling的值,_MainTex_ST.zw 是offset的值 在Material中可以设置的Tiling就是xy，Offset就是zw。
				UNITY_DEFINE_INSTANCED_PROP(float, _AnimTime)
			UNITY_INSTANCING_BUFFER_END(Props)
            CBUFFER_END
             
            //UNITY_ACCESS_INSTANCED_PROP : 从缓冲区中获取实例的属性值,arrayName与UNITY_INSTANCING_BUFFER_START(name)对应
            v2f vert (appdata v)
            {
                v2f o;
                UNITY_SETUP_INSTANCE_ID(v);
                UNITY_TRANSFER_INSTANCE_ID(v, o);// 仅当您要访问片元着色器中的实例化属性时才需要
                //为什么要加 0.5
                //像素中心对齐：避免采样时插值到相邻像素。数学原理：将顶点 ID 映射到纹理像素中心坐标。公式推导：纹理U坐标 = (顶点ID + 0.5) * (1.0 / 纹理宽度)
				float4 uv_anim = float4((v.vid + 0.5) * UNITY_ACCESS_INSTANCED_PROP(Props, _AnimTex_TexelSize).x, _Time.y / UNITY_ACCESS_INSTANCED_PROP(Props, _AnimTime),0.0,0.0);
                //tex2Dlod 函数,从动画纹理中读取顶点位置   参数说明 _AnimTex：存储顶点位置数据的纹理
                                                           //uv_anim.xy：计算得到的 UV 坐标
                                                           //uv_anim.zw：LOD 级别（此处设为 0）
				v.vertex = float4(tex2Dlod(_AnimTex, uv_anim).xyz,1.0);
                //v.vertex.y = v.vertex.y - 0.5;
                o.vertex = UnityObjectToClipPos(v.vertex);//模型空间转到屏幕裁切空间
                o.uv = v.uv * UNITY_ACCESS_INSTANCED_PROP(Props, _MainTex_ST).xy + UNITY_ACCESS_INSTANCED_PROP(Props, _MainTex_ST).zw; //就是将模型顶点的uv和Tiling、Offset两个变量进行运算，计算出实际显示用的定点uv。
                return o;
            }
 
            fixed4 frag (v2f i) : SV_Target
            {
                UNITY_SETUP_INSTANCE_ID(i);// 仅当要在片元着色器中访问任何实例化属性时才需要
                fixed4 col = tex2D(_MainTex, i.uv);//采样贴图
                return col;
            }
            ENDCG
        }
    }
}


</code></pre>
    <p>
     大部分参考和借鉴：
     <a href="https://blog.csdn.net/Zhidai_/article/details/126040983">
      [Unity] GPU动画实现1-5
     </a>
     这位大佬的文章
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="687474:70733a2f2f626c6f672e6373646e2e6e65742f514f5f47512f:61727469636c652f64657461696c732f313436323937353230" class_="artid" style="display:none">
 </p>
</div>


