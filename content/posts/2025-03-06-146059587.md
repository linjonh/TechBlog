---
layout: post
title: "Kafka-消息不丢失全方位保障策略"
date: 2025-03-06 09:41:01 +0800
description: "要确保 Kafka 消息不丢失，需要从生产者、Broker 和消费者三个层面进行综合考虑和配置。生产者通过合理设置确认机制和重试机制，Broker 利用多副本、最小同步副本数和刷盘策略，消费者采用手动提交偏移量和异常处理等方法，全方位保障消息的可靠传输。在实际应用中，需要根据具体的业务场景和性能要求，灵活调整这些配置，以达到消息可靠性和系统性能的平衡。"
keywords: "Kafka 消息不丢失：全方位保障策略"
categories: ['未分类']
tags: ['分布式', 'Linq', 'Kafka']
artid: "146059587"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146059587
    alt: "Kafka-消息不丢失全方位保障策略"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146059587
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146059587
cover: https://bing.ee123.net/img/rand?artid=146059587
image: https://bing.ee123.net/img/rand?artid=146059587
img: https://bing.ee123.net/img/rand?artid=146059587
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Kafka 消息不丢失：全方位保障策略
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2efd88d350b94c49b6e50d0c6838b813.png"/>
    </p>
    <h2>
     <a id="Kafka__2">
     </a>
     Kafka 消息不丢失：全方位保障策略
    </h2>
    <h3>
     <a id="_4">
     </a>
     引言
    </h3>
    <p>
     在现代分布式系统中，Kafka 作为一款高性能、高可扩展性的消息队列，被广泛应用于数据传输、日志收集、实时流处理等场景。然而，消息丢失是使用 Kafka 时可能面临的一个严重问题，这可能会导致数据不一致、业务逻辑错误等后果。因此，确保 Kafka 消息不丢失至关重要。本文将从生产者、Broker 和消费者三个层面详细介绍保障 Kafka 消息不丢失的方法。
    </p>
    <h3>
     <a id="_7">
     </a>
     生产者层面保障
    </h3>
    <h4>
     <a id="acks_9">
     </a>
     确认机制（acks）
    </h4>
    <p>
     生产者在发送消息时，
     <code>
      acks
     </code>
     参数决定了消息的确认机制，它有三个可选值：
    </p>
    <ul>
     <li>
      <strong>
       acks = 0
      </strong>
      ：生产者发送消息后，不等待 Broker 的确认，直接认为消息发送成功。这种方式虽然吞吐量最高，但存在消息丢失的风险。因为如果消息在传输过程中丢失，生产者无法得知。
     </li>
     <li>
      <strong>
       acks = 1
      </strong>
      ：生产者发送消息后，等待 Leader 分区的确认。只要 Leader 分区接收到消息并写入本地日志，就会给生产者返回确认信息。此方式能保证消息在 Leader 分区不丢失，但如果 Leader 分区在将消息同步到 Follower 分区之前发生故障，可能会导致消息丢失。
     </li>
     <li>
      <strong>
       acks = all 或 -1
      </strong>
      ：生产者发送消息后，等待 Leader 分区和所有 ISR（In - Sync Replicas，同步副本集合）中的 Follower 分区都确认收到消息后，才认为消息发送成功。这种方式能最大程度保证消息不丢失，但会降低吞吐量。
     </li>
    </ul>
    <p>
     以下是 Java 代码示例：
    </p>
    <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaProducerExample</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key.serializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value.serializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringSerializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置 acks 为 all</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"acks"</span><span class="token punctuation">,</span> <span class="token string">"all"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

        <span class="token class-name">Producer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"test - topic"</span><span class="token punctuation">,</span> <span class="token string">"key"</span><span class="token punctuation">,</span> <span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>record<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> metadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Failed to send message: "</span> <span class="token operator">+</span> exception<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Message sent successfully. Offset: "</span> <span class="token operator">+</span> metadata<span class="token punctuation">.</span><span class="token function">offset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_46">
     </a>
     重试机制
    </h4>
    <p>
     生产者可以设置
     <code>
      retries
     </code>
     参数来指定消息发送失败时的重试次数。当消息发送失败时，生产者会自动进行重试，直到达到重试次数上限。示例代码如下：
    </p>
    <pre><code class="prism language-java">props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"retries"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre>
    <h3>
     <a id="Broker__52">
     </a>
     Broker 层面保障
    </h3>
    <h4>
     <a id="_54">
     </a>
     多副本机制
    </h4>
    <p>
     Kafka 通过多副本机制保证消息的可靠性。每个分区可以有多个副本，其中一个是 Leader 副本，其余是 Follower 副本。生产者和消费者只与 Leader 副本进行交互，Follower 副本会从 Leader 副本同步消息。
     <br/>
     通过配置
     <code>
      replication.factor
     </code>
     参数来指定每个分区的副本数，建议将其设置为大于 1 的值，例如在
     <code>
      server.properties
     </code>
     中设置：
    </p>
    <pre><code class="prism language-properties">default.replication.factor = 3
</code></pre>
    <h4>
     <a id="mininsyncreplicas_61">
     </a>
     最小同步副本数（min.insync.replicas）
    </h4>
    <p>
     设置
     <code>
      min.insync.replicas
     </code>
     参数可以指定 ISR 集合中至少需要多少个副本同步消息，生产者才能认为消息发送成功。例如：
    </p>
    <pre><code class="prism language-properties">min.insync.replicas = 2
</code></pre>
    <p>
     当
     <code>
      acks = all
     </code>
     时，只有当 ISR 集合中至少有
     <code>
      min.insync.replicas
     </code>
     个副本同步了消息，生产者才会收到确认信息。
    </p>
    <h4>
     <a id="_68">
     </a>
     刷盘策略
    </h4>
    <p>
     可以通过调整
     <code>
      log.flush.interval.messages
     </code>
     和
     <code>
      log.flush.interval.ms
     </code>
     参数来控制消息刷盘的频率。例如：
    </p>
    <pre><code class="prism language-properties"># 每 10000 条消息刷一次盘
log.flush.interval.messages = 10000
# 每 1000 毫秒刷一次盘
log.flush.interval.ms = 1000
</code></pre>
    <h3>
     <a id="_77">
     </a>
     消费者层面保障
    </h3>
    <h4>
     <a id="_79">
     </a>
     手动提交偏移量
    </h4>
    <p>
     消费者可以通过设置
     <code>
      enable.auto.commit
     </code>
     为
     <code>
      false
     </code>
     来关闭自动提交偏移量功能，然后手动提交偏移量。只有在消息处理完成后，才提交偏移量，这样可以避免在消息处理过程中出现异常导致消息丢失。
    </p>
    <p>
     以下是 Java 代码示例：
    </p>
    <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collections</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">KafkaConsumerExample</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Properties</span> props <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"bootstrap.servers"</span><span class="token punctuation">,</span> <span class="token string">"localhost:9092"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"group.id"</span><span class="token punctuation">,</span> <span class="token string">"test - group"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"key.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"value.deserializer"</span><span class="token punctuation">,</span> <span class="token string">"org.apache.kafka.common.serialization.StringDeserializer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 关闭自动提交偏移量</span>
        props<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"enable.auto.commit"</span><span class="token punctuation">,</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

        <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> consumer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaConsumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
        consumer<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span><span class="token string">"test - topic"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">ConsumerRecords</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> records <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMillis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> record <span class="token operator">:</span> records<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Received message: key = %s, value = %s%n"</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 处理消息</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 手动提交偏移量</span>
                consumer<span class="token punctuation">.</span><span class="token function">commitSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            consumer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_119">
     </a>
     处理消费异常
    </h4>
    <p>
     在消费者处理消息的过程中，需要捕获并处理可能出现的异常，确保在异常情况下不会丢失消息。例如，在处理消息时可以使用事务机制，保证消息处理的原子性。
    </p>
    <h3>
     <a id="_122">
     </a>
     总结
    </h3>
    <p>
     要确保 Kafka 消息不丢失，需要从生产者、Broker 和消费者三个层面进行综合考虑和配置。生产者通过合理设置确认机制和重试机制，Broker 利用多副本、最小同步副本数和刷盘策略，消费者采用手动提交偏移量和异常处理等方法，全方位保障消息的可靠传输。在实际应用中，需要根据具体的业务场景和性能要求，灵活调整这些配置，以达到消息可靠性和系统性能的平衡。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031323734353439392f:61727469636c652f64657461696c732f313436303539353837" class_="artid" style="display:none">
 </p>
</div>


