---
layout: post
title: "IMX6ULL学习整理篇Linux驱动开发的基础2-老框架的一次实战LED驱动"
date: 2025-03-15 18:54:15 +0800
description: "​\t在上一篇博客中，我们实现了从0开始搭建的字符设备驱动框架，但是这个框架还是空中楼阁，没有应用，很难说明我们框架的正确性。这里，我们就准备好驱动正点原子开发板上的一个LED小灯外设。他被接在了GPIO01_IO03上。"
keywords: "IMX6ULL学习整理篇——Linux驱动开发的基础2 老框架的一次实战：LED驱动"
categories: ['从0开始的学习Armv7A', 'Imx']
tags: ['驱动开发', '教程', '学习', '字符设备', '内核', 'Linux']
artid: "146283675"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146283675
    alt: "IMX6ULL学习整理篇Linux驱动开发的基础2-老框架的一次实战LED驱动"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146283675
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146283675
cover: https://bing.ee123.net/img/rand?artid=146283675
image: https://bing.ee123.net/img/rand?artid=146283675
img: https://bing.ee123.net/img/rand?artid=146283675
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     IMX6ULL学习整理篇——Linux驱动开发的基础2 老框架的一次实战：LED驱动
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="IMX6ULLLinux2_LED_0">
     </a>
     IMX6ULL学习整理篇——Linux驱动开发的基础2 老框架的一次实战：LED驱动
    </h2>
    <p>
     ​ 在上一篇博客中，我们实现了从0开始搭建的字符设备驱动框架，但是这个框架还是空中楼阁，没有应用，很难说明我们框架的正确性。这里，我们就准备好驱动正点原子开发板上的一个LED小灯外设。他被接在了GPIO01_IO03上。
    </p>
    <h3>
     <a id="_4">
     </a>
     开始之前，复习一下架构体系对外设的地址处理
    </h3>
    <p>
     ​ 毫无疑问，任何一个搞过单片机的朋友都知道：在 ARM 架构中，外设的地址处理主要通过内存映射（Memory-Mapped I/O）方式进行。这意味着，外设的寄存器被映射到处理器的内存地址空间，CPU 可以像访问内存一样访问这些外设寄存器。这个技术连x86开始就在使用了！每个外设的寄存器都被分配了特定的物理地址，处理器通过读写这些地址来控制外设的操作。这种方式简化了处理器与外设之间的通信，因为不需要专门的 I/O 指令，统一了内存和外设的访问方式。
    </p>
    <p>
     ​ 当然，对于我们复杂的ARM芯片上的主板一般还有MMU内存管理单元。我们的地址访问都被认为是一个虚拟地址时，这个时候MMU 会根据页表将其转换为相应的物理地址。这不仅实现了内存的虚拟化，还允许操作系统为不同的应用程序提供独立的地址空间，提高了系统的安全性和稳定性。
    </p>
    <p>
     ​ 关于虚拟内存和物理内存，复习微机原理可以帮助你理解这些知识，笔者这里是驱动笔记整理，不是计算机体系架构笔记整理，所以请你自行翻阅相关的知识！
    </p>
    <p>
     ​ 这也就意味着，我们没法子直接拿物理地址访问我们的GPIO寄存器了，那咋办呢？答案是：Linux考虑到了这类情况，提供了一组API，让我们添加IO设备的外设地址映射，告诉我们我们操作的虚拟地址是哪个！
    </p>
    <h3>
     <a id="ioremapiounmap_14">
     </a>
     ioremap和iounmap函数
    </h3>
    <p>
     ​ 在 Linux 内核中，
     <code>
      ioremap
     </code>
     和
     <code>
      iounmap
     </code>
     函数用于在内核虚拟地址空间中映射和解除映射物理 I/O 内存区域，以便内核能够安全地访问硬件设备的寄存器或内存。
     <code>
      ioremap
     </code>
     函数用于将指定的物理地址范围映射到内核的虚拟地址空间，使内核能够通过虚拟地址访问对应的物理 I/O 内存区域。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> __iomem <span class="token operator">*</span><span class="token function">ioremap</span><span class="token punctuation">(</span><span class="token class-name">resource_size_t</span> phys_addr<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     ​ 其中：
     <code>
      phys_addr
     </code>
     是要映射的物理起始地址。
     <code>
      size
     </code>
     ：要映射的内存区域大小。成功时，返回指向映射后虚拟地址空间的指针；失败时，返回
     <code>
      NULL
     </code>
     。调用
     <code>
      ioremap
     </code>
     后，内核可以通过返回的虚拟地址指针访问对应的物理 I/O 内存区域。
    </p>
    <p>
     ​
     <code>
      iounmap
     </code>
     函数用于解除先前通过
     <code>
      ioremap
     </code>
     建立的映射关系，释放对应的虚拟地址空间。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">iounmap</span><span class="token punctuation">(</span><span class="token keyword">void</span> __iomem <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     ​ 这里的
     <code>
      addr
     </code>
     ：要解除映射的虚拟地址，即先前
     <code>
      ioremap
     </code>
     的返回值。调用
     <code>
      iounmap
     </code>
     后，内核将不再能够通过该虚拟地址访问对应的物理 I/O 内存区域。
    </p>
    <p>
     ​ 当然笔者提醒：
    </p>
    <ul>
     <li>
      在访问硬件设备的寄存器或内存时，必须先使用
      <code>
       ioremap
      </code>
      将物理地址映射到内核虚拟地址空间，然后通过返回的虚拟地址进行读写操作。
     </li>
     <li>
      在不再需要访问该 I/O 内存区域时，应调用
      <code>
       iounmap
      </code>
      解除映射，以释放资源。
     </li>
     <li>
      直接访问物理地址可能导致不可预期的行为，因此应始终通过
      <code>
       ioremap
      </code>
      和
      <code>
       iounmap
      </code>
      函数进行 I/O 内存的映射和解除映射。
     </li>
    </ul>
    <h3>
     <a id="readwriteIO_38">
     </a>
     read蔟函数和write蔟函数——操作我们的IO设备
    </h3>
    <p>
     ​ 拿到地址了，咋写呢？别自己手搓，我们的Linux还是给我们提供了API：在 Linux 内核中，
     <code>
      readb
     </code>
     、
     <code>
      readw
     </code>
     、
     <code>
      readl
     </code>
     以及
     <code>
      writeb
     </code>
     、
     <code>
      writew
     </code>
     、
     <code>
      writel
     </code>
     等函数用于在内存映射的 I/O 空间中读取和写入数据。
    </p>
    <p>
     <strong>
      读取操作函数：
      <code>
       readb
      </code>
      、
      <code>
       readw
      </code>
      、
      <code>
       readl
      </code>
      函数用于从内存映射的 I/O 空间读取 8 位、16 位和 32 位的数据。
     </strong>
    </p>
    <p>
     <code>
      readb
     </code>
     ：从指定的内存映射 I/O 地址读取 8 位（1 字节）数据。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token function">readb</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">volatile</span> <span class="token keyword">void</span> __iomem <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <code>
      readw
     </code>
     ：从指定的内存映射 I/O 地址读取 16 位（2 字节）数据。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">unsigned</span> <span class="token keyword">short</span> <span class="token function">readw</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">volatile</span> <span class="token keyword">void</span> __iomem <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <code>
      readl
     </code>
     ：从指定的内存映射 I/O 地址读取 32 位（4 字节）数据。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">readl</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">volatile</span> <span class="token keyword">void</span> __iomem <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      写入操作函数：
     </strong>
     <code>
      writeb
     </code>
     、
     <code>
      writew
     </code>
     、
     <code>
      writel
     </code>
     函数用于向内存映射的 I/O 空间写入 8 位、16 位和 32 位的数据。
    </p>
    <p>
     <code>
      writeb
     </code>
     ：向指定的内存映射 I/O 地址写入 8 位（1 字节）数据。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">writeb</span><span class="token punctuation">(</span>u8 value<span class="token punctuation">,</span> <span class="token keyword">volatile</span> <span class="token keyword">void</span> __iomem <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <code>
      writew
     </code>
     ：向指定的内存映射 I/O 地址写入 16 位（2 字节）数据。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">writew</span><span class="token punctuation">(</span>u16 value<span class="token punctuation">,</span> <span class="token keyword">volatile</span> <span class="token keyword">void</span> __iomem <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <code>
      writel
     </code>
     ：向指定的内存映射 I/O 地址写入 32 位（4 字节）数据。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">writel</span><span class="token punctuation">(</span>u32 value<span class="token punctuation">,</span> <span class="token keyword">volatile</span> <span class="token keyword">void</span> __iomem <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <code>
       addr
      </code>
      ：指向内存映射 I/O 空间中目标地址的指针。
     </li>
     <li>
      <code>
       value
      </code>
      ：要写入的数据。
     </li>
    </ul>
    <h3>
     <a id="_85">
     </a>
     编程，启动！
    </h3>
    <p>
     ​ 具体是啥地址，这个事情三个字：翻手册。没了，还不懂看如何裸机驱动LED，这就跟LKM驱动开发半毛钱关系没有了
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h&gt;</span>	</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;asm/io.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h&gt;</span></span>

<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"charliechen&lt;charliechen114514@demo.com&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_MAJOR_DEV_N</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">114</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_DEV_NAME</span>            <span class="token expression"><span class="token punctuation">(</span></span><span class="token string">"charlies_led"</span><span class="token expression"><span class="token punctuation">)</span></span></span>

<span class="token comment">/* 
    LED Physical Address 
        See the manual
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CCM_CCGR1_BASE</span>          <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x020C406C</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_IOLED_BASE</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x020E0068</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_IOPAD_BASE</span>        <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x020E02F4</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_IODR_BASE</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x0209C000</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">GPIO1_GDIR_BASE</span>         <span class="token expression"><span class="token punctuation">(</span><span class="token number">0x0209C004</span><span class="token punctuation">)</span></span></span>

<span class="token comment">/* mappings of the io phe*/</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LED_CCGR1<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDBASE<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDPAD_BASE<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDDR_BASE<span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span><span class="token operator">*</span> __iomem LEDGDIR_BASE<span class="token punctuation">;</span>

<span class="token comment">/* operations cached */</span>
<span class="token keyword">static</span> <span class="token keyword">char</span> operations_cached<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__led_turn_on</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u32 val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__led_turn_off</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u32 val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> u8 <span class="token function">__fetch_led_status</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u32 val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token punctuation">(</span>val <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__enable_led_mappings</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Ready to mappings the registers...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LED_CCGR1 <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>CCM_CCGR1_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDBASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_IOLED_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDPAD_BASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_IOPAD_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDDR_BASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_IODR_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    LEDGDIR_BASE <span class="token operator">=</span> <span class="token function">ioremap</span><span class="token punctuation">(</span>GPIO1_GDIR_BASE<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"mappings the registers done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LED_CCGR1     ioremap to: %p\n"</span><span class="token punctuation">,</span> LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDBASE       ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDBASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDPAD_BASE   ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDPAD_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDDR_BASE    ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LEDGDIR_BASE  ioremap to: %p\n"</span><span class="token punctuation">,</span> LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"initialize the led registers\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// clear the bits</span>
    val <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">writel</span><span class="token punctuation">(</span><span class="token number">0x5</span><span class="token punctuation">,</span> LEDBASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span><span class="token number">0x10B0</span><span class="token punctuation">,</span> LEDPAD_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    val <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    val <span class="token operator">|=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
    <span class="token function">writel</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"operations of led is accessable!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__disable_led_mappings</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">__led_turn_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"set the led turning off...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"set the led turning off done!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Ready to unmappings the registers...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LED_CCGR1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDBASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDPAD_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDDR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">iounmap</span><span class="token punctuation">(</span>LEDGDIR_BASE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"unmappings the registers done\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is opened!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">led_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">inode</span><span class="token operator">*</span> inode<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is released!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">led_read</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> 
                        <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token operator">*</span> ppos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> status <span class="token operator">=</span> <span class="token string">"opened"</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is reading!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__fetch_led_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> <span class="token string">"closed"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
    ret <span class="token operator">=</span> <span class="token function">copy_to_user</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> status<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Copy to the user failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>                        

<span class="token keyword">static</span> <span class="token class-name">ssize_t</span> <span class="token function">led_write</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">file</span><span class="token operator">*</span> filp<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> buffer<span class="token punctuation">,</span> 
    <span class="token class-name">size_t</span> count<span class="token punctuation">,</span> <span class="token class-name">loff_t</span><span class="token operator">*</span> ppos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> check <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"\nled device is ready writing!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    check <span class="token operator">=</span> <span class="token function">copy_from_user</span><span class="token punctuation">(</span>operations_cached<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>check <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Can not copy from user!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EFAULT<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>operations_cached<span class="token punctuation">,</span> <span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">__led_turn_on</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>operations_cached<span class="token punctuation">,</span> <span class="token string">"close"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">__led_turn_off</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"Can not find the indications operations!\n"</span>
                <span class="token string">"check the business: %s"</span><span class="token punctuation">,</span> operations_cached<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>   

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">file_operations</span> led_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>read <span class="token operator">=</span> led_read<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>write <span class="token operator">=</span> led_write<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>open <span class="token operator">=</span> led_open<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>release <span class="token operator">=</span> led_close
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">led_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LED Device is setting up\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token function">register_chrdev</span><span class="token punctuation">(</span>LED_MAJOR_DEV_N<span class="token punctuation">,</span> LED_DEV_NAME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>led_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"can not register the device!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EIO<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">__enable_led_mappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">led_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">unregister_chrdev</span><span class="token punctuation">(</span>LED_MAJOR_DEV_N<span class="token punctuation">,</span> LED_DEV_NAME<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">__disable_led_mappings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"LED Device is unhooked!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">module_init</span><span class="token punctuation">(</span>led_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>led_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="_282">
     </a>
     书写测试程序
    </h3>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ISSUE_BUFFER_N</span>      <span class="token expression"><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span></span></span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">display_help</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> app_name<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> 
        <span class="token string">"do: %s &lt;dev_file&gt; &lt;operations&gt;\n"</span>
        <span class="token string">"op: read : read the data from char dev\n"</span>
        <span class="token string">"op: write: write the data to char dev:\n"</span>
        <span class="token string">"   open: turn on the led\n"</span>
        <span class="token string">"   close: turn off the led\n"</span><span class="token punctuation">,</span> app_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> check <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">display_help</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">char</span><span class="token operator">*</span> filename <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    check <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> O_RDWR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>check <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Hey, Error in open filename: %s!\n"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// process reading issue</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"user process the read issue\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> buffer<span class="token punctuation">[</span>ISSUE_BUFFER_N<span class="token punctuation">]</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>check<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> ISSUE_BUFFER_N<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Hey, Error in read! filename: %s!\n"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> close_issue<span class="token punctuation">;</span>   
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"user receive from driver: %s\n"</span><span class="token punctuation">,</span> buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// done!</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"write"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// process the write</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"args: %d\n"</span><span class="token punctuation">,</span> argc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">display_help</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> close_issue<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"user process the write issue: %s\n"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> <span class="token function">write</span><span class="token punctuation">(</span>check<span class="token punctuation">,</span> argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Hey, Error in write! filename: %s!\n"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> close_issue<span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>    
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Unknown options!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">display_help</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> close_issue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

close_issue<span class="token operator">:</span>
    result <span class="token operator">=</span> <span class="token function">close</span><span class="token punctuation">(</span>check<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Hey, Error in close device! filename: %s!\n"</span><span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        
    <span class="token punctuation">}</span>        

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ​ 无比怀念CLI框架的一天.jpg
    </p>
    <p>
     ​ 下面我们测试一下：
    </p>
    <h3>
     <a id="_367">
     </a>
     测试
    </h3>
    <pre><code>/module_test # ls
chrdev_application  led.ko
/module_test # mknod /dev/ccled c 114 0
/module_test # insmod led.ko 
LED Device is setting up
Ready to mappings the registers...
mappings the registers done!
LED_CCGR1     ioremap to: f42c406c
LEDBASE       ioremap to: f42e0068
LEDPAD_BASE   ioremap to: f42e02f4
LEDDR_BASE    ioremap to: a092e000
LEDGDIR_BASE  ioremap to: a0936004
initialize the led registers
operations of led is accessable!
/module_test # ./chrdev_application /dev/ccled read

led device is opened!
user process the read issue
led device is reading!

user receive from driver: closed
led device is released!
v 
/module_test # ./chrdev_application /dev/ccled write open

led device is opened!
args: 4
led device is ready writing!

user process the write issue: o
led device is released!
pen
/module_test # ./chrdev_application /dev/ccled write close

led device is opened!
args: 4
user process the write issue: 
led device is ready writing!
close

led device is released!
/module_test # rmmod led.ko 
set the led turning off...
set the led turning off done!
Ready to unmappings the registers...
unmappings the registers done
LED Device is unhooked!
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/456d7e3e3fd34b7eb6d5511ae0ac26eb.jpeg#pic_center">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/00f72f0e85424a35b7c85c0e1d47fea7.jpeg#pic_center"/>
     </img>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e63:73646e2e6e65742f636861726c69653131343531343139312f:61727469636c652f64657461696c732f313436323833363735" class_="artid" style="display:none">
 </p>
</div>


