---
layout: post
title: "Redis-源码分析-内部数据结构-quicklist"
date: 2025-03-14 13:55:07 +0800
description: "quicklist 是 Redis 对外暴露的 list 数据结构的内部实现，经常被当作队列或栈使用，最常用的操作就是在两端进行增删，那么如何优雅的使用链表来进行实现呢？链表中指向前驱节点和后向节点的指针能不能省略？如何兼顾内存碎片和查找性能呢？"
keywords: "Redis 源码分析-内部数据结构 quicklist"
categories: ['Redis']
tags: ['链表', '数据结构', '数据库', '快速链表', 'Ziplist', 'Redis', 'Quicklist']
artid: "146255817"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146255817
    alt: "Redis-源码分析-内部数据结构-quicklist"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146255817
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146255817
cover: https://bing.ee123.net/img/rand?artid=146255817
image: https://bing.ee123.net/img/rand?artid=146255817
img: https://bing.ee123.net/img/rand?artid=146255817
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Redis 源码分析-内部数据结构 quicklist
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="Redis__quicklist_0">
     </a>
     Redis 源码分析-内部数据结构 quicklist
    </h2>
    <p>
     quicklist 是 Redis 对外暴露的 list 数据结构的内部实现，经常被当作队列或栈使用，我们可以从常用的一些 api 上先思考一下它的结构
    </p>
    <p>
     最常用的就是 lpush、lpop、rpush、rpop，同时它也支持 lindex 查询某元素在 list 中的索引，linsert 在指定元素旁边插入新元素。
    </p>
    <p>
     从头、尾节点的 push、pop 来看，这就是双向链表最优秀的设计，提供头尾节点的 O(1) 复杂度操作，但在
     <a href="https://blog.csdn.net/qq_56517253/article/details/146232853">
      ziplist
     </a>
     篇我提到了，普通的链表每个节点都需要一个前驱和后向指针，空间利用率低；且在链表元素过多时查询缓慢，ziplist 让每一个 entry 都存了上一个 entry 和自己的长度，用来实现双向遍历，节省了一些空间，但缺点是增加、修改元素时可能会带来更大的内存拷贝。
    </p>
    <p>
     有没有办法进行一个时间和空间的权衡呢？quicklist 就是这样设计的
    </p>
    <p>
     <code>
      A doubly linked list of ziplists
     </code>
    </p>
    <p>
     一个 ziplist 的双向链表
    </p>
    <p>
     那么每个 ziplist 存多少数据合适呢？比如我有 20 个元素，可以 4 个 ziplist，每个 ziplist 里 5 个元素；也可以 5 个 ziplist，每个 ziplist 里 4 个元素
    </p>
    <ul>
     <li>
      ziplist 的元素越多，进行操作时候需要内存拷贝的空间就越多，如果整个 quicklist 只有一个 ziplist 节点，那么其实就退化成了一个 ziplist 了
     </li>
     <li>
      ziplist 的元素越少，就需要更多的节点，空间利用率低，更容易产生内存碎片，如果每个 ziplist 只有一个元素，quicklist 就退化成一个普通的双向链表了
     </li>
    </ul>
    <p>
     redis 提供了一个这样的配置项
    </p>
    <pre><code class="prism language-c">list<span class="token operator">-</span>max<span class="token operator">-</span>ziplist<span class="token operator">-</span>size <span class="token comment">// 默认-2</span>
</code></pre>
    <p>
     当取正值的时候，表示按照数据项个数来限定每个 quicklist 节点上的 ziplist 长度。比如，当这个参数配置成 5的时候，表示每个 quicklist 节点的 ziplist 最多包含 5 个数据项。
    </p>
    <p>
     当取负值的时候，表示按照占用字节数来限定每个 quicklist 节点上的 ziplist 长度。这时，它只能取 -1 到 -5 这五个值，每个值含义如下：
    </p>
    <ul>
     <li>
      -5: 每个quicklist节点上的ziplist大小不能超过64 Kb
     </li>
     <li>
      -4: 每个quicklist节点上的ziplist大小不能超过32 Kb
     </li>
     <li>
      -3: 每个quicklist节点上的ziplist大小不能超过16 Kb
     </li>
     <li>
      -2: 每个quicklist节点上的ziplist大小不能超过8 Kb（Redis 默认值）
     </li>
     <li>
      -1: 每个quicklist节点上的ziplist大小不能超过4 Kb
     </li>
    </ul>
    <h3>
     <a id="quicklist_37">
     </a>
     quicklist
    </h3>
    <pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">quicklist</span> <span class="token punctuation">{<!-- --></span>
    quicklistNode <span class="token operator">*</span>head<span class="token punctuation">;</span>
    quicklistNode <span class="token operator">*</span>tail<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> count<span class="token punctuation">;</span>        <span class="token comment">/* total count of all entries in all ziplists */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">;</span>           <span class="token comment">/* number of quicklistNodes */</span>
    <span class="token keyword">int</span> fill <span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">;</span>              <span class="token comment">/* fill factor for individual nodes */</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> compress <span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token comment">/* depth of end nodes not to compress;0=off */</span>
<span class="token punctuation">}</span> quicklist<span class="token punctuation">;</span>
</code></pre>
    <p>
     和我们认知里的双向链表一样：
    </p>
    <ul>
     <li>
      head 头节点指针
     </li>
     <li>
      tail 尾节点指针
     </li>
     <li>
      count 整个 quicklist 中的元素数量
     </li>
     <li>
      len ziplist 的数量
     </li>
     <li>
      fill: 16bit，ziplist大小设置，存放
      <code>
       list-max-ziplist-size
      </code>
      参数的值
     </li>
     <li>
      compress: 16bit，节点压缩深度设置，存放
      <code>
       list-compress-depth
      </code>
      参数的值
     </li>
    </ul>
    <p>
     <code>
      list-max-ziplist-size
     </code>
     的值在最上面已经解释过含义了，
     <code>
      list-compress-depth
     </code>
     是出于这样的考虑：
    </p>
    <p>
     当列表很长的时候，最容易被访问的很可能是两端的数据，中间的数据被访问的频率比较低，所以 redis 提供了该选项选择压缩的中间数据，取值含义如下：
    </p>
    <ul>
     <li>
      0: 是个特殊值，表示都不压缩。这是Redis的默认值。
     </li>
     <li>
      1: 表示quicklist两端各有1个节点不压缩，中间的节点压缩。
     </li>
     <li>
      2: 表示quicklist两端各有2个节点不压缩，中间的节点压缩。
     </li>
     <li>
      3: 表示quicklist两端各有3个节点不压缩，中间的节点压缩。
     </li>
    </ul>
    <p>
     注意，两个端点（头、尾）是不会压缩的
    </p>
    <h3>
     <a id="quicklistNode_72">
     </a>
     quicklistNode
    </h3>
    <p>
     quicklistNode 是每一个 quicklist 节点的数据结构
    </p>
    <pre><code class="prism language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">quicklistNode</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">quicklistNode</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span>     <span class="token comment">// 前一个节点</span>
    <span class="token keyword">struct</span> <span class="token class-name">quicklistNode</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>     <span class="token comment">// 下一个节点</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>zl<span class="token punctuation">;</span>              <span class="token comment">// 数据指针。如果当前节点的数据没有压缩，那么它指向一个 ziplist 结构</span>
                                    <span class="token comment">// 否则，它指向一个quicklistLZF 结构。</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> sz<span class="token punctuation">;</span>                <span class="token comment">// zl 指向的 ziplist 的总大小（包括数据项和 zlbytes 等）</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> count<span class="token operator">:</span> <span class="token number">16</span><span class="token punctuation">;</span>         <span class="token comment">// ziplist 里面包含的数据项个数 2 字节</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> encoding<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>       <span class="token comment">// 目前只有 1/2 取值 分别代表没压缩和 LZF 压缩</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> container<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">;</span>      <span class="token comment">// 目前只有 2 取值，本意是取 1 代表节点直接存数据，取 2 代表使用 ziplist 存数据</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> recompress<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>     <span class="token comment">// 当我们使用 index 等命令查看到了已经被压缩的数据，需要暂时解压，再设置标记为合适的时候压缩回去</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> attempted_compress<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 自动化测试使用</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> extra<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">;</span>         <span class="token comment">// 拓展字段，暂时没用上</span>
<span class="token punctuation">}</span> quicklistNode<span class="token punctuation">;</span>

<span class="token comment">// 一个被压缩过的 ziplist</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">quicklistLZF</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> sz<span class="token punctuation">;</span>    <span class="token comment">// 压缩后的 ziplist 大小</span>
    <span class="token keyword">char</span> compressed<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 柔性数组（flexible array member），存放压缩后的 ziplist 字节数组</span>
<span class="token punctuation">}</span> quicklistLZF<span class="token punctuation">;</span>
</code></pre>
    <p>
     以下是某一时刻一个 quicklist 的示意图：
    </p>
    <pre><code class="prism language-c">list<span class="token operator">-</span>max<span class="token operator">-</span>ziplist<span class="token operator">-</span>size <span class="token number">3</span>
list<span class="token operator">-</span>compress<span class="token operator">-</span>depth <span class="token number">2</span>
</code></pre>
    <p>
     <img alt="Redis quicklist 结构图" src="https://i-blog.csdnimg.cn/img_convert/528c254a597394fe7d15ed3fd00b53a9.png"/>
    </p>
    <ul>
     <li>
      两端各有 2。橙黄色节点没有被压缩，对应 list-compress-depth 为 2
     </li>
     <li>
      第二个节点和倒数第二个节点，都是元素数量为 3 的 ziplist，对应 list-max-ziplist-size
     </li>
    </ul>
    <h3>
     <a id="_112">
     </a>
     代码分析
    </h3>
    <ol>
     <li>
      创建函数
     </li>
    </ol>
    <pre><code class="prism language-c">quicklist <span class="token operator">*</span><span class="token function">quicklistNew</span><span class="token punctuation">(</span><span class="token keyword">int</span> fill<span class="token punctuation">,</span> <span class="token keyword">int</span> compress<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    quicklist <span class="token operator">*</span>quicklist <span class="token operator">=</span> <span class="token function">quicklistCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将两个 option 设置到 quicklist 中</span>
    <span class="token function">quicklistSetOptions</span><span class="token punctuation">(</span>quicklist<span class="token punctuation">,</span> fill<span class="token punctuation">,</span> compress<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> quicklist<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

quicklist <span class="token operator">*</span><span class="token function">quicklistCreate</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">quicklist</span> <span class="token operator">*</span>quicklist<span class="token punctuation">;</span>
    quicklist <span class="token operator">=</span> <span class="token function">zmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>quicklist<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 初始化时 头尾节点都为 null</span>
    quicklist<span class="token operator">-&gt;</span>head <span class="token operator">=</span> quicklist<span class="token operator">-&gt;</span>tail <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    quicklist<span class="token operator">-&gt;</span>len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    quicklist<span class="token operator">-&gt;</span>count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    quicklist<span class="token operator">-&gt;</span>compress <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>		<span class="token comment">// 压缩深度</span>
    quicklist<span class="token operator">-&gt;</span>fill <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>			<span class="token comment">// 单个 ziplist 最多 8 字节</span>
    <span class="token keyword">return</span> quicklist<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     创建函数其实很简单，只是按照默认值初始化，并把配置项的值放入到 quicklist 对应的 compress、fill 字段上
    </p>
    <p>
     其他操作复杂的原因在于，比如插入操作过程中要判断是否达到了配置的值，达到的话需要创建新的 node 节点（包括 ziplist ）；删除操作如果 ziplist 为空了，那么对应的头部或尾部节点也要删除，还可能涉及到里面节点的解压缩问题…
    </p>
    <ol start="2">
     <li>
      在指定节点插入（lpush、rpush 最终都会调用到这个函数）
     </li>
    </ol>
    <pre><code class="prism language-c"><span class="token comment">// 在 quicklist 的指定位置插入元素，根据 after 判断在前还是在后</span>
REDIS_STATIC <span class="token keyword">void</span> <span class="token function">__quicklistInsertNode</span><span class="token punctuation">(</span>quicklist <span class="token operator">*</span>quicklist<span class="token punctuation">,</span>
                                        quicklistNode <span class="token operator">*</span>old_node<span class="token punctuation">,</span>
                                        quicklistNode <span class="token operator">*</span>new_node<span class="token punctuation">,</span> <span class="token keyword">int</span> after<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>after<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        new_node<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> old_node<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>old_node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            new_node<span class="token operator">-&gt;</span>next <span class="token operator">=</span> old_node<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>old_node<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span>
                old_node<span class="token operator">-&gt;</span>next<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> new_node<span class="token punctuation">;</span>
            old_node<span class="token operator">-&gt;</span>next <span class="token operator">=</span> new_node<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果插入在之后且 old_node 是尾节点,更新尾节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>quicklist<span class="token operator">-&gt;</span>tail <span class="token operator">==</span> old_node<span class="token punctuation">)</span>
            quicklist<span class="token operator">-&gt;</span>tail <span class="token operator">=</span> new_node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        new_node<span class="token operator">-&gt;</span>next <span class="token operator">=</span> old_node<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>old_node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            new_node<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> old_node<span class="token operator">-&gt;</span>prev<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>old_node<span class="token operator">-&gt;</span>prev<span class="token punctuation">)</span>
                old_node<span class="token operator">-&gt;</span>prev<span class="token operator">-&gt;</span>next <span class="token operator">=</span> new_node<span class="token punctuation">;</span>
            old_node<span class="token operator">-&gt;</span>prev <span class="token operator">=</span> new_node<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果插入在之前且 old_node 是头节点,更新头节点</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>quicklist<span class="token operator">-&gt;</span>head <span class="token operator">==</span> old_node<span class="token punctuation">)</span>
            quicklist<span class="token operator">-&gt;</span>head <span class="token operator">=</span> new_node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// 为空时初始化头尾指针</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>quicklist<span class="token operator">-&gt;</span>len <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        quicklist<span class="token operator">-&gt;</span>head <span class="token operator">=</span> quicklist<span class="token operator">-&gt;</span>tail <span class="token operator">=</span> new_node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>old_node<span class="token punctuation">)</span>
        <span class="token function">quicklistCompress</span><span class="token punctuation">(</span>quicklist<span class="token punctuation">,</span> old_node<span class="token punctuation">)</span><span class="token punctuation">;</span>

    quicklist<span class="token operator">-&gt;</span>len<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <ol start="3">
     <li>
      push 操作
     </li>
    </ol>
    <p>
     在调用这个函数前，会根据操作是 lpush 还是 rpush 确定 where 是头还是尾
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">quicklistPush</span><span class="token punctuation">(</span>quicklist <span class="token operator">*</span>quicklist<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">size_t</span> sz<span class="token punctuation">,</span> <span class="token keyword">int</span> where<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>where <span class="token operator">==</span> QUICKLIST_HEAD<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">quicklistPushHead</span><span class="token punctuation">(</span>quicklist<span class="token punctuation">,</span> value<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>where <span class="token operator">==</span> QUICKLIST_TAIL<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">quicklistPushTail</span><span class="token punctuation">(</span>quicklist<span class="token punctuation">,</span> value<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     头插
    </p>
    <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">quicklistPushHead</span><span class="token punctuation">(</span>quicklist <span class="token operator">*</span>quicklist<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">,</span> <span class="token class-name">size_t</span> sz<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    quicklistNode <span class="token operator">*</span>orig_head <span class="token operator">=</span> quicklist<span class="token operator">-&gt;</span>head<span class="token punctuation">;</span>
    <span class="token comment">// 可以直接插入</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span>
            <span class="token function">_quicklistNodeAllowInsert</span><span class="token punctuation">(</span>quicklist<span class="token operator">-&gt;</span>head<span class="token punctuation">,</span> quicklist<span class="token operator">-&gt;</span>fill<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 当前节点插入到头节点对应的 ziplist 的头部</span>
        quicklist<span class="token operator">-&gt;</span>head<span class="token operator">-&gt;</span>zl <span class="token operator">=</span>
                <span class="token function">ziplistPush</span><span class="token punctuation">(</span>quicklist<span class="token operator">-&gt;</span>head<span class="token operator">-&gt;</span>zl<span class="token punctuation">,</span> value<span class="token punctuation">,</span> sz<span class="token punctuation">,</span> ZIPLIST_HEAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 更新新节点指向的 ziplist 的总大小</span>
        <span class="token function">quicklistNodeUpdateSz</span><span class="token punctuation">(</span>quicklist<span class="token operator">-&gt;</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建新的 node 节点</span>
        quicklistNode <span class="token operator">*</span>node <span class="token operator">=</span> <span class="token function">quicklistCreateNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建对应的 ziplist，并把新元素插入到头</span>
        node<span class="token operator">-&gt;</span>zl <span class="token operator">=</span> <span class="token function">ziplistPush</span><span class="token punctuation">(</span><span class="token function">ziplistNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> sz<span class="token punctuation">,</span> ZIPLIST_HEAD<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 更新新节点指向的 ziplist 的总大小</span>
        <span class="token function">quicklistNodeUpdateSz</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 把当前节点插入到原头节点的前面</span>
        <span class="token function">_quicklistInsertNodeBefore</span><span class="token punctuation">(</span>quicklist<span class="token punctuation">,</span> quicklist<span class="token operator">-&gt;</span>head<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 总数据项 + 1</span>
    quicklist<span class="token operator">-&gt;</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token comment">// 头节点的里的元素数量 + 1</span>
    quicklist<span class="token operator">-&gt;</span>head<span class="token operator">-&gt;</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>orig_head <span class="token operator">!=</span> quicklist<span class="token operator">-&gt;</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

REDIS_STATIC <span class="token keyword">void</span> <span class="token function">_quicklistInsertNodeBefore</span><span class="token punctuation">(</span>quicklist <span class="token operator">*</span>quicklist<span class="token punctuation">,</span>
                                             quicklistNode <span class="token operator">*</span>old_node<span class="token punctuation">,</span>
                                             quicklistNode <span class="token operator">*</span>new_node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">__quicklistInsertNode</span><span class="token punctuation">(</span>quicklist<span class="token punctuation">,</span> old_node<span class="token punctuation">,</span> new_node<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     尾插
    </p>
    <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">quicklistPushTail</span><span class="token punctuation">(</span>quicklist <span class="token operator">*</span>quicklist<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">,</span> <span class="token class-name">size_t</span> sz<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    quicklistNode <span class="token operator">*</span>orig_tail <span class="token operator">=</span> quicklist<span class="token operator">-&gt;</span>tail<span class="token punctuation">;</span>
    <span class="token comment">// 是否可以直接插入</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span>
            <span class="token function">_quicklistNodeAllowInsert</span><span class="token punctuation">(</span>quicklist<span class="token operator">-&gt;</span>tail<span class="token punctuation">,</span> quicklist<span class="token operator">-&gt;</span>fill<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        quicklist<span class="token operator">-&gt;</span>tail<span class="token operator">-&gt;</span>zl <span class="token operator">=</span>
                <span class="token function">ziplistPush</span><span class="token punctuation">(</span>quicklist<span class="token operator">-&gt;</span>tail<span class="token operator">-&gt;</span>zl<span class="token punctuation">,</span> value<span class="token punctuation">,</span> sz<span class="token punctuation">,</span> ZIPLIST_TAIL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">quicklistNodeUpdateSz</span><span class="token punctuation">(</span>quicklist<span class="token operator">-&gt;</span>tail<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        quicklistNode <span class="token operator">*</span>node <span class="token operator">=</span> <span class="token function">quicklistCreateNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node<span class="token operator">-&gt;</span>zl <span class="token operator">=</span> <span class="token function">ziplistPush</span><span class="token punctuation">(</span><span class="token function">ziplistNew</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">,</span> sz<span class="token punctuation">,</span> ZIPLIST_TAIL<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">quicklistNodeUpdateSz</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 把当前节点插入到原尾节点的后面</span>
        <span class="token function">_quicklistInsertNodeAfter</span><span class="token punctuation">(</span>quicklist<span class="token punctuation">,</span> quicklist<span class="token operator">-&gt;</span>tail<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 更新当前 quicklist 中的元素总数和尾节点对应 ziplist 中的元素数量</span>
    quicklist<span class="token operator">-&gt;</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
    quicklist<span class="token operator">-&gt;</span>tail<span class="token operator">-&gt;</span>count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>orig_tail <span class="token operator">!=</span> quicklist<span class="token operator">-&gt;</span>tail<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

REDIS_STATIC <span class="token keyword">void</span> <span class="token function">_quicklistInsertNodeAfter</span><span class="token punctuation">(</span>quicklist <span class="token operator">*</span>quicklist<span class="token punctuation">,</span>
                                            quicklistNode <span class="token operator">*</span>old_node<span class="token punctuation">,</span>
                                            quicklistNode <span class="token operator">*</span>new_node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">__quicklistInsertNode</span><span class="token punctuation">(</span>quicklist<span class="token punctuation">,</span> old_node<span class="token punctuation">,</span> new_node<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     lpush 和 rpush 的逻辑几乎是一样的，而对其进行压缩，是在
     <code>
      __quicklistInsertNode
     </code>
     函数的
     <code>
      quicklistCompress
     </code>
     函数中…
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f35363531373235332f:61727469636c652f64657461696c732f313436323535383137" class_="artid" style="display:none">
 </p>
</div>


