---
layout: post
title: "C通过API接口返回流式响应内容-分块编码方式"
date: 2025-03-14 21:44:20 +0800
description: "阐述C#通过分块编码的方式实现流式响应，实现DeepSeek的回复效果"
keywords: "C#通过API接口返回流式响应内容---分块编码方式"
categories: ['.NET']
tags: ['流式响应Api', 'Deepseek']
artid: "146267346"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146267346
    alt: "C通过API接口返回流式响应内容-分块编码方式"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146267346
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146267346
cover: https://bing.ee123.net/img/rand?artid=146267346
image: https://bing.ee123.net/img/rand?artid=146267346
img: https://bing.ee123.net/img/rand?artid=146267346
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     C#通过API接口返回流式响应内容---分块编码方式
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="1_0">
     </a>
     1、背景
    </h2>
    <p>
     上一篇文章《
     <a href="https://blog.csdn.net/zlbcdn/article/details/146249023">
      C#通过API接口返回流式响应内容—SSE方式
     </a>
     》阐述了通过SSE（Server Send Event）方式，由服务器端推送数据到浏览器。本篇是通过分块编码的方式实现
    </p>
    <h2>
     <a id="2_2">
     </a>
     2、效果
    </h2>
    <p>
     <img alt="在这里插入图片描述" height="260" src="https://i-blog.csdnimg.cn/direct/b519121345684a63b3fed5c338bcf1a7.gif#pic_center"/>
    </p>
    <h2>
     <a id="3_4">
     </a>
     3、具体代码
    </h2>
    <h3>
     <a id="31_API_5">
     </a>
     3.1 API端实现
    </h3>
    <pre><code class="prism language-csharp"><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token return-type class-name">Task</span> <span class="token function">ChunkedResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Response<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">"text/plain"</span><span class="token punctuation">;</span>
    Response<span class="token punctuation">.</span>Headers<span class="token punctuation">[</span><span class="token string">"Transfer-Encoding"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"chunked"</span><span class="token punctuation">;</span> <span class="token comment">//设置编码传输方式</span>
    Response<span class="token punctuation">.</span>Headers<span class="token punctuation">[</span><span class="token string">"Access-Control-Allow-Origin"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"*"</span><span class="token punctuation">;</span> <span class="token comment">//可以实现跨域访问</span>

    <span class="token comment">//模拟DeepSeek的返回内容</span>
    <span class="token class-name"><span class="token keyword">var</span></span> phrases <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{<!-- --></span> <span class="token string">"你好！"</span><span class="token punctuation">,</span> <span class="token string">"我是"</span><span class="token punctuation">,</span> <span class="token string">"北京清华长庚医院"</span><span class="token punctuation">,</span> <span class="token string">"信息管理部的"</span><span class="token punctuation">,</span> <span class="token string">"郑林"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> phrases<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1、将内容转为UTF-8编码</span>
        <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> sendContentArray <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>phrases<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//2、内容的长度</span>
        <span class="token class-name"><span class="token keyword">var</span></span> sendContentLength <span class="token operator">=</span> sendContentArray<span class="token punctuation">.</span>Length<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token string">"X"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//转为16进制的标识</span>

        <span class="token comment">//3、将长度内容写入到Response中</span>
        <span class="token class-name"><span class="token keyword">var</span></span> chunkedContentLength <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">sendContentLength</span><span class="token punctuation">}</span></span><span class="token string">\r\n"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> Response<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>chunkedContentLength<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> chunkedContentLength<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//4、将内容与CRLF(\r\n)一起写入Response中</span>
        <span class="token class-name"><span class="token keyword">var</span></span> chunkedContentArray <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">phrases<span class="token punctuation">[</span>i<span class="token punctuation">]</span></span><span class="token punctuation">}</span></span><span class="token string">\r\n"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> Response<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>chunkedContentArray<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> chunkedContentArray<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">await</span> Response<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">FlushAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 强制发送数据块</span>
        <span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 每块之间的延时</span>
    <span class="token punctuation">}</span>
	
		<span class="token comment">//5、将数据终止标识写入到响应</span>
    <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> endLenghtBuffer <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token string">"0\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> Response<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>endLenghtBuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> endLenghtBuffer<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> endDataBuffer <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> Response<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>endDataBuffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> endDataBuffer<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> Response<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">FlushAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//强制发送数据块</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="32__47">
     </a>
     3.2 浏览器端的代码
    </h3>
    <pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> 
<span class="token attr-name">&lt;meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>utf-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>viewport<span class="token punctuation">"</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>width=device-width, initial-scale=1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>文档标题<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
     <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">'http://localhost:5105/api/Stream/ChunkedResponse'</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">response</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'异常发生！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token keyword">return</span> response<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">stream</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'进入方法'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> reader <span class="token operator">=</span> stream<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> decoder <span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">TextDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> contentDiv <span class="token operator">=</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'content'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">function</span> <span class="token function">readChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            reader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{<!-- --></span> value<span class="token punctuation">,</span> done <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'读取结束！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">var</span> contentserver<span class="token operator">=</span>decoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>value<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token literal-property property">stream</span><span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//解析数据</span>
                contentDiv<span class="token punctuation">.</span>innerHTML<span class="token operator">+=</span> contentserver <span class="token operator">+</span><span class="token string">'&amp;nbsp;'</span><span class="token punctuation">;</span> <span class="token comment">//将内容追加到界面中</span>
                <span class="token function">readChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//递归读取数据</span>
                <span class="token comment">//setTimeout(readChunk, 100); // 也可以使用延时1秒后继续读取下一个数据块。但没有区别，大家可以试试</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token function">readChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 启动读取流程</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
 
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h2>
     <a id="4_97">
     </a>
     4、原理
    </h2>
    <h3>
     <a id="41__98">
     </a>
     4.1 代码解释
    </h3>
    <p>
     服务器端的返回（就是响应（Response））中分块编码的
     <code>
      样例
     </code>
     如下：
    </p>
    <pre><code class="prism language-html">HTTP/1.1 200 OK
Content-Type: text/plain
Transfer-Encoding: chunked

25\r\n
This is the data in the first chunk\r\n

1C\r\n
and this is the second one\r\n

0\r\n
\r\n 
</code></pre>
    <p>
     这里面包含3部分的信息
     <br/>
     1、响应头信息中包含：
     <code>
      Content-Type: text/plain
     </code>
     以及
     <code>
      Transfer-Encoding: chunked
     </code>
     ，因此在API的代码中使用了：
    </p>
    <pre><code class="prism language-csharp">Response<span class="token punctuation">.</span>ContentType <span class="token operator">=</span> <span class="token string">"text/plain"</span><span class="token punctuation">;</span>
Response<span class="token punctuation">.</span>Headers<span class="token punctuation">[</span><span class="token string">"Transfer-Encoding"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"chunked"</span><span class="token punctuation">;</span> <span class="token comment">//设置编码传输方式</span>
</code></pre>
    <p>
     2、分块编码的数据，是放在body中，并且满足如下规则
    </p>
    <pre><code class="prism language-csharp"><span class="token punctuation">[</span>长度<span class="token punctuation">]</span>\r\n
<span class="token punctuation">[</span>数据<span class="token punctuation">]</span>\r\n
</code></pre>
    <p>
     （1）有两行，第一行表示长度、第二行表示数据
     <br/>
     （2）长度为
     <code>
      十六进制
     </code>
     的数字，代表第二行数据的
     <code>
      length
     </code>
     【注意不包括
     <code>
      \r\n
     </code>
     】
     <br/>
     （3）每行的最后都必须有
     <code>
      CRLF(\r\n)
     </code>
     <br/>
     （4）整个数据的最后，要以
     <code>
      0
     </code>
     为结尾，告知服务器，数据已经结束。即上面样例中的：
    </p>
    <pre><code class="prism language-csharp"><span class="token number">0</span>\r\n
\r\n 
</code></pre>
    <p>
     3、英文字符与中文字符的长度不一样，因此需要进行
     <code>
      utf-8
     </code>
     编码后，统一计算长度
    </p>
    <h3>
     <a id="42__136">
     </a>
     4.2 前端代码说明
    </h3>
    <p>
     <code>
      Fetch API
     </code>
     是现代 Web 开发中的一个重要组成部分，它提供了一种简单且一致的方式来访问网络资源。我们要读取的内容就是Response的body，在浏览器中Response.Body是ReadableStream对象，因此可以按照流对象处理方式既可。为了实现流式输出，可以使用TransformStream 类来处理数据流，也可以使用TextDecoder直接解析。两者的却别是：前者返回一个Uint8Array数组；后者直接解析数据，更加便捷。详细的可以参考第二个参考材料。
    </p>
    <h2>
     <a id="5_138">
     </a>
     5、参考资料
    </h2>
    <p>
     <a href="https://www.cnblogs.com/xuehaoyue/p/6639029.html" rel="nofollow">
      1、分块编码（Transfer-Encoding: chunked）
     </a>
     <br/>
     <a href="https://blog.csdn.net/jyl4855/article/details/136484042">
      2、fetch实现流式输出的实现原理
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f7a6c6263646e2f:61727469636c652f64657461696c732f313436323637333436" class_="artid" style="display:none">
 </p>
</div>


