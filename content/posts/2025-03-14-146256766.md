---
layout: post
title: "深度学习-服务器训练SparseDrive过程记录"
date: 2025-03-14 15:50:25 +0800
description: "用ssh远程的服务器终端只要关闭该终端，训练程序也会中断，是因为虽然ssh的终端是在本地电脑上显示的，但是其实是服务器端的终端，所以关掉ssh的终端，就是关掉了服务器的终端，在终端上运行的程序就会中断，通过使用screen就可以让程序在后台运行，即使关掉终端，程序仍然会在后台运行。：要将nuScenes-map-expansion-v1.3中的basemap、expansion、prediction拷贝到maps下。然后执行find / -name “"
keywords: "深度学习-服务器训练SparseDrive过程记录"
categories: ['未分类']
tags: ['深度学习', '服务器', '人工智能']
artid: "146256766"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146256766
    alt: "深度学习-服务器训练SparseDrive过程记录"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146256766
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146256766
cover: https://bing.ee123.net/img/rand?artid=146256766
image: https://bing.ee123.net/img/rand?artid=146256766
img: https://bing.ee123.net/img/rand?artid=146256766
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     深度学习-服务器训练SparseDrive过程记录
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <strong>
      1、cuda安装
     </strong>
     <br/>
     <strong>
      1.1 卸载安装失败的cuda
     </strong>
     <br/>
     <strong>
      参考
     </strong>
     ：
     <a href="https://blog.csdn.net/weixin_40826634/article/details/127493809">
      https://blog.csdn.net/weixin_40826634/article/details/127493809
     </a>
     <br/>
     <strong>
      注意
     </strong>
     ：因为/usr/local/cuda-xx.x/bin/下没有卸载脚本，很可能是apt安装的，所以通过执行下面的命令删除：
    </p>
    <pre><code class="prism language-cpp">apt<span class="token operator">-</span>get <span class="token operator">--</span>purge remove <span class="token string">"cuda*"</span>
apt<span class="token operator">-</span>get autoremove
</code></pre>
    <p>
     然后执行find / -name “
     <em>
      cuda
     </em>
     ”，查看是否还有残留的cuda相关文件，比如/etc/alternatives/cuda-12还存在，则执行下面的命令：
    </p>
    <pre><code class="prism language-cpp">rm <span class="token operator">/</span>etc<span class="token operator">/</span>alternatives<span class="token operator">/</span>cuda<span class="token operator">-</span><span class="token number">12</span>
</code></pre>
    <p>
     <strong>
      1.2 安装cuda及cudnn
     </strong>
     <br/>
     <strong>
      参考
     </strong>
     ：
     <a href="https://blog.csdn.net/weixin_40826634/article/details/127493809">
      https://blog.csdn.net/weixin_40826634/article/details/127493809
     </a>
     <br/>
     <strong>
      注意
     </strong>
     ：
    </p>
    <ul>
     <li>
      服务器显卡驱动支持的cuda最高版本是12.4，SparseDrive官方教程依赖的cuda运行时版本是11.6，因为运行时版本只要小于最高版本即可，所以这里安装的是cuda-11.6。
     </li>
     <li>
      安装完cuda后，发现/usr/local/cuda-11.6/samples路径下没有测试用例，从官网使用命令git clone https://github.com/NVIDIA/cuda-samples.git拉取了测试用例仓库，验证cuda成功安装。
     </li>
     <li>
      cudnn减压后的文件夹名为cudnn-linux-x86_64-8.4.1.50_cuda11.6-archive，和参考文档里减压后的文件夹cuda是对应的，只不过这里是cuda11.6对应的cudnn，参考文档里是cuda10.0对应的cudnn。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bf16737c64fb490b952659201a8cc140.png"/>
     </li>
    </ul>
    <p>
     <strong>
      2、数据集准备
     </strong>
     <br/>
     数据集的目录：
     <br/>
     nuSenses/
     <br/>
     ├── can_bus
     <br/>
     ├── maps
     <br/>
     │ ├── 36092f0b03a857c6a3403e25b4b7aab3.png
     <br/>
     │ ├── 37819e65e09e5547b8a3ceaefba56bb2.png
     <br/>
     │ ├── 53992ee3023e5494b90c316c183be829.png
     <br/>
     │ ├── 93406b464a165eaba6d9de76ca09f5da.png
     <br/>
     │ ├── basemap
     <br/>
     │ ├── expansion
     <br/>
     │ └── prediction
     <br/>
     ├── samples
     <br/>
     │ ├── CAM_BACK
     <br/>
     │ ├── CAM_BACK_LEFT
     <br/>
     │ ├── CAM_BACK_RIGHT
     <br/>
     │ ├── CAM_FRONT
     <br/>
     │ ├── CAM_FRONT_LEFT
     <br/>
     │ ├── CAM_FRONT_RIGHT
     <br/>
     │ ├── LIDAR_TOP
     <br/>
     │ ├── RADAR_BACK_LEFT
     <br/>
     │ ├── RADAR_BACK_RIGHT
     <br/>
     │ ├── RADAR_FRONT
     <br/>
     │ ├── RADAR_FRONT_LEFT
     <br/>
     │ └── RADAR_FRONT_RIGHT
     <br/>
     ├── sweeps
     <br/>
     │ ├── CAM_BACK
     <br/>
     │ ├── CAM_BACK_LEFT
     <br/>
     │ ├── CAM_BACK_RIGHT
     <br/>
     │ ├── CAM_FRONT
     <br/>
     │ ├── CAM_FRONT_LEFT
     <br/>
     │ ├── CAM_FRONT_RIGHT
     <br/>
     │ ├── LIDAR_TOP
     <br/>
     │ ├── RADAR_BACK_LEFT
     <br/>
     │ ├── RADAR_BACK_RIGHT
     <br/>
     │ ├── RADAR_FRONT
     <br/>
     │ ├── RADAR_FRONT_LEFT
     <br/>
     │ └── RADAR_FRONT_RIGHT
     <br/>
     └── v1.0-trainval
     <br/>
     ├── attribute.json
     <br/>
     ├── calibrated_sensor.json
     <br/>
     ├── category.json
     <br/>
     ├── ego_pose.json
     <br/>
     ├── instance.json
     <br/>
     ├── log.json
     <br/>
     ├── map.json
     <br/>
     ├── sample.json
     <br/>
     ├── sample_annotation.json
     <br/>
     ├── sample_data.json
     <br/>
     ├── scene.json
     <br/>
     ├── sensor.json
     <br/>
     └── visibility.json
     <br/>
     <strong>
      注意
     </strong>
     ：要将nuScenes-map-expansion-v1.3中的basemap、expansion、prediction拷贝到maps下。
     <br/>
     <strong>
      3、SparseDrive训练
     </strong>
     <br/>
     完全按照官网的教程进行部署，训练脚本不需要修改，就是两步，执行训练脚本遇到如下的问题：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c7ad56a8e9c34114aa64f7a1a47cf53c.png">
      <br/>
      排查是因为共享空间不足![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/c388ef7294314b3abef5321d227a6a97.png
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f7eaf0c1ea8c4ee0baa6236f011f70d1.png">
       <br/>
       执行以下两条命令，申请了8G的共享内存，并把batch_size从64改成32后，程序可以正常训练：
      </img>
     </img>
    </p>
    <pre><code class="prism language-cpp">卸载默认的 <span class="token operator">/</span>dev<span class="token operator">/</span>shm
umount <span class="token operator">/</span>dev<span class="token operator">/</span>shm
#挂载更大的内存文件系统（例如<span class="token number">8</span>g）
mount <span class="token operator">-</span>t tmpfs <span class="token operator">-</span>o size<span class="token operator">=</span><span class="token number">8</span>g tmpfs <span class="token operator">/</span>dev<span class="token operator">/</span>shm
</code></pre>
    <p>
     <strong>
      4、使用screen在服务器后台运行程序
     </strong>
     <br/>
     用ssh远程的服务器终端只要关闭该终端，训练程序也会中断，是因为虽然ssh的终端是在本地电脑上显示的，但是其实是服务器端的终端，所以关掉ssh的终端，就是关掉了服务器的终端，在终端上运行的程序就会中断，通过使用screen就可以让程序在后台运行，即使关掉终端，程序仍然会在后台运行。
     <br/>
     screen常用命令：
    </p>
    <pre><code class="prism language-cpp">screen <span class="token operator">-</span>S sparsedrive #创建一个名字为sparsedrive的会话

按ctrl<span class="token operator">+</span>a后再按d，退出会话

screen <span class="token operator">-</span>r sparsedrive #重新进入会话

screen <span class="token operator">-</span>ls #查看所有会话
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d15f9c281b0741fcafbeba1e84e5b207.png"/>
    </p>
    <pre><code class="prism language-cpp">screen <span class="token operator">-</span>X <span class="token operator">-</span>S <span class="token number">27444</span> quit 删除会话
</code></pre>
    <p>
     <strong>
      5、报显存不足的解决方法
     </strong>
     <br/>
     在训练时，如果发现显存不足，用htop查看未释放显存的进程，如果存在程序已经结束，但是显存还没释放的进程，则用下面的命令强制杀死这些进程：
    </p>
    <pre><code class="prism language-cpp">kill <span class="token operator">-</span><span class="token number">9</span> <span class="token operator">&lt;</span>进程id<span class="token operator">&gt;</span>
</code></pre>
    <p>
     然后，用nvidia-smi查看，会发现素所有gpu的util都是0了，即显存都被释放了。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34303832363633342f:61727469636c652f64657461696c732f313436323536373636" class_="artid" style="display:none">
 </p>
</div>


