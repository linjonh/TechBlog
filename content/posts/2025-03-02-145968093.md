---
layout: post
title: "一超声波模块"
date: 2025-03-02 19:41:38 +0800
description: "原理(1)采用 IO 口 TRIG 触发测距，给最少 10us 的高电平信呈。（即mcu输出一个高电平持续10us脉冲信号。(2)ECHO引脚自动发送 8 个 40khz 的方波，自动检测是否有信号返回；有信号返回，通过 IO 口 ECHO 输出一个高电平，高电平持续的时间就是超声波从发射到返回的时间。测试距离=(高电平时间*声速(340M/S))/2;（即：通过mcu检测该引脚的电平状态。修改配置systick。"
keywords: "一、超声波模块"
categories: ['模块']
tags: ['模块测试', '嵌入式硬件', '单片机', 'Stm']
artid: "145968093"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145968093
    alt: "一超声波模块"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145968093
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145968093
cover: https://bing.ee123.net/img/rand?artid=145968093
image: https://bing.ee123.net/img/rand?artid=145968093
img: https://bing.ee123.net/img/rand?artid=145968093
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     一、超声波模块
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="SR04_0">
     </a>
     一、SR04超声波模块
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/29bc939080144cb297637b82042989f3.jpeg"/>
    </p>
    <h2>
     <a id="_2">
     </a>
     说明：
    </h2>
    <p>
     原理
     <br/>
     (1)采用 IO 口 TRIG 触发测距，给最少 10us 的高电平信呈。（即mcu输出一个高电平持续10us脉冲信号。）
     <br/>
     (2)ECHO引脚自动发送 8 个 40khz 的方波，自动检测是否有信号返回；有信号返回，通过 IO 口 ECHO 输出一个高电平，高电平持续的时间就是超声波从发射到返回的时间。测试距离=(高电平时间*声速(340M/S))/2;
     <br/>
     （即：通过mcu检测该引脚的电平状态。）
    </p>
    <p>
     修改配置systick
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2a7beab05a784d02a543f53567059721.png"/>
    </p>
    <h2>
     <a id="tim_11">
     </a>
     配置tim：
    </h2>
    <pre><code class="prism language-c"><span class="token comment">/* 	滴答定时器配置1ms 
	SystemCoreClock/1000    1ms中断一次
	SystemCoreClock/100000	 10us中断一次
	SystemCoreClock/1000000 1us中断一次
 */</span>
  <span class="token function">HAL_SYSTICK_Config</span><span class="token punctuation">(</span>SystemCoreClock<span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* 系统滴答定时器时钟源 */</span>
  <span class="token function">HAL_SYSTICK_CLKSourceConfig</span><span class="token punctuation">(</span>SYSTICK_CLKSOURCE_HCLK<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* 系统滴答定时器中断优先级配置 */</span>
  <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>SysTick_IRQn<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	

  <span class="token class-name">uint64_t</span> count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token class-name">uint64_t</span> time_end<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">//定时器配置，设定一个10us的更新中断。</span>
  htim4<span class="token punctuation">.</span>Instance <span class="token operator">=</span> TIM4<span class="token punctuation">;</span>
  htim4<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Prescaler <span class="token operator">=</span> <span class="token number">120</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//1hmz=1us</span>
  htim4<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>CounterMode <span class="token operator">=</span> TIM_COUNTERMODE_UP<span class="token punctuation">;</span>
  htim4<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Period <span class="token operator">=</span> <span class="token number">10</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//10 us</span>

  <span class="token function">HAL_TIM_Base_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim4<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//在中断回调里进行自加处理</span>
<span class="token keyword">void</span> <span class="token function">HAL_TIM_PeriodElapsedCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* 根据形参判断进入回调函数的是哪个定时器 */</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>htim <span class="token operator">==</span> <span class="token operator">&amp;</span>htim4<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
		count<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">int16_t</span> <span class="token function">sonar_mm</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>		<span class="token comment">//测距并返回单位为毫米的距离结果</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">uint32_t</span> Distance<span class="token punctuation">,</span>Distance_mm <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//输出高电平</span>
	<span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//延时15微秒</span>
	<span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//输出低电平</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span>GPIO_PIN_1<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待低电平结束</span>
	count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//计时清零</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span>GPIO_PIN_1<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待高电平结束</span>
	time_end<span class="token operator">=</span>count<span class="token punctuation">;</span>	<span class="token comment">//记录结束时的时间</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>time_end<span class="token operator">/</span><span class="token number">100</span><span class="token operator">&lt;</span><span class="token number">38</span><span class="token punctuation">)</span>		<span class="token comment">//判断是否小于38毫秒，大于38毫秒的就是超时，直接调到下面返回0</span>
	<span class="token punctuation">{<!-- --></span>
		Distance<span class="token operator">=</span><span class="token punctuation">(</span>count<span class="token operator">*</span><span class="token number">346</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>	<span class="token comment">//计算距离，25°C空气中的音速为346m/s</span>
		Distance_mm<span class="token operator">=</span>Distance<span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">;</span>	<span class="token comment">//因为上面的time_end的单位是10微秒，所以要得出单位为毫米的距离结果，还得除以100</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> Distance_mm<span class="token punctuation">;</span>	<span class="token comment">//返回测距结果</span>
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">sonar</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>	<span class="token comment">//测距并返回单位为米的距离结果</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token class-name">uint32_t</span> Distance<span class="token punctuation">,</span>Distance_mm <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> Distance_m<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出高电平</span>
	<span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//延时15微秒</span>
	<span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>						<span class="token comment">//输出低电平</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span>GPIO_PIN_1<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待低电平结束</span>
	count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//计时清零</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span>GPIO_PIN_1<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待高电平结束</span>
	time_end<span class="token operator">=</span>count<span class="token punctuation">;</span>		
	<span class="token keyword">if</span><span class="token punctuation">(</span>time_end<span class="token operator">/</span><span class="token number">100</span><span class="token operator">&lt;</span><span class="token number">38</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		Distance<span class="token operator">=</span><span class="token punctuation">(</span>time_end<span class="token operator">*</span><span class="token number">346</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
		Distance_mm<span class="token operator">=</span>Distance<span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">;</span>
		Distance_m<span class="token operator">=</span>Distance_mm<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> Distance_m<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34343338363932372f:61727469636c652f64657461696c732f313435393638303933" class_="artid" style="display:none">
 </p>
</div>


