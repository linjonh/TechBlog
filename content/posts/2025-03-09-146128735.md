---
layout: post
title: "基于PaddleNLP使用DeepSeek-R1搭建智能体"
date: 2025-03-09 10:50:23 +0800
description: "词嵌入部分是为了将文本转换为向量形式，向量形式可便于对于文档的检索和搜寻，这里使用最新的ERNIE SDK进行词嵌入函数的定义，可将文本向量化在自然语言处理（NLP）中，向量知识库可以将文本转换为数值形式的向量，这使得机器可以处理和比较文本数据，嵌入向量能够捕捉文本的语义信息，使得相似的词汇或句子在向量空间中更接近。本部分用于获取每段文本，将前面切片好后的文档进行整理，全部至于sections列表内，sections是一个二维列表，用于存储数据，便于后续的文本向量化转换In [10]"
keywords: "基于PaddleNLP使用DeepSeek-R1搭建智能体"
categories: ['Ai']
tags: ['Paddlenlp', 'Deepseek']
artid: "146128735"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146128735
    alt: "基于PaddleNLP使用DeepSeek-R1搭建智能体"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146128735
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146128735
cover: https://bing.ee123.net/img/rand?artid=146128735
image: https://bing.ee123.net/img/rand?artid=146128735
img: https://bing.ee123.net/img/rand?artid=146128735
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     基于PaddleNLP使用DeepSeek-R1搭建智能体
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="PaddleNLPDeepSeekR1_0">
     </a>
     基于PaddleNLP使用DeepSeek-R1搭建智能体
    </h2>
    <p>
     <img alt="image-20250309103914834" src="https://i-blog.csdnimg.cn/img_convert/01ccf77abe9a5db6ee2e44cf4f4f878f.png"/>
    </p>
    <p>
     最近在学习DeepSeek，找到了PaddleNLP星河社区大模型，跟着敲写了一遍。内容来源：
     <a href="https://aistudio.baidu.com/course/introduce/33834?sharedType=1&amp;sharedUserId=16597718&amp;ts=1741488067384" rel="nofollow">
      DeepSeek实战训练营：从云端模型部署到应用开发 - 飞桨AI Studio星河社区-人工智能学习与实训社区
     </a>
    </p>
    <p>
     本项目基于 Langchain 框架，结合星河社区大模型 API 提供的词嵌入模型和 Milvus 向量服务器搭建向量知识库，并使用 PaddleNLP 的 DeepSeek-R1 模型搭建杭创赛解说智能体，旨在测试模型性能并帮助参赛者更好地了解比赛。
    </p>
    <p>
     来探索测试PaddleNLP中DeepSeek-R1所搭建的智能体使用RAG向量知识库的效果，测试效果很不错
    </p>
    <p>
     <img alt="img" src="https://i-blog.csdnimg.cn/img_convert/f411a4bd0da1ec449af60c8146e9301e.jpeg"/>
    </p>
    <p>
     <strong>
      运行环境Tesla V00 32G，飞桨星河社区每日运行项目就送8算力点，所以大家可以放心运行哈
     </strong>
    </p>
    <p>
     <img alt="img" src="https://i-blog.csdnimg.cn/img_convert/8b75974187977f126b363c41e90f8e94.png"/>
    </p>
    <h3>
     <a id="_16">
     </a>
     构建流程
    </h3>
    <p>
     <img alt="image-20250309104229016" src="https://i-blog.csdnimg.cn/img_convert/e874c4b17617bcaa1b32acc2e7b96b37.png"/>
    </p>
    <h3>
     <a id="_20">
     </a>
     环境配置
    </h3>
    <h4>
     <a id="PaddleNLPDeepSeekR1_22">
     </a>
     PaddleNLP环境配置（DeepSeek-R1）
    </h4>
    <p>
     飞桨官方已经为大家配置好在V100和A100环境下的依赖环境，大家仅需使用解压即可使用。同时飞桨官方提供了环境安装命令，方便复现安装，本部分操作主要完成了以下任务：
    </p>
    <p>
     自动卸载已安装的 PaddleNLP 库，确保环境干净，避免版本冲突。
    </p>
    <p>
     解压并安装了特定版本（2025年1月24日的 develop 分支）的 PaddleNLP，同时创建了外部库目录，用于存放安装的外部依赖，以防止重启后库被清空。
    </p>
    <p>
     安装 paddlenlp_ops 的 CUDA 算子，以提高 GPU 的利用率和运行速度。
    </p>
    <p>
     In [1]
    </p>
    <pre><code class="prism language-python"><span class="token comment"># 自动确认并卸载已安装的 paddlenlp 库</span>
!pip uninstall paddlenlp <span class="token operator">-</span>y
<span class="token comment"># 解压安装PaddleNLP，文件来自PaddleNLP GitHub仓库 develop分支（2025年1月24日）</span>
!tar <span class="token operator">-</span>xf PaddleNLP<span class="token operator">-</span><span class="token number">20250124</span><span class="token operator">-</span><span class="token number">1801</span><span class="token punctuation">.</span>tgz
<span class="token comment"># 创建一个名为 'external-libraries' 的目录，用于存放安装的外部库（星河平台默认安装库重启后会被清空，所以需要将安装的库放到外部目录中）</span>
<span class="token comment"># 创建环境依赖库，针对不同的GPU环境，请使用者自行切换</span>
<span class="token comment"># !mkdir -p /home/aistudio/external-libraries</span>
!tar zxf external<span class="token operator">-</span>libraries<span class="token punctuation">.</span>tgz

<span class="token comment"># !!! 依赖文件已经安装在external-libraries中，无需再次安装, 选择性安装paddlenlp_ops算子即可 !!!</span>
<span class="token comment"># 安装PaddleNLP</span>
<span class="token comment"># !pip install --pre --upgrade paddlenlp==3.0.0b3.post20250123 -f https://www.paddlepaddle.org.cn/whl/paddlenlp.html -t /home/aistudio/external-libraries</span>
<span class="token comment"># 【选择性安装】安装paddlenlp_ops cuda算子, 提高GPU利用率，加快运行速度</span>
!cd <span class="token operator">/</span>home<span class="token operator">/</span>aistudio<span class="token operator">/</span>PaddleNLP<span class="token operator">/</span>csrc <span class="token operator">&amp;</span><span class="token operator">&amp;</span> python <span class="token operator">/</span>home<span class="token operator">/</span>aistudio<span class="token operator">/</span>PaddleNLP<span class="token operator">/</span>csrc<span class="token operator">/</span>setup_cuda<span class="token punctuation">.</span>py install
</code></pre>
    <h4>
     <a id="Langchianmilvusernie_51">
     </a>
     知识库构建环境配置（Langchian、milvus、ernie等）
    </h4>
    <p>
     <img alt="image-20250309104333653" src="https://i-blog.csdnimg.cn/img_convert/b9741efe8c64b940e3bfbfee96e01435.png"/>
    </p>
    <p>
     本部分操作安装了多个Python库，包括langchain-community、langchain、tiktoken、langchain_openai、unstructured、erniebot-agent、openai、milvus客户端和docx2txt，
    </p>
    <p>
     用于支持自然语言处理、文档处理和向量数据库操作等功能。
    </p>
    <p>
     In [2]
    </p>
    <pre><code class="prism language-python">!pip install langchain<span class="token operator">-</span>community <span class="token operator">-</span><span class="token operator">-</span>user
!pip install langchain <span class="token operator">-</span><span class="token operator">-</span>user
!pip install tiktoken <span class="token operator">-</span><span class="token operator">-</span>user
!pip install langchain_openai <span class="token operator">-</span><span class="token operator">-</span>user
!pip install unstructured <span class="token operator">-</span><span class="token operator">-</span>user
!pip install erniebot<span class="token operator">-</span>agent langchain <span class="token operator">-</span><span class="token operator">-</span>user
!pip install openai
!pip install <span class="token string">"milvus[client]"</span> <span class="token operator">-</span><span class="token operator">-</span>user
!pip install docx2txt <span class="token operator">-</span><span class="token operator">-</span>user
</code></pre>
    <p>
     In [3]
    </p>
    <pre><code class="prism language-python"><span class="token comment"># 将自定义的外部库目录添加到系统路径中，以便Python能够导入这些库中的模块</span>
<span class="token keyword">import</span> sys 
<span class="token comment"># 添加包含已安装外部库的目录</span>
sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'/home/aistudio/external-libraries'</span><span class="token punctuation">)</span>
<span class="token comment"># 添加PaddleNLP项目的根目录到系统路径，以便可以导入其模块和包</span>
sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>insert<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">'/home/aistudio/PaddleNLP'</span><span class="token punctuation">)</span>
<span class="token keyword">import</span> paddle
<span class="token keyword">from</span> llm<span class="token punctuation">.</span>predict<span class="token punctuation">.</span>predictor <span class="token keyword">import</span> PredictorArgument<span class="token punctuation">,</span> ModelArgument<span class="token punctuation">,</span> create_predictor
<span class="token keyword">from</span> paddlenlp<span class="token punctuation">.</span>utils <span class="token keyword">import</span> is_paddlenlp_ops_available

predictor_args <span class="token operator">=</span> PredictorArgument<span class="token punctuation">(</span>
    model_name_or_path<span class="token operator">=</span><span class="token string">"deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B"</span><span class="token punctuation">,</span>
    src_length<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span>
    min_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>
    max_length<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>
    top_k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    top_p<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
    temperature<span class="token operator">=</span><span class="token number">0.95</span><span class="token punctuation">,</span>
    repetition_penalty<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span>
    dtype<span class="token operator">=</span><span class="token string">"float16"</span><span class="token punctuation">,</span>
    inference_model<span class="token operator">=</span> <span class="token boolean">True</span> <span class="token keyword">if</span> is_paddlenlp_ops_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

paddle<span class="token punctuation">.</span>set_default_dtype<span class="token punctuation">(</span>predictor_args<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>
predictor <span class="token operator">=</span> create_predictor<span class="token punctuation">(</span>predictor_args<span class="token punctuation">,</span> ModelArgument<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     In [4]
    </p>
    <pre><code class="prism language-python">input_text <span class="token operator">=</span> <span class="token string">"解释一下温故而知新"</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>predictor<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>input_text<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="RAG_111">
     </a>
     RAG向量知识库搭建
    </h3>
    <h4>
     <a id="_113">
     </a>
     文档加载和切片
    </h4>
    <p>
     <img alt="image-20250309104359975" src="https://i-blog.csdnimg.cn/img_convert/ae8450a93d089f34067dbcc37109a698.png"/>
    </p>
    <p>
     本代码片段使用 langchain_community 提供的文档加载器和文本分割器，实现了对指定文件的加载和内容分割。
    </p>
    <p>
     首先根据文件扩展名（.pdf、.txt、.docx）选择合适的加载器加载文档内容，随后使用 RecursiveCharacterTextSplitter 将文档内容分割成固定大小的片段，以便后续处理。
    </p>
    <p>
     代码成功加载了位于 /home/aistudio/杭创赛收集信息.docx 的文档内容，并将其分割成多个片段，每个片段大小为200字符，重叠部分为50字符。
    </p>
    <p>
     还打印了加载和分割的结果，包括文档内容、切片数量和第11个切片的内容。
    </p>
    <p>
     In [9]
    </p>
    <pre><code class="prism language-python">!pip install langchain
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>document_loaders <span class="token keyword">import</span> PyPDFLoader<span class="token punctuation">,</span>Docx2txtLoader<span class="token punctuation">,</span>TextLoader

<span class="token comment"># 加载文档</span>
file_name<span class="token operator">=</span><span class="token string">'/home/aistudio/ttt.txt'</span>

<span class="token keyword">if</span> file_name<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".pdf"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    loader <span class="token operator">=</span> PyPDFLoader<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>
<span class="token keyword">elif</span> file_name<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".txt"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    loader <span class="token operator">=</span> TextLoader<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>
<span class="token keyword">elif</span> file_name<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".docx"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    loader <span class="token operator">=</span> Docx2txtLoader<span class="token punctuation">(</span>file_name<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">raise</span> BizException<span class="token punctuation">(</span><span class="token string">"目前只支持pdf文件与txt、docx文件"</span><span class="token punctuation">)</span>
data<span class="token operator">=</span>loader<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"文档加载成功"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"------------------------------------------分割线--------------------------------------------"</span><span class="token punctuation">)</span>
<span class="token keyword">from</span> langchain<span class="token punctuation">.</span>text_splitter <span class="token keyword">import</span> RecursiveCharacterTextSplitter

text_splitter<span class="token operator">=</span>RecursiveCharacterTextSplitter<span class="token punctuation">(</span>
    chunk_size<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span>
    chunk_overlap<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span>
    length_function<span class="token operator">=</span><span class="token builtin">len</span>
<span class="token punctuation">)</span>


pages<span class="token operator">=</span>loader<span class="token punctuation">.</span>load_and_split<span class="token punctuation">(</span>text_splitter<span class="token operator">=</span>text_splitter<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"文档切片成功"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"切片数量："</span><span class="token punctuation">,</span><span class="token builtin">len</span><span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>pages<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">.</span>page_content<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"------------------------------------------分割线--------------------------------------------"</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_162">
     </a>
     向量数据库构建
    </h4>
    <p>
     <img alt="image-20250309104429916" src="https://i-blog.csdnimg.cn/img_convert/9c27c2fe189a1894de0802ebb1ef2113.png"/>
    </p>
    <h5>
     <a id="_166">
     </a>
     词嵌入函数定义
    </h5>
    <p>
     词嵌入部分是为了将文本转换为向量形式，向量形式可便于对于文档的检索和搜寻，这里使用最新的ERNIE SDK进行词嵌入函数的定义，可将文本向量化
    </p>
    <p>
     在自然语言处理（NLP）中，向量知识库可以将文本转换为数值形式的向量，这使得机器可以处理和比较文本数据，嵌入向量能够捕捉文本的语义信息，使得相似的词汇或句子在向量空间中更接近。
    </p>
    <p>
     本部分用于获取每段文本，将前面切片好后的文档进行整理，全部至于sections列表内，sections是一个二维列表，用于存储数据，便于后续的文本向量化转换
    </p>
    <p>
     In [10]
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">from</span> openai <span class="token keyword">import</span> OpenAI
access_token <span class="token operator">=</span> <span class="token string">""</span>
client_ernie <span class="token operator">=</span> OpenAI<span class="token punctuation">(</span>
     api_key<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">,</span>  <span class="token comment"># 含有 AI Studio 访问令牌的环境变量，https://aistudio.baidu.com/account/accessToken,</span>
     base_url<span class="token operator">=</span><span class="token string">"https://aistudio.baidu.com/llm/lmapi/v3"</span><span class="token punctuation">,</span>  <span class="token comment"># aistudio 大模型 api 服务域名</span>
<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">ernie_embedding</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    embeddings <span class="token operator">=</span> client_ernie<span class="token punctuation">.</span>embeddings<span class="token punctuation">.</span>create<span class="token punctuation">(</span>
        model<span class="token operator">=</span><span class="token string">"embedding-v1"</span><span class="token punctuation">,</span>
        <span class="token builtin">input</span><span class="token operator">=</span><span class="token punctuation">[</span>text<span class="token punctuation">]</span><span class="token punctuation">)</span>
    all_embeddings <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token builtin">float</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token keyword">for</span> val <span class="token keyword">in</span> embedding<span class="token punctuation">.</span>embedding<span class="token punctuation">]</span> <span class="token keyword">for</span> embedding <span class="token keyword">in</span> embeddings<span class="token punctuation">.</span>data<span class="token punctuation">]</span>
    <span class="token keyword">return</span> all_embeddings
text<span class="token operator">=</span> pages<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">.</span>page_content
re<span class="token operator">=</span>ernie_embedding<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>re<span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 假设re是一个嵌套列表，计算其维度</span>
    dimensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>re<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>sublist<span class="token punctuation">)</span> <span class="token keyword">for</span> sublist <span class="token keyword">in</span> re<span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>dimensions<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>re<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token comment"># 如果re不是列表，直接打印shape</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>re<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>

<span class="token comment"># 用于存储每个部分的内容</span>
sections <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token comment"># 遍历文档中的段落</span>
<span class="token keyword">for</span> page <span class="token keyword">in</span> pages<span class="token punctuation">:</span>
    tt<span class="token operator">=</span>page<span class="token punctuation">.</span>page_content
    text <span class="token operator">=</span> tt<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    sections<span class="token punctuation">.</span>append<span class="token punctuation">(</span>text<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>sections<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>sections<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
    <h5>
     <a id="_213">
     </a>
     向量数据库构建
    </h5>
    <p>
     主要先进性初始化和配置 Milvus 向量数据库，用于存储和检索向量化的文本数据，首先尝试启动 Milvus 服务器，并连接到本地运行的 Milvus 服务。
    </p>
    <p>
     接着定义了一个数据集合（Collection）的模式（Schema），包括字段 answer_id（主键）、answer（文本内容）和 answer_vector（向量形式），并创建了一个名为 qadb 的数据集合。
    </p>
    <p>
     在定义数据集合的模式后，为 answer_vector 字段创建了一个索引，使用了 IVF_FLAT 索引类型和 L2 距离度量，参数 nlist 设置为 1024。
    </p>
    <p>
     这种索引配置适用于高效的向量检索任务，能够快速找到与查询向量最相似的记录。代码还查询并打印了索引构建的进度信息，确认索引构建状态。
    </p>
    <p>
     最后加载 qadb 数据集合，确保其处于可查询状态，通过多次调用 collection.load()，确保数据集合被正确加载到内存中，以便后续进行高效的向量相似性搜索操作。
    </p>
    <p>
     <img alt="image-20250309104528724" src="https://i-blog.csdnimg.cn/img_convert/fd1f8152854a676135e9408f163a0c30.png"/>
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> pymilvus <span class="token keyword">import</span> utility<span class="token punctuation">,</span> Collection
<span class="token keyword">from</span> pymilvus <span class="token keyword">import</span> CollectionSchema<span class="token punctuation">,</span> FieldSchema<span class="token punctuation">,</span> DataType
<span class="token keyword">from</span> milvus <span class="token keyword">import</span> default_server
<span class="token keyword">from</span> pymilvus <span class="token keyword">import</span> connections

<span class="token keyword">try</span><span class="token punctuation">:</span>
    default_server<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span><span class="token punctuation">:</span>
    default_server<span class="token punctuation">.</span>cleanup<span class="token punctuation">(</span><span class="token punctuation">)</span>
    default_server<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
<span class="token comment"># 尝试连接到 Milvus 服务器</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    connections<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'127.0.0.1'</span><span class="token punctuation">,</span> port<span class="token operator">=</span>default_server<span class="token punctuation">.</span>listen_port<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"成功连接到 Milvus 服务器，端口为：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>default_server<span class="token punctuation">.</span>listen_port<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"连接失败：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <img alt="image-20250309104545326" src="https://i-blog.csdnimg.cn/img_convert/61c8eca4d682e5bae7b78c34b0177820.png"/>
    </p>
    <pre><code class="prism language-python"><span class="token comment"># id</span>
answer_id <span class="token operator">=</span> FieldSchema<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">"answer_id"</span><span class="token punctuation">,</span>
    dtype<span class="token operator">=</span>DataType<span class="token punctuation">.</span>INT64<span class="token punctuation">,</span>
    is_primary<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    auto_id<span class="token operator">=</span><span class="token boolean">True</span>
<span class="token punctuation">)</span>
<span class="token comment"># 答案</span>
answer <span class="token operator">=</span> FieldSchema<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">"answer"</span><span class="token punctuation">,</span>
    dtype<span class="token operator">=</span>DataType<span class="token punctuation">.</span>VARCHAR<span class="token punctuation">,</span>
    max_length<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token comment"># 答案向量形式</span>
answer_vector <span class="token operator">=</span> FieldSchema<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">"answer_vector"</span><span class="token punctuation">,</span>
    dtype<span class="token operator">=</span>DataType<span class="token punctuation">.</span>FLOAT_VECTOR<span class="token punctuation">,</span>
    dim<span class="token operator">=</span><span class="token number">384</span>
<span class="token punctuation">)</span>
<span class="token comment"># 定义一个数据集合（Collection）的模式（Schema）-创建一个表</span>
schema <span class="token operator">=</span> CollectionSchema<span class="token punctuation">(</span>
    fields<span class="token operator">=</span><span class="token punctuation">[</span>answer_id<span class="token punctuation">,</span> answer<span class="token punctuation">,</span> answer_vector<span class="token punctuation">]</span><span class="token punctuation">,</span>
    description<span class="token operator">=</span><span class="token string">"vector data"</span>
<span class="token punctuation">)</span>
<span class="token comment"># 表名</span>
collection_name <span class="token operator">=</span> <span class="token string">"qadb"</span>
<span class="token comment"># 连接数据库</span>
Collection<span class="token punctuation">(</span>
    name<span class="token operator">=</span>collection_name<span class="token punctuation">,</span>
    schema<span class="token operator">=</span>schema<span class="token punctuation">,</span>
    using<span class="token operator">=</span><span class="token string">'default'</span><span class="token punctuation">,</span>
    shards_num<span class="token operator">=</span><span class="token number">2</span>
<span class="token punctuation">)</span>
collection <span class="token operator">=</span> Collection<span class="token punctuation">(</span><span class="token string">"qadb"</span><span class="token punctuation">)</span>

index_params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"metric_type"</span><span class="token punctuation">:</span><span class="token string">"L2"</span><span class="token punctuation">,</span> <span class="token comment"># COSINE</span>
    <span class="token string">"index_type"</span><span class="token punctuation">:</span><span class="token string">"IVF_FLAT"</span><span class="token punctuation">,</span>
    <span class="token string">"params"</span><span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span><span class="token string">"nlist"</span><span class="token punctuation">:</span><span class="token number">1024</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

collection<span class="token punctuation">.</span>create_index<span class="token punctuation">(</span>
    field_name<span class="token operator">=</span><span class="token string">"answer_vector"</span><span class="token punctuation">,</span> 
    index_params<span class="token operator">=</span>index_params
<span class="token punctuation">)</span>

progress_info <span class="token operator">=</span> utility<span class="token punctuation">.</span>index_building_progress<span class="token punctuation">(</span><span class="token string">"qadb"</span><span class="token punctuation">)</span>
<span class="token comment"># 获取并打印索引构建进度 {'total_rows': 0, 'indexed_rows': 0, 'pending_index_rows': 0}</span>
<span class="token comment"># total_rows：集合中总行数（或向量数）为0。这表示集合中没有任何数据，或者数据尚未被成功插入到集合中。</span>
<span class="token comment"># indexed_rows：已成功索引的行数（或向量数）为0。这表示还没有数据被索引。</span>
<span class="token comment"># pending_index_rows：待索引的行数（或向量数）为0。这表示没有数据正在等待被索引。</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>progress_info<span class="token punctuation">)</span>  <span class="token comment"># 打印进度信息</span>
collection<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span> 
collection <span class="token operator">=</span> Collection<span class="token punctuation">(</span><span class="token string">"qadb"</span><span class="token punctuation">)</span>
collection<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h5>
     <a id="_310">
     </a>
     数据插入知识库
    </h5>
    <p>
     <img alt="image-20250309104559433" src="https://i-blog.csdnimg.cn/img_convert/fd0dd6a659345cbbf640328960c4f084.png"/>
    </p>
    <p>
     接着进行信息的插入，这部分通过循环形式，遍历前面处理好的sections数据列表，将每条数据进行向量转换，文本数据和向量数据均放于data列表内
    </p>
    <p>
     再通过insert形式进行数据的插入，通过result.insert_count属性查看是否插入成功，如果正常插入这里result.insert_count应该是1
    </p>
    <p>
     In [5]
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> time
<span class="token keyword">from</span> pymilvus <span class="token keyword">import</span> Collection

i <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment"># 打开一个文件用于记录错误</span>
<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'error.log'</span><span class="token punctuation">,</span> <span class="token string">'w'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> error_log<span class="token punctuation">:</span>
    <span class="token keyword">for</span> rly <span class="token keyword">in</span> sections<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"这里是第</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">段："</span></span><span class="token punctuation">)</span>
            rlyEmbedding <span class="token operator">=</span> ernie_embedding<span class="token punctuation">(</span>rly<span class="token punctuation">)</span>  <span class="token comment"># 假设这是一个将文本转换为向量的函数</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>rlyEmbedding<span class="token punctuation">)</span><span class="token punctuation">)</span>
            data <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token punctuation">[</span>rly<span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 文本数据</span>
                rlyEmbedding  <span class="token comment"># 对应的向量数据</span>
            <span class="token punctuation">]</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
            result <span class="token operator">=</span> collection<span class="token punctuation">.</span>insert<span class="token punctuation">(</span>data<span class="token punctuation">)</span>  <span class="token comment"># 插入数据并获取结果</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
            <span class="token comment"># 检查插入结果</span>
            <span class="token keyword">if</span> result<span class="token punctuation">.</span>insert_count <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"成功插入 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result<span class="token punctuation">.</span>insert_count<span class="token punctuation">}</span></span><span class="token string"> 条数据"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"插入操作失败，没有成功插入数据！！！"</span><span class="token punctuation">)</span>
            i <span class="token operator">+=</span> <span class="token number">1</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"插入操作异常：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            error_log<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Index </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string"> failed with error: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">\n'</span></span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
</code></pre>
    <h5>
     <a id="_354">
     </a>
     检验是否构建成功
    </h5>
    <p>
     主要进行两部分检验，一个是检验数据是否插入，另外一个是知识库查询检验，这里的插入检验貌似会有延迟，前面导入数据后这里如果响应慢不要紧，可以先进行下面的知识库查询校验，如果有数据可查询到代表无问题
    </p>
    <p>
     这段代码首先使用MilvusClient连接到Milvus服务器，并获取名为qadb的集合的统计信息，然后打印出集合中已插入的总数据量。
    </p>
    <p>
     接着定义一个函数get_collection_total_entities，该函数通过访问集合的num_entities属性来查询集合中的总实体数，并打印出这个数值。
    </p>
    <p>
     这里的查询校验使用Milvus数据库进行向量搜索，通过将问题文本转换为向量（使用ernie_embedding函数），然后在集合qadb中查找与该向量最相似的向量（基于欧几里得距离），并输出最匹配的前两个答案的文本内容。
    </p>
    <p>
     这部分代码重点是两部分，一个是查询参数的定义，另外一个是向量查询，这段代码中的search_params字典定义了在Milvus数据库中进行向量搜索时使用的参数。
    </p>
    <p>
     In [6]
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> pymilvus <span class="token keyword">import</span> MilvusClient

<span class="token comment"># 设置 Milvus 客户端</span>
client <span class="token operator">=</span> MilvusClient<span class="token punctuation">(</span>uri<span class="token operator">=</span><span class="token string">"http://localhost:19530"</span><span class="token punctuation">,</span> token<span class="token operator">=</span><span class="token string">"root:Milvus"</span><span class="token punctuation">)</span>

<span class="token comment"># 获取集合的统计信息</span>
stats <span class="token operator">=</span> client<span class="token punctuation">.</span>get_collection_stats<span class="token punctuation">(</span>collection_name<span class="token operator">=</span><span class="token string">"qadb"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span>

<span class="token comment"># 检查 stats 是否不为空，并且包含键 'row_count'</span>
<span class="token keyword">if</span> stats <span class="token keyword">and</span> <span class="token string">'row_count'</span> <span class="token keyword">in</span> stats<span class="token punctuation">:</span>
    total_entities <span class="token operator">=</span> stats<span class="token punctuation">[</span><span class="token string">'row_count'</span><span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"集合 'qadb' 中已经插入的总数据量为: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>total_entities<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"注意！集合 'qadb' 不存在或为空"</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_collection_total_entities</span><span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    查询集合中的总实体数（即总数据量）

    :param collection: 向量集合对象
    :return: 总实体数
    """</span>
    <span class="token comment"># 直接访问集合的 num_entities 属性</span>
    collection<span class="token punctuation">.</span>load<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>collection<span class="token punctuation">.</span>describe<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 检查集合的元数据</span>
    stats <span class="token operator">=</span> collection<span class="token punctuation">.</span>num_entities
    <span class="token keyword">print</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span>
    <span class="token keyword">return</span> stats

<span class="token comment"># 调用函数并输出集合中的总数据量</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"集合中的总数据量: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>get_collection_total_entities<span class="token punctuation">(</span>collection<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
</code></pre>
    <p>
     In [7]
    </p>
    <pre><code class="prism language-python">question <span class="token operator">=</span> <span class="token string">"比赛参赛要求?"</span>
qEmbedding <span class="token operator">=</span> ernie_embedding<span class="token punctuation">(</span>question<span class="token punctuation">)</span>

search_params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"metric_type"</span><span class="token punctuation">:</span> <span class="token string">"L2"</span><span class="token punctuation">,</span>  <span class="token comment"># 使用余弦相似度  或者 COSINE</span>
    <span class="token string">"offset"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
    <span class="token string">"ignore_growing"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> 
    <span class="token string">"params"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"nprobe"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">}</span>  <span class="token comment"># 增加 nprobe 值以提高检索范围</span>
<span class="token punctuation">}</span>

<span class="token comment"># 定义要导出的集合名称</span>
collection_name <span class="token operator">=</span> <span class="token string">"qadb"</span>
collection <span class="token operator">=</span> Collection<span class="token punctuation">(</span>collection_name<span class="token punctuation">)</span>

results <span class="token operator">=</span> collection<span class="token punctuation">.</span>search<span class="token punctuation">(</span>
    data<span class="token operator">=</span>qEmbedding<span class="token punctuation">,</span> 
    anns_field<span class="token operator">=</span><span class="token string">"answer_vector"</span><span class="token punctuation">,</span> 
    param<span class="token operator">=</span>search_params<span class="token punctuation">,</span>
    limit<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span>  <span class="token comment"># 查询 5 个结果</span>
    expr<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
    output_fields<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'answer'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    consistency_level<span class="token operator">=</span><span class="token string">"Strong"</span>
<span class="token punctuation">)</span>

<span class="token comment"># 打印所有返回的结果</span>
<span class="token keyword">for</span> i<span class="token punctuation">,</span> result <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Result </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'answer'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 获取第一个结果的 answer 字段</span>
answer <span class="token operator">=</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>entity<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'answer'</span><span class="token punctuation">)</span>
answer
</code></pre>
    <h3>
     <a id="DeepSeekR1_441">
     </a>
     基于DeepSeek-R1构建智能体
    </h3>
    <p>
     <img alt="image-20250309104623855" src="https://i-blog.csdnimg.cn/img_convert/0d8966e0e7fb7d8547908eca9a0f445b.png"/>
    </p>
    <p>
     本部分代码实现一个基于 PaddleNLP 的 DeepSeek-R1-Distill-Qwen-1.5B 模型的智能问答系统，用于对用户输入的问题进行解答。
    </p>
    <p>
     代码首先配置了模型参数，并创建了一个预测器实例。系统通过 Milvus 向量数据库检索与用户问题相关的文档内容，并结合这些内容生成简洁的回答。
    </p>
    <p>
     代码定义了 get_data 函数，用于将用户问题嵌入向量并通过 Milvus 搜索最相关的文档片段。
    </p>
    <p>
     检索到的内容被整合到提示词中，提示词通过 jinja2 模板生成，结合系统提示词和用户问题，引导模型生成符合要求的回答。系统提示词要求回答简洁（30字以内），并结合检索到的信息。
    </p>
    <p>
     通过一个循环实现用户交互，用户输入问题后，系统调用 predictor.predict 方法生成回答，并将回答添加到对话历史中。
    </p>
    <p>
     生成的回答会显示给用户，直到用户输入“结束”为止。整个流程实现了从问题检索到回答生成的完整闭环，为用户提供基于文档内容的智能解答。
    </p>
    <p>
     In [10]
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> paddle
<span class="token keyword">from</span> llm<span class="token punctuation">.</span>predict<span class="token punctuation">.</span>predictor <span class="token keyword">import</span> PredictorArgument<span class="token punctuation">,</span> ModelArgument<span class="token punctuation">,</span> create_predictor
<span class="token keyword">from</span> paddlenlp<span class="token punctuation">.</span>utils <span class="token keyword">import</span> is_paddlenlp_ops_available
<span class="token keyword">from</span> jinja2 <span class="token keyword">import</span> Template
<span class="token keyword">import</span> os
<span class="token keyword">import</span> json
<span class="token keyword">import</span> asyncio

predictor_args <span class="token operator">=</span> PredictorArgument<span class="token punctuation">(</span>
    model_name_or_path<span class="token operator">=</span><span class="token string">"deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B"</span><span class="token punctuation">,</span>
    src_length<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span>
    min_length<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>
    max_length<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>
    top_k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
    top_p<span class="token operator">=</span><span class="token number">0.7</span><span class="token punctuation">,</span>
    temperature<span class="token operator">=</span><span class="token number">0.95</span><span class="token punctuation">,</span>
    repetition_penalty<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">,</span>
    dtype<span class="token operator">=</span><span class="token string">"float16"</span><span class="token punctuation">,</span>
    inference_model<span class="token operator">=</span> <span class="token boolean">True</span> <span class="token keyword">if</span> is_paddlenlp_ops_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

paddle<span class="token punctuation">.</span>set_default_dtype<span class="token punctuation">(</span>predictor_args<span class="token punctuation">.</span>dtype<span class="token punctuation">)</span>
predictor <span class="token operator">=</span> create_predictor<span class="token punctuation">(</span>predictor_args<span class="token punctuation">,</span> ModelArgument<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 设置系统提示词</span>
systemprompts <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
比赛参赛要求?

"""</span>

<span class="token comment"># 用于查询相关信息</span>
<span class="token keyword">def</span> <span class="token function">get_data</span><span class="token punctuation">(</span>user_input<span class="token punctuation">)</span><span class="token punctuation">:</span>
    question <span class="token operator">=</span> user_input
    qEmbedding <span class="token operator">=</span>  ernie_embedding<span class="token punctuation">(</span>question<span class="token punctuation">)</span>
    search_params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"metric_type"</span><span class="token punctuation">:</span> <span class="token string">"L2"</span><span class="token punctuation">,</span> 
        <span class="token string">"offset"</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> 
        <span class="token string">"ignore_growing"</span><span class="token punctuation">:</span> <span class="token boolean">False</span><span class="token punctuation">,</span> 
        <span class="token string">"params"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token string">"nprobe"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span>  <span class="token comment"># 提高 nprobe 的值</span>
    <span class="token punctuation">}</span>
    collection_name <span class="token operator">=</span> <span class="token string">"qadb"</span>
    collection <span class="token operator">=</span> Collection<span class="token punctuation">(</span>collection_name<span class="token punctuation">)</span>
    results <span class="token operator">=</span> collection<span class="token punctuation">.</span>search<span class="token punctuation">(</span>
        data<span class="token operator">=</span>qEmbedding<span class="token punctuation">,</span> 
        anns_field<span class="token operator">=</span><span class="token string">"answer_vector"</span><span class="token punctuation">,</span> 
        param<span class="token operator">=</span>search_params<span class="token punctuation">,</span>
        limit<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>  <span class="token comment"># 查询 5 个结果</span>
        expr<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span>
        output_fields<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'answer'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        consistency_level<span class="token operator">=</span><span class="token string">"Strong"</span>
    <span class="token punctuation">)</span>
    <span class="token comment"># 打印所有返回的结果</span>
    answer <span class="token operator">=</span> <span class="token string">"原文内容为：\n"</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> result <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        answer <span class="token operator">=</span> answer <span class="token operator">+</span> result<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'answer'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> answer

messages <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span>
        <span class="token string">"content"</span><span class="token punctuation">:</span>systemprompts<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>


<span class="token comment"># 用于组合输入内容</span>
<span class="token keyword">def</span> <span class="token function">generate_prompt</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span>user_input<span class="token punctuation">,</span>system_prompt<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># # 从 messages 中提取历史信息，包括用户和AI的所有对话</span>
    <span class="token comment"># history_info = str(messages)</span>
    <span class="token comment"># 设置系统提示词模板</span>
    _DEFAULT_RESULT_ZH <span class="token operator">=</span> <span class="token triple-quoted-string string">"""
    系统提示：{<!-- -->{system_prompt}}
    与用户对话相关的你的宝典信息如下：{<!-- -->{text}}
    本此来访人员的问题是： {<!-- -->{user_input}}
    """</span> 
    template <span class="token operator">=</span> Template<span class="token punctuation">(</span>_DEFAULT_RESULT_ZH<span class="token punctuation">)</span>
    prompt <span class="token operator">=</span> template<span class="token punctuation">.</span>render<span class="token punctuation">(</span>system_prompt<span class="token operator">=</span>system_prompt<span class="token punctuation">,</span>text<span class="token operator">=</span>text<span class="token punctuation">,</span> user_input<span class="token operator">=</span>user_input<span class="token punctuation">)</span>
    <span class="token keyword">return</span> prompt
</code></pre>
    <p>
     In [11]
    </p>
    <pre><code class="prism language-python">user_input <span class="token operator">=</span> <span class="token string">""</span>
<span class="token keyword">while</span> <span class="token string">"结束"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> user_input<span class="token punctuation">:</span>
    user_input <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"your："</span><span class="token punctuation">)</span>
    <span class="token comment"># 将用户问题信息添加到messages列表中</span>
    <span class="token comment"># 向量查询拿到信息</span>
    text <span class="token operator">=</span> get_data<span class="token punctuation">(</span>user_input<span class="token punctuation">)</span>
    <span class="token comment"># print(text)</span>
    <span class="token comment"># 提示词组合-信息＋问题</span>
    prompt <span class="token operator">=</span> generate_prompt<span class="token punctuation">(</span>text<span class="token punctuation">,</span>user_input<span class="token punctuation">,</span>systemprompts<span class="token punctuation">)</span>
    <span class="token comment"># print(prompt)</span>
    <span class="token comment"># 形成用户提问,并添加到对话中</span>
    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"user"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> prompt<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment"># 获取大模型回复</span>
    <span class="token comment"># 调用 predictor.predict 获取结果</span>
    ll <span class="token operator">=</span> predictor<span class="token punctuation">.</span>predict<span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>messages<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    
    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"role"</span><span class="token punctuation">:</span> <span class="token string">"assistant"</span><span class="token punctuation">,</span> <span class="token string">"content"</span><span class="token punctuation">:</span> ll<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"小助手：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>ll<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"结束1"</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="DeepSeekR1_566">
     </a>
     DeepSeek-R1单独调用测试
    </h3>
    <p>
     In [ ]
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> re

<span class="token comment"># 假设 messages 是输入的提示</span>
message <span class="token operator">=</span> <span class="token string">'你是什么，你的基础模型是什么？'</span>

<span class="token comment"># 调用 predictor.predict 获取结果</span>
ll <span class="token operator">=</span> predictor<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>

<span class="token comment"># 确保 ll 是字符串类型</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>ll<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">raise</span> TypeError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Expected a string, but got </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">type</span><span class="token punctuation">(</span>ll<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 移除 &lt;think&gt; 标签及其内容</span>
cleaned_result <span class="token operator">=</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'&lt;think&gt;.*?&lt;/think&gt;'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> ll<span class="token punctuation">,</span> flags<span class="token operator">=</span>re<span class="token punctuation">.</span>DOTALL<span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>cleaned_result<span class="token punctuation">)</span>
</code></pre>
    <p>
     参考文献：
     <br/>
     <a href="https://aistudio.baidu.com/course/introduce/33834?sharedType=1&amp;sharedUserId=16597718&amp;ts=1741488067384" rel="nofollow">
      DeepSeek实战训练营：从云端模型部署到应用开发 - 飞桨AI Studio星河社区-人工智能学习与实训社区
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33353039383532362f:61727469636c652f64657461696c732f313436313238373335" class_="artid" style="display:none">
 </p>
</div>


