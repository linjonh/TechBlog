---
layout: post
title: "dorisSQL-方言兼容"
date: 2025-03-12 13:14:33 +0800
description: "doris：SQL 方言兼容"
keywords: "doris：SQL 方言兼容"
categories: ['大数据']
tags: ['Doris']
artid: "146202589"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146202589
    alt: "dorisSQL-方言兼容"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146202589
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146202589
cover: https://bing.ee123.net/img/rand?artid=146202589
image: https://bing.ee123.net/img/rand?artid=146202589
img: https://bing.ee123.net/img/rand?artid=146202589
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     doris：SQL 方言兼容
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     提示
    </p>
    <p>
     从 2.1 版本开始，Doris 可以支持多种 SQL 方言，如 Presto、Trino、Hive、PostgreSQL、Spark、Clickhouse 等等。通过这个功能，用户可以直接使用对应的 SQL 方言查询 Doris 中的数据，方便用户将原先的业务平滑的迁移到 Doris 中。
    </p>
    <p>
     警告
    </p>
    <p>
     该功能目前是实验性功能，您在使用过程中如遇到任何问题，欢迎通过邮件组、
     <a href="https://github.com/apache/doris/issues" title="GitHub Issue">
      GitHub Issue
     </a>
     等方式进行反馈。
    </p>
    <h3 id="部署服务">
     部署服务
     <a href="https://doris.apache.org/zh-CN/docs/lakehouse/sql-dialect#%E9%83%A8%E7%BD%B2%E6%9C%8D%E5%8A%A1" rel="nofollow" title="​">
      ​
     </a>
    </h3>
    <ol>
     <li>
      <p>
       下载最新版本的
       <a href="https://www.selectdb.com/tools/doris-sql-convertor" rel="nofollow" title="SQL 方言转换工具">
        SQL 方言转换工具
       </a>
      </p>
      <p>
       NOTE
      </p>
      <p>
       SQL 方言转换工具基于开源的
       <a href="https://github.com/tobymao/sqlglot" title="SQLGlot">
        SQLGlot
       </a>
       ，由 SelectDB 进行二次开发，关于 SQLGlot 可参阅
       <a href="https://sqlglot.com/sqlglot.html" rel="nofollow" title="SQLGlot 官网">
        SQLGlot 官网
       </a>
       。
       <br/>
       SQL Convertor 并非由 Apache Doris 维护或认可，这些工作由 Committers 和 Doris PMC 监督。使用这些资源和服务完全由您自行决定，社区不负责验证这些工具的许可或有效性。
      </p>
     </li>
     <li>
      <p>
       在任意 FE 节点，通过以下命令启动服务：
      </p>
      <pre><code># 配置服务端口
vim apiserver/conf/config.conf
# 启动 SQL Converter for Apache Doris 转换服务
sh apiserver/bin/start.sh
# 如需前端界面，可在 webserver 中配置相应的端口并启动，不需要前端则可以忽略以下操作
vim webserver/conf/config.conf
# 启动前端界面
sh webserver/bin/start.sh
</code></pre>
      <p>
      </p>
      <p>
       提示
      </p>
      <ol>
       <li>
        <p>
         该服务是一个无状态的服务，可随时启停
        </p>
       </li>
       <li>
        <p>
         在
         <code>
          apiserver/conf/config.conf
         </code>
         中配置 port 来指定任意一个可用端口，配置 workers 来指定启动的线程数量。在并发场景中，可以根据需要调整，默认为 1
        </p>
       </li>
       <li>
        <p>
         建议在每个 FE 节点都单独启动一个服务
        </p>
       </li>
       <li>
        <p>
         如需启动前端界面，可以在
         <code>
          webserver/conf/config.conf
         </code>
         中配置 SQL Converter for Apache Doris 转换服务地址，默认是
         <code>
          API_HOST=http://127.0.0.1:5001
         </code>
        </p>
       </li>
      </ol>
     </li>
     <li>
      <p>
       启动 Doris 集群（2.1 或更高版本）
      </p>
     </li>
     <li>
      <p>
       通过以下命令，在 Doris 中设置 SQL 方言转换服务的 URL：
      </p>
      <p>
       <code>
        MySQL&gt; set global sql_converter_service_url = "http://127.0.0.1:5001/api/v1/convert"
       </code>
      </p>
      <ul>
       <li>
        <code>
         127.0.0.1:5001
        </code>
        是 SQL 方言转换服务的部署节点 ip 和端口。
       </li>
      </ul>
     </li>
    </ol>
    <h3 id="使用-sql-方言">
     使用 SQL 方言
     <a href="https://doris.apache.org/zh-CN/docs/lakehouse/sql-dialect#%E4%BD%BF%E7%94%A8-sql-%E6%96%B9%E8%A8%80" rel="nofollow" title="​">
      ​
     </a>
    </h3>
    <p>
     目前支持的方言类型包括：
    </p>
    <ul>
     <li>
      <p>
       <code>
        presto
       </code>
      </p>
     </li>
     <li>
      <p>
       <code>
        trino
       </code>
      </p>
     </li>
     <li>
      <p>
       <code>
        clickhouse
       </code>
      </p>
     </li>
     <li>
      <p>
       <code>
        hive
       </code>
      </p>
     </li>
     <li>
      <p>
       <code>
        spark
       </code>
      </p>
     </li>
     <li>
      <p>
       <code>
        postgres
       </code>
      </p>
     </li>
    </ul>
    <p>
     示例：
    </p>
    <h4 id="presto">
     Presto
     <a href="https://doris.apache.org/zh-CN/docs/lakehouse/sql-dialect#presto" rel="nofollow" title="​">
      ​
     </a>
    </h4>
    <pre><code>mysql&gt; CREATE TABLE  test_sqlconvert (
         id int,
         start_time DateTime,
         value String,
         arr_int ARRAY&lt;Int&gt;,
         arr_str ARRAY&lt;String&gt;
     ) ENGINE=OLAP
     DUPLICATE KEY(`id`)
     COMMENT 'OLAP'
     DISTRIBUTED BY HASH(`id`) BUCKETS 1
     PROPERTIES (
     "replication_allocation" = "tag.location.default: 1"
     );
Query OK, 0 rows affected (0.01 sec)

mysql&gt; INSERT INTO test_sqlconvert values(1, '2024-05-20 13:14:52', '2024-01-14',[1, 2, 3, 3], ['Hello', 'World']);
Query OK, 1 row affected (0.08 sec)

mysql&gt; set sql_dialect=presto;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; SELECT cast(start_time as varchar(20)) as col1,
            array_distinct(arr_int) as col2,
            FILTER(arr_str, x -&gt; x LIKE '%World%') as col3,
            to_date(value,'%Y-%m-%d') as col4,
            YEAR(start_time) as col5,
            date_add('month', 1, start_time) as col6,
            REGEXP_EXTRACT_ALL(value, '-.') as col7,
            JSON_EXTRACT('{"id": "33"}', '$.id')as col8,
            element_at(arr_int, 1) as col9,
            date_trunc('day',start_time) as col10
         FROM test_sqlconvert
         where date_trunc('day',start_time)= DATE'2024-05-20'     
     order by id;
+---------------------+-----------+-----------+------------+------+---------------------+-------------+------+------+---------------------+
| col1                | col2      | col3      | col4       | col5 | col6                | col7        | col8 | col9 | col10               |
+---------------------+-----------+-----------+------------+------+---------------------+-------------+------+------+---------------------+
| 2024-05-20 13:14:52 | [1, 2, 3] | ["World"] | 2024-01-14 | 2024 | 2024-06-20 13:14:52 | ['-0','-1'] | "33" |    1 | 2024-05-20 00:00:00 |
+---------------------+-----------+-----------+------------+------+---------------------+-------------+------+------+---------------------+
1 row in set (0.03 sec)

</code></pre>
    <p>
    </p>
    <h4 id="clickhouse">
     Clickhouse
     <a href="https://doris.apache.org/zh-CN/docs/lakehouse/sql-dialect#clickhouse" rel="nofollow" title="​">
      ​
     </a>
    </h4>
    <pre><code>mysql&gt; set sql_dialect=clickhouse;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; select  toString(start_time) as col1,
             arrayCompact(arr_int) as col2,
             arrayFilter(x -&gt; x like '%World%',arr_str)as col3,
             toDate(value) as col4,
             toYear(start_time)as col5,
             addMonths(start_time, 1)as col6,
             extractAll(value, '-.')as col7,
             JSONExtractString('{"id": "33"}' , 'id')as col8,
             arrayElement(arr_int, 1) as col9,
             date_trunc('day',start_time) as col10
          FROM test_sqlconvert
          where date_trunc('day',start_time)= '2024-05-20 00:00:00'     
     order by id;
+---------------------+-----------+-----------+------------+------+---------------------+-------------+------+------+---------------------+
| col1                | col2      | col3      | col4       | col5 | col6                | col7        | col8 | col9 | col10               |
+---------------------+-----------+-----------+------------+------+---------------------+-------------+------+------+---------------------+
| 2024-05-20 13:14:52 | [1, 2, 3] | ["World"] | 2024-01-14 | 2024 | 2024-06-20 13:14:52 | ['-0','-1'] | "33" |    1 | 2024-05-20 00:00:00 |
+---------------------+-----------+-----------+------------+------+---------------------+-------------+------+------+---------------------+
1 row in set (0.02 sec)</code></pre>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33363037303130342f:61727469636c652f64657461696c732f313436323032353839" class_="artid" style="display:none">
 </p>
</div>


