---
layout: post
title: "springboot-Junit单元测试之坑-SpringBootTest注解无法加载srcmainresources目录下资源文件"
date: 2019-02-02 17:30:23 +0800
description: "Springboot微服务框架是目前越来越流行的框架，省去了很多繁琐的xml配置。最近新启了个项目，"
keywords: "springboot项目的test文件夹中无法注入service"
categories: ['Springboot']
tags: ['Springboottest', 'Springboot', 'Junit']
artid: "86750497"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=86750497
    alt: "springboot-Junit单元测试之坑-SpringBootTest注解无法加载srcmainresources目录下资源文件"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=86750497
featuredImagePreview: https://bing.ee123.net/img/rand?artid=86750497
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     springboot Junit单元测试之坑--@SpringBootTest注解无法加载src/main/resources目录下资源文件
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     Springboot微服务框架是目前越来越流行的框架，省去了很多繁琐的xml配置。最近新启了个项目，采用SpringBoot框架从头搭建，中间也遇到过各种坑，现在先描述一下
     <code>
      Junit4单元测试
     </code>
     之坑吧。
    </p>
    <p>
     结论：
     <br/>
     <mark>
      @SpringBootTest注解，只会加载test路径下的资源文件(即xml配置)，并不会加载main路径下的资源文件，这点很坑。。。
     </mark>
    </p>
    <p>
     环境及问题描述：
    </p>
    <ul>
     <li>
      1.SpringBoot版本：2.0.0.RELEASE
     </li>
     <li>
      2.通过项目入口类启动
      <code>
       Application.main()
      </code>
      OK，能正常处理web请求
     </li>
     <li>
      3.启动单元测试，执行测试类，提示
      <code>
       Caused by: org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type 'com.xx.xxx.service.SsoService' available
      </code>
      ，如下：
     </li>
    </ul>
    <pre><code>Error starting ApplicationContext. To display the conditions report re-run your application with 'debug' enabled.
2019-02-02 16:26:10.537 ERROR 7812 --- [           main] o.s.b.d.LoggingFailureAnalysisReporter   : 

***************************
APPLICATION FAILED TO START
***************************

Description:

A component required a bean of type 'com.xx.xxx.service.SsoService' that could not be found.


Action:

Consider defining a bean of type 'com.xx.xxx.service.SsoService' in your configuration.

2019-02-02 16:26:10.541 ERROR 7812 --- [           main] o.s.test.context.TestContextManager      : Caught exception while allowing TestExecutionListener [org.springframework.test.context.web.ServletTestExecutionListener@93b025] to prepare test instance [com.jd.id.activity.ControllerTest@b9178]

java.lang.IllegalStateException: Failed to load ApplicationContext
	at org.springframework.test.context.cache.DefaultCacheAwareContextLoaderDelegate.loadContext(DefaultCacheAwareContextLoaderDelegate.java:125) ~[spring-test-5.0.4.RELEASE.jar:5.0.4.RELEASE]
	at org.springframework.test.context.support.DefaultTestContext.getApplicationContext(DefaultTestContext.java:107) ~[spring-test-5.0.4.RELEASE.jar:5.0.4.RELEASE]
	at org.springframework.test.context.web.ServletTestExecutionListener.setUpRequestContextIfNecessary(ServletTestExecutionListener.java:190) ~[spring-test-5.0.4.RELEASE.jar:5.0.4.RELEASE]
	at org.springframework.test.context.web.ServletTestExecutionListener.prepareTestInstance(ServletTestExecutionListener.java:132) ~[spring-test-5.0.4.RELEASE.jar:5.0.4.RELEASE]
	at org.springframework.test.context.TestContextManager.prepareTestInstance(TestContextManager.java:242) ~[spring-test-5.0.4.RELEASE.jar:5.0.4.RELEASE]
	at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.createTest(SpringJUnit4ClassRunner.java:227) [spring-test-5.0.4.RELEASE.jar:5.0.4.RELEASE]
	at org.springframework.test.context.junit4.SpringJUnit4ClassRunner$1.runReflectiveCall(SpringJUnit4ClassRunner.java:289) [spring-test-5.0.4.RELEASE.jar:5.0.4.RELEASE]
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12) [junit-4.12.jar:4.12]
	at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.methodBlock(SpringJUnit4ClassRunner.java:291) [spring-test-5.0.4.RELEASE.jar:5.0.4.RELEASE]
	at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:246) [spring-test-5.0.4.RELEASE.jar:5.0.4.RELEASE]
	at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:97) [spring-test-5.0.4.RELEASE.jar:5.0.4.RELEASE]
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290) [junit-4.12.jar:4.12]
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71) [junit-4.12.jar:4.12]
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288) [junit-4.12.jar:4.12]
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58) [junit-4.12.jar:4.12]
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268) [junit-4.12.jar:4.12]
	at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61) [spring-test-5.0.4.RELEASE.jar:5.0.4.RELEASE]
	at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70) [spring-test-5.0.4.RELEASE.jar:5.0.4.RELEASE]
	at org.junit.runners.ParentRunner.run(ParentRunner.java:363) [junit-4.12.jar:4.12]
	at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:190) [spring-test-5.0.4.RELEASE.jar:5.0.4.RELEASE]
	at org.junit.runner.JUnitCore.run(JUnitCore.java:137) [junit-4.12.jar:4.12]
	at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68) [junit-rt.jar:na]
	at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:51) [junit-rt.jar:na]
	at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:242) [junit-rt.jar:na]
	at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:70) [junit-rt.jar:na]

…………

Caused by: org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type 'com.xx.xxx.service.SsoService' available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: {@javax.annotation.Resource(shareable=true, lookup=, name=, description=, authenticationType=CONTAINER, type=class java.lang.Object, mappedName=)}
	at org.springframework.beans.factory.support.DefaultListableBeanFactory.raiseNoMatchingBeanFound(DefaultListableBeanFactory.java:1509)
	at org.springframework.beans.factory.support.DefaultListableBeanFactory.doResolveDependency(DefaultListableBeanFactory.java:1104)
	at org.springframework.beans.factory.support.DefaultListableBeanFactory.resolveDependency(DefaultListableBeanFactory.java:1065)
	at org.springframework.context.annotation.CommonAnnotationBeanPostProcessor.autowireResource(CommonAnnotationBeanPostProcessor.java:506)
	at org.springframework.context.annotation.CommonAnnotationBeanPostProcessor.getResource(CommonAnnotationBeanPostProcessor.java:484)
	at org.springframework.context.annotation.CommonAnnotationBeanPostProcessor$ResourceElement.getResourceToInject(CommonAnnotationBeanPostProcessor.java:618)
	at org.springframework.beans.factory.annotation.InjectionMetadata$InjectedElement.inject(InjectionMetadata.java:177)
	at org.springframework.beans.factory.annotation.InjectionMetadata.inject(InjectionMetadata.java:91)
	at org.springframework.context.annotation.CommonAnnotationBeanPostProcessor.postProcessPropertyValues(CommonAnnotationBeanPostProcessor.java:318)
	... 41 more


Process finished with exit code -1

</code></pre>
    <p>
     问题分析：
    </p>
    <ul>
     <li>
      1.首先
      <code>
       com.xx.xxx.service.SsoService
      </code>
      该类存在，并且项目正常启动时，并没有这个错误提示，那肯定是单元测试配置的有问题了，首先检查下相关的配置，
      <code>
       @RunWith(SpringRunner.class)
      </code>
      使用
      <code>
       SpringRunner
      </code>
      以便在测试开始的时候自动创建spring的应用上下文，没毛病。
      <code>
       @SpringBootTest(classes = 启动类.class)
      </code>
      配置也没问题，网上有讨论说springboot 1.4以下版本，要使用
      <code>
       @SpringApplicationConfiguration(classes = 启动类.class)
      </code>
      ，而我的项目版本是2.0，显然这个配置也没毛病。
      <br/>
      代码如下：
     </li>
    </ul>
    <pre><code>package com.xx.xxx.activity;

import org.junit.After;
import org.junit.Before;
import org.junit.runner.RunWith;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.test.context.web.WebAppConfiguration;

/**
 * 单元测试基类
 */
@RunWith(SpringRunner.class)
@SpringBootTest(classes = Application.class)
//由于是Web项目，Junit需要模拟ServletContext，因此我们需要给我们的测试类加上@WebAppConfiguration。
@WebAppConfiguration
public class BaseTest
{

    @Before
    public void init() {
        System.out.println("开始测试----------------");
    }

    @After
    public void destory() {
        System.out.println("结束测试----------------");
    }
}

</code></pre>
    <ul>
     <li>
      2.再看下pom文件的配置，引用了对应的test包，也没毛病
     </li>
    </ul>
    <pre><code>        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;version&gt;${springboot.version}&lt;/version&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
</code></pre>
    <ul>
     <li>
      3.对了，
      <strong>
       这个类是在src/main/resources目录下的资源文件里配置的，即xml中配置的bean，而src/test下并没有resources目录
      </strong>
      ，莫非是这个原因？于是乎在test目录下创建resources路径，并把xml文件拷贝至test对应的路径下，结果能够正常进行单元测试了，数据也写入到数据库中，终于松了口气
      <sub>
       -
      </sub>
     </li>
    </ul>
    <p>
     准备就此作罢，不想在这个问题上浪费时间了，但是再做考虑，这样做欠妥，毕竟我每次改完xml文件的配置，必须得拷贝到test目录对应的文件夹下，这拷来拷去，并不是最好的解决方案啊，能不能打包时，把src/main/resources的资源文件也拷贝到src/test/resources中？这样就不用手工拷贝了。答案是：当然有了，看pom.xml配置：
    </p>
    <pre><code>&lt;build&gt;
        &lt;finalName&gt;id-web-activity-root&lt;/finalName&gt;
        &lt;resources&gt;
            &lt;resource&gt;
                &lt;directory&gt;src/main/resources&lt;/directory&gt;
                &lt;filtering&gt;true&lt;/filtering&gt;
                &lt;includes&gt;
                    &lt;include&gt;**/*.*&lt;/include&gt;
                &lt;/includes&gt;
            &lt;/resource&gt;
        &lt;/resources&gt;
        &lt;!--单元测试时引用src/main/resources下的资源文件--&gt;
        &lt;testResources&gt;
            &lt;testResource&gt;
                &lt;directory&gt;src/test/resources&lt;/directory&gt;
            &lt;/testResource&gt;
            &lt;testResource&gt;
                &lt;directory&gt;src/main/resources&lt;/directory&gt;
            &lt;/testResource&gt;
        &lt;/testResources&gt;
    &lt;/build&gt;
</code></pre>
    <p>
     这时再去执行单元测试，
     <strong>
      正常执行
     </strong>
     ，同时test-classes路径下已经有了xml资源配置文件，如下图：
     <br/>
     <img alt="打包前" src="https://i-blog.csdnimg.cn/blog_migrate/0d4f85f4d47af69a981a3ce13005e772.png">
      <img alt="打包后" src="https://i-blog.csdnimg.cn/blog_migrate/b4d71d277188a24ca7618ba0af324736.png">
       <br/>
       单元测试的坑算是填了，再接着填其他坑吧。。。
      </img>
     </img>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f4d75457248756f5875:2f61727469636c652f64657461696c732f3836373530343937" class_="artid" style="display:none">
 </p>
</div>


