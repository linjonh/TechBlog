---
layout: post
title: "音视频学习之rtsp推拉流学习2流媒体服务器ZLMediaKit"
date: 2024-12-19 00:17:05 +0800
description: "公司项目需要实现一个只是rtsp推流和rtsp拉流的业务机制，据说ZLMediaKit能满足rtsp"
keywords: "zlmediakit可以支持多路视频流接收吗"
categories: ['音视频']
tags: ['音视频', 'Zlmediakit']
artid: "122479324"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=122479324
    alt: "音视频学习之rtsp推拉流学习2流媒体服务器ZLMediaKit"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=122479324
featuredImagePreview: https://bing.ee123.net/img/rand?artid=122479324
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     音视频学习之rtsp推拉流学习2（流媒体服务器ZLMediaKit）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     公司项目需要实现一个只是rtsp推流和rtsp拉流的业务机制，据说ZLMediaKit能满足rtsp推拉流的相关业务。
    </p>
    <p>
     对ZLMediaKit流媒体服务器进行安装以及了解。
    </p>
    <h2>
     <a id="0Readme_4">
     </a>
     0：从开源库Readme中对其功能进行了解
    </h2>
    <p>
     简单认识ZLMediaKit，了解ZLMediaKit能实现的基本功能，我的理解是他就是一个流媒体服务器。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e5e876331b56e8a05a76b0de9b9a3c52.png#pic_center"/>
    </p>
    <h2>
     <a id="1ZLMediaKit_9">
     </a>
     1：ZLMediaKit环境搭建
    </h2>
    <p>
     使用linux虚拟机环境进行环境搭建，并启动：
    </p>
    <pre><code class="prism language-bash"><span class="token comment">#ZLMediaKit采⽤了C++11的语法和库，要求编译器⽀持完整的C++11标准。</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> cmake
<span class="token function">git</span> clone --depth <span class="token number">1</span> https://gitee.com/xia-chu/ZLMediaKit.git
<span class="token builtin class-name">cd</span> ZLMediaKit/
<span class="token comment">#注意一定要执行</span>
<span class="token function">git</span> submodule update --init
<span class="token function">mkdir</span> build
<span class="token function">sudo</span> cmake <span class="token punctuation">..</span>
<span class="token function">make</span> -j4

<span class="token comment">#相关依赖库 这里先测试基础功能 只安装openssl库</span>
<span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> libssl-dev
 <span class="token comment">#除了openssl,其他其实都可以不安装</span>
<span class="token comment">#sudo apt-get install libssl-dev</span>
<span class="token comment">#sudo apt-get install libsdl-dev</span>
<span class="token comment">#sudo apt-get install libavcodec-dev</span>
<span class="token comment">#sudo apt-get install libavutil-dev</span>
<span class="token comment">#sudo apt-get install ffmpeg</span>

<span class="token comment">#在release 目录下生成相关的可执行文件 这里暂时作为测试只关注MediaServer 主进程文件</span>
hlp@ubuntu:~/ZLMediaKit/release/linux/Debug$ <span class="token builtin class-name">pwd</span>
/home/hlp/ZLMediaKit/release/linux/Debug
./MediaServer -h	<span class="token comment">#查看相关参数</span>
<span class="token function">sudo</span> ./MediaServer -d <span class="token operator">&amp;</span>	<span class="token comment">#启动 </span>
<span class="token comment">#注意观察日志，启动逻辑正常</span>
</code></pre>
    <h2>
     <a id="2rtsprtmprtp_41">
     </a>
     2：对rtsp，rtmp，rtp推流和拉流进行测试
    </h2>
    <p>
     ZLMediaKit作为一个流媒体服务器，使用ffmpeg/obs，ffplay/vlc等工具作为推流端或者拉流端，进行基础功能的测试。
    </p>
    <h3>
     <a id="21rtspffmpegvlcffplay_45">
     </a>
     2.1：测试rtsp推流和拉流：使用ffmpeg推流，vlc/ffplay拉流测试
    </h3>
    <h4>
     <a id="211_ffmpegvlc_47">
     </a>
     2.1.1: ffmpeg进行推流，vlc拉流进行测试
    </h4>
    <p>
     <strong>
      启动ZLMediaKit, 使用ffmpeg推流命令
     </strong>
     ：
    </p>
    <pre><code class="prism language-bash">ffmpeg -re -i <span class="token string">"time.mp4"</span> -vcodec h264 -acodec aac -f rtsp -rtsp_transport tcp rtsp://192.168.0.110/live/test
<span class="token comment">#rtsp进行推流 推流用的tcp</span>
</code></pre>
    <p>
     <strong>
      vlc拉流进行验证
     </strong>
     ，会发现播放正常：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/8b907f0d67f87732e13d6ed945123a86.png#pic_center"/>
    </p>
    <h3>
     <a id="212ffplayrtsprtmp_59">
     </a>
     2.1.2：如果使用ffplay进行测试，试试用rtsp/rtmp拉流。
    </h3>
    <p>
     使用ffplay进行拉流相关命令：
    </p>
    <pre><code class="prism language-bash"><span class="token comment">#这里应该用的默认端口</span>
ffplay -rtsp_transport tcp rtsp://192.168.0.110/live/test
ffplay -rtsp_transport udp rtsp://192.168.0.110/live/test
ffplay rtmp://192.168.0.110/live/test
</code></pre>
    <p>
     拉流相关现象如下图，会发现rtsp以及rtmp拉流时，实时性有一定的差异。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5f9c42f190538fa287662039c19cbcf9.png#pic_center"/>
    </p>
    <h3>
     <a id="22rtmp_73">
     </a>
     2.2：使用rtmp进行推流和拉流测试：
    </h3>
    <h4>
     <a id="221ffmpeg_rtmp_75">
     </a>
     2.2.1：ffmpeg 使用rtmp推流命令
    </h4>
    <pre><code class="prism language-bash">-re 表示按时间戳读取文件
-vcodec vedio编码格式
-acodec audio编码格式
-f  表示输出格式
<span class="token comment">#使用rtmp进行推流命令</span>
ffmpeg -re -i <span class="token string">"time.mp4"</span> -vcodec h264 -acodec aac -f flv rtmp://192.168.0.110/live/test
</code></pre>
    <p>
     使用vlc简单测试拉流，播放成功，同时发现，使用rtmp,rtsp（udp、tcp的rtp方式），时间戳差异变化也挺大的：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/6d2957cae6f8ee274c761119e266b711.png#pic_center"/>
    </p>
    <h4>
     <a id="222ffmpegffplay_89">
     </a>
     2.2.2：如果使用ffmpeg推流，用ffplay进行拉流测试一下。
    </h4>
    <pre><code class="prism language-bash"><span class="token comment">#使用rtmp进行推流命令</span>
ffmpeg -re -i <span class="token string">"time.mp4"</span> -vcodec h264 -acodec aac -f flv rtmp://192.168.0.110/live/test
<span class="token comment">#ffplay拉流播放命令</span>
ffplay -rtsp_transport tcp rtsp://192.168.0.110/live/test
ffplay -rtsp_transport udp rtsp://192.168.0.110/live/test
ffplay rtmp://192.168.0.110/live/test
</code></pre>
    <p>
     也简单对比一下时间戳：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c4ffa9e09da2868a6bee5ab0772ae0d7.png#pic_center"/>
    </p>
    <h3>
     <a id="23rtp_104">
     </a>
     2.3：使用rtp进行推拉流测试
    </h3>
    <p>
     2.3.1 使用ffmpeg进行rtp推流
    </p>
    <p>
     rtp的推流和拉流个人有些许的知识盲点，这里暂时遗留
    </p>
    <pre><code class="prism language-bash"><span class="token comment">#使用rtp进行推流的命令： 但是我没有测通怎么播放</span>
ffmpeg -re -i <span class="token string">"time.mp4"</span> -vcodec h264 -acodec aac -f rtp_mpegts rtp://192.168.0.110:10000

<span class="token comment">#测试通过的一个逻辑： </span>
<span class="token comment">#借助ffmepg进行rtp推流以及基于ffplay进行播放的逻辑：（不需要借助服务器）</span>
ffmpeg -re -i time.mp4 -vcodec copy -f rtp rtp://127.0.0.1:123<span class="token operator"><span class="token file-descriptor important">4</span>&gt;</span>test.sdp
ffplay -protocol_whitelist <span class="token string">"file,udp,rtp"</span> -i test.sdp    <span class="token comment">#会发现播放成功</span>

<span class="token comment">#如下命令却没有播放成功 暂时遗留问题</span>
<span class="token comment">#ffplay -protocol_whitelist "file,udp,rtp" -i rtp://127.0.0.1:1234</span>
</code></pre>
    <h2>
     <a id="3wireshark_123">
     </a>
     3：用wireshark抓包一下，熟悉流程：
    </h2>
    <p>
     简单抓一下包，熟悉学习流程，这里使用rtsp udp进行推流，使用rtsp tcp进行拉流：
    </p>
    <pre><code>ffmpeg -re -i "time.mp4" -vcodec h264 -acodec aac -f rtsp -rtsp_transport udp rtsp://192.168.0.110/live/test
ffplay -rtsp_transport tcp rtsp://192.168.0.110/live/test
</code></pre>
    <h3>
     <a id="31ffmpeg__132">
     </a>
     3.1：使用ffmpeg进行推流时 抓包如下：
    </h3>
    <p>
     <strong>
      OPTION
     </strong>
     ：查询服务器端可⽤⽅法
    </p>
    <p>
     <strong>
      ANNOUNCE
     </strong>
     ： 发送媒体描述信息
    </p>
    <p>
     <strong>
      SETUP
     </strong>
     ：建⽴RTSP会话
    </p>
    <p>
     <strong>
      RECORD
     </strong>
     ：请求传送数据
    </p>
    <p>
     <strong>
      RTP
     </strong>
     ：数据推
    </p>
    <p>
     <strong>
      TEARDOWN
     </strong>
     ：关闭会话，退出
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/4bf751e5c39382f3a52682772534b401.png#pic_center">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/8743586e7319be50f229749cd5098d24.png#pic_center"/>
     </img>
    </p>
    <h3>
     <a id="32_148">
     </a>
     3.2：拉流抓包流程分析如下：
    </h3>
    <p>
     OPTION：查询服务器端可⽤⽅法
    </p>
    <p>
     <strong>
      DESCRIBE
     </strong>
     ：得到服务器媒体描述信息，一般时sdp信息
    </p>
    <p>
     SETUP：建⽴RTSP会话
    </p>
    <p>
     PLAY：请求开始传送数据
    </p>
    <p>
     RTP：数据传送播放中
    </p>
    <p>
     TEARDOWN：关闭会话，退出
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a5fbd4e5eca191b5f3616b625e681481.png#pic_center"/>
    </p>
    <h3>
     <a id="33rtsp_163">
     </a>
     3.3：rtsp推流和拉流流程总结
    </h3>
    <p>
     第一步:
     <strong>
      查询服务器端可用方法
     </strong>
     option
     <br/>
     第二步:
     <strong>
      交互媒体信息SDP
     </strong>
     ，推流：ANNOUNCE； 拉流：DESCRIBE
     <br/>
     第三步：
     <strong>
      请求建立会话
     </strong>
     ，这里基于tcp和基于udp的差异 SETUP,
     <br/>
     第四步：
     <strong>
      触发开始推流或者开始拉流
     </strong>
     ，推流：RECORD；拉流：PLAY，
     <br/>
     第五步：
     <strong>
      数据传输
     </strong>
     ，只是方向刚好相反，真正的推流或者拉流 rtp
     <br/>
     第六步：
     <strong>
      关闭会话
     </strong>
     ：TEARDOWN
    </p>
    <h2>
     <a id="4_172">
     </a>
     4：总结
    </h2>
    <p>
     想要对rtsp推拉流做了解，先实践做练习，为后面做准备
    </p>
    <p>
     对ZLMediaKit流媒体服务器以及相关推拉流进行测试。
    </p>
    <p>
     下一步计划：obs软件基本使用（obs是一个功能很强大的软件，本来想试着操作一下，但发现有些困难）
    </p>
    <p>
     音视频相关理论学习及实践参考：
     <a href="https://ke.qq.com/course/3202131?flowToken=1041281" rel="nofollow">
      推荐免费订阅
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f79756e363835333939322f:61727469636c652f64657461696c732f313232343739333234" class_="artid" style="display:none">
 </p>
</div>


