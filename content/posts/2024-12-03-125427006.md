---
layout: post
title: "Qt随手记sqlite几百万行数据性能测试"
date: 2024-12-03 23:00:51 +0800
description: "在UOS1042系统、Intel i78750H、16GB内存环境下，使用Qt5.15和SQLite"
keywords: "sqlite多少数据量会卡顿"
categories: ['Qt']
tags: ['数据库', 'Sqlite', 'Qt']
artid: "125427006"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=125427006
    alt: "Qt随手记sqlite几百万行数据性能测试"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=125427006
featuredImagePreview: https://bing.ee123.net/img/rand?artid=125427006
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Qt随手记：sqlite几百万行数据性能测试
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     环境：
    </h3>
    <p>
     Uos1042版本、cpu i7 8750H 内存16G 笔记本
     <br/>
     Qt5.15、sqlite3
     <br/>
     单表 19个字段
    </p>
    <h3>
     <a id="_6">
     </a>
     期望：
    </h3>
    <p>
     查询速度要快；更新较少，每天或几天更新一次，更新的时间恰当即可。
    </p>
    <h3>
     <a id="_10">
     </a>
     测试情况：
    </h3>
    <p>
     条件：测试过程涵盖产生数据时间、插入时间时间、是否内存时间。比如插入100万行数据的产生数据时间就有100万次for循环。并且表除了主键，没有其它索引。
     <br/>
     插入100万行 40S. 每行有19个字段，数据库文件占225M
     <br/>
     插入1000万行，1个小时没完成，测试程序卡死。占用内存90%。经过分析，其实1000万行数据在30分钟左右时就插入完毕。可能是内存不足，导致响应特别慢。数据库文件占空间2.5G。由于笔记本内存不足，接下来不再测试1000万行的情况。
     <br/>
     插入300万行，122910ms，即123秒，其中产生数据的时间和释放数据内存的时间占了96秒。接着，第二次插入300万行，128910ms，即129秒。第三次插入300万行，125575ms，即126秒。cpu保持在47%、内存保持在36%，其中数据本身占的内存23%。
     <br/>
     查询性能情况：
     <br/>
     查询语句 select * from 表名 where cardid=‘4600331’
     <br/>
     未建立索引的情况
     <br/>
     1000万行查询1.5秒
     <br/>
     建立索引后，1毫秒内
     <br/>
     在两个字段上建立索引后，插入数据时间变长。插入300万行，122910ms，即123秒，其中产生数据的时间和释放数据内存的时间占了96秒。接着，第二次插入300万行，128910ms，即129秒。第三次插入300万行，290575ms，即290秒。第四次插入100万行，279031ms，即279秒。建立索引后1000万行数据占空间2.8G。
     <br/>
     更新单行数据133ms。删除单行数据104ms。
     <br/>
     注意：建立索引后，插入数据时间倍增。第一次插入300万行约2分钟，接着第二次插入300万行5分钟，第三次约7分钟。
     <br/>
     上述性能测试结果已经满足当前的工作需要。
    </p>
    <h3>
     <a id="_26">
     </a>
     关键的测试源码
    </h3>
    <p>
     插入的代码
    </p>
    <pre><code class="prism language-cpp">QSqlDatabase db<span class="token punctuation">;</span>
QString addCmd <span class="token operator">=</span> <span class="token function">QString</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO 表名(AJQY, AJTD,  XM,   XB,  MZ,   ZH,  ZJLX,  ZZ,  TXSJ, SFYJ, YJDJ, YJNR,  ZQMJ,  YJSJ,   CZMJ,  CZSJ , ZJIMAGEPATH, PZIMAGEPATH) \
                                      VALUES(?, ?, ?, ?, ?, ?, ?,  ?, ?, ?, ?,  ?, ?, ?, ?, ?, ?,?)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QSqlQuery <span class="token function">query</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>addCmd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//有助于加快解析sql语句</span>
    QVariantList v2<span class="token punctuation">,</span>v3<span class="token punctuation">,</span>v4<span class="token punctuation">,</span>v5<span class="token punctuation">,</span>v6<span class="token punctuation">,</span>v7<span class="token punctuation">,</span>v8<span class="token punctuation">,</span>v9<span class="token punctuation">,</span>v10<span class="token punctuation">,</span>v11<span class="token punctuation">,</span>v12<span class="token punctuation">,</span>v13<span class="token punctuation">,</span>v14<span class="token punctuation">,</span>v15<span class="token punctuation">,</span>v16<span class="token punctuation">,</span>v17<span class="token punctuation">,</span>v18<span class="token punctuation">,</span>v19<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span> item <span class="token operator">:</span> piList<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        v2 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>AJQY1<span class="token punctuation">;</span>
        v3 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>AJTD2<span class="token punctuation">;</span>
        v4 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>XM3<span class="token punctuation">;</span>
        v5 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>XB4<span class="token punctuation">;</span>
        v6 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>MZ5<span class="token punctuation">;</span>
        v7 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>ZH6<span class="token punctuation">;</span>
        v8 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>ZJLX7<span class="token punctuation">;</span>
        v9 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>ZZ8<span class="token punctuation">;</span>
        v10 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>TXSJ9<span class="token punctuation">;</span>
        v11 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>SFYJ10<span class="token punctuation">;</span>
        v12 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>YJDJ11<span class="token punctuation">;</span>
        v13 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>YJNR12<span class="token punctuation">;</span>
        v14 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>ZQMJ14<span class="token punctuation">;</span>
        v15 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>YJSJ13<span class="token punctuation">;</span>
        v16 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>CZMJ15<span class="token punctuation">;</span>
        v17 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>CZSJ16<span class="token punctuation">;</span>
        v18 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>ZJIMAGEPATH17<span class="token punctuation">;</span>
        v19 <span class="token operator">&lt;&lt;</span> item<span class="token operator">-&gt;</span>PZIMAGEPATH18<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v4<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v6<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v8<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v9<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v10<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v11<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v12<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v13<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v14<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v15<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v16<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v17<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v18<span class="token punctuation">)</span><span class="token punctuation">;</span>
    query<span class="token punctuation">.</span><span class="token function">addBindValue</span><span class="token punctuation">(</span>v19<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>query<span class="token punctuation">.</span><span class="token function">execBatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
	 db<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    db<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    query<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     查询、删除和更新
     <br/>
     SELECT * FROM 表名 WHERE ZH=‘46000119901050342456486’
     <br/>
     UPDATE 表名 SET XM=‘李四’ WHERE ZH=‘11000119901119162999970’
     <br/>
     DELETE FROM 表名 WHERE ZH=‘11000119901119162999970’
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f6368635f6f66666963652f:61727469636c652f64657461696c732f313235343237303036" class_="artid" style="display:none">
 </p>
</div>


