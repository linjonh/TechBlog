---
layout: post
title: "网络编程WSAAsyncSelect-模型"
date: 2025-03-09 17:20:57 +0800
description: "这也是该模型的一个缺点。(5)为一个FD_READ网络事件不要多次调用recv(函数，如果应用程序为一个FD_READ 网络事件调用多个recv()函数，就会使得该应用程序收到多个FD_READ  网络事件。Windows sockets应用程序在 创建套接字后，调用WSAAsyncSelect 函数注册感兴趣的网络事件，当该事件发生时Windows  窗口收到消息，应用程序就可以对接收到的网络事件进行处理了。尽管应用程序调用上述函数取消了网络事件通知，但是在应用程序消息队列中，可能还有 网络消息在排队。"
keywords: "【网络编程】WSAAsyncSelect 模型"
categories: ['网络编程']
tags: ['网络', 'C']
artid: "146134652"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146134652
    alt: "网络编程WSAAsyncSelect-模型"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146134652
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146134652
cover: https://bing.ee123.net/img/rand?artid=146134652
image: https://bing.ee123.net/img/rand?artid=146134652
img: https://bing.ee123.net/img/rand?artid=146134652
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【网络编程】WSAAsyncSelect 模型
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="IO_0">
     </a>
     十、基于I/O模型的网络开发
    </h2>
    <p>
     接着上次的博客继续分享：
     <a href="https://blog.csdn.net/Antonio915/article/details/146132757?spm=1001.2014.3001.5501">
      select模型
     </a>
    </p>
    <h3>
     <a id="108_WSAAsyncSelect_4">
     </a>
     10.8 异步选择模型WSAAsyncSelect
    </h3>
    <h4>
     <a id="1081___6">
     </a>
     10.8.1 基本概念
    </h4>
    <ul>
     <li>
      <p>
       WSAAsyncSelect模型是Windows socket的一个异步I/O 模型，利用这个模型，应用程序 可在一个套接字上接收以Windows 消息为基础的网络事件通知。
      </p>
     </li>
     <li>
      <p>
       Windows sockets应用程序在 创建套接字后，调用WSAAsyncSelect 函数注册感兴趣的网络事件，当该事件发生时Windows 窗口收到消息，应用程序就可以对接收到的网络事件进行处理了。
      </p>
     </li>
     <li>
      <p>
       利用WSAAsyncSelect 函数， 将socket 消息发送到hWnd 窗口上，然后在那里处理相应的FD_READ 、FD_WRITE 等消息。
      </p>
     </li>
     <li>
      <p>
       WSAAsyncSelect 模型与select 模型的相同点是它们都可以对多个套接字进行管理。
      </p>
     </li>
     <li>
      <p>
       但它 们也有不小的区别。首先WSAAsyncSelect 模型是异步的，且通知方式不同。更重要的一点是： WSAAsyncSelect 模型应用在基于消息的Windows 环境下，使用该模型时必须创建窗口，而 select 模型可以广泛应用在UNIX/Linux 系统，使用该模型不需要创建窗口。最后一点区别是：应用程序在调用WSAAsyncSelect 函数后，套接字就被设置为非阻塞状态；而使用select 函数 不改变套接字的工作方式。
      </p>
     </li>
     <li>
      <p>
       由于要关联一个Windows 窗口来接收消息，因此如果处理成千上万的套接字就力不从心 了。这也是该模型的一个缺点。另外，由于调用WSAAsyncSelect 后，套接字被设为非阻塞模 式，那么其他一些函数调用不一定能成功返回，必须要对这些函数的调用返回做处理。对于这 一点，可以从accept() 、receive() 和 send() 等函数的调用中得到验证。
      </p>
     </li>
     <li>
      <p>
       WSAAsyncSelect模型也有其优点，即提供了读写数据能力的异步通知。而且，该模型为 确保接收所有数据提供了很好的机制，通过注册FD_CLOSE网络事件，可以从容关闭服务器与客户端的连接，保证了数据的全部接收。
      </p>
     </li>
    </ul>
    <h4>
     <a id="1082__WSAAsyncSelect_19">
     </a>
     10.8.2 WSAAsyncSelect函数
    </h4>
    <p>
     WSAAsyncSelect函数会自动将套接字设置为非阻塞模式，并且把发生在该套接字上且是 你所感兴趣的事件以Windows 消息的形式发送到指定的窗口。
    </p>
    <p>
     WSAAsyncSelect函数声明如下：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">WSAAsyncSelect</span><span class="token punctuation">(</span>
    in SOCKET s<span class="token punctuation">,</span>
    in HWND hWnd<span class="token punctuation">,</span>
    __in <span class="token keyword">unsigned</span> <span class="token keyword">int</span> wMsg<span class="token punctuation">,</span>
    __in <span class="token keyword">long</span> lEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <p>
       s: 标识一个需要事件通知的套接口的描述符。
      </p>
     </li>
     <li>
      <p>
       hWnd: 标识一个在网络事件发生时需要接收消息的窗口句柄。
      </p>
     </li>
     <li>
      <p>
       wMsg: 在网络事件发生时要接收的消息。
      </p>
     </li>
     <li>
      <p>
       IEvent: 位屏蔽码，用于指明应用程序感兴趣的网络事件集合。IEvent 参数可取下列 值：
      </p>
     </li>
     <li>
      <ul>
       <li>
        FD_READ: 欲接收读准备好的通知。发生FD_READ 的条件是：
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        <ul>
         <li>
          调 用recv 或 者recvfrom 函数后，仍然有数据可读。
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        <ul>
         <li>
          调用WSAAsyncSelect 有数据可读。
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        FD_WRITE: 欲接收写准备好的通知。发生FD_WRITE 的条件是：
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        <ul>
         <li>
          当调用WSAAsyncSelect 函数时，如果调用能够发送数据。
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        <ul>
         <li>
          调用connect 或 者accept 函数后，当连接已经建立时。
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        <ul>
         <li>
          调用send 或 者sendto, 返 回WSAWOULDBLOCK 错误码，再次调用send 或 者sendto 函数可能成功时。
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        FD_OOB: 欲接收带边数据到达的通知。
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        FD_ACCEPT: 欲接收将要连接的通知。
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        FD_CONNECT: 欲接收已连接好的通知。
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        FD_CLOSE: 欲接收套接口关闭的通知。发生FD CLOSE 的条件是：
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        <ul>
         <li>
          当调用WSAAsyncSelect 函数时，套接字连接关闭时。
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        <ul>
         <li>
          对方执行从容关闭后，没有数据可读时，如果数据已经到达并等待读取，FD_CLOSE 事件不会被发送，直到所有数据都被接收。
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        <ul>
         <li>
          调用shutdown 函数执行从容关闭，对方应答FIN 后，此时无数据可读。
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        <ul>
         <li>
          对方结束了连接，并且lparam 包 含WSAECONNRESET 错误时。
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        FD_QOS: 欲接收套接字服务质量发生变化的通知。
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        FD_GROUP_QOS: 欲接收套接字组服务质量发生变化的通知。
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        FD_ADDRESS_LIST_CHANGE: 欲接收针对套接字的协议簇，本地地址列表发生变化的通知。
       </li>
      </ul>
     </li>
     <li>
      <ul>
       <li>
        FD ROUTING INTERFACE CHANGE: 欲在指定方向上与路由接口发生变化的通知 。
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <p>
     如果函数成功就返回0,如果出错就返回 SOCKET_ERROR,此时可用函数 WSAGetLastError 获取更多信息。
    </p>
    <p>
     可根据需要同时注册多个网络事件，这时要把网络事件类型执行按位或(OR) 运算，然 后将它们分配给 IEvent 参数。例如，应用程序希望在套接字上接收连接完成、数据可读和套 接字关闭的网络事件，可调用如下函数：
    </p>
    <pre><code class="prism language-cpp"><span class="token function">WSAAsyncSelect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> hwnd<span class="token punctuation">,</span> WM_SOCKET<span class="token punctuation">,</span> FD_CONNECT <span class="token operator">|</span> FD_READ <span class="token operator">|</span> FD_CLOSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     当该套接字连接完成、有数据可读或者套接字关闭的网络事件发生时，就会有 WM_SOCKET消息发送给窗口句柄为hwnd 的窗口。
    </p>
    <p>
     <em>
      值得注意的是，启动一个 WSAAsyncSelect 将使为同一个套接口启动的所有先前的 WSAAsyncSelect 作废。
     </em>
    </p>
    <p>
     <strong>
      使用WSAAsyncSelect 函数需要注意的地方：
     </strong>
    </p>
    <ul>
     <li>
      (1)调用该函数后，套接字被设置为非阻塞模式，要想恢复为阻塞模式，必须再次调用 该函数，取消掉注册过的事件，再调用ioctlsocket 设为阻塞模式。如果要取消所有的网络事件通知，告知windows sockets实现不再为该套接字发送任何网
      <br/>
      络事件相关的消息，要以参数IEvent 值为0调用函数，即
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token function">WSAAsyncSelect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> hwnd<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     尽管应用程序调用上述函数取消了网络事件通知，但是在应用程序消息队列中，可能还有 网络消息在排队。所以调用上述函数取消网络事件消息后，应用程序还应该继续准备接收网络 事 件 。
    </p>
    <ul>
     <li>
      (2)消息函数的wParam 参数为事件发生的套接字，LParam 对应错误消息和相应的事件， 可以调用宏WSAGETSELECTERROR(IParam) 、WSAGETSELECTEVENT(IParam) 来获取具体 的 信 息 。
     </li>
     <li>
      (3)多次调用WSAAsyncSelect 函数在同一个套接字上注册不同的事件(多次调用采用 同样或者不同样的消息),最后一次调用将取消前面注册的事件。比如前后两次调用：
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token function">WSAAsyncSelect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> hwnd<span class="token punctuation">,</span> WM_SOCKET<span class="token punctuation">,</span> FD_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">WSAAsyncSelect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> hwnd<span class="token punctuation">,</span> WM_SOCKET<span class="token punctuation">,</span> FD_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     此时虽然消息相同，都是WM_SOCKET, 但是应用程序只能接收到FD_WRITE 网络事件。
    </p>
    <p>
     还有一种情况是消息不同、网络事件也不同，比如：
    </p>
    <pre><code class="prism language-cpp"><span class="token function">WSAAsyncSelect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> hwnd<span class="token punctuation">,</span> wMsg1<span class="token punctuation">,</span> FD_READ<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">WSAAsyncSelect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> hwnd<span class="token punctuation">,</span> wMsg2<span class="token punctuation">,</span> FD_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     第二次函数调用依旧将会取消第一次函数调用的作用，只有 FD_WRITE 网络事件通过wMsg2 通知到窗口。
     <br/>
     这也是很多初学者发现接收不到网络事件的原因。因为最后一次调用将取消前面注册的事 件。
    </p>
    <ul>
     <li>
      (4)使用accept 函数建立的套接字与监听套接字具有同样的属性，也就是说，在监听套 接字上注册的事件同样会对建立连接的套接字起作用，如果一个监听套接字请求 FD_READ 和 FD_WRITE 网络事件，那么在该监听套接字上接受的任何套接字也会请求 FD_READ 和 FD_WRITE 网络事件，以及发送同样的消息。
     </li>
     <li>
     </li>
    </ul>
    <p>
     我们一般会在监听套接字建立连接后重新为其注册事件。
    </p>
    <ul>
     <li>
      <p>
       (5)为一个FD_READ网络事件不要多次调用recv(函数，如果应用程序为一个FD_READ 网络事件调用多个recv()函数，就会使得该应用程序收到多个FD_READ 网络事件。如果在一 次接收FD_READ 网络事件时需要调用多次 recv()函数，应用程序就应该在调用recv()函数之 前关闭FD_READ消息。
      </p>
     </li>
     <li>
      <p>
       (6)使用FD_CLOSE 事件来判断套接字是否已经关闭，错误代码指示套接字是从容关闭 还是硬关闭：错误码为0,代表从容关闭；错误码为WSAECONNERESET, 则为硬关闭。如 果套接字从容关闭，数据全部接收，应用程序就会收到FD_CLOSE。
      </p>
     </li>
     <li>
      <p>
       (7)发送数据出现失败。一个应用程序当接收到第一个FD_WRITE 网络事件后，便认为 在该套接字上可以发送数据。当调用输出函数发送数据时，会收到 WSAEWOULDBLOCKE 错误。经过这样的失败后，要在下一次接收到FD_WRITE网络事件后再次发送数据，才能够 将数据成功发送。
      </p>
     </li>
    </ul>
    <h4>
     <a id="1083___WSAAsyncSelect__109">
     </a>
     10.8.3 实战WSAAsyncSelect 模型
    </h4>
    <p>
     WSAAsyncSelect 传参需要窗口句柄。为了简化代码，这里直接创建了一个mfc 对话框程 序，用m_hwnd 给 WSAAsyncSelect 传参。对话框类名为WSAAsyncSelecDlg。
    </p>
    <p>
     <strong>
      服务端
     </strong>
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_WINSOCK_DEPRECATED_NO_WARNINGS</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;winsock2.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">"ws2_32.lib"</span><span class="token expression"><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">WM_SOCKET</span> <span class="token expression"><span class="token punctuation">(</span>WM_USER <span class="token operator">+</span> <span class="token number">101</span><span class="token punctuation">)</span></span></span>

<span class="token comment">//-------------------窗口过程----------------------</span>
LRESULT CALLBACK <span class="token function">WindowProc</span><span class="token punctuation">(</span>HWND hwnd<span class="token punctuation">,</span> UINT uMsg<span class="token punctuation">,</span> WPARAM wParam<span class="token punctuation">,</span> LPARAM lParam<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>uMsg<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> WM_SOCKET<span class="token operator">:</span>
    <span class="token punctuation">{<!-- --></span>
        SOCKET ss <span class="token operator">=</span> wParam<span class="token punctuation">;</span>   <span class="token comment">// wParam 参数标志了网络事件发生的套接口</span>
        <span class="token keyword">long</span> event <span class="token operator">=</span> <span class="token function">WSAGETSELECTEVENT</span><span class="token punctuation">(</span>lParam<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 事件</span>
        <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token function">WSAGETSELECTERROR</span><span class="token punctuation">(</span>lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 错误码</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">closesocket</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> FD_ACCEPT<span class="token operator">:</span>   <span class="token comment">//-----①连接请求到来</span>
        <span class="token punctuation">{<!-- --></span>
            sockaddr_in Cadd<span class="token punctuation">;</span>
            <span class="token keyword">int</span> Cadd_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Cadd<span class="token punctuation">)</span><span class="token punctuation">;</span>
            SOCKET sNew <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> <span class="token punctuation">(</span>sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>Cadd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Cadd_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sNew <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">MessageBox</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> L<span class="token string">"调用accept()失败！"</span><span class="token punctuation">,</span> L<span class="token string">"标题栏提示"</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">WSAAsyncSelect</span><span class="token punctuation">(</span>sNew<span class="token punctuation">,</span> hwnd<span class="token punctuation">,</span> WM_SOCKET<span class="token punctuation">,</span> FD_READ <span class="token operator">|</span> FD_CLOSE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> FD_READ<span class="token operator">:</span>   <span class="token comment">//-----②数据发送来</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">char</span> cbuf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">memset</span><span class="token punctuation">(</span>cbuf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cbuf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> cRecv <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> cbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>cbuf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cRecv <span class="token operator">==</span> SOCKET_ERROR <span class="token operator">&amp;&amp;</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> WSAECONNRESET<span class="token punctuation">)</span> <span class="token operator">||</span> cRecv <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">MessageBox</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> L<span class="token string">"调用recv()失败！"</span><span class="token punctuation">,</span> L<span class="token string">"标题栏提示"</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">closesocket</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cRecv <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 转换消息为宽字符</span>
                <span class="token keyword">wchar_t</span> wbuf<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token function">MultiByteToWideChar</span><span class="token punctuation">(</span>CP_ACP<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cbuf<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> wbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>wbuf<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">wchar_t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">MessageBox</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> wbuf<span class="token punctuation">,</span> L<span class="token string">"收到的信息"</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">char</span> Sbuf<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"Hello client! I am server"</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> isend <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>ss<span class="token punctuation">,</span> Sbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>Sbuf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isend <span class="token operator">==</span> SOCKET_ERROR <span class="token operator">||</span> isend <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">MessageBox</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> L<span class="token string">"发送消息失败！"</span><span class="token punctuation">,</span> L<span class="token string">"标题栏提示"</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token function">MessageBox</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> L<span class="token string">"已经发信息到客户端！"</span><span class="token punctuation">,</span> L<span class="token string">"标题栏提示"</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

        <span class="token keyword">case</span> FD_CLOSE<span class="token operator">:</span>    <span class="token comment">//----③关闭连接</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">closesocket</span><span class="token punctuation">(</span>ss<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> WM_CLOSE<span class="token operator">:</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>IDYES <span class="token operator">==</span> <span class="token function">MessageBox</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> L<span class="token string">"是否确定退出？"</span><span class="token punctuation">,</span> L<span class="token string">"message"</span><span class="token punctuation">,</span> MB_YESNO<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">DestroyWindow</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> WM_DESTROY<span class="token operator">:</span>
        <span class="token function">PostQuitMessage</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">return</span> <span class="token function">DefWindowProc</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> uMsg<span class="token punctuation">,</span> wParam<span class="token punctuation">,</span> lParam<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//----------------WinMain()函数------------------</span>
<span class="token keyword">int</span> WINAPI <span class="token function">WinMain</span><span class="token punctuation">(</span>HINSTANCE hInstance<span class="token punctuation">,</span> HINSTANCE hPrevInstance<span class="token punctuation">,</span> LPSTR lpCmdLine<span class="token punctuation">,</span> <span class="token keyword">int</span> nShowCmd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    WNDCLASS wc<span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>style <span class="token operator">=</span> CS_HREDRAW <span class="token operator">|</span> CS_VREDRAW<span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>lpfnWndProc <span class="token operator">=</span> WindowProc<span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>cbClsExtra <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>cbWndExtra <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>hInstance <span class="token operator">=</span> hInstance<span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>hIcon <span class="token operator">=</span> <span class="token function">LoadIcon</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> IDI_APPLICATION<span class="token punctuation">)</span><span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>hCursor <span class="token operator">=</span> <span class="token function">LoadCursor</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> IDC_ARROW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    HBRUSH hbrush <span class="token operator">=</span> <span class="token function">CreateSolidBrush</span><span class="token punctuation">(</span><span class="token function">RGB</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>hbrBackground <span class="token operator">=</span> hbrush<span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>lpszMenuName <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    wc<span class="token punctuation">.</span>lpszClassName <span class="token operator">=</span> L<span class="token string">"Test"</span><span class="token punctuation">;</span>

    <span class="token comment">//---注册窗口类（使用宽字符版本函数）---- </span>
    <span class="token function">RegisterClassW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wc<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//---创建窗口---- </span>
    HWND hwnd <span class="token operator">=</span> <span class="token function">CreateWindowW</span><span class="token punctuation">(</span>L<span class="token string">"Test"</span><span class="token punctuation">,</span> L<span class="token string">"WSAAsyncSelect模型-服务端窗口"</span><span class="token punctuation">,</span> WS_SYSMENU<span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">600</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> hInstance<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hwnd <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">MessageBoxW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> L<span class="token string">"创建窗口出错"</span><span class="token punctuation">,</span> L<span class="token string">"标题栏提示"</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//---显示窗口---- </span>
    <span class="token function">ShowWindow</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> SW_SHOWNORMAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">UpdateWindow</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//---初始化WSA---</span>
    WSADATA wsaData<span class="token punctuation">;</span>
    WORD wVersionRequested <span class="token operator">=</span> <span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WSAStartup</span><span class="token punctuation">(</span>wVersionRequested<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsaData<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">MessageBoxW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> L<span class="token string">"WSAStartup() Failed"</span><span class="token punctuation">,</span> L<span class="token string">"调用失败"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    SOCKET s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> INVALID_SOCKET<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">MessageBoxW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> L<span class="token string">"socket() Failed"</span><span class="token punctuation">,</span> L<span class="token string">"调用失败"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    sockaddr_in sin<span class="token punctuation">;</span>
    sin<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    sin<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    sin<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>S_un<span class="token punctuation">.</span>S_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span>sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sin<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sin<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">MessageBoxW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> L<span class="token string">"bind() Failed"</span><span class="token punctuation">,</span> L<span class="token string">"调用失败"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">listen</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">MessageBoxW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> L<span class="token string">"listen() Failed"</span><span class="token punctuation">,</span> L<span class="token string">"调用失败"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        <span class="token function">MessageBoxW</span><span class="token punctuation">(</span>hwnd<span class="token punctuation">,</span> L<span class="token string">"进入监听状态！"</span><span class="token punctuation">,</span> L<span class="token string">"标题栏提示"</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">WSAAsyncSelect</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> hwnd<span class="token punctuation">,</span> WM_SOCKET<span class="token punctuation">,</span> FD_ACCEPT <span class="token operator">|</span> FD_CLOSE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//---消息循环----</span>
    MSG msg<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">GetMessageW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">TranslateMessage</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">DispatchMessageW</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">closesocket</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> msg<span class="token punctuation">.</span>wParam<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      客户端
     </strong>
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_WINSOCK_DEPRECATED_NO_WARNINGS</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;WINSOCK2.H&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;windows.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;process.h&gt;</span>  </span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;string&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">BUF_SIZE</span> <span class="token expression"><span class="token number">64</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span></span><span class="token string">"wS2_32.lib"</span><span class="token expression"><span class="token punctuation">)</span></span></span>


<span class="token keyword">void</span> <span class="token function">recv</span><span class="token punctuation">(</span>PVOID pt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	SOCKET  sHost <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SOCKET<span class="token operator">*</span><span class="token punctuation">)</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//清空接收数据的缓冲区</span>
		<span class="token function">memset</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> retVal <span class="token operator">=</span> <span class="token function">recv</span><span class="token punctuation">(</span>sHost<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>SOCKET_ERROR <span class="token operator">==</span> retVal<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">int</span>  err <span class="token operator">=</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//无法立即完成非阻塞Socket上的操作</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> WSAEWOULDBLOCK<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//printf("\nwaiting  reply!");</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> WSAETIMEDOUT <span class="token operator">||</span> err <span class="token operator">==</span> WSAENETDOWN <span class="token operator">||</span> err <span class="token operator">==</span> WSAECONNRESET<span class="token punctuation">)</span><span class="token comment">//已建立连接</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">closesocket</span><span class="token punctuation">(</span>sHost<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

		<span class="token punctuation">}</span>

		<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\n%s"</span><span class="token punctuation">,</span> buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//break;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	WSADATA wsd<span class="token punctuation">;</span>
	SOCKET sHost<span class="token punctuation">;</span>
	SOCKADDR_IN servAddr<span class="token punctuation">;</span><span class="token comment">//服务器地址</span>
	<span class="token keyword">int</span> retVal<span class="token punctuation">;</span><span class="token comment">//调用Socket函数的返回值</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span>BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token comment">//初始化Socket环境</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">WSAStartup</span><span class="token punctuation">(</span><span class="token function">MAKEWORD</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>wsd<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"WSAStartup failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	sHost <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//设置服务器Socket地址</span>
	servAddr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
	servAddr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>S_un<span class="token punctuation">.</span>S_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//在实际应用中，建议将服务器的IP地址和端口号保存在配置文件中</span>
	servAddr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">6000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//计算地址的长度</span>
	<span class="token keyword">int</span> sServerAddlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>



	<span class="token comment">//调用ioctlsocket（）将其设置为非阻塞模式</span>
	<span class="token keyword">int</span> iMode <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	retVal <span class="token operator">=</span> <span class="token function">ioctlsocket</span><span class="token punctuation">(</span>sHost<span class="token punctuation">,</span> FIONBIO<span class="token punctuation">,</span> <span class="token punctuation">(</span>u_long FAR<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> iMode<span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token keyword">if</span> <span class="token punctuation">(</span>retVal <span class="token operator">==</span> SOCKET_ERROR<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ioctlsocket failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	<span class="token comment">//循环等待</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//连接到服务器</span>
		retVal <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>sHost<span class="token punctuation">,</span> <span class="token punctuation">(</span>LPSOCKADDR<span class="token punctuation">)</span><span class="token operator">&amp;</span>servAddr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>servAddr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>SOCKET_ERROR <span class="token operator">==</span> retVal<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//无法立即完成非阻塞Socket上的操作</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> WSAEWOULDBLOCK <span class="token operator">||</span> err <span class="token operator">==</span> WSAEINVAL<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"check  connect!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> WSAEISCONN<span class="token punctuation">)</span><span class="token comment">//已建立连接</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"connection failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">closesocket</span><span class="token punctuation">(</span>sHost<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>


	<span class="token keyword">unsigned</span> <span class="token keyword">long</span>     threadId <span class="token operator">=</span> <span class="token function">_beginthread</span><span class="token punctuation">(</span>recv<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sHost<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动一个线程接收数据的线程   </span>



	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//向服务器发送字符串，并显示反馈信息</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"input a string to send:\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		std<span class="token double-colon punctuation">::</span>string str<span class="token punctuation">;</span>
		<span class="token comment">//接收输入的数据</span>
		std<span class="token double-colon punctuation">::</span>cin <span class="token operator">&gt;&gt;</span> str<span class="token punctuation">;</span>
		<span class="token comment">//将用户输入的数据复制到buf中</span>
		<span class="token function">ZeroMemory</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> BUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">strcpy_s</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> str<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token string">"quit"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"quit!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			retVal <span class="token operator">=</span> <span class="token function">send</span><span class="token punctuation">(</span>sHost<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>SOCKET_ERROR <span class="token operator">==</span> retVal<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">int</span> err <span class="token operator">=</span> <span class="token function">WSAGetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>err <span class="token operator">==</span> WSAEWOULDBLOCK<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token comment">//无法立即完成非阻塞Socket上的操作</span>
					<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">continue</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">else</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"send failed!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">closesocket</span><span class="token punctuation">(</span>sHost<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">WSACleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>


	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      监听状态：
     </strong>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ffd5daf1ff674a64a1e31ffc5c1d023a.png"/>
    </p>
    <p>
     <strong>
      收到客户端消息：
     </strong>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ea2bc40a906c46b595caa6bfec6dbf30.png"/>
    </p>
    <p>
     <strong>
      参考书籍：《Visual C++2017 网络编程实战》
     </strong>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f416e746f6e696f3931352f:61727469636c652f64657461696c732f313436313334363532" class_="artid" style="display:none">
 </p>
</div>


