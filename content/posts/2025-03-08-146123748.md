---
layout: post
title: "Ubuntu-下-nginx-1.24.0-源码分析-ngx_cycle_modules"
date: 2025-03-08 22:18:43 +0800
description: "NGX_OK+1。"
keywords: "Ubuntu 下 nginx-1.24.0 源码分析 - ngx_cycle_modules"
categories: ['未分类']
tags: ['运维', 'Nginx']
artid: "146123748"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146123748
    alt: "Ubuntu-下-nginx-1.24.0-源码分析-ngx_cycle_modules"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146123748
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146123748
cover: https://bing.ee123.net/img/rand?artid=146123748
image: https://bing.ee123.net/img/rand?artid=146123748
img: https://bing.ee123.net/img/rand?artid=146123748
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Ubuntu 下 nginx-1.24.0 源码分析 - ngx_cycle_modules
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h4>
     <strong>
      声明
     </strong>
     在
     <span style="color:#be191c">
      <code>
       src/core/ngx_module.h
      </code>
     </span>
    </h4>
    <pre><code class="hljs">ngx_int_t ngx_cycle_modules(ngx_cycle_t *cycle);
</code></pre>
    <h4>
     <strong>
      实现
     </strong>
     在
     <span style="color:#be191c">
      <code>
       src/core/ngx_module.c
      </code>
     </span>
    </h4>
    <pre><code class="hljs">ngx_int_t
ngx_cycle_modules(ngx_cycle_t *cycle)
{
    /*
     * create a list of modules to be used for this cycle,
     * copy static modules to it
     */

    cycle-&gt;modules = ngx_pcalloc(cycle-&gt;pool, (ngx_max_module + 1)
                                              * sizeof(ngx_module_t *));
    if (cycle-&gt;modules == NULL) {
        return NGX_ERROR;
    }

    ngx_memcpy(cycle-&gt;modules, ngx_modules,
               ngx_modules_n * sizeof(ngx_module_t *));

    cycle-&gt;modules_n = ngx_modules_n;

    return NGX_OK;
}
</code></pre>
    <hr/>
    <h4>
     这个函数
     <span style="color:#be191c">
      <code>
       ngx_cycle_modules
      </code>
     </span>
     的作用是为当前Nginx服务器周期(cycle)初始化并设置模块列表。具体来说：
    </h4>
    <ol>
     <li>
      <h4>
       函数为当前周期分配内存，用于存储模块指针数组
      </h4>
     </li>
     <li>
      <h4>
       将静态定义的模块列表(
       <code>
        ngx_modules
       </code>
       )复制到当前周期的模块列表中
      </h4>
     </li>
     <li>
      <h4>
       设置当前周期的模块数量
      </h4>
     </li>
    </ol>
    <hr/>
    <h4>
     <code>
      ngx_cycle_modules
     </code>
     函数的签名如下：
    </h4>
    <pre><code class="hljs">ngx_int_t ngx_cycle_modules(ngx_cycle_t *cycle);
</code></pre>
    <h4>
     以下是对函数签名的详细解析：
    </h4>
    <hr/>
    <h4>
     1. 返回值类型
     <span style="color:#be191c">
      ngx_int_t
     </span>
     <br/>
     类型定义：ngx_int_t 是 Nginx 自定义的整数类型，用于统一跨平台的整数表示。
     <br/>
     语义：
     <br/>
     <span style="color:#be191c">
      NGX_OK
     </span>
     （值为 0）：表示函数执行成功。
     <br/>
     <span style="color:#be191c">
      NGX_ERROR
     </span>
     （值为 -1）：表示函数执行失败（如内存分配失败）。
     <br/>
     作用：通过返回状态码，通知调用者函数执行结果。
    </h4>
    <h4>
     <br/>
     <br/>
     2. 参数
     <span style="color:#be191c">
      ngx_cycle_t *cycle
     </span>
     <br/>
     参数类型：ngx_cycle_t 是 Nginx 的核心结构体，表示一个运行周期（如启动、重载配置时的实例）。
    </h4>
    <hr/>
    <h4>
     <br/>
     详解
    </h4>
    <hr/>
    <h5>
     <strong>
      注释部分
     </strong>
    </h5>
    <pre><code class="hljs">/*
 * create a list of modules to be used for this cycle,
 * copy static modules to it
 */
</code></pre>
    <h4>
     作用：说明函数的核心目标。
    </h4>
    <h4>
     <br/>
     背景：
     <br/>
     Nginx 的模块在编译时静态注册到全局数组 ngx_modules。
     <br/>
     每个运行周期（cycle）需要独立的模块列表，以支持配置重载时的多实例隔离。
    </h4>
    <h4>
     <br/>
     设计思想：
     <br/>
     隔离性：通过复制全局模块到 cycle，避免不同周期（如旧配置与新配置）的模块相互干扰。
    </h4>
    <hr/>
    <h3>
     <strong>
      分配模块数组内存
     </strong>
    </h3>
    <pre><code class="hljs">cycle-&gt;modules = ngx_pcalloc(cycle-&gt;pool, (ngx_max_module + 1) * sizeof(ngx_module_t *));
</code></pre>
    <h4>
     作用：在
     <span style="color:#be191c">
      cycle
     </span>
     的内存池中分配内存，存储模块指针数组。
    </h4>
    <h4>
     <br/>
     关键参数：
     <br/>
     <span style="color:#be191c">
      cycle-&gt;pool
     </span>
     ：Nginx 内存池，确保高效内存管理（避免频繁 malloc/free）。
     <br/>
     <span style="color:#be191c">
      ngx_max_module + 1
     </span>
     ：
     <span style="color:#be191c">
      ngx_max_module
     </span>
     是编译时定义的最大模块数，
     <span style="color:#be191c">
      +1
     </span>
     用于预留终止标记（如 NULL）
    </h4>
    <hr/>
    <h3>
     <strong>
      检查内存分配
     </strong>
    </h3>
    <pre><code class="hljs">if (cycle-&gt;modules == NULL) {
    return NGX_ERROR;
}
</code></pre>
    <ul>
     <li>
      <h4>
       <strong>
        作用
       </strong>
       ：验证内存分配是否成功。
      </h4>
     </li>
     <li>
      <h4>
       <strong>
        逻辑
       </strong>
       ：若
       <span style="color:#be191c">
        <code>
         ngx_pcalloc
        </code>
       </span>
       返回
       <span style="color:#be191c">
        <code>
         NULL
        </code>
       </span>
       ，直接返回错误码
       <span style="color:#be191c">
        <code>
         NGX_ERROR
        </code>
       </span>
      </h4>
     </li>
    </ul>
    <hr/>
    <h3>
     <strong>
      复制全局模块到周期模块列表
     </strong>
    </h3>
    <pre><code class="hljs">ngx_memcpy(cycle-&gt;modules, ngx_modules, ngx_modules_n * sizeof(ngx_module_t *));
</code></pre>
    <h4>
     作用：将全局模块数组
     <span style="color:#be191c">
      ngx_modules
     </span>
     拷贝到
     <span style="color:#be191c">
      cycle-&gt;modules
     </span>
    </h4>
    <h4>
     <br/>
     关键变量：
     <br/>
     <span style="color:#be191c">
      ngx_modules
     </span>
     ：全局静态模块数组，编译时生成。
    </h4>
    <h4>
     <span style="color:#be191c">
      ngx_modules_n
     </span>
     ：全局模块数量，编译时确定。
    </h4>
    <h4>
     仅复制实际存在的模块（ngx_modules_n 个），而非整个预分配空间。
    </h4>
    <hr/>
    <h3>
     <strong>
      记录模块数量
     </strong>
    </h3>
    <pre><code class="hljs">cycle-&gt;modules_n = ngx_modules_n;
</code></pre>
    <ul>
     <li>
      <h4>
       <strong>
        作用
       </strong>
       ：将全局模块数量
       <span style="color:#be191c">
        <code>
         ngx_modules_n
        </code>
       </span>
       赋值给
       <span style="color:#be191c">
        <code>
         cycle-&gt;modules_n
        </code>
       </span>
      </h4>
     </li>
     <li>
      <h4>
       <strong>
        逻辑
       </strong>
       ：
      </h4>
      <ul>
       <li>
        <h4>
         <span style="color:#be191c">
          <code>
           cycle-&gt;modules_n
          </code>
         </span>
         后续用于遍历模块（如初始化模块时）
        </h4>
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     <strong>
      返回成功状态
     </strong>
    </h4>
    <pre><code class="hljs">return NGX_OK;
</code></pre>
    <ul>
     <li>
      <h4>
       <strong>
        作用
       </strong>
       ：通知调用者函数执行成功。
      </h4>
     </li>
    </ul>
    <h3>
    </h3>
    <h3>
     <a href="https://blog.csdn.net/weixin_41812346/article/details/145931227?sharetype=blogdetail&amp;sharerId=145931227&amp;sharerefer=PC&amp;sharesource=weixin_41812346&amp;spm=1011.2480.3001.8118" title="Ubuntu 下 nginx-1.24.0 源码分析 - ngx_modules-CSDN博客">
      Ubuntu 下 nginx-1.24.0 源码分析 - ngx_modules-CSDN博客
     </a>
    </h3>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34313831323334362f:61727469636c652f64657461696c732f313436313233373438" class_="artid" style="display:none">
 </p>
</div>


