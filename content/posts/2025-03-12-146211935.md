---
layout: post
title: "双周报Vol.67-模式匹配支持守卫LLVM-后端发布支持-Attribute-语法...多项核心技术更新"
date: 2025-03-12 18:34:23 +0800
description: "enum支持自定义 tag 值，这在绑定 Native 的 C FFI 时非常有用。以opentest {"
keywords: "双周报Vol.67: 模式匹配支持守卫、LLVM 后端发布、支持 Attribute 语法...多项核心技术更新！"
categories: ['未分类']
tags: ['编程语言', '开发语言', 'Moonbit']
artid: "146211935"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146211935
    alt: "双周报Vol.67-模式匹配支持守卫LLVM-后端发布支持-Attribute-语法...多项核心技术更新"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146211935
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146211935
cover: https://bing.ee123.net/img/rand?artid=146211935
image: https://bing.ee123.net/img/rand?artid=146211935
img: https://bing.ee123.net/img/rand?artid=146211935
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     双周报Vol.67: 模式匹配支持守卫、LLVM 后端发布、支持 Attribute 语法...多项核心技术更新！
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="20250310_0">
     </a>
     2025-03-10
    </h2>
    <h3>
     <a id="_2">
     </a>
     语言更新
    </h3>
    <h4>
     <a id="Pattern_Guard_4">
     </a>
     模式匹配支持守卫（Pattern Guard）
    </h4>
    <p>
     模式守卫可以通过在模式后追加
     <code>
      if ...
     </code>
     的语法结构来指定。有模式守卫的分支只有在被模式匹配的值满足对应模式，并且模式守卫为真的情况下才会执行。如果模式守卫为假，则会继续向下寻找能够被匹配的分支。
    </p>
    <p>
     这个特性能够简化许多使用模式匹配的代码，以化简算术表达式为例：
    </p>
    <pre><code class="prism language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">simplify</span><span class="token punctuation">(</span>e <span class="token punctuation">:</span> <span class="token class-name">Expr</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Expr</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">match</span> e <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Add</span><span class="token punctuation">(</span>e1<span class="token punctuation">,</span> <span class="token class-name">Lit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> e1
    <span class="token class-name">Sub</span><span class="token punctuation">(</span>e1<span class="token punctuation">,</span> e2<span class="token punctuation">)</span> <span class="token keyword">if</span> e1 <span class="token operator">==</span> e2 <span class="token operator">=&gt;</span> <span class="token class-name">Lit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token comment">//          ^^^^^^^^^^^ pattern guard</span>
    _ <span class="token operator">=&gt;</span> e
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     模式守卫还可以配合
     <code>
      is
     </code>
     表示式使用来引入新的变量，例如：
    </p>
    <pre><code class="prism language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">json_get_key</span><span class="token punctuation">(</span>json <span class="token punctuation">:</span> <span class="token class-name">Json</span><span class="token punctuation">,</span> key <span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token macro property">Json!</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">match</span> json <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Object</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span> <span class="token keyword">if</span> map<span class="token punctuation">[</span>key<span class="token punctuation">]</span> is <span class="token class-name">Some</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> value
    _ <span class="token operator">=&gt;</span> <span class="token macro property">fail!</span><span class="token punctuation">(</span><span class="token string">"key not found: \{key}"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_Attribute__32">
     </a>
     支持 Attribute 语法
    </h4>
    <p>
     支持 Attribute 语法，用来代替原有的
     <code>
      @alert deprecated "message"
     </code>
     等 pragmas。每个 attribute 单独占用一行，attribute 内不允许换行。
    </p>
    <p>
     目前支持的attribute：
    </p>
    <ol>
     <li>
      <code>
       #deprecated("message")
      </code>
      ：声明该函数为 deprecated ，并且在使用处提示 message 中的内容。
     </li>
     <li>
      <code>
       #coverage.skip
      </code>
      ：声明该函数不计入覆盖率测试。
      <br/>
      我们后续将会移除旧的 pragmas 语法。
     </li>
    </ol>
    <pre><code class="prism language-moonbit">#deprecated("use function g instead")
#coverage.skip
fn f() -&gt; Unit {
  ...
}
</code></pre>
    <h4>
     <a id="Bytes__50">
     </a>
     Bytes 类型支持使用字符串字面量进行初始化和赋值
    </h4>
    <p>
     Bytes 类型支持使用字符串字面量进行初始化和赋值。该字符串会以 UTF-8 编码的形式存储为一个 Bytes 。例如：
    </p>
    <pre><code class="prism language-rust"><span class="token keyword">fn</span> <span class="token function-definition function">main</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> xs <span class="token punctuation">:</span> <span class="token class-name">Bytes</span> <span class="token operator">=</span> <span class="token string">"123"</span>
  <span class="token keyword">let</span> ys <span class="token punctuation">:</span> <span class="token class-name">Bytes</span> <span class="token operator">=</span> <span class="token string">"你好，世界"</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="enum__tag__61">
     </a>
     <code>
      enum
     </code>
     支持自定义 tag 值
    </h4>
    <p>
     <code>
      enum
     </code>
     支持自定义 tag 值，这在绑定 Native 的 C FFI 时非常有用。以
     <code>
      open
     </code>
     这个 syscall 为例：
    </p>
    <pre><code class="prism language-rust"><span class="token keyword">enum</span> <span class="token type-definition class-name">OpenFlag</span> <span class="token punctuation">{<!-- --></span>
  <span class="token constant">O_RDONLY</span> <span class="token operator">=</span> <span class="token number">0x00</span>
  <span class="token constant">O_WRONLY</span> <span class="token operator">=</span> <span class="token number">0x01</span>
  <span class="token constant">O_RDWR</span>   <span class="token operator">=</span> <span class="token number">0x02</span>
<span class="token punctuation">}</span>

<span class="token keyword">extern</span> <span class="token string">"c"</span> <span class="token keyword">fn</span> <span class="token function-definition function">open</span><span class="token punctuation">(</span>path <span class="token punctuation">:</span> <span class="token class-name">Bytes</span><span class="token punctuation">,</span> flag <span class="token punctuation">:</span> <span class="token class-name">OpenFlag</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Int</span> <span class="token operator">=</span> <span class="token string">"open"</span>

test <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">let</span> path <span class="token punctuation">:</span> <span class="token class-name">Bytes</span> <span class="token operator">=</span> <span class="token string">"tmp.txt"</span>
  <span class="token keyword">let</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token constant">O_RDONLY</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="const_80">
     </a>
     增强了常量（
     <code>
      const
     </code>
     ）声明的表达能力
    </h4>
    <p>
     const 新增支持：
    </p>
    <ul>
     <li>
      引用其他常量
     </li>
     <li>
      内建类型的其四则运算、位运算和比较运算
     </li>
    </ul>
    <p>
     例如：
    </p>
    <pre><code class="prism language-rust"><span class="token keyword">const</span> <span class="token class-name">A</span> <span class="token punctuation">:</span> <span class="token class-name">Int</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">3</span>
<span class="token keyword">const</span> <span class="token class-name">B</span> <span class="token punctuation">:</span> <span class="token class-name">Int</span> <span class="token operator">=</span> <span class="token class-name">A</span> <span class="token operator">*</span> <span class="token number">6</span>
</code></pre>
    <h4>
     <a id="Deprecate__trait__94">
     </a>
     Deprecate 通过方法隐式实现 trait 的行为
    </h4>
    <p>
     通过方法隐式实现 trait 的行为现已 deprecate。如果需要为一个类型实现一个 trait ，需要通过显示的
     <code>
      impl
     </code>
     构造来实现。
    </p>
    <pre><code class="prism language-rust"><span class="token comment">// 为 T 隐式实现 Show （deprecated）</span>
<span class="token keyword">fn</span> <span class="token function-definition function">T</span><span class="token punctuation">::</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token keyword">self</span> <span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span> logger <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Logger</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Unit</span> <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">...</span>
<span class="token punctuation">}</span>

<span class="token comment">// 你应该迁移到如下的显示实现</span>
<span class="token keyword">impl</span> <span class="token class-name">Show</span> <span class="token keyword">for</span> <span class="token class-name">T</span> with <span class="token function">output</span><span class="token punctuation">(</span><span class="token keyword">Self</span> <span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">,</span> logger <span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Logger</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Unit</span> <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">...</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_fn_Tf__110">
     </a>
     移除了直接调用形如 fn T::f(…) 的行为
    </h4>
    <p>
     移除了直接调用形如 fn T::f(…) 的行为。该行为之前已通过警告的形式 deprecate。未来，形如
     <code>
      fn f(self : T, ..)
     </code>
     的方法可以当成普通函数使用，而形如
     <code>
      fn T::f(..)
     </code>
     的方法只能用
     <code>
      T::f(..)
     </code>
     的形式或
     <code>
      x.f(..)
     </code>
     语法调用。新语义的更多细节见
     <a href="https://github.com/moonbitlang/core/pull/1472">
      https://github.com/moonbitlang/core/pull/1472
     </a>
    </p>
    <h4>
     <a id="_Native__runtime_114">
     </a>
     单独拆分 Native 后端部分 runtime
    </h4>
    <p>
     Native 后端的一部分 runtime 拆出来到单独的 C 文件里面了。该 C 文件位于
     <code>
      $MOON_HOME/lib/runtime.c
     </code>
     。如果你使用了非标准的构建方式，比如自己通过调用 C 编译器编译生成出来的 C 文件，需要注意在编译的时候加入该 C 文件。
    </p>
    <h4>
     <a id="_bleeding__LLVM__118">
     </a>
     在 bleeding 版本的工具链上面发布 LLVM 后端
    </h4>
    <p>
     我们在 bleeding 版本的工具链上面发布了我们的 LLVM 后端。目前我们的 LLVM 后端只支持了 x86_64 Linux 和 ARM64 macOS 平台。这两个平台上可以通过如下 bash 命令安装 bleeding 版本的 moon 。
    </p>
    <pre><code class="prism language-bash"><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://cli.moonbitlang.com/install/unix.sh <span class="token operator">|</span> <span class="token function">bash</span> <span class="token parameter variable">-s</span> <span class="token string">'bleeding'</span>
</code></pre>
    <p>
     然后就可以在构建、测试和运行的时候，通过向 moon 传入
     <code>
      --target llvm
     </code>
     的选项来使用 LLVM 后端。例如：
    </p>
    <pre><code class="prism language-bash">moon build <span class="token parameter variable">--target</span> llvm
</code></pre>
    <h3>
     <a id="_132">
     </a>
     构建系统更新
    </h3>
    <ol>
     <li>
      <p>
       新增
       <code>
        moon check --explain
       </code>
       ，能够输出关于某个 error code 的详细信息。
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5b90643081a248779e8e951253466afd.png#pic_center"/>
      </p>
     </li>
     <li>
      <p>
       <code>
        moon.pkg.json
       </code>
       中新增
       <code>
        "native-stub"
       </code>
       配置项用来声明当前包用到的 C stub 文件。在构建时，这些 stub 会被构建并连接到当前包的产物中。如果你的项目是把 C stub 文件写在 cc-flags 中，现在可以将这些 C stub 文件声明在
       <code>
        "native-stub"
       </code>
       字段中
      </p>
     </li>
     <li>
      <p>
       放松了
       <code>
        moon publish
       </code>
       必须要通过 moon check 的要求。如果 check 失败，会询问用户是否坚持发布。
      </p>
     </li>
    </ol>
    <h4>
     <a id="IDE__142">
     </a>
     IDE 更新
    </h4>
    <ol>
     <li>
      Markdown 中内嵌的 MoonBit 代码块支持格式化。用户可以通过选择 MoonBit 插件来格式化含有 MoonBit 的 Markdown 。
     </li>
    </ol>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/72bd2bb8859748f287ec153233fed506.gif#pic_center"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f37343734333738382f:61727469636c652f64657461696c732f313436323131393335" class_="artid" style="display:none">
 </p>
</div>


