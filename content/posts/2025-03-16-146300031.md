---
layout: post
title: "CC-æ¯æ—¥ä¸€ç»ƒ-6"
date: 2025-03-16 19:38:56 +0800
description: "ä»€ä¹ˆæ˜¯æ™ºèƒ½æŒ‡é’ˆï¼Ÿæ™ºèƒ½æŒ‡é’ˆå’Œæ™®é€šæŒ‡é’ˆçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿæœ‰å“ªäº›å¸¸ç”¨çš„æ™ºèƒ½æŒ‡é’ˆï¼Ÿè¯´ä¸€ä¸‹åº•å±‚å¦‚ä½•å®ç°çš„ï¼Ÿ"
keywords: "C/C++ | æ¯æ—¥ä¸€ç»ƒ (6)"
categories: ['æ¯æ—¥ä¸€ç»ƒ', 'C']
tags: ['é¢è¯•', 'C', 'C']
artid: "146300031"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146300031
    alt: "CC-æ¯æ—¥ä¸€ç»ƒ-6"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146300031
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146300031
cover: https://bing.ee123.net/img/rand?artid=146300031
image: https://bing.ee123.net/img/rand?artid=146300031
img: https://bing.ee123.net/img/rand?artid=146300031
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     C/C++ | æ¯æ—¥ä¸€ç»ƒ (6)
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      ğŸ’¢æ¬¢è¿æ¥åˆ°å¼ èƒ¤å°˜çš„æŠ€æœ¯ç«™
      <br/>
      ğŸ’¥æŠ€æœ¯å¦‚æ±Ÿæ²³ï¼Œæ±‡èšä¼—å¿—æˆã€‚ä»£ç ä¼¼æ˜Ÿè¾°ï¼Œç…§äº®è¡Œå¾ç¨‹ã€‚å¼€æºç²¾ç¥é•¿ï¼Œä¼ æ‰¿æ°¸ä¸å¿˜ã€‚æºæ‰‹å…±å‰è¡Œï¼Œæœªæ¥æ›´è¾‰ç…ŒğŸ’¥
     </p>
    </blockquote>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="CC___6_5">
     </a>
     C/C++ | æ¯æ—¥ä¸€ç»ƒ (6)
    </h2>
    <h3>
     <a id="_7">
     </a>
     é¢˜ç›®
    </h3>
    <p>
     ä»€ä¹ˆæ˜¯æ™ºèƒ½æŒ‡é’ˆï¼Ÿæ™ºèƒ½æŒ‡é’ˆå’Œæ™®é€šæŒ‡é’ˆçš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿæœ‰å“ªäº›å¸¸ç”¨çš„æ™ºèƒ½æŒ‡é’ˆï¼Ÿè¯´ä¸€ä¸‹åº•å±‚å¦‚ä½•å®ç°çš„ï¼Ÿ
    </p>
    <h3>
     <a id="_12">
     </a>
     å‚è€ƒç­”æ¡ˆ
    </h3>
    <h4>
     <a id="_14">
     </a>
     æ™®é€šæŒ‡é’ˆå­˜åœ¨çš„é—®é¢˜ï¼Ÿ
    </h4>
    <p>
     æ™®é€šæŒ‡é’ˆï¼ˆå¦‚
     <code>
      C/C++
     </code>
     ä¸­çš„
     <code>
      int*
     </code>
     ã€
     <code>
      char*
     </code>
     ç­‰ï¼‰æ˜¯ç¼–ç¨‹ä¸­éå¸¸çµæ´»çš„å·¥å…·ï¼Œä½†åŒæ—¶ä¹Ÿå¸¦æ¥äº†è®¸å¤šæ½œåœ¨é—®é¢˜ã€‚è¿™äº›é—®é¢˜ä¸»è¦æºäºæŒ‡é’ˆçš„ä½çº§ç‰¹æ€§å’Œå¯¹èµ„æºç®¡ç†çš„ç›´æ¥ä¾èµ–ã€‚
    </p>
    <h5>
     <a id="_18">
     </a>
     å†…å­˜æ³„æ¼
    </h5>
    <p>
     å†…å­˜æ³„æ¼æ˜¯æŒ‡åŠ¨æ€åˆ†é…çš„å†…å­˜æ²¡æœ‰è¢«æ­£ç¡®é‡Šæ”¾ï¼Œå¯¼è‡´ç¨‹åºå ç”¨çš„å†…å­˜ä¸æ–­å¢åŠ ï¼Œæœ€ç»ˆå¯èƒ½å¯¼è‡´ç¨‹åºæ€§èƒ½ä¸‹é™ç”šè‡³å´©æºƒã€‚æ¯”å¦‚ä½¿ç”¨
     <code>
      malloc
     </code>
     æˆ–è€…
     <code>
      new
     </code>
     åˆ†é…å†…å­˜åï¼Œå¿…é¡»åœ¨åˆé€‚çš„æ—¶å€™ä½¿ç”¨
     <code>
      free
     </code>
     æˆ–è€…
     <code>
      delete
     </code>
     é‡Šæ”¾å†…å­˜ã€‚å¦‚æœå¿˜è®°é‡Šæ”¾å†…å­˜ï¼Œå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ã€‚ä¾‹å¦‚ï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">leakMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span><span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// åˆ†é…å†…å­˜</span>
    <span class="token comment">// å¿˜è®°é‡Šæ”¾å†…å­˜</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">leakMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// å‡½æ•°è°ƒç”¨</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     å½“ç¨‹åºæ¯æ¬¡è°ƒç”¨
     <code>
      leakMemory
     </code>
     å‡½æ•°æ—¶ï¼Œéƒ½ä¼šåˆ†é…1000ä¸ª
     <code>
      int
     </code>
     çš„å†…å­˜ï¼Œä½†è¿™äº›å†…å­˜æ°¸è¿œä¸ä¼šè¢«é‡Šæ”¾ã€‚
    </p>
    <p>
     å†…å­˜æ³„æ¼çš„å¯¹ç¨‹åºçš„å±å®³ï¼š
    </p>
    <ul>
     <li>
      <strong>
       æ€§èƒ½ä¸‹é™
      </strong>
      ï¼šéšç€ç¨‹åºè¿è¡Œæ—¶é—´çš„å¢åŠ ï¼Œå†…å­˜æ³„æ¼ä¼šå¯¼è‡´å¯ç”¨å†…å­˜é€æ¸å‡å°‘ï¼Œç¨‹åºè¿è¡Œé€Ÿåº¦å˜æ…¢ã€‚
     </li>
     <li>
      <strong>
       ç³»ç»Ÿå´©æºƒ
      </strong>
      ï¼šå¦‚æœå†…å­˜æ³„æ¼ä¸¥é‡ï¼Œå¯èƒ½ä¼šè€—å°½ç³»ç»Ÿèµ„æºï¼Œå¯¼è‡´ç¨‹åºå´©æºƒç”šè‡³æ•´ä¸ªç³»ç»Ÿå´©æºƒã€‚
     </li>
     <li>
      <strong>
       èµ„æºæµªè´¹
      </strong>
      ï¼šæœªé‡Šæ”¾çš„å†…å­˜æ— æ³•è¢«ç³»ç»Ÿæˆ–å…¶ä»–ç¨‹åºä½¿ç”¨ï¼Œé€ æˆèµ„æºæµªè´¹ã€‚
     </li>
    </ul>
    <h5>
     <a id="_42">
     </a>
     æ‚¬ç©ºæŒ‡é’ˆ
    </h5>
    <p>
     å¦å¤–ï¼Œè¿˜æœ‰ä¸€ç§æ— æ•ˆçš„æŒ‡é’ˆâ€”â€”æ‚¬ç©ºæŒ‡é’ˆï¼Œåœ¨ä½¿ç”¨æ—¶å¯èƒ½å¯¼è‡´æœªå®šä¹‰è¡Œä¸ºç”šè‡³ç¨‹åºå´©æºƒã€‚
    </p>
    <p>
     æ‚¬ç©ºæŒ‡é’ˆæ˜¯æŒ‡æŒ‡é’ˆæ›¾ç»æŒ‡å‘ä¸€ä¸ªæœ‰æ•ˆçš„å†…å­˜ä½ç½®ï¼Œä½†è¯¥å†…å­˜å·²è¢«é‡Šæ”¾æˆ–å›æ”¶ï¼Œå¯¼è‡´æŒ‡é’ˆå˜å¾—æ— æ•ˆã€‚å°½ç®¡æŒ‡é’ˆä»ç„¶ä¿å­˜ç€åŸæ¥çš„åœ°å€ï¼Œä½†è®¿é—®è¯¥åœ°å€ä¼šäº§ç”Ÿæœªå®šä¹‰è¡Œä¸ºï¼Œå› ä¸ºè¯¥åœ°å€å¯èƒ½å·²ç»è¢«åˆ†é…ç»™å…¶ä»–å¯¹è±¡æˆ–æˆä¸ºä¸å¯è®¿é—®çš„åŒºåŸŸã€‚ä¾‹å¦‚ï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">danglingPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> ptr<span class="token punctuation">;</span> <span class="token comment">// é‡Šæ”¾å†…å­˜</span>
    <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>  <span class="token comment">// é€šè¿‡æ‚¬ç©ºæŒ‡é’ˆè®¿é—®å†…å­˜ï¼Œæœªå®šä¹‰è¡Œä¸º</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">danglingPointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// å‡½æ•°è°ƒç”¨</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="_62">
     </a>
     æŒ‡é’ˆè¢«é‡å¤é‡Šæ”¾
    </h5>
    <p>
     é‡å¤é‡Šæ”¾æ˜¯æŒ‡å¯¹åŒä¸€å—å†…å­˜è°ƒç”¨å¤šæ¬¡
     <code>
      delete
     </code>
     æˆ–
     <code>
      free
     </code>
     ã€‚è¿™å¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒæˆ–å†…å­˜æŸåã€‚ä¾‹å¦‚ï¼š
    </p>
    <pre><code class="prism language-go"><span class="token builtin">int</span> <span class="token operator">*</span><span class="token function">doubleFree</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token builtin">int</span> <span class="token operator">*</span>ptr <span class="token operator">=</span> <span class="token builtin">new</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">delete</span> ptr<span class="token punctuation">;</span> <span class="token comment">// ç¬¬ä¸€æ¬¡é‡Šæ”¾</span>
    <span class="token keyword">return</span> ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token builtin">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token builtin">int</span> <span class="token operator">*</span>p <span class="token operator">=</span> <span class="token function">doubleFree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// free(): double free detected in tcache 2</span>
    <span class="token comment">// Aborted (core dumped)</span>
    <span class="token builtin">delete</span> p<span class="token punctuation">;</span> <span class="token comment">// ç¬¬äºŒæ¬¡é‡Šæ”¾ï¼Œæœªå®šä¹‰è¡Œä¸º</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <p>
     å¦å¤–ï¼Œåœ¨ä½¿ç”¨æ™®é€šæŒ‡é’ˆæ—¶å¦‚æœä¸æ³¨æ„å¯èƒ½è¿˜ä¼šæœ‰ä¸€äº›å…¶ä»–æ›´ä¸ºä¸¥é‡çš„é—®é¢˜äº§ç”Ÿï¼Œè¿™é‡Œå°±ä¸å†ä¸€ä¸€åˆ—ä¸¾ã€‚
    </p>
    <p>
     è¯´åˆ°è¿™é‡Œæœ‰äº›åŒå­¦å¯èƒ½ä¼šæœ‰ç–‘é—®ï¼šå½“ç¨‹åºå‘˜çš„èƒ½åŠ›è¶³å¤Ÿå¼ºã€è¶³å¤Ÿçš„ä»”ç»†æ˜¯ä¸æ˜¯å°±å¯ä»¥é¿å…è¿™äº›é—®é¢˜ï¼Ÿè¿™ä¹ˆè¯´ä¹Ÿå¾ˆæœ‰é“ç†ï¼Œç¡®å®å¯ä»¥é¿å…è®¸å¤šå¸¸è§çš„é—®é¢˜ï¼Œæ¯”å¦‚å†…å­˜æ³„æ¼ã€æ‚¬ç©ºæŒ‡é’ˆç­‰ã€‚ç„¶è€Œï¼Œæˆ‘è®¤ä¸º â€œäººéåœ£è´¤ï¼Œå­°èƒ½æ— è¿‡â€ï¼Œå³ä½¿æ˜¯èƒ½åŠ›æœ€å¼ºã€æœ€è°¨æ…çš„ç¨‹åºå‘˜ä¹Ÿéš¾ä»¥å®Œå…¨é¿å…é”™è¯¯ï¼Œå°¤å…¶æ˜¯åœ¨ç‰¹åˆ«å¤æ‚çš„é¡¹ç›®æˆ–å›¢é˜Ÿåä½œç¯å¢ƒä¸­ã€‚ä½¿ç”¨æ™®é€šæŒ‡é’ˆä»ç„¶å­˜åœ¨ä¸€äº›éš¾ä»¥å…‹æœçš„å±€é™æ€§ï¼Œè¿™äº›å±€é™æ€§ä½¿å¾—æ™ºèƒ½æŒ‡é’ˆå’Œå…¶ä»–ç°ä»£
     <code>
      C++
     </code>
     ç‰¹æ€§æˆä¸ºæ›´å¥½çš„é€‰æ‹©ã€‚
    </p>
    <p>
     é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥å°±é’ˆå¯¹
     <code>
      C++
     </code>
     æ ‡å‡†åº“ä¸­çš„æ™ºèƒ½æŒ‡é’ˆè¿›è¡Œæ·±åº¦è®²è§£ã€‚
    </p>
    <h4>
     <a id="_93">
     </a>
     æ™ºèƒ½æŒ‡é’ˆ
    </h4>
    <p>
     æ™ºèƒ½æŒ‡é’ˆæ˜¯
     <code>
      C++
     </code>
     æ ‡å‡†åº“ä¸­çš„ä¸€ç§ç±»æ¨¡æ¿ï¼Œç”¨äº
     <strong>
      è‡ªåŠ¨ç®¡ç†åŠ¨æ€åˆ†é…çš„å†…å­˜
     </strong>
     ã€‚å®ƒä»¬å¯ä»¥é˜²æ­¢å†…å­˜æ³„æ¼å’Œæ‚¬æŒ‚æŒ‡é’ˆé—®é¢˜ï¼Œå¹¶ä¸”æä¾›äº†å¼‚å¸¸å®‰å…¨æ€§ã€‚
    </p>
    <p>
     <code>
      C++11
     </code>
     æ ‡å‡†åº“å¼•å…¥äº†ä¸‰ç§æ™ºèƒ½æŒ‡é’ˆï¼š
     <code>
      std::unique_ptr
     </code>
     ã€
     <code>
      std::shared_ptr
     </code>
     å’Œ
     <code>
      std::weak_ptr
     </code>
     ã€‚
    </p>
    <blockquote>
     <p>
      æœ¬æ–‡ç« åªè®¨è®º
      <code>
       C++11
      </code>
      æ ‡å‡†åº“ä¸­çš„æ™ºèƒ½æŒ‡é’ˆï¼Œ
      <code>
       Boost
      </code>
      åº“ä¸­æä¾›çš„æ™ºèƒ½æŒ‡é’ˆæœ¬æ–‡ç« ä¸å†è®¨è®ºã€‚å¦å¤–
      <code>
       std::auto_ptr
      </code>
      åœ¨
      <code>
       C++11
      </code>
      ä¸­è¢«åºŸå¼ƒï¼Œåœ¨
      <code>
       C++17
      </code>
      ä¸­è¢«ç§»é™¤ã€‚æœ¬æ–‡ç« ä¹Ÿä¸å†è®¨è®ºã€‚
     </p>
     <p>
      å¦å¤–ï¼Œæœ¬ç¯‡æ–‡ç« çš„æ‰€æœ‰åº•å±‚æºç å‡æ¥æºäº
      <code>
       libstdc++
      </code>
      ï¼Œå…¶ä»–å¹³å°çš„æºç å®ç°å¯èƒ½ä¼šæœ‰äº›å‡ºå…¥ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <h5>
     <a id="stdunique_ptr_103">
     </a>
     <code>
      std::unique_ptr
     </code>
    </h5>
    <p>
     <code>
      std::unique_ptr
     </code>
     æ˜¯
     <code>
      C++11
     </code>
     å¼•å…¥çš„ä¸€ç§æ™ºèƒ½æŒ‡é’ˆï¼Œè¡¨ç¤ºå¯¹èµ„æºï¼ˆé€šå¸¸æ˜¯åŠ¨æ€åˆ†é…çš„å†…å­˜ï¼‰çš„ç‹¬å æ‰€æœ‰æƒã€‚å®ƒé€šè¿‡ç§»åŠ¨è¯­ä¹‰ï¼ˆè€Œä¸æ˜¯æ‹·è´è¯­ä¹‰ï¼‰æ¥è½¬ç§»èµ„æºçš„æ‰€æœ‰æƒï¼Œç¡®ä¿åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ª
     <code>
      unique_ptr
     </code>
     å¯ä»¥ç®¡ç†æŸä¸ªèµ„æºã€‚
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">p</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>	<span class="token comment">// 10</span>

    <span class="token comment">// cannot be referenced -- it is a deleted function</span>
    <span class="token comment">// std::unique_ptr&lt;int&gt; p1 = p;</span>
    <span class="token comment">// p = p1;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     åœ¨æºç ä¸­ï¼Œ
     <code>
      std::unique_ptr
     </code>
     å› ä¸ºç¦ç”¨äº†æ‹·è´æ„é€ å‡½æ•°å’Œèµ‹å€¼è¿ç®—ç¬¦å‡½æ•°ï¼Œå¯¼è‡´
     <code>
      std::unique_ptr
     </code>
     ä¸æ”¯æŒæ‹·è´è¯­ä¹‰ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// Disable copy from lvalue.</span>
<span class="token function">unique_ptr</span><span class="token punctuation">(</span><span class="token keyword">const</span> unique_ptr<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
unique_ptr<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> unique_ptr<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     è™½ç„¶
     <code>
      std::unique_ptr
     </code>
     ç¦ç”¨äº†æ‹·è´æ„é€ å’Œèµ‹å€¼æ“ä½œè¿ç®—ç¬¦ï¼Œä½†æ˜¯æä¾›äº†ç§»åŠ¨æ‹·è´æ„é€ å’Œç§»åŠ¨èµ‹å€¼æ“ä½œè¿ç®—ç¬¦ï¼Œä¹Ÿå°±æ˜¯è¯´
     <code>
      std::unique_ptr
     </code>
     æ”¯æŒäº†ç§»åŠ¨è¯­ä¹‰ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// Move constructor.</span>
<span class="token function">unique_ptr</span><span class="token punctuation">(</span>unique_ptr<span class="token operator">&amp;&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
unique_ptr<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>unique_ptr<span class="token operator">&amp;&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      æ³¨æ„ï¼š
      <code>
       std::unique_ptr
      </code>
      æ¨¡æ¿åŒ–çš„ç§»åŠ¨æ‹·è´æ„é€ å’Œç§»åŠ¨èµ‹å€¼æ“ä½œè¿ç®—ç¬¦æºç è¿™é‡Œä¸å†åˆ—ä¸¾ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦è‡ªè¡ŒæŸ¥çœ‹æºä»£ç ã€‚
     </p>
    </blockquote>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">p</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">p1</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>  <span class="token comment">// 10</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p1 <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 21</span>

    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">p3</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç§»åŠ¨æ„é€ </span>

    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> p4<span class="token punctuation">;</span>
    p4 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>p1<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ç§»åŠ¨èµ‹å€¼æ“ä½œè¿ç®—ç¬¦</span>

    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p3 <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 10</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p4 <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 21</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="_163">
     </a>
     åº•å±‚ç»“æ„
    </h6>
    <p>
     åœ¨
     <code>
      std::unique_ptr
     </code>
     çš„å®ç°ä¸­ï¼Œ
     <code>
      __uniq_ptr_data
     </code>
     æ˜¯ä¸€ä¸ªåº•å±‚æ•°æ®ç»“æ„ï¼Œç”¨äºå°è£…å’Œç®¡ç†
     <code>
      std::unique_ptr
     </code>
     çš„åº•å±‚æŒ‡é’ˆå’Œåˆ é™¤å™¨ã€‚
    </p>
    <p>
     ä¸ºäº†å¯ä»¥æ›´å¥½çš„ç†è§£ä¸‹é¢çš„æºç ï¼Œè¿™é‡Œå…ˆè§£é‡Šä¸€ä¸‹åˆ é™¤å™¨ï¼šåˆ é™¤å™¨æ˜¯ä¸€ä¸ªéå¸¸é‡è¦çš„ç»„ä»¶ï¼Œå®ƒå®šä¹‰äº†å¦‚ä½•é‡Šæ”¾
     <code>
      std::unique_ptr
     </code>
     æ‰€ç®¡ç†çš„èµ„æºã€‚å¦å¤–ï¼Œåˆ é™¤å™¨çš„ä½œç”¨ä¸ä»…ä»…æ˜¯ç®€å•åœ°é‡Šæ”¾å†…å­˜ï¼Œå®ƒè¿˜å¯ä»¥æ‰§è¡Œæ›´å¤æ‚çš„æ¸…ç†æ“ä½œï¼Œæ¯”å¦‚å…³é—­æ–‡ä»¶å¥æŸ„ã€é‡Šæ”¾ç½‘ç»œè¿æ¥ã€é”€æ¯è‡ªå®šä¹‰å¯¹è±¡ç­‰ã€‚å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œé€šè¿‡è‡ªå®šä¹‰åˆ é™¤å™¨ï¼Œ
     <code>
      std::unique_ptr
     </code>
     èƒ½å¤Ÿçµæ´»åœ°ç®¡ç†å„ç§ç±»å‹çš„èµ„æºï¼Œè€Œä¸ä»…ä»…æ˜¯åŠ¨æ€åˆ†é…çš„å†…å­˜ã€‚
    </p>
    <p>
     åœ¨ä¸‹é¢çš„
     <code>
      std::unique_ptr
     </code>
     æ¨¡æ¿ç±»ä¸­ï¼Œç±»å‹
     <code>
      _Tp
     </code>
     è¡¨ç¤ºåº•å±‚æŒ‡é’ˆçš„æ³›å‹å‚æ•°ï¼Œè€Œ
     <code>
      _Dp
     </code>
     è¡¨ç¤ºæ‰€ä½¿ç”¨çš„åˆ é™¤å™¨ï¼Œå¦‚æœæœªæŒ‡å®šåˆ é™¤å™¨åˆ™ä½¿ç”¨é»˜è®¤åˆ é™¤å™¨
     <code>
      default_delete&lt;_Tp&gt;
     </code>
     ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_Tp</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">_Dp</span> <span class="token operator">=</span> default_delete<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">unique_ptr</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
	
    __uniq_ptr_data<span class="token operator">&lt;</span>_Tp<span class="token punctuation">,</span> _Dp<span class="token operator">&gt;</span> _M_t<span class="token punctuation">;</span>
    
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <p>
     åœ¨ä¸Šè¿°ç»“æ„ä½“ä¸­ï¼Œ
     <code>
      _M_t
     </code>
     æ˜¯æœ€ä¸ºæ ¸å¿ƒçš„æˆå‘˜å±æ€§ï¼Œè¯¥å±æ€§æ˜¯ä¸€ä¸ªåŒ…å«äº†ä¸¤ä¸ªéƒ¨åˆ†çš„æ¨¡æ¿ç»“æ„ä½“ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_Tp</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">_Dp</span><span class="token punctuation">,</span>
    <span class="token keyword">bool</span> <span class="token operator">=</span> is_move_constructible<span class="token operator">&lt;</span>_Dp<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>value<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> <span class="token operator">=</span> is_move_assignable<span class="token operator">&lt;</span>_Dp<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>value<span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">__uniq_ptr_data</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token class-name">__uniq_ptr_impl</span><span class="token operator">&lt;</span><span class="token class-name">_Tp</span><span class="token punctuation">,</span> <span class="token class-name">_Dp</span><span class="token operator">&gt;</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">using</span> __uniq_ptr_impl<span class="token operator">&lt;</span>_Tp<span class="token punctuation">,</span> _Dp<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>__uniq_ptr_impl<span class="token punctuation">;</span>
    <span class="token function">__uniq_ptr_data</span><span class="token punctuation">(</span>__uniq_ptr_data<span class="token operator">&amp;&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
    __uniq_ptr_data<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>__uniq_ptr_data<span class="token operator">&amp;&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     è€Œ
     <code>
      __uniq_ptr_data
     </code>
     åˆç»§æ‰¿è‡ª
     <code>
      __uniq_ptr_impl
     </code>
     ï¼Œ
     <code>
      __uniq_ptr_impl
     </code>
     ä¹Ÿæ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œç”¨äºå°è£…å’Œç®¡ç†
     <code>
      std::unique_ptr
     </code>
     çš„æŒ‡é’ˆå’Œåˆ é™¤å™¨ã€‚å®ƒæ˜¯
     <code>
      std::unique_ptr
     </code>
     çš„åº•å±‚å®ç°ç»†èŠ‚ï¼Œéšè—äº†æŒ‡é’ˆå’Œåˆ é™¤å™¨çš„ç®¡ç†é€»è¾‘ï¼Œä½¿å¾—
     <code>
      std::unique_ptr
     </code>
     çš„æ¥å£æ›´åŠ ç®€æ´å’Œå®‰å…¨ã€‚æºç å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_Tp</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">_Dp</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">__uniq_ptr_impl</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_Up</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">_Ep</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token operator">=</span> <span class="token keyword">void</span><span class="token operator">&gt;</span>
    <span class="token keyword">struct</span> <span class="token class-name">_Ptr</span>
    <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">using</span> type <span class="token operator">=</span> _Up<span class="token operator">*</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_Up</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">_Ep</span><span class="token operator">&gt;</span>
    <span class="token keyword">struct</span>
    <span class="token class-name">_Ptr</span><span class="token operator">&lt;</span>_Up<span class="token punctuation">,</span> _Ep<span class="token punctuation">,</span> __void_t<span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">remove_reference</span><span class="token operator">&lt;</span>_Ep<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>type<span class="token double-colon punctuation">::</span>pointer<span class="token operator">&gt;&gt;</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">using</span> type <span class="token operator">=</span> <span class="token keyword">typename</span> <span class="token class-name">remove_reference</span><span class="token operator">&lt;</span>_Ep<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>type<span class="token double-colon punctuation">::</span>pointer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
 	<span class="token comment">// ...</span>

    pointer<span class="token operator">&amp;</span>   <span class="token function">_M_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_M_t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    pointer    <span class="token function">_M_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_M_t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    _Dp<span class="token operator">&amp;</span>       <span class="token function">_M_deleter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_M_t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">const</span> _Dp<span class="token operator">&amp;</span> <span class="token function">_M_deleter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_M_t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

	<span class="token comment">// ...</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	tuple<span class="token operator">&lt;</span>pointer<span class="token punctuation">,</span> _Dp<span class="token operator">&gt;</span> _M_t<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <p>
     ä»ä¸Šè¿°ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œ
     <code>
      __uniq_ptr_impl
     </code>
     åˆä½¿ç”¨
     <code>
      tuple
     </code>
     å­˜å‚¨åº•å±‚æŒ‡é’ˆå’Œåˆ é™¤å™¨ï¼ŒåŒæ—¶å¯¹å¤–ä¹Ÿæä¾›äº†åº•å±‚æŒ‡é’ˆ
     <code>
      pointer
     </code>
     å’Œåˆ é™¤å™¨
     <code>
      _Dp
     </code>
     çš„è®¿é—®å‡½æ•°ã€‚
    </p>
    <h6>
     <a id="_237">
     </a>
     å¸¸ç”¨æ“ä½œ
    </h6>
    <p>
     ä¸‹é¢é’ˆå¯¹
     <code>
      std::unique_ptr
     </code>
     ä¸­å¸¸ç”¨å‡½æ•°çš„åº•å±‚æºç è¿›è¡Œåˆ†æã€‚
    </p>
    <h6>
     <a id="_241">
     </a>
     é‡Šæ”¾æ‰€æœ‰æƒ
    </h6>
    <p>
     <code>
      release
     </code>
     å‡½æ•°é‡Šæ”¾
     <code>
      std::unique_ptr
     </code>
     å½“å‰ç®¡ç†çš„æŒ‡é’ˆã€‚
    </p>
    <pre><code class="prism language-cpp">pointer <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">return</span> _M_t<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
    <p>
     è°ƒç”¨
     <code>
      _M_t
     </code>
     çš„
     <code>
      release
     </code>
     å‡½æ•°ï¼Œå–åˆ°åº•å±‚æŒ‡é’ˆ
     <code>
      __p
     </code>
     ï¼Œç›´æ¥å°†åº•å±‚æŒ‡é’ˆç½®ä¸º
     <code>
      nullptr
     </code>
     ï¼Œæœ€ç»ˆè¿”å›å½“å‰ç®¡ç†çš„æŒ‡é’ˆã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp">pointer <span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
    pointer __p <span class="token operator">=</span> <span class="token function">_M_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_M_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> __p<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     å¦‚æœå°†
     <code>
      std::unique_ptr
     </code>
     çš„åº•å±‚æŒ‡é’ˆç½®ä¸º
     <code>
      nullptr
     </code>
     ï¼Œè¡¨ç¤ºå®ƒä¸å†ç®¡ç†ä»»ä½•èµ„æºã€‚
    </p>
    <h6>
     <a id="_265">
     </a>
     é‡ç½®
    </h6>
    <p>
     <code>
      reset
     </code>
     å‡½æ•°ç”¨äºæ›¿æ¢
     <code>
      std::unique_ptr
     </code>
     å½“å‰ç®¡ç†çš„åº•å±‚æŒ‡é’ˆã€‚
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span>pointer __p <span class="token operator">=</span> <span class="token function">pointer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">static_assert</span><span class="token punctuation">(</span>__is_invocable<span class="token operator">&lt;</span>deleter_type<span class="token operator">&amp;</span><span class="token punctuation">,</span> pointer<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>value<span class="token punctuation">,</span>
      <span class="token string">"unique_ptr's deleter must be invocable with a pointer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	_M_t<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>__p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     è°ƒç”¨
     <code>
      _M_t
     </code>
     çš„
     <code>
      reset
     </code>
     å‡½æ•°ï¼Œå–åˆ°åº•å±‚æŒ‡é’ˆ
     <code>
      __old_p
     </code>
     ï¼Œå°†æ–°çš„æŒ‡é’ˆ
     <code>
      __p
     </code>
     èµ‹å€¼åº•å±‚æŒ‡é’ˆã€‚ç»™å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span>pointer __p<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> pointer __old_p <span class="token operator">=</span> <span class="token function">_M_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ–°çš„æŒ‡é’ˆèµ‹å€¼ç»™ unique_ptr</span>
    <span class="token function">_M_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> __p<span class="token punctuation">;</span>
    <span class="token comment">// å¦‚æœå½“å‰æŒ‡é’ˆä¸ä¸ºç©º</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__old_p<span class="token punctuation">)</span>
        <span class="token comment">// è°ƒç”¨åˆ é™¤å™¨é‡Šæ”¾å½“å‰æŒ‡é’ˆ</span>
    	<span class="token function">_M_deleter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>__old_p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     å¦‚æœå½“å‰åº•å±‚æŒ‡é’ˆ
     <code>
      __old_p
     </code>
     ä¸ä¸ºç©ºï¼Œåˆ™é¦–å…ˆè·å–åˆ°åˆ é™¤å™¨ã€‚ç»™å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// è·å–å–åˆ°åˆ é™¤å™¨</span>
<span class="token keyword">const</span> _Dp<span class="token operator">&amp;</span> <span class="token function">_M_deleter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_M_t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
    <p>
     ç„¶åï¼Œé€šè¿‡è°ƒç”¨åˆ é™¤å™¨é‡Šæ”¾å½“å‰æŒ‡é’ˆï¼ˆä¸‹é¢è¿™ä¸ªæ˜¯é»˜è®¤åˆ é™¤å™¨çš„é‡Šæ”¾æŒ‡é’ˆçš„ä»£ç ï¼‰ã€‚ç»™å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_Tp</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">default_delete</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    
    <span class="token keyword">void</span> <span class="token keyword">operator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>_Tp<span class="token operator">*</span> __ptr<span class="token punctuation">)</span> <span class="token keyword">const</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">static_assert</span><span class="token punctuation">(</span><span class="token operator">!</span>is_void<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>value<span class="token punctuation">,</span>
              <span class="token string">"can't delete pointer to incomplete type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">static_assert</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>_Tp<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">,</span>
              <span class="token string">"can't delete pointer to incomplete type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> __ptr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <h6>
     <a id="_321">
     </a>
     è·å–åŸå§‹æŒ‡é’ˆ
    </h6>
    <p>
     <code>
      get
     </code>
     å‡½æ•°è¿”å›
     <code>
      std::unique_ptr
     </code>
     å½“å‰ç®¡ç†çš„åº•å±‚æŒ‡é’ˆã€‚å®ƒä¸ä¼šè½¬ç§»æ‰€æœ‰æƒï¼Œåªæ˜¯æä¾›å¯¹åº•å±‚æŒ‡é’ˆçš„è®¿é—®ã€‚
    </p>
    <pre><code class="prism language-cpp">pointer <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">return</span> _M_t<span class="token punctuation">.</span><span class="token function">_M_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     è°ƒç”¨
     <code>
      _M_t
     </code>
     çš„
     <code>
      _M_ptr
     </code>
     å‡½æ•°ï¼Œå–åˆ°åº•å±‚æŒ‡é’ˆ
     <code>
      pointer
     </code>
     ï¼Œç›´æ¥è¿”å›è¯¥æŒ‡é’ˆã€‚ç»™å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp">pointer <span class="token function">_M_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">get</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>_M_t<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="_338">
     </a>
     äº¤æ¢
    </h6>
    <p>
     <code>
      swap
     </code>
     å‡½æ•°ç”¨äºäº¤æ¢ä¸¤ä¸ª
     <code>
      std::unique_ptr
     </code>
     çš„åº•å±‚æŒ‡é’ˆå’Œåˆ é™¤å™¨ã€‚
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span>unique_ptr<span class="token operator">&amp;</span> __u<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static_assert</span><span class="token punctuation">(</span>__is_swappable<span class="token operator">&lt;</span>_Dp<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>value<span class="token punctuation">,</span> <span class="token string">"deleter must be swappable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _M_t<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>__u<span class="token punctuation">.</span>_M_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     è°ƒç”¨
     <code>
      _M_t
     </code>
     çš„
     <code>
      swap
     </code>
     å‡½æ•°ï¼Œåº•å±‚ä½¿ç”¨çš„æ˜¯æ ‡å‡†åº“çš„
     <code>
      std::swap
     </code>
     å‡½æ•°ï¼Œç„¶åäº¤æ¢åº•å±‚æŒ‡é’ˆå’Œåˆ é™¤å™¨ã€‚ç»™å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span>__uniq_ptr_impl<span class="token operator">&amp;</span> __rhs<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>swap<span class="token punctuation">;</span>
    <span class="token function">swap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">_M_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> __rhs<span class="token punctuation">.</span><span class="token function">_M_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">swap</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">_M_deleter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> __rhs<span class="token punctuation">.</span><span class="token function">_M_deleter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="stdshared_ptr_361">
     </a>
     <code>
      std::shared_ptr
     </code>
    </h5>
    <p>
     <code>
      std::shared_ptr
     </code>
     ä¹Ÿæ˜¯
     <code>
      C++11
     </code>
     å¼•å…¥çš„ä¸€ç§æ™ºèƒ½æŒ‡é’ˆï¼Œç”¨äºé€šè¿‡å¼•ç”¨è®¡æ•°æœºåˆ¶å…±äº«å¯¹è±¡çš„æ‰€æœ‰æƒã€‚å®ƒå…è®¸å¤šä¸ª
     <code>
      std::shared_ptr
     </code>
     å®ä¾‹å…±äº«åŒä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶åœ¨æœ€åä¸€ä¸ª
     <code>
      std::shared_ptr
     </code>
     è¢«é”€æ¯æ—¶è‡ªåŠ¨é”€æ¯å¯¹è±¡ã€‚
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">p</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 10</span>

    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> p1<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> p2 <span class="token operator">=</span> p<span class="token punctuation">;</span>	<span class="token comment">// æ‹·è´æ„é€ </span>

    p1 <span class="token operator">=</span> p2<span class="token punctuation">;</span>	<span class="token comment">// èµ‹å€¼è¿ç®—ç¬¦æ„é€ </span>

    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>  <span class="token comment">// 10</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p1 <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 10</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p2 <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 10</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      std::shared_ptr
     </code>
     å’Œ
     <code>
      std::unique_ptr
     </code>
     çš„å…¶ä¸­ä¹‹ä¸€çš„åŒºåˆ«å°±æ˜¯å…è®¸å…±äº«åŒä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰æƒï¼Œåœ¨æºç ä¸­
     <code>
      std::shared_ptr
     </code>
     å¼€æ”¾äº†æ‹·è´æ„é€ å‡½æ•°å’Œèµ‹å€¼è¿ç®—ç¬¦å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´æ”¯æŒæ‹·è´è¯­ä¹‰ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token function">shared_ptr</span><span class="token punctuation">(</span><span class="token keyword">const</span> shared_ptr<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
shared_ptr<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> shared_ptr<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      æ³¨æ„ï¼š
      <code>
       std::shared_ptr
      </code>
      æ¨¡æ¿åŒ–çš„æ‹·è´æ„é€ å’Œèµ‹å€¼æ“ä½œè¿ç®—ç¬¦æºç è¿™é‡Œä¸å†åˆ—ä¸¾ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦è‡ªè¡ŒæŸ¥çœ‹æºä»£ç ã€‚
     </p>
    </blockquote>
    <p>
     åŒæ ·çš„
     <code>
      std::shared_ptr
     </code>
     ä¹Ÿå¼€æ”¾äº†ç§»åŠ¨æ‹·è´æ„é€ å‡½æ•°å’Œç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦å‡½æ•°ï¼Œæ”¯æŒç§»åŠ¨è¯­ä¹‰ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token function">shared_ptr</span><span class="token punctuation">(</span>shared_ptr<span class="token operator">&amp;&amp;</span> __r<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
	<span class="token operator">:</span> <span class="token generic-function"><span class="token function">__shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>__r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

shared_ptr<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>shared_ptr<span class="token operator">&amp;&amp;</span> __r<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token operator">-&gt;</span>__shared_ptr<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>__r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      æ³¨æ„ï¼š
      <code>
       std::shared_ptr
      </code>
      æ¨¡æ¿åŒ–çš„ç§»åŠ¨æ‹·è´æ„é€ å’Œç§»åŠ¨èµ‹å€¼æ“ä½œè¿ç®—ç¬¦æºç è¿™é‡Œä¸å†åˆ—ä¸¾ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦è‡ªè¡ŒæŸ¥çœ‹æºä»£ç ã€‚
     </p>
    </blockquote>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">p</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 10</span>

    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> p1<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> p2 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>

    p1 <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>p2<span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>p1 <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 10</span>
<span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="_427">
     </a>
     åº•å±‚ç»“æ„
    </h6>
    <p>
     <code>
      std::shared_ptr
     </code>
     æ˜¯é€šè¿‡ç»§æ‰¿ä¸€ä¸ªå†…éƒ¨æ¨¡æ¿ç±»
     <code>
      __shared_ptr&lt;_Tp&gt;
     </code>
     æ¥å®ç°çš„ã€‚è¿™ç§è®¾è®¡å…è®¸
     <code>
      std::shared_ptr
     </code>
     ç»§æ‰¿åº•å±‚çš„èµ„æºç®¡ç†å’Œå¼•ç”¨è®¡æ•°é€»è¾‘ï¼ŒåŒæ—¶æä¾›æ ‡å‡†åº“çš„æ¥å£ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_Tp</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">shared_ptr</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">__shared_ptr</span><span class="token operator">&lt;</span><span class="token class-name">_Tp</span><span class="token operator">&gt;</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <p>
     åœ¨
     <code>
      __shared_ptr&lt;_Tp&gt;
     </code>
     ç±»ä¸­å°è£…äº†é‡è¦çš„ä¸¤ä¸ªæˆå‘˜å±æ€§ï¼š
     <code>
      _M_ptr
     </code>
     å’Œ
     <code>
      _M_refcount
     </code>
     ã€‚
    </p>
    <ul>
     <li>
      <code>
       _M_ptr
      </code>
      ï¼šæŒ‡å‘è¢«ç®¡ç†åº•å±‚æŒ‡é’ˆçš„æŒ‡é’ˆã€‚
     </li>
     <li>
      <code>
       _M_refcount
      </code>
      ï¼šå¼•ç”¨è®¡æ•°å™¨ï¼Œç”¨äºè·Ÿè¸ªèµ„æºçš„å¼•ç”¨è®¡æ•°ã€‚
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_Tp</span><span class="token punctuation">,</span> _Lock_policy _Lp<span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">__shared_ptr</span> 
    <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">__shared_ptr_access</span><span class="token operator">&lt;</span><span class="token class-name">_Tp</span><span class="token punctuation">,</span> <span class="token class-name">_Lp</span><span class="token operator">&gt;</span></span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ...</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    element_type<span class="token operator">*</span>     _M_ptr<span class="token punctuation">;</span>         <span class="token comment">// Contained pointer.</span>
    __shared_count<span class="token operator">&lt;</span>_Lp<span class="token operator">&gt;</span>  _M_refcount<span class="token punctuation">;</span>    <span class="token comment">// Reference counter.</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <p>
     åœ¨å¼•ç”¨è®¡æ•°å™¨
     <code>
      _M_refcount
     </code>
     ä¸­ï¼Œåˆå°è£…äº†å¼•ç”¨è®¡æ•°é€»è¾‘çš„ç±»
     <code>
      __shared_count
     </code>
     ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span>_Lock_policy _Lp<span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">__shared_count</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    _Sp_counted_base<span class="token operator">&lt;</span>_Lp<span class="token operator">&gt;</span><span class="token operator">*</span>  _M_pi<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <p>
     <code>
      _Sp_counted_base
     </code>
     ä¹Ÿæ˜¯ä¸€ä¸ªæ¨¡æ¿ç±»ï¼Œå°è£…äº†å®é™…çš„å¼•ç”¨è®¡æ•°é€»è¾‘ã€‚å®ƒåŒ…å«ä¸¤ä¸ªåŸå­è®¡æ•°å™¨ï¼š
    </p>
    <ul>
     <li>
      <code>
       _M_use_count
      </code>
      ï¼šè®°å½•å¼ºå¼•ç”¨è®¡æ•°ï¼ˆå³
      <code>
       std::shared_ptr
      </code>
      çš„ä¸ªæ•°ï¼‰ã€‚
     </li>
     <li>
      <code>
       _M_weak_count
      </code>
      ï¼šè®°å½•å¼±å¼•ç”¨è®¡æ•°ï¼ˆå³
      <code>
       std::weak_ptr
      </code>
      çš„ä¸ªæ•°ï¼‰ã€‚
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span>_Lock_policy _Lp <span class="token operator">=</span> __default_lock_policy<span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">_Sp_counted_base</span>
    <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">_Mutex_base</span><span class="token operator">&lt;</span><span class="token class-name">_Lp</span><span class="token operator">&gt;</span></span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ...</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    _Atomic_word  _M_use_count<span class="token punctuation">;</span>     <span class="token comment">// #shared</span>
    _Atomic_word  _M_weak_count<span class="token punctuation">;</span>    <span class="token comment">// #weak + (#shared != 0)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <hr/>
    <p>
     æ¥ä¸‹æ¥ï¼Œä»æ•´ä¸ª
     <code>
      std::shared_ptr
     </code>
     çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ·±å…¥äº†è§£
     <code>
      std::shared_ptr
     </code>
     æ˜¯å¦‚ä½•ç®¡ç†å¼•ç”¨è®¡æ•°å™¨çš„ã€‚
    </p>
    <ul>
     <li>
      å½“ä¸€ä¸ªæ–°çš„
      <code>
       std::shared_ptr
      </code>
      è¢«åˆ›å»ºæ—¶ï¼Œ
      <code>
       _M_use_count
      </code>
      å’Œ
      <code>
       _M_weak_count
      </code>
      é»˜è®¤éƒ½æ˜¯ 1ã€‚
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token keyword">explicit</span> <span class="token function">shared_ptr</span><span class="token punctuation">(</span>_Yp<span class="token operator">*</span> __p<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token generic-function"><span class="token function">__shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>__p<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
</code></pre>
    <p>
     è°ƒç”¨
     <code>
      __shared_ptr&lt;_Tp&gt;(__p)
     </code>
     æ„é€ å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_Yp</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token operator">=</span> _SafeConv<span class="token operator">&lt;</span>_Yp<span class="token operator">&gt;&gt;</span>
<span class="token keyword">explicit</span>
<span class="token function">__shared_ptr</span><span class="token punctuation">(</span>_Yp<span class="token operator">*</span> __p<span class="token punctuation">)</span>
<span class="token operator">:</span> <span class="token function">_M_ptr</span><span class="token punctuation">(</span>__p<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_M_refcount</span><span class="token punctuation">(</span>__p<span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">is_array</span><span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static_assert</span><span class="token punctuation">(</span> <span class="token operator">!</span>is_void<span class="token operator">&lt;</span>_Yp<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>value<span class="token punctuation">,</span> <span class="token string">"incomplete type"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">static_assert</span><span class="token punctuation">(</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>_Yp<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"incomplete type"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">_M_enable_shared_from_this_with</span><span class="token punctuation">(</span>__p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     é¦–å…ˆ
     <code>
      _M_ptr(__p)
     </code>
     åˆå§‹åŒ–æ•°æ®æŒ‡é’ˆï¼Œç´§æ¥ç€ï¼Œè°ƒç”¨
     <code>
      _M_refcount(__p, typename is_array&lt;_Tp&gt;::type())
     </code>
     æ„é€ å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_Ptr</span><span class="token operator">&gt;</span>
<span class="token keyword">explicit</span> <span class="token function">__shared_count</span><span class="token punctuation">(</span>_Ptr __p<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_M_pi</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    __try
    <span class="token punctuation">{<!-- --></span>
		_M_pi <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-function"><span class="token function">_Sp_counted_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>_Ptr<span class="token punctuation">,</span> _Lp<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>__p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">__catch</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">delete</span> __p<span class="token punctuation">;</span>
        __throw_exception_again<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     è°ƒç”¨
     <code>
      _M_pi
     </code>
     çš„æ„é€ å‡½æ•°ï¼Œå…ˆåˆå§‹åŒ–çˆ¶ç±»
     <code>
      _Sp_counted_base
     </code>
     ï¼Œå½“çˆ¶ç±»åˆå§‹åŒ–å®Œæ¯•åå†åˆå§‹åŒ–
     <code>
      _Sp_counted_ptr
     </code>
     ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token function">_Sp_counted_base</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
      <span class="token operator">:</span> <span class="token function">_M_use_count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_M_weak_count</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      æ¯å½“å…±äº«ä¸€ä¸ª
      <code>
       std::shared_ptr
      </code>
      æŒ‡é’ˆæ—¶ï¼Œ
      <code>
       _M_use_count
      </code>
      ä¼šå¢åŠ ã€‚
     </li>
    </ul>
    <blockquote>
     <p>
      ä¸‹é¢ä»¥èµ‹å€¼æ“ä½œè¿ç®—ç¬¦ä¸ºä¾‹ã€‚å…¶ä»–æƒ…å†µåŸºæœ¬ç±»ä¼¼ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚
     </p>
    </blockquote>
    <pre><code class="prism language-cpp">shared_ptr<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> shared_ptr<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <code>
      std::shared_ptr
     </code>
     ä½¿ç”¨äº†
     <code>
      default
     </code>
     çš„æ–¹å¼è®©ç¼–è¯‘å™¨è‡ªåŠ¨ç”Ÿæˆä»£ç ï¼Œè¿™é‡Œå¯ä»¥æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼š
    </p>
    <blockquote>
     <p>
      <a href="https://en.cppreference.com/w/cpp/memory/shared_ptr/operator%3D" rel="nofollow">
       cppreference.com
      </a>
     </p>
     <p>
      Shares ownership of the object managed by r. If r manages no object, *this manages no object too. Equivalent to shared_ptrÂ®.swap(*this).
     </p>
    </blockquote>
    <p>
     æ ¹æ®æ ‡å‡†åº“çš„æ–‡æ¡£ï¼Œæ‹·è´èµ‹å€¼è¿ç®—ç¬¦çš„è¡Œä¸ºç­‰ä»·äºä»¥ä¸‹ä»£ç ï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token function">shared_ptr</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     é¦–å…ˆæ„é€ ä¸€ä¸ªä¸´æ—¶çš„
     <code>
      std::shared_ptr
     </code>
     å¯¹è±¡ï¼Œå®ƒå…±äº«
     <code>
      r
     </code>
     çš„æ‰€æœ‰æƒã€‚ç„¶åï¼Œé€šè¿‡
     <code>
      swap
     </code>
     æ–¹æ³•äº¤æ¢ä¸´æ—¶å¯¹è±¡å’Œå½“å‰å¯¹è±¡çš„å†…å®¹ã€‚
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_Yp</span><span class="token punctuation">,</span>
	       <span class="token keyword">typename</span> <span class="token operator">=</span> _Constructible<span class="token operator">&lt;</span><span class="token keyword">const</span> shared_ptr<span class="token operator">&lt;</span>_Yp<span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token operator">&gt;&gt;</span>
<span class="token function">shared_ptr</span><span class="token punctuation">(</span><span class="token keyword">const</span> shared_ptr<span class="token operator">&lt;</span>_Yp<span class="token operator">&gt;</span><span class="token operator">&amp;</span> __r<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
    <span class="token operator">:</span> <span class="token generic-function"><span class="token function">__shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>__r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
</code></pre>
    <p>
     è°ƒç”¨
     <code>
      __shared_ptr
     </code>
     çš„å¸¦å‚æ„é€ å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_Yp</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token operator">=</span> _Compatible<span class="token operator">&lt;</span>_Yp<span class="token operator">&gt;&gt;</span>
<span class="token function">__shared_ptr</span><span class="token punctuation">(</span><span class="token keyword">const</span> __shared_ptr<span class="token operator">&lt;</span>_Yp<span class="token punctuation">,</span> _Lp<span class="token operator">&gt;</span><span class="token operator">&amp;</span> __r<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
	<span class="token operator">:</span> <span class="token function">_M_ptr</span><span class="token punctuation">(</span>__r<span class="token punctuation">.</span>_M_ptr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_M_refcount</span><span class="token punctuation">(</span>__r<span class="token punctuation">.</span>_M_refcount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
</code></pre>
    <p>
     å…¶ä¸­ï¼Œ
     <code>
      _M_refcount
     </code>
     åˆè°ƒç”¨äº†
     <code>
      __shared_count
     </code>
     çš„æ‹·è´æ„é€ å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"> <span class="token function">__shared_count</span><span class="token punctuation">(</span><span class="token keyword">const</span> __shared_count<span class="token operator">&amp;</span> __r<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
  <span class="token operator">:</span> <span class="token function">_M_pi</span><span class="token punctuation">(</span>__r<span class="token punctuation">.</span>_M_pi<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_M_pi <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    	_M_pi<span class="token operator">-&gt;</span><span class="token function">_M_add_ref_copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     åœ¨è¯¥å‡½æ•°ä¸­å½“
     <code>
      _M_pi != nullptr
     </code>
     æ—¶ï¼Œè°ƒç”¨
     <code>
      _M_add_ref_copy
     </code>
     å‡½æ•°ï¼Œåœ¨è¯¥å‡½æ•°å†…é‡‡ç”¨åŸå­æ“ä½œå¢åŠ å¼ºå¼•ç”¨è®¡æ•°å™¨çš„å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">_M_add_ref_copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span> 
    __gnu_cxx<span class="token double-colon punctuation">::</span><span class="token function">__atomic_add_dispatch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_M_use_count<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     æœ€åçš„äº¤æ¢é€»è¾‘å‚è€ƒ
     <strong>
      å¸¸ç”¨æ“ä½œ
     </strong>
     å°ç»“ä¸­çš„å†…å®¹ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚
    </p>
    <ul>
     <li>
      å½“ä¸€ä¸ª
      <code>
       std::shared_ptr
      </code>
      è¢«é”€æ¯æ—¶ï¼Œ
      <code>
       _M_use_count
      </code>
      å¼•ç”¨è®¡æ•°ä¼šå‡å°‘ã€‚å¦‚æœå¼•ç”¨è®¡æ•°å˜ä¸ºé›¶ï¼Œè¯´æ˜æ²¡æœ‰
      <code>
       std::shared_ptr
      </code>
      å†æŒæœ‰è¯¥å¯¹è±¡ï¼Œæ­¤æ—¶å¯¹è±¡ä¼šè¢«é”€æ¯ã€‚
     </li>
    </ul>
    <p>
     <code>
      __shared_count
     </code>
     å¯¹è±¡å°è£…äº†å¼•ç”¨è®¡æ•°çš„é€»è¾‘ã€‚å½“
     <code>
      std::shared_ptr
     </code>
     è¢«é”€æ¯æ—¶ï¼Œè§¦å‘ææ„é€»è¾‘ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"> <span class="token operator">~</span><span class="token function">__shared_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_M_pi <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    	_M_pi<span class="token operator">-&gt;</span><span class="token function">_M_release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     è°ƒç”¨äº†
     <code>
      _M_release
     </code>
     å‡½æ•°ï¼Œè¯¥å‡½æ•°å†…å¯¹å¼•ç”¨è®¡æ•°å™¨è¿›è¡Œäº†å‡ä¸€çš„æ“ä½œï¼Œå½“å¼•ç”¨è®¡æ•°å™¨ä¸º0æ—¶ï¼Œè§¦å‘èµ„æºå›æ”¶çš„é€»è¾‘ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">_M_release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__gnu_cxx<span class="token double-colon punctuation">::</span><span class="token function">__exchange_and_add_dispatch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_M_use_count<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
       <span class="token comment">// ...</span>
        <span class="token function">_M_dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ...</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>__gnu_cxx<span class="token double-colon punctuation">::</span><span class="token function">__exchange_and_add_dispatch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_M_weak_count<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
          <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// ...</span>
        	<span class="token function">_M_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <p>
     <code>
      __exchange_and_add_dispatch
     </code>
     å‡½æ•°åˆ†åˆ«å¯¹
     <code>
      _M_use_count
     </code>
     å’Œ
     <code>
      _M_weak_count
     </code>
     è¿›è¡Œäº†å‡ä¸€æ“ä½œï¼Œå½“
     <code>
      _M_use_count
     </code>
     å€¼ä¸º 0 æ—¶è°ƒç”¨
     <code>
      _M_dispose
     </code>
     å‡½æ•°ï¼›å½“
     <code>
      _M_weak_count
     </code>
     å€¼ä¸º 0 æ—¶è°ƒç”¨
     <code>
      _M_destroy
     </code>
     å‡½æ•°ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">_M_dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">delete</span> _M_ptr<span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-cpp"><span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">_M_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <p>
     åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬è¿˜æœªå¯¹
     <strong>
      å¼±å¼•ç”¨è®¡æ•°å™¨
     </strong>
     çš„ä½œç”¨è¿›è¡Œè¯´æ˜ã€‚å¦å¤–ï¼Œä»ä¸Šé¢çš„æè¿°ä¸­æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¼ºå¼•ç”¨è®¡æ•°å™¨çš„ä½œç”¨æ˜¯ä¸ºäº†è·Ÿè¸ª
     <code>
      std::shared_ptr
     </code>
     ç®¡ç†çš„åº•å±‚æŒ‡é’ˆè¢«å¤šå°‘ä¸ªå…¶ä»–çš„
     <code>
      std::shared_ptr
     </code>
     å…±äº«ã€‚é‚£ä¹ˆåœ¨è¿™é‡Œæˆ‘å…ˆæŠ›å‡ºä¸€ä¸ªé—®é¢˜ï¼š
     <strong>
      åœ¨ä¸‹é¢çš„ä»£ç ç¤ºä¾‹ä¸­ï¼Œ
      <code>
       class A
      </code>
      å’Œ
      <code>
       class B
      </code>
      ä¸¤ä¸ªç±»çš„å¯¹è±¡é€šè¿‡
      <code>
       std::shared_ptr
      </code>
      æ™ºèƒ½æŒ‡é’ˆç›¸äº’å¼•ç”¨æ—¶ï¼Œåœ¨ç¨‹åºç»“æŸæ—¶æ˜¯å¦å¯ä»¥æ­£å¸¸çš„å°†å¼•ç”¨è®¡æ•°å‡å°‘åˆ°0ï¼Ÿ
     </strong>
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">B</span><span class="token punctuation">;</span>  <span class="token comment">// å‰ç½®å£°æ˜</span>

<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>B<span class="token operator">&gt;</span> b_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>A<span class="token operator">&gt;</span> a_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>A<span class="token operator">&gt;</span> aptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>A<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>B<span class="token operator">&gt;</span> bptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>B<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    aptr<span class="token operator">-&gt;</span>b_ptr <span class="token operator">=</span> bptr<span class="token punctuation">;</span>  <span class="token comment">// A æŒæœ‰ B çš„å…±äº«æŒ‡é’ˆ</span>
    bptr<span class="token operator">-&gt;</span>a_ptr <span class="token operator">=</span> aptr<span class="token punctuation">;</span>  <span class="token comment">// B æŒæœ‰ A çš„å…±äº«æŒ‡é’ˆ</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <strong>
      ç­”æ¡ˆï¼šåœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ
      <code>
       A
      </code>
      å’Œ
      <code>
       B
      </code>
      é€šè¿‡
      <code>
       std::shared_ptr
      </code>
      ç›¸äº’å¼•ç”¨ï¼Œå½¢æˆä¸€ä¸ªå¾ªç¯ä¾èµ–ã€‚å½“ç¨‹åºç»“æŸæ—¶ï¼Œ
      <code>
       A
      </code>
      å’Œ
      <code>
       B
      </code>
      çš„å¼•ç”¨è®¡æ•°éƒ½ä¸º1ï¼Œæ— æ³•å‡å°‘åˆ°0ï¼Œå› æ­¤ä¸ä¼šè§¦å‘åˆ é™¤å™¨ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼
     </strong>
     ã€‚
    </p>
    <p>
     ä¸ºä»€ä¹ˆï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿè§£å†³åŠæ³•æ˜¯å¦å’Œå¼±å¼•ç”¨è®¡æ•°ç›¸å…³ï¼Ÿè¿™äº›æ‚¬å¿µä¼šåœ¨
     <code>
      std::weak_ptr
     </code>
     ç« èŠ‚ä¸­ä¸€ä¸€è§£ç­”ã€‚
    </p>
    <h6>
     <a id="_681">
     </a>
     å¸¸ç”¨æ“ä½œ
    </h6>
    <h6>
     <a id="_683">
     </a>
     è·å–å¼•ç”¨è®¡æ•°
    </h6>
    <p>
     <code>
      use_count
     </code>
     å‡½æ•°è¿”å›å½“å‰
     <code>
      std::shared_ptr
     </code>
     ç®¡ç†çš„åº•å±‚æŒ‡é’ˆçš„å¼•ç”¨è®¡æ•°ï¼Œå³æœ‰å¤šå°‘ä¸ª
     <code>
      std::shared_ptr
     </code>
     å®ä¾‹å…±äº«åŒä¸€ä¸ªåº•å±‚æŒ‡é’ˆã€‚
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">long</span> <span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">return</span> _M_refcount<span class="token punctuation">.</span><span class="token function">_M_get_use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
    <p>
     è°ƒç”¨
     <code>
      _M_refcount
     </code>
     çš„
     <code>
      _M_get_use_count
     </code>
     å‡½æ•°ï¼Œå¦‚æœ
     <code>
      std::shared_ptr
     </code>
     æ²¡æœ‰å¼•ç”¨ä»»ä½•æŒ‡é’ˆï¼Œåˆ™
     <code>
      _M_pi
     </code>
     å¯¹è±¡ä¸º
     <code>
      nullptr
     </code>
     åˆ™è¿”å› 0ï¼Œå¦åˆ™è°ƒç”¨
     <code>
      _M_pi
     </code>
     å¯¹è±¡çš„
     <code>
      _M_get_use_count
     </code>
     è·å–å¼ºå¼•ç”¨è®¡æ•°å€¼ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">long</span> <span class="token function">_M_get_use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">return</span> _M_pi <span class="token operator">?</span> _M_pi<span class="token operator">-&gt;</span><span class="token function">_M_get_use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ç´§æ¥ç€ï¼Œåœ¨
     <code>
      _M_get_use_count
     </code>
     ä¸­ä½¿ç”¨åŸå­æ“ä½œè¯»å–
     <code>
      _M_use_count
     </code>
     å¼ºå¼•ç”¨è®¡æ•°å™¨çš„å€¼ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">long</span> <span class="token function">_M_get_use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// No memory barrier is used here so there is no synchronization</span>
    <span class="token comment">// with other threads.</span>
    <span class="token keyword">return</span> <span class="token function">__atomic_load_n</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_M_use_count<span class="token punctuation">,</span> __ATOMIC_RELAXED<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     å…¶ä¸­ï¼Œ
     <code>
      __ATOMIC_RELAXED
     </code>
     æ˜¯æœ€å¼±çš„å†…å­˜é¡ºåºæ¨¡å‹ï¼Œä»…ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œä¸æä¾›ä»»ä½•å†…å­˜é¡ºåºä¿è¯ã€‚
    </p>
    <h6>
     <a id="_716">
     </a>
     é‡ç½®
    </h6>
    <p>
     <code>
      reset
     </code>
     å‡½æ•°ç”¨äºé‡Šæ”¾å½“å‰
     <code>
      std::shared_ptr
     </code>
     ç®¡ç†çš„æŒ‡é’ˆã€‚
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token function">__shared_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
    <p>
     åœ¨
     <code>
      reset
     </code>
     å‡½æ•°ä¸­ä½¿ç”¨é»˜è®¤æ„é€ åˆ›å»ºäº†
     <code>
      __shared_ptr
     </code>
     ä¸´æ—¶å¯¹è±¡ï¼Œè¿™ä¸ªä¸´æ—¶å¯¹è±¡ä¸ç®¡ç†ä»»ä½•èµ„æºï¼ˆå³å®ƒçš„å¼•ç”¨è®¡æ•°ä¸º 0ï¼‰ã€‚ç„¶åè°ƒç”¨äº†
     <code>
      swap
     </code>
     å‡½æ•°å°†å½“å‰
     <code>
      std::shared_ptr
     </code>
     å¯¹è±¡çš„å†…å®¹ä¸ä¸´æ—¶å¯¹è±¡äº¤æ¢ã€‚äº¤æ¢åï¼Œå½“å‰
     <code>
      std::shared_ptr
     </code>
     çš„å†…å®¹è¢«æ¸…ç©ºã€‚åŒæ—¶ï¼Œä¸´æ—¶å¯¹è±¡æ¥ç®¡äº†å½“å‰
     <code>
      std::shared_ptr
     </code>
     çš„èµ„æºï¼Œä½†ç”±äºä¸´æ—¶å¯¹è±¡å³å°†è¢«é”€æ¯ï¼Œå®ƒçš„ææ„å‡½æ•°å°±ä¼šè‡ªåŠ¨é‡Šæ”¾è¿™äº›èµ„æºã€‚
    </p>
    <h6>
     <a id="_729">
     </a>
     è·å–åŸå§‹æŒ‡é’ˆ
    </h6>
    <p>
     <code>
      get
     </code>
     å‡½æ•°è¿”å›
     <code>
      std::shared_ptr
     </code>
     ç®¡ç†çš„åº•å±‚æŒ‡é’ˆï¼Œä½†ä¸ä¼šè½¬ç§»æ‰€æœ‰æƒã€‚
    </p>
    <pre><code class="prism language-cpp">element_type<span class="token operator">*</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">return</span> _M_ptr<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="_740">
     </a>
     äº¤æ¢
    </h6>
    <p>
     <code>
      swap()
     </code>
     å‡½æ•°ç”¨äºäº¤æ¢ä¸¤ä¸ª
     <code>
      std::shared_ptr
     </code>
     çš„ç®¡ç†åº•å±‚æŒ‡é’ˆå’Œå¼•ç”¨å™¨ã€‚
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span>__shared_ptr<span class="token operator">&lt;</span>_Tp<span class="token punctuation">,</span> _Lp<span class="token operator">&gt;</span><span class="token operator">&amp;</span> __other<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>_M_ptr<span class="token punctuation">,</span> __other<span class="token punctuation">.</span>_M_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _M_refcount<span class="token punctuation">.</span><span class="token function">_M_swap</span><span class="token punctuation">(</span>__other<span class="token punctuation">.</span>_M_refcount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ä½¿ç”¨æ ‡å‡†åº“ä¸­çš„
     <code>
      swap
     </code>
     å‡½æ•°å¯¹åº•å±‚æŒ‡é’ˆè¿›è¡Œäº¤æ¢ï¼Œç„¶åè°ƒç”¨äº†
     <code>
      _M_swap
     </code>
     å‡½æ•°äº¤æ¢å¼•ç”¨è®¡æ•°å™¨ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"> <span class="token keyword">void</span> <span class="token function">_M_swap</span><span class="token punctuation">(</span>__shared_count<span class="token operator">&amp;</span> __r<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
    _Sp_counted_base<span class="token operator">&lt;</span>_Lp<span class="token operator">&gt;</span><span class="token operator">*</span> __tmp <span class="token operator">=</span> __r<span class="token punctuation">.</span>_M_pi<span class="token punctuation">;</span>
    __r<span class="token punctuation">.</span>_M_pi <span class="token operator">=</span> _M_pi<span class="token punctuation">;</span>
    _M_pi <span class="token operator">=</span> __tmp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="_763">
     </a>
     æ£€æµ‹æ˜¯å¦å”¯ä¸€
    </h6>
    <p>
     <code>
      unique()
     </code>
     å‡½æ•°ç”¨äºæ£€æŸ¥å½“å‰
     <code>
      std::shared_ptr
     </code>
     æ˜¯å¦æ˜¯å…¶ç®¡ç†åº•å±‚æŒ‡é’ˆçš„å”¯ä¸€æ‰€æœ‰è€…ã€‚
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token function">unique</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">return</span> _M_refcount<span class="token punctuation">.</span><span class="token function">_M_unique</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
    <p>
     è°ƒç”¨
     <code>
      _M_unique
     </code>
     å‡½æ•°ï¼Œè¿”å›ä¸€ä¸ª
     <code>
      bool
     </code>
     å€¼ã€‚å¦‚æœ
     <code>
      _M_get_use_count
     </code>
     å‡½æ•°çš„è¿”å›å€¼ç­‰äº1è¿”å›
     <code>
      true
     </code>
     å¦åˆ™è¿”å›
     <code>
      false
     </code>
     ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token function">_M_unique</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">_M_get_use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
    <p>
     åœ¨
     <code>
      _M_get_use_count
     </code>
     å‡½æ•°ä¸­è°ƒç”¨äº†
     <code>
      _M_pi
     </code>
     çš„
     <code>
      _M_get_use_count
     </code>
     æ–¹æ³•ï¼Œè¿”å›åº•å±‚æŒ‡é’ˆçš„å¼ºå¼•ç”¨è®¡æ•°å€¼ã€‚å…·ä½“
     <code>
      _M_get_use_count
     </code>
     æ–¹æ³•å†…å®¹ï¼Œè¯·å‚è€ƒ
     <strong>
      è·å–å¼•ç”¨è®¡æ•°
     </strong>
     å‡½æ•°è§£æã€‚
    </p>
    <h6>
     <a id="_785">
     </a>
     åˆ¤æ–­ç›¸ç­‰æ€§
    </h6>
    <p>
     ä¸‹é¢ç»™å‡ºä¸€æ®µä»£ç ï¼Œè¯¥ä»£ç ä¸­åˆ¤æ–­äº†ä¸¤ä¸ª
     <code>
      std::shared_ptr
     </code>
     çš„ç›¸ç­‰æ€§ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">p</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> p1 <span class="token operator">=</span> p<span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">p2</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> p1<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 1</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>p <span class="token operator">==</span> p2<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 0</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     å¯¹è±¡ç›¸ç­‰æ€§åˆ¤æ–­çš„ä¾æ®æ˜¯
     <code>
      ==
     </code>
     è¿ç®—ç¬¦é‡è½½å‡½æ•°çš„åˆ¤æ–­é€»è¾‘ï¼Œå‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_Tp</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">_Up</span><span class="token operator">&gt;</span>
_GLIBCXX_NODISCARD <span class="token keyword">inline</span> <span class="token keyword">bool</span>
<span class="token keyword">operator</span><span class="token operator">==</span><span class="token punctuation">(</span><span class="token keyword">const</span> shared_ptr<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span><span class="token operator">&amp;</span> __a<span class="token punctuation">,</span> <span class="token keyword">const</span> shared_ptr<span class="token operator">&lt;</span>_Up<span class="token operator">&gt;</span><span class="token operator">&amp;</span> __b<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> __a<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> __b<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
</code></pre>
    <p>
     åœ¨è¯¥å‡½æ•°ä¸­ï¼Œåˆ†åˆ«å¯¹ä¸¤ä¸ª
     <code>
      std::shared_ptr
     </code>
     è°ƒç”¨äº†
     <code>
      get
     </code>
     å‡½æ•°ï¼Œåˆ¤æ–­ä¸¤ä¸ªåº•å±‚ç®¡ç†çš„æŒ‡é’ˆæ˜¯å¦ç›¸ç­‰ï¼Œåˆå› ä¸ºæŒ‡é’ˆçš„ç›¸ç­‰æ€§æ˜¯æ ¹æ®æŒ‡é’ˆçš„åœ°å€æ˜¯å¦ç›¸ç­‰æ¥ç¡®å®šçš„ï¼Œæ‰€ä»¥ä¸¤ä¸ª
     <code>
      std::shared_ptr
     </code>
     æ˜¯å¦ç›¸ç­‰å°±æ˜¯åˆ¤æ–­åˆ†åˆ«å¼•ç”¨çš„åº•å±‚æŒ‡é’ˆåœ°å€æ˜¯å¦ç›¸ç­‰ã€‚
    </p>
    <h5>
     <a id="stdweak_ptr_816">
     </a>
     <code>
      std::weak_ptr
     </code>
    </h5>
    <p>
     <code>
      std::weak_ptr
     </code>
     æ˜¯
     <code>
      C++11
     </code>
     æ ‡å‡†åº“ä¸­çš„ä¸€ç§æ™ºèƒ½æŒ‡é’ˆï¼Œç”¨äºè§£å†³
     <code>
      std::shared_ptr
     </code>
     åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°çš„å¾ªç¯å¼•ç”¨é—®é¢˜ï¼ŒåŒæ—¶å…è®¸å¯¹èµ„æºè¿›è¡Œâ€œå¼±å¼•ç”¨â€ã€‚ä¸
     <code>
      std::shared_ptr
     </code>
     ä¸åŒï¼Œ
     <code>
      std::weak_ptr
     </code>
     ä¸ä¼šå¢åŠ èµ„æºçš„å¼ºå¼•ç”¨è®¡æ•°ï¼Œå› æ­¤ä¸ä¼šé˜»æ­¢èµ„æºçš„é”€æ¯ã€‚
    </p>
    <p>
     æˆ‘ä»¬é‡æ–°çœ‹ä¸€ä¸‹
     <code>
      std::shared_ptr
     </code>
     ç« èŠ‚ä¸­ç»™å‡ºçš„å¼‚å¸¸ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">B</span><span class="token punctuation">;</span>  <span class="token comment">// å‰ç½®å£°æ˜</span>

<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>B<span class="token operator">&gt;</span> b_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>A<span class="token operator">&gt;</span> a_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>A<span class="token operator">&gt;</span> aptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>A<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>B<span class="token operator">&gt;</span> bptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>B<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    aptr<span class="token operator">-&gt;</span>b_ptr <span class="token operator">=</span> bptr<span class="token punctuation">;</span>  <span class="token comment">// A æŒæœ‰ B çš„å…±äº«æŒ‡é’ˆ</span>
    bptr<span class="token operator">-&gt;</span>a_ptr <span class="token operator">=</span> aptr<span class="token punctuation">;</span>  <span class="token comment">// B æŒæœ‰ A çš„å…±äº«æŒ‡é’ˆ</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     æ¥ä¸‹æ¥ï¼Œæ ¹æ®æ¯è¡Œä»£ç åˆ†æä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆä¼šå‡ºç°åœ¨ç¨‹åºç»“æŸæ—¶ï¼Œå¼•ç”¨è®¡æ•°æ— æ³•åˆ° 0 çš„é—®é¢˜ã€‚
    </p>
    <ul>
     <li>
      é¦–å…ˆåˆ›å»º
      <code>
       aptr
      </code>
      ï¼Œ
      <code>
       _M_use_count
      </code>
      å’Œ
      <code>
       _M_weak_count
      </code>
      éƒ½æ˜¯ 1ã€‚
     </li>
     <li>
      ç´§æ¥ç€åˆ›å»º
      <code>
       bptr
      </code>
      ï¼Œ
      <code>
       _M_use_count
      </code>
      å’Œ
      <code>
       _M_weak_count
      </code>
      ä¹Ÿéƒ½æ˜¯ 1ã€‚
     </li>
     <li>
      å½“æ‰§è¡Œåˆ°
      <code>
       aptr-&gt;b_ptr = bptr
      </code>
      æ—¶ï¼Œ
      <code>
       bptr
      </code>
      çš„
      <code>
       _M_use_count
      </code>
      å¼•ç”¨è®¡æ•°å™¨å¢é•¿å˜æˆäº† 2ã€‚
     </li>
     <li>
      åŒç†å½“æ‰§è¡Œåˆ°
      <code>
       bptr-&gt;a_ptr = aptr
      </code>
      æ—¶ï¼Œ
      <code>
       aptr
      </code>
      çš„
      <code>
       _M_use_count
      </code>
      å¼•ç”¨è®¡æ•°å™¨ä¹Ÿå¢é•¿å˜æˆäº† 2ã€‚
     </li>
     <li>
      å½“ç¨‹åº
      <code>
       main
      </code>
      å‡½æ•°ç»“æŸæ—¶ï¼Œå¯¹å‡½æ•°æ ˆä¸­çš„æ ˆå¯¹è±¡ä¾æ¬¡è¿›è¡Œææ„ï¼š
      <ul>
       <li>
        é¦–å…ˆææ„
        <code>
         bptr
        </code>
        ï¼Œå°†
        <code>
         bptr
        </code>
        çš„
        <code>
         _M_use_count
        </code>
        å¼•ç”¨è®¡æ•°å™¨å‡å°‘å˜æˆäº† 1ï¼Œå› ä¸º
        <code>
         _M_use_count
        </code>
        ä¸æ˜¯ 0 æ— æ³•è§¦å‘
        <code>
         _M_dispose
        </code>
        å‡½æ•°çš„æ‰§è¡Œã€‚
       </li>
       <li>
        ç„¶åææ„
        <code>
         aptr
        </code>
        ï¼Œå°†
        <code>
         aptr
        </code>
        çš„
        <code>
         _M_use_count
        </code>
        å¼•ç”¨è®¡æ•°å™¨ä¹Ÿå‡å°‘å˜æˆäº† 1ï¼Œå› ä¸º
        <code>
         _M_use_count
        </code>
        åŒæ ·ä¸æ˜¯ 0 ä¹Ÿæ— æ³•è§¦å‘
        <code>
         _M_dispose
        </code>
        å‡½æ•°çš„æ‰§è¡Œã€‚
       </li>
      </ul>
     </li>
     <li>
      æœ€ç»ˆï¼Œä¸¤ä¸ª
      <code>
       std::shared_ptr
      </code>
      æ‰€ç®¡ç†çš„åº•å±‚æŒ‡é’ˆéƒ½æ— æ³•å¾—åˆ°æ­£ç¡®çš„èµ„æºé‡Šæ”¾ï¼Œå½¢æˆå†…å­˜æ³„æ¼é—®é¢˜ã€‚
     </li>
    </ul>
    <p>
     ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±å¯ä»¥ä½¿ç”¨
     <code>
      std::weak_ptr
     </code>
     æ¥æ‰“ç ´å¾ªç¯å¼•ç”¨ã€‚å› ä¸º
     <code>
      std::weak_ptr
     </code>
     ä¸ä¼šå¢åŠ å¼ºå¼•ç”¨è®¡æ•°ï¼Œæ‰€ä»¥å¯ä»¥å®‰å…¨åœ°è®¿é—®èµ„æºã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">B</span><span class="token punctuation">;</span>  <span class="token comment">// å‰ç½®å£°æ˜</span>

<span class="token keyword">class</span> <span class="token class-name">A</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>weak_ptr<span class="token operator">&lt;</span>B<span class="token operator">&gt;</span> b_ptr<span class="token punctuation">;</span>  <span class="token comment">// ä½¿ç”¨ weak_ptr</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">B</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>weak_ptr<span class="token operator">&lt;</span>A<span class="token operator">&gt;</span> a_ptr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>A<span class="token operator">&gt;</span> aptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>A<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span>B<span class="token operator">&gt;</span> bptr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_shared</span><span class="token generic class-name"><span class="token operator">&lt;</span>B<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    aptr<span class="token operator">-&gt;</span>b_ptr <span class="token operator">=</span> bptr<span class="token punctuation">;</span>  <span class="token comment">// A æŒæœ‰ B çš„å¼±å¼•ç”¨</span>
    bptr<span class="token operator">-&gt;</span>a_ptr <span class="token operator">=</span> aptr<span class="token punctuation">;</span>  <span class="token comment">// B æŒæœ‰ A çš„å¼±å¼•ç”¨</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token comment">// ç¨‹åºç»“æŸæ—¶ï¼Œèµ„æºå¯ä»¥æ­£ç¡®é‡Šæ”¾</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      å½“æ‰§è¡Œåˆ°
      <code>
       aptr-&gt;b_ptr = bptr
      </code>
      æ—¶ï¼Œ
      <code>
       bptr
      </code>
      çš„
      <code>
       _M_use_count
      </code>
      å¼•ç”¨è®¡æ•°å™¨ä¸ä¼šå¢é•¿ï¼Œä½†æ˜¯ä¼šå¯¹
      <code>
       _M_weak_count
      </code>
      å¼•ç”¨è®¡æ•°å™¨å¢é•¿ï¼Œå˜æˆäº† 2ã€‚
     </li>
     <li>
      åŒç†å½“æ‰§è¡Œåˆ°
      <code>
       bptr-&gt;a_ptr = aptr
      </code>
      æ—¶ï¼Œ
      <code>
       aptr
      </code>
      çš„
      <code>
       _M_use_count
      </code>
      å¼•ç”¨è®¡æ•°å™¨ä¹Ÿä¸ä¼šå¢é•¿ï¼ŒåŒæ ·ä¼šå¯¹
      <code>
       _M_weak_count
      </code>
      å¼•ç”¨è®¡æ•°å™¨å¢é•¿ï¼Œå˜æˆäº† 2ã€‚
     </li>
     <li>
      å½“
      <code>
       main
      </code>
      å‡½æ•°ç»“æŸæ—¶ï¼Œè§¦å‘ææ„é€»è¾‘ï¼š
      <ul>
       <li>
        é¦–å…ˆææ„
        <code>
         bptr
        </code>
        ï¼š
        <ul>
         <li>
          <code>
           bptr
          </code>
          çš„
          <code>
           _M_use_count
          </code>
          å‡å°‘1ï¼Œå˜ä¸º 0ï¼›å› ä¸º
          <code>
           _M_use_count
          </code>
          ä¸º 0ï¼Œè§¦å‘
          <code>
           _M_dispose
          </code>
          å‡½æ•°ï¼Œé‡Šæ”¾
          <code>
           B
          </code>
          çš„èµ„æºã€‚
         </li>
         <li>
          <code>
           bptr
          </code>
          çš„
          <code>
           _M_weak_count
          </code>
          å‡å°‘1ï¼Œå˜ä¸º1ã€‚
         </li>
        </ul>
       </li>
       <li>
        ç„¶åææ„
        <code>
         aptr
        </code>
        ï¼š
        <ul>
         <li>
          <code>
           aptr
          </code>
          çš„
          <code>
           _M_use_count
          </code>
          å‡å°‘1ï¼Œå˜ä¸º 0ï¼›å› ä¸º
          <code>
           _M_use_count
          </code>
          ä¸º 0ï¼Œè§¦å‘
          <code>
           _M_dispose
          </code>
          å‡½æ•°ï¼Œé‡Šæ”¾
          <code>
           A
          </code>
          çš„èµ„æºã€‚
         </li>
         <li>
          <code>
           aptr
          </code>
          çš„
          <code>
           _M_weak_count
          </code>
          å‡å°‘1ï¼Œå˜ä¸º1ã€‚
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      å½“æœ€åä¸€ä¸ª
      <code>
       std::weak_ptr
      </code>
      è¢«ææ„æ—¶ï¼Œ
      <code>
       _M_weak_count
      </code>
      å‡å°‘åˆ° 0ï¼Œè§¦å‘
      <code>
       _M_destroy
      </code>
      å‡½æ•°çš„æ‰§è¡Œã€‚è‡³æ­¤å†…å­˜éƒ½è¢«æ­£å¸¸é‡Šæ”¾ï¼Œæ— å†…å­˜æ³„æ¼é—®é¢˜ã€‚
     </li>
    </ul>
    <hr/>
    <p>
     æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä¸€èµ·æ·±å…¥
     <code>
      std::weak_ptr
     </code>
     ä¸­æ¢ç©¶å…¶èƒŒåçš„åŸç†ã€‚
    </p>
    <p>
     <code>
      std::weak_ptr
     </code>
     æ”¯æŒæ‹·è´è¯­ä¹‰å’Œç§»åŠ¨è¯­ä¹‰ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token function">weak_ptr</span><span class="token punctuation">(</span><span class="token keyword">const</span> weak_ptr<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
weak_ptr<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> weak_ptr<span class="token operator">&amp;</span> __r<span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
</code></pre>
    <pre><code class="prism language-cpp"><span class="token function">weak_ptr</span><span class="token punctuation">(</span>weak_ptr<span class="token operator">&amp;&amp;</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
weak_ptr<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>weak_ptr<span class="token operator">&amp;&amp;</span> __r<span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      æ³¨æ„ï¼š
      <code>
       std::weak_ptr
      </code>
      æ¨¡æ¿åŒ–çš„æ‹·è´æ„é€ ã€ç§»åŠ¨æ„é€ å‡½æ•°å’Œç§»åŠ¨ã€èµ‹å€¼æ“ä½œè¿ç®—ç¬¦æºç è¿™é‡Œä¸å†åˆ—ä¸¾ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦è‡ªè¡ŒæŸ¥çœ‹ã€‚
     </p>
    </blockquote>
    <h6>
     <a id="_914">
     </a>
     åº•å±‚ç»“æ„
    </h6>
    <p>
     é¦–å…ˆ
     <code>
      std::weak_ptr
     </code>
     ç»§æ‰¿è‡ª
     <code>
      __weak_ptr&lt;Tp&gt;
     </code>
     ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"> <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_Tp</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">weak_ptr</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">__weak_ptr</span><span class="token operator">&lt;</span><span class="token class-name">_Tp</span><span class="token operator">&gt;</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <p>
     <code>
      __weak_ptr
     </code>
     æ˜¯
     <code>
      std::weak_ptr
     </code>
     çš„åº•å±‚å®ç°ç±»ï¼Œç”¨äºç®¡ç†å¯¹èµ„æºçš„å¼±å¼•ç”¨ã€‚åœ¨
     <code>
      __weak_ptr
     </code>
     ç±»ä¸­æœ‰ä¸¤ä¸ªæ ¸å¿ƒçš„æˆå‘˜å±æ€§
     <code>
      _M_ptr
     </code>
     å’Œ
     <code>
      _M_refcount
     </code>
     ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">_Tp</span><span class="token punctuation">,</span> _Lock_policy _Lp<span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">__weak_ptr</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ...</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    element_type<span class="token operator">*</span>	 _M_ptr<span class="token punctuation">;</span>         <span class="token comment">// Contained pointer.</span>
    __weak_count<span class="token operator">&lt;</span>_Lp<span class="token operator">&gt;</span>  _M_refcount<span class="token punctuation">;</span>    <span class="token comment">// Reference counter.</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <p>
     åœ¨
     <code>
      __weak_count
     </code>
     ä¸­åˆå°è£…äº†å¯¹
     <code>
      _Sp_counted_base
     </code>
     çš„å¼•ç”¨è®¡æ•°å™¨çš„ç®¡ç†ï¼Œç¡®ä¿å¼•ç”¨è®¡æ•°çš„ç”Ÿå‘½å‘¨æœŸè¢«æ­£ç¡®è·Ÿè¸ªã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span>_Lock_policy _Lp<span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">__weak_count</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    _Sp_counted_base<span class="token operator">&lt;</span>_Lp<span class="token operator">&gt;</span><span class="token operator">*</span>  _M_pi<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <hr/>
    <ul>
     <li>
      å½“åˆ›å»ºä¸€ä¸ª
      <code>
       std::weak_ptr
      </code>
      æ—¶ï¼Œè°ƒç”¨å…¶æ„é€ å‡½æ•°ï¼ŒåŒæ—¶ä¹Ÿè°ƒç”¨
      <code>
       __weak_ptr
      </code>
      çš„æ„é€ å‡½æ•°ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token function">weak_ptr</span><span class="token punctuation">(</span><span class="token keyword">const</span> shared_ptr<span class="token operator">&lt;</span>_Yp<span class="token operator">&gt;</span><span class="token operator">&amp;</span> __r<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
	<span class="token operator">:</span> <span class="token generic-function"><span class="token function">__weak_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>__r<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-cpp"><span class="token function">__weak_ptr</span><span class="token punctuation">(</span><span class="token keyword">const</span> __shared_ptr<span class="token operator">&lt;</span>_Yp<span class="token punctuation">,</span> _Lp<span class="token operator">&gt;</span><span class="token operator">&amp;</span> __r<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
	<span class="token operator">:</span> <span class="token function">_M_ptr</span><span class="token punctuation">(</span>__r<span class="token punctuation">.</span>_M_ptr<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_M_refcount</span><span class="token punctuation">(</span>__r<span class="token punctuation">.</span>_M_refcount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
</code></pre>
    <p>
     åˆå§‹åŒ–æ•°æ®æŒ‡é’ˆ
     <code>
      _M_ptr
     </code>
     ï¼Œå¦‚æœå½“å‰å¯¹è±¡ç¡®å®ç®¡ç†äº†ä¸€ä¸ªæœ‰æ•ˆçš„èµ„æºåˆ™å¢åŠ å¼±å¼•ç”¨è®¡æ•°
     <code>
      _M_weak_count
     </code>
     ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token function">__weak_count</span><span class="token punctuation">(</span><span class="token keyword">const</span> __shared_count<span class="token operator">&lt;</span>_Lp<span class="token operator">&gt;</span><span class="token operator">&amp;</span> __r<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
	<span class="token operator">:</span> <span class="token function">_M_pi</span><span class="token punctuation">(</span>__r<span class="token punctuation">.</span>_M_pi<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_M_pi <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    	_M_pi<span class="token operator">-&gt;</span><span class="token function">_M_weak_add_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     è°ƒç”¨
     <code>
      _M_weak_add_ref
     </code>
     å‡½æ•°å¢åŠ å¼±å¼•ç”¨è®¡æ•°
     <code>
      _M_weak_count
     </code>
     ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œç¡®ä¿åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­æ­£ç¡®åœ°æ›´æ–°å¼±å¼•ç”¨è®¡æ•°ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">_M_weak_add_ref</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> 
     __gnu_cxx<span class="token double-colon punctuation">::</span><span class="token function">__atomic_add_dispatch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_M_weak_count<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      å½“é”€æ¯æˆ–è€…æˆ–é‡ç½®
      <code>
       std::weak_ptr
      </code>
      æ—¶ï¼Œ
      <code>
       __weak_count
      </code>
      çš„ææ„å‡½æ•°ä¼šè¢«è°ƒç”¨ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token operator">~</span><span class="token function">__weak_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>_M_pi <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>
    	_M_pi<span class="token operator">-&gt;</span><span class="token function">_M_weak_release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     åœ¨
     <code>
      _M_weak_release
     </code>
     å‡½æ•°ä¸­ä¼šè°ƒç”¨
     <code>
      __exchange_and_add_dispatch
     </code>
     å‡½æ•°å°†
     <code>
      _M_weak_count
     </code>
     å¼±å¼•ç”¨è®¡æ•°å™¨å‡ä¸€ï¼Œå¦‚æœå½“å¼±å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶ï¼Œåˆ™è°ƒç”¨
     <code>
      _M_destroy
     </code>
     æ–¹æ³•ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">_M_weak_release</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__gnu_cxx<span class="token double-colon punctuation">::</span><span class="token function">__exchange_and_add_dispatch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_M_weak_count<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...</span>
        
        <span class="token function">_M_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <p>
     <code>
      _M_destroy
     </code>
     æ˜¯
     <code>
      _Sp_counted_base
     </code>
     ç±»ä¸­çš„ä¸€ä¸ªå…³é”®æ–¹æ³•ï¼Œå®ƒç¡®ä¿åœ¨å¼•ç”¨è®¡æ•°ä¸º 0 æ—¶ï¼Œèµ„æºè¢«æ­£ç¡®é‡Šæ”¾ã€‚
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">_M_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">delete</span> <span class="token keyword">this</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="_1028">
     </a>
     å¸¸ç”¨æ“ä½œ
    </h6>
    <h6>
     <a id="_1030">
     </a>
     æ£€æŸ¥å¼•ç”¨å¯¹è±¡æ˜¯å¦è¢«é”€æ¯
    </h6>
    <p>
     <code>
      expired
     </code>
     å‡½æ•°ç”¨äºæ£€æŸ¥
     <code>
      std::weak_ptr
     </code>
     æ‰€å¼•ç”¨çš„å¯¹è±¡æ˜¯å¦å·²ç»è¢«é”€æ¯ã€‚å¦‚æœ
     <code>
      std::weak_ptr
     </code>
     æ‰€å¼•ç”¨çš„å¯¹è±¡å·²ç»è¢«é”€æ¯ï¼Œåˆ™è¿”å›
     <code>
      true
     </code>
     ï¼›å¦åˆ™è¿”å›
     <code>
      false
     </code>
     ã€‚
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">bool</span> <span class="token function">expired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> 
	<span class="token keyword">return</span> _M_refcount<span class="token punctuation">.</span><span class="token function">_M_get_use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
    <p>
     å…·ä½“
     <code>
      _M_get_use_count
     </code>
     æ–¹æ³•å†…å®¹ï¼Œ è¯·å‚è€ƒ
     <strong>
      è·å–å¼•ç”¨è®¡æ•°
     </strong>
     å‡½æ•°è§£æã€‚
    </p>
    <h6>
     <a id="_stdshared_ptr_1043">
     </a>
     è·å–
     <code>
      std::shared_ptr
     </code>
    </h6>
    <p>
     <code>
      lock
     </code>
     å‡½æ•°å°è¯•è·å–ä¸€ä¸ª
     <code>
      std::shared_ptr
     </code>
     ï¼ŒæŒ‡å‘
     <code>
      std::weak_ptr
     </code>
     æ‰€å¼•ç”¨çš„å¯¹è±¡ã€‚å¦‚æœå¯¹è±¡ä»ç„¶å­˜åœ¨ï¼Œè¿”å›ä¸€ä¸ª
     <code>
      std::shared_ptr
     </code>
     ï¼Œå…±äº«å¯¹è±¡çš„æ‰€æœ‰æƒï¼›å¦‚æœå¯¹è±¡å·²ç»è¢«é”€æ¯ï¼Œè¿”å›ä¸€ä¸ªç©ºçš„
     <code>
      std::shared_ptr
     </code>
     ã€‚
    </p>
    <pre><code class="prism language-cpp">shared_ptr<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> 
	<span class="token keyword">return</span> <span class="token generic-function"><span class="token function">shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>nothrow<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ç›´æ¥è°ƒç”¨äº†
     <code>
      std::shared_ptr
     </code>
     çš„æ„é€ å‡½æ•°ï¼Œç´§æ¥ç€åˆè°ƒç”¨äº†
     <code>
      __shared_ptr
     </code>
     çš„æ„é€ å‡½æ•°ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token function">shared_ptr</span><span class="token punctuation">(</span><span class="token keyword">const</span> weak_ptr<span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span><span class="token operator">&amp;</span> __r<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>nothrow_t<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
    <span class="token operator">:</span> <span class="token generic-function"><span class="token function">__shared_ptr</span><span class="token generic class-name"><span class="token operator">&lt;</span>_Tp<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>__r<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>nothrow<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
</code></pre>
    <p>
     åœ¨è¯¥å‡½æ•°ä¸­ï¼Œé¦–å…ˆä»
     <code>
      __r
     </code>
     çš„å¼•ç”¨è®¡æ•°ä¸­åˆå§‹åŒ–å½“å‰
     <code>
      std::shared_ptr
     </code>
     çš„å¼•ç”¨è®¡æ•°ã€‚ç„¶åè®¾ç½®æ•°æ®æŒ‡é’ˆï¼Œå½“
     <code>
      _M_get_use_count
     </code>
     è¿”å›éé›¶å€¼ï¼ˆå³èµ„æºä»ç„¶å­˜åœ¨ï¼‰ï¼Œåˆ™
     <code>
      _M_ptr
     </code>
     è¢«è®¾ç½®ä¸º
     <code>
      __r._M_ptr
     </code>
     ï¼›å¦åˆ™å°±æ˜¯èµ„æºå·²ç»è¢«é”€æ¯
     <code>
      _M_ptr
     </code>
     è¢«è®¾ç½®ä¸º
     <code>
      nullptr
     </code>
     ã€‚
    </p>
    <pre><code class="prism language-cpp"><span class="token function">__shared_ptr</span><span class="token punctuation">(</span><span class="token keyword">const</span> __weak_ptr<span class="token operator">&lt;</span>_Tp<span class="token punctuation">,</span> _Lp<span class="token operator">&gt;</span><span class="token operator">&amp;</span> __r<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>nothrow_t<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
	<span class="token operator">:</span> <span class="token function">_M_refcount</span><span class="token punctuation">(</span>__r<span class="token punctuation">.</span>_M_refcount<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>nothrow<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	_M_ptr <span class="token operator">=</span> _M_refcount<span class="token punctuation">.</span><span class="token function">_M_get_use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> __r<span class="token punctuation">.</span>_M_ptr <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="_1071">
     </a>
     é‡ç½®
    </h6>
    <p>
     <code>
      reset
     </code>
     å‡½æ•°å°†
     <code>
      std::weak_ptr
     </code>
     ç½®ä¸ºç©ºï¼Œè¡¨ç¤ºä¸å†å¼•ç”¨ä»»ä½•å¯¹è±¡ï¼Œå¹¶ä¸ä¼šå½±å“å¼•ç”¨è®¡æ•°ã€‚
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> 
	<span class="token function">__weak_ptr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
    <p>
     é¦–å…ˆè°ƒç”¨é»˜è®¤æ„é€ å‡½æ•°åˆ›å»º
     <code>
      std::weak_ptr
     </code>
     å¯¹è±¡ï¼Œç„¶åè°ƒç”¨
     <code>
      swap
     </code>
     å‡½æ•°è¿›è¡Œäº¤æ¢ã€‚
    </p>
    <h6>
     <a id="_1084">
     </a>
     äº¤æ¢
    </h6>
    <p>
     <code>
      swap
     </code>
     å‡½æ•°ç”¨äºäº¤æ¢ä¸¤ä¸ª
     <code>
      std::weak_ptr
     </code>
     çš„å†…å®¹ï¼Œå¹¶ä¸ä¼šå½±å“å¼•ç”¨è®¡æ•°ã€‚
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span>__weak_ptr<span class="token operator">&amp;</span> __s<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span><span class="token function">swap</span><span class="token punctuation">(</span>_M_ptr<span class="token punctuation">,</span> __s<span class="token punctuation">.</span>_M_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _M_refcount<span class="token punctuation">.</span><span class="token function">_M_swap</span><span class="token punctuation">(</span>__s<span class="token punctuation">.</span>_M_refcount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     è°ƒç”¨æ ‡å‡†åº“ä¸­çš„
     <code>
      swap
     </code>
     å‡½æ•°äº¤æ¢åº•å±‚æ•°æ®æŒ‡é’ˆï¼Œç„¶åå†è°ƒç”¨
     <code>
      _M_swap
     </code>
     å‡½æ•°äº¤æ¢å¼•ç”¨è®¡æ•°å™¨ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">_M_swap</span><span class="token punctuation">(</span>__weak_count<span class="token operator">&amp;</span> __r<span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
    _Sp_counted_base<span class="token operator">&lt;</span>_Lp<span class="token operator">&gt;</span><span class="token operator">*</span> __tmp <span class="token operator">=</span> __r<span class="token punctuation">.</span>_M_pi<span class="token punctuation">;</span>
    __r<span class="token punctuation">.</span>_M_pi <span class="token operator">=</span> _M_pi<span class="token punctuation">;</span>
    _M_pi <span class="token operator">=</span> __tmp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="_1107">
     </a>
     è·å–å¼•ç”¨è®¡æ•°
    </h6>
    <p>
     <code>
      use_count
     </code>
     å‡½æ•°è¿”å›
     <code>
      std::weak_ptr
     </code>
     æ‰€å¼•ç”¨çš„å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œè¡¨ç¤ºæœ‰å¤šå°‘ä¸ª
     <code>
      std::shared_ptr
     </code>
     å…±äº«è¯¥å¯¹è±¡ï¼Œå¦‚æœå¯¹è±¡å·²ç»è¢«é”€æ¯ï¼Œè¿”å›0ã€‚
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">long</span> <span class="token function">use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">return</span> _M_refcount<span class="token punctuation">.</span><span class="token function">_M_get_use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
    <p>
     åœ¨
     <code>
      _M_get_use_count
     </code>
     å‡½æ•°ä¸­åˆ¤æ–­
     <code>
      _M_pi
     </code>
     æ˜¯å¦ä¸º
     <code>
      nullptr
     </code>
     å¦‚æœä¸ºç©ºåˆ™è¡¨ç¤ºæ²¡æœ‰ç®¡ç†ä»»ä½•èµ„æºç›´æ¥è¿”å› 0ï¼›å¦åˆ™è°ƒç”¨
     <code>
      _M_get_use_count
     </code>
     å‡½æ•°è·å–å¼•ç”¨è®¡æ•°å™¨çš„å€¼ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">long</span> <span class="token function">_M_get_use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">return</span> _M_pi <span class="token operator">!=</span> <span class="token keyword">nullptr</span> <span class="token operator">?</span> _M_pi<span class="token operator">-&gt;</span><span class="token function">_M_get_use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
    <p>
     é€šè¿‡åŸå­æ“ä½œè·å–å…³è”çš„å¼ºå¼•ç”¨è®¡æ•°å™¨çš„å€¼ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">long</span> <span class="token function">_M_get_use_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">__atomic_load_n</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_M_use_count<span class="token punctuation">,</span> __ATOMIC_RELAXED<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     å…¶ä¸­ï¼Œ
     <code>
      __ATOMIC_RELAXED
     </code>
     æ˜¯æœ€å¼±çš„å†…å­˜é¡ºåºæ¨¡å‹ï¼Œä»…ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œä¸æä¾›ä»»ä½•å†…å­˜é¡ºåºä¿è¯ã€‚
    </p>
    <p>
     ğŸŒºğŸŒºğŸŒºæ’’èŠ±ï¼
    </p>
    <p>
     å¦‚æœæœ¬æ–‡å¯¹ä½ æœ‰å¸®åŠ©ï¼Œå°±ç‚¹å…³æ³¨æˆ–è€…ç•™ä¸ªğŸ‘
     <br/>
     å¦‚æœæ‚¨æœ‰ä»»ä½•æŠ€æœ¯é—®é¢˜æˆ–è€…éœ€è¦æ›´å¤šå…¶ä»–çš„å†…å®¹ï¼Œè¯·éšæ—¶å‘æˆ‘æé—®ã€‚
    </p>
    <p>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/3734a0d4d24847a6ad83ea7ad3b1a2c6.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f34363238373931382f:61727469636c652f64657461696c732f313436333030303331" class_="artid" style="display:none">
 </p>
</div>


