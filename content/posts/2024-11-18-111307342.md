---
arturl_encode: "68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34343837343634352f:61727469636c652f64657461696c732f313131333037333432"
layout: post
title: "Web安全笔记之2.0-计算机网络与协议"
date: 2024-11-18 22:05:05 +08:00
description: "2.0 计算机网络与协议2.1 网络基础计算机通信网的组成计算机网络由通信子网和资源子网组成。其中通"
keywords: "mkcol 409"
categories: ['Web']
tags: ['无标签']
artid: "111307342"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=111307342
    alt: "Web安全笔记之2.0-计算机网络与协议"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=111307342
featuredImagePreview: https://bing.ee123.net/img/rand?artid=111307342
---

# 【Web安全笔记】之【2.0 计算机网络与协议】

#### 文章目录

* [2.0 计算机网络与协议](#20__1)
* + [2.1 网络基础](#21__3)
  + - * [2.1.1 计算机通信网的组成](#211__5)
      * [2.1.2 通信协议](#212__15)
      * [2.1.3 OSI七层模型](#213_OSI_25)
      * + [简介](#_27)
        + [1. 物理层](#1__31)
        + [2. 数据链路层](#2__37)
        + [3. 网络层](#3__45)
        + [4. 传输层](#4__52)
        + [5. 会话层](#5__58)
        + [6. 表示层](#6__64)
        + [7. 应用层](#7__72)
        + [总结](#_76)
  + [2.2 UDP 协议](#22_UDP__84)
  + - [主要特点](#_86)
  + [2.3 TCP 协议](#23_TCP__95)
  + - [2.3.1 简介](#231__97)
    - [2.3.2 TCP 状态](#232_TCP__101)
    - [2.3.3 三次握手](#233__105)
    - [2.3.4 四次挥手](#234__115)
    - [2.3.5 拥塞控制](#235__127)
    - [2.3.6 参考链接](#236__133)
  + [2.4 DHCP协议](#24_DHCP_141)
  + - [2.4.1 简介](#241__143)
    - [2.4.2 DCHP 报文格式](#242_DCHP__149)
  + [2.5 路由算法](#25__178)
  + - [2.5.1 简介](#251__180)
    - [2.5.2 路由选择算法的功能](#252__184)
    - [2.5.3 自治系统 AS (Autonomous System)](#253__AS_Autonomous_System_197)
    - [2.5.4 两大类路由选择协议](#254__207)
    - * [1. RIP](#1_RIP_213)
      * [2. OSPF](#2_OSPF_217)
  + [2.6 域名系统](#26__221)
  + - [2.6.1 简介](#261__223)
    - [2.6.2 术语](#262__227)
    - * [1. mDNS](#1_mDNS_229)
      * [2. FQDN](#2_FQDN_237)
      * [3. TLD](#3_TLD_241)
      * [4. IDN](#4_IDN_247)
      * [5. CNAME](#5_CNAME_251)
      * [6. TTL](#6_TTL_255)
    - [2.6.3 请求响应](#263__259)
    - * [1. DNS记录](#1_DNS_261)
      * [2. 响应码](#2__277)
    - [2.6.4 域名系统工作原理](#264__321)
    - * [1. 解析过程](#1__323)
      * [2. 域传送](#2__336)
    - [2.6.5 服务器类型](#265__340)
    - * [1. 根服务器](#1__342)
      * [2. 权威服务器](#2__350)
      * [3. 递归服务器](#3__356)
    - [2.6.6 DNS利用](#266_DNS_360)
    - * [1. DGA](#1_DGA_362)
      * [2. DNS隧道](#2_DNS_370)
      * [3. 加密方案](#3__374)
      * [4. DoT](#4_DoT_378)
      * [5. DNS-over-DTLS](#5_DNSoverDTLS_382)
      * [6. DoH](#6_DoH_386)
      * [7. DNS-over-QUIC](#7_DNSoverQUIC_390)
      * [8. DNSCrypt](#8_DNSCrypt_394)
    - [2.6.7 参考链接](#267__398)
    - * [1. RFC](#1_RFC_400)
    - [2.6.8 工具](#268__425)
    - [2.6.9 研究文章](#269__430)
    - [2.6.10 相关CVE](#2610_CVE_437)
  + [2.7 HTTP协议簇](#27_HTTP_441)
  + - [2.7.1 HTTP标准](#271_HTTP_443)
    - * [1. 报文格式](#1__445)
      * + [1). 请求报文格式](#1__447)
        + [2). 响应报文格式](#2__456)
      * [2. 字段解释](#2__465)
      * + [1). method](#1_method_467)
        + [2). version](#2_version_473)
        + [3). url](#3_url_478)
      * [3. 请求头列表](#3__482)
      * + [1). Accept](#1_Accept_484)
        + [2). Accept-Charset](#2_AcceptCharset_489)
        + [3). Accept-Encoding](#3_AcceptEncoding_494)
        + [4). Accept-Language](#4_AcceptLanguage_499)
        + [5). Accept-Ranges](#5_AcceptRanges_504)
        + [6). Authorization](#6_Authorization_509)
        + [7). Cache-Control](#7_CacheControl_514)
        + [8). Connection](#8_Connection_519)
        + [9). Cookie](#9_Cookie_524)
        + [10). Content-Length](#10_ContentLength_529)
        + [11). Content-Type](#11_ContentType_534)
        + [12). Date](#12_Date_539)
        + [13). Expect](#13_Expect_544)
        + [14). From](#14_From_549)
        + [15). Host](#15_Host_554)
        + [16). If-Match](#16_IfMatch_559)
        + [17). If-Modified-Since](#17_IfModifiedSince_564)
        + [18). If-None-Match](#18_IfNoneMatch_569)
        + [19). If-Range](#19_IfRange_574)
        + [20). If-Unmodified-Since](#20_IfUnmodifiedSince_579)
        + [21). Max-Forwards](#21_MaxForwards_584)
        + [22). Pragma](#22_Pragma_589)
        + [23). Proxy-Authorization](#23_ProxyAuthorization_594)
        + [24). Range](#24_Range_599)
        + [25). Referer](#25_Referer_604)
        + [26). TE](#26_TE_609)
        + [27). Upgrade](#27_Upgrade_614)
        + [28). User-Agent](#28_UserAgent_619)
        + [29). Via](#29_Via_624)
        + [30). Warning](#30_Warning_629)
      * [4. 响应头列表](#4__634)
      * + [1). Accept-Ranges](#1_AcceptRanges_636)
        + [2). Access-Control-Allow-Origin](#2_AccessControlAllowOrigin_641)
        + [3). Age](#3_Age_646)
        + [4). Allow](#4_Allow_651)
        + [5). Cache-Control](#5_CacheControl_656)
        + [6). Content-Encoding](#6_ContentEncoding_661)
        + [7). Content-Language](#7_ContentLanguage_666)
        + [8). Content-Length](#8_ContentLength_671)
        + [9). Content-Location](#9_ContentLocation_676)
        + [10). Content-MD5](#10_ContentMD5_681)
        + [11). Content-Range](#11_ContentRange_686)
        + [12). Content-Type](#12_ContentType_691)
        + [13). Date](#13_Date_696)
        + [14). ETag](#14_ETag_701)
        + [15). Expires](#15_Expires_706)
        + [16). Last-Modified](#16_LastModified_711)
        + [17). Location](#17_Location_716)
        + [18). Pragma](#18_Pragma_721)
        + [19). Proxy-Authenticate](#19_ProxyAuthenticate_726)
        + [20). Refresh](#20_Refresh_731)
        + [21). Retry-After](#21_RetryAfter_736)
        + [22). Server](#22_Server_741)
        + [23). Set-Cookie](#23_SetCookie_746)
        + [24). Strict-Transport-Security](#24_StrictTransportSecurity_751)
        + [25). Trailer](#25_Trailer_758)
        + [26). Transfer-Encoding](#26_TransferEncoding_763)
        + [27). Vary](#27_Vary_768)
        + [28). Via](#28_Via_773)
        + [29). Warning](#29_Warning_778)
        + [30). WWW-Authenticate](#30_WWWAuthenticate_783)
        + [31). X-Content-Type-Options](#31_XContentTypeOptions_788)
        + [32). X-Frame-Options](#32_XFrameOptions_793)
        + [33). X-XSS-Protection](#33_XXSSProtection_798)
      * [5. HTTP状态返回代码](#5_HTTP_803)
      * + [1xx（临时响应）](#1xx_805)
        + [2xx （成功）](#2xx__814)
        + [3xx （重定向）](#3xx__828)
        + [4xx（请求错误）](#4xx_842)
        + [5xx（服务器错误）](#5xx_866)
    - [2.7.2 HTTP 版本](#272_HTTP__879)
    - * [1. HTTP](#1_HTTP_881)
      * + [1). HTTP 0.9](#1_HTTP_09_885)
        + [2). HTTP 1.0](#2_HTTP_10_889)
        + [3). HTTP 1.1](#3_HTTP_11_897)
        + [4). SPDY](#4_SPDY_903)
        + [5). HTTP/2](#5_HTTP2_907)
      * [2. HTTPS](#2_HTTPS_911)
      * + [1). 简介](#1__913)
        + [2). 交互](#2__917)
        + - [证书验证阶段](#_919)
          - [数据传输阶段](#_933)
    - [2.7.3 CA](#273_CA_940)
    - [2.7.4 Cookie](#274_Cookie_944)
    - * [1. 简介](#1__946)
      * [2. 属性](#2__950)
      * + [1). name](#1_name_952)
        + [2). value](#2_value_956)
        + [3). expires](#3_expires_960)
        + [4). max-age](#4_maxage_964)
        + [5). domain](#5_domain_968)
        + [6). path](#6_path_972)
        + [7). secure](#7_secure_976)
        + [8). httponly](#8_httponly_980)
        + [9). SameSite](#9_SameSite_984)
    - [2.7.5 WebDAV](#275_WebDAV_988)
    - * [1. 简介](#1__990)
      * [2. 支持的方法](#2__994)
    - [2.7.6 相关CVE](#276_CVE_1020)
    - * [1. CVE-2015-1833](#1_CVE20151833_1022)
      * [2. CVE-2015-7326](#2_CVE20157326_1027)
    - [2.7.7 参考链接](#277__1032)
    - * [1. RFC](#1_RFC_1034)
      * [2. Blog](#2_Blog_1044)
  + [2.8 邮件协议族](#28__1050)
  + - [2.8.1 简介](#281__1052)
    - * [1. SMTP](#1_SMTP_1054)
      * [2. POP3](#2_POP3_1058)
      * [3. IMAP](#3_IMAP_1062)
    - [2.8.2 防护策略](#282__1066)
    - * [1. SPF](#1_SPF_1068)
      * [2. DKIM](#2_DKIM_1072)
      * [3. DMARC](#3_DMARC_1076)
    - [2.8.3 参考链接](#283__1080)
    - * [1. RFC](#1_RFC_1082)
    - [2. 8.4 相关文档](#2_84__1093)
    - [2.8.5 研究文章](#285__1099)
  + [2.9 SSL/TLS](#29_SSLTLS_1103)
  + - [2.9.1 简介](#291__1105)
    - [2.9.2 协议](#292__1137)
    - * [1. 记录协议](#1__1141)
      * [2. 警报协议](#2__1145)
      * [3. 握手协议](#3__1149)
      * [4. 变更密码规范协议](#4__1153)
    - [2.9.3 交互过程](#293__1157)
    - * [1. Client Hello](#1_Client_Hello_1159)
      * [2. Server Hello](#2_Server_Hello_1163)
      * [3. Certificate](#3_Certificate_1167)
      * [4. Server Key Exchange](#4_Server_Key_Exchange_1171)
      * [5. Server Hello Done](#5_Server_Hello_Done_1175)
      * [6. Client Key Exchange](#6_Client_Key_Exchange_1179)
      * [7. Change Cipher Spec](#7_Change_Cipher_Spec_1183)
      * [8. Encrypted Handshake Message](#8_Encrypted_Handshake_Message_1187)
      * [9. New Session Ticket](#9_New_Session_Ticket_1191)
      * [10. Application Data](#10_Application_Data_1195)
      * [11. Encrypted Alert](#11_Encrypted_Alert_1199)
    - [2.9.4 版本更新内容](#294__1203)
    - * [TLS 1.3](#TLS_13_1205)
    - [2.9.5 子协议](#295__1220)
    - * [1. Handshake 协议](#1_Handshake__1224)
      * [2. ChangeCipherSpec 协议](#2_ChangeCipherSpec__1228)
      * [3. Alert 协议](#3_Alert__1232)
      * [4. Record 协议](#4_Record__1236)
    - [2.9.6 参考链接](#296__1240)
    - * [1. RFC](#1_RFC_1242)
      * [2. Document](#2_Document_1252)
  + [2.10 IPsec](#210_IPsec_1256)
  + - [2.10.1 简介](#2101__1258)
    - * [1. 数据机密性（Confidentiality）](#1_Confidentiality_1262)
      * [2. 数据完整性（Data Integrity）](#2_Data_Integrity_1266)
      * [3. 数据来源认证（Data Authentication）](#3_Data_Authentication_1270)
      * [4. 防重放（Anti-Replay）](#4_AntiReplay_1274)
    - [2.10.2 优点](#2102__1278)
    - [2.10.3 构成](#2103__1286)
    - * [1. 安全联盟（Security Association，SA）](#1_Security_AssociationSA_1295)
      * [2. IKE](#2_IKE_1307)
  + [2.11 Wi-Fi](#211_WiFi_1315)
  + - [2.11.1 简介](#2111__1317)
    - [2.11.2 攻击](#2112__1321)
    - * [1. 暴力破解](#1__1323)
      * [2. 伪造热点](#2__1327)
      * [3. 秘钥重装攻击](#3__1331)
      * [4. Dragonblood](#4_Dragonblood_1335)
    - [2.11.3 参考链接](#2113__1339)

## 2.0 计算机网络与协议

### 2.1 网络基础

##### 2.1.1 计算机通信网的组成

计算机网络由
**通信子网和资源子网**
组成。

其中通信子网负责数据的无差错和有序传递，其处理功能包括差错控制、流量控制、路由选择、网络互连等。

其中资源子网是计算机通信的本地系统环境，包括主机、终端和应用程序等， 资源子网的主要功能是用户资源配置、数据的处理和管理、软件和硬件共享以及负载均衡等。

总的来说，计算机通信网就是一个
**由通信子网承载的、传输和共享资源子网的各类信息的系统**
。

##### 2.1.2 通信协议

为了完成计算机之间有序的信息交换，提出了通信协议的概念，其定义是相互通信的双方（或多方）对如何进行信息交换所必须遵守的一整套规则。

协议涉及到三个要素，分别为：

* **语法**
  ：语法是用户数据与控制信息的结构与格式，以及数据出现顺序的意义
* **语义**
  ：用于解释比特流的每一部分的意义
* **时序**
  ：事件实现顺序的详细说明

##### 2.1.3 OSI七层模型

###### 简介

OSI（Open System Interconnection）共分为
**物理层、数据链路层、网络层、传输层、会话层、表示层、应用层**
七层，其具体的功能如下。

###### 1. 物理层

* 提供建立、维护和释放物理链路所需的机械、电气功能和规程等特性
* 通过传输介质进行数据流(比特流)的物理传输、故障监测和物理层管理
* 从数据链路层接收帧，将比特流转换成底层物理介质上的
  **信号**

###### 2. 数据链路层

* 在物理链路的两端之间传输数据
* 在网络层实体间提供数据传输功能和控制
* 提供数据的流量控制
* 检测和纠正物理链路产生的差错
* 格式化的消息称为
  **帧**

###### 3. 网络层

* 负责端到端的数据的路由或交换，为透明地传输数据建立连接
* 寻址并解决与数据在异构网络间传输相关的所有问题
* 使用上面的传输层和下面的数据链路层的功能
* 格式化的消息称为
  **分组**

###### 4. 传输层

* 提供无差错的数据传输
* 接收来自会话层的数据，如果需要，将数据分割成更小的分组，向网络层传送分组并确保分组完整和正确到达它们的目的地
* 在系统之间提供可靠的透明的数据传输,提供端到端的错误恢复和流量控制

###### 5. 会话层

* 提供节点之间通信过程的协调
* 负责执行会话规则（如：连接是否允许半双工或全双工通信）、同步数据流以及当故障发生时重新建立连接
* 使用上面的表示层和下面的传输层的功能

###### 6. 表示层

* 提供数据格式、变换和编码转换
* 涉及正在传输数据的语法和语义
* 将消息以合适电子传输的格式编码
* 执行该层的数据压缩和加密
* 从应用层接收消息，转换格式，并传送到会话层，该层常合并在应用层中

###### 7. 应用层

* 包括各种协议，它们定义了具体的面向用户的应用：如电子邮件、文件传输等

###### 总结

**低三层**
模型属于
**通信子网**
，涉及为用户间提供透明连接，操作主要以每条链路（ hop-by-hop）为基础，在节点间的各条数据链路上进行通信。由网络层来控制各条链路上的通信，但要依赖于其他节点的协调操作。

**高三层**
属于
**资源子网**
，主要涉及保证信息以正确可理解形式传送。

传输层是高三层和低三层之间的接口，它是第一个端到端的层次，保证透明的端到端连接，满足用户的服务质量（QoS）要求，并向高三层提供合适的信息形式。

### 2.2 UDP 协议

#### 主要特点

* 协议开销小、效率高。
* UDP是无连接的，即发送数据之前不需要建立连接。
* UDP使用尽最大努力交付，即不保证可靠交付。
* UDP没有拥塞控制。
* UDP支持一对一、一对多、多对一和多对多交互通信。
* UDP的首部开销小，只有8个字节。

### 2.3 TCP 协议

#### 2.3.1 简介

TCP（Transmission Control Protocol，传输控制协议）是一种面向连接的、可靠的、基于字节流的传输层通信协议，由RFC 793定义。

#### 2.3.2 TCP 状态

[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-X9wPuLqX-1608624928978)(./imag/tcp-state-transition-diagram.gif)]

#### 2.3.3 三次握手

三次握手（Three-Way Handshake）是指建立一个TCP连接时，需要客户端和服务端总共发送3个包以确认连接的建立。

第一次握手客户端将标志位 SYN 置为1，随机产生一个值 seq=s ，并将该数据包发送给服务端，客户端进入 SYN\_SENT 状态，等待服务端确认。

第二次握手服务端收到数据包后由标志位 SYN=1 知道客户端请求建立连接，服务端将标志位 SYN 和 ACK 都置为1，ack=s+1，随机产生一个值 seq=k ，并将该数据包发送给客户端以确认连接请求，服务端进入 SYN\_RCVD 状态。

第三次握手客户端收到确认后，检查ack值是否为s+1，ACK标志位是否为1，如果正确则将标志位 ACK 置为1，ack=k+1，并将该数据包发送给服务端，服务端检查ack值是否为k+1，ACK标志位是否为1，如果正确则连接建立成功，客户端和服务端进入 ESTABLISHED 状态，完成三次握手。

#### 2.3.4 四次挥手

四次挥手（Four-Way Wavehand）指断开一个TCP连接时，需要客户端和服务端总共发送4个包以确认连接的断开。

第一次挥手客户端发送一个 FIN ，用来关闭客户端到服务端的数据传送，客户端进入 FIN\_WAIT\_1 状态。

第二次挥手服务端收到 FIN 后，发送一个 ACK 给客户端，确认序号为收到序号+1，服务端进入 CLOSE\_WAIT 状态。

第三次挥手服务端发送一个 FIN ，用来关闭服务端到客户端的数据传送，服务端进入 LAST\_ACK 状态。

第四次挥手客户端收到 FIN 后，客户端进入 TIME\_WAIT 状态，接着发送一个 ACK 给服务端，确认序号为收到序号+1，服务端进入 CLOSED 状态，完成四次挥手。

#### 2.3.5 拥塞控制

拥塞是指网络中报文数量过多，使得服务端来不及处理，以致引起这部分乃至整个网络性能下降的现象，严重时甚至会导致网络通信业务陷入停顿即出现死锁现象。

TCP采用拥塞控制算法来减少或者避免拥塞现象的发生，TCP的拥塞算法有过多种实现，包括Tahoe、Reno、NewReno、Vegas、Hybla、BIC 、CUBIC、SACK、Westwood、PRR、BBR等。

#### 2.3.6 参考链接

* [RFC 793 TRANSMISSION CONTROL PROTOCOL](https://tools.ietf.org/html/rfc793)
* [RFC 2001 TCP Slow Start, Congestion Avoidance, Fast Retransmit, and Fast Recovery Algorithms](https://tools.ietf.org/html/rfc2001)
* [RFC 3390 Increasing TCP’s Initial Window](https://tools.ietf.org/html/rfc3390)
* [RFC 5681 TCP Congestion Control](https://tools.ietf.org/html/rfc5681)
* [TCP congestion control wiki](https://en.wikipedia.org/wiki/TCP_congestion_control)

### 2.4 DHCP协议

#### 2.4.1 简介

动态主机配置协议 (Dynamic Host Configuration Protocol，DHCP) 是一个用于局域网的网络协议，位于OSI模型的应用层，使用UDP协议工作，主要用于自动分配IP地址给用户，方便管理员进行统一管理。

DHCP服务器端使用67/udp，客户端使用68/udp。DHCP运行分为四个基本过程，分别为请求IP租约、提供IP租约、选择IP租约和确认IP租约。客户端在获得了一个IP地址以后，就可以发送一个ARP请求来避免由于DHCP服务器地址池重叠而引发的IP冲突。

#### 2.4.2 DCHP 报文格式

```txt
0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+
|     op (1)    |   htype (1)   |   hlen (1)    |   hops (1)    |
+---------------+---------------+---------------+---------------+
|                            xid (4)                            |
+-------------------------------+-------------------------------+
|           secs (2)            |           flags (2)           |
+-------------------------------+-------------------------------+
|                          ciaddr  (4)                          |
+---------------------------------------------------------------+
|                          yiaddr  (4)                          |
+---------------------------------------------------------------+
|                          siaddr  (4)                          |
+---------------------------------------------------------------+
|                          giaddr  (4)                          |
+---------------------------------------------------------------+
|                          chaddr  (16)                         |
+---------------------------------------------------------------+
|                          sname   (64)                         |
+---------------------------------------------------------------+
|                          file    (128)                        |
+---------------------------------------------------------------+
|                          options (variable)                   |
+---------------------------------------------------------------+

```

### 2.5 路由算法

#### 2.5.1 简介

路由算法是用于
**找到一条从源路由器到目的路由器的最佳路径的算法**
。存在着多种路由算法，每种算法对网络和路由器资源的影响都不同；由于路由算法使用多种度量标准 (metric)，所以不同路由算法的最佳路径选择也有所不同。

#### 2.5.2 路由选择算法的功能

源/宿对之间的路径选择，以及选定路由之后将报文传送到它们的目的地。

路由选择算法的要求：

* 正确性：确保分组从源节点传送到目的节点
* 简单性：实现方便，软硬件开销小
* 自适应性：也称健壮性，算法能够适应业务量和网络拓扑的变化
* 稳定性：能长时间无故障运行
* 公平性：每个节点都有机会传送信息
* 最优性：尽量选取好的路由

#### 2.5.3 自治系统 AS (Autonomous System)

经典定义：

* 由一个组织管理的一整套路由器和网络。
* 使用一种AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由。
* 使用一种 AS 之间的路由选择协议用以确定分组在AS之间的路由。

尽管一个 AS 使用了多种内部路由选择协议和度量，但对其他 AS 表现出的是一个单一的和一致的路由选择策略。

#### 2.5.4 两大类路由选择协议

因特网的中，路由协议可以分为
**内部网关协议 IGP**
(Interior Gateway Protocol)和
**外部网关协议 EGP**
(External Gateway Protocol)。

IGP是在一个AS内部使用的路由选择协议，如RIP和OSPF协议，是域内路由选择 (interdomain routing)。当源主机和目的主机处在不同的AS中，在数据报到达AS的边界时，使用外部网关协议 EGP 将路由选择信息传递到另一个自治系统中，如BGP-4，是域间路由选择 (intradomain routing)。

##### 1. RIP

**路由信息协议**
(Routing Information Protocol, RIP) 是一种基于距离 向量的路由选择协议。RIP 协议要求网络中的每一个路由器都要维护从它自己到自治系统内其他每一个目的网络的距离和下一跳路由器地址。

##### 2. OSPF

**开放最短路径优先**
(Open Shortest Path First，OSPF)，这个算法名为“最短路径优先”是因为使用了 Dijkstra 提出的最短路径算法SPF，只是一个协议的名字，它并不表示其他的路由选择协议不是“最短路径优先”。

### 2.6 域名系统

#### 2.6.1 简介

DNS是一个简单的请求-响应协议，是将域名和IP地址相互映射的一个分布式数据库，能够使人更方便地访问互联网。
**DNS使用TCP和UDP协议的53端口**
。

#### 2.6.2 术语

##### 1. mDNS

Multicast DNS (mDNS)，
**多播DNS**
，使用
**5353**
端口，组播地址为
`224.0.0.251`
或
`[FF02::FB]`
。在一个
**没有常规DNS服务器的小型网络内**
可以使用mDNS来实现类似DNS的编程接口、包格式和操作语义。mDNS协议的报文与DNS的报文结构相同，但有些字段对于mDNS来说有新的含义。

启动mDNS的主机会在进入局域网后向所有主机组播消息，包含主机名、IP等信息，其他拥有相应服务的主机也会响应含有主机名和IP的信息。

mDNS的域名是用
`.local`
和普通域名区分开的。

##### 2. FQDN

FQDN (Fully-Qualified Domain Name) 是
**域名的完全形态**
，主要是包含零长度的根标签，例如
`www.example.com.`
。

##### 3. TLD

Top-Level Domain (TLD) 是
**属于根域的一个域**
，例如
`com`
或
`jp`
。

TLD一般可以分为 Country Code Top-Level Domains (ccTLDs) 、Generic Top-Level Domains (gTLDs) 以及其它。

##### 4. IDN

IDN一般指国际化域名。国际化域名 英文全称是 Internationalized Domain Names ，英文简称 IDN,也叫多语种域名，是指非英语国家为推广本国语言的域名系统的一个总称。

##### 5. CNAME

**CNAME即Canonical name，又称alias，将域名指向另一个域名**
。

##### 6. TTL

**Time To Live**
，无符号整数，
**记录DNS记录过期的时间**
，最小是0，最大是2147483647 (2
31
- 1)。

#### 2.6.3 请求响应

##### 1. DNS记录

* **A记录**

  + **返回域名对应的IPv4地址**
* **NS记录**

  + 域名服务器
  + **返回该域名由哪台域名服务器解析**
* **PTR记录**

  + 反向记录
  + **从IP地址到域名的记录**
* **MX记录**

  + 电子邮件交换记录
  + **记录邮件域名对应的IP地址**

##### 2. 响应码

* NOERROR

```
No error condition

```

* FORMERR

```
Format error - The name server was unable to interpret the query

```

* SERVFAIL

```
Server failure - The name server was unable to process this query due to a problem with the name server

```

* NXDOMAIN

```
this code signifies that the domain name referenced in the query does not exist

```

* NOTIMP

```
Not Implemented - The name server does not support the requested kind of query

```

* REFUSED

```
Refused - The name server refuses to perform the specified operation for policy reasons

```

* NODATA

```
A pseudo RCODE which indicates that the name is valid, for the given class, but [there] are no records of the given type A NODATA response has to be inferred from the answer.

```

#### 2.6.4 域名系统工作原理

##### 1. 解析过程

DNS解析过程是
**递归查询**
的，具体过程如下：

* 用户要访问域名www.example.com时，
  **先查看本机hosts**
  是否有记录或者本机是否有DNS缓存，如果有，直接返回结果，否则
  **向递归服务器查询**
  该域名的IP地址
* 递归缓存为空时，首
  **先向根服务器查询**
  com顶级域的IP地址
* 根服务器告知递归服务器com顶级域名服务器的IP地址
* 递归
  **向com顶级域名服务器查询**
  负责example.com的权威服务器的IP
* com顶级域名服务器返回相应的IP地址
* 递归
  **向example.com的权威服务器查询**
  www.example.com的地址记录
* 权威服务器告知www.example.com的地址记录
* 递归服务器将查询结果返回客户端

##### 2. 域传送

DNS服务器可以分为
**主服务器、备份服务器和缓存服务器**
。域传送是指备份服务器从主服务器拷贝数据，并使用得到的数据更新自身数据库。
**域传送是在主备服务器之间同步数据库的机制**
。

#### 2.6.5 服务器类型

##### 1. 根服务器

根服务器是DNS的核心，
**负责互联网顶级域名的解析**
，用于维护域的权威信息，并将DNS查询引导到相应的域名服务器。

根服务器在域名树中代表最顶级的
`.`
域， 一般省略。

13台IPv4根服务器的域名标号为a到m，即a.root-servers.org到m.root-servers.org，所有服务器存储的数据相同，仅包含ICANN批准的TLD域名权威信息。

##### 2. 权威服务器

**权威服务器上存储域名Zone文件，维护域内域名的权威信息**
，递归服务器可以从权威服务器获得DNS查询的资源记录。

权威服务器需要在所承载的域名所属的TLD管理局注册，同一个权威服务器可以承载不同TLD域名，同一个域也可以有多个权威服务器。

##### 3. 递归服务器

递归服务器负责接收用户的查询请求，进行递归查询并响应用户查询请求。在初始时递归服务器仅有记录了根域名的Hint文件。

#### 2.6.6 DNS利用

##### 1. DGA

DGA（Domain Generate Algorithm，
**域名生成算法**
）是一种利用随机字符来生成C&C域名，从而逃避域名黑名单检测的技术手段，常见于botnet中。一般来说，一个DGA域名的存活时间约在1-7天左右。

通信时，客户端和服务端都运行同一套DGA算法，生成相同的备选域名列表，当需要发动攻击的时候，选择其中少量进行注册，便可以建立通信，并且可以对注册的域名应用速变IP技术，快速变换IP，从而域名和IP都可以进行快速变化。

DGA域名有多种生成方式，根据种子类型可以分为确定性和不确定性的生成。不确定性的种子可能会选用当天的一些即时数据，如汇率信息等。

##### 2. DNS隧道

DNS隧道工具将进入隧道的其他协议流量封装到DNS协议内，在隧道上传输。这些数据包出隧道时进行解封装，还原数据。

##### 3. 加密方案

作为主流的防御方案，DNS加密有五种方案，分别是 DNS-over-TLS (DoT)、DNS-over-DTLS、DNS-over-HTTPS (DoH)、DNS-over-QUIC以及DNSCrypt。

##### 4. DoT

DoT方案在2016年发表于RFC7858，使用853端口。主要思想是Client和Server通过TCP协议建立TLS会话后再进行DNS传输，Client通过SSL证书验证服务器身份。

##### 5. DNS-over-DTLS

DNS-over-DTLS和DoT类似，区别在于使用UDP协议而不是TCP协议。

##### 6. DoH

DoH方案在发表RFC8484，使用
`https://dns.example.com/dns-query{?dns}`
来查询服务器的IP，复用https的443端口，流量特征比较小。DoH会对DNS服务器进行加密认证，不提供fallback选项。目前Cloudflare、Google等服务商对DoH提供了支持。

##### 7. DNS-over-QUIC

DNS-over-QUIC安全特性和DoT类似，但是性能更高，目前没有合适的软件实现。

##### 8. DNSCrypt

DNSCrypt使用X25519-XSalsa20Poly1305而非标准的TLS，且DNSCrypt的Client需要额外的软件，Server需要的专门的证书。

#### 2.6.7 参考链接

##### 1. RFC

* [RFC 1034 DOMAIN NAMES CONCEPTS AND FACILITIES](https://tools.ietf.org/html/rfc1034)
* [RFC 1035 DOMAIN NAMES IMPLEMENTATION AND SPECIFICATION](https://tools.ietf.org/html/rfc1035)
* [RFC 1123 Requirements for Internet Hosts – Application and Support](https://tools.ietf.org/html/rfc1123)
* [RFC 2535 Domain Name System Security Extensions](https://tools.ietf.org/html/rfc2535)
* [RFC 2930 Secret Key Establishment for DNS (TKEY RR)](https://tools.ietf.org/html/rfc2930)
* [RFC 2931 DNS Request and Transaction Signatures ( SIG(0)s )](https://tools.ietf.org/html/rfc2931)
* [RFC 3596 Legacy Resolver Compatibility for Delegation Signer (DS)](https://tools.ietf.org/html/rfc3596)
* [RFC 3755 DNS Extensions to Support IP Version 6](https://tools.ietf.org/html/rfc3755)
* [RFC 5001 Automated Updates of DNS Security (DNSSEC) Trust Anchors](https://tools.ietf.org/html/rfc5001)
* [RFC 5936 DNS Zone Transfer Protocol](https://tools.ietf.org/html/rfc5936)
* [RFC 5966 DNS Transport over TCP - Implementation Requirements](https://tools.ietf.org/html/rfc5966)
* [RFC 6376 DomainKeys Identified Mail (DKIM) Signatures](https://tools.ietf.org/html/rfc6376)
* [RFC 6762 Multicast DNS](https://tools.ietf.org/html/rfc6762)
* [RFC 6891 Extension Mechanisms for DNS (EDNS(0))](https://tools.ietf.org/html/rfc6891)
* [RFC 6895 DNS IANA Considerations](https://tools.ietf.org/html/rfc6895)
* [RFC 7766 DNS Transport over TCP - Implementation Requirements](https://tools.ietf.org/html/rfc7766)
* [RFC 7858 Specification for DNS over Transport Layer Security (TLS)](https://tools.ietf.org/html/rfc7858)
* [RFC 8082 NXDOMAIN](https://tools.ietf.org/html/rfc8082)
* [RFC 8482 Providing Minimal-Sized Responses to DNS Queries That Have QTYPE=ANY](https://tools.ietf.org/html/rfc8482)
* [RFC 8484 DNS Queries over HTTPS (DoH)](https://tools.ietf.org/html/rfc8484)
* [RFC 8490 DNS Stateful Operations](https://tools.ietf.org/html/rfc8490)
* [RFC 8499 DNS Terminology](https://tools.ietf.org/html/rfc8499)

#### 2.6.8 工具

* [Unbound](https://github.com/NLnetLabs/unbound)
* [bind9](https://github.com/isc-projects/bind9)

#### 2.6.9 研究文章

* [DGA域名的今生前世：缘起、检测、与发展](https://mp.weixin.qq.com/s/xbf0Qbppk8R0nx89Pb4YTg)
* [DNSSEC原理和分析](https://blog.thecjw.me/?p=1221)
* Plohmann D, Yakdan K, Klatt M, et al. A comprehensive measurement study of domain generating malware[C]//25th {USENIX} Security Symposium ({USENIX} Security 16). 2016: 263-278.
* An End-to-End Large-Scale Measurement of DNS-over-Encryption: How Far Have We Come?

#### 2.6.10 相关CVE

* [SIGRed – Resolving Your Way into Domain Admin: Exploiting a 17 Year-old Bug in Windows DNS Servers](https://research.checkpoint.com/2020/resolving-your-way-into-domain-admin-exploiting-a-17-year-old-bug-in-windows-dns-servers/)

### 2.7 HTTP协议簇

#### 2.7.1 HTTP标准

##### 1. 报文格式

###### 1). 请求报文格式

```http
<method><request-URL><version>
<headers>

<entity-body>

```

###### 2). 响应报文格式

```http
<version><status><reason-phrase>
<headers>

<entity-body>

```

##### 2. 字段解释

###### 1). method

* HTTP动词
* 常见方法：
  **HEAD / GET / POST / PUT / DELETE / PATCH / OPTIONS / TRACE**
* 扩展方法：
  **LOCK / MKCOL / COPY / MOVE**

###### 2). version

* 报文使用的HTTP版本
* 格式为HTTP/.

###### 3). url

`<scheme>://<user>:<password>@<host>:<port>/<path>;<params>?<query>#<frag>`

##### 3. 请求头列表

###### 1). Accept

* 指定客户端能够接收的内容类型
* Accept: text/plain, text/html

###### 2). Accept-Charset

* 浏览器可以接受的字符编码集
* Accept-Charset: iso-8859-5

###### 3). Accept-Encoding

* 指定浏览器可以支持的web服务器返回内容压缩编码类型
* Accept-Encoding: compress, gzip

###### 4). Accept-Language

* 浏览器可接受的语言
* Accept-Language: en,zh

###### 5). Accept-Ranges

* 可以请求网页实体的一个或者多个子范围字段
* Accept-Ranges: bytes

###### 6). Authorization

* HTTP授权的授权证书
* Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==

###### 7). Cache-Control

* 指定请求和响应遵循的缓存机制
* Cache-Control: no-cache

###### 8). Connection

* 表示是否需要持久连接 // HTTP 1.1默认进行持久连接
* Connection: close

###### 9). Cookie

* HTTP请求发送时，会把保存在该请求域名下的所有cookie值一起发送给web服务器
* Cookie: role=admin;ssid=1

###### 10). Content-Length

* 请求的内容长度
* Content-Length: 348

###### 11). Content-Type

* 请求的与实体对应的MIME信息
* Content-Type: application/x-www-form-urlencoded

###### 12). Date

* 请求发送的日期和时间
* Date: Tue, 15 Nov 2010 08:12:31 GMT

###### 13). Expect

* 请求的特定的服务器行为
* Expect: 100-continue

###### 14). From

* 发出请求的用户的Email
* From:
  [user@email.com](mailto:user%40email.com)

###### 15). Host

* 指定请求的服务器的域名和端口号
* Host: www.github.com

###### 16). If-Match

* 只有请求内容与实体相匹配才有效
* If-Match: “737060cd8c284d8af7ad3082f209582d”

###### 17). If-Modified-Since

* 如果请求的部分在指定时间之后被修改则请求成功，未被修改则返回304代码
* If-Modified-Since: Sat, 29 Oct 2018 19:43:31 GMT

###### 18). If-None-Match

* 如果内容未改变返回304代码，参数为服务器先前发送的Etag，与服务器回应的Etag比较判断是否改变
* If-None-Match: “737060cd8c284d8af7ad3082f209582d”

###### 19). If-Range

* 如果实体未改变，服务器发送客户端丢失的部分，否则发送整个实体。参数也为Etag
* If-Range: “737060cd8c284d8af7ad3082f209582d”

###### 20). If-Unmodified-Since

* 只在实体在指定时间之后未被修改才请求成功
* If-Unmodified-Since: Sat, 29 Oct 2010 19:43:31 GMT

###### 21). Max-Forwards

* 限制信息通过代理和网关传送的时间
* Max-Forwards: 10

###### 22). Pragma

* 用来包含实现特定的指令
* Pragma: no-cache

###### 23). Proxy-Authorization

* 连接到代理的授权证书
* Proxy-Authorization: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==

###### 24). Range

* 只请求实体的一部分，指定范围
* Range: bytes=500-999

###### 25). Referer

* 先前网页的地址，当前请求网页紧随其后,即来路
* Referer: http://www.zcmhi.com/archives/71.html

###### 26). TE

* 客户端愿意接受的传输编码，并通知服务器接受接受尾加头信息
* TE: trailers,deflate;q=0.5

###### 27). Upgrade

* 向服务器指定某种传输协议以便服务器进行转换（如果支持）
* Upgrade: HTTP/2.0, SHTTP/1.3, IRC/6.9, RTA/x11

###### 28). User-Agent

* User-Agent的内容包含发出请求的用户信息
* User-Agent: Mozilla/5.0 (Linux; X11)

###### 29). Via

* 通知中间网关或代理服务器地址，通信协议
* Via: 1.0 fred, 1.1 nowhere.com (Apache/1.1)

###### 30). Warning

* 关于消息实体的警告信息
* Warn: 199 Miscellaneous warning

##### 4. 响应头列表

###### 1). Accept-Ranges

* 表明服务器是否支持指定范围请求及哪种类型的分段请求
* Accept-Ranges: bytes

###### 2). Access-Control-Allow-Origin

* 配置有权限访问资源的域
* Access-Control-Allow-Origin: |*

###### 3). Age

* 从原始服务器到代理缓存形成的估算时间（以秒计，非负）
* Age: 12

###### 4). Allow

* 对某网络资源的有效的请求行为，不允许则返回405
* Allow: GET, HEAD

###### 5). Cache-Control

* 告诉所有的缓存机制是否可以缓存及哪种类型
* Cache-Control: no-cache

###### 6). Content-Encoding

* web服务器支持的返回内容压缩编码类型。
* Content-Encoding: gzip

###### 7). Content-Language

* 响应体的语言
* Content-Language: en,zh

###### 8). Content-Length

* 响应体的长度
* Content-Length: 348

###### 9). Content-Location

* 请求资源可替代的备用的另一地址
* Content-Location: /index.htm

###### 10). Content-MD5

* 返回资源的MD5校验值
* Content-MD5: Q2hlY2sgSW50ZWdyaXR5IQ==

###### 11). Content-Range

* 在整个返回体中本部分的字节位置
* Content-Range: bytes 21010-47021/47022

###### 12). Content-Type

* 返回内容的MIME类型
* Content-Type: text/html; charset=utf-8

###### 13). Date

* 原始服务器消息发出的时间
* Date: Tue, 15 Nov 2010 08:12:31 GMT

###### 14). ETag

* 请求变量的实体标签的当前值
* ETag: “737060cd8c284d8af7ad3082f209582d”

###### 15). Expires

* 响应过期的日期和时间
* Expires: Thu, 01 Dec 2010 16:00:00 GMT

###### 16). Last-Modified

* 请求资源的最后修改时间
* Last-Modified: Tue, 15 Nov 2010 12:45:26 GMT

###### 17). Location

* 用来重定向接收方到非请求URL的位置来完成请求或标识新的资源
* Location: http://www.zcmhi.com/archives/94.html

###### 18). Pragma

* 包括实现特定的指令，它可应用到响应链上的任何接收方
* Pragma: no-cache

###### 19). Proxy-Authenticate

* 它指出认证方案和可应用到代理的该URL上的参数
* Proxy-Authenticate: Basic

###### 20). Refresh

* 应用于重定向或一个新的资源被创造，在5秒之后重定向（由网景提出，被大部分浏览器支持）
* Refresh: 5; url=http://www.zcmhi.com/archives/94.html

###### 21). Retry-After

* 如果实体暂时不可取，通知客户端在指定时间之后再次尝试
* Retry-After: 120

###### 22). Server

* web服务器软件名称
* Server: Apache/1.3.27 (Unix) (Red-Hat/Linux)

###### 23). Set-Cookie

* 设置Http Cookie
* Set-Cookie: UserID=JohnDoe; Max-Age=3600; Version=1

###### 24). Strict-Transport-Security

* 设置浏览器强制使用HTTPS访问
* max-age: x秒的时间内 访问对应域名都使用HTTPS请求
* includeSubDomains: 网站的子域名也启用规则
* Strict-Transport-Security: max-age=1000; includeSubDomains

###### 25). Trailer

* 指出头域在分块传输编码的尾部存在
* Trailer: Max-Forwards

###### 26). Transfer-Encoding

* 文件传输编码
* Transfer-Encoding:chunked

###### 27). Vary

* 告诉下游代理是使用缓存响应还是从原始服务器请求
* Vary: *

###### 28). Via

* 告知代理客户端响应是通过哪里发送的
* Via: 1.0 fred, 1.1 nowhere.com (Apache/1.1)

###### 29). Warning

* 警告实体可能存在的问题
* Warning: 199 Miscellaneous warning

###### 30). WWW-Authenticate

* 表明客户端请求实体应该使用的授权方案
* WWW-Authenticate: Basic

###### 31). X-Content-Type-Options

* 配置禁止MIME类型嗅探
* X-Content-Type-Options: nosniff

###### 32). X-Frame-Options

* 配置页面是否能出现在 , , , 等标签中，防止点击劫持
* X-Frame-Options: deny

###### 33). X-XSS-Protection

* 配置XSS防护机制
* X-XSS-Protection: 1; mode=block

##### 5. HTTP状态返回代码

###### 1xx（临时响应）

表示临时响应并需要请求者继续执行操作的状态代码。

| Code | 代码 | 说明 |
| --- | --- | --- |
| 100 | 继续 | 服务器返回此代码表示已收到请求的第一部分，正在等待其余部分 |
| 101 | 切换协议 | 请求者已要求服务器切换协议，服务器已确认并准备切换 |

###### 2xx （成功）

表示成功处理了请求的状态代码。

| Code | 代码 | 说明 |
| --- | --- | --- |
| 200 | 成功 | 服务器已成功处理了请求。 通常，这表示服务器提供了请求的网页 |
| 201 | 已创建 | 请求成功并且服务器创建了新的资源 |
| 202 | 已接受 | 服务器已接受请求，但尚未处理 |
| 203 | 非授权信息 | 服务器已成功处理了请求，但返回的信息可能来自另一来源 |
| 204 | 无内容 | 服务器成功处理了请求，但没有返回任何内容 |
| 205 | 重置内容 | m服务器成功处理了请求，但没有返回任何内容 |
| 206 | 部分内容 | 服务器成功处理了部分GET请求 |

###### 3xx （重定向）

表示要完成请求，需要进一步操作。 通常，这些状态代码用来重定向。

| Code | 代码 | 说明 |
| --- | --- | --- |
| 300 | 多种选择 | 针对请求，服务器可执行多种操作。 服务器可根据请求者 (user agent) 选择一项操作，或提供操作列表供请求者选择。 |
| 301 | 永久移动 | 请求的网页已永久移动到新位置。 服务器返回此响应（对 GET 或 HEAD 请求的响应）时，会自动将请求者转到新位置。 |
| 302 | 临时移动 | 服务器目前从不同位置的网页响应请求，但请求者应继续使用原有位置来进行以后的请求。 |
| 303 | 查看其他位置 | 请求者应当对不同的位置使用单独的 GET 请求来检索响应时，服务器返回此代码。 |
| 304 | 未修改 | 自从上次请求后，请求的网页未修改过。 服务器返回此响应时，不会返回网页内容。 |
| 305 | 使用代理 | 请求者只能使用代理访问请求的网页。如果服务器返回此响应，还表示请求者应使用代理。 |
| 307 | 临时重定向 | 服务器目前从不同位置的网页响应请求，但请求者应继续使用原有位置来进行以后的请求。 |

###### 4xx（请求错误）

这些状态代码表示请求可能出错，妨碍了服务器的处理。

| Code | 代码 | 说明 |
| --- | --- | --- |
| 400 | 错误请求 | 服务器不理解请求的语法。 |
| 401 | 未授权 | 请求要求身份验证。对于需要登录的网页，服务器可能返回此响应。 |
| 403 | 禁止 | 服务器拒绝请求。 |
| 404 | 未找到 | 服务器找不到请求的网页。 |
| 405 | 方法禁用 | 禁用请求中指定的方法。 |
| 406 | 不接受 | 无法使用请求的内容特性响应请求的网页。 |
| 407 | 需要代理授权 | 此状态代码与 401（未授权）类似，但指定请求者应当授权使用代理。 |
| 408 | 请求超时 | 服务器等候请求时发生超时。 |
| 409 | 冲突 | 服务器在完成请求时发生冲突。 服务器必须在响应中包含有关冲突的信息。 |
| 410 | 已删除 | 如果请求的资源已永久删除，服务器就会返回此响应。 |
| 411 | 需要有效长度 | 服务器不接受不含有效内容长度标头字段的请求。 |
| 412 | 未满足前提条件 | 服务器未满足请求者在请求中设置的其中一个前提条件。 |
| 413 | 请求实体过大 | 服务器无法处理请求，因为请求实体过大，超出服务器的处理能力。 |
| 414 | 请求的 URI 过长 | 请求的 URI（通常为网址）过长，服务器无法处理。 |
| 415 | 不支持的媒体类型 | 请求的格式不受请求页面的支持。 |
| 416 | 请求范围不符合要求 | 如果页面无法提供请求的范围，则服务器会返回此状态代码。 |
| 417 | 未满足期望值 | 服务器未满足"期望"请求标头字段的要求。 |

###### 5xx（服务器错误）

这些状态代码表示服务器在尝试处理请求时发生内部错误。 这些错误可能是服务器本身的错误，而不是请求出错。

| Code | 代码 | 说明 |
| --- | --- | --- |
| 500 | 服务器内部错误 | 服务器遇到错误，无法完成请求。 |
| 501 | 尚未实施 | 服务器不具备完成请求的功能。例如，服务器无法识别请求方法时可能会返回此代码。 |
| 502 | 错误网关 | 服务器作为网关或代理，从上游服务器收到无效响应。 |
| 503 | 服务不可用 | 服务器目前无法使用（由于超载或停机维护）。 通常，这只是暂时状态。 |
| 504 | 网关超时 | 服务器作为网关或代理，但是没有及时从上游服务器收到请求。 |
| 505 | HTTP 版本不受支持 | 服务器不支持请求中所用的 HTTP 协议版本。 |

#### 2.7.2 HTTP 版本

##### 1. HTTP

HTTP 是基于 TCP/IP 协议的应用层协议，主要规定了客户端和服务器之间的通信格式，默认使用80端口。

###### 1). HTTP 0.9

HTTP 0.9最早在1991年发布，仅支持GET命令，请求格式只有简单的
`GET /url`
，服务端仅响应HTML，响应完毕后关闭TCP连接。

###### 2). HTTP 1.0

1996年5月，HTTP/1.0 版本发布，丰富了传输的格式和内容，还引入了
**POST、HEAD**
两个动词。
**从1.0开始，必须在尾部添加协议版本**
。在1.0中，也引入了
**状态码**
(status code)、
**多字符集支持**
、
**多部分发送**
(multi-part type)、
**权限**
(authorization)、
**缓存**
(cache)、
**内容编码**
(content encoding)等内容。

HTTP 1.0 版的
**主要缺点是，每个TCP连接只能发送一个请求**
。发送数据完毕，连接就关闭，如果还要请求其他资源，就必须再新建一个连接。

TCP连接的新建成本很高，因为需要客户端和服务器三次握手，并且开始时发送速率较慢(slow start)，所以，HTTP 1.0版本的性能比较差。

###### 3). HTTP 1.1

1997年1月，HTTP/1.1 版本发布，进一步完善了 HTTP 协议。1.1版本主要是引入了
**持久连接、管道机制、Content-Length、分块传输编码等内容**
。管道机制即在同一个TCP连接里面，客户端可以同时发送多个请求，这样就改进了HTTP协议的效率。PUT、PATCH、HEAD、 OPTIONS、DELETE等动词方法也是在HTTP 1.1版本引入的。另外1.1版本新增了Host字段，用于指定服务器的域名，这也是后来虚拟主机得以发展的基础。

虽然1.1版允许复用TCP连接，但是同一个TCP连接里面，所有的数据通信是按次序进行的。服务器只有处理完一个回应，才会进行下一个回应。如果有一个请求很慢，就会阻塞后面的请求。

###### 4). SPDY

2009年，谷歌公开了自行研发的 SPDY 协议，用于解决 HTTP/1.1 效率不高的问题，而后被当做 HTTP/2 的基础。

###### 5). HTTP/2

2015年，HTTP/2 发布，HTTP/2是一个
**二进制协议**
，头信息和数据体都是二进制，统称为帧(frame)，帧分为头信息帧和数据帧。HTTP/2 复用TCP连接，在一个连接里，客户端和浏览器都可以同时发送多个请求或回应，而且不用按照顺序回应。

##### 2. HTTPS

###### 1). 简介

HTTPS (HyperText Transfer Protocol over Secure Socket Layer)可以理解为HTTP+SSL/TLS，
**即 HTTP 下加入 SSL 层**
，HTTPS 的安全基础是 SSL。

###### 2). 交互

###### 证书验证阶段

* 浏览器发起 HTTPS 请求
* 服务端返回 HTTPS 证书

  + 其中证书包含：
    - 颁发机构信息
    - **公钥**
    - 公司信息
    - 域名
    - 有效期
    - 指纹
* 客户端验证证书是否合法，如果不合法则提示告警

###### 数据传输阶段

* 当证书验证合法后，在本地生成随机数
* 通过
  **公钥加密**
  随机数，并把加密后的随机数传输到服务端
* 服务端通过
  **私钥**
  对随机数进行
  **解密**
* 服务端通过客户端传入的随机数构造对称加密算法，对返回结果内容进行加密后传输

#### 2.7.3 CA

CA (Certificate Authority) 是
**颁发数字证书的机构**
。是负责发放和管理数字证书的权威机构，并作为电子商务交易中受信任的第三方，承担公钥体系中公钥的合法性检验的责任。

#### 2.7.4 Cookie

##### 1. 简介

Cookie（复数形态Cookies），类型为「小型文本文件」，指某些网站为了辨别用户身份而储存在用户本地终端上的数据。

##### 2. 属性

###### 1). name

cookie的名称。

###### 2). value

cookie的值。

###### 3). expires

当 Expires 属性缺省时，表示是会话性 Cookie，在用户关闭浏览器时失效。

###### 4). max-age

max-age 可以为正数、负数、0。如果 max-age 属性为正数时，浏览器会将其持久化，当 max-age 属性为负数，则表示该 Cookie 只是一个会话性 Cookie。当 max-age 为 0 时，则会立即删除这个 Cookie。Expires 和 max-age 都存在的条件下，max-age 优先级更高。

###### 5). domain

指定Cookie的域名，默认是当前域名。domain设置时可以设置为自身及其父域，子域可以访问父域的Cookie，反之不能。

###### 6). path

指定一个 URL 路径，这个路径必须出现在要请求的资源的路径中才可以发送对应的 Cookie。

###### 7). secure

只能通过 HTTPS 传输。

###### 8). httponly

限制Cookie仅在HTTP传输过程中被读取，一定程度上防御XSS攻击。

###### 9). SameSite

SameSite 支持 Strict / Lax / None 三种值。Strict最为严格，完全禁止第三方 Cookie，跨站点时，任何情况下都不会发送 Cookie。Lax 允许部分第三方请求携带 Cookie，主要是链接、预加载、GET 表单三种情况。Cookie 的 SameSite 属性为 None ，且设置了 Secure 时，无论是否跨站都会发送 Cookie。

#### 2.7.5 WebDAV

##### 1. 简介

WebDAV （Web-based Distributed Authoring and Versioning）
**一种基于 HTTP 1.1协议的通信协议**
。它扩展了HTTP 1.1，在GET、POST、HEAD等几个HTTP标准方法以外添加了一些新的方法，使应用程序可对Web Server直接读写，并支持写文件锁定、解锁，以及版本控制等功能。

##### 2. 支持的方法

* OPTIONS

  获取服务器的支持
* GET / PUT / POST / DELETE

  资源操作
* TRACE

  跟踪服务器
* HEAD
* MKCOL

  创建集合
* PROPFIND / PROPPATCH
* COPY / MOVE
* LOCK / UNLOCK

#### 2.7.6 相关CVE

##### 1. CVE-2015-1833

* Apache Jacrabbit WebDav XXE
* http://www.securityfocus.com/archive/1/535582

##### 2. CVE-2015-7326

* Milton WebDav XXE
* http://www.securityfocus.com/archive/1/536813

#### 2.7.7 参考链接

##### 1. RFC

* [RFC 3253](https://tools.ietf.org/html/rfc3253)
  Versioning Extensions to WebDAV (Web Distributed Authoring and Versioning)
* [RFC 3648](https://tools.ietf.org/html/rfc3648)
  Web Distributed Authoring and Versioning (WebDAV) Ordered Collections Protocol
* [RFC 3744](https://tools.ietf.org/html/rfc3744)
  Web Distributed Authoring and Versioning (WebDAV) Access Control Protocol
* [RFC 4437](https://tools.ietf.org/html/rfc4437)
  Web Distributed Authoring and Versioning (WebDAV) Redirect Reference Resources
* [RFC 4918](https://tools.ietf.org/html/rfc4918)
  HTTP Extensions for Web Distributed Authoring and Versioning (WebDAV)
* [RFC 5323](https://tools.ietf.org/html/rfc5323)
  Web Distributed Authoring and Versioning (WebDAV) SEARCH
* [RFC 5842](https://tools.ietf.org/html/rfc5842)
  Binding Extensions to Web Distributed Authoring and Versioning (WebDAV)

##### 2. Blog

* [What should a hacker know about WebDav](http://2015.zeronights.org/assets/files/35-Egorov.pdf)
* [Cookie 的 SameSite 属性](http://www.ruanyifeng.com/blog/2019/09/cookie-samesite.html)
* [HTTP 协议入门](http://www.ruanyifeng.com/blog/2016/08/http.html)

### 2.8 邮件协议族

#### 2.8.1 简介

##### 1. SMTP

SMTP (Simple Mail Transfer Protocol) 是一种
**电子邮件传输的协议**
，是一组用于从源地址到目的地址传输邮件的规范。不启用SSL时端口号为
**25**
，启用SSL时端口号多为
**465**
或
**994**
。

##### 2. POP3

POP3 (Post Office Protocol 3) 用于
**支持使用客户端远程管理在服务器上的电子邮件**
。不启用SSL时端口号为
**110**
，启用SSL时端口号多为
**995**
。

##### 3. IMAP

IMAP (Internet Mail Access Protocol)，即
**交互式邮件存取协议**
，它是跟POP3类似邮件访问标准协议之一。不同的是，开启了IMAP后，您在电子邮件客户端收取的邮件仍然保留在服务器上，同时在客户端上的操作都会反馈到服务器上，如：删除邮件，标记已读等，服务器上的邮件也会做相应的动作。不启用SSL时端口号为
**143**
，启用SSL时端口号多为
**993**
。

#### 2.8.2 防护策略

##### 1. SPF

**发件人策略框架**
(Sender Policy Framework, SPF) 是一套电子邮件认证机制，用于确认电子邮件是否由网域授权的邮件服务器寄出，防止有人伪冒身份网络钓鱼或寄出垃圾邮件。SPF允许管理员设定一个DNS TXT记录或SPF记录设定发送邮件服务器的IP范围，如有任何邮件并非从上述指明授权的IP地址寄出，则很可能该邮件并非确实由真正的寄件者寄出。

##### 2. DKIM

**域名密钥识别邮件**
(DomainKeys Identified Mail, DKIM) 是一种检测电子邮件发件人地址伪造的方法。发送方会在邮件的头中插入DKIM-Signature，收件方通过查询DNS记录中的公钥来验证发件人的信息。

##### 3. DMARC

**基于网域的消息认证、报告和一致性**
(Domain-based Message Authentication, Reporting and Conformance, DMARC) 是电子邮件身份验证协议，用于解决在邮件栏中显示的域名和验证的域名不一致的问题。要通过 DMARC 检查，必须通过 SPF 或/和 DKIM 的身份验证，且需要标头地址中的域名必须与经过身份验证的域名一致。

#### 2.8.3 参考链接

##### 1. RFC

* [RFC 4408 Sender Policy Framework (SPF) for Authorizing Use of Domains in E-Mail, Version 1](https://tools.ietf.org/html/rfc4408)
* [RFC 6376 DomainKeys Identified Mail (DKIM) Signatures](https://tools.ietf.org/html/rfc6376)
* [RFC 7208 Sender Policy Framework (SPF) for Authorizing Use of Domains in Email, Version 1](https://tools.ietf.org/html/rfc7208)
* [RFC 7489 Domain-based Message Authentication, Reporting, and Conformance (DMARC)](https://tools.ietf.org/html/rfc7489)
* [RFC 8301 Cryptographic Algorithm and Key Usage Update to DomainKeys Identified Mail (DKIM)](https://tools.ietf.org/html/rfc8301)
* [RFC 8463 A New Cryptographic Signature Method for DomainKeys Identified Mail (DKIM)](https://tools.ietf.org/html/rfc8463)
* [RFC 8616 Email Authentication for Internationalized Mail](https://tools.ietf.org/html/rfc8616)
* [RFC 8611 Mail](https://tools.ietf.org/html/rfc8611)

#### 2. 8.4 相关文档

* [Sender Policy Framework wikipedia](https://en.wikipedia.org/wiki/Sender_Policy_Framework)
* [DomainKeys Identified Mail wikipedia](https://en.wikipedia.org/wiki/DomainKeys_Identified_Mail)
* [DMARC wikipedia](https://en.wikipedia.org/wiki/DMARC)

#### 2.8.5 研究文章

* [Composition Kills:A Case Study of Email Sender Authentication](http://i.blackhat.com/USA-20/Thursday/us-20-Chen-You-Have-No-Idea-Who-Sent-That-Email-18-Attacks-On-Email-Sender-Authentication-wp.pdf)

### 2.9 SSL/TLS

#### 2.9.1 简介

SSL全称是
**Secure Sockets Layer**
，
**安全套接字层**
，它是由网景公司(Netscape)在1994年时设计，主要用于Web的安全传输协议，目的是为网络通信提供机密性、认证性及数据完整性保障。如今，SSL已经成为互联网保密通信的工业标准。

SSL最初的几个版本(SSL 1.0、SSL2.0、SSL 3.0)由网景公司设计和维护，从3.1版本开始，SSL协议由因特网工程任务小组(IETF)正式接管，并更名为TLS(
**Transport Layer Security**
)，发展至今已有TLS 1.0、TLS1.1、TLS1.2、TLS1.3这几个版本。

如TLS名字所说，SSL/TLS协议仅保障传输层安全。同时，由于协议自身特性(数字证书机制)，SSL/TLS不能被用于保护多跳(multi-hop)端到端通信，而只能保护点到点通信。

SSL/TLS协议能够提供的安全目标主要包括如下几个：

* 认证性

  借助数字证书认证服务端端和客户端身份，防止身份伪造
* 机密性

  借助加密防止第三方窃听
* 完整性

  借助消息认证码(MAC)保障数据完整性，防止消息篡改
* 重放保护

  通过使用隐式序列号防止重放攻击

为了实现这些安全目标，SSL/TLS协议被设计为一个两阶段协议，分为
**握手阶段**
和
**应用阶段**
：

握手阶段也称协商阶段，在这一阶段，客户端和服务端端会认证对方身份(依赖于PKI体系，利用数字证书进行身份认证)，并协商通信中使用的安全参数、密码套件以及MasterSecret。后续通信使用的所有密钥都是通过MasterSecret生成。

在握手阶段完成后，进入应用阶段。在应用阶段通信双方使用握手阶段协商好的密钥进行安全通信。

#### 2.9.2 协议

TLS 包含几个子协议，比较常用的有
**记录协议、警报协议、握手协议、变更密码规范协议**
等。

##### 1. 记录协议

记录协议(Record Protocol)规定了 TLS 收发数据的基本单位记录(record)。

##### 2. 警报协议

警报协议(Alert Protocol)用于提示协议交互过程出现错误。

##### 3. 握手协议

握手协议(Handshake Protocol)是 TLS 里最复杂的子协议，在握手过程中协商 TLS 版本号、随机数、密码套件等信息，然后交换证书和密钥参数，最终双方协商得到会话密钥，用于后续的混合加密系统。

##### 4. 变更密码规范协议

变更密码规范协议(Change Cipher Spec Protocol)是一个“通知”，告诉对方，后续的数据都将使用加密保护。

#### 2.9.3 交互过程

##### 1. Client Hello

Client Hello 由客户端发送，内容包括客户端的一个Unix时间戳(GMT Unix Time)、一些随机的字节(Random Bytes)，还包括了客户端接受的算法类型(Cipher Suites)。

##### 2. Server Hello

Server Hello 由服务端发送，内容包括服务端支持的算法类型、GMT Unix Time以及Random Bytes。

##### 3. Certificate

由服务端或者客户端发送，发送方会会将自己的数字证书发送给接收方，由接收方进行证书验证，如果不通过的话，接收方会中断握手的过程。一般跟在Client / Server Hello报文之后。

##### 4. Server Key Exchange

由服务端发送，将自己的公钥参数传输给了客户端，一般也和Server Hello与Certificate在一个TCP报文中。

##### 5. Server Hello Done

服务端发送，一般也和Server Hello、Certificate和Server Key Exchange在一个TCP报文中。

##### 6. Client Key Exchange

客户端发送，向服务端发送自己的公钥参数，与服务端协商密钥。

##### 7. Change Cipher Spec

客户端或者服务端发送，紧跟着Key Exchange发送，代表自己生成了新的密钥，通知对方以后将更换密钥，使用新的密钥进行通信。

##### 8. Encrypted Handshake Message

客户端或者服务端发送，紧跟着Key Exchange发送。进行测试，一方用自己的刚刚生成的密钥加密一段固定的消息发送给对方，如果密钥协商正确无误的话，对方可以正确解密。

##### 9. New Session Ticket

服务端发送，表示发起会话，在一段时间之内(超时时间到来之前)，双方都以刚刚交换的密钥进行通信。从这以后，加密通信正式开始。

##### 10. Application Data

使用密钥交换协议协商出来的密钥加密的应用层的数据。

##### 11. Encrypted Alert

客户端或服务端发送，意味着加密通信因为某些原因需要中断，警告对方不要再发送敏感的数据。

#### 2.9.4 版本更新内容

##### TLS 1.3

* 引入了PSK作为新的密钥协商机制
* 支持 0-RTT 模式，以安全性降低为代价，在建立连接时节省了往返时间
* ServerHello 之后的所有握手消息采取了加密操作，可见明文减少
* 不再允许对加密报文进行压缩、不再允许双方发起重协商
* DSA 证书不再允许在 TLS 1.3 中使用
* 删除不安全的密码算法
  + RSA 密钥传输 - 不支持前向安全性
  + CBC 模式密码 - 易受 BEAST 和 Lucky 13 攻击
  + RC4 流密码 - 在 HTTPS 中使用并不安全
  + SHA-1 哈希函数 - 建议以 SHA-2 取而代之
  + 任意 Diffie-Hellman 组- CVE-2016-0701 漏洞
  + 输出密码 - 易受 FREAK 和 LogJam 攻击

#### 2.9.5 子协议

SSL/TLS协议有一个高度模块化的架构，分为很多子协议，主要是：

##### 1. Handshake 协议

包括协商安全参数和密码套件、服务端身份认证(客户端身份认证可选)、密钥交换

##### 2. ChangeCipherSpec 协议

一条消息表明握手协议已经完成

##### 3. Alert 协议

对握手协议中一些异常的错误提醒，分为fatal和warning两个级别，fatal类型的错误会直接中断SSL链接，而warning级别的错误SSL链接仍可继续，只是会给出错误警告

##### 4. Record 协议

包括对消息的分段、压缩、消息认证和完整性保护、加密等

#### 2.9.6 参考链接

##### 1. RFC

* [RFC 2246 The TLS Protocol Version 1.0](https://tools.ietf.org/html/rfc2246)
* [RFC 4346 The Transport Layer Security (TLS) Protocol Version 1.1](https://tools.ietf.org/html/rfc4346)
* [RFC 5246 The Transport Layer Security (TLS) Protocol Version 1.2](https://tools.ietf.org/html/rfc5246)
* [RFC 6101 The Secure Sockets Layer (SSL) Protocol Version 3.0](https://tools.ietf.org/html/rfc6101)
* [RFC 6176 Prohibiting Secure Sockets Layer (SSL) Version 2.0](https://tools.ietf.org/html/rfc6176)
* [RFC 7568 Deprecating Secure Sockets Layer Version 3.0](https://tools.ietf.org/html/rfc7568)
* [RFC 8446 The Transport Layer Security (TLS) Protocol Version 1.3](https://tools.ietf.org/html/rfc8446)

##### 2. Document

* [Wikipedia Transport Layer Security](https://en.wikipedia.org/wiki/Transport_Layer_Security)

### 2.10 IPsec

#### 2.10.1 简介

IPsec（
**IP Security**
）是IETF制定的三层隧道加密协议，它为Internet上传输的数据提供了高质量的、可互操作的、基于密码学的安全保证。特定的通信方之间在IP层通过加密与数据源认证等方式，提供了以下的安全服务：

##### 1. 数据机密性（Confidentiality）

IPsec发送方在通过网络传输包前对包进行加密。

##### 2. 数据完整性（Data Integrity）

IPsec接收方对发送方发送来的包进行认证，以确保数据在传输过程中没有被篡改。

##### 3. 数据来源认证（Data Authentication）

IPsec在接收端可以认证发送IPsec报文的发送端是否合法。

##### 4. 防重放（Anti-Replay）

IPsec接收方可检测并拒绝接收过时或重复的报文。

#### 2.10.2 优点

IPsec具有以下优点：

* 支持IKE（Internet Key Exchange，
  **因特网密钥交换**
  ），可实现密钥的自动协商功能，减少了密钥协商的开销。可以通过IKE建立和维护SA的服务，简化了IPsec的使用和管理。
* 所有使用IP协议进行数据传输的应用系统和服务都可以使用IPsec，而不必对这些应用系统和服务本身做任何修改。
* 对数据的加密是以数据包为单位的，而不是以整个数据流为单位，这不仅灵活而且有助于进一步提高IP数据包的安全性，可以有效防范网络攻击。

#### 2.10.3 构成

IPsec由四部分内容构成：

* 负责密钥管理的Internet密钥交换协议IKE（Internet Key Exchange Protocol）
* 负责将安全服务与使用该服务的通信流相联系的安全关联SA（Security Associations）
* 直接操作数据包的认证头协议AH（IP Authentication Header）和安全载荷协议ESP（IP Encapsulating Security Payload）
* 若干用于加密和认证的算法

##### 1. 安全联盟（Security Association，SA）

IPsec在两个端点之间提供安全通信，端点被称为IPsec对等体。

SA是IPsec的基础，也是IPsec的本质。SA是通信对等体间对某些要素的约定，例如，使用哪种协议（AH、ESP还是两者结合使用）、协议的封装模式（传输模式和隧道模式）、加密算法（DES、3DES和AES）、特定流中保护数据的共享密钥以及密钥的生存周期等。建立SA的方式有手工配置和IKE自动协商两种。

SA是单向的，在两个对等体之间的双向通信，最少需要两个SA来分别对两个方向的数据流进行安全保护。同时，如果两个对等体希望同时使用AH和ESP来进行安全通信，则每个对等体都会针对每一种协议来构建一个独立的SA。

SA由一个三元组来唯一标识，这个三元组包括SPI（Security Parameter Index，安全参数索引）、目的IP地址、安全协议号（AH或ESP）。

SPI是用于唯一标识SA的一个32比特数值，它在AH和ESP头中传输。在手工配置SA时，需要手工指定SPI的取值。使用IKE协商产生SA时，SPI将随机生成。

##### 2. IKE

IKE（RFC2407，RFC2408、RFC2409）属于
**一种混合型协议**
，由Internet安全关联和密钥管理协议（ISAKMP）和两种密钥交换协议OAKLEY与SKEME组成。IKE创建在由ISAKMP定义的框架上，沿用了OAKLEY的密钥交换模式以及SKEME的共享和密钥更新技术，还定义了它自己的两种密钥交换方式。

IKE使用了两个阶段的ISAKMP：

第一阶段，协商创建一个通信信道（IKE SA），并对该信道进行验证，为双方进一步的IKE通信提供机密性、消息完整性以及消息源验证服务； 第二阶段，使用已建立的IKE SA建立IPsec SA（V2中叫Child SA）。

### 2.11 Wi-Fi

#### 2.11.1 简介

Wi-Fi又称“无线热点”或“无线网络”，是Wi-Fi联盟的商标，一个基于IEEE 802.11标准的无线局域网技术。

#### 2.11.2 攻击

##### 1. 暴力破解

WiFi密码是基于预置的秘钥，可以通过抓取报文的方式在本地快速的批量进行密码爆破尝试。

##### 2. 伪造热点

AP可以动态的广播自己，客户也可以主动发送探针请求。可以伪造AP发送对探针请求的响应包，来让客户端错误的识别。

##### 3. 秘钥重装攻击

该漏洞由Vanhoef发现。Wi-Fi在握手时双方会更新秘钥，该攻击通过重放握手信息，令客户端重新安装相同的秘钥。

##### 4. Dragonblood

最新版的WPA3标准在实现上存在一些问题，同样由Vanhoef发现。包含拒绝服务攻击、降级攻击、侧信道泄露等。

#### 2.11.3 参考链接

* [Wi-Fi Alliance](https://www.wi-fi.org/)
* [Dragonblood](https://papers.mathyvanhoef.com/dragonblood.pdf)
  : Analyzing the Dragonfly Handshake of WPA3 and EAP-pwd
* [Improving Privacy through Fast Passive Wi-Fi Scanning](https://papers.mathyvanhoef.com/nordsec2019.pdf)
* [Practical Side-Channel Attacks against WPA-TKIP](https://papers.mathyvanhoef.com/asiaccs2019.pdf)
* [Key Reinstallation Attacks: Breaking the WPA2 Protocol](https://papers.mathyvanhoef.com/blackhat-eu2017.pdf)
* [RFC 7664 Dragonfly Key Exchange](https://tools.ietf.org/html/rfc7664)