---
layout: post
title: "è“æ¡¥æ¯åµŒå…¥å¼ç»„ç¬¬ä¸ƒå±Šçœèµ›é¢˜ç›®è§£æSTM32G431RBT6å®ç°æºç "
date: 2025-03-06 08:00:00 +0800
description: "STM32G431RBT6å®ç°åµŒå…¥å¼ç»„ç¬¬ä¸ƒå±Šé¢˜ç›®è§£æ+æºç ã€‚"
keywords: "è“æ¡¥æ¯åµŒå…¥å¼ç»„ç¬¬ä¸ƒå±Šçœèµ›é¢˜ç›®è§£æ+STM32G431RBT6å®ç°æºç "
categories: ['å•ç‰‡æœº']
tags: ['è“æ¡¥æ¯', 'å­¦ä¹ ', 'å•ç‰‡æœº', 'Stm', 'C']
artid: "145996589"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145996589
    alt: "è“æ¡¥æ¯åµŒå…¥å¼ç»„ç¬¬ä¸ƒå±Šçœèµ›é¢˜ç›®è§£æSTM32G431RBT6å®ç°æºç "
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145996589
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145996589
cover: https://bing.ee123.net/img/rand?artid=145996589
image: https://bing.ee123.net/img/rand?artid=145996589
img: https://bing.ee123.net/img/rand?artid=145996589
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     è“æ¡¥æ¯åµŒå…¥å¼ç»„ç¬¬ä¸ƒå±Šçœèµ›é¢˜ç›®è§£æ+STM32G431RBT6å®ç°æºç 
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <br/>
    å‰è¨€ï¼šSTM32G431RBT6å®ç°åµŒå…¥å¼ç»„ç¬¬ä¸ƒå±Šé¢˜ç›®è§£æ+æºç ï¼Œæœ¬æ–‡é»˜è®¤è¯»è€…å…·å¤‡åŸºç¡€çš„stm32çŸ¥è¯†ã€‚æ–‡ç« æœ«å°¾æœ‰ç¬¬ä¸ƒå±Šé¢˜ç›®ã€‚
    <p>
    </p>
    <h2>
     <a id="1_2">
     </a>
     1.é¢˜ç›®è§£æ
    </h2>
    <h3>
     <a id="11__3">
     </a>
     1.1 åˆ†è€Œæ²»ä¹‹ï¼Œè—•æ–­ä¸è¿
    </h3>
    <p>
     è¿˜æ˜¯é‚£å¥è¯ï¼Œå°†ä¸åŒæ¨¡å—è¿›è¡Œå°è£…ï¼Œé€šè¿‡å˜é‡è¿›è¡Œæ¨¡å—é—´çš„åˆä½œã€‚
    </p>
    <h3>
     <a id="12__5">
     </a>
     1.2 æ¨¡å—åŒ–æ€ç»´å¯¼å›¾
    </h3>
    <p>
     ä¸‹å›¾æ ¹æ®é¢˜ç›®æ¢³ç†ã€‚ç¬¬å…­å±Šæ²¡æœ‰å†™è¿™ä¹ˆè¯¦ç»†ï¼ˆä¸»è¦æ˜¯æ‡’ğŸ˜€ï¼‰ã€‚
     <br/>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/2be6fdefdd314408aea9a4ac52152b19.png"/>
    </p>
    <h3>
     <a id="13__10">
     </a>
     1.3 æ¨¡å—è§£æ
    </h3>
    <p>
     æ•´åˆæ¨¡å—ï¼Œé€»è¾‘æ€ç»´ã€‚
    </p>
    <h4>
     <a id="131_KEY_12">
     </a>
     1.3.1 KEYæ¨¡å—
    </h4>
    <p>
     B1ï¼šç•Œé¢1ï¼Œ2ä¹‹é—´åˆ‡æ¢ï¼Œæ–¹æ³•ï¼šè®¡æ•°ï¼›0ï¼šè¡¨ç¤ºç•Œé¢1ï¼Œ1ï¼šè¡¨ç¤ºç•Œé¢2ã€‚
     <br/>
     B2ï¼šä¸‰ç§é˜ˆå€¼ä½ä¹‹é—´åˆ‡æ¢ï¼Œæ–¹æ³•ï¼šè®¡æ•°ï¼›0ï¼šè¡¨ç¤ºT1ï¼Œ1ï¼šè¡¨ç¤ºT2ï¼Œ2ï¼šè¡¨ç¤ºT3ã€‚
     <br/>
     B3ï¼šæ¯æ¬¡åŠ 5ï¼Œä¸Šé™95ï¼ˆå„é˜ˆå€¼ä¹‹é—´è¿˜åº”è¯¥T1&lt;T2&lt;T3ï¼Œ ä½†æ˜¯æˆ‘æ²¡å†™ğŸ˜…ï¼‰ã€‚
     <br/>
     B4ï¼šæ¯æ¬¡å‡5ï¼Œä¸‹é™5ã€‚
    </p>
    <pre><code class="prism language-c"><span class="token comment">//B1ï¼ŒB4ï¼ŒB3éƒ½æ˜¯åŒæ ·çš„æ ¼å¼</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span> <span class="token comment">//B1</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tick <span class="token operator">&gt;</span> KEY_REDUCTION<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>    <span class="token comment">//æŒ‰é”®æ¶ˆæŠ–</span>
            tick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B1 <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>    
<span class="token comment">//            keyS-&gt;bits.B1++;</span>
<span class="token comment">//            if(keyS-&gt;bits.B1 == 2) keyS-&gt;bits.B1 = 0;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//å®ç°æŒ‰ä¸‹ä¸€æ¬¡åªè®¡æ•°ä¸€æ¬¡</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment">//B2å¤šäº†ä¸€ç§çŠ¶æ€</span>
<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_1<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span> <span class="token comment">//B2</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tick <span class="token operator">&gt;</span> KEY_REDUCTION<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            tick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B2<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B2 <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_1<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="132_ADC_40">
     </a>
     1.3.2 ADCæ¨¡å—
    </h4>
    <p>
     é‡‡é›†å¯è°ƒç”µä½å™¨ç”µå‹ã€‚é»˜è®¤10æ¬¡ä¸ºä¸€ç»„è¿›è¡Œä¸€æ¬¡æ»¤æ³¢ã€‚
     <br/>
     å‡å¦‚ä½¿ç”¨0.2sæ—¶åŸºæ¥å¼€å¯adcé‡‡é›†ï¼Œé‡‡é›†10æ¬¡éœ€2så“åº”å¤ªæ…¢ï¼Œæ”¾åœ¨systickä¸­æ–­ä¸­ï¼Œç¨‹åºå†™åˆ°åé¢æ—¶é—´1msæ˜¾çŸ­ï¼Œæˆ‘å°±å¤šä½¿ç”¨äº†ä¸€ä¸ªtimäº§ç”Ÿ0.5sæ—¶åŸºï¼Œä¸ç”¨ç™½ä¸ç”¨ã€‚ä¹Ÿå¯ä½¿ç”¨ä¸€ä¸ª0.5çš„å°±è¡Œï¼Œç´¯è®¡4æ¬¡å°±æ‰§è¡Œä¸€æ¬¡éœ€0.2sæ—¶åŸºæ¨¡å—ã€‚ä¹Ÿå¯ä½¿ç”¨dmaé‡‡é›†ã€‚
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">HAL_ADC_ConvCpltCallback</span><span class="token punctuation">(</span>ADC_HandleTypeDef <span class="token operator">*</span>hadc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>adc_smp_flag <span class="token operator">&lt;</span> <span class="token punctuation">(</span>FILTER_LEN<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        adc_smp_flag<span class="token operator">++</span><span class="token punctuation">;</span>
        adc_smp_vtg<span class="token punctuation">.</span>smp_val<span class="token punctuation">[</span>adc_smp_flag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">HAL_ADC_GetValue</span><span class="token punctuation">(</span>hadc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>adc_smp_flag <span class="token operator">==</span> <span class="token punctuation">(</span>FILTER_LEN<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            adc_smp_flag <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">filter_process</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>adc_smp_vtg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ç´¯åŠ ç›¸é™¤</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> smp_val<span class="token punctuation">[</span>FILTER_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> filter_val<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">adc_smp_t</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="133_IIC_63">
     </a>
     1.3.3 IICæ¨¡å—
    </h4>
    <p>
     å®Œæˆeepromä¸­æ•°æ®çš„è¯»å†™ã€‚å¼€å‘æ¿çš„PB6å’ŒPB7è®¾ç½®ä¸º
     <strong>
      å¼€æ¼è¾“å‡º
     </strong>
     ï¼Œä½¿ç”¨è½¯ä»¶æ¨¡æ‹Ÿå®ç°å•å­—èŠ‚æ•°æ®çš„è¯»å†™ã€‚
     <strong>
      æ³¨æ„ï¼šé­”æœ¯æ£’-&gt;c\c+Â±&gt;optimizationé€‰é¡¹è¦è®¾ç½®æˆ-O0ï¼Œè¦ä¸ç„¶ä»£ç æ‰§è¡Œåå¾—ä¸åˆ°æƒ³è¦çš„ç»“æœã€‚
     </strong>
     <br/>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/60d05ee4785c4cc89735369b7aecdaff.png">
      <br/>
      <em>
       å…·ä½“å®ç°çœ‹ç¬¬äºŒéƒ¨åˆ†æºç ã€‚
      </em>
     </img>
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* è½¯ä»¶æ¨¡æ‹Ÿå®ç°at24c02å•å­—èŠ‚å†™å…¥ */</span>
<span class="token keyword">void</span> <span class="token function">at24c02_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">/* è½¯ä»¶æ¨¡æ‹Ÿå®ç°at24c02å•å­—èŠ‚è¯»å– */</span>
<span class="token class-name">uint8_t</span> <span class="token function">at24c02_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">/* i2cå‘eepromå†™å…¥data */</span>
<span class="token keyword">void</span> <span class="token function">iic_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre>
    <h4>
     <a id="134_UART_86">
     </a>
     1.3.4 UARTæ¨¡å—
    </h4>
    <p>
     UARTæ¥æ”¶PCç«¯æŸ¥è¯¢ç â€™Câ€™, â€˜Sâ€™ï¼Œåšå‡ºç›¸åº”çš„å›åº”ã€‚
     <br/>
     <em>
      å…·ä½“å®ç°çœ‹ç¬¬äºŒéƒ¨åˆ†æºç ã€‚
     </em>
    </p>
    <pre><code class="prism language-c"><span class="token comment">//ä¸­æ–­è§¦å‘å›è°ƒå‡½æ•°</span>
<span class="token keyword">void</span> <span class="token function">HAL_UARTEx_RxEventCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> Size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token comment">//å®šæ—¶ä¸ŠæŠ¥æ•°æ®</span>
<span class="token keyword">void</span> <span class="token function">uart_inform_PC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="135_LCD_101">
     </a>
     1.3.5 LCDæ¨¡å—
    </h4>
    <p>
     å°†æ¶‰åŠåˆ°çš„æ•°æ®æ˜¾ç¤ºåˆ°lcdå±å¹•ä¸Šï¼Œä»½ç•Œé¢1å’Œç•Œé¢2ã€‚
     <br/>
     <em>
      å…·ä½“å®ç°çœ‹ç¬¬äºŒéƒ¨åˆ†æºç ã€‚
     </em>
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">lcd_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1ï¼šif ç•Œé¢1ï¼Œ2åˆ‡æ¢æ¸…å±</span>
        <span class="token comment">//2ï¼šLCDæ˜¾ç¤ºæ•°æ®</span>
        <span class="token comment">//3ï¼šifè®¾ç½®é˜ˆå€¼æˆåŠŸååˆ‡æ¢åˆ°ç•Œé¢1ï¼Œå°†set_throså†™å…¥eeprom</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1ï¼šif ç•Œé¢1ï¼Œ2åˆ‡æ¢æ¸…å±</span>
        <span class="token comment">//2ï¼šif æ˜¾ç¤ºthros1ä¸ºç»¿è‰²+è®¾ç½®è¯¥é˜ˆå€¼</span>
        <span class="token comment">//3ï¼šelse if æ˜¾ç¤ºthros2ä¸ºç»¿è‰²+è®¾ç½®è¯¥é˜ˆå€¼</span>
        <span class="token comment">//4ï¼šelse if æ˜¾ç¤ºthros3ä¸ºç»¿è‰²+è®¾ç½®è¯¥é˜ˆå€¼</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="136_LED_123">
     </a>
     1.3.6 LEDæ¨¡å—
    </h4>
    <p>
     è¿™å±Šé¢˜ç›®æˆ‘æ„Ÿè§‰éš¾åº¦å°±åœ¨ledçš„å¤„ç†ä¸Šé¢ï¼Œçœ‹ç€é¢˜ç›®è¦æ±‚éå¸¸ç®€å•ï¼Œæ­£å¸¸æ€è·¯å½“äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™ï¼Œä½¿ç”¨HAL_GPIO_TogglePin()ç¿»è½¬ledå¯¹åº”å¼•è„šç”µå¹³å°±è¡Œï¼Œä½†æ˜¯æˆ‘ä»¬ä½¿ç”¨åˆ°äº†lcdå±å¹•ï¼Œlcdå±å¹•ä¹Ÿä½¿ç”¨åˆ°PC8-PC15è¿™äº›å¼•è„šï¼Œæ‰€ä»¥æˆ‘ä»¬æ¯æ¬¡å†™å…¥ledçŠ¶æ€çš„æ—¶å€™å¯¹å…¶ä»–ledå¼•è„šä¹Ÿå¾—è€ƒè™‘ã€‚æˆ‘å°±è¢«ç»•è¿›å»äº†ï¼Œæ•´äº†æˆ‘2ä¸ªå¤šå°æ—¶ã€‚è¿˜æ˜¯å› ä¸ºé€»è¾‘æ€ç»´ä¸å¤Ÿå¼ºï¼Œä»£ç å†™å°‘äº†ğŸ˜¶ã€‚
     <br/>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/16b8b95ceee64384ad575f3c71a41b3d.png">
      <br/>
      ä¸‰ç§äº‹ä»¶ç›¸äº’ä¹‹é—´ä¿æŒç‹¬ç«‹ã€‚æˆ‘ä»¬åˆ†æä¸€ä¸‹ä¸‰ä¸ªäº‹ä»¶ä¹‹é—´çš„å…³ç³»ï¼š
      <br/>
      LD1ï¼šæ¯éš”1säº®ç­é—ªçƒï¼Œäº‹ä»¶å‘¨æœŸæ€§è§¦å‘ã€‚
      <br/>
      LD2ï¼š0.2sé—´éš”é—ªçƒ5æ¬¡ï¼Œä½†æ˜¯äº‹ä»¶è§¦å‘æ²¡æœ‰å‘¨æœŸæ€§ï¼Œæ¶²ä½ç­‰çº§å˜åŒ–è§¦å‘ä¸€æ¬¡ã€‚
      <br/>
      LD3ï¼š0.2sé—´éš”é—ªçƒ5æ¬¡ï¼Œä½†æ˜¯äº‹ä»¶è§¦å‘æ²¡æœ‰å‘¨æœŸæ€§ï¼Œæ¥æ”¶åˆ°æŸ¥è¯¢æŒ‡ä»¤è§¦å‘ä¸€æ¬¡ã€‚
      <br/>
      æ‰€ä»¥ä¸‰äº‹ä»¶ç›¸äº’ç‹¬ç«‹ï¼Œå¯èƒ½åŒæ—¶è§¦å‘ï¼Œå¯ä»¥ä¸€æ¬¡è§¦å‘å…¶ä¸­çš„éšæœºä¸¤ä¸ªï¼Œä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªï¼Œä¹Ÿå¯èƒ½æ˜¯éƒ½æ²¡å‘ç”Ÿã€‚æ‰€ä»¥è¿™æ ·å°±æ„æˆäº†8ç§æƒ…å†µã€‚
      <br/>
      æˆ‘ä»¬å‡è®¾ä¸€ä¸ªuint8_t tempå˜é‡ï¼ŒLD1ä»£è¡¨ç¬¬1ä½ï¼ˆäº‹ä»¶1ï¼‰ï¼ŒLD2ä»£è¡¨ç¬¬2ä½ï¼ˆäº‹ä»¶2ï¼‰ï¼ŒLD3ä»£è¡¨ç¬¬3ä½ï¼ˆäº‹ä»¶3ï¼‰ï¼Œå¯¹åº”ä½ç½®1è¡¨ç¤ºè¯¥äº‹ä»¶å‘ç”Ÿï¼Œéœ€æ‰§è¡Œè¯¥äº‹ä»¶ã€‚è¿™æ ·æˆ‘å°±å¾—åˆ°äº†8ç§æƒ…å†µï¼š
      <br/>
      111ï¼šä»£è¡¨ä¸‰ç§äº‹ä»¶åŒæ—¶å‘ç”Ÿï¼›
      <br/>
      110ï¼šä»£è¡¨äº‹ä»¶3ï¼Œäº‹ä»¶2å‘ç”Ÿï¼›
      <br/>
      ä¾æ­¤ç±»æ¨â€¦
      <br/>
      000ï¼šä»£è¡¨éƒ½ä¸å‘ç”Ÿã€‚
      <br/>
      æœ€åæ ¹æ®è¿™å…«ç§æƒ…å†µå†™å…¥å¯¹åº”çš„ç”µå¹³çŠ¶æ€å°±å¯ä»¥äº†ã€‚
     </img>
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">led_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> new_liq_level <span class="token operator">=</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    ld1_tim_flag<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld1_tim_flag <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">|=</span> <span class="token number">1</span><span class="token punctuation">;</span>     
        ld1_state_flag <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>old_liq_level <span class="token operator">!=</span> new_liq_level<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">|=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        ld2_tim_flag<span class="token operator">++</span><span class="token punctuation">;</span>
        ld2_state_flag <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ld2_tim_flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">uart_inform_PC</span><span class="token punctuation">(</span>new_liq_level<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>uart_rec_flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">|=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        ld3_tim_flag<span class="token operator">++</span><span class="token punctuation">;</span>
        ld3_state_flag <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> GPIO_PIN_2<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xff00</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>        
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfe00</span> <span class="token operator">^</span> <span class="token punctuation">(</span>ld1_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfd00</span> <span class="token operator">^</span> <span class="token punctuation">(</span>ld2_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfc00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ld1_state_flag <span class="token operator">+</span> <span class="token punctuation">(</span>ld2_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfb00</span> <span class="token operator">^</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfa00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ld1_state_flag <span class="token operator">+</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfa00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ld2_state_flag<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfa00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ld1_state_flag <span class="token operator">+</span> <span class="token punctuation">(</span>ld2_state_flag<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>
    
    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> GPIO_PIN_2<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//äº‹ä»¶å®Œæˆä¹‹åç»“æŸè®¾ç½®å¯¹åº”æ ‡å¿—ä½ã€‚</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld1_tim_flag <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        ld1_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld2_tim_flag <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        old_liq_level <span class="token operator">=</span> new_liq_level<span class="token punctuation">;</span>
        ld2_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld3_tim_flag <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        uart_rec_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        ld3_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="137_TIM_212">
     </a>
     1.3.7 TIMæ¨¡å—
    </h4>
    <p>
     170MHzçš„é¢‘ç‡ï¼Œé¢„åˆ†é¢‘å€¼å¡«å†™16ï¼Œé‡è£…è½½å¯„å­˜å™¨å¡«å†™1999999å®ç°0.2sæ—¶åŸºï¼›
     <br/>
     é¢„åˆ†é¢‘å€¼å¡«å†™16ï¼Œé‡è£…è½½å¯„å­˜å™¨å¡«å†™499999å®ç°0.05sæ—¶åŸºã€‚
     <br/>
     0.2sçš„æ—¶åŸºï¼Œç”¨åœ¨ledæ¨¡å—ã€‚
     <br/>
     0.05sçš„æ—¶åŸºç”¨åœ¨uartï¼Œadcä¸Šã€‚
     <br/>
     <em>
      å…·ä½“å®ç°çœ‹ç¬¬äºŒéƒ¨åˆ†æºç ã€‚
     </em>
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">HAL_TIM_PeriodElapsedCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token class-name">uint8_t</span> test_val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>htim <span class="token operator">==</span> <span class="token operator">&amp;</span>htim2<span class="token punctuation">)</span>   <span class="token comment">//tim2</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">led_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//ledå¤„ç†å‡½æ•°</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>     <span class="token comment">//tim3</span>
        <span class="token function">HAL_ADC_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_UARTEx_ReceiveToIdle_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uart_rec_char<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="2_234">
     </a>
     2.æºç 
    </h2>
    <p>
     æˆ‘æ‰€æœ‰çš„å®ç°éƒ½åœ¨main.cæ–‡ä»¶ä¸­ã€‚
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* USER CODE BEGIN Header */</span>
<span class="token comment">/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2025 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */</span>
<span class="token comment">/* USER CODE END Header */</span>
<span class="token comment">/* Includes ------------------------------------------------------------------*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"main.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"adc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"gpio.h"</span></span>

<span class="token comment">/* Private includes ----------------------------------------------------------*/</span>
<span class="token comment">/* USER CODE BEGIN Includes */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_hal.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lcd.h"</span></span>
<span class="token comment">/* USER CODE END Includes */</span>

<span class="token comment">/* Private typedef -----------------------------------------------------------*/</span>
<span class="token comment">/* USER CODE BEGIN PTD */</span>

<span class="token comment">/* USER CODE END PTD */</span>

<span class="token comment">/* Private define ------------------------------------------------------------*/</span>
<span class="token comment">/* USER CODE BEGIN PD */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FILTER_LEN</span> <span class="token expression"><span class="token number">10</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_REDUCTION</span> <span class="token expression"><span class="token number">20</span></span></span>
<span class="token comment">/* USER CODE END PD */</span>

<span class="token comment">/* Private macro -------------------------------------------------------------*/</span>
<span class="token comment">/* USER CODE BEGIN PM */</span>

<span class="token comment">/* USER CODE END PM */</span>

<span class="token comment">/* Private variables ---------------------------------------------------------*/</span>

<span class="token comment">/* USER CODE BEGIN PV */</span>

<span class="token comment">/* USER CODE END PV */</span>

<span class="token comment">/* Private function prototypes -----------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE BEGIN PFP */</span>

<span class="token comment">/* USER CODE END PFP */</span>

<span class="token comment">/* Private user code ---------------------------------------------------------*/</span>
<span class="token comment">/* USER CODE BEGIN 0 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> smp_val<span class="token punctuation">[</span>FILTER_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> filter_val<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">adc_smp_t</span><span class="token punctuation">;</span>
<span class="token class-name">adc_smp_t</span> adc_smp_vtg <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token comment">//å°†ADCé‡‡é›†çš„æ•°æ®æ”¶é›†FILTER_LENä¸ªï¼Œä¹‹åä¼šè¿›è¡Œå‡å€¼æ»¤æ³¢</span>

<span class="token keyword">typedef</span> <span class="token keyword">union</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> keys<span class="token punctuation">;</span>
    <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">uint8_t</span> B1<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token class-name">uint8_t</span> B2<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token class-name">uint8_t</span> B3<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token class-name">uint8_t</span> B4<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>bits<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token class-name">key_state_t</span><span class="token punctuation">;</span>
<span class="token class-name">key_state_t</span> key_state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>       <span class="token comment">//è¡¨ç¤ºæŒ‰é”®çŠ¶æ€</span>

<span class="token comment">/*
adc_smp_flagï¼šä¿è¯é‡‡é›†FILTER_LENä¸ªæ•°æ®ä¹‹åè¿›è¡Œæ»¤æ³¢
key_add_sub_flagï¼Œ b3_b4_flagï¼šæ§åˆ¶æŒ‰é”®B3,B4åŠ å‡æ“ä½œã€‚
lcd_clear_flagï¼šåœ¨ç•Œé¢1å’Œç•Œé¢2ä¹‹é—´åˆ‡æ¢æ—¶å€™çš„æ¸…å±æ ‡å¿—ä½ã€‚
set_thros_flagï¼šB1æŒ‰ä¸‹è¿”å›ç•Œé¢1åï¼Œè®¾ç½®é˜ˆå€¼æˆåŠŸï¼Œå°†è®¾ç½®é˜ˆå€¼å†™å…¥eeprom
uart_rec_flagï¼šæ¥æ”¶åˆ°pcæŸ¥è¯¢æŒ‡ä»¤åï¼Œæ§åˆ¶ld3æ ‡å¿—
old_liq_levelï¼šè®°ä½ä¸Šä¸€æ¬¡çš„levelå€¼ï¼Œé€šçŸ¥pcç«¯æ—¶çŸ¥é“æ˜¯Uè¿˜æ˜¯Dï¼Œè¿˜æœ‰é…åˆæ§åˆ¶ld2
*/</span>
<span class="token class-name">uint8_t</span> adc_smp_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> key_add_sub_flag <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> b3_b4_flag <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> 
            lcd_clear_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> set_thros_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> uart_rec_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> old_liq_level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">/* åœ¨lcdä¸Šæ˜¾ç¤ºæ•°æ®ï¼Œé…åˆsprinfä½¿ç”¨ */</span>
<span class="token keyword">char</span> lcd_HOR<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> lcd_thros<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> uart_resp<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*
    iic_liq_throsï¼šå®æ—¶å€¼
    set_throsï¼šæ›´æ”¹é˜ˆå€¼æ—¶åšä¸­é—´å€¼
*/</span>
<span class="token class-name">uint8_t</span> iic_liq_thros<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">}</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*
    ldi_tim_flagï¼š0.2såŠ ä¸€ï¼Œæ§åˆ¶ldié—ªçƒæ¬¡æ•°
    ldi_state_flagï¼šæ”¹å˜å¯¹åº”ldiçš„çŠ¶æ€æ ‡å¿—ï¼Œå¯¹åº”å‘¨æœŸç­‰é—´éš”1010...äº¤æ›¿å˜åŒ–
*/</span>
<span class="token class-name">uint16_t</span> ld1_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>   ld2_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>   ld3_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
         ld1_state_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ld2_state_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ld3_state_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">/* æ¥æ”¶pcç«¯å‘æ¥çš„æŸ¥è¯¢ä¿¡å· */</span>
<span class="token class-name">uint8_t</span> uart_rec_char<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">filter_process</span><span class="token punctuation">(</span><span class="token class-name">adc_smp_t</span> <span class="token operator">*</span>adcSmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">lcd_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">at24c02_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">at24c02_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">iic_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">iic_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">key_process</span><span class="token punctuation">(</span><span class="token class-name">key_state_t</span> <span class="token operator">*</span>keyS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">set_thros_process</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>des<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">led_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">cmp_thros</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint32_t</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> liq_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">iic1_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">uart_inform_PC</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END 0 */</span>

<span class="token comment">/**
  * @brief  The application entry point.
  * @retval int
  */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

  <span class="token comment">/* USER CODE BEGIN 1 */</span>

  <span class="token comment">/* USER CODE END 1 */</span>

  <span class="token comment">/* MCU Configuration--------------------------------------------------------*/</span>

  <span class="token comment">/* Reset of all peripherals, Initializes the Flash interface and the Systick. */</span>
  <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* USER CODE BEGIN Init */</span>
    <span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_Clear</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END Init */</span>

  <span class="token comment">/* Configure the system clock */</span>
  <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* USER CODE BEGIN SysInit */</span>

  <span class="token comment">/* USER CODE END SysInit */</span>

  <span class="token comment">/* Initialize all configured peripherals */</span>
  <span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_ADC2_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_TIM2_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_TIM3_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN 2 */</span>
    <span class="token function">HAL_TIM_Base_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//tim2äº§ç”Ÿ200msæ—¶åŸº</span>
    <span class="token function">HAL_TIM_Base_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//tim3äº§ç”Ÿ50msæ—¶åŸº</span>
    <span class="token function">HAL_ADC_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAL_UARTEx_ReceiveToIdle_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uart_rec_char<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//æ£€æŸ¥eepromå¯¹åº”æ•°æ®å†…å­˜ä¸­æ•°æ®æ˜¯å¦ç¬¦åˆè¦æ±‚ï¼Œåº”å¯¹ç¬¬ä¸€æ¬¡åœ¨æ¿å­ä¸‹è½½è¯¥ç¨‹åºï¼Œeepromå¯¹åº”å†…å­˜ä½ç½®æ•°æ®ä¸æ­£ç¡®çš„é—®é¢˜</span>
    <span class="token function">iic_read</span><span class="token punctuation">(</span>set_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">cmp_thros</span><span class="token punctuation">(</span>set_thros<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">iic_write</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
       <span class="token function">iic_read</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        set_thros<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> iic_liq_thros<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   
    
    old_liq_level <span class="token operator">=</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END 2 */</span>

  <span class="token comment">/* Infinite loop */</span>
  <span class="token comment">/* USER CODE BEGIN WHILE */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* USER CODE END WHILE */</span>

    <span class="token comment">/* USER CODE BEGIN 3 */</span>

      <span class="token function">key_process</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">lcd_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
  <span class="token punctuation">}</span>
  <span class="token comment">/* USER CODE END 3 */</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
  * @brief System Clock Configuration
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  RCC_OscInitTypeDef RCC_OscInitStruct <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  RCC_ClkInitTypeDef RCC_ClkInitStruct <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/** Configure the main internal regulator output voltage
  */</span>
  <span class="token function">HAL_PWREx_ControlVoltageScaling</span><span class="token punctuation">(</span>PWR_REGULATOR_VOLTAGE_SCALE1_BOOST<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>OscillatorType <span class="token operator">=</span> RCC_OSCILLATORTYPE_HSE<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>HSEState <span class="token operator">=</span> RCC_HSE_ON<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLState <span class="token operator">=</span> RCC_PLL_ON<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLSource <span class="token operator">=</span> RCC_PLLSOURCE_HSE<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLM <span class="token operator">=</span> RCC_PLLM_DIV6<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLN <span class="token operator">=</span> <span class="token number">85</span><span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLP <span class="token operator">=</span> RCC_PLLP_DIV2<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLQ <span class="token operator">=</span> RCC_PLLQ_DIV2<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLR <span class="token operator">=</span> RCC_PLLR_DIV2<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_RCC_OscConfig</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RCC_OscInitStruct<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/** Initializes the CPU, AHB and APB buses clocks
  */</span>
  RCC_ClkInitStruct<span class="token punctuation">.</span>ClockType <span class="token operator">=</span> RCC_CLOCKTYPE_HCLK<span class="token operator">|</span>RCC_CLOCKTYPE_SYSCLK
                              <span class="token operator">|</span>RCC_CLOCKTYPE_PCLK1<span class="token operator">|</span>RCC_CLOCKTYPE_PCLK2<span class="token punctuation">;</span>
  RCC_ClkInitStruct<span class="token punctuation">.</span>SYSCLKSource <span class="token operator">=</span> RCC_SYSCLKSOURCE_PLLCLK<span class="token punctuation">;</span>
  RCC_ClkInitStruct<span class="token punctuation">.</span>AHBCLKDivider <span class="token operator">=</span> RCC_SYSCLK_DIV1<span class="token punctuation">;</span>
  RCC_ClkInitStruct<span class="token punctuation">.</span>APB1CLKDivider <span class="token operator">=</span> RCC_HCLK_DIV1<span class="token punctuation">;</span>
  RCC_ClkInitStruct<span class="token punctuation">.</span>APB2CLKDivider <span class="token operator">=</span> RCC_HCLK_DIV1<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_RCC_ClockConfig</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RCC_ClkInitStruct<span class="token punctuation">,</span> FLASH_LATENCY_4<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* USER CODE BEGIN 4 */</span>
<span class="token comment">/*
void lcd_process()
{
    if
    {
        1ï¼šif ç•Œé¢1ï¼Œ2åˆ‡æ¢æ¸…å±
        2ï¼šLCDæ˜¾ç¤ºæ•°æ®
        3ï¼šifè®¾ç½®é˜ˆå€¼æˆåŠŸååˆ‡æ¢åˆ°ç•Œé¢1ï¼Œå°†set_throså†™å…¥eeprom
    }
    else
    {
        1ï¼šif ç•Œé¢1ï¼Œ2åˆ‡æ¢æ¸…å±
        2ï¼šif æ˜¾ç¤ºthros1ä¸ºç»¿è‰²+è®¾ç½®è¯¥é˜ˆå€¼
        3ï¼šelse if æ˜¾ç¤ºthros2ä¸ºç»¿è‰²+è®¾ç½®è¯¥é˜ˆå€¼
        4ï¼šelse if æ˜¾ç¤ºthros3ä¸ºç»¿è‰²+è®¾ç½®è¯¥é˜ˆå€¼
    }
}
*/</span>
<span class="token keyword">void</span> <span class="token function">lcd_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>key_state<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>B1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>lcd_clear_flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LCD_Clear</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lcd_clear_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line1<span class="token punctuation">,</span> <span class="token string">"  Liquid Level"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_HOR<span class="token punctuation">,</span> <span class="token string">"  Height:%dcm"</span><span class="token punctuation">,</span> adc_smp_vtg<span class="token punctuation">.</span>filter_val<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_HOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_HOR<span class="token punctuation">,</span> <span class="token string">"  ADC:%.2fV"</span><span class="token punctuation">,</span> adc_smp_vtg<span class="token punctuation">.</span>filter_val<span class="token operator">*</span><span class="token number">3.3</span><span class="token operator">/</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_HOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_HOR<span class="token punctuation">,</span> <span class="token string">"  Level: %d"</span><span class="token punctuation">,</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line4<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_HOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>set_thros_flag<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            set_thros_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">iic_write</span><span class="token punctuation">(</span>set_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">iic_read</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>lcd_clear_flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LCD_Clear</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lcd_clear_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line1<span class="token punctuation">,</span> <span class="token string">"    Parameter Setup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>key_state<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>B2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">LCD_SetTextColor</span><span class="token punctuation">(</span>Green<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 1:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_SetTextColor</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 2:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line4<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 2:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line5<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>b3_b4_flag <span class="token operator">!=</span> key_add_sub_flag<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">set_thros_process</span><span class="token punctuation">(</span>set_thros<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key_state<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>B2 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 1:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_SetTextColor</span><span class="token punctuation">(</span>Green<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 2:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line4<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_SetTextColor</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 2:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line5<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>b3_b4_flag <span class="token operator">!=</span> key_add_sub_flag<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
                <span class="token function">set_thros_process</span><span class="token punctuation">(</span>set_thros<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key_state<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>B2 <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 1:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 2:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line4<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_SetTextColor</span><span class="token punctuation">(</span>Green<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 2:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line5<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_SetTextColor</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>b3_b4_flag <span class="token operator">!=</span> key_add_sub_flag<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
                <span class="token function">set_thros_process</span><span class="token punctuation">(</span>set_thros<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>

<span class="token comment">/* è½¯ç”²æ¨¡æ‹Ÿiicåè®®å†™å…¥1byte */</span>
<span class="token keyword">void</span> <span class="token function">at24c02_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">I2CStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CSendByte</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CWaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CSendByte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CWaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CSendByte</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CWaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* è½¯ä»¶æ¨¡æ‹Ÿiicåè®®è¯»å–1byte */</span>
<span class="token class-name">uint8_t</span> <span class="token function">at24c02_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> data<span class="token punctuation">;</span>
    <span class="token function">I2CStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CSendByte</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CWaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CSendByte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CWaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CSendByte</span><span class="token punctuation">(</span><span class="token number">0xa1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CWaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    data <span class="token operator">=</span> <span class="token function">I2CReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CSendNotAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* å†™å…¥æ•°æ® */</span>
<span class="token keyword">void</span> <span class="token function">iic_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">at24c02_write</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* è¯»å–æ•°æ® */</span>
<span class="token keyword">void</span> <span class="token function">iic_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">=</span> <span class="token function">at24c02_read</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
        <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* éªŒè¯è¯»å‡ºæ•°æ®æ˜¯å¦æ­£å¸¸ */</span>
<span class="token class-name">uint8_t</span> <span class="token function">cmp_thros</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>a<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token operator">||</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">95</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* æ£€æµ‹æ¶²æ·±ç­‰çº§ */</span>
<span class="token class-name">uint32_t</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> liq_thros<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> temp <span class="token operator">=</span> adc_smp_vtg<span class="token punctuation">.</span>filter_val<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span><span class="token number">4096</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">&lt;=</span> liq_thros<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">&gt;</span> liq_thros<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> temp <span class="token operator">&lt;=</span> liq_thros<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">&gt;</span> liq_thros<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> temp <span class="token operator">&lt;=</span> liq_thros<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* è¯»å–BiæŒ‰é”®çŠ¶æ€ */</span>
<span class="token keyword">void</span> <span class="token function">key_process</span><span class="token punctuation">(</span><span class="token class-name">key_state_t</span> <span class="token operator">*</span>keyS<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> tick <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span> <span class="token comment">//B1</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tick <span class="token operator">&gt;</span> KEY_REDUCTION<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            tick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B1 <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//            keyS-&gt;bits.B1++;</span>
<span class="token comment">//            if(keyS-&gt;bits.B1 == 2) keyS-&gt;bits.B1 = 0;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_1<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span> <span class="token comment">//B2</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tick <span class="token operator">&gt;</span> KEY_REDUCTION<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            tick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B2<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B2 <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_1<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_2<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span> <span class="token comment">//B3</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tick <span class="token operator">&gt;</span> KEY_REDUCTION<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            tick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B3 <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//            keyS-&gt;bits.B3++;</span>
<span class="token comment">//            if(keyS-&gt;bits.B3 == 2) keyS-&gt;bits.B3 = 0;</span>
            key_add_sub_flag<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_2<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span> <span class="token comment">//B1</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tick <span class="token operator">&gt;</span> KEY_REDUCTION<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            tick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B4 <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//            keyS-&gt;bits.B4++;</span>
<span class="token comment">//            if(keyS-&gt;bits.B4 == 2) keyS-&gt;bits.B4 = 0;</span>
            key_add_sub_flag<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* è®¾ç½®é˜ˆå€¼ */</span>
<span class="token keyword">void</span> <span class="token function">set_thros_process</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>des<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> index<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>key_add_sub_flag<span class="token operator">&gt;</span>b3_b4_flag <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>des<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token operator">&gt;=</span><span class="token number">5</span> <span class="token operator">&amp;&amp;</span> des<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>        
        des<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>des<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span> des<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">95</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key_add_sub_flag<span class="token operator">&lt;</span>b3_b4_flag <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>des<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token operator">&gt;=</span><span class="token number">5</span> <span class="token operator">&amp;&amp;</span> des<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        des<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>des<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> des<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    set_thros_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    b3_b4_flag <span class="token operator">=</span> key_add_sub_flag<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">/* 
void led_process()
{
    1ï¼šå‰é¢3ifè®¾ç½®3ç§äº‹ä»¶æ˜¯å¦å‘ç”Ÿ
    2ï¼š3ç§äº‹ä»¶ç›¸äº’ç»„åˆå½¢æˆ8ç§æ··åˆäº‹ä»¶
    3ï¼šæœ€å3ifè®¾ç½®ç›¸å…³æ ‡å¿—ä½
}
*/</span>
<span class="token keyword">void</span> <span class="token function">led_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> new_liq_level <span class="token operator">=</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    ld1_tim_flag<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld1_tim_flag <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">|=</span> <span class="token number">1</span><span class="token punctuation">;</span>     
        ld1_state_flag <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>old_liq_level <span class="token operator">!=</span> new_liq_level<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">|=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        ld2_tim_flag<span class="token operator">++</span><span class="token punctuation">;</span>
        ld2_state_flag <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ld2_tim_flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">uart_inform_PC</span><span class="token punctuation">(</span>new_liq_level<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>uart_rec_flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">|=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        ld3_tim_flag<span class="token operator">++</span><span class="token punctuation">;</span>
        ld3_state_flag <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> GPIO_PIN_2<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xff00</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>        
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfe00</span> <span class="token operator">^</span> <span class="token punctuation">(</span>ld1_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfd00</span> <span class="token operator">^</span> <span class="token punctuation">(</span>ld2_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfc00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ld1_state_flag <span class="token operator">+</span> <span class="token punctuation">(</span>ld2_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfb00</span> <span class="token operator">^</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfa00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ld1_state_flag <span class="token operator">+</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfa00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ld2_state_flag<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfa00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ld1_state_flag <span class="token operator">+</span> <span class="token punctuation">(</span>ld2_state_flag<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>
    
    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> GPIO_PIN_2<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld1_tim_flag <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        ld1_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld2_tim_flag <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        old_liq_level <span class="token operator">=</span> new_liq_level<span class="token punctuation">;</span>
        ld2_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld3_tim_flag <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        uart_rec_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        ld3_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* å‘pcç«¯å‘é€æ•°æ® */</span>
<span class="token keyword">void</span> <span class="token function">uart_inform_PC</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> level<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>old_liq_level<span class="token operator">&lt;</span>level<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>uart_resp<span class="token punctuation">,</span> <span class="token string">"A:H%2d+L%1d+U\r\n"</span><span class="token punctuation">,</span> adc_smp_vtg<span class="token punctuation">.</span>filter_val<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span><span class="token number">4096</span><span class="token punctuation">,</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_UART_Transmit_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>uart_resp<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>old_liq_level<span class="token operator">&gt;</span>level<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>uart_resp<span class="token punctuation">,</span> <span class="token string">"A:H%2d+L%1d+D\r\n"</span><span class="token punctuation">,</span> adc_smp_vtg<span class="token punctuation">.</span>filter_val<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span><span class="token number">4096</span><span class="token punctuation">,</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_UART_Transmit_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>uart_resp<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* å®šæ—¶å™¨æ—¶åŸºä¸­æ–­å›è°ƒå‡½æ•° */</span>
<span class="token keyword">void</span> <span class="token function">HAL_TIM_PeriodElapsedCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token class-name">uint8_t</span> test_val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>htim <span class="token operator">==</span> <span class="token operator">&amp;</span>htim2<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">led_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">HAL_ADC_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_UARTEx_ReceiveToIdle_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uart_rec_char<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment">/* uartæ¥æ”¶äº‹ä»¶ä¸­æ–­å›è°ƒå‡½æ•° */</span>
<span class="token keyword">void</span> <span class="token function">HAL_UARTEx_RxEventCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> Size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>uart_rec_char <span class="token operator">==</span> <span class="token char">'C'</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        uart_rec_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>uart_resp<span class="token punctuation">,</span> <span class="token string">"C:H%2d+L%1d\r\n"</span><span class="token punctuation">,</span> adc_smp_vtg<span class="token punctuation">.</span>filter_val<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span><span class="token number">4096</span><span class="token punctuation">,</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_UART_Transmit_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>uart_resp<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>uart_rec_char <span class="token operator">==</span> <span class="token char">'S'</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        uart_rec_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>uart_resp<span class="token punctuation">,</span> <span class="token string">"S:TL%2d+TM%2d+TH%2d\r\n"</span><span class="token punctuation">,</span> iic_liq_thros<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> iic_liq_thros<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> iic_liq_thros<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_UART_Transmit_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>uart_resp<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* adcè§„åˆ™ç»„è½¬æ¢å®Œæˆä¸­æ–­å›è°ƒå‡½æ•° */</span>
<span class="token keyword">void</span> <span class="token function">HAL_ADC_ConvCpltCallback</span><span class="token punctuation">(</span>ADC_HandleTypeDef <span class="token operator">*</span>hadc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>adc_smp_flag <span class="token operator">&lt;</span> <span class="token punctuation">(</span>FILTER_LEN<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        adc_smp_flag<span class="token operator">++</span><span class="token punctuation">;</span>
        adc_smp_vtg<span class="token punctuation">.</span>smp_val<span class="token punctuation">[</span>adc_smp_flag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">HAL_ADC_GetValue</span><span class="token punctuation">(</span>hadc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>adc_smp_flag <span class="token operator">==</span> <span class="token punctuation">(</span>FILTER_LEN<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            adc_smp_flag <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">filter_process</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>adc_smp_vtg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* adcé‡‡é›†å€¼è¿›è¡Œæ»¤æ³¢ */</span>
<span class="token keyword">void</span> <span class="token function">filter_process</span><span class="token punctuation">(</span><span class="token class-name">adc_smp_t</span> <span class="token operator">*</span>adcSmp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>FILTER_LEN<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">+=</span> adcSmp<span class="token operator">-&gt;</span>smp_val<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    adcSmp<span class="token operator">-&gt;</span>filter_val <span class="token operator">=</span> temp<span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">/* USER CODE END 4 */</span>

<span class="token comment">/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* USER CODE BEGIN Error_Handler_Debug */</span>
  <span class="token comment">/* User can add his own implementation to report the HAL error return state */</span>
  <span class="token function">__disable_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* USER CODE END Error_Handler_Debug */</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span>  <span class="token expression">USE_FULL_ASSERT</span></span>
<span class="token comment">/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">assert_failed</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> line<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* USER CODE BEGIN 6 */</span>
  <span class="token comment">/* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */</span>
  <span class="token comment">/* USER CODE END 6 */</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* USE_FULL_ASSERT */</span></span>

</code></pre>
    <h2>
     <a id="3_893">
     </a>
     3.ç¬¬ä¸ƒå±Šé¢˜ç›®
    </h2>
    <p>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/9bcb7a647feb43de8aeb6713c2821d5e.png">
      <br/>
      <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/9e0763d60cad4d3f8a85852cf7d07e17.png">
       <br/>
       <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/a4caae68a7a846b386a7ec11ff8891b0.png">
        <br/>
        <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/b5a3ab5e81e34eba885fd05258607d47.png">
         <br/>
         <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/16b8b95ceee64384ad575f3c71a41b3d.png"/>
        </img>
       </img>
      </img>
     </img>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f38303735343230332f:61727469636c652f64657461696c732f313435393936353839" class_="artid" style="display:none">
 </p>
</div>


