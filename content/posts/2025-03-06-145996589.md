---
layout: post
title: "蓝桥杯嵌入式组第七届省赛题目解析STM32G431RBT6实现源码"
date: 2025-03-06 08:00:00 +0800
description: "STM32G431RBT6实现嵌入式组第七届题目解析+源码。"
keywords: "蓝桥杯嵌入式组第七届省赛题目解析+STM32G431RBT6实现源码"
categories: ['单片机']
tags: ['蓝桥杯', '学习', '单片机', 'Stm', 'C']
artid: "145996589"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145996589
    alt: "蓝桥杯嵌入式组第七届省赛题目解析STM32G431RBT6实现源码"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145996589
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145996589
cover: https://bing.ee123.net/img/rand?artid=145996589
image: https://bing.ee123.net/img/rand?artid=145996589
img: https://bing.ee123.net/img/rand?artid=145996589
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     蓝桥杯嵌入式组第七届省赛题目解析+STM32G431RBT6实现源码
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <br/>
    前言：STM32G431RBT6实现嵌入式组第七届题目解析+源码，本文默认读者具备基础的stm32知识。文章末尾有第七届题目。
    <p>
    </p>
    <h2>
     <a id="1_2">
     </a>
     1.题目解析
    </h2>
    <h3>
     <a id="11__3">
     </a>
     1.1 分而治之，藕断丝连
    </h3>
    <p>
     还是那句话，将不同模块进行封装，通过变量进行模块间的合作。
    </p>
    <h3>
     <a id="12__5">
     </a>
     1.2 模块化思维导图
    </h3>
    <p>
     下图根据题目梳理。第六届没有写这么详细（主要是懒😀）。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2be6fdefdd314408aea9a4ac52152b19.png"/>
    </p>
    <h3>
     <a id="13__10">
     </a>
     1.3 模块解析
    </h3>
    <p>
     整合模块，逻辑思维。
    </p>
    <h4>
     <a id="131_KEY_12">
     </a>
     1.3.1 KEY模块
    </h4>
    <p>
     B1：界面1，2之间切换，方法：计数；0：表示界面1，1：表示界面2。
     <br/>
     B2：三种阈值位之间切换，方法：计数；0：表示T1，1：表示T2，2：表示T3。
     <br/>
     B3：每次加5，上限95（各阈值之间还应该T1&lt;T2&lt;T3， 但是我没写😅）。
     <br/>
     B4：每次减5，下限5。
    </p>
    <pre><code class="prism language-c"><span class="token comment">//B1，B4，B3都是同样的格式</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span> <span class="token comment">//B1</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tick <span class="token operator">&gt;</span> KEY_REDUCTION<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>    <span class="token comment">//按键消抖</span>
            tick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B1 <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>    
<span class="token comment">//            keyS-&gt;bits.B1++;</span>
<span class="token comment">//            if(keyS-&gt;bits.B1 == 2) keyS-&gt;bits.B1 = 0;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//实现按下一次只计数一次</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment">//B2多了一种状态</span>
<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_1<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span> <span class="token comment">//B2</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tick <span class="token operator">&gt;</span> KEY_REDUCTION<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            tick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B2<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B2 <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_1<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="132_ADC_40">
     </a>
     1.3.2 ADC模块
    </h4>
    <p>
     采集可调电位器电压。默认10次为一组进行一次滤波。
     <br/>
     假如使用0.2s时基来开启adc采集，采集10次需2s响应太慢，放在systick中断中，程序写到后面时间1ms显短，我就多使用了一个tim产生0.5s时基，不用白不用。也可使用一个0.5的就行，累计4次就执行一次需0.2s时基模块。也可使用dma采集。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">HAL_ADC_ConvCpltCallback</span><span class="token punctuation">(</span>ADC_HandleTypeDef <span class="token operator">*</span>hadc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>adc_smp_flag <span class="token operator">&lt;</span> <span class="token punctuation">(</span>FILTER_LEN<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        adc_smp_flag<span class="token operator">++</span><span class="token punctuation">;</span>
        adc_smp_vtg<span class="token punctuation">.</span>smp_val<span class="token punctuation">[</span>adc_smp_flag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">HAL_ADC_GetValue</span><span class="token punctuation">(</span>hadc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>adc_smp_flag <span class="token operator">==</span> <span class="token punctuation">(</span>FILTER_LEN<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            adc_smp_flag <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">filter_process</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>adc_smp_vtg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//累加相除</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> smp_val<span class="token punctuation">[</span>FILTER_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> filter_val<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">adc_smp_t</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="133_IIC_63">
     </a>
     1.3.3 IIC模块
    </h4>
    <p>
     完成eeprom中数据的读写。开发板的PB6和PB7设置为
     <strong>
      开漏输出
     </strong>
     ，使用软件模拟实现单字节数据的读写。
     <strong>
      注意：魔术棒-&gt;c\c+±&gt;optimization选项要设置成-O0，要不然代码执行后得不到想要的结果。
     </strong>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/60d05ee4785c4cc89735369b7aecdaff.png">
      <br/>
      <em>
       具体实现看第二部分源码。
      </em>
     </img>
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* 软件模拟实现at24c02单字节写入 */</span>
<span class="token keyword">void</span> <span class="token function">at24c02_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 软件模拟实现at24c02单字节读取 */</span>
<span class="token class-name">uint8_t</span> <span class="token function">at24c02_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">/* i2c向eeprom写入data */</span>
<span class="token keyword">void</span> <span class="token function">iic_write</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

</code></pre>
    <h4>
     <a id="134_UART_86">
     </a>
     1.3.4 UART模块
    </h4>
    <p>
     UART接收PC端查询码’C’, ‘S’，做出相应的回应。
     <br/>
     <em>
      具体实现看第二部分源码。
     </em>
    </p>
    <pre><code class="prism language-c"><span class="token comment">//中断触发回调函数</span>
<span class="token keyword">void</span> <span class="token function">HAL_UARTEx_RxEventCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> Size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token comment">//定时上报数据</span>
<span class="token keyword">void</span> <span class="token function">uart_inform_PC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="135_LCD_101">
     </a>
     1.3.5 LCD模块
    </h4>
    <p>
     将涉及到的数据显示到lcd屏幕上，份界面1和界面2。
     <br/>
     <em>
      具体实现看第二部分源码。
     </em>
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">lcd_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1：if 界面1，2切换清屏</span>
        <span class="token comment">//2：LCD显示数据</span>
        <span class="token comment">//3：if设置阈值成功后切换到界面1，将set_thros写入eeprom</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//1：if 界面1，2切换清屏</span>
        <span class="token comment">//2：if 显示thros1为绿色+设置该阈值</span>
        <span class="token comment">//3：else if 显示thros2为绿色+设置该阈值</span>
        <span class="token comment">//4：else if 显示thros3为绿色+设置该阈值</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="136_LED_123">
     </a>
     1.3.6 LED模块
    </h4>
    <p>
     这届题目我感觉难度就在led的处理上面，看着题目要求非常简单，正常思路当事件发生的时候，使用HAL_GPIO_TogglePin()翻转led对应引脚电平就行，但是我们使用到了lcd屏幕，lcd屏幕也使用到PC8-PC15这些引脚，所以我们每次写入led状态的时候对其他led引脚也得考虑。我就被绕进去了，整了我2个多小时。还是因为逻辑思维不够强，代码写少了😶。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/16b8b95ceee64384ad575f3c71a41b3d.png">
      <br/>
      三种事件相互之间保持独立。我们分析一下三个事件之间的关系：
      <br/>
      LD1：每隔1s亮灭闪烁，事件周期性触发。
      <br/>
      LD2：0.2s间隔闪烁5次，但是事件触发没有周期性，液位等级变化触发一次。
      <br/>
      LD3：0.2s间隔闪烁5次，但是事件触发没有周期性，接收到查询指令触发一次。
      <br/>
      所以三事件相互独立，可能同时触发，可以一次触发其中的随机两个，也可能是一个，也可能是都没发生。所以这样就构成了8种情况。
      <br/>
      我们假设一个uint8_t temp变量，LD1代表第1位（事件1），LD2代表第2位（事件2），LD3代表第3位（事件3），对应位置1表示该事件发生，需执行该事件。这样我就得到了8种情况：
      <br/>
      111：代表三种事件同时发生；
      <br/>
      110：代表事件3，事件2发生；
      <br/>
      依此类推…
      <br/>
      000：代表都不发生。
      <br/>
      最后根据这八种情况写入对应的电平状态就可以了。
     </img>
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">led_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> new_liq_level <span class="token operator">=</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    ld1_tim_flag<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld1_tim_flag <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">|=</span> <span class="token number">1</span><span class="token punctuation">;</span>     
        ld1_state_flag <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>old_liq_level <span class="token operator">!=</span> new_liq_level<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">|=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        ld2_tim_flag<span class="token operator">++</span><span class="token punctuation">;</span>
        ld2_state_flag <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ld2_tim_flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">uart_inform_PC</span><span class="token punctuation">(</span>new_liq_level<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>uart_rec_flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">|=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        ld3_tim_flag<span class="token operator">++</span><span class="token punctuation">;</span>
        ld3_state_flag <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> GPIO_PIN_2<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xff00</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>        
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfe00</span> <span class="token operator">^</span> <span class="token punctuation">(</span>ld1_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfd00</span> <span class="token operator">^</span> <span class="token punctuation">(</span>ld2_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfc00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ld1_state_flag <span class="token operator">+</span> <span class="token punctuation">(</span>ld2_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfb00</span> <span class="token operator">^</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfa00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ld1_state_flag <span class="token operator">+</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfa00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ld2_state_flag<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfa00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ld1_state_flag <span class="token operator">+</span> <span class="token punctuation">(</span>ld2_state_flag<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>
    
    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> GPIO_PIN_2<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//事件完成之后结束设置对应标志位。</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld1_tim_flag <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        ld1_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld2_tim_flag <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        old_liq_level <span class="token operator">=</span> new_liq_level<span class="token punctuation">;</span>
        ld2_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld3_tim_flag <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        uart_rec_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        ld3_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="137_TIM_212">
     </a>
     1.3.7 TIM模块
    </h4>
    <p>
     170MHz的频率，预分频值填写16，重装载寄存器填写1999999实现0.2s时基；
     <br/>
     预分频值填写16，重装载寄存器填写499999实现0.05s时基。
     <br/>
     0.2s的时基，用在led模块。
     <br/>
     0.05s的时基用在uart，adc上。
     <br/>
     <em>
      具体实现看第二部分源码。
     </em>
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">HAL_TIM_PeriodElapsedCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token class-name">uint8_t</span> test_val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>htim <span class="token operator">==</span> <span class="token operator">&amp;</span>htim2<span class="token punctuation">)</span>   <span class="token comment">//tim2</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">led_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//led处理函数</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>     <span class="token comment">//tim3</span>
        <span class="token function">HAL_ADC_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_UARTEx_ReceiveToIdle_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uart_rec_char<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="2_234">
     </a>
     2.源码
    </h2>
    <p>
     我所有的实现都在main.c文件中。
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* USER CODE BEGIN Header */</span>
<span class="token comment">/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2025 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */</span>
<span class="token comment">/* USER CODE END Header */</span>
<span class="token comment">/* Includes ------------------------------------------------------------------*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"main.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"adc.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tim.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"gpio.h"</span></span>

<span class="token comment">/* Private includes ----------------------------------------------------------*/</span>
<span class="token comment">/* USER CODE BEGIN Includes */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"i2c_hal.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lcd.h"</span></span>
<span class="token comment">/* USER CODE END Includes */</span>

<span class="token comment">/* Private typedef -----------------------------------------------------------*/</span>
<span class="token comment">/* USER CODE BEGIN PTD */</span>

<span class="token comment">/* USER CODE END PTD */</span>

<span class="token comment">/* Private define ------------------------------------------------------------*/</span>
<span class="token comment">/* USER CODE BEGIN PD */</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FILTER_LEN</span> <span class="token expression"><span class="token number">10</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_REDUCTION</span> <span class="token expression"><span class="token number">20</span></span></span>
<span class="token comment">/* USER CODE END PD */</span>

<span class="token comment">/* Private macro -------------------------------------------------------------*/</span>
<span class="token comment">/* USER CODE BEGIN PM */</span>

<span class="token comment">/* USER CODE END PM */</span>

<span class="token comment">/* Private variables ---------------------------------------------------------*/</span>

<span class="token comment">/* USER CODE BEGIN PV */</span>

<span class="token comment">/* USER CODE END PV */</span>

<span class="token comment">/* Private function prototypes -----------------------------------------------*/</span>
<span class="token keyword">void</span> <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE BEGIN PFP */</span>

<span class="token comment">/* USER CODE END PFP */</span>

<span class="token comment">/* Private user code ---------------------------------------------------------*/</span>
<span class="token comment">/* USER CODE BEGIN 0 */</span>
<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> smp_val<span class="token punctuation">[</span>FILTER_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> filter_val<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token class-name">adc_smp_t</span><span class="token punctuation">;</span>
<span class="token class-name">adc_smp_t</span> adc_smp_vtg <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token comment">//将ADC采集的数据收集FILTER_LEN个，之后会进行均值滤波</span>

<span class="token keyword">typedef</span> <span class="token keyword">union</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> keys<span class="token punctuation">;</span>
    <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">uint8_t</span> B1<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token class-name">uint8_t</span> B2<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token class-name">uint8_t</span> B3<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token class-name">uint8_t</span> B4<span class="token operator">:</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>bits<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token class-name">key_state_t</span><span class="token punctuation">;</span>
<span class="token class-name">key_state_t</span> key_state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>       <span class="token comment">//表示按键状态</span>

<span class="token comment">/*
adc_smp_flag：保证采集FILTER_LEN个数据之后进行滤波
key_add_sub_flag， b3_b4_flag：控制按键B3,B4加减操作。
lcd_clear_flag：在界面1和界面2之间切换时候的清屏标志位。
set_thros_flag：B1按下返回界面1后，设置阈值成功，将设置阈值写入eeprom
uart_rec_flag：接收到pc查询指令后，控制ld3标志
old_liq_level：记住上一次的level值，通知pc端时知道是U还是D，还有配合控制ld2
*/</span>
<span class="token class-name">uint8_t</span> adc_smp_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> key_add_sub_flag <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> b3_b4_flag <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">,</span> 
            lcd_clear_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> set_thros_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> uart_rec_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> old_liq_level <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">/* 在lcd上显示数据，配合sprinf使用 */</span>
<span class="token keyword">char</span> lcd_HOR<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> lcd_thros<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> uart_resp<span class="token punctuation">[</span><span class="token number">30</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*
    iic_liq_thros：实时值
    set_thros：更改阈值时做中间值
*/</span>
<span class="token class-name">uint8_t</span> iic_liq_thros<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">}</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/*
    ldi_tim_flag：0.2s加一，控制ldi闪烁次数
    ldi_state_flag：改变对应ldi的状态标志，对应周期等间隔1010...交替变化
*/</span>
<span class="token class-name">uint16_t</span> ld1_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>   ld2_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>   ld3_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
         ld1_state_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ld2_state_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ld3_state_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">/* 接收pc端发来的查询信号 */</span>
<span class="token class-name">uint8_t</span> uart_rec_char<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">filter_process</span><span class="token punctuation">(</span><span class="token class-name">adc_smp_t</span> <span class="token operator">*</span>adcSmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">lcd_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">at24c02_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">at24c02_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">iic_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">iic_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">key_process</span><span class="token punctuation">(</span><span class="token class-name">key_state_t</span> <span class="token operator">*</span>keyS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">set_thros_process</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>des<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">led_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint8_t</span> <span class="token function">cmp_thros</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">uint32_t</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> liq_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">iic1_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">uart_inform_PC</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> level<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* USER CODE END 0 */</span>

<span class="token comment">/**
  * @brief  The application entry point.
  * @retval int
  */</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

  <span class="token comment">/* USER CODE BEGIN 1 */</span>

  <span class="token comment">/* USER CODE END 1 */</span>

  <span class="token comment">/* MCU Configuration--------------------------------------------------------*/</span>

  <span class="token comment">/* Reset of all peripherals, Initializes the Flash interface and the Systick. */</span>
  <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* USER CODE BEGIN Init */</span>
    <span class="token function">LCD_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LCD_Clear</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END Init */</span>

  <span class="token comment">/* Configure the system clock */</span>
  <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/* USER CODE BEGIN SysInit */</span>

  <span class="token comment">/* USER CODE END SysInit */</span>

  <span class="token comment">/* Initialize all configured peripherals */</span>
  <span class="token function">MX_GPIO_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_ADC2_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_TIM2_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_TIM3_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">MX_USART1_UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE BEGIN 2 */</span>
    <span class="token function">HAL_TIM_Base_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim2<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//tim2产生200ms时基</span>
    <span class="token function">HAL_TIM_Base_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>htim3<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//tim3产生50ms时基</span>
    <span class="token function">HAL_ADC_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAL_UARTEx_ReceiveToIdle_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uart_rec_char<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//检查eeprom对应数据内存中数据是否符合要求，应对第一次在板子下载该程序，eeprom对应内存位置数据不正确的问题</span>
    <span class="token function">iic_read</span><span class="token punctuation">(</span>set_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">cmp_thros</span><span class="token punctuation">(</span>set_thros<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">iic_write</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
       <span class="token function">iic_read</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
    
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        set_thros<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> iic_liq_thros<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>   
    
    old_liq_level <span class="token operator">=</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">/* USER CODE END 2 */</span>

  <span class="token comment">/* Infinite loop */</span>
  <span class="token comment">/* USER CODE BEGIN WHILE */</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* USER CODE END WHILE */</span>

    <span class="token comment">/* USER CODE BEGIN 3 */</span>

      <span class="token function">key_process</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>key_state<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">lcd_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
  <span class="token punctuation">}</span>
  <span class="token comment">/* USER CODE END 3 */</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
  * @brief System Clock Configuration
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">SystemClock_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  RCC_OscInitTypeDef RCC_OscInitStruct <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  RCC_ClkInitTypeDef RCC_ClkInitStruct <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token comment">/** Configure the main internal regulator output voltage
  */</span>
  <span class="token function">HAL_PWREx_ControlVoltageScaling</span><span class="token punctuation">(</span>PWR_REGULATOR_VOLTAGE_SCALE1_BOOST<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>OscillatorType <span class="token operator">=</span> RCC_OSCILLATORTYPE_HSE<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>HSEState <span class="token operator">=</span> RCC_HSE_ON<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLState <span class="token operator">=</span> RCC_PLL_ON<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLSource <span class="token operator">=</span> RCC_PLLSOURCE_HSE<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLM <span class="token operator">=</span> RCC_PLLM_DIV6<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLN <span class="token operator">=</span> <span class="token number">85</span><span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLP <span class="token operator">=</span> RCC_PLLP_DIV2<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLQ <span class="token operator">=</span> RCC_PLLQ_DIV2<span class="token punctuation">;</span>
  RCC_OscInitStruct<span class="token punctuation">.</span>PLL<span class="token punctuation">.</span>PLLR <span class="token operator">=</span> RCC_PLLR_DIV2<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_RCC_OscConfig</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RCC_OscInitStruct<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/** Initializes the CPU, AHB and APB buses clocks
  */</span>
  RCC_ClkInitStruct<span class="token punctuation">.</span>ClockType <span class="token operator">=</span> RCC_CLOCKTYPE_HCLK<span class="token operator">|</span>RCC_CLOCKTYPE_SYSCLK
                              <span class="token operator">|</span>RCC_CLOCKTYPE_PCLK1<span class="token operator">|</span>RCC_CLOCKTYPE_PCLK2<span class="token punctuation">;</span>
  RCC_ClkInitStruct<span class="token punctuation">.</span>SYSCLKSource <span class="token operator">=</span> RCC_SYSCLKSOURCE_PLLCLK<span class="token punctuation">;</span>
  RCC_ClkInitStruct<span class="token punctuation">.</span>AHBCLKDivider <span class="token operator">=</span> RCC_SYSCLK_DIV1<span class="token punctuation">;</span>
  RCC_ClkInitStruct<span class="token punctuation">.</span>APB1CLKDivider <span class="token operator">=</span> RCC_HCLK_DIV1<span class="token punctuation">;</span>
  RCC_ClkInitStruct<span class="token punctuation">.</span>APB2CLKDivider <span class="token operator">=</span> RCC_HCLK_DIV1<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HAL_RCC_ClockConfig</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>RCC_ClkInitStruct<span class="token punctuation">,</span> FLASH_LATENCY_4<span class="token punctuation">)</span> <span class="token operator">!=</span> HAL_OK<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* USER CODE BEGIN 4 */</span>
<span class="token comment">/*
void lcd_process()
{
    if
    {
        1：if 界面1，2切换清屏
        2：LCD显示数据
        3：if设置阈值成功后切换到界面1，将set_thros写入eeprom
    }
    else
    {
        1：if 界面1，2切换清屏
        2：if 显示thros1为绿色+设置该阈值
        3：else if 显示thros2为绿色+设置该阈值
        4：else if 显示thros3为绿色+设置该阈值
    }
}
*/</span>
<span class="token keyword">void</span> <span class="token function">lcd_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>key_state<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>B1 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>lcd_clear_flag <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LCD_Clear</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lcd_clear_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line1<span class="token punctuation">,</span> <span class="token string">"  Liquid Level"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_HOR<span class="token punctuation">,</span> <span class="token string">"  Height:%dcm"</span><span class="token punctuation">,</span> adc_smp_vtg<span class="token punctuation">.</span>filter_val<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line2<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_HOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_HOR<span class="token punctuation">,</span> <span class="token string">"  ADC:%.2fV"</span><span class="token punctuation">,</span> adc_smp_vtg<span class="token punctuation">.</span>filter_val<span class="token operator">*</span><span class="token number">3.3</span><span class="token operator">/</span><span class="token number">4096</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_HOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_HOR<span class="token punctuation">,</span> <span class="token string">"  Level: %d"</span><span class="token punctuation">,</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line4<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_HOR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>set_thros_flag<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            set_thros_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">iic_write</span><span class="token punctuation">(</span>set_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">iic_read</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>lcd_clear_flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LCD_Clear</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lcd_clear_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line1<span class="token punctuation">,</span> <span class="token string">"    Parameter Setup"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>key_state<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>B2 <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">LCD_SetTextColor</span><span class="token punctuation">(</span>Green<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 1:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_SetTextColor</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 2:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line4<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 2:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line5<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>b3_b4_flag <span class="token operator">!=</span> key_add_sub_flag<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">set_thros_process</span><span class="token punctuation">(</span>set_thros<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key_state<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>B2 <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 1:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_SetTextColor</span><span class="token punctuation">(</span>Green<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 2:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line4<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_SetTextColor</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 2:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line5<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>b3_b4_flag <span class="token operator">!=</span> key_add_sub_flag<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
                <span class="token function">set_thros_process</span><span class="token punctuation">(</span>set_thros<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key_state<span class="token punctuation">.</span>bits<span class="token punctuation">.</span>B2 <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 1:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line3<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 2:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line4<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_SetTextColor</span><span class="token punctuation">(</span>Green<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sprintf</span><span class="token punctuation">(</span>lcd_thros<span class="token punctuation">,</span> <span class="token string">"  Throsouth 2:%2dcm"</span><span class="token punctuation">,</span> set_thros<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_DisplayStringLine</span><span class="token punctuation">(</span>Line5<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>lcd_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LCD_SetTextColor</span><span class="token punctuation">(</span>Black<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>b3_b4_flag <span class="token operator">!=</span> key_add_sub_flag<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
                <span class="token function">set_thros_process</span><span class="token punctuation">(</span>set_thros<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>

<span class="token comment">/* 软甲模拟iic协议写入1byte */</span>
<span class="token keyword">void</span> <span class="token function">at24c02_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">I2CStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CSendByte</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CWaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CSendByte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CWaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CSendByte</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CWaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* 软件模拟iic协议读取1byte */</span>
<span class="token class-name">uint8_t</span> <span class="token function">at24c02_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> addr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> data<span class="token punctuation">;</span>
    <span class="token function">I2CStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CSendByte</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CWaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CSendByte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CWaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CSendByte</span><span class="token punctuation">(</span><span class="token number">0xa1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CWaitAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    data <span class="token operator">=</span> <span class="token function">I2CReceiveByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CSendNotAck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">I2CStop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 写入数据 */</span>
<span class="token keyword">void</span> <span class="token function">iic_write</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">at24c02_write</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 读取数据 */</span>
<span class="token keyword">void</span> <span class="token function">iic_read</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">=</span> <span class="token function">at24c02_read</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> temp<span class="token punctuation">;</span>
        <span class="token function">HAL_Delay</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 验证读出数据是否正常 */</span>
<span class="token class-name">uint8_t</span> <span class="token function">cmp_thros</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>a<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">5</span> <span class="token operator">||</span> a<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">95</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 检测液深等级 */</span>
<span class="token class-name">uint32_t</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span> liq_thros<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> temp <span class="token operator">=</span> adc_smp_vtg<span class="token punctuation">.</span>filter_val<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span><span class="token number">4096</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">&lt;=</span> liq_thros<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">&gt;</span> liq_thros<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> temp <span class="token operator">&lt;=</span> liq_thros<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">&gt;</span> liq_thros<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> temp <span class="token operator">&lt;=</span> liq_thros<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">return</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 读取Bi按键状态 */</span>
<span class="token keyword">void</span> <span class="token function">key_process</span><span class="token punctuation">(</span><span class="token class-name">key_state_t</span> <span class="token operator">*</span>keyS<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> tick <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span> <span class="token comment">//B1</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tick <span class="token operator">&gt;</span> KEY_REDUCTION<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            tick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B1 <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//            keyS-&gt;bits.B1++;</span>
<span class="token comment">//            if(keyS-&gt;bits.B1 == 2) keyS-&gt;bits.B1 = 0;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_1<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span> <span class="token comment">//B2</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tick <span class="token operator">&gt;</span> KEY_REDUCTION<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            tick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B2<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B2 <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_1<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_2<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span> <span class="token comment">//B3</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tick <span class="token operator">&gt;</span> KEY_REDUCTION<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            tick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B3 <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//            keyS-&gt;bits.B3++;</span>
<span class="token comment">//            if(keyS-&gt;bits.B3 == 2) keyS-&gt;bits.B3 = 0;</span>
            key_add_sub_flag<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> GPIO_PIN_2<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span> <span class="token comment">//B1</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> tick <span class="token operator">&gt;</span> KEY_REDUCTION<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            tick <span class="token operator">=</span> <span class="token function">HAL_GetTick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyS<span class="token operator">-&gt;</span>bits<span class="token punctuation">.</span>B4 <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">//            keyS-&gt;bits.B4++;</span>
<span class="token comment">//            if(keyS-&gt;bits.B4 == 2) keyS-&gt;bits.B4 = 0;</span>
            key_add_sub_flag<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">HAL_GPIO_ReadPin</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> GPIO_PIN_0<span class="token punctuation">)</span> <span class="token operator">==</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 设置阈值 */</span>
<span class="token keyword">void</span> <span class="token function">set_thros_process</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>des<span class="token punctuation">,</span> <span class="token class-name">uint8_t</span> index<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>key_add_sub_flag<span class="token operator">&gt;</span>b3_b4_flag <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>des<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token operator">&gt;=</span><span class="token number">5</span> <span class="token operator">&amp;&amp;</span> des<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>        
        des<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>des<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">100</span><span class="token punctuation">)</span> des<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">95</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key_add_sub_flag<span class="token operator">&lt;</span>b3_b4_flag <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>des<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token operator">&gt;=</span><span class="token number">5</span> <span class="token operator">&amp;&amp;</span> des<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">95</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        des<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token number">5</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>des<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> des<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    set_thros_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    b3_b4_flag <span class="token operator">=</span> key_add_sub_flag<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">/* 
void led_process()
{
    1：前面3if设置3种事件是否发生
    2：3种事件相互组合形成8种混合事件
    3：最后3if设置相关标志位
}
*/</span>
<span class="token keyword">void</span> <span class="token function">led_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> new_liq_level <span class="token operator">=</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    ld1_tim_flag<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld1_tim_flag <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">|=</span> <span class="token number">1</span><span class="token punctuation">;</span>     
        ld1_state_flag <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>old_liq_level <span class="token operator">!=</span> new_liq_level<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">|=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        ld2_tim_flag<span class="token operator">++</span><span class="token punctuation">;</span>
        ld2_state_flag <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ld2_tim_flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">uart_inform_PC</span><span class="token punctuation">(</span>new_liq_level<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>uart_rec_flag <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">|=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        ld3_tim_flag<span class="token operator">++</span><span class="token punctuation">;</span>
        ld3_state_flag <span class="token operator">^=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> GPIO_PIN_2<span class="token punctuation">,</span> GPIO_PIN_SET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xff00</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>        
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfe00</span> <span class="token operator">^</span> <span class="token punctuation">(</span>ld1_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfd00</span> <span class="token operator">^</span> <span class="token punctuation">(</span>ld2_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfc00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ld1_state_flag <span class="token operator">+</span> <span class="token punctuation">(</span>ld2_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfb00</span> <span class="token operator">^</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfa00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ld1_state_flag <span class="token operator">+</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfa00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ld2_state_flag<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        GPIOC<span class="token operator">-&gt;</span>ODR <span class="token operator">=</span> <span class="token number">0xfa00</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ld1_state_flag <span class="token operator">+</span> <span class="token punctuation">(</span>ld2_state_flag<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>ld3_state_flag <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>
    
    <span class="token function">HAL_GPIO_WritePin</span><span class="token punctuation">(</span>GPIOD<span class="token punctuation">,</span> GPIO_PIN_2<span class="token punctuation">,</span> GPIO_PIN_RESET<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld1_tim_flag <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        ld1_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld2_tim_flag <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        old_liq_level <span class="token operator">=</span> new_liq_level<span class="token punctuation">;</span>
        ld2_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ld3_tim_flag <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        uart_rec_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        ld3_tim_flag <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 向pc端发送数据 */</span>
<span class="token keyword">void</span> <span class="token function">uart_inform_PC</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> level<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>old_liq_level<span class="token operator">&lt;</span>level<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>uart_resp<span class="token punctuation">,</span> <span class="token string">"A:H%2d+L%1d+U\r\n"</span><span class="token punctuation">,</span> adc_smp_vtg<span class="token punctuation">.</span>filter_val<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span><span class="token number">4096</span><span class="token punctuation">,</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_UART_Transmit_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>uart_resp<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>old_liq_level<span class="token operator">&gt;</span>level<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>uart_resp<span class="token punctuation">,</span> <span class="token string">"A:H%2d+L%1d+D\r\n"</span><span class="token punctuation">,</span> adc_smp_vtg<span class="token punctuation">.</span>filter_val<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span><span class="token number">4096</span><span class="token punctuation">,</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_UART_Transmit_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>uart_resp<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 定时器时基中断回调函数 */</span>
<span class="token keyword">void</span> <span class="token function">HAL_TIM_PeriodElapsedCallback</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token class-name">uint8_t</span> test_val <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>htim <span class="token operator">==</span> <span class="token operator">&amp;</span>htim2<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">led_process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">HAL_ADC_Start_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hadc2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_UARTEx_ReceiveToIdle_IT</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>huart1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uart_rec_char<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token comment">/* uart接收事件中断回调函数 */</span>
<span class="token keyword">void</span> <span class="token function">HAL_UARTEx_RxEventCallback</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> Size<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>uart_rec_char <span class="token operator">==</span> <span class="token char">'C'</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        uart_rec_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>uart_resp<span class="token punctuation">,</span> <span class="token string">"C:H%2d+L%1d\r\n"</span><span class="token punctuation">,</span> adc_smp_vtg<span class="token punctuation">.</span>filter_val<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span><span class="token number">4096</span><span class="token punctuation">,</span> <span class="token function">liq_level_process</span><span class="token punctuation">(</span>iic_liq_thros<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_UART_Transmit_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>uart_resp<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>uart_rec_char <span class="token operator">==</span> <span class="token char">'S'</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        uart_rec_flag <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">sprintf</span><span class="token punctuation">(</span>uart_resp<span class="token punctuation">,</span> <span class="token string">"S:TL%2d+TM%2d+TH%2d\r\n"</span><span class="token punctuation">,</span> iic_liq_thros<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> iic_liq_thros<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> iic_liq_thros<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">HAL_UART_Transmit_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token operator">*</span><span class="token punctuation">)</span>uart_resp<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* adc规则组转换完成中断回调函数 */</span>
<span class="token keyword">void</span> <span class="token function">HAL_ADC_ConvCpltCallback</span><span class="token punctuation">(</span>ADC_HandleTypeDef <span class="token operator">*</span>hadc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>adc_smp_flag <span class="token operator">&lt;</span> <span class="token punctuation">(</span>FILTER_LEN<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        adc_smp_flag<span class="token operator">++</span><span class="token punctuation">;</span>
        adc_smp_vtg<span class="token punctuation">.</span>smp_val<span class="token punctuation">[</span>adc_smp_flag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">HAL_ADC_GetValue</span><span class="token punctuation">(</span>hadc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>adc_smp_flag <span class="token operator">==</span> <span class="token punctuation">(</span>FILTER_LEN<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            adc_smp_flag <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token function">filter_process</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>adc_smp_vtg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* adc采集值进行滤波 */</span>
<span class="token keyword">void</span> <span class="token function">filter_process</span><span class="token punctuation">(</span><span class="token class-name">adc_smp_t</span> <span class="token operator">*</span>adcSmp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint32_t</span> temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>FILTER_LEN<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        temp <span class="token operator">+=</span> adcSmp<span class="token operator">-&gt;</span>smp_val<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    adcSmp<span class="token operator">-&gt;</span>filter_val <span class="token operator">=</span> temp<span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token comment">/* USER CODE END 4 */</span>

<span class="token comment">/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">Error_Handler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* USER CODE BEGIN Error_Handler_Debug */</span>
  <span class="token comment">/* User can add his own implementation to report the HAL error return state */</span>
  <span class="token function">__disable_irq</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">}</span>
  <span class="token comment">/* USER CODE END Error_Handler_Debug */</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span>  <span class="token expression">USE_FULL_ASSERT</span></span>
<span class="token comment">/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */</span>
<span class="token keyword">void</span> <span class="token function">assert_failed</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>file<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> line<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* USER CODE BEGIN 6 */</span>
  <span class="token comment">/* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */</span>
  <span class="token comment">/* USER CODE END 6 */</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* USE_FULL_ASSERT */</span></span>

</code></pre>
    <h2>
     <a id="3_893">
     </a>
     3.第七届题目
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9bcb7a647feb43de8aeb6713c2821d5e.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9e0763d60cad4d3f8a85852cf7d07e17.png">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a4caae68a7a846b386a7ec11ff8891b0.png">
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b5a3ab5e81e34eba885fd05258607d47.png">
         <br/>
         <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/16b8b95ceee64384ad575f3c71a41b3d.png"/>
        </img>
       </img>
      </img>
     </img>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f38303735343230332f:61727469636c652f64657461696c732f313435393936353839" class_="artid" style="display:none">
 </p>
</div>


