---
layout: post
title: "pycharm-anaconda-yolo11ultralytics-的视频流实时检测,保存推流简单实现"
date: 2025-03-12 16:25:52 +0800
description: "draw_rounded_rect 单纯为了绘制个圆角框，可以简单的用cv2.rectangle(frame_in, (x1, y1), (x2, y2), (0, 255, 0), 2, cv2.LINE_AA)画。流程主要就是加载模型，捕获对应的rtmp视频流，跑循环一帧帧解析数据，之后把帧的绘制结果写入本地的视频文件，同时帧结果也通过ffmpeg库推到对应的RTMP server去播放。依据传入的opencv捕获的视频流对象，获取本地保存视频的一些参数，创建video_writer，并记录推流参数。"
keywords: "pycharm + anaconda + yolo11(ultralytics) 的视频流实时检测，保存推流简单实现"
categories: ['Ai']
tags: ['视频', '目标检测', 'Yolo']
artid: "146204615"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146204615
    alt: "pycharm-anaconda-yolo11ultralytics-的视频流实时检测,保存推流简单实现"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146204615
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146204615
cover: https://bing.ee123.net/img/rand?artid=146204615
image: https://bing.ee123.net/img/rand?artid=146204615
img: https://bing.ee123.net/img/rand?artid=146204615
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     pycharm + anaconda + yolo11(ultralytics) 的视频流实时检测，保存推流简单实现
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="_1">
     </a>
     背景
    </h2>
    <p>
     首先这个基于完整安装配置了anaconda和yolo11的环境，如果需要配置开始的话，先看下专栏里另一个文章。
     <br/>
     这次的目的是实现拉取视频流，做检测并绘制对象检测框。之后，将结果保存本地视频，并且推流到对应的rtmp服务器，便于调试也可以实时显示处理结果视频。
    </p>
    <h2>
     <a id="pycharm_4">
     </a>
     pycharm安装配置
    </h2>
    <p>
     安装就不提了吧，到官网下载个免费的社区版本就ok了，安装也基本不会有啥问题。
     <br/>
     安装完成后，打开你的本地ultralytics文件夹作为项目，然后在设置里加一下解释器：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/85ddde4c01cb4919af15678784c3eea6.png">
      <br/>
      记得选对你的anaconda配置的环境，右边的列表能看到你环境中安装的库。
     </img>
    </p>
    <h2>
     <a id="_9">
     </a>
     代码实现
    </h2>
    <h3>
     <a id="___10">
     </a>
     创建本地视频配置 和 推流配置
    </h3>
    <p>
     依据传入的opencv捕获的视频流对象，获取本地保存视频的一些参数，创建video_writer，并记录推流参数。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">create_video_writer</span><span class="token punctuation">(</span>cap_video<span class="token punctuation">,</span> path_output<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 获取视频流参数</span>
    width <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>cap_video<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_WIDTH<span class="token punctuation">)</span><span class="token punctuation">)</span>
    height <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>cap_video<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FRAME_HEIGHT<span class="token punctuation">)</span><span class="token punctuation">)</span>
    fps <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>cap_video<span class="token punctuation">.</span>get<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>CAP_PROP_FPS<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 初始化本地视频保存</span>
    fourcc <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoWriter<span class="token punctuation">.</span>fourcc<span class="token punctuation">(</span><span class="token operator">*</span><span class="token string">'mp4v'</span><span class="token punctuation">)</span>
    out_writer <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoWriter<span class="token punctuation">(</span>path_output<span class="token punctuation">,</span> fourcc<span class="token punctuation">,</span> fps<span class="token punctuation">,</span> <span class="token punctuation">(</span>width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 推流的参数配置</span>
    command <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token string">'ffmpeg'</span><span class="token punctuation">,</span>
    <span class="token string">'-y'</span><span class="token punctuation">,</span>                    <span class="token comment"># 覆盖输出文件（如果存在）</span>
    <span class="token string">'-f'</span><span class="token punctuation">,</span> <span class="token string">'rawvideo'</span><span class="token punctuation">,</span>        <span class="token comment"># 输入格式</span>
    <span class="token string">'-pix_fmt'</span><span class="token punctuation">,</span> <span class="token string">'bgr24'</span><span class="token punctuation">,</span>     <span class="token comment"># OpenCV 的像素格式</span>
    <span class="token string">'-s'</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>width<span class="token punctuation">}</span></span><span class="token string">x</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>height<span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">,</span> <span class="token comment"># 分辨率</span>
    <span class="token string">'-r'</span><span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>fps<span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment"># 帧率</span>
    <span class="token string">'-i'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">,</span>               <span class="token comment"># 从标准输入读取</span>
    <span class="token string">'-c:v'</span><span class="token punctuation">,</span> <span class="token string">'libx264'</span><span class="token punctuation">,</span>       <span class="token comment"># 输出视频编码</span>
    <span class="token string">'-preset'</span><span class="token punctuation">,</span> <span class="token string">'ultrafast'</span><span class="token punctuation">,</span>       <span class="token comment"># 编码速度预设</span>
    <span class="token string">'-f'</span><span class="token punctuation">,</span> <span class="token string">'flv'</span><span class="token punctuation">,</span>             <span class="token comment"># 输出格式（RTMP 需要 flv）</span>
    RTMP_SERVER_URL
    <span class="token punctuation">]</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"视频参数：fps "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>fps<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> out_writer<span class="token punctuation">,</span> command
</code></pre>
    <h3>
     <a id="_39">
     </a>
     视频帧的处理和检测框绘制
    </h3>
    <p>
     依据传入的模型对象和视频帧，去绘制检测框和文本，之后返回结果的图像以及结果数据。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">process_frame</span><span class="token punctuation">(</span>model_in<span class="token punctuation">,</span> frame_in<span class="token punctuation">)</span><span class="token punctuation">:</span>
 results <span class="token operator">=</span> model_in<span class="token punctuation">.</span>predict<span class="token punctuation">(</span>frame_in<span class="token punctuation">)</span>
 <span class="token comment"># 绘制检测框</span>
 <span class="token keyword">for</span> result <span class="token keyword">in</span> results<span class="token punctuation">:</span>
     <span class="token keyword">for</span> box <span class="token keyword">in</span> result<span class="token punctuation">.</span>boxes<span class="token punctuation">:</span>
         x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> box<span class="token punctuation">.</span>xyxy<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
         conf <span class="token operator">=</span> box<span class="token punctuation">.</span>conf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
         cls_id <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>box<span class="token punctuation">.</span>cls<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
         label <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_in<span class="token punctuation">.</span>names<span class="token punctuation">[</span>cls_id<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>conf<span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
         <span class="token keyword">print</span><span class="token punctuation">(</span>label<span class="token punctuation">)</span>
         <span class="token comment"># 绘制矩形和标签</span>
         draw_rounded_rect<span class="token punctuation">(</span>frame_in<span class="token punctuation">,</span> <span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x2<span class="token punctuation">,</span> y2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>
                           cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>  <span class="token comment"># 红色圆角矩形</span>
         cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>frame_in<span class="token punctuation">,</span> label<span class="token punctuation">,</span> <span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1 <span class="token operator">-</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
         <span class="token keyword">return</span> frame_in<span class="token punctuation">,</span> results
</code></pre>
    <p>
     draw_rounded_rect 单纯为了绘制个圆角框，可以简单的用cv2.rectangle(frame_in, (x1, y1), (x2, y2), (0, 255, 0), 2, cv2.LINE_AA)画。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">draw_rounded_rect</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> pt1<span class="token punctuation">,</span> pt2<span class="token punctuation">,</span> color<span class="token punctuation">,</span> thickness<span class="token punctuation">,</span> line_type<span class="token punctuation">,</span> corner_radius<span class="token punctuation">)</span><span class="token punctuation">:</span>
    x1<span class="token punctuation">,</span> y1 <span class="token operator">=</span> pt1
    x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> pt2
    <span class="token comment"># 绘制四个角的圆弧</span>
    cv2<span class="token punctuation">.</span>ellipse<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>x1 <span class="token operator">+</span> corner_radius<span class="token punctuation">,</span> y1 <span class="token operator">+</span> corner_radius<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>corner_radius<span class="token punctuation">,</span> corner_radius<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> thickness<span class="token punctuation">,</span> line_type<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>ellipse<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>x2 <span class="token operator">-</span> corner_radius<span class="token punctuation">,</span> y1 <span class="token operator">+</span> corner_radius<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>corner_radius<span class="token punctuation">,</span> corner_radius<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">270</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> thickness<span class="token punctuation">,</span> line_type<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>ellipse<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>x1 <span class="token operator">+</span> corner_radius<span class="token punctuation">,</span> y2 <span class="token operator">-</span> corner_radius<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>corner_radius<span class="token punctuation">,</span> corner_radius<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> thickness<span class="token punctuation">,</span> line_type<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>ellipse<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>x2 <span class="token operator">-</span> corner_radius<span class="token punctuation">,</span> y2 <span class="token operator">-</span> corner_radius<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>corner_radius<span class="token punctuation">,</span> corner_radius<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> thickness<span class="token punctuation">,</span> line_type<span class="token punctuation">)</span>
    <span class="token comment"># 绘制四条边</span>
    cv2<span class="token punctuation">.</span>line<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>x1 <span class="token operator">+</span> corner_radius<span class="token punctuation">,</span> y1<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x2 <span class="token operator">-</span> corner_radius<span class="token punctuation">,</span> y1<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> thickness<span class="token punctuation">,</span> line_type<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>line<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y1 <span class="token operator">+</span> corner_radius<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x1<span class="token punctuation">,</span> y2 <span class="token operator">-</span> corner_radius<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> thickness<span class="token punctuation">,</span> line_type<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>line<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>x1 <span class="token operator">+</span> corner_radius<span class="token punctuation">,</span> y2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x2 <span class="token operator">-</span> corner_radius<span class="token punctuation">,</span> y2<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> thickness<span class="token punctuation">,</span> line_type<span class="token punctuation">)</span>
    cv2<span class="token punctuation">.</span>line<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span>x2<span class="token punctuation">,</span> y1 <span class="token operator">+</span> corner_radius<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x2<span class="token punctuation">,</span> y2 <span class="token operator">-</span> corner_radius<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> thickness<span class="token punctuation">,</span> line_type<span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_75">
     </a>
     主要流程
    </h3>
    <p>
     流程主要就是加载模型，捕获对应的rtmp视频流，跑循环一帧帧解析数据，之后把帧的绘制结果写入本地的视频文件，同时帧结果也通过ffmpeg库推到对应的RTMP server去播放。最后终端清除资源。
    </p>
    <pre><code class="prism language-python"><span class="token comment"># 加载模型</span>
model <span class="token operator">=</span> YOLO<span class="token punctuation">(</span>MODEL_PATH<span class="token punctuation">)</span>
<span class="token comment"># 初始化视频流</span>
cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>RTSP_URL<span class="token punctuation">)</span>
<span class="token keyword">if</span> <span class="token keyword">not</span> cap<span class="token punctuation">.</span>isOpened<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"无法打开视频流！"</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"视频流已连接..."</span><span class="token punctuation">)</span>
out_writer<span class="token punctuation">,</span> ffmpeg_command <span class="token operator">=</span> create_video_writer<span class="token punctuation">(</span>cap<span class="token punctuation">,</span> OUTPUT_VIDEO_PATH<span class="token punctuation">)</span>
<span class="token keyword">if</span> ENABLE_FEATURE_STREAM<span class="token punctuation">:</span>
    <span class="token comment"># 启动 FFmpeg 进程</span>
    ffmpeg_proc <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>Popen<span class="token punctuation">(</span>ffmpeg_command<span class="token punctuation">,</span> stdin<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">,</span> stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>PIPE<span class="token punctuation">)</span>
<span class="token keyword">if</span> ENABLE_FEATURE_DISPLAY<span class="token punctuation">:</span>
    cv2<span class="token punctuation">.</span>namedWindow<span class="token punctuation">(</span><span class="token string">"DISPLAY"</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>WINDOW_NORMAL<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"本地视频写入配置完成..."</span><span class="token punctuation">)</span>
<span class="token keyword">try</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> cap<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> ret<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"视频流中断，尝试重连..."</span><span class="token punctuation">)</span>
            cap<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
            cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span>RTSP_URL<span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token comment"># 处理单帧画面</span>
        out_frame<span class="token punctuation">,</span> _ <span class="token operator">=</span> process_frame<span class="token punctuation">(</span>model<span class="token punctuation">,</span> frame<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ENABLE_FEATURE_DISPLAY<span class="token punctuation">:</span>
            frame_small <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>out_frame<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1080</span><span class="token punctuation">,</span> <span class="token number">900</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">"DISPLAY"</span><span class="token punctuation">,</span> frame_small<span class="token punctuation">)</span>
        <span class="token keyword">if</span> ENABLE_FEATURE_STREAM<span class="token punctuation">:</span>
            <span class="token comment"># 推流到服务器</span>
            <span class="token keyword">if</span> ffmpeg_proc<span class="token punctuation">.</span>stdin<span class="token punctuation">:</span>
                ffmpeg_proc<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>write<span class="token punctuation">(</span>out_frame<span class="token punctuation">.</span>tobytes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># 保存到本地</span>
        out_writer<span class="token punctuation">.</span>write<span class="token punctuation">(</span>out_frame<span class="token punctuation">)</span>
<span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"用户中断操作"</span><span class="token punctuation">)</span>
<span class="token keyword">finally</span><span class="token punctuation">:</span>
    <span class="token comment"># 清理资源</span>
    cap<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    out_writer<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> ENABLE_FEATURE_STREAM<span class="token punctuation">:</span>
        <span class="token keyword">if</span> ffmpeg_proc<span class="token punctuation">.</span>stdin<span class="token punctuation">:</span>
            ffmpeg_proc<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            ffmpeg_proc<span class="token punctuation">.</span>terminate<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"等待进程退出"</span><span class="token punctuation">)</span>
        ffmpeg_proc<span class="token punctuation">.</span>wait<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"资源已释放"</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     然后前面的import，就是缺什么装什么，直接在conda环境里pip装就好了。
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> ultralytics <span class="token keyword">import</span> YOLO
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> time
<span class="token keyword">import</span> subprocess
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

<span class="token comment"># 参数</span>
ENABLE_FEATURE_STREAM <span class="token operator">=</span> <span class="token boolean">True</span>
ENABLE_FEATURE_DISPLAY <span class="token operator">=</span> <span class="token boolean">True</span>
RTSP_URL <span class="token operator">=</span> <span class="token string">"rtmp://xxxxx"</span>  <span class="token comment"># RTSP 或 HTTP 流地址</span>
OUTPUT_VIDEO_PATH <span class="token operator">=</span> <span class="token string">"YOLO11OutPut.mp4"</span>  <span class="token comment"># 本地保存路径</span>
RTMP_SERVER_URL <span class="token operator">=</span> <span class="token string">"rtmp://xxxxxx"</span>  <span class="token comment"># 推流服务器地址</span>
MODEL_PATH <span class="token operator">=</span> <span class="token string">"yolo11n.pt"</span>
</code></pre>
    <p>
     效果就是跑起来前端会有实时视频，并且本地会有mp4保存，远端服务器也能实时看到视频。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9e029baaca634ed79e90832b22b88c14.png">
      <br/>
      至于什么效果啥的就是后续自己调整的事情了。
     </img>
    </p>
    <h3>
     <a id="_146">
     </a>
     遇到的一些问题
    </h3>
    <ul>
     <li>
      第一个是图里后续加了中文标签，默认opencv字体不支持绘制中文会是?问号。
      <br/>
      有两个方法一个是去改yolo的绘制代码，比较麻烦，我最后用的是转PIL绘制，当然需要下字体文件SimHei.ttf丢在目录下。标签的可以在项目内的ultralytics/ultralytics/blob/main/ultralytics/cfg/datasets/coco.yaml找到识别的标签集合，自己简单补个对应中文标签组。至于代码不难，就参考着自己调整吧：
     </li>
    </ul>
    <pre><code class="prism language-python"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image<span class="token punctuation">,</span> ImageDraw<span class="token punctuation">,</span> ImageFont
cn_names <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">"人"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">"自行车"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">"汽车"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">'摩托车'</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token string">'飞机'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span> <span class="token string">'大巴'</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span> <span class="token string">'火车'</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">:</span> <span class="token string">'卡车'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">:</span> <span class="token string">'船'</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">:</span> <span class="token string">'信号灯'</span>
<span class="token punctuation">}</span>
font_path <span class="token operator">=</span> <span class="token string">"SimHei.ttf"</span>
font_size <span class="token operator">=</span> <span class="token number">20</span>
font <span class="token operator">=</span> ImageFont<span class="token punctuation">.</span>truetype<span class="token punctuation">(</span>font_path<span class="token punctuation">,</span> font_size<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">put_text_cn</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> text<span class="token punctuation">,</span> pos<span class="token punctuation">,</span> color<span class="token punctuation">,</span> font<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 转换 OpenCV 图像为 PIL 格式</span>
    img_pil <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span><span class="token punctuation">)</span>
    draw <span class="token operator">=</span> ImageDraw<span class="token punctuation">.</span>Draw<span class="token punctuation">(</span>img_pil<span class="token punctuation">)</span>
    <span class="token comment"># 计算文本尺寸并绘制背景框</span>
    bbox <span class="token operator">=</span> draw<span class="token punctuation">.</span>textbbox<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">)</span>
    text_width <span class="token operator">=</span> bbox<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> bbox<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 宽度 = 右边界 - 左边界</span>
    text_height <span class="token operator">=</span> bbox<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> bbox<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>  <span class="token comment"># 高度 = 下边界 - 上边界</span>
    x<span class="token punctuation">,</span> y <span class="token operator">=</span> pos
    bg_pos <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y <span class="token operator">-</span> text_height<span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">,</span> x <span class="token operator">+</span> text_width<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
    <span class="token comment"># draw.rectangle(bg_pos, fill=color)</span>
    <span class="token comment"># 绘制文本</span>
    draw<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token punctuation">(</span>bg_pos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bg_pos<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> text<span class="token punctuation">,</span> font<span class="token operator">=</span>font<span class="token punctuation">,</span> fill<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 白色文字</span>
    <span class="token comment"># 转换回 OpenCV 格式</span>
    <span class="token keyword">return</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>img_pil<span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_RGB2BGR<span class="token punctuation">)</span>
</code></pre>
    <ul>
     <li>
      第二个是一开始跑yolo的时候遇到过报“NotImplementedError: Could not run 'torchvision::nms“错误。查了下是已安装库版本的问题，参考
      <a href="https://stackoverflow.com/questions/75103127/getting-notimplementederror-could-not-run-torchvisionnms-with-arguments-fr" rel="nofollow">
       https://stackoverflow.com/questions/75103127/getting-notimplementederror-could-not-run-torchvisionnms-with-arguments-fr
      </a>
      <br/>
      uninstall对应的torch库然后重新安装官网链接安装一次试试~
     </li>
     <li>
      还有就是如果下载模型异常，也是跑不起来的，网络实在不行可以考虑直接去yolo的文档里找预训练的模型链接，把模型下下来丢项目根目录先：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1cd73f2190194ccbb1c98f8544d0cd38.png"/>
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f6368616e65795f662f:61727469636c652f64657461696c732f313436323034363135" class_="artid" style="display:none">
 </p>
</div>


