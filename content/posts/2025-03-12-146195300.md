---
layout: post
title: "PyTorch深度学习框架进阶学习计划-第20天端到端图像生成系统"
date: 2025-03-12 08:49:56 +0800
description: "PyTorch深度学习框架进阶学习计划 - 第20天：端到端图像生成系统！如果文章对你有帮助，还请给个三连好评，感谢感谢！"
keywords: "PyTorch深度学习框架进阶学习计划 - 第20天：端到端图像生成系统"
categories: ['未分类']
tags: ['深度学习', '学习', '人工智能', 'Pytorch', 'Python', 'Aigc', 'Ai']
artid: "146195300"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146195300
    alt: "PyTorch深度学习框架进阶学习计划-第20天端到端图像生成系统"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146195300
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146195300
cover: https://bing.ee123.net/img/rand?artid=146195300
image: https://bing.ee123.net/img/rand?artid=146195300
img: https://bing.ee123.net/img/rand?artid=146195300
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     PyTorch深度学习框架进阶学习计划 - 第20天：端到端图像生成系统
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="PyTorch__20_0">
     </a>
     PyTorch深度学习框架进阶学习计划 - 第20天
    </h2>
    <h2>
     <a id="_2">
     </a>
     端到端图像生成系统
    </h2>
    <p>
     今天我们将综合应用之前学习的知识，构建一个完整的端到端艺术风格转换系统。这个系统将结合CycleGAN与风格迁移技术，并通过Gradio创建交互式界面，同时实现模型优化、部署和监控。
    </p>
    <h4>
     <a id="1_CycleGAN_5">
     </a>
     1. CycleGAN与风格迁移原理回顾
    </h4>
    <p>
     CycleGAN能够在没有配对数据的情况下学习两个领域之间的映射，而风格迁移则能将特定的艺术风格应用到内容图像上。我们将结合这两种技术，创建一个灵活的艺术风格转换系统。
    </p>
    <p>
     <strong>
      CycleGAN核心概念
     </strong>
     :
    </p>
    <ul>
     <li>
      两个生成器(G, F)和两个判别器(DX, DY)
     </li>
     <li>
      循环一致性损失(Cycle Consistency Loss)
     </li>
     <li>
      身份映射损失(Identity Mapping Loss)
     </li>
    </ul>
    <p>
     <strong>
      风格迁移核心概念
     </strong>
     :
    </p>
    <ul>
     <li>
      内容损失(Content Loss)
     </li>
     <li>
      风格损失(Style Loss)
     </li>
     <li>
      Gram矩阵计算
     </li>
    </ul>
    <h4>
     <a id="2_GPU_19">
     </a>
     2. 多GPU训练与混合精度训练
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>distributed <span class="token keyword">as</span> dist
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>parallel <span class="token keyword">import</span> DistributedDataParallel <span class="token keyword">as</span> DDP
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader<span class="token punctuation">,</span> DistributedSampler
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> datasets<span class="token punctuation">,</span> transforms
<span class="token keyword">import</span> os
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>amp <span class="token keyword">import</span> autocast<span class="token punctuation">,</span> GradScaler

<span class="token comment"># 定义简化版的生成器和判别器</span>
<span class="token keyword">class</span> <span class="token class-name">ResidualBlock</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> channels<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>ResidualBlock<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>block <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>ReflectionPad2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>channels<span class="token punctuation">,</span> channels<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>InstanceNorm2d<span class="token punctuation">(</span>channels<span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReflectionPad2d<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>channels<span class="token punctuation">,</span> channels<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>InstanceNorm2d<span class="token punctuation">(</span>channels<span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> x <span class="token operator">+</span> self<span class="token punctuation">.</span>block<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Generator</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> output_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> n_residual_blocks<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Generator<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 初始卷积层</span>
        self<span class="token punctuation">.</span>initial <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>ReflectionPad2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>input_channels<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>InstanceNorm2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        
        <span class="token comment"># 下采样</span>
        self<span class="token punctuation">.</span>downsample <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>InstanceNorm2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>InstanceNorm2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        
        <span class="token comment"># 残差块</span>
        res_blocks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_residual_blocks<span class="token punctuation">)</span><span class="token punctuation">:</span>
            res_blocks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>ResidualBlock<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>res_blocks <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span><span class="token operator">*</span>res_blocks<span class="token punctuation">)</span>
        
        <span class="token comment"># 上采样</span>
        self<span class="token punctuation">.</span>upsample <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> output_padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>InstanceNorm2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ConvTranspose2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> output_padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>InstanceNorm2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>ReLU<span class="token punctuation">(</span>inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
        
        <span class="token comment"># 输出层</span>
        self<span class="token punctuation">.</span>output <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>ReflectionPad2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> output_channels<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>Tanh<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>initial<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>downsample<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>res_blocks<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>upsample<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>output<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Discriminator</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Discriminator<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>model <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>input_channels<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>InstanceNorm2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>InstanceNorm2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>InstanceNorm2d<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            nn<span class="token punctuation">.</span>LeakyReLU<span class="token punctuation">(</span><span class="token number">0.2</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            
            nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

<span class="token comment"># 多GPU分布式训练设置</span>
<span class="token keyword">def</span> <span class="token function">setup_ddp</span><span class="token punctuation">(</span>rank<span class="token punctuation">,</span> world_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
    os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'MASTER_ADDR'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'localhost'</span>
    os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'MASTER_PORT'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'12355'</span>
    
    <span class="token comment"># 初始化进程组</span>
    dist<span class="token punctuation">.</span>init_process_group<span class="token punctuation">(</span><span class="token string">"nccl"</span><span class="token punctuation">,</span> rank<span class="token operator">=</span>rank<span class="token punctuation">,</span> world_size<span class="token operator">=</span>world_size<span class="token punctuation">)</span>
    
    <span class="token comment"># 设置当前设备</span>
    torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>set_device<span class="token punctuation">(</span>rank<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">cleanup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    dist<span class="token punctuation">.</span>destroy_process_group<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">train_model</span><span class="token punctuation">(</span>rank<span class="token punctuation">,</span> world_size<span class="token punctuation">,</span> epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 设置分布式训练环境</span>
    setup_ddp<span class="token punctuation">(</span>rank<span class="token punctuation">,</span> world_size<span class="token punctuation">)</span>
    
    <span class="token comment"># 数据预处理</span>
    transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
        transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 加载数据集（示例使用CIFAR-10）</span>
    dataset <span class="token operator">=</span> datasets<span class="token punctuation">.</span>CIFAR10<span class="token punctuation">(</span>root<span class="token operator">=</span><span class="token string">'./data'</span><span class="token punctuation">,</span> train<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> download<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>transform<span class="token punctuation">)</span>
    sampler <span class="token operator">=</span> DistributedSampler<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> num_replicas<span class="token operator">=</span>world_size<span class="token punctuation">,</span> rank<span class="token operator">=</span>rank<span class="token punctuation">)</span>
    dataloader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> sampler<span class="token operator">=</span>sampler<span class="token punctuation">)</span>
    
    <span class="token comment"># 初始化模型</span>
    generator <span class="token operator">=</span> Generator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>rank<span class="token punctuation">)</span>
    discriminator <span class="token operator">=</span> Discriminator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>rank<span class="token punctuation">)</span>
    
    <span class="token comment"># 将模型包装为DDP模型</span>
    generator <span class="token operator">=</span> DDP<span class="token punctuation">(</span>generator<span class="token punctuation">,</span> device_ids<span class="token operator">=</span><span class="token punctuation">[</span>rank<span class="token punctuation">]</span><span class="token punctuation">)</span>
    discriminator <span class="token operator">=</span> DDP<span class="token punctuation">(</span>discriminator<span class="token punctuation">,</span> device_ids<span class="token operator">=</span><span class="token punctuation">[</span>rank<span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 定义优化器</span>
    optimizer_G <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>generator<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.0002</span><span class="token punctuation">,</span> betas<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    optimizer_D <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>discriminator<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.0002</span><span class="token punctuation">,</span> betas<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 损失函数</span>
    criterion_GAN <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    criterion_cycle <span class="token operator">=</span> nn<span class="token punctuation">.</span>L1Loss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    criterion_identity <span class="token operator">=</span> nn<span class="token punctuation">.</span>L1Loss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 梯度缩放器（用于混合精度训练）</span>
    scaler_G <span class="token operator">=</span> GradScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
    scaler_D <span class="token operator">=</span> GradScaler<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 训练循环</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>epochs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        sampler<span class="token punctuation">.</span>set_epoch<span class="token punctuation">(</span>epoch<span class="token punctuation">)</span>  <span class="token comment"># 设置epoch以确保数据洗牌</span>
        
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>real_A<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span><span class="token punctuation">:</span>
            real_A <span class="token operator">=</span> real_A<span class="token punctuation">.</span>to<span class="token punctuation">(</span>rank<span class="token punctuation">)</span>
            
            <span class="token comment"># 训练判别器</span>
            optimizer_D<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 混合精度训练</span>
            <span class="token keyword">with</span> autocast<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># 生成fake图像</span>
                fake_B <span class="token operator">=</span> generator<span class="token punctuation">(</span>real_A<span class="token punctuation">)</span>
                
                <span class="token comment"># 判别器损失</span>
                pred_real <span class="token operator">=</span> discriminator<span class="token punctuation">(</span>real_A<span class="token punctuation">)</span>
                pred_fake <span class="token operator">=</span> discriminator<span class="token punctuation">(</span>fake_B<span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                
                real_label <span class="token operator">=</span> torch<span class="token punctuation">.</span>ones_like<span class="token punctuation">(</span>pred_real<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>rank<span class="token punctuation">)</span>
                fake_label <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros_like<span class="token punctuation">(</span>pred_fake<span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>rank<span class="token punctuation">)</span>
                
                loss_D_real <span class="token operator">=</span> criterion_GAN<span class="token punctuation">(</span>pred_real<span class="token punctuation">,</span> real_label<span class="token punctuation">)</span>
                loss_D_fake <span class="token operator">=</span> criterion_GAN<span class="token punctuation">(</span>pred_fake<span class="token punctuation">,</span> fake_label<span class="token punctuation">)</span>
                loss_D <span class="token operator">=</span> <span class="token punctuation">(</span>loss_D_real <span class="token operator">+</span> loss_D_fake<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span>
            
            <span class="token comment"># 反向传播与优化</span>
            scaler_D<span class="token punctuation">.</span>scale<span class="token punctuation">(</span>loss_D<span class="token punctuation">)</span><span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            scaler_D<span class="token punctuation">.</span>step<span class="token punctuation">(</span>optimizer_D<span class="token punctuation">)</span>
            scaler_D<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 训练生成器</span>
            optimizer_G<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token keyword">with</span> autocast<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># 身份损失</span>
                identity_B <span class="token operator">=</span> generator<span class="token punctuation">(</span>real_A<span class="token punctuation">)</span>
                loss_identity <span class="token operator">=</span> criterion_identity<span class="token punctuation">(</span>identity_B<span class="token punctuation">,</span> real_A<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">5.0</span>
                
                <span class="token comment"># GAN损失</span>
                fake_B <span class="token operator">=</span> generator<span class="token punctuation">(</span>real_A<span class="token punctuation">)</span>
                pred_fake <span class="token operator">=</span> discriminator<span class="token punctuation">(</span>fake_B<span class="token punctuation">)</span>
                loss_GAN <span class="token operator">=</span> criterion_GAN<span class="token punctuation">(</span>pred_fake<span class="token punctuation">,</span> real_label<span class="token punctuation">)</span>
                
                <span class="token comment"># 总损失</span>
                loss_G <span class="token operator">=</span> loss_identity <span class="token operator">+</span> loss_GAN
            
            <span class="token comment"># 反向传播与优化</span>
            scaler_G<span class="token punctuation">.</span>scale<span class="token punctuation">(</span>loss_G<span class="token punctuation">)</span><span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
            scaler_G<span class="token punctuation">.</span>step<span class="token punctuation">(</span>optimizer_G<span class="token punctuation">)</span>
            scaler_G<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token keyword">and</span> rank <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"[Epoch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epochs<span class="token punctuation">}</span></span><span class="token string">] [Batch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>dataloader<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">] "</span></span>
                      <span class="token string-interpolation"><span class="token string">f"[D loss: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>loss_D<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">] [G loss: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>loss_G<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">]"</span></span><span class="token punctuation">)</span>
    
    <span class="token comment"># 保存模型（仅在主进程）</span>
    <span class="token keyword">if</span> rank <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>generator<span class="token punctuation">.</span>module<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'generator.pth'</span><span class="token punctuation">)</span>
        torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>discriminator<span class="token punctuation">.</span>module<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'discriminator.pth'</span><span class="token punctuation">)</span>
    
    cleanup<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 执行多GPU训练</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    world_size <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>device_count<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> world_size <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Using </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>world_size<span class="token punctuation">}</span></span><span class="token string"> GPUs!"</span></span><span class="token punctuation">)</span>
        torch<span class="token punctuation">.</span>multiprocessing<span class="token punctuation">.</span>spawn<span class="token punctuation">(</span>train_model<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span>world_size<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span> nprocs<span class="token operator">=</span>world_size<span class="token punctuation">,</span> join<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Only one GPU available or no GPU, running on single device"</span><span class="token punctuation">)</span>
        train_model<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     多GPU训练和混合精度训练可以大幅加速CycleGAN等复杂模型的训练过程。上述代码展示了如何使用PyTorch的
     <code>
      DistributedDataParallel
     </code>
     和
     <code>
      torch.cuda.amp
     </code>
     来实现这些优化。
    </p>
    <p>
     <strong>
      关键优化技术说明：
     </strong>
    </p>
    <ol>
     <li>
      <strong>
       DistributedDataParallel (DDP)
      </strong>
      : 实现数据并行训练，每个GPU处理数据的不同子集
     </li>
     <li>
      <strong>
       混合精度训练
      </strong>
      : 使用FP16和FP32混合精度，降低内存消耗并提高计算速度
     </li>
     <li>
      <strong>
       GradScaler
      </strong>
      : 解决混合精度训练中的梯度下溢问题
     </li>
    </ol>
    <h4>
     <a id="3_GradioUI_259">
     </a>
     3. 使用Gradio构建交互式UI
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> gradio <span class="token keyword">as</span> gr
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> os

<span class="token comment"># 假设已经训练好的模型</span>
<span class="token keyword">class</span> <span class="token class-name">StyleTransferModel</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> model_path<span class="token operator">=</span><span class="token string">'generator.pth'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">from</span> model <span class="token keyword">import</span> Generator  <span class="token comment"># 假设Generator类在model.py中定义</span>
        self<span class="token punctuation">.</span>device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>model <span class="token operator">=</span> Generator<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 加载预训练权重</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> map_location<span class="token operator">=</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Model loaded from </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_path<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Model </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_path<span class="token punctuation">}</span></span><span class="token string"> not found. Using untrained model."</span></span><span class="token punctuation">)</span>
        
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 预处理和后处理</span>
        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
            transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span><span class="token punctuation">)</span>
        
    <span class="token keyword">def</span> <span class="token function">inference</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> image<span class="token punctuation">,</span> style_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 图像预处理</span>
        image <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span>
        
        <span class="token comment"># 模型推理</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            output <span class="token operator">=</span> self<span class="token punctuation">.</span>model<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        
        <span class="token comment"># 后处理</span>
        output <span class="token operator">=</span> output<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>
        output <span class="token operator">=</span> output <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span>  <span class="token comment"># 反归一化</span>
        output <span class="token operator">=</span> output<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        output <span class="token operator">=</span> transforms<span class="token punctuation">.</span>ToPILImage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        
        <span class="token keyword">return</span> output

<span class="token comment"># 初始化模型</span>
<span class="token keyword">def</span> <span class="token function">load_model</span><span class="token punctuation">(</span>style_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    model_path <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'models/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>style_name<span class="token punctuation">}</span></span><span class="token string">_generator.pth'</span></span>
    <span class="token keyword">return</span> StyleTransferModel<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>

<span class="token comment"># 创建风格转换函数</span>
<span class="token keyword">def</span> <span class="token function">apply_style</span><span class="token punctuation">(</span>input_image<span class="token punctuation">,</span> style_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> input_image <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>
    
    <span class="token comment"># 加载对应风格的模型</span>
    model <span class="token operator">=</span> load_model<span class="token punctuation">(</span>style_name<span class="token punctuation">)</span>
    
    <span class="token comment"># 执行风格转换</span>
    output_image <span class="token operator">=</span> model<span class="token punctuation">.</span>inference<span class="token punctuation">(</span>input_image<span class="token punctuation">,</span> style_name<span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> output_image

<span class="token comment"># 定义可用的风格</span>
styles <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"monet"</span><span class="token punctuation">,</span> <span class="token string">"vangogh"</span><span class="token punctuation">,</span> <span class="token string">"cezanne"</span><span class="token punctuation">,</span> <span class="token string">"ukiyoe"</span><span class="token punctuation">]</span>

<span class="token comment"># 创建Gradio界面</span>
<span class="token keyword">def</span> <span class="token function">create_gradio_app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Blocks<span class="token punctuation">(</span>title<span class="token operator">=</span><span class="token string">"艺术风格转换"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> app<span class="token punctuation">:</span>
        gr<span class="token punctuation">.</span>Markdown<span class="token punctuation">(</span><span class="token string">"# 艺术风格转换系统"</span><span class="token punctuation">)</span>
        gr<span class="token punctuation">.</span>Markdown<span class="token punctuation">(</span><span class="token string">"上传图像并选择艺术风格，系统将自动为您转换图像风格。"</span><span class="token punctuation">)</span>
        
        <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Row<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                input_image <span class="token operator">=</span> gr<span class="token punctuation">.</span>Image<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">"输入图像"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"pil"</span><span class="token punctuation">)</span>
                style_selector <span class="token operator">=</span> gr<span class="token punctuation">.</span>Dropdown<span class="token punctuation">(</span>
                    choices<span class="token operator">=</span>styles<span class="token punctuation">,</span> 
                    label<span class="token operator">=</span><span class="token string">"选择艺术风格"</span><span class="token punctuation">,</span> 
                    value<span class="token operator">=</span><span class="token string">"monet"</span>
                <span class="token punctuation">)</span>
                submit_btn <span class="token operator">=</span> gr<span class="token punctuation">.</span>Button<span class="token punctuation">(</span><span class="token string">"应用风格"</span><span class="token punctuation">)</span>
            
            <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Column<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                output_image <span class="token operator">=</span> gr<span class="token punctuation">.</span>Image<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">"风格化结果"</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 设置提交按钮动作</span>
        submit_btn<span class="token punctuation">.</span>click<span class="token punctuation">(</span>
            fn<span class="token operator">=</span>apply_style<span class="token punctuation">,</span> 
            inputs<span class="token operator">=</span><span class="token punctuation">[</span>input_image<span class="token punctuation">,</span> style_selector<span class="token punctuation">]</span><span class="token punctuation">,</span> 
            outputs<span class="token operator">=</span>output_image
        <span class="token punctuation">)</span>
        
        <span class="token comment"># 添加示例</span>
        gr<span class="token punctuation">.</span>Examples<span class="token punctuation">(</span>
            examples<span class="token operator">=</span><span class="token punctuation">[</span>
                <span class="token punctuation">[</span><span class="token string">"examples/landscape.jpg"</span><span class="token punctuation">,</span> <span class="token string">"monet"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token string">"examples/portrait.jpg"</span><span class="token punctuation">,</span> <span class="token string">"vangogh"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token punctuation">[</span><span class="token string">"examples/cityscape.jpg"</span><span class="token punctuation">,</span> <span class="token string">"cezanne"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            inputs<span class="token operator">=</span><span class="token punctuation">[</span>input_image<span class="token punctuation">,</span> style_selector<span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
        
        <span class="token comment"># 添加额外信息</span>
        gr<span class="token punctuation">.</span>Markdown<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""
        ## 关于风格转换
        
        本系统使用CycleGAN结合风格迁移技术，将您的图像转换为各种艺术风格。
        
        可用风格:
        - Monet: 印象派风格，色彩柔和，笔触可见
        - Van Gogh: 后印象派风格，色彩鲜明，笔触有力
        - Cezanne: 现代艺术先驱，结构化笔触
        - Ukiyo-e: 日本浮世绘风格，平面色彩，明显轮廓
        
        系统使用PyTorch开发，模型经过优化可在CPU上运行，但GPU会有更好的性能。
        """</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> app

<span class="token comment"># 启动Gradio应用</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    app <span class="token operator">=</span> create_gradio_app<span class="token punctuation">(</span><span class="token punctuation">)</span>
    app<span class="token punctuation">.</span>launch<span class="token punctuation">(</span>share<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 设置share=True可获得公共链接</span>
</code></pre>
    <p>
     Gradio是一个强大而简洁的工具，可以快速为深度学习模型创建交互式Web界面。上面的代码展示了如何为我们的风格转换系统创建一个用户友好的界面。
    </p>
    <p>
     <strong>
      Gradio界面功能：
     </strong>
    </p>
    <ol>
     <li>
      图像上传区域
     </li>
     <li>
      风格选择下拉菜单
     </li>
     <li>
      转换按钮
     </li>
     <li>
      结果展示区域
     </li>
     <li>
      样例图片
     </li>
    </ol>
    <h4>
     <a id="4_ONNXRuntime_399">
     </a>
     4. ONNX模型导出与Runtime部署
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> onnx
<span class="token keyword">import</span> onnxruntime <span class="token keyword">as</span> ort
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms
<span class="token keyword">import</span> time
<span class="token keyword">import</span> os

<span class="token comment"># 加载PyTorch模型</span>
<span class="token keyword">def</span> <span class="token function">load_pytorch_model</span><span class="token punctuation">(</span>model_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">from</span> model <span class="token keyword">import</span> Generator  <span class="token comment"># 假设Generator在model.py中定义</span>
    model <span class="token operator">=</span> Generator<span class="token punctuation">(</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> map_location<span class="token operator">=</span><span class="token string">'cpu'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> model

<span class="token comment"># 导出为ONNX模型</span>
<span class="token keyword">def</span> <span class="token function">export_to_onnx</span><span class="token punctuation">(</span>pytorch_model<span class="token punctuation">,</span> onnx_path<span class="token punctuation">,</span> input_shape<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 创建示例输入</span>
    dummy_input <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>input_shape<span class="token punctuation">)</span>
    
    <span class="token comment"># 导出模型</span>
    torch<span class="token punctuation">.</span>onnx<span class="token punctuation">.</span>export<span class="token punctuation">(</span>
        pytorch_model<span class="token punctuation">,</span>               <span class="token comment"># PyTorch模型</span>
        dummy_input<span class="token punctuation">,</span>                 <span class="token comment"># 示例输入</span>
        onnx_path<span class="token punctuation">,</span>                   <span class="token comment"># 输出路径</span>
        export_params<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>          <span class="token comment"># 存储训练好的参数权重</span>
        opset_version<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">,</span>            <span class="token comment"># ONNX操作集版本</span>
        do_constant_folding<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>    <span class="token comment"># 常量折叠优化</span>
        input_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'input'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>       <span class="token comment"># 输入名称</span>
        output_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token comment"># 输出名称</span>
        dynamic_axes<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>               <span class="token comment"># 动态轴（批处理维度）</span>
            <span class="token string">'input'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch_size'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">'output'</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">'batch_size'</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment"># 验证ONNX模型</span>
    onnx_model <span class="token operator">=</span> onnx<span class="token punctuation">.</span>load<span class="token punctuation">(</span>onnx_path<span class="token punctuation">)</span>
    onnx<span class="token punctuation">.</span>checker<span class="token punctuation">.</span>check_model<span class="token punctuation">(</span>onnx_model<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Model exported to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>onnx_path<span class="token punctuation">}</span></span><span class="token string"> and validated successfully"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> onnx_path

<span class="token comment"># 创建ONNX推理会话</span>
<span class="token keyword">def</span> <span class="token function">create_onnx_session</span><span class="token punctuation">(</span>onnx_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 检查可用的执行提供程序并选择最合适的</span>
    <span class="token keyword">if</span> <span class="token string">'CUDAExecutionProvider'</span> <span class="token keyword">in</span> ort<span class="token punctuation">.</span>get_available_providers<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">and</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        providers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'CUDAExecutionProvider'</span><span class="token punctuation">,</span> <span class="token string">'CPUExecutionProvider'</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Using CUDA for ONNX inference"</span><span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        providers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'CPUExecutionProvider'</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Using CPU for ONNX inference"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 创建推理会话</span>
    session_options <span class="token operator">=</span> ort<span class="token punctuation">.</span>SessionOptions<span class="token punctuation">(</span><span class="token punctuation">)</span>
    session_options<span class="token punctuation">.</span>graph_optimization_level <span class="token operator">=</span> ort<span class="token punctuation">.</span>GraphOptimizationLevel<span class="token punctuation">.</span>ORT_ENABLE_ALL
    session <span class="token operator">=</span> ort<span class="token punctuation">.</span>InferenceSession<span class="token punctuation">(</span>onnx_path<span class="token punctuation">,</span> session_options<span class="token punctuation">,</span> providers<span class="token operator">=</span>providers<span class="token punctuation">)</span>
    <span class="token keyword">return</span> session

<span class="token comment"># 使用ONNX Runtime进行推理</span>
<span class="token keyword">def</span> <span class="token function">onnx_inference</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span> image_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 图像预处理</span>
    transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
        transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 加载和预处理图像</span>
    image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>
    input_tensor <span class="token operator">=</span> transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 获取输入名称</span>
    input_name <span class="token operator">=</span> session<span class="token punctuation">.</span>get_inputs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name
    
    <span class="token comment"># 执行推理</span>
    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> session<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>input_name<span class="token punctuation">:</span> input_tensor<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    inference_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time
    
    <span class="token comment"># 后处理</span>
    output <span class="token operator">=</span> output<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> output <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span>  <span class="token comment"># 反归一化</span>
    output <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    output <span class="token operator">=</span> np<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">255.0</span>
    output_image <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>output<span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> output_image<span class="token punctuation">,</span> inference_time

<span class="token comment"># 性能比较函数：PyTorch vs ONNX</span>
<span class="token keyword">def</span> <span class="token function">compare_performance</span><span class="token punctuation">(</span>pytorch_model<span class="token punctuation">,</span> onnx_session<span class="token punctuation">,</span> image_path<span class="token punctuation">,</span> num_runs<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># PyTorch推理</span>
    pytorch_model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
        transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>image_path<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>
    input_tensor <span class="token operator">=</span> transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 预热</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        _ <span class="token operator">=</span> pytorch_model<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span>
    
    <span class="token comment"># 计时</span>
    pytorch_times <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_runs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            _ <span class="token operator">=</span> pytorch_model<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span>
        pytorch_times<span class="token punctuation">.</span>append<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span>
    
    <span class="token comment"># ONNX推理</span>
    input_name <span class="token operator">=</span> onnx_session<span class="token punctuation">.</span>get_inputs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name
    input_array <span class="token operator">=</span> input_tensor<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 预热</span>
    _ <span class="token operator">=</span> onnx_session<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>input_name<span class="token punctuation">:</span> input_array<span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 计时</span>
    onnx_times <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>num_runs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        _ <span class="token operator">=</span> onnx_session<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>input_name<span class="token punctuation">:</span> input_array<span class="token punctuation">}</span><span class="token punctuation">)</span>
        onnx_times<span class="token punctuation">.</span>append<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span>
    
    <span class="token comment"># 计算统计数据</span>
    avg_pytorch_time <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>pytorch_times<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>pytorch_times<span class="token punctuation">)</span>
    avg_onnx_time <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>onnx_times<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>onnx_times<span class="token punctuation">)</span>
    speedup <span class="token operator">=</span> avg_pytorch_time <span class="token operator">/</span> avg_onnx_time
    
    results <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'pytorch_avg_time'</span><span class="token punctuation">:</span> avg_pytorch_time<span class="token punctuation">,</span>
        <span class="token string">'onnx_avg_time'</span><span class="token punctuation">:</span> avg_onnx_time<span class="token punctuation">,</span>
        <span class="token string">'speedup'</span><span class="token punctuation">:</span> speedup
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> results

<span class="token comment"># 主函数：导出并使用ONNX模型</span>
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> onnx_path<span class="token punctuation">,</span> image_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 步骤1：加载PyTorch模型</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Loading PyTorch model..."</span><span class="token punctuation">)</span>
    pytorch_model <span class="token operator">=</span> load_pytorch_model<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span>
    
    <span class="token comment"># 步骤2：导出为ONNX</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Exporting to ONNX..."</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>onnx_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        export_to_onnx<span class="token punctuation">(</span>pytorch_model<span class="token punctuation">,</span> onnx_path<span class="token punctuation">)</span>
    
    <span class="token comment"># 步骤3：创建ONNX推理会话</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Creating ONNX inference session..."</span><span class="token punctuation">)</span>
    onnx_session <span class="token operator">=</span> create_onnx_session<span class="token punctuation">(</span>onnx_path<span class="token punctuation">)</span>
    
    <span class="token comment"># 步骤4：使用ONNX进行推理</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Running ONNX inference..."</span><span class="token punctuation">)</span>
    output_image<span class="token punctuation">,</span> inference_time <span class="token operator">=</span> onnx_inference<span class="token punctuation">(</span>onnx_session<span class="token punctuation">,</span> image_path<span class="token punctuation">)</span>
    output_image<span class="token punctuation">.</span>save<span class="token punctuation">(</span><span class="token string">'onnx_output.jpg'</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Inference completed in </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>inference_time<span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string"> seconds, result saved to onnx_output.jpg"</span></span><span class="token punctuation">)</span>
    
    <span class="token comment"># 步骤5：比较性能</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Comparing performance..."</span><span class="token punctuation">)</span>
    perf_results <span class="token operator">=</span> compare_performance<span class="token punctuation">(</span>pytorch_model<span class="token punctuation">,</span> onnx_session<span class="token punctuation">,</span> image_path<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"PyTorch average inference time: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>perf_results<span class="token punctuation">[</span><span class="token string">'pytorch_avg_time'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string"> seconds"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"ONNX average inference time: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>perf_results<span class="token punctuation">[</span><span class="token string">'onnx_avg_time'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string"> seconds"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Speedup: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>perf_results<span class="token punctuation">[</span><span class="token string">'speedup'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">x"</span></span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span>
        model_path<span class="token operator">=</span><span class="token string">"models/monet_generator.pth"</span><span class="token punctuation">,</span>
        onnx_path<span class="token operator">=</span><span class="token string">"models/monet_generator.onnx"</span><span class="token punctuation">,</span>
        image_path<span class="token operator">=</span><span class="token string">"examples/landscape.jpg"</span>
    <span class="token punctuation">)</span>
</code></pre>
    <p>
     ONNX (Open Neural Network Exchange) 是一种开放格式，用于表示深度学习模型。ONNX Runtime是一个高性能推理引擎，可以显著提高模型在生产环境中的性能。
    </p>
    <p>
     <strong>
      ONNX优势:
     </strong>
    </p>
    <ol>
     <li>
      <strong>
       跨平台兼容性
      </strong>
      : 支持多种硬件和框架
     </li>
     <li>
      <strong>
       推理性能优化
      </strong>
      : 通常比原始PyTorch模型更快
     </li>
     <li>
      <strong>
       减小模型大小
      </strong>
      : 通过量化和优化减小模型体积
     </li>
     <li>
      <strong>
       部署简化
      </strong>
      : 简化从训练到部署的流程
     </li>
    </ol>
    <h4>
     <a id="5__589">
     </a>
     5. 性能监控仪表盘实现
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">import</span> time
<span class="token keyword">import</span> threading
<span class="token keyword">import</span> queue
<span class="token keyword">import</span> streamlit <span class="token keyword">as</span> st
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> plotly<span class="token punctuation">.</span>express <span class="token keyword">as</span> px
<span class="token keyword">import</span> plotly<span class="token punctuation">.</span>graph_objects <span class="token keyword">as</span> go
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">import</span> onnxruntime <span class="token keyword">as</span> ort
<span class="token keyword">import</span> psutil
<span class="token keyword">import</span> GPUtil
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> os

<span class="token comment"># 创建队列用于存储性能数据</span>
performance_queue <span class="token operator">=</span> queue<span class="token punctuation">.</span>Queue<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 性能监控线程函数</span>
<span class="token keyword">def</span> <span class="token function">monitor_system_performance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token comment"># CPU使用率</span>
            cpu_percent <span class="token operator">=</span> psutil<span class="token punctuation">.</span>cpu_percent<span class="token punctuation">(</span>interval<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 内存使用率</span>
            memory <span class="token operator">=</span> psutil<span class="token punctuation">.</span>virtual_memory<span class="token punctuation">(</span><span class="token punctuation">)</span>
            memory_percent <span class="token operator">=</span> memory<span class="token punctuation">.</span>percent
            
            <span class="token comment"># GPU使用率（如果有GPU）</span>
            gpu_data <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                gpus <span class="token operator">=</span> GPUtil<span class="token punctuation">.</span>getGPUs<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">for</span> gpu <span class="token keyword">in</span> gpus<span class="token punctuation">:</span>
                    gpu_data<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                        <span class="token string">'id'</span><span class="token punctuation">:</span> gpu<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span>
                        <span class="token string">'load'</span><span class="token punctuation">:</span> gpu<span class="token punctuation">.</span>load <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">,</span>
                        <span class="token string">'memory_used'</span><span class="token punctuation">:</span> gpu<span class="token punctuation">.</span>memoryUsed<span class="token punctuation">,</span>
                        <span class="token string">'memory_total'</span><span class="token punctuation">:</span> gpu<span class="token punctuation">.</span>memoryTotal
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                <span class="token keyword">pass</span>
            
            <span class="token comment"># 当前时间</span>
            timestamp <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 创建性能数据点</span>
            perf_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">'timestamp'</span><span class="token punctuation">:</span> timestamp<span class="token punctuation">,</span>
                <span class="token string">'cpu_percent'</span><span class="token punctuation">:</span> cpu_percent<span class="token punctuation">,</span>
                <span class="token string">'memory_percent'</span><span class="token punctuation">:</span> memory_percent<span class="token punctuation">,</span>
                <span class="token string">'gpu_data'</span><span class="token punctuation">:</span> gpu_data
            <span class="token punctuation">}</span>
            
            <span class="token comment"># 将数据放入队列</span>
            performance_queue<span class="token punctuation">.</span>put<span class="token punctuation">(</span>perf_data<span class="token punctuation">)</span>
            
            <span class="token comment"># 每秒更新一次</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
            
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error in monitoring thread: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>

<span class="token comment"># 模型推理性能测试函数</span>
<span class="token keyword">def</span> <span class="token function">inference_performance_test</span><span class="token punctuation">(</span>onnx_session<span class="token punctuation">,</span> input_data<span class="token punctuation">,</span> n_runs<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    input_name <span class="token operator">=</span> onnx_session<span class="token punctuation">.</span>get_inputs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name
    
    <span class="token comment"># 预热</span>
    _ <span class="token operator">=</span> onnx_session<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>input_name<span class="token punctuation">:</span> input_data<span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 测量多次运行的性能</span>
    latencies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_runs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        _ <span class="token operator">=</span> onnx_session<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>input_name<span class="token punctuation">:</span> input_data<span class="token punctuation">}</span><span class="token punctuation">)</span>
        latencies<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>  <span class="token comment"># 转换为毫秒</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'mean_latency'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>latencies<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'median_latency'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>median<span class="token punctuation">(</span>latencies<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'min_latency'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>latencies<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'max_latency'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>latencies<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'p95_latency'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>percentile<span class="token punctuation">(</span>latencies<span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">'p99_latency'</span><span class="token punctuation">:</span> np<span class="token punctuation">.</span>percentile<span class="token punctuation">(</span>latencies<span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

<span class="token comment"># Streamlit仪表盘应用</span>
<span class="token keyword">def</span> <span class="token function">create_monitoring_dashboard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    st<span class="token punctuation">.</span>set_page_config<span class="token punctuation">(</span>
        page_title<span class="token operator">=</span><span class="token string">"模型性能监控仪表盘"</span><span class="token punctuation">,</span>
        page_icon<span class="token operator">=</span><span class="token string">"📊"</span><span class="token punctuation">,</span>
        layout<span class="token operator">=</span><span class="token string">"wide"</span>
    <span class="token punctuation">)</span>
    
    st<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"艺术风格转换系统 - 性能监控仪表盘"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 启动监控线程</span>
    monitor_thread <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>monitor_system_performance<span class="token punctuation">,</span> daemon<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    monitor_thread<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 存储历史数据</span>
    <span class="token keyword">if</span> <span class="token string">'history'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">:</span>
        st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>history <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'timestamp'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'cpu_percent'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'memory_percent'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'gpu_load'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">'inference_latency'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    
    <span class="token comment"># 初始化模型</span>
    <span class="token decorator annotation punctuation">@st<span class="token punctuation">.</span>cache_resource</span>
    <span class="token keyword">def</span> <span class="token function">load_model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        model_path <span class="token operator">=</span> <span class="token string">"models/monet_generator.onnx"</span>
        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>model_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 选择合适的执行提供程序</span>
            <span class="token keyword">if</span> <span class="token string">'CUDAExecutionProvider'</span> <span class="token keyword">in</span> ort<span class="token punctuation">.</span>get_available_providers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                providers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'CUDAExecutionProvider'</span><span class="token punctuation">,</span> <span class="token string">'CPUExecutionProvider'</span><span class="token punctuation">]</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                providers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'CPUExecutionProvider'</span><span class="token punctuation">]</span>
                
            session <span class="token operator">=</span> ort<span class="token punctuation">.</span>InferenceSession<span class="token punctuation">(</span>model_path<span class="token punctuation">,</span> providers<span class="token operator">=</span>providers<span class="token punctuation">)</span>
            <span class="token keyword">return</span> session
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            st<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"模型文件 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>model_path<span class="token punctuation">}</span></span><span class="token string"> 不存在!"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token boolean">None</span>
    
    onnx_session <span class="token operator">=</span> load_model<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 创建仪表盘布局</span>
    col1<span class="token punctuation">,</span> col2 <span class="token operator">=</span> st<span class="token punctuation">.</span>columns<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
    
    <span class="token keyword">with</span> col1<span class="token punctuation">:</span>
        st<span class="token punctuation">.</span>subheader<span class="token punctuation">(</span><span class="token string">"系统资源监控"</span><span class="token punctuation">)</span>
        
        <span class="token comment"># CPU利用率图表</span>
        cpu_chart <span class="token operator">=</span> st<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 内存利用率图表</span>
        memory_chart <span class="token operator">=</span> st<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>GPUtil<span class="token punctuation">.</span>getGPUs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># GPU利用率图表</span>
            gpu_chart <span class="token operator">=</span> st<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">with</span> col2<span class="token punctuation">:</span>
        st<span class="token punctuation">.</span>subheader<span class="token punctuation">(</span><span class="token string">"模型推理性能"</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 模型选择</span>
        model_options <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"monet"</span><span class="token punctuation">,</span> <span class="token string">"vangogh"</span><span class="token punctuation">,</span> <span class="token string">"cezanne"</span><span class="token punctuation">,</span> <span class="token string">"ukiyoe"</span><span class="token punctuation">]</span>
        selected_model <span class="token operator">=</span> st<span class="token punctuation">.</span>selectbox<span class="token punctuation">(</span><span class="token string">"选择模型"</span><span class="token punctuation">,</span> model_options<span class="token punctuation">)</span>
        
        <span class="token comment"># 上传测试图像</span>
        uploaded_file <span class="token operator">=</span> st<span class="token punctuation">.</span>file_uploader<span class="token punctuation">(</span><span class="token string">"上传测试图像"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"jpg"</span><span class="token punctuation">,</span> <span class="token string">"jpeg"</span><span class="token punctuation">,</span> <span class="token string">"png"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 推理性能图表</span>
        latency_chart <span class="token operator">=</span> st<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 性能详情</span>
        perf_metrics <span class="token operator">=</span> st<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 运行测试按钮</span>
        test_button <span class="token operator">=</span> st<span class="token punctuation">.</span>button<span class="token punctuation">(</span><span class="token string">"运行推理性能测试"</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 创建图表更新函数</span>
    <span class="token keyword">def</span> <span class="token function">update_charts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 从队列获取所有数据</span>
        <span class="token keyword">while</span> <span class="token keyword">not</span> performance_queue<span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                data <span class="token operator">=</span> performance_queue<span class="token punctuation">.</span>get_nowait<span class="token punctuation">(</span><span class="token punctuation">)</span>
                
                <span class="token comment"># 更新历史数据</span>
                st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'cpu_percent'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'cpu_percent'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'memory_percent'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'memory_percent'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                
                <span class="token comment"># 如果有GPU数据</span>
                <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token string">'gpu_data'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                    gpu_load <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'gpu_data'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'load'</span><span class="token punctuation">]</span>  <span class="token comment"># 假设使用第一个GPU</span>
                    st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'gpu_load'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>gpu_load<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    <span class="token comment"># 如果没有GPU，添加None或0</span>
                    st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'gpu_load'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                
                <span class="token comment"># 限制历史数据长度</span>
                max_history <span class="token operator">=</span> <span class="token number">100</span>
                <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> max_history<span class="token punctuation">:</span>
                    <span class="token keyword">for</span> key <span class="token keyword">in</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>history<span class="token punctuation">:</span>
                        st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>history<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>history<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token operator">-</span>max_history<span class="token punctuation">:</span><span class="token punctuation">]</span>
            
            <span class="token keyword">except</span> queue<span class="token punctuation">.</span>Empty<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
        
        <span class="token comment"># 创建数据框</span>
        df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>history<span class="token punctuation">)</span>
        
        <span class="token comment"># 更新CPU图表</span>
        cpu_fig <span class="token operator">=</span> px<span class="token punctuation">.</span>line<span class="token punctuation">(</span>
            df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'timestamp'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'cpu_percent'</span><span class="token punctuation">,</span>
            title<span class="token operator">=</span><span class="token string">'CPU 利用率 (%)'</span><span class="token punctuation">,</span>
            labels<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'cpu_percent'</span><span class="token punctuation">:</span> <span class="token string">'CPU %'</span><span class="token punctuation">,</span> <span class="token string">'timestamp'</span><span class="token punctuation">:</span> <span class="token string">'时间'</span><span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
        cpu_fig<span class="token punctuation">.</span>update_layout<span class="token punctuation">(</span>yaxis_range<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        cpu_chart<span class="token punctuation">.</span>plotly_chart<span class="token punctuation">(</span>cpu_fig<span class="token punctuation">,</span> use_container_width<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 更新内存图表</span>
        memory_fig <span class="token operator">=</span> px<span class="token punctuation">.</span>line<span class="token punctuation">(</span>
            df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'timestamp'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'memory_percent'</span><span class="token punctuation">,</span>
            title<span class="token operator">=</span><span class="token string">'内存利用率 (%)'</span><span class="token punctuation">,</span>
            labels<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'memory_percent'</span><span class="token punctuation">:</span> <span class="token string">'内存 %'</span><span class="token punctuation">,</span> <span class="token string">'timestamp'</span><span class="token punctuation">:</span> <span class="token string">'时间'</span><span class="token punctuation">}</span>
        <span class="token punctuation">)</span>
        memory_fig<span class="token punctuation">.</span>update_layout<span class="token punctuation">(</span>yaxis_range<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        memory_chart<span class="token punctuation">.</span>plotly_chart<span class="token punctuation">(</span>memory_fig<span class="token punctuation">,</span> use_container_width<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 如果有GPU数据，更新GPU图表</span>
        <span class="token keyword">if</span> <span class="token builtin">any</span><span class="token punctuation">(</span>GPUtil<span class="token punctuation">.</span>getGPUs<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            gpu_fig <span class="token operator">=</span> px<span class="token punctuation">.</span>line<span class="token punctuation">(</span>
                df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'timestamp'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'gpu_load'</span><span class="token punctuation">,</span>
                title<span class="token operator">=</span><span class="token string">'GPU 利用率 (%)'</span><span class="token punctuation">,</span>
                labels<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'gpu_load'</span><span class="token punctuation">:</span> <span class="token string">'GPU %'</span><span class="token punctuation">,</span> <span class="token string">'timestamp'</span><span class="token punctuation">:</span> <span class="token string">'时间'</span><span class="token punctuation">}</span>
            <span class="token punctuation">)</span>
            gpu_fig<span class="token punctuation">.</span>update_layout<span class="token punctuation">(</span>yaxis_range<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            gpu_chart<span class="token punctuation">.</span>plotly_chart<span class="token punctuation">(</span>gpu_fig<span class="token punctuation">,</span> use_container_width<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 如果有推理数据，更新推理性能图表</span>
        <span class="token keyword">if</span> <span class="token string">'inference_latency'</span> <span class="token keyword">in</span> df<span class="token punctuation">.</span>columns <span class="token keyword">and</span> <span class="token keyword">not</span> df<span class="token punctuation">[</span><span class="token string">'inference_latency'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>empty<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            latency_fig <span class="token operator">=</span> px<span class="token punctuation">.</span>line<span class="token punctuation">(</span>
                df<span class="token punctuation">,</span> x<span class="token operator">=</span><span class="token string">'timestamp'</span><span class="token punctuation">,</span> y<span class="token operator">=</span><span class="token string">'inference_latency'</span><span class="token punctuation">,</span>
                title<span class="token operator">=</span><span class="token string">'推理延迟 (ms)'</span><span class="token punctuation">,</span>
                labels<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'inference_latency'</span><span class="token punctuation">:</span> <span class="token string">'延迟 (ms)'</span><span class="token punctuation">,</span> <span class="token string">'timestamp'</span><span class="token punctuation">:</span> <span class="token string">'时间'</span><span class="token punctuation">}</span>
            <span class="token punctuation">)</span>
            latency_chart<span class="token punctuation">.</span>plotly_chart<span class="token punctuation">(</span>latency_fig<span class="token punctuation">,</span> use_container_width<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 处理推理性能测试</span>
    <span class="token keyword">if</span> test_button <span class="token keyword">and</span> uploaded_file <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">and</span> onnx_session <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">with</span> st<span class="token punctuation">.</span>spinner<span class="token punctuation">(</span><span class="token string">"运行推理性能测试中..."</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 处理上传的图像</span>
            image <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>uploaded_file<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 预处理</span>
            <span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms
            transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
                transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">]</span><span class="token punctuation">)</span>
            input_tensor <span class="token operator">=</span> transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 运行性能测试</span>
            perf_results <span class="token operator">=</span> inference_performance_test<span class="token punctuation">(</span>onnx_session<span class="token punctuation">,</span> input_tensor<span class="token punctuation">,</span> n_runs<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
            
            <span class="token comment"># 展示性能指标</span>
            col1<span class="token punctuation">,</span> col2<span class="token punctuation">,</span> col3 <span class="token operator">=</span> perf_metrics<span class="token punctuation">.</span>columns<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
            col1<span class="token punctuation">.</span>metric<span class="token punctuation">(</span><span class="token string">"平均延迟 (ms)"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>perf_results<span class="token punctuation">[</span><span class="token string">'mean_latency'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            col2<span class="token punctuation">.</span>metric<span class="token punctuation">(</span><span class="token string">"中位延迟 (ms)"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>perf_results<span class="token punctuation">[</span><span class="token string">'median_latency'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            col3<span class="token punctuation">.</span>metric<span class="token punctuation">(</span><span class="token string">"P95延迟 (ms)"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>perf_results<span class="token punctuation">[</span><span class="token string">'p95_latency'</span><span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token format-spec">.2f</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            
            <span class="token comment"># 记录推理延迟历史</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                st<span class="token punctuation">.</span>session_state<span class="token punctuation">.</span>history<span class="token punctuation">[</span><span class="token string">'inference_latency'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>perf_results<span class="token punctuation">[</span><span class="token string">'mean_latency'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 定期更新图表</span>
    update_charts<span class="token punctuation">(</span><span class="token punctuation">)</span>
    time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">)</span>
    st<span class="token punctuation">.</span>experimental_rerun<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 主函数</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    create_monitoring_dashboard<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     现在让我完成关于CI/CD流水线与单元测试的部分：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">name</span><span class="token punctuation">:</span> Style Transfer CI/CD Pipeline

<span class="token key atrule">on</span><span class="token punctuation">:</span>
  <span class="token key atrule">push</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> main<span class="token punctuation">,</span> develop <span class="token punctuation">]</span>
  <span class="token key atrule">pull_request</span><span class="token punctuation">:</span>
    <span class="token key atrule">branches</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> main<span class="token punctuation">,</span> develop <span class="token punctuation">]</span>

<span class="token key atrule">jobs</span><span class="token punctuation">:</span>
  <span class="token key atrule">test</span><span class="token punctuation">:</span>
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v3
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Python
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>python@v4
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">python-version</span><span class="token punctuation">:</span> <span class="token string">'3.9'</span>
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install dependencies
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        python -m pip install --upgrade pip
        pip install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cpu
        pip install pytest pytest-cov flake8 black isort
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi</span>
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Lint with flake8
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics</span>
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Format check with black
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        black --check .</span>
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Import order check with isort
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        isort --check-only --profile black .</span>
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run unit tests
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        pytest --cov=./ --cov-report=xml</span>
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Upload coverage to Codecov
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> codecov/codecov<span class="token punctuation">-</span>action@v3
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">file</span><span class="token punctuation">:</span> ./coverage.xml
        <span class="token key atrule">fail_ci_if_error</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>

  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">needs</span><span class="token punctuation">:</span> test
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">if</span><span class="token punctuation">:</span> github.event_name == 'push' <span class="token important">&amp;&amp;</span> (github.ref == 'refs/heads/main' <span class="token punctuation">|</span><span class="token punctuation">|</span> github.ref == 'refs/heads/develop')
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v3
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Python
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>python@v4
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">python-version</span><span class="token punctuation">:</span> <span class="token string">'3.9'</span>
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install dependencies
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        python -m pip install --upgrade pip
        pip install torch torchvision torchaudio --extra-index-url https://download.pytorch.org/whl/cpu
        pip install -r requirements.txt
        pip install onnx onnxruntime</span>
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build and export ONNX models
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        python scripts/export_models.py</span>
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Package application
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        mkdir -p release
        cp -r models release/
        cp -r scripts release/
        cp -r app.py release/
        cp -r requirements.txt release/
        tar -czvf style-transfer-app.tar.gz release/</span>
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Upload artifacts
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/upload<span class="token punctuation">-</span>artifact@v3
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> style<span class="token punctuation">-</span>transfer<span class="token punctuation">-</span>app
        <span class="token key atrule">path</span><span class="token punctuation">:</span> style<span class="token punctuation">-</span>transfer<span class="token punctuation">-</span>app.tar.gz

  <span class="token key atrule">deploy</span><span class="token punctuation">:</span>
    <span class="token key atrule">needs</span><span class="token punctuation">:</span> build
    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest
    <span class="token key atrule">if</span><span class="token punctuation">:</span> github.event_name == 'push' <span class="token important">&amp;&amp;</span> github.ref == 'refs/heads/main'
    <span class="token key atrule">steps</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v3
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Download artifact
      <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/download<span class="token punctuation">-</span>artifact@v3
      <span class="token key atrule">with</span><span class="token punctuation">:</span>
        <span class="token key atrule">name</span><span class="token punctuation">:</span> style<span class="token punctuation">-</span>transfer<span class="token punctuation">-</span>app
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy to staging
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        # 这里可以添加部署到测试环境的脚本
        echo "Deploying to staging environment"</span>
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Run integration tests
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        # 在测试环境运行集成测试
        echo "Running integration tests"</span>
    
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Deploy to production
      <span class="token key atrule">if</span><span class="token punctuation">:</span> success()
      <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
        # 部署到生产环境
        echo "Deploying to production environment"</span>
</code></pre>
    <pre><code class="prism language-python"><span class="token keyword">import</span> pytest
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> os
<span class="token keyword">import</span> sys
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image

<span class="token comment"># 添加项目根目录到系统路径</span>
sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 导入模型和工具函数</span>
<span class="token keyword">from</span> models<span class="token punctuation">.</span>generator <span class="token keyword">import</span> Generator
<span class="token keyword">from</span> models<span class="token punctuation">.</span>discriminator <span class="token keyword">import</span> Discriminator
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>transforms <span class="token keyword">import</span> preprocess_image<span class="token punctuation">,</span> postprocess_image
<span class="token keyword">from</span> utils<span class="token punctuation">.</span>onnx_utils <span class="token keyword">import</span> export_to_onnx

<span class="token keyword">class</span> <span class="token class-name">TestGenerator</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span>
    <span class="token keyword">def</span> <span class="token function">generator</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""创建一个测试用的生成器实例"""</span>
        <span class="token keyword">return</span> Generator<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">test_generator_output_shape</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> generator<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""测试生成器输出的形状是否正确"""</span>
        batch_size <span class="token operator">=</span> <span class="token number">2</span>
        input_shape <span class="token operator">=</span> <span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>input_shape<span class="token punctuation">)</span>
        output <span class="token operator">=</span> generator<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        
        <span class="token comment"># 检查输出形状是否与输入一致</span>
        <span class="token keyword">assert</span> output<span class="token punctuation">.</span>shape <span class="token operator">==</span> input_shape
        
    <span class="token keyword">def</span> <span class="token function">test_generator_output_range</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> generator<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""测试生成器输出的值域是否在[-1, 1]之间"""</span>
        batch_size <span class="token operator">=</span> <span class="token number">2</span>
        input_shape <span class="token operator">=</span> <span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>input_shape<span class="token punctuation">)</span>
        
        <span class="token comment"># 确保输入在合理范围内</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>clamp<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        
        output <span class="token operator">=</span> generator<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        
        <span class="token comment"># 检查输出在[-1.1, 1.1]范围内（允许一点数值误差）</span>
        <span class="token keyword">assert</span> output<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token operator">-</span><span class="token number">1.1</span>
        <span class="token keyword">assert</span> output<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1.1</span>

<span class="token keyword">class</span> <span class="token class-name">TestDiscriminator</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span>
    <span class="token keyword">def</span> <span class="token function">discriminator</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""创建一个测试用的判别器实例"""</span>
        <span class="token keyword">return</span> Discriminator<span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">test_discriminator_output_shape</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> discriminator<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""测试判别器输出的形状是否正确"""</span>
        batch_size <span class="token operator">=</span> <span class="token number">2</span>
        input_shape <span class="token operator">=</span> <span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span>input_shape<span class="token punctuation">)</span>
        output <span class="token operator">=</span> discriminator<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        
        <span class="token comment"># PatchGAN判别器输出应该是(batch_size, 1, H/16, W/16)</span>
        expected_shape <span class="token operator">=</span> <span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token operator">//</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token operator">//</span><span class="token number">16</span><span class="token punctuation">)</span>
        <span class="token keyword">assert</span> output<span class="token punctuation">.</span>shape <span class="token operator">==</span> expected_shape

<span class="token keyword">class</span> <span class="token class-name">TestImageProcessing</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span>
    <span class="token keyword">def</span> <span class="token function">sample_image</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""创建一个测试用的样例图像"""</span>
        <span class="token comment"># 创建一个简单的RGB图像</span>
        img <span class="token operator">=</span> np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
        img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 左上角是红色</span>
        img<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 左下角是绿色</span>
        img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">]</span>  <span class="token comment"># 右上角是蓝色</span>
        img<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>  <span class="token comment"># 右下角是黄色</span>
        <span class="token keyword">return</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">test_preprocess_image</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sample_image<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""测试图像预处理函数"""</span>
        tensor <span class="token operator">=</span> preprocess_image<span class="token punctuation">(</span>sample_image<span class="token punctuation">)</span>
        
        <span class="token comment"># 检查输出是否为PyTorch张量</span>
        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>tensor<span class="token punctuation">,</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span>
        
        <span class="token comment"># 检查形状是否正确 (C, H, W)</span>
        <span class="token keyword">assert</span> tensor<span class="token punctuation">.</span>dim<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span>
        <span class="token keyword">assert</span> tensor<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">3</span>  <span class="token comment"># RGB通道</span>
        
        <span class="token comment"># 检查值域是否在[-1, 1]之间</span>
        <span class="token keyword">assert</span> tensor<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token operator">-</span><span class="token number">1.1</span>
        <span class="token keyword">assert</span> tensor<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1.1</span>
    
    <span class="token keyword">def</span> <span class="token function">test_postprocess_image</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""测试图像后处理函数"""</span>
        <span class="token comment"># 创建一个在[-1, 1]范围内的张量</span>
        tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span>
        
        img <span class="token operator">=</span> postprocess_image<span class="token punctuation">(</span>tensor<span class="token punctuation">)</span>
        
        <span class="token comment"># 检查输出是否为PIL图像</span>
        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> Image<span class="token punctuation">.</span>Image<span class="token punctuation">)</span>
        
        <span class="token comment"># 检查图像大小是否正确</span>
        <span class="token keyword">assert</span> img<span class="token punctuation">.</span>size <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 检查图像模式是否为RGB</span>
        <span class="token keyword">assert</span> img<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token string">"RGB"</span>

<span class="token keyword">class</span> <span class="token class-name">TestONNXExport</span><span class="token punctuation">:</span>
    <span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>fixture</span>
    <span class="token keyword">def</span> <span class="token function">temp_onnx_path</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> tmp_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""创建临时文件路径用于ONNX模型导出"""</span>
        <span class="token keyword">return</span> <span class="token builtin">str</span><span class="token punctuation">(</span>tmp_path <span class="token operator">/</span> <span class="token string">"temp_model.onnx"</span><span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">test_onnx_export</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> temp_onnx_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""测试ONNX模型导出功能"""</span>
        <span class="token comment"># 跳过如果没有安装onnx</span>
        pytest<span class="token punctuation">.</span>importorskip<span class="token punctuation">(</span><span class="token string">"onnx"</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 创建一个简单的模型</span>
        generator <span class="token operator">=</span> Generator<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 导出模型</span>
        success <span class="token operator">=</span> export_to_onnx<span class="token punctuation">(</span>generator<span class="token punctuation">,</span> temp_onnx_path<span class="token punctuation">)</span>
        
        <span class="token comment"># 检查导出是否成功</span>
        <span class="token keyword">assert</span> success
        
        <span class="token comment"># 检查文件是否存在</span>
        <span class="token keyword">assert</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>temp_onnx_path<span class="token punctuation">)</span>
        
        <span class="token comment"># 检查文件大小是否合理 (至少1MB)</span>
        <span class="token keyword">assert</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getsize<span class="token punctuation">(</span>temp_onnx_path<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1_000_000</span>

<span class="token keyword">class</span> <span class="token class-name">TestCycleGANTraining</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">test_cycle_consistency_loss</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""测试循环一致性损失计算是否正确"""</span>
        <span class="token keyword">from</span> utils<span class="token punctuation">.</span>losses <span class="token keyword">import</span> cycle_consistency_loss
        
        <span class="token comment"># 创建示例数据</span>
        real_images <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        cycled_images <span class="token operator">=</span> real_images <span class="token operator">+</span> <span class="token number">0.1</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 计算损失</span>
        loss <span class="token operator">=</span> cycle_consistency_loss<span class="token punctuation">(</span>real_images<span class="token punctuation">,</span> cycled_images<span class="token punctuation">)</span>
        
        <span class="token comment"># 损失应该是正数</span>
        <span class="token keyword">assert</span> loss <span class="token operator">&gt;</span> <span class="token number">0</span>
        
        <span class="token comment"># 相同图像的损失应该为0</span>
        identical_loss <span class="token operator">=</span> cycle_consistency_loss<span class="token punctuation">(</span>real_images<span class="token punctuation">,</span> real_images<span class="token punctuation">)</span>
        <span class="token keyword">assert</span> identical_loss <span class="token operator">&lt;</span> <span class="token number">1e-5</span>

    <span class="token keyword">def</span> <span class="token function">test_identity_loss</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""测试身份映射损失计算是否正确"""</span>
        <span class="token keyword">from</span> utils<span class="token punctuation">.</span>losses <span class="token keyword">import</span> identity_mapping_loss
        
        <span class="token comment"># 创建示例数据</span>
        real_images <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        identity_mapped <span class="token operator">=</span> real_images <span class="token operator">+</span> <span class="token number">0.1</span> <span class="token operator">*</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 计算损失</span>
        loss <span class="token operator">=</span> identity_mapping_loss<span class="token punctuation">(</span>real_images<span class="token punctuation">,</span> identity_mapped<span class="token punctuation">)</span>
        
        <span class="token comment"># 损失应该是正数</span>
        <span class="token keyword">assert</span> loss <span class="token operator">&gt;</span> <span class="token number">0</span>
        
        <span class="token comment"># 相同图像的损失应该为0</span>
        identical_loss <span class="token operator">=</span> identity_mapping_loss<span class="token punctuation">(</span>real_images<span class="token punctuation">,</span> real_images<span class="token punctuation">)</span>
        <span class="token keyword">assert</span> identical_loss <span class="token operator">&lt;</span> <span class="token number">1e-5</span>

<span class="token comment"># 集成测试</span>
<span class="token keyword">class</span> <span class="token class-name">TestEndToEnd</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">test_style_transfer_pipeline</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> monkeypatch<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""测试完整的风格转换流程"""</span>
        <span class="token comment"># 模拟图像处理和模型推理</span>
        <span class="token keyword">def</span> <span class="token function">mock_load_image</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">'white'</span><span class="token punctuation">)</span>
        
        <span class="token keyword">def</span> <span class="token function">mock_inference</span><span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment"># 返回一个随机图像</span>
            tensor <span class="token operator">=</span> torch<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">2</span> <span class="token operator">-</span> <span class="token number">1</span>
            <span class="token keyword">return</span> postprocess_image<span class="token punctuation">(</span>tensor<span class="token punctuation">)</span>
        
        <span class="token comment"># 打补丁替换真实函数</span>
        <span class="token keyword">import</span> utils<span class="token punctuation">.</span>image_utils
        monkeypatch<span class="token punctuation">.</span><span class="token builtin">setattr</span><span class="token punctuation">(</span>utils<span class="token punctuation">.</span>image_utils<span class="token punctuation">,</span> <span class="token string">"load_image"</span><span class="token punctuation">,</span> mock_load_image<span class="token punctuation">)</span>
        monkeypatch<span class="token punctuation">.</span><span class="token builtin">setattr</span><span class="token punctuation">(</span>utils<span class="token punctuation">.</span>inference<span class="token punctuation">,</span> <span class="token string">"run_inference"</span><span class="token punctuation">,</span> mock_inference<span class="token punctuation">)</span>
        
        <span class="token comment"># 测试端到端流程</span>
        <span class="token keyword">from</span> pipeline <span class="token keyword">import</span> StyleTransferPipeline
        
        pipeline <span class="token operator">=</span> StyleTransferPipeline<span class="token punctuation">(</span>style<span class="token operator">=</span><span class="token string">"monet"</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> pipeline<span class="token punctuation">.</span>process<span class="token punctuation">(</span><span class="token string">"dummy_input.jpg"</span><span class="token punctuation">)</span>
        
        <span class="token comment"># 检查结果是否为PIL图像</span>
        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> Image<span class="token punctuation">.</span>Image<span class="token punctuation">)</span>
        
        <span class="token comment"># 检查图像尺寸</span>
        <span class="token keyword">assert</span> result<span class="token punctuation">.</span>size <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    pytest<span class="token punctuation">.</span>main<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"-v"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0d43d2b71ade41358137e07961918407.png"/>
    </p>
    <h3>
     <a id="_1188">
     </a>
     完整学习计划总结
    </h3>
    <p>
     今天我们学习了如何构建一个完整的端到端图像生成系统，将CycleGAN和风格迁移技术结合起来，并通过多种工程实践实现了高效的训练、部署和监控。
    </p>
    <h4>
     <a id="1_CycleGAN_1192">
     </a>
     1. CycleGAN与风格迁移结合
    </h4>
    <p>
     我们回顾了CycleGAN的核心原理，它通过两个生成器和两个判别器实现了无配对数据的域间转换，同时引入了循环一致性损失和身份映射损失来保证转换质量。风格迁移的核心在于内容损失和风格损失，通过Gram矩阵计算实现了风格特征的提取和应用。
    </p>
    <p>
     这两种技术结合后，我们能够创建一个灵活的艺术风格转换系统，既能够保持内容的完整性，又能够应用多种艺术风格。
    </p>
    <h4>
     <a id="2_GPU_1198">
     </a>
     2. 多GPU训练与混合精度训练
    </h4>
    <p>
     为了加速模型训练，我们使用了PyTorch的
     <code>
      DistributedDataParallel
     </code>
     实现数据并行训练，让多个GPU同时处理不同的数据批次。同时，我们引入了混合精度训练，使用
     <code>
      torch.cuda.amp
     </code>
     模块的
     <code>
      autocast
     </code>
     和
     <code>
      GradScaler
     </code>
     ，通过FP16和FP32混合计算大幅提高训练速度，减少内存使用。
    </p>
    <h4>
     <a id="3_Gradio_1202">
     </a>
     3. Gradio交互式界面
    </h4>
    <p>
     我们通过Gradio创建了一个简洁而强大的Web界面，支持图像上传、风格选择和结果展示，大大提高了系统的可用性。Gradio的优势在于快速开发、易于部署，适合AI应用的原型开发和演示。
    </p>
    <h4>
     <a id="4_ONNX_1206">
     </a>
     4. ONNX模型导出与优化
    </h4>
    <p>
     通过将PyTorch模型导出为ONNX格式，我们实现了跨平台的模型部署，并通过ONNX Runtime显著提高了推理速度。ONNX的图优化和算子融合功能进一步提升了模型性能，同时通过量化技术减小了模型体积。
    </p>
    <h4>
     <a id="5__1210">
     </a>
     5. 性能监控仪表盘
    </h4>
    <p>
     使用Streamlit构建了实时性能监控仪表盘，跟踪CPU、内存、GPU使用率和推理延迟等关键指标，帮助识别性能瓶颈并优化系统表现。
    </p>
    <h4>
     <a id="6_CICD_1214">
     </a>
     6. CI/CD流水线与单元测试
    </h4>
    <p>
     构建了完整的CI/CD流水线，包括代码质量检查、单元测试、构建与打包、部署到测试环境和生产环境。同时，编写了全面的单元测试用例，覆盖了模型结构、图像处理、损失计算等核心功能，保证了代码质量和系统稳定性。
    </p>
    <h3>
     <a id="_1218">
     </a>
     实战项目演示流程
    </h3>
    <ol>
     <li>
      <strong>
       环境准备
      </strong>
      ：安装PyTorch、ONNX、Gradio等依赖
     </li>
     <li>
      <strong>
       模型训练
      </strong>
      ：使用多GPU和混合精度训练CycleGAN模型
     </li>
     <li>
      <strong>
       模型优化
      </strong>
      ：导出为ONNX并使用Runtime加速
     </li>
     <li>
      <strong>
       交互界面
      </strong>
      ：启动Gradio界面进行演示
     </li>
     <li>
      <strong>
       性能监控
      </strong>
      ：启动监控仪表盘观察系统性能
     </li>
     <li>
      <strong>
       CI/CD部署
      </strong>
      ：通过GitHub Actions自动部署
     </li>
    </ol>
    <hr/>
    <p>
     <strong>
      清华大学全三版的《DeepSeek教程》完整的文档需要的朋友，关注我私信：deepseek 即可获得。
     </strong>
    </p>
    <p>
     <strong>
      怎么样今天的内容还满意吗？再次感谢朋友们的观看，关注GZH：凡人的AI工具箱，回复666，送您价值199的AI大礼包。最后，祝您早日实现财务自由，还请给个赞，谢谢！
     </strong>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34303738303137382f:61727469636c652f64657461696c732f313436313935333030" class_="artid" style="display:none">
 </p>
</div>


