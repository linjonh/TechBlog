---
arturl_encode: "68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f37373634353537332f:61727469636c652f64657461696c732f313436323037303139"
layout: post
title: "SeleniumPytest自动化测试框架实战"
date: 2025-03-12 15:43:17 +0800
description: "首先我们上述这种较为原始的方法，基本不适用于平时做UI自动化测试的，因为在UI界面实际运行情况远远比较复杂，可能因为网络原因，或者控件原因，我们元素还没有显示出来，就进行点击或者输入。以上四种代码主体进行了拆分，虽然在用例很少的情况下做会增加代码，但是当用例多的时候意义很大，代码量会在用例增加的时候显著减少。但是还有一个问题，我们怎么样才能确保我们写的每一项元素不出错，人为的错误是不可避免的，但是我们可以通过代码来运行对文件的审查。在这个文件中我们可以设置自己的各个目录，也可以查看自己当前的目录。"
keywords: "Selenium+Pytest自动化测试框架实战"
categories: ['未分类']
tags: ['测试工具', 'Selenium', 'Pytest']
artid: "146207019"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146207019
    alt: "SeleniumPytest自动化测试框架实战"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146207019
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146207019
cover: https://bing.ee123.net/img/rand?artid=146207019
image: https://bing.ee123.net/img/rand?artid=146207019
img: https://bing.ee123.net/img/rand?artid=146207019
---

# Selenium+Pytest自动化测试框架实战

#### **前言**

selenium自动化+ pytest测试框架

**本章你需要**

* 一定的
  [python基础](https://so.csdn.net/so/search?q=python%E5%9F%BA%E7%A1%80&spm=1001.2101.3001.7020 "python基础")
  ——至少明白类与对象，封装继承
* 一定的selenium基础——本篇不讲selenium

---

#### **测试框架简介**

* **测试框架有什么优点呢：**

  + 代码复用率高，如果不使用框架的话，代码会很冗余
  + 可以组装日志、报告、邮件等一些高级功能
  + 提高元素等数据的可维护性，元素发生变化时，只需要更新一下配置文件
  + 使用更灵活的PageObject设计模式
* **测试框架的整体目录**

  | 目录/文件 | 说明 | 是否为python包 |
  | --- | --- | --- |
  | common | 这个包中存放的是常见的通用的类，如读取配置文件 | 是 |
  | config | 配置文件目录 | 是 |
  | logs | 日志目录 |  |
  | page | 对selenium的方放进行深度的封装 | 是 |
  | page\_element | 页面元素存放目录 |  |
  | page\_object | 页面对象POM设计模式，本人对这个的理解来自于 [苦叶子](https://www.cnblogs.com/lym51/p/6646033.html "苦叶子") 的博客 | 是 |
  | TestCase | 所有的测试用例集 | 是 |
  | utils | 工具类 | 是 |
  | script | 脚本文件 |  |
  | conftest.py | pytest胶水文件 |  |
  | pytest.ini | pytest配置文件 |  |

**这样一个简单的框架结构就清晰了。**

知道了以上这些我们就开始吧！

**我们在项目中先按照上面的框架指引，建好每一项目录。**

注意：python包为是的，都需要添加一个
`__init__.py`
文件以标识此目录为一个python包。

---

#### **首先管理时间 [#](https://www.cnblogs.com/wxhou/p/selenium-pytest-test-framework.html#%E9%A6%96%E5%85%88%E7%AE%A1%E7%90%86%E6%97%B6%E9%97%B4 "#")**

首先呢，因为我们很多的模块会用到时间戳，或者日期等等字符串，所以我们先单独把时间封装成一个模块。

然后让其他模块来调用即可。在
`utils`
目录新建
`times.py`
模块

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-python"><span style="color:#5c6370"><em>#!/usr/bin/env python3</em></span>`
2. `<span style="color:#5c6370"><em># -*- coding:utf-8 -*-</em></span>`
3. `<span style="color:#7171bf">import</span> time`
4. `<span style="color:#7171bf">import</span> datetime`
5. `<span style="color:#7171bf">from</span> functools <span style="color:#7171bf">import</span> wraps`

8. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">timestamp</span>():`
9. `<span style="color:#98c379">"""时间戳"""</span>`
10. `<span style="color:#7171bf">return</span> time.time()`

13. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">dt_strftime</span>(fmt=<span style="color:#98c379">"%Y%m"</span>):`
14. `<span style="color:#98c379">"""`
15. `datetime格式化时间`
16. `:param fmt "%Y%m%d %H%M%S`
17. `"""</span>`
18. `<span style="color:#7171bf">return</span> datetime.datetime.now().strftime(fmt)`

21. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">sleep</span>(seconds=<span style="color:#d19a66">1.0</span>):`
22. `<span style="color:#98c379">"""`
23. `睡眠时间`
24. `"""</span>`
25. `time.sleep(seconds)`

28. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">running_time</span>(func):`
29. `<span style="color:#98c379">"""函数运行时间"""</span>`
31. `<span style="color:#61aeee"> @wraps(func)</span>`
32. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">wrapper</span>(*args, **kwargs):`
33. `start = timestamp()`
34. `res = func(*args, **kwargs)`
35. `<span style="color:#7171bf">print</span>(<span style="color:#98c379">"校验元素done！用时%.3f秒！"</span> % (timestamp() - start))`
36. `<span style="color:#7171bf">return</span> res`
38. `<span style="color:#7171bf">return</span> wrapper`

41. `<span style="color:#7171bf">if</span> __name__ == <span style="color:#98c379">'__main__'</span>:`
42. `<span style="color:#7171bf">print</span>(dt_strftime(<span style="color:#98c379">"%Y%m%d%H%M%S"</span>))`
44. `</code></span></span>`

![](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblogv2%2Fdist%2Fpc%2Fimg%2FnewCodeMoreWhite.png&pos_id=4s868RZz)

---

#### **添加配置文件**

配置文件总是项目中必不可少的部分！

将固定不变的信息集中在固定的文件中

##### **conf.py**

> 项目中都应该有一个文件对整体的目录进行管理，我也在这个python项目中设置了此文件。

在项目
`config`
目录创建
`conf.py`
文件，所有的目录配置信息写在这个文件里面。

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-python"><span style="color:#5c6370"><em>#!/usr/bin/env python3</em></span>`
2. `<span style="color:#5c6370"><em># -*- coding:utf-8 -*-</em></span>`
3. `<span style="color:#7171bf">import</span> os`
4. `<span style="color:#7171bf">from</span> selenium.webdriver.common.by <span style="color:#7171bf">import</span> By`
5. `<span style="color:#7171bf">from</span> utils.times <span style="color:#7171bf">import</span> dt_strftime`

8. `<span style="color:#7171bf">class</span> <span style="color:#61aeee">ConfigManager</span>(<span style="color:#61aeee">object</span>):`
9. `<span style="color:#5c6370"><em># 项目目录</em></span>`
10. `BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))`
12. `<span style="color:#5c6370"><em># 页面元素目录</em></span>`
13. `ELEMENT_PATH = os.path.join(BASE_DIR, <span style="color:#98c379">'page_element'</span>)`
15. `<span style="color:#5c6370"><em># 报告文件</em></span>`
16. `REPORT_FILE = os.path.join(BASE_DIR, <span style="color:#98c379">'report.html'</span>)`
18. `<span style="color:#5c6370"><em># 元素定位的类型</em></span>`
19. `LOCATE_MODE = {`
20. `<span style="color:#98c379">'css'</span>: By.CSS_SELECTOR,`
21. `<span style="color:#98c379">'xpath'</span>: By.XPATH,`
22. `<span style="color:#98c379">'name'</span>: By.NAME,`
23. `<span style="color:#98c379">'id'</span>: By.ID,`
24. `<span style="color:#98c379">'class'</span>: By.CLASS_NAME`
25. `}`
27. `<span style="color:#5c6370"><em># 邮件信息</em></span>`
28. `EMAIL_INFO = {`
29. `<span style="color:#98c379">'username'</span>: <span style="color:#98c379">'1084502012@qq.com'</span>, <span style="color:#5c6370"><em># 切换成你自己的地址</em></span>`
30. `<span style="color:#98c379">'password'</span>: <span style="color:#98c379">'QQ邮箱授权码'</span>,`
31. `<span style="color:#98c379">'smtp_host'</span>: <span style="color:#98c379">'smtp.qq.com'</span>,`
32. `<span style="color:#98c379">'smtp_port'</span>: <span style="color:#d19a66">465</span>`
33. `}`
35. `<span style="color:#5c6370"><em># 收件人</em></span>`
36. `ADDRESSEE = [`
37. `<span style="color:#98c379">'1084502012@qq.com'</span>,`
38. `]`
40. `<span style="color:#61aeee"> @property</span>`
41. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">log_file</span>(self):`
42. `<span style="color:#98c379">"""日志目录"""</span>`
43. `log_dir = os.path.join(self.BASE_DIR, <span style="color:#98c379">'logs'</span>)`
44. `<span style="color:#7171bf">if</span> <span style="color:#7171bf">not</span> os.path.exists(log_dir):`
45. `os.makedirs(log_dir)`
46. `<span style="color:#7171bf">return</span> os.path.join(log_dir, <span style="color:#98c379">'{}.log'</span>.<span style="color:#7171bf">format</span>(dt_strftime()))`
48. `<span style="color:#61aeee"> @property</span>`
49. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">ini_file</span>(self):`
50. `<span style="color:#98c379">"""配置文件"""</span>`
51. `ini_file = os.path.join(self.BASE_DIR, <span style="color:#98c379">'config'</span>, <span style="color:#98c379">'config.ini'</span>)`
52. `<span style="color:#7171bf">if</span> <span style="color:#7171bf">not</span> os.path.exists(ini_file):`
53. `<span style="color:#7171bf">raise</span> FileNotFoundError(<span style="color:#98c379">"配置文件%s不存在！"</span> % ini_file)`
54. `<span style="color:#7171bf">return</span> ini_file`

57. `cm = ConfigManager()`
58. `<span style="color:#7171bf">if</span> __name__ == <span style="color:#98c379">'__main__'</span>:`
59. `<span style="color:#7171bf">print</span>(cm.BASE_DIR)`
60. `</code></span></span>`

![](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblogv2%2Fdist%2Fpc%2Fimg%2FnewCodeMoreWhite.png&pos_id=xwHl4M4A)

> 这个conf文件我模仿了Django的settings.py文件的设置风格，但是又有些许差异。

在这个文件中我们可以设置自己的各个目录，也可以查看自己当前的目录。

遵循了约定：不变的常量名全部大写，函数名小写。看起来整体美观。

##### **config.ini**

在项目
`config`
目录新建一个
`config.ini`
文件，里面暂时先放入我们的需要测试的URL

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-ini"><span style="color:#e06c75">[HOST]</span>`
2. `<span style="color:#d19a66">HOST</span> = https://www.baidu.com`
3. `</code></span></span>`

##### **读取配置文件**

配置文件创建好了，接下来我们需要读取这个配置文件以使用里面的信息。

我们在
`common`
目录中新建一个
`readconfig.py`
文件

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-python"><span style="color:#5c6370"><em>#!/usr/bin/env python3</em></span>`
2. `<span style="color:#5c6370"><em># -*- coding:utf-8 -*-</em></span>`
3. `<span style="color:#7171bf">import</span> configparser`
4. `<span style="color:#7171bf">from</span> config.conf <span style="color:#7171bf">import</span> cm`
6. `HOST = <span style="color:#98c379">'HOST'</span>`

9. `<span style="color:#7171bf">class</span> <span style="color:#61aeee">ReadConfig</span>(<span style="color:#61aeee">object</span>):`
10. `<span style="color:#98c379">"""配置文件"""</span>`
12. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">__init__</span>(self):`
13. `self.config = configparser.RawConfigParser() <span style="color:#5c6370"><em># 当有%的符号时请使用Raw读取</em></span>`
14. `self.config.read(cm.ini_file, encoding=<span style="color:#98c379">'utf-8'</span>)`
16. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">_get</span>(self, section, option):`
17. `<span style="color:#98c379">"""获取"""</span>`
18. `<span style="color:#7171bf">return</span> self.config.get(section, option)`
20. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">_set</span>(self, section, option, value):`
21. `<span style="color:#98c379">"""更新"""</span>`
22. `self.config.<span style="color:#7171bf">set</span>(section, option, value)`
23. `<span style="color:#7171bf">with</span> <span style="color:#7171bf">open</span>(cm.ini_file, <span style="color:#98c379">'w'</span>) <span style="color:#7171bf">as</span> f:`
24. `self.config.write(f)`
26. `<span style="color:#61aeee"> @property</span>`
27. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">url</span>(self):`
28. `<span style="color:#7171bf">return</span> self._get(HOST, HOST)`

31. `ini = ReadConfig()`
33. `<span style="color:#7171bf">if</span> __name__ == <span style="color:#98c379">'__main__'</span>:`
34. `<span style="color:#7171bf">print</span>(ini.url)`
35. `</code></span></span>`

![](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblogv2%2Fdist%2Fpc%2Fimg%2FnewCodeMoreWhite.png&pos_id=d4SvEj1r)

可以看到我们用python内置的configparser模块对
`config.ini`
文件进行了读取。

对于url值的提取，我使用了高阶语法
`@property`
属性值，写法更简单。

---

#### **记录操作日志**

日志，大家应该都很熟悉这个名词，就是记录代码中的动作。

在
`utils`
目录中新建
`logger.py`
文件。

这个文件就是我们用来在自动化测试过程中记录一些操作步骤的。

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-python"><span style="color:#5c6370"><em>#!/usr/bin/env python3</em></span>`
2. `<span style="color:#5c6370"><em># -*- coding:utf-8 -*-</em></span>`
3. `<span style="color:#7171bf">import</span> logging`
4. `<span style="color:#7171bf">from</span> config.conf <span style="color:#7171bf">import</span> cm`

7. `<span style="color:#7171bf">class</span> <span style="color:#61aeee">Log</span>:`
8. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">__init__</span>(self):`
9. `self.logger = logging.getLogger()`
10. `<span style="color:#7171bf">if</span> <span style="color:#7171bf">not</span> self.logger.handlers:`
11. `self.logger.setLevel(logging.DEBUG)`
13. `<span style="color:#5c6370"><em># 创建一个handle写入文件</em></span>`
14. `fh = logging.FileHandler(cm.log_file, encoding=<span style="color:#98c379">'utf-8'</span>)`
15. `fh.setLevel(logging.INFO)`
17. `<span style="color:#5c6370"><em># 创建一个handle输出到控制台</em></span>`
18. `ch = logging.StreamHandler()`
19. `ch.setLevel(logging.INFO)`
21. `<span style="color:#5c6370"><em># 定义输出的格式</em></span>`
22. `formatter = logging.Formatter(self.fmt)`
23. `fh.setFormatter(formatter)`
24. `ch.setFormatter(formatter)`
26. `<span style="color:#5c6370"><em># 添加到handle</em></span>`
27. `self.logger.addHandler(fh)`
28. `self.logger.addHandler(ch)`
30. `<span style="color:#61aeee"> @property</span>`
31. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">fmt</span>(self):`
32. `<span style="color:#7171bf">return</span> <span style="color:#98c379">'%(levelname)s\t%(asctime)s\t[%(filename)s:%(lineno)d]\t%(message)s'</span>`

35. `log = Log().logger`
37. `<span style="color:#7171bf">if</span> __name__ == <span style="color:#98c379">'__main__'</span>:`
38. `log.info(<span style="color:#98c379">'hello world'</span>)`
39. `</code></span></span>`

![](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblogv2%2Fdist%2Fpc%2Fimg%2FnewCodeMoreWhite.png&pos_id=MCKSKlNr)

在终端中运行该文件，就看到命令行打印出了：

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-shell">INFO 2020-12-01 16:00:05,467 [logger.py:38] hello world`
2. `</code></span></span>`

然后在项目logs目录下生成了当月的日志文件。

---

#### **简单理解POM模型**

> 由于下面要讲元素相关的，所以首先理解一下POM模型

**Page Object模式具有以下几个优点。**

> 该观点来自 《Selenium自动化测试——基于Python语言》

* 抽象出对象可以最大程度地降低开发人员修改页面代码对测试的影响， 所以， 你仅需要对页
    
  面对象进行调整， 而对测试没有影响；
* 可以在多个测试用例中复用一部分测试代码；
* 测试代码变得更易读、 灵活、 可维护

**Page Object模式图**

* basepage ——selenium的基类，对selenium的方法进行封装
* pageelements——页面元素，把页面元素单独提取出来，放入一个文件中
* searchpage ——页面对象类，把selenium方法和页面元素进行整合
* testcase ——使用pytest对整合的searchpage进行测试用例编写

通过上图我们可以看出，通过POM模型思想，我们把：

* selenium方法
* 页面元素
* 页面对象
* 测试用例

以上四种代码主体进行了拆分，虽然在用例很少的情况下做会增加代码，但是当用例多的时候意义很大，代码量会在用例增加的时候显著减少。我们维护代码变得更加直观明显，代码可读性也变得比工厂模式强很多，代码复用率也极大的得到了提高。

---

#### **简单学习元素定位**

在日常的工作中，我见过很多在浏览器中直接在浏览器中右键
`Copy Xpath`
复制元素的同学。这样获得的元素表达式放在 webdriver 中去运行往往是不够稳定的，像前端的一些微小改动，都会引起元素无法定位的
`NoSuchElementException`
报错。

所以在实际工作和学习中我们应该加强自己的元素定位能力，尽可能的采用
`xpath`
和
`CSS selector`
这种相对稳定的定位语法。由于
`CSS selector`
的语法生硬难懂，对新手很不友好，而且相比
`xpath`
缺少一些定位语法。所以我们选择
`xpath`
进行我们的元素定位语法。

**xpath
[#](https://www.cnblogs.com/wxhou/p/selenium-pytest-test-framework.html#xpath "#")**

**语法规则**

> [菜鸟教程](https://www.runoob.com/xpath/xpath-intro.html "菜鸟教程")
> 中对于 xpath 的介绍是一门在 XML 文档中查找信息的语言。

| 表达式 | 介绍 | 备注 |
| --- | --- | --- |
| / | 根节点 | 绝对路径 |
| // | 当前节点的所有子节点 | 相对路径 |
| \* | 所有节点元素的 |  |
| @ | 属性名的前缀 | @class   @id |
| \*[1] | [] 下标运算符 |  |
| [] | [ ]谓词表达式 | //input[@id='kw'] |
| Following-sibling | 当前节点之后的同级 |  |
| preceding-sibling | 当前节点之前的同级 |  |
| parent | 当前节点的父级节点 |  |

**定位工具**

* chropath
  + 优点：这是一个Chrome浏览器的测试定位插件，类似于firepath，本人试用了一下整体感觉非常好。对小白的友好度很好。
  + 缺点：安装这个插件需要FQ。
* Katalon录制工具
  + 录制出来的脚本里面也会有定位元素的信息
* 自己写——本人推荐这种
  + 优点：本人推荐的方式，因为当熟练到一定程度的时候，写出来的会更直观简洁，并且在运行自动化测试中出现问题时，能快速定位。
  + 缺点：需要一定
    `xpath`
    和
    `CSS selector`
    语法积累，不太容易上手。

---

#### **管理页面元素**

> 本教程选择的测试地址是百度首页，所以对应的元素也是百度首页的。

项目框架设计中有一个目录
`page_element`
就是专门来存放定位元素的文件的。

通过对各种配置文件的对比，我在这里选择的是YAML文件格式。其易读，交互性好。

我们在
`page_element`
中新建一个
`search.yaml`
文件。

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-yaml"><span style="color:#98c379">搜索框:</span> <span style="color:#98c379">"id==kw"</span>`
2. `<span style="color:#98c379">候选:</span> <span style="color:#98c379">"css==.bdsug-overflow"</span>`
3. `<span style="color:#98c379">搜索候选:</span> <span style="color:#98c379">"css==#form div li"</span>`
4. `<span style="color:#98c379">搜索按钮:</span> <span style="color:#98c379">"id==su"</span>`
5. `</code></span></span>`

元素定位文件创建好了，下来我们需要读取这个文件。

在
`common`
目录中创建
`readelement.py`
文件。

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-python"><span style="color:#5c6370"><em>#!/usr/bin/env python3</em></span>`
2. `<span style="color:#5c6370"><em># -*- coding:utf-8 -*-</em></span>`
3. `<span style="color:#7171bf">import</span> os`
4. `<span style="color:#7171bf">import</span> yaml`
5. `<span style="color:#7171bf">from</span> config.conf <span style="color:#7171bf">import</span> cm`

8. `<span style="color:#7171bf">class</span> <span style="color:#61aeee">Element</span>(<span style="color:#61aeee">object</span>):`
9. `<span style="color:#98c379">"""获取元素"""</span>`
11. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">__init__</span>(self, name):`
12. `self.file_name = <span style="color:#98c379">'%s.yaml'</span> % name`
13. `self.element_path = os.path.join(cm.ELEMENT_PATH, self.file_name)`
14. `<span style="color:#7171bf">if</span> <span style="color:#7171bf">not</span> os.path.exists(self.element_path):`
15. `<span style="color:#7171bf">raise</span> FileNotFoundError(<span style="color:#98c379">"%s 文件不存在！"</span> % self.element_path)`
16. `<span style="color:#7171bf">with</span> <span style="color:#7171bf">open</span>(self.element_path, encoding=<span style="color:#98c379">'utf-8'</span>) <span style="color:#7171bf">as</span> f:`
17. `self.data = yaml.safe_load(f)`
19. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">__getitem__</span>(self, item):`
20. `<span style="color:#98c379">"""获取属性"""</span>`
21. `data = self.data.get(item)`
22. `<span style="color:#7171bf">if</span> data:`
23. `name, value = data.split(<span style="color:#98c379">'=='</span>)`
24. `<span style="color:#7171bf">return</span> name, value`
25. `<span style="color:#7171bf">raise</span> ArithmeticError(<span style="color:#98c379">"{}中不存在关键字：{}"</span>.<span style="color:#7171bf">format</span>(self.file_name, item))`

28. `<span style="color:#7171bf">if</span> __name__ == <span style="color:#98c379">'__main__'</span>:`
29. `search = Element(<span style="color:#98c379">'search'</span>)`
30. `<span style="color:#7171bf">print</span>(search[<span style="color:#98c379">'搜索框'</span>])`
31. `</code></span></span>`

![](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblogv2%2Fdist%2Fpc%2Fimg%2FnewCodeMoreWhite.png&pos_id=3PS0thaq)

通过特殊方法
`__getitem__`
实现调用任意属性，读取yaml中的值。

这样我们就实现了定位元素的存储和调用。

但是还有一个问题，我们怎么样才能确保我们写的每一项元素不出错，人为的错误是不可避免的，但是我们可以通过代码来运行对文件的审查。当前也不能所有问题都能发现。

所以我们编写一个文件，在
`script`
脚本文件目录中创建
`inspect.py`
文件，对所有的元素yaml文件进行审查。

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-python"><span style="color:#5c6370"><em>#!/usr/bin/env python3</em></span>`
2. `<span style="color:#5c6370"><em># -*- coding:utf-8 -*-</em></span>`
3. `<span style="color:#7171bf">import</span> os`
4. `<span style="color:#7171bf">import</span> yaml`
5. `<span style="color:#7171bf">from</span> config.conf <span style="color:#7171bf">import</span> cm`
6. `<span style="color:#7171bf">from</span> utils.times <span style="color:#7171bf">import</span> running_time`

9. `<span style="color:#61aeee">@running_time</span>`
10. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">inspect_element</span>():`
11. `<span style="color:#98c379">"""检查所有的元素是否正确`
12. `只能做一个简单的检查`
13. `"""</span>`
14. `<span style="color:#7171bf">for</span> files <span style="color:#7171bf">in</span> os.listdir(cm.ELEMENT_PATH):`
15. `_path = os.path.join(cm.ELEMENT_PATH, files)`
16. `<span style="color:#7171bf">with</span> <span style="color:#7171bf">open</span>(_path, encoding=<span style="color:#98c379">'utf-8'</span>) <span style="color:#7171bf">as</span> f:`
17. `data = yaml.safe_load(f)`
18. `<span style="color:#7171bf">for</span> k <span style="color:#7171bf">in</span> data.values():`
19. `<span style="color:#7171bf">try</span>:`
20. `pattern, value = k.split(<span style="color:#98c379">'=='</span>)`
21. `<span style="color:#7171bf">except</span> ValueError:`
22. `<span style="color:#7171bf">raise</span> Exception(<span style="color:#98c379">"元素表达式中没有`==`"</span>)`
23. `<span style="color:#7171bf">if</span> pattern <span style="color:#7171bf">not</span> <span style="color:#7171bf">in</span> cm.LOCATE_MODE:`
24. `<span style="color:#7171bf">raise</span> Exception(<span style="color:#98c379">'%s中元素【%s】没有指定类型'</span> % (_path, k))`
25. `<span style="color:#7171bf">elif</span> pattern == <span style="color:#98c379">'xpath'</span>:`
26. `<span style="color:#7171bf">assert</span> <span style="color:#98c379">'//'</span> <span style="color:#7171bf">in</span> value,\`
27. `<span style="color:#98c379">'%s中元素【%s】xpath类型与值不配'</span> % (_path, k)`
28. `<span style="color:#7171bf">elif</span> pattern == <span style="color:#98c379">'css'</span>:`
29. `<span style="color:#7171bf">assert</span> <span style="color:#98c379">'//'</span> <span style="color:#7171bf">not</span> <span style="color:#7171bf">in</span> value, \`
30. `<span style="color:#98c379">'%s中元素【%s]css类型与值不配'</span> % (_path, k)`
31. `<span style="color:#7171bf">else</span>:`
32. `<span style="color:#7171bf">assert</span> value, <span style="color:#98c379">'%s中元素【%s】类型与值不匹配'</span> % (_path, k)`

35. `<span style="color:#7171bf">if</span> __name__ == <span style="color:#98c379">'__main__'</span>:`
36. `inspect_element()`
37. `</code></span></span>`

![](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblogv2%2Fdist%2Fpc%2Fimg%2FnewCodeMoreWhite.png&pos_id=JggTTeOm)

执行该文件：

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-powershell">校验元素done！用时<span style="color:#d19a66">0.002</span>秒！`
2. `</code></span></span>`

可以看到，很短的时间内，我们就对所填写的YAML文件进行了审查。

现在我们基本所需要的组件已经大致完成了。

接下来我们将进行最重要的一环，封装selenium。

---

#### **封装Selenium基类**

在工厂模式种我们是这样写的：

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-python"><span style="color:#5c6370"><em>#!/usr/bin/env python3</em></span>`
2. `<span style="color:#5c6370"><em># -*- coding:utf-8 -*-</em></span>`
3. `<span style="color:#7171bf">import</span> time`
4. `<span style="color:#7171bf">from</span> selenium <span style="color:#7171bf">import</span> webdriver`

7. `driver = webdriver.Chrome()`
8. `driver.get(<span style="color:#98c379">'https://www.baidu.com'</span>)`
9. `driver.find_element_by_xpath(<span style="color:#98c379">"//input[@id='kw']"</span>).send_keys(<span style="color:#98c379">'selenium'</span>)`
10. `driver.find_element_by_xpath(<span style="color:#98c379">"//input[@id='su']"</span>).click()`
11. `time.sleep(<span style="color:#d19a66">5</span>)`
12. `driver.quit()`
13. `</code></span></span>`

很直白，简单，又明了。

**创建driver对象，打开百度网页，搜索selenium，点击搜索，然后停留5秒，查看结果，最后关闭浏览器。**

那我们为什么要封装selenium的方法呢。首先我们上述这种较为原始的方法，基本不适用于平时做UI自动化测试的，因为在UI界面实际运行情况远远比较复杂，可能因为网络原因，或者控件原因，我们元素还没有显示出来，就进行点击或者输入。所以我们需要封装selenium方法，通过内置的显式等待或一定的条件语句，才能构建一个稳定的方法。而且把selenium方法封装起来，有利于平时的代码维护。

我们在
`page`
目录创建
`webpage.py`
文件。

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-python"><span style="color:#5c6370"><em>#!/usr/bin/env python3</em></span>`
2. `<span style="color:#5c6370"><em># -*- coding:utf-8 -*-</em></span>`
3. `<span style="color:#98c379">"""`
4. `selenium基类`
5. `本文件存放了selenium基类的封装方法`
6. `"""</span>`
7. `<span style="color:#7171bf">from</span> selenium.webdriver.support <span style="color:#7171bf">import</span> expected_conditions <span style="color:#7171bf">as</span> EC`
8. `<span style="color:#7171bf">from</span> selenium.webdriver.support.ui <span style="color:#7171bf">import</span> WebDriverWait`
9. `<span style="color:#7171bf">from</span> selenium.common.exceptions <span style="color:#7171bf">import</span> TimeoutException`
11. `<span style="color:#7171bf">from</span> config.conf <span style="color:#7171bf">import</span> cm`
12. `<span style="color:#7171bf">from</span> utils.times <span style="color:#7171bf">import</span> sleep`
13. `<span style="color:#7171bf">from</span> utils.logger <span style="color:#7171bf">import</span> log`

16. `<span style="color:#7171bf">class</span> <span style="color:#61aeee">WebPage</span>(<span style="color:#61aeee">object</span>):`
17. `<span style="color:#98c379">"""selenium基类"""</span>`
19. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">__init__</span>(self, driver):`
20. `<span style="color:#5c6370"><em># self.driver = webdriver.Chrome()</em></span>`
21. `self.driver = driver`
22. `self.timeout = <span style="color:#d19a66">20</span>`
23. `self.wait = WebDriverWait(self.driver, self.timeout)`
25. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">get_url</span>(self, url):`
26. `<span style="color:#98c379">"""打开网址并验证"""</span>`
27. `self.driver.maximize_window()`
28. `self.driver.set_page_load_timeout(<span style="color:#d19a66">60</span>)`
29. `<span style="color:#7171bf">try</span>:`
30. `self.driver.get(url)`
31. `self.driver.implicitly_wait(<span style="color:#d19a66">10</span>)`
32. `log.info(<span style="color:#98c379">"打开网页：%s"</span> % url)`
33. `<span style="color:#7171bf">except</span> TimeoutException:`
34. `<span style="color:#7171bf">raise</span> TimeoutException(<span style="color:#98c379">"打开%s超时请检查网络或网址服务器"</span> % url)`
36. `<span style="color:#61aeee"> @staticmethod</span>`
37. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">element_locator</span>(func, locator):`
38. `<span style="color:#98c379">"""元素定位器"""</span>`
39. `name, value = locator`
40. `<span style="color:#7171bf">return</span> func(cm.LOCATE_MODE[name], value)`
42. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">find_element</span>(self, locator):`
43. `<span style="color:#98c379">"""寻找单个元素"""</span>`
44. `<span style="color:#7171bf">return</span> WebPage.element_locator(<span style="color:#7171bf">lambda</span> *args: self.wait.until(`
45. `EC.presence_of_element_located(args)), locator)`
47. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">find_elements</span>(self, locator):`
48. `<span style="color:#98c379">"""查找多个相同的元素"""</span>`
49. `<span style="color:#7171bf">return</span> WebPage.element_locator(<span style="color:#7171bf">lambda</span> *args: self.wait.until(`
50. `EC.presence_of_all_elements_located(args)), locator)`
52. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">elements_num</span>(self, locator):`
53. `<span style="color:#98c379">"""获取相同元素的个数"""</span>`
54. `number = <span style="color:#7171bf">len</span>(self.find_elements(locator))`
55. `log.info(<span style="color:#98c379">"相同元素：{}"</span>.<span style="color:#7171bf">format</span>((locator, number)))`
56. `<span style="color:#7171bf">return</span> number`
58. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">input_text</span>(self, locator, txt):`
59. `<span style="color:#98c379">"""输入(输入前先清空)"""</span>`
60. `sleep(<span style="color:#d19a66">0.5</span>)`
61. `ele = self.find_element(locator)`
62. `ele.clear()`
63. `ele.send_keys(txt)`
64. `log.info(<span style="color:#98c379">"输入文本：{}"</span>.<span style="color:#7171bf">format</span>(txt))`
66. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">is_click</span>(self, locator):`
67. `<span style="color:#98c379">"""点击"""</span>`
68. `self.find_element(locator).click()`
69. `sleep()`
70. `log.info(<span style="color:#98c379">"点击元素：{}"</span>.<span style="color:#7171bf">format</span>(locator))`
72. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">element_text</span>(self, locator):`
73. `<span style="color:#98c379">"""获取当前的text"""</span>`
74. `_text = self.find_element(locator).text`
75. `log.info(<span style="color:#98c379">"获取文本：{}"</span>.<span style="color:#7171bf">format</span>(_text))`
76. `<span style="color:#7171bf">return</span> _text`
78. `<span style="color:#61aeee"> @property</span>`
79. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">get_source</span>(self):`
80. `<span style="color:#98c379">"""获取页面源代码"""</span>`
81. `<span style="color:#7171bf">return</span> self.driver.page_source`
83. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">refresh</span>(self):`
84. `<span style="color:#98c379">"""刷新页面F5"""</span>`
85. `self.driver.refresh()`
86. `self.driver.implicitly_wait(<span style="color:#d19a66">30</span>)`
87. `</code></span></span>`

![](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblogv2%2Fdist%2Fpc%2Fimg%2FnewCodeMoreWhite.png&pos_id=QfelP2Ra)

在文件中我们对主要用了
**`显式等待`**
对selenium的click，send\_keys等方法，做了二次封装。提高了运行的成功率。

好了我们完成了POM模型的一半左右的内容。接下来我们们进入页面对象。

---

#### **创建页面对象**

在
`page_object`
目录下创建一个
`searchpage.py`
文件。

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-python"><span style="color:#5c6370"><em>#!/usr/bin/env python3</em></span>`
2. `<span style="color:#5c6370"><em># -*- coding:utf-8 -*-</em></span>`
3. `<span style="color:#7171bf">from</span> page.webpage <span style="color:#7171bf">import</span> WebPage, sleep`
4. `<span style="color:#7171bf">from</span> common.readelement <span style="color:#7171bf">import</span> Element`
6. `search = Element(<span style="color:#98c379">'search'</span>)`

9. `<span style="color:#7171bf">class</span> <span style="color:#61aeee">SearchPage</span>(<span style="color:#61aeee">WebPage</span>):`
10. `<span style="color:#98c379">"""搜索类"""</span>`
12. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">input_search</span>(self, content):`
13. `<span style="color:#98c379">"""输入搜索"""</span>`
14. `self.input_text(search[<span style="color:#98c379">'搜索框'</span>], txt=content)`
15. `sleep()`
17. `<span style="color:#61aeee"> @property</span>`
18. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">imagine</span>(self):`
19. `<span style="color:#98c379">"""搜索联想"""</span>`
20. `<span style="color:#7171bf">return</span> [x.text <span style="color:#7171bf">for</span> x <span style="color:#7171bf">in</span> self.find_elements(search[<span style="color:#98c379">'候选'</span>])]`
22. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">click_search</span>(self):`
23. `<span style="color:#98c379">"""点击搜索"""</span>`
24. `self.is_click(search[<span style="color:#98c379">'搜索按钮'</span>])`
25. `</code></span></span>`

![](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblogv2%2Fdist%2Fpc%2Fimg%2FnewCodeMoreWhite.png&pos_id=ZNRxbNZk)

在该文件中我们对，输入搜索关键词，点击搜索，搜索联想，进行了封装。

并配置了注释。

> 在平时中我们应该养成写注释的习惯，因为过一段时间后，没有注释，代码读起来很费劲。

好了我们的页面对象此时业已完成了。下面我们开始编写测试用例。在开始测试用了之前我们先熟悉一下pytest测试框架。

---

#### **简单了解Pytest**

打开pytest框架的官网。
[pytest: helps you write better programs — pytest documentation](http://www.pytest.org/en/latest/ "pytest: helps you write better programs — pytest documentation")

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-python"><span style="color:#5c6370"><em># content of test_sample.py</em></span>`
2. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">inc</span>(x):`
3. `<span style="color:#7171bf">return</span> x + <span style="color:#d19a66">1</span>`

6. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">test_answer</span>():`
7. `<span style="color:#7171bf">assert</span> inc(<span style="color:#d19a66">3</span>) == <span style="color:#d19a66">5</span>`
8. `</code></span></span>`

官方教程我认为写的并不适合入门阅读，而且没有汉化版。

推荐看一下
[上海悠悠的pytest教程](https://www.cnblogs.com/yoyoketang/tag/pytest/ "上海悠悠的pytest教程")
。

##### **pytest.ini**

pytest项目中的配置文件，可以对pytest执行过程中操作做全局控制。

在项目根目录新建
`pytest.ini`
文件。

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-ini"><span style="color:#e06c75">[pytest]</span>`
2. `<span style="color:#d19a66">addopts</span> = --html=report.html --self-contained-html`
3. `</code></span></span>`

* addopts 指定执行时的其他参数说明：
  + `--html=report/report.html --self-contained-html`
    生成pytest-html带样式的报告
  + `-s`
    输出我们用例中的调式信息
  + `-q`
    安静的进行测试
  + `-v`
    可以输出用例更加详细的执行信息，比如用例所在的文件及用例名称等

---

#### **编写测试用例**

我们将使用pytest编写测试用例。

在
`TestCase`
目录中创建
`test_search.py`
文件。

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-python"><span style="color:#5c6370"><em>#!/usr/bin/env python3</em></span>`
2. `<span style="color:#5c6370"><em># -*- coding:utf-8 -*-</em></span>`
3. `<span style="color:#7171bf">import</span> re`
4. `<span style="color:#7171bf">import</span> pytest`
5. `<span style="color:#7171bf">from</span> utils.logger <span style="color:#7171bf">import</span> log`
6. `<span style="color:#7171bf">from</span> common.readconfig <span style="color:#7171bf">import</span> ini`
7. `<span style="color:#7171bf">from</span> page_object.searchpage <span style="color:#7171bf">import</span> SearchPage`

10. `<span style="color:#7171bf">class</span> <span style="color:#61aeee">TestSearch</span>:`
11. `<span style="color:#61aeee"> @pytest.fixture(scope=<span style="color:#3388aa">'function'</span>, autouse=<span style="color:#56b6c2">True</span>)</span>`
12. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">open_baidu</span>(self, drivers):`
13. `<span style="color:#98c379">"""打开百度"""</span>`
14. `search = SearchPage(drivers)`
15. `search.get_url(ini.url)`
17. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">test_001</span>(self, drivers):`
18. `<span style="color:#98c379">"""搜索"""</span>`
19. `search = SearchPage(drivers)`
20. `search.input_search(<span style="color:#98c379">"selenium"</span>)`
21. `search.click_search()`
22. `result = re.search(<span style="color:#98c379">r'selenium'</span>, search.get_source)`
23. `log.info(result)`
24. `<span style="color:#7171bf">assert</span> result`
26. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">test_002</span>(self, drivers):`
27. `<span style="color:#98c379">"""测试搜索候选"""</span>`
28. `search = SearchPage(drivers)`
29. `search.input_search(<span style="color:#98c379">"selenium"</span>)`
30. `log.info(<span style="color:#7171bf">list</span>(search.imagine))`
31. `<span style="color:#7171bf">assert</span> <span style="color:#7171bf">all</span>([<span style="color:#98c379">"selenium"</span> <span style="color:#7171bf">in</span> i <span style="color:#7171bf">for</span> i <span style="color:#7171bf">in</span> search.imagine])`

34. `<span style="color:#7171bf">if</span> __name__ == <span style="color:#98c379">'__main__'</span>:`
35. `pytest.main([<span style="color:#98c379">'TestCase/test_search.py'</span>])`
37. `</code></span></span>`

![](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblogv2%2Fdist%2Fpc%2Fimg%2FnewCodeMoreWhite.png&pos_id=mqjwt9R9)

我们测试用了就编写好了。

* pytest.fixture 这个实现了和unittest的setup，teardown一样的前置启动，后置清理的装饰器。
* 第一个测试用例：

  + 我们实现了在百度selenium关键字，并点击搜索按钮，并在搜索结果中，用正则查找结果页源代码，返回数量大于10我们就认为通过。
* 第二个测试用例：

  + 我们实现了，搜索selenium，然后断言搜索候选中的所有结果有没有selenium关键字。

最后我们的在下面写一个执行启动的语句。

这时候我们应该进入执行了，但是还有一个问题，我们还没有把driver传递。

#### **conftest.py**

我们在项目根目录下新建一个
`conftest.py`
文件。

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-python"><span style="color:#5c6370"><em>#!/usr/bin/env python3</em></span>`
2. `<span style="color:#5c6370"><em># -*- coding:utf-8 -*-</em></span>`
3. `<span style="color:#7171bf">import</span> pytest`
4. `<span style="color:#7171bf">from</span> py.xml <span style="color:#7171bf">import</span> html`
5. `<span style="color:#7171bf">from</span> selenium <span style="color:#7171bf">import</span> webdriver`

8. `driver = <span style="color:#56b6c2">None</span>`

11. `<span style="color:#61aeee">@pytest.fixture(scope=<span style="color:#3388aa">'session'</span>, autouse=<span style="color:#56b6c2">True</span>)</span>`
12. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">drivers</span>(request):`
13. `<span style="color:#7171bf">global</span> driver`
14. `<span style="color:#7171bf">if</span> driver <span style="color:#7171bf">is</span> <span style="color:#56b6c2">None</span>:`
15. `driver = webdriver.Chrome()`
16. `driver.maximize_window()`
18. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">fn</span>():`
19. `driver.quit()`
21. `request.addfinalizer(fn)`
22. `<span style="color:#7171bf">return</span> driver`

25. `<span style="color:#61aeee">@pytest.hookimpl(hookwrapper=<span style="color:#56b6c2">True</span>)</span>`
26. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">pytest_runtest_makereport</span>(item):`
27. `<span style="color:#98c379">"""`
28. `当测试失败的时候，自动截图，展示到html报告中`
29. `:param item:`
30. `"""</span>`
31. `pytest_html = item.config.pluginmanager.getplugin(<span style="color:#98c379">'html'</span>)`
32. `outcome = <span style="color:#7171bf">yield</span>`
33. `report = outcome.get_result()`
34. `report.description = <span style="color:#7171bf">str</span>(item.function.__doc__)`
35. `extra = <span style="color:#7171bf">getattr</span>(report, <span style="color:#98c379">'extra'</span>, [])`
37. `<span style="color:#7171bf">if</span> report.when == <span style="color:#98c379">'call'</span> <span style="color:#7171bf">or</span> report.when == <span style="color:#98c379">"setup"</span>:`
38. `xfail = <span style="color:#7171bf">hasattr</span>(report, <span style="color:#98c379">'wasxfail'</span>)`
39. `<span style="color:#7171bf">if</span> (report.skipped <span style="color:#7171bf">and</span> xfail) <span style="color:#7171bf">or</span> (report.failed <span style="color:#7171bf">and</span> <span style="color:#7171bf">not</span> xfail):`
40. `file_name = report.nodeid.replace(<span style="color:#98c379">"::"</span>, <span style="color:#98c379">"_"</span>) + <span style="color:#98c379">".png"</span>`
41. `screen_img = _capture_screenshot()`
42. `<span style="color:#7171bf">if</span> file_name:`
43. `html = <span style="color:#98c379">'<div><img src="data:image/png;base64,%s" alt="screenshot" style="width:1024px;height:768px;" '</span> \`
44. `<span style="color:#98c379">'onclick="window.open(this.src)" align="right"/></div>'</span> % screen_img`
45. `extra.append(pytest_html.extras.html(html))`
46. `report.extra = extra`

49. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">pytest_html_results_table_header</span>(cells):`
50. `cells.insert(<span style="color:#d19a66">1</span>, html.th(<span style="color:#98c379">'用例名称'</span>))`
51. `cells.insert(<span style="color:#d19a66">2</span>, html.th(<span style="color:#98c379">'Test_nodeid'</span>))`
52. `cells.pop(<span style="color:#d19a66">2</span>)`

55. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">pytest_html_results_table_row</span>(report, cells):`
56. `cells.insert(<span style="color:#d19a66">1</span>, html.td(report.description))`
57. `cells.insert(<span style="color:#d19a66">2</span>, html.td(report.nodeid))`
58. `cells.pop(<span style="color:#d19a66">2</span>)`

61. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">pytest_html_results_table_html</span>(report, data):`
62. `<span style="color:#7171bf">if</span> report.passed:`
63. `<span style="color:#7171bf">del</span> data[:]`
64. `data.append(html.div(<span style="color:#98c379">'通过的用例未捕获日志输出.'</span>, class_=<span style="color:#98c379">'empty log'</span>))`

67. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">_capture_screenshot</span>():`
68. `<span style="color:#98c379">'''`
69. `截图保存为base64`
70. `:return:`
71. `'''</span>`
72. `<span style="color:#7171bf">return</span> driver.get_screenshot_as_base64()`
74. `</code></span></span>`

![](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblogv2%2Fdist%2Fpc%2Fimg%2FnewCodeMoreWhite.png&pos_id=dGPfLQ3E)

conftest.py测试框架pytest的胶水文件，里面用到了fixture的方法，封装并传递出了driver。

---

#### **执行用例**

以上我们已经编写完成了整个框架和测试用例。

我们进入到当前项目的主目录执行命令：

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-powershell">pytest`
2. `</code></span></span>`

命令行输出：

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-powershell">Test session starts (platform: win32, Python <span style="color:#d19a66">3.7</span>.<span style="color:#d19a66">7</span>, pytest <span style="color:#d19a66">5.3</span>.<span style="color:#d19a66">2</span>, py<span style="color:#7171bf">test-sugar</span> <span style="color:#d19a66">0.9</span>.<span style="color:#d19a66">2</span>)`
2. `cachedir: .pytest_cache`
3. `metadata: {<span style="color:#98c379">'Python'</span>: <span style="color:#98c379">'3.7.7'</span>, <span style="color:#98c379">'Platform'</span>: <span style="color:#98c379">'Windows-10-10.0.18362-SP0'</span>, <span style="color:#98c379">'Packages'</span>: {<span style="color:#98c379">'pytest'</span>: <span style="color:#98c379">'5.3.2'</span>, <span style="color:#98c379">'py'</span>: <span style="color:#98c379">'1.8.0'</span>, <span style="color:#98c379">'pluggy'</span>: <span style="color:#98c379">'0.13.1'</span>}, <span style="color:#98c379">'Plugins'</span>: {<span style="color:#98c379">'forked'</span>: <span style="color:#98c379">'1.1.3'</span>, <span style="color:#98c379">'html'</span>: <span style="color:#98c379">'2.0.1'</span>, <span style="color:#98c379">'metadata'</span>: <span style="color:#98c379">'1.8.0'</span>, <span style="color:#98c379">'ordering'</span>: <span style="color:#98c379">'0.6'</span>, <span style="color:#98c379">'rerunfailures'</span>: <span style="color:#98c379">'8.0'</span>, <span style="color:#98c379">'sugar'</span>: <span style="color:#98c379">'0.9.2'</span>, <span style="color:#98c379">'xdist'</span>: <span style="color:#98c379">'1.31.0'</span>}, <span style="color:#98c379">'JAVA_HOME'</span>: <span style="color:#98c379">'D:\\Program Files\\Java\\jdk1.8.0_131'</span>}`
4. `rootdir: C:\Users\hoou\PycharmProjects\web<span style="color:#56b6c2">-demotest</span>, inifile: pytest.ini`
5. `plugins: forked<span style="color:#56b6c2">-1</span>.<span style="color:#d19a66">1.3</span>, html<span style="color:#56b6c2">-2</span>.<span style="color:#d19a66">0.1</span>, metadata<span style="color:#56b6c2">-1</span>.<span style="color:#d19a66">8.0</span>, ordering<span style="color:#56b6c2">-0</span>.<span style="color:#d19a66">6</span>, rerunfailures<span style="color:#56b6c2">-8</span>.<span style="color:#d19a66">0</span>, sugar<span style="color:#56b6c2">-0</span>.<span style="color:#d19a66">9.2</span>, xdist<span style="color:#56b6c2">-1</span>.<span style="color:#d19a66">31.0</span>`
6. `collecting ...`
7. `DevTools listening on ws://<span style="color:#d19a66">127.0</span>.<span style="color:#d19a66">0.1</span>:<span style="color:#d19a66">10351</span>/devtools/browser/<span style="color:#d19a66">78</span>bef34d<span style="color:#56b6c2">-b94c-4087-b724-34fb6b2ef6d1</span>`
9. `TestCase\test_search.py::TestSearch.test_001 ✓ <span style="color:#d19a66">50</span>% █████`
11. `TestCase\test_search.py::TestSearch.test_002 ✓ <span style="color:#d19a66">100</span>% ██████████`
12. `<span style="color:#56b6c2">-------------------------------</span> generated html file: file://C:\Users\hoou\PycharmProjects\web<span style="color:#56b6c2">-demotest</span>\report\report.html <span style="color:#56b6c2">--------------------------------</span>`
14. `Results (<span style="color:#d19a66">12.90</span>s):`
15. `<span style="color:#d19a66">2</span> passed`
16. `</code></span></span>`

![](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblogv2%2Fdist%2Fpc%2Fimg%2FnewCodeMoreWhite.png&pos_id=br9kns3J)

可以看到两条用例已经执行成功了。

项目的report目录中生成了一个report.html文件。

这就是生成的测试报告文件。

---

#### **发送邮件**

当项目执行完成之后，需要发送到自己或者其他人邮箱里查看结果。

我们编写发送邮件的模块。

在
`utils`
目录中新建
`send_mail.py`
文件

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-python"><span style="color:#5c6370"><em>#!/usr/bin/env python3</em></span>`
2. `<span style="color:#5c6370"><em># -*- coding:utf-8 -*-</em></span>`
3. `<span style="color:#7171bf">import</span> zmail`
4. `<span style="color:#7171bf">from</span> config.conf <span style="color:#7171bf">import</span> cm`

7. `<span style="color:#7171bf">def</span> <span style="color:#61aeee">send_report</span>():`
8. `<span style="color:#98c379">"""发送报告"""</span>`
9. `<span style="color:#7171bf">with</span> <span style="color:#7171bf">open</span>(cm.REPORT_FILE, encoding=<span style="color:#98c379">'utf-8'</span>) <span style="color:#7171bf">as</span> f:`
10. `content_html = f.read()`
11. `<span style="color:#7171bf">try</span>:`
12. `mail = {`
13. `<span style="color:#98c379">'from'</span>: <span style="color:#98c379">'1084502012@qq.com'</span>,`
14. `<span style="color:#98c379">'subject'</span>: <span style="color:#98c379">'最新的测试报告邮件'</span>,`
15. `<span style="color:#98c379">'content_html'</span>: content_html,`
16. `<span style="color:#98c379">'attachments'</span>: [cm.REPORT_FILE, ]`
17. `}`
18. `server = zmail.server(*cm.EMAIL_INFO.values())`
19. `server.send_mail(cm.ADDRESSEE, mail)`
20. `<span style="color:#7171bf">print</span>(<span style="color:#98c379">"测试邮件发送成功！"</span>)`
21. `<span style="color:#7171bf">except</span> Exception <span style="color:#7171bf">as</span> e:`
22. `<span style="color:#7171bf">print</span>(<span style="color:#98c379">"Error: 无法发送邮件，{}！"</span>, <span style="color:#7171bf">format</span>(e))`

25. `<span style="color:#7171bf">if</span> __name__ == <span style="color:#98c379">"__main__"</span>:`
26. `<span style="color:#98c379">'''请先在config/conf.py文件设置QQ邮箱的账号和密码'''</span>`
27. `send_report()`
28. `</code></span></span>`

![](https://img-home.csdnimg.cn/images/20230724024159.png?origin_url=https%3A%2F%2Fcsdnimg.cn%2Frelease%2Fblogv2%2Fdist%2Fpc%2Fimg%2FnewCodeMoreWhite.png&pos_id=ws6KKTF3)

执行该文件：

1. `<span style="color:#596172"><span style="background-color:#ffffff"><code class="language-shell">测试邮件发送成功！`
2. `</code></span></span>`

可以看到测试报告邮件已经发送成功了。打开邮箱。

![](https://i-blog.csdnimg.cn/blog_migrate/f4e210a68223fbd27f0c64eb7afe4622.png)

![](https://i-blog.csdnimg.cn/blog_migrate/a2c3a10a9b5e076aca2d9f63d6a589ec.png)

成功收到了邮件。

这个demo项目就算是整体完工了；是不是很有心得，在发送邮件的那一刻很有成就感。

最后，想必你已经对pytest+selenium框架有了一个整体的认知了，在自动化测试的道路上又上了一层台阶。