---
layout: post
title: "HarmonyOS实战-基于hi3861芯片鸿蒙2.0的避坑指南"
date: 2024-12-27 08:00:00 +0800
description: "HarmonyOS实战 —基于hi3861芯片鸿蒙2.0的避坑指南特别说明：本文章与卡片开发无关，想"
keywords: "鸿蒙wifi-iot sdk软件"
categories: ['Os', 'Harmony']
tags: ['无标签']
artid: "118976113"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=118976113
    alt: "HarmonyOS实战-基于hi3861芯片鸿蒙2.0的避坑指南"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=118976113
featuredImagePreview: https://bing.ee123.net/img/rand?artid=118976113
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     HarmonyOS实战 —基于hi3861芯片鸿蒙2.0的避坑指南
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="HarmonyOS_hi386120_0">
     </a>
     HarmonyOS实战 —基于hi3861芯片鸿蒙2.0的避坑指南
    </h2>
    <p>
     <strong>
      特别说明：本文章与卡片开发无关，想看卡片开发的不用往下读了
     </strong>
    </p>
    <h4>
     <a id="OpenHarmony1xOpenHarmony20_2">
     </a>
     最近学习鸿蒙设备开发的过程中遇到了很多问题，因为目前几乎所有设备开发教程都是针对OpenHarmony1.x的，用OpenHarmony2.0的过程中遇到了很多问题，于是想写一篇文章蹭一下卡片开发的热度，让更多人看到帮大家避坑。
    </h4>
    <h3>
     <a id="1wifi_iotsdk_3">
     </a>
     1.wifi iot套件的专用sdk目录和数量变了
    </h3>
    <p>
     <strong>
      harmonyos1.0:
     </strong>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/429129efdb0bcf6140e259e6a3ccbfe5.jpeg#pic_center">
      <br/>
      <strong>
       harmonyos2.0:
      </strong>
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0d621555b0eb35cfe33a43d86f1226e0.jpeg#pic_center">
       <br/>
       <strong>
        我猜测可能时还没有来得及封装的原因， 我在用Openharmony2.0写一个简单的按键程序的时候我发现iot开头的头文件居然没有拉高电平的函数
       </strong>
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/14fccbe27fbb05d0582397cc973dd0b0.jpeg#pic_center">
        <br/>
        <strong>
         但是在openharmony1.0的代码里面有相关函数的封装
        </strong>
       </img>
      </img>
     </img>
    </p>
    <p>
     <strong>
      最后通过看源码发现无论是新的sdk还是旧的sdk其实都是基于更底层的hi开头的sdk封装的，所以如果发现没有相应函数的时候可以直接调用这些hi开头的头文件
     </strong>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7c66b3b1031fb35124a9342d157c7fd7.jpeg#pic_center"/>
    </p>
    <h3>
     <a id="2usr_configmk_14">
     </a>
     2.usr_config.mk文件位置改变
    </h3>
    <p>
     <strong>
      玩过OpenHarmony1.0的人应该都知道在使用某些功能的时候需要在配置文件把对应的选项写上才能使用该功能否则会报错。
     </strong>
     <br/>
     openharmony1.0：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/99dcd4bd67feeda303ceab2fdc443fe1.jpeg#pic_center">
      <br/>
      但是Open Harmony2.0里面这个文件的位置变了：
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/8899f33ef8e49c3ca54a8c50cb99dbe3.jpeg#pic_center">
       <br/>
       <strong>
        目前我在学习过程中也只发现这两个问题，后面遇到问题再补充吧， 这个好像不写够1000字还不让发，那我再附一个hi3861开发板用蜂鸣器放歌的鸿蒙2.0版本教程吧。
       </strong>
      </img>
     </img>
    </p>
    <h3>
     <a id="3PWMhispark_wifiharmony_os_20_23">
     </a>
     3.PWM播放音乐，基于hispark wifi套件采用harmony os 2.0全量代码
    </h3>
    <h3>
     <a id="_24">
     </a>
     一、看原理图确定硬件电路
    </h3>
    <p>
     <strong>
      本例采用红绿灯扩展版上的蜂鸣器
     </strong>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a4ab5df80a9c97cf7c79db5fd7f930df.png#pic_center">
      <br/>
      <strong>
       注：可以发现由于红绿灯的蜂鸣器与GPIO9相连而核心板上的led也是与GPIO9相连的，所以控制蜂鸣器时核心板板载的led也会发生变化。
      </strong>
     </img>
    </p>
    <h3>
     <a id="demo_28">
     </a>
     二、在源码中建立demo文件
    </h3>
    <p>
     在app下建立pwmdemo文件夹并创建BUILD.gn和pwm_buz_music.c文件
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e28557d76f6b61727960bcf738171cab.png#pic_center"/>
    </p>
    <h3>
     <a id="_32">
     </a>
     三、编写代码
    </h3>
    <p>
     在pwmdemo/pwm_buz_music.c中写入
    </p>
    <pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ohos_init.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"cmsis_os2.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"hi_gpio.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"hi_io.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"hi_pwm.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"hi_time.h"</span></span>


<span class="token comment">// 音符对应的分频系数</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> uint16_t g_tuneFreqs<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">//40MHz时钟源</span>
    <span class="token number">38223</span><span class="token punctuation">,</span> <span class="token comment">// 1 1046.5</span>
    <span class="token number">34052</span><span class="token punctuation">,</span> <span class="token comment">// 2 1174.7</span>
    <span class="token number">30338</span><span class="token punctuation">,</span> <span class="token comment">// 3 1318.5</span>
    <span class="token number">28635</span><span class="token punctuation">,</span> <span class="token comment">// 4 1396.4</span>
    <span class="token number">25511</span><span class="token punctuation">,</span> <span class="token comment">// 5 1568</span>
    <span class="token number">22728</span><span class="token punctuation">,</span> <span class="token comment">// 6 1760</span>
    <span class="token number">20249</span><span class="token punctuation">,</span> <span class="token comment">// 7 1975.5</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//曲谱音符</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> uint8_t g_scoreNotes<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 《两只老虎》简谱</span>
    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>    <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>   <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span>
    <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>   <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 曲谱时值</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> uint8_t g_scoreDurations<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span>    <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span>   <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span>  <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span>
    <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span>  <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span>   <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span>  <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">PwmGpioTask</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>arg<span class="token punctuation">;</span>
    uint32_t tune<span class="token punctuation">;</span>
    uint16_t freqDivisor<span class="token punctuation">;</span>
    uint32_t tuneInterval<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>g_scoreNotes<span class="token punctuation">)</span><span class="token operator">/</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>g_scoreNotes<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        tune <span class="token operator">=</span> g_scoreNotes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        freqDivisor <span class="token operator">=</span> g_tuneFreqs<span class="token punctuation">[</span>tune<span class="token punctuation">]</span><span class="token punctuation">;</span>
        tuneInterval <span class="token operator">=</span> g_scoreDurations<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">125</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 时间</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%d %d %d\r\n"</span><span class="token punctuation">,</span> tune<span class="token punctuation">,</span> freqDivisor<span class="token punctuation">,</span> tuneInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">hi_pwm_start</span><span class="token punctuation">(</span>HI_PWM_PORT_PWM0<span class="token punctuation">,</span> freqDivisor<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> freqDivisor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">hi_udelay</span><span class="token punctuation">(</span>tuneInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">hi_pwm_stop</span><span class="token punctuation">(</span>HI_PWM_PORT_PWM0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">PwmGpioEntry</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    osThreadAttr_t attr<span class="token punctuation">;</span>

    <span class="token function">hi_gpio_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hi_io_set_func</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">,</span> HI_IO_FUNC_GPIO_9_PWM0_OUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">hi_pwm_init</span><span class="token punctuation">(</span>HI_PWM_PORT_PWM0<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">hi_pwm_set_clock</span><span class="token punctuation">(</span>PWM_CLK_XTAL<span class="token punctuation">)</span><span class="token punctuation">;</span>

    attr<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"PwmGpioTask"</span><span class="token punctuation">;</span>
    attr<span class="token punctuation">.</span>attr_bits <span class="token operator">=</span> <span class="token number">0U</span><span class="token punctuation">;</span>
    attr<span class="token punctuation">.</span>cb_mem <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    attr<span class="token punctuation">.</span>cb_size <span class="token operator">=</span> <span class="token number">0U</span><span class="token punctuation">;</span>
    attr<span class="token punctuation">.</span>stack_mem <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    attr<span class="token punctuation">.</span>stack_size <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
    attr<span class="token punctuation">.</span>priority <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">osThreadNew</span><span class="token punctuation">(</span>PwmGpioTask<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>attr<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[LedExample] Falied to create LedTask!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">SYS_RUN</span><span class="token punctuation">(</span>PwmGpioEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
    <p>
     <strong>
      这里的pwm相关函数用法参考源码
     </strong>
     <br/>
     在pwmdemo/BUILD.gn中写入
    </p>
    <pre><code class="prism language-gn">static_library("pwmdemo") {
    sources = [
        "pwm_buz_music.c"
    ]

    include_dirs = [
        "//utils/native/lite/include",
        "//kernel/liteos_m/components/cmsis/2.0",
        "//base/iot_hardware/peripheral/interfaces/kits",
        "//device/hisilicon/hispark_pegasus/sdk_liteos/include"
    ]
}
</code></pre>
    <p>
     在上级目录的app/BUILD.gn中写入
    </p>
    <pre><code class="prism language-gn">import("//build/lite/config/component/lite_component.gni")

lite_component("app") {
    features = [
        "pwmdemo",
    ]
}
</code></pre>
    <p>
     <strong>
      注：为了保证编译通过请修改配置文件
     </strong>
     <br/>
     修改device/hisilicon/hispark_pegasus/sdk_liteos/build/config/usr_config.mk
     <br/>
     加上
    </p>
    <pre><code class="prism language-mk">CONFIG_PWM_SUPPORT=y
</code></pre>
    <h3>
     <a id="Linuxhb_150">
     </a>
     四、在Linux下使用hb工具进行编译
    </h3>
    <pre><code class="prism language-bash">root@DESKTOP-QAO2AOK:~/harmonyos/code-2.0-canary<span class="token comment"># hb set</span>
<span class="token punctuation">[</span>OHOS INFO<span class="token punctuation">]</span> Input code path: <span class="token keyword">.</span>
OHOS Which product <span class="token keyword">do</span> you need?  wifiiot_hispark_pegasus
root@DESKTOP-QAO2AOK:~/harmonyos/code-2.0-canary<span class="token comment"># hb build</span>
</code></pre>
    <p>
     如果曾经设置过hb set就不需要再设置了，直接这样就可以了
    </p>
    <pre><code class="prism language-bash">root@DESKTOP-QAO2AOK:~/harmonyos/code-2.0-canary<span class="token comment"># hb build</span>
</code></pre>
    <p>
     看到success字样即为编译成功
    </p>
    <h3>
     <a id="_164">
     </a>
     五、将编译好的固件烧录到开发板
    </h3>
    <p>
     将linux中的源码文件夹中的out拷贝到Windows下替换原有out文件夹就可以了，
     <strong>
      但是要先删除原有out文件夹
     </strong>
     <br/>
     打开vscode使用DevEco Device Tool打开源码文件夹
     <br/>
     选择对应的开发板型号
     <br/>
     这里选择的是hi3861
     <br/>
     然后在项目设置中按照实际端口情况进行如下设置
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/b99dcac248fef53b8b7eaddce38e077c.png#pic_center"/>
     <br/>
     保存项目并打开
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0861958d5631de1d3458d38c8defc149.png#pic_center"/>
     <br/>
     点击upload进行烧录，
     <strong>
      烧录时需要根据提示按下开发板的rst键
     </strong>
     ，稍等片刻，看到success代表烧录成功。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/84ad92497e7022cfe396628ea73085a1.png#pic_center"/>
     <br/>
     按下rst键重启开发板，可以听到蜂鸣器播放儿歌两只老虎
    </p>
    <p>
     【本文正在参与“有奖征文 | HarmonyOS征文大赛”活动】
     <br/>
     <a href="https://marketing.csdn.net/p/ad3879b53f4b8b31db27382b5fc65bbc">
      活动页面链接
     </a>
     .
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f59616e67487875616e2f:61727469636c652f64657461696c732f313138393736313133" class_="artid" style="display:none">
 </p>
</div>


