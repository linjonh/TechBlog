---
layout: post
title: "草堂笔记ARM5到ARM6-分散文件加载错误问题"
date: 2025-03-13 14:42:00 +0800
description: "在最近的一次项目中，使用的是ciu32L系列的单片机，因为初始化时，需要对flash进行一些数据写入，发现其使用的是ARM5编译用官方的历程编译一切正常，但我项目使用的是ARM6编译器，所以我也试了下，直接将编译器改为ARM6，此时编译报了各警告。"
keywords: "【草堂笔记】ARM5到ARM6 分散文件加载错误问题"
categories: ['好记性不如烂笔头系列随笔']
tags: ['经验分享', '笔记', '单片机', 'C']
artid: "146230194"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146230194
    alt: "草堂笔记ARM5到ARM6-分散文件加载错误问题"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146230194
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146230194
cover: https://bing.ee123.net/img/rand?artid=146230194
image: https://bing.ee123.net/img/rand?artid=146230194
img: https://bing.ee123.net/img/rand?artid=146230194
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【草堂笔记】ARM5到ARM6 分散文件加载错误问题
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="___0">
     </a>
     一 、 背景
    </h2>
    <p>
     在最近的一次项目中，使用的是ciu32L系列的单片机，因为初始化时，需要对flash进行一些数据写入，发现其使用的是ARM5编译
     <br/>
     用官方的历程编译一切正常，但我项目使用的是ARM6编译器，所以我也试了下，直接将编译器改为ARM6，此时编译报了各警告
     <br/>
     如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/460c86444b234975a63c8c107c5056d6.png#pic_center"/>
    </p>
    <h2>
     <a id="_5">
     </a>
     二、解决方案
    </h2>
    <h3>
     <a id="21__6">
     </a>
     2.1、 官方例程如下：
    </h3>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span>   <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span> __CC_ARM <span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">arm section code <span class="token operator">=</span> </span><span class="token string">"FAST_PROGRAM"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span> __ICCARM__ <span class="token punctuation">)</span></span></span>
__ramfunc
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span> __GNUC__ <span class="token punctuation">)</span></span></span>
<span class="token keyword">__attribute__</span>  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">section</span> <span class="token punctuation">(</span><span class="token string">".RamFunc"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">/**
* @brief  Flash快速编程，往目标地址快速编程半页数据
* @param  address 编程地址
* @param  data_buf 编程数据
* @retval std_status_t 本函数执行结果
*/</span>
<span class="token class-name">std_status_t</span> <span class="token function">bsp_flash_fast_write</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> address<span class="token punctuation">,</span> <span class="token class-name">uint32_t</span> <span class="token operator">*</span>data_buf<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">std_status_t</span> status <span class="token operator">=</span> STD_OK<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> prog_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 启动快速编程模式 */</span>
    FLASH<span class="token operator">-&gt;</span>CR <span class="token operator">|=</span> FLASH_CR_FSTPG_MODE<span class="token punctuation">;</span>
    
    <span class="token comment">/* 向目标地址写入数据 */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>prog_count<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> prog_count <span class="token operator">&lt;</span> FSTPG_WORD_COUNT<span class="token punctuation">;</span> prog_count<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>address<span class="token punctuation">)</span><span class="token punctuation">[</span>prog_count<span class="token punctuation">]</span> <span class="token operator">=</span> data_buf<span class="token punctuation">[</span>prog_count<span class="token punctuation">]</span><span class="token punctuation">;</span>
        
        <span class="token comment">/* 查询等待BSY标志被清除 */</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>FLASH<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> FLASH_FLAG_BSY<span class="token punctuation">)</span> <span class="token operator">==</span> FLASH_FLAG_BSY<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">/* 若出现错误，则退出编程循环 */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>FLASH<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> FLASH_FLAG_ALL_ERR<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            status <span class="token operator">=</span> STD_ERR<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">/* 查询等待FSTPG_MODE状态被自动清零 */</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>FLASH<span class="token operator">-&gt;</span>CR <span class="token operator">&amp;</span> FLASH_CR_FSTPG_MODE<span class="token punctuation">)</span> <span class="token operator">==</span> FLASH_CR_FSTPG_MODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* 清除Flash标志 */</span>
    FLASH<span class="token operator">-&gt;</span>SR <span class="token operator">=</span> <span class="token punctuation">(</span>FLASH_FLAG_ALL_ERR <span class="token operator">|</span> FLASH_SR_EOP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">return</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span>   <span class="token expression"><span class="token function">defined</span> <span class="token punctuation">(</span> __CC_ARM <span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">arm section</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre>
    <p>
     分散加载文件如下：
    </p>
    <pre><code class="prism language-c">LR_IROM1 <span class="token number">0x08000000</span> <span class="token number">0x00040000</span>  <span class="token punctuation">{<!-- --></span>    <span class="token punctuation">;</span> load region size_region
  ER_IROM1 <span class="token number">0x08000000</span> <span class="token number">0x00040000</span>  <span class="token punctuation">{<!-- --></span>  <span class="token punctuation">;</span> load address <span class="token operator">=</span> execution address
   <span class="token operator">*</span><span class="token punctuation">.</span><span class="token function">o</span> <span class="token punctuation">(</span>RESET<span class="token punctuation">,</span> <span class="token operator">+</span>First<span class="token punctuation">)</span>
   <span class="token operator">*</span><span class="token punctuation">(</span>InRoot$$Sections<span class="token punctuation">)</span>
   <span class="token punctuation">.</span><span class="token function">ANY</span> <span class="token punctuation">(</span><span class="token operator">+</span>RO<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  RW_IRAM1 <span class="token number">0x20000000</span> <span class="token number">0x00001000</span>  <span class="token punctuation">{<!-- --></span>  <span class="token punctuation">;</span> RW data
   <span class="token operator">*</span><span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>FAST_PROGRAM<span class="token punctuation">)</span>
   <span class="token punctuation">.</span><span class="token function">ANY</span> <span class="token punctuation">(</span><span class="token operator">+</span>RW <span class="token operator">+</span>ZI<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre>
    <p>
     注意：
    </p>
    <blockquote>
     <p>
      在ARM6（即AC6编译器，基于LLVM/Clang）环境下，__CC_ARM 这个宏已被废弃，
      <strong>
       GNUC
      </strong>
      <br/>
      也被Keil的ARM编译器6支持。但你遇到的问题的根本原因是，没有正确地在链接脚本和代码中统一声明和使用 .FAST_PROGRAM
      <br/>
      段，导致编译时找不到匹配的 .o(FAST_PROGRAM) 段。
     </p>
    </blockquote>
    <h3>
     <a id="22_84">
     </a>
     2.2、解决方案：
    </h3>
    <ol>
     <li>
      确保正确的编译器宏判断
      <br/>
      ARM6 编译器在 Keil 中的宏是 __ARMCC_VERSION
     </li>
    </ol>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__CC_ARM<span class="token punctuation">)</span>  </span><span class="token comment">// ARM Compiler 5</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">arm section code<span class="token operator">=</span></span><span class="token string">"FAST_PROGRAM"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__ARMCC_VERSION<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>__ARMCC_VERSION <span class="token operator">&gt;=</span> <span class="token number">6000000</span><span class="token punctuation">)</span>  </span><span class="token comment">// ARM Compiler 6</span></span>
<span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">section</span><span class="token punctuation">(</span><span class="token string">".FAST_PROGRAM"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> used<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__ICCARM__<span class="token punctuation">)</span>  </span><span class="token comment">// IAR</span></span>
__ramfunc
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">elif</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__GNUC__<span class="token punctuation">)</span>  </span><span class="token comment">// GCC</span></span>
<span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">section</span><span class="token punctuation">(</span><span class="token string">".FAST_PROGRAM"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> used<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre>
    <p>
     分散加载文件如下：
    </p>
    <pre><code class="prism language-c">LR_IROM1 <span class="token number">0x08000000</span> <span class="token number">0x00040000</span>  <span class="token punctuation">{<!-- --></span>    <span class="token punctuation">;</span> load region size_region
  ER_IROM1 <span class="token number">0x08000000</span> <span class="token number">0x00040000</span>  <span class="token punctuation">{<!-- --></span>  <span class="token punctuation">;</span> load address <span class="token operator">=</span> execution address
   <span class="token operator">*</span><span class="token punctuation">.</span><span class="token function">o</span> <span class="token punctuation">(</span>RESET<span class="token punctuation">,</span> <span class="token operator">+</span>First<span class="token punctuation">)</span>
   <span class="token operator">*</span><span class="token punctuation">(</span>InRoot$$Sections<span class="token punctuation">)</span>
   <span class="token punctuation">.</span><span class="token function">ANY</span> <span class="token punctuation">(</span><span class="token operator">+</span>RO<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  RW_IRAM1 <span class="token number">0x20000000</span> <span class="token number">0x00002000</span>  <span class="token punctuation">{<!-- --></span>  <span class="token punctuation">;</span> RW data
    <span class="token operator">*</span><span class="token punctuation">(</span>FAST_PROGRAM<span class="token punctuation">)</span>   <span class="token punctuation">;</span> 让 <span class="token punctuation">.</span>FAST_PROGRAM 段放入 RAM
    <span class="token punctuation">.</span><span class="token function">ANY</span> <span class="token punctuation">(</span><span class="token operator">+</span>RW <span class="token operator">+</span>ZI<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     此时编译通过，程序运行正常。
    </p>
    <p>
     写笔记的目的其实就是当再次遇到同一个问题，时间久了可能会忘记处理方法，同时也可以解决大家在项目中碰到此类问题，给以快速解决方案。赠人玫瑰，手有余香。养成做笔记的习惯。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f506f727465725f3030372f:61727469636c652f64657461696c732f313436323330313934" class_="artid" style="display:none">
 </p>
</div>


