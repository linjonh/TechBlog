---
layout: post
title: "K8s集群的环境部署"
date: 2025-03-16 21:21:47 +0800
description: "1.测试环境所需要的主机名和IP和扮演的角色harbor 172.25.254.200 harbor仓库k8s-master 172.25.254.100 k8s集群控制节点k8s-node1 172.25.254.10 k8s集群工作节点k8s-node2 172.25.254.20 k8集群工作节点注意：所有节点禁用selinux和防火墙所有节点同步时间和地址解析所有节点安装docker所有节点禁用swap 注意注释掉/etc/fstab文件中的定义为什么禁用swap？"
keywords: "K8s集群的环境部署"
categories: ['未分类']
tags: ['Kubernetes', 'Java', 'Docker']
artid: "146279534"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146279534
    alt: "K8s集群的环境部署"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146279534
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146279534
cover: https://bing.ee123.net/img/rand?artid=146279534
image: https://bing.ee123.net/img/rand?artid=146279534
img: https://bing.ee123.net/img/rand?artid=146279534
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     K8s集群的环境部署
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     1.测试环境所需要的主机名和IP和扮演的角色
    </p>
    <p>
     harbor 172.25.254.200 harbor仓库
    </p>
    <p>
     k8s-master 172.25.254.100 k8s集群控制节点
    </p>
    <p>
     k8s-node1 172.25.254.10 k8s集群工作节点
    </p>
    <p>
     k8s-node2 172.25.254.20 k8集群工作节点
    </p>
    <p>
     注意：所有节点禁用selinux和防火墙
    </p>
    <p>
     所有节点同步时间和地址解析
    </p>
    <p>
     所有节点安装docker
    </p>
    <p>
     所有节点禁用swap 注意注释掉/etc/fstab文件中的定义
    </p>
    <p>
     为什么禁用swap？
    </p>
    <p>
     内存速度远快于 Swap，使用 Swap 会导致性能下降，影响节点和应用响应速度。
    </p>
    <p>
     Kubernetes 依赖 kubelet 管理节点资源，而 kubelet 默认无法有效处理 Swap，可能导致资源分配错误。
    </p>
    <p>
     Swap 可能延迟内存压力的响应，导致节点或 Pod 进入不稳定状态。
    </p>
    <p>
     关闭所有节点的火墙和禁用iptables
    </p>
    <h6>
     1.master 和node harbor禁用swap
    </h6>
    <p>
     swapon -s#查看磁盘名
    </p>
    <p>
     Filename                Type        Size        Used        Priority
     <br/>
     /dev/dm-1                               partition    2097148        0        -2
    </p>
    <p>
     ]# systemctl mask swap.target
    </p>
    <p>
     ]# swapoff -a
    </p>
    <p>
     ]# vim /etc/fstab
    </p>
    <p>
     #/dev/mapper/rhel-swap swap swap defaults 0 0
    </p>
    <p>
     /dev/cdrom /media iso9660 defaults 0 0
    </p>
    <h5>
     2.master和node harbor都做本地解析
    </h5>
    <p>
     [root@k8s-master ~]# vim /etc/hosts
    </p>
    <p>
     127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4
    </p>
    <p>
     ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6
    </p>
    <p>
     172.25.254.100 k8s-master.timinglee.org
    </p>
    <p>
     172.25.254.10 k8s-node1.timinglee.org
    </p>
    <p>
     172.25.254.20 k8s-node2.timinglee.org
    </p>
    <p>
     172.25.254.254 reg.timinglee.org
    </p>
    <h5>
     3.master和node harbor都安装docker
    </h5>
    <p>
     [root@k8s-master ~]# vim /etc/yum.repos.d/docker.repo
    </p>
    <p>
     [docker] name=docker
    </p>
    <p>
     baseurl=https://mirrors.aliyun.com/docker-ce/linux/rhel/9/x86_64/stable/
    </p>
    <p>
     gpgcheck=0
    </p>
    <p>
     [root@k8s-master ~]# dnf install docker-ce -y
    </p>
    <h5>
     4.所有节点设定 docker资源管理模式为systemd
    </h5>
    <p>
     <span style="color:#ff9900">
      [root@k8s-master ~]# vim /etc/docker/daemon.json
     </span>
    </p>
    <p>
     <span style="color:#ff9900">
      {
     </span>
    </p>
    <p>
     <span style="color:#ff9900">
      "registry-mirrors": ["https://reg.timinglee.org"],
     </span>
    </p>
    <p>
     "exec-opts": ["native.cgroupdriver=systemd"],
    </p>
    <p>
     "log-driver": "json-file",
    </p>
    <p>
     "log-opts": {
     <!-- -->
    </p>
    <p>
     "max-size": "100m"
    </p>
    <p>
     },
    </p>
    <p>
     "storage-driver": "overlay2"
    </p>
    <p>
     }
    </p>
    <h5>
     4.复制harbor仓库中的证书并启动docker
    </h5>
    <p>
     k8s-master:#mkdir /etc/docker/certs.d/reg.timinglee.org/ -p
    </p>
    <p>
     harbor:#scp /data/certs/timinglee.org.crt root@172.25.254.100:/etc/docker/certs.d/reg.timinglee.org/ca.crt
    </p>
    <p>
     同时把密钥拷给所有node节点
    </p>
    <p>
     确保master和所有节点都能访问harbor仓库
    </p>
    <h5>
     5.安装k8s部署工具
    </h5>
    <p>
     添加软件仓库中k8s源
    </p>
    <p>
     [root@k8s-master ~]# vim /etc/yum.repos.d/k8s.repo
    </p>
    <p>
     [k8s] name=k8s
    </p>
    <p>
     baseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.30/rpm
    </p>
    <p>
     gpgcheck=0
    </p>
    <p>
     #安装软件 [root@k8s-master ~]# dnf install kubelet-1.30.0 kubeadm-1.30.0 kubectl-1.30.0 -y
    </p>
    <h5>
     4.设置kubectl命令补全功能
    </h5>
    <p>
     [root@k8s-master ~]# dnf install bash-completion -y
    </p>
    <p>
     [root@k8s-master ~]# echo "source &gt; ~/.bashrc
    </p>
    <p>
     [root@k8s-master ~]# source ~/.bashrc
    </p>
    <h5>
     5.在master节点拉取k8s所需要的镜像
    </h5>
    <p>
     kubeadm config print init-defaults
    </p>
    <p>
    </p>
    <p>
     手动指定镜像下载位置和容器管理接口
    </p>
    <p>
     kubeadm config images pull \
    </p>
    <p>
     --image-repository registry.aliyuncs.com/google_containers \  #拉取镜像的位置现在我们所用的为aliyun的
    </p>
    <p>
     --kubernetes-version v1.30.0 \  #需要的版本
    </p>
    <p>
     --cri-socket=unix:///var/run/cri-dockerd.sock   #拉取需要连接容器控制器使用
    </p>
    <p>
     先在master登录harbor仓库
    </p>
    <p>
     拉取结束上传至我们的harbor仓库
    </p>
    <p>
     [root@k8s-master ~]# docker images | awk '/google/{ print $1":"$2}' \ | awk -F "/" '{system("docker  tag "$0" reg.timinglee.org/k8s/"$3)}'
    </p>
    <p>
     [root@k8s-master ~]# docker images | awk '/k8s/{system("docker push "$1":"$2)}'
    </p>
    <p>
    </p>
    <h5>
     6..在节点安装cri-docker
    </h5>
    <p>
     k8s从1.24版本开始就移除了dockershim 所以节点安装cri-docker插件才能使同docker
    </p>
    <p>
     在节点安装插件和插件依赖性用docker管理k8s 和docker依赖
    </p>
    <h5>
    </h5>
    <p>
    </p>
    <p>
     vim/lib/systemd/system/cri-docker.service#编写该文件夹 加上网络插件和根容器
    </p>
    <p>
     指定网络插件名称及基础容器镜像 ExecStart=/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --networkplugin=cni --pod-infra-container-image=reg.timinglee.org/k8
    </p>
    <p>
     systemctl daemon-reload
    </p>
    <p>
     以上操作master和node节点都要做
    </p>
    <p>
     例：scp -r /lib/systemd/system/cri-docker.service  @root172.25.254.10:/lib/systemd/system/cri-docker.service
    </p>
    <h5>
     7.集群初始化
    </h5>
    <p>
     #kubeadm init --pod-network-cidr=192.188.0.0/16 \  #初始化并设定容器集群的网络
    </p>
    <p>
     --image-repository reg.timinglee.org/k8s \  #
    </p>
    <p>
     --kubernetes-version v1.30.0 \ #指k8s版本
    </p>
    <p>
     --cri-socket=unix:///var/run/cri-dockerd.sock #指定插件使docker和k8s结合到一起使用
    </p>
    <p>
     #kubeadm reset --cri-socket=unix:///var/run/cri-dockerd.sock重置集群
    </p>
    <h5>
     8.指定主配置文件
    </h5>
    <p>
     #指定集群配置文件变量 [
    </p>
    <p>
     root@k8s-master ~]# echo "export KUBECONFIG=/etc/kubernetes/admin.conf" &gt;&gt; ~/.bash_profile
    </p>
    <p>
     source ~/.bash_profile
    </p>
    <p>
     初始化完成
    </p>
    <h5>
     9.安装网络插件
    </h5>
    <p>
     导入flannel插件 和 kube-flannel.yml
    </p>
    <p>
     将网络插件导入到本地docker仓库 并且上传到harbor仓库中
    </p>
    <p>
     kubectl apply -f kube-flannel.yml 安装flannel.yml
    </p>
    <h6>
     10.节点扩容
    </h6>
    <p>
     1.禁用swap
    </p>
    <p>
     2.安装kubelet-1.30.0 kubeadm-1.30.0 kubectl-1.30.0
    </p>
    <p>
     docker-ce
    </p>
    <p>
     cri-dockerd#连接docker和k8s 的 还有一个依赖
    </p>
    <p>
     修改cri-dockerd启动文件添加 vim /lib/systemd/system/cri-docker.service
    </p>
    <p>
     ExecStart=/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --networkplugin=cni --pod-infra-container-image=reg.timinglee.org/k8s/pause:3.9
    </p>
    <p>
     5 启动服务 kubelet.service cri-docker.service
    </p>
    <p>
     root@k8s-node1 &amp; 2 ~]# kubeadm join 172.25.254.100:6443 --token 5hwptm.zwn7epa6pvatbpwf --discovery-token-ca-cert-hash sha256:52f1a83b70ffc8744db5570288ab51987ef2b563bf906ba4244a300f61e9db23 --crisocket=unix:///var/run/cri-dockerd.soc
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f6878646378792f:61727469636c652f64657461696c732f313436323739353334" class_="artid" style="display:none">
 </p>
</div>


