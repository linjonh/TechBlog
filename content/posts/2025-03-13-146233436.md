---
layout: post
title: "经验分享SpringBoot集成Websocket开发-之-使用由-Jakarta-EE-规范提供的-API开发"
date: 2025-03-13 15:51:02 +0800
description: "WebSocket 是一种基于 TCP 协议的全双工通信协议，它允许客户端和服务器之间建立持久的、双向的通信连接。相比传统的 HTTP 请求 - 响应模式，WebSocket 提供了实时、低延迟的数据传输能力。通过 WebSocket，客户端和服务器可以在任意时间点互相发送消息，实现实时更新和即时通信的功能。WebSocket 协议经过了多个浏览器和服务器的支持，成为了现代 Web 应用中常用的通信协议之一。"
keywords: "【经验分享】SpringBoot集成Websocket开发 之 使用由 Jakarta EE 规范提供的 API开发"
categories: ['学习笔记']
tags: ['经验分享', 'Websocket', 'Spring', 'Boot']
artid: "146233436"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146233436
    alt: "经验分享SpringBoot集成Websocket开发-之-使用由-Jakarta-EE-规范提供的-API开发"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146233436
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146233436
cover: https://bing.ee123.net/img/rand?artid=146233436
image: https://bing.ee123.net/img/rand?artid=146233436
img: https://bing.ee123.net/img/rand?artid=146233436
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【经验分享】SpringBoot集成Websocket开发 之 使用由 Jakarta EE 规范提供的 API开发
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_Spring_Boot__WebSocket_2">
     </a>
     在 Spring Boot 中整合、使用 WebSocket
    </h2>
    <p>
     WebSocket 是一种基于 TCP 协议的全双工通信协议，它允许客户端和服务器之间建立持久的、双向的通信连接。相比传统的 HTTP 请求 - 响应模式，WebSocket 提供了实时、低延迟的数据传输能力。通过 WebSocket，客户端和服务器可以在任意时间点互相发送消息，实现实时更新和即时通信的功能。WebSocket 协议经过了多个浏览器和服务器的支持，成为了现代 Web 应用中常用的通信协议之一。它广泛应用于聊天应用、实时数据更新、多人游戏等场景，为 Web 应用提供了更好的用户体验和更高效的数据传输方式。
    </p>
    <p>
     本文将会指导你如何在 Spring Boot 中整合、使用 WebSocket，以及如何在
     <code>
      @ServerEndpoint
     </code>
     类中注入其他 Bean 依赖 。
    </p>
    <p>
     在 Spring Boot 中使用 WebSocket 有 2 种方式。第 1 种是使用由 Jakarta EE 规范提供的 Api，也就是
     <code>
      jakarta.websocket
     </code>
     包下的接口。第 2 种是使用 spring 提供的支持，也就是
     <a href="https://github.com/spring-projects/spring-framework/tree/main/spring-websocket">
      <code>
       spring-websocket
      </code>
     </a>
     模块。前者是一种独立于框架的技术规范，而后者是 Spring 生态系统的一部分，可以与其他 Spring 模块（如 Spring MVC、Spring Security）无缝集成，共享其配置和功能。
    </p>
    <p>
     2 种方式各有优劣，你可以按需选择。本文将使用第 1 种方式，也就是使用
     <code>
      jakarta.websocket
     </code>
     来开发 WebSocket 应用。
    </p>
    <p>
     软件版本：
    </p>
    <ul>
     <li>
      Spring Boot：
      <code>
       3.1.3
      </code>
     </li>
    </ul>
    <h3>
     <a id="_Spring_Boot__WebSocket_16">
     </a>
     在 Spring Boot 中整合 WebSocket
    </h3>
    <h4>
     <a id="_18">
     </a>
     添加依赖
    </h4>
    <p>
     在
     <code>
      pom.xml
     </code>
     中添加
     <code>
      spring-boot-starter-websocket
     </code>
     依赖。
    </p>
    <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-websocket<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h4>
     <a id="_ServerEndpoint__29">
     </a>
     开发 ServerEndpoint 端点
    </h4>
    <p>
     服务端 WebSocket 端点的开发也有 2 种方式。第 1 种是实现规范所提供的各种接口，通过接口定义的回调方法来处理新的连接、客户端消息、连接断开等等事件。另一种方式是使用注解，类似于 Spring 中的 Controller，通过在方法上使用不同的注解来监听不同的 WebSocket 事件，灵活性比较高，推荐使用。
    </p>
    <p>
     我们打算创建一个
     <code>
      echo
     </code>
     端点，该端点会处理客户端的连接、断开、消息事件。在收到消息后，我们会在消息前面加上服务器时间戳和
     <code>
      Hello
     </code>
     前缀，原样写回给客户端。如果客户端发送的消息为
     <code>
      bye
     </code>
     ，则服务器会主动断开与客户端的连接。
    </p>
    <pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>springdoc<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>channel</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Instant</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span><span class="token class-name">CloseReason</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span><span class="token class-name">EndpointConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span><span class="token class-name">OnClose</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span><span class="token class-name">OnError</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span><span class="token class-name">OnMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span><span class="token class-name">OnOpen</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span><span class="token class-name">Session</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerEndpoint</span></span><span class="token punctuation">;</span>

<span class="token comment">// 使用 @ServerEndpoint 注解表示此类是一个 WebSocket 端点</span>
<span class="token comment">// 通过 value 注解，指定 websocket 的路径</span>
<span class="token annotation punctuation">@ServerEndpoint</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/channel/echo"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoChannel</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> <span class="token constant">LOGGER</span> <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">EchoChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Session</span> session<span class="token punctuation">;</span>

    <span class="token comment">// 收到消息</span>
    <span class="token annotation punctuation">@OnMessage</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">{<!-- --></span>
        
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[websocket] 收到消息：id={}，message={}"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span><span class="token string">"bye"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 由服务器主动关闭连接。状态码为 NORMAL_CLOSURE（正常关闭）。</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span><span class="token class-name">CloseReason<span class="token punctuation">.</span>CloseCodes</span><span class="token punctuation">.</span><span class="token constant">NORMAL_CLOSURE</span><span class="token punctuation">,</span> <span class="token string">"Bye"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        
        <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">getAsyncRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendText</span><span class="token punctuation">(</span><span class="token string">"["</span><span class="token operator">+</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEpochMilli</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">"] Hello "</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 连接打开</span>
    <span class="token annotation punctuation">@OnOpen</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onOpen</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">,</span> <span class="token class-name">EndpointConfig</span> endpointConfig<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 保存 session 到对象</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>session <span class="token operator">=</span> session<span class="token punctuation">;</span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[websocket] 新的连接：id={}"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 连接关闭</span>
    <span class="token annotation punctuation">@OnClose</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClose</span><span class="token punctuation">(</span><span class="token class-name">CloseReason</span> closeReason<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[websocket] 连接断开：id={}，reason={}"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>closeReason<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 连接异常</span>
    <span class="token annotation punctuation">@OnError</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[websocket] 连接异常：id={}，throwable={}"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 关闭连接。状态码为 UNEXPECTED_CONDITION（意料之外的异常）</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CloseReason</span><span class="token punctuation">(</span><span class="token class-name">CloseReason<span class="token punctuation">.</span>CloseCodes</span><span class="token punctuation">.</span><span class="token constant">UNEXPECTED_CONDITION</span><span class="token punctuation">,</span> throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ​ 首先，使用
     <code>
      @ServerEndpoint
     </code>
     注解表示此类是一个 WebSocket 端点，
     <code>
      value
     </code>
     属性是必须的，用于设置路由。它还有其他的一些可选属性可以用于自定义子协议、消息编码器、消息解码器、握手处理器等等，篇幅原因这里不展开。
    </p>
    <h5>
     <a id="OnMessage_106">
     </a>
     @OnMessage
    </h5>
    <p>
     <code>
      @OnMessage
     </code>
     注解用于监听客户端消息事件，它只有一个属性
     <code>
      long maxMessageSize() default -1;
     </code>
     用于限制客户端消息的大小，如果小于等于 0 则表示不限制。当客户端消息体积超过这个阈值，那么服务器就会主动断开连接，状态码为：
     <code>
      1009
     </code>
     。方法的参数可以是基本的
     <code>
      String
     </code>
     /
     <code>
      byte[]
     </code>
     或者是
     <code>
      Reader
     </code>
     /
     <code>
      InputStream
     </code>
     ，分别表示 WebSocket 中的文本和二进制消息。也可以是自定义的 Java 对象，但是需要在
     <code>
      @ServerEndpoint
     </code>
     中配置对象的解码器（
     <code>
      jakarta.websocket.Decoder
     </code>
     ）。对于内容较长的消息，支持分批发送，可以在消息参数后面定义一个布尔类型的
     <code>
      boolean last
     </code>
     参数，如果该值为
     <code>
      true
     </code>
     则表示此消息是批次消息中的最后一条。
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@OnMessage</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token keyword">boolean</span> last<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>last<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 这是批量消息的最后一条</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="OnOpen_119">
     </a>
     @OnOpen
    </h5>
    <p>
     <code>
      @OnOpen
     </code>
     方法用于监听客户端的连接事件，它没有任何属性。可以作为方法参数的对象有很多，
     <code>
      Session
     </code>
     对象是必须的，表示当前连接对象，我们可以通过此对象来执行发送消息、断开连接等操作。WebSocket 的连接 URL，类似于 Http 的 URL，也可以传递查询参数、path 参数。通常用于传递认证、鉴权用的 Token 或其他信息。
    </p>
    <p>
     要获取查询参数，我们可以通过
     <code>
      Session
     </code>
     的
     <code>
      getRequestParameterMap();
     </code>
     获取。
    </p>
    <pre><code class="prism language-java"><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> query <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">getRequestParameterMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     要获取 path 参数，首先要在
     <code>
      @ServerEndpoint
     </code>
     中定义 path 参数，类似于 Spring Mvc 的 path 参数定义。例如：
     <code>
      @ServerEndpoint(value = "/channel/echo/{id}")
     </code>
     。那么我们可以在
     <code>
      @OnOpen
     </code>
     方法中使用
     <code>
      @PathParam
     </code>
     注解接收，如下：
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@ServerEndpoint</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/channel/echo/{id}"</span><span class="token punctuation">)</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token annotation punctuation">@OnOpen</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onOpen</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathParam</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">EndpointConfig</span> endpointConfig<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     示例中的最后一个参数
     <code>
      EndpointConfig
     </code>
     ，它是可选，用于获取全局的一些配置。在本文中未用到。
    </p>
    <h5>
     <a id="OnClose_144">
     </a>
     @OnClose
    </h5>
    <p>
     <code>
      @OnClose
     </code>
     用于处理连接断开事件，参数中可以指定一个
     <code>
      CloseReason
     </code>
     对象，它封装了断开连接的状态码、原因信息。
    </p>
    <h5>
     <a id="OnError_148">
     </a>
     @OnError
    </h5>
    <p>
     <code>
      @OnError
     </code>
     用于处理异常事件，
     <strong>
      该方法必须要有一个
      <code>
       Throwable
      </code>
      类型的参数
     </strong>
     ，表示发生的异常。否则应用会启用失败：
    </p>
    <pre><code class="prism language-txt">Caused by: jakarta.websocket.DeploymentException: No Throwable parameter was present on the method [onError] of class [cn.springdoc.demo.channel.EchoChannel] that was annotated with OnError
    at org.apache.tomcat.websocket.pojo.PojoMethodMapping.getPathParams(PojoMethodMapping.java:311) ~[tomcat-embed-websocket-10.1.12.jar:10.1.12]
    at org.apache.tomcat.websocket.pojo.PojoMethodMapping.&lt;init&gt;(PojoMethodMapping.java:194) ~[tomcat-embed-websocket-10.1.12.jar:10.1.12]
    at org.apache.tomcat.websocket.server.WsServerContainer.addEndpoint(WsServerContainer.java:130) ~[tomcat-embed-websocket-10.1.12.jar:10.1.12]
    at org.apache.tomcat.websocket.server.WsServerContainer.addEndpoint(WsServerContainer.java:240) ~[tomcat-embed-websocket-10.1.12.jar:10.1.12]
    at org.apache.tomcat.websocket.server.WsServerContainer.addEndpoint(WsServerContainer.java:198) ~[tomcat-embed-websocket-10.1.12.jar:10.1.12]
    at org.springframework.web.socket.server.standard.ServerEndpointExporter.registerEndpoint(ServerEndpointExporter.java:156) ~[spring-websocket-6.0.11.jar:6.0.11]
    ... 12 common frames omitted
</code></pre>
    <p>
     所有事件方法，都支持使用
     <code>
      Session
     </code>
     作为参数，表示当前连接参数。但是为了更加方便，我们在
     <code>
      @OnOpen
     </code>
     事件中直接把
     <code>
      Session
     </code>
     存储到了当前对象中，可以在任意方法中使用
     <code>
      this
     </code>
     访问。服务器会为每个连接创建一个端点对象，所以这是线程安全的。
    </p>
    <p>
     上面还提到了一个 “连接关闭状态码”，WebSocket 协议定义了一系列状态码来表示连接断开的原因，这些状态码定义在了
     <code>
      CloseReason.CloseCodes
     </code>
     枚举中。
    </p>
    <h4>
     <a id="_ServerEndpointExporter_167">
     </a>
     配置 ServerEndpointExporter
    </h4>
    <p>
     定义好端点后，需要在配置类中通过定义
     <code>
      ServerEndpointExporter
     </code>
     Bean 进行注册。
    </p>
    <pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>springdoc<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>socket<span class="token punctuation">.</span>server<span class="token punctuation">.</span>standard<span class="token punctuation">.</span></span><span class="token class-name">ServerEndpointExporter</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>springdoc<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>channel<span class="token punctuation">.</span></span><span class="token class-name">EchoChannel</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSocketConfiguration</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>  
    <span class="token keyword">public</span> <span class="token class-name">ServerEndpointExporter</span> serverEndpointExporter <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        
        <span class="token class-name">ServerEndpointExporter</span> exporter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServerEndpointExporter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 手动注册 WebSocket 端点</span>
        exporter<span class="token punctuation">.</span><span class="token function">setAnnotatedEndpointClasses</span><span class="token punctuation">(</span><span class="token class-name">EchoChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> exporter<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
    <p>
     你也可以在 WebSocket 端点上添加
     <code>
      @Component
     </code>
     注解，使用 Spring 自动扫描，这样的话不需要手动调用
     <code>
      setAnnotatedEndpointClasses
     </code>
     方法进行注册。
    </p>
    <h5>
     <a id="_198">
     </a>
     说明：
    </h5>
    <p>
     另外一点就是服务端如何发送消息给客户端，服务端发送消息必须通过上面说的 Session 类，通常是在@OnOpen 方法中，当连接成功后把 session 存入 Map 的 value，key 是与 session 对应的用户标识，当要发送的时候通过 key 获得 session 再发送，这里可以通过
     <strong>
      session.getBasicRemote
     </strong>
     <em>
      <strong>
       ()
      </strong>
     </em>
     <strong>
      .sendText
     </strong>
     <em>
      <strong>
       (
      </strong>
     </em>
     <strong>
      )
     </strong>
     来对客户端发送消息。
    </p>
    <h3>
     <a id="_202">
     </a>
     测试
    </h3>
    <p>
     在项目的
     <code>
      src/main/resources
     </code>
     目录下创建一个
     <code>
      public
     </code>
     文件夹，再在此文件夹中新建一个
     <code>
      index.html
     </code>
     文件，作为 WebSocket 客户端。内容如下：
    </p>
    <blockquote>
     <p>
      Spring Boot 默认会把
      <code>
       public
      </code>
      目录下的
      <code>
       index.html
      </code>
      作为应用主页。
     </p>
    </blockquote>
    <pre><code class="prism language-html"><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>WebSocket<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
        <span class="token keyword">let</span> websocket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WebSocket</span><span class="token punctuation">(</span><span class="token string">"ws://localhost:8080/channel/echo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 连接断开</span>
        websocket<span class="token punctuation">.</span><span class="token function-variable function">onclose</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">连接关闭: code=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>e<span class="token punctuation">.</span>code<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, reason=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>e<span class="token punctuation">.</span>reason<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 收到消息</span>
        websocket<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">收到消息：</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>e<span class="token punctuation">.</span>data<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 异常</span>
        websocket<span class="token punctuation">.</span><span class="token function-variable function">onerror</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"连接异常"</span><span class="token punctuation">)</span>
            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 连接打开</span>
        websocket<span class="token punctuation">.</span><span class="token function-variable function">onopen</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"连接打开"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 创建连接后，往服务器连续写入3条消息</span>
            websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"springdoc.cn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"springdoc.cn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"springdoc.cn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 最后发送 bye，由服务器断开连接</span>
            websocket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">"bye"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token comment">// 也可以由客户端主动断开</span>
            <span class="token comment">// websocket.close();</span>
        <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
     内容很简单，网页加载后运行 Javascript 代码。立即创建与
     <code>
      ws://localhost:8080/channel/echo
     </code>
     的 WebSocket 连接对象，通过注册对象的各种监听方法来处理事件。
    </p>
    <p>
     在连接就绪后，也就是在
     <code>
      onopen
     </code>
     方法中往服务器端点发送了 3 条消息。按照逻辑，服务端也会回复 3 条消息，这会触发
     <code>
      onmessage
     </code>
     事件，把消息内容输出到控制台。最后，发送
     <code>
      bye
     </code>
     ，服务器收到消息后会主动断开连接，这就会触发
     <code>
      onclose
     </code>
     事件，把 “连接关闭状态码” 和原因输出到控制台。
    </p>
    <blockquote>
     <p>
      其实你可以直接把这段 Javascript 代码复制到任意支持 WebSocket 的浏览器的控制台执行，WebSocket 没有跨域的说法！
     </p>
    </blockquote>
    <p>
     启动应用，打开浏览器（先打开控制台），然后访问
     <code>
      http://localhost:8080/
     </code>
     ，查看控制台输出的日志：
    </p>
    <pre><code class="prism language-txt">连接打开
收到消息：[1694505275009] Hello springdoc.cn
收到消息：[1694505275012] Hello springdoc.cn
收到消息：[1694505275014] Hello springdoc.cn
连接关闭: code=1000, reason=Bye
</code></pre>
    <p>
     再看看服务端控制台日志：
    </p>
    <pre><code class="prism language-txt">cn.springdoc.demo.channel.EchoChannel    : [websocket] 新的连接：id=0
cn.springdoc.demo.channel.EchoChannel    : [websocket] 收到消息：id=0，message=springdoc.cn
cn.springdoc.demo.channel.EchoChannel    : [websocket] 收到消息：id=0，message=springdoc.cn
cn.springdoc.demo.channel.EchoChannel    : [websocket] 收到消息：id=0，message=springdoc.cn
cn.springdoc.demo.channel.EchoChannel    : [websocket] 收到消息：id=0，message=bye
cn.springdoc.demo.channel.EchoChannel    : [websocket] 连接断开：id=0，reason=CloseReason: code [1000], reason [Bye]
</code></pre>
    <p>
     没有任何问题，一切按照我们预定义的逻辑在运行。客户端发送 3 条消息，服务器响应 3 条消息，最后断开连接。客户端、服务器相应的事件方法都成功执行。
    </p>
    <p>
     服务端日志中的 sessionId（
     <code>
      id=0
     </code>
     ），是通过
     <code>
      Session
     </code>
     的
     <code>
      String getId();
     </code>
     方法获取的。服务器会为每个连接分配一个不同的 id 值，不同服务器生成的 id 类型不一样。 Tomcat 使用从 0 开始的自增值（本例），Undertow 使用的是类似于 UUID 的 32 位长度的字符串。
    </p>
    <h3>
     <a id="_Bean_283">
     </a>
     在端点中注入 Bean
    </h3>
    <p>
     往往我们需要在端点中使用其他 Spring 管理的 Bean 来完成业务，例如认证、鉴权、保存消息。。。等等。
    </p>
    <p>
     假如我们有一个
     <code>
      UserService
     </code>
     服务类，内容如下：
    </p>
    <pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">cn<span class="token punctuation">.</span>springdoc<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token comment">// ....</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     我们现在要在端点中注入使用它，很多人会直接在端点类上使用
     <code>
      @Component
     </code>
     注解，然后注入：
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@ServerEndpoint</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/channel/echo"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>  <span class="token comment">// 注册为 Spring 组件</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoChannel</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span> <span class="token comment">// 注入需要的 Bean</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token comment">// ...</span>

    <span class="token annotation punctuation">@OnOpen</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onOpen</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">,</span> <span class="token class-name">EndpointConfig</span> endpointConfig<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>session <span class="token operator">=</span> session<span class="token punctuation">;</span>

        <span class="token comment">// 在业务中使用</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     服务可以正常启动，看似一切都没问题！可是当你在事件方法中使用这 Bean 的时候就会导致
     <code>
      NullPointerException
     </code>
     异常。
    </p>
    <pre><code class="prism language-txt">java.lang.NullPointerException: Cannot invoke "cn.springdoc.demo.service.UserService.foo()" because "this.userService" is null
    at cn.springdoc.demo.channel.EchoChannel.onOpen(EchoChannel.java:54)
    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)
    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
    at java.base/java.lang.reflect.Method.invoke(Method.java:568)
    at org.apache.tomcat.websocket.pojo.PojoEndpointBase.doOnOpen(PojoEndpointBase.java:67)
    at org.apache.tomcat.websocket.pojo.PojoEndpointServer.onOpen(PojoEndpointServer.java:46)
    at org.apache.tomcat.websocket.server.WsHttpUpgradeHandler.init(WsHttpUpgradeHandler.java:131)
    at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:936)
    at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1740)
    at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)
    at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1191)
    at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:659)
    at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
    at java.base/java.lang.Thread.run(Thread.java:833)
</code></pre>
    <p>
     <strong>
      原因：运行时的 WebSocket 连接对象，也就是端点实例，是由服务器创建，而不是 Spring，所以不能使用自动装配
     </strong>
     。上文也提到过 “服务器会为每个连接创建一个端点实例对象”。
    </p>
    <p>
     知道了原因后，解决办法也很简单，我们可以使用 Spring 的
     <code>
      ApplicationContextAware
     </code>
     接口，在应用启动时获取到
     <code>
      ApplicationContext
     </code>
     并且保存在全局静态变量中。
    </p>
    <p>
     服务器每次创建连接的时候，我们就在
     <code>
      @OnOpen
     </code>
     事件方法中从
     <code>
      ApplicationContext
     </code>
     获取到需要 Bean 来初始化端点对象。
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@ServerEndpoint</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/channel/echo"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>  <span class="token comment">// 由 spring 扫描管理</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EchoChannel</span> <span class="token keyword">implements</span>
                <span class="token class-name">ApplicationContextAware</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 实现 ApplicationContextAware 接口， Spring 会在运行时注入 ApplicationContext</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> <span class="token constant">LOGGER</span> <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">EchoChannel</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 全局静态变量，保存 ApplicationContext</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Session</span> session<span class="token punctuation">;</span>

    <span class="token comment">// 声明需要的 Bean</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>


    <span class="token comment">// 保存 Spring 注入的 ApplicationContext 到静态变量</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setApplicationContext</span><span class="token punctuation">(</span><span class="token class-name">ApplicationContext</span> applicationContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">BeansException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">EchoChannel</span><span class="token punctuation">.</span>applicationContext <span class="token operator">=</span> applicationContext<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@OnOpen</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onOpen</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">,</span> <span class="token class-name">EndpointConfig</span> endpointConfig<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        
        <span class="token comment">// 保存 session 到对象</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>session <span class="token operator">=</span> session<span class="token punctuation">;</span>
        
        <span class="token comment">// 连接创建的时候，从 ApplicationContext 获取到 Bean 进行初始化</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userService <span class="token operator">=</span> <span class="token class-name">EchoChannel</span><span class="token punctuation">.</span>applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 在业务中使用</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>userService<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token constant">LOGGER</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"[websocket] 新的连接：id={}"</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ....</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      onOpen
     </code>
     方法在整个连接的生命周期中，只会执行一次，所以这种方式不会带来通信时的性能损耗。
    </p>
    <p>
     进阶阅读：
    </p>
    <ul>
     <li>
      <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket" rel="nofollow">
       MDN
      </a>
     </li>
     <li>
      <a href="https://springdoc.cn/spring-boot-websocket/" rel="nofollow">
       官方文档地址
      </a>
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f58636f6e675f5a68752f:61727469636c652f64657461696c732f313436323333343336" class_="artid" style="display:none">
 </p>
</div>


