---
layout: post
title: "18-实现简洁架构的-Handler-层"
date: 2025-03-12 23:34:17 +0800
description: "本节课介绍如何实现简介架构的 Handler 层"
keywords: "18 | 实现简洁架构的 Handler 层"
categories: ['项目开发极速入门课', 'Go']
tags: ['开发语言', '云原生', 'Kubernetes', 'Golang', 'Ai']
artid: "146217286"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146217286
    alt: "18-实现简洁架构的-Handler-层"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146217286
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146217286
cover: https://bing.ee123.net/img/rand?artid=146217286
image: https://bing.ee123.net/img/rand?artid=146217286
img: https://bing.ee123.net/img/rand?artid=146217286
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     18 | 实现简洁架构的 Handler 层
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      <strong>
       提示：
      </strong>
     </p>
     <ul>
      <li>
       所有体系课见专栏：
       <a href="https://blog.csdn.net/lnxfei/category_12907774.html">
        Go 项目开发极速入门实战课
       </a>
       ；
      </li>
      <li>
       欢迎加入
       <a href="https://konglingfei.com" rel="nofollow">
        云原生 AI 实战
       </a>
       星球，12+ 高质量体系课、20+ 高质量实战项目助你在 AI 时代建立技术竞争力（聚焦于 Go、云原生、AI Infra）；
      </li>
      <li>
       本节课最终源码位于 fastgo 项目的
       <a href="https://github.com/onexstack/fastgo/tree/feature/s14">
        feature/s14
       </a>
       分支；
      </li>
      <li>
       更详细的课程版本见：
       <a href="https://konglingfei.com/cloudai/catalog/intermediate.html" rel="nofollow">
        Go 项目开发中级实战课
       </a>
       ：27 | 业务实现（4）：实现 Handler 层代码
      </li>
     </ul>
    </blockquote>
    <p>
     fastgo 三层简洁架构开发的最后一步便是开发 Handler 层代码。Handler 层代码的实现思路和 Biz 层、Store 层保持一致。
    </p>
    <h3>
     <a id="Handler__7">
     </a>
     Handler 实现
    </h3>
    <p>
     要实现 Handler，主要分为以下几步：
    </p>
    <ol>
     <li>
      实现创建 Handler 层实例的方法；
     </li>
     <li>
      实现用户相关 Handler 方法；
     </li>
     <li>
      对请求参数进行校验；
     </li>
     <li>
      初始化 Handler。
     </li>
    </ol>
    <h4>
     <a id="_1_Handler__14">
     </a>
     步骤 1：实现创建 Handler 层实例的方法
    </h4>
    <p>
     HTTP API 接口最终的逻辑是由 Handler 方法来实现的。所以，需要先实现 Handler 方法。
    </p>
    <p>
     fastgo 项目的 Handler 层代码位于
     <a href="https://github.com/onexstack/fastgo/tree/feature/s14/internal/apiserver/handler">
      internal/apiserver/handler/
     </a>
     目录中。新建一个
     <a href="https://github.com/onexstack/fastgo/blob/feature/s14/internal/apiserver/handler/handler.go#L15">
      Handler
     </a>
     结构体，该结构体包含了 fg-apiserver 的路由函数。代码位于 internal/apiserver/handler/handler.go 文件中，内容如下：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> handler

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token string">"github.com/onexstack/fastgo/internal/apiserver/biz"</span>
<span class="token punctuation">)</span>

<span class="token comment">// Handler 处理博客模块的请求.</span>
<span class="token keyword">type</span> Handler <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    biz biz<span class="token punctuation">.</span>IBiz
<span class="token punctuation">}</span>

<span class="token comment">// NewHandler 创建新的 Handler 实例.</span>
<span class="token keyword">func</span> <span class="token function">NewHandler</span><span class="token punctuation">(</span>biz biz<span class="token punctuation">.</span>IBiz<span class="token punctuation">)</span> <span class="token operator">*</span>Handler <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Handler<span class="token punctuation">{<!-- --></span>
        biz<span class="token punctuation">:</span> biz<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     Handler 结构体中包含了 Biz 层的 IBiz 接口，IBiz 接口中包含的方法用来执行具体的业务逻辑。:
    </p>
    <h4>
     <a id="_2__Handler__40">
     </a>
     步骤 2： 实现用户相关 Handler 方法
    </h4>
    <p>
     <a href="https://github.com/onexstack/fastgo/blob/feature/s14/internal/apiserver/handler/user.go">
      internal/apiserver/handler/user.go
     </a>
     文件中包含了用户相关的 Handler 方法。这些 Handler 方法的实现逻辑保持一致。实现逻辑如下：
    </p>
    <p>
     <img alt="画板" src="https://i-blog.csdnimg.cn/img_convert/952ec43abe3e90c0d2bae31d0dbb9918.jpeg"/>
    </p>
    <p>
     这里，我介绍下
     <a href="https://github.com/onexstack/fastgo/blob/feature/s14/internal/apiserver/handler/user.go#L20">
      CreateUser
     </a>
     路由方法的实现，其他路由实现方法类似。
     <code>
      CreateUser
     </code>
     路由方法代码如下：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// CreateUser 创建新用户.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>Handler<span class="token punctuation">)</span> <span class="token function">CreateUser</span><span class="token punctuation">(</span>c <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    slog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Create user function called"</span><span class="token punctuation">)</span>

    <span class="token keyword">var</span> rq v1<span class="token punctuation">.</span>CreateUserRequest
    <span class="token keyword">if</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">ShouldBindJSON</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        core<span class="token punctuation">.</span><span class="token function">WriteResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> errorsx<span class="token punctuation">.</span>ErrBind<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> err <span class="token operator">:=</span> validation<span class="token punctuation">.</span><span class="token function">ValidateCreateUserRequest</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        core<span class="token punctuation">.</span><span class="token function">WriteResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> errorsx<span class="token punctuation">.</span>ErrInvalidArgument<span class="token punctuation">.</span><span class="token function">WithMessage</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span><span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    resp<span class="token punctuation">,</span> err <span class="token operator">:=</span> h<span class="token punctuation">.</span>biz<span class="token punctuation">.</span><span class="token function">UserV1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>Request<span class="token punctuation">.</span><span class="token function">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>rq<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        core<span class="token punctuation">.</span><span class="token function">WriteResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> err<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    core<span class="token punctuation">.</span><span class="token function">WriteResponse</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> resp<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     首先调用
     <code>
      c.ShouldBindJSON
     </code>
     方法将请求中的参数解析到
     <code>
      v1.CreateUserRequest
     </code>
     类型的变量
     <code>
      rq
     </code>
     中。如果解析失败，返回
     <code>
      errorsx.ErrBind
     </code>
     类型的自定义错误。
    </p>
    <p>
     接着，调用
     <code>
      validation.ValidateCreateUserRequest
     </code>
     函数，对请求参数进行校验。为了统一管理请求参数的校验方法，提高代码可维护性。将校验方法统一放在
     <code>
      validation
     </code>
     （位于
     <a href="https://github.com/onexstack/fastgo/tree/feature/s14/internal/apiserver/pkg/validation">
      internal/apiserver/pkg/validation
     </a>
     目录中）。如果校验失败，返回
     <code>
      errorsx.ErrInvalidArgument
     </code>
     类型的自定义错误。这里要注意，传递的 context 是
     <code>
      c.Request.Context()
     </code>
     ，而不是
     <code>
      *gin.Context
     </code>
     类型的变量
     <code>
      c
     </code>
     。因为
     <code>
      c
     </code>
     中缺少了一些 HTTP 请求上下文信息。
    </p>
    <p>
     接着，调用 Biz 层的方法
     <code>
      h.biz.UserV1().Create
     </code>
     执行具体的业务逻辑。
    </p>
    <p>
     <code>
      gin.Context
     </code>
     结构体类型提供了以下方法，分别用来绑定不同位置的请求参数到结构体：
    </p>
    <ul>
     <li>
      <code>
       ShouldBindJSON
      </code>
      ：
     </li>
     <li>
      <code>
       ShouldBindUri
      </code>
      ：将请求中的路径参数绑定到 Go 结构体中的对应字段上，这些字段跟路径参数的映射关系，是通过 Go 结构体字段的
      <code>
       uri
      </code>
      标签来映射的；
     </li>
     <li>
      XXXX：
     </li>
    </ul>
    <h4>
     <a id="_3_84">
     </a>
     步骤 3：对请求参数进行校验
    </h4>
    <p>
     首先创建一个校验类型的结构体
     <a href="https://github.com/onexstack/fastgo/blob/feature/s14/internal/apiserver/pkg/validation/validation.go#L8">
      Validator
     </a>
     ，代码位于 internal/apiserver/pkg/validation/validation.go 文件中，内容如下：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// Validator 是验证逻辑的实现结构体.</span>
<span class="token keyword">type</span> Validator <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 有些复杂的验证逻辑，可能需要直接查询数据库</span>
    <span class="token comment">// 这里只是一个举例，如果验证时，有其他依赖的客户端/服务/资源等，</span>
    <span class="token comment">// 都可以一并注入进来</span>
    store store<span class="token punctuation">.</span>IStore
<span class="token punctuation">}</span>

<span class="token comment">// NewValidator 创建一个新的 Validator 实例.</span>
<span class="token keyword">func</span> <span class="token function">NewValidator</span><span class="token punctuation">(</span>store store<span class="token punctuation">.</span>IStore<span class="token punctuation">)</span> <span class="token operator">*</span>Validator <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>Validator<span class="token punctuation">{<!-- --></span>store<span class="token punctuation">:</span> store<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在
     <code>
      Validator
     </code>
     结构体中，可以添加校验逻辑中依赖的依赖项。例如
     <code>
      store.IStore
     </code>
     类型的实例，第三方微服务客户端等。以此实现更加复杂的校验逻辑。
    </p>
    <p>
     <a href="https://github.com/onexstack/fastgo/blob/feature/s14/internal/apiserver/pkg/validation/user.go#L10">
      ValidateCreateUserRequest
     </a>
     方法实现如下：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>v <span class="token operator">*</span>Validator<span class="token punctuation">)</span> <span class="token function">ValidateCreateUserRequest</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> rq <span class="token operator">*</span>v1<span class="token punctuation">.</span>CreateUserRequest<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Validate username</span>
    <span class="token keyword">if</span> rq<span class="token punctuation">.</span>Username <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Username cannot be empty"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>rq<span class="token punctuation">.</span>Username<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">4</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>rq<span class="token punctuation">.</span>Username<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">32</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Username must be between 4 and 32 characters"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Username can only contain letters, numbers, and underscores</span>
    usernameRegex <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">MustCompile</span><span class="token punctuation">(</span><span class="token string">`^[a-zA-Z0-9_]+$`</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>usernameRegex<span class="token punctuation">.</span><span class="token function">MatchString</span><span class="token punctuation">(</span>rq<span class="token punctuation">.</span>Username<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Username can only contain letters, numbers, and underscores"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Validate password</span>
    <span class="token keyword">if</span> rq<span class="token punctuation">.</span>Password <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Password cannot be empty"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>rq<span class="token punctuation">.</span>Password<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">8</span> <span class="token operator">||</span> <span class="token function">len</span><span class="token punctuation">(</span>rq<span class="token punctuation">.</span>Password<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">64</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Password must be between 8 and 64 characters"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Validate password complexity (must contain at least one letter and one number)</span>
    passwordRegex <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">MustCompile</span><span class="token punctuation">(</span><span class="token string">`^.*(?=.*[a-zA-Z])(?=.*\d).*$`</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>passwordRegex<span class="token punctuation">.</span><span class="token function">MatchString</span><span class="token punctuation">(</span>rq<span class="token punctuation">.</span>Password<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Password must contain at least one letter and one number"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Validate nickname (if provided)</span>
    <span class="token keyword">if</span> rq<span class="token punctuation">.</span>Nickname <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>rq<span class="token punctuation">.</span>Nickname <span class="token operator">!=</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span><span class="token operator">*</span>rq<span class="token punctuation">.</span>Nickname<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">32</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Nickname cannot exceed 32 characters"</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Validate email</span>
    <span class="token keyword">if</span> rq<span class="token punctuation">.</span>Email <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Email cannot be empty"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    emailRegex <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">MustCompile</span><span class="token punctuation">(</span><span class="token string">`^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$`</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>emailRegex<span class="token punctuation">.</span><span class="token function">MatchString</span><span class="token punctuation">(</span>rq<span class="token punctuation">.</span>Email<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Invalid email format"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Validate phone number</span>
    <span class="token keyword">if</span> rq<span class="token punctuation">.</span>Phone <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Phone number cannot be empty"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Validate Chinese mainland phone number format (11 digits starting with 1)</span>
    phoneRegex <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">MustCompile</span><span class="token punctuation">(</span><span class="token string">`^1\d{10}$`</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token operator">!</span>phoneRegex<span class="token punctuation">.</span><span class="token function">MatchString</span><span class="token punctuation">(</span>rq<span class="token punctuation">.</span>Phone<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> errors<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token string">"Invalid phone number format, must be 11 digits starting with 1"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     上述校验逻辑代码比较简单，这里不再介绍。为了提高代码的可维护性，将用户相关的校验方法统一保存在 internal/apiserver/pkg/validation/user.go 文件中。user.go 文件中只实现了
     <code>
      v1.CreateUserRequest
     </code>
     请求结构体的校验逻辑。
    </p>
    <p>
     <code>
      v1.UpdateUserRequest
     </code>
     等其他请求结构体的校验代码实现，留个作业，由你来实现。
    </p>
    <h4>
     <a id="_4_Handler_167">
     </a>
     步骤 4：初始化 Handler
    </h4>
    <p>
     修改
     <a href="https://github.com/onexstack/fastgo/blob/feature/s14/internal/apiserver/server.go">
      internal/apiserver/server.go
     </a>
     文件，添加以下代码：
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> apiserver

<span class="token keyword">import</span> <span class="token punctuation">(</span>
    <span class="token operator">...</span>
    <span class="token string">"github.com/onexstack/fastgo/internal/apiserver/biz"</span>
    <span class="token string">"github.com/onexstack/fastgo/internal/apiserver/handler"</span>
    <span class="token string">"github.com/onexstack/fastgo/internal/apiserver/pkg/validation"</span>
    <span class="token string">"github.com/onexstack/fastgo/internal/apiserver/store"</span>
    <span class="token operator">...</span>
<span class="token punctuation">)</span>
<span class="token operator">...</span>
<span class="token comment">// NewServer 根据配置创建服务器.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>cfg <span class="token operator">*</span>Config<span class="token punctuation">)</span> <span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>Server<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">...</span>
    <span class="token comment">// 初始化数据库连接</span>
    db<span class="token punctuation">,</span> err <span class="token operator">:=</span> cfg<span class="token punctuation">.</span>MySQLOptions<span class="token punctuation">.</span><span class="token function">NewDB</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> err
    <span class="token punctuation">}</span>
    store <span class="token operator">:=</span> store<span class="token punctuation">.</span><span class="token function">NewStore</span><span class="token punctuation">(</span>db<span class="token punctuation">)</span>

    cfg<span class="token punctuation">.</span><span class="token function">InstallRESTAPI</span><span class="token punctuation">(</span>engine<span class="token punctuation">,</span> store<span class="token punctuation">)</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在
     <a href="https://github.com/onexstack/fastgo/blob/feature/s14/internal/apiserver/server.go#L45">
      NewServer
     </a>
     方法中，通过调用
     <code>
      cfg.MySQLOptions.NewDB()
     </code>
     创建了一个
     <code>
      *gorm.DB
     </code>
     的实例
     <code>
      db
     </code>
     ，再使用 db 创建了
     <code>
      store.IStore
     </code>
     的实例
     <code>
      store
     </code>
     。
    </p>
    <p>
     将路由安装代码在
     <a href="https://github.com/onexstack/fastgo/blob/feature/s14/internal/apiserver/server.go#L69">
      cfg.InstallRESTAPI
     </a>
     方法中实现，这样可以使
     <code>
      NewServer
     </code>
     更加简洁，同时也便于统一维护路由设置。
    </p>
    <p>
     <code>
      cfg.InstallRESTAPI
     </code>
     方法实现如下：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// 注册 API 路由。路由的路径和 HTTP 方法，严格遵循 REST 规范.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>cfg <span class="token operator">*</span>Config<span class="token punctuation">)</span> <span class="token function">InstallRESTAPI</span><span class="token punctuation">(</span>engine <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine<span class="token punctuation">,</span> store store<span class="token punctuation">.</span>IStore<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">...</span>
    <span class="token comment">// 创建核心业务处理器</span>
    handler <span class="token operator">:=</span> handler<span class="token punctuation">.</span><span class="token function">NewHandler</span><span class="token punctuation">(</span>biz<span class="token punctuation">.</span><span class="token function">NewBiz</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">,</span> validation<span class="token punctuation">.</span><span class="token function">NewValidator</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span><span class="token punctuation">)</span>

    authMiddlewares <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>gin<span class="token punctuation">.</span>HandlerFunc<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token comment">// 注册 v1 版本 API 路由分组</span>
    v1 <span class="token operator">:=</span> engine<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/v1"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 用户相关路由</span>
        userv1 <span class="token operator">:=</span> v1<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/users"</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 创建用户。这里要注意：创建用户是不用进行认证和授权的</span>
            userv1<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> handler<span class="token punctuation">.</span>CreateUser<span class="token punctuation">)</span>
            userv1<span class="token punctuation">.</span><span class="token function">PUT</span><span class="token punctuation">(</span><span class="token string">":userID"</span><span class="token punctuation">,</span> handler<span class="token punctuation">.</span>UpdateUser<span class="token punctuation">)</span>    <span class="token comment">// 更新用户信息</span>
            userv1<span class="token punctuation">.</span><span class="token function">DELETE</span><span class="token punctuation">(</span><span class="token string">":userID"</span><span class="token punctuation">,</span> handler<span class="token punctuation">.</span>DeleteUser<span class="token punctuation">)</span> <span class="token comment">// 删除用户</span>
            userv1<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">":userID"</span><span class="token punctuation">,</span> handler<span class="token punctuation">.</span>GetUser<span class="token punctuation">)</span>       <span class="token comment">// 查询用户详情</span>
            userv1<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> handler<span class="token punctuation">.</span>ListUser<span class="token punctuation">)</span>             <span class="token comment">// 查询用户列表.</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 博客相关路由</span>
        postv1 <span class="token operator">:=</span> v1<span class="token punctuation">.</span><span class="token function">Group</span><span class="token punctuation">(</span><span class="token string">"/posts"</span><span class="token punctuation">,</span> authMiddlewares<span class="token operator">...</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            postv1<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> handler<span class="token punctuation">.</span>CreatePost<span class="token punctuation">)</span>       <span class="token comment">// 创建博客</span>
            postv1<span class="token punctuation">.</span><span class="token function">PUT</span><span class="token punctuation">(</span><span class="token string">":postID"</span><span class="token punctuation">,</span> handler<span class="token punctuation">.</span>UpdatePost<span class="token punctuation">)</span> <span class="token comment">// 更新博客</span>
            postv1<span class="token punctuation">.</span><span class="token function">DELETE</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> handler<span class="token punctuation">.</span>DeletePost<span class="token punctuation">)</span>     <span class="token comment">// 删除博客</span>
            postv1<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">":postID"</span><span class="token punctuation">,</span> handler<span class="token punctuation">.</span>GetPost<span class="token punctuation">)</span>    <span class="token comment">// 查询博客详情</span>
            postv1<span class="token punctuation">.</span><span class="token function">GET</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> handler<span class="token punctuation">.</span>ListPost<span class="token punctuation">)</span>          <span class="token comment">// 查询博客列表</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在
     <code>
      InstallRESTAPI
     </code>
     方法中，通过
     <code>
      handler.NewHandler
     </code>
     函数创建了 Handler 层的实例。并使用 Handler 的实例
     <code>
      handler
     </code>
     提供的路由方法来设置 HTTP 路由。
    </p>
    <p>
     创建
     <code>
      handler
     </code>
     实例依赖
     <code>
      biz.IBiz
     </code>
     、
     <code>
      *validation.Validator
     </code>
     类型的实例。上述实例分别通过
     <code>
      biz.NewBiz(store)
     </code>
     、
     <code>
      validation.NewValidator(store)
     </code>
     函数来创建。
    </p>
    <p>
     上述代码，使用 Gin 框架提供的各类路由注册方法注册了符合 REST 规范的 HTTP 路由。Gin 框架如何注册路由，请阅读 Gin GitHub 项目仓库的 README 文件。上述代码注册的 HTTP 路由见 下表所示。
    </p>
    <table>
     <thead>
      <tr>
       <th>
        HTTP 路由（HTTP 方法 HTTP 路径）
       </th>
       <th>
        路由描述
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        GET /healthz
       </td>
       <td>
        健康检查接口
       </td>
      </tr>
      <tr>
       <td>
        POST /v1/users
       </td>
       <td>
        创建用户
       </td>
      </tr>
      <tr>
       <td>
        PUT /v1/users/:userID
       </td>
       <td>
        更新用户信息
       </td>
      </tr>
      <tr>
       <td>
        DELETE /v1/users/:userID
       </td>
       <td>
        删除用户
       </td>
      </tr>
      <tr>
       <td>
        GET /v1/users/:userID
       </td>
       <td>
        获取用户信息
       </td>
      </tr>
      <tr>
       <td>
        GET /v1/users
       </td>
       <td>
        列出所有用户
       </td>
      </tr>
      <tr>
       <td>
        POST /v1/posts
       </td>
       <td>
        创建文章
       </td>
      </tr>
      <tr>
       <td>
        PUT /v1/posts/:postID
       </td>
       <td>
        更新文章
       </td>
      </tr>
      <tr>
       <td>
        DELETE /v1/posts
       </td>
       <td>
        删除文章
       </td>
      </tr>
      <tr>
       <td>
        GET /v1/posts/:postID
       </td>
       <td>
        获取文章信息
       </td>
      </tr>
      <tr>
       <td>
        GET /v1/posts
       </td>
       <td>
        列出所有文章
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="_258">
     </a>
     编译并测试
    </h3>
    <p>
     执行以下命令重新编译并运行 fg-apiserver：
    </p>
    <pre><code class="prism language-go">$ <span class="token punctuation">.</span><span class="token operator">/</span>build<span class="token punctuation">.</span>sh
$ _output<span class="token operator">/</span>fg<span class="token operator">-</span>apiserver <span class="token operator">-</span>c configs<span class="token operator">/</span>fg<span class="token operator">-</span>apiserver<span class="token punctuation">.</span>yaml
</code></pre>
    <p>
     打开另一个 Linux 终端，执行以下命令测试 HTTP 接口是否正常工作：
    </p>
    <pre><code class="prism language-bash">$ <span class="token function">curl</span> <span class="token parameter variable">-XPOST</span> -H<span class="token string">'Content-Type: application/json'</span> http://127.0.0.1:6666/v1/users  <span class="token parameter variable">-d</span> <span class="token string">'{"username":"colin","password":"fastgo1234","nickname":"belm","email":"nosbelm@qq.com","phone":"1818888xxxx"}'</span>
<span class="token punctuation">{<!-- --></span><span class="token string">"userID"</span><span class="token builtin class-name">:</span><span class="token string">"user-gxqfqn"</span><span class="token punctuation">}</span>
</code></pre>
    <p>
     上述命令创建了一个新的用户，并返回了 用户 ID
     <code>
      user-gxqfqn
     </code>
     。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031313633343432312f:61727469636c652f64657461696c732f313436323137323836" class_="artid" style="display:none">
 </p>
</div>


