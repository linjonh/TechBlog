---
layout: post
title: "21.Linux-线程库的使用与封装"
date: 2025-03-11 17:50:26 +0800
description: "详细的讲讲解了linux中的线程库的使用与封装"
keywords: "21.Linux 线程库的使用与封装"
categories: ['Linux']
tags: ['进程空间布局', '系统调用', '笔记', '操作系统', 'Linux']
artid: "146165294"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146165294
    alt: "21.Linux-线程库的使用与封装"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146165294
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146165294
cover: https://bing.ee123.net/img/rand?artid=146165294
image: https://bing.ee123.net/img/rand?artid=146165294
img: https://bing.ee123.net/img/rand?artid=146165294
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     21.Linux 线程库的使用与封装
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     在linux内核中并没有线程的概念，只有轻量级进程LWP的概念，linux下的线程都是是由LWP进行模拟实现的。因此linux操作系统中不会提供线程的相关接口，只会提供轻量级线程的接口（如vfork，clone等）。但是在我们的学习过程中实际上学到的都是线程的概念，故而linux的设计者在用户和操作系统之间将轻量级进程的的系统调用进行了封装成库并提供给了用户，这样的线程我们称之为
     <strong>
      用户级线程库
     </strong>
     。
    </p>
    <p>
     接下来我们介绍一下linux系统中线程库的使用与封装。
    </p>
    <h2>
     <a id="_3">
     </a>
     一、线程库的使用
    </h2>
    <h3>
     <a id="11_POSIX_4">
     </a>
     1.1 POSIX线程库
    </h3>
    <p>
     在linux中，与线程有关的函数构成了一个完整的系列，绝大多数函数的名字都是以
     <code>
      pthread_
     </code>
     打头的。要想使用这些函数库，要通过引入头文件
     <code>
      &lt;pthread.h&gt;
     </code>
     ，而在链接这些线程函数库时要使用编译器命令的
     <code>
      -lpthread
     </code>
     选项。
    </p>
    <h3>
     <a id="12__6">
     </a>
     1.2 线程库的接口
    </h3>
    <h4>
     <a id="121___7">
     </a>
     1.2.1
     <strong>
      线程创建
     </strong>
    </h4>
    <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> <span class="token operator">*</span>thread<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">pthread_attr_t</span> <span class="token operator">*</span>attr<span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>start_routine<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//功能：创建一个新的线程</span>
<span class="token comment">//参数:</span>
	<span class="token comment">//thread：输出型参数，用以返回线程ID</span>
	<span class="token comment">//attr：设置线程的属性，attr为NULL表示使⽤默认属性</span>
	<span class="token comment">//start_routine：是个函数地址，即线程启动后要执⾏的函数，它的返回值也可以是任意类型（整型，字符型，对象）</span>
	<span class="token comment">//arg:传给线程启动函数的参数，可以是任意类型（整型，字符型，对象……）</span>
<span class="token comment">//返回值：成功返回0，失败返回错误码</span>
</code></pre>
    <p>
     <strong>
      示例：
     </strong>
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout<span class="token operator">&lt;&lt;</span><span class="token string">"new thread :"</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">)</span>arg<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    pthread_t thread1<span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread1<span class="token punctuation">,</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span>run<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"new thread1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pthread_t thread2<span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread2<span class="token punctuation">,</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span>run<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"new thread2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout<span class="token operator">&lt;&lt;</span><span class="token string">"main thread"</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      <strong>
       注意：
      </strong>
      <br/>
      • 新线程和主线程的运行顺序是不确定的。
      <br/>
      • 多线程的调度时间是基于对进程的时间片进行瓜分。
      <br/>
      • 多个线程向同一个文件（这里是显示器）进行写入时，在不加保护的情况下是会发生重入的，也就会产生数据不一致问题。
      <br/>
      • 线程是共享进程地址空间的。
      <br/>
      • 线程出现异常会导致当前进程的其他线程全部崩溃。
     </p>
    </blockquote>
    <h4>
     <a id="122__54">
     </a>
     1.2.2
     <strong>
      线程终止
     </strong>
    </h4>
    <p>
     和进程一样，线程创建之后也是要被等待和回收的！
    </p>
    <p>
     <mark>
      如果需要只终止某个线程而不终止整个进程的话，有三种方法：
     </mark>
     <br/>
     • 线程执行函数return。这种方法对主线程不适用，main函数return相当于调用exit。
     <br/>
     • 线程可以调用pthread_exit终止自己。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>value_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//功能：线程终⽌</span>
<span class="token comment">//参数:</span>
	<span class="token comment">//value_ptr:线程退出时的返回值。</span>
</code></pre>
    <blockquote>
     <p>
      需要注意pthread_exit或者return返回的指针所指向的内存单元
      <strong>
       必须是全局的或者是用malloc分配的
      </strong>
      ，不能在线程函数的栈上分配。因为当其它线程得到这个返回指针时线程函数已经退出了。
     </p>
    </blockquote>
    <p>
     • 一个线程可以调用pthread_cancel终止同一进程中的另一个线程。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">pthread_cancel</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//功能：取消一个执⾏中的线程</span>
<span class="token comment">//参数:</span>
	<span class="token comment">//thread:要取消的线程ID</span>
<span class="token comment">//返回值：成功返回0，失败返回错误码</span>
</code></pre>
    <h4>
     <a id="123__76">
     </a>
     1.2.3
     <strong>
      线程等待
     </strong>
    </h4>
    <blockquote>
     <p>
      <strong>
       为什么需要线程等待？
      </strong>
      <br/>
      因为已经退出的线程其空间没有被释放，仍然在进程的地址空间内。而创建新的线程不会复用刚才退出线程的地址空间。
     </p>
    </blockquote>
    <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">pthread_join</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>value_ptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//功能：等待线程结束</span>
<span class="token comment">//参数:</span>
	<span class="token comment">//thread:线程ID</span>
	<span class="token comment">//value_ptr:用以保存线程的返回值的地址</span>
<span class="token comment">//返回值：成功返回0；失败返回错误码</span>
</code></pre>
    <p>
     调用该函数的线程将挂起等待，直到id为thread的线程终止。
    </p>
    <p>
     <strong>
      thread线程以不同的方法终止，通过pthread_join得到的终止状态是不同的：
     </strong>
     <br/>
     • 如果thread线程通过return返回，那么value_ptr所指向的单元里存放的是thread线程函数的返回值。
     <br/>
     • 如果thread线程被别的线程调用pthread_cancel异常终掉，value_ptr所指向的单元里存放的是常数PTHREAD_CANCELED（
     <mark>
      (void*)-1
     </mark>
     ）。
     <br/>
     • 如果thread线程是自己调用pthread_exit终止的，value_ptr所指向的单元存放的是传给pthread_exit的参数。
     <br/>
     • 如果对thread线程的终止状态不感兴趣，则可以传NULL给value_ptr参数。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2ab747739eae43a6b709cbe86876ac9e.png">
      <br/>
      <strong>
       示例：
      </strong>
     </img>
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">run1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> count<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>count<span class="token operator">--</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout<span class="token operator">&lt;&lt;</span><span class="token string">"new thread :"</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">)</span>arg<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">pthread_exit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout<span class="token operator">&lt;&lt;</span><span class="token string">"退出成功！"</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">run2</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout<span class="token operator">&lt;&lt;</span><span class="token string">"new thread :"</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> <span class="token punctuation">)</span>arg<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//创建线程1，线程2</span>
    pthread_t thread1<span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread1<span class="token punctuation">,</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span>run1<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"new thread1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pthread_t thread2<span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>thread2<span class="token punctuation">,</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span>run2<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"new thread2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//取消线程2</span>
    <span class="token function">pthread_cancel</span><span class="token punctuation">(</span>thread2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout<span class="token operator">&lt;&lt;</span><span class="token string">"取消成功！"</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>

    <span class="token comment">//线程等待</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>ret1<span class="token punctuation">,</span><span class="token operator">*</span>ret2<span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thread1<span class="token punctuation">,</span><span class="token operator">&amp;</span>ret1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>thread2<span class="token punctuation">,</span><span class="token operator">&amp;</span>ret2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout<span class="token operator">&lt;&lt;</span><span class="token string">"等待成功！"</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
    cout<span class="token operator">&lt;&lt;</span><span class="token string">"ret1 :"</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>ret1<span class="token operator">&lt;&lt;</span><span class="token string">";ret2 :"</span><span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">long</span><span class="token punctuation">)</span>ret2<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-bash">caryon@VM-24-10-ubuntu:~/linux/thread$ ./thread 
new thread :new thread1
new thread :new thread2
new thread :new thread1
new thread :new thread2
new thread :new thread1
new thread :new thread2
取消成功！
new thread :new thread1
new thread :new thread1
等待成功！
ret1 :100<span class="token punctuation">;</span>ret2 :-1
</code></pre>
    <p>
     <mark>
      在多执行流的情况下，主执行流往往是最后退出的！
     </mark>
    </p>
    <h4>
     <a id="124__162">
     </a>
     1.2.4 线程分离
    </h4>
    <p>
     默认情况下，新创建的线程是joinable的，线程退出后需要对其进型pthread_join操作，否则无法释放资源从而造成系统泄漏。如果不关心线程的返回值的话join就是一种负担。这个时候我们可以告诉系统，当线程退出时，自动释放线程资源。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">pthread_detach</span><span class="token punctuation">(</span><span class="token class-name">pthread_t</span> thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//功能：进行线程分离</span>
<span class="token comment">//参数:</span>
	<span class="token comment">//thread:被分离的线程ID</span>
<span class="token comment">//返回值：成功返回0；失败返回错误码</span>
</code></pre>
    <p>
     可以是线程组内其他线程对目标线程进型分离，也可以是线程自己分离。
     <mark>
      joinable和分离是冲突的，一个线程不能既是joinable又是分离的。
     </mark>
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">thread_run</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//创建线程</span>
    pthread_t tid<span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> thread_run<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"thread1 run..."</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
    <span class="token comment">//分离线程</span>
    <span class="token function">pthread_detach</span><span class="token punctuation">(</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pthread wait success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"pthread wait failed\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-bash">caryon@VM-24-10-ubuntu:~/linux/thread$ ./thread 
thread1 run<span class="token punctuation">..</span>.
pthread <span class="token function">wait</span> failed
</code></pre>
    <h2>
     <a id="id_215">
     </a>
     二、线程id与进程空间布局
    </h2>
    <p>
     在线程创建、终止、等待时我们都有注意到pthread_t thread（线程id）这个参数的存在，这个id表示的是什么意思呢？
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>    
<span class="token punctuation">}</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    pthread_t tid<span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span>run<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"newthread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"0x%lx\n"</span><span class="token punctuation">,</span>tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-bash">caryon@VM-24-10-ubuntu:~/linux/thread$ ./thread 
0x7fae58e006c0
</code></pre>
    <p>
     我们可以看到这个id的值是一个地址，那这个地址是什么地址呀？
    </p>
    <blockquote>
     <p>
      通过ldd查看我们所形成的可执行程序是依赖pthread库的，这个库在程序运行时会加载到内存中，进而映射到进程地址空间里被所有的线程所共享。我们又知道linux系统中只有轻量级进程，线程是使用轻量级进程模拟实现的。但是用户想要查看当前线程的属性怎么办呢？
      <br/>
      linux内核中是存在这些属性的，但是Linux中不存在线程呀！这需要内核层与用户层进行解耦啊！故而线程的相关属性也是由pthread库进行维护的，用户可以通过pthread库来查看线程的属性。
     </p>
    </blockquote>
    <p>
     <mark>
      所以这个地址就是该线程的属性所对应的进程地址空间中的地址！
     </mark>
    </p>
    <p>
     我们可以使用下面这个函数获取当前线程的id：
    </p>
    <pre><code class="prism language-c"><span class="token class-name">pthread_t</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2c01c8acba7f4d4cad6146821f5d4e2c.png">
      <br/>
      上图就是进程地址空间中的tcb了。
      <br/>
      •
      <strong>
       struct pthread
      </strong>
      <br/>
      这个结构里面一定封装了LWP。
      <br/>
      •
      <strong>
       线程栈
      </strong>
      <br/>
      进程地址空间中的栈是主线程的栈，新线程的栈是通过动态申请创建的。
      <br/>
      •
      <strong>
       线程局部存储
      </strong>
      <br/>
      理论上来说全部变量是所有线程所共享的，即他们所访问的全局变量的地址是相同的！但是在声明全局变量是加上
      <code>
       __thread
      </code>
      进行修饰（
      <mark>
       修饰的只能是内置类型
      </mark>
      ）就表示给每个线程都来一份，即线程的局部性存储。
     </img>
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;pthread.h&gt;</span></span>
using namespace std<span class="token punctuation">;</span>

__thread <span class="token keyword">int</span> count<span class="token operator">=</span><span class="token number">100</span><span class="token punctuation">;</span>

<span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"new thread &amp;count : %p\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> nullptr<span class="token punctuation">;</span>    
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">pthread_t</span> tid<span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tid<span class="token punctuation">,</span>nullptr<span class="token punctuation">,</span>run<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token string">"newthread"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>tid<span class="token punctuation">,</span>nullptr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"main thread &amp;count : %p\n"</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-bash">caryon@VM-24-10-ubuntu:~/linux/thread$ ./thread 
new thread <span class="token operator">&amp;</span>count <span class="token builtin class-name">:</span> 0x71e23b2006bc
main thread <span class="token operator">&amp;</span>count <span class="token builtin class-name">:</span> 0x71e23ba8e4fc
</code></pre>
    <h2>
     <a id="_288">
     </a>
     三、线程的封装
    </h2>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">using</span> func_t <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>function<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">enum</span> <span class="token keyword">class</span> <span class="token class-name">TSTATUS</span>
<span class="token punctuation">{<!-- --></span>
    NEW<span class="token punctuation">,</span>
    RUNNING<span class="token punctuation">,</span>
    STOP
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Thread</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">// 成员方法！</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">Routine</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Thread <span class="token operator">*</span>t <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Thread <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        t<span class="token operator">-&gt;</span>_status <span class="token operator">=</span> TSTATUS<span class="token double-colon punctuation">::</span>RUNNING<span class="token punctuation">;</span>
        t<span class="token operator">-&gt;</span><span class="token function">_func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">EnableDetach</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> _joinable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">bool</span> <span class="token function">IsJoinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> _joinable<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Thread</span><span class="token punctuation">(</span>func_t func<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_func</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_status</span><span class="token punctuation">(</span>TSTATUS<span class="token double-colon punctuation">::</span>NEW<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_joinable</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _name <span class="token operator">=</span> <span class="token string">"Thread-"</span> <span class="token operator">+</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>number<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        _pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">bool</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_status <span class="token operator">!=</span> TSTATUS<span class="token double-colon punctuation">::</span>RUNNING<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_tid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> Routine<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">bool</span> <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_status <span class="token operator">==</span> TSTATUS<span class="token double-colon punctuation">::</span>RUNNING<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">pthread_cancel</span><span class="token punctuation">(</span>_tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            _status <span class="token operator">=</span> TSTATUS<span class="token double-colon punctuation">::</span>STOP<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">bool</span> <span class="token function">Join</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_joinable<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">pthread_join</span><span class="token punctuation">(</span>_tid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            _status <span class="token operator">=</span> TSTATUS<span class="token double-colon punctuation">::</span>STOP<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">Detach</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">EnableDetach</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_detach</span><span class="token punctuation">(</span>_tid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>string _name<span class="token punctuation">;</span>
    pthread_t _tid<span class="token punctuation">;</span>
    pid_t _pid<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> _joinable<span class="token punctuation">;</span> <span class="token comment">// 是否是分离的，默认不是</span>
    func_t _func<span class="token punctuation">;</span>
    TSTATUS _status<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f38303235383333362f:61727469636c652f64657461696c732f313436313635323934" class_="artid" style="display:none">
 </p>
</div>


