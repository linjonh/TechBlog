---
layout: post
title: "ios端通过微信小程序客服助手进行支付"
date: 2024-08-12 13:49:05 +0800
description: "通过微信小程序助手进行订单支付_微信小程序ios支付"
keywords: "微信小程序ios支付"
categories: ['未分类']
tags: ['微信小程序', 'Notepad', 'Ios']
artid: "141128397"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=141128397
  alt: "ios端通过微信小程序客服助手进行支付"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=141128397
featuredImagePreview: https://bing.ee123.net/img/rand?artid=141128397
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ios端通过微信小程序客服助手进行支付
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <a href="#_7" rel="nofollow">
        前言
       </a>
      </li>
      <li>
       <a href="#_15" rel="nofollow">
        一、如何开通微信小程序客户助手？
       </a>
      </li>
      <li>
       <a href="#_23" rel="nofollow">
        二、如何配置小程序消息回复的接口校验？
       </a>
      </li>
      <li>
       <a href="#_53" rel="nofollow">
        三、小程序客服消息如何处理？
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#httpsiblogcsdnimgcndirectb9f8063b0d7d41d6bf4f432320f6e836png_114" rel="nofollow">
          在这里插入图片描述
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_117" rel="nofollow">
        四、小程序客服消息已经回复了，如何使用公众号授权让用户进行微信付款了？
       </a>
      </li>
      <li>
       <a href="#_130" rel="nofollow">
        总结
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="_7">
     </a>
     前言
    </h2>
    <p>
     <code>
      小程序的ios端在众所周知的原因无法支付虚拟商品信息，互联网公司的处理方案：1.引导客户在H5页面进行支付，2.通过微信小程序客服助手引导客户授权公众号进行JSAPI调用支付
     </code>
    </p>
    <p>
     题主在查阅网上资料的时候，发现网上只是总结了大概得实现方案，并没有相关的实际案例代码给大家参考，如是题主使用的是接入小程序客服助手引导客户进行微信公众号授权后的JSAPI支付写了一套支付逻辑代码供大家参考。
    </p>
    <hr/>
    <h2>
     <a id="_15">
     </a>
     一、如何开通微信小程序客户助手？
    </h2>
    <p>
     <a href="https://mp.weixin.qq.com/" rel="nofollow">
      进入到微信公众平台
     </a>
     —&gt;登录选择–&gt;开发–&gt;开发管理–&gt;开发设置–&gt;消息推送
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/05438e5b3f3d42f98cb414f69df4236a.png">
      <br/>
      设置小程序客服消息需要转发到后端的url地址，设置token，数据格式题主选的xml，大家根据实际场景选择，影响不大。
     </img>
    </p>
    <blockquote>
     <p>
      注意：我们配置后端的url地址时，微信小程序提交的校验接口需要和服务器接收的转发的url地址保持一致，服务器校验的接口使用GET请求，小程序将用户消息转发到后端的接口需要用POST。例如：/wxMini//msg GET作为校验，/wxMini//msg POST作为处理接口转发请求的接口，在此接口里实现业务逻辑
     </p>
    </blockquote>
    <hr/>
    <h2>
     <a id="_23">
     </a>
     二、如何配置小程序消息回复的接口校验？
    </h2>
    <pre><code class="prism language-java">    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/msg"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@ResponseBody</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wechatInitCheck</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 微信加密签名，signature结合了开发者填写的token参数和请求中的timestamp参数、nonce参数。</span>
        <span class="token class-name">String</span> signature <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"signature"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 时间戳</span>
        <span class="token class-name">String</span> timestamp <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 随机数</span>
        <span class="token class-name">String</span> nonce <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"nonce"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 随机字符串</span>
        <span class="token class-name">String</span> echostr <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getParameter</span><span class="token punctuation">(</span><span class="token string">"echostr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"signature:{},timestamp:{},nonce:{},echostr:{}"</span><span class="token punctuation">,</span> signature<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> echostr<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//这边的数组排序，大家一定要按照这个要求来，这个是微信官方文档的要求</span>
       <span class="token comment">//，不然校验会报错</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> sort <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>wxConfig<span class="token punctuation">.</span><span class="token function">getMiniAppToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonce<span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>sort<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> sign <span class="token operator">=</span> <span class="token class-name">SecureUtil</span><span class="token punctuation">.</span><span class="token function">sha1</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>sort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sign<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> echostr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">"接入失败"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     接入成功后的小程序消息推送的配置效果，这样我们就完成了接收小程序客服消息的能力。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7ebfe2428c1341c4812d0bc917d60f99.png"/>
    </p>
    <hr/>
    <h2>
     <a id="_53">
     </a>
     三、小程序客服消息如何处理？
    </h2>
    <pre><code class="prism language-java">    <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"微信小程序消息回复处理"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/msg"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">disposeEvent</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//解析</span>
        <span class="token class-name">BufferedReader</span> br <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">StringBuilder</span> xmlData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> temp<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>temp <span class="token operator">=</span> br<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            xmlData<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//将收到的xml文件转换成map，大家可以根据具体的业务场景再次转换成对象</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> msgMap <span class="token operator">=</span> <span class="token class-name">XmlUtil</span><span class="token punctuation">.</span><span class="token function">xmlToMap</span><span class="token punctuation">(</span>xmlData<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//处理转发过来的微信小程序客服消息</span>
        wxMiniService<span class="token punctuation">.</span><span class="token function">disposeMsg</span><span class="token punctuation">(</span>msgMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

</code></pre>
<p>
处理收到的小程序转发的客服消息，解析消息后，可以在消息体当中解析出，用户小程序的 openid 参数为 FromUserName，以及消息的类型参数为 MsgType，然后内容 content，大家根据实际的场景去 debug 下消息的格式，下面是一个示例。
</p>
<pre><code class="prism language-powershell"><span class="token punctuation">{<!-- --></span>
AppId=xxxxxxxxxxxxx<span class="token punctuation">,</span>
PagePath=pages/mine/vip/index<span class="token punctuation">,</span>
Title=AI 短视频<span class="token punctuation">,</span>
ToUserName=xxxxx<span class="token punctuation">,</span>
<span class="token operator">/</span><span class="token operator">/</span>解析出来的用户的小程序 openid
FromUserName=xxxxx<span class="token punctuation">,</span>
<span class="token operator">/</span><span class="token operator">/</span>解析出来的消息类型，此处为小程序卡片消息
MsgType=miniprogrampage<span class="token punctuation">,</span>
ThumbMediaId=xxxxxxx<span class="token punctuation">,</span>
MsgId=24659455xxxxxxx<span class="token punctuation">}</span>
</code></pre>
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">disposeMsg</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> msgMap<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>msgMap<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"微信客服消息事件处理:{}"</span><span class="token punctuation">,</span> msgMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> msgType <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> msgMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"MsgType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>msgType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//题主这边处理的是小程序消息和普通文本类型的消息，实际应用场景大家可以自行转换</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>msgType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"miniprogrampage"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>msgType<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"text"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token class-name">String</span> userOpenId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> msgMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"FromUserName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//todo 获取当用户的小程序 openid，就可以通过小程序客服助手给指定的</span>
<span class="token comment">//openid 的小程序用户发送消息</span>
<span class="token punctuation">}</span>
</code></pre>
<p>
效果如下图所示，我这边处理的的小程序卡片消息，小程序卡片消息当中
<strong>
包含了订单信息，后端根据这个订单消息进行后续处理
</strong>
，然后返回给用户一个包含一个跳转地址的图文连接消息。
</p>
<h3>
<a id="httpsiblogcsdnimgcndirectb9f8063b0d7d41d6bf4f432320f6e836png_114">
</a>
<img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b9f8063b0d7d41d6bf4f432320f6e836.png"/>
</h3>
<h2>
<a id="_117">
</a>
四、小程序客服消息已经回复了，如何使用公众号授权让用户进行微信付款了？
</h2>
<p>
题主当时想到的办法是，返回一个包含一个 H5 页面地址给前端，前端在根据打开的 H5 页面地址进行，后续的微信公众号的授权及付款操作。但是这样处理起来整个流程就会特别复杂，链路会很长，于是题主采用了一种更简单的方式，就是返回的小程序卡片消息中直接包含了
<em>
<strong>
微信公众号授权跳转地址
</strong>
</em>
，用户点击授权地址授权完成后，携带用户的授权 code 查询出用户的
<em>
<strong>
微信公众号的 openid
</strong>
</em>
，然后携带
<em>
<strong>
订单号
</strong>
</em>
<br/>
和用户的公众号的 openid 重定向到前端地址，前端通过调用 JSAPI 的支付接口就可以完成支付了。卡片消息的内容为吊起微信微信公众号授权接口，具体参照
<a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/Wechat_webpage_authorization.html" rel="nofollow">
微信接口文档
</a>
。示例如下：整个流程图如下：
</p>
<pre><code class="prism language-java"><span class="token comment">//授权重定向时记得带上订单编号或者订单 id</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token constant">OPEN_LINK_URL</span> <span class="token operator">=</span> <span class="token string">"https://open.weixin.qq.com/connect/oauth2/authorize?appid="</span> <span class="token operator">+</span>
<span class="token constant">WX_PUB_APP_ID</span> <span class="token operator">+</span> <span class="token string">"&amp;redirect_uri="</span> <span class="token operator">+</span> <span class="token constant">REDIRECT_URI</span> <span class="token operator">+</span> <span class="token string">"%3ForderNo%3D"</span> <span class="token operator">+</span>
<span class="token constant">ORDER_NO_PLACEHOLDER</span> <span class="token operator">+</span> <span class="token string">"&amp;response_type=code&amp;scope=snsapi_userinfo&amp;state=STATE#wechat_redirect"</span><span class="token punctuation">;</span>
</code></pre>
<p>
<img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/direct/cd4aea08db6d49bcb01641aa6ae7936b.png"/>
</p>
<h2>
<a id="_130">
</a>
总结
</h2>
<p>
通过微信小程序客服消息，以及微信公众号授权，既可以通过在微信内通过 JSAPI 进行支付。具体的业务处理流程大家可以根据实际的业务场景去调整。如果对您有帮助，麻烦点赞收藏，谢谢！
</p>

   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f33373930333537342f:61727469636c652f64657461696c732f313431313238333937" class_="artid" style="display:none">
 </p>
</div>
