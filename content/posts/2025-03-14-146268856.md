---
layout: post
title: "SpringCloud-学习笔记1Spring概述工程搭建注册中心负载均衡-SpringCloud-LoadBalancer"
date: 2025-03-14 22:48:15 +0800
description: "微服务是一种经过良好架构设计的分布式架构方案。一个服务只对应一个单一的功能，只做一件事，这个服务可以单独部署运行。Spring Cloud 是一套基于的微服务开发工具集，用于简化分布式系统（如微服务架构）的构建、部署和管理。它整合了多种开源组件，提供了一站式解决方案，帮助开发者快速实现服务治理、配置管理、负载均衡、熔断降级等分布式系统中的常见问题。简单的说，Spring Cloud 就是分布式微服务架构的一站式解决方案。有没有什么办法来解决这个问题呢？"
keywords: "SpringCloud 学习笔记1（Spring概述、工程搭建、注册中心、负载均衡、 SpringCloud LoadBalancer）"
categories: ['Javaee']
tags: ['学习', 'Spring', 'Spring', 'Cloud']
artid: "146268856"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146268856
    alt: "SpringCloud-学习笔记1Spring概述工程搭建注册中心负载均衡-SpringCloud-LoadBalancer"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146268856
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146268856
cover: https://bing.ee123.net/img/rand?artid=146268856
image: https://bing.ee123.net/img/rand?artid=146268856
img: https://bing.ee123.net/img/rand?artid=146268856
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     SpringCloud 学习笔记1（Spring概述、工程搭建、注册中心、负载均衡、 SpringCloud LoadBalancer）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="SpringCloud_1">
     </a>
     SpringCloud
    </h2>
    <h3>
     <a id="SpringCloud__3">
     </a>
     SpringCloud 概述
    </h3>
    <h4>
     <a id="_5">
     </a>
     集群和分布式
    </h4>
    <p>
     集群：是将一个系统完整的部署到多个服务器上，每个服务器都能提供系统的所有服务，多个服务器通过负载均衡调度完成任务，每个服务器称为集群的节点。
    </p>
    <p>
     分布式：是将一个系统拆分成多个子系统，多个子系统部署在多个服务器上，多个服务器上的子系统协同合作完成一个特定任务。
    </p>
    <h5>
     <a id="_15">
     </a>
     集群和分布式的区别和联系
    </h5>
    <ol>
     <li>
      集群是多个计算机做同样的事情，分布式是多个计算机做不同的事。
     </li>
     <li>
      集群的每一个节点的功能是相同的，并且是可以替代的。分布式也是多个节点组成的系统，但是每个节点完成的任务是不同的，一个节点出现问题，这个业务就无法访问了。
     </li>
     <li>
      分布式和集群在实践中，很多时候都是相互配合使用的。比如分布式的某一个节点，可能由一个集群来代替。分布式架构大多数是建立在集群上的。所以实际的分布式架构中并不会把分布式和集群单独区分，而是统称：分布式架构。
     </li>
    </ol>
    <h4>
     <a id="_23">
     </a>
     微服务
    </h4>
    <h5>
     <a id="_27">
     </a>
     什么是微服务？
    </h5>
    <p>
     微服务是一种经过良好架构设计的分布式架构方案。
    </p>
    <p>
     一个服务只对应一个单一的功能，只做一件事，这个服务可以单独部署运行。
    </p>
    <h5>
     <a id="_35">
     </a>
     分布式架构和微服务架构的区别
    </h5>
    <p>
     分布式：服务拆分，拆了就行。
    </p>
    <p>
     微服务：指非常微小的服务，更细粒度的垂直拆分，通常指不能再拆的服务。
    </p>
    <p>
     分布式架构侧重于压力的分散，强调的是服务的分散化，微服务侧重于能力的分散，更强调服务的专业化和精细分工。
    </p>
    <h5>
     <a id="_47">
     </a>
     微服务的优缺点？
    </h5>
    <p>
     优点：
    </p>
    <p>
     <img alt="image-20250311173842098" src="https://i-blog.csdnimg.cn/img_convert/c412e0a171977ecc6ccd532908e04830.png"/>
    </p>
    <p>
     缺点：
    </p>
    <p>
     <img alt="image-20250311173920969" src="https://i-blog.csdnimg.cn/img_convert/a0de092b2abde983387f81b68724f51e.png"/>
    </p>
    <h5>
     <a id="_63">
     </a>
     拆分微服务原则
    </h5>
    <ol>
     <li>
      <p>
       单一职责原则
      </p>
      <p>
       单一职责原则原本是面向对象程序设计中的一个基本原则，它指的是一个类应该专注于单一功能。
      </p>
      <p>
       在微服务架构中，一个微服务也应该只负责一个功能或业务领域，每个服务应该有清晰的定义和边界，只关注自己的特定业务领域。
      </p>
     </li>
     <li>
      <p>
       服务自治
      </p>
      <p>
       服务自治是指每个微服务都应该具备高度自治的能力，即每个服务要能做到独立开发，独立测试， 独立构建， 独立部署，独立运行。
      </p>
     </li>
     <li>
      <p>
       单向依赖
      </p>
      <p>
       微服务之间需要做到单向依赖，严禁循环依赖，双向依赖。
      </p>
      <p>
       <img alt="image-20250311174451006" src="https://i-blog.csdnimg.cn/img_convert/87b00388176dcda8e90b1a99cfb7e13e.png"/>
      </p>
      <blockquote>
       <p>
        如果一些场景确实无法避免循环依赖或者双向依赖,，可以考虑使用消息队列等其他方式来实现。
       </p>
      </blockquote>
     </li>
    </ol>
    <h4>
     <a id="_SpringCloud__85">
     </a>
     什么是 SpringCloud ？
    </h4>
    <p>
     Spring Cloud 是一套基于
     <strong>
      Spring Boot
     </strong>
     的微服务开发工具集，用于简化分布式系统（如微服务架构）的构建、部署和管理。它整合了多种开源组件，提供了一站式解决方案，帮助开发者快速实现服务治理、配置管理、负载均衡、熔断降级等分布式系统中的常见问题。
    </p>
    <p>
     简单的说，
     <strong>
      Spring Cloud 就是分布式微服务架构的一站式解决方案。
     </strong>
    </p>
    <h5>
     <a id="_95">
     </a>
     核心功能与组件
    </h5>
    <ol>
     <li>
      <strong>
       服务注册与发现
      </strong>
      <ul>
       <li>
        组件：
        <strong>
         Eureka
        </strong>
        、
        <strong>
         Nacos
        </strong>
        、
        <strong>
         Consul
        </strong>
       </li>
       <li>
        功能：服务自动注册到注册中心，并通过服务名实现动态发现，避免硬编码服务地址。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       负载均衡
      </strong>
      <ul>
       <li>
        组件：
        <strong>
         Ribbon
        </strong>
        、
        <strong>
         LoadBalancer
        </strong>
       </li>
       <li>
        功能：在多个服务实例间分配请求，支持轮询、随机等策略。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       服务调用
      </strong>
      <ul>
       <li>
        组件：
        <strong>
         OpenFeign
        </strong>
       </li>
       <li>
        功能：声明式的 HTTP 客户端，简化服务间的 RESTful 调用。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       熔断与容错
      </strong>
      <ul>
       <li>
        组件：
        <strong>
         Hystrix
        </strong>
        、
        <strong>
         Resilience4j
        </strong>
        、
        <strong>
         Sentinel
        </strong>
       </li>
       <li>
        功能：防止服务雪崩，提供降级逻辑和故障隔离。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       配置中心
      </strong>
      <ul>
       <li>
        组件：
        <strong>
         Spring Cloud Config
        </strong>
        、
        <strong>
         Nacos
        </strong>
       </li>
       <li>
        功能：集中管理配置文件，支持动态更新。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       API 网关
      </strong>
      <ul>
       <li>
        组件：
        <strong>
         Spring Cloud Gateway
        </strong>
        、
        <strong>
         Zuul
        </strong>
       </li>
       <li>
        功能：统一入口，处理路由、鉴权、限流等跨服务功能。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       分布式链路追踪
      </strong>
      <ul>
       <li>
        组件：
        <strong>
         Sleuth
        </strong>
        +
        <strong>
         Zipkin
        </strong>
       </li>
       <li>
        功能：追踪请求在微服务间的调用路径，便于排查问题。
       </li>
      </ul>
     </li>
    </ol>
    <h3>
     <a id="_121">
     </a>
     工程搭建
    </h3>
    <h4>
     <a id="_pom__123">
     </a>
     父项目的 pom 文件
    </h4>
    <p>
     指定父项目的打包方式：
    </p>
    <p>
     <img alt="image-20250311175319332" src="https://i-blog.csdnimg.cn/img_convert/b3d6f6672757059fd081d56a0db00dd6.png"/>
    </p>
    <p>
     添加依赖：
    </p>
    <p>
     <img alt="image-20250311175027099" src="https://i-blog.csdnimg.cn/img_convert/eb038486d51e650a46c79d78e0913f38.png"/>
    </p>
    <p>
     子项目被创建时，父项目的 pom 文件中会自动添加
    </p>
    <p>
     <img alt="image-20250311175514057" src="https://i-blog.csdnimg.cn/img_convert/a78d5c6f83e356bf847dc30040bc9730.png"/>
    </p>
    <p>
     上面的代码表示这里有两个子项目（模块），分别是 order-service 和 product-service 。
    </p>
    <h3>
     <a id="_145">
     </a>
     注册中心
    </h3>
    <h4>
     <a id="RestTemplate_147">
     </a>
     RestTemplate
    </h4>
    <p>
     RestTemplate 是从 Spring3.0 开始支持的一个 HTTP 请求工具，它是一个同步的 REST API 客户端，提供了常见的 REST 请求方案的模版。
    </p>
    <p>
     在项目中，当我们需要
     <strong>
      远程调用一个 HTTP 接口
     </strong>
     时，我们经常会用到 RestTemplate 这个类。这个类是 Spring 框架提供的一个工具类。
    </p>
    <p>
     定义 RestTemplate
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeanConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     使用 RestTemplate
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderMapper</span> orderMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">OrderInfo</span> <span class="token function">selectOrderById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">selectOrderById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 通过 RestTemplate 从指定 URL 获取 ProductInfo 对象</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"http://127.0.0.1:9090/product/"</span> <span class="token operator">+</span> orderInfo<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductInfo</span> productInfo <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">ProductInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        orderInfo<span class="token punctuation">.</span><span class="token function">setProductInfo</span><span class="token punctuation">(</span>productInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在前面的示例中 URL 是写死的。写死这个事情做的不好，如果服务器的 IP 发生变化，我们还得把所有 IP 都修改，太麻烦了，而且没有技术含量。
    </p>
    <pre><code class="prism language-java"><span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"http://127.0.0.1:9090/product/"</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="_201">
     </a>
     注册中心介绍
    </h4>
    <p>
     有没有什么办法来解决这个问题呢？
    </p>
    <p>
     我们可以这样做：
    </p>
    <p>
     当服务 启动/变更 时, 向注册中⼼报道。注册中⼼记录应⽤和 IP 的关系。
    </p>
    <p>
     调⽤⽅调⽤时，先去注册中⼼获取服务⽅的 IP，再去服务⽅进⾏调⽤。
    </p>
    <p>
     <img alt="image-20250311212947467" src="https://i-blog.csdnimg.cn/img_convert/d86389e528a03d566610aa45cf9d2998.png"/>
    </p>
    <p>
     <img alt="image-20250311213409451" src="https://i-blog.csdnimg.cn/img_convert/5b455c70a7b8b1a58b4176f6218a9992.png"/>
    </p>
    <h4>
     <a id="CAP__217">
     </a>
     CAP 理论
    </h4>
    <p>
     <img alt="image-20250311213758583" src="https://i-blog.csdnimg.cn/img_convert/1c52c80be9ce47adeb02bc7ce6ece274.png"/>
    </p>
    <ul>
     <li>
      <p>
       一致性（C）：CAP 理论中的一致性，指的是强一致性。所有节点在同一时间具有相同的数据。
      </p>
      <blockquote>
       <img alt="image-20250311214959974" src="https://i-blog.csdnimg.cn/img_convert/df1807e37a1d2ccb024e95559b545776.png"/>
       <p>
        强一致性：主库和从库不论何时，服务器对外提供的服务都是一致的。
       </p>
       <p>
        弱一致性：随着时间的推移，主库和从库最终达到了一致性。
       </p>
      </blockquote>
     </li>
     <li>
      <p>
       可用性（A）：保证每个请求都有响应。
      </p>
     </li>
     <li>
      <p>
       分区容错性（P）：当出现网络分区后，系统仍然能够对外提供服务。
      </p>
      <blockquote>
       <p>
        网络分区：指分布式系统中，由于网络故障导致集群中的节点被分割成多个孤立的子集，子集之间的节点无法正常通信，但子集内部的节点仍然可以正常通信。这种现象也被称为“脑裂”（Split-Brain）。
       </p>
       <p>
        举个例子
       </p>
       <p>
        假设有一个分布式系统，由 5 个节点（A、B、C、D、E）组成，它们之间通过网络通信。如果由于网络故障，节点 A 和 B 之间的网络断开，那么可能会形成两个分区：
       </p>
       <ul>
        <li>
         分区 1：节点 A、B
        </li>
        <li>
         分区 2：节点 C、D、E
        </li>
       </ul>
       <p>
        此时，分区 1 和分区 2 之间的节点无法通信，但分区内部的节点仍然可以正常通信。
       </p>
      </blockquote>
     </li>
    </ul>
    <p>
     在分布式系统中，系统间的⽹络不能100%保证健康, 服务⼜必须对外保证服务. 因此 分区容错性（P） 不可避免. 那就只能在 C 和 A 中选择⼀个. 也就是 CP 或者 AP 架构。
    </p>
    <p>
     正常情况:
    </p>
    <img alt="image-20250311215348627" src="https://i-blog.csdnimg.cn/img_convert/5cf3e1f73c75786c9d11c3c5b05db5e3.png"/>
    <p>
     网络异常：
    </p>
    <img alt="image-20250311215423635" src="https://i-blog.csdnimg.cn/img_convert/c31292a9d5f172da02f298d0c1c9c488.png"/>
    <p>
     CP架构：为了保证分布式系统对外的数据⼀致性，于是选择不返回任何数据。
    </p>
    <p>
     AP架构：为了保证分布式系统的可⽤性，节点2返回V0版本的数据(即使这个数据不正确)。
    </p>
    <p>
     关于CAP的更多信息，可以看看这篇文章：
     <a href="https://cloud.tencent.com/developer/article/1860632" rel="nofollow">
      一文看懂｜分布式系统之CAP理论-腾讯云开发者社区-腾讯云
     </a>
    </p>
    <h4>
     <a id="Eureka_270">
     </a>
     Eureka
    </h4>
    <h5>
     <a id="_272">
     </a>
     添加依赖
    </h5>
    <pre><code class="prism language-xml"> <span class="token comment">&lt;!--  给客户端用  --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--  给服务器用  --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>

<span class="token comment">&lt;!--  借助 Maven 打包  --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h5>
     <a id="_304">
     </a>
     配置文件
    </h5>
    <pre><code class="prism language-yaml"><span class="token comment"># Eureka相关配置</span>
<span class="token comment"># Eureka 服务</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">10010</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
  <span class="token comment"># 这个应用的名称</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> eureka<span class="token punctuation">-</span>server
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">instance</span><span class="token punctuation">:</span>
  <span class="token comment"># 主机的名称</span>
    <span class="token key atrule">hostname</span><span class="token punctuation">:</span> localhost
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token comment"># 表示是否从Eureka Server获取注册信息,默认为true.因为这是一个单点的Eureka Server,不需要同步其他的Eureka Server节点的数据,这里设置为false</span>
    <span class="token key atrule">fetch-registry</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
    <span class="token comment"># 表示是否将自己注册到Eureka Server,默认为true.</span>
    <span class="token key atrule">register-with-eureka</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> 
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment"># 设置Eureka Server的地址,查询服务和注册服务都需要依赖这个地址</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>eureka.instance.hostname<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{<!-- --></span>server.port<span class="token punctuation">}</span>/eureka/

</code></pre>
    <h5>
     <a id="_332">
     </a>
     启动类
    </h5>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@EnableEurekaServer</span>  <span class="token comment">// 开启 Eureka 的功能</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaServerApplication</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">EurekaServerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="_344">
     </a>
     查看
    </h5>
    <pre><code>http://127.0.0.1:10010/
</code></pre>
    <p>
     <img alt="image-20250314164624808" src="https://i-blog.csdnimg.cn/img_convert/bb1070c798edfcf4cb40ef2ba76e297a.png"/>
    </p>
    <h5>
     <a id="_352">
     </a>
     服务注册
    </h5>
    <h6>
     <a id="_354">
     </a>
     添加依赖
    </h6>
    <pre><code class="prism language-xml">        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-eureka-client<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h6>
     <a id="_365">
     </a>
     配置文件
    </h6>
    <pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
  	<span class="token comment"># 配置应用名称</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> product<span class="token punctuation">-</span>service

<span class="token comment">#Eureka Client</span>
<span class="token key atrule">eureka</span><span class="token punctuation">:</span>
  <span class="token key atrule">client</span><span class="token punctuation">:</span>
    <span class="token key atrule">service-url</span><span class="token punctuation">:</span>
      <span class="token comment"># 注册到哪里 / 从哪里拿相关信息</span>
      <span class="token key atrule">defaultZone</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//127.0.0.1<span class="token punctuation">:</span>10010/eureka/
</code></pre>
    <h6>
     <a id="_381">
     </a>
     查看
    </h6>
    <pre><code>http://127.0.0.1:10010/
</code></pre>
    <p>
     <img alt="image-20250314164722794" src="https://i-blog.csdnimg.cn/img_convert/644704a0d1bcf27e5fbbbb11f066f605.png"/>
    </p>
    <h5>
     <a id="_393">
     </a>
     服务发现
    </h5>
    <h6>
     <a id="_395">
     </a>
     依赖、配置
    </h6>
    <p>
     同服务注册。
    </p>
    <h6>
     <a id="_401">
     </a>
     修改代码
    </h6>
    <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span></span><span class="token class-name">DiscoveryClient</span></span><span class="token punctuation">;</span>   
<span class="token comment">// 注意不要引错包</span>
	<span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscoveryClient</span> discoveryClient<span class="token punctuation">;</span>

        <span class="token comment">// 从 Eureka 中获取服务列表，括号内写应用名称</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">"product-service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> uri <span class="token operator">=</span> instances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 替换之前写死的 url </span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> uri <span class="token operator">+</span> <span class="token string">"/product/"</span> <span class="token operator">+</span> orderInfo<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="Eureka__Zookeeper__418">
     </a>
     Eureka 和 Zookeeper 区别
    </h5>
    <p>
     Eureka 和 Zookeeper 都是用于服务注册和服务发现的工具，区别如下：
    </p>
    <ol>
     <li>
      Eureka 基于 AP 原则，保证高可用。Zookeeper 基于 CP 原则，保证数据一致性。
     </li>
     <li>
      Eureka 每个节点都是均等的，Zookeeper 的节点区分 Leader 和 Follower 或 Observer，如果 Zookeeper 的 Leader 发生故障时，需要重新选举，选举过程集群会有短暂时间的不可用。
     </li>
    </ol>
    <h3>
     <a id="_427">
     </a>
     负载均衡
    </h3>
    <h4>
     <a id="_429">
     </a>
     多次在不同的端口号上开启同一个服务
    </h4>
    <p>
     <img alt="image-20250314172405488" src="https://i-blog.csdnimg.cn/img_convert/61763fecaf3bb441e515e265fb27f33e.png"/>
    </p>
    <p>
     点击 Services 并添加应用
    </p>
    <p>
     <img alt="image-20250314172548516" src="https://i-blog.csdnimg.cn/img_convert/5e3ee1ffb9ead9a4f4c629e296f7e8e7.png"/>
    </p>
    <p>
     选择 Application
    </p>
    <p>
     <img alt="image-20250314172632852" src="https://i-blog.csdnimg.cn/img_convert/96d851803280acc6e54547dab37df247.png"/>
    </p>
    <p>
     复制你要多开的服务
    </p>
    <p>
     <img alt="image-20250314172710731" src="https://i-blog.csdnimg.cn/img_convert/07178b310b56e2f712481a37fc8facc6.png"/>
    </p>
    <p>
     设置端口号，设置完毕后点击 Apply。
    </p>
    <p>
     <img alt="image-20250314172839615" src="https://i-blog.csdnimg.cn/img_convert/5789996de3ea28de46f843234731849f.png"/>
    </p>
    <p>
     可以看到，已经配置好了。
    </p>
    <p>
     <img alt="image-20250314173002148" src="https://i-blog.csdnimg.cn/img_convert/3467a5830b6931f2d59aa9592a76cd51.png"/>
    </p>
    <h4>
     <a id="_457">
     </a>
     出现的问题
    </h4>
    <p>
     当我们进行多次访问时，每次的 discoveryClient.getInstances(“product-service”); 拿到的列表是不固定的。
    </p>
    <pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">OrderInfo</span> <span class="token function">selectOrderById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">selectOrderById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 从 Eureka 中获取服务列表</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">"product-service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> uri <span class="token operator">=</span> instances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 替换之前写死的 url</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> uri <span class="token operator">+</span> <span class="token string">"/product/"</span> <span class="token operator">+</span> orderInfo<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"远程调用 url：{}"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductInfo</span> productInfo <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">ProductInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setProductInfo</span><span class="token punctuation">(</span>productInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     <img alt="image-20250314173928563" src="https://i-blog.csdnimg.cn/img_convert/2211c6868ab082f3462d109bb00418bc.png"/>
    </p>
    <p>
     显然这并不是很合理。
    </p>
    <h4>
     <a id="_480">
     </a>
     解决问题
    </h4>
    <p>
     假设我们想让请求平均分配到每个端口上。可以使用以下方法：
    </p>
    <p>
     <img alt="image-20250314174244230" src="https://i-blog.csdnimg.cn/img_convert/ca4fca9bb72340d40192570a338832a7.png"/>
    </p>
    <p>
     修改代码：
    </p>
    <pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>order<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>order<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">OrderMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>order<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">OrderInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>order<span class="token punctuation">.</span>model<span class="token punctuation">.</span></span><span class="token class-name">ProductInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PostConstruct</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">ServiceInstance</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>client<span class="token punctuation">.</span>discovery<span class="token punctuation">.</span></span><span class="token class-name">DiscoveryClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">RestTemplate</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author hanzishuai
 * @date 2025/03/07 19:19
 * @Description
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderMapper</span> orderMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RestTemplate</span> restTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscoveryClient</span> discoveryClient<span class="token punctuation">;</span>

    <span class="token comment">// 计数器</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 将实例提取出来</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 从 Eureka 中获取服务列表</span>
        instances <span class="token operator">=</span> discoveryClient<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span><span class="token string">"product-service"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">// 这是之前的写法：    </span>
<span class="token comment">//        public OrderInfo selectOrderById(Integer orderId) {<!-- --></span>
<span class="token comment">//        OrderInfo orderInfo = orderMapper.selectOrderById(orderId);</span>
<span class="token comment">//        String url = "http://127.0.0.1:9090/product/" + orderInfo.getProductId();</span>
<span class="token comment">//    </span>
<span class="token comment">//        // 从 Eureka 中获取服务列表，这里每次请求拿到的 instances 是不固定的 </span>
<span class="token comment">//        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances("product-service");</span>
<span class="token comment">//        String uri = instances.get(0).getUri().toString();</span>
<span class="token comment">//    </span>
<span class="token comment">//        // 替换之前写死的 url</span>
<span class="token comment">//        String url = uri + "/product/" + orderInfo.getProductId();</span>
<span class="token comment">//        log.info("远程调用 url：{}", url);</span>
<span class="token comment">//        ProductInfo productInfo = restTemplate.getForObject(url, ProductInfo.class);</span>
<span class="token comment">//        orderInfo.setProductInfo(productInfo);</span>
<span class="token comment">//        return orderInfo;</span>
<span class="token comment">//    }</span>

    
    <span class="token keyword">public</span> <span class="token class-name">OrderInfo</span> <span class="token function">selectOrderById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">selectOrderById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 实现平均分配</span>
        <span class="token keyword">int</span> index <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">getAndIncrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> instances<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> uri <span class="token operator">=</span> instances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUri</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span> url <span class="token operator">=</span> uri <span class="token operator">+</span> <span class="token string">"/product/"</span> <span class="token operator">+</span> orderInfo<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"远程调用 url：{}"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductInfo</span> productInfo <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">ProductInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setProductInfo</span><span class="token punctuation">(</span>productInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <blockquote>
     <p>
      但是上述写法会带来一个新的问题：当实例发生变化，这里的服务并不能实时的感知到。
     </p>
     <p>
      不要较真，在这里只是为了演示一下。
     </p>
    </blockquote>
    <p>
     更改后的效果：
    </p>
    <p>
     <img alt="image-20250314180245882" src="https://i-blog.csdnimg.cn/img_convert/8c068c89b1e1be3a3155ffd2522cfc0e.png"/>
    </p>
    <h4>
     <a id="_580">
     </a>
     负载均衡正式介绍
    </h4>
    <h5>
     <a id="_582">
     </a>
     什么是负载均衡
    </h5>
    <p>
     负载均衡用来在多个机器或者其他资源中，按照一定的规则合理分配负载。
    </p>
    <blockquote>
     <p>
      比如说，有很多请求和很多服务器，负载均衡就是把这些请求合理的分配到各个服务器上。
     </p>
    </blockquote>
    <h5>
     <a id="_590">
     </a>
     负载均衡的一些实现
    </h5>
    <h6>
     <a id="_592">
     </a>
     服务端负载均衡
    </h6>
    <p>
     服务端负载均衡就是在服务端进行负载均衡算法的分配。
    </p>
    <p>
     以 Nginx 为例，请求先到达 Nginx 负载均衡器，然后通过负载均衡算法，在多个服务器之间选一个进行访问。
    </p>
    <img alt="image-20250314182324386" src="https://i-blog.csdnimg.cn/img_convert/a345ed6d94df604e393de91c3947919a.png"/>
    <h6>
     <a id="_604">
     </a>
     客户端负载均衡
    </h6>
    <p>
     服务端负载均衡就是在客户端进行负载均衡算法的分配。
    </p>
    <p>
     以 SpringCloud 的 Ribbon 为例，请求发送到客户端，客户端从注册中心获取服务器列表，在发送请求前通过负载均衡算法选择一个服务器，然后进行访问。
    </p>
    <img alt="image-20250314183108271" src="https://i-blog.csdnimg.cn/img_convert/a0d6a115cf6bd29f41460908af02de05.png"/>
    <h5>
     <a id="SpringCloud_LoadBalancer_616">
     </a>
     SpringCloud LoadBalancer
    </h5>
    <p>
     加上 @LoadBalanced 注解
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeanConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     修改代码
    </p>
    <pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">OrderInfo</span> <span class="token function">selectOrderById</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> orderId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> orderMapper<span class="token punctuation">.</span><span class="token function">selectOrderById</span><span class="token punctuation">(</span>orderId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 修改前</span>
        <span class="token comment">// String url = "http://127.0.0.1:9090/product/" + orderInfo.getProductId();</span>
        <span class="token comment">// 修改后</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"http://product-service/product/"</span> <span class="token operator">+</span> orderInfo<span class="token punctuation">.</span><span class="token function">getProductId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"远程调用 url：{}"</span><span class="token punctuation">,</span> url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ProductInfo</span> productInfo <span class="token operator">=</span> restTemplate<span class="token punctuation">.</span><span class="token function">getForObject</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token class-name">ProductInfo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setProductInfo</span><span class="token punctuation">(</span>productInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     效果:
    </p>
    <p>
     <img alt="image-20250314203553542" src="https://i-blog.csdnimg.cn/img_convert/3e48426fbe5205e75bb8998423e86cdc.png"/>
    </p>
    <p>
     <img alt="image-20250314203658809" src="https://i-blog.csdnimg.cn/img_convert/a4f0b42dce3bc39cd964f0f7cdf5f831.png"/>
    </p>
    <p>
     <img alt="image-20250314203605370" src="https://i-blog.csdnimg.cn/img_convert/f2c878ffc8633570a3f6995c864ae36a.png"/>
    </p>
    <h6>
     <a id="_658">
     </a>
     负载均衡策略
    </h6>
    <p>
     SpringCloud LoadBalancer 仅支持两种负载均衡策略:
    </p>
    <ol>
     <li>
      轮询策略: 指服务器轮流处理用户的请求.
     </li>
     <li>
      随机选择: 随机选择一个后端服务器来处理请求.
     </li>
    </ol>
    <p>
     自定义负载均衡策略
    </p>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomLoadBalancerConfiguration</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">ReactorLoadBalancer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> <span class="token function">randomLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> environment<span class="token punctuation">,</span>
                                                            <span class="token class-name">LoadBalancerClientFactory</span> loadBalancerClientFactory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerClientFactory</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RandomLoadBalancer</span><span class="token punctuation">(</span>loadBalancerClientFactory
                <span class="token punctuation">.</span><span class="token function">getLazyProvider</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token class-name">ServiceInstanceListSupplier</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     使用方法:
    </p>
    <ol>
     <li>
      <p>
       需要在关联负载均衡策略的配置类上添加 @LoadBalancerClient 或者 @LoadBalancerClients 注解.
      </p>
      <pre><code class="prism language-java"><span class="token comment">// name 表示要对那个服务生效, configuration 表示你采取的负载均衡策略是什么.</span>
<span class="token annotation punctuation">@LoadBalancerClient</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"product-service"</span><span class="token punctuation">,</span>configuration <span class="token operator">=</span> <span class="token class-name">CustomLoadBalancerConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BeanConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@LoadBalanced</span>
    <span class="token keyword">public</span> <span class="token class-name">RestTemplate</span> <span class="token function">restTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
     <li>
      <p>
       自定义负载均衡策略的配置类（如
       <code>
        CustomLoadBalancerConfiguration
       </code>
       ）上不能使用 @Configuration 注解.
      </p>
      <blockquote>
       <p>
        原因: 如果
        <code>
         CustomLoadBalancerConfiguration
        </code>
        类被标记为
        <code>
         @Configuration
        </code>
        ，并且位于主应用程序组件扫描的路径下，它会被 Spring 自动加载为一个配置类。而当通过
        <code>
         @LoadBalancerClient
        </code>
        的 configuration 属性引用它时，可能会导致 Spring 尝试再次加载它，从而产生冲突或重复的 bean 定义。
       </p>
      </blockquote>
     </li>
     <li>
      <p>
       自定义负载均衡策略的配置类（如
       <code>
        CustomLoadBalancerConfiguration
       </code>
       ）必须能被 Spring 容器发现。
      </p>
     </li>
    </ol>
    <blockquote>
     <p>
      是不是感觉与第三条第二条有矛盾?
     </p>
     <ul>
      <li>
       在之前的回答中提到，
       <code>
        CustomLoadBalancerConfiguration
       </code>
       不能添加
       <code>
        @Configuration
       </code>
       注解，这是为了避免被 Spring 自动扫描到后重复加载。
      </li>
      <li>
       但同时又需要确保该类能被 Spring 容器发现，这里的矛盾需要通过以下方式解决：
       <ul>
        <li>
         通过
         <code>
          @LoadBalancerClient(configuration = ...)
         </code>
         显式引用该类，而不是依赖组件扫描。上面的 BeanConfig 采用的就是这种方法。
        </li>
        <li>
         确保
         <code>
          CustomLoadBalancerConfiguration
         </code>
         不在主应用的扫描范围内，但能被
         <code>
          @LoadBalancerClient
         </code>
         正确引用。
        </li>
       </ul>
      </li>
     </ul>
    </blockquote>
    <h6>
     <a id="LoadBalancer__713">
     </a>
     LoadBalancer 原理
    </h6>
    <blockquote>
     <p>
      tip: 按 Ctrl + alt + ← 或者 → 可以快速定位上/下次查看的位置
     </p>
    </blockquote>
    <p>
     在 LoadBalancerInterceptor 中有一个 intercept 方法：
    </p>
    <pre><code class="prism language-java">	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">ClientHttpResponse</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">HttpRequest</span> request<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> body<span class="token punctuation">,</span>
			<span class="token keyword">final</span> <span class="token class-name">ClientHttpRequestExecution</span> execution<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 拿到 uri </span>
		<span class="token keyword">final</span> <span class="token class-name">URI</span> originalUri <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 拿到 host</span>
		<span class="token class-name">String</span> serviceName <span class="token operator">=</span> originalUri<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">(</span>serviceName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">"Request URI does not contain a valid hostname: "</span> <span class="token operator">+</span> originalUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loadBalancer<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestFactory<span class="token punctuation">.</span><span class="token function">createRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> body<span class="token punctuation">,</span> execution<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre>
    <p>
     它会拦截所有的请求。
    </p>
    <p>
     它做了三件事：
    </p>
    <ol>
     <li>
      拿到 uri，也就是 http://product-service/product/1001
     </li>
     <li>
      拿到 host，也就是 product-service
     </li>
     <li>
      执行
     </li>
    </ol>
    <p>
     接下来具体看看
     <code>
      this.loadBalancer.execute(serviceName, this.requestFactory.createRequest(request, body, execution))
     </code>
     它干了什么。
    </p>
    <pre><code class="prism language-java">   <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">,</span> <span class="token class-name">LoadBalancerRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> hint <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getHint</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LoadBalancerRequestAdapter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token class-name">TimedRequestContext</span><span class="token punctuation">&gt;</span></span> lbRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoadBalancerRequestAdapter</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">buildRequestContext</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> hint<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">LoadBalancerLifecycle</span><span class="token punctuation">&gt;</span></span> supportedLifecycleProcessors <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSupportedLifecycleProcessors</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        supportedLifecycleProcessors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>lifecycle<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            lifecycle<span class="token punctuation">.</span><span class="token function">onStart</span><span class="token punctuation">(</span>lbRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       
       <span class="token comment">// 通过 choose 方法返回了一个应用</span>
        <span class="token class-name">ServiceInstance</span> serviceInstance <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">,</span> lbRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
       
        <span class="token keyword">if</span> <span class="token punctuation">(</span>serviceInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            supportedLifecycleProcessors<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>lifecycle<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                lifecycle<span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CompletionContext</span><span class="token punctuation">(</span><span class="token class-name">Status</span><span class="token punctuation">.</span><span class="token constant">DISCARD</span><span class="token punctuation">,</span> lbRequest<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">EmptyResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No instances available for "</span> <span class="token operator">+</span> serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">,</span> serviceInstance<span class="token punctuation">,</span> lbRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     接下来看一下 choose 方法
    </p>
    <pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">ServiceInstance</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">,</span> <span class="token class-name">Request</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 根据应用名称获取负载均衡策略</span>
        <span class="token class-name">ReactiveLoadBalancer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> loadBalancer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>loadBalancerClientFactory<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>loadBalancer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果 loadBalancer 不为空，这里又进行了一次选择</span>
            <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> loadBalancerResponse <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">)</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>loadBalancer<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> loadBalancerResponse <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">)</span>loadBalancerResponse<span class="token punctuation">.</span><span class="token function">getServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     如果 loadBalancer 不为空，这里又进行了一次选择接下来进入
     <code>
      Response&lt;ServiceInstance&gt; loadBalancerResponse = (Response)Mono.from(loadBalancer.choose(request)).block()
     </code>
     中的 choose 看看，
    </p>
    <p>
     可以看到它有两个实现，一个是
     <code>
      RandomLoadBalancer
     </code>
     ,一个是
     <code>
      RoundRobinLoadBalancer
     </code>
     。
    </p>
    <p>
     <img alt="image-20250314222100838" src="https://i-blog.csdnimg.cn/img_convert/8b5ff95f97fa3ce2456d38d6c92e7f59.png"/>
    </p>
    <h6>
     <a id="_787">
     </a>
     随机选择策略
    </h6>
    <p>
     先来看一下
     <code>
      RandomLoadBalancer
     </code>
    </p>
    <pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Response</span><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 做了一些处理</span>
        <span class="token class-name">ServiceInstanceListSupplier</span> supplier <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServiceInstanceListSupplier</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>serviceInstanceListSupplierProvider<span class="token punctuation">.</span><span class="token function">getIfAvailable</span><span class="token punctuation">(</span><span class="token class-name">NoopServiceInstanceListSupplier</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 根据请求获取到服务列表</span>
        <span class="token keyword">return</span> supplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>serviceInstances<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 对服务列表进行处理</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processInstanceResponse</span><span class="token punctuation">(</span>supplier<span class="token punctuation">,</span> serviceInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     进入
     <code>
      processInstanceResponse
     </code>
     看一下
    </p>
    <pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> <span class="token function">processInstanceResponse</span><span class="token punctuation">(</span><span class="token class-name">ServiceInstanceListSupplier</span> supplier<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> serviceInstances<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> serviceInstanceResponse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getInstanceResponse</span><span class="token punctuation">(</span>serviceInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>supplier <span class="token keyword">instanceof</span> <span class="token class-name">SelectedInstanceCallback</span> <span class="token operator">&amp;&amp;</span> serviceInstanceResponse<span class="token punctuation">.</span><span class="token function">hasServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SelectedInstanceCallback</span><span class="token punctuation">)</span>supplier<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">selectedServiceInstance</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">)</span>serviceInstanceResponse<span class="token punctuation">.</span><span class="token function">getServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> serviceInstanceResponse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     进
     <code>
      getInstanceResponse
     </code>
     看一下
    </p>
    <pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInstanceResponse</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instances<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"No servers available for service: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EmptyResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 生成随机数</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>instances<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 根据生成的随机数，在服务列表中选择</span>
            <span class="token class-name">ServiceInstance</span> instance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">)</span>instances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 进行下一步的处理</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultResponse</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="_837">
     </a>
     轮询策略
    </h6>
    <p>
     进入
     <code>
      RoundRobinLoadBalancer
     </code>
    </p>
    <p>
     <img alt="image-20250314223558314" src="https://i-blog.csdnimg.cn/img_convert/4b7d3fd4ad6d580700580c58e75e7da2.png"/>
    </p>
    <pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Response</span><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ServiceInstanceListSupplier</span> supplier <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServiceInstanceListSupplier</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>serviceInstanceListSupplierProvider<span class="token punctuation">.</span><span class="token function">getIfAvailable</span><span class="token punctuation">(</span><span class="token class-name">NoopServiceInstanceListSupplier</span><span class="token operator">::</span><span class="token keyword">new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> supplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>serviceInstances<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processInstanceResponse</span><span class="token punctuation">(</span>supplier<span class="token punctuation">,</span> serviceInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     进入
     <code>
      processInstanceResponse
     </code>
    </p>
    <pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> <span class="token function">processInstanceResponse</span><span class="token punctuation">(</span><span class="token class-name">ServiceInstanceListSupplier</span> supplier<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> serviceInstances<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> serviceInstanceResponse <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getInstanceResponse</span><span class="token punctuation">(</span>serviceInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>supplier <span class="token keyword">instanceof</span> <span class="token class-name">SelectedInstanceCallback</span> <span class="token operator">&amp;&amp;</span> serviceInstanceResponse<span class="token punctuation">.</span><span class="token function">hasServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">SelectedInstanceCallback</span><span class="token punctuation">)</span>supplier<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">selectedServiceInstance</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">)</span>serviceInstanceResponse<span class="token punctuation">.</span><span class="token function">getServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> serviceInstanceResponse<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     进入
     <code>
      getInstanceResponse
     </code>
    </p>
    <pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> <span class="token function">getInstanceResponse</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instances<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isWarnEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"No servers available for service: "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EmptyResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>instances<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultResponse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">)</span>instances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 计数器</span>
            <span class="token keyword">int</span> pos <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">2147483647</span><span class="token punctuation">;</span>
            <span class="token comment">// 通过计数器 % instances.size() 来拿到坐标</span>
            <span class="token class-name">ServiceInstance</span> instance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">)</span>instances<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pos <span class="token operator">%</span> instances<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultResponse</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="_889">
     </a>
     服务部署
    </h6>
    <p>
     参考
     <a href="https://blog.csdn.net/qrwitu142857/article/details/145854526?spm=1001.2014.3001.5501">
      博客系统笔记总结 2（ Linux 相关）
     </a>
     中的部署 Web 项目到 Linux
    </p>
    <hr/>
    <p>
     本文到这里就结束啦~
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/703e1af8ff51400aa23e56d64d5030ff.gif"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f7172776974753134323835372f:61727469636c652f64657461696c732f313436323638383536" class_="artid" style="display:none">
 </p>
</div>


