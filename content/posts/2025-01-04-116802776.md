---
layout: post
title: "ESP8266连接腾讯云物联网平台"
date: 2025-01-04 17:03:20 +0800
description: "本文详细介绍了如何使用ESP8266模块连接腾讯云物联网平台，通过MQTT协议进行设备的订阅与发布。"
keywords: "esp82660连接腾讯云"
categories: ['Esp']
tags: ['腾讯云', '物联网', 'Wifi', 'Stm', 'Mqtt']
artid: "116802776"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=116802776
    alt: "ESP8266连接腾讯云物联网平台"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=116802776
featuredImagePreview: https://bing.ee123.net/img/rand?artid=116802776
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ESP8266连接腾讯云物联网平台
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="ESP8266_0">
     </a>
     ESP8266连接腾讯云物联网平台
    </h2>
    <p>
     MQTT（Message Queuing Telemetry Transport，消息队列遥测传输协议），是一种基于发布/订阅（Publish/Subscribe）模式的轻量级通讯协议，该协议构建于TCP/IP协议上，由IBM在1999年发布。MQTT最大的优点在于可以以极少的代码和有限的带宽，为远程设备提供实时可靠的消息服务。做为一种低开销、低带宽占用的即时通讯协议，MQTT在物联网、小型设备、移动应用等方面有广泛的应用。MQTT属于应用层协议。最新版本为MQTT v5.0标准。本次连接腾讯云物联网平台主要以MQTT标准协议3.1版本为主。
    </p>
    <h3>
     <a id="emsp1_3">
     </a>
     1.注册腾讯云账号，登陆云平台
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1fb798420b8c9156db23b79bec6ef6c7.png#pic_center">
      <br/>
      1. 搜索物联网平台，登录物联网平台。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1691f1bcbdc911314189a9dafcfa95e5.png#pic_center"/>
     </img>
    </p>
    <h3>
     <a id="emsp2_8">
     </a>
     2.创建项目
    </h3>
    <p>
     1. 进入物联网控制台
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c37493e1b1f4f448aaa95d7944fdf057.png#pic_center">
      <br/>
      2. 创建项目
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/6d167e7a463e1ea6240b48dbc2fd0f37.png#pic_center"/>
     </img>
    </p>
    <p>
     3. 创建产品
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/af68ec488b89cfce21fd06e707b66d85.png#pic_center">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c160252fa6d12f874044aaa5c8b68351.png#pic_center"/>
     </img>
    </p>
    <h3>
     <a id="emsp3_18">
     </a>
     3.创建产品功能
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/14483f0b77fe37820ce1a148c61c1244.png#pic_center">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/9d53720bec5237a632f5713590d867ba.png#pic_center">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e11032f429e7055b67f70fc67a588602.png#pic_center">
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e6f332f6b2cf4d85fb0d75d23ae3ef5c.png#pic_center"/>
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/79d7d5429e4d03fe5b806c316f7cc575.png#pic_center"/>
       </img>
      </img>
     </img>
    </p>
    <h3>
     <a id="emsp4_24">
     </a>
     4.设备调试
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/86686312d796a66d4828a39450f71e70.png#pic_center"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/64566349266ddab45b9ef08d8c98a8e6.png#pic_center"/>
    </p>
    <pre><code class="prism language-c"><span class="token comment">//设备名，产品ID,设备秘钥修改为自己所创建产品参数</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DeviceName "Smart_123"</span><span class="token comment">//设备名</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ProductID "LA57WL612"</span><span class="token comment">//产品ID</span>
<span class="token macro property">#<span class="token directive keyword">define</span> DeviceSceret "9JHiCQ5668uZlVDuQ2ZnQ=="</span><span class="token comment">//设备秘钥</span>
</code></pre>
    <h3>
     <a id="emsp5_34">
     </a>
     5.创建工程，连接腾讯物联网平台
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/f63262bb728b6d58e1659cf34bf43e34.png#pic_center"/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/f1f7459bd12e7b7fef9eaa1dcd04f4a3.png#pic_center"/>
    </p>
    <pre><code class="prism language-c"><span class="token comment">//服务器IP:{PRODUCT_ID}.iotcloud.tencentdevices.com   ---PRODUCT_ID对应产品ID</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SERVER_IP "LA57WL612.iotcloud.tencentdevices.com"</span><span class="token comment">//服务器IP</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SERVER_PORT 1883 </span><span class="token comment">//端口号</span>
<span class="token comment">//客户端ID:{产品ID}{设备名}</span>
<span class="token macro property">#<span class="token directive keyword">define</span> ClientID "LA57WL612Smart_123"</span>
<span class="token comment">//用户名和密码可使用密码生成工具完成</span>
<span class="token macro property">#<span class="token directive keyword">define</span> Username "LA57WL612Smart_123;12010126;R05S3;1621619622"</span>
<span class="token macro property">#<span class="token directive keyword">define</span> Password "9ebe0d0069ac4dd1e9e98664abc9f726c13b5a150190afdfa7b3c12240ff1e73;hmacsha256"</span><span class="token comment">//密文 </span>
<span class="token comment">//订阅主题:$thing/down/property/{ProductID}/{DeviceName} ---{ProductID}产品ID,{DeviceName}设备名</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SET_TOPIC  "$thing/down/property/LA57WL612/Smart_123"</span><span class="token comment">//订阅</span>
</code></pre>
    <h3>
     <a id="emsp6_50">
     </a>
     6.主题订阅
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/bda4b321257b1a1e7acd4cd95553c533.png#pic_center"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/867ee3df5147cd8e65f3a2ce2a657e06.png#pic_center"/>
    </p>
    <pre><code class="prism language-c"><span class="token comment">//订阅主题:$thing/down/property/{ProductID}/{DeviceName} ---{ProductID}产品ID,{DeviceName}设备名</span>
<span class="token macro property">#<span class="token directive keyword">define</span> SET_TOPIC  "$thing/down/property/LA57WL612/Smart_123"</span><span class="token comment">//订阅</span>
<span class="token comment">//发布主题:$thing/up/property/{ProductID}/{DeviceName}</span>
<span class="token macro property">#<span class="token directive keyword">define</span> POST_TOPIC "$thing/up/property/LA57WL612/Smart_123"</span><span class="token comment">//发布</span>
</code></pre>
    <h3>
     <a id="emsp_7ESP8266WIFITCPSTA_60">
     </a>
     7.初始化ESP8266模块，配置WIFI模式为TCP+STA模式
    </h3>
    <pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">define</span> WIFI_NAME "wbyq"</span><span class="token comment">//WIFI名</span>
<span class="token macro property">#<span class="token directive keyword">define</span> WIFI_PASSWORD "asdfghjkl23"</span><span class="token comment">//wifi密码</span>
<span class="token keyword">char</span> mqtt_message<span class="token punctuation">[</span><span class="token number">200</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//上报数据缓存区</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 stat<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u32 time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u16 cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> temp<span class="token punctuation">;</span>
	<span class="token function">Beep_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//蜂鸣器初始化</span>
	<span class="token function">Led_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//LED初始化</span>
	<span class="token function">Key_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//按键初始化</span>
	<span class="token function">Usartx_Init</span><span class="token punctuation">(</span>USART1<span class="token punctuation">,</span><span class="token number">115200</span><span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Usartx_Init</span><span class="token punctuation">(</span>USART3<span class="token punctuation">,</span><span class="token number">115200</span><span class="token punctuation">,</span><span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">TIMx_Init</span><span class="token punctuation">(</span>TIM2<span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过定时器2辅助串口接收数据，20ms</span>
	<span class="token function">TIMx_Init</span><span class="token punctuation">(</span>TIM4<span class="token punctuation">,</span><span class="token number">72</span><span class="token punctuation">,</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过定时器2辅助串口接收数据，20ms</span>
	<span class="token function">DS18B20_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token comment">//	RTC_Init();//RTC初始化</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"初始化完成\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		stat<span class="token operator">=</span><span class="token function">Esp8266_STA_TCPclinet_Init</span><span class="token punctuation">(</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span>WIFI_NAME<span class="token punctuation">,</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span>WIFI_PASSWORD<span class="token punctuation">,</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span>SERVER_IP<span class="token punctuation">,</span>SERVER_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>stat<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token function">Delay_Ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"stat=%d\r\n"</span><span class="token punctuation">,</span>stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"服务器连接成功\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">MQTT_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		stat<span class="token operator">=</span><span class="token function">MQTT_Connect</span><span class="token punctuation">(</span>ClientID<span class="token punctuation">,</span>Username<span class="token punctuation">,</span>Password<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>stat<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token function">Delay_Ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"正在连接....\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"连接成功\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	stat<span class="token operator">=</span><span class="token function">MQTT_SubscribeTopic</span><span class="token punctuation">(</span>SET_TOPIC<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>stat<span class="token punctuation">)</span><span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"订阅失败\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"订阅成功\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>usart3_flag<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>usart3_cnt<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span>usart3_rx_buff<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
			usart3_cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			usart3_flag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">Delay_Ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		time<span class="token operator">++</span><span class="token punctuation">;</span>
		cnt<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>time<span class="token operator">&gt;=</span><span class="token number">5000</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token function">MQTT_SentHeart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送心跳包</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>cnt<span class="token operator">&gt;=</span><span class="token number">1000</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			temp<span class="token operator">=</span><span class="token function">DS18B20_GetTemp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.0625</span><span class="token punctuation">;</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span>mqtt_message<span class="token punctuation">,</span><span class="token string">"{\"method\":\"report\",\"clientToken\":\"123\",\"params\":{\"LED1\":1,\"temp\":%.2f,\"L\":356}}"</span><span class="token punctuation">,</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//温度</span>
			<span class="token function">MQTT_PublishData</span><span class="token punctuation">(</span>POST_TOPIC<span class="token punctuation">,</span>mqtt_message<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="emsp8_133">
     </a>
     8.设备上报数据格式
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5d2fa8191a21e410f9fdb9e6a3a1a451.png#pic_center"/>
    </p>
    <pre><code class="prism language-c"><span class="token punctuation">{<!-- --></span>
   <span class="token string">"method"</span><span class="token punctuation">:</span><span class="token string">"report"</span><span class="token punctuation">,</span><span class="token comment">//上报设备属性</span>
   <span class="token string">"clientToken"</span><span class="token punctuation">:</span><span class="token string">"123"</span><span class="token punctuation">,</span><span class="token comment">//消息配对标识</span>
   <span class="token string">"timestamp"</span><span class="token punctuation">:</span><span class="token number">1212121221</span><span class="token punctuation">,</span>  <span class="token comment">//可不填，默认为系统时间</span>
   <span class="token string">"params"</span><span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>
       <span class="token string">"power_switch"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//设备属性power_switch</span>
       <span class="token string">"color"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">,</span>        <span class="token comment">//设备属性color</span>
       <span class="token string">"brightness"</span><span class="token punctuation">:</span><span class="token number">32</span>   <span class="token comment">//设备属性brightness</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="emsp9_147">
     </a>
     9.执行效果
    </h3>
    <p>
     设备上报数据到平台
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/84ee6444a610361b63036cb525fb6c13.png#pic_center"/>
     <br/>
     平台下发数据到设备
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5ad6d7b93ddccafbadfc19e1a01ae05e.png#pic_center"/>
     <br/>
     移动端界面:
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e18df052ed8fb91c9af22d8e54d63f88.png#pic_center"/>
    </p>
    <h3>
     <a id="_154">
     </a>
     总结
    </h3>
    <p>
     MQTT 是一个客户端服务端架构的发布/订阅模式的消息传输协议。 它的设计思想是轻巧、 开放、简单、 规范， 因此易于实现。 消耗资源少，在MQTT3.1标准协议中仅有14个报文。每个报文都分为固定报头、可变报头和有效载荷3部分。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/2d7198be7d5c94fb351900ff2db7536a.png#pic_center"/>
     <br/>
     14个报文如下：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/750c1f4c04b6c2e640d1c64827da3bc1.png#pic_center"/>
     <br/>
     示例工程:https://download.csdn.net/download/weixin_44453694/18726172
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34343435333639342f:61727469636c652f64657461696c732f313136383032373736" class_="artid" style="display:none">
 </p>
</div>


