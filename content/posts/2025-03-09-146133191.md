---
layout: post
title: "AF3-squeeze_features函数解读"
date: 2025-03-09 15:38:56 +0800
description: "AlphaFold3  data_transforms 模块的 squeeze_features 函数的作用去除 蛋白质特征张量中不必要的单维度（singleton dimensions）和重复维度，以使其适配 AlphaFold3 预期的输入格式。"
keywords: "AF3 squeeze_features函数解读"
categories: ['未分类']
tags: ['生物信息学', '深度学习', '人工智能', 'Pytorch']
artid: "146133191"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146133191
    alt: "AF3-squeeze_features函数解读"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146133191
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146133191
cover: https://bing.ee123.net/img/rand?artid=146133191
image: https://bing.ee123.net/img/rand?artid=146133191
img: https://bing.ee123.net/img/rand?artid=146133191
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     AF3 squeeze_features函数解读
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     AlphaFold3
     <code>
      data_transforms 模块的
     </code>
     squeeze_features 函数的作用
     <strong>
      去除
     </strong>
     <strong>
      蛋白质特征张量中不必要的单维度（singleton dimensions）和重复维度
     </strong>
     ，以使其适配
     <strong>
      AlphaFold3
     </strong>
     预期的输入格式。
    </p>
    <h4>
     源代码：
    </h4>
    <pre><code>def squeeze_features(protein):
    """Remove singleton and repeated dimensions in protein features."""
    protein["aatype"] = torch.argmax(protein["aatype"], dim=-1)
    for k in [
        "domain_name",
        "msa",
        "num_alignments",
        "seq_length",
        "sequence",
        "superfamily",
        "deletion_matrix",
        "resolution",
        "between_segment_residues",
        "residue_index",
        "template_all_atom_mask",
    ]:
        if k in protein:
            final_dim = protein[k].shape[-1]
            if isinstance(final_dim, int) and final_dim == 1:
                if torch.is_tensor(protein[k]):
                    protein[k] = torch.squeeze(protein[k], dim=-1)
                else:
                    protein[k] = np.squeeze(protein[k], axis=-1)

    for k in ["seq_length", "num_alignments"]:
        if k in protein:
            protein[k] = protein[k][0]

    return protein
</code></pre>
    <h4>
     源码解读：
    </h4>
    <ul>
     <li>
      该函数接收
      <code>
       protein
      </code>
      （一个
      <strong>
       包含蛋白质特征的字典
      </strong>
      ）作为输入。
     </li>
     <li>
      主要任务：
      <ol>
       <li>
        <strong>
         将 one-hot
         <code>
          aatype
         </code>
         转换为索引表示
        </strong>
        。
       </li>
       <li>
        <strong>
         移除 shape 为
         <code>
          (N, ..., 1)
         </code>
         的单维度
        </strong>
        。
       </li>
       <li>
        <strong>
         提取
         <code>
          seq_length
         </code>
         和
         <code>
          num_alignments
         </code>
         的实际数值
        </strong>
        。
       </li>
      </ol>
     </li>
    </ul>
    <h5>
     Step 1: 处理
     <code>
      aatype
     </code>
    </h5>
    <pre><code>protein["aatype"] = torch.argmax(protein["aatype"], dim=-1)
</code></pre>
    <ul>
     <li>
      <strong>
       输入
       <code>
        aatype
       </code>
       （氨基酸类型）通常是 one-hot 编码
      </strong>
     </li>
     <li>
      通过
      <code>
       torch.argmax(..., dim=-1)
      </code>
      获取
      <strong>
       索引
      </strong>
     </li>
     <li>
      <strong>
       目的
      </strong>
      ：简化
      <code>
       aatype
      </code>
      的数据表示，使其直接存储氨基酸索引，而不是 one-hot 矩阵。
     </li>
    </ul>
    <h5>
     Step 2: 移除单维度
    </h5>
    <pre><code>for k in [
    "domain_name",
    "msa",
    "num_alignments",
    "seq_length",
    "sequence",
    "superfamily",
    "deletion_matrix",
    "resolution",
    "between_segment_residues",
    "residue_index",
    "template_all_atom_mask",
]:
    if k in protein:
        final_dim = protein[k].shape[-1]  # 获取最后一维的大小
        if isinstance(final_dim, int) and final_dim == 1:
            if torch.is_tensor(protein[k]):
                protein[k] = torch.squeeze(protein[k], dim=-1)  # 去掉单维度
            else:
                protein[k] = np.squeeze(protein[k], axis=-1)
</code></pre>
    <ul>
     <li>
      <strong>
       遍历多个
       <code>
        protein
       </code>
       特征字段
      </strong>
      ，检查它们是否存在。
     </li>
     <li>
      <strong>
       如果最后一维
       <code>
        final_dim
       </code>
       为
       <code>
        1
       </code>
      </strong>
      ，说明这个维度是
      <strong>
       无意义的单维度
      </strong>
      ，需要去除：
      <ul>
       <li>
        如果是
        <strong>
         PyTorch 张量
        </strong>
        （
        <code>
         torch.Tensor
        </code>
        ），使用
        <code>
         torch.squeeze(dim=-1)
        </code>
        。
       </li>
       <li>
        如果是
        <strong>
         NumPy 数组
        </strong>
        ，使用
        <code>
         np.squeeze(axis=-1)
        </code>
        。
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     Step 3: 处理
     <code>
      seq_length
     </code>
     和
     <code>
      num_alignments
     </code>
    </h5>
    <pre><code>for k in ["seq_length", "num_alignments"]:
    if k in protein:
        protein[k] = protein[k][0]
</code></pre>
    <p>
     <code>
      seq_length
     </code>
     和
     <code>
      num_alignments
     </code>
     可能是
     <strong>
      列表或张量
     </strong>
     ，但它们的数值其实是一个单独的整数，因此需要转换成
     <strong>
      标量值
     </strong>
     。
    </p>
    <h5>
     <strong>
      结论
     </strong>
    </h5>
    <p>
     1️⃣
     <strong>
      转换
      <code>
       aatype
      </code>
     </strong>
     : 从
     <strong>
      one-hot 编码
     </strong>
     转换成
     <strong>
      索引表示
     </strong>
     。
     <br/>
     2️⃣
     <strong>
      移除无用的单维度
     </strong>
     : 让
     <code>
      msa
     </code>
     ,
     <code>
      resolution
     </code>
     ,
     <code>
      deletion_matrix
     </code>
     等数据符合 AlphaFold3 预期格式。
     <br/>
     3️⃣
     <strong>
      转换
      <code>
       seq_length
      </code>
      和
      <code>
       num_alignments
      </code>
      为标量
     </strong>
     : 确保它们不会以张量形式存在，而是整数。
    </p>
    <p>
     💡
     <strong>
      最终作用：保证输入数据的维度符合 AlphaFold3 训练时的输入要求，提高数据处理效率。
     </strong>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f32373339303032332f:61727469636c652f64657461696c732f313436313333313931" class_="artid" style="display:none">
 </p>
</div>


