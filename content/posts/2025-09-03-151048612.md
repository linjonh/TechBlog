---
layout: post
title: "Linuxçº¿ç¨‹å°è£…"
date: 2025-09-03T18:02:56+0800
description: "/ è·å–è½»é‡çº§è¿›ç¨‹IDï¼ˆçº¿ç¨‹IDï¼‰// å®šä¹‰å‡½æ•°ç±»å‹åˆ«åpublic:// æ„é€ å‡½æ•°ï¼šæ¥æ”¶çº¿ç¨‹å‡½æ•°å’Œçº¿ç¨‹å// é™æ€æˆå‘˜å‡½æ•°ï¼šçº¿ç¨‹å¯åŠ¨ä¾‹ç¨‹// è·å–å®é™…çº¿ç¨‹ID// æ‰§è¡Œç”¨æˆ·å‡½æ•°// çº¿ç¨‹é€€å‡º// å¯åŠ¨çº¿ç¨‹std::cout &lt;&lt; &quot;çº¿ç¨‹&quot; &lt;&lt; _name &lt;&lt; &quot;åˆ›å»ºæˆåŠŸ&quot; &lt;&lt; std::endl;// ç­‰å¾…çº¿ç¨‹ç»“æŸif (!std::cout &lt;&lt; &quot;çº¿ç¨‹&quot; &lt;&lt; _name &lt;&lt; &quot;å›æ”¶æˆåŠŸ&quot; &lt;&lt; std::endl;private:// çº¿ç¨‹è¿è¡ŒçŠ¶æ€ã€‚"
keywords: "ã€Linuxã€‘çº¿ç¨‹å°è£…"
categories: ['æœªåˆ†ç±»']
tags: ['Linux', 'Jvm', 'C']
artid: "151048612"
arturl: "https://blog.csdn.net/weixin_54114700/article/details/151048612"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=151048612
    alt: "Linuxçº¿ç¨‹å°è£…"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=151048612
featuredImagePreview: https://bing.ee123.net/img/rand?artid=151048612
cover: https://bing.ee123.net/img/rand?artid=151048612
image: https://bing.ee123.net/img/rand?artid=151048612
img: https://bing.ee123.net/img/rand?artid=151048612
---



# ã€Linuxã€‘çº¿ç¨‹å°è£…



> æç¤ºï¼šæ–‡ç« å†™å®Œåï¼Œç›®å½•å¯ä»¥è‡ªåŠ¨ç”Ÿæˆï¼Œå¦‚ä½•ç”Ÿæˆå¯å‚è€ƒå³è¾¹çš„å¸®åŠ©æ–‡æ¡£

#### æ–‡ç« ç›®å½•













---

## 

### ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦å°è£…çº¿ç¨‹åº“ï¼Ÿ

åœ¨Linux C++å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦ä½¿ç”¨å¤šçº¿ç¨‹ã€‚åŸç”Ÿçš„pthreadæ¥å£è™½ç„¶å¼ºå¤§ï¼Œä½†å­˜åœ¨ä¸€äº›é—®é¢˜ï¼š

#### pthreadçš„ç—›ç‚¹ï¼š

* ğŸ”§Â **Cé£æ ¼æ¥å£**ï¼šå‡½æ•°æŒ‡é’ˆå’Œvoid*å‚æ•°ä¸å¤Ÿç±»å‹å®‰å…¨
* ğŸ“Â **å†—é•¿çš„ä»£ç **ï¼šéœ€è¦æ‰‹åŠ¨ç®¡ç†çº¿ç¨‹åˆ›å»ºã€è¿æ¥ã€é”€æ¯
* ğŸš«Â **æ˜“å‡ºé”™**ï¼šå®¹æ˜“å¿˜è®°æ£€æŸ¥è¿”å›å€¼ï¼Œå¯¼è‡´éš¾ä»¥è°ƒè¯•çš„é—®é¢˜
* ğŸ”„Â **ç¼ºä¹RAII**ï¼šèµ„æºç®¡ç†éœ€è¦æ‰‹åŠ¨å¤„ç†

#### å°è£…å¸¦æ¥çš„å¥½å¤„ï¼š

* ğŸ¯Â **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨std::functionä»£æ›¿å‡½æ•°æŒ‡é’ˆ
* ğŸš€Â **ç®€æ´æ˜“ç”¨**ï¼šå‡ è¡Œä»£ç å®Œæˆçº¿ç¨‹ç®¡ç†
* ğŸ›¡ï¸Â **å¼‚å¸¸å®‰å…¨**ï¼šåˆ©ç”¨RAIIè‡ªåŠ¨ç®¡ç†èµ„æº
* ğŸ“¦Â **å¯æ‰©å±•æ€§**ï¼šæ–¹ä¾¿æ·»åŠ æ–°åŠŸèƒ½ï¼ˆå¦‚çº¿ç¨‹æ± ï¼‰

### äºŒã€çº¿ç¨‹å°è£…æ ¸å¿ƒä»£ç è§£æ

#### 1. å¤´æ–‡ä»¶å®šä¹‰ï¼ˆThread.hppï¼‰

```
#include <iostream>
#include <pthread.h>
#include <unistd.h>
#include <vector>
#include <functional>
#include <sys/syscall.h>

// è·å–è½»é‡çº§è¿›ç¨‹IDï¼ˆçº¿ç¨‹IDï¼‰
#define get_lwp_id() syscall(SYS_gettid)

// å®šä¹‰å‡½æ•°ç±»å‹åˆ«å
using func_t = std::function<void()>;

class Thread
{
public:
    // æ„é€ å‡½æ•°ï¼šæ¥æ”¶çº¿ç¨‹å‡½æ•°å’Œçº¿ç¨‹å
    Thread(func_t func, const std::string &name)
        : _name(name), _func(func), _isrunning(false)
    {
    }

    // é™æ€æˆå‘˜å‡½æ•°ï¼šçº¿ç¨‹å¯åŠ¨ä¾‹ç¨‹
    static void *start_routine(void *args)
    {
        Thread *self = static_cast<Thread *>(args);
        self->_isrunning = true;
        self->_lwpid = get_lwp_id();  // è·å–å®é™…çº¿ç¨‹ID
        self->_func();                // æ‰§è¡Œç”¨æˆ·å‡½æ•°
        pthread_exit((void *)0);      // çº¿ç¨‹é€€å‡º
    }

    // å¯åŠ¨çº¿ç¨‹
    void Start()
    {
        int n = pthread_create(&_tid, nullptr, start_routine, this);
        if (n == 0)
        {
            std::cout << "çº¿ç¨‹" << _name << "åˆ›å»ºæˆåŠŸ" << std::endl;
        }
    }

    // ç­‰å¾…çº¿ç¨‹ç»“æŸ
    void Join()
    {
        if (!_isrunning) return;
        
        int n = pthread_join(_tid, nullptr);
        if (n == 0)
        {
            std::cout << "çº¿ç¨‹" << _name << "å›æ”¶æˆåŠŸ" << std::endl;
        }
    }

    ~Thread() {}

private:
    bool _isrunning;        // çº¿ç¨‹è¿è¡ŒçŠ¶æ€
    pthread_t _tid;         // çº¿ç¨‹ID
    pid_t _lwpid;           // è½»é‡çº§è¿›ç¨‹ID
    std::string _name;      // çº¿ç¨‹åç§°
    func_t _func;           // çº¿ç¨‹æ‰§è¡Œå‡½æ•°
};
```

### ä¸‰ã€å…³é”®æŠ€æœ¯ç‚¹è¯¦è§£

#### 1. std::functionçš„é­…åŠ›

**ä¼ ç»Ÿpthreadçš„é—®é¢˜ï¼š**

```
Â 

// Cé£æ ¼ï¼šéœ€è¦é™æ€å‡½æ•°å’Œvoid*å‚æ•°
void* thread_func(void* arg) {
    // éœ€è¦ç±»å‹è½¬æ¢
    int* data = (int*)arg;
    // ...
}
```

**æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆï¼š**

```
// C++11é£æ ¼ï¼šç±»å‹å®‰å…¨çš„å‡½æ•°å¯¹è±¡
using func_t = std::function<void()>;

// å¯ä»¥æ¥æ”¶ä»»ä½•å¯è°ƒç”¨å¯¹è±¡ï¼š
// 1. æ™®é€šå‡½æ•°
// 2. Lambdaè¡¨è¾¾å¼  
// 3. å‡½æ•°å¯¹è±¡
// 4. std::bindè¡¨è¾¾å¼
```

#### 2. é™æ€æˆå‘˜å‡½æ•°çš„å·§å¦™ä½¿ç”¨

**ä¸ºä»€ä¹ˆéœ€è¦é™æ€å‡½æ•°ï¼Ÿ**  
 pthread_createè¦æ±‚Cé£æ ¼çš„å‡½æ•°æŒ‡é’ˆï¼Œä½†æ™®é€šæˆå‘˜å‡½æ•°æœ‰éšå¼çš„thiså‚æ•°ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**

```
static void *start_routine(void *args) {
    Thread *self = static_cast<Thread *>(args);  // è½¬æ¢å›å¯¹è±¡æŒ‡é’ˆ
    self->_func();  // è°ƒç”¨çœŸæ­£çš„çº¿ç¨‹å‡½æ•°
}
```

#### 3. è·å–çœŸå®çš„çº¿ç¨‹ID

```
#define get_lwp_id() syscall(SYS_gettid)

// ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ
// - pthread_tæ˜¯è¿›ç¨‹å†…æ ‡è¯†ï¼Œåœ¨ä¸åŒè¿›ç¨‹ä¸­å¯èƒ½é‡å¤
// - é€šè¿‡ç³»ç»Ÿè°ƒç”¨è·å–çš„LWP IDæ˜¯ç³»ç»ŸèŒƒå›´å†…å”¯ä¸€çš„
// - ä¾¿äºè°ƒè¯•å’Œç³»ç»Ÿç›‘æ§
```

### å››ã€ä½¿ç”¨ç¤ºä¾‹å’Œæµ‹è¯•ä»£ç 

#### æµ‹è¯•ä»£ç ï¼ˆmain.cppï¼‰

```
#include "Thread.hpp"
#include <iostream>
#include <vector>

// æµ‹è¯•å‡½æ•°
void Test()
{
    int cnt = 3;
    while (cnt--)
    {
        std::cout << "çº¿ç¨‹" << get_lwp_id() << "æ­£åœ¨è¿è¡Œ..." << std::endl;
        sleep(1);
    }
}

// Lambdaè¡¨è¾¾å¼æµ‹è¯•
auto lambda_test = []() {
    std::cout << "Lambdaçº¿ç¨‹è¿è¡Œä¸­" << std::endl;
    sleep(2);
};

int main()
{
    std::cout << "=== å•çº¿ç¨‹æµ‹è¯• ===" << std::endl;
    Thread t1(Test, "single-thread");
    t1.Start();
    t1.Join();

    std::cout << "\n=== å¤šçº¿ç¨‹æµ‹è¯• ===" << std::endl;
    std::vector<Thread> threads;
    
    // åˆ›å»º3ä¸ªçº¿ç¨‹
    for (int i = 0; i < 3; i++)
    {
        std::string name = "thread-";
        name += std::to_string(i + 1);
        threads.emplace_back(Test, name);
    }

    // å¯åŠ¨æ‰€æœ‰çº¿ç¨‹
    for (auto &thread : threads)
    {
        thread.Start();
    }

    // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹ç»“æŸ
    for (auto &thread : threads)
    {
        thread.Join();
    }

    std::cout << "\n=== Lambdaæµ‹è¯• ===" << std::endl;
    Thread t2(lambda_test, "lambda-thread");
    t2.Start();
    t2.Join();

    return 0;
}
```



