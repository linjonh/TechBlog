---
layout: post
title: "补充如何在C20中测量一个函数或者功能的运行时间"
date: 2025-03-14 13:45:22 +0800
description: "之前写过一篇，最近发现了个新的chrono。虽然chrono是 C++11 新增的，但是那时候很少使用，因为很多设计还不完善。加之当时的情况与其他方法相比并不占优。好在 C++20 进行了很多修改，优势起来了，所以现在很多代码里都使用的chrono。本文使用的一些特性是 C++20 才有的，早期版本可能能用，但不保证。这种方法没有之前博客里写的通用，但是代码量简单多了（真的是少了很多很多）。但是我不好说哪个好，哪个坏。因为我不像之前那篇博客，几种方法都使用了很长时间，对优缺点非常清楚。"
keywords: "补充：如何在C++20中测量一个函数或者功能的运行时间"
categories: ['语言家族的笔记', 'C']
tags: ['C']
artid: "146254281"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146254281
    alt: "补充如何在C20中测量一个函数或者功能的运行时间"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146254281
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146254281
cover: https://bing.ee123.net/img/rand?artid=146254281
image: https://bing.ee123.net/img/rand?artid=146254281
img: https://bing.ee123.net/img/rand?artid=146254281
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     补充：如何在C++20中测量一个函数或者功能的运行时间
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     之前写过一篇
     <a href="https://blog.csdn.net/qq_33919450/article/details/134653349">
      《如何在C/C++中测量一个函数或者功能的运行时间（串行和并行，以及三种方法的实际情况对比）》
     </a>
     ，最近发现了个新的
     <code>
      chrono
     </code>
     。
    </p>
    <blockquote>
     <p>
      虽然
      <code>
       chrono
      </code>
      是 C++11 新增的，但是那时候很少使用，因为很多设计还不完善。加之当时的情况与其他方法相比并不占优。好在 C++20 进行了很多修改，优势起来了，所以现在很多代码里都使用的
      <code>
       chrono
      </code>
      。
      <br/>
      本文使用的一些特性是 C++20 才有的，早期版本可能能用，但不保证。
     </p>
    </blockquote>
    <p>
     这种方法没有之前博客里写的通用，但是代码量简单多了（真的是少了很多很多）。
    </p>
    <p>
     但是我不好说哪个好，哪个坏。因为我不像之前那篇博客，几种方法都使用了很长时间，对优缺点非常清楚。所以这里只是记录一下
     <code>
      chrono
     </code>
     的用法，未来可能会更新。写本文是因为现在 C++ 代码中，
     <code>
      chrono
     </code>
     的出场率越来越高，至少要了解一下吧。
    </p>
    <blockquote>
     <p>
      chrono 这个单词是天文（chronometer）的缩写，也有种说法是来自希腊语的 chrónos：希腊神话里的 chrónos 是时间之父。
     </p>
    </blockquote>
    <p>
     看了下文档，
     <code>
      chrono
     </code>
     可以看作是
     <code>
      time
     </code>
     的后继者。主要功能是格式化打印时间（也是，其他家语言都有相关现代标准库，但是 C++ 相关的有点“老”，但这也导致使用起来非常复杂）。所以一般情况下，计时和之前那篇博客的逻辑不太一样：
     <code>
      chrono
     </code>
     计时就是获取系统时间，然后做差，而
     <code>
      clock_gettime
     </code>
     获取的是设备上的计时器/计数器来实现的。
    </p>
    <p>
     当然你也可以在
     <code>
      chrono
     </code>
     使用计数器，后面会说。
    </p>
    <blockquote>
     <p>
      本文主要是讲运行时间，也就是间隔时间，格式化打印系统时间这里不赘述。
     </p>
    </blockquote>
    <h3>
     <a id="_15">
     </a>
     系统时间计算运行时间
    </h3>
    <h4>
     <a id="_16">
     </a>
     复杂版
    </h4>
    <p>
     先直接上代码（下面这个代码不是最简的，也不好写，这里主要是为了说明代码，后面会放个简化的代码）：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono&gt;</span></span>

	std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>time_point<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock<span class="token operator">&gt;</span> start <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>需要被测量的代码
	
    std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>time_point<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock<span class="token operator">&gt;</span> end <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>duration<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>nano<span class="token operator">&gt;</span>  elapsed <span class="token operator">=</span> end <span class="token operator">-</span> start<span class="token punctuation">;</span>
    <span class="token comment">// 注意，这里是elapsed.count()，而不是简单使用elapsed</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span>elapsed<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
</code></pre>
    <p>
     现在来讲一下这个代码的含义。
    </p>
    <p>
     可以看到获取开始、结束时间的时候，使用的是
     <code>
      system_clock
     </code>
     ，也就是系统时间。如果你想使用计数器，那么改成
     <code>
      steady_clock
     </code>
     （这部分后面会举个例子，现在还不能说）。
    </p>
    <p>
     继续往后看，可以注意到，计算差值的时候，前面的类型是
     <code>
      std::chrono::duration&lt;double, std::nano&gt;
     </code>
     ，其他部分都很好理解，但是这里的
     <code>
      &lt;double, std::nano&gt;
     </code>
     ，前者是双精度浮点类型，后者是啥意思呢？
    </p>
    <p>
     这就是不太一样的地方，这里
     <code>
      nano
     </code>
     表示计时单位是纳秒。还记得
     <code>
      clock_gettime
     </code>
     的时候吗，我们为了转换时间单位需要进行大量计算（反正我每次用都是复制的，谁每次都手写啊）。这里的
     <code>
      nano
     </code>
     是
     <code>
      std
     </code>
     里设置的一些量（这是个比率），可以换成其他的单位，如下（可以看到不光有时间的单位）：
    </p>
    <p>
     <img alt="请添加图片描述" height="300" src="https://i-blog.csdnimg.cn/direct/c454064c715545a3ba7dbdfb1237764b.png"/>
    </p>
    <p>
     需要注意这里是个比率，如果把
     <code>
      nano
     </code>
     改成
     <code>
      deci
     </code>
     （十进制的意思），比率也就是
     <code>
      deci
     </code>
     ，最后获得的秒数就是 10 倍的实际秒数。打印的时候记得除以 10。
    </p>
    <blockquote>
     <p>
      当然我这里是举个例子，实际用的时候你可以直接用
      <code>
       nano
      </code>
      ，然后除以
      <code>
       1e9
      </code>
      ，也一样的。
     </p>
    </blockquote>
    <h4>
     <a id="_45">
     </a>
     简化版
    </h4>
    <p>
     都 C++20 了，很多事情都可以简化了。根据 C++ 基金会调查统计，2024 年只有 30% 的人使用 C++20，很多事情也不一样了：
    </p>
    <p>
     <img alt="请添加图片描述" height="300" src="https://i-blog.csdnimg.cn/direct/51ba7ac90e6f485e817c1facbbb30495.png"/>
    </p>
    <p>
     <strong>
      所以这里你可以偷懒，把上面的数据类型改成
      <code>
       auto
      </code>
     </strong>
     ，都 C++20 了，就别老扣数据类型了：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono&gt;</span></span>
	<span class="token comment">// 使用std::literals之后，你就可以直接使用`1s`来表示1秒，太方便了</span>
	<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token double-colon punctuation">::</span>literals<span class="token punctuation">;</span>
	
	<span class="token keyword">auto</span> start <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>需要被测量的代码
	
    <span class="token keyword">auto</span> end <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span> <span class="token string">"ms: "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token operator">/</span> <span class="token number">1</span>ms <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout<span class="token operator">&lt;&lt;</span> <span class="token string">"s: "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token operator">/</span> <span class="token number">1</span>s <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
</code></pre>
    <p>
     运行之后是这样的：
    </p>
    <pre><code>$ ./a.out 
ms: 2317
s: 2
</code></pre>
    <p>
     这代码量是不是相当少，还少了计算时间的时候处理数据类型转换的步骤。
    </p>
    <h3>
     <a id="_77">
     </a>
     计数器计算运行时间
    </h3>
    <p>
     现在回到前面
     <code>
      steady_clock
     </code>
     到部分，如果用计数器来计算时间呢？
    </p>
    <p>
     就是把
     <code>
      system_clock
     </code>
     改成
     <code>
      steady_clock
     </code>
     。这里我们直接用简化版：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono&gt;</span></span>
	<span class="token keyword">auto</span> start <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>steady_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
 	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>需要被测量的代码
 
    <span class="token keyword">auto</span> end <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>steady_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     时间的使用方法和系统时间一模一样。
    </p>
    <h3>
     <a id="_93">
     </a>
     参考资料
    </h3>
    <p>
     <a href="https://en.cppreference.com/w/cpp/header/chrono" rel="nofollow">
      Standard library header - cppreference.com
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33333931393435302f:61727469636c652f64657461696c732f313436323534323831" class_="artid" style="display:none">
 </p>
</div>


