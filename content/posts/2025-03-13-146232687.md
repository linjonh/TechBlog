---
layout: post
title: "PyTorch多机训练Loss不一致问题排查指南基于算子级一致性验证"
date: 2025-03-13 15:38:00 +0800
description: "比较二次训练过程中所有算子的误差,定位存在一致性问题的pytorch算子"
keywords: "PyTorch多机训练Loss不一致问题排查指南：基于算子级一致性验证"
categories: ['调试工具']
tags: ['人工智能', 'Pytorch', 'Python']
artid: "146232687"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146232687
    alt: "PyTorch多机训练Loss不一致问题排查指南基于算子级一致性验证"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146232687
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146232687
cover: https://bing.ee123.net/img/rand?artid=146232687
image: https://bing.ee123.net/img/rand?artid=146232687
img: https://bing.ee123.net/img/rand?artid=146232687
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     PyTorch多机训练Loss不一致问题排查指南：基于算子级一致性验证
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h3>
     <a id="_3">
     </a>
     一.背景
    </h3>
    <p>
     在分布式训练场景中，观察到以下现象：
    </p>
    <ol>
     <li>
      相同超参配置下，多次训练的Loss曲线存在显著差异（波动幅度&gt;5%）
     </li>
     <li>
      模型收敛稳定性受训练节点数影响，节点越多差异越明显
     </li>
     <li>
      梯度检查（Gradient Check）未发现异常，初步排除模型结构问题
     </li>
    </ol>
    <h3>
     <a id="_9">
     </a>
     二.技术方案
    </h3>
    <h4>
     <a id="1_11">
     </a>
     1.核心思路
    </h4>
    <p>
     通过算子级数值一致性验证，定位导致多机训练结果不一致的PyTorch原生算子。关键技术路径：
    </p>
    <ol>
     <li>
      <strong>
       算子拦截
      </strong>
      ：利用
      <code>
       __torch_dispatch__
      </code>
      机制捕获所有ATen算子调用
     </li>
     <li>
      <strong>
       双模校验
      </strong>
      ：
      <ul>
       <li>
        <strong>
         基准模式
        </strong>
        ：首次运行保存各算子输入/输出的统计特征
       </li>
       <li>
        <strong>
         验证模式
        </strong>
        ：后续运行实时校验数值一致性
       </li>
      </ul>
     </li>
     <li>
      <strong>
       差异定位
      </strong>
      ：当检测到统计特征偏离时，打印完整的调用栈信息
     </li>
    </ol>
    <h4>
     <a id="2_19">
     </a>
     2.关键技术点
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        模块
       </th>
       <th>
        实现方案
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        算子拦截
       </td>
       <td>
        继承
        <code>
         TorchDispatchMode
        </code>
        重写调度逻辑
       </td>
      </tr>
      <tr>
       <td>
        特征提取
       </td>
       <td>
        计算张量均值（排除形状/类型等非数值因素）
       </td>
      </tr>
      <tr>
       <td>
        差异检测
       </td>
       <td>
        使用
        <code>
         torch.allclose
        </code>
        进行容差对比（默认atol=1e-4）
       </td>
      </tr>
      <tr>
       <td>
        结果持久化
       </td>
       <td>
        按rank序列化存储基准数据到磁盘
       </td>
      </tr>
      <tr>
       <td>
        黑名单机制
       </td>
       <td>
        过滤
        <code>
         empty_like
        </code>
        等非计算类算子，减少误报
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="_28">
     </a>
     三.代码
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>_python_dispatch <span class="token keyword">import</span> TorchDispatchMode
<span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Any
<span class="token keyword">from</span> datetime <span class="token keyword">import</span> datetime
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> time
<span class="token keyword">import</span> os
<span class="token keyword">import</span> pickle
<span class="token keyword">import</span> inspect
<span class="token keyword">import</span> traceback

<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">_ProfilerState</span><span class="token punctuation">:</span>
    cls<span class="token punctuation">:</span> Any
    <span class="token builtin">object</span><span class="token punctuation">:</span> Any <span class="token operator">=</span> <span class="token boolean">None</span>

<span class="token keyword">def</span> <span class="token function">is_tensor</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">do_compare</span><span class="token punctuation">(</span>rank<span class="token punctuation">,</span> name<span class="token punctuation">,</span> tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    timestamp <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
    seconds <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span>
    millis <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>timestamp <span class="token operator">-</span> seconds<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span>
    now<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>time<span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">'%Y-%m-%d %H:%M:%S'</span><span class="token punctuation">,</span> time<span class="token punctuation">.</span>localtime<span class="token punctuation">(</span>seconds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>millis<span class="token punctuation">:</span><span class="token format-spec">03d</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
    has_nan <span class="token operator">=</span> torch<span class="token punctuation">.</span>isnan<span class="token punctuation">(</span>tensor<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> has_nan<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"has_nan </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>now<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>rank<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>tensor<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>tensor<span class="token punctuation">.</span>dtype<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>tensor<span class="token punctuation">.</span>device<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    current_mean <span class="token operator">=</span> torch<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>tensor<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cache_file <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"/logs/rank_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>rank<span class="token punctuation">}</span></span><span class="token string">.pkl"</span></span>
    os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>cache_file<span class="token punctuation">)</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    stored_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>cache_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>cache_file<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
                stored_data <span class="token operator">=</span> pickle<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"load failed:"</span><span class="token punctuation">,</span>cache_file<span class="token punctuation">)</span>
            traceback<span class="token punctuation">.</span>print_exc<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> name <span class="token keyword">in</span> stored_data<span class="token punctuation">:</span>
        <span class="token keyword">if</span> torch<span class="token punctuation">.</span>allclose<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>current_mean<span class="token punctuation">)</span><span class="token punctuation">,</span>
                         torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>stored_data<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         atol<span class="token operator">=</span><span class="token number">1e-4</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">True</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"------------------------------In-----------------------------------"</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"MisMatch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>now<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>rank<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>tensor<span class="token punctuation">.</span>shape<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>tensor<span class="token punctuation">.</span>dtype<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>tensor<span class="token punctuation">.</span>device<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>current_mean<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>stored_data<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> min:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>torch<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>tensor<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string"> max:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>tensor<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        stored_data<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> current_mean
        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>cache_file<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
            pickle<span class="token punctuation">.</span>dump<span class="token punctuation">(</span>stored_data<span class="token punctuation">,</span> f<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>

index_counter <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">def</span> <span class="token function">compare_tensor</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> index_counter
    index_counter <span class="token operator">+=</span> <span class="token number">1</span>
    rank<span class="token operator">=</span>torch<span class="token punctuation">.</span>distributed<span class="token punctuation">.</span>get_rank<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> is_tensor<span class="token punctuation">(</span>tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> do_compare<span class="token punctuation">(</span>rank<span class="token punctuation">,</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name<span class="token punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>index_counter<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>tensor<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">tuple</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> idx<span class="token punctuation">,</span> t <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> is_tensor<span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token keyword">not</span> do_compare<span class="token punctuation">(</span>rank<span class="token punctuation">,</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>name<span class="token punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>index_counter<span class="token punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>idx<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span>t<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">return</span> <span class="token boolean">False</span>
    <span class="token keyword">return</span> <span class="token boolean">True</span>

<span class="token keyword">class</span> <span class="token class-name">TorchDumpDispatchMode</span><span class="token punctuation">(</span>TorchDispatchMode<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>parent<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>parent<span class="token operator">=</span>parent

    <span class="token keyword">def</span> <span class="token function">is_allow_dump</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>name<span class="token punctuation">)</span><span class="token punctuation">:</span>
        black_list<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"empty"</span><span class="token punctuation">,</span><span class="token string">"like"</span><span class="token punctuation">,</span><span class="token string">"zero"</span><span class="token punctuation">,</span><span class="token string">"detach"</span><span class="token punctuation">,</span><span class="token string">"has"</span><span class="token punctuation">,</span><span class="token string">"view"</span><span class="token punctuation">,</span>
                    <span class="token string">"copy"</span><span class="token punctuation">,</span><span class="token string">"arange"</span><span class="token punctuation">,</span><span class="token string">"fill"</span><span class="token punctuation">,</span><span class="token string">"ones"</span><span class="token punctuation">,</span><span class="token string">"lift_fresh"</span><span class="token punctuation">,</span><span class="token string">"alias"</span><span class="token punctuation">,</span>
                    <span class="token string">"scalar_tensor"</span><span class="token punctuation">,</span><span class="token string">"clone"</span><span class="token punctuation">,</span><span class="token string">"stack"</span><span class="token punctuation">,</span><span class="token string">"slice"</span><span class="token punctuation">,</span><span class="token string">"source"</span><span class="token punctuation">,</span><span class="token string">"barrier"</span><span class="token punctuation">,</span>
                    <span class="token string">"select"</span><span class="token punctuation">,</span><span class="token string">"random"</span><span class="token punctuation">,</span><span class="token string">"unsqueeze"</span><span class="token punctuation">,</span><span class="token string">"expand"</span><span class="token punctuation">,</span><span class="token string">"normal_"</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> black_list<span class="token punctuation">:</span>
            <span class="token keyword">if</span> name<span class="token punctuation">.</span>find<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">&gt;=</span><span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token boolean">False</span>
        <span class="token keyword">return</span> <span class="token boolean">True</span>

    <span class="token keyword">def</span> <span class="token function">__torch_dispatch__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> func<span class="token punctuation">,</span> types<span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> kwargs<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        func_packet <span class="token operator">=</span> func<span class="token punctuation">.</span>_overloadpacket
        op_name<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>func<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        enable_dump<span class="token operator">=</span> self<span class="token punctuation">.</span>is_allow_dump<span class="token punctuation">(</span>op_name<span class="token punctuation">)</span>
        <span class="token keyword">if</span> kwargs <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            kwargs <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> enable_dump<span class="token punctuation">:</span>
            torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>synchronize<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> compare_tensor<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>op_name<span class="token punctuation">}</span></span><span class="token string">-[input]"</span></span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
                stack <span class="token operator">=</span> inspect<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">)</span>
                i<span class="token operator">=</span><span class="token number">0</span>
                <span class="token keyword">for</span> frame_info <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    msg<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>frame_info<span class="token punctuation">.</span>filename<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>frame_info<span class="token punctuation">.</span>lineno<span class="token punctuation">}</span></span><span class="token string">"</span></span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
                    i<span class="token operator">+=</span><span class="token number">1</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"------------------------------Out-----------------------------------"</span><span class="token punctuation">)</span>
        ret<span class="token operator">=</span> func<span class="token punctuation">(</span><span class="token operator">*</span>args<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        <span class="token keyword">if</span> enable_dump<span class="token punctuation">:</span>
            torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>synchronize<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> compare_tensor<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>op_name<span class="token punctuation">}</span></span><span class="token string">-[output0]"</span></span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">:</span>
                stack <span class="token operator">=</span> inspect<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">)</span>
                i<span class="token operator">=</span><span class="token number">0</span>
                <span class="token keyword">for</span> frame_info <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    msg<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>frame_info<span class="token punctuation">.</span>filename<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>frame_info<span class="token punctuation">.</span>lineno<span class="token punctuation">}</span></span><span class="token string">"</span></span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
                    i<span class="token operator">+=</span><span class="token number">1</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"------------------------------Out0-----------------------------------"</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> compare_tensor<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>op_name<span class="token punctuation">}</span></span><span class="token string">-[output1]"</span></span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">:</span>
                stack <span class="token operator">=</span> inspect<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">)</span>
                i<span class="token operator">=</span><span class="token number">0</span>
                <span class="token keyword">for</span> frame_info <span class="token keyword">in</span> <span class="token builtin">reversed</span><span class="token punctuation">(</span>stack<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    msg<span class="token operator">=</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>frame_info<span class="token punctuation">.</span>filename<span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>frame_info<span class="token punctuation">.</span>lineno<span class="token punctuation">}</span></span><span class="token string">"</span></span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
                    i<span class="token operator">+=</span><span class="token number">1</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"------------------------------Out1-----------------------------------"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret

<span class="token keyword">class</span> <span class="token class-name">TorchDebugDumper</span><span class="token punctuation">:</span>
    _CURRENT_Dumper <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>p<span class="token operator">=</span> _ProfilerState<span class="token punctuation">(</span>TorchDumpDispatchMode<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__enter__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> TorchDebugDumper<span class="token punctuation">.</span>_CURRENT_Dumper <span class="token keyword">is</span> <span class="token boolean">None</span>
        TorchDebugDumper<span class="token punctuation">.</span>_CURRENT_Dumper <span class="token operator">=</span> self
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token builtin">object</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            o <span class="token operator">=</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span>cls<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
            o<span class="token punctuation">.</span>__enter__<span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token builtin">object</span> <span class="token operator">=</span> o
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self

    <span class="token keyword">def</span> <span class="token function">__exit__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> exc_type<span class="token punctuation">,</span> exc_val<span class="token punctuation">,</span> exc_tb<span class="token punctuation">)</span><span class="token punctuation">:</span>
        TorchDebugDumper<span class="token punctuation">.</span>_CURRENT_Dumper <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token builtin">object</span> <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token builtin">object</span><span class="token punctuation">.</span>__exit__<span class="token punctuation">(</span>exc_type<span class="token punctuation">,</span> exc_val<span class="token punctuation">,</span> exc_tb<span class="token punctuation">)</span>
            <span class="token keyword">del</span> self<span class="token punctuation">.</span>p<span class="token punctuation">.</span><span class="token builtin">object</span>

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pretrain<span class="token punctuation">(</span>
        train_valid_test_datasets_provider<span class="token punctuation">,</span>
        model_provider<span class="token punctuation">,</span>
        forward_step<span class="token punctuation">,</span>
        extra_args_provider<span class="token operator">=</span>llama_argument_handler<span class="token punctuation">,</span>
        args_defaults<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"tokenizer_type"</span><span class="token punctuation">:</span> <span class="token string">"GPT2BPETokenizer"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> TorchDebugDumper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f36313836343537372f:61727469636c652f64657461696c732f313436323332363837" class_="artid" style="display:none">
 </p>
</div>


