---
layout: post
title: "P8ä½¿ç”¨pytorchå®ç°YOLOv5-C3æ¨¡å—"
date: 2025-03-07 17:28:28 +0800
description: "æœ¬å‘¨å…ˆç”¨pytorchæ¥å®ç°YOLOv5-C3çš„æ¨¡å—ï¼Œæå‰ç†Ÿæ‚‰ä¸€ä¸‹YOLOï¼Œè™½ç„¶YOLOå„è·¯å¤§ç¥ç‰ˆæœ¬å¾ˆå¤šï¼Œä½†æ˜¯V5å¾ˆç¨³å®šï¼Œè¿˜æ˜¯å¾ˆæœ‰å¿…è¦å­¦ä¹ å­¦ä¹ çš„ã€‚ä»»åŠ¡æ˜¯å¤©æ°”åˆ†ç±»ã€‚æé—®ï¼šæ˜¯å¦å¯ä»¥è°ƒæ•´C3å’ŒConvå—æ¥æé«˜å‡†ç¡®ç‡ï¼Ÿ"
keywords: "P8ï¼šä½¿ç”¨pytorchå®ç°YOLOv5-C3æ¨¡å—"
categories: ['æ·±åº¦å­¦ä¹ ']
tags: ['äººå·¥æ™ºèƒ½', 'Yolo', 'Pytorch']
artid: "146096138"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146096138
    alt: "P8ä½¿ç”¨pytorchå®ç°YOLOv5-C3æ¨¡å—"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146096138
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146096138
cover: https://bing.ee123.net/img/rand?artid=146096138
image: https://bing.ee123.net/img/rand?artid=146096138
img: https://bing.ee123.net/img/rand?artid=146096138
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     P8ï¼šä½¿ç”¨pytorchå®ç°YOLOv5-C3æ¨¡å—
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <ul>
     <li>
      <strong>
       ğŸ¨ æœ¬æ–‡ä¸º
       <a href="https://mp.weixin.qq.com/s/kV8ZsJv6cPNzJLEuhPfvXg" rel="nofollow">
        ğŸ”—365å¤©æ·±åº¦å­¦ä¹ è®­ç»ƒè¥
       </a>
       ä¸­çš„å­¦ä¹ è®°å½•åšå®¢
      </strong>
     </li>
     <li>
      <strong>
       ğŸ– åŸä½œè€…ï¼š
       <a href="https://mtyjkh.blog.csdn.net/" rel="nofollow">
        KåŒå­¦å•Š
       </a>
      </strong>
      <br/>
      <strong>
       æˆ‘çš„ç¯å¢ƒ
      </strong>
      <br/>
      è¯­è¨€ç¯å¢ƒï¼špython 3.7.12
      <br/>
      ç¼–è¯‘å™¨ï¼špycharm
      <br/>
      æ·±åº¦å­¦ä¹ ç¯å¢ƒï¼štensorflow 2.7.0
      <br/>
      æ•°æ®ï¼šå¤©æ°”æœ¬åœ°æ•°æ®é›†
     </li>
    </ul>
    <h2>
     <a id="_7">
     </a>
     ä¸€ã€å‰è¨€
    </h2>
    <p>
     æœ¬å‘¨å…ˆç”¨pytorchæ¥å®ç°YOLOv5-C3çš„æ¨¡å—ï¼Œæå‰ç†Ÿæ‚‰ä¸€ä¸‹YOLOï¼Œè™½ç„¶YOLOå„è·¯å¤§ç¥ç‰ˆæœ¬å¾ˆå¤šï¼Œä½†æ˜¯V5å¾ˆç¨³å®šï¼Œè¿˜æ˜¯å¾ˆæœ‰å¿…è¦å­¦ä¹ å­¦ä¹ çš„ã€‚ä»»åŠ¡æ˜¯å¤©æ°”åˆ†ç±»ã€‚
    </p>
    <h2>
     <a id="_9">
     </a>
     äºŒã€ä»£ç 
    </h2>
    <pre><code># ç¬¬P8å‘¨ï¼šYOLOv5-C3æ¨¡å—å®ç°
# è®¾ç½®è®¾å¤‡
import torch
import torch.nn as nn
import torchvision.transforms as transforms
import torchvision
from torchvision import transforms, datasets
import os,PIL,pathlib,warnings

warnings.filterwarnings("ignore")             #å¿½ç•¥è­¦å‘Šä¿¡æ¯

device = torch.device("cuda" if torch.cuda.is_available() else "cpu")
device

# å¯¼å…¥æ•°æ®
import os,PIL,random,pathlib

data_dir1 = './weather-data/'
data_dir = pathlib.Path(data_dir1)

data_paths  = list(data_dir.glob('*'))
classeNames = [str(path).split("/")[1] for path in data_paths]
print(classeNames)

# å…³äºtransforms.Composeçš„æ›´å¤šä»‹ç»å¯ä»¥å‚è€ƒï¼šhttps://blog.csdn.net/qq_38251616/article/details/124878863
train_transforms = transforms.Compose([
    transforms.Resize([224, 224]),  # å°†è¾“å…¥å›¾ç‰‡resizeæˆç»Ÿä¸€å°ºå¯¸
    # transforms.RandomHorizontalFlip(), # éšæœºæ°´å¹³ç¿»è½¬
    transforms.ToTensor(),          # å°†PIL Imageæˆ–numpy.ndarrayè½¬æ¢ä¸ºtensorï¼Œå¹¶å½’ä¸€åŒ–åˆ°[0,1]ä¹‹é—´
    transforms.Normalize(           # æ ‡å‡†åŒ–å¤„ç†--&gt;è½¬æ¢ä¸ºæ ‡å‡†æ­£å¤ªåˆ†å¸ƒï¼ˆé«˜æ–¯åˆ†å¸ƒï¼‰ï¼Œä½¿æ¨¡å‹æ›´å®¹æ˜“æ”¶æ•›
        mean=[0.485, 0.456, 0.406],
        std=[0.229, 0.224, 0.225])  # å…¶ä¸­ mean=[0.485,0.456,0.406]ä¸std=[0.229,0.224,0.225] ä»æ•°æ®é›†ä¸­éšæœºæŠ½æ ·è®¡ç®—å¾—åˆ°çš„ã€‚
])

test_transform = transforms.Compose([
    transforms.Resize([224, 224]),  # å°†è¾“å…¥å›¾ç‰‡resizeæˆç»Ÿä¸€å°ºå¯¸
    transforms.ToTensor(),          # å°†PIL Imageæˆ–numpy.ndarrayè½¬æ¢ä¸ºtensorï¼Œå¹¶å½’ä¸€åŒ–åˆ°[0,1]ä¹‹é—´
    transforms.Normalize(           # æ ‡å‡†åŒ–å¤„ç†--&gt;è½¬æ¢ä¸ºæ ‡å‡†æ­£å¤ªåˆ†å¸ƒï¼ˆé«˜æ–¯åˆ†å¸ƒï¼‰ï¼Œä½¿æ¨¡å‹æ›´å®¹æ˜“æ”¶æ•›
        mean=[0.485, 0.456, 0.406],
        std=[0.229, 0.224, 0.225])  # å…¶ä¸­ mean=[0.485,0.456,0.406]ä¸std=[0.229,0.224,0.225] ä»æ•°æ®é›†ä¸­éšæœºæŠ½æ ·è®¡ç®—å¾—åˆ°çš„ã€‚
])

total_data = datasets.ImageFolder(data_dir1,transform=train_transforms)
print(total_data)
print(total_data.class_to_idx)

# åˆ’åˆ†æ•°æ®é›†
train_size = int(0.8 * len(total_data))
test_size  = len(total_data) - train_size
train_dataset, test_dataset = torch.utils.data.random_split(total_data, [train_size, test_size])
print(train_dataset, test_dataset)
batch_size = 4

train_dl = torch.utils.data.DataLoader(train_dataset,
                                           batch_size=batch_size,
                                           shuffle=True,
                                           num_workers=1)
test_dl = torch.utils.data.DataLoader(test_dataset,
                                          batch_size=batch_size,
                                          shuffle=True,
                                          num_workers=1)
for X, y in test_dl:
    print("Shape of X [N, C, H, W]: ", X.shape)
    print("Shape of y: ", y.shape, y.dtype)
    break

# æ­å»ºåŒ…å«C3æ¨¡å—çš„æ¨¡å‹
import torch.nn.functional as F


def autopad(k, p=None):  # kernel, padding
    # Pad to 'same'
    if p is None:
        p = k // 2 if isinstance(k, int) else [x // 2 for x in k]  # auto-pad
    return p


class Conv(nn.Module):
    # Standard convolution
    def __init__(self, c1, c2, k=1, s=1, p=None, g=1, act=True):  # ch_in, ch_out, kernel, stride, padding, groups
        super().__init__()
        self.conv = nn.Conv2d(c1, c2, k, s, autopad(k, p), groups=g, bias=False)
        self.bn = nn.BatchNorm2d(c2)
        self.act = nn.SiLU() if act is True else (act if isinstance(act, nn.Module) else nn.Identity())

    def forward(self, x):
        return self.act(self.bn(self.conv(x)))


class Bottleneck(nn.Module):
    # Standard bottleneck
    def __init__(self, c1, c2, shortcut=True, g=1, e=0.5):  # ch_in, ch_out, shortcut, groups, expansion
        super().__init__()
        c_ = int(c2 * e)  # hidden channels
        self.cv1 = Conv(c1, c_, 1, 1)
        self.cv2 = Conv(c_, c2, 3, 1, g=g)
        self.add = shortcut and c1 == c2

    def forward(self, x):
        return x + self.cv2(self.cv1(x)) if self.add else self.cv2(self.cv1(x))


class C3(nn.Module):
    # CSP Bottleneck with 3 convolutions
    def __init__(self, c1, c2, n=1, shortcut=True, g=1, e=0.5):  # ch_in, ch_out, number, shortcut, groups, expansion
        super().__init__()
        c_ = int(c2 * e)  # hidden channels
        self.cv1 = Conv(c1, c_, 1, 1)
        self.cv2 = Conv(c1, c_, 1, 1)
        self.cv3 = Conv(2 * c_, c2, 1)  # act=FReLU(c2)
        self.m = nn.Sequential(*(Bottleneck(c_, c_, shortcut, g, e=1.0) for _ in range(n)))

    def forward(self, x):
        return self.cv3(torch.cat((self.m(self.cv1(x)), self.cv2(x)), dim=1))


class model_K(nn.Module):
    def __init__(self):
        super(model_K, self).__init__()

        # å·ç§¯æ¨¡å—
        self.Conv = Conv(3, 32, 3, 2)

        # C3æ¨¡å—1
        self.C3_1 = C3(32, 64, 3, 2)

        # å…¨è¿æ¥ç½‘ç»œå±‚ï¼Œç”¨äºåˆ†ç±»
        self.classifier = nn.Sequential(
            nn.Linear(in_features=802816, out_features=100),
            nn.ReLU(),
            nn.Linear(in_features=100, out_features=4)
        )

    def forward(self, x):
        x = self.Conv(x)
        x = self.C3_1(x)
        x = torch.flatten(x, start_dim=1)
        x = self.classifier(x)

        return x


device = "cuda" if torch.cuda.is_available() else "cpu"
print("Using {} device".format(device))

model = model_K().to(device)
print(model)

# ç»Ÿè®¡æ¨¡å‹å‚æ•°é‡ä»¥åŠå…¶ä»–æŒ‡æ ‡
import torchsummary as summary
summary.summary(model, (3, 224, 224))

# è®­ç»ƒå‡½æ•°
# è®­ç»ƒå¾ªç¯
def train(dataloader, model, loss_fn, optimizer):
    size = len(dataloader.dataset)  # è®­ç»ƒé›†çš„å¤§å°
    num_batches = len(dataloader)  # æ‰¹æ¬¡æ•°ç›®, (size/batch_sizeï¼Œå‘ä¸Šå–æ•´)

    train_loss, train_acc = 0, 0  # åˆå§‹åŒ–è®­ç»ƒæŸå¤±å’Œæ­£ç¡®ç‡

    for X, y in dataloader:  # è·å–å›¾ç‰‡åŠå…¶æ ‡ç­¾
        X, y = X.to(device), y.to(device)

        # è®¡ç®—é¢„æµ‹è¯¯å·®
        pred = model(X)  # ç½‘ç»œè¾“å‡º
        loss = loss_fn(pred, y)  # è®¡ç®—ç½‘ç»œè¾“å‡ºå’ŒçœŸå®å€¼ä¹‹é—´çš„å·®è·ï¼Œtargetsä¸ºçœŸå®å€¼ï¼Œè®¡ç®—äºŒè€…å·®å€¼å³ä¸ºæŸå¤±

        # åå‘ä¼ æ’­
        optimizer.zero_grad()  # gradå±æ€§å½’é›¶
        loss.backward()  # åå‘ä¼ æ’­
        optimizer.step()  # æ¯ä¸€æ­¥è‡ªåŠ¨æ›´æ–°

        # è®°å½•accä¸loss
        train_acc += (pred.argmax(1) == y).type(torch.float).sum().item()
        train_loss += loss.item()

    train_acc /= size
    train_loss /= num_batches

    return train_acc, train_loss

# æµ‹è¯•å‡½æ•°
def test(dataloader, model, loss_fn):
    size = len(dataloader.dataset)  # æµ‹è¯•é›†çš„å¤§å°
    num_batches = len(dataloader)  # æ‰¹æ¬¡æ•°ç›®, (size/batch_sizeï¼Œå‘ä¸Šå–æ•´)
    test_loss, test_acc = 0, 0

    # å½“ä¸è¿›è¡Œè®­ç»ƒæ—¶ï¼Œåœæ­¢æ¢¯åº¦æ›´æ–°ï¼ŒèŠ‚çœè®¡ç®—å†…å­˜æ¶ˆè€—
    with torch.no_grad():
        for imgs, target in dataloader:
            imgs, target = imgs.to(device), target.to(device)

            # è®¡ç®—loss
            target_pred = model(imgs)
            loss = loss_fn(target_pred, target)

            test_loss += loss.item()
            test_acc += (target_pred.argmax(1) == target).type(torch.float).sum().item()

    test_acc /= size
    test_loss /= num_batches

    return test_acc, test_loss

# æ­£å¼è®­ç»ƒ
import copy

optimizer = torch.optim.Adam(model.parameters(), lr=1e-4)
loss_fn = nn.CrossEntropyLoss()  # åˆ›å»ºæŸå¤±å‡½æ•°

epochs = 20

train_loss = []
train_acc = []
test_loss = []
test_acc = []

best_acc = 0  # è®¾ç½®ä¸€ä¸ªæœ€ä½³å‡†ç¡®ç‡ï¼Œä½œä¸ºæœ€ä½³æ¨¡å‹çš„åˆ¤åˆ«æŒ‡æ ‡

for epoch in range(epochs):

    model.train()
    epoch_train_acc, epoch_train_loss = train(train_dl, model, loss_fn, optimizer)

    model.eval()
    epoch_test_acc, epoch_test_loss = test(test_dl, model, loss_fn)

    # ä¿å­˜æœ€ä½³æ¨¡å‹åˆ° best_model
    if epoch_test_acc &gt; best_acc:
        best_acc = epoch_test_acc
        best_model = copy.deepcopy(model)

    train_acc.append(epoch_train_acc)
    train_loss.append(epoch_train_loss)
    test_acc.append(epoch_test_acc)
    test_loss.append(epoch_test_loss)

    # è·å–å½“å‰çš„å­¦ä¹ ç‡
    lr = optimizer.state_dict()['param_groups'][0]['lr']

    template = ('Epoch:{:2d}, Train_acc:{:.1f}%, Train_loss:{:.3f}, Test_acc:{:.1f}%, Test_loss:{:.3f}, Lr:{:.2E}')
    print(template.format(epoch + 1, epoch_train_acc * 100, epoch_train_loss,
                          epoch_test_acc * 100, epoch_test_loss, lr))

# ä¿å­˜æœ€ä½³æ¨¡å‹åˆ°æ–‡ä»¶ä¸­
PATH = './best_model.pth'  # ä¿å­˜çš„å‚æ•°æ–‡ä»¶å
torch.save(best_model.state_dict(), PATH)
print('Done')

#lossä¸accuracyå›¾
import matplotlib.pyplot as plt
#éšè—è­¦å‘Š
import warnings
warnings.filterwarnings("ignore")               #å¿½ç•¥è­¦å‘Šä¿¡æ¯
plt.rcParams['font.sans-serif']    = ['SimHei'] # ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºä¸­æ–‡æ ‡ç­¾
plt.rcParams['axes.unicode_minus'] = False      # ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºè´Ÿå·
plt.rcParams['figure.dpi']         = 100        #åˆ†è¾¨ç‡

from datetime import datetime
current_time = datetime.now() # è·å–å½“å‰æ—¶é—´

epochs_range = range(epochs)

plt.figure(figsize=(12, 3))
plt.subplot(1, 2, 1)

plt.plot(epochs_range, train_acc, label='Training Accuracy')
plt.plot(epochs_range, test_acc, label='Test Accuracy')
plt.legend(loc='lower right')
plt.title('Training and Validation Accuracy')
plt.xlabel(current_time) # æ‰“å¡è¯·å¸¦ä¸Šæ—¶é—´æˆ³ï¼Œå¦åˆ™ä»£ç æˆªå›¾æ— æ•ˆ

plt.subplot(1, 2, 2)
plt.plot(epochs_range, train_loss, label='Training Loss')
plt.plot(epochs_range, test_loss, label='Test Loss')
plt.legend(loc='upper right')
plt.title('Training and Validation Loss')
plt.show()
# æ¨¡å‹è¯„ä¼°
best_model.eval()
epoch_test_acc, epoch_test_loss = test(test_dl, best_model, loss_fn)
print(epoch_test_acc,epoch_test_loss)

</code></pre>
    <h2>
     <a id="_295">
     </a>
     ä¸‰ã€ç»“æœ
    </h2>
    <p>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/2df4419f27c64b1ca565d4859c53e090.png">
      <br/>
      <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/7d3778997eac4431b5e5e8ac7b1718b3.png">
       <br/>
       <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/f774f7fdb506429b853fc1c9d487fa2b.png">
        <br/>
        <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/9cfe5af8f8ee4919a01ced3035818692.png"/>
       </img>
      </img>
     </img>
    </p>
    <p>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/21c51e61607a42fba85087eac9f9382e.png"/>
    </p>
    <h2>
     <a id="_303">
     </a>
     å››ã€æ€»ç»“
    </h2>
    <h3>
     <a id="_304">
     </a>
     æ¨¡å‹ç»“æ„
    </h3>
    <p>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/91bc3b55475941fda0894db672523ec0.png">
      <br/>
      <strong>
       æé—®
      </strong>
      ï¼šæ˜¯å¦å¯ä»¥è°ƒæ•´C3å’ŒConvå—æ¥æé«˜å‡†ç¡®ç‡ï¼Ÿ
     </img>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f617077706173792f:61727469636c652f64657461696c732f313436303936313338" class_="artid" style="display:none">
 </p>
</div>


