---
arturl_encode: "6874747073:3a2f2f626c6f672e6373646e2e6e65742f617077706173792f:61727469636c652f64657461696c732f313436303936313338"
layout: post
title: "P8ä½¿ç”¨pytorchå®ç°YOLOv5-C3æ¨¡å—"
date: 2025-03-07 17:28:28 +0800
description: "æœ¬å‘¨å…ˆç”¨pytorchæ¥å®ç°YOLOv5-C3çš„æ¨¡å—ï¼Œæå‰ç†Ÿæ‚‰ä¸€ä¸‹YOLOï¼Œè™½ç„¶YOLOå„è·¯å¤§ç¥ç‰ˆæœ¬å¾ˆå¤šï¼Œä½†æ˜¯V5å¾ˆç¨³å®šï¼Œè¿˜æ˜¯å¾ˆæœ‰å¿…è¦å­¦ä¹ å­¦ä¹ çš„ã€‚ä»»åŠ¡æ˜¯å¤©æ°”åˆ†ç±»ã€‚æé—®ï¼šæ˜¯å¦å¯ä»¥è°ƒæ•´C3å’ŒConvå—æ¥æé«˜å‡†ç¡®ç‡ï¼Ÿ"
keywords: "P8ï¼šä½¿ç”¨pytorchå®ç°YOLOv5-C3æ¨¡å—"
categories: ['æ·±åº¦å­¦ä¹ ']
tags: ['äººå·¥æ™ºèƒ½', 'Yolo', 'Pytorch']
artid: "146096138"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146096138
    alt: "P8ä½¿ç”¨pytorchå®ç°YOLOv5-C3æ¨¡å—"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146096138
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146096138
cover: https://bing.ee123.net/img/rand?artid=146096138
image: https://bing.ee123.net/img/rand?artid=146096138
img: https://bing.ee123.net/img/rand?artid=146096138
---

# P8ï¼šä½¿ç”¨pytorchå®ç°YOLOv5-C3æ¨¡å—
\* \*\*ğŸ¨ æœ¬æ–‡ä¸º
[ğŸ”—365å¤©æ·±åº¦å­¦ä¹ è®­ç»ƒè¥](https://mp.weixin.qq.com/s/kV8ZsJv6cPNzJLEuhPfvXg)
ä¸­çš„å­¦ä¹ è®°å½•åšå®¢\*\*
\* \*\*ğŸ– åŸä½œè€…ï¼š
[KåŒå­¦å•Š](https://mtyjkh.blog.csdn.net/)\*\*
\*\*æˆ‘çš„ç¯å¢ƒ\*\*
è¯­è¨€ç¯å¢ƒï¼špython 3.7.12
ç¼–è¯‘å™¨ï¼špycharm
æ·±åº¦å­¦ä¹ ç¯å¢ƒï¼štensorflow 2.7.0
æ•°æ®ï¼šå¤©æ°”æœ¬åœ°æ•°æ®é›†
## ä¸€ã€å‰è¨€
æœ¬å‘¨å…ˆç”¨pytorchæ¥å®ç°YOLOv5-C3çš„æ¨¡å—ï¼Œæå‰ç†Ÿæ‚‰ä¸€ä¸‹YOLOï¼Œè™½ç„¶YOLOå„è·¯å¤§ç¥ç‰ˆæœ¬å¾ˆå¤šï¼Œä½†æ˜¯V5å¾ˆç¨³å®šï¼Œè¿˜æ˜¯å¾ˆæœ‰å¿…è¦å­¦ä¹ å­¦ä¹ çš„ã€‚ä»»åŠ¡æ˜¯å¤©æ°”åˆ†ç±»ã€‚
## äºŒã€ä»£ç 
```
# ç¬¬P8å‘¨ï¼šYOLOv5-C3æ¨¡å—å®ç°
# è®¾ç½®è®¾å¤‡
import torch
import torch.nn as nn
import torchvision.transforms as transforms
import torchvision
from torchvision import transforms, datasets
import os,PIL,pathlib,warnings
warnings.filterwarnings("ignore") #å¿½ç•¥è­¦å‘Šä¿¡æ¯
device = torch.device("cuda" if torch.cuda.is\_available() else "cpu")
device
# å¯¼å…¥æ•°æ®
import os,PIL,random,pathlib
data\_dir1 = './weather-data/'
data\_dir = pathlib.Path(data\_dir1)
data\_paths = list(data\_dir.glob('\*'))
classeNames = [str(path).split("/")[1] for path in data\_paths]
print(classeNames)
# å…³äºtransforms.Composeçš„æ›´å¤šä»‹ç»å¯ä»¥å‚è€ƒï¼šhttps://blog.csdn.net/qq\_38251616/article/details/124878863
train\_transforms = transforms.Compose([
transforms.Resize([224, 224]), # å°†è¾“å…¥å›¾ç‰‡resizeæˆç»Ÿä¸€å°ºå¯¸
# transforms.RandomHorizontalFlip(), # éšæœºæ°´å¹³ç¿»è½¬
transforms.ToTensor(), # å°†PIL Imageæˆ–numpy.ndarrayè½¬æ¢ä¸ºtensorï¼Œå¹¶å½’ä¸€åŒ–åˆ°[0,1]ä¹‹é—´
transforms.Normalize( # æ ‡å‡†åŒ–å¤„ç†-->è½¬æ¢ä¸ºæ ‡å‡†æ­£å¤ªåˆ†å¸ƒï¼ˆé«˜æ–¯åˆ†å¸ƒï¼‰ï¼Œä½¿æ¨¡å‹æ›´å®¹æ˜“æ”¶æ•›
mean=[0.485, 0.456, 0.406],
std=[0.229, 0.224, 0.225]) # å…¶ä¸­ mean=[0.485,0.456,0.406]ä¸std=[0.229,0.224,0.225] ä»æ•°æ®é›†ä¸­éšæœºæŠ½æ ·è®¡ç®—å¾—åˆ°çš„ã€‚
])
test\_transform = transforms.Compose([
transforms.Resize([224, 224]), # å°†è¾“å…¥å›¾ç‰‡resizeæˆç»Ÿä¸€å°ºå¯¸
transforms.ToTensor(), # å°†PIL Imageæˆ–numpy.ndarrayè½¬æ¢ä¸ºtensorï¼Œå¹¶å½’ä¸€åŒ–åˆ°[0,1]ä¹‹é—´
transforms.Normalize( # æ ‡å‡†åŒ–å¤„ç†-->è½¬æ¢ä¸ºæ ‡å‡†æ­£å¤ªåˆ†å¸ƒï¼ˆé«˜æ–¯åˆ†å¸ƒï¼‰ï¼Œä½¿æ¨¡å‹æ›´å®¹æ˜“æ”¶æ•›
mean=[0.485, 0.456, 0.406],
std=[0.229, 0.224, 0.225]) # å…¶ä¸­ mean=[0.485,0.456,0.406]ä¸std=[0.229,0.224,0.225] ä»æ•°æ®é›†ä¸­éšæœºæŠ½æ ·è®¡ç®—å¾—åˆ°çš„ã€‚
])
total\_data = datasets.ImageFolder(data\_dir1,transform=train\_transforms)
print(total\_data)
print(total\_data.class\_to\_idx)
# åˆ’åˆ†æ•°æ®é›†
train\_size = int(0.8 \* len(total\_data))
test\_size = len(total\_data) - train\_size
train\_dataset, test\_dataset = torch.utils.data.random\_split(total\_data, [train\_size, test\_size])
print(train\_dataset, test\_dataset)
batch\_size = 4
train\_dl = torch.utils.data.DataLoader(train\_dataset,
batch\_size=batch\_size,
shuffle=True,
num\_workers=1)
test\_dl = torch.utils.data.DataLoader(test\_dataset,
batch\_size=batch\_size,
shuffle=True,
num\_workers=1)
for X, y in test\_dl:
print("Shape of X [N, C, H, W]: ", X.shape)
print("Shape of y: ", y.shape, y.dtype)
break
# æ­å»ºåŒ…å«C3æ¨¡å—çš„æ¨¡å‹
import torch.nn.functional as F
def autopad(k, p=None): # kernel, padding
# Pad to 'same'
if p is None:
p = k // 2 if isinstance(k, int) else [x // 2 for x in k] # auto-pad
return p
class Conv(nn.Module):
# Standard convolution
def \_\_init\_\_(self, c1, c2, k=1, s=1, p=None, g=1, act=True): # ch\_in, ch\_out, kernel, stride, padding, groups
super().\_\_init\_\_()
self.conv = nn.Conv2d(c1, c2, k, s, autopad(k, p), groups=g, bias=False)
self.bn = nn.BatchNorm2d(c2)
self.act = nn.SiLU() if act is True else (act if isinstance(act, nn.Module) else nn.Identity())
def forward(self, x):
return self.act(self.bn(self.conv(x)))
class Bottleneck(nn.Module):
# Standard bottleneck
def \_\_init\_\_(self, c1, c2, shortcut=True, g=1, e=0.5): # ch\_in, ch\_out, shortcut, groups, expansion
super().\_\_init\_\_()
c\_ = int(c2 \* e) # hidden channels
self.cv1 = Conv(c1, c\_, 1, 1)
self.cv2 = Conv(c\_, c2, 3, 1, g=g)
self.add = shortcut and c1 == c2
def forward(self, x):
return x + self.cv2(self.cv1(x)) if self.add else self.cv2(self.cv1(x))
class C3(nn.Module):
# CSP Bottleneck with 3 convolutions
def \_\_init\_\_(self, c1, c2, n=1, shortcut=True, g=1, e=0.5): # ch\_in, ch\_out, number, shortcut, groups, expansion
super().\_\_init\_\_()
c\_ = int(c2 \* e) # hidden channels
self.cv1 = Conv(c1, c\_, 1, 1)
self.cv2 = Conv(c1, c\_, 1, 1)
self.cv3 = Conv(2 \* c\_, c2, 1) # act=FReLU(c2)
self.m = nn.Sequential(\*(Bottleneck(c\_, c\_, shortcut, g, e=1.0) for \_ in range(n)))
def forward(self, x):
return self.cv3(torch.cat((self.m(self.cv1(x)), self.cv2(x)), dim=1))
class model\_K(nn.Module):
def \_\_init\_\_(self):
super(model\_K, self).\_\_init\_\_()
# å·ç§¯æ¨¡å—
self.Conv = Conv(3, 32, 3, 2)
# C3æ¨¡å—1
self.C3\_1 = C3(32, 64, 3, 2)
# å…¨è¿æ¥ç½‘ç»œå±‚ï¼Œç”¨äºåˆ†ç±»
self.classifier = nn.Sequential(
nn.Linear(in\_features=802816, out\_features=100),
nn.ReLU(),
nn.Linear(in\_features=100, out\_features=4)
)
def forward(self, x):
x = self.Conv(x)
x = self.C3\_1(x)
x = torch.flatten(x, start\_dim=1)
x = self.classifier(x)
return x
device = "cuda" if torch.cuda.is\_available() else "cpu"
print("Using {} device".format(device))
model = model\_K().to(device)
print(model)
# ç»Ÿè®¡æ¨¡å‹å‚æ•°é‡ä»¥åŠå…¶ä»–æŒ‡æ ‡
import torchsummary as summary
summary.summary(model, (3, 224, 224))
# è®­ç»ƒå‡½æ•°
# è®­ç»ƒå¾ªç¯
def train(dataloader, model, loss\_fn, optimizer):
size = len(dataloader.dataset) # è®­ç»ƒé›†çš„å¤§å°
num\_batches = len(dataloader) # æ‰¹æ¬¡æ•°ç›®, (size/batch\_sizeï¼Œå‘ä¸Šå–æ•´)
train\_loss, train\_acc = 0, 0 # åˆå§‹åŒ–è®­ç»ƒæŸå¤±å’Œæ­£ç¡®ç‡
for X, y in dataloader: # è·å–å›¾ç‰‡åŠå…¶æ ‡ç­¾
X, y = X.to(device), y.to(device)
# è®¡ç®—é¢„æµ‹è¯¯å·®
pred = model(X) # ç½‘ç»œè¾“å‡º
loss = loss\_fn(pred, y) # è®¡ç®—ç½‘ç»œè¾“å‡ºå’ŒçœŸå®å€¼ä¹‹é—´çš„å·®è·ï¼Œtargetsä¸ºçœŸå®å€¼ï¼Œè®¡ç®—äºŒè€…å·®å€¼å³ä¸ºæŸå¤±
# åå‘ä¼ æ’­
optimizer.zero\_grad() # gradå±æ€§å½’é›¶
loss.backward() # åå‘ä¼ æ’­
optimizer.step() # æ¯ä¸€æ­¥è‡ªåŠ¨æ›´æ–°
# è®°å½•accä¸loss
train\_acc += (pred.argmax(1) == y).type(torch.float).sum().item()
train\_loss += loss.item()
train\_acc /= size
train\_loss /= num\_batches
return train\_acc, train\_loss
# æµ‹è¯•å‡½æ•°
def test(dataloader, model, loss\_fn):
size = len(dataloader.dataset) # æµ‹è¯•é›†çš„å¤§å°
num\_batches = len(dataloader) # æ‰¹æ¬¡æ•°ç›®, (size/batch\_sizeï¼Œå‘ä¸Šå–æ•´)
test\_loss, test\_acc = 0, 0
# å½“ä¸è¿›è¡Œè®­ç»ƒæ—¶ï¼Œåœæ­¢æ¢¯åº¦æ›´æ–°ï¼ŒèŠ‚çœè®¡ç®—å†…å­˜æ¶ˆè€—
with torch.no\_grad():
for imgs, target in dataloader:
imgs, target = imgs.to(device), target.to(device)
# è®¡ç®—loss
target\_pred = model(imgs)
loss = loss\_fn(target\_pred, target)
test\_loss += loss.item()
test\_acc += (target\_pred.argmax(1) == target).type(torch.float).sum().item()
test\_acc /= size
test\_loss /= num\_batches
return test\_acc, test\_loss
# æ­£å¼è®­ç»ƒ
import copy
optimizer = torch.optim.Adam(model.parameters(), lr=1e-4)
loss\_fn = nn.CrossEntropyLoss() # åˆ›å»ºæŸå¤±å‡½æ•°
epochs = 20
train\_loss = []
train\_acc = []
test\_loss = []
test\_acc = []
best\_acc = 0 # è®¾ç½®ä¸€ä¸ªæœ€ä½³å‡†ç¡®ç‡ï¼Œä½œä¸ºæœ€ä½³æ¨¡å‹çš„åˆ¤åˆ«æŒ‡æ ‡
for epoch in range(epochs):
model.train()
epoch\_train\_acc, epoch\_train\_loss = train(train\_dl, model, loss\_fn, optimizer)
model.eval()
epoch\_test\_acc, epoch\_test\_loss = test(test\_dl, model, loss\_fn)
# ä¿å­˜æœ€ä½³æ¨¡å‹åˆ° best\_model
if epoch\_test\_acc > best\_acc:
best\_acc = epoch\_test\_acc
best\_model = copy.deepcopy(model)
train\_acc.append(epoch\_train\_acc)
train\_loss.append(epoch\_train\_loss)
test\_acc.append(epoch\_test\_acc)
test\_loss.append(epoch\_test\_loss)
# è·å–å½“å‰çš„å­¦ä¹ ç‡
lr = optimizer.state\_dict()['param\_groups'][0]['lr']
template = ('Epoch:{:2d}, Train\_acc:{:.1f}%, Train\_loss:{:.3f}, Test\_acc:{:.1f}%, Test\_loss:{:.3f}, Lr:{:.2E}')
print(template.format(epoch + 1, epoch\_train\_acc \* 100, epoch\_train\_loss,
epoch\_test\_acc \* 100, epoch\_test\_loss, lr))
# ä¿å­˜æœ€ä½³æ¨¡å‹åˆ°æ–‡ä»¶ä¸­
PATH = './best\_model.pth' # ä¿å­˜çš„å‚æ•°æ–‡ä»¶å
torch.save(best\_model.state\_dict(), PATH)
print('Done')
#lossä¸accuracyå›¾
import matplotlib.pyplot as plt
#éšè—è­¦å‘Š
import warnings
warnings.filterwarnings("ignore") #å¿½ç•¥è­¦å‘Šä¿¡æ¯
plt.rcParams['font.sans-serif'] = ['SimHei'] # ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºä¸­æ–‡æ ‡ç­¾
plt.rcParams['axes.unicode\_minus'] = False # ç”¨æ¥æ­£å¸¸æ˜¾ç¤ºè´Ÿå·
plt.rcParams['figure.dpi'] = 100 #åˆ†è¾¨ç‡
from datetime import datetime
current\_time = datetime.now() # è·å–å½“å‰æ—¶é—´
epochs\_range = range(epochs)
plt.figure(figsize=(12, 3))
plt.subplot(1, 2, 1)
plt.plot(epochs\_range, train\_acc, label='Training Accuracy')
plt.plot(epochs\_range, test\_acc, label='Test Accuracy')
plt.legend(loc='lower right')
plt.title('Training and Validation Accuracy')
plt.xlabel(current\_time) # æ‰“å¡è¯·å¸¦ä¸Šæ—¶é—´æˆ³ï¼Œå¦åˆ™ä»£ç æˆªå›¾æ— æ•ˆ
plt.subplot(1, 2, 2)
plt.plot(epochs\_range, train\_loss, label='Training Loss')
plt.plot(epochs\_range, test\_loss, label='Test Loss')
plt.legend(loc='upper right')
plt.title('Training and Validation Loss')
plt.show()
# æ¨¡å‹è¯„ä¼°
best\_model.eval()
epoch\_test\_acc, epoch\_test\_loss = test(test\_dl, best\_model, loss\_fn)
print(epoch\_test\_acc,epoch\_test\_loss)
```
## ä¸‰ã€ç»“æœ
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/2df4419f27c64b1ca565d4859c53e090.png)
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/7d3778997eac4431b5e5e8ac7b1718b3.png)
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/f774f7fdb506429b853fc1c9d487fa2b.png)
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/9cfe5af8f8ee4919a01ced3035818692.png)
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/21c51e61607a42fba85087eac9f9382e.png)
## å››ã€æ€»ç»“
### æ¨¡å‹ç»“æ„
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/91bc3b55475941fda0894db672523ec0.png)
\*\*æé—®\*\*
ï¼šæ˜¯å¦å¯ä»¥è°ƒæ•´C3å’ŒConvå—æ¥æé«˜å‡†ç¡®ç‡ï¼Ÿ