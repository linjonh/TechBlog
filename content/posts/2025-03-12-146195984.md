---
layout: post
title: "C设计模式第二十二篇访问者模式Visitor"
date: 2025-03-12 09:24:37 +0800
description: "数据结构与操作的解耦之道"
keywords: "​【C++设计模式】第二十二篇：访问者模式（Visitor）"
categories: ['C']
tags: ['访问者模式', '设计模式', 'C']
artid: "146195984"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146195984
    alt: "C设计模式第二十二篇访问者模式Visitor"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146195984
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146195984
cover: https://bing.ee123.net/img/rand?artid=146195984
image: https://bing.ee123.net/img/rand?artid=146195984
img: https://bing.ee123.net/img/rand?artid=146195984
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ​【C++设计模式】第二十二篇：访问者模式（Visitor）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <code>
      注意：复现代码时，确保 VS2022 使用 C++17/20 标准以支持现代特性。
     </code>
    </p>
    <h3>
     <a id="_2">
     </a>
     数据结构与操作的解耦之道
    </h3>
    <hr/>
    <h3>
     <a id="1__4">
     </a>
     1. 模式定义与用途
    </h3>
    <h4>
     <a id="_5">
     </a>
     核心思想
    </h4>
    <ul>
     <li>
      ​
      <strong>
       访问者模式
      </strong>
      ：将
      <strong>
       数据结构的操作
      </strong>
      与
      <strong>
       数据结构本身
      </strong>
      分离，通过访问者对象实现操作逻辑，支持在不修改类的前提下添加新功能。
     </li>
     <li>
      ​
      <strong>
       关键用途
      </strong>
      ：
      <br/>
      ​1.
      <strong>
       动态扩展功能
      </strong>
      ：新增操作无需修改原有类（如导出、序列化、统计）。
      <br/>
      ​2.
      <strong>
       解耦数据结构与操作
      </strong>
      ：将分散的操作集中到访问者类中。
      <br/>
      ​3.
      <strong>
       支持复杂对象结构
      </strong>
      ：适用于树形、图形等嵌套结构的统一处理。
     </li>
    </ul>
    <h4>
     <a id="_11">
     </a>
     经典场景
    </h4>
    <ul>
     <li>
      抽象语法树（AST）遍历（类型检查、代码生成）。
     </li>
     <li>
      文档导出（HTML、PDF、纯文本）。
     </li>
     <li>
      UI组件渲染（不同平台绘制逻辑）。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="2__16">
     </a>
     2. 模式结构解析
    </h3>
    <h4>
     <a id="UML_17">
     </a>
     UML类图
    </h4>
    <pre><code class="prism language-plaintext">+---------------------+          +---------------------+  
|       Element       |          |       Visitor       |  
+---------------------+          +---------------------+  
| + accept(v: Visitor)|&lt;|--------| + visit(e: ElementA)|  
+---------------------+          | + visit(e: ElementB)|  
          ^                      +---------------------+  
          |                                ^  
  +-------+-------+              +---------+---------+  
  |               |              |                   |  
+---------------------+    +----------------+ +----------------+  
|    ElementA        |    |  ConcreteVisitor | |     Client     |  
+---------------------+    +----------------+ +----------------+  
| + accept(v: Visitor)|    | + visit()      | | 调用访问者处理元素 |  
+---------------------+    +----------------+ +----------------+  
</code></pre>
    <h4>
     <a id="_34">
     </a>
     角色说明
    </h4>
    <ol>
     <li>
      <code>
       Element
      </code>
      ：元素接口，定义
      <code>
       accept
      </code>
      方法接收访问者。
     </li>
     <li>
      <code>
       ​ConcreteElement
      </code>
      ：具体元素类（如
      <code>
       ElementA
      </code>
      、
      <code>
       ElementB
      </code>
      ），实现
      <code>
       accept
      </code>
      方法。
     </li>
     <li>
      <code>
       Visitor
      </code>
      ：访问者接口，为每个元素类声明
      <code>
       visit
      </code>
      方法。
     </li>
     <li>
      <code>
       ConcreteVisitor
      </code>
      ：具体访问者，实现各元素的处理逻辑。
     </li>
     <li>
      <code>
       Client
      </code>
      ：创建访问者并触发元素对访问者的接受。
     </li>
    </ol>
    <hr/>
    <h3>
     <a id="3_C_41">
     </a>
     3. 现代C++实现示例
    </h3>
    <h4>
     <a id="_42">
     </a>
     场景：文档导出系统
    </h4>
    <h5>
     <a id="1_43">
     </a>
     ​步骤1：定义元素与访问者接口
    </h5>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span>  </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span>  </span>

<span class="token comment">// 前向声明  </span>
<span class="token keyword">class</span> <span class="token class-name">TextElement</span><span class="token punctuation">;</span>  
<span class="token keyword">class</span> <span class="token class-name">ImageElement</span><span class="token punctuation">;</span>  

<span class="token comment">// 访问者接口  </span>
<span class="token keyword">class</span> <span class="token class-name">DocumentVisitor</span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">public</span><span class="token operator">:</span>  
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">DocumentVisitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>  
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">const</span> TextElement<span class="token operator">&amp;</span> text<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">const</span> ImageElement<span class="token operator">&amp;</span> image<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  

<span class="token comment">// 元素接口  </span>
<span class="token keyword">class</span> <span class="token class-name">DocumentElement</span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">public</span><span class="token operator">:</span>  
    <span class="token keyword">virtual</span> <span class="token operator">~</span><span class="token function">DocumentElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>  
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>DocumentVisitor<span class="token operator">&amp;</span> visitor<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
    <h5>
     <a id="2_69">
     </a>
     步骤2：实现具体元素类
    </h5>
    <pre><code class="prism language-cpp"><span class="token comment">// 文本元素  </span>
<span class="token keyword">class</span> <span class="token class-name">TextElement</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">DocumentElement</span></span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">public</span><span class="token operator">:</span>  
    <span class="token function">TextElement</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> content<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">content_</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>  

    <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>DocumentVisitor<span class="token operator">&amp;</span> visitor<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>  
        visitor<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> <span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> content_<span class="token punctuation">;</span> <span class="token punctuation">}</span>  

<span class="token keyword">private</span><span class="token operator">:</span>  
    std<span class="token double-colon punctuation">::</span>string content_<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  

<span class="token comment">// 图片元素  </span>
<span class="token keyword">class</span> <span class="token class-name">ImageElement</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">DocumentElement</span></span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">public</span><span class="token operator">:</span>  
    <span class="token function">ImageElement</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> path<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">path_</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>  

    <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>DocumentVisitor<span class="token operator">&amp;</span> visitor<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>  
        visitor<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> <span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> path_<span class="token punctuation">;</span> <span class="token punctuation">}</span>  

<span class="token keyword">private</span><span class="token operator">:</span>  
    std<span class="token double-colon punctuation">::</span>string path_<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
    <h5>
     <a id="3_102">
     </a>
     步骤3：实现具体访问者（导出逻辑）​
    </h5>
    <pre><code class="prism language-cpp"><span class="token comment">// HTML导出访问者  </span>
<span class="token keyword">class</span> <span class="token class-name">HtmlExporter</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">DocumentVisitor</span></span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">public</span><span class="token operator">:</span>  
    <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">const</span> TextElement<span class="token operator">&amp;</span> text<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>  
        html_ <span class="token operator">+=</span> <span class="token string">"&lt;p&gt;"</span> <span class="token operator">+</span> text<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"&lt;/p&gt;\n"</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">const</span> ImageElement<span class="token operator">&amp;</span> image<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>  
        html_ <span class="token operator">+=</span> <span class="token string">"&lt;img src=\""</span> <span class="token operator">+</span> image<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\" /&gt;\n"</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    std<span class="token double-colon punctuation">::</span>string <span class="token function">getHtml</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> html_<span class="token punctuation">;</span> <span class="token punctuation">}</span>  

<span class="token keyword">private</span><span class="token operator">:</span>  
    std<span class="token double-colon punctuation">::</span>string html_<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  

<span class="token comment">// 纯文本导出访问者  </span>
<span class="token keyword">class</span> <span class="token class-name">TextExporter</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">DocumentVisitor</span></span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">public</span><span class="token operator">:</span>  
    <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">const</span> TextElement<span class="token operator">&amp;</span> text<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>  
        text_ <span class="token operator">+=</span> text<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">const</span> ImageElement<span class="token operator">&amp;</span> image<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span>  
        text_ <span class="token operator">+=</span> <span class="token string">"[图片: "</span> <span class="token operator">+</span> image<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]\n"</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  

    std<span class="token double-colon punctuation">::</span>string <span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> text_<span class="token punctuation">;</span> <span class="token punctuation">}</span>  

<span class="token keyword">private</span><span class="token operator">:</span>  
    std<span class="token double-colon punctuation">::</span>string text_<span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
    <h5>
     <a id="4_139">
     </a>
     步骤4：客户端代码
    </h5>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">// 创建文档元素  </span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>DocumentElement<span class="token operator">&gt;&gt;</span> doc<span class="token punctuation">;</span>  
    doc<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>TextElement<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"欢迎访问！"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    doc<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>ImageElement<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"photo.jpg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  

    <span class="token comment">// 导出为HTML  </span>
    HtmlExporter htmlExporter<span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> elem <span class="token operator">:</span> doc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        elem<span class="token operator">-&gt;</span><span class="token function">accept</span><span class="token punctuation">(</span>htmlExporter<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"HTML导出结果:\n"</span> <span class="token operator">&lt;&lt;</span> htmlExporter<span class="token punctuation">.</span><span class="token function">getHtml</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>  

    <span class="token comment">// 导出为纯文本  </span>
    TextExporter textExporter<span class="token punctuation">;</span>  
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> elem <span class="token operator">:</span> doc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        elem<span class="token operator">-&gt;</span><span class="token function">accept</span><span class="token punctuation">(</span>textExporter<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"文本导出结果:\n"</span> <span class="token operator">&lt;&lt;</span> textExporter<span class="token punctuation">.</span><span class="token function">getText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span>  

<span class="token comment">/* 输出：  
HTML导出结果:  
&lt;p&gt;欢迎访问！&lt;/p&gt;  
&lt;img src="photo.jpg" /&gt;  

文本导出结果:  
欢迎访问！  
[图片: photo.jpg]  
*/</span>  
</code></pre>
    <hr/>
    <h3>
     <a id="4__174">
     </a>
     4. 应用场景示例
    </h3>
    <h4>
     <a id="1_175">
     </a>
     场景1：编译器符号表检查
    </h4>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">VariableNode</span><span class="token punctuation">;</span>  
<span class="token keyword">class</span> <span class="token class-name">FunctionNode</span><span class="token punctuation">;</span>  

<span class="token keyword">class</span> <span class="token class-name">SymbolTableVisitor</span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">public</span><span class="token operator">:</span>  
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">const</span> VariableNode<span class="token operator">&amp;</span> var<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionNode<span class="token operator">&amp;</span> func<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  

<span class="token keyword">class</span> <span class="token class-name">VariableNode</span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">public</span><span class="token operator">:</span>  
    <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>SymbolTableVisitor<span class="token operator">&amp;</span> visitor<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> visitor<span class="token punctuation">.</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  

<span class="token keyword">class</span> <span class="token class-name">TypeChecker</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">SymbolTableVisitor</span></span> <span class="token punctuation">{<!-- --></span>  
    <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">const</span> VariableNode<span class="token operator">&amp;</span> var<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* 类型检查逻辑 */</span> <span class="token punctuation">}</span>  
    <span class="token keyword">void</span> <span class="token function">visit</span><span class="token punctuation">(</span><span class="token keyword">const</span> FunctionNode<span class="token operator">&amp;</span> func<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* 类型检查逻辑 */</span> <span class="token punctuation">}</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
    <h4>
     <a id="23D_197">
     </a>
     场景2：3D模型渲染器
    </h4>
    <pre><code class="prism language-cpp"><span class="token keyword">class</span> <span class="token class-name">Mesh</span><span class="token punctuation">;</span>  
<span class="token keyword">class</span> <span class="token class-name">Light</span><span class="token punctuation">;</span>  

<span class="token keyword">class</span> <span class="token class-name">RenderVisitor</span> <span class="token punctuation">{<!-- --></span>  
<span class="token keyword">public</span><span class="token operator">:</span>  
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token keyword">const</span> Mesh<span class="token operator">&amp;</span> mesh<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token keyword">const</span> Light<span class="token operator">&amp;</span> light<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  

<span class="token keyword">class</span> <span class="token class-name">OpenGLRenderer</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">RenderVisitor</span></span> <span class="token punctuation">{<!-- --></span>  
    <span class="token keyword">void</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token keyword">const</span> Mesh<span class="token operator">&amp;</span> mesh<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* OpenGL绘制网格 */</span> <span class="token punctuation">}</span>  
    <span class="token keyword">void</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token keyword">const</span> Light<span class="token operator">&amp;</span> light<span class="token punctuation">)</span> <span class="token keyword">override</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* OpenGL处理光照 */</span> <span class="token punctuation">}</span>  
<span class="token punctuation">}</span><span class="token punctuation">;</span>  
</code></pre>
    <hr/>
    <h3>
     <a id="5__215">
     </a>
     5. 优缺点分析
    </h3>
    <table>
     <thead>
      <tr>
       <th align="left">
        ​优点
       </th>
       <th align="left">
        ​缺点
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="left">
        新增操作无需修改元素类
       </td>
       <td align="left">
        新增元素类型需修改所有访问者接口
       </td>
      </tr>
      <tr>
       <td align="left">
        集中相关操作，提升内聚性
       </td>
       <td align="left">
        破坏封装性，访问者可能访问私有成员
       </td>
      </tr>
      <tr>
       <td align="left">
        支持复杂结构遍历（如树形结构）
       </td>
       <td align="left">
        增加系统复杂度，需维护访问者与元素关系
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h3>
     <a id="6__222">
     </a>
     6. 调试与优化策略
    </h3>
    <h4>
     <a id="VS2022_223">
     </a>
     调试技巧（VS2022）​
    </h4>
    <h5>
     <a id="1__224">
     </a>
     1. ​验证访问者分发逻辑：
    </h5>
    <ul>
     <li>
      在
      <code>
       accept()
      </code>
      方法内设置断点，确认元素正确调用访问者的
      <code>
       visit
      </code>
      方法。
     </li>
    </ul>
    <h5>
     <a id="2__226">
     </a>
     2. 类型安全检查：
    </h5>
    <ul>
     <li>
      使用
      <code>
       dynamic_cast
      </code>
      检查访问者是否处理了所有元素类型：
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span>DocumentVisitor<span class="token operator">&amp;</span> visitor<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span>  
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">*</span> v <span class="token operator">=</span> <span class="token generic-function"><span class="token function">dynamic_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>HtmlExporter<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>visitor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  
        v<span class="token operator">-&gt;</span><span class="token function">visit</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>  
        <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"不支持的访问者类型！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>  
<span class="token punctuation">}</span>  
</code></pre>
    <h4>
     <a id="_238">
     </a>
     性能优化
    </h4>
    <h5>
     <a id="1__239">
     </a>
     1. 访问者缓存：
    </h5>
    <ul>
     <li>
      对频繁使用的访问者（如渲染器）进行实例复用，避免重复创建。
     </li>
    </ul>
    <h5>
     <a id="2__241">
     </a>
     2. 并行访问：
    </h5>
    <ul>
     <li>
      对独立元素使用多线程处理（需确保访问者线程安全）：
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;execution&gt;</span>  </span>
std<span class="token double-colon punctuation">::</span><span class="token function">for_each</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>execution<span class="token double-colon punctuation">::</span>par<span class="token punctuation">,</span> doc<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> doc<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  
    <span class="token punctuation">[</span><span class="token operator">&amp;</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> elem<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> elem<span class="token operator">-&gt;</span><span class="token function">accept</span><span class="token punctuation">(</span>visitor<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e637364:6e2e6e65742f4a7569637941637469766547696c626572742f:61727469636c652f64657461696c732f313436313935393834" class_="artid" style="display:none">
 </p>
</div>


