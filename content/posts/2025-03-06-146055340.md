---
layout: post
title: "GoTeams-1项目基础搭建"
date: 2025-03-06 15:47:17 +0800
description: "GoTeams：项目协同管理实战1-基础搭建（上）"
keywords: "【GoTeams】-1：项目基础搭建"
categories: ['Goteams']
tags: ['Goteams', 'Gin']
artid: "146055340"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146055340
    alt: "GoTeams-1项目基础搭建"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146055340
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146055340
cover: https://bing.ee123.net/img/rand?artid=146055340
image: https://bing.ee123.net/img/rand?artid=146055340
img: https://bing.ee123.net/img/rand?artid=146055340
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【GoTeams】-1：项目基础搭建
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e6374f0612eb4287ae09798285a4e014.png">
      <br/>
     </img>
    </p>
    <p>
    </p>
    <h2>
     <a id="1__4">
     </a>
     1. 工作环境准备
    </h2>
    <p>
     在
     <code>
      GoProject
     </code>
     路径下创建work工作区，依次输入以下命令完成工作目录的构建。
    </p>
    <pre><code class="prism language-go">mkdir msproject
<span class="token keyword">go</span> work init
mkdir project<span class="token operator">-</span>user
cd project<span class="token operator">-</span>user
<span class="token keyword">go</span> mod init test<span class="token punctuation">.</span>com<span class="token operator">/</span>project<span class="token operator">-</span>user
cd <span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">go</span> work use <span class="token punctuation">.</span><span class="token operator">/</span>project<span class="token operator">-</span>user
</code></pre>
    <p>
     在路径下安装gin框架。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">go</span> get <span class="token operator">-</span>u github<span class="token punctuation">.</span>com<span class="token operator">/</span>gin<span class="token operator">-</span>gonic<span class="token operator">/</span>gin
</code></pre>
    <h2>
     <a id="2__25">
     </a>
     2. 优雅启停
    </h2>
    <p>
     在
     <code>
      main.go
     </code>
     中创建优雅启停的代码，如下所示。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"github.com/gin-gonic/gin"</span>
	<span class="token string">"log"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"os"</span>
	<span class="token string">"os/signal"</span>
	<span class="token string">"syscall"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	r <span class="token operator">:=</span> gin<span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	srv <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{<!-- --></span>
		Addr<span class="token punctuation">:</span>    <span class="token string">":80"</span><span class="token punctuation">,</span>
		Handler<span class="token punctuation">:</span> r<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"web server running is %s \n"</span><span class="token punctuation">,</span> srv<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> http<span class="token punctuation">.</span>ErrServerClosed <span class="token punctuation">{<!-- --></span>
			log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
	signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>quit

	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"shutting down project web server..."</span><span class="token punctuation">)</span>

	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span><span class="token string">"web server shutdown,cause by:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"关闭超时"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"web server stop success..."</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     下面来说明每个代码模块的作用：
    </p>
    <pre><code class="prism language-go">	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"web server running is %s \n"</span><span class="token punctuation">,</span> srv<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> http<span class="token punctuation">.</span>ErrServerClosed <span class="token punctuation">{<!-- --></span>
			log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     启动一个 HTTP Web 服务器，并在后台以独立的协程运行。调用
     <code>
      srv.ListenAndServe()
     </code>
     方法，启动服务器并开始监听客户端请求。如果在启动过程中发生错误，并且该错误不是因为服务器被正常关闭（即错误不是
     <code>
      http.ErrServerClosed
     </code>
     ），则会通过
     <code>
      log.Fatalln
     </code>
     记录错误信息并终止程序运行。整个过程被封装在一个匿名函数中，并通过
     <code>
      go func()
     </code>
     的方式启动为一个独立的协程，这样可以避免阻塞主线程，从而让主线程可以继续执行其他任务，例如处理关闭信号等操作。
    </p>
    <pre><code class="prism language-go">	quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
	signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>quit
</code></pre>
    <p>
     <code>
      quit := make(chan os.Signal)
     </code>
     创建一个信号通道 quit，用于接收操作系统发送的信号。这个通道的类型是
     <code>
      os.Signal
     </code>
     ，专门用于传递
     <code>
      信号事件
     </code>
     。
    </p>
    <p>
     <code>
      signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)
     </code>
     使用
     <code>
      signal.Notify
     </code>
     函数将
     <code>
      通道 quit
     </code>
     注册到信号监听中，指定监听的信号类型为
     <code>
      syscall.SIGINT
     </code>
     和
     <code>
      syscall.SIGTERM
     </code>
     。SIGINT 是用户通过键盘输入（如 Ctrl+C）发送的中断信号，通常用于请求程序终止。SIGTERM 是一个更通用的终止信号，通常由系统或进程管理工具发送，用于请求程序优雅地关闭。当程序接收到这些信号中的任何一个时，操作系统会将信号发送到 quit 通道。
    </p>
    <p>
     这是一个
     <code>
      阻塞操作
     </code>
     ，表示从 quit 通道中接收信号。程序会在这里暂停执行，
     <code>
      直到通道中接收到一个信号（即程序接收到 SIGINT 或 SIGTERM）
     </code>
     。
     <strong>
      一旦接收到信号，程序会继续执行后续的关闭逻辑
     </strong>
     。
    </p>
    <p>
     也就是说，当程序接收到用户或系统发送的中断或终止信号时，它不会直接退出，而是触发后续的清理操作（如关闭服务器、释放资源等），从而确保程序能够安全地关闭。
    </p>
    <pre><code class="prism language-go">ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     创建了一个带有超时限制的上下文 ctx，超时时间为 5 秒。
     <code>
      context.WithTimeout
     </code>
     函数基于
     <code>
      context.Background()
     </code>
     创建了一个新的上下文，并为其设置了超时时间。如果在 5 秒内没有完成关闭操作，上下文将被取消。
     <code>
      defer cancel()
     </code>
     确保在函数返回时调用
     <code>
      cancel() 函数
     </code>
     ，从而
     <code>
      释放与上下文相关的资源，避免资源泄漏
     </code>
     。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
	log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span><span class="token string">"web server shutdown, cause by:"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      Shutdown 方法
     </code>
     会等待所有正在处理的请求完成，然后关闭服务器。这里的上下文
     <code>
      ctx
     </code>
     用于
     <code>
      限制关闭操作的执行时间
     </code>
     。
    </p>
    <pre><code class="prism language-go">	<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"wait timeout..."</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
</code></pre>
    <p>
     回顾一下select语法，其 是 Go 语言中用于同时监听多个通道操作的语法结构。
     <code>
      select
     </code>
     语句会阻塞，直到其中一个 case 中的通道操作可以执行（即通道准备好发送或接收数据）。
    </p>
    <p>
     <code>
      ctx.Done()
     </code>
     是
     <code>
      context.Context
     </code>
     提供的一个通道，当上下文被取消（cancel() 被调用）或超时（如果设置了超时时间）时，该通道会被关闭。
    </p>
    <p>
     <code>
      &lt;-ctx.Done()
     </code>
     表示从
     <code>
      ctx.Done()
     </code>
     通道中接收数据。如果通道被关闭（即上下文被取消或超时），case 会被触发。
    </p>
    <p>
     运行代码，可以验证所写的功能。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/3d0db5acdd3c4b27971179ac87e18c7d.png"/>
    </p>
    <h3>
     <a id="_135">
     </a>
     抽取封装
    </h3>
    <p>
     因为其他模块可能都有用到启停，所以需要把这个模块抽取到公共模块common中去。
    </p>
    <p>
     创建一个新的
     <code>
      common
     </code>
     目录，然后编写一个
     <code>
      Run
     </code>
     文件，并且加入到work工作目录中，
     <code>
      D:\GoProject\msproject&gt; go work use ./project-common
     </code>
     ，
     <code>
      Run.go
     </code>
     的代码如下。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> common

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"github.com/gin-gonic/gin"</span>
	<span class="token string">"log"</span>
	<span class="token string">"net/http"</span>
	<span class="token string">"os"</span>
	<span class="token string">"os/signal"</span>
	<span class="token string">"syscall"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">Run</span><span class="token punctuation">(</span>r <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine<span class="token punctuation">,</span> svrName <span class="token builtin">string</span><span class="token punctuation">,</span> addr <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	srv <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Server<span class="token punctuation">{<!-- --></span>
		Addr<span class="token punctuation">:</span>    addr<span class="token punctuation">,</span>
		Handler<span class="token punctuation">:</span> r<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s running is %s \n"</span><span class="token punctuation">,</span> svrName<span class="token punctuation">,</span> srv<span class="token punctuation">.</span>Addr<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> err <span class="token operator">!=</span> http<span class="token punctuation">.</span>ErrServerClosed <span class="token punctuation">{<!-- --></span>
			log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	quit <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> os<span class="token punctuation">.</span>Signal<span class="token punctuation">)</span>
	signal<span class="token punctuation">.</span><span class="token function">Notify</span><span class="token punctuation">(</span>quit<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGINT<span class="token punctuation">,</span> syscall<span class="token punctuation">.</span>SIGTERM<span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>quit

	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"shutting down project %s ... \n"</span><span class="token punctuation">,</span> svrName<span class="token punctuation">)</span>

	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">Shutdown</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		log<span class="token punctuation">.</span><span class="token function">Fatalf</span><span class="token punctuation">(</span><span class="token string">"%s shutdown,cause by: %v"</span><span class="token punctuation">,</span> svrName<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"wait timeout..."</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"%s stop success... \n"</span><span class="token punctuation">,</span> svrName<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这样我们就可以在
     <code>
      main.go
     </code>
     中直接调用common的run了（这里把common包命名为了srv）。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ed611f70b0564dc59b1465166323b17c.png">
      <br/>
      这样就可以正常使用了，按下ctrl+c也能够正常启停了。
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9841d17c1c894682ae16936647db4fb0.png"/>
    </p>
    <h2>
     <a id="3__198">
     </a>
     3. 路由
    </h2>
    <p>
     各个模块的路由不可能都写在mian函数中，所以需要分摊下去，由各个模块自己去管理对应的路由。
    </p>
    <p>
     所以这就需要实现接口，然后实现对应的接口即可。
    </p>
    <p>
     现在讲一下实现思路，首先需要构建项目文件结构如下。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/feb41b1803754c94a4c883e5944b75a5.png">
      <br/>
      <code>
       router.go
      </code>
      的代码如下。
     </img>
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> router

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"github.com/gin-gonic/gin"</span>
	<span class="token string">"test.com/project-user/api/user"</span>
<span class="token punctuation">)</span>

<span class="token comment">// Router 接口</span>
<span class="token keyword">type</span> Router <span class="token keyword">interface</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">Route</span><span class="token punctuation">(</span>r <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> RegisterRouter <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>RegisterRouter <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>RegisterRouter<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>RegisterRouter<span class="token punctuation">)</span> <span class="token function">Route</span><span class="token punctuation">(</span>ro Router<span class="token punctuation">,</span> r <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ro<span class="token punctuation">.</span><span class="token function">Route</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">InitRouter</span><span class="token punctuation">(</span>r <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	rg <span class="token operator">:=</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	rg<span class="token punctuation">.</span><span class="token function">Route</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>user<span class="token punctuation">.</span>RouterUser<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     <code>
      user.go
     </code>
     代码如下，主要是执行handler，处理请求。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> user

<span class="token keyword">import</span> <span class="token string">"github.com/gin-gonic/gin"</span>

<span class="token keyword">type</span> HandlerUser <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>HandlerUser<span class="token punctuation">)</span> <span class="token function">getCaptcha</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token string">"getCaptcha success"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     <code>
      route.go
     </code>
     代码如下，主要是实现了对应的Route接口。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> user

<span class="token keyword">import</span> <span class="token string">"github.com/gin-gonic/gin"</span>

<span class="token keyword">type</span> RouterUser <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>RouterUser<span class="token punctuation">)</span> <span class="token function">Route</span><span class="token punctuation">(</span>r <span class="token operator">*</span>gin<span class="token punctuation">.</span>Engine<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	h <span class="token operator">:=</span> <span class="token operator">&amp;</span>HandlerUser<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	r<span class="token punctuation">.</span><span class="token function">POST</span><span class="token punctuation">(</span><span class="token string">"project/login/getCaptcha"</span><span class="token punctuation">,</span> h<span class="token punctuation">.</span>getCaptcha<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     运行后，发送请求，能够正常响应。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d54019dc9cd5458e891de49187efc80b.png">
      <br/>
      这里画了一个流程图，来表示说明。
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/371ec26b532c47ccb87b78ed1faa99bb.png"/>
    </p>
    <h2>
     <a id="4_278">
     </a>
     4.验证码接口
    </h2>
    <p>
     我们在
     <code>
      project-common
     </code>
     文件夹下创建
     <code>
      model.go
     </code>
     文件，然后定义返回的
     <code>
      Result
     </code>
     模型。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> common

<span class="token keyword">type</span> BusinessCode <span class="token builtin">int</span>

<span class="token keyword">type</span> Result <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Code BusinessCode <span class="token string">`json:"code"`</span>
	Msg  <span class="token builtin">string</span>       <span class="token string">`json:"msg"`</span>
	Data any          <span class="token string">`json:"data"`</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Result<span class="token punctuation">)</span> <span class="token function">Success</span><span class="token punctuation">(</span>data any<span class="token punctuation">)</span> <span class="token operator">*</span>Result <span class="token punctuation">{<!-- --></span>
	r<span class="token punctuation">.</span>Code <span class="token operator">=</span> <span class="token number">200</span>
	r<span class="token punctuation">.</span>Msg <span class="token operator">=</span> <span class="token string">"success"</span>
	r<span class="token punctuation">.</span>Data <span class="token operator">=</span> data
	<span class="token keyword">return</span> r
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>Result<span class="token punctuation">)</span> <span class="token function">Fail</span><span class="token punctuation">(</span>code BusinessCode<span class="token punctuation">,</span> msg <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Result <span class="token punctuation">{<!-- --></span>
	r<span class="token punctuation">.</span>Code <span class="token operator">=</span> code
	r<span class="token punctuation">.</span>Msg <span class="token operator">=</span> msg
	<span class="token keyword">return</span> r
<span class="token punctuation">}</span>

</code></pre>
    <p>
     然后在
     <code>
      user.go
     </code>
     中来创建对应的返回代码。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/83497de808ad411389c420fe957db2c5.png"/>
    </p>
    <p>
     验证一下接口请求，没问题。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/cdf903008dcb4847afcb2aebb02b6b03.png"/>
    </p>
    <hr/>
    <p>
     定义手机号验证的逻辑，在common下编写
     <code>
      validata.go
     </code>
     代码。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> common

<span class="token keyword">import</span> <span class="token string">"regexp"</span>

<span class="token comment">// VerifyMobile 验证手机合法性</span>
<span class="token keyword">func</span> <span class="token function">VerifyMobile</span><span class="token punctuation">(</span>mobile <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> mobile <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	regular <span class="token operator">:=</span> <span class="token string">"^((13[0-9])|(14[5,7])|(15[0-3,5-9])|(17[0,3,5-8])|(18[0-9])|166|198|199|(147))\\d{8}$"</span>
	reg <span class="token operator">:=</span> regexp<span class="token punctuation">.</span><span class="token function">MustCompile</span><span class="token punctuation">(</span>regular<span class="token punctuation">)</span>
	<span class="token keyword">return</span> reg<span class="token punctuation">.</span><span class="token function">MatchString</span><span class="token punctuation">(</span>mobile<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     使用
     <code>
      regexp.MustCompile
     </code>
     将正则表达式编译为一个正则对象 reg。最后，调用
     <code>
      reg.MatchString(mobile)
     </code>
     方法，检查传入的手机号码是否与正则表达式匹配。如果匹配，则返回 true，表示手机号码有效；否则返回 false，表示手机号码无效。
    </p>
    <p>
     接着我们优化
     <code>
      user.go
     </code>
     逻辑处理代码，来优化整个登录流程。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span><span class="token operator">*</span>HandlerUser<span class="token punctuation">)</span> <span class="token function">getCaptcha</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	rsp <span class="token operator">:=</span> <span class="token operator">&amp;</span>common<span class="token punctuation">.</span>Result<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	<span class="token comment">//1.获取参数</span>
	moblie <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">"mobile"</span><span class="token punctuation">)</span>
	<span class="token comment">//2.校验参数</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>common<span class="token punctuation">.</span><span class="token function">VerifyMoblie</span><span class="token punctuation">(</span>moblie<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> rsp<span class="token punctuation">.</span><span class="token function">Fail</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>NoLegalMoblie<span class="token punctuation">,</span> <span class="token string">"手机号不合法"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//3.生成验证码（随机4位或者6位）</span>
	code <span class="token operator">:=</span> <span class="token string">"123456"</span>
	<span class="token comment">//4.调用短信平台（三方，放入go协程中执行，接口可以快速响应，短信几秒到无所谓）</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"短信平台调用成功，发送短信"</span><span class="token punctuation">)</span>
		<span class="token comment">//5.存储验证码redis，设置过期时间15分钟即可</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"将手机号和验证码存入redis成功：REGISTER %s : %s"</span><span class="token punctuation">,</span> moblie<span class="token punctuation">,</span> code<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> rsp<span class="token punctuation">.</span><span class="token function">Success</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     在上面我们用到了定义的常量
     <code>
      NolegalMoblie
     </code>
     ，需要创建一个新的文件夹和
     <code>
      code.go
     </code>
     代码，如下所示。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/813b3a266e514c85b3367b1f55832d00.png"/>
    </p>
    <h3>
     <a id="redis_366">
     </a>
     导入redis支持
    </h3>
    <p>
     在
     <code>
      project-user
     </code>
     路径下导入redis模块。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">go</span> get github<span class="token punctuation">.</span>com<span class="token operator">/</span><span class="token keyword">go</span><span class="token operator">-</span>redis<span class="token operator">/</span>redis<span class="token operator">/</span>v8
</code></pre>
    <p>
     上面的代码并没有对redis的支持，现在我们需要考虑引用redis了。
    </p>
    <p>
     但是redis后续可能会缓存在mysql或者mongo或者别的存储器当中，需要不断变换代码，那么就不方便，这个时候就需要用到接口，面向接口编程，低耦合，高内聚。
    </p>
    <p>
     这里我们进行了如下改动，首先定义了cache的相关接口。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f78a799351b8473a99a0eae82e02cf41.png"/>
     <br/>
     然后在定义在redis.go中来定义实现的方法
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/59142d0b3f944c798cf93c96c4e14b48.png"/>
     <br/>
     最后更新user.go中的相关代码即可。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">type</span> HandlerUser <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	cache repo<span class="token punctuation">.</span>Cache
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>HandlerUser <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>HandlerUser<span class="token punctuation">{<!-- --></span>
		cache<span class="token punctuation">:</span> dao<span class="token punctuation">.</span>Rc<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>h <span class="token operator">*</span>HandlerUser<span class="token punctuation">)</span> <span class="token function">getCaptcha</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>gin<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	rsp <span class="token operator">:=</span> <span class="token operator">&amp;</span>common<span class="token punctuation">.</span>Result<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	<span class="token comment">//1.获取参数</span>
	moblie <span class="token operator">:=</span> ctx<span class="token punctuation">.</span><span class="token function">PostForm</span><span class="token punctuation">(</span><span class="token string">"mobile"</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>moblie<span class="token punctuation">)</span>
	<span class="token comment">//2.校验参数</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>common<span class="token punctuation">.</span><span class="token function">VerifyMoblie</span><span class="token punctuation">(</span>moblie<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> rsp<span class="token punctuation">.</span><span class="token function">Fail</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span>NoLegalMoblie<span class="token punctuation">,</span> <span class="token string">"手机号不合法"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//3.生成验证码（随机4位或者6位）</span>
	code <span class="token operator">:=</span> <span class="token string">"123456"</span>
	<span class="token comment">//4.调用短信平台（三方，放入go协程中执行，接口可以快速响应，短信几秒到无所谓）</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"短信平台调用成功，发送短信"</span><span class="token punctuation">)</span>
		<span class="token comment">// redis 假设后续缓存在mysql或者mongo当中，也有可能存储在别的当中</span>
		<span class="token comment">// 所以考虑用接口实现，面向接口编程“低耦合，高内聚“</span>
		<span class="token comment">// 5.存储验证码redis，设置过期时间15分钟即可</span>
		c<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		err <span class="token operator">:=</span> h<span class="token punctuation">.</span>cache<span class="token punctuation">.</span><span class="token function">Put</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token string">"REGISTER_"</span><span class="token operator">+</span>moblie<span class="token punctuation">,</span> code<span class="token punctuation">,</span> <span class="token number">15</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Minute<span class="token punctuation">)</span>
		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"验证码存入redis出错，causer by :%v\n"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"将手机号和验证码存入redis成功：REGISTER %s : %s"</span><span class="token punctuation">,</span> moblie<span class="token punctuation">,</span> code<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	ctx<span class="token punctuation">.</span><span class="token function">JSON</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>StatusOK<span class="token punctuation">,</span> rsp<span class="token punctuation">.</span><span class="token function">Success</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f7468656169706f7765722f:61727469636c652f64657461696c732f313436303535333430" class_="artid" style="display:none">
 </p>
</div>


