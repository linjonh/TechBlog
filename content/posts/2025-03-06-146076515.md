---
layout: post
title: "ALGAlloyLokiGrafana轻量级日志系统"
date: 2025-03-06 17:50:02 +0800
description: "Docker Compose搭建ALG(Alloy+Loki+Grafana)轻量级日志系统"
keywords: "alloy采集docker日志"
categories: ['未分类']
tags: ['Grafana']
artid: "146076515"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146076515
    alt: "ALGAlloyLokiGrafana轻量级日志系统"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146076515
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146076515
cover: https://bing.ee123.net/img/rand?artid=146076515
image: https://bing.ee123.net/img/rand?artid=146076515
img: https://bing.ee123.net/img/rand?artid=146076515
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ALG(Alloy+Loki+Grafana)轻量级日志系统
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-dracula" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="ALGAlloyLokiGrafana_1">
     </a>
     ALG(Alloy+Loki+Grafana)轻量级日志系统
    </h2>
    <blockquote>
     <p>
      前提要求
     </p>
     <ol>
      <li>
       Grafana
      </li>
      <li>
       Minio
      </li>
      <li>
       Nginx
      </li>
      <li>
       Prometheus
      </li>
     </ol>
    </blockquote>
    <p>
     Grafana日志收集系统旧版是PLG(Protail+Loki+Grafana), Protail收集日志, Loki存储, Grafana展示, 后续的Protail不维护了, Grafana推出了Alloy代替Pritial, 除了收集日志外, 还集成管理Prometheus各种exporter功能, 代替传统模式下需要安装xxxx_exporter插件才能采集指标的情况
    </p>
    <p>
     ALG适合云原生, 拓展性强, 但是对于传统的日志收集是很支持(后续有Alloy采集本地日志log, gz等格式案例)
    </p>
    <h3>
     <a id="ALG_20">
     </a>
     读写分离模式部署ALG
    </h3>
    <h4>
     <a id="_22">
     </a>
     初始化文件夹和一些配置文件
    </h4>
    <h5>
     <a id="_24">
     </a>
     初始化文件夹
    </h5>
    <pre><code class="prism language-sh"><span class="token comment"># log日志存储</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/alg/flog/logs/log
<span class="token comment"># 日志压缩文件存储</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/alg/flog/logs/gz
<span class="token comment"># minio存储</span>
<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /data/alg/minio
</code></pre>
    <h5>
     <a id="nginx_37">
     </a>
     创建nginx配置文件
    </h5>
    <pre><code class="prism language-sh"><span class="token function">vim</span> /data/alg/nginx.conf
</code></pre>
    <pre><code class="prism language-json">user nginx<span class="token punctuation">;</span>
worker_processes <span class="token number">5</span><span class="token punctuation">;</span> # worker线程数

events <span class="token punctuation">{<!-- --></span>
    worker_connections <span class="token number">1000</span><span class="token punctuation">;</span> # 单个worker连接数
<span class="token punctuation">}</span>

http <span class="token punctuation">{<!-- --></span>
    # 使用Docker内置<span class="token constant">DNS</span>解析服务名<span class="token punctuation">,</span> <span class="token constant">DNS</span>缓存有效期<span class="token number">10</span>秒
    resolver <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.11</span> valid<span class="token operator">=</span>10s<span class="token punctuation">;</span>
    # 开启访问日志<span class="token punctuation">,</span> 生产中建议关闭
    access_log on<span class="token punctuation">;</span>
    
    # 定义上游Loki writer服务器组
    upstream loki_writers <span class="token punctuation">{<!-- --></span>
        server write<span class="token operator">:</span><span class="token number">3100</span><span class="token punctuation">;</span>
        # 保持长连接池
        keepalive <span class="token number">32</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    # 定义上游Loki reader服务器组
    upstream loki_readers <span class="token punctuation">{<!-- --></span>
        server read<span class="token operator">:</span><span class="token number">3100</span><span class="token punctuation">;</span>
        keepalive <span class="token number">32</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    # 定义上游alloy服务器组
    upstream alloys <span class="token punctuation">{<!-- --></span>
        server alloy<span class="token operator">:</span><span class="token number">12345</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    # Grafana <span class="token constant">UI</span>
    server <span class="token punctuation">{<!-- --></span>
        listen <span class="token number">3000</span><span class="token punctuation">;</span>
        
        location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
            proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>grafana<span class="token operator">:</span><span class="token number">3000</span><span class="token punctuation">;</span>
            
            # 代理设置请求头<span class="token punctuation">,</span> 否则Grafana会提示一直登录
            # 并且要设置WebSocket<span class="token punctuation">,</span> 否则无法运行实时跟踪
            # 见https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>weixin_41287260<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">134630447</span>
            # https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>cnblogs<span class="token punctuation">.</span>com<span class="token operator">/</span>hahaha111122222<span class="token operator">/</span>p<span class="token operator">/</span><span class="token number">16407564</span><span class="token punctuation">.</span>html
            proxy_set_header Upgrade $http_upgrade<span class="token punctuation">;</span>
            proxy_set_header Connection <span class="token string">"upgrade"</span><span class="token punctuation">;</span>
            proxy_set_header Host $http_host<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    
    # Loki相关日志推送<span class="token punctuation">,</span> 存储等配置
    server <span class="token punctuation">{<!-- --></span>
        # 监听容器内 <span class="token number">3100</span> 端口（通过 ports 映射到宿主机 <span class="token number">3100</span>）启用端口复用提升性能
        listen <span class="token number">3100</span> reuseport<span class="token punctuation">;</span>

         # 定义写入类请求的通用配置块
        location <span class="token operator">~</span> <span class="token operator">^</span><span class="token operator">/</span><span class="token punctuation">(</span>api<span class="token operator">/</span>prom<span class="token operator">/</span>push<span class="token operator">|</span>loki<span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>push<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>loki_writers$request_uri<span class="token punctuation">;</span>
            proxy_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>
            proxy_set_header Connection <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        # 定义实时日志流式传输（tail）请求的通用配置块
        location <span class="token operator">~</span> <span class="token operator">^</span><span class="token operator">/</span><span class="token punctuation">(</span>api<span class="token operator">/</span>prom<span class="token operator">/</span>tail<span class="token operator">|</span>loki<span class="token operator">/</span>api<span class="token operator">/</span>v1<span class="token operator">/</span>tail<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>loki_readers$request_uri<span class="token punctuation">;</span>
            proxy_read_timeout 3600s<span class="token punctuation">;</span>
            # 这里必须要配置WebSocket<span class="token punctuation">,</span> 否则无法运行实时跟踪
            proxy_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>
            proxy_set_header Upgrade $http_upgrade<span class="token punctuation">;</span>
            proxy_set_header Connection <span class="token string">"upgrade"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        # 定义所有 Prometheus 格式和 Loki 原生格式查询请求的通用配置块
        location <span class="token operator">~</span> <span class="token operator">^</span><span class="token operator">/</span><span class="token punctuation">(</span>api<span class="token operator">/</span>prom<span class="token operator">/</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token operator">|</span>loki<span class="token operator">/</span>api<span class="token operator">/</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>loki_readers$request_uri<span class="token punctuation">;</span>
            proxy_http_version <span class="token number">1.1</span><span class="token punctuation">;</span>
            proxy_set_header Connection <span class="token string">""</span><span class="token punctuation">;</span>
            # 缓存查询结果<span class="token number">10</span>秒
            proxy_cache_valid <span class="token number">200</span> 10s<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    # read 端点<span class="token punctuation">,</span> <span class="token function">生产中应该禁外界访问</span><span class="token punctuation">(</span>这里做演示<span class="token punctuation">,</span> 所以开放<span class="token punctuation">)</span><span class="token punctuation">,</span> 容器内部通信即可
    server <span class="token punctuation">{<!-- --></span>
        listen <span class="token number">3101</span><span class="token punctuation">;</span>
        
        location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
            proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>loki_readers<span class="token operator">/</span>ready<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    # write 端点<span class="token punctuation">,</span> <span class="token function">生产中禁外界访问</span><span class="token punctuation">(</span>这里做演示<span class="token punctuation">,</span> 所以开放<span class="token punctuation">)</span><span class="token punctuation">,</span> 容器内部通信即可
    server <span class="token punctuation">{<!-- --></span>
        listen <span class="token number">3102</span><span class="token punctuation">;</span>
        
        location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
            proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>loki_writers<span class="token operator">/</span>ready<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    # Minio <span class="token constant">UI</span>
    server <span class="token punctuation">{<!-- --></span>
        listen <span class="token number">9001</span><span class="token punctuation">;</span>
        
        location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
            proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>minio<span class="token operator">:</span><span class="token number">9001</span><span class="token punctuation">;</span>
            
            # 添加websocket支持<span class="token punctuation">,</span> 否则Minio会卡主<span class="token punctuation">,</span> 页面一直loading
            # 见https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>blog<span class="token punctuation">.</span>csdn<span class="token punctuation">.</span>net<span class="token operator">/</span>qq_25231683<span class="token operator">/</span>article<span class="token operator">/</span>details<span class="token operator">/</span><span class="token number">128734555</span>
            proxy_set_header Upgrade $http_upgrade<span class="token punctuation">;</span>
            proxy_set_header Connection <span class="token string">"upgrade"</span><span class="token punctuation">;</span>
            proxy_set_header Host $http_host<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    # Alloy <span class="token constant">UI</span>
    server <span class="token punctuation">{<!-- --></span>
        listen <span class="token number">12345</span><span class="token punctuation">;</span>
        
        location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
            proxy_pass http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>alloys<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>    
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="alloy_173">
     </a>
     创建alloy配置文件
    </h5>
    <pre><code class="prism language-sh"><span class="token function">vim</span> /data/alg/alloy-local-config.yaml
</code></pre>
    <pre><code class="prism language-yaml">// ========================
// 实时调试
// ========================
livedebugging <span class="token punctuation">{<!-- --></span>
  enabled = true
<span class="token punctuation">}</span>

// ========================
// Docker容器日志发现和采集
// ========================
// Docker 容器发现配置
discovery.docker "flog_scrape" <span class="token punctuation">{<!-- --></span>
    // 连接 Docker daemon 的地址（Unix 套接字）
    host             = "unix<span class="token punctuation">:</span>///var/run/docker.sock"  
    // 每5s抓取Docker信息日志
    refresh_interval = "5s"  
<span class="token punctuation">}</span>

// 主要用于服务发现阶段对发现的目标（如容器、节点等）的元数据标签进行预处理。当通过服务发现机制（如基于 Docker、Kubernetes 等）发现一系列目标时，这些目标会带有各种元数据标签，这里可以对这些原始标签进行修改、添加、删除等操作，使得标签更加符
discovery.relabel "flog_scrape" <span class="token punctuation">{<!-- --></span>
    // 初始空目标列表（自动从上游发现discovery.docker "flog_scrape"填充）
    targets = <span class="token punctuation">[</span><span class="token punctuation">]</span>  

    // 提取容器名称
    rule <span class="token punctuation">{<!-- --></span>
        // 原始元数据标签（来自 Docker 的属性）
        source_labels = <span class="token punctuation">[</span><span class="token string">"__meta_docker_container_name"</span><span class="token punctuation">]</span>  
        // 正则提取容器名称（去除路径前缀）
        regex         = "/(.<span class="token important">*)"</span>  
        // 生成新标签 container 存储处理结果
        target_label  = "container"
    <span class="token punctuation">}</span>
    
    // 提取项目名
    rule <span class="token punctuation">{<!-- --></span>
        //
        source_labels = <span class="token punctuation">[</span><span class="token string">"__meta_docker_container_label_com_docker_compose_project"</span><span class="token punctuation">]</span>
        regex         = "(.<span class="token important">*)"</span>  
        target_label  = "project"     
    <span class="token punctuation">}</span>       
<span class="token punctuation">}</span>

// Loki Docker 日志采集配置
loki.source.docker "flog_scrape" <span class="token punctuation">{<!-- --></span>
    // Docker 连接配置（需与发现模块一致）
    host             = "unix<span class="token punctuation">:</span>///var/run/docker.sock"  
    // 要从中读取日志的容器列表<span class="token punctuation">,</span> 关联发现模块获取的目标列表
    targets          = discovery.docker.flog_scrape.targets  
    // 日志转发目的地（指向写入模块）
    forward_to       = <span class="token punctuation">[</span>loki.write.default.receiver<span class="token punctuation">]</span>  
    // 应用标签重写规则
    relabel_rules    = discovery.relabel.flog_scrape.rules  
    // 目标同步频率（与发现模块同步）
    refresh_interval = "5s"  
<span class="token punctuation">}</span>

// ========================
// <span class="token important">*.log文件匹配和采集</span>
// ========================
// 本地<span class="token important">*.log文件匹配</span>
local.file_match "local_log" <span class="token punctuation">{<!-- --></span>
  path_targets = <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>__path__ = "/data/alg/flog/logs/log/<span class="token important">*.log"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

// ========================
// 本地<span class="token important">*.log文件采集</span>
// ========================
loki.source.file "local_log" <span class="token punctuation">{<!-- --></span>
  // 关联发现模块获取的目标列表<span class="token punctuation">,</span> 关联到本地机器日志匹配
  targets    = local.file_match.local_log.targets
  // 日志转发目的地（指向写入模块）
  forward_to = <span class="token punctuation">[</span>loki.write.default.receiver<span class="token punctuation">]</span>
<span class="token punctuation">}</span>

// ========================
// <span class="token important">*.gz文件匹配和采集</span>
// ========================
// 本地<span class="token important">*.gz文件匹配</span>
local.file_match "local_log_gz" <span class="token punctuation">{<!-- --></span>
  path_targets = <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>__path__ = "/data/alg/flog/logs/gz/<span class="token important">*.gz"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

// 本地<span class="token important">*.log文件采集</span>
loki.source.file "local_log_gz" <span class="token punctuation">{<!-- --></span>
  // 关联发现模块获取的目标列表<span class="token punctuation">,</span> 关联到本地机器日志匹配
  targets    = local.file_match.local_log_gz.targets
  // 日志转发目的地（指向写入模块）
  forward_to = <span class="token punctuation">[</span>loki.write.default.receiver<span class="token punctuation">]</span>
  // 解压缩
  decompression <span class="token punctuation">{<!-- --></span>
    // 是否启用解压缩
    enabled       = true
    // 开始从新的压缩文件读取之前要等待的时间
    initial_delay = "10s"
    // 使用的压缩格式Gzip
    format        = "gz"
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


// ========================
// Loki 日志写入配置
// ========================
loki.write "default" <span class="token punctuation">{<!-- --></span>
    // 将日志发送到的位置
    endpoint <span class="token punctuation">{<!-- --></span>
        // 要将日志发送到的完整 URL<span class="token punctuation">,</span> Loki 接收端 API 地址
        url       = "http<span class="token punctuation">:</span>//gateway<span class="token punctuation">:</span>3100/loki/api/v1/push"
        // 发送前要累积的最大日志批次大小
        batch_size = "1MiB"
        // 发送批次前要等待的最长时间
        batch_wait = "1s"
        // 多租户标识（生产环境建议动态获取）
        tenant_id = "tenant1"
    <span class="token punctuation">}</span>
    // 附加全局标签（当前为空配置）
    external_labels = <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>  
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="loki_310">
     </a>
     创建loki配置文件
    </h5>
    <pre><code class="prism language-sh"><span class="token function">vim</span> /data/alg/loki-config.yaml
</code></pre>
    <pre><code class="prism language-yaml"><span class="token comment"># ========================</span>
<span class="token comment"># Loki 服务核心配置</span>
<span class="token comment"># ========================</span>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">http_listen_address</span><span class="token punctuation">:</span> 0.0.0.0    <span class="token comment"># 监听所有网络接口</span>
  <span class="token key atrule">http_listen_port</span><span class="token punctuation">:</span> <span class="token number">3100</span>           <span class="token comment"># 默认 Loki 服务端口</span>

<span class="token comment"># ========================</span>
<span class="token comment"># 集群节点发现与通信配置</span>
<span class="token comment"># ========================</span>
<span class="token key atrule">memberlist</span><span class="token punctuation">:</span>
  <span class="token key atrule">join_members</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"read"</span><span class="token punctuation">,</span> <span class="token string">"write"</span><span class="token punctuation">,</span> <span class="token string">"backend"</span><span class="token punctuation">]</span>  <span class="token comment"># 需要连接的初始节点列表（建议使用IP或DNS）</span>
  <span class="token key atrule">dead_node_reclaim_time</span><span class="token punctuation">:</span> 30s     <span class="token comment"># 节点标记为死亡后保留元数据的时间</span>
  <span class="token key atrule">gossip_to_dead_nodes_time</span><span class="token punctuation">:</span> 15s  <span class="token comment"># 停止向死亡节点发送gossip包的时间</span>
  <span class="token key atrule">left_ingesters_timeout</span><span class="token punctuation">:</span> 30s     <span class="token comment"># 离开节点清理超时时间</span>
  <span class="token key atrule">bind_addr</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">]</span>          <span class="token comment"># 集群通信绑定地址</span>
  <span class="token key atrule">bind_port</span><span class="token punctuation">:</span> <span class="token number">7946</span>                 <span class="token comment"># 集群通信端口</span>
  <span class="token key atrule">gossip_interval</span><span class="token punctuation">:</span> 2s             <span class="token comment"># 节点状态同步间隔</span>

<span class="token comment"># ========================</span>
<span class="token comment"># 数据存储架构配置</span>
<span class="token comment"># ========================</span>
<span class="token key atrule">schema_config</span><span class="token punctuation">:</span>
  <span class="token key atrule">configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">from</span><span class="token punctuation">:</span> <span class="token datetime number">2023-01-01</span>            <span class="token comment"># 配置生效起始时间</span>
      <span class="token key atrule">store</span><span class="token punctuation">:</span> tsdb                 <span class="token comment"># 使用 Prometheus TSDB 存储</span>
      <span class="token key atrule">object_store</span><span class="token punctuation">:</span> s3            <span class="token comment"># 对象存储类型</span>
      <span class="token key atrule">schema</span><span class="token punctuation">:</span> v13                 <span class="token comment"># 存储格式版本</span>
      <span class="token key atrule">index</span><span class="token punctuation">:</span>
        <span class="token key atrule">prefix</span><span class="token punctuation">:</span> index_            <span class="token comment"># 索引文件前缀</span>
        <span class="token key atrule">period</span><span class="token punctuation">:</span> 24h               <span class="token comment"># 索引文件切割周期</span>

<span class="token comment"># ========================</span>
<span class="token comment"># 公共基础配置</span>
<span class="token comment"># ========================</span>
<span class="token key atrule">common</span><span class="token punctuation">:</span>
  <span class="token key atrule">path_prefix</span><span class="token punctuation">:</span> /loki             <span class="token comment"># 存储路径前缀</span>
  <span class="token key atrule">replication_factor</span><span class="token punctuation">:</span> <span class="token number">1</span>          <span class="token comment"># 数据副本数（生产环境建议 &gt;=3）</span>
  <span class="token key atrule">compactor_address</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//backend<span class="token punctuation">:</span><span class="token number">3100</span>  <span class="token comment"># 压缩组件地址</span>

  <span class="token comment"># 对象存储配置</span>
  <span class="token key atrule">storage</span><span class="token punctuation">:</span>
    <span class="token comment"># S3对象存储</span>
    <span class="token key atrule">s3</span><span class="token punctuation">:</span>
      <span class="token key atrule">endpoint</span><span class="token punctuation">:</span> minio<span class="token punctuation">:</span><span class="token number">9000</span>         <span class="token comment"># S3兼容存储地址</span>
      <span class="token key atrule">insecure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>              <span class="token comment"># 禁用HTTPS（生产环境不推荐）</span>
      <span class="token key atrule">bucketnames</span><span class="token punctuation">:</span> loki<span class="token punctuation">-</span>data      <span class="token comment"># 主数据存储桶</span>
      <span class="token key atrule">access_key_id</span><span class="token punctuation">:</span> whiteBrocade         <span class="token comment"># 访问密钥（建议使用环境变量）</span>
      <span class="token key atrule">secret_access_key</span><span class="token punctuation">:</span> whiteBrocade  <span class="token comment"># 密钥（存在安全隐患）</span>
      <span class="token key atrule">s3forcepathstyle</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>      <span class="token comment"># 强制路径访问模式</span>
    <span class="token comment"># 本地文件存储(由于是容器形式启动loki, 这里指的是容器内系统)</span>
    <span class="token comment">#filesystem:</span>
    <span class="token comment">#  # 数据保存的地方</span>
    <span class="token comment">#  chunks_directory: /tmp/loki/chunks</span>
    <span class="token comment">#  # 规则保存的地方</span>
    <span class="token comment">#  rules_directory: /tmp/loki/rules</span>
  <span class="token comment"># 一致性哈希环配置</span>
  <span class="token key atrule">ring</span><span class="token punctuation">:</span>
    <span class="token key atrule">kvstore</span><span class="token punctuation">:</span>
      <span class="token key atrule">store</span><span class="token punctuation">:</span> memberlist           <span class="token comment"># 使用memberlist实现分布式哈希环</span>

<span class="token comment"># ========================</span>
<span class="token comment"># 告警规则配置</span>
<span class="token comment"># ========================</span>
<span class="token key atrule">ruler</span><span class="token punctuation">:</span>
  <span class="token key atrule">storage</span><span class="token punctuation">:</span>
    <span class="token key atrule">s3</span><span class="token punctuation">:</span>
      <span class="token key atrule">bucketnames</span><span class="token punctuation">:</span> loki<span class="token punctuation">-</span>ruler     <span class="token comment"># 独立存储告警规则的桶</span>

<span class="token comment"># ========================</span>
<span class="token comment"># 数据压缩配置</span>
<span class="token comment"># ========================</span>
<span class="token key atrule">compactor</span><span class="token punctuation">:</span>
  <span class="token key atrule">working_directory</span><span class="token punctuation">:</span> /tmp/compactor  <span class="token comment"># 临时工作目录（建议使用持久化存储）</span>
</code></pre>
    <h4>
     <a id="dockercompose_397">
     </a>
     docker-compose文件
    </h4>
    <h6>
     <a id="ALG_399">
     </a>
     ALG
    </h6>
    <blockquote>
     <ol>
      <li>
       loki使用的是
       <strong>
        读写分离
       </strong>
       模式部署, 拆分成了read, write, backend三个组件
      </li>
      <li>
       存储使用的Minio, 生产中建议对存储日志的桶设置过期策略, 减少存储成本
      </li>
      <li>
       使用ng作为网关统一入口, 有些端口生产中不应该开放, 比如说loki的read和write的read访问
      </li>
     </ol>
    </blockquote>
    <pre><code class="prism language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.8"</span>
<span class="token comment"># ========================</span>
<span class="token comment"># 自定义网络配置</span>
<span class="token comment"># ========================</span>
<span class="token key atrule">networks</span><span class="token punctuation">:</span>
  <span class="token key atrule">loki</span><span class="token punctuation">:</span>  <span class="token comment"># 创建专用网络确保服务隔离</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> bridge

<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token comment"># ========================</span>
  <span class="token comment"># Loki 读取组件（查询节点）</span>
  <span class="token comment"># ========================</span>
  <span class="token key atrule">read</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> grafana/loki<span class="token punctuation">:</span>latest
    <span class="token comment"># 容器名</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> loki<span class="token punctuation">-</span>read
    <span class="token comment"># 指定read模式启动</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"-config.file=/etc/loki/config.yaml -target=read"</span>  <span class="token comment"># 指定角色为读取节点</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token number">3100</span>    <span class="token comment"># 映射外部访问端口</span>
      <span class="token punctuation">-</span> <span class="token number">7946</span>    <span class="token comment"># memberlist 通信端口</span>
      <span class="token punctuation">-</span> <span class="token number">9095</span>    <span class="token comment"># 指标暴露端口（未映射到宿主机）</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/alg/loki<span class="token punctuation">-</span>config.yaml<span class="token punctuation">:</span>/etc/loki/config.yaml  <span class="token comment"># 共享配置文件</span>
    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span>  <span class="token comment"># 健康检查策略</span>
      <span class="token key atrule">test</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"CMD-SHELL"</span><span class="token punctuation">,</span> <span class="token comment"># 使用 shell 执行命令</span>
        "wget <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>verbose <span class="token punctuation">-</span><span class="token punctuation">-</span>tries=1 <span class="token punctuation">-</span><span class="token punctuation">-</span>spider http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3100/ready <span class="token punctuation">|</span><span class="token punctuation">|</span> exit 1"
        <span class="token punctuation">]</span>
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s <span class="token comment"># 每10秒检查一次</span>
      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 5s   <span class="token comment"># 超时时间5秒</span>
      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">5</span>    <span class="token comment"># 最多重试5次</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span> <span class="token comment"># 依赖Minio</span>
      <span class="token punctuation">-</span> minio
    <span class="token comment"># 定义网络锚点, 后续直接复用</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span> <span class="token important">&amp;loki-dns</span>  <span class="token comment"># 网络别名锚点</span>
      <span class="token key atrule">loki</span><span class="token punctuation">:</span>
        <span class="token key atrule">aliases</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> loki  <span class="token comment"># 其他服务可通过 loki 域名访问</span>

  <span class="token comment"># ========================</span>
  <span class="token comment"># Loki 写入组件（接收节点）</span>
  <span class="token comment"># ========================</span>
  <span class="token key atrule">write</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> grafana/loki<span class="token punctuation">:</span>latest
    <span class="token comment"># 容器名</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> loki<span class="token punctuation">-</span>write
    <span class="token comment"># 指定write模式启动</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"-config.file=/etc/loki/config.yaml -target=write"</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token number">3100</span>    <span class="token comment"># 与读节点区分端口</span>
      <span class="token punctuation">-</span> <span class="token number">7946</span>    <span class="token comment"># memberlist 通信端口</span>
      <span class="token punctuation">-</span> <span class="token number">9095</span>    <span class="token comment"># 指标暴露端口（未映射到宿主机）</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/alg/loki<span class="token punctuation">-</span>config.yaml<span class="token punctuation">:</span>/etc/loki/config.yaml
    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span> <span class="token comment"># 健康检查策略</span>
      <span class="token key atrule">test</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"CMD-SHELL"</span><span class="token punctuation">,</span> <span class="token comment"># 使用 shell 执行命令</span>
        "wget <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>verbose <span class="token punctuation">-</span><span class="token punctuation">-</span>tries=1 <span class="token punctuation">-</span><span class="token punctuation">-</span>spider http<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3100/ready <span class="token punctuation">|</span><span class="token punctuation">|</span> exit 1"
        <span class="token punctuation">]</span>
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s <span class="token comment"># 每10秒检查一次</span>
      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 5s   <span class="token comment"># 超时时间5秒</span>
      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">5</span>    <span class="token comment"># 最多重试5次</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span> <span class="token comment"># 依赖Minio</span>
      <span class="token punctuation">-</span> minio
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token key atrule">&lt;&lt;</span><span class="token punctuation">:</span> <span class="token important">*loki-dns</span>  <span class="token comment"># 复用网络别名配置</span>

  <span class="token comment"># ========================</span>
  <span class="token comment"># Loki 后台处理组件</span>
  <span class="token comment"># ========================</span>
  <span class="token key atrule">backend</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> grafana/loki<span class="token punctuation">:</span>latest
    <span class="token comment"># 容器名</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> loki<span class="token punctuation">-</span>backend
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token string">"-config.file=/etc/loki/config.yaml -target=backend -legacy-read-mode=false"</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token number">3100</span>    <span class="token comment"># 默认API端口（未映射到宿主机）</span>
      <span class="token punctuation">-</span> <span class="token number">7946</span>    <span class="token comment"># memberlist端口</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/alg/loki<span class="token punctuation">-</span>config.yaml<span class="token punctuation">:</span>/etc/loki/config.yaml
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> loki

  <span class="token comment"># ========================</span>
  <span class="token comment"># 日志采集组件（原Grafana Agent）</span>
  <span class="token comment"># ========================</span>
  <span class="token key atrule">alloy</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> grafana/alloy<span class="token punctuation">:</span>latest
    <span class="token comment"># 容器名</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> alloy
    <span class="token key atrule">command</span><span class="token punctuation">:</span> run <span class="token punctuation">-</span><span class="token punctuation">-</span>server.http.listen<span class="token punctuation">-</span>addr=0.0.0.0<span class="token punctuation">:</span>12345 <span class="token punctuation">-</span><span class="token punctuation">-</span>storage.path=/var/lib/alloy/data /etc/alloy/config.alloy
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token number">12345</span>   <span class="token comment"># Web UI端口</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token comment"># 将程序产生的*.log,*.gzd的父目录映射到alloy, 这样才能探测到</span>
      <span class="token punctuation">-</span> /data/alg/flog/logs<span class="token punctuation">:</span>/data/alg/flog/logs
      <span class="token punctuation">-</span> /data/alg/alloy<span class="token punctuation">-</span>local<span class="token punctuation">-</span>config.yaml<span class="token punctuation">:</span>/etc/alloy/config.alloy<span class="token punctuation">:</span>ro  <span class="token comment"># 采集配置</span>
      <span class="token punctuation">-</span> /var/run/docker.sock<span class="token punctuation">:</span>/var/run/docker.sock  <span class="token comment"># 挂载docker socket, 如果不挂载这个, 那么没法获取到容器的日志</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> loki

  <span class="token comment"># ========================</span>
  <span class="token comment"># 对象存储服务（S3兼容）</span>
  <span class="token comment"># ========================</span>
  <span class="token key atrule">minio</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> minio/minio<span class="token punctuation">:</span>latest
    <span class="token comment"># 容器名</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> minio
    <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span>  <span class="token comment"># 初始化存储目录</span>
      <span class="token punctuation">-</span> sh          
      <span class="token punctuation">-</span> <span class="token punctuation">-</span>euc        <span class="token comment"># 执行脚本的参数：e(报错退出) u(未定义变量报错) c(执行后续命令)</span>
      <span class="token punctuation">-</span> <span class="token punctuation">|</span>           <span class="token comment"># 多行脚本开始, minio创建目录挂载日志</span>
        mkdir <span class="token punctuation">-</span>p /data/loki<span class="token punctuation">-</span>data <span class="token important">&amp;&amp;</span> \
        mkdir <span class="token punctuation">-</span>p /data/loki<span class="token punctuation">-</span>ruler <span class="token important">&amp;&amp;</span> \
        minio server /data <span class="token punctuation">-</span><span class="token punctuation">-</span>console<span class="token punctuation">-</span>address <span class="token punctuation">:</span><span class="token number">9001</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> MINIO_ROOT_USER=whiteBrocade        <span class="token comment"># 用户名（与Loki配置对应）</span>
      <span class="token punctuation">-</span> MINIO_ROOT_PASSWORD=whiteBrocade    <span class="token comment"># 密码（需加密处理）</span>
      <span class="token punctuation">-</span> MINIO_PROMETHEUS_AUTH_TYPE=public   <span class="token comment"># 开放指标</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/alg/minio<span class="token punctuation">:</span>/data  <span class="token comment"># 持久化存储路径</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token number">9000</span>    <span class="token comment"># API端口</span>
      <span class="token punctuation">-</span> <span class="token number">9001</span>    <span class="token comment"># UI端口</span>
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> loki

  <span class="token comment"># ========================</span>
  <span class="token comment"># 可视化平台</span>
  <span class="token comment"># ========================</span>
  <span class="token key atrule">grafana</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> grafana/grafana<span class="token punctuation">-</span>enterprise<span class="token punctuation">:</span>latest
    <span class="token comment"># 容器名</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> grafana
    <span class="token comment"># 数据持久化</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> GF_AUTH_ANONYMOUS_ENABLED=true  <span class="token comment"># 开启匿名访问（生产环境应关闭）</span>
      <span class="token comment"># 设置 Grafana 的管理员（admin）账户的初始密码为admin </span>
      <span class="token punctuation">-</span> GF_SECURITY_ADMIN_PASSWORD=admin
      <span class="token comment"># 设置Grafana的语言为简体中文</span>
      <span class="token punctuation">-</span> GF_VIEWER_LANGUAGE=zh<span class="token punctuation">-</span>Hans
      <span class="token comment"># 设置 Grafana 的默认用户界面主题为暗黑模式</span>
      <span class="token punctuation">-</span> GF_USERS_DEFAULT_THEME=dark
      <span class="token punctuation">-</span> GF_PATHS_PROVISIONING=/etc/grafana/provisioning
    <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span>  <span class="token comment"># 覆盖默认启动命令, 动态创建Loki数据源配置</span>
      <span class="token punctuation">-</span> sh
      <span class="token punctuation">-</span> <span class="token punctuation">-</span>euc         <span class="token comment"># 执行脚本的参数</span>
      <span class="token punctuation">-</span> <span class="token punctuation">|</span>            <span class="token comment"># 多行脚本开始</span>
        mkdir <span class="token punctuation">-</span>p /etc/grafana/provisioning/datasources
        cat &lt;&lt;EOF <span class="token punctuation">&gt;</span> /etc/grafana/provisioning/datasources/ds.yaml
        <span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> <span class="token number">1</span>
        <span class="token comment"># 初始化Loki数据源</span>
        <span class="token key atrule">datasources</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Loki     <span class="token comment"># 显示在UI中的名称</span>
            <span class="token key atrule">type</span><span class="token punctuation">:</span> loki     <span class="token comment"># 数据源类型</span>
            <span class="token key atrule">access</span><span class="token punctuation">:</span> proxy  <span class="token comment"># 通过Grafana服务代理访问</span>
            <span class="token key atrule">url</span><span class="token punctuation">:</span> http<span class="token punctuation">:</span>//gateway<span class="token punctuation">:</span><span class="token number">3100</span>  <span class="token comment"># 通过NG网关访问</span>
            <span class="token key atrule">jsonData</span><span class="token punctuation">:</span>
              <span class="token key atrule">httpHeaderName1</span><span class="token punctuation">:</span> <span class="token string">"X-Scope-OrgID"</span>  <span class="token comment"># # 多租户头部名称</span>
            <span class="token key atrule">secureJsonData</span><span class="token punctuation">:</span>
              <span class="token key atrule">httpHeaderValue1</span><span class="token punctuation">:</span> <span class="token string">"tenant1"</span>  <span class="token comment"># 租户ID</span>
        EOF
        /run.sh
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token number">3000</span>    <span class="token comment"># Web访问端口</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span> <span class="token comment"># 依赖网关服务</span>
      <span class="token punctuation">-</span> gateway
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> loki

  <span class="token comment"># ========================</span>
  <span class="token comment"># API网关（流量路由）</span>
  <span class="token comment"># ========================</span>
  <span class="token key atrule">gateway</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>latest
    <span class="token comment"># 容器名</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> nginx
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/alg/nginx.conf<span class="token punctuation">:</span>/etc/nginx/nginx.conf
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> 3000<span class="token punctuation">:</span><span class="token number">3000</span>	<span class="token comment"># Grafana UI</span>
      <span class="token punctuation">-</span> 3100<span class="token punctuation">:</span><span class="token number">3100</span>   <span class="token comment"># Loki统一入口端口</span>
      <span class="token punctuation">-</span> 3101<span class="token punctuation">:</span><span class="token number">3101</span>   <span class="token comment"># read 端点</span>
      <span class="token punctuation">-</span> 3102<span class="token punctuation">:</span><span class="token number">3102</span>   <span class="token comment"># write 端点</span>
      <span class="token punctuation">-</span> 9001<span class="token punctuation">:</span><span class="token number">9001</span>   <span class="token comment"># Minio UI</span>
      <span class="token punctuation">-</span> 12345<span class="token punctuation">:</span><span class="token number">12345</span> <span class="token comment"># Alloy UI</span>
    <span class="token key atrule">healthcheck</span><span class="token punctuation">:</span> <span class="token comment"># 健康检查策略</span>
      <span class="token key atrule">test</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"CMD"</span><span class="token punctuation">,</span> 
        <span class="token string">"service"</span><span class="token punctuation">,</span> 
        <span class="token string">"nginx"</span><span class="token punctuation">,</span> 
        <span class="token string">"status"</span><span class="token punctuation">]</span>
      <span class="token key atrule">interval</span><span class="token punctuation">:</span> 10s
      <span class="token key atrule">timeout</span><span class="token punctuation">:</span> 5s
      <span class="token key atrule">retries</span><span class="token punctuation">:</span> <span class="token number">5</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> read
      <span class="token punctuation">-</span> write
      <span class="token punctuation">-</span> alloy
    <span class="token key atrule">networks</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> loki
</code></pre>
    <blockquote>
     <p>
      ALG相关访问路径
     </p>
    </blockquote>
    <pre><code class="prism language-tex">
</code></pre>
    <p>
     启动ALG
    </p>
    <p>
     <img alt="image-20250306154436045" src="https://i-blog.csdnimg.cn/img_convert/4e6bfb397e5f07f5c6136a8805d6808a.png"/>
    </p>
    <p>
     Grafana UI
    </p>
    <ul>
     <li>
      <p>
       访问地址(这里换成你自己的IP): http://192.168.132.10:3000
      </p>
     </li>
     <li>
      <p>
       账号: admin
      </p>
     </li>
     <li>
      <p>
       密码: admin
      </p>
     </li>
    </ul>
    <p>
     <img alt="image-20250306155441031" src="https://i-blog.csdnimg.cn/img_convert/596713410a9ccffe8470f6f8a9515501.png"/>
    </p>
    <p>
     Minio UI
    </p>
    <ul>
     <li>
      访问地址(这里换成你自己的IP): http://192.168.132.10:9001
     </li>
     <li>
      账号: whiteBrocade
     </li>
     <li>
      密码: whiteBrocade
     </li>
    </ul>
    <p>
     <img alt="image-20250306155533136" src="https://i-blog.csdnimg.cn/img_convert/4443424fbe11555c7b7cdc82bf578a46.png"/>
    </p>
    <p>
     Grafana Alloy UI
    </p>
    <ul>
     <li>
      访问地址(这里换成你自己的IP): http://192.168.132.10:12345
     </li>
    </ul>
    <p>
     <img alt="image-20250306155931033" src="https://i-blog.csdnimg.cn/img_convert/13010b8e4a8b48da6795151a7d823e13.png"/>
    </p>
    <p>
     Loki Read/Write组件
    </p>
    <ul>
     <li>
      Read访问地址(这里换成你自己的IP): http://192.168.132.10:3101
     </li>
     <li>
      Write访问地址(这里换成你自己的IP): http://192.168.132.10:3102
     </li>
    </ul>
    <p>
     <img alt="image-20250306160337569" src="https://i-blog.csdnimg.cn/img_convert/ade27b808d4fbb9948bef399c98295f3.png"/>
    </p>
    <h5>
     <a id="Flog_663">
     </a>
     Flog
    </h5>
    <blockquote>
     <p>
      使用flog生成日志, 模拟三种情况
     </p>
     <ul>
      <li>
       Docker容器日志
      </li>
      <li>
       本地*.log日志
      </li>
      <li>
       本地*.log.gz
      </li>
     </ul>
    </blockquote>
    <pre><code class="prism language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.8"</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token comment"># ========================</span>
  <span class="token comment"># log 是一个由 mingrammer 开发的开源项目，主要用于生成常见的日志格式，如 Apache 通用日志、Apache 错误日志和 RFC3164 系统日志</span>
  <span class="token comment"># 日志会输出到 容器内部的标准输出(stdout)</span>
  <span class="token comment"># ========================</span>
  <span class="token key atrule">flog-stdout</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mingrammer/flog<span class="token punctuation">:</span>latest
    <span class="token comment"># 容器名</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> flog<span class="token punctuation">-</span>stdout
    <span class="token comment"># -f json:日志格式, 这里指定为json</span>
    <span class="token comment"># -d 200ms: 日志产生的速度</span>
    <span class="token comment"># -t stdout: 输出类型为标准输出</span>
    <span class="token comment"># -l: 无限循环生成日志</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">-</span>f json <span class="token punctuation">-</span>d 200ms <span class="token punctuation">-</span>t stdout <span class="token punctuation">-</span>l
  <span class="token comment"># 这里的日志持久化, 用于应用程序产生的*.log日志以及压缩日志</span>
  <span class="token key atrule">flog-log</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mingrammer/flog<span class="token punctuation">:</span>latest
    <span class="token comment"># 容器名</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> flog<span class="token punctuation">-</span>log
    <span class="token comment"># -f json:日志格式, 这里指定为json</span>
    <span class="token comment"># -d 200ms: 日志产生的速度</span>
    <span class="token comment"># -t log: s输出类型为log日志</span>
    <span class="token comment"># -l: 无限循环生成日志</span>
    <span class="token comment"># -w: 覆盖已存在的日志文件</span>
    <span class="token comment"># -o /data/logs/test.log: 将日志输出到文件中</span>
    <span class="token comment"># -p 1048576: 当日志文件达到1MB的时候就会分割日志</span>
    <span class="token comment"># -b 10485760 该路径下/data/logs/*.log最多生成10MB</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">-</span>f json <span class="token punctuation">-</span>d 200ms <span class="token punctuation">-</span>l <span class="token punctuation">-</span>t log <span class="token punctuation">-</span>w <span class="token punctuation">-</span>o /data/logs/test.log <span class="token punctuation">-</span>p 1048576 <span class="token punctuation">-</span>b 10485760
    <span class="token comment"># 将日志映射到宿主机上, 模拟非容器环境部署程序产生的日志文件</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/alg/flog/logs/log<span class="token punctuation">:</span>/data/logs
  <span class="token key atrule">flog-gz</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> mingrammer/flog<span class="token punctuation">:</span>latest
    <span class="token comment"># 容器名</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> flog<span class="token punctuation">-</span>gz
    <span class="token comment"># -f json:日志格式, 这里指定为json</span>
    <span class="token comment"># -t gz: 输出类型为gzip文件</span>
    <span class="token comment"># -l: 无限循环生成日志</span>
    <span class="token comment"># -w: 覆盖已存在的日志文件</span>
    <span class="token comment"># -o /data/logs/test.log.gz: 将日志输出到test.log.gz</span>
    <span class="token comment"># -p 1048576: 当日志文件达到1MB的时候就会分割日志</span>
    <span class="token comment"># -b 10485760 该路径下/data/logs/*.gz最多生成10MB</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">-</span>f json <span class="token punctuation">-</span>l <span class="token punctuation">-</span>t gz <span class="token punctuation">-</span>w <span class="token punctuation">-</span>o /data/logs/test.log.gz <span class="token punctuation">-</span>p 1048576 <span class="token punctuation">-</span>b 10485760
    <span class="token comment"># 将日志映射到宿主机上, 模拟非容器环境部署程序产生的日志文件</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> /data/alg/flog/logs/gz<span class="token punctuation">:</span>/data/logs
</code></pre>
    <p>
     启动Flog容器, 如下图
    </p>
    <p>
     <img alt="image-20250306154948134" src="https://i-blog.csdnimg.cn/img_convert/5eb805032451c5362d9f9609461ce2db.png"/>
    </p>
    <h4>
     <a id="_731">
     </a>
     效果
    </h4>
    <h5>
     <a id="_733">
     </a>
     容器日志查看
    </h5>
    <p>
     访问http://192.168.132.10:3000的Grafana面板, 选择Expore, 查看Nginx容器的日志
    </p>
    <p>
     <img alt="image-20250306154730631" src="https://i-blog.csdnimg.cn/img_convert/a6d1b3bce9e9ddf561f8dc7e44c26861.png"/>
    </p>
    <p>
     日志如下
    </p>
    <p>
     <img alt="image-20250306154836987" src="https://i-blog.csdnimg.cn/img_convert/599a4a99e1ad9a4f1617192ea6192048.png"/>
    </p>
    <h5>
     <a id="logloggz_745">
     </a>
     log日志和log.gz日志查看
    </h5>
    <p>
     访问http://192.168.132.10:3000, 通过filename标签(这个标签是alloy内置自动添加的)查看log日志
    </p>
    <p>
     <img alt="image-20250306155035916" src="https://i-blog.csdnimg.cn/img_convert/5f7abc5d41ff507dd8e139deb17a2f58.png"/>
    </p>
    <p>
     查看gz格式的压缩日志
    </p>
    <p>
     <img alt="image-20250306155154219" src="https://i-blog.csdnimg.cn/img_convert/4ef394d725b7fc6887d925bd823acb80.png"/>
    </p>
    <h3>
     <a id="AlloyNode_Exporter_759">
     </a>
     Alloy代替Node Exporter方式采集主机信息
    </h3>
    <p>
     alloy除了可以用于收集日志, 还可以采集主机信息, 发送给Prome
    </p>
    <h2>
     <a id="_765">
     </a>
     参考资料
    </h2>
    <h3>
     <a id="ALG_767">
     </a>
     ALG
    </h3>
    <h3>
     <a id="_769">
     </a>
     博客
    </h3>
    <p>
     <a href="https://ewhisper.cn/posts/13947/" rel="nofollow">
      Grafana 系列文章（一）：基于 Grafana 的全栈可观察性 Demo
     </a>
    </p>
    <p>
     <a href="https://ewhisper.cn/posts/61512/" rel="nofollow">
      Grafana Loki 简要指南：关于标签您需要了解的一切
     </a>
    </p>
    <p>
     <a href="https://ewhisper.cn/posts/50848/" rel="nofollow">
      开源日志监控：Grafana Loki 简要指南
     </a>
    </p>
    <p>
     <a href="https://www.cnblogs.com/jingzh/p/17998082" rel="nofollow">
      日志之Loki详细讲解
     </a>
    </p>
    <p>
     <a href="https://www.cnblogs.com/hahaha111122222/p/16407640.html" rel="nofollow">
      使用读写分离模式扩展 Grafana Loki
     </a>
     <br/>
     <a href="https://grafana.org.cn/docs/loki/latest/get-started/deployment-modes/" rel="nofollow">
      Loki部署模式
     </a>
     <br/>
     <a href="https://www.oomkill.com/2024/grafana-loki-2-9/" rel="nofollow">
      grafana loki的理解与配置(2.9)
     </a>
     <br/>
     <a href="https://blog.csdn.net/qq_41193586/article/details/143159219">
      轻量级日志系统docker-compose搭建Loki+Grafana+Promtail，配置、部署，查询全流程
     </a>
     <br/>
     <a href="https://www.yuque.com/leifengyang/live/zoooekqgpgppgkfi" rel="nofollow">
      轻量级日志系统-Loki
     </a>
    </p>
    <p>
     <a href="https://www.cnblogs.com/corianderfiend/articles/18696225" rel="nofollow">
      轻量级日志系统笔记ALG
     </a>
    </p>
    <p>
     <a href="https://blog.csdn.net/gitblog_01120/article/details/143914991">
      开源项目推荐：flog
     </a>
     <br/>
     <a href="https://www.jianshu.com/p/533f9a25e91d" rel="nofollow">
      推荐一个小工具：flog
     </a>
     <br/>
     <a href="https://blog.csdn.net/gitblog_00020/article/details/137581902">
      探索Flog：伪装日志流量的神器
     </a>
     <br/>
     <a href="https://gitcode.com/gh_mirrors/fl/flog/?utm_source=artical_gitcode&amp;index=top&amp;type=card&amp;webUrl">
      gitcode的flog项目
     </a>
    </p>
    <p>
     <a href="https://blog.csdn.net/m0_70878103/article/details/144554450">
      Docker 环境中配置 Grafana：详细教程与常见配置项解析
     </a>
    </p>
    <p>
     <a href="https://blog.csdn.net/qq_36522346/article/details/133761021">
      项目集成grafana,并用非root用户启动
     </a>
    </p>
    <p>
     <a href="https://itaken.github.io/2021/1/21/docker%E9%85%8D%E7%BD%AEgrafana%E9%81%87%E5%88%B0%E7%9A%84%E4%B8%80%E4%B8%AA%E5%9D%91/" rel="nofollow">
      在docker-compose启动grafana,出现权限错误的解决方案
     </a>
    </p>
    <p>
     <a href="https://cloud.tencent.com/developer/ask/sof/749733" rel="nofollow">
      Docker上的Grafana 7.3.0存在权限问题
     </a>
    </p>
    <p>
     <a href="https://blog.51cto.com/u_16099301/10327703" rel="nofollow">
      grafana重启后模板没有数据了 grafana新建dashboard
     </a>
    </p>
    <p>
     <a href="https://blog.csdn.net/wayne_primes/article/details/112467639">
      Docker安装grafana数据持久化+配置SMTP
     </a>
    </p>
    <p>
     <a href="https://blog.csdn.net/weixin_40141628/article/details/140924757">
      springboot+Loki+Loki4j+Grafana搭建轻量级日志系统
     </a>
    </p>
    <h3>
     <a id="_806">
     </a>
     视频
    </h3>
    <p>
     <a href="https://www.bilibili.com/video/BV11Q2VYBEUt/?spm_id_from=333.337.search-card.all.click" rel="nofollow">
      【IT老齐636】Grafana Loki vs ELK
     </a>
    </p>
    <p>
     <a href="https://www.bilibili.com/video/BV1wtP7epEDq?spm_id_from=333.788.videopod.sections&amp;vd_source=036963fc62928d35d006417a891c490c" rel="nofollow">
      【IT老齐710】Grafana ALG分布式日志收集架构
     </a>
    </p>
    <p>
     <a href="https://www.bilibili.com/video/BV1vP9gYbEh6?spm_id_from=333.788.videopod.sections&amp;vd_source=036963fc62928d35d006417a891c490c" rel="nofollow">
      【IT老齐711】ALG收集Docker所有实例运行日志
     </a>
    </p>
    <p>
     <a href="https://www.bilibili.com/video/BV1eoyVY7Eag/?spm_id_from=333.337.search-card.all.click" rel="nofollow">
      Grafana+Loki+Alloy快速构建企业日志系统
     </a>
    </p>
    <p>
     <a href="https://www.bilibili.com/video/BV1nY4y137nv/?spm_id_from=333.337.search-card.all.click" rel="nofollow">
      k8s + loki 日志解决方案 (持续更新中)
     </a>
    </p>
    <p>
     <a href="https://www.bilibili.com/video/BV1gc41137Bf/?spm_id_from=333.1387.upload.video_card.click" rel="nofollow">
      Loki日志系统-安装、使用、告警
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f35313931383732322f:61727469636c652f64657461696c732f313436303736353135" class_="artid" style="display:none">
 </p>
</div>


