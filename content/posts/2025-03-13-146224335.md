---
layout: post
title: "FFmpeg处理流程"
date: 2025-03-13 10:54:35 +0800
description: "作用：管理媒体文件的封装格式上下文，存储文件格式、流信息、I/O 操作等元数据。关键字段。"
keywords: "FFmpeg处理流程"
categories: ['音视频开发']
tags: ['Ffmpeg']
artid: "146224335"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146224335
    alt: "FFmpeg处理流程"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146224335
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146224335
cover: https://bing.ee123.net/img/rand?artid=146224335
image: https://bing.ee123.net/img/rand?artid=146224335
img: https://bing.ee123.net/img/rand?artid=146224335
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     FFmpeg处理流程
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     结构体
    </h2>
    <h3>
     <a id="AVFormatContext_1">
     </a>
     AVFormatContext
    </h3>
    <p>
     作用：管理媒体文件的封装格式上下文，存储文件格式、流信息、I/O 操作等元数据。
     <br/>
     关键字段
    </p>
    <pre><code class="prism language-cpp">AVInputFormat <span class="token operator">*</span>iformat<span class="token punctuation">;</span>   <span class="token comment">// 输入格式（如MP4、FLV）</span>
AVStream <span class="token operator">*</span><span class="token operator">*</span>streams<span class="token punctuation">;</span>       <span class="token comment">// 音视频流数组</span>
<span class="token keyword">int</span> nb_streams<span class="token punctuation">;</span>           <span class="token comment">// 流数量</span>
<span class="token keyword">int64_t</span> duration<span class="token punctuation">;</span>         <span class="token comment">// 总时长（微秒）</span>
</code></pre>
    <p>
     初始化：
     <code>
      avformat_alloc_context()
     </code>
     ，
     <code>
      avformat_open_input()
     </code>
    </p>
    <h3>
     <a id="AVStream_11">
     </a>
     AVStream
    </h3>
    <p>
     作用：表示单个音视频流，包含编解码参数和时间基准。
     <br/>
     关键字段：
    </p>
    <pre><code class="prism language-cpp">AVCodecParameters <span class="token operator">*</span>codecpar<span class="token punctuation">;</span>  <span class="token comment">// 编解码参数（如分辨率、采样率）</span>
AVRational time_base<span class="token punctuation">;</span>         <span class="token comment">// 时间基（如1/30表示30fps）</span>
</code></pre>
    <p>
     初始化：
     <code>
      avformat_new_stream()
     </code>
    </p>
    <h3>
     <a id="AVCodec_19">
     </a>
     AVCodec
    </h3>
    <h3>
     <a id="AVCodecContext_20">
     </a>
     AVCodecContext
    </h3>
    <p>
     作用：编解码器上下文，存储编解码参数（如码率、帧率、像素格式）。
     <br/>
     关键字段：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">enum</span> <span class="token class-name">AVCodecID</span> codec_id<span class="token punctuation">;</span>      <span class="token comment">// 编解码器ID（如H.264、AAC）</span>
<span class="token keyword">int</span> width<span class="token punctuation">,</span> height<span class="token punctuation">;</span>            <span class="token comment">// 视频分辨率</span>
<span class="token keyword">enum</span> <span class="token class-name">AVPixelFormat</span> pix_fmt<span class="token punctuation">;</span>   <span class="token comment">// 像素格式（如YUV420P）</span>
AVRational time_base<span class="token punctuation">;</span>         <span class="token comment">// 编码器时间基</span>
</code></pre>
    <p>
     初始化：avcodec_alloc_context3()，avcodec_parameters_to_context()
    </p>
    <h3>
     <a id="AVPacket_30">
     </a>
     AVPacket
    </h3>
    <p>
     作用：存储编码后的压缩数据（如H.264数据包）。
     <br/>
     关键字段：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>       <span class="token comment">// 压缩数据指针</span>
<span class="token keyword">int</span> size<span class="token punctuation">;</span>            <span class="token comment">// 数据大小</span>
<span class="token keyword">int64_t</span> pts<span class="token punctuation">,</span> dts<span class="token punctuation">;</span>    <span class="token comment">// 显示和解码时间戳</span>
</code></pre>
    <p>
     初始化：
     <code>
      av_packet_alloc()
     </code>
     ，
     <code>
      av_packet_unref()
     </code>
    </p>
    <h3>
     <a id="AVFrame_39">
     </a>
     AVFrame
    </h3>
    <p>
     作用：存储解码后的原始数据（如YUV像素数据或PCM音频样本）。
     <br/>
     关键字段：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">uint8_t</span> <span class="token operator">*</span>data<span class="token punctuation">[</span>AV_NUM_DATA_POINTERS<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 数据指针（如Y、U、V分量）</span>
<span class="token keyword">int</span> linesize<span class="token punctuation">[</span>AV_NUM_DATA_POINTERS<span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// 每行字节数</span>
<span class="token keyword">int</span> width<span class="token punctuation">,</span> height<span class="token punctuation">;</span>                    <span class="token comment">// 视频分辨率</span>
</code></pre>
    <p>
     初始化：
     <code>
      av_frame_alloc()
     </code>
     ，
     <code>
      av_frame_free()
     </code>
    </p>
    <h3>
     <a id="SwsContext_48">
     </a>
     SwsContext
    </h3>
    <p>
     作用：图像格式转换上下文（如YUV转RGB）。
     <br/>
     初始化：
     <code>
      sws_getContext()
     </code>
     ，销毁：
     <code>
      sws_freeContext()
     </code>
    </p>
    <h3>
     <a id="SwrContext_51">
     </a>
     SwrContext
    </h3>
    <p>
     作用：音频重采样上下文（如48kHz转44.1kHz）。
     <br/>
     初始化：
     <code>
      swr_alloc_set_opts()
     </code>
     ，销毁：
     <code>
      swr_free()
     </code>
    </p>
    <h2>
     <a id="API_55">
     </a>
     API
    </h2>
    <p>
     avformat_open_input
     <br/>
     avformat_find_stream_info
     <br/>
     av_find_best_stream
     <br/>
     avcodec_alloc_context3
     <br/>
     avcodec_parameters_to_context
     <br/>
     avcodec_open2
     <br/>
     avcodec_find_encoder
     <br/>
     av_opt_set_int
    </p>
    <p>
     sws_getContext
     <br/>
     avformat_alloc_output_context2
     <br/>
     avformat_new_stream
     <br/>
     avcodec_parameters_from_context
     <br/>
     avio_open
     <br/>
     avformat_write_header
     <br/>
     av_frame_alloc
     <br/>
     av_frame_get_buffer
     <br/>
     av_packet_alloc
    </p>
    <p>
     av_read_frame
     <br/>
     avcodec_send_packet
     <br/>
     avcodec_receive_frame
     <br/>
     sws_scale
     <br/>
     av_rescale_q
     <br/>
     avcodec_send_frame
     <br/>
     avcodec_receive_packet
     <br/>
     av_packet_rescale_ts
     <br/>
     av_interleaved_write_frame
     <br/>
     av_packet_unref
     <br/>
     av_write_trailer
    </p>
    <h2>
     <a id="_86">
     </a>
     例子
    </h2>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

<span class="token comment">// 使用 RAII 管理指针（可选，但推荐）</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token punctuation">,</span> <span class="token keyword">void</span><span class="token punctuation">(</span><span class="token operator">*</span>Deleter<span class="token punctuation">)</span><span class="token punctuation">(</span>T<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">FFmpegResource</span> <span class="token punctuation">{<!-- --></span>
    T<span class="token operator">*</span> ptr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token function">FFmpegResource</span><span class="token punctuation">(</span>T<span class="token operator">*</span> p <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ptr</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">FFmpegResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ptr<span class="token punctuation">)</span> <span class="token function">Deleter</span><span class="token punctuation">(</span>ptr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">using</span> AVFormatContextPtr <span class="token operator">=</span> FFmpegResource<span class="token operator">&lt;</span>AVFormatContext<span class="token punctuation">,</span> avformat_close_input<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> AVCodecContextPtr <span class="token operator">=</span> FFmpegResource<span class="token operator">&lt;</span>AVCodecContext<span class="token punctuation">,</span> avcodec_free_context<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> SwsContextPtr <span class="token operator">=</span> FFmpegResource<span class="token operator">&lt;</span>SwsContext<span class="token punctuation">,</span> sws_freeContext<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> AVFramePtr <span class="token operator">=</span> FFmpegResource<span class="token operator">&lt;</span>AVFrame<span class="token punctuation">,</span> av_frame_free<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> AVPacketPtr <span class="token operator">=</span> FFmpegResource<span class="token operator">&lt;</span>AVPacket<span class="token punctuation">,</span> av_packet_free<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    AVFormatContext <span class="token operator">*</span>srcCtx <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    AVCodecContext <span class="token operator">*</span>srcDecCtx <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">*</span>encCtx <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    SwsContext <span class="token operator">*</span>swsCtx <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    AVFrame <span class="token operator">*</span>decFrame <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token operator">*</span>encFrame <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    AVPacket <span class="token operator">*</span>pkt <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    AVFormatContext <span class="token operator">*</span>outputCtx <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 错误处理标签</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">CHECK_ERROR</span><span class="token expression"><span class="token punctuation">(</span>cond<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> cleanup_label<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cond<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> </span><span class="token punctuation">\</span>
            <span class="token expression">std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>msg<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> </span><span class="token string">": "</span> <span class="token expression"><span class="token operator">&lt;&lt;</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token keyword">goto</span> cleanup_label<span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">}</span></span></span>

    <span class="token comment">// ============ 打开输入文件 ============</span>
    ret <span class="token operator">=</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>srcCtx<span class="token punctuation">,</span> srcPath<span class="token punctuation">.</span><span class="token function">toStdString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"打开视频文件失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">avformat_find_stream_info</span><span class="token punctuation">(</span>srcCtx<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"获取视频流信息失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ============ 初始化视频解码器 ============</span>
    <span class="token keyword">const</span> AVCodec <span class="token operator">*</span>srcDec <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> streamIndex <span class="token operator">=</span> <span class="token function">av_find_best_stream</span><span class="token punctuation">(</span>srcCtx<span class="token punctuation">,</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>srcDec<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span>streamIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"查找视频流失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    srcDecCtx <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span>srcDec<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span><span class="token operator">!</span>srcDecCtx<span class="token punctuation">,</span> <span class="token string">"分配解码器上下文失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">avcodec_parameters_to_context</span><span class="token punctuation">(</span>srcDecCtx<span class="token punctuation">,</span> srcCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>streamIndex<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"拷贝解码器参数失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">avcodec_open2</span><span class="token punctuation">(</span>srcDecCtx<span class="token punctuation">,</span> srcDec<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"打开解码器失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ============ 初始化视频编码器 ============</span>
    <span class="token keyword">const</span> AVCodec <span class="token operator">*</span>srcEnc <span class="token operator">=</span> <span class="token function">avcodec_find_encoder</span><span class="token punctuation">(</span>srcCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>streamIndex<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>codec_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span><span class="token operator">!</span>srcEnc<span class="token punctuation">,</span> <span class="token string">"查找编码器失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    encCtx <span class="token operator">=</span> <span class="token function">avcodec_alloc_context3</span><span class="token punctuation">(</span>srcEnc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span><span class="token operator">!</span>encCtx<span class="token punctuation">,</span> <span class="token string">"分配编码器上下文失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 配置编码参数</span>
    encCtx<span class="token operator">-&gt;</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
    encCtx<span class="token operator">-&gt;</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
    encCtx<span class="token operator">-&gt;</span>pix_fmt <span class="token operator">=</span> AV_PIX_FMT_YUV420P<span class="token punctuation">;</span>
    encCtx<span class="token operator">-&gt;</span>time_base <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    encCtx<span class="token operator">-&gt;</span>gop_size <span class="token operator">=</span> <span class="token number">12</span><span class="token punctuation">;</span>
<span class="token comment">//    encCtx-&gt;bit_rate = 4000000; 不设置码率</span>

    encCtx<span class="token operator">-&gt;</span>profile <span class="token operator">=</span> FF_PROFILE_H264_HIGH<span class="token punctuation">;</span>
    encCtx<span class="token operator">-&gt;</span>level <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>
    encCtx<span class="token operator">-&gt;</span>max_b_frames <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    encCtx<span class="token operator">-&gt;</span>color_range <span class="token operator">=</span> AVCOL_RANGE_MPEG<span class="token punctuation">;</span> <span class="token comment">// 颜色范围（tv）</span>
    encCtx<span class="token operator">-&gt;</span>color_primaries <span class="token operator">=</span> AVCOL_PRI_BT709<span class="token punctuation">;</span> <span class="token comment">// 颜色标准</span>
    encCtx<span class="token operator">-&gt;</span>color_trc <span class="token operator">=</span> AVCOL_TRC_BT709<span class="token punctuation">;</span>  <span class="token comment">// 颜色传输特性</span>
    encCtx<span class="token operator">-&gt;</span>colorspace <span class="token operator">=</span> AVCOL_SPC_BT709<span class="token punctuation">;</span> <span class="token comment">// 颜色空间</span>

    <span class="token comment">// 设置CRF模式与参数调整</span>
    encCtx<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> AV_CODEC_FLAG_QSCALE<span class="token punctuation">;</span><span class="token comment">// 启用量化参数控制</span>
    <span class="token function">av_opt_set_int</span><span class="token punctuation">(</span>encCtx<span class="token operator">-&gt;</span>priv_data<span class="token punctuation">,</span> <span class="token string">"crf"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> AV_OPT_SEARCH_CHILDREN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 0-51，18为视觉无损</span>

    <span class="token function">av_opt_set</span><span class="token punctuation">(</span>encCtx<span class="token operator">-&gt;</span>priv_data<span class="token punctuation">,</span> <span class="token string">"preset"</span><span class="token punctuation">,</span> <span class="token string">"veryslow"</span><span class="token punctuation">,</span> AV_OPT_SEARCH_CHILDREN<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 牺牲时间换取质量</span>
<span class="token comment">//    av_opt_set(encCtx-&gt;priv_data, "tune", "film", AV_OPT_SEARCH_CHILDREN);  // 电影类用film，动画用animation</span>


    ret <span class="token operator">=</span> <span class="token function">avcodec_open2</span><span class="token punctuation">(</span>encCtx<span class="token punctuation">,</span> srcEnc<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"打开编码器失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ============ 创建缩放上下文 ============</span>
    swsCtx <span class="token operator">=</span> <span class="token function">sws_getContext</span><span class="token punctuation">(</span><span class="token comment">/* 参数保持原逻辑 */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span><span class="token operator">!</span>swsCtx<span class="token punctuation">,</span> <span class="token string">"创建缩放上下文失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ============ 准备输出文件 ============</span>
    ret <span class="token operator">=</span> <span class="token function">avformat_alloc_output_context2</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>outputCtx<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> destPath<span class="token punctuation">.</span><span class="token function">toStdString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"创建输出上下文失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    AVStream <span class="token operator">*</span>outStream <span class="token operator">=</span> <span class="token function">avformat_new_stream</span><span class="token punctuation">(</span>outputCtx<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span><span class="token operator">!</span>outStream<span class="token punctuation">,</span> <span class="token string">"创建输出流失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">avcodec_parameters_from_context</span><span class="token punctuation">(</span>outStream<span class="token operator">-&gt;</span>codecpar<span class="token punctuation">,</span> encCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"拷贝编码器参数到输出流失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 显式设置输出流时间基与编码器一致 </span>
    outStream<span class="token operator">-&gt;</span>time_base <span class="token operator">=</span> encCtx<span class="token operator">-&gt;</span>time_base<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>outputCtx<span class="token operator">-&gt;</span>oformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_NOFILE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">avio_open</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>outputCtx<span class="token operator">-&gt;</span>pb<span class="token punctuation">,</span> destPath<span class="token punctuation">.</span><span class="token function">toStdString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> AVIO_FLAG_WRITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"打开输出文件失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">avformat_write_header</span><span class="token punctuation">(</span>outputCtx<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"写入文件头失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// ============ 帧处理循环 ============</span>
    decFrame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    encFrame <span class="token operator">=</span> <span class="token function">av_frame_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pkt <span class="token operator">=</span> <span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span><span class="token operator">!</span>decFrame <span class="token operator">||</span> <span class="token operator">!</span>encFrame <span class="token operator">||</span> <span class="token operator">!</span>pkt<span class="token punctuation">,</span> <span class="token string">"分配帧/包失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">av_read_frame</span><span class="token punctuation">(</span>srcCtx<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>stream_index <span class="token operator">!=</span> streamIndex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

         <span class="token comment">// 解码</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">avcodec_send_packet</span><span class="token punctuation">(</span>srcDecCtx<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"读取包失败: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">avcodec_receive_frame</span><span class="token punctuation">(</span>srcDecCtx<span class="token punctuation">,</span> decFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span> <span class="token operator">||</span> ret <span class="token operator">==</span> AVERROR_EOF<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"读取帧失败: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"解码帧 pts: "</span> <span class="token operator">&lt;&lt;</span> decFrame<span class="token operator">-&gt;</span>pts <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

            <span class="token comment">// 缩放</span>
            <span class="token function">sws_scale</span><span class="token punctuation">(</span>swsCtx<span class="token punctuation">,</span> decFrame<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> decFrame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">,</span>
                      <span class="token number">0</span><span class="token punctuation">,</span> srcDecCtx<span class="token operator">-&gt;</span>height<span class="token punctuation">,</span> encFrame<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> encFrame<span class="token operator">-&gt;</span>linesize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            encFrame<span class="token operator">-&gt;</span>pts <span class="token operator">=</span> <span class="token function">av_rescale_q</span><span class="token punctuation">(</span>decFrame<span class="token operator">-&gt;</span>pts<span class="token punctuation">,</span> srcCtx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>streamIndex<span class="token punctuation">]</span><span class="token operator">-&gt;</span>time_base<span class="token punctuation">,</span> encCtx<span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 编码</span>
            AVPacket <span class="token operator">*</span>encPkt <span class="token operator">=</span> <span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">avcodec_send_frame</span><span class="token punctuation">(</span>encCtx<span class="token punctuation">,</span> encFrame<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"发送帧到编码器失败: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ret <span class="token operator">=</span> <span class="token function">avcodec_receive_packet</span><span class="token punctuation">(</span>encCtx<span class="token punctuation">,</span> encPkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EAGAIN<span class="token punctuation">)</span> <span class="token operator">||</span> ret <span class="token operator">==</span> AVERROR_EOF<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"编码器输出包失败: "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">av_err2str</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">// 写入输出文件</span>
                <span class="token function">av_packet_rescale_ts</span><span class="token punctuation">(</span>encPkt<span class="token punctuation">,</span> encCtx<span class="token operator">-&gt;</span>time_base<span class="token punctuation">,</span> outStream<span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"编码: "</span> <span class="token operator">&lt;&lt;</span> encPkt<span class="token operator">-&gt;</span>pts <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token function">av_interleaved_write_frame</span><span class="token punctuation">(</span>outputCtx<span class="token punctuation">,</span> encPkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>encPkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ============ 刷新编码器缓冲区  ============</span>
    <span class="token function">avcodec_send_frame</span><span class="token punctuation">(</span>encCtx<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 发送空帧刷新</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        AVPacket encPkt<span class="token punctuation">;</span>
        <span class="token function">av_init_packet</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>encPkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">avcodec_receive_packet</span><span class="token punctuation">(</span>encCtx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>encPkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> AVERROR_EOF <span class="token operator">||</span> ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token function">av_packet_rescale_ts</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>encPkt<span class="token punctuation">,</span> encCtx<span class="token operator">-&gt;</span>time_base<span class="token punctuation">,</span> outStream<span class="token operator">-&gt;</span>time_base<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">av_interleaved_write_frame</span><span class="token punctuation">(</span>outputCtx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>encPkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">av_packet_unref</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>encPkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ============ 写入文件尾 ============</span>
    ret <span class="token operator">=</span> <span class="token function">av_write_trailer</span><span class="token punctuation">(</span>outputCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECK_ERROR</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"写入文件尾失败"</span><span class="token punctuation">,</span> cleanup<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ============ 资源释放 ============</span>
cleanup<span class="token operator">:</span>
    <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>srcCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">avcodec_free_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>srcDecCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">avcodec_free_context</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>encCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sws_freeContext</span><span class="token punctuation">(</span>swsCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>decFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_frame_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>encFrame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_packet_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>outputCtx <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>outputCtx<span class="token operator">-&gt;</span>oformat<span class="token operator">-&gt;</span>flags <span class="token operator">&amp;</span> AVFMT_NOFILE<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">avio_closep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>outputCtx<span class="token operator">-&gt;</span>pb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">avformat_free_context</span><span class="token punctuation">(</span>outputCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f75707365745f706f6f722f:61727469636c652f64657461696c732f313436323234333335" class_="artid" style="display:none">
 </p>
</div>


