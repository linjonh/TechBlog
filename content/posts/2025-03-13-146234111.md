---
layout: post
title: "基于ESP32的桌面小屏幕实战8任务创建"
date: 2025-03-13 16:09:56 +0800
description: "任务创建成功后，调度器会根据任务的优先级和时间片分配 CPU 时间，运行 test_task_example 函数中的代码。此处为 NULL，表示不需要任务句柄，如果需要在其他地方引用或管理此任务，可以传入指向句柄的指针，例如 TaskHandle_t 类型的变量地址。：任务名称，是一个字符串标识符，用于在调试时识别任务。：指向任务函数的指针，也就是任务的入口函数。：任务函数的输入参数，这里传递的是 NULL。是 FreeRTOS 提供的一个延迟函数，使任务进入阻塞状态，等待指定的时间后再继续执行。"
keywords: "基于ESP32的桌面小屏幕实战[8]：任务创建"
categories: ['未分类']
tags: ['物联网', 'Esp']
artid: "146234111"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146234111
    alt: "基于ESP32的桌面小屏幕实战8任务创建"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146234111
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146234111
cover: https://bing.ee123.net/img/rand?artid=146234111
image: https://bing.ee123.net/img/rand?artid=146234111
img: https://bing.ee123.net/img/rand?artid=146234111
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     基于ESP32的桌面小屏幕实战[8]：任务创建
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     调用任务创建必须要添加下面两个头文件：
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"freertos/FreeRTOS.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"freertos/task.h"</span></span>
</code></pre>
    <p>
     还要定义一个静态的任务函数
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test_task_example</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">vTaskDelay</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">/</span> portTICK_PERIOD_MS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"task run \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     创建成功后，每秒打印一个数据。
     <code>
      for(;;)
     </code>
     表示一个无限循环，
     <code>
      for(;;)
     </code>
     等效于
     <code>
      while(1)
     </code>
     。任务函数一般是无限循环的，以便系统调度器能够持续执行它们，除非有特殊情况终止。
     <code>
      vTaskDelay
     </code>
     是 FreeRTOS 提供的一个延迟函数，使任务进入阻塞状态，等待指定的时间后再继续执行。
     <br/>
     <code>
      1000 / portTICK_PERIOD_MS
     </code>
     将延迟时间设为 1000 毫秒（即 1 秒）。
     <code>
      portTICK_PERIOD_MS
     </code>
     是一个系统常量，用于将毫秒转换为系统时钟周期数，以适配不同的时钟速率。
    </p>
    <p>
     在主函数中创建任务
    </p>
    <pre><code class="prism language-c"><span class="token function">xTaskCreate</span><span class="token punctuation">(</span>test_task_example<span class="token punctuation">,</span> <span class="token string">"test_task_example"</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      <p>
       <code>
        test_task_example
       </code>
       ：指向任务函数的指针，也就是任务的入口函数。创建的任务会在 test_task_example 函数中执行。
      </p>
     </li>
     <li>
      <p>
       <code>
        "test_task_example"
       </code>
       ：任务名称，是一个字符串标识符，用于在调试时识别任务。这个名字可以帮助开发者识别和管理任务，但不会影响任务的实际执行。
      </p>
     </li>
     <li>
      <p>
       <code>
        2048
       </code>
       ：任务栈的大小，以字节为单位。栈大小为 2048 字节，意味着此任务可以使用 2048 字节的内存来存储局部变量、函数调用等。栈大小应根据任务的内存需求设置，避免过大或过小。
      </p>
     </li>
     <li>
      <p>
       <code>
        NULL
       </code>
       ：任务函数的输入参数，这里传递的是 NULL。如果任务需要初始化数据或控制参数，可以在这里传递参数。
      </p>
     </li>
     <li>
      <p>
       <code>
        10
       </code>
       ：任务优先级。FreeRTOS 的任务调度基于优先级，数值越高，优先级越高。优先级决定了任务被调度器分配 CPU 时间的优先程度。在此示例中，优先级为 10。
      </p>
     </li>
     <li>
      <p>
       <code>
        NULL
       </code>
       ：任务句柄（Task Handle）的指针。句柄用于标识任务和与任务交互。此处为 NULL，表示不需要任务句柄，如果需要在其他地方引用或管理此任务，可以传入指向句柄的指针，例如 TaskHandle_t 类型的变量地址。
      </p>
     </li>
    </ul>
    <p>
     这行代码会在 FreeRTOS 中创建一个名为 test_task_example 的任务。任务创建成功后，调度器会根据任务的优先级和时间片分配 CPU 时间，运行 test_task_example 函数中的代码。如果任务成功创建，test_task_example 会每隔一秒打印 “task run”。
    </p>
    <p>
     添加一个分支
    </p>
    <pre><code class="prism language-sh"><span class="token function">git</span> checkout <span class="token parameter variable">-b</span> dev2
</code></pre>
    <p>
     按照上述内容修改hello_world_main.c文件
    </p>
    <pre><code>vim main/hello_world_main.c
</code></pre>
    <p>
     按
     <code>
      i
     </code>
     进入编辑模式，按
     <code>
      Esc
     </code>
     退出编辑，按
     <code>
      :
     </code>
     +
     <code>
      w
     </code>
     +
     <code>
      q
     </code>
     保存。
     <br/>
     添加到库里，并打上标签
    </p>
    <pre><code>git add *
git commit -m "add xTaskCreate"
</code></pre>
    <p>
     输入
     <code>
      git log
     </code>
     查看日志，按
     <code>
      Q
     </code>
     退出。
    </p>
    <p>
     编译
    </p>
    <pre><code>idf.py -p /dev/ttyUSB0 flash monitor
</code></pre>
    <p>
     终端中显示：
     <br/>
     <img alt="img" src="https://i-blog.csdnimg.cn/img_convert/f6f6c2709d47bd77381b78598610f01e.png"/>
    </p>
    <p>
     完整代码
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* Hello World Example

   This example code is in the Public Domain (or CC0 licensed, at your option.)

   Unless required by applicable law or agreed to in writing, this
   software is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR
   CONDITIONS OF ANY KIND, either express or implied.
*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sdkconfig.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"freertos/FreeRTOS.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"freertos/task.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"esp_system.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"esp_spi_flash.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"esp_log.h"</span></span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>TAG <span class="token operator">=</span> <span class="token string">"MAIN APP"</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">test_task_example</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">vTaskDelay</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">/</span> portTICK_PERIOD_MS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"task run \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">app_main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Hello world!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Print chip information */</span>
    <span class="token class-name">esp_chip_info_t</span> chip_info<span class="token punctuation">;</span>
    <span class="token function">esp_chip_info</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>chip_info<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"This is %s chip with %d CPU core(s), WiFi%s%s, "</span><span class="token punctuation">,</span>
            CONFIG_IDF_TARGET<span class="token punctuation">,</span>
            chip_info<span class="token punctuation">.</span>cores<span class="token punctuation">,</span>
            <span class="token punctuation">(</span>chip_info<span class="token punctuation">.</span>features <span class="token operator">&amp;</span> CHIP_FEATURE_BT<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"/BT"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>chip_info<span class="token punctuation">.</span>features <span class="token operator">&amp;</span> CHIP_FEATURE_BLE<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"/BLE"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">unsigned</span> major_rev <span class="token operator">=</span> chip_info<span class="token punctuation">.</span>full_revision <span class="token operator">/</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> minor_rev <span class="token operator">=</span> chip_info<span class="token punctuation">.</span>full_revision <span class="token operator">%</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"silicon revision v%d.%d, "</span><span class="token punctuation">,</span> major_rev<span class="token punctuation">,</span> minor_rev<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%dMB %s flash\n"</span><span class="token punctuation">,</span> <span class="token function">spi_flash_get_chip_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">(</span>chip_info<span class="token punctuation">.</span>features <span class="token operator">&amp;</span> CHIP_FEATURE_EMB_FLASH<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"embedded"</span> <span class="token operator">:</span> <span class="token string">"external"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Minimum free heap size: %d bytes\n"</span><span class="token punctuation">,</span> <span class="token function">esp_get_minimum_free_heap_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ESP_LOGI</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"system init V1.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//打印日志</span>

    <span class="token function">xTaskCreate</span><span class="token punctuation">(</span>test_task_example<span class="token punctuation">,</span> <span class="token string">"test_task_example"</span><span class="token punctuation">,</span> <span class="token number">2048</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建任务</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"system run ...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">vTaskDelay</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">/</span> portTICK_PERIOD_MS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f35353634323837382f:61727469636c652f64657461696c732f313436323334313131" class_="artid" style="display:none">
 </p>
</div>


