---
layout: post
title: "petalinxu-在zynq的FPGA下的ST7735S的驱动配置"
date: 2025-03-11 19:51:19 +0800
description: "petalinux 下st7735的DTS配置."
keywords: "petalinxu 在zynq的FPGA下的ST7735S的驱动配置"
categories: ['未分类']
tags: ['Zynq', 'St', 'Petalinux', 'Dts']
artid: "146187210"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146187210
    alt: "petalinxu-在zynq的FPGA下的ST7735S的驱动配置"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146187210
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146187210
cover: https://bing.ee123.net/img/rand?artid=146187210
image: https://bing.ee123.net/img/rand?artid=146187210
img: https://bing.ee123.net/img/rand?artid=146187210
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     petalinxu 在zynq的FPGA下的ST7735S的驱动配置
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     spi的接线：
    </p>
    <p>
     【TFT模块排针8】 【开发板spi,gpio】【antminers9】
     <br/>
     VCC ----------- 3.3V   -----------      3.3V
     <br/>
     GND ----------- GND -----------      GND
     <br/>
     BLK(背光）-------GPIO----------- BANK34_L4N_RXD2(w13; j2.12; gpio[2])
     <br/>
     RST(复位）-------GPIO----------- BANK34_L3N_RST2(v13; j2.15; gpio[3])
     <br/>
     DC-------GPIO 四线SPI中的命令/数据选择 ----- BANK34_L4P_TXD2(v12; j2.11; gpio[1])
     <br/>
     SDA------- MOSI(SPI)-----------BANK34_L6P_TXD3(P14; j3.11)
     <br/>
     SCL------- SCK(SPI)    ----------- BANK34_L5N_RST3(T15; j3.15)
     <br/>
     CS  ------- ss(SPI) -----BANK34_0_PLUG2(R19; j2.5; gpio[0]) 直接垃低
    </p>
    <p>
     CS  ------- ss(SPI) 接地？？因为这个SPI接口只接收数据，所以直接接地没问题。
    </p>
    <p>
     CS的实际接线我用的是BANK34_0_PLUG2(R19; j2.5; gpio[0])这个GPIO去控制。
    </p>
    <p>
     4个GPIO用的是AXI_gpio的IP模块。这个模块的vivado配置先配好测好。
    </p>
    <p>
    </p>
    <p>
     petalinux的编译用HYPER-V的虚拟机，在写入SD时不方便用EXT4分区。用SD的单一FAT 分区。initrd 的根文作系统就好。但单独的EXT4分区好更改一些内容。虚拟硬盘一开如就用300G以上的，否则后面加容量，很麻烦。要生成SDK时编译过程中会用到相当大的硬盘容量，150多吧。
    </p>
    <p>
     petalinux默认用的是drm的显示驱动框架。FP的框架，默认没配置。/st7735 找到并配置好。6.4的内核的驱动是ST7735R的，这个用于ST7735S没问题。/backlight可能要配一下。驱动源码不需要动，主要工作在配置DTS 。对petalinxu主要就是system-user.dtsi。内容如下：
    </p>
    <p>
     /include/ "system-conf.dtsi"
     <br/>
     #include &lt;dt-bindings/gpio/gpio.h&gt;
     <br/>
     #include &lt;dt-bindings/input/input.h&gt;
    </p>
    <p>
     //#define GPIO_ACTIVE_HIGH 0
     <br/>
     //#define GPIO_ACTIVE_LOW 1
     <br/>
     //gpio.h就是如上这种反逻辑定义，但下面的语义反而正确。
    </p>
    <p>
     /{
     <!-- -->
    </p>
    <p>
     model="AntMiner S9";
     <br/>
     compatible = "zynq7010,zynq-7020","xlnx,zynq-7000";
    </p>
    <p>
     leds {
     <!-- -->
     <br/>
     compatible="gpio-leds";
     <br/>
     gpio-led1{
     <!-- -->
     <br/>
     label="led1";
     <br/>
     gpios=&lt;&amp;gpio0 58 GPIO_ACTIVE_LOW&gt;;
     <br/>
     default-state="off";
     <br/>
     };
     <br/>
     };
    </p>
    <p>
     keys {
     <!-- -->
     <br/>
     compatible="gpio-keys";
     <br/>
     autorepeat;
     <br/>
     gpio-key1{
     <!-- -->
     <br/>
     label="key1";
     <br/>
     gpios=&lt;&amp;gpio0 51 GPIO_ACTIVE_LOW&gt;;
     <br/>
     //linux,code=&lt;105&gt;;//right
     <br/>
     linux,code=&lt;KEY_RIGHT&gt;;
     <br/>
     gpio-key,wakeup;
     <br/>
     debounce-interval=&lt;10&gt;;
     <br/>
     }；
     <br/>
     };
     <br/>
     backlight:backlight {
     <!-- -->
     <br/>
     compatible="gpio-backlight";
     <br/>
     gpios=&lt;&amp;axi_gpio_0 2 GPIO_ACTIVE_LOW&gt;;
     <br/>
     default-on;
     <br/>
     };
     <br/>
     };
    </p>
    <p>
     &amp;sdhci1 {
     <!-- -->
     <br/>
     disable-wp;
     <br/>
     no-1-8-v;
     <br/>
     };
    </p>
    <p>
     &amp;spi0 {
     <!-- -->
     <br/>
     status="okay";
     <br/>
     //cs-gpios=&lt;0&gt;,&lt;&amp;axi_gpio_0 0 0&gt;;//&lt;0&gt; for reg=&lt;0&gt;
     <br/>
     cs-gpios=&lt;&amp;axi_gpio_0 0 GPIO_ACTIVE_LOW&gt;;
     <br/>
     tft_lcd@0 {
     <!-- -->
     <br/>
     status="okay";
     <br/>
     compatible="sitronix,st7735r";
     <br/>
     reg=&lt;0x0&gt;;
     <br/>
     spi-max-frequency=&lt;15000000&gt;;
     <br/>
     spi-cpol;
     <br/>
     spi-cpha;
     <br/>
     fps=&lt;20&gt;;
     <br/>
     buswidth=&lt;8&gt;;
     <br/>
     dc-gpios=&lt;&amp;axi_gpio_0 1 GPIO_ACTIVE_HIGH&gt;;
     <br/>
     reset-gpios=&lt;&amp;axi_gpio_0 3 GPIO_ACTIVE_LOW&gt;;
     <br/>
     bl-gpio=&lt;&amp;backlight&gt;;
     <br/>
     };
    </p>
    <p>
     };
     <br/>
     FB的测试网上下载了一个fb-test-app的源码，这个在petalinu下编译不难，长时间没做，花了单开时间才把它编译出来，主要是要看明的Makefile,并改正确。也补在下面吧。
     <br/>
     先要构建sdk:
     <br/>
     petalinux-build --sdk
     <br/>
     安装sdk：安装路径下/opt/Xilinx/Petalinux/2022.2/，是没有sdk这个文件夹的.
     <br/>
     petalinux-package --sysroot -s -d /opt/pkg/petalinux2024.2/sdk
    </p>
    <p>
     编译前：
    </p>
    <p>
     source /opt/pkg/petalinux2024.2/sdk/environment-setup-cortexa9t2hf-neon-xilinx-linux-gnueabi
     <br/>
    </p>
    <p>
     fb-test-app改后Makefile如下：
    </p>
    <p>
     <br/>
     APP = myfbtest
    </p>
    <p>
     #这些定义是fb-test源码中引用，不定义报错，这个程写的。
    </p>
    <p>
     VERSION = 1
     <br/>
     PATCHLEVEL = 1
     <br/>
     SUBLEVEL = 0
     <br/>
     EXTRAVERSION = .git
     <br/>
     NAME = rosetta
    </p>
    <p>
     override CFLAGS += -DVERSION=$(VERSION)
     <br/>
     override CFLAGS += -DPATCHLEVEL=$(PATCHLEVEL)
     <br/>
     override CFLAGS += -DSUBLEVEL=$(SUBLEVEL)
     <br/>
     override CFLAGS += -DVERSION_NAME=\"$(NAME)\"
    </p>
    <p>
     #
     <br/>
     # CC=$(CROSS_COMPILE)gcc
     <br/>
     # CXX=$(CROSS_COMPILE)g++
    </p>
    <p>
     # Common options
     <br/>
     #CFLAGS= -g -O3
     <br/>
     CFLAGS=-O2 -Wall
     <br/>
     LIBS =
    </p>
    <p>
     # Options for extra libraries
    </p>
    <p>
     #下面是一个目录下，用多个源文件编一个应用程序的定义方式。因为这个目录下多个源文件编多个应用，需要注去。
     <br/>
     #CFLAGS_OPENCV = `pkg-config opencv --cflags`
     <br/>
     #LIBS_OPENCV = `pkg-config opencv --libs`
    </p>
    <p>
     # Find all C files and create object file list
     <br/>
     #C_SRC = $(wildcard *.c)
     <br/>
     #C_OBJ = $(patsubst %c, %o, $(C_SRC))
    </p>
    <p>
     # Find all Cpp files and create object file list
     <br/>
     #CPP_SRC = $(wildcard *.cpp)
     <br/>
     #CPP_OBJ = $(patsubst %cpp, %o, $(CPP_SRC))
    </p>
    <p>
     #下需才是主要配置
     <br/>
     # Include directory
     <br/>
     INC_PATH=-I. -I./include -I../include
    </p>
    <p>
     PROGS=perf rect offset fb-test fb-string
    </p>
    <p>
     all: $(PROGS)
     <br/>
     <br/>
     .c.o: common.h font.h
     <br/>
     $(CC) -c $(CFLAGS) $(INC_PATH) -o $@ $&lt; $(LIBS)
    </p>
    <p>
     fb-test: fb-test.o common.o font_8x8.c
     <br/>
     $(CC) -o $@ fb-test.o common.o font_8x8.c $(LDFLAGS) $(LDLIBS)
     <br/>
     fb-string: fb-string.o common.o font_8x8.c
     <br/>
     #    $(CXX) -o $@ $(C_OBJ) $(CPP_OBJ) $(LDFLAGS) $(LDLIBS)
     <br/>
     $(CC) -o $@ fb-string.o common.o font_8x8.c $(LDFLAGS) $(LDLIBS)
     <br/>
     clean:
     <br/>
     rm -f $(PROGS) *.o
     <br/>
     <br/>
    </p>
    <p>
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f71757368616f626f2f:61727469636c652f64657461696c732f313436313837323130" class_="artid" style="display:none">
 </p>
</div>


