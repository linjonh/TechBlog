---
layout: post
title: "GDB之4调试Python代码"
date: 2023-03-22 23:09:09 +0800
description: "如果Python程序挂住了，想查看Python代码的栈，但是用GDB看到的是C栈，本文介绍使用gdb"
keywords: "python gdb"
categories: ['Python', 'Linux', 'Cs']
tags: ['Python', 'Linux', 'Gdb']
artid: "129721541"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=129721541
    alt: "GDB之4调试Python代码"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=129721541
featuredImagePreview: https://bing.ee123.net/img/rand?artid=129721541
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     GDB之(4)调试Python代码
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h4>
     <a id="GDB4Python_0">
     </a>
     GDB之(4)调试Python代码
    </h4>
    <p>
     Author：Once Day Date：2023年3月22日/2024年2月26日
    </p>
    <p>
     漫漫长路，才刚刚开始…
    </p>
    <p>
     全系列文章请查看专栏:
     <a href="https://blog.csdn.net/once_day/category_11958578.html">
      Linux实践记录_Once-Day的博客-CSDN博客
     </a>
    </p>
    <p>
     推荐参考文档：
    </p>
    <ul>
     <li>
      <a href="https://winglq.github.io/posts/pythongdb/" rel="nofollow">
       如何用gdb调试python程序 (winglq.github.io)
      </a>
     </li>
     <li>
      <a href="https://sourceware.org/gdb/" rel="nofollow">
       GDB: The GNU Project Debugger (sourceware.org)
      </a>
     </li>
     <li>
      <a href="https://sourceware.org/gdb/documentation/" rel="nofollow">
       GDB Documentation (sourceware.org)
      </a>
     </li>
    </ul>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <ul>
        <li>
         <ul>
          <li>
           <a href="#GDB4Python_0" rel="nofollow">
            GDB之(4)调试Python代码
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#1__17" rel="nofollow">
              1. 概述
             </a>
            </li>
            <li>
             <a href="#2_libpython_50" rel="nofollow">
              2. 加载libpython文件
             </a>
            </li>
            <li>
             <ul>
              <li>
               <a href="#21__175" rel="nofollow">
                2.1 如果打印信息失败
               </a>
              </li>
             </ul>
            </li>
            <li>
             <a href="#3pippystack_207" rel="nofollow">
              3.安装pip+pystack
             </a>
            </li>
           </ul>
          </li>
         </ul>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h5>
     <a id="1__17">
     </a>
     1. 概述
    </h5>
    <p>
     如果Python程序挂住了，想查看Python代码的栈，但是用GDB看到的是C栈，本文介绍使用gdb的python扩展来查看python代码栈。
    </p>
    <p>
     一般而言，现在的ubuntu设备上，安装gdb时都会自带装上python的扩展工具：
    </p>
    <pre><code class="prism language-yacas">onceday-&gt;~:# find /usr/ -name "gdb"
/usr/include/gdb
/usr/share/doc/gdb
/usr/share/gdb
/usr/share/gdb/python/gdb
/usr/share/bash-completion/completions/gdb
/usr/bin/gdb
</code></pre>
    <p>
     <strong>
      如上面，搜索一下目录，看看是否有
      <code>
       /usr/share/gdb/python/gdb
      </code>
      ，如果没有需要安装对应的工具，这里自带的是python3的调试扩展
     </strong>
     。
    </p>
    <p>
     对于Python2，需要安装对应的包扩展才行。
    </p>
    <pre><code class="prism language-yacas">onceday-&gt;~:# apt search python-gdb
Sorting... Done
Full Text Search... Done
python-gdbm/jammy 2.7.18-1build1 amd64
  GNU dbm database support for Python2

python-gdbm-dbg/jammy 2.7.18-1build1 amd64
  GNU dbm database support for Python2 (debug extension)
</code></pre>
    <p>
     <strong>
      如上所示，安装对应的python2-gdb扩展即可
     </strong>
     。
    </p>
    <h5>
     <a id="2_libpython_50">
     </a>
     2. 加载libpython文件
    </h5>
    <p>
     下载地址为：
     <a href="https://github.com/python/cpython/blob/3.9/Tools/gdb/libpython.py">
      GitHub cpython tools
     </a>
    </p>
    <p>
     下载文件需要在仓库分支那里选择对应当前版本的分支下载该文件，然后操作如下：
    </p>
    <ul>
     <li>
      下载到本地文件夹中。
      <strong>
       可以放到系统路径去，这样后面不需要额外添加系统路径了
      </strong>
      。
     </li>
    </ul>
    <p>
     首先找到目标进程ID，或者coredump文件，皆可以：
    </p>
    <pre><code class="prism language-yacas">onceday-&gt;~:# ps aux |grep gdb
ubuntu   1588276  0.0  0.1  16288  8844 pts/8    S+   21:58   0:00 python3 gdb_test.py
root     1588710  0.0  0.0   6476  2448 pts/9    S+   22:00   0:00 grep --color=auto gdb
</code></pre>
    <p>
     然后使用
     <code>
      gdb python3 1588276
     </code>
     ，便可以attach到运行的进程上：
    </p>
    <pre><code class="prism language-yacas">......
#10 0x000056527606a005 in _PyEval_EvalFrameDefault ()
No symbol table info available.
#11 0x00005652760813ac in _PyFunction_Vectorcall ()
No symbol table info available.
#12 0x000056527606a005 in _PyEval_EvalFrameDefault ()
No symbol table info available.
#13 0x00005652760813ac in _PyFunction_Vectorcall ()
No symbol table info available.
#14 0x000056527606a005 in _PyEval_EvalFrameDefault ()
No symbol table info available.
#15 0x0000565276066766 in ?? ()
......
</code></pre>
    <p>
     <strong>
      直接使用bt full打出来的是上面的栈，(忽略符号表，重点是栈形式)，这是基于C代码的角度
     </strong>
     。
    </p>
    <p>
     这个时候，可以手动加在python扩展，
     <strong>
      部分发行版Linux的GDB集成了python扩展功能，那就无需手动导入了
     </strong>
     。
    </p>
    <pre><code class="prism language-yacas">(gdb) python
&gt;import sys
&gt;sys.path.insert(0,"/home/ubuntu/py-code")
&gt;import libpython
&gt;end
(gdb) py
py-bt               py-down             py-locals           py-up               python-interactive
py-bt-full          py-list             py-print            python        
</code></pre>
    <p>
     <strong>
      sys.path.insert是把下载的libpython.py文件所在的文件夹加入系统路径中，如果已经放入系统路径，这一步就是多余的了
     </strong>
     。
    </p>
    <p>
     导入成功了，输入
     <code>
      py
     </code>
     然后tab，将看到下面几个命令，其含义和gdb中命令类似。
    </p>
    <pre><code class="prism language-yacas">(gdb) py-bt
Traceback (most recent call first):
  (unable to read python frame information)
  (unable to read python frame information)
  (unable to read python frame information)
</code></pre>
    <p>
     <strong>
      <code>
       py-bt
      </code>
      是打印栈，但是如果报出上面的错误，无需担心，这是libpython版本和当前python解释器版本没对上的问题，因此重新下载对应版本的libpython.py文件即可
     </strong>
     。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0785e9d49b5cbef66e75adc6b01c0183.png#pic_center"/>
    </p>
    <p>
     <strong>
      如上图所示，选择对应的python版本即可，这里选择的应该是
      <code>
       3.10
      </code>
      版本
     </strong>
     。
    </p>
    <p>
     下面来看一下常见的命令效果：
    </p>
    <p>
     <strong>
      py-bt打印栈的简略信息：
     </strong>
    </p>
    <pre><code class="prism language-yacas">(gdb) py-bt
Traceback (most recent call first):
  File "/home/postgres/Connect_data.py", line 44, in deal_type_value
    data = (int(random.random() * 20000), int(random.random() * 1000000))
  File "/home/postgres/Connect_data.py", line 159, in &lt;module&gt;
    deal_type_value(f1, f2, start_time_sec)
</code></pre>
    <p>
     <strong>
      py-bt-full打印栈的详细信息
     </strong>
     ：
    </p>
    <pre><code class="prism language-yacas">(gdb) py-bt-full
#0 Frame 0xffffb85ed640, for file /home/postgres/Connect_data.py, line 44, in deal_type_value (f1=&lt;_io.TextIOWrapper at remote 0xffffb8622860&gt;, f2=&lt;_io.TextIOWrapper at remote 0xffffb8622ee0&gt;, now_time=1704118932, d_time=80532)
    data = (int(random.random() * 20000), int(random.random() * 1000000))
#5 Frame 0x2302d680, for file /home/postgres/Connect_data.py, line 159, in &lt;module&gt; ()
    deal_type_value
</code></pre>
    <p>
     <strong>
      py-up和py-down上下移动栈的位置
     </strong>
     ，
     <code>
      py-list
     </code>
     显示当前附近的源码：
    </p>
    <pre><code class="prism language-yacas">(gdb) py-list 
  39    
  40    def deal_type_value(f1, f2, now_time):
  41        global sava_start_time
  42        global data_sum
  43        d_time = now_time - sava_start_time
 &gt;44        data = (int(random.random() * 20000), int(random.random() * 1000000))
  45        data_sum["3s"].append(data)
  46        data_sum["10s"].append(data)
  47        if d_time % 3 == 0:
  48            succ, conc = sum_data(data_sum["3s"])
  49            f1.write(f"{now_time}, 1, {succ}, {conc}\n")
</code></pre>
    <p>
     <strong>
      py-locals打印当前栈的局部变量信息
     </strong>
     ：
    </p>
    <pre><code class="prism language-yacas">(gdb) py-locals 
f1 = &lt;_io.TextIOWrapper at remote 0xffffb8622860&gt;
f2 = &lt;_io.TextIOWrapper at remote 0xffffb8622ee0&gt;
now_time = 1704118932
d_time = 80532
</code></pre>
    <p>
     <strong>
      py-print可以打印指定的变量信息：
     </strong>
    </p>
    <pre><code class="prism language-yacas">(gdb) py-print now_time
local 'now_time' = 1704118932
</code></pre>
    <h6>
     <a id="21__175">
     </a>
     2.1 如果打印信息失败
    </h6>
    <pre><code class="prism language-yacas">(gdb) py-bt
Traceback (most recent call first):
  (unable to read python frame information)
  (unable to read python frame information)
  (unable to read python frame information)
  (unable to read python frame information)
</code></pre>
    <p>
     上述输出表明 GDB 无法读取 Python 堆栈帧信息。这可能会出现在几种情况下：
    </p>
    <ol>
     <li>
      <p>
       <strong>
        GDB 没有正确加载 Python 插件
       </strong>
       ：需要确保在开始追踪之前已经通过
       <code>
        gdb
       </code>
       命令行加载了 Python 插件，比如：
      </p>
      <pre><code class="prism language-python"><span class="token punctuation">(</span>gdb<span class="token punctuation">)</span> python
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">import</span> sys
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> sys<span class="token punctuation">.</span>path<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token string">'/path/to/python/source'</span><span class="token punctuation">)</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">from</span> Tools <span class="token keyword">import</span> gdb
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> end
</code></pre>
      <p>
       这里的 ‘/path/to/python/source’ 是 Python 源代码的路径。这个路径需要替换为实际的路径。
      </p>
     </li>
     <li>
      <p>
       <strong>
        Python 可执行文件没有包含调试符号
       </strong>
       ：要在 GDB 中调试 Python，需要一个包含调试符号的 Python 可执行文件。在构建 Python 时，需要使用
       <code>
        --with-pydebug
       </code>
       选项来包含这些符号。如果使用的 Python 没有包含这些符号，可能需要重新构建 Python。
      </p>
     </li>
     <li>
      <p>
       <strong>
        GDB 版本不兼容
       </strong>
       ：不是所有版本的 GDB 都能正确地处理 Python 堆栈帧。你可能需要尝试升级或降级 GDB 来解决这个问题。
      </p>
     </li>
     <li>
      <p>
       <strong>
        Python 代码正在执行非 Python 代码
       </strong>
       ：如果 Python 代码正在执行一个 C 扩展或者其他非 Python 代码，GDB 可能无法显示 Python 堆栈帧。在这种情况下，可能需要等待代码回到 Python 域，或者在 C 代码中设置断点。
      </p>
     </li>
    </ol>
    <h5>
     <a id="3pippystack_207">
     </a>
     3.安装pip+pystack
    </h5>
    <p>
     使用下面命令安装
     <code>
      pip(“ensurepip” is a module in Python that provides support for bootstrapping the pip installer into an existing Python installation or virtual environment)
     </code>
    </p>
    <pre><code class="prism language-yacas">pip -m ensurepip
pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple pystack-debugger
ps -ef | grep yams
pystack &lt;python-pid&gt;
</code></pre>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <br/>
    <p>
     <img alt="Alt" height="200" src="https://i-blog.csdnimg.cn/blog_migrate/027004482f3a3ce3cf6063b863ab8f98.png#pic_center"/>
    </p>
    <center>
     <h3>
      Once Day
     </h3>
     <h3>
     </h3>
    </center>
    <center>
     <p>
      <i>
       <b>
        也信美人终作土，不堪幽梦太匆匆......
       </b>
      </i>
     </p>
    </center>
    <center>
     <p>
      <b>
       如果这篇文章为您带来了帮助或启发，不妨点个赞👍和关注，再加上一个小小的收藏⭐！
      </b>
     </p>
    </center>
    <center>
     <p>
      <b>
       (｡◕‿◕｡)感谢您的阅读与支持~~~
      </b>
     </p>
     <p>
     </p>
    </center>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f4f6e63655f6461792f:61727469636c652f64657461696c732f313239373231353431" class_="artid" style="display:none">
 </p>
</div>


