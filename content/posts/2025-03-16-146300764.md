---
layout: post
title: "linux-下消息队列"
date: 2025-03-16 20:33:39 +0800
description: "linux 下消息队列"
keywords: "linux 下消息队列"
categories: ['Linux']
tags: ['运维', '服务器', 'Linux', 'C', 'C']
artid: "146300764"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146300764
    alt: "linux-下消息队列"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146300764
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146300764
cover: https://bing.ee123.net/img/rand?artid=146300764
image: https://bing.ee123.net/img/rand?artid=146300764
img: https://bing.ee123.net/img/rand?artid=146300764
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     linux 下消息队列
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d6d70b58e84442aeba129409048457ec.png"/>
    </p>
    <hr/>
    <h2>
     <a id="_Linux_System_V__6">
     </a>
     📨 Linux System V 消息队列实战
    </h2>
    <hr/>
    <h3>
     <a id="__9">
     </a>
     一、消息队列核心概念 💡
    </h3>
    <h4>
     <a id="1___11">
     </a>
     1. 消息队列特点 🌟
    </h4>
    <ul>
     <li>
      📦
      <strong>
       结构化数据
      </strong>
      ：消息包含类型标识（
      <code>
       mytype
      </code>
      ）和正文（
      <code>
       data
      </code>
      ），支持分类处理
     </li>
     <li>
      ⏳
      <strong>
       异步通信
      </strong>
      ：发送方和接收方无需同时在线
     </li>
     <li>
      🔒
      <strong>
       持久性
      </strong>
      ：消息队列在内核中持久存在，直到显式删除
     </li>
     <li>
      🔑
      <strong>
       访问控制
      </strong>
      ：通过权限标志（如
      <code>
       0666
      </code>
      ）管理读写权限
     </li>
    </ul>
    <h4>
     <a id="2___17">
     </a>
     2. 生命周期 🔄
    </h4>
    <ul>
     <li>
      <strong>
       创建
      </strong>
      →
      <strong>
       发送/接收
      </strong>
      →
      <strong>
       销毁
      </strong>
     </li>
     <li>
      ❗若不主动销毁，队列会持续占用内核资源（通过
      <code>
       ipcs -q
      </code>
      可查看）
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="_22">
     </a>
     二、项目概述
    </h3>
    <p>
     本示例通过
     <strong>
      System V 消息队列
     </strong>
     实现跨进程通信，包含三个核心文件：
    </p>
    <ul>
     <li>
      <strong>
       <code>
        common.hpp
       </code>
      </strong>
      ：消息队列公共配置
     </li>
     <li>
      <strong>
       <code>
        sender.cpp
       </code>
      </strong>
      ：消息生产者（发送端）
     </li>
     <li>
      <strong>
       <code>
        receiver.cpp
       </code>
      </strong>
      ：消息消费者（接收端）
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="_31">
     </a>
     三、完整代码实现
    </h3>
    <h4>
     <a id="1__commonhpp_33">
     </a>
     1. 公共头文件
     <code>
      common.hpp
     </code>
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/msg.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib&gt;</span></span>

<span class="token comment">// 消息队列标识配置</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> pathname <span class="token operator">=</span> <span class="token string">"/home"</span><span class="token punctuation">;</span> <span class="token comment">// ftok路径参数（需真实存在）</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> proj_id <span class="token operator">=</span> <span class="token number">666</span><span class="token punctuation">;</span>        <span class="token comment">// 项目ID（取值范围0-255）</span>

<span class="token comment">// 消息结构体（必须包含long类型字段）</span>
<span class="token keyword">struct</span> <span class="token class-name">message</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> mytype<span class="token punctuation">;</span>    <span class="token comment">// 消息类型标识（必须 &gt; 0）</span>
    <span class="token keyword">char</span> data<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 消息正文（最大99字符）</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 错误码枚举</span>
<span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span>
    MSGGET_ERROR <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 通用队列创建/获取函数</span>
<span class="token keyword">int</span> <span class="token function">Msgqueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> flag<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    key_t key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> proj_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ftok failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>MSGGET_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> msgid <span class="token operator">=</span> <span class="token function">msgget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msgid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"msgget failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>MSGGET_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> msgid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建新队列（服务端）</span>
<span class="token keyword">int</span> <span class="token function">CreateMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">Msgqueue</span><span class="token punctuation">(</span>IPC_CREAT <span class="token operator">|</span> IPC_EXCL <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取已有队列（客户端）</span>
<span class="token keyword">int</span> <span class="token function">Getmsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">Msgqueue</span><span class="token punctuation">(</span>IPC_CREAT <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <h4>
     <a id="2__sendercpp_87">
     </a>
     2. 发送端
     <code>
      sender.cpp
     </code>
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"common.hpp"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建消息队列</span>
    <span class="token keyword">int</span> msgid <span class="token operator">=</span> <span class="token function">CreateMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">" 消息队列创建成功! ID: "</span> <span class="token operator">&lt;&lt;</span> msgid <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    <span class="token comment">// 构造消息</span>
    message msg<span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>mytype <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 消息类型标识</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hello from sender"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送消息（阻塞模式）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">msgsnd</span><span class="token punctuation">(</span>msgid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">" 消息发送失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">" 消息已发送: "</span> <span class="token operator">&lt;&lt;</span> msg<span class="token punctuation">.</span>data <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <h4>
     <a id="3__receivercpp_114">
     </a>
     3. 接收端
     <code>
      receiver.cpp
     </code>
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"common.hpp"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 获取消息队列</span>
    <span class="token keyword">int</span> msgid <span class="token operator">=</span> <span class="token function">Getmsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">" 连接到消息队列 ID: "</span> <span class="token operator">&lt;&lt;</span> msgid <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    <span class="token comment">// 接收消息（阻塞等待类型为1的消息）</span>
    message msg<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">msgrcv</span><span class="token punctuation">(</span>msgid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">" 消息接收失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">" 收到消息: "</span> <span class="token operator">&lt;&lt;</span> msg<span class="token punctuation">.</span>data <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

    <span class="token comment">// 销毁队列（生产环境慎用！）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">msgctl</span><span class="token punctuation">(</span>msgid<span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">" 队列删除失败"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"消息队列已销毁"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_144">
     </a>
     三、编译与运行指南
    </h3>
    <h4>
     <a id="1__146">
     </a>
     1. 编译命令
    </h4>
    <pre><code class="prism language-bash"><span class="token comment"># 生成发送端可执行文件</span>
g++ sender.cpp <span class="token parameter variable">-o</span> sender <span class="token parameter variable">-std</span><span class="token operator">=</span>c++11

<span class="token comment"># 生成接收端可执行文件</span>
g++ receiver.cpp <span class="token parameter variable">-o</span> receiver <span class="token parameter variable">-std</span><span class="token operator">=</span>c++11
</code></pre>
    <h4>
     <a id="2__155">
     </a>
     2. 运行顺序
    </h4>
    <pre><code class="prism language-bash"><span class="token comment"># 终端1：运行发送端（创建队列）</span>
./sender

<span class="token comment"># 终端2：运行接收端（消费消息）</span>
./receiver
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/33d209f5155c4466bad547f50c5840ec.png"/>
    </p>
    <h3>
     <a id="__167">
     </a>
     四、代码分解与核心函数 🛠️
    </h3>
    <h4>
     <a id="1__commonhpp__169">
     </a>
     1. 公共头文件
     <code>
      common.hpp
     </code>
     📁
    </h4>
    <h5>
     <a id="_170">
     </a>
     消息结构体定义
    </h5>
    <pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">message</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> mytype<span class="token punctuation">;</span>    <span class="token comment">// 🔢 消息类型（必须 &gt; 0）</span>
    <span class="token keyword">char</span> data<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 📝 消息正文（最大长度可调整）</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="Key__178">
     </a>
     Key 生成与队列创建
    </h5>
    <pre><code class="prism language-cpp">key_t key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span>pathname<span class="token punctuation">,</span> proj_id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 🗝️ 生成唯一键值</span>
<span class="token keyword">int</span> msgid <span class="token operator">=</span> <span class="token function">msgget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 🚪 创建/获取队列</span>
</code></pre>
    <ul>
     <li>
      <strong>
       <code>
        ftok
       </code>
       参数
      </strong>
      ：
      <ul>
       <li>
        📂
        <code>
         pathname
        </code>
        ：任意存在的文件路径（本文使用
        <code>
         /home
        </code>
        ）
       </li>
       <li>
        🆔
        <code>
         proj_id
        </code>
        ：项目标识符（确保不同应用使用不同值）
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="_187">
     </a>
     封装函数
    </h5>
    <ul>
     <li>
      🆕
      <strong>
       <code>
        CreateMsg()
       </code>
      </strong>
      ：创建新队列（
      <code>
       IPC_CREAT | IPC_EXCL
      </code>
      确保唯一性）
     </li>
     <li>
      🔍
      <strong>
       <code>
        Getmsg()
       </code>
      </strong>
      ：获取已有队列（若不存在则创建）
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="2___192">
     </a>
     2. 发送端代码解析 📤
    </h4>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> msgid <span class="token operator">=</span> <span class="token function">CreateMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 🏗️ 创建队列</span>
    message msg<span class="token punctuation">;</span>
    msg<span class="token punctuation">.</span>mytype <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 🏷️ 设置消息类型</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"hello from sender\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ✈️ 发送消息（阻塞模式）</span>
    <span class="token function">msgsnd</span><span class="token punctuation">(</span>msgid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Message sent: "</span> <span class="token operator">&lt;&lt;</span> msg<span class="token punctuation">.</span>data <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="__207">
     </a>
     关键点 🔑
    </h5>
    <ul>
     <li>
      🎯
      <strong>
       消息类型
      </strong>
      ：接收端通过
      <code>
       mytype
      </code>
      筛选消息
     </li>
     <li>
      🚦
      <strong>
       发送模式
      </strong>
      ：
      <ul>
       <li>
        🛑
        <code>
         0
        </code>
        ：阻塞发送（队列满时等待）
       </li>
       <li>
        🚀
        <code>
         IPC_NOWAIT
        </code>
        ：非阻塞发送（立即返回错误）
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="3___215">
     </a>
     3. 接收端代码解析 📥
    </h4>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> msgid <span class="token operator">=</span> <span class="token function">Getmsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 🔍 获取队列</span>
    message msg<span class="token punctuation">;</span>
    
    <span class="token comment">// 📭 接收类型为1的消息（阻塞模式）</span>
    <span class="token function">msgrcv</span><span class="token punctuation">(</span>msgid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> msg<span class="token punctuation">.</span>data <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    
    <span class="token function">msgctl</span><span class="token punctuation">(</span>msgid<span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 🗑️ 销毁队列</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="__230">
     </a>
     关键点 🔍
    </h5>
    <ul>
     <li>
      🎯
      <strong>
       消息过滤
      </strong>
      ：
      <code>
       msgrcv
      </code>
      的第4个参数指定接收的消息类型
      <ul>
       <li>
        🎯
        <code>
         1
        </code>
        ：仅接收类型为1的消息
       </li>
       <li>
        🎲
        <code>
         0
        </code>
        ：接收队列中第一条消息
       </li>
       <li>
        🔍
        <code>
         -3
        </code>
        ：接收类型 ≤3 的最小消息
       </li>
      </ul>
     </li>
     <li>
      🧹
      <strong>
       资源释放
      </strong>
      ：
      <code>
       IPC_RMID
      </code>
      立即删除队列
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="__239">
     </a>
     五、常见问题与调试技巧 🚨
    </h3>
    <h4>
     <a id="1___240">
     </a>
     1. 系统命令 💻
    </h4>
    <pre><code class="prism language-bash">ipcs <span class="token parameter variable">-q</span>          <span class="token comment"># 🔍 查看所有消息队列</span>
ipcrm <span class="token parameter variable">-q</span> <span class="token operator">&lt;</span>msqid<span class="token operator">&gt;</span> <span class="token comment"># 🗑️ 手动删除队列</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34363533383938352f:61727469636c652f64657461696c732f313436333030373634" class_="artid" style="display:none">
 </p>
</div>


