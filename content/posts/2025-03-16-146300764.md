---
layout: post
title: "linux-ä¸‹æ¶ˆæ¯é˜Ÿåˆ—"
date: 2025-03-16 20:33:39 +0800
description: "linux ä¸‹æ¶ˆæ¯é˜Ÿåˆ—"
keywords: "linux ä¸‹æ¶ˆæ¯é˜Ÿåˆ—"
categories: ['Linux']
tags: ['è¿ç»´', 'æœåŠ¡å™¨', 'Linux', 'C', 'C']
artid: "146300764"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146300764
    alt: "linux-ä¸‹æ¶ˆæ¯é˜Ÿåˆ—"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146300764
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146300764
cover: https://bing.ee123.net/img/rand?artid=146300764
image: https://bing.ee123.net/img/rand?artid=146300764
img: https://bing.ee123.net/img/rand?artid=146300764
---

# linux ä¸‹æ¶ˆæ¯é˜Ÿåˆ—

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/d6d70b58e84442aeba129409048457ec.png)

* * *

## ğŸ“¨ Linux System V æ¶ˆæ¯é˜Ÿåˆ—å®æˆ˜

* * *

### ä¸€ã€æ¶ˆæ¯é˜Ÿåˆ—æ ¸å¿ƒæ¦‚å¿µ ğŸ’¡

#### 1\. æ¶ˆæ¯é˜Ÿåˆ—ç‰¹ç‚¹ ğŸŒŸ

  * ğŸ“¦ **ç»“æ„åŒ–æ•°æ®** ï¼šæ¶ˆæ¯åŒ…å«ç±»å‹æ ‡è¯†ï¼ˆ`mytype`ï¼‰å’Œæ­£æ–‡ï¼ˆ`data`ï¼‰ï¼Œæ”¯æŒåˆ†ç±»å¤„ç†
  * â³ **å¼‚æ­¥é€šä¿¡** ï¼šå‘é€æ–¹å’Œæ¥æ”¶æ–¹æ— éœ€åŒæ—¶åœ¨çº¿
  * ğŸ”’ **æŒä¹…æ€§** ï¼šæ¶ˆæ¯é˜Ÿåˆ—åœ¨å†…æ ¸ä¸­æŒä¹…å­˜åœ¨ï¼Œç›´åˆ°æ˜¾å¼åˆ é™¤
  * ğŸ”‘ **è®¿é—®æ§åˆ¶** ï¼šé€šè¿‡æƒé™æ ‡å¿—ï¼ˆå¦‚`0666`ï¼‰ç®¡ç†è¯»å†™æƒé™

#### 2\. ç”Ÿå‘½å‘¨æœŸ ğŸ”„

  * **åˆ›å»º** â†’ **å‘é€/æ¥æ”¶** â†’ **é”€æ¯**
  * â—è‹¥ä¸ä¸»åŠ¨é”€æ¯ï¼Œé˜Ÿåˆ—ä¼šæŒç»­å ç”¨å†…æ ¸èµ„æºï¼ˆé€šè¿‡`ipcs -q`å¯æŸ¥çœ‹ï¼‰

* * *

### äºŒã€é¡¹ç›®æ¦‚è¿°

æœ¬ç¤ºä¾‹é€šè¿‡ **System V æ¶ˆæ¯é˜Ÿåˆ—** å®ç°è·¨è¿›ç¨‹é€šä¿¡ï¼ŒåŒ…å«ä¸‰ä¸ªæ ¸å¿ƒæ–‡ä»¶ï¼š

  * **`common.hpp`** ï¼šæ¶ˆæ¯é˜Ÿåˆ—å…¬å…±é…ç½®
  * **`sender.cpp`** ï¼šæ¶ˆæ¯ç”Ÿäº§è€…ï¼ˆå‘é€ç«¯ï¼‰
  * **`receiver.cpp`** ï¼šæ¶ˆæ¯æ¶ˆè´¹è€…ï¼ˆæ¥æ”¶ç«¯ï¼‰

* * *

### ä¸‰ã€å®Œæ•´ä»£ç å®ç°

#### 1\. å…¬å…±å¤´æ–‡ä»¶ `common.hpp`

    
    
    #pragma once
    #include <iostream>
    #include <sys/types.h>
    #include <sys/ipc.h>
    #include <sys/msg.h>
    #include <cstring>
    #include <cstdlib>
    
    // æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†é…ç½®
    const char* pathname = "/home"; // ftokè·¯å¾„å‚æ•°ï¼ˆéœ€çœŸå®å­˜åœ¨ï¼‰
    const int proj_id = 666;        // é¡¹ç›®IDï¼ˆå–å€¼èŒƒå›´0-255ï¼‰
    
    // æ¶ˆæ¯ç»“æ„ä½“ï¼ˆå¿…é¡»åŒ…å«longç±»å‹å­—æ®µï¼‰
    struct message {
        long mytype;    // æ¶ˆæ¯ç±»å‹æ ‡è¯†ï¼ˆå¿…é¡» > 0ï¼‰
        char data[100]; // æ¶ˆæ¯æ­£æ–‡ï¼ˆæœ€å¤§99å­—ç¬¦ï¼‰
    };
    
    // é”™è¯¯ç æšä¸¾
    enum {
        MSGGET_ERROR = 1,
    };
    
    // é€šç”¨é˜Ÿåˆ—åˆ›å»º/è·å–å‡½æ•°
    int Msgqueue(int flag) {
        key_t key = ftok(pathname, proj_id);
        if (key < 0) {
            perror("ftok failed");
            exit(MSGGET_ERROR);
        }
    
        int msgid = msgget(key, flag);
        if (msgid < 0) {
            perror("msgget failed");
            exit(MSGGET_ERROR);
        }
        return msgid;
    }
    
    // åˆ›å»ºæ–°é˜Ÿåˆ—ï¼ˆæœåŠ¡ç«¯ï¼‰
    int CreateMsg() {
        return Msgqueue(IPC_CREAT | IPC_EXCL | 0666);
    }
    
    // è·å–å·²æœ‰é˜Ÿåˆ—ï¼ˆå®¢æˆ·ç«¯ï¼‰
    int Getmsg() {
        return Msgqueue(IPC_CREAT | 0666);
    }
    

* * *

#### 2\. å‘é€ç«¯ `sender.cpp`

    
    
    #include "common.hpp"
    
    int main() {
        // åˆ›å»ºæ¶ˆæ¯é˜Ÿåˆ—
        int msgid = CreateMsg();
        std::cout << " æ¶ˆæ¯é˜Ÿåˆ—åˆ›å»ºæˆåŠŸ! ID: " << msgid << std::endl;
    
        // æ„é€ æ¶ˆæ¯
        message msg;
        msg.mytype = 1; // æ¶ˆæ¯ç±»å‹æ ‡è¯†
        snprintf(msg.data, sizeof(msg.data), "hello from sender");
    
        // å‘é€æ¶ˆæ¯ï¼ˆé˜»å¡æ¨¡å¼ï¼‰
        if (msgsnd(msgid, &msg, sizeof(msg.data), 0) < 0) {
            perror(" æ¶ˆæ¯å‘é€å¤±è´¥");
            exit(1);
        }
        std::cout << " æ¶ˆæ¯å·²å‘é€: " << msg.data << std::endl;
    
        return 0;
    }
    

* * *

#### 3\. æ¥æ”¶ç«¯ `receiver.cpp`

    
    
    #include "common.hpp"
    
    int main() {
        // è·å–æ¶ˆæ¯é˜Ÿåˆ—
        int msgid = Getmsg();
        std::cout << " è¿æ¥åˆ°æ¶ˆæ¯é˜Ÿåˆ— ID: " << msgid << std::endl;
    
        // æ¥æ”¶æ¶ˆæ¯ï¼ˆé˜»å¡ç­‰å¾…ç±»å‹ä¸º1çš„æ¶ˆæ¯ï¼‰
        message msg;
        if (msgrcv(msgid, &msg, sizeof(msg.data), 1, 0) < 0) {
            perror(" æ¶ˆæ¯æ¥æ”¶å¤±è´¥");
            exit(1);
        }
        std::cout << " æ”¶åˆ°æ¶ˆæ¯: " << msg.data << std::endl;
    
        // é”€æ¯é˜Ÿåˆ—ï¼ˆç”Ÿäº§ç¯å¢ƒæ…ç”¨ï¼ï¼‰
        if (msgctl(msgid, IPC_RMID, nullptr) < 0) {
            perror(" é˜Ÿåˆ—åˆ é™¤å¤±è´¥");
        } else {
            std::cout << "æ¶ˆæ¯é˜Ÿåˆ—å·²é”€æ¯" << std::endl;
        }
    
        return 0;
    }
    

* * *

### ä¸‰ã€ç¼–è¯‘ä¸è¿è¡ŒæŒ‡å—

#### 1\. ç¼–è¯‘å‘½ä»¤

    
    
    # ç”Ÿæˆå‘é€ç«¯å¯æ‰§è¡Œæ–‡ä»¶
    g++ sender.cpp -o sender -std=c++11
    
    # ç”Ÿæˆæ¥æ”¶ç«¯å¯æ‰§è¡Œæ–‡ä»¶
    g++ receiver.cpp -o receiver -std=c++11
    

#### 2\. è¿è¡Œé¡ºåº

    
    
    # ç»ˆç«¯1ï¼šè¿è¡Œå‘é€ç«¯ï¼ˆåˆ›å»ºé˜Ÿåˆ—ï¼‰
    ./sender
    
    # ç»ˆç«¯2ï¼šè¿è¡Œæ¥æ”¶ç«¯ï¼ˆæ¶ˆè´¹æ¶ˆæ¯ï¼‰
    ./receiver
    

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/33d209f5155c4466bad547f50c5840ec.png)

### å››ã€ä»£ç åˆ†è§£ä¸æ ¸å¿ƒå‡½æ•° ğŸ› ï¸

#### 1\. å…¬å…±å¤´æ–‡ä»¶ `common.hpp` ğŸ“

##### æ¶ˆæ¯ç»“æ„ä½“å®šä¹‰

    
    
    struct message {
        long mytype;    // ğŸ”¢ æ¶ˆæ¯ç±»å‹ï¼ˆå¿…é¡» > 0ï¼‰
        char data[100]; // ğŸ“ æ¶ˆæ¯æ­£æ–‡ï¼ˆæœ€å¤§é•¿åº¦å¯è°ƒæ•´ï¼‰
    };
    

##### Key ç”Ÿæˆä¸é˜Ÿåˆ—åˆ›å»º

    
    
    key_t key = ftok(pathname, proj_id); // ğŸ—ï¸ ç”Ÿæˆå”¯ä¸€é”®å€¼
    int msgid = msgget(key, flag);       // ğŸšª åˆ›å»º/è·å–é˜Ÿåˆ—
    

  * **`ftok`å‚æ•°**ï¼š 
    * ğŸ“‚ `pathname`ï¼šä»»æ„å­˜åœ¨çš„æ–‡ä»¶è·¯å¾„ï¼ˆæœ¬æ–‡ä½¿ç”¨`/home`ï¼‰
    * ğŸ†” `proj_id`ï¼šé¡¹ç›®æ ‡è¯†ç¬¦ï¼ˆç¡®ä¿ä¸åŒåº”ç”¨ä½¿ç”¨ä¸åŒå€¼ï¼‰

##### å°è£…å‡½æ•°

  * ğŸ†• **`CreateMsg()`** ï¼šåˆ›å»ºæ–°é˜Ÿåˆ—ï¼ˆ`IPC_CREAT | IPC_EXCL`ç¡®ä¿å”¯ä¸€æ€§ï¼‰
  * ğŸ” **`Getmsg()`** ï¼šè·å–å·²æœ‰é˜Ÿåˆ—ï¼ˆè‹¥ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼‰

* * *

#### 2\. å‘é€ç«¯ä»£ç è§£æ ğŸ“¤

    
    
    int main() {
        int msgid = CreateMsg(); // ğŸ—ï¸ åˆ›å»ºé˜Ÿåˆ—
        message msg;
        msg.mytype = 1; // ğŸ·ï¸ è®¾ç½®æ¶ˆæ¯ç±»å‹
        snprintf(msg.data, sizeof(msg.data), "hello from sender\n");
        
        // âœˆï¸ å‘é€æ¶ˆæ¯ï¼ˆé˜»å¡æ¨¡å¼ï¼‰
        msgsnd(msgid, &msg, sizeof(msg.data), 0); 
        std::cout << "Message sent: " << msg.data << std::endl;
        return 0;
    }
    

##### å…³é”®ç‚¹ ğŸ”‘

  * ğŸ¯ **æ¶ˆæ¯ç±»å‹** ï¼šæ¥æ”¶ç«¯é€šè¿‡`mytype`ç­›é€‰æ¶ˆæ¯
  * ğŸš¦ **å‘é€æ¨¡å¼** ï¼š 
    * ğŸ›‘ `0`ï¼šé˜»å¡å‘é€ï¼ˆé˜Ÿåˆ—æ»¡æ—¶ç­‰å¾…ï¼‰
    * ğŸš€ `IPC_NOWAIT`ï¼šéé˜»å¡å‘é€ï¼ˆç«‹å³è¿”å›é”™è¯¯ï¼‰

* * *

#### 3\. æ¥æ”¶ç«¯ä»£ç è§£æ ğŸ“¥

    
    
    int main() {
        int msgid = Getmsg(); // ğŸ” è·å–é˜Ÿåˆ—
        message msg;
        
        // ğŸ“­ æ¥æ”¶ç±»å‹ä¸º1çš„æ¶ˆæ¯ï¼ˆé˜»å¡æ¨¡å¼ï¼‰
        msgrcv(msgid, &msg, sizeof(msg.data), 1, 0); 
        std::cout << msg.data << std::endl;
        
        msgctl(msgid, IPC_RMID, NULL); // ğŸ—‘ï¸ é”€æ¯é˜Ÿåˆ—
        return 0;
    }
    

##### å…³é”®ç‚¹ ğŸ”

  * ğŸ¯ **æ¶ˆæ¯è¿‡æ»¤** ï¼š`msgrcv`çš„ç¬¬4ä¸ªå‚æ•°æŒ‡å®šæ¥æ”¶çš„æ¶ˆæ¯ç±»å‹ 
    * ğŸ¯ `1`ï¼šä»…æ¥æ”¶ç±»å‹ä¸º1çš„æ¶ˆæ¯
    * ğŸ² `0`ï¼šæ¥æ”¶é˜Ÿåˆ—ä¸­ç¬¬ä¸€æ¡æ¶ˆæ¯
    * ğŸ” `-3`ï¼šæ¥æ”¶ç±»å‹ â‰¤3 çš„æœ€å°æ¶ˆæ¯
  * ğŸ§¹ **èµ„æºé‡Šæ”¾** ï¼š`IPC_RMID`ç«‹å³åˆ é™¤é˜Ÿåˆ—

* * *

### äº”ã€å¸¸è§é—®é¢˜ä¸è°ƒè¯•æŠ€å·§ ğŸš¨

#### 1\. ç³»ç»Ÿå‘½ä»¤ ğŸ’»

    
    
    ipcs -q          # ğŸ” æŸ¥çœ‹æ‰€æœ‰æ¶ˆæ¯é˜Ÿåˆ—
    ipcrm -q <msqid> # ğŸ—‘ï¸ æ‰‹åŠ¨åˆ é™¤é˜Ÿåˆ—
    



