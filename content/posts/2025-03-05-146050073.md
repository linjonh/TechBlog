---
layout: post
title: "KubernetesK8S部署-Redis-Cluster-集群"
date: 2025-03-05 18:33:30 +0800
description: "通过以上步骤，我们使用 Kubernetes 的 ConfigMap、Service 和 StatefulSet 成功部署了 Redis Cluster 集群。在实际生产环境中，还可以根据需要调整配置和资源，以满足业务需求。"
keywords: "Kubernetes（K8S）部署 Redis Cluster 集群"
categories: ['未分类']
tags: ['容器', 'Redis', 'Kubernetes']
artid: "146050073"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146050073
    alt: "KubernetesK8S部署-Redis-Cluster-集群"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146050073
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146050073
cover: https://bing.ee123.net/img/rand?artid=146050073
image: https://bing.ee123.net/img/rand?artid=146050073
img: https://bing.ee123.net/img/rand?artid=146050073
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Kubernetes（K8S）部署 Redis Cluster 集群
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     以下将详细介绍如何使用 Kubernetes（K8S）部署 Redis Cluster 集群，并给出相应的 YAML 代码。
    </p>
    <h4>
     <a id="1__3">
     </a>
     1. 准备工作
    </h4>
    <p>
     在开始部署之前，需要确保已经安装并配置好 Kubernetes 集群，并且
     <code>
      kubectl
     </code>
     可以正常与集群通信。
    </p>
    <h4>
     <a id="2__Redis_Cluster_6">
     </a>
     2. 部署 Redis Cluster
    </h4>
    <h5>
     <a id="21__Namespace__8">
     </a>
     2.1 创建 Namespace (可选)
    </h5>
    <p>
     创建一个名为
     <code>
      redis-cluster-namespace.yaml
     </code>
     的文件，内容如下：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>cluster
</code></pre>
    <p>
     使用以下命令创建 Namespace：
    </p>
    <pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> redis-cluster-namespace.yaml
</code></pre>
    <h5>
     <a id="22__Redis__ConfigMap_22">
     </a>
     2.2 创建 Redis 配置文件 ConfigMap
    </h5>
    <p>
     Redis Cluster 需要特定的配置，我们可以通过 ConfigMap 来管理这些配置。创建一个名为
     <code>
      redis-config.yaml
     </code>
     的文件，内容如下：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>config
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>cluster
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis.conf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    port 6379
    cluster-enabled yes
    cluster-config-file /data/nodes.conf
    cluster-node-timeout 5000
    appendonly yes
    # 如果需要密码认证，取消注释并替换密码
    # requirepass yourpassword
    # masterauth yourpassword</span>
</code></pre>
    <p>
     上述配置文件中，
     <code>
      cluster-enabled yes
     </code>
     开启了 Redis Cluster 功能，
     <code>
      cluster-config-file nodes.conf
     </code>
     指定了集群配置文件的名称，这个文件中的内容是由 Redis 集群自动维护和更新的，随着集群的运行，节点的状态、槽位分配等信息可能会发生变化，文件内容也会相应更新，以反映集群的最新状态。
     <code>
      cluster-node-timeout 5000
     </code>
     表示节点超时时间为 5 秒，
     <code>
      appendonly yes
     </code>
     开启了 AOF 持久化。
    </p>
    <p>
     使用以下命令创建 ConfigMap：
    </p>
    <pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> redis-config.yaml
</code></pre>
    <h5>
     <a id="23__Redis__48">
     </a>
     2.3 创建 Redis 服务
    </h5>
    <p>
     创建一个名为
     <code>
      redis-service.yaml
     </code>
     的文件，用于定义 Redis 服务，内容如下：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>service
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>cluster
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>cluster
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
      <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">6379</span>
      <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">6379</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
</code></pre>
    <p>
     这个服务将用于在集群内部暴露 Redis 节点，使用以下命令创建服务：
    </p>
    <pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> redis-service.yaml
</code></pre>
    <h5>
     <a id="24__Redis_StatefulSet_70">
     </a>
     2.4 创建 Redis 有状态集（StatefulSet）
    </h5>
    <p>
     创建一个名为
     <code>
      redis-statefulset.yaml
     </code>
     的文件，用于定义 Redis 有状态集，内容如下：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>cluster
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>cluster
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>cluster<span class="token punctuation">-</span>service
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">6</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>cluster
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>cluster
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis
        <span class="token key atrule">image</span><span class="token punctuation">:</span> redis<span class="token punctuation">:</span>6.2<span class="token punctuation">-</span>alpine
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">6379</span>
        <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">16379</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">]</span>
        <span class="token key atrule">args</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token punctuation">&gt;</span><span class="token scalar string">
          cp /redis-config/redis.conf /data/redis.conf &amp;&amp;
          redis-server /data/redis.conf</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>config
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /redis<span class="token punctuation">-</span>config
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>data
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /data
        <span class="token comment"># 存活探针</span>
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">exec</span><span class="token punctuation">:</span>
            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"redis-cli"</span><span class="token punctuation">,</span> <span class="token string">"ping"</span><span class="token punctuation">]</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
        <span class="token comment"># 就绪探针</span>
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">exec</span><span class="token punctuation">:</span>
            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"redis-cli"</span><span class="token punctuation">,</span> <span class="token string">"ping"</span><span class="token punctuation">]</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>config
        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>config
  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>data
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span> <span class="token string">"ReadWriteOnce"</span> <span class="token punctuation">]</span>
      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token string">"standard"</span> <span class="token comment"># 修改为你的存储类</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span>
        <span class="token key atrule">requests</span><span class="token punctuation">:</span>
          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 1Gi
</code></pre>
    <p>
     上述有状态集创建了 6 个 Redis 节点（一般 Redis Cluster 建议使用 6 个节点，3 主 3 从），并挂载了之前创建的 ConfigMap 和持久化存储卷。使用以下命令创建有状态集：
    </p>
    <pre><code class="prism language-bash">kubectl apply <span class="token parameter variable">-f</span> redis-statefulset.yaml
</code></pre>
    <h5>
     <a id="25__Redis__136">
     </a>
     2.5 创建 Redis 集群
    </h5>
    <p>
     等待所有 Redis 节点启动完成后，可以使用以下命令创建 Redis Cluster：
    </p>
    <pre><code class="prism language-bash">kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> redis-cluster-0 -- redis-cli <span class="token parameter variable">--cluster</span> create <span class="token punctuation">\</span>
<span class="token variable"><span class="token variable">$(</span>kubectl get pods <span class="token parameter variable">-l</span> <span class="token assign-left variable">app</span><span class="token operator">=</span>redis-cluster <span class="token parameter variable">-o</span> <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">'{range.items[*]}{.status.podIP}:6379 '</span><span class="token variable">)</span></span> <span class="token punctuation">\</span>
--cluster-replicas <span class="token number">1</span>
</code></pre>
    <p>
     上述命令中，
     <code>
      --cluster-replicas 1
     </code>
     表示每个主节点有 1 个从节点。
    </p>
    <h4>
     <a id="3__Redis_Cluster__145">
     </a>
     3. 验证 Redis Cluster 部署
    </h4>
    <p>
     可以使用以下命令进入任意一个 Redis 节点的容器，并验证集群是否正常工作：
    </p>
    <pre><code class="prism language-bash">kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> redis-cluster-0 -- redis-cli cluster info
kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> redis-cluster-0 -- redis-cli cluster nodes
</code></pre>
    <p>
     如果上述命令能够正常输出集群信息和节点信息，则说明 Redis Cluster 部署成功。
    </p>
    <h4>
     <a id="_153">
     </a>
     总结
    </h4>
    <p>
     通过以上步骤，我们使用 Kubernetes 的 ConfigMap、Service 和 StatefulSet 成功部署了 Redis Cluster 集群。在实际生产环境中，还可以根据需要调整配置和资源，以满足业务需求。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f5261696e7369726975732f:61727469636c652f64657461696c732f313436303530303733" class_="artid" style="display:none">
 </p>
</div>


