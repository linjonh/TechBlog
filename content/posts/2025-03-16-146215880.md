---
layout: post
title: "从Online-Softmax到FlashAttention"
date: 2025-03-16 22:14:51 +0800
description: "从Online Softmax到FlashAttention"
keywords: "从Online Softmax到FlashAttention"
categories: ['Llm']
tags: ['Softmax', 'Softmax', 'Softmax', 'Safe', 'Online', 'Flashattention', 'Attention']
artid: "146215880"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146215880
    alt: "从Online-Softmax到FlashAttention"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146215880
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146215880
cover: https://bing.ee123.net/img/rand?artid=146215880
image: https://bing.ee123.net/img/rand?artid=146215880
img: https://bing.ee123.net/img/rand?artid=146215880
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     从Online Softmax到FlashAttention
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h3>
     <a id="_2">
     </a>
     前言
    </h3>
    <blockquote>
     <p>
      最近在学习 FlashAttention，看到一份不错的手稿分享下🤗
     </p>
     <p>
      manuscript：
      <a href="https://courses.cs.washington.edu/courses/cse599m/23sp/notes/flashattn.pdf" rel="nofollow">
       From Online Softmax to FlashAttention
      </a>
     </p>
    </blockquote>
    <h3>
     <a id="0_Abstract_8">
     </a>
     0. Abstract
    </h3>
    <p>
     <a rel="nofollow">
      FlashAttention
     </a>
     的关键创新是使用类似于
     <a rel="nofollow">
      Online Softmax
     </a>
     的思想来 tile 分块 self-attention 的计算，这样可以融合整个多头注意力层，而无需多次重复访问 GPU 的全局内存来获取临时变量和注意力分数矩阵
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        A 
        
       
      
        A
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal">
          A
         </span>
        </span>
       </span>
      </span>
     </span>
     。本文将简要解释如何 tiling 分块 self-attention 的计算，以及如何从 online softmax 中推导出 FlashAttention 计算
    </p>
    <h3>
     <a id="1_The_SelfAttention_12">
     </a>
     1. The Self-Attention
    </h3>
    <p>
     Self-Attention 的计算可以描述为：
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         O 
             
            
              = 
             
             
             
               s 
              
             
               o 
              
             
               f 
              
             
               t 
              
             
               m 
              
             
               a 
              
             
               x 
              
             
             
             
               ( 
              
             
               Q 
              
              
              
                K 
               
              
                T 
               
              
             
               ) 
              
             
            
              V 
             
            
           
          
          
          
         
        
       
         \begin{equation} O = \mathrm{softmax}\left(QK^T\right)V \end{equation}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.2513em; vertical-align: -0.3757em;">
          </span>
          <span class="mtable">
           <span class="col-align-c">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8757em;">
               <span class="" style="top: -2.9843em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord mathnormal" style="margin-right: 0.0278em;">
                  O
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mrel">
                  =
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mord">
                  <span class="mord mathrm">
                   softmax
                  </span>
                 </span>
                 <span class="mspace" style="margin-right: 0.1667em;">
                 </span>
                 <span class="minner">
                  <span class="mopen delimcenter" style="top: 0em;">
                   <span class="delimsizing size1">
                    (
                   </span>
                  </span>
                  <span class="mord mathnormal">
                   Q
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal" style="margin-right: 0.0715em;">
                    K
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8913em;">
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                          T
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mclose delimcenter" style="top: 0em;">
                   <span class="delimsizing size1">
                    )
                   </span>
                  </span>
                 </span>
                 <span class="mspace" style="margin-right: 0.1667em;">
                 </span>
                 <span class="mord mathnormal" style="margin-right: 0.2222em;">
                  V
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3757em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="tag">
          <span class="vlist-t vlist-t2">
           <span class="vlist-r">
            <span class="vlist" style="height: 0.8757em;">
             <span class="" style="top: -2.8757em;">
              <span class="pstrut" style="height: 2.8913em;">
              </span>
              <span class="eqn-num">
              </span>
             </span>
            </span>
            <span class="vlist-s">
             ​
            </span>
           </span>
           <span class="vlist-r">
            <span class="vlist" style="height: 0.3757em;">
             <span class="">
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     其中
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        Q 
        
       
         , 
        
       
         K 
        
       
         , 
        
       
         V 
        
       
         , 
        
       
         O 
        
       
         ∈ 
        
        
        
          R 
         
         
         
           L 
          
         
           × 
          
         
           D 
          
         
        
       
      
        Q,K,V,O \in \mathbb{R}^{L\times D}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal">
          Q
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0715em;">
          K
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.2222em;">
          V
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          O
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ∈
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8413em;">
         </span>
         <span class="mord">
          <span class="mord mathbb">
           R
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8413em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  L
                 </span>
                 <span class="mbin mtight">
                  ×
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                  D
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        L 
        
       
      
        L
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal">
          L
         </span>
        </span>
       </span>
      </span>
     </span>
     是序列长度，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        D 
        
       
      
        D
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          D
         </span>
        </span>
       </span>
      </span>
     </span>
     是每个头的维度，softmax 将按列应用于
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        Q 
        
        
        
          K 
         
        
          T 
         
        
       
      
        QK^T
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0358em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal">
          Q
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           K
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8413em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                 T
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     <strong>
      Note
     </strong>
     ：这里我们忽略了多头、多 batch，因为在这些维度上的计算是完全并行的，也就是说我们只关注单头、单 batch 的计算就行。另外为了简单起见，我们也忽略了注意力掩码以及缩放因子
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        1 
         
         
         
           D 
          
         
        
       
      
        \frac{1}{\sqrt{D}}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.3831em; vertical-align: -0.538em;">
         </span>
         <span class="mord">
          <span class="mopen nulldelimiter">
          </span>
          <span class="mfrac">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8451em;">
              <span class="" style="top: -2.5374em;">
               <span class="pstrut" style="height: 3em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord sqrt mtight">
                  <span class="vlist-t vlist-t2">
                   <span class="vlist-r">
                    <span class="vlist" style="height: 0.9323em;">
                     <span class="svg-align" style="top: -3em;">
                      <span class="pstrut" style="height: 3em;">
                      </span>
                      <span class="mord mtight" style="padding-left: 0.833em;">
                       <span class="mord mathnormal mtight" style="margin-right: 0.0278em;">
                        D
                       </span>
                      </span>
                     </span>
                     <span class="" style="top: -2.8923em;">
                      <span class="pstrut" style="height: 3em;">
                      </span>
                      <span class="hide-tail mtight" style="min-width: 0.853em; height: 1.08em;">
                       <svg height="1.08em" preserveaspectratio="xMinYMin slice" viewbox="0 0 400000 1080" width="400em">
                        <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z">
                        </path>
                       </svg>
                      </span>
                     </span>
                    </span>
                    <span class="vlist-s">
                     ​
                    </span>
                   </span>
                   <span class="vlist-r">
                    <span class="vlist" style="height: 0.1077em;">
                     <span class="">
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.23em;">
               <span class="pstrut" style="height: 3em;">
               </span>
               <span class="frac-line" style="border-bottom-width: 0.04em;">
               </span>
              </span>
              <span class="" style="top: -3.394em;">
               <span class="pstrut" style="height: 3em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.538em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose nulldelimiter">
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     计算 self-attention 的标准方法是将其分解为以下几个阶段：
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         X 
            
           
          
          
           
            
             
            
              = 
             
            
              Q 
             
             
             
               K 
              
             
               T 
              
             
            
           
          
          
          
         
         
          
          
           
           
             A 
            
           
          
          
           
            
             
            
              = 
             
             
             
               s 
              
             
               o 
              
             
               f 
              
             
               t 
              
             
               m 
              
             
               a 
              
             
               x 
              
             
            
              ( 
             
            
              X 
             
            
              ) 
             
            
           
          
          
          
         
         
          
          
           
           
             O 
            
           
          
          
           
            
             
            
              = 
             
            
              A 
             
            
              V 
             
            
           
          
          
          
         
        
       
         \begin{align} X &amp; = QK^T \\ A &amp; = \mathrm{softmax}(X) \\ O &amp; = AV \end{align}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 4.5513em; vertical-align: -2.0257em;">
          </span>
          <span class="mtable">
           <span class="col-align-r">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 2.5257em;">
               <span class="" style="top: -4.6343em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord mathnormal" style="margin-right: 0.0785em;">
                  X
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.1343em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord mathnormal">
                  A
                 </span>
                </span>
               </span>
               <span class="" style="top: -1.6343em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord mathnormal" style="margin-right: 0.0278em;">
                  O
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 2.0257em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="col-align-l">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 2.5257em;">
               <span class="" style="top: -4.6343em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mrel">
                  =
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mord mathnormal">
                  Q
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal" style="margin-right: 0.0715em;">
                   K
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.8913em;">
                      <span class="" style="top: -3.113em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                         T
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.1343em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mrel">
                  =
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mord">
                  <span class="mord mathrm">
                   softmax
                  </span>
                 </span>
                 <span class="mopen">
                  (
                 </span>
                 <span class="mord mathnormal" style="margin-right: 0.0785em;">
                  X
                 </span>
                 <span class="mclose">
                  )
                 </span>
                </span>
               </span>
               <span class="" style="top: -1.6343em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mrel">
                  =
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mord mathnormal">
                  A
                 </span>
                 <span class="mord mathnormal" style="margin-right: 0.2222em;">
                  V
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 2.0257em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="tag">
          <span class="vlist-t vlist-t2">
           <span class="vlist-r">
            <span class="vlist" style="height: 2.5257em;">
             <span class="" style="top: -4.5257em;">
              <span class="pstrut" style="height: 2.8913em;">
              </span>
              <span class="eqn-num">
              </span>
             </span>
             <span class="" style="top: -3.0257em;">
              <span class="pstrut" style="height: 2.8913em;">
              </span>
              <span class="eqn-num">
              </span>
             </span>
             <span class="" style="top: -1.5257em;">
              <span class="pstrut" style="height: 2.8913em;">
              </span>
              <span class="eqn-num">
              </span>
             </span>
            </span>
            <span class="vlist-s">
             ​
            </span>
           </span>
           <span class="vlist-r">
            <span class="vlist" style="height: 2.0257em;">
             <span class="">
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     我们称
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        X 
        
       
      
        X
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0785em;">
          X
         </span>
        </span>
       </span>
      </span>
     </span>
     矩阵为 pre-softmax logits，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        A 
        
       
      
        A
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal">
          A
         </span>
        </span>
       </span>
      </span>
     </span>
     矩阵为注意力分数（attention score），
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        O 
        
       
      
        O
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          O
         </span>
        </span>
       </span>
      </span>
     </span>
     矩阵为输出
    </p>
    <p>
     FlashAttention 的一个惊人之处在于，我们不需要在全局内存（global memory）上实现
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        X 
        
       
      
        X
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0785em;">
          X
         </span>
        </span>
       </span>
      </span>
     </span>
     和
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        A 
        
       
      
        A
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal">
          A
         </span>
        </span>
       </span>
      </span>
     </span>
     矩阵，而是将公式 (1) 中的整个计算融合到单个 CUDA kernel 中。这要求我们设计一种能够精心管理片上内存（on-chip memory）的算法，因为 NVIDIA GPU 的共享内存（shared memory）非常小
    </p>
    <p>
     对于矩阵乘法等经典算法，我们通常会使用 tiling 技术来确保片上内存不超过硬件限制。下图提供了一个例子，在 kernel 执行期间，无论矩阵形状如何，只有
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        3 
        
        
        
          T 
         
        
          2 
         
        
       
      
        3T^2
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8141em;">
         </span>
         <span class="mord">
          3
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           T
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8141em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 2
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     个元素存储在片上。这种 tiling 方法之所以有效，是因为加法是关联的，允许将整个矩阵乘法分解为许多 tile-wise 矩阵乘法的总和
    </p>
    <p>
     然而，Self-Attention 包含一个不直接关联的 softmax 运算符，因此很难像下图那样简单地对 Self-Attention 进行 tile，那有没有办法让 softmax 具有关联性呢？🤔
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/158826e34d414323b046e9a21c2c339f.png#pic_center"/>
    </p>
    <p>
     上图简要说明了如何对矩阵乘法
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        C 
        
       
         = 
        
       
         A 
        
       
         × 
        
       
         B 
        
       
      
        C=A\times B
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0715em;">
          C
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;">
         </span>
         <span class="mord mathnormal">
          A
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          ×
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0502em;">
          B
         </span>
        </span>
       </span>
      </span>
     </span>
     的输入和输出矩阵进行 tile（分块），矩阵被划分为
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        T 
        
       
         × 
        
       
         T 
        
       
      
        T\times T
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.1389em;">
          T
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          ×
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.1389em;">
          T
         </span>
        </span>
       </span>
      </span>
     </span>
     个小块。对于每个输出块，我们从左到右遍历
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        A 
        
       
      
        A
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal">
          A
         </span>
        </span>
       </span>
      </span>
     </span>
     中的相关块，从上到下遍历
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        B 
        
       
      
        B
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0502em;">
          B
         </span>
        </span>
       </span>
      </span>
     </span>
     中的相关块，并将它们的值从全局内存（global memory）加载到片上内存（on-chip memory）（以蓝色表示，整体片上内存占用为
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        O 
        
       
         ( 
        
        
        
          T 
         
        
          2 
         
        
       
         ) 
        
       
      
        O(T^2)
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0641em; vertical-align: -0.25em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          O
         </span>
         <span class="mopen">
          (
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           T
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8141em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 2
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mclose">
          )
         </span>
        </span>
       </span>
      </span>
     </span>
     ）
    </p>
    <p>
     接着逐块进行矩阵乘法，对于位置
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        ( 
        
       
         i 
        
       
         , 
        
       
         j 
        
       
         ) 
        
       
      
        (i,j)
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mopen">
          (
         </span>
         <span class="mord mathnormal">
          i
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0572em;">
          j
         </span>
         <span class="mclose">
          )
         </span>
        </span>
       </span>
      </span>
     </span>
     ，我们先从片上内存中加载块内所有
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        i 
        
       
      
        i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6595em;">
         </span>
         <span class="mord mathnormal">
          i
         </span>
        </span>
       </span>
      </span>
     </span>
     行的元素即
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        A 
        
       
         [ 
        
       
         i 
        
       
         , 
        
       
         k 
        
       
         ] 
        
       
      
        A[i,k]
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord mathnormal">
          A
         </span>
         <span class="mopen">
          [
         </span>
         <span class="mord mathnormal">
          i
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0315em;">
          k
         </span>
         <span class="mclose">
          ]
         </span>
        </span>
       </span>
      </span>
     </span>
     以及所有
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        j 
        
       
      
        j
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.854em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0572em;">
          j
         </span>
        </span>
       </span>
      </span>
     </span>
     列的元素即
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        B 
        
       
         [ 
        
       
         k 
        
       
         , 
        
       
         j 
        
       
         ] 
        
       
      
        B[k,j]
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0502em;">
          B
         </span>
         <span class="mopen">
          [
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0315em;">
          k
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0572em;">
          j
         </span>
         <span class="mclose">
          ]
         </span>
        </span>
       </span>
      </span>
     </span>
     （以红色表示），然后利用
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        A 
        
       
         [ 
        
       
         i 
        
       
         , 
        
       
         k 
        
       
         ] 
        
       
      
        A[i,k]
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord mathnormal">
          A
         </span>
         <span class="mopen">
          [
         </span>
         <span class="mord mathnormal">
          i
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0315em;">
          k
         </span>
         <span class="mclose">
          ]
         </span>
        </span>
       </span>
      </span>
     </span>
     和
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        B 
        
       
         [ 
        
       
         k 
        
       
         , 
        
       
         j 
        
       
         ] 
        
       
      
        B[k,j]
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0502em;">
          B
         </span>
         <span class="mopen">
          [
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0315em;">
          k
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0572em;">
          j
         </span>
         <span class="mclose">
          ]
         </span>
        </span>
       </span>
      </span>
     </span>
     计算得到片上内存中的
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        C 
        
       
         [ 
        
       
         i 
        
       
         , 
        
       
         j 
        
       
         ] 
        
       
      
        C[i,j]
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0715em;">
          C
         </span>
         <span class="mopen">
          [
         </span>
         <span class="mord mathnormal">
          i
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0572em;">
          j
         </span>
         <span class="mclose">
          ]
         </span>
        </span>
       </span>
      </span>
     </span>
     。以此循环，直到完成一个块的计算后，我们再将片上
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        C 
        
       
      
        C
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0715em;">
          C
         </span>
        </span>
       </span>
      </span>
     </span>
     块的结果写回主内存并继续处理下一个块
    </p>
    <p>
     实际 tiling 的应用要复杂得多，大家可以参考：
     <a href="https://developer.download.nvidia.com/video/gputechconf/gtc/2020/presentations/s21745-developing-cuda-kernels-to-push-tensor-cores-to-the-absolute-limit-on-nvidia-a100.pdf" rel="nofollow">
      cutlass 在 A100 上实现矩阵乘法
     </a>
    </p>
    <h3>
     <a id="2_Safe_Softmax_53">
     </a>
     2. (Safe) Softmax
    </h3>
    <p>
     我们先回顾一下 softmax 算子，下面是 softmax 计算的通用公式：
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         s 
              
             
               o 
              
             
               f 
              
             
               t 
              
             
               m 
              
             
               a 
              
             
               x 
              
             
            
              ( 
             
            
              { 
             
             
             
               x 
              
             
               1 
              
             
            
              , 
             
            
              … 
             
            
              , 
             
             
             
               x 
              
             
               N 
              
             
            
              } 
             
            
              ) 
             
            
              = 
             
             
              
              
                { 
               
               
                
                
                  e 
                 
                 
                 
                   x 
                  
                 
                   i 
                  
                 
                
                
                 
                 
                   ∑ 
                  
                  
                  
                    j 
                   
                  
                    = 
                   
                  
                    1 
                   
                  
                 
                   N 
                  
                 
                 
                 
                   e 
                  
                  
                  
                    x 
                   
                  
                    j 
                   
                  
                 
                
               
              
                } 
               
              
              
              
                i 
               
              
                = 
               
              
                1 
               
              
             
               N 
              
             
            
           
          
          
          
         
        
       
         \begin{equation} \mathrm{softmax}(\{x_1,\ldots,x_N\})=\left\{\frac{e^{x_i}}{\sum_{j=1}^Ne^{x_j}}\right\}_{i=1}^N \end{equation}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 3.338em; vertical-align: -1.419em;">
          </span>
          <span class="mtable">
           <span class="col-align-c">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.919em;">
               <span class="" style="top: -3.919em;">
                <span class="pstrut" style="height: 3.9812em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mord mathrm">
                   softmax
                  </span>
                 </span>
                 <span class="mopen">
                  ({
                  <!-- -->
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal">
                   x
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3011em;">
                      <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         1
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.15em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mpunct">
                  ,
                 </span>
                 <span class="mspace" style="margin-right: 0.1667em;">
                 </span>
                 <span class="minner">
                  …
                 </span>
                 <span class="mspace" style="margin-right: 0.1667em;">
                 </span>
                 <span class="mpunct">
                  ,
                 </span>
                 <span class="mspace" style="margin-right: 0.1667em;">
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal">
                   x
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3283em;">
                      <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                         N
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.15em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mclose">
                  })
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mrel">
                  =
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="minner">
                  <span class="minner">
                   <span class="mopen delimcenter" style="top: 0em;">
                    <span class="delimsizing size4">
                     {
                     <!-- -->
                    </span>
                   </span>
                   <span class="mord">
                    <span class="mopen nulldelimiter">
                    </span>
                    <span class="mfrac">
                     <span class="vlist-t vlist-t2">
                      <span class="vlist-r">
                       <span class="vlist" style="height: 1.3414em;">
                        <span class="" style="top: -2.1288em;">
                         <span class="pstrut" style="height: 3em;">
                         </span>
                         <span class="mord">
                          <span class="mop">
                           <span class="mop op-symbol small-op" style="position: relative; top: 0em;">
                            ∑
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.9812em;">
                               <span class="" style="top: -2.4003em; margin-left: 0em; margin-right: 0.05em;">
                                <span class="pstrut" style="height: 2.7em;">
                                </span>
                                <span class="sizing reset-size6 size3 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                   j
                                  </span>
                                  <span class="mrel mtight">
                                   =
                                  </span>
                                  <span class="mord mtight">
                                   1
                                  </span>
                                 </span>
                                </span>
                               </span>
                               <span class="" style="top: -3.2029em; margin-right: 0.05em;">
                                <span class="pstrut" style="height: 2.7em;">
                                </span>
                                <span class="sizing reset-size6 size3 mtight">
                                 <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                                  N
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.4358em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mspace" style="margin-right: 0.1667em;">
                          </span>
                          <span class="mord">
                           <span class="mord mathnormal">
                            e
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.6065em;">
                               <span class="" style="top: -3.0051em; margin-right: 0.05em;">
                                <span class="pstrut" style="height: 2.7em;">
                                </span>
                                <span class="sizing reset-size6 size3 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mtight">
                                   <span class="mord mathnormal mtight">
                                    x
                                   </span>
                                   <span class="msupsub">
                                    <span class="vlist-t vlist-t2">
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.3281em;">
                                       <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                        <span class="pstrut" style="height: 2.5em;">
                                        </span>
                                        <span class="sizing reset-size3 size1 mtight">
                                         <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                          j
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                      <span class="vlist-s">
                                       ​
                                      </span>
                                     </span>
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.2819em;">
                                       <span class="">
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                        <span class="" style="top: -3.23em;">
                         <span class="pstrut" style="height: 3em;">
                         </span>
                         <span class="frac-line" style="border-bottom-width: 0.04em;">
                         </span>
                        </span>
                        <span class="" style="top: -3.677em;">
                         <span class="pstrut" style="height: 3em;">
                         </span>
                         <span class="mord">
                          <span class="mord">
                           <span class="mord mathnormal">
                            e
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.6644em;">
                               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                <span class="pstrut" style="height: 2.7em;">
                                </span>
                                <span class="sizing reset-size6 size3 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mtight">
                                   <span class="mord mathnormal mtight">
                                    x
                                   </span>
                                   <span class="msupsub">
                                    <span class="vlist-t vlist-t2">
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.3281em;">
                                       <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                        <span class="pstrut" style="height: 2.5em;">
                                        </span>
                                        <span class="sizing reset-size3 size1 mtight">
                                         <span class="mord mathnormal mtight">
                                          i
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                      <span class="vlist-s">
                                       ​
                                      </span>
                                     </span>
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.143em;">
                                       <span class="">
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="vlist-s">
                        ​
                       </span>
                      </span>
                      <span class="vlist-r">
                       <span class="vlist" style="height: 1.307em;">
                        <span class="">
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                    <span class="mclose nulldelimiter">
                    </span>
                   </span>
                   <span class="mclose delimcenter" style="top: 0em;">
                    <span class="delimsizing size4">
                     }
                    </span>
                   </span>
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 1.9812em;">
                      <span class="" style="top: -1.3433em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                         <span class="mrel mtight">
                          =
                         </span>
                         <span class="mord mtight">
                          1
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -4.2029em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                         N
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 1.3567em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 1.419em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="tag">
          <span class="vlist-t vlist-t2">
           <span class="vlist-r">
            <span class="vlist" style="height: 1.919em;">
             <span class="" style="top: -3.919em;">
              <span class="pstrut" style="height: 3.9812em;">
              </span>
              <span class="eqn-num">
              </span>
             </span>
            </span>
            <span class="vlist-s">
             ​
            </span>
           </span>
           <span class="vlist-r">
            <span class="vlist" style="height: 1.419em;">
             <span class="">
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     值得注意的是，当
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        x 
         
        
          i 
         
        
       
      
        x_i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           x
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     比较大时
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        e 
         
         
         
           x 
          
         
           i 
          
         
        
       
      
        e^{x_i}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6644em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           e
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.6644em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   x
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3281em;">
                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                       <span class="pstrut" style="height: 2.5em;">
                       </span>
                       <span class="sizing reset-size3 size1 mtight">
                        <span class="mord mathnormal mtight">
                         i
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.143em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     很容易溢出，例如 float16 可以支持的最大值是 65536，这意味着当
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        x 
        
       
         ⩾ 
        
       
         11 
        
       
      
        x \geqslant 11
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7733em; vertical-align: -0.1367em;">
         </span>
         <span class="mord mathnormal">
          x
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel amsrm">
          ⩾
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6444em;">
         </span>
         <span class="mord">
          11
         </span>
        </span>
       </span>
      </span>
     </span>
     时，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        e 
         
        
          x 
         
        
       
      
        e^x
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6644em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           e
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.6644em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 x
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     将超过 float16 的有效范围
    </p>
    <p>
     为了解决这个问题，像 pytorch、tensorflow 等框架通常会使用一种被称为 “safe” 的 softmax 计算方法：
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         e 
               
               
               
                 x 
                
               
                 i 
                
               
              
              
               
               
                 ∑ 
                
                
                
                  j 
                 
                
                  = 
                 
                
                  1 
                 
                
               
                 N 
                
               
               
               
                 e 
                
                
                
                  x 
                 
                
                  j 
                 
                
               
              
             
            
              = 
             
             
              
              
                e 
               
               
                
                
                  x 
                 
                
                  i 
                 
                
               
                 − 
                
               
                 m 
                
               
              
              
               
               
                 ∑ 
                
                
                
                  j 
                 
                
                  = 
                 
                
                  1 
                 
                
               
                 N 
                
               
               
               
                 e 
                
                
                 
                 
                   x 
                  
                 
                   j 
                  
                 
                
                  − 
                 
                
                  m 
                 
                
               
              
             
            
           
          
          
          
         
        
       
         \begin{equation} \frac{e^{x_{i}}}{\sum_{j=1}^{N}e^{x_{j}}}=\frac{e^{x_{i}-m}}{\sum_{j=1}^{N}e^{x_{j}-m}} \end{equation}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 2.7554em; vertical-align: -1.1277em;">
          </span>
          <span class="mtable">
           <span class="col-align-c">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.6277em;">
               <span class="" style="top: -3.6277em;">
                <span class="pstrut" style="height: 3.4483em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mopen nulldelimiter">
                  </span>
                  <span class="mfrac">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 1.3414em;">
                      <span class="" style="top: -2.1288em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="mord">
                        <span class="mop">
                         <span class="mop op-symbol small-op" style="position: relative; top: 0em;">
                          ∑
                         </span>
                         <span class="msupsub">
                          <span class="vlist-t vlist-t2">
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.9812em;">
                             <span class="" style="top: -2.4003em; margin-left: 0em; margin-right: 0.05em;">
                              <span class="pstrut" style="height: 2.7em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mtight">
                                <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                 j
                                </span>
                                <span class="mrel mtight">
                                 =
                                </span>
                                <span class="mord mtight">
                                 1
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="" style="top: -3.2029em; margin-right: 0.05em;">
                              <span class="pstrut" style="height: 2.7em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mtight">
                                <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                                 N
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                            <span class="vlist-s">
                             ​
                            </span>
                           </span>
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.4358em;">
                             <span class="">
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                        <span class="mspace" style="margin-right: 0.1667em;">
                        </span>
                        <span class="mord">
                         <span class="mord mathnormal">
                          e
                         </span>
                         <span class="msupsub">
                          <span class="vlist-t">
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.6065em;">
                             <span class="" style="top: -3.0051em; margin-right: 0.05em;">
                              <span class="pstrut" style="height: 2.7em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  x
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.3281em;">
                                     <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                      <span class="pstrut" style="height: 2.5em;">
                                      </span>
                                      <span class="sizing reset-size3 size1 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                         j
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.2819em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -3.23em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="frac-line" style="border-bottom-width: 0.04em;">
                       </span>
                      </span>
                      <span class="" style="top: -3.677em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="mord">
                        <span class="mord">
                         <span class="mord mathnormal">
                          e
                         </span>
                         <span class="msupsub">
                          <span class="vlist-t">
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.6644em;">
                             <span class="" style="top: -3.063em; margin-right: 0.05em;">
                              <span class="pstrut" style="height: 2.7em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  x
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.3281em;">
                                     <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                      <span class="pstrut" style="height: 2.5em;">
                                      </span>
                                      <span class="sizing reset-size3 size1 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.143em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 1.307em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mclose nulldelimiter">
                  </span>
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mrel">
                  =
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mord">
                  <span class="mopen nulldelimiter">
                  </span>
                  <span class="mfrac">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 1.4483em;">
                      <span class="" style="top: -2.1288em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="mord">
                        <span class="mop">
                         <span class="mop op-symbol small-op" style="position: relative; top: 0em;">
                          ∑
                         </span>
                         <span class="msupsub">
                          <span class="vlist-t vlist-t2">
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.9812em;">
                             <span class="" style="top: -2.4003em; margin-left: 0em; margin-right: 0.05em;">
                              <span class="pstrut" style="height: 2.7em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mtight">
                                <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                 j
                                </span>
                                <span class="mrel mtight">
                                 =
                                </span>
                                <span class="mord mtight">
                                 1
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="" style="top: -3.2029em; margin-right: 0.05em;">
                              <span class="pstrut" style="height: 2.7em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mtight">
                                <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                                 N
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                            <span class="vlist-s">
                             ​
                            </span>
                           </span>
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.4358em;">
                             <span class="">
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                        <span class="mspace" style="margin-right: 0.1667em;">
                        </span>
                        <span class="mord">
                         <span class="mord mathnormal">
                          e
                         </span>
                         <span class="msupsub">
                          <span class="vlist-t">
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.7134em;">
                             <span class="" style="top: -3.0051em; margin-right: 0.05em;">
                              <span class="pstrut" style="height: 2.7em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  x
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.3281em;">
                                     <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                      <span class="pstrut" style="height: 2.5em;">
                                      </span>
                                      <span class="sizing reset-size3 size1 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                         j
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.2819em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                                <span class="mbin mtight">
                                 −
                                </span>
                                <span class="mord mathnormal mtight">
                                 m
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -3.23em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="frac-line" style="border-bottom-width: 0.04em;">
                       </span>
                      </span>
                      <span class="" style="top: -3.677em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="mord">
                        <span class="mord">
                         <span class="mord mathnormal">
                          e
                         </span>
                         <span class="msupsub">
                          <span class="vlist-t">
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.7713em;">
                             <span class="" style="top: -3.063em; margin-right: 0.05em;">
                              <span class="pstrut" style="height: 2.7em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  x
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.3281em;">
                                     <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                      <span class="pstrut" style="height: 2.5em;">
                                      </span>
                                      <span class="sizing reset-size3 size1 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.143em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                                <span class="mbin mtight">
                                 −
                                </span>
                                <span class="mord mathnormal mtight">
                                 m
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 1.307em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mclose nulldelimiter">
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 1.1277em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="tag">
          <span class="vlist-t vlist-t2">
           <span class="vlist-r">
            <span class="vlist" style="height: 1.6277em;">
             <span class="" style="top: -3.6277em;">
              <span class="pstrut" style="height: 3.4483em;">
              </span>
              <span class="eqn-num">
              </span>
             </span>
            </span>
            <span class="vlist-s">
             ​
            </span>
           </span>
           <span class="vlist-r">
            <span class="vlist" style="height: 1.1277em;">
             <span class="">
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     其中
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        m 
        
       
         = 
        
        
         
         
           max 
          
         
           ⁡ 
          
         
         
         
           j 
          
         
           = 
          
         
           1 
          
         
        
          N 
         
        
       
         ( 
        
        
        
          x 
         
        
          j 
         
        
       
         ) 
        
       
      
        m=\max_{j=1}^{N}(x_j)
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal">
          m
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1.2361em; vertical-align: -0.3948em;">
         </span>
         <span class="mop">
          <span class="mop">
           max
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8413em;">
              <span class="" style="top: -2.4413em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  j
                 </span>
                 <span class="mrel mtight">
                  =
                 </span>
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                  N
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3948em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mopen">
          (
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           x
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                 j
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2861em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mclose">
          )
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     我们将
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        x 
         
        
          i 
         
        
       
      
        x_i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           x
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     减去它们中的最大值，这样可以确保每个元素
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        x 
         
        
          i 
         
        
       
         − 
        
       
         m 
        
       
         ⩽ 
        
       
         0 
        
       
      
        x_i-m \leqslant 0
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7333em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           x
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          −
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.7733em; vertical-align: -0.1367em;">
         </span>
         <span class="mord mathnormal">
          m
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel amsrm">
          ⩽
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6444em;">
         </span>
         <span class="mord">
          0
         </span>
        </span>
       </span>
      </span>
     </span>
     ，从而再做指数运算时可以确保其值不会溢出
    </p>
    <p>
     我们可以将 safe softmax 的计算总结为下面的 3-pass 算法：
    </p>
    <p>
     <strong>
      Algorithm 3-pass safe softmax
     </strong>
    </p>
    <p>
     NOTATIONS
    </p>
    <ul>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         { 
         
         
         
           m 
          
         
           i 
          
         
        
          } 
         
        
       
         \{m_i\}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mopen">
           {
           <!-- -->
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            m
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           }
          </span>
         </span>
        </span>
       </span>
      </span>
      ：
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         max 
           
          
            ⁡ 
           
          
          
          
            j 
           
          
            = 
           
          
            1 
           
          
         
           i 
          
         
        
          { 
         
         
         
           x 
          
         
           j 
          
         
        
          } 
         
        
       
         \max_{j=1}^i\{x_j\}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.2194em; vertical-align: -0.3948em;">
          </span>
          <span class="mop">
           <span class="mop">
            max
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8247em;">
               <span class="" style="top: -2.4413em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   j
                  </span>
                  <span class="mrel mtight">
                   =
                  </span>
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3948em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mopen">
           {
           <!-- -->
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            x
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  j
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           }
          </span>
         </span>
        </span>
       </span>
      </span>
      ，初始值
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         m 
          
         
           0 
          
         
        
          = 
         
        
          − 
         
        
          ∞ 
         
        
       
         m_0=-\infty
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            m
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  0
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6667em; vertical-align: -0.0833em;">
          </span>
          <span class="mord">
           −
          </span>
          <span class="mord">
           ∞
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         { 
         
         
         
           d 
          
         
           i 
          
         
        
          } 
         
        
       
         \{d_i\}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mopen">
           {
           <!-- -->
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           }
          </span>
         </span>
        </span>
       </span>
      </span>
      ：
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         ∑ 
          
          
          
            j 
           
          
            = 
           
          
            1 
           
          
         
           i 
          
         
         
         
           e 
          
          
           
           
             x 
            
           
             j 
            
           
          
            − 
           
           
           
             m 
            
           
             N 
            
           
          
         
        
       
         \sum_{j=1}^{i}e^{x_{j}-m_{N}}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.4004em; vertical-align: -0.4358em;">
          </span>
          <span class="mop">
           <span class="mop op-symbol small-op" style="position: relative; top: 0em;">
            ∑
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.9646em;">
               <span class="" style="top: -2.4003em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   j
                  </span>
                  <span class="mrel mtight">
                   =
                  </span>
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.2029em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   i
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.4358em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            e
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.7713em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight">
                    x
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3281em;">
                       <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                        <span class="pstrut" style="height: 2.5em;">
                        </span>
                        <span class="sizing reset-size3 size1 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                           j
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.2819em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mbin mtight">
                   −
                  </span>
                  <span class="mord mtight">
                   <span class="mord mathnormal mtight">
                    m
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3448em;">
                       <span class="" style="top: -2.3567em; margin-left: 0em; margin-right: 0.0714em;">
                        <span class="pstrut" style="height: 2.5em;">
                        </span>
                        <span class="sizing reset-size3 size1 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                           N
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.1433em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ，初始值
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         d 
          
         
           0 
          
         
        
          = 
         
        
          0 
         
        
       
         d_0=0
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  0
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6444em;">
          </span>
          <span class="mord">
           0
          </span>
         </span>
        </span>
       </span>
      </span>
      ，
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         d 
          
         
           N 
          
         
        
       
         d_N
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                  N
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      是 safe softmax 的分母
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         { 
         
         
         
           a 
          
         
           i 
          
         
        
          } 
         
        
       
         \{a_i\}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mopen">
           {
           <!-- -->
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            a
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           }
          </span>
         </span>
        </span>
       </span>
      </span>
      ：最终的 softmax 值
     </li>
    </ul>
    <p>
     BODY
    </p>
    <p>
     <strong>
      for
     </strong>
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        i 
        
       
         ← 
        
       
         1 
        
       
         , 
        
       
         N 
        
       
      
        i\leftarrow1,N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6595em;">
         </span>
         <span class="mord mathnormal">
          i
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ←
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          1
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.109em;">
          N
         </span>
        </span>
       </span>
      </span>
     </span>
     <strong>
      do
     </strong>
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         m 
              
             
               i 
              
             
            
              ← 
             
            
              max 
             
            
              ⁡ 
             
            
              ( 
             
             
             
               m 
              
              
              
                i 
               
              
                − 
               
              
                1 
               
              
             
            
              , 
             
             
             
               x 
              
             
               i 
              
             
            
              ) 
             
            
           
          
          
          
         
        
       
         \begin{equation} m_i \leftarrow \max (m_{i-1},x_i) \end{equation}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.2em; vertical-align: -0.35em;">
          </span>
          <span class="mtable">
           <span class="col-align-c">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.85em;">
               <span class="" style="top: -3.01em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mord mathnormal">
                   m
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3117em;">
                      <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight">
                         i
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.15em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mrel">
                  ←
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mop">
                  max
                 </span>
                 <span class="mopen">
                  (
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal">
                   m
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3117em;">
                      <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                         <span class="mbin mtight">
                          −
                         </span>
                         <span class="mord mtight">
                          1
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.2083em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mpunct">
                  ,
                 </span>
                 <span class="mspace" style="margin-right: 0.1667em;">
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal">
                   x
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3117em;">
                      <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight">
                         i
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.15em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mclose">
                  )
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.35em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="tag">
          <span class="vlist-t vlist-t2">
           <span class="vlist-r">
            <span class="vlist" style="height: 0.85em;">
             <span class="" style="top: -2.85em;">
              <span class="pstrut" style="height: 2.84em;">
              </span>
              <span class="eqn-num">
              </span>
             </span>
            </span>
            <span class="vlist-s">
             ​
            </span>
           </span>
           <span class="vlist-r">
            <span class="vlist" style="height: 0.35em;">
             <span class="">
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     <strong>
      end
     </strong>
    </p>
    <p>
     <strong>
      for
     </strong>
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        i 
        
       
         ← 
        
       
         1 
        
       
         , 
        
       
         N 
        
       
      
        i\leftarrow1,N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6595em;">
         </span>
         <span class="mord mathnormal">
          i
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ←
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          1
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.109em;">
          N
         </span>
        </span>
       </span>
      </span>
     </span>
     <strong>
      do
     </strong>
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         d 
              
             
               i 
              
             
            
              ← 
             
             
             
               d 
              
              
              
                i 
               
              
                − 
               
              
                1 
               
              
             
            
              + 
             
             
             
               e 
              
              
               
               
                 x 
                
               
                 i 
                
               
              
                − 
               
               
               
                 m 
                
               
                 N 
                
               
              
             
            
           
          
          
          
         
        
       
         \begin{equation} d_i \leftarrow d_{i-1} + e^{x_i-m_N} \end{equation}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.2em; vertical-align: -0.35em;">
          </span>
          <span class="mtable">
           <span class="col-align-c">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.85em;">
               <span class="" style="top: -3.01em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mord mathnormal">
                   d
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3117em;">
                      <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight">
                         i
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.15em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mrel">
                  ←
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal">
                   d
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3117em;">
                      <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                         <span class="mbin mtight">
                          −
                         </span>
                         <span class="mord mtight">
                          1
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.2083em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mspace" style="margin-right: 0.2222em;">
                 </span>
                 <span class="mbin">
                  +
                 </span>
                 <span class="mspace" style="margin-right: 0.2222em;">
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal">
                   e
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.8213em;">
                      <span class="" style="top: -3.113em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           x
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.3281em;">
                              <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                               <span class="pstrut" style="height: 2.5em;">
                               </span>
                               <span class="sizing reset-size3 size1 mtight">
                                <span class="mord mathnormal mtight">
                                 i
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.143em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                         <span class="mbin mtight">
                          −
                         </span>
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           m
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.3448em;">
                              <span class="" style="top: -2.3567em; margin-left: 0em; margin-right: 0.0714em;">
                               <span class="pstrut" style="height: 2.5em;">
                               </span>
                               <span class="sizing reset-size3 size1 mtight">
                                <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                                 N
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.1433em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.35em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="tag">
          <span class="vlist-t vlist-t2">
           <span class="vlist-r">
            <span class="vlist" style="height: 0.85em;">
             <span class="" style="top: -2.85em;">
              <span class="pstrut" style="height: 2.84em;">
              </span>
              <span class="eqn-num">
              </span>
             </span>
            </span>
            <span class="vlist-s">
             ​
            </span>
           </span>
           <span class="vlist-r">
            <span class="vlist" style="height: 0.35em;">
             <span class="">
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     <strong>
      end
     </strong>
    </p>
    <p>
     <strong>
      for
     </strong>
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        i 
        
       
         ← 
        
       
         1 
        
       
         , 
        
       
         N 
        
       
      
        i\leftarrow1,N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6595em;">
         </span>
         <span class="mord mathnormal">
          i
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ←
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          1
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.109em;">
          N
         </span>
        </span>
       </span>
      </span>
     </span>
     <strong>
      do
     </strong>
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         a 
              
             
               i 
              
             
            
              ← 
             
             
              
              
                e 
               
               
                
                
                  x 
                 
                
                  i 
                 
                
               
                 − 
                
                
                
                  m 
                 
                
                  N 
                 
                
               
              
              
              
                d 
               
              
                N 
               
              
             
            
           
          
          
          
         
        
       
         \begin{equation} a_i \leftarrow \frac{e^{x_i-m_N}}{d_N} \end{equation}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 2.2843em; vertical-align: -0.8922em;">
          </span>
          <span class="mtable">
           <span class="col-align-c">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.3922em;">
               <span class="" style="top: -3.3922em;">
                <span class="pstrut" style="height: 3.4483em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mord mathnormal">
                   a
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3117em;">
                      <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight">
                         i
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.15em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mrel">
                  ←
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mord">
                  <span class="mopen nulldelimiter">
                  </span>
                  <span class="mfrac">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 1.4483em;">
                      <span class="" style="top: -2.314em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="mord">
                        <span class="mord">
                         <span class="mord mathnormal">
                          d
                         </span>
                         <span class="msupsub">
                          <span class="vlist-t vlist-t2">
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.3283em;">
                             <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                              <span class="pstrut" style="height: 2.7em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                                N
                               </span>
                              </span>
                             </span>
                            </span>
                            <span class="vlist-s">
                             ​
                            </span>
                           </span>
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.15em;">
                             <span class="">
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -3.23em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="frac-line" style="border-bottom-width: 0.04em;">
                       </span>
                      </span>
                      <span class="" style="top: -3.677em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="mord">
                        <span class="mord">
                         <span class="mord mathnormal">
                          e
                         </span>
                         <span class="msupsub">
                          <span class="vlist-t">
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.7713em;">
                             <span class="" style="top: -3.063em; margin-right: 0.05em;">
                              <span class="pstrut" style="height: 2.7em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  x
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.3281em;">
                                     <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                      <span class="pstrut" style="height: 2.5em;">
                                      </span>
                                      <span class="sizing reset-size3 size1 mtight">
                                       <span class="mord mathnormal mtight">
                                        i
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.143em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                                <span class="mbin mtight">
                                 −
                                </span>
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  m
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.3448em;">
                                     <span class="" style="top: -2.3567em; margin-left: 0em; margin-right: 0.0714em;">
                                      <span class="pstrut" style="height: 2.5em;">
                                      </span>
                                      <span class="sizing reset-size3 size1 mtight">
                                       <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                                        N
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.1433em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.836em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mclose nulldelimiter">
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8922em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="tag">
          <span class="vlist-t vlist-t2">
           <span class="vlist-r">
            <span class="vlist" style="height: 1.3922em;">
             <span class="" style="top: -3.3922em;">
              <span class="pstrut" style="height: 3.4483em;">
              </span>
              <span class="eqn-num">
              </span>
             </span>
            </span>
            <span class="vlist-s">
             ​
            </span>
           </span>
           <span class="vlist-r">
            <span class="vlist" style="height: 0.8922em;">
             <span class="">
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     <strong>
      end
     </strong>
    </p>
    <p>
     该算法要求我们对
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        [ 
        
       
         1 
        
       
         , 
        
       
         N 
        
       
         ] 
        
       
      
        [1,N]
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1em; vertical-align: -0.25em;">
         </span>
         <span class="mopen">
          [
         </span>
         <span class="mord">
          1
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.109em;">
          N
         </span>
         <span class="mclose">
          ]
         </span>
        </span>
       </span>
      </span>
     </span>
     进行 3 次迭代，在 Transformer 的 self-attention 中，每个
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        x 
         
        
          i 
         
        
       
      
        x_i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           x
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     是通过
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        Q 
        
        
        
          K 
         
        
          T 
         
        
       
      
        QK^T
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0358em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal">
          Q
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           K
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8413em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                 T
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     计算得到的。如果我们无法将所有的
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        x 
         
        
          i 
         
        
       
      
        x_i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           x
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     都缓存到片上内存（SRAM）中（实际上我们也没有足够大的片上内存 SRAM 来容纳所有的
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        x 
         
        
          i 
         
        
       
      
        x_i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           x
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ），那么在每次迭代时不得不访问
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        Q 
        
       
         , 
        
       
         K 
        
       
      
        Q,K
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal">
          Q
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0715em;">
          K
         </span>
        </span>
       </span>
      </span>
     </span>
     以动态重新计算
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        x 
         
        
          i 
         
        
       
      
        x_i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           x
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，这种频繁的访问会导致大量的 I/O 操作，从而降低整体效率
    </p>
    <h3>
     <a id="3_Online_Softmax_120">
     </a>
     3. Online Softmax
    </h3>
    <p>
     如果我们能够在一个循环中融合公式 (7)、(8)、(9)，那么就可以将 global memory 的访问时间降低 3 倍，不幸的是，我们不能在同一个循环中融合公式 (7)、(8)，因为公式 (8) 的计算需要依赖
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        m 
         
        
          N 
         
        
       
      
        m_N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           m
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3283em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                 N
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，而
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        m 
         
        
          N 
         
        
       
      
        m_N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           m
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3283em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                 N
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     只有在第一个循环完成之后才能够确定
    </p>
    <p>
     既然数据之间存在着依赖关系，那我们可以创建另外一个序列
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        d 
         
        
          i 
         
        
          ′ 
         
        
       
         : 
        
       
         = 
        
        
        
          ∑ 
         
         
         
           j 
          
         
           = 
          
         
           1 
          
         
        
          i 
         
        
        
        
          e 
         
         
          
          
            x 
           
          
            j 
           
          
         
           − 
          
          
          
            m 
           
          
            i 
           
          
         
        
       
      
        d_{i}^{ \prime} := \sum_{j=1}^{i}e^{x_{j}-m_{i}}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           d
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2587em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          :=
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1.4004em; vertical-align: -0.4358em;">
         </span>
         <span class="mop">
          <span class="mop op-symbol small-op" style="position: relative; top: 0em;">
           ∑
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.9646em;">
              <span class="" style="top: -2.4003em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  j
                 </span>
                 <span class="mrel mtight">
                  =
                 </span>
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.2029em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.4358em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           e
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7713em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   x
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3281em;">
                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                       <span class="pstrut" style="height: 2.5em;">
                       </span>
                       <span class="sizing reset-size3 size1 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                          j
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.2819em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mbin mtight">
                  −
                 </span>
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   m
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3281em;">
                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                       <span class="pstrut" style="height: 2.5em;">
                       </span>
                       <span class="sizing reset-size3 size1 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.143em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     作为原始序列
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        d 
         
        
          i 
         
        
          ′ 
         
        
       
         : 
        
       
         = 
        
        
        
          ∑ 
         
         
         
           j 
          
         
           = 
          
         
           1 
          
         
        
          i 
         
        
        
        
          e 
         
         
          
          
            x 
           
          
            j 
           
          
         
           − 
          
          
          
            m 
           
          
            N 
           
          
         
        
       
      
        d_{i}^{ \prime} := \sum_{j=1}^{i}e^{x_{j}-m_{N}}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           d
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2587em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          :=
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1.4004em; vertical-align: -0.4358em;">
         </span>
         <span class="mop">
          <span class="mop op-symbol small-op" style="position: relative; top: 0em;">
           ∑
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.9646em;">
              <span class="" style="top: -2.4003em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  j
                 </span>
                 <span class="mrel mtight">
                  =
                 </span>
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.2029em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.4358em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           e
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7713em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   x
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3281em;">
                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                       <span class="pstrut" style="height: 2.5em;">
                       </span>
                       <span class="sizing reset-size3 size1 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                          j
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.2819em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mbin mtight">
                  −
                 </span>
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   m
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3448em;">
                      <span class="" style="top: -2.3567em; margin-left: 0em; margin-right: 0.0714em;">
                       <span class="pstrut" style="height: 2.5em;">
                       </span>
                       <span class="sizing reset-size3 size1 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                          N
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.1433em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     的替代，以消除对
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        N 
        
       
      
        N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.109em;">
          N
         </span>
        </span>
       </span>
      </span>
     </span>
     的依赖，并且这两个序列的第
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        N 
        
       
      
        N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.109em;">
          N
         </span>
        </span>
       </span>
      </span>
     </span>
     项是相同的即
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        d 
         
        
          N 
         
        
       
         = 
        
        
        
          d 
         
        
          N 
         
        
          ′ 
         
        
       
      
        d_N=d^{\prime}_N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           d
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3283em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                 N
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1.0272em; vertical-align: -0.2753em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           d
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -2.4247em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                 N
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2753em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，因此我们可以安全地用
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        d 
         
        
          N 
         
        
          ′ 
         
        
       
      
        d^{\prime}_N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0272em; vertical-align: -0.2753em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           d
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -2.4247em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                 N
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2753em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     替换公式 (9) 中的
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        d 
         
        
          N 
         
        
       
      
        d_N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           d
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3283em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                 N
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     <strong>
      Note
     </strong>
     ：在数学和计算机科学中，符号
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        : 
        
       
         = 
        
       
      
        :=
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mrel">
          :=
         </span>
        </span>
       </span>
      </span>
     </span>
     用于表示 “定义为” 或 “被定义为”，例如当我们写下
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        x 
        
       
         : 
        
       
         = 
        
       
         y 
        
       
      
        x:=y
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal">
          x
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          :=
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0359em;">
          y
         </span>
        </span>
       </span>
      </span>
     </span>
     时，我们是在说明 “我们将
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        x 
        
       
      
        x
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal">
          x
         </span>
        </span>
       </span>
      </span>
     </span>
     定义为
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        y 
        
       
      
        y
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0359em;">
          y
         </span>
        </span>
       </span>
      </span>
     </span>
     ” 或 “
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        x 
        
       
      
        x
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal">
          x
         </span>
        </span>
       </span>
      </span>
     </span>
     等于
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        y 
        
       
      
        y
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0359em;">
          y
         </span>
        </span>
       </span>
      </span>
     </span>
     （这是它的定义）”
    </p>
    <p>
     此外，我们还可以找到
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        d 
         
        
          i 
         
        
          ′ 
         
        
       
      
        d^{\prime}_i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           d
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2587em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     和
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        d 
         
         
         
           i 
          
         
           − 
          
         
           1 
          
         
        
          ′ 
         
        
       
      
        d^{\prime}_{i-1}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0689em; vertical-align: -0.317em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           d
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                 <span class="mbin mtight">
                  −
                 </span>
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.317em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     之间的递归关系：
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         d 
                 
                
                  i 
                 
                
                  ′ 
                 
                
               
              
              
               
                
                 
                
                  = 
                 
                 
                 
                   ∑ 
                  
                  
                  
                    j 
                   
                  
                    = 
                   
                  
                    1 
                   
                  
                 
                   i 
                  
                 
                 
                 
                   e 
                  
                  
                   
                   
                     x 
                    
                   
                     j 
                    
                   
                  
                    − 
                   
                   
                   
                     m 
                    
                   
                     i 
                    
                   
                  
                 
                
               
              
             
             
              
               
                
               
              
              
               
                
                 
                
                  = 
                 
                 
                 
                   ( 
                  
                  
                  
                    ∑ 
                   
                   
                   
                     j 
                    
                   
                     = 
                    
                   
                     1 
                    
                   
                   
                   
                     i 
                    
                   
                     − 
                    
                   
                     1 
                    
                   
                  
                  
                  
                    e 
                   
                   
                    
                    
                      x 
                     
                    
                      j 
                     
                    
                   
                     − 
                    
                    
                    
                      m 
                     
                    
                      i 
                     
                    
                   
                  
                 
                   ) 
                  
                 
                
                  + 
                 
                 
                 
                   e 
                  
                  
                   
                   
                     x 
                    
                   
                     i 
                    
                   
                  
                    − 
                   
                   
                   
                     m 
                    
                   
                     i 
                    
                   
                  
                 
                
               
              
             
             
              
               
                
               
              
              
               
                
                 
                
                  = 
                 
                 
                 
                   ( 
                  
                  
                  
                    ∑ 
                   
                   
                   
                     j 
                    
                   
                     = 
                    
                   
                     1 
                    
                   
                   
                   
                     i 
                    
                   
                     − 
                    
                   
                     1 
                    
                   
                  
                  
                  
                    e 
                   
                   
                    
                    
                      x 
                     
                    
                      j 
                     
                    
                   
                     − 
                    
                    
                    
                      m 
                     
                     
                     
                       i 
                      
                     
                       − 
                      
                     
                       1 
                      
                     
                    
                   
                  
                 
                   ) 
                  
                 
                 
                 
                   e 
                  
                  
                   
                   
                     m 
                    
                    
                    
                      i 
                     
                    
                      − 
                     
                    
                      1 
                     
                    
                   
                  
                    − 
                   
                   
                   
                     m 
                    
                   
                     i 
                    
                   
                  
                 
                
                  + 
                 
                 
                 
                   e 
                  
                  
                   
                   
                     x 
                    
                   
                     i 
                    
                   
                  
                    − 
                   
                   
                   
                     m 
                    
                   
                     i 
                    
                   
                  
                 
                
               
              
             
             
              
               
                
               
              
              
               
                
                 
                
                  = 
                 
                 
                 
                   d 
                  
                  
                  
                    i 
                   
                  
                    − 
                   
                  
                    1 
                   
                  
                 
                   ′ 
                  
                 
                 
                 
                   e 
                  
                  
                   
                   
                     m 
                    
                    
                    
                      i 
                     
                    
                      − 
                     
                    
                      1 
                     
                    
                   
                  
                    − 
                   
                   
                   
                     m 
                    
                   
                     i 
                    
                   
                  
                 
                
                  + 
                 
                 
                 
                   e 
                  
                  
                   
                   
                     x 
                    
                   
                     i 
                    
                   
                  
                    − 
                   
                   
                   
                     m 
                    
                   
                     i 
                    
                   
                  
                 
                
               
              
             
            
           
          
          
          
         
        
       
         \begin{equation} \begin{aligned} d_{i}^{\prime} &amp; =\sum_{j=1}^ie^{x_j-m_i} \\ &amp; =\left(\sum_{j=1}^{i-1}e^{x_j-m_i}\right)+e^{x_i-m_i} \\ &amp; =\left(\sum_{j=1}^{i-1}e^{x_j-m_{i-1}}\right)e^{m_{i-1}-m_i}+e^{x_i-m_i} \\ &amp; =d_{i-1}^{\prime}e^{m_{i-1}-m_i}+e^{x_i-m_i} \end{aligned} \end{equation}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 12.0763em; vertical-align: -5.7882em;">
          </span>
          <span class="mtable">
           <span class="col-align-c">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 6.2882em;">
               <span class="" style="top: -8.2882em;">
                <span class="pstrut" style="height: 8.2882em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mtable">
                   <span class="col-align-r">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 6.2882em;">
                       <span class="" style="top: -8.2882em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                          <span class="mord mathnormal">
                           d
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.8019em;">
                              <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.113em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  ′
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.247em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -4.7627em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                        </span>
                       </span>
                       <span class="" style="top: -1.2373em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                        </span>
                       </span>
                       <span class="" style="top: 1.3165em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 5.7882em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                   <span class="col-align-l">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 6.2882em;">
                       <span class="" style="top: -8.2882em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mrel">
                          =
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mop op-limits">
                          <span class="vlist-t vlist-t2">
                           <span class="vlist-r">
                            <span class="vlist" style="height: 1.8117em;">
                             <span class="" style="top: -1.8723em; margin-left: 0em;">
                              <span class="pstrut" style="height: 3.05em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mtight">
                                <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                 j
                                </span>
                                <span class="mrel mtight">
                                 =
                                </span>
                                <span class="mord mtight">
                                 1
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="" style="top: -3.05em;">
                              <span class="pstrut" style="height: 3.05em;">
                              </span>
                              <span class="">
                               <span class="mop op-symbol large-op">
                                ∑
                               </span>
                              </span>
                             </span>
                             <span class="" style="top: -4.3em; margin-left: 0em;">
                              <span class="pstrut" style="height: 3.05em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mathnormal mtight">
                                i
                               </span>
                              </span>
                             </span>
                            </span>
                            <span class="vlist-s">
                             ​
                            </span>
                           </span>
                           <span class="vlist-r">
                            <span class="vlist" style="height: 1.4138em;">
                             <span class="">
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                         <span class="mspace" style="margin-right: 0.1667em;">
                         </span>
                         <span class="mord">
                          <span class="mord mathnormal">
                           e
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.8213em;">
                              <span class="" style="top: -3.113em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   x
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                         j
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.2819em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   m
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.143em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -4.7627em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mrel">
                          =
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="minner">
                          <span class="mopen delimcenter" style="top: 0em;">
                           <span class="delimsizing size4">
                            (
                           </span>
                          </span>
                          <span class="mop op-limits">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.8117em;">
                              <span class="" style="top: -1.8723em; margin-left: 0em;">
                               <span class="pstrut" style="height: 3.05em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                  j
                                 </span>
                                 <span class="mrel mtight">
                                  =
                                 </span>
                                 <span class="mord mtight">
                                  1
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.05em;">
                               <span class="pstrut" style="height: 3.05em;">
                               </span>
                               <span class="">
                                <span class="mop op-symbol large-op">
                                 ∑
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -4.3em; margin-left: 0em;">
                               <span class="pstrut" style="height: 3.05em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  1
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.4138em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mspace" style="margin-right: 0.1667em;">
                          </span>
                          <span class="mord">
                           <span class="mord mathnormal">
                            e
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.8213em;">
                               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                                <span class="pstrut" style="height: 2.7em;">
                                </span>
                                <span class="sizing reset-size6 size3 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mtight">
                                   <span class="mord mathnormal mtight">
                                    x
                                   </span>
                                   <span class="msupsub">
                                    <span class="vlist-t vlist-t2">
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.3281em;">
                                       <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                        <span class="pstrut" style="height: 2.5em;">
                                        </span>
                                        <span class="sizing reset-size3 size1 mtight">
                                         <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                          j
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                      <span class="vlist-s">
                                       ​
                                      </span>
                                     </span>
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.2819em;">
                                       <span class="">
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                  <span class="mbin mtight">
                                   −
                                  </span>
                                  <span class="mord mtight">
                                   <span class="mord mathnormal mtight">
                                    m
                                   </span>
                                   <span class="msupsub">
                                    <span class="vlist-t vlist-t2">
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.3281em;">
                                       <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                        <span class="pstrut" style="height: 2.5em;">
                                        </span>
                                        <span class="sizing reset-size3 size1 mtight">
                                         <span class="mord mathnormal mtight">
                                          i
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                      <span class="vlist-s">
                                       ​
                                      </span>
                                     </span>
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.143em;">
                                       <span class="">
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mclose delimcenter" style="top: 0em;">
                           <span class="delimsizing size4">
                            )
                           </span>
                          </span>
                         </span>
                         <span class="mspace" style="margin-right: 0.2222em;">
                         </span>
                         <span class="mbin">
                          +
                         </span>
                         <span class="mspace" style="margin-right: 0.2222em;">
                         </span>
                         <span class="mord">
                          <span class="mord mathnormal">
                           e
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.8213em;">
                              <span class="" style="top: -3.113em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   x
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.143em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   m
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.143em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -1.2373em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mrel">
                          =
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="minner">
                          <span class="mopen delimcenter" style="top: 0em;">
                           <span class="delimsizing size4">
                            (
                           </span>
                          </span>
                          <span class="mop op-limits">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.8117em;">
                              <span class="" style="top: -1.8723em; margin-left: 0em;">
                               <span class="pstrut" style="height: 3.05em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                  j
                                 </span>
                                 <span class="mrel mtight">
                                  =
                                 </span>
                                 <span class="mord mtight">
                                  1
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.05em;">
                               <span class="pstrut" style="height: 3.05em;">
                               </span>
                               <span class="">
                                <span class="mop op-symbol large-op">
                                 ∑
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -4.3em; margin-left: 0em;">
                               <span class="pstrut" style="height: 3.05em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  1
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.4138em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mspace" style="margin-right: 0.1667em;">
                          </span>
                          <span class="mord">
                           <span class="mord mathnormal">
                            e
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.8213em;">
                               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                                <span class="pstrut" style="height: 2.7em;">
                                </span>
                                <span class="sizing reset-size6 size3 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mtight">
                                   <span class="mord mathnormal mtight">
                                    x
                                   </span>
                                   <span class="msupsub">
                                    <span class="vlist-t vlist-t2">
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.3281em;">
                                       <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                        <span class="pstrut" style="height: 2.5em;">
                                        </span>
                                        <span class="sizing reset-size3 size1 mtight">
                                         <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                          j
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                      <span class="vlist-s">
                                       ​
                                      </span>
                                     </span>
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.2819em;">
                                       <span class="">
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                  <span class="mbin mtight">
                                   −
                                  </span>
                                  <span class="mord mtight">
                                   <span class="mord mathnormal mtight">
                                    m
                                   </span>
                                   <span class="msupsub">
                                    <span class="vlist-t vlist-t2">
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.3281em;">
                                       <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                        <span class="pstrut" style="height: 2.5em;">
                                        </span>
                                        <span class="sizing reset-size3 size1 mtight">
                                         <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                           i
                                          </span>
                                          <span class="mbin mtight">
                                           −
                                          </span>
                                          <span class="mord mtight">
                                           1
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                      <span class="vlist-s">
                                       ​
                                      </span>
                                     </span>
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.2025em;">
                                       <span class="">
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mclose delimcenter" style="top: 0em;">
                           <span class="delimsizing size4">
                            )
                           </span>
                          </span>
                         </span>
                         <span class="mspace" style="margin-right: 0.1667em;">
                         </span>
                         <span class="mord">
                          <span class="mord mathnormal">
                           e
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.8213em;">
                              <span class="" style="top: -3.113em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   m
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          i
                                         </span>
                                         <span class="mbin mtight">
                                          −
                                         </span>
                                         <span class="mord mtight">
                                          1
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.2025em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   m
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.143em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                         <span class="mspace" style="margin-right: 0.2222em;">
                         </span>
                         <span class="mbin">
                          +
                         </span>
                         <span class="mspace" style="margin-right: 0.2222em;">
                         </span>
                         <span class="mord">
                          <span class="mord mathnormal">
                           e
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.8213em;">
                              <span class="" style="top: -3.113em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   x
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.143em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   m
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.143em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: 1.3165em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mrel">
                          =
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mord">
                          <span class="mord mathnormal">
                           d
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.8019em;">
                              <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  1
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.113em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  ′
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.3053em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                         <span class="mord">
                          <span class="mord mathnormal">
                           e
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.8213em;">
                              <span class="" style="top: -3.113em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   m
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          i
                                         </span>
                                         <span class="mbin mtight">
                                          −
                                         </span>
                                         <span class="mord mtight">
                                          1
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.2025em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   m
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.143em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                         <span class="mspace" style="margin-right: 0.2222em;">
                         </span>
                         <span class="mbin">
                          +
                         </span>
                         <span class="mspace" style="margin-right: 0.2222em;">
                         </span>
                         <span class="mord">
                          <span class="mord mathnormal">
                           e
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.8213em;">
                              <span class="" style="top: -3.113em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   x
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.143em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   m
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.143em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 5.7882em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 5.7882em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="tag">
          <span class="vlist-t vlist-t2">
           <span class="vlist-r">
            <span class="vlist" style="height: 6.2882em;">
             <span class="" style="top: -8.2882em;">
              <span class="pstrut" style="height: 8.2882em;">
              </span>
              <span class="eqn-num">
              </span>
             </span>
            </span>
            <span class="vlist-s">
             ​
            </span>
           </span>
           <span class="vlist-r">
            <span class="vlist" style="height: 5.7882em;">
             <span class="">
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     这个递归公式只依赖于
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        m 
         
        
          i 
         
        
       
      
        m_i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           m
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     和
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        m 
         
         
         
           i 
          
         
           − 
          
         
           1 
          
         
        
       
      
        m_{i-1}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6389em; vertical-align: -0.2083em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           m
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                 <span class="mbin mtight">
                  −
                 </span>
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2083em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，此外我们还可以在一个循环中同时计算
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        m 
         
        
          j 
         
        
       
      
        m_j
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           m
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                 j
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2861em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     和
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        d 
         
        
          j 
         
        
          ′ 
         
        
       
      
        d^{\prime}_j
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.1467em; vertical-align: -0.3948em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           d
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                 j
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3948em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     <strong>
      Algorithm 2-pass online softmax
     </strong>
    </p>
    <p>
     <strong>
      for
     </strong>
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        i 
        
       
         ← 
        
       
         1 
        
       
         , 
        
       
         N 
        
       
      
        i\leftarrow 1,N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6595em;">
         </span>
         <span class="mord mathnormal">
          i
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ←
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          1
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.109em;">
          N
         </span>
        </span>
       </span>
      </span>
     </span>
     <strong>
      do
     </strong>
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         m 
             
            
              i 
             
            
           
          
          
           
            
             
            
              ← 
             
            
              max 
             
            
              ⁡ 
             
            
              ( 
             
             
             
               m 
              
              
              
                i 
               
              
                − 
               
              
                1 
               
              
             
            
              , 
             
             
             
               x 
              
             
               i 
              
             
            
              ) 
             
            
           
          
         
         
          
           
            
            
              d 
             
            
              i 
             
            
              ′ 
             
            
           
          
          
           
            
             
            
              ← 
             
             
             
               d 
              
              
              
                i 
               
              
                − 
               
              
                1 
               
              
             
               ′ 
              
             
             
             
               e 
              
              
               
               
                 m 
                
                
                
                  i 
                 
                
                  − 
                 
                
                  1 
                 
                
               
              
                − 
               
               
               
                 m 
                
               
                 i 
                
               
              
             
            
              + 
             
             
             
               e 
              
              
               
               
                 x 
                
               
                 i 
                
               
              
                − 
               
               
               
                 m 
                
               
                 i 
                
               
              
             
            
           
          
         
        
       
         \begin{aligned} m_i &amp; \leftarrow \max (m_{i-1}, x_i) \\ d^{\prime}_i &amp; \leftarrow d^{\prime}_{i-1}e^{m_{i-1}-m_i}+e^{x_i-m_i} \end{aligned}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 3em; vertical-align: -1.25em;">
          </span>
          <span class="mord">
           <span class="mtable">
            <span class="col-align-r">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 1.75em;">
                <span class="" style="top: -3.91em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord mathnormal">
                    m
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -2.41em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord mathnormal">
                    d
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8019em;">
                       <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           ′
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.247em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 1.25em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="col-align-l">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 1.75em;">
                <span class="" style="top: -3.91em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   ←
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mop">
                   max
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    m
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                          <span class="mbin mtight">
                           −
                          </span>
                          <span class="mord mtight">
                           1
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.2083em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mpunct">
                   ,
                  </span>
                  <span class="mspace" style="margin-right: 0.1667em;">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    x
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mclose">
                   )
                  </span>
                 </span>
                </span>
                <span class="" style="top: -2.41em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   ←
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    d
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8019em;">
                       <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                          <span class="mbin mtight">
                           −
                          </span>
                          <span class="mord mtight">
                           1
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           ′
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3053em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    e
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8213em;">
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            m
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3281em;">
                               <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   i
                                  </span>
                                  <span class="mbin mtight">
                                   −
                                  </span>
                                  <span class="mord mtight">
                                   1
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.2025em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mbin mtight">
                           −
                          </span>
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            m
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3281em;">
                               <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.143em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mbin">
                   +
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    e
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8213em;">
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            x
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3281em;">
                               <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.143em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mbin mtight">
                           −
                          </span>
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            m
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3281em;">
                               <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.143em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 1.25em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     <strong>
      end
     </strong>
    </p>
    <p>
     <strong>
      for
     </strong>
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        i 
        
       
         ← 
        
       
         1 
        
       
         , 
        
       
         N 
        
       
      
        i\leftarrow 1,N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6595em;">
         </span>
         <span class="mord mathnormal">
          i
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ←
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          1
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.109em;">
          N
         </span>
        </span>
       </span>
      </span>
     </span>
     <strong>
      do
     </strong>
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         a 
          
         
           i 
          
         
        
          ← 
         
         
          
          
            e 
           
           
            
            
              x 
             
            
              i 
             
            
           
             − 
            
            
            
              m 
             
            
              N 
             
            
           
          
          
          
            d 
           
          
            N 
           
          
            ′ 
           
          
         
        
       
         a_i \leftarrow \frac{e^{x_i - m_N}}{d^{\prime}_N}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            a
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           ←
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.4279em; vertical-align: -0.9795em;">
          </span>
          <span class="mord">
           <span class="mopen nulldelimiter">
           </span>
           <span class="mfrac">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.4483em;">
               <span class="" style="top: -2.314em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mord mathnormal">
                   d
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.7337em;">
                      <span class="" style="top: -2.4065em; margin-left: 0em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                         N
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mtight">
                          ′
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.2935em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.23em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="frac-line" style="border-bottom-width: 0.04em;">
                </span>
               </span>
               <span class="" style="top: -3.677em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mord mathnormal">
                   e
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.7713em;">
                      <span class="" style="top: -3.063em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           x
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.3281em;">
                              <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                               <span class="pstrut" style="height: 2.5em;">
                               </span>
                               <span class="sizing reset-size3 size1 mtight">
                                <span class="mord mathnormal mtight">
                                 i
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.143em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                         <span class="mbin mtight">
                          −
                         </span>
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           m
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.3448em;">
                              <span class="" style="top: -2.3567em; margin-left: 0em; margin-right: 0.0714em;">
                               <span class="pstrut" style="height: 2.5em;">
                               </span>
                               <span class="sizing reset-size3 size1 mtight">
                                <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                                 N
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.1433em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.9795em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose nulldelimiter">
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     <strong>
      end
     </strong>
    </p>
    <p>
     这是
     <a rel="nofollow">
      Online Softmax
     </a>
     论文中提出的算法，但它仍然需要两次循环才能完成 softmax 的计算，我们能否将循环次数减少到 1 次来最小化全局的 I/O 呢？🤔
    </p>
    <h3>
     <a id="4_FlashAttention_166">
     </a>
     4. FlashAttention
    </h3>
    <p>
     不幸的是，对于 softmax 来说，答案是否定的，但在 Self-Attention 中，我们最终的目标并不是注意力分数矩阵
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        A 
        
       
         = 
        
        
        
          s 
         
        
          o 
         
        
          f 
         
        
          t 
         
        
          m 
         
        
          a 
         
        
          x 
         
        
       
         ( 
        
       
         Q 
        
        
        
          K 
         
        
          T 
         
        
       
         ) 
        
       
      
        A=\mathrm{softmax}(QK^T)
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal">
          A
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 1.0913em; vertical-align: -0.25em;">
         </span>
         <span class="mord">
          <span class="mord mathrm">
           softmax
          </span>
         </span>
         <span class="mopen">
          (
         </span>
         <span class="mord mathnormal">
          Q
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           K
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8413em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                 T
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mclose">
          )
         </span>
        </span>
       </span>
      </span>
     </span>
     ，而是输出矩阵
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        O 
        
       
         = 
        
       
         A 
        
       
         × 
        
       
         V 
        
       
      
        O=A \times V
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          O
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;">
         </span>
         <span class="mord mathnormal">
          A
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
         <span class="mbin">
          ×
         </span>
         <span class="mspace" style="margin-right: 0.2222em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.2222em;">
          V
         </span>
        </span>
       </span>
      </span>
     </span>
     ，既然无法找到 softmax 的一次递归形式，那我们换个思路思考下能否找到矩阵
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        O 
        
       
      
        O
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          O
         </span>
        </span>
       </span>
      </span>
     </span>
     的一次递归形式呢？
    </p>
    <p>
     下面我们尝试下先将 Self-Attention 计算的第
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        k 
        
       
      
        k
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0315em;">
          k
         </span>
        </span>
       </span>
      </span>
     </span>
     行公式转化为递归算法：
    </p>
    <p>
     <strong>
      Note
     </strong>
     ：由于所有行的计算都是独立的，为了简单起见，这里我们只解释一行的计算
    </p>
    <p>
     <strong>
      Algorithm Multi-pass Self-Attention
     </strong>
    </p>
    <p>
     NOTATIONS
    </p>
    <ul>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         Q 
         
        
          [ 
         
        
          k 
         
        
          , 
         
        
          : 
         
        
          ] 
         
        
       
         Q[k,:]
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           Q
          </span>
          <span class="mopen">
           [
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0315em;">
           k
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           :
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mclose">
           ]
          </span>
         </span>
        </span>
       </span>
      </span>
      ：查询矩阵
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         Q 
         
        
       
         Q
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           Q
          </span>
         </span>
        </span>
       </span>
      </span>
      的第
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         k 
         
        
       
         k
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6944em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0315em;">
           k
          </span>
         </span>
        </span>
       </span>
      </span>
      行向量
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         K 
          
         
           T 
          
         
        
          [ 
         
        
          : 
         
        
          , 
         
        
          i 
         
        
          ] 
         
        
       
         K^T[:,i]
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.0913em; vertical-align: -0.25em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0715em;">
            K
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8413em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                  T
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mopen">
           [
          </span>
          <span class="mrel">
           :
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal">
           i
          </span>
          <span class="mclose">
           ]
          </span>
         </span>
        </span>
       </span>
      </span>
      ：键矩阵
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         K 
          
         
           T 
          
         
        
       
         K^T
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8413em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0715em;">
            K
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8413em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                  T
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      的第
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         i 
         
        
       
         i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6595em;">
          </span>
          <span class="mord mathnormal">
           i
          </span>
         </span>
        </span>
       </span>
      </span>
      列向量
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         O 
         
        
          [ 
         
        
          k 
         
        
          , 
         
        
          : 
         
        
          ] 
         
        
       
         O[k,:]
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           O
          </span>
          <span class="mopen">
           [
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0315em;">
           k
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           :
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mclose">
           ]
          </span>
         </span>
        </span>
       </span>
      </span>
      ：输出矩阵
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         O 
         
        
       
         O
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           O
          </span>
         </span>
        </span>
       </span>
      </span>
      的第
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         k 
         
        
       
         k
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6944em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0315em;">
           k
          </span>
         </span>
        </span>
       </span>
      </span>
      行
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         V 
         
        
          [ 
         
        
          i 
         
        
          , 
         
        
          : 
         
        
          ] 
         
        
       
         V[i,:]
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.2222em;">
           V
          </span>
          <span class="mopen">
           [
          </span>
          <span class="mord mathnormal">
           i
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           :
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mclose">
           ]
          </span>
         </span>
        </span>
       </span>
      </span>
      ：值矩阵
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         V 
         
        
       
         V
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.2222em;">
           V
          </span>
         </span>
        </span>
       </span>
      </span>
      的第
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         i 
         
        
       
         i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6595em;">
          </span>
          <span class="mord mathnormal">
           i
          </span>
         </span>
        </span>
       </span>
      </span>
      行
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         o 
          
         
           i 
          
         
        
       
         \bm{o}_i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5944em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord">
            <span class="mord">
             <span class="mord boldsymbol">
              o
             </span>
            </span>
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ：
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         ∑ 
          
          
          
            j 
           
          
            = 
           
          
            1 
           
          
         
           i 
          
         
         
         
           a 
          
         
           j 
          
         
        
          V 
         
        
          [ 
         
        
          j 
         
        
          , 
         
        
          : 
         
        
          ] 
         
        
       
         \sum_{j=1}^ia_jV[j,:]
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.4004em; vertical-align: -0.4358em;">
          </span>
          <span class="mop">
           <span class="mop op-symbol small-op" style="position: relative; top: 0em;">
            ∑
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.9646em;">
               <span class="" style="top: -2.4003em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   j
                  </span>
                  <span class="mrel mtight">
                   =
                  </span>
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.2029em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.4358em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            a
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  j
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mord mathnormal" style="margin-right: 0.2222em;">
           V
          </span>
          <span class="mopen">
           [
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0572em;">
           j
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           :
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mclose">
           ]
          </span>
         </span>
        </span>
       </span>
      </span>
      ，存储
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         A 
         
        
          [ 
         
        
          k 
         
        
          , 
         
        
          : 
         
        
          i 
         
        
          ] 
         
        
          × 
         
        
          V 
         
        
          [ 
         
        
          : 
         
        
          i 
         
        
          , 
         
        
          : 
         
        
          ] 
         
        
       
         A[k,:i]\times V[:i,:]
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           A
          </span>
          <span class="mopen">
           [
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0315em;">
           k
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           :
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           i
          </span>
          <span class="mclose">
           ]
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ×
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.2222em;">
           V
          </span>
          <span class="mopen">
           [
          </span>
          <span class="mrel">
           :
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.854em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           i
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           :
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mclose">
           ]
          </span>
         </span>
        </span>
       </span>
      </span>
      结果的行向量
     </li>
    </ul>
    <p>
     BODY
    </p>
    <p>
     <strong>
      for
     </strong>
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        i 
        
       
         ← 
        
       
         1 
        
       
         , 
        
       
         N 
        
       
      
        i\leftarrow 1,N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6595em;">
         </span>
         <span class="mord mathnormal">
          i
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ←
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          1
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.109em;">
          N
         </span>
        </span>
       </span>
      </span>
     </span>
     <strong>
      do
     </strong>
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         x 
             
            
              i 
             
            
           
          
          
           
            
             
            
              ← 
             
            
              Q 
             
            
              [ 
             
            
              k 
             
            
              , 
             
            
              : 
             
            
              ] 
             
             
             
               K 
              
             
               T 
              
             
            
              [ 
             
            
              : 
             
            
              , 
             
            
              i 
             
            
              ] 
             
            
           
          
         
         
          
           
            
            
              m 
             
            
              i 
             
            
           
          
          
           
            
             
            
              ← 
             
            
              max 
             
            
              ⁡ 
             
            
              ( 
             
             
             
               m 
              
              
              
                i 
               
              
                − 
               
              
                1 
               
              
             
            
              , 
             
             
             
               x 
              
             
               i 
              
             
            
              ) 
             
            
           
          
         
         
          
           
            
            
              d 
             
            
              i 
             
            
              ′ 
             
            
           
          
          
           
            
             
            
              ← 
             
             
             
               d 
              
              
              
                i 
               
              
                − 
               
              
                1 
               
              
             
               ′ 
              
             
             
             
               e 
              
              
               
               
                 m 
                
                
                
                  i 
                 
                
                  − 
                 
                
                  1 
                 
                
               
              
                − 
               
               
               
                 m 
                
               
                 i 
                
               
              
             
            
              + 
             
             
             
               e 
              
              
               
               
                 x 
                
               
                 i 
                
               
              
                − 
               
               
               
                 m 
                
               
                 i 
                
               
              
             
            
           
          
         
        
       
         \begin{aligned} x_i &amp; \leftarrow Q[k,:]K^T[:,i] \\ m_i &amp; \leftarrow \max (m_{i-1},x_i) \\ d^{\prime}_i &amp; \leftarrow d^{\prime}_{i-1} e^{m_{i-1}-m_i} + e^{x_i-m_i} \end{aligned}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 4.5513em; vertical-align: -2.0257em;">
          </span>
          <span class="mord">
           <span class="mtable">
            <span class="col-align-r">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 2.5257em;">
                <span class="" style="top: -4.6343em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord mathnormal">
                    x
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.1343em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord mathnormal">
                    m
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -1.6343em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord mathnormal">
                    d
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8019em;">
                       <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           ′
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.247em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 2.0257em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="col-align-l">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 2.5257em;">
                <span class="" style="top: -4.6343em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   ←
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord mathnormal">
                   Q
                  </span>
                  <span class="mopen">
                   [
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.0315em;">
                   k
                  </span>
                  <span class="mpunct">
                   ,
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mclose">
                   ]
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal" style="margin-right: 0.0715em;">
                    K
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8913em;">
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                          T
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mopen">
                   [
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mpunct">
                   ,
                  </span>
                  <span class="mspace" style="margin-right: 0.1667em;">
                  </span>
                  <span class="mord mathnormal">
                   i
                  </span>
                  <span class="mclose">
                   ]
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.1343em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   ←
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mop">
                   max
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    m
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                          <span class="mbin mtight">
                           −
                          </span>
                          <span class="mord mtight">
                           1
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.2083em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mpunct">
                   ,
                  </span>
                  <span class="mspace" style="margin-right: 0.1667em;">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    x
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mclose">
                   )
                  </span>
                 </span>
                </span>
                <span class="" style="top: -1.6343em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   ←
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    d
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8019em;">
                       <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                          <span class="mbin mtight">
                           −
                          </span>
                          <span class="mord mtight">
                           1
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           ′
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3053em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    e
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8213em;">
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            m
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3281em;">
                               <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   i
                                  </span>
                                  <span class="mbin mtight">
                                   −
                                  </span>
                                  <span class="mord mtight">
                                   1
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.2025em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mbin mtight">
                           −
                          </span>
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            m
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3281em;">
                               <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.143em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mbin">
                   +
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    e
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8213em;">
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            x
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3281em;">
                               <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.143em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mbin mtight">
                           −
                          </span>
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            m
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3281em;">
                               <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.143em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 2.0257em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     <strong>
      end
     </strong>
    </p>
    <p>
     <strong>
      for
     </strong>
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        i 
        
       
         ← 
        
       
         1 
        
       
         , 
        
       
         N 
        
       
      
        i\leftarrow 1,N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6595em;">
         </span>
         <span class="mord mathnormal">
          i
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ←
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          1
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.109em;">
          N
         </span>
        </span>
       </span>
      </span>
     </span>
     <strong>
      do
     </strong>
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         a 
             
            
              i 
             
            
           
          
          
           
            
             
            
              ← 
             
             
              
              
                e 
               
               
                
                
                  x 
                 
                
                  i 
                 
                
               
                 − 
                
                
                
                  m 
                 
                
                  N 
                 
                
               
              
              
              
                d 
               
              
                N 
               
              
                ′ 
               
              
             
            
           
          
          
          
         
         
          
          
           
            
            
              o 
             
            
              i 
             
            
           
          
          
           
            
             
            
              ← 
             
             
             
               o 
              
              
              
                i 
               
              
                − 
               
              
                1 
               
              
             
            
              + 
             
             
             
               a 
              
             
               i 
              
             
            
              V 
             
            
              [ 
             
            
              i 
             
            
              , 
             
            
              : 
             
            
              ] 
             
            
           
          
          
          
         
        
       
         \begin{align} a_i &amp; \leftarrow \frac{e^{x_i-m_N}}{d^{\prime}_N} \\ \bm{o}_i &amp; \leftarrow \bm{o}_{i-1} + a_iV[i,:] \end{align}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 4.2279em; vertical-align: -1.8639em;">
          </span>
          <span class="mtable">
           <span class="col-align-r">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 2.3639em;">
               <span class="" style="top: -4.3639em;">
                <span class="pstrut" style="height: 3.4483em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mord mathnormal">
                   a
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3117em;">
                      <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight">
                         i
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.15em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -2.2444em;">
                <span class="pstrut" style="height: 3.4483em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mord">
                   <span class="mord">
                    <span class="mord boldsymbol">
                     o
                    </span>
                   </span>
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3117em;">
                      <span class="" style="top: -2.55em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight">
                         i
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.15em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 1.8639em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="col-align-l">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 2.3639em;">
               <span class="" style="top: -4.3639em;">
                <span class="pstrut" style="height: 3.4483em;">
                </span>
                <span class="mord">
                 <span class="mord">
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mrel">
                  ←
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mord">
                  <span class="mopen nulldelimiter">
                  </span>
                  <span class="mfrac">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 1.4483em;">
                      <span class="" style="top: -2.314em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="mord">
                        <span class="mord">
                         <span class="mord mathnormal">
                          d
                         </span>
                         <span class="msupsub">
                          <span class="vlist-t vlist-t2">
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.7337em;">
                             <span class="" style="top: -2.4065em; margin-left: 0em; margin-right: 0.05em;">
                              <span class="pstrut" style="height: 2.7em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                                N
                               </span>
                              </span>
                             </span>
                             <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                              <span class="pstrut" style="height: 2.7em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mtight">
                                <span class="mord mtight">
                                 ′
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                            <span class="vlist-s">
                             ​
                            </span>
                           </span>
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.2935em;">
                             <span class="">
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -3.23em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="frac-line" style="border-bottom-width: 0.04em;">
                       </span>
                      </span>
                      <span class="" style="top: -3.677em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="mord">
                        <span class="mord">
                         <span class="mord mathnormal">
                          e
                         </span>
                         <span class="msupsub">
                          <span class="vlist-t">
                           <span class="vlist-r">
                            <span class="vlist" style="height: 0.7713em;">
                             <span class="" style="top: -3.063em; margin-right: 0.05em;">
                              <span class="pstrut" style="height: 2.7em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  x
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.3281em;">
                                     <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                      <span class="pstrut" style="height: 2.5em;">
                                      </span>
                                      <span class="sizing reset-size3 size1 mtight">
                                       <span class="mord mathnormal mtight">
                                        i
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.143em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                                <span class="mbin mtight">
                                 −
                                </span>
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  m
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.3448em;">
                                     <span class="" style="top: -2.3567em; margin-left: 0em; margin-right: 0.0714em;">
                                      <span class="pstrut" style="height: 2.5em;">
                                      </span>
                                      <span class="sizing reset-size3 size1 mtight">
                                       <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                                        N
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.1433em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.9795em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mclose nulldelimiter">
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -2.2444em;">
                <span class="pstrut" style="height: 3.4483em;">
                </span>
                <span class="mord">
                 <span class="mord">
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mrel">
                  ←
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord">
                    <span class="mord boldsymbol">
                     o
                    </span>
                   </span>
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3117em;">
                      <span class="" style="top: -2.55em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                         <span class="mbin mtight">
                          −
                         </span>
                         <span class="mord mtight">
                          1
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.2083em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mspace" style="margin-right: 0.2222em;">
                 </span>
                 <span class="mbin">
                  +
                 </span>
                 <span class="mspace" style="margin-right: 0.2222em;">
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal">
                   a
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3117em;">
                      <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight">
                         i
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.15em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mord mathnormal" style="margin-right: 0.2222em;">
                  V
                 </span>
                 <span class="mopen">
                  [
                 </span>
                 <span class="mord mathnormal">
                  i
                 </span>
                 <span class="mpunct">
                  ,
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mrel">
                  :
                 </span>
                 <span class="mclose">
                  ]
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 1.8639em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="tag">
          <span class="vlist-t vlist-t2">
           <span class="vlist-r">
            <span class="vlist" style="height: 2.3639em;">
             <span class="" style="top: -4.3639em;">
              <span class="pstrut" style="height: 3.4483em;">
              </span>
              <span class="eqn-num">
              </span>
             </span>
             <span class="" style="top: -2.2444em;">
              <span class="pstrut" style="height: 3.4483em;">
              </span>
              <span class="eqn-num">
              </span>
             </span>
            </span>
            <span class="vlist-s">
             ​
            </span>
           </span>
           <span class="vlist-r">
            <span class="vlist" style="height: 1.8639em;">
             <span class="">
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     <strong>
      end
     </strong>
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         O 
         
        
          [ 
         
        
          k 
         
        
          , 
         
        
          : 
         
        
          ] 
         
        
          ← 
         
         
         
           o 
          
         
           N 
          
         
        
       
         O[k,:] \leftarrow \bm{o}_N
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           O
          </span>
          <span class="mopen">
           [
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0315em;">
           k
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           :
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mclose">
           ]
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           ←
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.5944em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord">
            <span class="mord">
             <span class="mord boldsymbol">
              o
             </span>
            </span>
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                  N
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     我们将公式 (12) 中的
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        a 
         
        
          i 
         
        
       
      
        a_i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           a
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     替换公式 (11) 中的定义，有：
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         o 
              
             
               i 
              
             
            
              : 
             
            
              = 
             
             
             
               ∑ 
              
              
              
                j 
               
              
                = 
               
              
                1 
               
              
             
               i 
              
             
             
             
               ( 
              
              
               
               
                 e 
                
                
                 
                 
                   x 
                  
                 
                   j 
                  
                 
                
                  − 
                 
                 
                 
                   m 
                  
                 
                   N 
                  
                 
                
               
               
               
                 d 
                
               
                 N 
                
               
                 ′ 
                
               
              
             
               V 
              
             
               [ 
              
             
               j 
              
             
               , 
              
             
               : 
              
             
               ] 
              
             
               ) 
              
             
            
           
          
          
          
         
        
       
         \begin{align} \bm{o}_i := \sum_{j=1}^i\left(\frac{e^{x_j-m_N}}{d_N^{\prime}}V[j,:]\right) \end{align}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 3.5254em; vertical-align: -1.5127em;">
          </span>
          <span class="mtable">
           <span class="col-align-r">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 2.0127em;">
               <span class="" style="top: -4.0127em;">
                <span class="pstrut" style="height: 3.8117em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mord">
                   <span class="mord">
                    <span class="mord boldsymbol">
                     o
                    </span>
                   </span>
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3117em;">
                      <span class="" style="top: -2.55em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight">
                         i
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.15em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mrel">
                  :=
                 </span>
                 <span class="mspace" style="margin-right: 0.2778em;">
                 </span>
                 <span class="mop op-limits">
                  <span class="vlist-t vlist-t2">
                   <span class="vlist-r">
                    <span class="vlist" style="height: 1.8117em;">
                     <span class="" style="top: -1.8723em; margin-left: 0em;">
                      <span class="pstrut" style="height: 3.05em;">
                      </span>
                      <span class="sizing reset-size6 size3 mtight">
                       <span class="mord mtight">
                        <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                         j
                        </span>
                        <span class="mrel mtight">
                         =
                        </span>
                        <span class="mord mtight">
                         1
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="" style="top: -3.05em;">
                      <span class="pstrut" style="height: 3.05em;">
                      </span>
                      <span class="">
                       <span class="mop op-symbol large-op">
                        ∑
                       </span>
                      </span>
                     </span>
                     <span class="" style="top: -4.3em; margin-left: 0em;">
                      <span class="pstrut" style="height: 3.05em;">
                      </span>
                      <span class="sizing reset-size6 size3 mtight">
                       <span class="mord mathnormal mtight">
                        i
                       </span>
                      </span>
                     </span>
                    </span>
                    <span class="vlist-s">
                     ​
                    </span>
                   </span>
                   <span class="vlist-r">
                    <span class="vlist" style="height: 1.4138em;">
                     <span class="">
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mspace" style="margin-right: 0.1667em;">
                 </span>
                 <span class="minner">
                  <span class="mopen delimcenter" style="top: 0em;">
                   <span class="delimsizing size3">
                    (
                   </span>
                  </span>
                  <span class="mord">
                   <span class="mopen nulldelimiter">
                   </span>
                   <span class="mfrac">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 1.4483em;">
                       <span class="" style="top: -2.314em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                          <span class="mord mathnormal">
                           d
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.7337em;">
                              <span class="" style="top: -2.4065em; margin-left: 0em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                                 N
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  ′
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.2935em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.23em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="frac-line" style="border-bottom-width: 0.04em;">
                        </span>
                       </span>
                       <span class="" style="top: -3.677em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                          <span class="mord mathnormal">
                           e
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.7713em;">
                              <span class="" style="top: -3.063em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   x
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                         j
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.2819em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   m
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3448em;">
                                      <span class="" style="top: -2.3567em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                                         N
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.1433em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.9795em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                   <span class="mclose nulldelimiter">
                   </span>
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.2222em;">
                   V
                  </span>
                  <span class="mopen">
                   [
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.0572em;">
                   j
                  </span>
                  <span class="mpunct">
                   ,
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mclose">
                   ]
                  </span>
                  <span class="mclose delimcenter" style="top: 0em;">
                   <span class="delimsizing size3">
                    )
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 1.5127em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="tag">
          <span class="vlist-t vlist-t2">
           <span class="vlist-r">
            <span class="vlist" style="height: 2.0127em;">
             <span class="" style="top: -4.0127em;">
              <span class="pstrut" style="height: 3.8117em;">
              </span>
              <span class="eqn-num">
              </span>
             </span>
            </span>
            <span class="vlist-s">
             ​
            </span>
           </span>
           <span class="vlist-r">
            <span class="vlist" style="height: 1.5127em;">
             <span class="">
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     该公式仍然依赖
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        m 
         
        
          N 
         
        
       
      
        m_N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           m
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3283em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                 N
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     和
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        d 
         
        
          N 
         
        
       
      
        d_N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           d
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3283em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                 N
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     变量，这两个值在前一个循环完成之前无法确定。但我们可以再次使用第 3 节中的替代技巧，即创建替代序列
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        o 
         
        
          ′ 
         
        
       
      
        \bm{o}^{\prime}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7519em;">
         </span>
         <span class="mord">
          <span class="mord">
           <span class="mord">
            <span class="mord boldsymbol">
             o
            </span>
           </span>
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ：
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         o 
          
         
           i 
          
         
           ′ 
          
         
        
          : 
         
        
          = 
         
         
         
           ( 
          
          
          
            ∑ 
           
           
           
             j 
            
           
             = 
            
           
             1 
            
           
          
            i 
           
          
          
           
           
             e 
            
            
             
             
               x 
              
             
               j 
              
             
            
              − 
             
             
             
               m 
              
             
               i 
              
             
            
           
           
           
             d 
            
           
             i 
            
           
             ′ 
            
           
          
         
           V 
          
         
           [ 
          
         
           j 
          
         
           , 
          
         
           : 
          
         
           ] 
          
         
           ) 
          
         
        
       
         \bm{o}_i^{\prime}:=\left(\sum_{j=1}^i\frac{e^{x_j-m_i}}{d_i^{\prime}}V[j,:]\right)
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.0489em; vertical-align: -0.247em;">
          </span>
          <span class="mord">
           <span class="mord">
            <span class="mord">
             <span class="mord boldsymbol">
              o
             </span>
            </span>
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8019em;">
               <span class="" style="top: -2.453em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   ′
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.247em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           :=
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 3.2254em; vertical-align: -1.4138em;">
          </span>
          <span class="minner">
           <span class="mopen delimcenter" style="top: 0em;">
            <span class="delimsizing size4">
             (
            </span>
           </span>
           <span class="mop op-limits">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.8117em;">
               <span class="" style="top: -1.8723em; margin-left: 0em;">
                <span class="pstrut" style="height: 3.05em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   j
                  </span>
                  <span class="mrel mtight">
                   =
                  </span>
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.05em;">
                <span class="pstrut" style="height: 3.05em;">
                </span>
                <span class="">
                 <span class="mop op-symbol large-op">
                  ∑
                 </span>
                </span>
               </span>
               <span class="" style="top: -4.3em; margin-left: 0em;">
                <span class="pstrut" style="height: 3.05em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 1.4138em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mspace" style="margin-right: 0.1667em;">
           </span>
           <span class="mord">
            <span class="mopen nulldelimiter">
            </span>
            <span class="mfrac">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 1.4483em;">
                <span class="" style="top: -2.314em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord mathnormal">
                    d
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.7337em;">
                       <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mathnormal mtight">
                          i
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           ′
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.2769em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.23em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="frac-line" style="border-bottom-width: 0.04em;">
                 </span>
                </span>
                <span class="" style="top: -3.677em;">
                 <span class="pstrut" style="height: 3em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord mathnormal">
                    e
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.7713em;">
                       <span class="" style="top: -3.063em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            x
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3281em;">
                               <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                  j
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.2819em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mbin mtight">
                           −
                          </span>
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            m
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3281em;">
                               <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.143em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.9629em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="mclose nulldelimiter">
            </span>
           </span>
           <span class="mord mathnormal" style="margin-right: 0.2222em;">
            V
           </span>
           <span class="mopen">
            [
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0572em;">
            j
           </span>
           <span class="mpunct">
            ,
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            :
           </span>
           <span class="mclose">
            ]
           </span>
           <span class="mclose delimcenter" style="top: 0em;">
            <span class="delimsizing size4">
             )
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        o 
        
       
      
        \bm{o}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4444em;">
         </span>
         <span class="mord">
          <span class="mord">
           <span class="mord boldsymbol">
            o
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     和
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        o 
         
        
          ′ 
         
        
       
      
        \bm{o}^{\prime}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.7519em;">
         </span>
         <span class="mord">
          <span class="mord">
           <span class="mord">
            <span class="mord boldsymbol">
             o
            </span>
           </span>
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     的第
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        N 
        
       
      
        N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.109em;">
          N
         </span>
        </span>
       </span>
      </span>
     </span>
     个元素相同即
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        o 
         
        
          N 
         
        
          ′ 
         
        
       
         = 
        
        
        
          o 
         
        
          N 
         
        
       
      
        \bm{o}^{\prime}_N=\bm{o}_N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0272em; vertical-align: -0.2753em;">
         </span>
         <span class="mord">
          <span class="mord">
           <span class="mord">
            <span class="mord boldsymbol">
             o
            </span>
           </span>
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -2.4247em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                 N
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2753em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          =
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.5944em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord">
           <span class="mord">
            <span class="mord boldsymbol">
             o
            </span>
           </span>
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3283em;">
              <span class="" style="top: -2.55em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                 N
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，并且我们可以发现
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        o 
         
        
          i 
         
        
          ′ 
         
        
       
      
        \bm{o}^{\prime}_i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;">
         </span>
         <span class="mord">
          <span class="mord">
           <span class="mord">
            <span class="mord boldsymbol">
             o
            </span>
           </span>
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -2.4413em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2587em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     和
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        o 
         
         
         
           i 
          
         
           − 
          
         
           1 
          
         
        
          ′ 
         
        
       
      
        \bm{o}^{\prime}_{i-1}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0689em; vertical-align: -0.317em;">
         </span>
         <span class="mord">
          <span class="mord">
           <span class="mord">
            <span class="mord boldsymbol">
             o
            </span>
           </span>
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -2.4413em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                 <span class="mbin mtight">
                  −
                 </span>
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.317em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     之间存在如下的递归关系：
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         o 
                 
                
                  i 
                 
                
                  ′ 
                 
                
               
              
              
               
                
                 
                
                  = 
                 
                 
                 
                   ∑ 
                  
                  
                  
                    j 
                   
                  
                    = 
                   
                  
                    1 
                   
                  
                 
                   i 
                  
                 
                 
                  
                  
                    e 
                   
                   
                    
                    
                      x 
                     
                    
                      j 
                     
                    
                   
                     − 
                    
                    
                    
                      m 
                     
                    
                      i 
                     
                    
                   
                  
                  
                  
                    d 
                   
                  
                    i 
                   
                  
                    ′ 
                   
                  
                 
                
                  V 
                 
                
                  [ 
                 
                
                  j 
                 
                
                  , 
                 
                
                  : 
                 
                
                  ] 
                 
                
               
              
             
             
              
               
                
               
              
              
               
                
                 
                
                  = 
                 
                 
                 
                   ( 
                  
                  
                  
                    ∑ 
                   
                   
                   
                     j 
                    
                   
                     = 
                    
                   
                     1 
                    
                   
                   
                   
                     i 
                    
                   
                     − 
                    
                   
                     1 
                    
                   
                  
                  
                   
                   
                     e 
                    
                    
                     
                     
                       x 
                      
                     
                       j 
                      
                     
                    
                      − 
                     
                     
                     
                       m 
                      
                     
                       i 
                      
                     
                    
                   
                   
                   
                     d 
                    
                   
                     i 
                    
                   
                     ′ 
                    
                   
                  
                 
                   V 
                  
                 
                   [ 
                  
                 
                   j 
                  
                 
                   , 
                  
                 
                   : 
                  
                 
                   ] 
                  
                 
                   ) 
                  
                 
                
                  + 
                 
                 
                  
                  
                    e 
                   
                   
                    
                    
                      x 
                     
                    
                      i 
                     
                    
                   
                     − 
                    
                    
                    
                      m 
                     
                    
                      i 
                     
                    
                   
                  
                  
                  
                    d 
                   
                  
                    i 
                   
                  
                    ′ 
                   
                  
                 
                
                  V 
                 
                
                  [ 
                 
                
                  i 
                 
                
                  , 
                 
                
                  : 
                 
                
                  ] 
                 
                
               
              
             
             
              
               
                
               
              
              
               
                
                 
                
                  = 
                 
                 
                 
                   ( 
                  
                  
                  
                    ∑ 
                   
                   
                   
                     j 
                    
                   
                     = 
                    
                   
                     1 
                    
                   
                   
                   
                     i 
                    
                   
                     − 
                    
                   
                     1 
                    
                   
                  
                  
                   
                   
                     e 
                    
                    
                     
                     
                       x 
                      
                     
                       j 
                      
                     
                    
                      − 
                     
                     
                     
                       m 
                      
                      
                      
                        i 
                       
                      
                        − 
                       
                      
                        1 
                       
                      
                     
                    
                   
                   
                   
                     d 
                    
                    
                    
                      i 
                     
                    
                      − 
                     
                    
                      1 
                     
                    
                   
                     ′ 
                    
                   
                  
                  
                   
                   
                     e 
                    
                    
                     
                     
                       x 
                      
                     
                       j 
                      
                     
                    
                      − 
                     
                     
                     
                       m 
                      
                     
                       i 
                      
                     
                    
                   
                   
                   
                     e 
                    
                    
                     
                     
                       x 
                      
                     
                       j 
                      
                     
                    
                      − 
                     
                     
                     
                       m 
                      
                      
                      
                        i 
                       
                      
                        − 
                       
                      
                        1 
                       
                      
                     
                    
                   
                  
                  
                   
                   
                     d 
                    
                    
                    
                      i 
                     
                    
                      − 
                     
                    
                      1 
                     
                    
                   
                     ′ 
                    
                   
                   
                   
                     d 
                    
                   
                     i 
                    
                   
                     ′ 
                    
                   
                  
                 
                   V 
                  
                 
                   [ 
                  
                 
                   j 
                  
                 
                   , 
                  
                 
                   : 
                  
                 
                   ] 
                  
                 
                   ) 
                  
                 
                
                  + 
                 
                 
                  
                  
                    e 
                   
                   
                    
                    
                      x 
                     
                    
                      i 
                     
                    
                   
                     − 
                    
                    
                    
                      m 
                     
                    
                      i 
                     
                    
                   
                  
                  
                  
                    d 
                   
                  
                    i 
                   
                  
                    ′ 
                   
                  
                 
                
                  V 
                 
                
                  [ 
                 
                
                  i 
                 
                
                  , 
                 
                
                  : 
                 
                
                  ] 
                 
                
               
              
             
             
              
               
                
               
              
              
               
                
                 
                
                  = 
                 
                 
                 
                   ( 
                  
                  
                  
                    ∑ 
                   
                   
                   
                     j 
                    
                   
                     = 
                    
                   
                     1 
                    
                   
                   
                   
                     i 
                    
                   
                     − 
                    
                   
                     1 
                    
                   
                  
                  
                   
                   
                     e 
                    
                    
                     
                     
                       x 
                      
                     
                       j 
                      
                     
                    
                      − 
                     
                     
                     
                       m 
                      
                      
                      
                        i 
                       
                      
                        − 
                       
                      
                        1 
                       
                      
                     
                    
                   
                   
                   
                     d 
                    
                    
                    
                      i 
                     
                    
                      − 
                     
                    
                      1 
                     
                    
                   
                     ′ 
                    
                   
                  
                 
                   V 
                  
                 
                   [ 
                  
                 
                   j 
                  
                 
                   , 
                  
                 
                   : 
                  
                 
                   ] 
                  
                 
                   ) 
                  
                 
                 
                  
                  
                    d 
                   
                   
                   
                     i 
                    
                   
                     − 
                    
                   
                     1 
                    
                   
                  
                    ′ 
                   
                  
                  
                  
                    d 
                   
                  
                    i 
                   
                  
                    ′ 
                   
                  
                 
                 
                 
                   e 
                  
                  
                   
                   
                     m 
                    
                    
                    
                      i 
                     
                    
                      − 
                     
                    
                      1 
                     
                    
                   
                  
                    − 
                   
                   
                   
                     m 
                    
                   
                     i 
                    
                   
                  
                 
                
                  + 
                 
                 
                  
                  
                    e 
                   
                   
                    
                    
                      x 
                     
                    
                      i 
                     
                    
                   
                     − 
                    
                    
                    
                      m 
                     
                    
                      i 
                     
                    
                   
                  
                  
                  
                    d 
                   
                  
                    i 
                   
                  
                    ′ 
                   
                  
                 
                
                  V 
                 
                
                  [ 
                 
                
                  i 
                 
                
                  , 
                 
                
                  : 
                 
                
                  ] 
                 
                
               
              
             
             
              
               
                
               
              
              
               
                
                 
                
                  = 
                 
                 
                 
                   o 
                  
                  
                  
                    i 
                   
                  
                    − 
                   
                  
                    1 
                   
                  
                 
                   ′ 
                  
                 
                 
                  
                   
                   
                     d 
                    
                    
                    
                      i 
                     
                    
                      − 
                     
                    
                      1 
                     
                    
                   
                     ′ 
                    
                   
                   
                   
                     e 
                    
                    
                     
                     
                       m 
                      
                      
                      
                        i 
                       
                      
                        − 
                       
                      
                        1 
                       
                      
                     
                    
                      − 
                     
                     
                     
                       m 
                      
                     
                       i 
                      
                     
                    
                   
                  
                  
                  
                    d 
                   
                  
                    i 
                   
                  
                    ′ 
                   
                  
                 
                
                  + 
                 
                 
                  
                  
                    e 
                   
                   
                    
                    
                      x 
                     
                    
                      i 
                     
                    
                   
                     − 
                    
                    
                    
                      m 
                     
                    
                      i 
                     
                    
                   
                  
                  
                  
                    d 
                   
                  
                    i 
                   
                  
                    ′ 
                   
                  
                 
                
                  V 
                 
                
                  [ 
                 
                
                  i 
                 
                
                  , 
                 
                
                  : 
                 
                
                  ] 
                 
                
               
              
             
            
           
          
          
          
         
        
       
         \begin{equation} \begin{aligned} \bm{o}^{\prime}_{i}&amp; = \sum_{j=1}^{i} \frac{e^{x_{j}-m_{i}}}{d^{\prime}_{i}}V[j, : ]\\ &amp; = \left(\sum_{j=1}^{i-1}\frac{e^{x_{j}-m_{i}}}{d^{\prime}_{i} }V[j, : ]\right) + \frac{e^{x_{i}-m_{i}}}{d^{\prime}_{i}}V[i, : ]\\ &amp; = \left(\sum_{j=1}^{i-1}\frac{e^{x_{j}-m_{i-1}}}{d^{\prime}_{ i-1}}\frac{e^{x_{j}-m_{i}}}{e^{x_{j}-m_{i-1}}}\frac{d^{\prime}_{i-1}}{d^{ \prime}_{i}}V[j, : ]\right) + \frac{e^{x_{i}-m_{i}}}{d^{\prime}_{i}}V[i, : ]\\ &amp; = \left(\sum_{j=1}^{i-1}\frac{e^{x_{j}-m_{i-1}}}{d^{\prime}_{ i-1}}V[j, : ]\right) \frac{d^{\prime}_{i-1}}{d^{\prime}_{i}}e^{m_{i-1}-m_{i}} + \frac{e^{x_{i}-m_{i}}}{d^{\prime}_{i}}V[i, : ]\\ &amp; = \bm{o}^{\prime}_{i-1}\frac{d^{\prime}_{i-1} e^{m_{i-1}-m_{ i}}}{d^{\prime}_{i}} + \frac{e^{x_{i}-m_{i}}}{d^{\prime}_{i}}V[i, : ] \end{aligned} \end{equation}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 16.843em; vertical-align: -8.1715em;">
          </span>
          <span class="mtable">
           <span class="col-align-c">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 8.6715em;">
               <span class="" style="top: -10.6715em;">
                <span class="pstrut" style="height: 10.6715em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  <span class="mtable">
                   <span class="col-align-r">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 8.6715em;">
                       <span class="" style="top: -10.6715em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                          <span class="mord">
                           <span class="mord">
                            <span class="mord boldsymbol">
                             o
                            </span>
                           </span>
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.8019em;">
                              <span class="" style="top: -2.453em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.113em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  ′
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.247em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -7.146em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                        </span>
                       </span>
                       <span class="" style="top: -3.6206em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                        </span>
                       </span>
                       <span class="" style="top: -0.0951em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                        </span>
                       </span>
                       <span class="" style="top: 3.097em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 8.1715em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                   <span class="col-align-l">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 8.6715em;">
                       <span class="" style="top: -10.6715em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mrel">
                          =
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mop op-limits">
                          <span class="vlist-t vlist-t2">
                           <span class="vlist-r">
                            <span class="vlist" style="height: 1.8117em;">
                             <span class="" style="top: -1.8723em; margin-left: 0em;">
                              <span class="pstrut" style="height: 3.05em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mtight">
                                <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                 j
                                </span>
                                <span class="mrel mtight">
                                 =
                                </span>
                                <span class="mord mtight">
                                 1
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="" style="top: -3.05em;">
                              <span class="pstrut" style="height: 3.05em;">
                              </span>
                              <span class="">
                               <span class="mop op-symbol large-op">
                                ∑
                               </span>
                              </span>
                             </span>
                             <span class="" style="top: -4.3em; margin-left: 0em;">
                              <span class="pstrut" style="height: 3.05em;">
                              </span>
                              <span class="sizing reset-size6 size3 mtight">
                               <span class="mord mtight">
                                <span class="mord mathnormal mtight">
                                 i
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                            <span class="vlist-s">
                             ​
                            </span>
                           </span>
                           <span class="vlist-r">
                            <span class="vlist" style="height: 1.4138em;">
                             <span class="">
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                         <span class="mspace" style="margin-right: 0.1667em;">
                         </span>
                         <span class="mord">
                          <span class="mopen nulldelimiter">
                          </span>
                          <span class="mfrac">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.4483em;">
                              <span class="" style="top: -2.314em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="mord">
                                <span class="mord">
                                 <span class="mord mathnormal">
                                  d
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.7337em;">
                                     <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mtight">
                                         ′
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.2769em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.23em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="frac-line" style="border-bottom-width: 0.04em;">
                               </span>
                              </span>
                              <span class="" style="top: -3.677em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="mord">
                                <span class="mord">
                                 <span class="mord mathnormal">
                                  e
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.7713em;">
                                     <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          x
                                         </span>
                                         <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.3281em;">
                                             <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                              <span class="pstrut" style="height: 2.5em;">
                                              </span>
                                              <span class="sizing reset-size3 size1 mtight">
                                               <span class="mord mtight">
                                                <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                                 j
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                            </span>
                                            <span class="vlist-s">
                                             ​
                                            </span>
                                           </span>
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.2819em;">
                                             <span class="">
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                        <span class="mbin mtight">
                                         −
                                        </span>
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          m
                                         </span>
                                         <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.3281em;">
                                             <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                              <span class="pstrut" style="height: 2.5em;">
                                              </span>
                                              <span class="sizing reset-size3 size1 mtight">
                                               <span class="mord mtight">
                                                <span class="mord mathnormal mtight">
                                                 i
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                            </span>
                                            <span class="vlist-s">
                                             ​
                                            </span>
                                           </span>
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.143em;">
                                             <span class="">
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.9629em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mclose nulldelimiter">
                          </span>
                         </span>
                         <span class="mord mathnormal" style="margin-right: 0.2222em;">
                          V
                         </span>
                         <span class="mopen">
                          [
                         </span>
                         <span class="mord mathnormal" style="margin-right: 0.0572em;">
                          j
                         </span>
                         <span class="mpunct">
                          ,
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mrel">
                          :
                         </span>
                         <span class="mclose">
                          ]
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -7.146em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mrel">
                          =
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="minner">
                          <span class="mopen delimcenter" style="top: 0em;">
                           <span class="delimsizing size4">
                            (
                           </span>
                          </span>
                          <span class="mop op-limits">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.8117em;">
                              <span class="" style="top: -1.8723em; margin-left: 0em;">
                               <span class="pstrut" style="height: 3.05em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                  j
                                 </span>
                                 <span class="mrel mtight">
                                  =
                                 </span>
                                 <span class="mord mtight">
                                  1
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.05em;">
                               <span class="pstrut" style="height: 3.05em;">
                               </span>
                               <span class="">
                                <span class="mop op-symbol large-op">
                                 ∑
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -4.3em; margin-left: 0em;">
                               <span class="pstrut" style="height: 3.05em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  1
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.4138em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mspace" style="margin-right: 0.1667em;">
                          </span>
                          <span class="mord">
                           <span class="mopen nulldelimiter">
                           </span>
                           <span class="mfrac">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 1.4483em;">
                               <span class="" style="top: -2.314em;">
                                <span class="pstrut" style="height: 3em;">
                                </span>
                                <span class="mord">
                                 <span class="mord">
                                  <span class="mord mathnormal">
                                   d
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.7337em;">
                                      <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                                       <span class="pstrut" style="height: 2.7em;">
                                       </span>
                                       <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          i
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                      <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                                       <span class="pstrut" style="height: 2.7em;">
                                       </span>
                                       <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mtight">
                                          ′
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.2769em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                               <span class="" style="top: -3.23em;">
                                <span class="pstrut" style="height: 3em;">
                                </span>
                                <span class="frac-line" style="border-bottom-width: 0.04em;">
                                </span>
                               </span>
                               <span class="" style="top: -3.677em;">
                                <span class="pstrut" style="height: 3em;">
                                </span>
                                <span class="mord">
                                 <span class="mord">
                                  <span class="mord mathnormal">
                                   e
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.7713em;">
                                      <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                       <span class="pstrut" style="height: 2.7em;">
                                       </span>
                                       <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                           x
                                          </span>
                                          <span class="msupsub">
                                           <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.3281em;">
                                              <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                               <span class="pstrut" style="height: 2.5em;">
                                               </span>
                                               <span class="sizing reset-size3 size1 mtight">
                                                <span class="mord mtight">
                                                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                                  j
                                                 </span>
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                             <span class="vlist-s">
                                              ​
                                             </span>
                                            </span>
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.2819em;">
                                              <span class="">
                                              </span>
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                         <span class="mbin mtight">
                                          −
                                         </span>
                                         <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                           m
                                          </span>
                                          <span class="msupsub">
                                           <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.3281em;">
                                              <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                               <span class="pstrut" style="height: 2.5em;">
                                               </span>
                                               <span class="sizing reset-size3 size1 mtight">
                                                <span class="mord mtight">
                                                 <span class="mord mathnormal mtight">
                                                  i
                                                 </span>
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                             <span class="vlist-s">
                                              ​
                                             </span>
                                            </span>
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.143em;">
                                              <span class="">
                                              </span>
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.9629em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                           <span class="mclose nulldelimiter">
                           </span>
                          </span>
                          <span class="mord mathnormal" style="margin-right: 0.2222em;">
                           V
                          </span>
                          <span class="mopen">
                           [
                          </span>
                          <span class="mord mathnormal" style="margin-right: 0.0572em;">
                           j
                          </span>
                          <span class="mpunct">
                           ,
                          </span>
                          <span class="mspace" style="margin-right: 0.2778em;">
                          </span>
                          <span class="mrel">
                           :
                          </span>
                          <span class="mclose">
                           ]
                          </span>
                          <span class="mclose delimcenter" style="top: 0em;">
                           <span class="delimsizing size4">
                            )
                           </span>
                          </span>
                         </span>
                         <span class="mspace" style="margin-right: 0.2222em;">
                         </span>
                         <span class="mbin">
                          +
                         </span>
                         <span class="mspace" style="margin-right: 0.2222em;">
                         </span>
                         <span class="mord">
                          <span class="mopen nulldelimiter">
                          </span>
                          <span class="mfrac">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.4483em;">
                              <span class="" style="top: -2.314em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="mord">
                                <span class="mord">
                                 <span class="mord mathnormal">
                                  d
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.7337em;">
                                     <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mtight">
                                         ′
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.2769em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.23em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="frac-line" style="border-bottom-width: 0.04em;">
                               </span>
                              </span>
                              <span class="" style="top: -3.677em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="mord">
                                <span class="mord">
                                 <span class="mord mathnormal">
                                  e
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.7713em;">
                                     <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          x
                                         </span>
                                         <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.3281em;">
                                             <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                              <span class="pstrut" style="height: 2.5em;">
                                              </span>
                                              <span class="sizing reset-size3 size1 mtight">
                                               <span class="mord mtight">
                                                <span class="mord mathnormal mtight">
                                                 i
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                            </span>
                                            <span class="vlist-s">
                                             ​
                                            </span>
                                           </span>
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.143em;">
                                             <span class="">
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                        <span class="mbin mtight">
                                         −
                                        </span>
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          m
                                         </span>
                                         <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.3281em;">
                                             <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                              <span class="pstrut" style="height: 2.5em;">
                                              </span>
                                              <span class="sizing reset-size3 size1 mtight">
                                               <span class="mord mtight">
                                                <span class="mord mathnormal mtight">
                                                 i
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                            </span>
                                            <span class="vlist-s">
                                             ​
                                            </span>
                                           </span>
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.143em;">
                                             <span class="">
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.9629em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mclose nulldelimiter">
                          </span>
                         </span>
                         <span class="mord mathnormal" style="margin-right: 0.2222em;">
                          V
                         </span>
                         <span class="mopen">
                          [
                         </span>
                         <span class="mord mathnormal">
                          i
                         </span>
                         <span class="mpunct">
                          ,
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mrel">
                          :
                         </span>
                         <span class="mclose">
                          ]
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.6206em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mrel">
                          =
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="minner">
                          <span class="mopen delimcenter" style="top: 0em;">
                           <span class="delimsizing size4">
                            (
                           </span>
                          </span>
                          <span class="mop op-limits">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.8117em;">
                              <span class="" style="top: -1.8723em; margin-left: 0em;">
                               <span class="pstrut" style="height: 3.05em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                  j
                                 </span>
                                 <span class="mrel mtight">
                                  =
                                 </span>
                                 <span class="mord mtight">
                                  1
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.05em;">
                               <span class="pstrut" style="height: 3.05em;">
                               </span>
                               <span class="">
                                <span class="mop op-symbol large-op">
                                 ∑
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -4.3em; margin-left: 0em;">
                               <span class="pstrut" style="height: 3.05em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  1
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.4138em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mspace" style="margin-right: 0.1667em;">
                          </span>
                          <span class="mord">
                           <span class="mopen nulldelimiter">
                           </span>
                           <span class="mfrac">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 1.4483em;">
                               <span class="" style="top: -2.314em;">
                                <span class="pstrut" style="height: 3em;">
                                </span>
                                <span class="mord">
                                 <span class="mord">
                                  <span class="mord mathnormal">
                                   d
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.7337em;">
                                      <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                                       <span class="pstrut" style="height: 2.7em;">
                                       </span>
                                       <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          i
                                         </span>
                                         <span class="mbin mtight">
                                          −
                                         </span>
                                         <span class="mord mtight">
                                          1
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                      <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                                       <span class="pstrut" style="height: 2.7em;">
                                       </span>
                                       <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mtight">
                                          ′
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3352em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                               <span class="" style="top: -3.23em;">
                                <span class="pstrut" style="height: 3em;">
                                </span>
                                <span class="frac-line" style="border-bottom-width: 0.04em;">
                                </span>
                               </span>
                               <span class="" style="top: -3.677em;">
                                <span class="pstrut" style="height: 3em;">
                                </span>
                                <span class="mord">
                                 <span class="mord">
                                  <span class="mord mathnormal">
                                   e
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.7713em;">
                                      <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                       <span class="pstrut" style="height: 2.7em;">
                                       </span>
                                       <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                           x
                                          </span>
                                          <span class="msupsub">
                                           <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.3281em;">
                                              <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                               <span class="pstrut" style="height: 2.5em;">
                                               </span>
                                               <span class="sizing reset-size3 size1 mtight">
                                                <span class="mord mtight">
                                                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                                  j
                                                 </span>
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                             <span class="vlist-s">
                                              ​
                                             </span>
                                            </span>
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.2819em;">
                                              <span class="">
                                              </span>
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                         <span class="mbin mtight">
                                          −
                                         </span>
                                         <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                           m
                                          </span>
                                          <span class="msupsub">
                                           <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.3281em;">
                                              <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                               <span class="pstrut" style="height: 2.5em;">
                                               </span>
                                               <span class="sizing reset-size3 size1 mtight">
                                                <span class="mord mtight">
                                                 <span class="mord mathnormal mtight">
                                                  i
                                                 </span>
                                                 <span class="mbin mtight">
                                                  −
                                                 </span>
                                                 <span class="mord mtight">
                                                  1
                                                 </span>
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                             <span class="vlist-s">
                                              ​
                                             </span>
                                            </span>
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.2025em;">
                                              <span class="">
                                              </span>
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 1.0212em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                           <span class="mclose nulldelimiter">
                           </span>
                          </span>
                          <span class="mord">
                           <span class="mopen nulldelimiter">
                           </span>
                           <span class="mfrac">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 1.4483em;">
                               <span class="" style="top: -2.314em;">
                                <span class="pstrut" style="height: 3em;">
                                </span>
                                <span class="mord">
                                 <span class="mord">
                                  <span class="mord mathnormal">
                                   e
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.7134em;">
                                      <span class="" style="top: -3.0051em; margin-right: 0.05em;">
                                       <span class="pstrut" style="height: 2.7em;">
                                       </span>
                                       <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                           x
                                          </span>
                                          <span class="msupsub">
                                           <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.3281em;">
                                              <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                               <span class="pstrut" style="height: 2.5em;">
                                               </span>
                                               <span class="sizing reset-size3 size1 mtight">
                                                <span class="mord mtight">
                                                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                                  j
                                                 </span>
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                             <span class="vlist-s">
                                              ​
                                             </span>
                                            </span>
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.2819em;">
                                              <span class="">
                                              </span>
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                         <span class="mbin mtight">
                                          −
                                         </span>
                                         <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                           m
                                          </span>
                                          <span class="msupsub">
                                           <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.3281em;">
                                              <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                               <span class="pstrut" style="height: 2.5em;">
                                               </span>
                                               <span class="sizing reset-size3 size1 mtight">
                                                <span class="mord mtight">
                                                 <span class="mord mathnormal mtight">
                                                  i
                                                 </span>
                                                 <span class="mbin mtight">
                                                  −
                                                 </span>
                                                 <span class="mord mtight">
                                                  1
                                                 </span>
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                             <span class="vlist-s">
                                              ​
                                             </span>
                                            </span>
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.2025em;">
                                              <span class="">
                                              </span>
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                               <span class="" style="top: -3.23em;">
                                <span class="pstrut" style="height: 3em;">
                                </span>
                                <span class="frac-line" style="border-bottom-width: 0.04em;">
                                </span>
                               </span>
                               <span class="" style="top: -3.677em;">
                                <span class="pstrut" style="height: 3em;">
                                </span>
                                <span class="mord">
                                 <span class="mord">
                                  <span class="mord mathnormal">
                                   e
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.7713em;">
                                      <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                       <span class="pstrut" style="height: 2.7em;">
                                       </span>
                                       <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                           x
                                          </span>
                                          <span class="msupsub">
                                           <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.3281em;">
                                              <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                               <span class="pstrut" style="height: 2.5em;">
                                               </span>
                                               <span class="sizing reset-size3 size1 mtight">
                                                <span class="mord mtight">
                                                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                                  j
                                                 </span>
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                             <span class="vlist-s">
                                              ​
                                             </span>
                                            </span>
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.2819em;">
                                              <span class="">
                                              </span>
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                         <span class="mbin mtight">
                                          −
                                         </span>
                                         <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                           m
                                          </span>
                                          <span class="msupsub">
                                           <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.3281em;">
                                              <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                               <span class="pstrut" style="height: 2.5em;">
                                               </span>
                                               <span class="sizing reset-size3 size1 mtight">
                                                <span class="mord mtight">
                                                 <span class="mord mathnormal mtight">
                                                  i
                                                 </span>
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                             <span class="vlist-s">
                                              ​
                                             </span>
                                            </span>
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.143em;">
                                              <span class="">
                                              </span>
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.686em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                           <span class="mclose nulldelimiter">
                           </span>
                          </span>
                          <span class="mord">
                           <span class="mopen nulldelimiter">
                           </span>
                           <span class="mfrac">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 1.4589em;">
                               <span class="" style="top: -2.314em;">
                                <span class="pstrut" style="height: 3em;">
                                </span>
                                <span class="mord">
                                 <span class="mord">
                                  <span class="mord mathnormal">
                                   d
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.7337em;">
                                      <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                                       <span class="pstrut" style="height: 2.7em;">
                                       </span>
                                       <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          i
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                      <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                                       <span class="pstrut" style="height: 2.7em;">
                                       </span>
                                       <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mtight">
                                          ′
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.2769em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                               <span class="" style="top: -3.23em;">
                                <span class="pstrut" style="height: 3em;">
                                </span>
                                <span class="frac-line" style="border-bottom-width: 0.04em;">
                                </span>
                               </span>
                               <span class="" style="top: -3.707em;">
                                <span class="pstrut" style="height: 3em;">
                                </span>
                                <span class="mord">
                                 <span class="mord">
                                  <span class="mord mathnormal">
                                   d
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.7519em;">
                                      <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
                                       <span class="pstrut" style="height: 2.7em;">
                                       </span>
                                       <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          i
                                         </span>
                                         <span class="mbin mtight">
                                          −
                                         </span>
                                         <span class="mord mtight">
                                          1
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                      <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                       <span class="pstrut" style="height: 2.7em;">
                                       </span>
                                       <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mtight">
                                          ′
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.317em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.9629em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                           <span class="mclose nulldelimiter">
                           </span>
                          </span>
                          <span class="mord mathnormal" style="margin-right: 0.2222em;">
                           V
                          </span>
                          <span class="mopen">
                           [
                          </span>
                          <span class="mord mathnormal" style="margin-right: 0.0572em;">
                           j
                          </span>
                          <span class="mpunct">
                           ,
                          </span>
                          <span class="mspace" style="margin-right: 0.2778em;">
                          </span>
                          <span class="mrel">
                           :
                          </span>
                          <span class="mclose">
                           ]
                          </span>
                          <span class="mclose delimcenter" style="top: 0em;">
                           <span class="delimsizing size4">
                            )
                           </span>
                          </span>
                         </span>
                         <span class="mspace" style="margin-right: 0.2222em;">
                         </span>
                         <span class="mbin">
                          +
                         </span>
                         <span class="mspace" style="margin-right: 0.2222em;">
                         </span>
                         <span class="mord">
                          <span class="mopen nulldelimiter">
                          </span>
                          <span class="mfrac">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.4483em;">
                              <span class="" style="top: -2.314em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="mord">
                                <span class="mord">
                                 <span class="mord mathnormal">
                                  d
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.7337em;">
                                     <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mtight">
                                         ′
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.2769em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.23em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="frac-line" style="border-bottom-width: 0.04em;">
                               </span>
                              </span>
                              <span class="" style="top: -3.677em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="mord">
                                <span class="mord">
                                 <span class="mord mathnormal">
                                  e
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.7713em;">
                                     <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          x
                                         </span>
                                         <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.3281em;">
                                             <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                              <span class="pstrut" style="height: 2.5em;">
                                              </span>
                                              <span class="sizing reset-size3 size1 mtight">
                                               <span class="mord mtight">
                                                <span class="mord mathnormal mtight">
                                                 i
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                            </span>
                                            <span class="vlist-s">
                                             ​
                                            </span>
                                           </span>
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.143em;">
                                             <span class="">
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                        <span class="mbin mtight">
                                         −
                                        </span>
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          m
                                         </span>
                                         <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.3281em;">
                                             <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                              <span class="pstrut" style="height: 2.5em;">
                                              </span>
                                              <span class="sizing reset-size3 size1 mtight">
                                               <span class="mord mtight">
                                                <span class="mord mathnormal mtight">
                                                 i
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                            </span>
                                            <span class="vlist-s">
                                             ​
                                            </span>
                                           </span>
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.143em;">
                                             <span class="">
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.9629em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mclose nulldelimiter">
                          </span>
                         </span>
                         <span class="mord mathnormal" style="margin-right: 0.2222em;">
                          V
                         </span>
                         <span class="mopen">
                          [
                         </span>
                         <span class="mord mathnormal">
                          i
                         </span>
                         <span class="mpunct">
                          ,
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mrel">
                          :
                         </span>
                         <span class="mclose">
                          ]
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -0.0951em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mrel">
                          =
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="minner">
                          <span class="mopen delimcenter" style="top: 0em;">
                           <span class="delimsizing size4">
                            (
                           </span>
                          </span>
                          <span class="mop op-limits">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.8117em;">
                              <span class="" style="top: -1.8723em; margin-left: 0em;">
                               <span class="pstrut" style="height: 3.05em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                  j
                                 </span>
                                 <span class="mrel mtight">
                                  =
                                 </span>
                                 <span class="mord mtight">
                                  1
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.05em;">
                               <span class="pstrut" style="height: 3.05em;">
                               </span>
                               <span class="">
                                <span class="mop op-symbol large-op">
                                 ∑
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -4.3em; margin-left: 0em;">
                               <span class="pstrut" style="height: 3.05em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  1
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.4138em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mspace" style="margin-right: 0.1667em;">
                          </span>
                          <span class="mord">
                           <span class="mopen nulldelimiter">
                           </span>
                           <span class="mfrac">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 1.4483em;">
                               <span class="" style="top: -2.314em;">
                                <span class="pstrut" style="height: 3em;">
                                </span>
                                <span class="mord">
                                 <span class="mord">
                                  <span class="mord mathnormal">
                                   d
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.7337em;">
                                      <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                                       <span class="pstrut" style="height: 2.7em;">
                                       </span>
                                       <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          i
                                         </span>
                                         <span class="mbin mtight">
                                          −
                                         </span>
                                         <span class="mord mtight">
                                          1
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                      <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                                       <span class="pstrut" style="height: 2.7em;">
                                       </span>
                                       <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mtight">
                                          ′
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3352em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                               <span class="" style="top: -3.23em;">
                                <span class="pstrut" style="height: 3em;">
                                </span>
                                <span class="frac-line" style="border-bottom-width: 0.04em;">
                                </span>
                               </span>
                               <span class="" style="top: -3.677em;">
                                <span class="pstrut" style="height: 3em;">
                                </span>
                                <span class="mord">
                                 <span class="mord">
                                  <span class="mord mathnormal">
                                   e
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.7713em;">
                                      <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                       <span class="pstrut" style="height: 2.7em;">
                                       </span>
                                       <span class="sizing reset-size6 size3 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                           x
                                          </span>
                                          <span class="msupsub">
                                           <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.3281em;">
                                              <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                               <span class="pstrut" style="height: 2.5em;">
                                               </span>
                                               <span class="sizing reset-size3 size1 mtight">
                                                <span class="mord mtight">
                                                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                                  j
                                                 </span>
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                             <span class="vlist-s">
                                              ​
                                             </span>
                                            </span>
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.2819em;">
                                              <span class="">
                                              </span>
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                         <span class="mbin mtight">
                                          −
                                         </span>
                                         <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                           m
                                          </span>
                                          <span class="msupsub">
                                           <span class="vlist-t vlist-t2">
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.3281em;">
                                              <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                               <span class="pstrut" style="height: 2.5em;">
                                               </span>
                                               <span class="sizing reset-size3 size1 mtight">
                                                <span class="mord mtight">
                                                 <span class="mord mathnormal mtight">
                                                  i
                                                 </span>
                                                 <span class="mbin mtight">
                                                  −
                                                 </span>
                                                 <span class="mord mtight">
                                                  1
                                                 </span>
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                             <span class="vlist-s">
                                              ​
                                             </span>
                                            </span>
                                            <span class="vlist-r">
                                             <span class="vlist" style="height: 0.2025em;">
                                              <span class="">
                                              </span>
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 1.0212em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                           <span class="mclose nulldelimiter">
                           </span>
                          </span>
                          <span class="mord mathnormal" style="margin-right: 0.2222em;">
                           V
                          </span>
                          <span class="mopen">
                           [
                          </span>
                          <span class="mord mathnormal" style="margin-right: 0.0572em;">
                           j
                          </span>
                          <span class="mpunct">
                           ,
                          </span>
                          <span class="mspace" style="margin-right: 0.2778em;">
                          </span>
                          <span class="mrel">
                           :
                          </span>
                          <span class="mclose">
                           ]
                          </span>
                          <span class="mclose delimcenter" style="top: 0em;">
                           <span class="delimsizing size4">
                            )
                           </span>
                          </span>
                         </span>
                         <span class="mspace" style="margin-right: 0.1667em;">
                         </span>
                         <span class="mord">
                          <span class="mopen nulldelimiter">
                          </span>
                          <span class="mfrac">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.4589em;">
                              <span class="" style="top: -2.314em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="mord">
                                <span class="mord">
                                 <span class="mord mathnormal">
                                  d
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.7337em;">
                                     <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mtight">
                                         ′
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.2769em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.23em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="frac-line" style="border-bottom-width: 0.04em;">
                               </span>
                              </span>
                              <span class="" style="top: -3.707em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="mord">
                                <span class="mord">
                                 <span class="mord mathnormal">
                                  d
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.7519em;">
                                     <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                        <span class="mbin mtight">
                                         −
                                        </span>
                                        <span class="mord mtight">
                                         1
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mtight">
                                         ′
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.317em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.9629em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mclose nulldelimiter">
                          </span>
                         </span>
                         <span class="mord">
                          <span class="mord mathnormal">
                           e
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.8213em;">
                              <span class="" style="top: -3.113em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   m
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          i
                                         </span>
                                         <span class="mbin mtight">
                                          −
                                         </span>
                                         <span class="mord mtight">
                                          1
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.2025em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   m
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          i
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.143em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                         <span class="mspace" style="margin-right: 0.2222em;">
                         </span>
                         <span class="mbin">
                          +
                         </span>
                         <span class="mspace" style="margin-right: 0.2222em;">
                         </span>
                         <span class="mord">
                          <span class="mopen nulldelimiter">
                          </span>
                          <span class="mfrac">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.4483em;">
                              <span class="" style="top: -2.314em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="mord">
                                <span class="mord">
                                 <span class="mord mathnormal">
                                  d
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.7337em;">
                                     <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mtight">
                                         ′
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.2769em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.23em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="frac-line" style="border-bottom-width: 0.04em;">
                               </span>
                              </span>
                              <span class="" style="top: -3.677em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="mord">
                                <span class="mord">
                                 <span class="mord mathnormal">
                                  e
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.7713em;">
                                     <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          x
                                         </span>
                                         <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.3281em;">
                                             <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                              <span class="pstrut" style="height: 2.5em;">
                                              </span>
                                              <span class="sizing reset-size3 size1 mtight">
                                               <span class="mord mtight">
                                                <span class="mord mathnormal mtight">
                                                 i
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                            </span>
                                            <span class="vlist-s">
                                             ​
                                            </span>
                                           </span>
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.143em;">
                                             <span class="">
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                        <span class="mbin mtight">
                                         −
                                        </span>
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          m
                                         </span>
                                         <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.3281em;">
                                             <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                              <span class="pstrut" style="height: 2.5em;">
                                              </span>
                                              <span class="sizing reset-size3 size1 mtight">
                                               <span class="mord mtight">
                                                <span class="mord mathnormal mtight">
                                                 i
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                            </span>
                                            <span class="vlist-s">
                                             ​
                                            </span>
                                           </span>
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.143em;">
                                             <span class="">
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.9629em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mclose nulldelimiter">
                          </span>
                         </span>
                         <span class="mord mathnormal" style="margin-right: 0.2222em;">
                          V
                         </span>
                         <span class="mopen">
                          [
                         </span>
                         <span class="mord mathnormal">
                          i
                         </span>
                         <span class="mpunct">
                          ,
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mrel">
                          :
                         </span>
                         <span class="mclose">
                          ]
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: 3.097em;">
                        <span class="pstrut" style="height: 3.8117em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mrel">
                          =
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mord">
                          <span class="mord">
                           <span class="mord">
                            <span class="mord boldsymbol">
                             o
                            </span>
                           </span>
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.8019em;">
                              <span class="" style="top: -2.453em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  1
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.113em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  ′
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.3053em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                         <span class="mord">
                          <span class="mopen nulldelimiter">
                          </span>
                          <span class="mfrac">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.4783em;">
                              <span class="" style="top: -2.314em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="mord">
                                <span class="mord">
                                 <span class="mord mathnormal">
                                  d
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.7337em;">
                                     <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mtight">
                                         ′
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.2769em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.23em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="frac-line" style="border-bottom-width: 0.04em;">
                               </span>
                              </span>
                              <span class="" style="top: -3.707em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="mord">
                                <span class="mord">
                                 <span class="mord mathnormal">
                                  d
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.7519em;">
                                     <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                        <span class="mbin mtight">
                                         −
                                        </span>
                                        <span class="mord mtight">
                                         1
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mtight">
                                         ′
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.317em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                                <span class="mord">
                                 <span class="mord mathnormal">
                                  e
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.7713em;">
                                     <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          m
                                         </span>
                                         <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.3281em;">
                                             <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                              <span class="pstrut" style="height: 2.5em;">
                                              </span>
                                              <span class="sizing reset-size3 size1 mtight">
                                               <span class="mord mtight">
                                                <span class="mord mathnormal mtight">
                                                 i
                                                </span>
                                                <span class="mbin mtight">
                                                 −
                                                </span>
                                                <span class="mord mtight">
                                                 1
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                            </span>
                                            <span class="vlist-s">
                                             ​
                                            </span>
                                           </span>
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.2025em;">
                                             <span class="">
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                        <span class="mbin mtight">
                                         −
                                        </span>
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          m
                                         </span>
                                         <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.3281em;">
                                             <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                              <span class="pstrut" style="height: 2.5em;">
                                              </span>
                                              <span class="sizing reset-size3 size1 mtight">
                                               <span class="mord mtight">
                                                <span class="mord mathnormal mtight">
                                                 i
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                            </span>
                                            <span class="vlist-s">
                                             ​
                                            </span>
                                           </span>
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.143em;">
                                             <span class="">
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.9629em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mclose nulldelimiter">
                          </span>
                         </span>
                         <span class="mspace" style="margin-right: 0.2222em;">
                         </span>
                         <span class="mbin">
                          +
                         </span>
                         <span class="mspace" style="margin-right: 0.2222em;">
                         </span>
                         <span class="mord">
                          <span class="mopen nulldelimiter">
                          </span>
                          <span class="mfrac">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 1.4483em;">
                              <span class="" style="top: -2.314em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="mord">
                                <span class="mord">
                                 <span class="mord mathnormal">
                                  d
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t vlist-t2">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.7337em;">
                                     <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mathnormal mtight">
                                         i
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mtight">
                                         ′
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                    <span class="vlist-s">
                                     ​
                                    </span>
                                   </span>
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.2769em;">
                                     <span class="">
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.23em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="frac-line" style="border-bottom-width: 0.04em;">
                               </span>
                              </span>
                              <span class="" style="top: -3.677em;">
                               <span class="pstrut" style="height: 3em;">
                               </span>
                               <span class="mord">
                                <span class="mord">
                                 <span class="mord mathnormal">
                                  e
                                 </span>
                                 <span class="msupsub">
                                  <span class="vlist-t">
                                   <span class="vlist-r">
                                    <span class="vlist" style="height: 0.7713em;">
                                     <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                      <span class="pstrut" style="height: 2.7em;">
                                      </span>
                                      <span class="sizing reset-size6 size3 mtight">
                                       <span class="mord mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          x
                                         </span>
                                         <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.3281em;">
                                             <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                              <span class="pstrut" style="height: 2.5em;">
                                              </span>
                                              <span class="sizing reset-size3 size1 mtight">
                                               <span class="mord mtight">
                                                <span class="mord mathnormal mtight">
                                                 i
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                            </span>
                                            <span class="vlist-s">
                                             ​
                                            </span>
                                           </span>
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.143em;">
                                             <span class="">
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                        <span class="mbin mtight">
                                         −
                                        </span>
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          m
                                         </span>
                                         <span class="msupsub">
                                          <span class="vlist-t vlist-t2">
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.3281em;">
                                             <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                              <span class="pstrut" style="height: 2.5em;">
                                              </span>
                                              <span class="sizing reset-size3 size1 mtight">
                                               <span class="mord mtight">
                                                <span class="mord mathnormal mtight">
                                                 i
                                                </span>
                                               </span>
                                              </span>
                                             </span>
                                            </span>
                                            <span class="vlist-s">
                                             ​
                                            </span>
                                           </span>
                                           <span class="vlist-r">
                                            <span class="vlist" style="height: 0.143em;">
                                             <span class="">
                                             </span>
                                            </span>
                                           </span>
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.9629em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mclose nulldelimiter">
                          </span>
                         </span>
                         <span class="mord mathnormal" style="margin-right: 0.2222em;">
                          V
                         </span>
                         <span class="mopen">
                          [
                         </span>
                         <span class="mord mathnormal">
                          i
                         </span>
                         <span class="mpunct">
                          ,
                         </span>
                         <span class="mspace" style="margin-right: 0.2778em;">
                         </span>
                         <span class="mrel">
                          :
                         </span>
                         <span class="mclose">
                          ]
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 8.1715em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 8.1715em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="tag">
          <span class="vlist-t vlist-t2">
           <span class="vlist-r">
            <span class="vlist" style="height: 8.6715em;">
             <span class="" style="top: -10.6715em;">
              <span class="pstrut" style="height: 10.6715em;">
              </span>
              <span class="eqn-num">
              </span>
             </span>
            </span>
            <span class="vlist-s">
             ​
            </span>
           </span>
           <span class="vlist-r">
            <span class="vlist" style="height: 8.1715em;">
             <span class="">
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     它仅依赖于
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        d 
         
        
          i 
         
        
          ′ 
         
        
       
         , 
        
       
           
        
        
        
          d 
         
         
         
           i 
          
         
           − 
          
         
           1 
          
         
        
          ′ 
         
        
       
         , 
        
       
           
        
        
        
          m 
         
        
          i 
         
        
       
         , 
        
       
           
        
        
        
          m 
         
         
         
           i 
          
         
           − 
          
         
           1 
          
         
        
       
         , 
        
       
           
        
        
        
          x 
         
        
          i 
         
        
       
      
        d^{\prime}_i,\ d^{\prime}_{i-1}, \ m_i, \ m_{i-1}, \ x_i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0689em; vertical-align: -0.317em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           d
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2587em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace">
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           d
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                 <span class="mbin mtight">
                  −
                 </span>
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.317em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace">
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           m
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace">
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           m
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                 <span class="mbin mtight">
                  −
                 </span>
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2083em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace">
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           x
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，因此我们可以在单个循环中融合 Self-Attention 中的所有计算
    </p>
    <p>
     <strong>
      Algorithm FlashAttention
     </strong>
    </p>
    <p>
     <strong>
      for
     </strong>
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        i 
        
       
         ← 
        
       
         1 
        
       
         , 
        
       
         N 
        
       
      
        i \leftarrow 1,N
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6595em;">
         </span>
         <span class="mord mathnormal">
          i
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ←
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          1
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.109em;">
          N
         </span>
        </span>
       </span>
      </span>
     </span>
     <strong>
      do
     </strong>
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         x 
             
            
              i 
             
            
           
          
          
           
            
             
            
              ← 
             
             
             
               Q 
              
             
               [ 
              
             
               k 
              
             
               , 
              
             
               : 
              
             
               ] 
              
             
             
              
              
                K 
               
              
                T 
               
              
             
               [ 
              
             
               : 
              
             
               , 
              
             
               i 
              
             
               ] 
              
             
            
           
          
         
         
          
           
            
            
              m 
             
            
              i 
             
            
           
          
          
           
            
             
            
              ← 
             
            
              max 
             
            
              ⁡ 
             
             
             
               ( 
              
              
               
               
                 m 
                
                
                
                  i 
                 
                
                  − 
                 
                
                  1 
                 
                
               
              
                , 
               
               
               
                 x 
                
               
                 i 
                
               
              
             
               ) 
              
             
            
           
          
         
         
          
           
            
            
              d 
             
            
              i 
             
            
              ′ 
             
            
           
          
          
           
            
             
            
              ← 
             
             
              
              
                d 
               
               
               
                 i 
                
               
                 − 
                
               
                 1 
                
               
              
                ′ 
               
              
              
              
                e 
               
               
                
                
                  m 
                 
                 
                 
                   i 
                  
                 
                   − 
                  
                 
                   1 
                  
                 
                
               
                 − 
                
                
                
                  m 
                 
                
                  i 
                 
                
               
              
             
            
              + 
             
             
             
               e 
              
              
               
               
                 x 
                
               
                 i 
                
               
              
                − 
               
               
               
                 m 
                
               
                 i 
                
               
              
             
            
           
          
         
         
          
           
            
            
              o 
             
            
              i 
             
            
              ′ 
             
            
           
          
          
           
            
             
            
              ← 
             
             
             
               o 
              
              
              
                i 
               
              
                − 
               
              
                1 
               
              
             
               ′ 
              
             
             
              
               
               
                 d 
                
                
                
                  i 
                 
                
                  − 
                 
                
                  1 
                 
                
               
                 ′ 
                
               
               
               
                 e 
                
                
                 
                 
                   m 
                  
                  
                  
                    i 
                   
                  
                    − 
                   
                  
                    1 
                   
                  
                 
                
                  − 
                 
                 
                 
                   m 
                  
                 
                   i 
                  
                 
                
               
              
              
              
                d 
               
              
                i 
               
              
                ′ 
               
              
             
            
              + 
             
             
              
              
                e 
               
               
                
                
                  x 
                 
                
                  i 
                 
                
               
                 − 
                
                
                
                  m 
                 
                
                  i 
                 
                
               
              
              
              
                d 
               
              
                i 
               
              
                ′ 
               
              
             
             
             
               V 
              
             
               [ 
              
             
               i 
              
             
               , 
              
             
               : 
              
             
               ] 
              
             
            
           
          
         
        
       
         \begin{aligned} {x_{i}} &amp; \leftarrow {Q[k,:]} {K^{T}[:,i]}\\ {m_{i}} &amp; \leftarrow \max\left( {m_{i-1},x_{i}} \right)\\ {d^{\prime}_{i}} &amp; \leftarrow {d^{\prime}_{i-1}e^{m_{i-1}-m_{i}}}+ {e^{x_{i}-m_{i}}}\\ {o^{\prime}_{i}} &amp; \leftarrow {o^{\prime}_{i-1}}\frac{ {d^{\prime}_{i-1}e^{m_{i-1}-m_{i}}}}{ { d^{\prime}_{i}}}+\frac{ {e^{x_{i}-m_{i}}}}{ {d^{\prime}_{i}}} {V[i,:]}\end{aligned}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 7.2925em; vertical-align: -3.3963em;">
          </span>
          <span class="mord">
           <span class="mtable">
            <span class="col-align-r">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 3.8963em;">
                <span class="" style="top: -6.4833em;">
                 <span class="pstrut" style="height: 3.4783em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord">
                    <span class="mord mathnormal">
                     x
                    </span>
                    <span class="msupsub">
                     <span class="vlist-t vlist-t2">
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.3117em;">
                        <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            i
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="vlist-s">
                        ​
                       </span>
                      </span>
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.15em;">
                        <span class="">
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -4.9833em;">
                 <span class="pstrut" style="height: 3.4783em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord">
                    <span class="mord mathnormal">
                     m
                    </span>
                    <span class="msupsub">
                     <span class="vlist-t vlist-t2">
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.3117em;">
                        <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            i
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="vlist-s">
                        ​
                       </span>
                      </span>
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.15em;">
                        <span class="">
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.4833em;">
                 <span class="pstrut" style="height: 3.4783em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord">
                    <span class="mord mathnormal">
                     d
                    </span>
                    <span class="msupsub">
                     <span class="vlist-t vlist-t2">
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.8019em;">
                        <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            i
                           </span>
                          </span>
                         </span>
                        </span>
                        <span class="" style="top: -3.113em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mtight">
                           <span class="mord mtight">
                            ′
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="vlist-s">
                        ​
                       </span>
                      </span>
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.247em;">
                        <span class="">
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -1.3449em;">
                 <span class="pstrut" style="height: 3.4783em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord">
                    <span class="mord mathnormal">
                     o
                    </span>
                    <span class="msupsub">
                     <span class="vlist-t vlist-t2">
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.8019em;">
                        <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            i
                           </span>
                          </span>
                         </span>
                        </span>
                        <span class="" style="top: -3.113em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mtight">
                           <span class="mord mtight">
                            ′
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="vlist-s">
                        ​
                       </span>
                      </span>
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.247em;">
                        <span class="">
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 3.3963em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="col-align-l">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 3.8963em;">
                <span class="" style="top: -6.4833em;">
                 <span class="pstrut" style="height: 3.4783em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   ←
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    Q
                   </span>
                   <span class="mopen">
                    [
                   </span>
                   <span class="mord mathnormal" style="margin-right: 0.0315em;">
                    k
                   </span>
                   <span class="mpunct">
                    ,
                   </span>
                   <span class="mspace" style="margin-right: 0.2778em;">
                   </span>
                   <span class="mrel">
                    :
                   </span>
                   <span class="mclose">
                    ]
                   </span>
                  </span>
                  <span class="mord">
                   <span class="mord">
                    <span class="mord mathnormal" style="margin-right: 0.0715em;">
                     K
                    </span>
                    <span class="msupsub">
                     <span class="vlist-t">
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.8913em;">
                        <span class="" style="top: -3.113em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                            T
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                   <span class="mopen">
                    [
                   </span>
                   <span class="mrel">
                    :
                   </span>
                   <span class="mpunct">
                    ,
                   </span>
                   <span class="mspace" style="margin-right: 0.1667em;">
                   </span>
                   <span class="mord mathnormal">
                    i
                   </span>
                   <span class="mclose">
                    ]
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -4.9833em;">
                 <span class="pstrut" style="height: 3.4783em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   ←
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mop">
                   max
                  </span>
                  <span class="mspace" style="margin-right: 0.1667em;">
                  </span>
                  <span class="minner">
                   <span class="mopen delimcenter" style="top: 0em;">
                    (
                   </span>
                   <span class="mord">
                    <span class="mord">
                     <span class="mord mathnormal">
                      m
                     </span>
                     <span class="msupsub">
                      <span class="vlist-t vlist-t2">
                       <span class="vlist-r">
                        <span class="vlist" style="height: 0.3117em;">
                         <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                          <span class="pstrut" style="height: 2.7em;">
                          </span>
                          <span class="sizing reset-size6 size3 mtight">
                           <span class="mord mtight">
                            <span class="mord mathnormal mtight">
                             i
                            </span>
                            <span class="mbin mtight">
                             −
                            </span>
                            <span class="mord mtight">
                             1
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                        <span class="vlist-s">
                         ​
                        </span>
                       </span>
                       <span class="vlist-r">
                        <span class="vlist" style="height: 0.2083em;">
                         <span class="">
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                    <span class="mpunct">
                     ,
                    </span>
                    <span class="mspace" style="margin-right: 0.1667em;">
                    </span>
                    <span class="mord">
                     <span class="mord mathnormal">
                      x
                     </span>
                     <span class="msupsub">
                      <span class="vlist-t vlist-t2">
                       <span class="vlist-r">
                        <span class="vlist" style="height: 0.3117em;">
                         <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                          <span class="pstrut" style="height: 2.7em;">
                          </span>
                          <span class="sizing reset-size6 size3 mtight">
                           <span class="mord mtight">
                            <span class="mord mathnormal mtight">
                             i
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                        <span class="vlist-s">
                         ​
                        </span>
                       </span>
                       <span class="vlist-r">
                        <span class="vlist" style="height: 0.15em;">
                         <span class="">
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                   <span class="mclose delimcenter" style="top: 0em;">
                    )
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -3.4833em;">
                 <span class="pstrut" style="height: 3.4783em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   ←
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord">
                   <span class="mord">
                    <span class="mord mathnormal">
                     d
                    </span>
                    <span class="msupsub">
                     <span class="vlist-t vlist-t2">
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.8019em;">
                        <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            i
                           </span>
                           <span class="mbin mtight">
                            −
                           </span>
                           <span class="mord mtight">
                            1
                           </span>
                          </span>
                         </span>
                        </span>
                        <span class="" style="top: -3.113em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mtight">
                           <span class="mord mtight">
                            ′
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="vlist-s">
                        ​
                       </span>
                      </span>
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.3053em;">
                        <span class="">
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                   <span class="mord">
                    <span class="mord mathnormal">
                     e
                    </span>
                    <span class="msupsub">
                     <span class="vlist-t">
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.8213em;">
                        <span class="" style="top: -3.113em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mtight">
                           <span class="mord mtight">
                            <span class="mord mathnormal mtight">
                             m
                            </span>
                            <span class="msupsub">
                             <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                               <span class="vlist" style="height: 0.3281em;">
                                <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                 <span class="pstrut" style="height: 2.5em;">
                                 </span>
                                 <span class="sizing reset-size3 size1 mtight">
                                  <span class="mord mtight">
                                   <span class="mord mathnormal mtight">
                                    i
                                   </span>
                                   <span class="mbin mtight">
                                    −
                                   </span>
                                   <span class="mord mtight">
                                    1
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                               <span class="vlist-s">
                                ​
                               </span>
                              </span>
                              <span class="vlist-r">
                               <span class="vlist" style="height: 0.2025em;">
                                <span class="">
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                           <span class="mbin mtight">
                            −
                           </span>
                           <span class="mord mtight">
                            <span class="mord mathnormal mtight">
                             m
                            </span>
                            <span class="msupsub">
                             <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                               <span class="vlist" style="height: 0.3281em;">
                                <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                 <span class="pstrut" style="height: 2.5em;">
                                 </span>
                                 <span class="sizing reset-size3 size1 mtight">
                                  <span class="mord mtight">
                                   <span class="mord mathnormal mtight">
                                    i
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                               <span class="vlist-s">
                                ​
                               </span>
                              </span>
                              <span class="vlist-r">
                               <span class="vlist" style="height: 0.143em;">
                                <span class="">
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mbin">
                   +
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mord">
                   <span class="mord">
                    <span class="mord mathnormal">
                     e
                    </span>
                    <span class="msupsub">
                     <span class="vlist-t">
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.8213em;">
                        <span class="" style="top: -3.113em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mtight">
                           <span class="mord mtight">
                            <span class="mord mathnormal mtight">
                             x
                            </span>
                            <span class="msupsub">
                             <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                               <span class="vlist" style="height: 0.3281em;">
                                <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                 <span class="pstrut" style="height: 2.5em;">
                                 </span>
                                 <span class="sizing reset-size3 size1 mtight">
                                  <span class="mord mtight">
                                   <span class="mord mathnormal mtight">
                                    i
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                               <span class="vlist-s">
                                ​
                               </span>
                              </span>
                              <span class="vlist-r">
                               <span class="vlist" style="height: 0.143em;">
                                <span class="">
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                           <span class="mbin mtight">
                            −
                           </span>
                           <span class="mord mtight">
                            <span class="mord mathnormal mtight">
                             m
                            </span>
                            <span class="msupsub">
                             <span class="vlist-t vlist-t2">
                              <span class="vlist-r">
                               <span class="vlist" style="height: 0.3281em;">
                                <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                 <span class="pstrut" style="height: 2.5em;">
                                 </span>
                                 <span class="sizing reset-size3 size1 mtight">
                                  <span class="mord mtight">
                                   <span class="mord mathnormal mtight">
                                    i
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                               <span class="vlist-s">
                                ​
                               </span>
                              </span>
                              <span class="vlist-r">
                               <span class="vlist" style="height: 0.143em;">
                                <span class="">
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -1.3449em;">
                 <span class="pstrut" style="height: 3.4783em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   ←
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord">
                   <span class="mord">
                    <span class="mord mathnormal">
                     o
                    </span>
                    <span class="msupsub">
                     <span class="vlist-t vlist-t2">
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.8019em;">
                        <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            i
                           </span>
                           <span class="mbin mtight">
                            −
                           </span>
                           <span class="mord mtight">
                            1
                           </span>
                          </span>
                         </span>
                        </span>
                        <span class="" style="top: -3.113em; margin-right: 0.05em;">
                         <span class="pstrut" style="height: 2.7em;">
                         </span>
                         <span class="sizing reset-size6 size3 mtight">
                          <span class="mord mtight">
                           <span class="mord mtight">
                            ′
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="vlist-s">
                        ​
                       </span>
                      </span>
                      <span class="vlist-r">
                       <span class="vlist" style="height: 0.3053em;">
                        <span class="">
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mord">
                   <span class="mopen nulldelimiter">
                   </span>
                   <span class="mfrac">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 1.4783em;">
                       <span class="" style="top: -2.314em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                          <span class="mord">
                           <span class="mord mathnormal">
                            d
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.7337em;">
                               <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                                <span class="pstrut" style="height: 2.7em;">
                                </span>
                                <span class="sizing reset-size6 size3 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   i
                                  </span>
                                 </span>
                                </span>
                               </span>
                               <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                                <span class="pstrut" style="height: 2.7em;">
                                </span>
                                <span class="sizing reset-size6 size3 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mtight">
                                   ′
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.2769em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.23em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="frac-line" style="border-bottom-width: 0.04em;">
                        </span>
                       </span>
                       <span class="" style="top: -3.707em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                          <span class="mord">
                           <span class="mord mathnormal">
                            d
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.7519em;">
                               <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
                                <span class="pstrut" style="height: 2.7em;">
                                </span>
                                <span class="sizing reset-size6 size3 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   i
                                  </span>
                                  <span class="mbin mtight">
                                   −
                                  </span>
                                  <span class="mord mtight">
                                   1
                                  </span>
                                 </span>
                                </span>
                               </span>
                               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                <span class="pstrut" style="height: 2.7em;">
                                </span>
                                <span class="sizing reset-size6 size3 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mtight">
                                   ′
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.317em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mord">
                           <span class="mord mathnormal">
                            e
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.7713em;">
                               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                <span class="pstrut" style="height: 2.7em;">
                                </span>
                                <span class="sizing reset-size6 size3 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mtight">
                                   <span class="mord mathnormal mtight">
                                    m
                                   </span>
                                   <span class="msupsub">
                                    <span class="vlist-t vlist-t2">
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.3281em;">
                                       <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                        <span class="pstrut" style="height: 2.5em;">
                                        </span>
                                        <span class="sizing reset-size3 size1 mtight">
                                         <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                           i
                                          </span>
                                          <span class="mbin mtight">
                                           −
                                          </span>
                                          <span class="mord mtight">
                                           1
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                      <span class="vlist-s">
                                       ​
                                      </span>
                                     </span>
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.2025em;">
                                       <span class="">
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                  <span class="mbin mtight">
                                   −
                                  </span>
                                  <span class="mord mtight">
                                   <span class="mord mathnormal mtight">
                                    m
                                   </span>
                                   <span class="msupsub">
                                    <span class="vlist-t vlist-t2">
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.3281em;">
                                       <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                        <span class="pstrut" style="height: 2.5em;">
                                        </span>
                                        <span class="sizing reset-size3 size1 mtight">
                                         <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                           i
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                      <span class="vlist-s">
                                       ​
                                      </span>
                                     </span>
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.143em;">
                                       <span class="">
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.9629em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                   <span class="mclose nulldelimiter">
                   </span>
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mbin">
                   +
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mord">
                   <span class="mopen nulldelimiter">
                   </span>
                   <span class="mfrac">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 1.4483em;">
                       <span class="" style="top: -2.314em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                          <span class="mord">
                           <span class="mord mathnormal">
                            d
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.7337em;">
                               <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                                <span class="pstrut" style="height: 2.7em;">
                                </span>
                                <span class="sizing reset-size6 size3 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   i
                                  </span>
                                 </span>
                                </span>
                               </span>
                               <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                                <span class="pstrut" style="height: 2.7em;">
                                </span>
                                <span class="sizing reset-size6 size3 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mtight">
                                   ′
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.2769em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.23em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="frac-line" style="border-bottom-width: 0.04em;">
                        </span>
                       </span>
                       <span class="" style="top: -3.677em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                          <span class="mord">
                           <span class="mord mathnormal">
                            e
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.7713em;">
                               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                                <span class="pstrut" style="height: 2.7em;">
                                </span>
                                <span class="sizing reset-size6 size3 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mtight">
                                   <span class="mord mathnormal mtight">
                                    x
                                   </span>
                                   <span class="msupsub">
                                    <span class="vlist-t vlist-t2">
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.3281em;">
                                       <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                        <span class="pstrut" style="height: 2.5em;">
                                        </span>
                                        <span class="sizing reset-size3 size1 mtight">
                                         <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                           i
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                      <span class="vlist-s">
                                       ​
                                      </span>
                                     </span>
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.143em;">
                                       <span class="">
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                  <span class="mbin mtight">
                                   −
                                  </span>
                                  <span class="mord mtight">
                                   <span class="mord mathnormal mtight">
                                    m
                                   </span>
                                   <span class="msupsub">
                                    <span class="vlist-t vlist-t2">
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.3281em;">
                                       <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                        <span class="pstrut" style="height: 2.5em;">
                                        </span>
                                        <span class="sizing reset-size3 size1 mtight">
                                         <span class="mord mtight">
                                          <span class="mord mathnormal mtight">
                                           i
                                          </span>
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                      <span class="vlist-s">
                                       ​
                                      </span>
                                     </span>
                                     <span class="vlist-r">
                                      <span class="vlist" style="height: 0.143em;">
                                       <span class="">
                                       </span>
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.9629em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                   <span class="mclose nulldelimiter">
                   </span>
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal" style="margin-right: 0.2222em;">
                    V
                   </span>
                   <span class="mopen">
                    [
                   </span>
                   <span class="mord mathnormal">
                    i
                   </span>
                   <span class="mpunct">
                    ,
                   </span>
                   <span class="mspace" style="margin-right: 0.2778em;">
                   </span>
                   <span class="mrel">
                    :
                   </span>
                   <span class="mclose">
                    ]
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 3.3963em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     <strong>
      end
     </strong>
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         O 
         
        
          [ 
         
        
          k 
         
        
          , 
         
        
          : 
         
        
          ] 
         
        
          ← 
         
         
         
           o 
          
         
           N 
          
         
           ′ 
          
         
        
       
         O[k,:] \leftarrow \bm{o}^{\prime}_N
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           O
          </span>
          <span class="mopen">
           [
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0315em;">
           k
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           :
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mclose">
           ]
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           ←
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1.0489em; vertical-align: -0.247em;">
          </span>
          <span class="mord">
           <span class="mord">
            <span class="mord">
             <span class="mord boldsymbol">
              o
             </span>
            </span>
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8019em;">
               <span class="" style="top: -2.453em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                  N
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   ′
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.247em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     状态量
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        x 
         
        
          i 
         
        
       
         , 
        
       
           
        
        
        
          m 
         
        
          i 
         
        
       
         , 
        
       
           
        
        
        
          d 
         
        
          i 
         
        
          ′ 
         
        
       
         , 
        
        
        
          o 
         
        
          i 
         
        
          ′ 
         
        
       
      
        x_i, \ m_i, \ d^{\prime}_i, \bm{o}^{\prime}_i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           x
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace">
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           m
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3117em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace">
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           d
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2587em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord">
          <span class="mord">
           <span class="mord">
            <span class="mord boldsymbol">
             o
            </span>
           </span>
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.7519em;">
              <span class="" style="top: -2.4413em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight">
                 i
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ′
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2587em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     占用的内存都很小，可以非常轻松的放入 GPU 的 shared memory 中。另外由于此算法中的所有操作都是关联的，因此它与 tiling 兼容，如果我们逐个 tiling 计算，则该算法可以表示为：
    </p>
    <p>
     <strong>
      Algorithm FlashAttention（Tiling）
     </strong>
    </p>
    <p>
     NEW NOTATIONS
    </p>
    <ul>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         b 
         
        
       
         b
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6944em;">
          </span>
          <span class="mord mathnormal">
           b
          </span>
         </span>
        </span>
       </span>
      </span>
      ：tile 的 block size 大小
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         #tiles 
         
        
       
         \text{\#tiles}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;">
          </span>
          <span class="mord text">
           <span class="mord">
            #tiles
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ：每行 tile 的数量，
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         N 
         
        
          = 
         
        
          b 
         
        
          × 
         
        
          #tiles 
         
        
       
         N= b \times \text{\#tiles}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.109em;">
           N
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.7778em; vertical-align: -0.0833em;">
          </span>
          <span class="mord mathnormal">
           b
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ×
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;">
          </span>
          <span class="mord text">
           <span class="mord">
            #tiles
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         x 
          
         
           i 
          
         
        
       
         \bm{x}_i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5944em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord">
            <span class="mord">
             <span class="mord boldsymbol">
              x
             </span>
            </span>
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ：存储第
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         i 
         
        
       
         i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6595em;">
          </span>
          <span class="mord mathnormal">
           i
          </span>
         </span>
        </span>
       </span>
      </span>
      个 tile 的
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         Q 
         
        
          [ 
         
        
          k 
         
        
          ] 
         
         
         
           K 
          
         
           T 
          
         
        
       
         Q[k]K^T
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.0913em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           Q
          </span>
          <span class="mopen">
           [
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0315em;">
           k
          </span>
          <span class="mclose">
           ]
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0715em;">
            K
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8413em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                  T
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      值的向量
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         [ 
         
        
          ( 
         
        
          i 
         
        
          − 
         
        
          1 
         
        
          ) 
         
        
          b 
         
        
          : 
         
        
          i 
         
        
          b 
         
        
          ] 
         
        
       
         [(i-1)b:ib]
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mopen">
           [(
          </span>
          <span class="mord mathnormal">
           i
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           −
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord">
           1
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mord mathnormal">
           b
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           :
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           ib
          </span>
          <span class="mclose">
           ]
          </span>
         </span>
        </span>
       </span>
      </span>
     </li>
     <li>
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         m 
          
         
           i 
          
          
          
            ( 
           
          
            l 
           
          
            o 
           
          
            c 
           
          
            a 
           
          
            l 
           
          
            ) 
           
          
         
        
       
         m_i^{\mathrm{(local)}}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.3217em; vertical-align: -0.2769em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            m
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.0448em;">
               <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.2198em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   <span class="mopen mtight">
                    (
                   </span>
                   <span class="mord mathrm mtight">
                    local
                   </span>
                   <span class="mclose mtight">
                    )
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2769em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ：
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         x 
          
         
           i 
          
         
        
       
         \bm{x}_i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5944em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord">
            <span class="mord">
             <span class="mord boldsymbol">
              x
             </span>
            </span>
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      内部的局部最大值
     </li>
    </ul>
    <p>
     BODY
    </p>
    <p>
     <strong>
      for
     </strong>
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        i 
        
       
         ← 
        
       
         1 
        
       
         , 
        
       
         #tile 
        
       
      
        i \leftarrow 1,\text{\#tile}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6595em;">
         </span>
         <span class="mord mathnormal">
          i
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
         <span class="mrel">
          ←
         </span>
         <span class="mspace" style="margin-right: 0.2778em;">
         </span>
        </span>
        <span class="base">
         <span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;">
         </span>
         <span class="mord">
          1
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord text">
          <span class="mord">
           #tile
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <strong>
      do
     </strong>
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         x 
             
            
              i 
             
            
           
          
          
           
            
             
            
                
             
            
              ← 
             
            
                
             
            
              Q 
             
            
              [ 
             
            
              k 
             
            
              , 
             
            
              : 
             
            
              ] 
             
             
             
               K 
              
             
               T 
              
             
            
              [ 
             
            
              : 
             
            
              , 
             
            
              ( 
             
            
              i 
             
            
              − 
             
            
              1 
             
            
              ) 
             
            
              b 
             
            
              : 
             
            
              i 
             
            
              b 
             
            
              ] 
             
            
           
          
         
         
          
           
            
            
              m 
             
            
              i 
             
            
              (local) 
             
            
           
          
          
           
            
             
            
                
             
            
              = 
             
            
                
             
             
              
              
                max 
               
              
                ⁡ 
               
              
              
              
                j 
               
              
                = 
               
              
                1 
               
              
             
               b 
              
             
            
              ( 
             
             
             
               x 
              
             
               i 
              
             
            
              [ 
             
            
              j 
             
            
              ] 
             
            
              ) 
             
            
           
          
         
         
          
           
            
            
              m 
             
            
              i 
             
            
           
          
          
           
            
             
            
                
             
            
              ← 
             
            
                
             
            
              max 
             
            
              ⁡ 
             
            
              ( 
             
             
             
               m 
              
              
              
                i 
               
              
                − 
               
              
                1 
               
              
             
            
              , 
             
             
             
               m 
              
             
               i 
              
             
               (local) 
              
             
            
              ) 
             
            
           
          
         
         
          
           
            
            
              d 
             
            
              i 
             
            
              ′ 
             
            
           
          
          
           
            
             
            
                
             
            
              ← 
             
            
                
             
             
             
               d 
              
              
              
                i 
               
              
                − 
               
              
                1 
               
              
             
               ′ 
              
             
             
             
               e 
              
              
               
               
                 m 
                
                
                
                  i 
                 
                
                  − 
                 
                
                  1 
                 
                
               
              
                − 
               
               
               
                 m 
                
               
                 i 
                
               
              
             
            
              + 
             
             
             
               ∑ 
              
              
              
                j 
               
              
                = 
               
              
                1 
               
              
             
               b 
              
             
             
             
               e 
              
              
               
               
                 x 
                
               
                 i 
                
               
              
                [ 
               
              
                j 
               
              
                ] 
               
              
                − 
               
               
               
                 m 
                
               
                 i 
                
               
              
             
            
           
          
         
         
          
           
            
            
              o 
             
            
              i 
             
            
              ′ 
             
            
           
          
          
           
            
             
            
                
             
            
              ← 
             
            
                
             
             
             
               o 
              
              
              
                i 
               
              
                − 
               
              
                1 
               
              
             
               ′ 
              
             
             
              
               
               
                 d 
                
                
                
                  i 
                 
                
                  − 
                 
                
                  1 
                 
                
               
                 ′ 
                
               
               
               
                 e 
                
                
                 
                 
                   m 
                  
                  
                  
                    i 
                   
                  
                    − 
                   
                  
                    1 
                   
                  
                 
                
                  − 
                 
                 
                 
                   m 
                  
                 
                   i 
                  
                 
                
               
              
              
              
                d 
               
              
                i 
               
              
                ′ 
               
              
             
            
              + 
             
             
             
               ∑ 
              
              
              
                j 
               
              
                = 
               
              
                1 
               
              
             
               b 
              
             
             
              
              
                e 
               
               
                
                
                  x 
                 
                
                  i 
                 
                
               
                 [ 
                
               
                 j 
                
               
                 ] 
                
               
                 − 
                
                
                
                  m 
                 
                
                  i 
                 
                
               
              
              
              
                d 
               
              
                i 
               
              
                ′ 
               
              
             
            
              V 
             
            
              [ 
             
            
              j 
             
            
              + 
             
            
              ( 
             
            
              i 
             
            
              − 
             
            
              1 
             
            
              ) 
             
            
              b 
             
            
              , 
             
            
              : 
             
            
              ] 
             
            
           
          
         
        
       
         \begin{split}\bm{x}_{i}&amp;\ \leftarrow\ Q[k, : ] K^{T}[:,(i-1) b : i b]\\ m_{i}^{\text{(local)}}&amp;\ =\ \max_{j=1}^{b} (\bm{x}_{i} [j]) \\ m_{i}&amp;\ \leftarrow\ \max\big(m_{i-1},m_{i}^{\text{(local)}} \big)\\ d_{i}^{\prime}&amp;\ \leftarrow\ d_{i-1}^{\prime} e^{m_{i-1}-m_{i}} + \sum_{j=1}^{b} e^{\bm{x}_{i}[j]-m_{i}}\\ \bm{o}_{i}^{\prime}&amp;\ \leftarrow\ \bm{o}_{i-1}^{\prime} \frac{d_{i-1}^{\prime} e^{m_{i-1}-m_{i}}}{d_{i}^{\prime}} + \sum_{j=1}^{b} \frac{e^{\bm{x}_{i}[j]-m_{i}}}{d_{i}^{\prime}}V[j+(i-1) b, : ]\end{split}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 12.7364em; vertical-align: -6.1182em;">
          </span>
          <span class="mord">
           <span class="mtable">
            <span class="col-align-r">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 6.6182em;">
                <span class="" style="top: -9.563em;">
                 <span class="pstrut" style="height: 3.8361em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord">
                    <span class="mord">
                     <span class="mord boldsymbol">
                      x
                     </span>
                    </span>
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -7.6863em;">
                 <span class="pstrut" style="height: 3.8361em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord mathnormal">
                    m
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 1.0448em;">
                       <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.2198em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord text mtight">
                           <span class="mord mtight">
                            (local)
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.2769em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -5.4777em;">
                 <span class="pstrut" style="height: 3.8361em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord mathnormal">
                    m
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -2.9816em;">
                 <span class="pstrut" style="height: 3.8361em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord mathnormal">
                    d
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8019em;">
                       <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           ′
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.247em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: 0.5683em;">
                 <span class="pstrut" style="height: 3.8361em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                   <span class="mord">
                    <span class="mord">
                     <span class="mord boldsymbol">
                      o
                     </span>
                    </span>
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8019em;">
                       <span class="" style="top: -2.453em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           ′
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.247em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 6.1182em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
            <span class="col-align-l">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 6.6182em;">
                <span class="" style="top: -9.563em;">
                 <span class="pstrut" style="height: 3.8361em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   ←
                  </span>
                  <span class="mspace">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord mathnormal">
                   Q
                  </span>
                  <span class="mopen">
                   [
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.0315em;">
                   k
                  </span>
                  <span class="mpunct">
                   ,
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mclose">
                   ]
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal" style="margin-right: 0.0715em;">
                    K
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8913em;">
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                           T
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mopen">
                   [
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mpunct">
                   ,
                  </span>
                  <span class="mspace" style="margin-right: 0.1667em;">
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord mathnormal">
                   i
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mbin">
                   −
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mord">
                   1
                  </span>
                  <span class="mclose">
                   )
                  </span>
                  <span class="mord mathnormal">
                   b
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord mathnormal">
                   ib
                  </span>
                  <span class="mclose">
                   ]
                  </span>
                 </span>
                </span>
                <span class="" style="top: -7.6863em;">
                 <span class="pstrut" style="height: 3.8361em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   =
                  </span>
                  <span class="mspace">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mop op-limits">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 1.2167em;">
                      <span class="" style="top: -2.3723em; margin-left: 0em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                          j
                         </span>
                         <span class="mrel mtight">
                          =
                         </span>
                         <span class="mord mtight">
                          1
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -3em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="">
                        <span class="mop">
                         max
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -3.6306em; margin-left: 0em;">
                       <span class="pstrut" style="height: 3em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight">
                          b
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.8638em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord">
                   <span class="mord">
                    <span class="mord">
                     <span class="mord boldsymbol">
                      x
                     </span>
                    </span>
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.15em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mopen">
                   [
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.0572em;">
                   j
                  </span>
                  <span class="mclose">
                   ])
                  </span>
                 </span>
                </span>
                <span class="" style="top: -5.4777em;">
                 <span class="pstrut" style="height: 3.8361em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   ←
                  </span>
                  <span class="mspace">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mop">
                   max
                  </span>
                  <span class="mspace" style="margin-right: 0.1667em;">
                  </span>
                  <span class="mord">
                   <span class="delimsizing size1">
                    (
                   </span>
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    m
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3117em;">
                       <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                          <span class="mbin mtight">
                           −
                          </span>
                          <span class="mord mtight">
                           1
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.2083em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mpunct">
                   ,
                  </span>
                  <span class="mspace" style="margin-right: 0.1667em;">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    m
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 1.0448em;">
                       <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.2198em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord text mtight">
                           <span class="mord mtight">
                            (local)
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.2769em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mord">
                   <span class="delimsizing size1">
                    )
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: -2.9816em;">
                 <span class="pstrut" style="height: 3.8361em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   ←
                  </span>
                  <span class="mspace">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    d
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8019em;">
                       <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                          <span class="mbin mtight">
                           −
                          </span>
                          <span class="mord mtight">
                           1
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           ′
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3053em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    e
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8213em;">
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            m
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3281em;">
                               <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   i
                                  </span>
                                  <span class="mbin mtight">
                                   −
                                  </span>
                                  <span class="mord mtight">
                                   1
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.2025em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mbin mtight">
                           −
                          </span>
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            m
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3281em;">
                               <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   i
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.143em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mbin">
                   +
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mop op-limits">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 1.8361em;">
                      <span class="" style="top: -1.8723em; margin-left: 0em;">
                       <span class="pstrut" style="height: 3.05em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                          j
                         </span>
                         <span class="mrel mtight">
                          =
                         </span>
                         <span class="mord mtight">
                          1
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -3.05em;">
                       <span class="pstrut" style="height: 3.05em;">
                       </span>
                       <span class="">
                        <span class="mop op-symbol large-op">
                         ∑
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -4.3em; margin-left: 0em;">
                       <span class="pstrut" style="height: 3.05em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight">
                          b
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 1.4138em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mspace" style="margin-right: 0.1667em;">
                  </span>
                  <span class="mord">
                   <span class="mord mathnormal">
                    e
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.938em;">
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           <span class="mord mtight">
                            <span class="mord mtight">
                             <span class="mord boldsymbol mtight">
                              x
                             </span>
                            </span>
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3281em;">
                               <span class="" style="top: -2.357em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   i
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.143em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                          <span class="mopen mtight">
                           [
                          </span>
                          <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                           j
                          </span>
                          <span class="mclose mtight">
                           ]
                          </span>
                          <span class="mbin mtight">
                           −
                          </span>
                          <span class="mord mtight">
                           <span class="mord mathnormal mtight">
                            m
                           </span>
                           <span class="msupsub">
                            <span class="vlist-t vlist-t2">
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.3281em;">
                               <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                <span class="pstrut" style="height: 2.5em;">
                                </span>
                                <span class="sizing reset-size3 size1 mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   i
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="vlist-s">
                               ​
                              </span>
                             </span>
                             <span class="vlist-r">
                              <span class="vlist" style="height: 0.143em;">
                               <span class="">
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
                <span class="" style="top: 0.5683em;">
                 <span class="pstrut" style="height: 3.8361em;">
                 </span>
                 <span class="mord">
                  <span class="mord">
                  </span>
                  <span class="mspace">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   ←
                  </span>
                  <span class="mspace">
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mord">
                   <span class="mord">
                    <span class="mord">
                     <span class="mord boldsymbol">
                      o
                     </span>
                    </span>
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8019em;">
                       <span class="" style="top: -2.453em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mathnormal mtight">
                           i
                          </span>
                          <span class="mbin mtight">
                           −
                          </span>
                          <span class="mord mtight">
                           1
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.113em; margin-right: 0.05em;">
                        <span class="pstrut" style="height: 2.7em;">
                        </span>
                        <span class="sizing reset-size6 size3 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           ′
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3053em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mord">
                   <span class="mopen nulldelimiter">
                   </span>
                   <span class="mfrac">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 1.4783em;">
                       <span class="" style="top: -2.314em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                          <span class="mord mathnormal">
                           d
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.7337em;">
                              <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  ′
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.2769em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.23em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="frac-line" style="border-bottom-width: 0.04em;">
                        </span>
                       </span>
                       <span class="" style="top: -3.707em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                          <span class="mord mathnormal">
                           d
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.7519em;">
                              <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  1
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.063em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  ′
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.317em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                         <span class="mord">
                          <span class="mord mathnormal">
                           e
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.7713em;">
                              <span class="" style="top: -3.063em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   m
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          i
                                         </span>
                                         <span class="mbin mtight">
                                          −
                                         </span>
                                         <span class="mord mtight">
                                          1
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.2025em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   m
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          i
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.143em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.9629em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                   <span class="mclose nulldelimiter">
                   </span>
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mbin">
                   +
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mop op-limits">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 1.8361em;">
                      <span class="" style="top: -1.8723em; margin-left: 0em;">
                       <span class="pstrut" style="height: 3.05em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                          j
                         </span>
                         <span class="mrel mtight">
                          =
                         </span>
                         <span class="mord mtight">
                          1
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -3.05em;">
                       <span class="pstrut" style="height: 3.05em;">
                       </span>
                       <span class="">
                        <span class="mop op-symbol large-op">
                         ∑
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -4.3em; margin-left: 0em;">
                       <span class="pstrut" style="height: 3.05em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         <span class="mord mathnormal mtight">
                          b
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 1.4138em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mspace" style="margin-right: 0.1667em;">
                  </span>
                  <span class="mord">
                   <span class="mopen nulldelimiter">
                   </span>
                   <span class="mfrac">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 1.565em;">
                       <span class="" style="top: -2.314em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                          <span class="mord mathnormal">
                           d
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t vlist-t2">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.7337em;">
                              <span class="" style="top: -2.4231em; margin-left: 0em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mathnormal mtight">
                                  i
                                 </span>
                                </span>
                               </span>
                              </span>
                              <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  ′
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                             <span class="vlist-s">
                              ​
                             </span>
                            </span>
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.2769em;">
                              <span class="">
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                       <span class="" style="top: -3.23em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="frac-line" style="border-bottom-width: 0.04em;">
                        </span>
                       </span>
                       <span class="" style="top: -3.677em;">
                        <span class="pstrut" style="height: 3em;">
                        </span>
                        <span class="mord">
                         <span class="mord">
                          <span class="mord mathnormal">
                           e
                          </span>
                          <span class="msupsub">
                           <span class="vlist-t">
                            <span class="vlist-r">
                             <span class="vlist" style="height: 0.888em;">
                              <span class="" style="top: -3.063em; margin-right: 0.05em;">
                               <span class="pstrut" style="height: 2.7em;">
                               </span>
                               <span class="sizing reset-size6 size3 mtight">
                                <span class="mord mtight">
                                 <span class="mord mtight">
                                  <span class="mord mtight">
                                   <span class="mord mtight">
                                    <span class="mord boldsymbol mtight">
                                     x
                                    </span>
                                   </span>
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          i
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.143em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                 <span class="mopen mtight">
                                  [
                                 </span>
                                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                                  j
                                 </span>
                                 <span class="mclose mtight">
                                  ]
                                 </span>
                                 <span class="mbin mtight">
                                  −
                                 </span>
                                 <span class="mord mtight">
                                  <span class="mord mathnormal mtight">
                                   m
                                  </span>
                                  <span class="msupsub">
                                   <span class="vlist-t vlist-t2">
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.3281em;">
                                      <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                                       <span class="pstrut" style="height: 2.5em;">
                                       </span>
                                       <span class="sizing reset-size3 size1 mtight">
                                        <span class="mord mtight">
                                         <span class="mord mathnormal mtight">
                                          i
                                         </span>
                                        </span>
                                       </span>
                                      </span>
                                     </span>
                                     <span class="vlist-s">
                                      ​
                                     </span>
                                    </span>
                                    <span class="vlist-r">
                                     <span class="vlist" style="height: 0.143em;">
                                      <span class="">
                                      </span>
                                     </span>
                                    </span>
                                   </span>
                                  </span>
                                 </span>
                                </span>
                               </span>
                              </span>
                             </span>
                            </span>
                           </span>
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.9629em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                   <span class="mclose nulldelimiter">
                   </span>
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.2222em;">
                   V
                  </span>
                  <span class="mopen">
                   [
                  </span>
                  <span class="mord mathnormal" style="margin-right: 0.0572em;">
                   j
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mbin">
                   +
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mopen">
                   (
                  </span>
                  <span class="mord mathnormal">
                   i
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mbin">
                   −
                  </span>
                  <span class="mspace" style="margin-right: 0.2222em;">
                  </span>
                  <span class="mord">
                   1
                  </span>
                  <span class="mclose">
                   )
                  </span>
                  <span class="mord mathnormal">
                   b
                  </span>
                  <span class="mpunct">
                   ,
                  </span>
                  <span class="mspace" style="margin-right: 0.2778em;">
                  </span>
                  <span class="mrel">
                   :
                  </span>
                  <span class="mclose">
                   ]
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 6.1182em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     <strong>
      end
     </strong>
    </p>
    <p>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         O 
         
        
          [ 
         
        
          k 
         
        
          , 
         
        
          : 
         
        
          ] 
         
        
          ← 
         
         
         
           o 
          
          
          
            N 
           
          
            / 
           
          
            b 
           
          
         
           ′ 
          
         
        
       
         O[k,:] \leftarrow \bm{o}^{\prime}_{N/b}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           O
          </span>
          <span class="mopen">
           [
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0315em;">
           k
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           :
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mclose">
           ]
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           ←
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1.2489em; vertical-align: -0.447em;">
          </span>
          <span class="mord">
           <span class="mord">
            <span class="mord">
             <span class="mord boldsymbol">
              o
             </span>
            </span>
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8019em;">
               <span class="" style="top: -2.428em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                   N
                  </span>
                  <span class="mord mtight">
                   /
                  </span>
                  <span class="mord mathnormal mtight">
                   b
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   ′
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.447em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <p>
     下图说明了如何将该算法应用到硬件上：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/011cab53bdb4407ea1db49aee3982c94.png#pic_center"/>
    </p>
    <p>
     上图说明了 FlashAttention 在硬件上的计算方式，其中蓝色块表示在 SRAM 中的 tile，而红色块对应于 tile 中的第
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        i 
        
       
      
        i
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6595em;">
         </span>
         <span class="mord mathnormal">
          i
         </span>
        </span>
       </span>
      </span>
     </span>
     行，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        L 
        
       
      
        L
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal">
          L
         </span>
        </span>
       </span>
      </span>
     </span>
     表示序列长度，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        D 
        
       
      
        D
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          D
         </span>
        </span>
       </span>
      </span>
     </span>
     表示每个头的维度，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        B 
        
       
      
        B
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0502em;">
          B
         </span>
        </span>
       </span>
      </span>
     </span>
     表示 block size 的大小
    </p>
    <p>
     值得注意的是，整体 SRAM 的内存占用仅仅取决于
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        B 
        
       
      
        B
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0502em;">
          B
         </span>
        </span>
       </span>
      </span>
     </span>
     和
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        D 
        
       
      
        D
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          D
         </span>
        </span>
       </span>
      </span>
     </span>
     ，与
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        L 
        
       
      
        L
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal">
          L
         </span>
        </span>
       </span>
      </span>
     </span>
     无关，因此，该算法可以扩展到长上下文而不会遇到内存问题（GPU 的共享内存很小，例如 H100 架构中为 228kb/SM）。在计算过程中，我们从左到右遍历
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        K 
         
        
          T 
         
        
       
      
        K^T
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8413em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           K
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8413em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                 T
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     和
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        A 
        
       
      
        A
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal">
          A
         </span>
        </span>
       </span>
      </span>
     </span>
     ，从上到下遍历
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        V 
        
       
      
        V
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.2222em;">
          V
         </span>
        </span>
       </span>
      </span>
     </span>
     ，并相应地更新
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        m 
        
       
         , 
        
       
           
        
       
         d 
        
       
         , 
        
       
           
        
       
         O 
        
       
      
        m,\ d, \ O
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal">
          m
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace">
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal">
          d
         </span>
         <span class="mpunct">
          ,
         </span>
         <span class="mspace">
         </span>
         <span class="mspace" style="margin-right: 0.1667em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0278em;">
          O
         </span>
        </span>
       </span>
      </span>
     </span>
     的状态
    </p>
    <h3>
     <a id="_285">
     </a>
     结语
    </h3>
    <blockquote>
     <p>
      这篇文章主要分享了 FlashAttention 的思想，FlashAttention 想要做的就是在单个循环中完成 self-attention 的整个计算
     </p>
     <p>
      我们先从 safe softmax 出发分析了 safe softmax 算法需要循环迭代 3 次，第一次循环求取序列中的最大值
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         m 
          
         
           N 
          
         
        
       
         m_N
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            m
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                  N
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ，第二次循环求取 safe softmax 的分母
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         d 
          
         
           N 
          
         
        
       
         d_N
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                  N
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ，第三次循环求取最终的 softmax 值
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         a 
          
         
           i 
          
         
        
       
         a_i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            a
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      。由于 SRAM 片上内存空间有限，我们无法将所有的
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         x 
          
         
           i 
          
         
        
       
         x_i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            x
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      缓存，导致我们在每次迭代时需要重新访问
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         Q 
         
        
          , 
         
        
          K 
         
        
       
         Q,K
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;">
          </span>
          <span class="mord mathnormal">
           Q
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0715em;">
           K
          </span>
         </span>
        </span>
       </span>
      </span>
      以动态重新计算
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         x 
          
         
           i 
          
         
        
       
         x_i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            x
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ，这造成了大量的 I/O 操作，我们并不希望看到
     </p>
     <p>
      在 online softmax 中提出了一个有意思的想法，那就是创建一个新的序列
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         d 
          
         
           i 
          
         
           ′ 
          
         
        
       
         d_i^{\prime}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.7519em;">
               <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   ′
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2587em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      来替换原始的
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         d 
          
         
           i 
          
         
        
       
         d_i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ，主要区别在于将原来
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         d 
          
         
           i 
          
         
        
       
         d_i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      定义中的
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         m 
          
         
           N 
          
         
        
       
         m_N
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            m
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                  N
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      替换为了
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         m 
          
         
           i 
          
         
        
       
         m_i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            m
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ，以消除对
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         N 
         
        
       
         N
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.109em;">
           N
          </span>
         </span>
        </span>
       </span>
      </span>
      的依赖，并且我们发现
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         d 
          
         
           N 
          
         
        
          = 
         
         
         
           d 
          
         
           N 
          
         
           ′ 
          
         
        
       
         d_N=d_N^{\prime}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                  N
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1.0272em; vertical-align: -0.2753em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.7519em;">
               <span class="" style="top: -2.4247em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                  N
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   ′
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2753em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ，那么整个 safe softmax 的计算就只需要迭代 2 次即可，第一次循环迭代可以同时计算
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         m 
          
         
           i 
          
         
        
       
         m_i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            m
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      和
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         d 
          
         
           i 
          
         
           ′ 
          
         
        
       
         d_i^{\prime}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.7519em;">
               <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   ′
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2587em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </p>
     <p>
      FlashAttention 想要把 self-attention 中的循环次数降低到一次，但是发现对于其中的 softmax 而言无法实现，因此它另辟蹊径试图寻找输出矩阵
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         O 
         
        
       
         O
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           O
          </span>
         </span>
        </span>
       </span>
      </span>
      的一次迭代形式。经过推导我们发现输出行向量
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         o 
          
         
           i 
          
         
        
       
         \bm{o}_i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5944em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord">
            <span class="mord">
             <span class="mord boldsymbol">
              o
             </span>
            </span>
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      仍然依赖于
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         m 
          
         
           N 
          
         
        
       
         m_N
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            m
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                  N
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      和
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         d 
          
         
           N 
          
         
        
       
         d_N
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                  N
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      变量，这两个值在前一个循环完成之前无法确定，因此仍需要两次循环
     </p>
     <p>
      FlashAttention 借助 online softmax 的替代思想，将序列
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         o 
         
        
       
         \bm{o}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.4444em;">
          </span>
          <span class="mord">
           <span class="mord">
            <span class="mord boldsymbol">
             o
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      替换为
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         o 
          
         
           ′ 
          
         
        
       
         \bm{o}^{\prime}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.7519em;">
          </span>
          <span class="mord">
           <span class="mord">
            <span class="mord">
             <span class="mord boldsymbol">
              o
             </span>
            </span>
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.7519em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   ′
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ，替换之后发现
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         o 
          
         
           i 
          
         
           ′ 
          
         
        
       
         \bm{o}_i^{\prime}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.0106em; vertical-align: -0.2587em;">
          </span>
          <span class="mord">
           <span class="mord">
            <span class="mord">
             <span class="mord boldsymbol">
              o
             </span>
            </span>
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.7519em;">
               <span class="" style="top: -2.4413em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   ′
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2587em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      不再依赖于
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         m 
          
         
           N 
          
         
        
       
         m_N
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.5806em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            m
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                  N
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      和
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         d 
          
         
           N 
          
         
        
       
         d_N
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8444em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.109em;">
                  N
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      等变量，而仅依赖于
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         d 
          
         
           i 
          
         
           ′ 
          
         
        
          , 
         
        
            
         
         
         
           d 
          
          
          
            i 
           
          
            − 
           
          
            1 
           
          
         
           ′ 
          
         
        
          , 
         
        
            
         
         
         
           m 
          
         
           i 
          
         
        
          , 
         
        
            
         
         
         
           m 
          
          
          
            i 
           
          
            − 
           
          
            1 
           
          
         
        
          , 
         
        
            
         
         
         
           x 
          
         
           i 
          
         
        
       
         d^{\prime}_i,\ d^{\prime}_{i-1}, \ m_i, \ m_{i-1}, \ x_i
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.0689em; vertical-align: -0.317em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.7519em;">
               <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   ′
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2587em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace">
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            d
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.7519em;">
               <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   i
                  </span>
                  <span class="mbin mtight">
                   −
                  </span>
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   ′
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.317em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace">
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            m
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace">
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            m
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   i
                  </span>
                  <span class="mbin mtight">
                   −
                  </span>
                  <span class="mord mtight">
                   1
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2083em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace">
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            x
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3117em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ，从而可以在单个循环中融合 self-attention 中的所有计算
     </p>
     <p>
      最后，由于 flashattention 算法中的所有操作都是关联的，因此可以逐个 tiling 分块计算，并且整体 SRAM 的内存占用与序列长度无关，因此可以扩展到长上下文而不用担心遇到内存问题
     </p>
     <p>
      OK，以上就是关于这篇手稿的全部内容了，大家感兴趣的可以看看，作为 FlashAttention 的入门还是没有问题的😄
     </p>
    </blockquote>
    <h3>
     <a id="_301">
     </a>
     参考
    </h3>
    <ul>
     <li>
      <a href="https://arxiv.org/abs/2205.14135" rel="nofollow">
       FlashAttention: Fast and Memory-Efficient Exact Attention with IO-Awareness
      </a>
     </li>
     <li>
      <a href="https://developer.download.nvidia.com/video/gputechconf/gtc/2020/presentations/s21745-developing-cuda-kernels-to-push-tensor-cores-to-the-absolute-limit-on-nvidia-a100.pdf" rel="nofollow">
       Gtc 2020: developing cuda kernels to push tensor cores to the absolute limit on nvidia a100
      </a>
     </li>
     <li>
      <a href="https://arxiv.org/abs/1805.02867" rel="nofollow">
       Online normalizer calculation for softmax
      </a>
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34303637323131352f:61727469636c652f64657461696c732f313436323135383830" class_="artid" style="display:none">
 </p>
</div>


