---
layout: post
title: "论文阅读笔记LORA-LOW-RANK-ADAPTATION-OF-LARGE-LANGUAGE-MODELS"
date: 2025-03-14 12:44:03 +0800
description: "LORA: LOW-RANK ADAPTATION OF LARGE LANGUAGE MODELS 论文阅读笔记"
keywords: "lora low-rank adaptation of large language models"
categories: ['论文阅读笔记']
tags: ['语言模型', '论文阅读', '自然语言处理', '笔记', '机器人', '人工智能']
artid: "146254605"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146254605
    alt: "论文阅读笔记LORA-LOW-RANK-ADAPTATION-OF-LARGE-LANGUAGE-MODELS"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146254605
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146254605
cover: https://bing.ee123.net/img/rand?artid=146254605
image: https://bing.ee123.net/img/rand?artid=146254605
img: https://bing.ee123.net/img/rand?artid=146254605
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     论文阅读笔记——LORA: LOW-RANK ADAPTATION OF LARGE LANGUAGE MODELS
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <a href="https://arxiv.org/pdf/2106.09685" rel="nofollow">
      LoRA 论文
     </a>
     <br/>
     传统全面微调，对每个任务学习的参数与原始模型相同：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         m 
         
        
          a 
         
         
         
           x 
          
         
           Φ 
          
         
         
         
           ∑ 
          
          
          
            ( 
           
          
            x 
           
          
            , 
           
          
            y 
           
          
            ) 
           
          
            ∈ 
           
          
            Z 
           
          
         
         
         
           ∑ 
          
          
          
            t 
           
          
            = 
           
          
            1 
           
          
          
          
            ∣ 
           
          
            y 
           
          
            ∣ 
           
          
         
        
          l 
         
        
          o 
         
        
          g 
         
        
          ( 
         
         
         
           P 
          
         
           Φ 
          
         
        
          ( 
         
         
         
           y 
          
         
           t 
          
         
        
          ∣ 
         
        
          x 
         
        
          , 
         
        
          y 
         
        
          &lt; 
         
        
          t 
         
        
          ) 
         
        
          ) 
         
         
        
          式(1) 
         
        
       
         max_{\Phi}\sum_{(x,y)\in Z}\sum^{|y|}_{t=1}log(P_{\Phi}(y_t|x,y&lt;t)) \qquad \text{式(1)}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 3.477em; vertical-align: -1.516em;">
          </span>
          <span class="mord mathnormal">
           ma
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            x
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   Φ
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mop op-limits">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 1.05em;">
              <span class="" style="top: -1.809em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mopen mtight">
                  (
                 </span>
                 <span class="mord mathnormal mtight">
                  x
                 </span>
                 <span class="mpunct mtight">
                  ,
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                  y
                 </span>
                 <span class="mclose mtight">
                  )
                 </span>
                 <span class="mrel mtight">
                  ∈
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0715em;">
                  Z
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.05em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="">
                <span class="mop op-symbol large-op">
                 ∑
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 1.516em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mop op-limits">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 1.961em;">
              <span class="" style="top: -1.8829em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  t
                 </span>
                 <span class="mrel mtight">
                  =
                 </span>
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.05em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="">
                <span class="mop op-symbol large-op">
                 ∑
                </span>
               </span>
              </span>
              <span class="" style="top: -4.386em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ∣
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                  y
                 </span>
                 <span class="mord mtight">
                  ∣
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 1.2671em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="mord mathnormal">
           o
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           g
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            P
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   Φ
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0359em;">
            y
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2806em;">
               <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  t
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mord">
           ∣
          </span>
          <span class="mord mathnormal">
           x
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           y
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           &lt;
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           t
          </span>
          <span class="mclose">
           ))
          </span>
          <span class="mspace" style="margin-right: 2em;">
          </span>
          <span class="mord text">
           <span class="mord cjk_fallback">
            式
           </span>
           <span class="mord">
            (1)
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     LoRA 提出
     <strong>
      对模型中权重更新部分低秩分解
     </strong>
     ，编码任务特定的参数，大幅减少所需参数规模，同时优化
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        Θ 
        
       
      
        \Theta
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord">
          Θ
         </span>
        </span>
       </span>
      </span>
     </span>
     来寻找
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        Δ 
        
       
         Θ 
        
       
      
        \Delta \Theta
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord">
          ΔΘ
         </span>
        </span>
       </span>
      </span>
     </span>
     。对于 175B 的 GPT-3 参数量只有原来的 0.01%。
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         m 
         
        
          a 
         
         
         
           x 
          
         
           Θ 
          
         
         
         
           ∑ 
          
          
          
            ( 
           
          
            x 
           
          
            , 
           
          
            y 
           
          
            ) 
           
          
            ∈ 
           
          
            Z 
           
          
         
         
         
           ∑ 
          
          
          
            t 
           
          
            = 
           
          
            1 
           
          
          
          
            ∣ 
           
          
            y 
           
          
            ∣ 
           
          
         
        
          l 
         
        
          o 
         
        
          g 
         
        
          ( 
         
         
         
           p 
          
          
           
           
             Φ 
            
           
             0 
            
           
          
            + 
           
          
            Δ 
           
          
            Φ 
           
          
            ( 
           
          
            Θ 
           
          
         
        
          ) 
         
        
          ( 
         
         
         
           y 
          
         
           t 
          
         
        
          ∣ 
         
        
          x 
         
        
          , 
         
        
          y 
         
        
          &lt; 
         
        
          t 
         
        
          ) 
         
        
          ) 
         
        
       
         max_{\Theta}\sum_{(x,y)\in Z}\sum^{|y|}_{t=1}log(p_{\Phi_0+\Delta \Phi(\Theta})(y_t|x,y&lt;t))
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 3.477em; vertical-align: -1.516em;">
          </span>
          <span class="mord mathnormal">
           ma
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            x
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3283em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   Θ
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mop op-limits">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 1.05em;">
              <span class="" style="top: -1.809em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mopen mtight">
                  (
                 </span>
                 <span class="mord mathnormal mtight">
                  x
                 </span>
                 <span class="mpunct mtight">
                  ,
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                  y
                 </span>
                 <span class="mclose mtight">
                  )
                 </span>
                 <span class="mrel mtight">
                  ∈
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0715em;">
                  Z
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.05em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="">
                <span class="mop op-symbol large-op">
                 ∑
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 1.516em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mop op-limits">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 1.961em;">
              <span class="" style="top: -1.8829em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  t
                 </span>
                 <span class="mrel mtight">
                  =
                 </span>
                 <span class="mord mtight">
                  1
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.05em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="">
                <span class="mop op-symbol large-op">
                 ∑
                </span>
               </span>
              </span>
              <span class="" style="top: -4.386em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mtight">
                  ∣
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                  y
                 </span>
                 <span class="mord mtight">
                  ∣
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 1.2671em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0197em;">
           l
          </span>
          <span class="mord mathnormal">
           o
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           g
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            p
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3448em;">
               <span class="" style="top: -2.5198em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   <span class="mord mtight">
                    Φ
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t vlist-t2">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.3173em;">
                       <span class="" style="top: -2.357em; margin-left: 0em; margin-right: 0.0714em;">
                        <span class="pstrut" style="height: 2.5em;">
                        </span>
                        <span class="sizing reset-size3 size1 mtight">
                         <span class="mord mtight">
                          0
                         </span>
                        </span>
                       </span>
                      </span>
                      <span class="vlist-s">
                       ​
                      </span>
                     </span>
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.143em;">
                       <span class="">
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                  <span class="mbin mtight">
                   +
                  </span>
                  <span class="mord mtight">
                   ΔΦ
                  </span>
                  <span class="mopen mtight">
                   (
                  </span>
                  <span class="mord mtight">
                   Θ
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3552em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0359em;">
            y
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2806em;">
               <span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight">
                  t
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mord">
           ∣
          </span>
          <span class="mord mathnormal">
           x
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           y
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           &lt;
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           t
          </span>
          <span class="mclose">
           ))
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
    </p>
    <h2>
     <a id="_5">
     </a>
     传统方法不足
    </h2>
    <ul>
     <li>
      添加 adapters 的策略虽然参数少，但会在推理阶段引入延迟——增加了模型深度。并且有额外参数和计算，在模型中这些会被放大。
     </li>
     <li>
      直接优化输入层（prefix）在训练参数方面并非单调变化且保留一部分长度进行调整降低了下游任务的序列长度——占用了一部分序列长度，减少了可用的输入序列长度。并且他的优化难度也大。
     </li>
    </ul>
    <h2>
     <a id="LoRA_9">
     </a>
     LoRA
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/06cb36130b4947f99e0ae4767bc0ea86.png#pic_center">
      <br/>
      核心思想：对于一个预训练的
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         W 
         
        
          0 
         
        
       
         ∈ 
        
        
        
          R 
         
         
         
           d 
          
         
           × 
          
         
           k 
          
         
        
       
      
        W_0 \in R^{d×k}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  0
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           ∈
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.8491em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0077em;">
            R
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8491em;">
               <span class="" style="top: -3.063em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   d
                  </span>
                  <span class="mbin mtight">
                   ×
                  </span>
                  <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                   k
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ，训练低秩矩阵
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         B 
        
       
         A 
        
       
      
        BA
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0502em;">
           B
          </span>
          <span class="mord mathnormal">
           A
          </span>
         </span>
        </span>
       </span>
      </span>
      来替代权重更新部分
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         Δ 
        
       
         W 
        
       
      
        \Delta W
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord">
           Δ
          </span>
          <span class="mord mathnormal" style="margin-right: 0.1389em;">
           W
          </span>
         </span>
        </span>
       </span>
      </span>
      ，
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         d 
        
       
         i 
        
       
         m 
        
       
         ( 
        
       
         A 
        
       
         ) 
        
       
         = 
        
       
         r 
        
       
         × 
        
       
         k 
        
       
         , 
        
        
       
         d 
        
       
         i 
        
       
         m 
        
       
         ( 
        
       
         B 
        
       
         ) 
        
       
         = 
        
       
         d 
        
       
         × 
        
       
         r 
        
        
       
         r 
        
       
         &lt; 
        
       
         &lt; 
        
       
         m 
        
       
         i 
        
       
         n 
        
       
         ( 
        
       
         d 
        
       
         , 
        
       
         k 
        
       
         ) 
        
       
      
        dim(A) = r×k, \quad dim(B)=d×r \quad r &lt;&lt; min(d,k)
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           d
          </span>
          <span class="mord mathnormal">
           im
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           A
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.6667em; vertical-align: -0.0833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           r
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ×
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0315em;">
           k
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 1em;">
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal">
           d
          </span>
          <span class="mord mathnormal">
           im
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0502em;">
           B
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.7778em; vertical-align: -0.0833em;">
          </span>
          <span class="mord mathnormal">
           d
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           ×
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 0.5782em; vertical-align: -0.0391em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           r
          </span>
          <span class="mspace" style="margin-right: 1em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0278em;">
           r
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           &lt;&lt;
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1em; vertical-align: -0.25em;">
          </span>
          <span class="mord mathnormal">
           min
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           d
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0315em;">
           k
          </span>
          <span class="mclose">
           )
          </span>
         </span>
        </span>
       </span>
      </span>
      。
      <br/>
      <span class="katex--display">
       <span class="katex-display">
        <span class="katex">
         <span class="katex-mathml">
          h 
         
        
          = 
         
         
         
           W 
          
         
           0 
          
         
        
          x 
         
        
          + 
         
        
          Δ 
         
        
          W 
         
        
          x 
         
        
          = 
         
         
         
           W 
          
         
           0 
          
         
        
          x 
         
        
          + 
         
        
          B 
         
        
          A 
         
        
          x 
         
        
       
         h=W_0x+\Delta Wx=W_0x+BAx
         </span>
         <span class="katex-html">
          <span class="base">
           <span class="strut" style="height: 0.6944em;">
           </span>
           <span class="mord mathnormal">
            h
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3011em;">
                <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   0
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mord mathnormal">
            x
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.6833em;">
           </span>
           <span class="mord">
            Δ
           </span>
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="mord mathnormal">
            x
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
           <span class="mrel">
            =
           </span>
           <span class="mspace" style="margin-right: 0.2778em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
           </span>
           <span class="mord">
            <span class="mord mathnormal" style="margin-right: 0.1389em;">
             W
            </span>
            <span class="msupsub">
             <span class="vlist-t vlist-t2">
              <span class="vlist-r">
               <span class="vlist" style="height: 0.3011em;">
                <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                 <span class="pstrut" style="height: 2.7em;">
                 </span>
                 <span class="sizing reset-size6 size3 mtight">
                  <span class="mord mtight">
                   0
                  </span>
                 </span>
                </span>
               </span>
               <span class="vlist-s">
                ​
               </span>
              </span>
              <span class="vlist-r">
               <span class="vlist" style="height: 0.15em;">
                <span class="">
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mord mathnormal">
            x
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
           <span class="mbin">
            +
           </span>
           <span class="mspace" style="margin-right: 0.2222em;">
           </span>
          </span>
          <span class="base">
           <span class="strut" style="height: 0.6833em;">
           </span>
           <span class="mord mathnormal" style="margin-right: 0.0502em;">
            B
           </span>
           <span class="mord mathnormal">
            A
           </span>
           <span class="mord mathnormal">
            x
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      <br/>
      其中，A 采取随机高斯初始化，B 为 0。
     </img>
    </p>
    <blockquote>
     <p>
      LoRA 在适应期间不需要满足满秩的条件，只需要将 r 设置为预训练权重矩阵的秩，大致可恢复完全微调的能力，可以维持原来架构。
     </p>
    </blockquote>
    <p>
     LoRA 优势：
    </p>
    <ol>
     <li>
      <strong>
       参数高效
      </strong>
      ：训练参数减少了数千倍，例如在GPT-3中，训练参数从1750亿减少到数百万甚至更少。
     </li>
     <li>
      <strong>
       计算资源节省
      </strong>
      ：由于需要计算梯度的参数大大减少，显存占用降低，训练速度加快。
     </li>
     <li>
      <strong>
       无额外推理延迟
      </strong>
      ：训练完成后，可以将低秩更新融合到预训练权重中，推理时无需额外计算。
     </li>
     <li>
      <strong>
       任务切换灵活
      </strong>
      ：不同任务只需存储和加载小的低秩矩阵，实现快速切换，减少存储需求。
      <br/>
      将 LoRA 应用于 transformer 架构中，只需要对自注意力模块
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         ( 
         
         
         
           W 
          
         
           q 
          
         
        
          , 
         
         
         
           W 
          
         
           k 
          
         
        
          , 
         
         
         
           W 
          
         
           v 
          
         
        
          , 
         
         
         
           W 
          
         
           0 
          
         
        
          ) 
         
        
       
         (W_q,W_k,W_v,W_0)
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;">
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1514em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                  q
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0315em;">
                  k
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1514em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                  v
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  0
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           )
          </span>
         </span>
        </span>
       </span>
      </span>
      中的
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         W 
          
         
           q 
          
         
        
          , 
         
         
         
           W 
          
         
           v 
          
         
        
       
         W_q,W_v
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1514em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                  q
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.1514em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                  v
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      进行适应，保持 MLP 不变。
      <br/>
      在下游部署时，只需要减去
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         B 
         
        
          A 
         
        
       
         BA
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.6833em;">
          </span>
          <span class="mord mathnormal" style="margin-right: 0.0502em;">
           B
          </span>
          <span class="mord mathnormal">
           A
          </span>
         </span>
        </span>
       </span>
      </span>
      即可恢复
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         W 
          
         
           0 
          
         
        
       
         W_0
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            W
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3011em;">
               <span class="" style="top: -2.55em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  0
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      ，再根据任务需求加上对应
      <span class="katex--inline">
       <span class="katex">
        <span class="katex-mathml">
         B 
          
          
           
          
            ′ 
           
          
         
         
         
           A 
          
          
           
          
            ′ 
           
          
         
        
       
         B^{'}A^{'}
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.9425em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0502em;">
            B
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.9425em;">
               <span class="" style="top: -2.9425em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.5795em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   <span class="">
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8278em;">
                       <span class="" style="top: -2.931em; margin-right: 0.0714em;">
                        <span class="pstrut" style="height: 2.5em;">
                        </span>
                        <span class="sizing reset-size3 size1 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           ′
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            A
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.9425em;">
               <span class="" style="top: -2.9425em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.5795em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mtight">
                   <span class="">
                   </span>
                   <span class="msupsub">
                    <span class="vlist-t">
                     <span class="vlist-r">
                      <span class="vlist" style="height: 0.8278em;">
                       <span class="" style="top: -2.931em; margin-right: 0.0714em;">
                        <span class="pstrut" style="height: 2.5em;">
                        </span>
                        <span class="sizing reset-size3 size1 mtight">
                         <span class="mord mtight">
                          <span class="mord mtight">
                           ′
                          </span>
                         </span>
                        </span>
                       </span>
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
      。最明显的好处在于内存和存储使用量减少。
     </li>
    </ol>
    <h2>
     <a id="_24">
     </a>
     实验结果
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bfc890e5fe1a4ee3b667d095bb781b40.png#pic_center"/>
    </p>
    <h2>
     <a id="_26">
     </a>
     代码实现
    </h2>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">LoRALayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span> 
        r<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> 
        lora_alpha<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> 
        lora_dropout<span class="token punctuation">:</span> <span class="token builtin">float</span><span class="token punctuation">,</span>
        merge_weights<span class="token punctuation">:</span> <span class="token builtin">bool</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>r <span class="token operator">=</span> r
        self<span class="token punctuation">.</span>lora_alpha <span class="token operator">=</span> lora_alpha
        <span class="token comment"># Optional dropout</span>
        <span class="token keyword">if</span> lora_dropout <span class="token operator">&gt;</span> <span class="token number">0.</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>lora_dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span>lora_dropout<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>lora_dropout <span class="token operator">=</span> <span class="token keyword">lambda</span> x<span class="token punctuation">:</span> x
        <span class="token comment"># Mark the weight as unmerged</span>
        self<span class="token punctuation">.</span>merged <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>merge_weights <span class="token operator">=</span> merge_weights
</code></pre>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Embedding</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">,</span> LoRALayer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        num_embeddings<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
        embedding_dim<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
        r<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
        lora_alpha<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        merge_weights<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        <span class="token operator">**</span>kwargs
    <span class="token punctuation">)</span><span class="token punctuation">:</span>
        nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_embeddings<span class="token punctuation">,</span> embedding_dim<span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        LoRALayer<span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>self<span class="token punctuation">,</span> r<span class="token operator">=</span>r<span class="token punctuation">,</span> lora_alpha<span class="token operator">=</span>lora_alpha<span class="token punctuation">,</span> lora_dropout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>
                           merge_weights<span class="token operator">=</span>merge_weights<span class="token punctuation">)</span>

        <span class="token keyword">if</span> r <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>lora_A <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>new_zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> num_embeddings<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>lora_B <span class="token operator">=</span> nn<span class="token punctuation">.</span>Parameter<span class="token punctuation">(</span>self<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>new_zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>embedding_dim<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>scaling <span class="token operator">=</span> self<span class="token punctuation">.</span>lora_alpha <span class="token operator">/</span> self<span class="token punctuation">.</span>r
            <span class="token comment"># 冻结预训练权重</span>
            self<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>requires_grad <span class="token operator">=</span> <span class="token boolean">False</span>
        self<span class="token punctuation">.</span>reset_parameters<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">reset_parameters</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">.</span>reset_parameters<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token builtin">hasattr</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token string">'lora_A'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>zeros_<span class="token punctuation">(</span>self<span class="token punctuation">.</span>lora_A<span class="token punctuation">)</span>
            nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>normal_<span class="token punctuation">(</span>self<span class="token punctuation">.</span>lora_B<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">train</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> mode<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">.</span>train<span class="token punctuation">(</span>self<span class="token punctuation">,</span> mode<span class="token punctuation">)</span>
        <span class="token keyword">if</span> mode<span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>merge_weights <span class="token keyword">and</span> self<span class="token punctuation">.</span>merged<span class="token punctuation">:</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>r <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data <span class="token operator">-=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>lora_B @ self<span class="token punctuation">.</span>lora_A<span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>scaling
                self<span class="token punctuation">.</span>merged <span class="token operator">=</span> <span class="token boolean">False</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>merge_weights <span class="token keyword">and</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>merged<span class="token punctuation">:</span>
                <span class="token comment"># Merge the weights and mark it</span>
                <span class="token keyword">if</span> self<span class="token punctuation">.</span>r <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    self<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data <span class="token operator">+=</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>lora_B @ self<span class="token punctuation">.</span>lora_A<span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>scaling
                self<span class="token punctuation">.</span>merged <span class="token operator">=</span> <span class="token boolean">True</span>
                
	    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>Tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
	        <span class="token keyword">if</span> self<span class="token punctuation">.</span>r <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">and</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>merged<span class="token punctuation">:</span>
	            result <span class="token operator">=</span> nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
	            after_A <span class="token operator">=</span> F<span class="token punctuation">.</span>embedding<span class="token punctuation">(</span>
	                x<span class="token punctuation">,</span> self<span class="token punctuation">.</span>lora_A<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>padding_idx<span class="token punctuation">,</span> self<span class="token punctuation">.</span>max_norm<span class="token punctuation">,</span>
	                self<span class="token punctuation">.</span>norm_type<span class="token punctuation">,</span> self<span class="token punctuation">.</span>scale_grad_by_freq<span class="token punctuation">,</span> self<span class="token punctuation">.</span>sparse
	            <span class="token punctuation">)</span>
	            result <span class="token operator">+=</span> <span class="token punctuation">(</span>after_A @ self<span class="token punctuation">.</span>lora_B<span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>scaling
	            <span class="token keyword">return</span> result
	        <span class="token keyword">else</span><span class="token punctuation">:</span>
	            <span class="token keyword">return</span> nn<span class="token punctuation">.</span>Embedding<span class="token punctuation">.</span>forward<span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f4d756c7469706c655f782f:61727469636c652f64657461696c732f313436323534363035" class_="artid" style="display:none">
 </p>
</div>


