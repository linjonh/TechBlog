---
layout: post
title: "ThinkPHP5多个数据库查询注意项"
date: 2018-07-13 13:14:58 +0800
description: "数据库切换 i. 在config.php中添加数据库配置数组//数据库配置1'db_config1'"
keywords: "pt5查询数据库可以使用两个条件吗"
categories: ['Thinkphp']
tags: ['无标签']
artid: "81029689"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=81029689
    alt: "ThinkPHP5多个数据库查询注意项"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=81029689
featuredImagePreview: https://bing.ee123.net/img/rand?artid=81029689
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ThinkPHP5多个数据库查询注意项
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <ol>
     <li>
      数据库切换
      <br/>
      i. 在config.php中添加数据库配置数组
     </li>
    </ol>
    <pre class="prettyprint"><code class="hljs php"><span class="hljs-comment">//数据库配置1</span>
<span class="hljs-string">'db_config1'</span> =&gt; [
<span class="hljs-comment">// 数据库类型</span>
<span class="hljs-string">'type'</span> =&gt; <span class="hljs-string">'mysql'</span>,
<span class="hljs-comment">// 服务器地址</span>
<span class="hljs-string">'hostname'</span> =&gt; <span class="hljs-string">'127.0.0.1'</span>,
<span class="hljs-comment">// 数据库名</span>
<span class="hljs-string">'database'</span> =&gt; <span class="hljs-string">'thinkphp'</span>,
<span class="hljs-comment">// 数据库用户名</span>
<span class="hljs-string">'username'</span> =&gt; <span class="hljs-string">'root'</span>,
<span class="hljs-comment">// 数据库密码</span>
<span class="hljs-string">'password'</span> =&gt; <span class="hljs-string">''</span>,
<span class="hljs-comment">// 数据库编码默认采用utf8</span>
<span class="hljs-string">'charset'</span> =&gt; <span class="hljs-string">'utf8'</span>,
<span class="hljs-comment">// 数据库表前缀</span>
<span class="hljs-string">'prefix'</span> =&gt; <span class="hljs-string">'think_'</span>,
],
<span class="hljs-comment">//数据库配置2</span>
<span class="hljs-string">'db_config2'</span> =&gt; <span class="hljs-string">'mysql://root:1234@localhost:3306/thinkphp#utf8'</span>;</code></pre>
    <p>
     将查询语句改成(这里要用‘-&gt;’连接table()方法；之前是‘::’)
    </p>
    <pre class="prettyprint"><code class="hljs coffeescript"><span class="hljs-attribute">Db</span>::connect<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'db_config1'</span>)</span>-&gt;</span>table<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'test1'</span>)</span>-&gt;</span>field<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'*'</span>)</span>-&gt;</span>select();
<span class="hljs-attribute">Db</span>::connect<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'db_config2'</span>)</span>-&gt;</span>table<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'test1'</span>)</span>-&gt;</span>field<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'*'</span>)</span>-&gt;</span>select();</code></pre>
    <ol>
     <li>
      将特定的SQL语句修改为TP5的链式操作
      <br/>
      原SQL语句如下：
     </li>
    </ol>
    <pre class="prettyprint"><code class="hljs lasso"><span class="hljs-keyword">SELECT</span> <span class="hljs-keyword">parent</span><span class="hljs-built_in">.</span>name, COUNT(product<span class="hljs-built_in">.</span>name)
FROM nested_category AS node,
nested_category AS <span class="hljs-keyword">parent</span>,
product
<span class="hljs-keyword">WHERE</span> node<span class="hljs-built_in">.</span>lft BETWEEN <span class="hljs-keyword">parent</span><span class="hljs-built_in">.</span>lft <span class="hljs-literal">AND</span> <span class="hljs-keyword">parent</span><span class="hljs-built_in">.</span>rgt
<span class="hljs-literal">AND</span> node<span class="hljs-built_in">.</span>category_id <span class="hljs-subst">=</span> product<span class="hljs-built_in">.</span>category_id
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">parent</span><span class="hljs-built_in">.</span>name
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> node<span class="hljs-built_in">.</span>lft</code></pre>
    <p>
     使用默认的数据库配置时
    </p>
    <pre class="prettyprint"><code class="hljs coffeescript">$res = <span class="hljs-attribute">Db</span>::table<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'nested_category node,nested_category parent,product'</span>)</span>
            -&gt;</span>field<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'parent.name,count(product.name)'</span>)</span>
            -&gt;</span>where<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'node.category_id'</span>,<span class="hljs-string">'exp'</span>, <span class="hljs-string">'= product.category_id'</span>)</span>
            -&gt;</span>where<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'node.lft'</span>,<span class="hljs-string">'exp'</span>, <span class="hljs-string">'between parent.lft and parent.rgt'</span>)</span>
            -&gt;</span>group<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'parent.name'</span>)</span>
            -&gt;</span>order<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'node.lft'</span>)</span>
            -&gt;</span>select();</code></pre>
    <p>
     使用第二个数据库配置时(table()前用‘-&gt;’连接；且多个数据库名用‘[]’包围，转为数组)
    </p>
    <pre class="prettyprint"><code class="hljs coffeescript">$testConnect = <span class="hljs-attribute">Db</span>::connect(<span class="hljs-string">'test_conf'</span>);
$res = $testConnect-&gt;table<span class="hljs-function"><span class="hljs-params">([<span class="hljs-string">'nested_category node,nested_category parent,product'</span>])</span>
            -&gt;</span>field<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'parent.name,count(product.name)'</span>)</span>
            -&gt;</span>where<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'node.category_id'</span>,<span class="hljs-string">'exp'</span>, <span class="hljs-string">'= product.category_id'</span>)</span>
            -&gt;</span>where<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'node.lft'</span>,<span class="hljs-string">'exp'</span>, <span class="hljs-string">'between parent.lft and parent.rgt'</span>)</span>
            -&gt;</span>group<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'parent.name'</span>)</span>
            -&gt;</span>order<span class="hljs-function"><span class="hljs-params">(<span class="hljs-string">'node.lft'</span>)</span>
            -&gt;</span>select();</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f62757a686964616f5f333231:2f61727469636c652f64657461696c732f3831303239363839" class_="artid" style="display:none">
 </p>
</div>


