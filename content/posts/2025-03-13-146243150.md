---
layout: post
title: "记录一个SQL自动执行的html页面"
date: 2025-03-13 21:59:55 +0800
description: "在实际工作场景中，需要运用到大量SQL语句更新业务逻辑，对程序员本身，写好的sql语句执行没有多大问题，但是对于普通用户来说还是有操作难度的。因此我们需要构建一个HTML页面，并结合JavaScript来发送请求到服务器端执行SQL语句。这里需要注意的是，在实际应用中直接通过前端请求执行SQL语句存在严重的安全隐患（如SQL注入攻击），通常的做法是在服务端进行严格的验证和处理。2、后端检查SQL语句是否自己预设的语句，否则提示“非法语句”；1、防火墙设置IP白名单，如我这里只允许公司内网部分IP可用；"
keywords: "记录一个SQL自动执行的html页面"
categories: ['数据库', 'Fastadmin']
tags: ['数据库', 'Sql']
artid: "146243150"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146243150
    alt: "记录一个SQL自动执行的html页面"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146243150
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146243150
cover: https://bing.ee123.net/img/rand?artid=146243150
image: https://bing.ee123.net/img/rand?artid=146243150
img: https://bing.ee123.net/img/rand?artid=146243150
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     记录一个SQL自动执行的html页面
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     在实际工作场景中，需要运用到大量SQL语句更新业务逻辑，对程序员本身，写好的sql语句执行没有多大问题（图1），但是对于普通用户来说还是有操作难度的。因此我们需要构建一个HTML页面（图2），并结合JavaScript来发送请求到服务器端执行SQL语句。这里需要注意的是，在实际应用中直接通过前端请求执行SQL语句存在严重的安全隐患（如SQL注入攻击），通常的做法是在服务端进行严格的验证和处理。
    </p>
    <p>
     图1:
    </p>
    <p>
     <img alt="" height="1245" src="https://i-blog.csdnimg.cn/direct/62dd148c5ebe4640a43c37585abc9e70.png" width="1575"/>
    </p>
    <p>
     图2:
    </p>
    <p>
     <img alt="" height="844" src="https://i-blog.csdnimg.cn/direct/af75df97303f431fa9334f0828b7a762.png" width="1556"/>
    </p>
    <p>
     以下是我的一个实际案例：
    </p>
    <p>
     HTML 页面代码（代码99%用AI工具生成即可，1%根据实际微调）
    </p>
    <pre><code class="language-html">&lt;style&gt;
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
        }
        h2 {
            color: #333;
        }
        button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        #output, #failedSql, #slowSql, #completionMessage {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        #failedSql {
            background-color: #ffe6e6;
            border-left: 5px solid #d9534f;
        }
        #slowSql {
            background-color: #fff3cd;
            border-left: 5px solid #f0ad4e;
        }
        #completionMessage {
            background-color: #dff0d8;
            border-left: 5px solid #5cb85c;
        }
        .modal {
            display: none; /* 默认隐藏 */
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
        }
    &lt;/style&gt;

    &lt;h2&gt;第53届名家具展邀约渠道统计&lt;/h2&gt;
    &lt;h5&gt;仅限公司内网操作（192.168.100.100-250）&lt;/h5&gt;
    &lt;button onclick="fetchAndExecuteSqlStatements()"&gt;开始执行&lt;/button&gt;
&lt;div id="output"&gt;&lt;/div&gt;
&lt;!-- 新增一个区域用于展示失败的SQL --&gt;
&lt;div id="failedSql" style=""&gt;
    &lt;h3&gt;失败的SQL语句:&lt;/h3&gt;
&lt;/div&gt;
&lt;!-- 新增一个区域用于展示耗时超过1秒的SQL --&gt;
&lt;div id="slowSql" style=""&gt;
    &lt;h3&gt;耗时超过1秒的SQL语句:&lt;/h3&gt;
&lt;/div&gt;
&lt;!-- 新增一个区域用于展示所有任务执行完成后的信息 --&gt;
&lt;div id="completionMessage" style=""&gt;
    &lt;h3&gt;成功与否&lt;/h3&gt;
&lt;/div&gt;

&lt;!--&lt;a href="#" id="openModalBtn"&gt;点击查看弹窗&lt;/a&gt;--&gt;

&lt;!-- 模态框 --&gt;
&lt;div id="myModal" class="modal"&gt;
    &lt;div class="modal-content"&gt;
        &lt;span class="close"&gt;&amp;times;&lt;/span&gt;
        &lt;p&gt;这是一个模态框的内容。&lt;/p&gt;
    &lt;/div&gt;
&lt;/div&gt;

&lt;script&gt;
    const url = 'xxx.com/api'    // 实际业务api
    const sqlTasks = {$sqlTasks}    // sql语句通过模板赋值
    
    async function fetchAndExecuteSqlStatements() {
        let outputDiv = document.getElementById('output');
        let failedSqlDiv = document.getElementById('failedSql');
        let slowSqlDiv = document.getElementById('slowSql');
        let completionMessageDiv = document.getElementById('completionMessage');

        let totalTasks = Object.keys(sqlTasks).length;
        let completedTasks = 0;
        let hasFailedTask = false;

        for (let [description, sql] of Object.entries(sqlTasks)) {
            try {
                let startTime = new Date().getTime();
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({sql: sql})
                });
                
                let endTime = new Date().getTime();
                let executionTime = (endTime - startTime) / 1000;

                const result = await response.json();
                if(result.code == 1) {
                    outputDiv.innerHTML += `&lt;p&gt;执行任务: "${description}" 结果: 成功，耗时: ${executionTime.toFixed(2)} 秒&lt;/p&gt;`;
                    
                    if(executionTime &gt; 1) {
                        slowSqlDiv.innerHTML += `&lt;p&gt;SQL语句: "${sql}" 耗时: ${executionTime.toFixed(2)} 秒&lt;/p&gt;`;
                    }
                } else {
                    outputDiv.innerHTML += `&lt;p&gt;执行任务: "${description}" 结果: 失败 - ${result.msg}&lt;/p&gt;`;
                    failedSqlDiv.innerHTML += `&lt;p&gt;SQL语句: "${sql}"&lt;/p&gt;`;
                    hasFailedTask = true;
                }
            } catch (error) {
                let endTime = new Date().getTime();
                let executionTime = (endTime - startTime) / 1000;
                
                outputDiv.innerHTML += `&lt;p&gt;执行任务: "${description}" 结果: 失败 - ${error.message}，耗时: ${executionTime.toFixed(2)} 秒&lt;/p&gt;`;
                failedSqlDiv.innerHTML += `&lt;p&gt;SQL语句: "${sql}"&lt;/p&gt;`;
                hasFailedTask = true;
            }

            completedTasks++;
            if(completedTasks === totalTasks) {
                if(hasFailedTask) {
                    completionMessageDiv.innerHTML = '&lt;h3&gt;注意：&lt;/strong&gt;部分任务执行失败，请检查错误日志。&lt;h3&gt;';
                } else {
                    completionMessageDiv.innerHTML = '&lt;h3&gt;恭喜：&lt;/strong&gt;所有任务执行成功。记得刷新&lt;h3&gt;';
                }
            }
        }
    }
    
    // 模态框相关脚本
    var modal = document.getElementById("myModal");
    var btn = document.getElementById("openModalBtn");
    var span = document.getElementsByClassName("close")[0];

    btn.onclick = function() { modal.style.display = "block"; }
    span.onclick = function() { modal.style.display = "none"; }
    window.onclick = function(event) {
        if (event.target == modal) { modal.style.display = "none"; }
    }
&lt;/script&gt;</code></pre>
    <p>
     模板赋值(ThinkPHP5)
    </p>
    <pre><code class="language-php">    // 获取SQL执行语句的方法
    private function getSql(){
        $name = 'miniform';
        $config = get_addon_config($name);
        $arr = isset($config['qudaosql']) ? $config['qudaosql'] : [];
        return $arr;
    }

    // 渠道更新页面访问方法
    public function aa(){
        if($this-&gt;request-&gt;isGet()){    // GET请求
            $arr = self::getSql();    // 获取SQL执行语句
            // dump($arr);
            $this-&gt;view-&gt;assign('sqlTasks',json_encode($arr));    // 模板赋值，输出json字符串
            return $this-&gt;view-&gt;fetch();
        }
    }</code></pre>
    <p>
    </p>
    <p>
     执行SQL后端部分（PHP ）
    </p>
    <pre><code class="language-php">    public function execSql($sql){
        // sql语句校验
        $arr = self::getSql();
        $arr = array_values($arr);
        if(!in_array($sql,$arr)){
            return json_encode(['code'=&gt;0,'msg'=&gt;'非法sql']);
        }
        $exec = Db::execute($sql);
        if($exec===false){
            return json_encode(['code'=&gt;0,'msg'=&gt;'执行失败']);
        } 
        return json_encode(['code'=&gt;1,'msg'=&gt;'执行成功']);
    }
</code></pre>
    <p>
     执行结果：
    </p>
    <p>
     <img alt="" height="1164" src="https://i-blog.csdnimg.cn/direct/203c07dd2aca4326a0f0e8798e95f4ea.png" width="1291"/>
    </p>
    <p>
     安全设置：
    </p>
    <p>
     1、防火墙设置IP白名单，如我这里只允许公司内网部分IP可用；
    </p>
    <p>
     2、后端检查SQL语句是否自己预设的语句，否则提示“非法语句”；
    </p>
    <p>
     补充一段上述代码中涉及到的SQL语句，供参考：
    </p>
    <p>
    </p>
    <pre><code>array(18) {
  ["更新表单id=18"] =&gt; string(77) "UPDATE fa_miniform_di53jieguojimingjiajudongguanzhanlanhui SET project_id=18;"
  ["更正original_data"] =&gt; string(183) "UPDATE fa_miniform_di53jieguojimingjiajudongguanzhanlanhui         SET original_data=REPLACE(original_data,'addfromcode-zh','addfromcode_zh')         WHERE addfromcode='fromyudengji';"
  ["补充addfromcode"] =&gt; string(472) "UPDATE fa_miniform_di53jieguojimingjiajudongguanzhanlanhui a INNER JOIN (         SELECT id,REPLACE(adfc,'\"','') as adfc,REPLACE(ly,'\"','') as ly FROM (         SELECT id,original_data,JSON_EXTRACT(original_data, '$.addfromcode_zh') as adfc 				,JSON_EXTRACT(original_data, '$.ly') as ly         FROM fa_miniform_di53jieguojimingjiajudongguanzhanlanhui         WHERE addfromcode='fromyudengji' 				) a         ) b ON a.id=b.id         SET a.addfromcode=b.adfc,a.ly=b.ly "
  ["归零"] =&gt; string(91) "UPDATE fa_miniform_qudao              SET items=0,items2=0             WHERE project_id=18;"
  ["匹配得上的统计"] =&gt; string(281) "UPDATE fa_miniform_qudao a INNER JOIN (             SELECT addfromcode,count(*) as jls FROM fa_miniform_di53jieguojimingjiajudongguanzhanlanhui             GROUP BY addfromcode) b             ON a.qdcode=b.addfromcode              SET a.items=b.jls             WHERE project_id=18;"
  ["匹配得上的统计2"] =&gt; string(193) "UPDATE fa_miniform_di53jieguojimingjiajudongguanzhanlanhui a INNER JOIN fa_miniform_qudao b             ON a.addfromcode=b.qdcode              SET a.qdid=b.id             WHERE b.project_id=18;"
  ["统计英文登记"] =&gt; string(323) "UPDATE fa_miniform_qudao a SET a.items=( SELECT SUM(jls) FROM ( SELECT addfromcode,count(*) as jls FROM fa_miniform_di53jieguojimingjiajudongguanzhanlanhui a LEFT JOIN fa_miniform_qudao b ON a.addfromcode=b.qdcode WHERE b.qdcode is NULL AND lang='en' AND a.project_id=18 GROUP BY addfromcode ) aa ) WHERE qdcode='sjyyclmj';"
  ["统计英文登记2"] =&gt; string(135) "UPDATE fa_miniform_di53jieguojimingjiajudongguanzhanlanhui a INNER JOIN fa_miniform_qudao b  ON a.addfromcode=b.qdcode SET a.qdid=b.id;"
  ["统计英文登记3"] =&gt; string(469) "UPDATE fa_miniform_di53jieguojimingjiajudongguanzhanlanhui a              SET a.qdid=(SELECT id FROM fa_miniform_qudao WHERE qdcode='sjyyclmj' AND project_id=18)             WHERE lang='en' AND addfromcode in (SELECT addfromcode from (SELECT addfromcode,count(*) as jls FROM fa_miniform_di53jieguojimingjiajudongguanzhanlanhui a LEFT JOIN fa_miniform_qudao b ON a.addfromcode=b.qdcode WHERE b.qdcode is NULL AND lang='en' AND a.project_id=18 GROUP BY addfromcode) aa );"
  ["更新好友邀请1"] =&gt; string(307) "UPDATE fa_miniform_qudao a INNER JOIN (             SELECT 'shujuyunyinghaoyoufenxiang' as addfromcode,count(*) as jls FROM fa_miniform_di53jieguojimingjiajudongguanzhanlanhui WHERE ly='fs'             ) b             ON a.qdcode=b.addfromcode              SET a.items=b.jls             WHERE project_id=18;"
  ["更新好友邀请2"] =&gt; string(206) "UPDATE fa_miniform_di53jieguojimingjiajudongguanzhanlanhui a              SET a.qdid=(SELECT id FROM fa_miniform_qudao WHERE qdcode='shujuyunyinghaoyoufenxiang' AND project_id=18)             WHERE ly='fs';"
  ["3-7号馆1"] =&gt; string(307) "UPDATE fa_miniform_qudao a INNER JOIN (             SELECT '1711zs' as addfromcode,count(*) as jls FROM fa_miniform_di53jieguojimingjiajudongguanzhanlanhui              WHERE (ly LIKE 'zs')             ) b             ON a.qdcode=b.addfromcode              SET a.items=b.jls             WHERE project_id=18;"
  ["3-7号馆2"] =&gt; string(207) "UPDATE fa_miniform_di53jieguojimingjiajudongguanzhanlanhui a              SET a.qdid=(SELECT id FROM fa_miniform_qudao WHERE qdcode='1711zs' AND project_id=18)             WHERE (addfromcode LIKE '1711zs%');"
  ["8-9号馆1"] =&gt; string(329) "UPDATE fa_miniform_qudao a INNER JOIN (             SELECT 'yingyunpinpaihaibaoliebian' as addfromcode,count(*) as jls FROM fa_miniform_di53jieguojimingjiajudongguanzhanlanhui              WHERE (ly LIKE 'zshb')             ) b             ON a.qdcode=b.addfromcode              SET a.items=b.jls             WHERE project_id=18;"
  ["8-9号馆2"] =&gt; string(215) "UPDATE fa_miniform_di53jieguojimingjiajudongguanzhanlanhui a              SET a.qdid=(SELECT id FROM fa_miniform_qudao WHERE qdcode='yingyunpinpaihaibaoliebian' AND project_id=18)             WHERE (ly LIKE 'zshb');"
  ["导入闸机数据后，更新观众登记表"] =&gt; string(195) "UPDATE fa_miniform_di53jieguojimingjiajudongguanzhanlanhui a INNER JOIN ( SELECT qrcode,count(*) as jls FROM fa_miniform_di52jiezhajishuju GROUP BY qrcode) b ON a.qrcode=b.qrcode SET a.dds=b.jls;"
  ["更新渠道邀约数"] =&gt; string(200) "UPDATE fa_miniform_qudao a INNER JOIN ( SELECT qdid,count(*) as jls FROM fa_miniform_di53jieguojimingjiajudongguanzhanlanhui WHERE qdid&gt;0 AND dds&gt;0 GROUP BY qdid ) b ON a.id=b.qdid SET a.items2=b.jls;"
  ["补充en数据ly为空"] =&gt; string(179) "UPDATE fa_miniform_di53jieguojimingjiajudongguanzhanlanhui a INNER JOIN fa_miniform_qudao b ON a.addfromcode=b.qdcode SET a.ly='qd' WHERE (a.ly IS NULL OR a.ly='') AND a.lang='en'"
}</code></pre>
    <p>
     在fa后台，用fieldset组件简单做一个SQL配置，虽然不太好看但能用就行，如下图所示：
    </p>
    <p>
     <img alt="" height="976" src="https://i-blog.csdnimg.cn/direct/e99e94172329464ab58168d7243333d7.png" width="657"/>
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f686a313034332f:61727469636c652f64657461696c732f313436323433313530" class_="artid" style="display:none">
 </p>
</div>


