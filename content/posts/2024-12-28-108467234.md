---
layout: post
title: "达梦数据库还原库导致用户名密码错误解决方法"
date: 2024-12-28 21:58:02 +0800
description: "由于本人喜欢DM迁移DM使用备份还原的方式进行迁库，所遇到的问题进"
keywords: "达梦数据库,脱机备份,数据库迁移"
categories: ['达梦数据库']
tags: ['数据库']
artid: "108467234"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=108467234
    alt: "达梦数据库还原库导致用户名密码错误解决方法"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=108467234
featuredImagePreview: https://bing.ee123.net/img/rand?artid=108467234
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     达梦数据库还原库导致用户名/密码错误解决方法
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      <strong>
       由于本人喜欢DM迁移DM使用备份还原的方式进行全库迁移，所遇到的问题进行分析。
      </strong>
     </p>
    </blockquote>
    <pre><code class="prism language-c">问题描述：使用脱机备份B数据库，在A数据上进行还原。还原后登录数据库提示用户名<span class="token operator">/</span>密码错误。
</code></pre>
    <p>
     达梦数据库可通过联机备份（热）或脱机备份（冷）的备份集进行全库还原。通过全库还原有两种方法：一种是备份数据库实例物理文件方法进行恢复，一种是通过达梦自带的脱机还原工具（dmrman工具和console工具）进行备份恢复。
    </p>
    <h5>
     <a id="_10">
     </a>
     测试环境：
    </h5>
    <table>
     <thead>
      <tr>
       <th>
        数据库
       </th>
       <th>
        操作系统版本
       </th>
       <th>
        数据库安装包版本
       </th>
       <th>
        IP地址
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        数据库A
       </td>
       <td>
        NeoKylin Liux General Server 6.0 (Dhaulagiri)
       </td>
       <td>
        dm8_setup_rh6_64_ent_8.1
       </td>
       <td>
        192.168.1.20
       </td>
      </tr>
      <tr>
       <td>
        数据库B
       </td>
       <td>
        CentOS Linux release 7.7.1908 (Core)
       </td>
       <td>
        dm8_setup_rh7_64_ent_8.1
       </td>
       <td>
        192.168.1.60
       </td>
      </tr>
     </tbody>
    </table>
    <h5>
     <a id="dmrmanA_17">
     </a>
     通过dmrman工具对数据库A进行脱机备份
    </h5>
    <blockquote>
     <p>
      1、停止数据库服务
     </p>
    </blockquote>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>dmdba@localhost bin<span class="token punctuation">]</span>$ <span class="token function">cd</span> /home/dmdba/dmdbms/bin
<span class="token punctuation">[</span>dmdba@localhost bin<span class="token punctuation">]</span>$ ./DmServiceDMSERVER stop
Stopping DmServiceDMSERVER:                                <span class="token punctuation">[</span> OK <span class="token punctuation">]</span>
<span class="token punctuation">[</span>dmdba@localhost bin<span class="token punctuation">]</span>$ 
</code></pre>
    <blockquote>
     <p>
      2、通过dmrman工具备份数据库备份集在/home/dmdba/dmdbms/data/DAMENG/bak路径下
     </p>
    </blockquote>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>dmdba@localhost bin<span class="token punctuation">]</span>$ ./dmrman
dmrman V8
RMAN<span class="token operator">&gt;</span> BACKUP DATABASE <span class="token string">'/home/dmdba/dmdbms/data/DAMENG/dm.ini'</span>FULL<span class="token punctuation">;</span>
BACKUP DATABASE <span class="token string">'/home/dmdba/dmdbms/data/DAMENG/dm.ini'</span> FULL<span class="token punctuation">;</span>
<span class="token function">file</span> dm.key not found, use default license<span class="token operator">!</span>
Database mode <span class="token operator">=</span> 0, oguid <span class="token operator">=</span> 0
EP<span class="token punctuation">[</span>0<span class="token punctuation">]</span>'s cur_lsn<span class="token punctuation">[</span>46015<span class="token punctuation">]</span>
BACKUP DATABASE <span class="token punctuation">[</span>DAMENG<span class="token punctuation">]</span>,execute<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
CMD CHECK LSN<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
BACKUP DATABASE <span class="token punctuation">[</span>DAMENG<span class="token punctuation">]</span>,collect dbf<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
CMD CHECK <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
DBF BACKUP SUBS<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
total 1 packages processed<span class="token punctuation">..</span>.
total 3 packages processed<span class="token punctuation">..</span>.
total 4 packages processed<span class="token punctuation">..</span>.
total 5 packages processed<span class="token punctuation">..</span>.
total 6 packages processed<span class="token punctuation">..</span>.
DBF BACKUP MAIN<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
BACKUPSET <span class="token punctuation">[</span>/home/dmdba/dmdbms/data/DAMENG/bak/DB_DAMENG_FULL_20200909_120148_000394<span class="token punctuation">]</span> END, CODE <span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
META GENERATING<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
total 10 packages processed<span class="token punctuation">..</span>.
total 10 packages processed<span class="token punctuation">..</span>.
total 10 packages processed<span class="token operator">!</span>
CMD END.CODE:<span class="token punctuation">[</span>0<span class="token punctuation">]</span>
backup successfully<span class="token operator">!</span>
<span class="token function">time</span> used: 00:00:01.187
RMAN<span class="token operator">&gt;</span> 
</code></pre>
    <blockquote>
     <p>
      3、通过SCP命令发送备份集到B服务器上
     </p>
    </blockquote>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>dmdba@localhost ~<span class="token punctuation">]</span>$ <span class="token function">cd</span> dmdbms/data/DAMENG/bak
<span class="token punctuation">[</span>dmdba@localhost bak<span class="token punctuation">]</span>$ ll
总用量 4
drwxr-xr-x 2 dmdba dminstall 4096  9月  9 12:28 DB_DAMENG_FULL_20200909_122802_975951
<span class="token punctuation">[</span>dmdba@localhost bak<span class="token punctuation">]</span>$ <span class="token function">scp</span> -r DB_DAMENG_FULL_20200909_122802_975951/ dmdba@192.168.1.21:/home/dmdba/dmdbms/data/DAMENG/bak
The authenticity of host <span class="token string">'192.168.1.21 (192.168.1.21)'</span> can<span class="token string">'t be established.
RSA key fingerprint is 7d:96:94:45:6a:61:a4:be:5f:fb:83:f9:01:a7:61:89.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '</span>192.168.1.21<span class="token string">' (RSA) to the list of known hosts.
dmdba@192.168.1.21'</span>s password: 
DB_DAMENG_FULL_20200909_122802_975951.meta                                                                                                               100%   73KB  72.5KB/s   00:00    
DB_DAMENG_FULL_20200909_122802_975951.bak                                                                                                                100% 5990KB   5.9MB/s   00:00    
<span class="token punctuation">[</span>dmdba@localhost bak<span class="token punctuation">]</span>$ 
 
</code></pre>
    <blockquote>
     <p>
      4、登录B服务进行查看备份集并进行还原。
     </p>
    </blockquote>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>C:\~<span class="token punctuation">]</span>$ <span class="token function">ssh</span> 192.168.1.60
Connecting to 192.168.1.60:22<span class="token punctuation">..</span>.
Connection established.
To escape to local shell, press <span class="token string">'Ctrl+Alt+]'</span><span class="token keyword">.</span>

Last login: Wed Sep  9 10:26:34 2020 from 192.168.1.163
<span class="token punctuation">[</span>dmdba@localhost ~<span class="token punctuation">]</span>$ 
<span class="token punctuation">[</span>dmdba@localhost ~<span class="token punctuation">]</span>$ 
<span class="token punctuation">[</span>dmdba@localhost ~<span class="token punctuation">]</span>$ 
<span class="token punctuation">[</span>dmdba@localhost ~<span class="token punctuation">]</span>$ <span class="token function">cd</span> /home/dmdba/dmdbms/data/DAMENG/bak
<span class="token punctuation">[</span>dmdba@localhost bak<span class="token punctuation">]</span>$ ll
总用量 4
drwxr-xr-x 2 dmdba dminstall 4096  9月  9 12:02  DB_DAMENG_FULL_20200909_122802_975951
<span class="token punctuation">[</span>dmdba@localhost bak<span class="token punctuation">]</span>$ 

<span class="token punctuation">[</span>dmdba@localhost bin<span class="token punctuation">]</span>$ <span class="token function">cd</span> /etc/init.d/
<span class="token punctuation">[</span>dmdba@localhost init.d<span class="token punctuation">]</span>$ ./DmServiceDMSERVER stop
Stopping DmServiceDMSERVER:                                <span class="token punctuation">[</span> OK <span class="token punctuation">]</span>
<span class="token punctuation">[</span>dmdba@localhost init.d<span class="token punctuation">]</span>$ <span class="token function">cd</span> /home/dmdba/dmdbms/bin
<span class="token punctuation">[</span>dmdba@localhost bin<span class="token punctuation">]</span>$ ./dmrman 
dmrman V8
RMAN<span class="token operator">&gt;</span> RESTORE DATABASE <span class="token string">'/home/dmdba/dmdbms/data/DAMENG/dm.ini'</span> FROM BACKUPSET<span class="token string">'/home/dmdba/dmdbms/data/DAMENG/bak/DB_DAMENG_FULL_20200909_122802_975951'</span><span class="token punctuation">;</span>
RESTORE DATABASE <span class="token string">'/home/dmdba/dmdbms/data/DAMENG/dm.ini'</span> FROM BACKUPSET <span class="token string">'/home/dmdba/dmdbms/data/DAMENG/bak/DB_DAMENG_FULL_20200909_122802_975951'</span><span class="token punctuation">;</span>
<span class="token function">file</span> dm.key not found, use default license<span class="token operator">!</span>
RESTORE DATABASE CHECK<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
RESTORE DATABASE,dbf collect<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
RESTORE DATABASE,dbf refresh <span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
RESTORE BACKUPSET <span class="token punctuation">[</span>/home/dmdba/dmdbms/data/DAMENG/bak/DB_DAMENG_FULL_20200909_122802_975951<span class="token punctuation">]</span> START<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
total 3 packages processed<span class="token punctuation">..</span>.
total 7 packages processed<span class="token punctuation">..</span>.
RESTORE DATABASE,UPDATE ctl file<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
RESTORE DATABASE,REBUILD key file<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
RESTORE DATABASE,CHECK db info<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
RESTORE DATABASE,UPDATE db info<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
total 7 packages processed<span class="token punctuation">..</span>.
total 7 packages processed<span class="token operator">!</span>
CMD END.CODE:<span class="token punctuation">[</span>0<span class="token punctuation">]</span>
restore successfully.
<span class="token function">time</span> used: 284.771<span class="token punctuation">(</span>ms<span class="token punctuation">)</span>
</code></pre>
    <blockquote>
     <p>
      5、对数据库进行恢复
     </p>
    </blockquote>
    <pre><code class="prism language-bash">RMAN<span class="token operator">&gt;</span> RECOVER DATABASE <span class="token string">'/home/dmdba/dmdbms/data/DAMENG/dm.ini'</span> FROM BACKUPSET<span class="token string">'/home/dmdba/dmdbms/data/DAMENG/bak/DB_DAMENG_FULL_20200909_122802_975951'</span><span class="token punctuation">;</span>
RECOVER DATABASE <span class="token string">'/home/dmdba/dmdbms/data/DAMENG/dm.ini'</span> FROM BACKUPSET <span class="token string">'/home/dmdba/dmdbms/data/DAMENG/bak/DB_DAMENG_FULL_20200909_122802_975951'</span><span class="token punctuation">;</span>
Database mode <span class="token operator">=</span> 0, oguid <span class="token operator">=</span> 0
EP<span class="token punctuation">[</span>0<span class="token punctuation">]</span>'s cur_lsn<span class="token punctuation">[</span>34896<span class="token punctuation">]</span>
RESTORE RLOG CHECK<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
CMD END.CODE:<span class="token punctuation">[</span>603<span class="token punctuation">]</span>,DESC:<span class="token punctuation">[</span>备份集<span class="token punctuation">[</span>/home/dmdba/dmdbms/data/DAMENG/bak/DB_DAMENG_FULL_20200909_122802_975951<span class="token punctuation">]</span>备份过程中未产生日志<span class="token punctuation">]</span>
备份集<span class="token punctuation">[</span>/home/dmdba/dmdbms/data/DAMENG/bak/DB_DAMENG_FULL_20200909_122802_975951<span class="token punctuation">]</span>备份过程中未产生日志
recover successfully<span class="token operator">!</span>
<span class="token function">time</span> used: 233.906<span class="token punctuation">(</span>ms<span class="token punctuation">)</span>
</code></pre>
    <blockquote>
     <p>
      6、更新DB_MAGIC值
     </p>
    </blockquote>
    <pre><code class="prism language-bash">RMAN<span class="token operator">&gt;</span> RECOVER DATABASE <span class="token string">'/home/dmdba/dmdbms/data/DAMENG/dm.ini'</span> UPDATE DB_MAGIC<span class="token punctuation">;</span>
RECOVER DATABASE <span class="token string">'/home/dmdba/dmdbms/data/DAMENG/dm.ini'</span> UPDATE DB_MAGIC<span class="token punctuation">;</span>
Database mode <span class="token operator">=</span> 0, oguid <span class="token operator">=</span> 0
EP<span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token string">'s cur_lsn[34896]
EP[0]'</span>s apply_lsn<span class="token punctuation">[</span>34896<span class="token punctuation">]</span> <span class="token operator">&gt;=</span> end_lsn<span class="token punctuation">[</span>34896<span class="token punctuation">]</span>
recover successfully<span class="token operator">!</span>
<span class="token function">time</span> used: 990.579<span class="token punctuation">(</span>ms<span class="token punctuation">)</span>
RMAN<span class="token operator">&gt;</span> 
</code></pre>
    <blockquote>
     <p>
      7、启动达梦数据库数据库实例服务
     </p>
    </blockquote>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>dmdba@localhost bin<span class="token punctuation">]</span>$ ./DmServiceDMSERVER start
Starting DmServiceDMSERVER:                                <span class="token punctuation">[</span> FAILED <span class="token punctuation">]</span>
<span class="token function">file</span> dm.key not found, use default license<span class="token operator">!</span>
version info: develop
Use normal os_malloc instead of HugeTLB
Use normal os_malloc instead of HugeTLB
DM Database Server x64 V8 1-1-45-19.11.21-116030-ENT  startup<span class="token punctuation">..</span>.
Database mode <span class="token operator">=</span> 0, oguid <span class="token operator">=</span> 0
License will expire on 2020-11-21
<span class="token function">file</span> lsn: 34896
ndct db load finished
ndct fill fast pool finished
iid page<span class="token string">'s trxid[3006]
NEXT TRX ID = 3007
pseg_collect_items, collect 0 active_trxs, 0 cmt_trxs, 0 pre_cmt_trxs, 0 active_pages, 0 cmt_pages, 0 pre_cmt_pages
pseg_process_collect_items end, 0 active trx, 0 active pages, 0 committed trx, 0 committed pages
total 0 active crash trx, pseg_crash_trx_rollback begin ...
pseg_crash_trx_rollback end
purg2_crash_cmt_trx end, total 0 page purged
set EP[0]'</span>s pseg state to inactive
pseg recv finished
nsvr_startup end.
aud sys init success.
aud rt sys init success.
systables desc init success.
ndct_db_load_info success.
nsvr_process_before_open begin.
Server DM7_DCT_VERSION mismatch, version of data is 7, server version is 5.
Server DM8_DCT_VERSION mismatch, version of data is 18, server version is 16.
Please use the correct version of server or <span class="token keyword">set</span> the CHECK_SVR_VERSION<span class="token operator">=</span>0 <span class="token keyword">in</span> dm.ini
<span class="token punctuation">[</span>dmdba@localhost bin<span class="token punctuation">]</span>$ 
</code></pre>
    <blockquote>
     <p>
      发现数据库服务无法启动。提示服务器版本不对，需要修改CHECK_SVR_VERSION=0
     </p>
    </blockquote>
    <pre><code class="prism language-bash"><span class="token function">vi</span> /home/dmdba/dmdbms/data/DAMENG/dm.ini
 CHECK_SVR_VERSION               <span class="token operator">=</span> 0                     <span class="token comment">#Whether to check server version</span>
</code></pre>
    <blockquote>
     <p>
      再去启动数据库实例服务
     </p>
    </blockquote>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>dmdba@localhost bin<span class="token punctuation">]</span>$ ./DmServiceDMSERVER start
Starting DmServiceDMSERVER:                                <span class="token punctuation">[</span> OK <span class="token punctuation">]</span>
<span class="token punctuation">[</span>dmdba@localhost bin<span class="token punctuation">]</span>$ 
</code></pre>
    <blockquote>
     <p>
      发现服务启动成功。现在开始登录数据库看是否正常。
     </p>
    </blockquote>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>dmdba@localhost bin<span class="token punctuation">]</span>$ ./disql 
disql V8
用户名:
密码:
<span class="token punctuation">[</span>-2501<span class="token punctuation">]</span>:用户名或密码错误.
用户名:
</code></pre>
    <p>
     <strong>
      本地登录，数据库账号密码错误。经过一些列的检查，发现两个数据库的小版本不对。
     </strong>
    </p>
    <p>
     发现192.168.1.60使用的达梦数据库版本是：dm8_setup_rh7_64_ent_8.1.1.45_20191121.iso
     <br/>
     发现192.168.1.21使用的达梦数据库版本是：dm8_setup_rh6_64_ent_8.1.1.88_20200629.iso
    </p>
    <p>
     这次把备份集拷贝到本地windows数据库上进行恢复。本地数据版本是：dm8_setup_win64_ent_8.1.1.88_20200708.iso
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1716f3668c37ddb9740dbe2b7d95cb83.png#pic_center"/>
    </p>
    <p>
     停止数据库实例服务
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7f34f5271ad6b27df86e89ea79588cfd.png#pic_center"/>
    </p>
    <p>
     windows使用dmrman工具最好使用管理员运行。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/03afcce50bc57d2239930602d3e7644d.png#pic_center">
      <br/>
      启动实例服务，查看数据库是否正常。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0fa911780bcb2fa1d5b878809b6e7766.png#pic_center">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/43659028f0c0841587d7cadec1c2cee8.png#pic_center">
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e16584eba2330a9083e295c8be3ba54f.png#pic_center">
         <br/>
         数据库正常。
         <br/>
         <strong>
          总结：如果使用备份还原方式进行迁移库的话，最好使用相同版本，小版本必须要一样。
         </strong>
        </img>
       </img>
      </img>
     </img>
    </p>
    <p>
     192.168.1.60使用的达梦数据库版本是：dm8_setup_rh7_64_ent_8.1.1.45_20191121.iso
     <br/>
     192.168.1.21使用的达梦数据库版本是：dm8_setup_rh6_64_ent_8.1.1.88_20200629.iso
     <br/>
     192.168.1.163使用的达梦数据库版本是：dm8_setup_win64_ent_8.1.1.88_20200708.iso
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33333830393536362f:61727469636c652f64657461696c732f313038343637323334" class_="artid" style="display:none">
 </p>
</div>


