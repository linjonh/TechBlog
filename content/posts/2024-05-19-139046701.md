---
layout: post
title: "Ansible自动化运维工具"
date: 2024-05-19 18:57:29 +0800
description: "Ansible是一款自动化运维工具，基于Python开发，集合了众多运维工具（puppet、cfen"
keywords: "python 运维工具"
categories: ['未分类']
tags: ['运维', '自动化', 'Linux', 'Ansible']
artid: "139046701"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=139046701
  alt: "Ansible自动化运维工具"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=139046701
featuredImagePreview: https://bing.ee123.net/img/rand?artid=139046701
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Ansible自动化运维工具
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <ul>
        <li>
         <a href="#Ansible_1" rel="nofollow">
          一、什么是Ansible
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#1_3" rel="nofollow">
            1、简介
           </a>
          </li>
          <li>
           <a href="#2_9" rel="nofollow">
            2、架构
           </a>
          </li>
          <li>
           <a href="#3_20" rel="nofollow">
            3、工作流程
           </a>
          </li>
         </ul>
        </li>
        <li>
         <a href="#Ansible_33" rel="nofollow">
          二、部署Ansible批量管理
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#1_35" rel="nofollow">
            1、涉及主机
           </a>
          </li>
          <li>
           <a href="#2Ansible_44" rel="nofollow">
            2、安装部署Ansible
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#21yum_48" rel="nofollow">
              2.1、yum安装
             </a>
            </li>
            <li>
             <a href="#22_58" rel="nofollow">
              2.2、其他方式
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#3_62" rel="nofollow">
            3、设置免密登录
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#31hosts_64" rel="nofollow">
              3.1、控制节点设置hosts解析
             </a>
            </li>
            <li>
             <a href="#32_74" rel="nofollow">
              3.2、生成密钥对
             </a>
            </li>
            <li>
             <a href="#33_103" rel="nofollow">
              3.3、将公钥发送给受管节点
             </a>
            </li>
            <li>
             <a href="#34_115" rel="nofollow">
              3.4、测试免密登录
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#4_125" rel="nofollow">
            4、定义主机清单
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#41ansible_127" rel="nofollow">
              4.1、ansible常见的配置文件
             </a>
            </li>
            <li>
             <a href="#42_133" rel="nofollow">
              4.2、备份主机清单文件
             </a>
            </li>
            <li>
             <a href="#43_141" rel="nofollow">
              4.3、修改主机清单，设置分组
             </a>
            </li>
           </ul>
          </li>
         </ul>
        </li>
        <li>
         <a href="#Ansible_168" rel="nofollow">
          三、Ansible参数说明及执行状态
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#1_170" rel="nofollow">
            1、参数说明
           </a>
          </li>
          <li>
           <a href="#2Ansible_191" rel="nofollow">
            2、Ansible的执行状态
           </a>
          </li>
         </ul>
        </li>
        <li>
         <a href="#Ansible_199" rel="nofollow">
          四、Ansible常用模块
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#1ping_201" rel="nofollow">
            1、ping模块
           </a>
          </li>
          <li>
           <a href="#2command_220" rel="nofollow">
            2、command模块
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#21_226" rel="nofollow">
              2.1、选项及描述
             </a>
            </li>
            <li>
             <a href="#22chdirremovescreates_244" rel="nofollow">
              2.2、结合chdir和removes、creates列出指定目录下内容
             </a>
            </li>
            <li>
             <a href="#23_256" rel="nofollow">
              2.3、查看磁盘空间
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#3shell_268" rel="nofollow">
            3、shell模块
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#31_272" rel="nofollow">
              3.1、选项及参数
             </a>
            </li>
            <li>
             <a href="#32_290" rel="nofollow">
              3.2、检查远程主机的系统版本
             </a>
            </li>
            <li>
             <a href="#33_302" rel="nofollow">
              3.3、查看远程主机防火墙状态
             </a>
            </li>
            <li>
             <a href="#34_315" rel="nofollow">
              3.4、创建、查看指定目录
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#4user_327" rel="nofollow">
            4、user模块
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#41_333" rel="nofollow">
              4.1、选项及描述
             </a>
            </li>
            <li>
             <a href="#42uid_360" rel="nofollow">
              4.2、添加系统用户，指定uid、家目录及注释
             </a>
            </li>
            <li>
             <a href="#43_369" rel="nofollow">
              4.3、查看新创建的用户
             </a>
            </li>
            <li>
             <a href="#44_378" rel="nofollow">
              4.4、删除新创建的用户
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#5group_387" rel="nofollow">
            5、group模块
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#51_393" rel="nofollow">
              5.1、选项及描述
             </a>
            </li>
            <li>
             <a href="#52_408" rel="nofollow">
              5.2、创建或更新组
             </a>
            </li>
            <li>
             <a href="#53_419" rel="nofollow">
              5.3、删除组
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#6copy_428" rel="nofollow">
            6、copy模块
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#61_434" rel="nofollow">
              6.1、选项及描述
             </a>
            </li>
            <li>
             <a href="#62_451" rel="nofollow">
              6.2、给定内容生成文件，并修改权限信息
             </a>
            </li>
            <li>
             <a href="#63_460" rel="nofollow">
              6.3、修改文件内容，选择覆盖备份
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#7fetch_469" rel="nofollow">
            7、fetch模块
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#71_473" rel="nofollow">
              7.1、选项及描述
             </a>
            </li>
            <li>
             <a href="#72_492" rel="nofollow">
              7.2、从远程主机抓取文件
             </a>
            </li>
            <li>
             <a href="#73_504" rel="nofollow">
              7.3、限制抓取文件的大小、添加文件存在检测
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#8file_513" rel="nofollow">
            8、file模块
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#81_517" rel="nofollow">
              8.1、选项及描述
             </a>
            </li>
            <li>
             <a href="#82_535" rel="nofollow">
              8.2、在指定路径下创建目录
             </a>
            </li>
            <li>
             <a href="#83_547" rel="nofollow">
              8.3、创建软链接文件
             </a>
            </li>
            <li>
             <a href="#84_556" rel="nofollow">
              8.4、创建硬链接文件
             </a>
            </li>
            <li>
             <a href="#85_565" rel="nofollow">
              8.5、删除文件
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#9yum_574" rel="nofollow">
            9、yum模块
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#91_580" rel="nofollow">
              9.1、选项及描述
             </a>
            </li>
            <li>
             <a href="#92httpd_598" rel="nofollow">
              9.2、安装httpd服务
             </a>
            </li>
            <li>
             <a href="#93_625" rel="nofollow">
              9.3、更新所有的软件包
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#10cron_634" rel="nofollow">
            10、cron模块
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#101_638" rel="nofollow">
              10.1、选项及描述
             </a>
            </li>
            <li>
             <a href="#102_663" rel="nofollow">
              10.2、添加计划任务
             </a>
            </li>
            <li>
             <a href="#103_672" rel="nofollow">
              10.3、删除指定计划任务
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#11service_681" rel="nofollow">
            11、service模块
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#111_687" rel="nofollow">
              11.1、选项及描述
             </a>
            </li>
            <li>
             <a href="#112_704" rel="nofollow">
              11.2、远程开启/关闭防火墙
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#12script_725" rel="nofollow">
            12、script模块
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#121_729" rel="nofollow">
              12.1、选项及描述
             </a>
            </li>
            <li>
             <a href="#122_745" rel="nofollow">
              12.2、编辑并部署脚本
             </a>
            </li>
            <li>
             <ul>
              <li>
               <a href="#1_747" rel="nofollow">
                1、控制节点本地编辑脚本并添加执行权限
               </a>
              </li>
              <li>
               <a href="#2script_760" rel="nofollow">
                2、通过script模块部署到远程主机执行
               </a>
              </li>
             </ul>
            </li>
           </ul>
          </li>
          <li>
           <a href="#13setup_769" rel="nofollow">
            13、setup模块
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#131_775" rel="nofollow">
              13.1、选项及描述
             </a>
            </li>
            <li>
             <a href="#132_788" rel="nofollow">
              13.2、查看内存信息
             </a>
            </li>
            <li>
             <ul>
              <li>
               <a href="#free_m_797" rel="nofollow">
                通过free -m命令查看内存大小是否一致
               </a>
              </li>
             </ul>
            </li>
            <li>
             <a href="#133_806" rel="nofollow">
              13.3、保存信息
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#14synchronize_815" rel="nofollow">
            14、synchronize模块
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#141_821" rel="nofollow">
              14.1、选项及描述
             </a>
            </li>
            <li>
             <a href="#142_856" rel="nofollow">
              14.2、将源目录同步至目标目录（增量同步）
             </a>
            </li>
            <li>
             <a href="#143_877" rel="nofollow">
              14.3、将源目录同步至目标目录（完全同步）
             </a>
            </li>
           </ul>
          </li>
         </ul>
        </li>
        <li>
         <a href="#Ansible_playbook_884" rel="nofollow">
          五、Ansible playbook
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#1_886" rel="nofollow">
            1、简介
           </a>
          </li>
          <li>
           <a href="#2playbookYAML_892" rel="nofollow">
            2、playbook的YAML格式
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#21_901" rel="nofollow">
              2.1、示例：
             </a>
            </li>
            <li>
             <a href="#22_937" rel="nofollow">
              2.2、解析
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#3playbook_958" rel="nofollow">
            3、playbook的执行与语法检查
           </a>
          </li>
          <li>
           <a href="#4playbook_968" rel="nofollow">
            4、playbook的核心元素
           </a>
          </li>
          <li>
           <a href="#5_976" rel="nofollow">
            5、基本组件及格式
           </a>
          </li>
          <li>
           <a href="#6nginx_1007" rel="nofollow">
            6、安装nginx并修改配置文件
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#61_1009" rel="nofollow">
              6.1、准备文件存放目录
             </a>
            </li>
            <li>
             <a href="#62yaml_1015" rel="nofollow">
              6.2、编写yaml文件
             </a>
            </li>
            <li>
             <a href="#63conf_1047" rel="nofollow">
              6.3、编写conf文件
             </a>
            </li>
            <li>
             <a href="#64playbook_1068" rel="nofollow">
              6.4、检查语法错误，执行playbook
             </a>
            </li>
            <li>
             <a href="#65nginx_1080" rel="nofollow">
              6.5、验证nginx启动状态
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#7nginxhandlersnotify_1089" rel="nofollow">
            7、安装nginx，并添加handlers和notify
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#71nginxymlnginxconf_1091" rel="nofollow">
              7.1、修改对应的nginx.yml和nginx.conf文件
             </a>
            </li>
            <li>
             <a href="#72nginx_1151" rel="nofollow">
              7.2、验证nginx进程信息
             </a>
            </li>
            <li>
             <a href="#73_1160" rel="nofollow">
              7.3、测试标签
             </a>
            </li>
            <li>
             <a href="#74notify_1172" rel="nofollow">
              7.4、测试notify
             </a>
            </li>
            <li>
             <ul>
              <li>
               <a href="#741notify_1174" rel="nofollow">
                7.4.1、notify的触发条件是配置文件被改变
               </a>
              </li>
              <li>
               <a href="#742_1198" rel="nofollow">
                7.4.2、重新执行剧本
               </a>
              </li>
              <li>
               <a href="#743_1210" rel="nofollow">
                7.4.3、重新查看端口号
               </a>
              </li>
             </ul>
            </li>
           </ul>
          </li>
          <li>
           <a href="#8variables_1220" rel="nofollow">
            8、变量（variables）
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#81_1226" rel="nofollow">
              8.1、定义变量的方式
             </a>
            </li>
            <li>
             <ul>
              <li>
               <a href="#1_FactsFacts_1228" rel="nofollow">
                1. Facts（Facts变量）
               </a>
              </li>
              <li>
               <a href="#2__1246" rel="nofollow">
                2. 用户自定义变量
               </a>
              </li>
              <li>
               <a href="#3_Roles_1270" rel="nofollow">
                3. 通过Roles传递变量
               </a>
              </li>
              <li>
               <a href="#4_Host_Inventory_1284" rel="nofollow">
                4. Host Inventory（主机清单）中定义变量
               </a>
              </li>
             </ul>
            </li>
            <li>
             <a href="#82_1301" rel="nofollow">
              8.2、优先级
             </a>
            </li>
            <li>
             <a href="#83keepalived_1307" rel="nofollow">
              8.3、案例：使用变量安装keepalived
             </a>
            </li>
            <li>
             <ul>
              <li>
               <a href="#1_1309" rel="nofollow">
                1、编写剧本
               </a>
              </li>
              <li>
               <a href="#2_1358" rel="nofollow">
                2、拷贝配置文件
               </a>
              </li>
              <li>
               <a href="#3_1366" rel="nofollow">
                3、运行剧本，变量由命令行传入
               </a>
              </li>
              <li>
               <a href="#4_1378" rel="nofollow">
                4、或者直接再剧本里定义变量
               </a>
              </li>
              <li>
               <a href="#5_1421" rel="nofollow">
                5、运行定义过变量的剧本
               </a>
              </li>
             </ul>
            </li>
           </ul>
          </li>
          <li>
           <a href="#9templates_1433" rel="nofollow">
            9、模板（templates）
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#91_1435" rel="nofollow">
              9.1、简介
             </a>
            </li>
            <li>
             <a href="#92_1443" rel="nofollow">
              9.2、基本数据类型和操作符
             </a>
            </li>
            <li>
             <a href="#93hosts_1456" rel="nofollow">
              9.3、案例：生成hosts解析文件
             </a>
            </li>
            <li>
             <ul>
              <li>
               <a href="#1Ansible_1460" rel="nofollow">
                1、修改Ansible主机清单
               </a>
              </li>
              <li>
               <a href="#2_1476" rel="nofollow">
                2、修改主机名
               </a>
              </li>
              <li>
               <a href="#3_1485" rel="nofollow">
                3、准备模板文件
               </a>
              </li>
              <li>
               <a href="#4_1498" rel="nofollow">
                4、编写剧本
               </a>
              </li>
              <li>
               <a href="#5_1515" rel="nofollow">
                5、执行剧本
               </a>
              </li>
              <li>
               <a href="#6_1524" rel="nofollow">
                6、验证
               </a>
              </li>
             </ul>
            </li>
           </ul>
          </li>
          <li>
           <a href="#10_1532" rel="nofollow">
            10、条件判断
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#101_1536" rel="nofollow">
              10.1、举例
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#11_1548" rel="nofollow">
            11、循环迭代
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#111_1553" rel="nofollow">
              11.1举例
             </a>
            </li>
            <li>
             <a href="#112_1577" rel="nofollow">
              11.2、案例：循环创建用户
             </a>
            </li>
            <li>
             <ul>
              <li>
               <a href="#1_1579" rel="nofollow">
                1、循环创建以下用户信息
               </a>
              </li>
              <li>
               <a href="#2_1588" rel="nofollow">
                2、循环创建出以上用户并指定用户信息
               </a>
              </li>
              <li>
               <a href="#3_1620" rel="nofollow">
                3、执行剧本
               </a>
              </li>
              <li>
               <a href="#4_1632" rel="nofollow">
                4、验证
               </a>
              </li>
             </ul>
            </li>
           </ul>
          </li>
          <li>
           <a href="#12_1640" rel="nofollow">
            12、字典
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#121_1644" rel="nofollow">
              12.1、举例
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#13role_1667" rel="nofollow">
            13、角色（role）
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#131_1669" rel="nofollow">
              13.1、简介
             </a>
            </li>
            <li>
             <a href="#132_1675" rel="nofollow">
              13.2、角色的目录结构
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#14nginx_1690" rel="nofollow">
            14、案例：使用角色安装nginx
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#141_1692" rel="nofollow">
              14.1、创建对应的目录结构
             </a>
            </li>
            <li>
             <a href="#142_1702" rel="nofollow">
              14.2、定义配置文件
             </a>
            </li>
            <li>
             <a href="#143_1722" rel="nofollow">
              14.3、放置文件到指定目录
             </a>
            </li>
            <li>
             <a href="#144_1739" rel="nofollow">
              14.4、修改变量文件
             </a>
            </li>
            <li>
             <a href="#145handlers_1746" rel="nofollow">
              14.5、定义handlers文件
             </a>
            </li>
            <li>
             <a href="#146_1755" rel="nofollow">
              14.6定义剧本文件
             </a>
            </li>
            <li>
             <a href="#147_1766" rel="nofollow">
              14.7、剩余的配置文件
             </a>
            </li>
            <li>
             <a href="#148_1782" rel="nofollow">
              14.8、启动服务
             </a>
            </li>
            <li>
             <a href="#149_1794" rel="nofollow">
              14.9、验证端口号
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#15httpd_1802" rel="nofollow">
            15、案例：使用角色安装httpd
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#151_1804" rel="nofollow">
              15.1、创建对应的目录结构
             </a>
            </li>
            <li>
             <a href="#152siteyaml_1817" rel="nofollow">
              15.2、编写site.yaml文件
             </a>
            </li>
            <li>
             <a href="#153tasksmainyml_1829" rel="nofollow">
              15.3、编写tasks里的main.yml文件
             </a>
            </li>
            <li>
             <a href="#154_1846" rel="nofollow">
              15.4、执行剧本
             </a>
            </li>
            <li>
             <a href="#155_1858" rel="nofollow">
              15.5、验证
             </a>
            </li>
           </ul>
          </li>
          <li>
           <a href="#16javanginxhalo_1866" rel="nofollow">
            16、案例：使用角色安装java+nginx+halo
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#161_1868" rel="nofollow">
              16.1、准备角色
             </a>
            </li>
            <li>
             <a href="#162siteyml_1881" rel="nofollow">
              16.2、编写site.yml
             </a>
            </li>
            <li>
             <a href="#163nginx_1913" rel="nofollow">
              16.3、编写nginx角色
             </a>
            </li>
            <li>
             <a href="#164java_1963" rel="nofollow">
              16.4、编写java角色
             </a>
            </li>
            <li>
             <a href="#165halo_1976" rel="nofollow">
              16.5、编写halo角色
             </a>
            </li>
            <li>
             <a href="#166_2048" rel="nofollow">
              16.6、执行剧本
             </a>
            </li>
            <li>
             <a href="#167_2060" rel="nofollow">
              16.7、验证
             </a>
            </li>
           </ul>
          </li>
         </ul>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h3>
     <a id="Ansible_1">
     </a>
     一、什么是Ansible
    </h3>
    <h4>
     <a id="1_3">
     </a>
     1、简介
    </h4>
    <p>
     Ansible是一款自动化运维工具，基于Python开发，集合了众多运维工具（puppet、cfengine、chef、func、fabric）的优点，实现了批量系统部署、批量程序部署，批量运行命令等功能。
    </p>
    <p>
     Ansible是基于模块工作的，本身没有批量部署的能力，真正具有批量部署能力的是Ansible运行的模块，Ansible只是提供一个框架。Ansible不需要在远程主机上安装client/agents，因为它们是基于ssh来和远程主机通讯的。
    </p>
    <h4>
     <a id="2_9">
     </a>
     2、架构
    </h4>
    <p>
     <img alt="2Q==" src="https://i-blog.csdnimg.cn/blog_migrate/02f7de265166cd3a6e5f6d4b21a2193a.jpeg"/>
    </p>
    <ul>
     <li>
      ansbile：核心程序
     </li>
     <li>
      modules：包括ansible自带的核心模块以及自定义模块
     </li>
     <li>
      plugins：完成模块功能的补充，包括连接插件，邮箱插件
     </li>
     <li>
      palybooks：剧本，定义ansbile多任务配置文件，由ansible自动执行
     </li>
     <li>
      inventory：定义ansbile管理的主机清单
     </li>
     <li>
      connection plugins：负责和被监控端实现通信
     </li>
    </ul>
    <h4>
     <a id="3_20">
     </a>
     3、工作流程
    </h4>
    <ol>
     <li>
      <strong>
       加载配置文件
      </strong>
      ： Ansible 默认查找
      <code>
       /etc/ansible/ansible.cfg
      </code>
      配置文件，这个文件包含了Ansible运行时的行为设定，如连接方式、插件路径等。
     </li>
     <li>
      <strong>
       解析Inventory
      </strong>
      ： Ansible 使用 Inventory 文件（默认是
      <code>
       /etc/ansible/hosts
      </code>
      ）来确定需要操作的目标主机或主机组。
     </li>
     <li>
      <strong>
       编译Playbook或命令
      </strong>
      ： Ansible 准备执行的Playbook或直接执行的Ad-Hoc命令，并解析其中的任务和模块调用。
     </li>
     <li>
      <strong>
       模块加载与执行策略准备
      </strong>
      ： 对于每个任务，Ansible 加载相应的模块（如
      <code>
       command
      </code>
      模块），并准备执行上下文，包括变量、环境等。
     </li>
     <li>
      <strong>
       生成并传输临时脚本
      </strong>
      ： Ansible 会根据任务和模块生成一个或多个临时的Python脚本，并通过SSH连接传输到目标主机的临时目录，通常位于目标用户的
      <code>
       ~/.ansible/tmp/ansible-tmp-&lt;UNIQUE_ID&gt;/
      </code>
      目录下。
     </li>
     <li>
      <strong>
       赋予执行权限
      </strong>
      ： 在目标主机上，Ansible 会给这个临时Python脚本加上执行权限，以便能够运行。
     </li>
     <li>
      <strong>
       执行远程脚本
      </strong>
      ： Ansible 通过SSH在目标主机上执行这个临时脚本，并收集执行结果。
     </li>
     <li>
      <strong>
       结果收集与处理
      </strong>
      ： 执行完毕后，各个主机的执行结果被收集并汇总，Ansible根据这些结果决定是否继续执行后续任务，或是根据Playbook中的错误处理逻辑（如
      <code>
       rescue
      </code>
      和
      <code>
       always
      </code>
      块）进行操作。
     </li>
     <li>
      <strong>
       清理
      </strong>
      ： 一旦任务执行完成，无论成功还是失败，Ansible 会清理目标主机上的临时文件，包括删除之前上传的Python脚本。
     </li>
     <li>
      <strong>
       退出与报告
      </strong>
      ： 清理完成后，Ansible 进程在目标主机上退出，并向控制机报告最终的执行状态和结果。
     </li>
    </ol>
    <h3>
     <a id="Ansible_33">
     </a>
     二、部署Ansible批量管理
    </h3>
    <h4>
     <a id="1_35">
     </a>
     1、涉及主机
    </h4>
    <table>
     <thead>
      <tr>
       <th align="center">
        主机名
       </th>
       <th align="center">
        角色
       </th>
       <th align="center">
        IP地址
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="center">
        server
       </td>
       <td align="center">
        控制节点
       </td>
       <td align="center">
        192.168.112.10
       </td>
      </tr>
      <tr>
       <td align="center">
        host1
       </td>
       <td align="center">
        受管节点
       </td>
       <td align="center">
        192.168.112.20
       </td>
      </tr>
      <tr>
       <td align="center">
        host2
       </td>
       <td align="center">
        受管节点
       </td>
       <td align="center">
        192.168.112.30
       </td>
      </tr>
      <tr>
       <td align="center">
        host3
       </td>
       <td align="center">
        受管节点
       </td>
       <td align="center">
        192.168.112.40
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="2Ansible_44">
     </a>
     2、安装部署Ansible
    </h4>
    <blockquote>
     <p>
      控制节点
     </p>
    </blockquote>
    <h5>
     <a id="21yum_48">
     </a>
     2.1、yum安装
    </h5>
    <pre><code class="prism language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> epel-release		<span class="token comment">#Centos需要安装EPEL仓库</span>
yum <span class="token function">install</span> <span class="token parameter variable">-y</span> ansible		<span class="token comment">#yum包管理安装Ansible</span>
ansible <span class="token parameter variable">--version</span>		<span class="token comment">#查看Ansible安装版本</span>
</code></pre>
    <p>
     <img alt="image-20240514193101699" src="https://i-blog.csdnimg.cn/blog_migrate/445a23bbaf36140a2460c305b75812cd.png"/>
    </p>
    <h5>
     <a id="22_58">
     </a>
     2.2、其他方式
    </h5>
    <p>
     <a href="http://www.ansible.com.cn/docs/intro_installation.html" rel="nofollow">
      安装管理主机
     </a>
    </p>
    <h4>
     <a id="3_62">
     </a>
     3、设置免密登录
    </h4>
    <h5>
     <a id="31hosts_64">
     </a>
     3.1、控制节点设置hosts解析
    </h5>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server ~<span class="token punctuation">]</span><span class="token comment"># vim /etc/hosts</span>
<span class="token number">192.168</span>.112.10 server
<span class="token number">192.168</span>.112.20 host1
<span class="token number">192.168</span>.112.30 host2
<span class="token number">192.168</span>.112.40 host3
</code></pre>
    <h5>
     <a id="32_74">
     </a>
     3.2、生成密钥对
    </h5>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server ~<span class="token punctuation">]</span><span class="token comment"># ssh-keygen -P "" -t rsa</span>
Generating public/private rsa key pair.
Enter <span class="token function">file</span> <span class="token keyword">in</span> <span class="token function">which</span> to save the key <span class="token punctuation">(</span>/root/.ssh/id_rsa<span class="token punctuation">)</span>:
Created directory <span class="token string">'/root/.ssh'</span><span class="token builtin class-name">.</span>
Your identification has been saved <span class="token keyword">in</span> /root/.ssh/id_rsa.
Your public key has been saved <span class="token keyword">in</span> /root/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:eSgh2wm7WxXS8n61UI4wKK0yEl3mLlzwIFBdOQSAgag root@server
The key's randomart image is:
+---<span class="token punctuation">[</span>RSA <span class="token number">2048</span><span class="token punctuation">]</span>----+
<span class="token operator">|</span><span class="token assign-left variable">B</span><span class="token operator">+=</span>o++o.         <span class="token operator">|</span>
<span class="token operator">|</span>+o B<span class="token punctuation">..</span>oo         <span class="token operator">|</span>
<span class="token operator">|</span>o <span class="token builtin class-name">.</span> B *.<span class="token operator">=</span>   <span class="token builtin class-name">.</span>    <span class="token operator">|</span>
<span class="token operator">|</span>Eo o O * * +     <span class="token operator">|</span>
<span class="token operator">|</span><span class="token builtin class-name">.</span> <span class="token operator">=</span> <span class="token operator">=</span> + S + o    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token builtin class-name">.</span> + <span class="token builtin class-name">.</span> + <span class="token builtin class-name">.</span> o <span class="token builtin class-name">.</span>   <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span> <span class="token builtin class-name">.</span>    <span class="token operator">|</span>
<span class="token operator">|</span>     o   <span class="token builtin class-name">.</span>       <span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token builtin class-name">.</span>            <span class="token operator">|</span>
+----<span class="token punctuation">[</span>SHA256<span class="token punctuation">]</span>-----+
</code></pre>
    <ul>
     <li>
      <code>
       -P ""
      </code>
      ：设置空密码
     </li>
     <li>
      <code>
       -t rsa
      </code>
      ： 指定生成密钥的类型为RSA
     </li>
     <li>
      简化后续实验输密码操作
     </li>
    </ul>
    <h5>
     <a id="33_103">
     </a>
     3.3、将公钥发送给受管节点
    </h5>
    <pre><code class="prism language-bash">ssh-copy-id <span class="token parameter variable">-i</span> /root/.ssh/id_rsa.pub root@host1
ssh-copy-id <span class="token parameter variable">-i</span> /root/.ssh/id_rsa.pub root@host2
ssh-copy-id <span class="token parameter variable">-i</span> /root/.ssh/id_rsa.pub root@host3
</code></pre>
    <p>
     <img alt="image-20240514194147934" src="https://i-blog.csdnimg.cn/blog_migrate/d57421781bd215b91990d15f69bc6aaf.png"/>
    </p>
    <blockquote>
     <p>
      过程中需要输入受管节点的密码
     </p>
    </blockquote>
    <h5>
     <a id="34_115">
     </a>
     3.4、测试免密登录
    </h5>
    <pre><code class="prism language-bash"><span class="token function">ssh</span> root@host1
<span class="token function">ssh</span> root@host2
<span class="token function">ssh</span> root@host3
</code></pre>
    <p>
     <img alt="image-20240514195408504" src="https://i-blog.csdnimg.cn/blog_migrate/36cae09f41f2783753de8fc30eec15c6.png"/>
    </p>
    <h4>
     <a id="4_125">
     </a>
     4、定义主机清单
    </h4>
    <h5>
     <a id="41ansible_127">
     </a>
     4.1、ansible常见的配置文件
    </h5>
    <ul>
     <li>
      /etc/ansible/ansible.cfg：主配置文件
     </li>
     <li>
      /etc/ansible/hosts：主机清单文件
     </li>
     <li>
      /etc/ansible/roles：角色目录
     </li>
    </ul>
    <h5>
     <a id="42_133">
     </a>
     4.2、备份主机清单文件
    </h5>
    <pre><code class="prism language-bash"><span class="token function">cp</span> <span class="token parameter variable">-f</span> hosts hosts.bak
</code></pre>
    <p>
     <img alt="image-20240515154201487" src="https://i-blog.csdnimg.cn/blog_migrate/f4f730e303ea0470b9483cef70d287af.png"/>
    </p>
    <h5>
     <a id="43_141">
     </a>
     4.3、修改主机清单，设置分组
    </h5>
    <pre><code class="prism language-bash"><span class="token function">vim</span> /etc/ansible/hosts
<span class="token punctuation">[</span>all-servers<span class="token punctuation">]</span>
server
host1
host2
host3
<span class="token punctuation">[</span>node1<span class="token punctuation">]</span>
host1
<span class="token punctuation">[</span>node2<span class="token punctuation">]</span>
host2
<span class="token punctuation">[</span>node3<span class="token punctuation">]</span>
host3
<span class="token punctuation">[</span>mysql_test<span class="token punctuation">]</span>
host1
host2
<span class="token punctuation">[</span>web_test<span class="token punctuation">]</span>
host2
host3
<span class="token punctuation">[</span>manager<span class="token punctuation">]</span>
server
</code></pre>
    <p>
     <img alt="image-20240516112421403" src="https://i-blog.csdnimg.cn/blog_migrate/aee24c255db7bbf6e76939db04347ba6.png"/>
    </p>
    <h3>
     <a id="Ansible_168">
     </a>
     三、Ansible参数说明及执行状态
    </h3>
    <h4>
     <a id="1_170">
     </a>
     1、参数说明
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th>
        说明
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <code>
         -h
        </code>
       </td>
       <td>
        显示帮助信息，包含可用的命令和选项。
       </td>
      </tr>
      <tr>
       <td>
        <code>
         -i
        </code>
       </td>
       <td>
        指定Inventory文件的路径，默认为
        <code>
         /etc/ansible/hosts
        </code>
        。
       </td>
      </tr>
      <tr>
       <td>
        <code>
         -l
        </code>
       </td>
       <td>
        限制playbook或命令的作用范围，仅对匹配的主机执行。
       </td>
      </tr>
      <tr>
       <td>
        <code>
         -u
        </code>
       </td>
       <td>
        指定连接远程主机时使用的用户名。
       </td>
      </tr>
      <tr>
       <td>
        <code>
         -b
        </code>
       </td>
       <td>
        在远程主机上执行操作时临时提升权限，相当于使用
        <code>
         sudo
        </code>
        。
       </td>
      </tr>
      <tr>
       <td>
        <code>
         --become-user=USER
        </code>
       </td>
       <td>
        提升权限后切换到的用户。
       </td>
      </tr>
      <tr>
       <td>
        <code>
         -m
        </code>
       </td>
       <td>
        用于ad-hoc命令，指定要使用的模块名。
       </td>
      </tr>
      <tr>
       <td>
        <code>
         -a
        </code>
       </td>
       <td>
        指定模块的参数。
       </td>
      </tr>
      <tr>
       <td>
        <code>
         -f
        </code>
       </td>
       <td>
        指定并发进程数，默认为5。
       </td>
      </tr>
      <tr>
       <td>
        <code>
         -v
        </code>
       </td>
       <td>
        增加输出的详细程度，多次使用可获得更多调试信息。
       </td>
      </tr>
      <tr>
       <td>
        <code>
         -vvv
        </code>
       </td>
       <td>
        设置更详细的输出级别，有助于调试。
       </td>
      </tr>
      <tr>
       <td>
        <code>
         --check
        </code>
       </td>
       <td>
        执行模拟运行，不实际改变系统状态，用以预览操作效果。
       </td>
      </tr>
      <tr>
       <td>
        <code>
         --diff
        </code>
       </td>
       <td>
        修改文件时，显示修改前后的差异。
       </td>
      </tr>
      <tr>
       <td>
        <code>
         -C
        </code>
       </td>
       <td>
        检查执行结果
       </td>
      </tr>
      <tr>
       <td>
        <code>
         -e
        </code>
       </td>
       <td>
        指明变量名
       </td>
      </tr>
      <tr>
       <td>
        <code>
         --syntax-check
        </code>
       </td>
       <td>
        检查执行命令是否存在语法错误
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="2Ansible_191">
     </a>
     2、Ansible的执行状态
    </h4>
    <ul>
     <li>
      绿色：执行成功并且不需要做改变的操作
     </li>
     <li>
      黄色：执行成功并且对目标主机做变更
     </li>
     <li>
      红色：执行失败
     </li>
     <li>
      粉色：警告信息
     </li>
     <li>
      蓝色：显示ansible命令执行的过程
     </li>
    </ul>
    <h3>
     <a id="Ansible_199">
     </a>
     四、Ansible常用模块
    </h3>
    <h4>
     <a id="1ping_201">
     </a>
     1、ping模块
    </h4>
    <blockquote>
     <p>
      主机连通性测试
     </p>
    </blockquote>
    <pre><code class="prism language-bash"><span class="token comment">#一个一个测试</span>
ansible <span class="token parameter variable">-m</span> <span class="token function">ping</span> node1
ansible <span class="token parameter variable">-m</span> <span class="token function">ping</span> node2
ansible <span class="token parameter variable">-m</span> <span class="token function">ping</span> node3
ansible <span class="token parameter variable">-m</span> <span class="token function">ping</span> manager

<span class="token comment">#以组为单位测试</span>
ansible <span class="token parameter variable">-m</span> <span class="token function">ping</span> all-servers
</code></pre>
<p>
<img alt="image-20240515175627840" src="https://i-blog.csdnimg.cn/blog_migrate/32835df301321a01b03d0e5827787170.png"/>
</p>
<p>
<img alt="image-20240516111257062" src="https://i-blog.csdnimg.cn/blog_migrate/d06ce7625a2f1fcff9eb1ecacf8d61f7.png"/>
</p>
<h4>
<a id="2command_220">
</a>
2、command 模块
</h4>
<blockquote>
<p>
ansible 的默认模块，用于在远程主机上执行简单的 Linux 命令，并将结果返回主机
</p>
<p>
不支持管道，变量及重定向等
</p>
</blockquote>
<h5>
<a id="21_226">
</a>
2.1、选项及描述
</h5>
<pre><code class="prism language-bash">ansible-doc <span class="token parameter variable">-s</span> <span class="token builtin class-name">command</span>
</code></pre>
<table>
<thead>
<tr>
<th align="center">
选项
</th>
<th align="center">
描述
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
argv
</td>
<td align="center">
将命令作为列表而非字符串传递。使用
<code>
argv
</code>
可避免对原本会被误解的值（例如用户名中带空格的情况）进行引用。只能提供字符串或列表形式之一，不能同时提供。
</td>
</tr>
<tr>
<td align="center">
chdir
</td>
<td align="center">
在执行命令前切换到此目录。
</td>
</tr>
<tr>
<td align="center">
cmd
</td>
<td align="center">
要执行的命令。
</td>
</tr>
<tr>
<td align="center">
creates
</td>
<td align="center">
如果该文件已经存在，此步骤不会执行。
</td>
</tr>
<tr>
<td align="center">
removes
</td>
<td align="center">
如果该文件存在，此步骤将会执行。
</td>
</tr>
<tr>
<td align="center">
stdin
</td>
<td align="center">
直接将指定的值设置为命令的 stdin。
</td>
</tr>
<tr>
<td align="center">
stdin_add_newline
</td>
<td align="center">
如果设置为
<code>
yes
</code>
，在 stdin 数据末尾追加换行符。
</td>
</tr>
<tr>
<td align="center">
strip_empty_ends
</td>
<td align="center">
从 stdout/stderr 结果的结尾去除空行。
</td>
</tr>
<tr>
<td align="center">
warn
</td>
<td align="center">
启用或禁用任务警告。
</td>
</tr>
</tbody>
</table>
<h5>
<a id="22chdirremovescreates_244">
</a>
2.2、结合 chdir 和 removes、creates 列出指定目录下内容
</h5>
<pre><code class="prism language-bash"><span class="token comment">#node1 组先切换到 root 目录下 aliyun.sh 文件存在不执行 ls</span>
ansible node1 <span class="token parameter variable">-m</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-a</span> <span class="token string">'chdir=/root/ creates=aliyun.sh ls'</span>

<span class="token comment">#node1 组先切换到 root 目录下 aliyun.sh 文件存在就执行 ls</span>
ansible node1 <span class="token parameter variable">-m</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-a</span> <span class="token string">'chdir=/root/ removes=aliyun.sh ls'</span>
</code></pre>
<p>
<img alt="image-20240516121432943" src="https://i-blog.csdnimg.cn/blog_migrate/b140f0745174da56abffd0c099e0046e.png"/>
</p>
<h5>
<a id="23_256">
</a>
2.3、查看磁盘空间
</h5>
<pre><code class="prism language-bash"><span class="token comment">#查看 mysql_test 组中所有主机的磁盘空间</span>
ansible mysql_test <span class="token parameter variable">-m</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-a</span> <span class="token string">'df -h'</span>

<span class="token comment">#查看 web_test 组中所有主机的磁盘空间</span>
ansible web_test <span class="token parameter variable">-m</span> <span class="token builtin class-name">command</span> <span class="token parameter variable">-a</span> <span class="token string">'df -h'</span>
</code></pre>
<p>
<img alt="image-20240516115223289" src="https://i-blog.csdnimg.cn/blog_migrate/4c7a02fcc3f210b27757211e200cd67c.png"/>
</p>
<h4>
<a id="3shell_268">
</a>
3、shell 模块
</h4>
<blockquote>
<p>
shell 模块可以在远程主机上调用 shell 解释器运行命令，支持 shell 的各种功能，例如管道等。
</p>
</blockquote>
<h5>
<a id="31_272">
</a>
3.1、选项及参数
</h5>
<pre><code class="prism language-bash">ansible-doc <span class="token parameter variable">-s</span> <span class="token builtin class-name">command</span>
</code></pre>
<table>
<thead>
<tr>
<th align="center">
选项
</th>
<th align="center">
描述
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
chdir
</td>
<td align="center">
在执行命令前切换到此目录。
</td>
</tr>
<tr>
<td align="center">
cmd
</td>
<td align="center">
要执行的命令及其可选参数。
</td>
</tr>
<tr>
<td align="center">
creates
</td>
<td align="center">
当指定的文件已存在时，此步骤将不执行。
</td>
</tr>
<tr>
<td align="center">
executable
</td>
<td align="center">
更改用于执行命令的 shell。这需要 shell 可执行文件的绝对路径。
</td>
</tr>
<tr>
<td align="center">
free_form
</td>
<td align="center">
要执行的 Linux 指令，一般使用 Ansible 的-a 参数代替。
</td>
</tr>
<tr>
<td align="center">
removes
</td>
<td align="center">
当指定的文件存在时，此步骤将执行。
</td>
</tr>
<tr>
<td align="center">
stdin
</td>
<td align="center">
直接将指定的值设置为命令的 stdin。
</td>
</tr>
<tr>
<td align="center">
stdin_add_newline
</td>
<td align="center">
是否在 stdin 数据末尾添加换行符。
</td>
</tr>
<tr>
<td align="center">
warn
</td>
<td align="center">
是否启用任务警告。
</td>
</tr>
</tbody>
</table>
<h5>
<a id="32_290">
</a>
3.2、检查远程主机的系统版本
</h5>
<pre><code class="prism language-bash"><span class="token comment">#查看 mysql_test 组远程主机的系统版本</span>
ansible mysql_test <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">'cat /etc/os-release | grep PRETTY_NAME | cut -d "=" -f2'</span>

<span class="token comment">#查看 web_test 组远程主机的系统版本</span>
ansible web_test <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">'cat /etc/os-release | grep PRETTY_NAME | cut -d "=" -f2'</span>
</code></pre>
<p>
<img alt="image-20240516204041385" src="https://i-blog.csdnimg.cn/blog_migrate/aada73ffabdfa05282688f175448fcbe.png"/>
</p>
<h5>
<a id="33_302">
</a>
3.3、查看远程主机防火墙状态
</h5>
<pre><code class="prism language-bash"><span class="token comment">#查看 mysql_test 组中所有的主机防火墙 firewalld 和 selinux 的状态</span>
ansible mysql_test <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">'systemctl status firewalld ; getenforce'</span>
</code></pre>
<blockquote>
<p>
这里验证了
<code>
command
</code>
模块不能使用命令别名、管道、重定向以及逻辑运算符（如
<code>
;
</code>
,
<code>
&amp;&amp;
</code>
,
<code>
||
</code>
）
</p>
<p>
由于
<code>
command
</code>
模块直接将整个字符串传递给系统执行，分号
<code>
;
</code>
以及随后的
<code>
getenforce
</code>
命令被视为命令的一部分，而不是独立的指令。这导致系统尝试查找名为类似
<code>
\x3b.service
</code>
（分号
<code>
;
</code>
的 ASCII 转义序列）的服务状态，以及尝试将
<code>
getenforce
</code>
当作一个服务单元来查找，由于这两个都不是有效的服务单元名称，因此返回了错误信息。
</p>
</blockquote>
<p>
<img alt="image-20240516210703587" src="https://i-blog.csdnimg.cn/blog_migrate/aecb79f6d267be2f1efec4abc31c0883.png"/>
</p>
<h5>
<a id="34_315">
</a>
3.4、创建、查看指定目录
</h5>
<pre><code class="prism language-bash"><span class="token comment">#在 mysql_test 组下的主机循环创建/root/tmp_1/NOW+当前时间的目录</span>
ansible mysql_test <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"mkdir -p /root/tmp_1/NOW-<span class="token variable"><span class="token variable">$(</span><span class="token function">date</span> +<span class="token string">'%H:%M:%S'</span><span class="token variable">)</span></span>"</span>

<span class="token comment">#find 查找是否正确创建</span>
ansible mysql_test <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"find /root/tmp_1 -mmin -5"</span>
</code></pre>
<p>
<img alt="image-20240516221926779" src="https://i-blog.csdnimg.cn/blog_migrate/5eaf3cdc949ea13e0c0f4b404adaf2a7.png"/>
</p>
<h4>
<a id="4user_327">
</a>
4、user 模块
</h4>
<blockquote>
<p>
主要用于管理远程系统上的用户账户，包括创建、修改和删除用户。
</p>
<p>
它允许你设置用户的密码、shell、主目录、权限等属性
</p>
</blockquote>
<h5>
<a id="41_333">
</a>
4.1、选项及描述
</h5>
<pre><code class="prism language-bash">ansible-doc <span class="token parameter variable">-s</span> user
</code></pre>
<table>
<thead>
<tr>
<th align="center">
选项
</th>
<th align="center">
描述
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
comment
</td>
<td align="center">
用户的描述信息
</td>
</tr>
<tr>
<td align="center">
createhom
</td>
<td align="center">
是否创建家目录
</td>
</tr>
<tr>
<td align="center">
force
</td>
<td align="center">
在使用 state=absent 时, 行为与 userdel –force 一致
</td>
</tr>
<tr>
<td align="center">
group
</td>
<td align="center">
指定基本组
</td>
</tr>
<tr>
<td align="center">
groups
</td>
<td align="center">
指定附加组，如果指定为(groups=)表示删除所有组
</td>
</tr>
<tr>
<td align="center">
home
</td>
<td align="center">
指定用户家目录
</td>
</tr>
<tr>
<td align="center">
move_home
</td>
<td align="center">
如果设置为 home=时, 试图将用户主目录移动到指定的目录
</td>
</tr>
<tr>
<td align="center">
name
</td>
<td align="center">
指定用户名
</td>
</tr>
<tr>
<td align="center">
non_unique
</td>
<td align="center">
该选项允许改变非唯一的用户 ID 值
</td>
</tr>
<tr>
<td align="center">
password
</td>
<td align="center">
指定用户密码
</td>
</tr>
<tr>
<td align="center">
remove
</td>
<td align="center">
在使用 state=absent 时, 行为是与 userdel –remove 一致
</td>
</tr>
<tr>
<td align="center">
shell
</td>
<td align="center">
指定默认 shell
</td>
</tr>
<tr>
<td align="center">
state
</td>
<td align="center">
设置帐号状态，默认为 present 表示新建用户，指定值为 absent 表示删除
</td>
</tr>
<tr>
<td align="center">
system
</td>
<td align="center">
当创建一个用户，设置这个用户是系统用户。这个设置不能更改现有用户
</td>
</tr>
<tr>
<td align="center">
uid
</td>
<td align="center">
指定用户的 uid
</td>
</tr>
<tr>
<td align="center">
update_password
</td>
<td align="center">
更新用户密码
</td>
</tr>
<tr>
<td align="center">
expires
</td>
<td align="center">
指明密码的过期时间
</td>
</tr>
<tr>
<td align="center">
append
</td>
<td align="center">
添加一个新的组
</td>
</tr>
</tbody>
</table>
<h5>
<a id="42uid_360">
</a>
4.2、添加系统用户，指定 uid、家目录及注释
</h5>
<pre><code class="prism language-bash"><span class="token comment">#给 web_test 组中添加一个系统用户 zhangsan 家目录为/home/zhangsan，用户 id 为 111，注释信息为 hello zhangsan</span>
ansible web_test <span class="token parameter variable">-m</span> user <span class="token parameter variable">-a</span> <span class="token string">"system=yes name=zhangsan home=/home/zhangsan uid=111 comment='hello zhangsan'"</span>
</code></pre>
<p>
<img alt="image-20240516232453569" src="https://i-blog.csdnimg.cn/blog_migrate/a79c0f1a2e2a07cd5bcdee5250e3681d.png"/>
</p>
<h5>
<a id="43_369">
</a>
4.3、查看新创建的用户
</h5>
<pre><code class="prism language-bash"><span class="token comment">#id zhangsan 验证用户是否正确创建，使用 grep+awk 截取/etc/passwd 上关于 zhangsan 的注释信息</span>
ansible web_test <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">'id zhangsan ; grep ^zhangsan: /etc/passwd | awk -F ":" '</span><span class="token punctuation">\</span>'<span class="token string">'{print $5}'</span><span class="token punctuation">\</span>'<span class="token string">''</span>
</code></pre>
<p>
<img alt="image-20240516233345659" src="https://i-blog.csdnimg.cn/blog_migrate/e50a871f96c593335a02e589c79ce74a.png"/>
</p>
<h5>
<a id="44_378">
</a>
4.4、删除新创建的用户
</h5>
<pre><code class="prism language-bash"><span class="token comment">#删除用户 zhangsan</span>
ansible web_test <span class="token parameter variable">-m</span> user <span class="token parameter variable">-a</span> <span class="token string">"name=zhangsan state=absent remove=yes"</span>
</code></pre>
<p>
<img alt="image-20240516233919793" src="https://i-blog.csdnimg.cn/blog_migrate/f68ca2cdb92f60a0143df0e15054bd1e.png"/>
</p>
<h4>
<a id="5group_387">
</a>
5、group 模块
</h4>
<blockquote>
<p>
用于管理 Linux 系统中的用户组。
</p>
<p>
这个模块允许你添加或删除用户组，并且可以设置组 ID(GID)。
</p>
</blockquote>
<h5>
<a id="51_393">
</a>
5.1、选项及描述
</h5>
<pre><code class="prism language-bash">ansible-doc <span class="token parameter variable">-s</span> group
</code></pre>
<table>
<thead>
<tr>
<th align="center">
选项
</th>
<th align="center">
描述
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
gid
</td>
<td align="center">
用于设置用户组的 GID（组 ID）。
</td>
</tr>
<tr>
<td align="center">
local
</td>
<td align="center">
强制使用平台提供的本地命令替代品（如
<code>
lgroupadd
</code>
代替
<code>
groupadd
</code>
），适用于需要操作本地组的集中认证环境。此选项要求目标主机上存在这些命令，否则会导致致命错误。
</td>
</tr>
<tr>
<td align="center">
name
</td>
<td align="center">
（必需）指定组的名称。
</td>
</tr>
<tr>
<td align="center">
non_unique
</td>
<td align="center">
允许将组 ID 更改为非唯一值。需要与
<code>
gid
</code>
一起使用。不支持 macOS 或 BusyBox 发行版。
</td>
</tr>
<tr>
<td align="center">
state
</td>
<td align="center">
指定用户组在远程主机上应有的状态，可以是
<code>
present
</code>
（存在）或
<code>
absent
</code>
（不存在）。
</td>
</tr>
<tr>
<td align="center">
system
</td>
<td align="center">
如果设置为
<code>
yes
</code>
，表示创建的用户组是系统组。
</td>
</tr>
</tbody>
</table>
<h5>
<a id="52_408">
</a>
5.2、创建或更新组
</h5>
<pre><code class="prism language-bash"><span class="token comment">#在 web_test 组的所有主机上创建一个系统组 web_test，组 id 为 1010</span>
ansible web_test <span class="token parameter variable">-m</span> group <span class="token parameter variable">-a</span> <span class="token string">"name=web_test gid=1010 system=yes"</span>

<span class="token comment">#通过/etc/group 查看系统组 web_test 信息</span>
</code></pre>
<p>
<img alt="image-20240517084145750" src="https://i-blog.csdnimg.cn/blog_migrate/0f09162d54b518ae1d00d2db28bca7f9.png"/>
</p>
<h5>
<a id="53_419">
</a>
5.3、删除组
</h5>
<pre><code class="prism language-bash"><span class="token comment">#删除 web_test 组所有主机上的系统组 web_test</span>
ansible web_test <span class="token parameter variable">-m</span> group <span class="token parameter variable">-a</span> <span class="token string">"name=web_test gid=1010 state=absent"</span>
</code></pre>
<p>
<img alt="image-20240517084723135" src="https://i-blog.csdnimg.cn/blog_migrate/e99361f8b5ede9569a4914e005585c3c.png"/>
</p>
<h4>
<a id="6copy_428">
</a>
6、copy 模块
</h4>
<blockquote>
<p>
用于将本地文件或目录复制到远程主机上
</p>
<p>
支持文件、目录、权限、用户组功能
</p>
</blockquote>
<h5>
<a id="61_434">
</a>
6.1、选项及描述
</h5>
<pre><code class="prism language-bash">ansible-doc <span class="token parameter variable">-s</span> copy
</code></pre>
<table>
<thead>
<tr>
<th align="center">
选项
</th>
<th align="center">
描述
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
backup
</td>
<td align="center">
在覆盖之前，将源文件备份，备份文件包含时间信息。
</td>
</tr>
<tr>
<td align="center">
content
</td>
<td align="center">
用于替代“src”，可以直接设定指定文件的值
</td>
</tr>
<tr>
<td align="center">
dest
</td>
<td align="center">
必选项。要将源文件复制到的远程主机的绝对路径
</td>
</tr>
<tr>
<td align="center">
directory_mode
</td>
<td align="center">
递归设定目录的权限，默认为系统默认权限
</td>
</tr>
<tr>
<td align="center">
force
</td>
<td align="center">
当目标主机包含该文件，但内容不同时，设为"yes"，表示强制覆盖；设为"no"，表示目标主机的目标位置不存在该文件才复制。默认为"yes"
</td>
</tr>
<tr>
<td align="center">
follow
</td>
<td align="center">
支持 link 文件拷贝
</td>
</tr>
<tr>
<td align="center">
others
</td>
<td align="center">
所有 file 模块里的选项都可以在这里使用
</td>
</tr>
<tr>
<td align="center">
src
</td>
<td align="center">
被复制到远程主机的本地文件。可以是绝对路径，也可以是相对路径。如果路径是一个目录，则会递归复制，用法类似于"rsync"
</td>
</tr>
</tbody>
</table>
<h5>
<a id="62_451">
</a>
6.2、给定内容生成文件，并修改权限信息
</h5>
<pre><code class="prism language-bash"><span class="token comment">#将 copy 内容为 copy test 复制到 node3 主机的/root/copy.txt 并设置权限 666</span>
ansible node3 <span class="token parameter variable">-m</span> copy <span class="token parameter variable">-a</span> <span class="token string">'content="copy test" dest=/root/copy.txt mode=666'</span>
</code></pre>
<p>
<img alt="image-20240517092416076" src="https://i-blog.csdnimg.cn/blog_migrate/a777745cd0e1f0584c7d8be135498f9e.png"/>
</p>
<h5>
<a id="63_460">
</a>
6.3、修改文件内容，选择覆盖备份
</h5>
<pre><code class="prism language-bash"><span class="token comment">#修改 node3 主机上 copy.txt 文件内容，并选择备份</span>
ansible node3 <span class="token parameter variable">-m</span> copy <span class="token parameter variable">-a</span> <span class="token string">'content="copy test_1\n" backup=yes dest=/root/copy.txt mode=666'</span>
</code></pre>
<p>
<img alt="image-20240517093301639" src="https://i-blog.csdnimg.cn/blog_migrate/a1aa87a2cbddd42308c8ff3c3a2270bf.png"/>
</p>
<h4>
<a id="7fetch_469">
</a>
7、fetch 模块
</h4>
<blockquote>
<p>
Ansible 的
<code>
fetch
</code>
模块用于从远程节点抓取文件并存储到 Ansible 控制器（执行 Ansible 任务的机器）上的指定目录
</p>
</blockquote>
<h5>
<a id="71_473">
</a>
7.1、选项及描述
</h5>
<pre><code class="prism language-bash">ansible-doc <span class="token parameter variable">-s</span> fetch
</code></pre>
<table>
<thead>
<tr>
<th align="center">
选项
</th>
<th align="center">
描述
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
dest
</td>
<td align="center">
必选项，用来存放文件的目录
</td>
</tr>
<tr>
<td align="center">
src
</td>
<td align="center">
必选项，在远程拉取的文件，并且必须是一个
<strong>
file
</strong>
，不能是
<strong>
目录
</strong>
</td>
</tr>
<tr>
<td align="center">
flat
</td>
<td align="center">
当设置为
<code>
yes
</code>
时，即使
<code>
src
</code>
是一个目录，也会将所有内容扁平化存储到指定的
<code>
dest
</code>
目录下，而不是保留目录结构。（ 默认
<code>
no
</code>
）
</td>
</tr>
<tr>
<td align="center">
validate_checksum
</td>
<td align="center">
当设置为
<code>
yes
</code>
时，在下载完成后校验文件的校验和，确保文件完整无误。这可以用来防止因网络问题导致的文件损坏。（默认
<code>
no
</code>
）
</td>
</tr>
<tr>
<td align="center">
fail_on_missing
</td>
<td align="center">
当设置为
<code>
yes
</code>
时，如果远程文件不存在，则标记任务失败，否则只是简单地跳过该文件。（默认
<code>
no
</code>
）
</td>
</tr>
<tr>
<td align="center">
size
</td>
<td align="center">
限制要抓取的文件大小，可以使用后缀如
<code>
k
</code>
、
<code>
M
</code>
、
<code>
G
</code>
来指定单位（千字节、兆字节、吉字节）。如果远程文件超过指定大小，抓取操作将不会执行。
</td>
</tr>
<tr>
<td align="center">
timeout
</td>
<td align="center">
设置超时时间（秒），用于等待文件传输完成。默认情况下，Ansible 使用其内部的连接超时设置。
</td>
</tr>
<tr>
<td align="center">
force
</td>
<td align="center">
即使本地文件已经存在，也强制重新抓取。如果设置为
<code>
no
</code>
，则只有当远程文件比本地文件新或不同才执行抓取。（默认
<code>
yes
</code>
）
</td>
</tr>
<tr>
<td align="center">
unarchive
</td>
<td align="center">
如果
<code>
src
</code>
是指向一个归档文件（如.zip 或.tar.gz），并且设置了此选项为
<code>
yes
</code>
，Ansible 将在抓取后尝试解压该归档文件。（默认
<code>
no
</code>
）
</td>
</tr>
<tr>
<td align="center">
list_files
</td>
<td align="center">
当设置为
<code>
yes
</code>
时，模块将只列出远程目录下的文件而不实际抓取它们，可用于预览目的。（默认
<code>
no
</code>
）
</td>
</tr>
</tbody>
</table>
<h5>
<a id="72_492">
</a>
7.2、从远程主机抓取文件
</h5>
<pre><code class="prism language-bash"><span class="token comment">#从 mysql_test 组的主机中抓取 aliyun.sh 文件到本机的/tmp/data 目录下</span>
ansible mysql_test <span class="token parameter variable">-m</span> fetch <span class="token parameter variable">-a</span> <span class="token string">"src=/root/aliyun.sh dest=/tmp/data"</span>

<span class="token comment">#通过检查/tmp/data 下的目录结构可知文件已完整获取</span>
ansible manager <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"tree -L 5 /tmp/data"</span>
</code></pre>
<p>
<img alt="image-20240518153051479" src="https://i-blog.csdnimg.cn/blog_migrate/8f7c5ebeda6ffa464a63313dde5725f5.png"/>
</p>
<h5>
<a id="73_504">
</a>
7.3、限制抓取文件的大小、添加文件存在检测
</h5>
<pre><code class="prism language-bash"><span class="token comment">#从 mysql_test 组的主机中抓取 install.sh 文件，限制最大抓取大小 20kb，传输中校验文件完整性，添加文件存在检测（不存在任务失败）</span>
ansible mysql_test <span class="token parameter variable">-m</span> fetch <span class="token parameter variable">-a</span> <span class="token string">"src=/root/install.sh dest=/tmp/data/ verify_checksum=yes fail_on_missing=yes size=20k"</span>
</code></pre>
<p>
<img alt="image-20240518154431410" src="https://i-blog.csdnimg.cn/blog_migrate/5a11a007083d361b18c915ae7a633171.png"/>
</p>
<h4>
<a id="8file_513">
</a>
8、file 模块
</h4>
<blockquote>
<p>
file 模块主要用于对文件的创建、删除、修改、权限、属性
</p>
</blockquote>
<h5>
<a id="81_517">
</a>
8.1、选项及描述
</h5>
<pre><code class="prism language-bash">ansible-doc <span class="token parameter variable">-s</span> <span class="token function">file</span>
</code></pre>
<table>
<thead>
<tr>
<th align="center">
选项
</th>
<th align="center">
描述
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
path
</td>
<td align="center">
必选项，定义文件/目录的路径
</td>
</tr>
<tr>
<td align="center">
mode
</td>
<td align="center">
定义文件/目录的权限
</td>
</tr>
<tr>
<td align="center">
force
</td>
<td align="center">
需要在两种情况下强制创建软链接，一种是源文件不存在，但之后会建立的情况下；另一种是目标软链接已存在，需要先取消之前的软链，然后创建新的软链，有两个选项：yes
</td>
</tr>
<tr>
<td align="center">
group
</td>
<td align="center">
定义文件/目录的属组，后面可以加上
<code>
mode
</code>
：定义文件/目录的权限
</td>
</tr>
<tr>
<td align="center">
owner
</td>
<td align="center">
定义文件/目录的属主。后面必须跟上
<code>
path
</code>
：定义文件/目录的路径
</td>
</tr>
<tr>
<td align="center">
recurse
</td>
<td align="center">
递归设置文件的属性，只对目录有效，后面跟上
<code>
src
</code>
：被链接的源文件路径，只应用于
<code>
state=link
</code>
的情况
</td>
</tr>
<tr>
<td align="center">
dest
</td>
<td align="center">
被链接到的路径，只应用于
<code>
state=link
</code>
的情况
</td>
</tr>
<tr>
<td align="center">
src
</td>
<td align="center">
被链接的源文件路径，只应用于 state=link 的情况
</td>
</tr>
<tr>
<td align="center">
state
</td>
<td align="center">
状态，有以下选项：
<code>
directory
</code>
、
<code>
file
</code>
、
<code>
link
</code>
、
<code>
hard
</code>
、
<code>
touch
</code>
、
<code>
absent
</code>
</td>
</tr>
</tbody>
</table>
<h5>
<a id="82_535">
</a>
8.2、在指定路径下创建目录
</h5>
<pre><code class="prism language-bash"><span class="token comment">#在 mysql_test 组所有主机在/tmp/路径下创建权限都是只读、属主属组都是 root 的 file1 目录</span>
ansible mysql_test <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/tmp/file1 mode=444 owner=root group=root state=directory"</span>

<span class="token comment">#查看创建好的目录</span>
ansible mysql_test <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"ls -l /tmp/ | grep file1"</span>
</code></pre>
<p>
<img alt="image-20240517104101964" src="https://i-blog.csdnimg.cn/blog_migrate/130172e983c3a4679fc38f80866db49c.png"/>
</p>
<h5>
<a id="83_547">
</a>
8.3、创建软链接文件
</h5>
<pre><code class="prism language-bash"><span class="token comment">#给 mysql_test 组的所有主机创建软链接文件 test1 指向/root/aliyun.sh</span>
ansible mysql_test <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/tmp/test1 src=/root/aliyun.sh state=link"</span>
</code></pre>
<p>
<img alt="image-20240517135611145" src="https://i-blog.csdnimg.cn/blog_migrate/6c5d238f4c4ce7e1d7626c3ad2d252a7.png"/>
</p>
<h5>
<a id="84_556">
</a>
8.4、创建硬链接文件
</h5>
<pre><code class="prism language-bash"><span class="token comment">#给 mysql_test 组的所有主机创建硬链接文件 test1 指向/root/aliyun.sh</span>
ansible mysql_test <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/tmp/test2 src=/root/aliyun.sh state=hard"</span>
</code></pre>
<p>
<img alt="image-20240517140146609" src="https://i-blog.csdnimg.cn/blog_migrate/b45df0a59a06537ccda1cc9ac34648cb.png"/>
</p>
<h5>
<a id="85_565">
</a>
8.5、删除文件
</h5>
<pre><code class="prism language-bash"><span class="token comment">#删除 mysql_test 组中所有主机/tmp/目录下 test1</span>
ansible mysql_test <span class="token parameter variable">-m</span> <span class="token function">file</span> <span class="token parameter variable">-a</span> <span class="token string">"path=/tmp/test1 state=absent"</span>
</code></pre>
<p>
<img alt="image-20240517141327165" src="https://i-blog.csdnimg.cn/blog_migrate/6917cf86d68b52958c2d9ba632d7c94c.png"/>
</p>
<h4>
<a id="9yum_574">
</a>
9、yum 模块
</h4>
<blockquote>
<p>
主要用于在基于 RPM 的 Linux 系统上管理软件包。
</p>
<p>
它允许用户安装、更新、卸载软件包，并可配置额外的选项以控制操作的具体行为。
</p>
</blockquote>
<h5>
<a id="91_580">
</a>
9.1、选项及描述
</h5>
<pre><code>ansible-doc -s yum
</code></pre>
<table>
<thead>
<tr>
<th align="center">
选项
</th>
<th align="center">
描述
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
name
</td>
<td align="center">
必选项，所安装的包的名称
</td>
</tr>
<tr>
<td align="center">
state
</td>
<td align="center">
安装-&gt; present ； 安装最新版本的-&gt; latest ；absent-&gt; 卸载包
</td>
</tr>
<tr>
<td align="center">
update_cache
</td>
<td align="center">
强制更新 yum 的缓存
</td>
</tr>
<tr>
<td align="center">
conf_file
</td>
<td align="center">
指定远程 yum 安装时所依赖的配置文件（安装本地已有的包）。
</td>
</tr>
<tr>
<td align="center">
disable_pgp_check
</td>
<td align="center">
是否禁止 GPG checking，只用于
<code>
present
</code>
or
<code>
latest
</code>
。
</td>
</tr>
<tr>
<td align="center">
disablerepo
</td>
<td align="center">
临时禁止使用 yum 库。 只用于安装或更新时。
</td>
</tr>
<tr>
<td align="center">
enablerepo
</td>
<td align="center">
临时使用的 yum 库。只用于安装或更新时。
</td>
</tr>
<tr>
<td align="center">
skip_borken
</td>
<td align="center">
跳过异常软件节点
</td>
</tr>
<tr>
<td align="center">
autoremove
</td>
<td align="center">
当设置为
<code>
yes
</code>
且状态为
<code>
absent
</code>
时，自动移除不再被任何已安装包依赖的包。
</td>
</tr>
</tbody>
</table>
<h5>
<a id="92httpd_598">
</a>
9.2、安装 httpd 服务
</h5>
<pre><code class="prism language-bash"><span class="token comment">#给 web_test 组的所有主机安装 httpd 服务</span>
ansible web_test <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">"name=httpd state=present"</span>

<span class="token comment">#远程启动 httpd 服务</span>
ansible web_test <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"systemctl start httpd"</span>

<span class="token comment">#远程查看 http 服务进程</span>
ansible web_test <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"ps aux | grep httpd"</span>

<span class="token comment">#远程停止 httpd 服务</span>
ansible web_test <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"systemctl stop httpd"</span>

<span class="token comment">#远程卸载 httpd 服务</span>
ansible web_test <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">"name=httpd state=absent"</span>
</code></pre>
<table>
<thead>
<tr>
<th align="center">
安装
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
<img alt="image-20240518102615952" src="https://i-blog.csdnimg.cn/blog_migrate/58cb509cf451f1c63e88331bd4af45d9.png"/>
</td>
</tr>
<tr>
<td align="center">
查看进程
</td>
</tr>
<tr>
<td align="center">
<img alt="image-20240518102905585" src="https://i-blog.csdnimg.cn/blog_migrate/88a9dcd7ac88285c285440fed4380cb2.png"/>
</td>
</tr>
<tr>
<td align="center">
卸载
</td>
</tr>
<tr>
<td align="center">
<img alt="image-20240518102701842" src="https://i-blog.csdnimg.cn/blog_migrate/cef873ddaefc1d46f38fe4bf3654a6f7.png"/>
</td>
</tr>
</tbody>
</table>
<h5>
<a id="93_625">
</a>
9.3、更新所有的软件包
</h5>
<pre><code class="prism language-bash"><span class="token comment">#给所有主机更新所有的软件包</span>
ansible all-servers <span class="token parameter variable">-m</span> yum <span class="token parameter variable">-a</span> <span class="token string">"name=_ state=latest"</span>
</code></pre>
<p>
<img alt="image-20240518110821977" src="https://i-blog.csdnimg.cn/blog_migrate/6a4fc2fc25a9ff8297560c310b1ac74c.png"/>
</p>
<h4>
<a id="10cron_634">
</a>
10、cron 模块
</h4>
<blockquote>
<p>
用于添加、删除、更新操作系统的 Crontab 计划任务
</p>
</blockquote>
<h5>
<a id="101_638">
</a>
10.1、选项及描述
</h5>
<pre><code class="prism language-bash">ansible-doc <span class="token parameter variable">-s</span> <span class="token function">cron</span>
</code></pre>
<table>
<thead>
<tr>
<th align="center">
选项
</th>
<th align="center">
描述
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
backup
</td>
<td align="center">
如果设置，会在修改 crontab 前创建备份。备份文件的位置通过
<code>
backup_file
</code>
变量返回。
</td>
</tr>
<tr>
<td align="center">
cron_file
</td>
<td align="center">
如果指定，将使用此文件而非用户个人的 crontab。如果是相对路径，则相对于
<code>
/etc/cron.d/
</code>
。绝对路径通常为
<code>
/etc/crontab
</code>
。为了使用
<code>
cron_file
</code>
参数，必须同时指定
<code>
user
</code>
。
</td>
</tr>
<tr>
<td align="center">
day
</td>
<td align="center">
任务应运行的月份中的日期 (1-31, _, _/2, 等)。
</td>
</tr>
<tr>
<td align="center">
disabled
</td>
<td align="center">
如果任务应在 crontab 中被禁用（注释掉）。仅当
<code>
state=present
</code>
时有效。
</td>
</tr>
<tr>
<td align="center">
env
</td>
<td align="center">
如果设置，管理 crontab 的环境变量。新变量会被添加到 crontab 的顶部。
<code>
name
</code>
和
<code>
value
</code>
参数分别为环境变量的名称和值。
</td>
</tr>
<tr>
<td align="center">
hour
</td>
<td align="center">
任务应运行的小时 (0-23, _, _/2, 等)。
</td>
</tr>
<tr>
<td align="center">
insertafter
</td>
<td align="center">
与
<code>
state=present
</code>
和
<code>
env
</code>
一起使用。如果指定，环境变量将在指定环境变量声明之后插入。
</td>
</tr>
<tr>
<td align="center">
insertbefore
</td>
<td align="center">
与
<code>
state=present
</code>
和
<code>
env
</code>
一起使用。如果指定，环境变量将在指定环境变量声明之前插入。
</td>
</tr>
<tr>
<td align="center">
job
</td>
<td align="center">
要执行的命令，或者如果设置了
<code>
env
</code>
，则是环境变量的值。命令不应包含换行符。当
<code>
state=present
</code>
时必需。
</td>
</tr>
<tr>
<td align="center">
minute
</td>
<td align="center">
任务应运行的分钟 (0-59, _, _/2, 等)。
</td>
</tr>
<tr>
<td align="center">
month
</td>
<td align="center">
任务应运行的年份中的月份 (1-12, _, _/2, 等)。
</td>
</tr>
<tr>
<td align="center">
name
</td>
<td align="center">
crontab 条目的描述，或者如果设置了
<code>
env
</code>
，则是环境变量的名称。当
<code>
state=absent
</code>
时必需。注意，如果不设置 name，且
<code>
state=present
</code>
，则总是会创建新的 crontab 条目，不管已有条目如何。此参数在未来的版本中将始终是必需的。
</td>
</tr>
<tr>
<td align="center">
special_time
</td>
<td align="center">
特殊的时间范围，参数：reboot（重启时），annually（每年），monthly（每月），weekly（每周），daily（每天），hourly（每小时）
</td>
</tr>
<tr>
<td align="center">
state
</td>
<td align="center">
确保任务或环境变量存在或不存在的状态。
</td>
</tr>
<tr>
<td align="center">
user
</td>
<td align="center">
应修改其 crontab 的具体用户。未设置时，默认为使用
<code>
root
</code>
。
</td>
</tr>
<tr>
<td align="center">
weekday
</td>
<td align="center">
任务应运行的星期几 (0-6 表示周日-周六，_, 等)。
</td>
</tr>
</tbody>
</table>
<h5>
<a id="102_663">
</a>
10.2、添加计划任务
</h5>
<pre><code class="prism language-bash"><span class="token comment">#给 mysql_test 组中的所有主机添加一个以 root 用户每天三点执行/root/aliyun.sh 脚本的计划任务</span>
ansible mysql_test <span class="token parameter variable">-m</span> <span class="token function">cron</span> <span class="token parameter variable">-a</span> <span class="token string">"name='Daily Task' minute=0 hour=3 job='/root/aliyun.sh &amp;&gt; /dev/null' user=root"</span>
</code></pre>
<p>
<img alt="image-20240518162626709" src="https://i-blog.csdnimg.cn/blog_migrate/28141f41ef699c044ab89c00beb7e3fc.png"/>
</p>
<h5>
<a id="103_672">
</a>
10.3、删除指定计划任务
</h5>
<pre><code class="prism language-bash"><span class="token comment">#删除名为 Daily Task 的计划任务（没有明确的计划任务名称写完整的计划任务也可以删除）</span>
ansible mysql_test <span class="token parameter variable">-m</span> <span class="token function">cron</span> <span class="token parameter variable">-a</span> <span class="token string">"name='Daily Task' state=absent"</span>
</code></pre>
<p>
<img alt="image-20240518163214996" src="https://i-blog.csdnimg.cn/blog_migrate/c94bb60f05f6e3f731d79151389385ac.png"/>
</p>
<h4>
<a id="11service_681">
</a>
11、service 模块
</h4>
<blockquote>
<p>
Ansible 的
<code>
service
</code>
模块用于管理系统服务（如启动、停止、重启服务等）。
</p>
<p>
这个模块与特定的系统服务管理工具（如 systemd、sysvinit、upstart 等）兼容，能够跨不同的 Linux 发行版和系统管理框架工作
</p>
</blockquote>
<h5>
<a id="111_687">
</a>
11.1、选项及描述
</h5>
<pre><code class="prism language-bash">ansible-doc <span class="token parameter variable">-s</span> <span class="token function">service</span>
</code></pre>
<table>
<thead>
<tr>
<th align="center">
选项
</th>
<th align="center">
描述
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
arguments
</td>
<td align="center">
额外的命令行参数，提供给服务管理命令。
</td>
</tr>
<tr>
<td align="center">
enabled
</td>
<td align="center">
服务是否应该在系统启动时自动启动。至少需要指定
<code>
state
</code>
或
<code>
enabled
</code>
中的一个。
</td>
</tr>
<tr>
<td align="center">
name
</td>
<td align="center">
（必需）服务的名称。
</td>
</tr>
<tr>
<td align="center">
pattern
</td>
<td align="center">
如果服务不响应状态查询命令，可以指定一个子字符串作为查找依据，该子字符串应能在
<code>
ps
</code>
命令的输出中找到，作为服务状态的替代判断。如果找到该字符串，服务将被认为已启动。
</td>
</tr>
<tr>
<td align="center">
runlevel
</td>
<td align="center">
仅针对 OpenRC 初始化脚本（如 Gentoo）使用。指定该服务属于哪个运行级别。
</td>
</tr>
<tr>
<td align="center">
sleep
</td>
<td align="center">
当服务处于
<code>
restarted
</code>
状态时，停止与启动命令之间暂停的秒数。有助于解决那些在发出停止信号后立即退出的不良行为初始化脚本问题。并非所有服务管理器都支持此设置，例如使用 systemd 时，此设置会被忽略。
</td>
</tr>
<tr>
<td align="center">
state
</td>
<td align="center">
有四种状态，分别为：
<code>
started
</code>
—&gt;启动服务，
<code>
stopped
</code>
—&gt;停止服务，
<code>
restarted
</code>
—&gt;重启服务，
<code>
reloaded
</code>
—&gt;重载配置
</td>
</tr>
<tr>
<td align="center">
use
</td>
<td align="center">
服务模块通常通过自动检测使用系统特定的模块，此设置可以强制使用特定模块。默认情况下，它使用
<code>
ansible_service_mgr
</code>
事实的值，并且在找不到匹配项时回退到旧的
<code>
service
</code>
模块。
</td>
</tr>
</tbody>
</table>
<h5>
<a id="112_704">
</a>
11.2、远程开启/关闭防火墙
</h5>
<pre><code class="prism language-bash"><span class="token comment">#给 web_test 组中的所有主机重启 firewalld 服务</span>
ansible web_test <span class="token parameter variable">-m</span> <span class="token function">service</span> <span class="token parameter variable">-a</span> <span class="token string">"name=firewalld state=restarted"</span>

<span class="token comment">#查看 web_test 组中所有主机的 firewalld 服务运行状态</span>
ansible web_test <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"systemctl status firewalld"</span>

<span class="token comment">#给 web_test 组中的所有主机关闭 firewalld 服务</span>
ansible web_test <span class="token parameter variable">-m</span> <span class="token function">service</span> <span class="token parameter variable">-a</span> <span class="token string">"name=firewalld state=stopped"</span>
</code></pre>
<table>
<thead>
<tr>
<th align="center">
开启 firewalld 服务
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
<img alt="image-20240518165922943" src="https://i-blog.csdnimg.cn/blog_migrate/a6d385e021635eb8943887a21f373549.png"/>
</td>
</tr>
<tr>
<td align="center">
查看 firewalld 服务状态
</td>
</tr>
<tr>
<td align="center">
<img alt="image-20240518170027529" src="https://i-blog.csdnimg.cn/blog_migrate/1548ed2e73d281c518c8573178111558.png"/>
</td>
</tr>
<tr>
<td align="center">
关闭 firewalld 服务
</td>
</tr>
<tr>
<td align="center">
<img alt="image-20240518170142857" src="https://i-blog.csdnimg.cn/blog_migrate/6f869ae499cab614c6f28c929d95fb9e.png"/>
</td>
</tr>
</tbody>
</table>
<h4>
<a id="12script_725">
</a>
12、script 模块
</h4>
<blockquote>
<p>
Ansible 的
<code>
script
</code>
模块允许你在远程主机上执行位于 Ansible 控制节点上的本地脚本
</p>
</blockquote>
<h5>
<a id="121_729">
</a>
12.1、选项及描述
</h5>
<pre><code class="prism language-bash">ansible-doc <span class="token parameter variable">-s</span> script
</code></pre>
<table>
<thead>
<tr>
<th align="center">
选项
</th>
<th align="center">
描述
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
chdir
</td>
<td align="center">
在远程节点上执行脚本之前切换到的目录路径。
</td>
</tr>
<tr>
<td align="center">
cmd
</td>
<td align="center">
要在远程节点上运行的本地脚本的路径，后面可以跟上可选的参数。注意，这个选项与
<code>
free_form
</code>
二选一使用。
</td>
</tr>
<tr>
<td align="center">
creates
</td>
<td align="center">
指定远程节点上的一个文件名，如果该文件已存在，则此步骤将
<strong>
不
</strong>
执行，可用于防止重复执行脚本。
</td>
</tr>
<tr>
<td align="center">
decrypt
</td>
<td align="center">
控制是否自动解密使用 Vault 加密的源文件。
</td>
</tr>
<tr>
<td align="center">
executable
</td>
<td align="center">
用于调用脚本的可执行文件的名称或路径，例如如果脚本是 Python 脚本，可以设置为
<code>
/usr/bin/python
</code>
。
</td>
</tr>
<tr>
<td align="center">
free_form
</td>
<td align="center">
直接提供本地脚本文件的路径以及可选的参数，与
<code>
cmd
</code>
选项作用相似但格式不同，两者选其一使用。
</td>
</tr>
<tr>
<td align="center">
removes
</td>
<td align="center">
指定远程节点上的一个文件名，如果该文件不存在，则此步骤将
<strong>
不
</strong>
执行，可以作为执行脚本的另一个条件。
</td>
</tr>
</tbody>
</table>
<h5>
<a id="122_745">
</a>
12.2、编辑并部署脚本
</h5>
<h6>
<a id="1_747">
</a>
1、控制节点本地编辑脚本并添加执行权限
</h6>
<pre><code class="prism language-bash"><span class="token function">vim</span> /tmp/df.sh

<span class="token comment">#!/bin/bash</span>
<span class="token function">date</span> <span class="token operator">&gt;&gt;</span> /tmp/data/df.log
<span class="token function">df</span> <span class="token parameter variable">-lh</span> <span class="token operator">&gt;&gt;</span> /tmp/data/df.log
<span class="token punctuation">[</span>root@server ~<span class="token punctuation">]</span><span class="token comment"># chmod +x /tmp/df.sh</span>
</code></pre>
<p>
<img alt="image-20240518173032713" src="https://i-blog.csdnimg.cn/blog_migrate/e41c93ee341af6b676ee77874ba8a692.png"/>
</p>
<h6>
<a id="2script_760">
</a>
2、通过 script 模块部署到远程主机执行
</h6>
<pre><code class="prism language-bash"><span class="token comment">#给 web_test 组的所有主机执行控制节点上的 df.sh 脚本文件</span>
ansible web_test <span class="token parameter variable">-m</span> script <span class="token parameter variable">-a</span> "/tmp/df.sh”
</code></pre>
<p>
<img alt="image-20240518173943581" src="https://i-blog.csdnimg.cn/blog_migrate/dce01741ff7a234d26bfd2efc04eaa8a.png"/>
</p>
<h4>
<a id="13setup_769">
</a>
13、setup 模块
</h4>
<blockquote>
<p>
Ansible 的
<code>
setup
</code>
模块用于收集远程主机的信息，并将这些信息以 facts 的形式返回给 Ansible 控制节点。
</p>
<p>
这些 facts 可以包括系统变量（如操作系统类型、架构、网络配置、已安装软件包等），并且在 Playbook 执行期间可以被其他任务使用。
</p>
</blockquote>
<h5>
<a id="131_775">
</a>
13.1、选项及描述
</h5>
<pre><code class="prism language-bash">ansible-doc <span class="token parameter variable">-s</span> setup
</code></pre>
<table>
<thead>
<tr>
<th align="center">
选项
</th>
<th align="center">
描述
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
fact_path
</td>
<td align="center">
用于存放本地 Ansible 事实（
<code>
*.fact
</code>
文件）的路径。此目录下的文件如果可执行，将被执行，其结果会被添加到
<code>
ansible_local
</code>
事实中；如果文件不可执行，则会被读取。适用于从 2.1 版本开始。文件/结果格式可以是 JSON 或 INI 格式。默认的
<code>
fact_path
</code>
可以在
<code>
ansible.cfg
</code>
中为自动调用
<code>
setup
</code>
作为
<code>
gather_facts
</code>
一部分时指定。Windows 环境下有特定选项，请查看注释。
</td>
</tr>
<tr>
<td align="center">
filter
</td>
<td align="center">
如果提供，仅返回匹配此 shell 风格（fnmatch 通配符）的变量。这允许筛选出特定的 facts 进行查看或使用。
</td>
</tr>
<tr>
<td align="center">
gather_subset
</td>
<td align="center">
如果提供，限制收集的额外事实子集。可能的值包括：
<code>
all
</code>
（全部）、
<code>
min
</code>
（最小集合）、
<code>
hardware
</code>
（硬件信息）、
<code>
network
</code>
（网络信息）、
<code>
virtual
</code>
（虚拟化信息）、
<code>
ohai
</code>
（类似 Chef Ohai 的扩展信息）、
<code>
facter
</code>
（使用 Facter 收集的信息）。可以指定值的列表来定义更大的子集。值前可加
<code>
!
</code>
来排除特定子集的收集，例如：
<code>
!hardware,!network,!virtual,!ohai,!facter
</code>
。如果指定
<code>
!all
</code>
，则只收集最小集合。要避免收集最小集合，可以指定
<code>
!all,!min
</code>
。要仅收集特定事实，使用
<code>
!all,!min
</code>
并指定特定的事实子集。如果只想隐藏某些收集到的事实，使用
<code>
filter
</code>
参数。
</td>
</tr>
<tr>
<td align="center">
gather_timeout
</td>
<td align="center">
设置单个事实收集的默认超时时间（以秒为单位）。这有助于控制事实收集过程，避免因个别慢速收集导致整个任务超时。
</td>
</tr>
</tbody>
</table>
<h5>
<a id="132_788">
</a>
13.2、查看内存信息
</h5>
<pre><code class="prism language-bash"><span class="token comment">#查看 mysql_test 组所有主机的内存信息</span>
ansible mysql_test <span class="token parameter variable">-m</span> setup <span class="token parameter variable">-a</span> <span class="token string">"filter='*mem*'"</span>
</code></pre>
<p>
<img alt="image-20240518180334853" src="https://i-blog.csdnimg.cn/blog_migrate/ce9b767a0f0051cc4af7f8200a8a96ac.png"/>
</p>
<h6>
<a id="free_m_797">
</a>
通过 free -m 命令查看内存大小是否一致
</h6>
<pre><code class="prism language-bash"><span class="token comment">#通过 free -m 命令查看 mysql_test 组主机的内存信息</span>
ansible mysql_test <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"free -m"</span>
</code></pre>
<p>
<img alt="image-20240518180649443" src="https://i-blog.csdnimg.cn/blog_migrate/21b4bc0b808971ee8f9347c04a5bf44d.png"/>
</p>
<h5>
<a id="133_806">
</a>
13.3、保存信息
</h5>
<pre><code class="prism language-bash"><span class="token comment">#将筛选的信息保存到控制节点的/tmp/data 目录下</span>
ansible web <span class="token parameter variable">-m</span> setup <span class="token parameter variable">-a</span> <span class="token string">'filter="*mem\*"'</span> <span class="token parameter variable">--tree</span> /tmp/data
</code></pre>
<p>
<img alt="image-20240518181607518" src="https://i-blog.csdnimg.cn/blog_migrate/65ce84bea5ab3ee3144432f4f2b27012.png"/>
</p>
<h4>
<a id="14synchronize_815">
</a>
14、synchronize 模块
</h4>
<blockquote>
<p>
Ansible 的
<code>
synchronize
</code>
模块提供了使用 rsync 进行文件和目录同步的功能。
</p>
<p>
rsync 是一个快速且高效的文件传输工具，支持增量更新，特别适合在远程主机之间同步大量文件或保持文件夹内容的一致性。
</p>
</blockquote>
<h5>
<a id="141_821">
</a>
14.1、选项及描述
</h5>
<pre><code class="prism language-bash">ansible-doc synchronize
</code></pre>
<table>
<thead>
<tr>
<th align="center">
选项
</th>
<th align="center">
描述
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
archive
</td>
<td align="center">
镜像 rsync 的归档标志，启用递归、链接、权限、时间戳、所有者、组标志及-D。默认开启。
</td>
</tr>
<tr>
<td align="center">
checksum
</td>
<td align="center">
基于校验和而非修改时间和大小来跳过同步，注意“archive”选项默认仍启用，"checksum"选项不会禁用它。默认关闭。从 1.6 版本起可用。
</td>
</tr>
<tr>
<td align="center">
compress
</td>
<td align="center">
在传输过程中压缩文件数据。大多数情况下应保持启用状态，除非引起问题。默认开启。从 1.7 版本起可用。
</td>
</tr>
<tr>
<td align="center">
copy_links
</td>
<td align="center">
将符号链接作为它们指向的对象（被链接项）复制，而不是复制符号链接本身。默认关闭。
</td>
</tr>
<tr>
<td align="center">
delete
</td>
<td align="center">
删除目标路径中不存在于源路径的文件（在传输之后，不是之前）。此选项要求
<code>
recursive=yes
</code>
。表现得像 rsync 的
<code>
--delete-excluded
</code>
选项，忽略被排除的文件。默认关闭。
</td>
</tr>
<tr>
<td align="center">
dest
</td>
<td align="center">
同步的目的地主机路径，将从源路径同步而来。路径可以是绝对或相对的。此选项是必须的。
</td>
</tr>
<tr>
<td align="center">
dest_port
</td>
<td align="center">
目标主机 SSH 端口。在 Ansible 2.0 之前，ansible_ssh_port 库存变量优先于这个值。此参数默认为
<code>
ansible_ssh_port
</code>
或
<code>
ansible_port
</code>
的值、
<code>
remote_port
</code>
配置设置的值，或如果没有设置前者，则使用 SSH 客户端配置的值。从 1.5 版本起可用。
</td>
</tr>
<tr>
<td align="center">
dirs
</td>
<td align="center">
仅传输目录而不递归进入。默认关闭。
</td>
</tr>
<tr>
<td align="center">
existing_only
</td>
<td align="center">
跳过在接收端创建新文件。默认关闭。从 1.5 版本起可用。
</td>
</tr>
<tr>
<td align="center">
group
</td>
<td align="center">
保留组信息。默认值取决于 archive 选项。
</td>
</tr>
<tr>
<td align="center">
link_dest
</td>
<td align="center">
添加一个硬链接目标，在 rsync 期间与之关联。默认为无。从 2.5 版本起可用。
</td>
</tr>
<tr>
<td align="center">
links
</td>
<td align="center">
作为符号链接复制符号链接。默认值取决于 archive 选项。
</td>
</tr>
<tr>
<td align="center">
mode
</td>
<td align="center">
指定同步的方向。推模式下，本地主机或代理是源；拉模式下，上下文中的远程主机是源。（可选值：pull, push）默认为 push。
</td>
</tr>
<tr>
<td align="center">
owner
</td>
<td align="center">
保留所有者（仅超级用户）。默认值取决于 archive 选项。
</td>
</tr>
<tr>
<td align="center">
partial
</td>
<td align="center">
告诉 rsync 保留部分文件，这应该会使后续传输文件剩余部分快得多。默认关闭。从 2.0 版本起可用。
</td>
</tr>
<tr>
<td align="center">
perms
</td>
<td align="center">
保留权限信息。默认值取决于 archive 选项。
</td>
</tr>
<tr>
<td align="center">
private_key
</td>
<td align="center">
为基于 SSH 的 rsync 连接指定私钥（如
<code>
~/.ssh/id_rsa
</code>
）。默认为无。从 1.6 版本起可用。
</td>
</tr>
<tr>
<td align="center">
recursive
</td>
<td align="center">
递归进入目录。默认值取决于 archive 选项。
</td>
</tr>
<tr>
<td align="center">
rsync_opts
</td>
<td align="center">
通过传递数组来指定额外的 rsync 选项。注意，
<code>
rsync_opts
</code>
中的空字符串最终会传输当前工作目录。默认为无。从 1.6 版本起可用。
</td>
</tr>
<tr>
<td align="center">
rsync_path
</td>
<td align="center">
指定在远程主机上运行的 rsync 命令。参见 rsync 手册页上的
<code>
--rsync-path
</code>
。要指定在本地主机上运行的 rsync 命令，你需要设置任务变量
<code>
ansible_rsync_path
</code>
。默认为无。
</td>
</tr>
<tr>
<td align="center">
rsync_timeout
</td>
<td align="center">
为 rsync 命令指定一个超时时间（秒）。默认为 0。
</td>
</tr>
<tr>
<td align="center">
set_remote_user
</td>
<td align="center">
为远程路径添加 user@。如果你有自定义的 ssh 配置来为与库存用户不匹配的主机定义远程用户，应将此参数设为
<code>
no
</code>
。默认为 True。
</td>
</tr>
<tr>
<td align="center">
src
</td>
<td align="center">
源主机上的路径，将同步到目的地。路径可以是绝对或相对的。此选项是必须的。
</td>
</tr>
<tr>
<td align="center">
times
</td>
<td align="center">
保留修改时间。默认值取决于 archive 选项。
</td>
</tr>
<tr>
<td align="center">
use_ssh_args
</td>
<td align="center">
使用 ansible.cfg 中指定的 ssh_args。默认关闭。从 2.0 版本起可用。
</td>
</tr>
<tr>
<td align="center">
verify_host
</td>
<td align="center">
验证目标主机密钥。默认关闭。从 2.0 版本起可用。
</td>
</tr>
</tbody>
</table>
<h5>
<a id="142_856">
</a>
14.2、将源目录同步至目标目录（增量同步）
</h5>
<pre><code class="prism language-bash"><span class="token comment">#既然是基于 rsync 那么所有主机安装 rsync</span>
ansible all-servers <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"yum install -y rsync"</span>

<span class="token comment">#将本地的/tmp/目录同步到 node1 组的 host1 主机上</span>
ansible node1 <span class="token parameter variable">-m</span> synchronize <span class="token parameter variable">-a</span> <span class="token string">"src=/tmp/ dest=/tmp/"</span>

<span class="token comment">#查看 node1 组的 host1 主机的/tmp/目录结构</span>
ansible node1 <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"tree -L 5 /tmp/"</span>
</code></pre>
<table>
<thead>
<tr>
<th align="center">
所有主机安装 rsync
</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">
<img alt="image-20240518202630013" src="https://i-blog.csdnimg.cn/blog_migrate/bbddae3feac169680f7a6a4c5826a606.png"/>
</td>
</tr>
<tr>
<td align="center">
同步本地/tmp/到 host1 主机上
</td>
</tr>
<tr>
<td align="center">
<img alt="image-20240518202725638" src="https://i-blog.csdnimg.cn/blog_migrate/38caf1ef16ea449cd5ae7b09c8f8e9c9.png"/>
</td>
</tr>
<tr>
<td align="center">
查看目录结构
</td>
</tr>
<tr>
<td align="center">
<img alt="image-20240518202919470" src="https://i-blog.csdnimg.cn/blog_migrate/7f60f3a2392eedf24815a2e0a6d50c4d.png"/>
</td>
</tr>
</tbody>
</table>
<h5>
<a id="143_877">
</a>
14.3、将源目录同步至目标目录（完全同步）
</h5>
<pre><code class="prism language-bash"><span class="token comment">#删除目标路径中不存在于源路径的文件（在传输之后）</span>
ansible node1 <span class="token parameter variable">-m</span> synchronize <span class="token parameter variable">-a</span> <span class="token string">"src=/tmp/ dest=/tmp/ delete=yes"</span>
</code></pre>
<h3>
<a id="Ansible_playbook_884">
</a>
五、Ansible playbook
</h3>
<h4>
<a id="1_886">
</a>
1、简介
</h4>
<p>
Ansible Playbook 是 Ansible 用于定义和执行自动化任务的配置、部署和编排的主要方式。它是一种使用 YAML 语言编写的剧本文件，允许用户以简洁、可读性强的方式描述一系列步骤，这些步骤可以跨多台主机执行，以实现系统的配置管理和应用程序部署。
</p>
<p>
playbook 是由一个或者多个 play 组成的列表，可以让这些列表按事先编排的机制执行；所谓 task 是调用 ansible 的具体模块，在模块参数中可以使用变量。模块执行是幂等性的，意味着多次执行结果相同。使用 yaml 语言编写 playbook，后缀名一般为.yml
</p>
<h4>
<a id="2playbookYAML_892">
</a>
2、playbook 的 YAML 格式
</h4>
<ul>
<li>
文件的第一行应该以 “—” (三个连字符)开始，表明 YMAL 文件的开始。
</li>
<li>
在同一行中，#之后的内容表示注释，类似于 shell，python 和 ruby。
</li>
<li>
YMAL 中的列表元素以”-”开头然后紧跟着一个空格，后面为元素内容。
</li>
<li>
同一个列表中的元素应该保持相同的缩进。否则会被当做错误处理。
</li>
<li>
play 中 hosts，variables，roles，tasks 等对象的表示方法都是键值中间以":“分隔表示，”:"后面还要增加一个空格。
</li>
<li>
缩进：使用空格缩进（而非 Tab），通常使用 2 个空格
</li>
</ul>
<h5>
<a id="21_901">
</a>
2.1、示例：
</h5>
<pre><code class="prism language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> update web servers
<span class="token key atrule">hosts</span><span class="token punctuation">:</span> node1
<span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root

<span class="token key atrule">tasks</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure apache is at the latest version
<span class="token key atrule">yum</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> httpd
<span class="token key atrule">state</span><span class="token punctuation">:</span> latest
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> write the apache config file
<span class="token key atrule">template</span><span class="token punctuation">:</span>
<span class="token key atrule">src</span><span class="token punctuation">:</span> /srv/httpd.j2
<span class="token key atrule">dest</span><span class="token punctuation">:</span> /etc/httpd.conf
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure that htppd is started
<span class="token key atrule">service</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> httpd
<span class="token key atrule">state</span><span class="token punctuation">:</span> started
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> update db servers
<span class="token key atrule">hosts</span><span class="token punctuation">:</span> node1
<span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root

<span class="token key atrule">tasks</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure mariadb is at the latest version
<span class="token key atrule">yum</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> mariadb<span class="token punctuation">-</span>server
<span class="token key atrule">state</span><span class="token punctuation">:</span> latest
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure that mariadb is started
<span class="token key atrule">service</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> mariadb
<span class="token key atrule">state</span><span class="token punctuation">:</span> started
</code></pre>
<h5>
<a id="22_937">
</a>
2.2、解析
</h5>
<p>
<strong>
Play 1: 更新 Web 服务器
</strong>
</p>
<ul>
<li>
<strong>
Play 标题
</strong>
：“update web servers”，表明本 Play 的目标是更新 Web 服务器配置。
</li>
<li>
<strong>
hosts
</strong>
：
<code>
node1
</code>
，指定该 Play 作用于名为
<code>
node1
</code>
的主机。
</li>
<li>
<strong>
remote_user
</strong>
：
<code>
root
</code>
，指定执行任务的远程用户为 root。
</li>
<li>
<strong>
tasks
</strong>
：
<ul>
<li>
<strong>
task 1
</strong>
: 确保 Apache 是最新的版本。使用
<code>
yum
</code>
模块安装
<code>
httpd
</code>
包至最新版。
</li>
<li>
<strong>
task 2
</strong>
: 写入 Apache 配置文件。使用
<code>
template
</code>
模块将模板文件
<code>
/srv/httpd.j2
</code>
渲染后复制到
<code>
/etc/httpd.conf
</code>
，允许动态配置生成。
</li>
<li>
<strong>
task 3
</strong>
: 确保 Apache 服务已启动。使用
<code>
service
</code>
模块设置
<code>
httpd
</code>
服务的状态为
<code>
started
</code>
，如果服务未运行则启动。
</li>
</ul>
</li>
</ul>
<p>
<strong>
Play 2: 更新数据库服务器
</strong>
</p>
<ul>
<li>
<strong>
Play 标题
</strong>
：“update db servers”，目标是更新数据库服务器配置。
</li>
<li>
<strong>
hosts
</strong>
：同样为
<code>
node1
</code>
，指定该 Play 作用于名为
<code>
node1
</code>
的主机。
</li>
<li>
<strong>
remote_user
</strong>
：
<code>
root
</code>
，指定执行任务的远程用户为 root。
</li>
<li>
<strong>
tasks
</strong>
：
<ul>
<li>
<strong>
task 1
</strong>
: 确保 MariaDB 是最新的版本。使用
<code>
yum
</code>
模块安装
<code>
mariadb-server
</code>
至最新版。
</li>
<li>
<strong>
task 2
</strong>
: 确保 MariaDB 服务已启动。使用
<code>
service
</code>
模块设置
<code>
mariadb
</code>
服务的状态为
<code>
started
</code>
。
</li>
</ul>
</li>
</ul>
<h4>
<a id="3playbook_958">
</a>
3、playbook 的执行与语法检查
</h4>
<pre><code class="prism language-bash"><span class="token comment">#执行 playbook</span>
ansible-playbook playbook.yml

<span class="token comment">#语法检查</span>
ansible-playbook --syntax-check playbook.yml
</code></pre>
<h4>
<a id="4playbook_968">
</a>
4、playbook 的核心元素
</h4>
<ol>
<li>
<strong>
Hosts（主机组）
</strong>
：定义了 Playbook 将要操作的目标机器集合。可以是单个主机名、IP 地址，也可以是主机组名。
</li>
<li>
<strong>
Tasks（任务列表）
</strong>
：构成 Play 的主要部分，定义了在目标主机上执行的具体操作序列。每个任务通常关联一个特定的 Ansible 模块及参数。
</li>
<li>
<strong>
Variables（变量）
</strong>
：用于在 Playbook 中传递和管理配置信息，支持多种设置方式（如直接赋值、变量文件、环境变量、角色默认变量等），增加了 Playbook 的灵活性和可重用性。
</li>
<li>
<strong>
Templates（模板）
</strong>
：使用 Jinja2 模板引擎动态生成配置文件。允许根据变量插入动态内容，适用于需要根据不同环境定制配置的情况。
</li>
<li>
<strong>
Handlers（处理程序）
</strong>
：特殊类型的任务，仅当被其他任务通过
<code>
notify
</code>
属性明确告知时才会执行。常用于服务重启等需要在特定条件满足时进行的操作。
</li>
</ol>
<h4>
<a id="5_976">
</a>
5、基本组件及格式
</h4>
<ul>
<li>
<p>
<strong>
remote_user
</strong>
：指定执行 Ansible 任务的远程用户名。
</p>
</li>
<li>
<p>
<strong>
sudo_user
</strong>
：定义需要临时提升权限执行任务时的目标用户。
</p>
</li>
<li>
<p>
<strong>
Tasks 格式
</strong>
：
</p>
<pre><code class="prism language-yaml"><span class="token key atrule">tasks</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 简短任务描述
<span class="token key atrule">module</span><span class="token punctuation">:</span> 模块名称
<span class="token key atrule">arguments</span><span class="token punctuation">:</span> 参数列表
<span class="token key atrule">notify</span><span class="token punctuation">:</span> 通知的处理程序名称（可选）
</code></pre>
</li>
<li>
<p>
<strong>
Handlers 格式
</strong>
：
</p>
<pre><code class="prism language-yaml"><span class="token key atrule">handlers</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> 处理程序描述
<span class="token key atrule">module</span><span class="token punctuation">:</span> 模块名称
<span class="token key atrule">arguments</span><span class="token punctuation">:</span> 参数列表
</code></pre>
<ul>
<li>
<strong>
Handlers 触发条件
</strong>
：
<ul>
<li>
当某任务状态变为
<code>
changed
</code>
时，可以触发一个或多个预先定义好的处理程序。
</li>
<li>
使用
<code>
tags
</code>
为任务和处理程序打标签，可以在执行 Playbook 时通过
<code>
--tags
</code>
或
<code>
-t
</code>
选项选择性地执行带有特定标签的任务。
</li>
</ul>
</li>
</ul>
</li>
<li>
<p>
<strong>
模块与模块参数
</strong>
：Ansible 通过各种模块执行具体操作，模块后跟随的是该模块接受的参数。对于
<code>
shell
</code>
和
<code>
command
</code>
这类直接执行系统命令的模块，参数直接是命令字符串，而不是键值对形式。
</p>
</li>
</ul>
<h4>
<a id="6nginx_1007">
</a>
6、安装 nginx 并修改配置文件
</h4>
<h5>
<a id="61_1009">
</a>
6.1、准备文件存放目录
</h5>
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server ~<span class="token punctuation">]</span><span class="token comment"># mkdir -p /root/ansible/{conf,bin}</span>
</code></pre>
<h5>
<a id="62yaml_1015">
</a>
6.2、编写 yaml 文件
</h5>
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@server ~<span class="token punctuation">]</span><span class="token comment"># cd ansible/bin/</span>
<span class="token punctuation">[</span>root@server bin<span class="token punctuation">]</span><span class="token comment"># cat nginx.yml</span>

<span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Update web servers
<span class="token key atrule">hosts</span><span class="token punctuation">:</span> node1
<span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
<span class="token key atrule">tasks</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install epel
<span class="token key atrule">yum</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> epel<span class="token punctuation">-</span>release.noarch
<span class="token key atrule">state</span><span class="token punctuation">:</span> latest
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install nginx
<span class="token key atrule">yum</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">state</span><span class="token punctuation">:</span> present
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Copy nginx configure file
<span class="token key atrule">copy</span><span class="token punctuation">:</span>
<span class="token key atrule">src</span><span class="token punctuation">:</span> /root/ansible/conf/nginx.conf
<span class="token key atrule">dest</span><span class="token punctuation">:</span> /etc/nginx/nginx.conf
<span class="token key atrule">backup</span><span class="token punctuation">:</span> yes
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Start nginx
<span class="token key atrule">service</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">state</span><span class="token punctuation">:</span> restarted
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Create index.html
<span class="token key atrule">shell</span><span class="token punctuation">:</span> echo "hello playbook_nginx" <span class="token punctuation">&gt;</span> /usr/share/nginx/html/index.html
</code></pre>
<h5>
<a id="63conf_1047">
</a>
6.3、编写 conf 文件
</h5>
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server conf<span class="token punctuation">]</span><span class="token comment"># cat site.conf</span>

events <span class="token punctuation">{<!-- --></span>
worker_connections <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

http <span class="token punctuation">{<!-- --></span>
server <span class="token punctuation">{<!-- --></span>
listen <span class="token number">8080</span><span class="token punctuation">;</span>
server_name <span class="token number">192.168</span>.112.20:8080<span class="token punctuation">;</span>

        location / <span class="token punctuation">{<!-- --></span>
            index index.html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<h5>
<a id="64playbook_1068">
</a>
6.4、检查语法错误，执行 playbook
</h5>
<pre><code class="prism language-bash"><span class="token comment">#语法检查</span>
ansible-playbook nginx.yml --syntax-check

<span class="token comment">#执行 playbook</span>
ansible-playbook nginx.yml
</code></pre>
<p>
<img alt="image-20240519071818027" src="https://i-blog.csdnimg.cn/blog_migrate/bffaf47d933cc2ea6c172dee3268c4eb.png"/>
</p>
<h5>
<a id="65nginx_1080">
</a>
6.5、验证 nginx 启动状态
</h5>
<pre><code class="prism language-bash"><span class="token comment">#ps aux|grep nginx 显示 nginx 的进程，curl -s 查看实际的响应体内容</span>
ansible node2 <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"ps aux | grep nginx ; curl -s 192.168.112.30:8080"</span>
</code></pre>
<p>
<img alt="image-20240519073818831" src="https://i-blog.csdnimg.cn/blog_migrate/84c4c06e0424231ecc5f9ed6ccd0c96c.png"/>
</p>
<h4>
<a id="7nginxhandlersnotify_1089">
</a>
7、安装 nginx，并添加 handlers 和 notify
</h4>
<h5>
<a id="71nginxymlnginxconf_1091">
</a>
7.1、修改对应的 nginx.yml 和 nginx.conf 文件
</h5>
<blockquote>
<p>
nginx2.yml
</p>
</blockquote>
<pre><code class="prism language-yaml"><span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Update web servers
<span class="token key atrule">hosts</span><span class="token punctuation">:</span> node2
<span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
<span class="token key atrule">tasks</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install epel
<span class="token key atrule">yum</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> epel<span class="token punctuation">-</span>release.noarch
<span class="token key atrule">state</span><span class="token punctuation">:</span> latest
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Install nginx
<span class="token key atrule">yum</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">state</span><span class="token punctuation">:</span> present
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Copy nginx configure file
<span class="token key atrule">copy</span><span class="token punctuation">:</span>
<span class="token key atrule">src</span><span class="token punctuation">:</span> /root/ansible/conf/nginx2.conf
<span class="token key atrule">dest</span><span class="token punctuation">:</span> /etc/nginx/nginx2.conf
<span class="token key atrule">backup</span><span class="token punctuation">:</span> yes
<span class="token key atrule">notify</span><span class="token punctuation">:</span> reload <span class="token comment">#当 nginx.conf 发生改变时，通知给相应的 handlers</span>
<span class="token key atrule">tags</span><span class="token punctuation">:</span> reloadnginx <span class="token comment">#打标签</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Start nginx
<span class="token key atrule">service</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">state</span><span class="token punctuation">:</span> restarted
<span class="token key atrule">tags</span><span class="token punctuation">:</span> startnginx <span class="token comment">#打标签</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Create index.html
<span class="token key atrule">shell</span><span class="token punctuation">:</span> echo "hello playbook_nginx_2" <span class="token punctuation">&gt;</span> /usr/share/nginx/html/index.html
<span class="token key atrule">handlers</span><span class="token punctuation">:</span> <span class="token comment">#注意，前面没有-，是两个空格</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> reload
<span class="token key atrule">service</span><span class="token punctuation">:</span>
<span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
<span class="token key atrule">state</span><span class="token punctuation">:</span> restarted
</code></pre>
<blockquote>
<p>
nginx2.conf
</p>
</blockquote>
<pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@server conf<span class="token punctuation">]</span><span class="token comment"># cat nginx2.conf</span>

events <span class="token punctuation">{<!-- --></span>
worker_connections 1024;
<span class="token punctuation">}</span>

http <span class="token punctuation">{<!-- --></span>
server <span class="token punctuation">{<!-- --></span>
listen 8080;
server_name 192.168.112.30<span class="token punctuation">:</span>8080;

        location / <span class="token punctuation">{<!-- --></span>
            index index.html;
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<h5>
<a id="72nginx_1151">
</a>
7.2、验证 nginx 进程信息
</h5>
<pre><code class="prism language-bash"><span class="token comment">#验证端口和响应内容</span>
ansible node2 <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"ss -tunlp | grep nginx ; curl -s 192.168.112.30:8080"</span>
</code></pre>
<p>
<img alt="image-20240519075156982" src="https://i-blog.csdnimg.cn/blog_migrate/471809e4c3013f8b2c946bb1e099364a.png"/>
</p>
<h5>
<a id="73_1160">
</a>
7.3、测试标签
</h5>
<pre><code class="prism language-bash"><span class="token comment">#先关闭 node3 上的 nginx 服务以便测试</span>
ansible node3 <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"systemctl stop nginx"</span>

<span class="token comment">#再运行剧本并引用标签 startnginx</span>
ansible-playbook nginx2.yml <span class="token parameter variable">-t</span> startnginx
</code></pre>
<p>
<img alt="image-20240519000329240" src="https://i-blog.csdnimg.cn/blog_migrate/91c0e7545e8c276714b35ac7b408b094.png"/>
</p>
<h5>
<a id="74notify_1172">
</a>
7.4、测试 notify
</h5>
<h6>
<a id="741notify_1174">
</a>
7.4.1、notify 的触发条件是配置文件被改变
</h6>
<pre><code class="prism language-bash"><span class="token comment">#修改监听的端口号</span>
<span class="token punctuation">[</span>root@server conf<span class="token punctuation">]</span><span class="token comment"># cat nginx2.conf</span>

events <span class="token punctuation">{<!-- --></span>
worker_connections <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

http <span class="token punctuation">{<!-- --></span>
server <span class="token punctuation">{<!-- --></span>
listen <span class="token number">8848</span><span class="token punctuation">;</span>
server_name <span class="token number">192.168</span>.112.30:8080<span class="token punctuation">;</span>

        location / <span class="token punctuation">{<!-- --></span>
            index index.html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
<p>
<img alt="image-20240519075419174" src="https://i-blog.csdnimg.cn/blog_migrate/22a59191ebad344131d2fbdf2c12ceeb.png"/>
</p>
<h6>
<a id="742_1198">
</a>
7.4.2、重新执行剧本
</h6>
<pre><code class="prism language-bash"><span class="token comment">#语法检查</span>
ansible-playbook nginx2.yml --syntax-check

<span class="token comment">#再运行剧本并引用标签 reloadnginx</span>
ansible-playbook nginx2.yml <span class="token parameter variable">-t</span> reloadnginx
</code></pre>
<p>
<img alt="image-20240519001410850" src="https://i-blog.csdnimg.cn/blog_migrate/5fb14945b015cb57723d7749b6ff2fb8.png"/>
</p>
<h6>
<a id="743_1210">
</a>
7.4.3、重新查看端口号
</h6>
<pre><code class="prism language-bash">ansible node2 <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"ss -tnulp | grep nginx"</span>
</code></pre>
<p>
<img alt="image-20240519075549066" src="https://i-blog.csdnimg.cn/blog_migrate/546a7d411d8b3cdb071f1051f8c1ce29.png"/>
</p>
<blockquote>
<p>
端口号变为 8848
</p>
</blockquote>
<h4>
<a id="8variables_1220">
</a>
8、变量（variables）
</h4>
<blockquote>
<p>
在 Ansible 剧本中，
<code>
vars
</code>
是用来定义变量的一个关键字，它允许你为任务、play 或整个剧本设定变量值。
</p>
<p>
这些变量可以在后续的任务中被引用，以提高剧本的灵活性和重用性。
</p>
</blockquote>
<h5>
<a id="81_1226">
</a>
8.1、定义变量的方式
</h5>
<h6>
<a id="1_FactsFacts_1228">
</a> 1. Facts（Facts 变量）
</h6>
<ul>
<li>
<p>
<strong>
描述
</strong>
：Facts 是 Ansible 自动收集的目标主机信息，如系统类型、网络配置等。它们不是直接定义的变量，而是通过执行
<code>
setup
</code>
模块获取的。尽管不能直接定义 Facts，但它们可以在剧本中像其他变量一样使用。
</p>
</li>
<li>
<p>
使用方式
</p>
<pre><code class="prism language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Display hostname using a fact
<span class="token key atrule">debug</span><span class="token punctuation">:</span>
<span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">"The hostname is {<!-- -->{ ansible_hostname }}"</span>
</code></pre>
</li>
<li>
<p>
查看所有可以使用的变量：
</p>
<pre><code class="prism language-bash">ansible node1 <span class="token parameter variable">-m</span> setup <span class="token operator">&gt;</span> variables
</code></pre>
</li>
</ul>
<h6>
<a id="2__1246">
</a> 2. 用户自定义变量
</h6>
<ul>
<li>
<p>
直接在 Playbook 中定义
</p>
<ul>
<li>
<p>
可以在 play 或 tasks 级别定义变量。
</p>
<pre><code class="prism language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">hosts</span><span class="token punctuation">:</span> web_test
<span class="token key atrule">vars</span><span class="token punctuation">:</span>
<span class="token key atrule">my_var</span><span class="token punctuation">:</span> <span class="token string">"Hello, World!"</span>
<span class="token key atrule">tasks</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Use playbook<span class="token punctuation">-</span>defined variable
<span class="token key atrule">debug</span><span class="token punctuation">:</span>
<span class="token key atrule">msg</span><span class="token punctuation">:</span> <span class="token string">"{<!-- -->{ my_var }}"</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p>
通过命令行参数(
<code>
-e
</code>
/
<code>
--extra-vars
</code>
)传入
</p>
<ul>
<li>
<p>
在运行 Ansible 命令时动态添加变量。
</p>
<pre><code class="prism language-bash">ansible-playbook my_playbook.yml <span class="token parameter variable">-e</span> <span class="token string">"my_var=ValueFromCommandLine"</span>
</code></pre>
</li>
</ul>
</li>
</ul>
<h6>
<a id="3_Roles_1270">
</a> 3. 通过 Roles 传递变量
</h6>
<ul>
<li>
<p>
简介：Roles 是 Ansible 组织和复用任务的一种方式。变量可以通过角色的
<code>
defaults
</code>
,
<code>
vars
</code>
,
<code>
environment
</code>
目录下的文件来定义，或者在角色的
<code>
tasks/main.yml
</code>
等文件中直接定义。
</p>
<ul>
<li>
<p>
例子：
</p>
<ul>
<li>
<p>
在
<code>
roles/my_role/defaults/main.yml
</code>
中定义：
</p>
<pre><code class="prism language-yaml"><span class="token key atrule">my_role_variable</span><span class="token punctuation">:</span> default_value
</code></pre>
</li>
<li>
<p>
然后在使用该角色的 playbook 中，该变量自动可用，也可被更高优先级的变量覆盖。
</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h6>
<a id="4_Host_Inventory_1284">
</a> 4. Host Inventory（主机清单）中定义变量
</h6>
<ul>
<li>
<p>
向不同主机传递不同变量
</p>
<pre><code class="prism language-bash"><span class="token punctuation">[</span>webservers<span class="token punctuation">]</span>
host1.example.com <span class="token assign-left variable">my_var</span><span class="token operator">=</span>value1
host2.example.com <span class="token assign-left variable">my_var</span><span class="token operator">=</span>value2
</code></pre>
</li>
<li>
<p>
向组中的所有主机传递相同变量
</p>
<pre><code class="prism language-bash"><span class="token punctuation">[</span>webservers:vars<span class="token punctuation">]</span>
<span class="token assign-left variable">group_variable</span><span class="token operator">=</span>value_for_all_hosts_in_group
</code></pre>
</li>
</ul>
<h5>
<a id="82_1301">
</a>
8.2、优先级
</h5>
<ol>
<li>
通过命令行指定变量优先级最高
</li>
<li>
/etc/ansible/hosts 定义变量（针对单个主机定义，针对主机组进行定义）
</li>
<li>
playbook 中定义的变量
</li>
</ol>
<h5>
<a id="83keepalived_1307">
</a>
8.3、案例：使用变量安装 keepalived
</h5>
<h6>
<a id="1_1309">
</a>
1、编写剧本
</h6>
<pre><code class="prism language-bash"><span class="token comment">#先复制一份</span>
<span class="token punctuation">[</span>root@server bin<span class="token punctuation">]</span><span class="token comment"># cp nginx2.yml keepalived.yml</span>

<span class="token comment">#再通过 vim 的替换将 nginx 替换为变量并优化一下 src 地址</span>
<span class="token punctuation">[</span>root@server bin<span class="token punctuation">]</span><span class="token comment"># cat keepalived.yml</span>

---

- name: Update web servers
  hosts: node2
  remote_user: root
  tasks:
  - name: Install epel
    yum:
    name: epel-release.noarch
    state: latest
  - name: Install <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span>
    yum:
    name: <span class="token string">"{<!-- -->{ rpmname }}"</span>
    state: present
  - name: Copy <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span> configure <span class="token function">file</span>
    copy:
    src: /root/ansible/conf/<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span>.conf
    dest: /etc/<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span>/<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span>.conf
    backup: <span class="token function">yes</span>
    notify: reload
    tags: reload<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span>
  - name: Start <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span>
    service:
    name: <span class="token string">"{<!-- -->{ rpmname }}"</span>
    state: restarted
    tags: start<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span>
    handlers: - name: reload
    service:
    name: <span class="token string">"{<!-- -->{ rpmname }}"</span>
    state: restarted
    </code></pre>
    <table>
    <thead>
    <tr>
    <th align="center">
    全局替换并添加确认动作
    </th>
    </tr>
    </thead>
    <tbody>
    <tr>
    <td align="center">
    <img alt="image-20240519085826481" src="https://i-blog.csdnimg.cn/blog_migrate/16df85947f53573de7a5ec01f443450a.png"/>
    </td>
    </tr>
    <tr>
    <td align="center">
    输入 y 确认替换
    </td>
    </tr>
    <tr>
    <td align="center">
    <img alt="image-20240519085933294" src="https://i-blog.csdnimg.cn/blog_migrate/ffca136cb0a5e046949ff410f95c0393.png"/>
    </td>
    </tr>
    <tr>
    <td align="center">
    替换好的剧本
    </td>
    </tr>
    <tr>
    <td align="center">
    <img alt="image-20240519091914865" src="https://i-blog.csdnimg.cn/blog_migrate/b4a91aab88fdf27e25a9bbd2e411414b.png"/>
    </td>
    </tr>
    </tbody>
    </table>
    <h6>
    <a id="2_1358">
    </a>
    2、拷贝配置文件
    </h6>
    <blockquote>
    <p>
    我们想要在被监管的机器上安装什么服务的话，就直接在我们的 server 端上把该服务的配置文件拷贝到我们定义剧本的
    <code>
    src
    </code>
    目录下。这样我们的剧本才能正常运行。
    </p>
    </blockquote>
    <pre><code class="prism language-bash"><span class="token function">cp</span> /etc/keepalived/keepalived.conf /root/ansible/conf/keepalived.conf
    </code></pre>
    <h6>
    <a id="3_1366">
    </a>
    3、运行剧本，变量由命令行传入
    </h6>
    <pre><code class="prism language-bash"><span class="token comment">#语法检查</span>
    ansible-playbook keepalived.yml --syntax-check

<span class="token comment">#执行剧本-e 接变量</span>
ansible-playbook keepalived.yml <span class="token parameter variable">-e</span> <span class="token assign-left variable">rpmname</span><span class="token operator">=</span>keepalived
</code></pre>
<p>
<img alt="image-20240519093852380" src="https://i-blog.csdnimg.cn/blog_migrate/a3f98c82a4673a52bdd3915ab23051d0.png"/>
</p>
<h6>
<a id="4_1378">
</a>
4、或者直接再剧本里定义变量
</h6>
<blockquote>
<p>
我们可以直接在剧本中把变量定义好，这样就不需要在通过命令行传入了。
</p>
<p>
以后想要安装不同的服务，直接在剧本里把变量修改一下即可。
</p>
</blockquote>
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server bin<span class="token punctuation">]</span><span class="token comment"># vim keepalived.yml</span>

---

- name: Update web servers
  hosts: node2
  remote_user: root
  vars: - rpmname: keepalived
  tasks:
  - name: Install epel
    yum:
    name: epel-release.noarch
    state: latest
  - name: Install <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span>
    yum:
    name: <span class="token string">"{<!-- -->{ rpmname }}"</span>
    state: present
  - name: Copy <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span> configure <span class="token function">file</span>
    copy:
    src: /root/ansible/conf/<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span>.conf
    dest: /etc/<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span>/<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span>.conf
    backup: <span class="token function">yes</span>
    notify: reload
    tags: reload<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span>
  - name: Start <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span>
    service:
    name: <span class="token string">"{<!-- -->{ rpmname }}"</span>
    state: restarted
    tags: start<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> rpmname <span class="token punctuation">}</span><span class="token punctuation">}</span>
    handlers: - name: reload
    service:
    name: <span class="token string">"{<!-- -->{ rpmname }}"</span>
    state: restarted
    </code></pre>
    <h6>
    <a id="5_1421">
    </a>
    5、运行定义过变量的剧本
    </h6>
    <pre><code class="prism language-bash"><span class="token comment">#语法检查</span>
    ansible-playbook keepalived.yml --syntax-check

<span class="token comment">#执行剧本</span>
ansible-playbook keepalived.yml
</code></pre>
<p>
<img alt="image-20240519094357159" src="https://i-blog.csdnimg.cn/blog_migrate/98822dd0fd3006a7707ecdad71bf568d.png"/>
</p>
<h4>
<a id="9templates_1433">
</a>
9、模板（templates）
</h4>
<h5>
<a id="91_1435">
</a>
9.1、简介
</h5>
<blockquote>
<p>
Templates 主要用于自动生成和管理服务器上的配置文件，如 nginx 的配置、数据库配置等。这有助于实现基础设施的配置标准化和自动化。
</p>
</blockquote>
<ul>
<li>
文本文件，内部嵌套有模板语言的脚本
</li>
<li>
jinja2 是由 python 编写的，在使用模板文件时 jinja2 是很好的解决方案
</li>
<li>
功能：将模板文件中的变量转换成对应的本地主机的确定值\
 </li>
</ul>
<h5>
<a id="92_1443">
</a>
9.2、基本数据类型和操作符
</h5>
<ul>
<li>
<strong>
字符串
</strong>
：在 Jinja2 模板中，无论是单引号还是双引号，都可以用来定义字符串。例如，
<code>
{
<!-- -->
{ "Hello, World!" }}
</code>
或
<code>
{
<!-- -->
{ 'Hello, World!' }}
</code>
。
</li>
<li>
<strong>
数字
</strong>
：Jinja2 直接支持整数和浮点数的使用，无需特别的标记，如
<code>
{
<!-- -->
{ 42 }}
</code>
或
<code>
{
<!-- -->
{ 3.14 }}
</code>
。
</li>
<li>
<strong>
列表(List)
</strong>
和
<strong>
元组(Tuple)
</strong>
：虽然 Jinja2 原生支持列表（使用方括号
<code>
[]
</code>
），但元组的直接表示不如 Python 中常见，因为模板更倾向于动态输出而不是静态结构。列表示例：
<code>
{% for item in [1, 2, 3] %}...{% endfor %}
</code>
。
</li>
<li>
<strong>
字典(Dictionary)
</strong>
：与 Python 类似，使用花括号
<code>
{}
</code>
定义，键值对之间用冒号
<code>
:
</code>
分隔。例如，
<code>
{
<!-- -->
{ {"key": "value", "another_key": 42} }}
</code>
。
</li>
<li>
<strong>
布尔型(Booleans)
</strong>
：在 Jinja2 中，可以直接使用
<code>
true
</code>
和
<code>
false
</code>
（全部小写），用于条件判断。
</li>
<li>
<strong>
算术运算
</strong>
：Jinja2 支持所有基本的算术运算符，包括
<code> +
</code>
,
<code> -
</code>
,
<code> \*
</code>
,
<code>
/
</code>
,
<code>
//
</code>
,
<code>
%
</code>
,
<code>
\*\*
</code>
。例如，
<code>
{
<!-- -->
{ 5 + 3 }}
</code>
或
<code>
{
<!-- -->
{ 10 // 2 }}
</code>
。
</li>
<li>
<strong>
比较操作
</strong>
：与 Python 相同，包括
<code>
==
</code>
,
<code>
!=
</code>
,
<code>
&gt;
</code>
,
<code>
&gt;=
</code>
,
<code>
&lt;
</code>
,
<code>
&lt;=
</code>
。用于条件判断，如
<code>
{% if variable &gt; 10 %}...{% endif %}
</code>
。
</li>
<li>
<strong>
逻辑运算
</strong>
：
<code>
and
</code>
,
<code>
or
</code>
,
<code>
not
</code>
用于逻辑条件组合。例如，
<code>
{% if condition1 and condition2 %}...{% endif %}
</code>
或
<code>
{% if not condition %}...{% endif %}
</code>
。
</li>
</ul>
<blockquote>
<p>
模板都是通过引用变量来引用的
</p>
</blockquote>
<h5>
<a id="93hosts_1456">
</a>
9.3、案例：生成 hosts 解析文件
</h5>
<blockquote>
<p>
使用模板替远程主机生成 hosts 解析文件(先把原来的 hosts 解析都去掉，在 ansible 配置文件里面替换为 ip)
</p>
</blockquote>
<h6>
<a id="1Ansible_1460">
</a>
1、修改 Ansible 主机清单
</h6>
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 ~<span class="token punctuation">]</span><span class="token comment"># egrep -v "^$|^#" /etc/ansible/hosts</span>
<span class="token punctuation">[</span>all-servers<span class="token punctuation">]</span>
server1
server2
server3
server4
<span class="token punctuation">[</span>all_ip<span class="token punctuation">]</span>
<span class="token number">192.168</span>.112.10
<span class="token number">192.168</span>.112.20
<span class="token number">192.168</span>.112.30
<span class="token number">192.168</span>.112.40
</code></pre>
<h6>
<a id="2_1476">
</a>
2、修改主机名
</h6>
<pre><code class="prism language-bash">hostnamectl set-hostname server1
hostnamectl set-hostname server2
hostnamectl set-hostname server3
hostnamectl set-hostname server4
</code></pre>
<h6>
<a id="3_1485">
</a>
3、准备模板文件
</h6>
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 ~<span class="token punctuation">]</span><span class="token comment"># vim hosts.j2</span>

<span class="token number">127.0</span>.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4
::1 localhost localhost.localdomain localhost6 localhost6.localdomain6

<span class="token punctuation">{<!-- --></span>% <span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> groups.all_ip %<span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>hostvars<span class="token punctuation">[</span>host<span class="token punctuation">]</span>.ansible_ens33.ipv4.address<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>hostvars<span class="token punctuation">[</span>host<span class="token punctuation">]</span>.ansible_hostname<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token punctuation">{<!-- --></span>% endfor %<span class="token punctuation">}</span>
</code></pre>
<h6>
<a id="4_1498">
</a>
4、编写剧本
</h6>
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 ~<span class="token punctuation">]</span><span class="token comment"># vim hosts.yml</span>

---

- name: Config hosts <span class="token function">file</span>
  hosts: all_ip
  remote_user: root

  tasks:

  - name: copy hosts.j2 to group servers
    template:
    src: hosts.j2
    dest: /etc/hosts
    </code></pre>
    <h6>
    <a id="5_1515">
    </a>
    5、执行剧本
    </h6>
    <pre><code class="prism language-bash">ansible-playbook hosts.yml --syntax-check
    ansible-playbook hosts.yml
    </code></pre>
    <p>
    <img alt="image-20240519103229272" src="https://i-blog.csdnimg.cn/blog_migrate/99420d2ba48f2caac8af1d9d7ec8fc7e.png"/>
    </p>
    <h6>
    <a id="6_1524">
    </a>
    6、验证
    </h6>
    <pre><code class="prism language-bash">ansible all-servers <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"tail -4 /etc/hosts"</span>
    </code></pre>
    <p>
    <img alt="image-20240519104459086" src="https://i-blog.csdnimg.cn/blog_migrate/bb776174e2ba24d78d082fadb904e1bf.png"/>
    </p>
    <h4>
    <a id="10_1532">
    </a>
    10、条件判断
    </h4>
    <blockquote>
    <p>
    when 语句：在 task 中使用，jinja2 的语法格式。
    </p>
    </blockquote>
    <h5>
    <a id="101_1536">
    </a>
    10.1、举例
    </h5>
    <pre><code class="prism language-bash">tasks:

- name: <span class="token function">install</span> conf <span class="token function">file</span> to centos7
  template: <span class="token assign-left variable">src</span><span class="token operator">=</span>files/nginx.conf.c7.j2
  when: ansible_distribution_major_version <span class="token operator">==</span> <span class="token string">"7"</span>
- name: <span class="token function">install</span> conf <span class="token function">file</span> to centos6
  template: <span class="token assign-left variable">src</span><span class="token operator">=</span>files/nginx.conf.c6.j2
  when: ansible_distribution_major_version <span class="token operator">==</span> <span class="token string">"6"</span>
  </code></pre>
  <h4>
  <a id="11_1548">
  </a>
  11、循环迭代
  </h4>
  <blockquote>
  <p>
  循环：迭代，需要重复执行的任务；
  <br/>
  对迭代项的引用，固定变量名为"item"，而后，要在 task 中使用 with_items 给定要迭代的元素列表；
  </p>
  </blockquote>
  <h5>
  <a id="111_1553">
  </a>
  11.1 举例
  </h5>
  <pre><code class="prism language-bash"><span class="token comment">#基于字符串列表</span>
  tasks:
  ‐ name: create rsyncd <span class="token function">file</span>
  copy: <span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token assign-left variable">dest</span><span class="token operator">=</span>/tmp/<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item <span class="token punctuation">}</span><span class="token punctuation">}</span>
  with_items:
  ‐ a
  ‐ b
  ‐ c
  ‐ d
  _with_itmes 嵌套子变量_
  <span class="token comment">#基于字典列表</span>
  ‐ hosts: eagleslab
  remote_user: root
  tasks:
  ‐ name: <span class="token function">add</span> several <span class="token function">users</span>
  user: <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item.name <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token assign-left variable">state</span><span class="token operator">=</span>present <span class="token assign-left variable">groups</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item.groups <span class="token punctuation">}</span><span class="token punctuation">}</span>
  with_items:
  ‐ <span class="token punctuation">{<!-- --></span> name: <span class="token string">'testuser1'</span> , groups: <span class="token string">'wheel'</span><span class="token punctuation">}</span>
  ‐ <span class="token punctuation">{<!-- --></span> name: <span class="token string">'testuser2'</span> , groups: <span class="token string">'root'</span> <span class="token punctuation">}</span>
  </code></pre>
  <h5>
  <a id="112_1577">
  </a>
  11.2、案例：循环创建用户
  </h5>
  <h6>
  <a id="1_1579">
  </a>
  1、循环创建以下用户信息
  </h6>
  <table>
  <thead>
  <tr>
  <th>
  zhangsan
  </th>
  <th>
  xsb
  </th>
  <th>
  /home/xsb/zhangsan
  </th>
  <th>
  /bin/bash
  </th>
  <th>
  销售
  </th>
  </tr>
  </thead>
  <tbody>
  <tr>
  <td>
  lisi
  </td>
  <td>
  xsb
  </td>
  <td>
  /home/xsb/lisi
  </td>
  <td>
  /bin/bash
  </td>
  <td>
  销售
  </td>
  </tr>
  <tr>
  <td>
  wangwu
  </td>
  <td>
  jsb
  </td>
  <td>
  /home/jsb/wangwu
  </td>
  <td>
  /bin/sh
  </td>
  <td>
  java 工程师
  </td>
  </tr>
  <tr>
  <td>
  maliu
  </td>
  <td>
  jsb
  </td>
  <td>
  /home/jsb/maliu
  </td>
  <td>
  /bin/sh
  </td>
  <td>
  linux 工程师
  </td>
  </tr>
  <tr>
  <td>
  zhaoqi
  </td>
  <td>
  cwb
  </td>
  <td>
  /home/cwb/zhaoqi
  </td>
  <td>
  /bin/sh
  </td>
  <td>
  会计
  </td>
  </tr>
  </tbody>
  </table>
  <h6>
  <a id="2_1588">
  </a>
  2、循环创建出以上用户并指定用户信息
  </h6>
  <pre><code class="prism language-yaml"><span class="token punctuation">[</span>root@server1 ~<span class="token punctuation">]</span><span class="token comment"># vim user_manage.yml</span>

<span class="token punctuation">---</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Manage user
<span class="token key atrule">hosts</span><span class="token punctuation">:</span> all<span class="token punctuation">-</span>servers
<span class="token key atrule">remote_user</span><span class="token punctuation">:</span> root
<span class="token key atrule">tasks</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> ensure group xsb/jsb/cwb exists
<span class="token key atrule">group</span><span class="token punctuation">:</span>
name=<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item.group <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">with_items</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token punctuation">{<!-- --></span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'xsb'</span> <span class="token punctuation">}</span>
<span class="token punctuation">-</span> <span class="token punctuation">{<!-- --></span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'cwb'</span> <span class="token punctuation">}</span>
<span class="token punctuation">-</span> <span class="token punctuation">{<!-- --></span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'jsb'</span> <span class="token punctuation">}</span>
<span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> create users zhangsan/lisi/wangwu/maliu/zhaoqi
<span class="token key atrule">user</span><span class="token punctuation">:</span>
name=<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item.name <span class="token punctuation">}</span><span class="token punctuation">}</span>
group=<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item.group <span class="token punctuation">}</span><span class="token punctuation">}</span>
shell=<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item.shell <span class="token punctuation">}</span><span class="token punctuation">}</span>
comment=<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item.comment <span class="token punctuation">}</span><span class="token punctuation">}</span>
home=<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item.home <span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token key atrule">with_items</span><span class="token punctuation">:</span>
<span class="token punctuation">-</span> <span class="token punctuation">{<!-- --></span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'zhangsan'</span><span class="token punctuation">,</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'xsb'</span><span class="token punctuation">,</span><span class="token key atrule">home</span><span class="token punctuation">:</span> <span class="token string">'/home/xsb/zhangsan'</span><span class="token punctuation">,</span><span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">'/bin/bash'</span><span class="token punctuation">,</span><span class="token key atrule">comment</span><span class="token punctuation">:</span> <span class="token string">'销售'</span><span class="token punctuation">}</span>
<span class="token punctuation">-</span> <span class="token punctuation">{<!-- --></span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'lisi'</span><span class="token punctuation">,</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'xsb'</span><span class="token punctuation">,</span><span class="token key atrule">home</span><span class="token punctuation">:</span> <span class="token string">'/home/xsb/zhangsan'</span><span class="token punctuation">,</span><span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">'/bin/bash'</span><span class="token punctuation">,</span><span class="token key atrule">comment</span><span class="token punctuation">:</span> <span class="token string">'销售'</span><span class="token punctuation">}</span>
<span class="token punctuation">-</span> <span class="token punctuation">{<!-- --></span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'wangwu'</span><span class="token punctuation">,</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'jsb'</span><span class="token punctuation">,</span><span class="token key atrule">home</span><span class="token punctuation">:</span> <span class="token string">'/home/jsb/wangwu'</span><span class="token punctuation">,</span><span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">'/bin/sh'</span><span class="token punctuation">,</span><span class="token key atrule">comment</span><span class="token punctuation">:</span> <span class="token string">'java 工程师'</span><span class="token punctuation">}</span>
<span class="token punctuation">-</span> <span class="token punctuation">{<!-- --></span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'maliu'</span><span class="token punctuation">,</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'jsb'</span><span class="token punctuation">,</span><span class="token key atrule">home</span><span class="token punctuation">:</span> <span class="token string">'/home/jsb/maliu'</span><span class="token punctuation">,</span><span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">'/bin/sh'</span><span class="token punctuation">,</span><span class="token key atrule">comment</span><span class="token punctuation">:</span> <span class="token string">'linux 工程师'</span><span class="token punctuation">}</span>
<span class="token punctuation">-</span> <span class="token punctuation">{<!-- --></span> <span class="token key atrule">name</span><span class="token punctuation">:</span> <span class="token string">'zhaoqi'</span><span class="token punctuation">,</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'cwb'</span><span class="token punctuation">,</span><span class="token key atrule">home</span><span class="token punctuation">:</span> <span class="token string">'/home/cwb/zhaoqi'</span><span class="token punctuation">,</span><span class="token key atrule">shell</span><span class="token punctuation">:</span> <span class="token string">'/bin/sh'</span><span class="token punctuation">,</span><span class="token key atrule">comment</span><span class="token punctuation">:</span> <span class="token string">'会计'</span><span class="token punctuation">}</span>
</code></pre>
<h6>
<a id="3_1620">
</a>
3、执行剧本
</h6>
<pre><code class="prism language-bash"><span class="token comment">#语法检查</span>
ansible-playbook user_manage.yml --syntax-check

<span class="token comment">#执行剧本</span>
ansible-playbook user_manage.yml
</code></pre>
<p>
<img alt="image-20240519151508668" src="https://i-blog.csdnimg.cn/blog_migrate/be5293fe8fe1943f67fe020b847de061.png"/>
</p>
<h6>
<a id="4_1632">
</a>
4、验证
</h6>
<pre><code class="prism language-bash">ansible all-servers <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"id zhangsan ; id lisi ; id wangwu ; id maliu ; id zhaoqi"</span>
</code></pre>
<p>
<img alt="image-20240519152054284" src="https://i-blog.csdnimg.cn/blog_migrate/73a95749b3350c28988cda87ad01c58c.png"/>
</p>
<h4>
<a id="12_1640">
</a>
12、字典
</h4>
<blockquote>
<p>
ansible playbook 还支持字典这种数据类型
</p>
</blockquote>
<h5>
<a id="121_1644">
</a>
12.1、举例
</h5>
<pre><code class="prism language-bash">- name: <span class="token function">install</span> some packages
yum: <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token assign-left variable">state</span><span class="token operator">=</span>present
with_items: - nginx - memcached - php-fpm

- name: <span class="token function">add</span> some <span class="token function">groups</span>
  group: <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token assign-left variable">state</span><span class="token operator">=</span>present
  with_items:
  - group11
  - group12
  - group13
- name: <span class="token function">add</span> some <span class="token function">users</span>
  user: <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item.name <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token assign-left variable">group</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> item.group <span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token assign-left variable">state</span><span class="token operator">=</span>present
  with_items: - <span class="token punctuation">{<!-- --></span> name: <span class="token string">'user11'</span>, group: <span class="token string">'group11'</span> <span class="token punctuation">}</span> - <span class="token punctuation">{<!-- --></span> name: <span class="token string">'user12'</span>, group: <span class="token string">'group12'</span> <span class="token punctuation">}</span> - <span class="token punctuation">{<!-- --></span> name: <span class="token string">'user13'</span>, group: <span class="token string">'group13'</span> <span class="token punctuation">}</span>
  </code></pre>
  <h4>
  <a id="13role_1667">
  </a>
  13、角色（role）
  </h4>
  <h5>
  <a id="131_1669">
  </a>
  13.1、简介
  </h5>
  <p>
  Ansible 的角色（Roles）是用于组织和复用配置任务的一种方式，它提供了一种结构化的方法来编写和管理 Playbooks，使得大型项目和重复使用的配置任务变得更加易于管理和维护。
  </p>
  <p>
  角色设计的初衷是为了促进 Playbooks 的层次化和模块化，使得不同功能组件能够清晰分离。
  </p>
  <h5>
  <a id="132_1675">
  </a>
  13.2、角色的目录结构
  </h5>
  <p>
  角色集合：roles/
  </p>
  <ul>
  <li>
  mysql/
  </li>
  <li>
  httpd/
  </li>
  <li>
  nginx/
  <ul>
  <li>
  files/：存储由 copy 或 script 等模块调用的文件；
  </li>
  <li>
  tasks/：此目录中至少应该有一个名为 main.yml 的文件，用于定义各 task；其它的文件需要由 main.yml 进行“包含”调用；、
  </li>
  <li>
  handlers/：此目录中至少应该有一个名为 main.yml 的文件，用于定义各 handler；其它的文件需要由 main.yml 进行“包含”调用；
  </li>
  <li>
  vars/：此目录中至少应该有一个名为 main.yml 的文件，用于定义各 variable；其它的文件需要由 main.yml 进行“包含”调用；
  </li>
  <li>
  templates/：存储由 template 模块调用的模板文本；
  </li>
  <li>
  meta/：此目录中至少应该有一个名为 main.yml 的文件，定义当前角色的特殊设定及其依赖关系；其它的文件需要由 main.yml 进行“包含”调用；
  </li>
  <li>
  default/：此目录中至少应该有一个名为 main.yml 的文件，用于设定默认变量；
  </li>
  </ul>
  </li>
  </ul>
  <h4>
  <a id="14nginx_1690">
  </a>
  14、案例：使用角色安装 nginx
  </h4>
  <h5>
  <a id="141_1692">
  </a>
  14.1、创建对应的目录结构
  </h5>
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/ansible/roles/</span>
  <span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># ls</span>
  <span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># mkdir -pv ./{nginx,mysql,httpd}/{files,templates,vars,tasks,handlers,meta,default}</span>
  </code></pre>
  <p>
  <img alt="image-20240519155820069" src="https://i-blog.csdnimg.cn/blog_migrate/32523ac297a31dff2126f1c95cdc7782.png"/>
  </p>
  <h5>
  <a id="142_1702">
  </a>
  14.2、定义配置文件
  </h5>
  <blockquote>
  <p>
  需要修改的配置文件为
  <code>
  /tasks/main.yml
  </code>
  </p>
  </blockquote>
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># cat /etc/ansible/roles/nginx/tasks/main.yml</span>

---

- name: <span class="token function">cp</span>
  copy: <span class="token assign-left variable">src</span><span class="token operator">=</span>nginx-1.10.2-1.el7.ngx.x86_64.rpm <span class="token assign-left variable">dest</span><span class="token operator">=</span>/tmp/nginx-1.10.2-1.el7.ngx.x86_64.rpm
- name: <span class="token function">install</span>
  yum: <span class="token assign-left variable">name</span><span class="token operator">=</span>/tmp/nginx-1.10.2-1.el7.ngx.x86_64.rpm <span class="token assign-left variable">state</span><span class="token operator">=</span>present
- name: conf
  template: <span class="token assign-left variable">src</span><span class="token operator">=</span>nginx.conf.j2 <span class="token assign-left variable">dest</span><span class="token operator">=</span>/etc/nginx/nginx.conf
  tags: nginxconf
  notify: new conf to reload
- name: start <span class="token function">service</span>
  service: <span class="token assign-left variable">name</span><span class="token operator">=</span>nginx <span class="token assign-left variable">state</span><span class="token operator">=</span>started <span class="token assign-left variable">enabled</span><span class="token operator">=</span>true
  </code></pre>
  <h5>
  <a id="143_1722">
  </a>
  14.3、放置文件到指定目录
  </h5>
  <p>
  <a href="https://nginx.org/packages/centos/7Server/x86_64/RPMS/" rel="nofollow">
  rpm 包
  </a>
  </p>
  <pre><code class="prism language-bash"><span class="token comment">#rpm 包放在 files 目录下</span>
  <span class="token function">cp</span> /tmp/nginx-1.10.2-1.el7.ngx.x86_64.rpm /etc/ansible/roles/nginx/files/

<span class="token comment">#模板放在 templates 目录下</span>
<span class="token function">cp</span> /tmp/nginx.conf.j2 /etc/ansible/roles/nginx/templates/

<span class="token comment">#查看目录结构</span>
<span class="token punctuation">[</span>root@server1 nginx<span class="token punctuation">]</span><span class="token comment"># tree</span>
</code></pre>
<p>
<img alt="image-20240519162239997" src="https://i-blog.csdnimg.cn/blog_migrate/23b95fa60eeabe9e512b78edb791a4c7.png"/>
</p>
<h5>
<a id="144_1739">
</a>
14.4、修改变量文件
</h5>
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 nginx<span class="token punctuation">]</span><span class="token comment"># cat /etc/ansible/roles/nginx/vars/main.yml</span>
nginxport: <span class="token number">6666</span>
</code></pre>
<h5>
<a id="145handlers_1746">
</a>
14.5、定义 handlers 文件
</h5>
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 nginx<span class="token punctuation">]</span><span class="token comment"># cat /etc/ansible/roles/nginx/handlers/main.yml</span>

---

- name: new conf to reload
  service: <span class="token assign-left variable">name</span><span class="token operator">=</span>nginx <span class="token assign-left variable">state</span><span class="token operator">=</span>restarted
  </code></pre>
  <h5>
  <a id="146_1755">
  </a>
  14.6 定义剧本文件
  </h5>
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 ansible<span class="token punctuation">]</span><span class="token comment"># cat /etc/ansible/roles.yml</span>

---

- hosts: all-servers
  remote_user: root
  roles: - nginx
  </code></pre>
  <h5>
  <a id="147_1766">
  </a>
  14.7、剩余的配置文件
  </h5>
  <ul>
  <li>
  nginx.conf.j2
  </li>
  </ul>
  <pre><code class="prism language-bash">events <span class="token punctuation">{<!-- --></span>
  worker_connections <span class="token number">1024</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

http <span class="token punctuation">{<!-- --></span>
server <span class="token punctuation">{<!-- --></span>
listen <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> nginxport <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h5>
<a id="148_1782">
</a>
14.8、启动服务
</h5>
<pre><code class="prism language-bash"><span class="token comment">#语法检查</span>
ansible-playbook roles.yml --syntax-check

<span class="token comment">#执行剧本</span>
ansible-playbook roles.yml
</code></pre>
<p>
<img alt="image-20240519165513040" src="https://i-blog.csdnimg.cn/blog_migrate/857e2a33a057d177ea334fe9570e8fe2.png"/>
</p>
<h5>
<a id="149_1794">
</a>
14.9、验证端口号
</h5>
<pre><code class="prism language-bash">ansible all-servers <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"ss -tunlp | grep nginx"</span>
</code></pre>
<p>
<img alt="image-20240519165645659" src="https://i-blog.csdnimg.cn/blog_migrate/50cf4949a4c8f4ee41cf61ba0b2c3224.png"/>
</p>
<h4>
<a id="15httpd_1802">
</a>
15、案例：使用角色安装 httpd
</h4>
<h5>
<a id="151_1804">
</a>
15.1、创建对应的目录结构
</h5>
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 ~<span class="token punctuation">]</span><span class="token comment"># cd /etc/ansible/roles/</span>
<span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># ls</span>
<span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># mkdir -pv ./{nginx,mysql,httpd}/{files,templates,vars,tasks,handlers,meta,default}</span>
<span class="token comment">#创建一个名为 apache 的新角色</span>
<span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># ansible-galaxy init apache</span>

- Role apache was created successfully
  </code></pre>
  <p>
  <img alt="image-20240519172738160" src="https://i-blog.csdnimg.cn/blog_migrate/358051e39370e6af29c1a136f5a92822.png"/>
  </p>
  <h5>
  <a id="152siteyaml_1817">
  </a>
  15.2、编写 site.yaml 文件
  </h5>
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># cat /etc/ansible/roles/site.yml</span>

---

- hosts: all-servers
  remote_user: root
  roles:
  - apache
    </code></pre>
    <h5>
    <a id="153tasksmainyml_1829">
    </a>
    15.3、编写 tasks 里的 main.yml 文件
    </h5>
    <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># cat /etc/ansible/roles/apache/tasks/main.yml</span>

---

- name: Install httpd
  yum:
  name: httpd
  state: present
- name: Start httpd
  service:
  name: httpd
  state: restarted
- name: Write index <span class="token function">file</span>
  shell: <span class="token builtin class-name">echo</span> <span class="token string">"http"</span> <span class="token operator">&gt;</span> /var/www/html/index.html
  </code></pre>
  <h5>
  <a id="154_1846">
  </a>
  15.4、执行剧本
  </h5>
  <pre><code class="prism language-bash"><span class="token comment">#语法验证</span>
  ansible-playbook site.yml --syntax-check

<span class="token comment">#执行剧本</span>
ansible-playbook site.yml
</code></pre>
<p>
<img alt="image-20240519173423259" src="https://i-blog.csdnimg.cn/blog_migrate/5c0edca2e58d1c1c8e7c8687d2b90a99.png"/>
</p>
<h5>
<a id="155_1858">
</a>
15.5、验证
</h5>
<pre><code class="prism language-bash">ansible all-servers <span class="token parameter variable">-m</span> shell <span class="token parameter variable">-a</span> <span class="token string">"curl -s server1 ; curl -s server2 ; curl -s server3 ; curl -s server4"</span>
</code></pre>
<p>
<img alt="image-20240519173703371" src="https://i-blog.csdnimg.cn/blog_migrate/ab9587883fcededbeb1e73100717535f.png"/>
</p>
<h4>
<a id="16javanginxhalo_1866">
</a>
16、案例：使用角色安装 java+nginx+halo
</h4>
<h5>
<a id="161_1868">
</a>
16.1、准备角色
</h5>
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># ansible-galaxy init halo</span>

- Role halo was created successfully
  <span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># ansible-galaxy init java</span>
- Role <span class="token function">java</span> was created successfully
  <span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># ansible-galaxy init nginx</span>
- Role nginx was created successfully
  </code></pre>
  <p>
  <img alt="image-20240519173958985" src="https://i-blog.csdnimg.cn/blog_migrate/225411638282c8cfb181ec8775e13c31.png"/>
  </p>
  <h5>
  <a id="162siteyml_1881">
  </a>
  16.2、编写 site.yml
  </h5>
  <ul>
  <li>
  pre_tasks 为运行 play 之前执行的任务
  </li>
  <li>
  post_tasks 为运行 play 之后执行的任务
  </li>
  </ul>
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># cat site.yml</span>

---

- hosts: node1
  remote_user: root
  strategy: <span class="token function">free</span>
  pre_tasks: - name: config nginx repo <span class="token keyword">for</span> centos <span class="token number">7</span>
  yum_repository:
  name: nginx
  description: nginx
  baseurl: http://nginx.org/packages/centos/<span class="token variable">$releasever</span>/<span class="token variable">$basearch</span>/
  gpgcheck: no
  when: ansible_distribution_major_version <span class="token operator">==</span> <span class="token string">"7"</span> - name: Disable SELinux
  selinux: <span class="token assign-left variable">state</span><span class="token operator">=</span>disabled

  roles: - nginx

  post_tasks: - shell: <span class="token builtin class-name">echo</span> <span class="token string">'Deplay halo finished.'</span>
  register: ret - debug: <span class="token assign-left variable">var</span><span class="token operator">=</span>ret.stdout
  </code></pre>
  <h5>
  <a id="163nginx_1913">
  </a>
  16.3、编写 nginx 角色
  </h5>
  <blockquote>
  <p>
  nginx/tasks/main.yml
  </p>
  </blockquote>
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># cat nginx/tasks/main.yml</span>

---

<span class="token comment"># tasks file for nginx</span>

- name: <span class="token function">make</span> sure nginx state is installed
  yum: <span class="token assign-left variable">name</span><span class="token operator">=</span>nginx <span class="token assign-left variable">state</span><span class="token operator">=</span>installed
- name: copy halo to nginx config <span class="token function">file</span>
  template: <span class="token assign-left variable">src</span><span class="token operator">=</span>halo.conf <span class="token assign-left variable">dest</span><span class="token operator">=</span><span class="token string">"/etc/nginx/conf.d/halo.conf"</span>
- name: <span class="token function">make</span> sure nginx <span class="token function">service</span> is running
  service: <span class="token assign-left variable">name</span><span class="token operator">=</span>nginx <span class="token assign-left variable">state</span><span class="token operator">=</span>started
- name: <span class="token function">make</span> sure port is <span class="token function">open</span>
  wait_for: <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token string">"{<!-- -->{ nginx_port }}"</span>
  </code></pre>
  <blockquote>
  <p>
  meta/main.yml 为 role 的依赖关系，要先运行这里面的内容才会运行自己的 nginx 这个 role。
  </p>
  </blockquote>
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># cat nginx/meta/main.yml #要修改的是 dependencies 部分</span>

dependencies:

- role: <span class="token function">java</span>
- role: halo
  </code></pre>
  <blockquote>
  <p>
  nginx/templates/halo.conf
  </p>
  </blockquote>
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># cat nginx/templates/halo.conf</span>
  upstream halo <span class="token punctuation">{<!-- --></span>
  server <span class="token number">127.0</span>.0.1:8090<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  server <span class="token punctuation">{<!-- --></span>
  listen <span class="token number">80</span><span class="token punctuation">;</span>
  listen <span class="token punctuation">[</span>::<span class="token punctuation">]</span>:80<span class="token punctuation">;</span>
  server_name <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> halo_domain <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  client_max_body_size 1024m<span class="token punctuation">;</span>
  location / <span class="token punctuation">{<!-- --></span>
  proxy_pass http://halo<span class="token punctuation">;</span>
  proxy_set_header HOST <span class="token variable">$host</span><span class="token punctuation">;</span>
    proxy_set_header X-Forwarded-Proto <span class="token variable">$scheme</span><span class="token punctuation">;</span>
  proxy_set_header X-Real-IP <span class="token variable">$remote_addr</span><span class="token punctuation">;</span>
    proxy_set_header X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  </code></pre>
  <h5>
  <a id="164java_1963">
  </a>
  16.4、编写 java 角色
  </h5>
  <blockquote>
  <p>
  为了安装 java
  </p>
  </blockquote>
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># cat java/tasks/main.yml</span>

---

<span class="token comment"># tasks file for java</span>

- name: <span class="token function">install</span> <span class="token function">java</span>
  yum: <span class="token assign-left variable">name</span><span class="token operator">=</span>java-11-openjdk <span class="token assign-left variable">state</span><span class="token operator">=</span>installed
  </code></pre>
  <h5>
  <a id="165halo_1976">
  </a>
  16.5、编写 halo 角色
  </h5>
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># cat halo/tasks/main.yml</span>

---

<span class="token comment"># tasks file for halo</span>

- name: get halo
  get_url: <span class="token assign-left variable">url</span><span class="token operator">=</span>https://dl.halo.run/release/halo-1.4.11.jar <span class="token assign-left variable">dest</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> halopath <span class="token punctuation">}</span><span class="token punctuation">}</span>

- name: <span class="token function">add</span> halo <span class="token function">service</span> <span class="token function">file</span>
  template: <span class="token assign-left variable">src</span><span class="token operator">=</span>halo.service <span class="token assign-left variable">dest</span><span class="token operator">=</span>/etc/systemd/system/halo.service

- name: <span class="token function">touch</span> ~/.halo directory
  file: <span class="token assign-left variable">path</span><span class="token operator">=~</span>/.halo <span class="token assign-left variable">state</span><span class="token operator">=</span>directory

- name: copy halo config <span class="token function">file</span>
  template: <span class="token assign-left variable">src</span><span class="token operator">=</span>application.yaml <span class="token assign-left variable">dest</span><span class="token operator">=</span><span class="token string">"~/.halo/application.yaml"</span>

- name: restart halo
  systemd:
  daemon_reload: <span class="token function">yes</span>
  name: halo
  state: started
  enabled: <span class="token function">yes</span>

- name: <span class="token function">wait</span> to start halo
  wait_for: <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> halo_port <span class="token punctuation">}</span><span class="token punctuation">}</span>
  </code></pre>
  <blockquote>
  <p>
  修改变量文件 halo/vars/main.yml
  </p>
  </blockquote>
  <pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># cat halo/vars/main.yml</span>

---

<span class="token comment"># vars file for halo</span>
memory: 512m
halo_port: <span class="token number">8090</span>
halopath: /root/halo.jar
halo_domain: <span class="token number">192.168</span>.112.10
nginx_port: <span class="token number">80</span>
</code></pre>
<blockquote>
<p>
下载 servers 文件并编辑
</p>
</blockquote>
<pre><code class="prism language-bash"><span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># wget https://dl.halo.run/config/halo.service -O halo/templates/halo.service</span>

<span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># cat halo/templates/halo.service</span>
<span class="token punctuation">[</span>Unit<span class="token punctuation">]</span>
<span class="token assign-left variable">Description</span><span class="token operator">=</span>Halo Service
<span class="token assign-left variable">Documentation</span><span class="token operator">=</span>https://docs.halo.run
<span class="token assign-left variable">After</span><span class="token operator">=</span>network-online.target
<span class="token assign-left variable">Wants</span><span class="token operator">=</span>network-online.target

<span class="token punctuation">[</span>Service<span class="token punctuation">]</span>
<span class="token assign-left variable">Type</span><span class="token operator">=</span>simple
<span class="token assign-left variable">User</span><span class="token operator">=</span>root <span class="token comment">#修改</span>
<span class="token assign-left variable">ExecStart</span><span class="token operator">=</span>/usr/bin/java <span class="token parameter variable">-server</span> <span class="token parameter variable">-Xms256m</span> <span class="token parameter variable">-Xmx256m</span> <span class="token parameter variable">-jar</span> /root/halo.jar <span class="token comment">#修改</span>
<span class="token assign-left variable">ExecStop</span><span class="token operator">=</span>/bin/kill <span class="token parameter variable">-s</span> QUIT <span class="token variable">$MAINPID</span>
<span class="token assign-left variable">Restart</span><span class="token operator">=</span>always
<span class="token assign-left variable">StandOutput</span><span class="token operator">=</span>syslog

<span class="token assign-left variable">StandError</span><span class="token operator">=</span>inherit

<span class="token punctuation">[</span>Install<span class="token punctuation">]</span>
<span class="token assign-left variable">WantedBy</span><span class="token operator">=</span>multi-user.target

<span class="token punctuation">[</span>root@server1 roles<span class="token punctuation">]</span><span class="token comment"># wget https://dl.halo.run/config/application-template.yaml -O halo/templates/application.yaml</span>
</code></pre>
<h5>
<a id="166_2048">
</a>
16.6、执行剧本
</h5>
<pre><code class="prism language-bash"><span class="token comment">#语法检查</span>
ansible-playbook site.yml --syntax-check

<span class="token comment">#执行剧本</span>
ansible-playbook site.yml
</code></pre>
<p>
<img alt="image-20240519181906858" src="https://i-blog.csdnimg.cn/blog_migrate/823e29c2ba5642f12479abdc333e55dd.png"/>
</p>
<h5>
<a id="167_2060">
</a>
16.7、验证
</h5>
<blockquote>
<p>
通过 IP ＋端口访问
</p>
<p>
192.168.112.10:8090
<br/>
<img alt="image-20240519182050796" src="https://i-blog.csdnimg.cn/blog_migrate/a3b50f51bd540d6d283ee3b72624c7c2.png"/>
</p>
</blockquote>
<blockquote>
<p>
至此 Ansible 的学习就告一段落啦
</p>
</blockquote>

   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f6d6973616b6976762f:61727469636c652f64657461696c732f313339303436373031" class_="artid" style="display:none">
 </p>
</div>
