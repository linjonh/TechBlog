---
layout: post
title: "RK平台UVC摄像头shell测试脚本"
date: 2024-12-11 09:33:28 +0800
description: "USB video class（又称为USB video device class or UVC）就"
keywords: "uvc 摄像头 带宽"
categories: ['Shell', 'Linux']
tags: ['摄像头', 'Shell', 'Android']
artid: "54410793"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=54410793
    alt: "RK平台UVC摄像头shell测试脚本"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=54410793
featuredImagePreview: https://bing.ee123.net/img/rand?artid=54410793
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     RK平台UVC摄像头shell测试脚本
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-github-gist" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     USB video class（又称为USB video device class or UVC）就是USB device class视频产品在不需要安装任何的驱动程序下即插即用，包括摄像头、数字摄影机、模拟视频转换器、电视卡及静态视频相机。
    </p>
    <p>
     SoC : RK3288
     <br/>
     Platform : Android 5.1
    </p>
    <pre><code>RK平台有自己的测试方法：在计算器中输入"83991906="，进入测试工程模式，选择CameraTest可以进行相
机的&lt;open/close test&gt;,&lt;Take photo test&gt;,&lt;Switch mode test&gt;等。
</code></pre>
    <p>
     此脚本测试流程：打开-拍照-退出，并将结果存入本地。shell如下：
    </p>
    <pre class="prettyprint"><code class="hljs bash"><span class="hljs-shebang">#!/system/bin/sh</span>
<span class="hljs-comment"># 拍照测试程序，监控照片是否生成,自动判断/dev/video设备是否存在</span>

MONITOR_DIR=/mnt/sdcard/DCIM/Camera               <span class="hljs-comment"># 照片存放目录</span>
ACTIVITY_DIR=/mnt/sdcard/CameraActivity.txt       <span class="hljs-comment"># 启动相机的log</span>
PHOTO_NUMBER=/mnt/sdcard/photonumber.txt          <span class="hljs-comment"># 拍照次数的log</span>
DEVICE_ERR=/mnt/sdcard/CameraError.txt            <span class="hljs-comment"># 没有识别到设备/dev/video0的log  </span>

open_success=<span class="hljs-number">0</span>
open_failed=<span class="hljs-number">0</span>
open_error=<span class="hljs-number">0</span>
device_err=<span class="hljs-number">0</span>;
takephoto_success=<span class="hljs-number">0</span>
takephoto_failed=<span class="hljs-number">0</span>
PICTURE_PIRV=<span class="hljs-number">0</span>
PICTURE_NEXT=<span class="hljs-number">0</span>

<span class="hljs-keyword">if</span> [ <span class="hljs-operator">-f</span> <span class="hljs-string">"CameraTestOK.txt"</span> ];<span class="hljs-keyword">then</span>
    rm /mnt/sdcard/*.txt
    rm /mnt/sdcard/DCIM/Camera/*.jpg
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># </span>
<span class="hljs-comment">#       当没有产生/dev/video0或/dev/video1时，打开相机系统会弹窗提示"相机发生错误：无法连接到相机"</span>
<span class="hljs-comment">#       这里只记录错误的次数,当没有产生设备文件时，注意备份相关log         </span>
<span class="hljs-comment">#   </span>

<span class="hljs-function"><span class="hljs-title">takephoto_function</span></span>()
{
    PICTURE_PIRV=`ls <span class="hljs-operator">-l</span>  <span class="hljs-variable">$MONITOR_DIR</span>/*.jpg |grep <span class="hljs-string">"^-"</span>| busybox wc <span class="hljs-operator">-l</span>`
    am start -n  com.android.camera2/com.android.camera.CameraActivity 
<span class="hljs-keyword">if</span>  ps | grep com.android.camera2 ;<span class="hljs-keyword">then</span>
        <span class="hljs-built_in">let</span> <span class="hljs-string">"open_success++"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"start Camera activity success number:<span class="hljs-variable">$open_success</span>"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"[<span class="hljs-variable">$(date +%T)</span>] start Camera activity success number:<span class="hljs-variable">$open_success</span>"</span>  &gt;&gt; <span class="hljs-variable">$ACTIVITY_DIR</span>
        sleep <span class="hljs-number">3</span>
        input tap <span class="hljs-number">1910</span> <span class="hljs-number">500</span>
        PICTURE_NEXT=`ls <span class="hljs-operator">-l</span>  <span class="hljs-variable">$MONITOR_DIR</span>/*.jpg |grep <span class="hljs-string">"^-"</span>| busybox wc <span class="hljs-operator">-l</span>`
        <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$PICTURE_NEXT</span> <span class="hljs-operator">-gt</span> <span class="hljs-variable">$PICTURE_PIRV</span> ];<span class="hljs-keyword">then</span>
            <span class="hljs-built_in">let</span> <span class="hljs-string">"takephoto_success++"</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"Take photo success:<span class="hljs-variable">$takephoto_success</span>"</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"[<span class="hljs-variable">$(date +%T)</span>] Take photo success:<span class="hljs-variable">$takephoto_success</span>"</span> &gt;&gt; <span class="hljs-variable">$PHOTO_NUMBER</span>
        <span class="hljs-keyword">else</span>
            <span class="hljs-built_in">let</span> <span class="hljs-string">"takephoto_failed++"</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"[<span class="hljs-variable">$(date +%T)</span>] Take photo failed:<span class="hljs-variable">$takephoto_failed</span>"</span>    &gt;&gt;  <span class="hljs-variable">$PHOTO_NUMBER</span>
        <span class="hljs-keyword">fi</span>
<span class="hljs-comment">#       am force-stop  com.android.camera2</span>
        PROID=`ps |grep com.android.camera2 |grep -v <span class="hljs-string">"grep"</span>|busybox awk <span class="hljs-string">'{print $2}'</span>`
        kill -<span class="hljs-number">9</span> <span class="hljs-variable">$PROID</span>
<span class="hljs-keyword">else</span>
        <span class="hljs-built_in">let</span> <span class="hljs-string">"open_failed++"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"[<span class="hljs-variable">$(date +%T)</span>] start Camera activity failed number:<span class="hljs-variable">$open_failed</span>"</span>  &gt;&gt; <span class="hljs-variable">$ACTIVITY_DIR</span>
<span class="hljs-keyword">fi</span>  

}

<span class="hljs-keyword">while</span>((<span class="hljs-variable">$open_success</span>&lt;=<span class="hljs-number">1000</span>))
<span class="hljs-keyword">do</span>
    <span class="hljs-keyword">if</span> ls <span class="hljs-operator">-l</span> /dev/video0 ;<span class="hljs-keyword">then</span>
        takephoto_function;
    <span class="hljs-keyword">elif</span> ls <span class="hljs-operator">-l</span> /dev/video1 ;<span class="hljs-keyword">then</span>    
        <span class="hljs-built_in">let</span> <span class="hljs-string">"device_err++"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"[<span class="hljs-variable">$(date +%T)</span>] Camera device is /dev/video1"</span>  &gt;&gt;  <span class="hljs-variable">$DEVICE_ERR</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"[<span class="hljs-variable">$(date +%T)</span>] ---------- Camera device has change!!!!!!!!!!!!!!!!!!!"</span>
        takephoto_function;
        conitue
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">let</span> <span class="hljs-string">"open_error++"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"------&lt;/dev/video0&gt; and &lt;/dev/video1&gt; not exist.-------"</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"[<span class="hljs-variable">$(date +%T)</span>] Camera device &lt;/dev/video0&gt; and &lt;/dev/video1&gt; not exist:<span class="hljs-variable">$open_error</span>"</span> &gt;&gt; <span class="hljs-variable">$DEVICE_ERR</span>
        sleep <span class="hljs-number">2</span>
        conitue
    <span class="hljs-keyword">fi</span>      

<span class="hljs-comment">#   PROID=`ps -fe | grep com.android.camera2 | awk '{print $2}' | head -n 1`</span>
<span class="hljs-comment">#   kill -9 $PROID</span>
<span class="hljs-comment">#   am force-stop  com.android.camera2</span>
<span class="hljs-keyword">done</span>

PICTURE=`ls <span class="hljs-operator">-l</span>  <span class="hljs-variable">$MONITOR_DIR</span>/*.jpg |grep <span class="hljs-string">"^-"</span>| busybox wc <span class="hljs-operator">-l</span>`
<span class="hljs-built_in">echo</span> <span class="hljs-string">"----------------------------------------------------"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"1.total  Camera picture  number:<span class="hljs-variable">$PICTURE</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"2.start Camera app success number:<span class="hljs-variable">$open_success</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"3.Take photo success number:<span class="hljs-variable">$takephoto_success</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"4.can not find device [/dev/video0] number:<span class="hljs-variable">$open_error</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"5.find Camera device [/dev/video1] number:<span class="hljs-variable">$device_err</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"----------------------------------------------------"</span>

</code></pre>
    <p>
     NOTE:
     <br/>
     1. 需要确定系统的Camera应用包名与全路径名称，作相应的修改
     <br/>
     2.通过adb push 到/system/bin/下，运行前su下即可。
    </p>
    <p>
     shell作用：监控Camera2应用是否运行，并判断是否存在videoX设备，通过对比生成照片的数量判断是否拍照成功。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f75303134373730383632:2f61727469636c652f64657461696c732f3534343130373933" class_="artid" style="display:none">
 </p>
</div>


