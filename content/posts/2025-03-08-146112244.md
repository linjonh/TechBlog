---
layout: post
title: "SQL-Server核心知识总结"
date: 2025-03-08 10:57:47 +0800
description: "SQL server核心知识总结"
keywords: "SQL Server核心知识总结"
categories: ['编程知识']
tags: ['数据库开发', '数据库', 'Sql']
artid: "146112244"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146112244
    alt: "SQL-Server核心知识总结"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146112244
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146112244
cover: https://bing.ee123.net/img/rand?artid=146112244
image: https://bing.ee123.net/img/rand?artid=146112244
img: https://bing.ee123.net/img/rand?artid=146112244
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     SQL Server核心知识总结
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="SQL_Server_1">
     </a>
     SQL Server核心知识总结
    </h2>
    <blockquote>
     <p>
      🎯 本文总结了SQL Server核心知识点,每个主题都提供实际可运行的示例代码。
     </p>
    </blockquote>
    <h3>
     <a id="SQL_Server_5">
     </a>
     一、SQL Server基础精要
    </h3>
    <h4>
     <a id="1__7">
     </a>
     1. 数据库核心操作
    </h4>
    <pre><code class="prism language-sql"><span class="token comment">-- 1. 创建数据库（核心配置）</span>
<span class="token keyword">CREATE</span> <span class="token keyword">DATABASE</span> 学生管理系统
<span class="token keyword">ON</span> <span class="token keyword">PRIMARY</span>
<span class="token punctuation">(</span>
    NAME <span class="token operator">=</span> <span class="token string">'学生管理系统_数据'</span><span class="token punctuation">,</span>
    FILENAME <span class="token operator">=</span> <span class="token string">'D:\Data\学生管理系统.mdf'</span><span class="token punctuation">,</span>
    SIZE <span class="token operator">=</span> <span class="token number">100</span>MB<span class="token punctuation">,</span>
    FILEGROWTH <span class="token operator">=</span> <span class="token number">100</span>MB
<span class="token punctuation">)</span>
LOG <span class="token keyword">ON</span>
<span class="token punctuation">(</span>
    NAME <span class="token operator">=</span> <span class="token string">'学生管理系统_日志'</span><span class="token punctuation">,</span>
    FILENAME <span class="token operator">=</span> <span class="token string">'D:\Data\学生管理系统.ldf'</span><span class="token punctuation">,</span>
    SIZE <span class="token operator">=</span> <span class="token number">50</span>MB<span class="token punctuation">,</span>
    FILEGROWTH <span class="token operator">=</span> <span class="token number">50</span>MB
<span class="token punctuation">)</span><span class="token punctuation">;</span>
GO

<span class="token comment">-- 2. 创建核心表结构</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 学生表
<span class="token punctuation">(</span>
    学号 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>           <span class="token comment">-- 主键（最重要）</span>
    姓名 NVARCHAR<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>         <span class="token comment">-- 必填字段</span>
    性别 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    出生日期 <span class="token keyword">DATE</span><span class="token punctuation">,</span>
    班级 NVARCHAR<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 成绩表
<span class="token punctuation">(</span>
    ID <span class="token keyword">INT</span> <span class="token keyword">IDENTITY</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>    <span class="token comment">-- 自增主键</span>
    学号 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    课程号 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    成绩 <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">CONSTRAINT</span> FK_成绩表_学生表 
        <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>学号<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> 学生表<span class="token punctuation">(</span>学号<span class="token punctuation">)</span>  <span class="token comment">-- 外键关系</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 3. 基本数据操作（最常用）</span>
<span class="token comment">-- 插入数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 学生表 <span class="token punctuation">(</span>学号<span class="token punctuation">,</span> 姓名<span class="token punctuation">,</span> 性别<span class="token punctuation">,</span> 班级<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2021001'</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">,</span> <span class="token string">'男'</span><span class="token punctuation">,</span> <span class="token string">'计算机1班'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 更新数据</span>
<span class="token keyword">UPDATE</span> 学生表 
<span class="token keyword">SET</span> 班级 <span class="token operator">=</span> <span class="token string">'计算机2班'</span>
<span class="token keyword">WHERE</span> 学号 <span class="token operator">=</span> <span class="token string">'2021001'</span><span class="token punctuation">;</span>

<span class="token comment">-- 删除数据</span>
<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> 学生表 
<span class="token keyword">WHERE</span> 学号 <span class="token operator">=</span> <span class="token string">'2021001'</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     🔑
     <strong>
      核心要点
     </strong>
     ：
    </p>
    <ol>
     <li>
      <p>
       数据库设计三要素：
      </p>
      <ul>
       <li>
        主数据文件(.mdf)：存储数据
       </li>
       <li>
        日志文件(.ldf)：记录事务
       </li>
       <li>
        合理的初始大小和增长设置
       </li>
      </ul>
     </li>
     <li>
      <p>
       表设计核心原则：
      </p>
      <ul>
       <li>
        必须有主键（唯一标识）
       </li>
       <li>
        建立合适的外键关系
       </li>
       <li>
        选择合适的数据类型
       </li>
       <li>
        添加必要的约束
       </li>
      </ul>
     </li>
     <li>
      <p>
       最常用的SQL操作：
      </p>
      <ul>
       <li>
        INSERT：添加数据
       </li>
       <li>
        UPDATE：修改数据
       </li>
       <li>
        DELETE：删除数据
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="2__79">
     </a>
     2. 数据类型和查询
    </h4>
    <p>
     让我们学习最常用的数据类型和SELECT查询：
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- 1. 最常用数据类型示例</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 数据类型示例
<span class="token punctuation">(</span>
    <span class="token comment">-- 整数类型（最常用）</span>
    ID <span class="token keyword">INT</span> <span class="token keyword">IDENTITY</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment">-- 自增整数，常用主键</span>
    数量 <span class="token keyword">SMALLINT</span><span class="token punctuation">,</span>               <span class="token comment">-- 较小范围整数</span>
    
    <span class="token comment">-- 精确数值（金融计算必用）</span>
    金额 <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment">-- 总12位，小数2位</span>
    单价 MONEY<span class="token punctuation">,</span>                  <span class="token comment">-- 专用于金融计算</span>
    
    <span class="token comment">-- 字符串（最常用）</span>
    名称 NVARCHAR<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>           <span class="token comment">-- Unicode变长，最常用</span>
    编号 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>              <span class="token comment">-- 定长，如学号工号等</span>
    描述 <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span>MAX<span class="token punctuation">)</span><span class="token punctuation">,</span>          <span class="token comment">-- 大文本数据</span>
    
    <span class="token comment">-- 日期时间（最常用）</span>
    创建日期 <span class="token keyword">DATE</span><span class="token punctuation">,</span>               <span class="token comment">-- 仅日期</span>
    更新时间 DATETIME2           <span class="token comment">-- 日期时间，推荐使用</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 2. 核心查询语句</span>
<span class="token comment">-- 基础查询（最常用）</span>
<span class="token keyword">SELECT</span> 学号<span class="token punctuation">,</span> 姓名<span class="token punctuation">,</span> 成绩
<span class="token keyword">FROM</span> 学生表
<span class="token keyword">WHERE</span> 班级 <span class="token operator">=</span> <span class="token string">'计算机1班'</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 成绩 <span class="token keyword">DESC</span><span class="token punctuation">;</span>

<span class="token comment">-- 多表联接（重要）</span>
<span class="token keyword">SELECT</span> s<span class="token punctuation">.</span>姓名<span class="token punctuation">,</span> c<span class="token punctuation">.</span>课程名<span class="token punctuation">,</span> g<span class="token punctuation">.</span>成绩
<span class="token keyword">FROM</span> 学生表 s
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> 成绩表 g <span class="token keyword">ON</span> s<span class="token punctuation">.</span>学号 <span class="token operator">=</span> g<span class="token punctuation">.</span>学号
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> 课程表 c <span class="token keyword">ON</span> g<span class="token punctuation">.</span>课程号 <span class="token operator">=</span> c<span class="token punctuation">.</span>课程号
<span class="token keyword">WHERE</span> g<span class="token punctuation">.</span>成绩 <span class="token operator">&gt;=</span> <span class="token number">60</span><span class="token punctuation">;</span>

<span class="token comment">-- 分组统计（常用）</span>
<span class="token keyword">SELECT</span> 班级<span class="token punctuation">,</span> 
       <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 人数<span class="token punctuation">,</span>
       <span class="token function">AVG</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token keyword">AS</span> 平均分<span class="token punctuation">,</span>
       <span class="token function">MAX</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token keyword">AS</span> 最高分
<span class="token keyword">FROM</span> 学生表 s
<span class="token keyword">JOIN</span> 成绩表 g <span class="token keyword">ON</span> s<span class="token punctuation">.</span>学号 <span class="token operator">=</span> g<span class="token punctuation">.</span>学号
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 班级
<span class="token keyword">HAVING</span> <span class="token function">AVG</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">60</span><span class="token punctuation">;</span>

<span class="token comment">-- 子查询（重要）</span>
<span class="token keyword">SELECT</span> 姓名<span class="token punctuation">,</span> 成绩
<span class="token keyword">FROM</span> 学生表 s
<span class="token keyword">JOIN</span> 成绩表 g <span class="token keyword">ON</span> s<span class="token punctuation">.</span>学号 <span class="token operator">=</span> g<span class="token punctuation">.</span>学号
<span class="token keyword">WHERE</span> 成绩 <span class="token operator">&gt;</span> <span class="token punctuation">(</span>
    <span class="token keyword">SELECT</span> <span class="token function">AVG</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span>
    <span class="token keyword">FROM</span> 成绩表
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     📝
     <strong>
      查询要点
     </strong>
     ：
    </p>
    <ol>
     <li>
      <p>
       SELECT语句核心组成（按执行顺序）：
      </p>
      <ul>
       <li>
        FROM：指定数据来源
       </li>
       <li>
        WHERE：行级过滤
       </li>
       <li>
        GROUP BY：分组
       </li>
       <li>
        HAVING：组级过滤
       </li>
       <li>
        ORDER BY：排序
       </li>
      </ul>
     </li>
     <li>
      <p>
       常用联接类型：
      </p>
      <ul>
       <li>
        INNER JOIN：内联接（最常用）
       </li>
       <li>
        LEFT JOIN：左外联接（保留左表所有行）
       </li>
       <li>
        RIGHT JOIN：右外联接（保留右表所有行）
       </li>
      </ul>
     </li>
     <li>
      <p>
       常用聚合函数：
      </p>
      <ul>
       <li>
        COUNT()：计数
       </li>
       <li>
        SUM()：求和
       </li>
       <li>
        AVG()：平均值
       </li>
       <li>
        MAX()/MIN()：最大/最小值
       </li>
      </ul>
     </li>
     <li>
      <p>
       性能优化要点：
      </p>
      <ul>
       <li>
        只查询需要的列
       </li>
       <li>
        合理使用索引
       </li>
       <li>
        避免SELECT *
       </li>
       <li>
        适当使用WHERE条件
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="3__163">
     </a>
     3. 索引和性能优化
    </h4>
    <p>
     让我们学习最核心的性能优化技术：
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- 1. 创建最常用的索引类型</span>
<span class="token comment">-- 聚集索引（主键，每表仅一个）</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 订单表
<span class="token punctuation">(</span>
    订单号 <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>  <span class="token comment">-- 自动创建聚集索引</span>
    客户ID <span class="token keyword">INT</span><span class="token punctuation">,</span>
    订单日期 <span class="token keyword">DATE</span><span class="token punctuation">,</span>
    总金额 <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 非聚集索引（最常用的查询优化方式）</span>
<span class="token keyword">CREATE</span> <span class="token keyword">NONCLUSTERED</span> <span class="token keyword">INDEX</span> IX_订单表_客户ID
<span class="token keyword">ON</span> 订单表<span class="token punctuation">(</span>客户ID<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 覆盖索引（包含所有需要的列）</span>
<span class="token keyword">CREATE</span> <span class="token keyword">NONCLUSTERED</span> <span class="token keyword">INDEX</span> IX_订单表_日期_金额
<span class="token keyword">ON</span> 订单表<span class="token punctuation">(</span>订单日期<span class="token punctuation">)</span>
INCLUDE <span class="token punctuation">(</span>总金额<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 2. 查看索引使用情况</span>
<span class="token comment">-- 查看索引的使用统计</span>
<span class="token keyword">SELECT</span> 
    OBJECT_NAME<span class="token punctuation">(</span>i<span class="token punctuation">.</span>object_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> 表名<span class="token punctuation">,</span>
    i<span class="token punctuation">.</span>name <span class="token keyword">AS</span> 索引名<span class="token punctuation">,</span>
    ius<span class="token punctuation">.</span>user_seeks <span class="token operator">+</span> ius<span class="token punctuation">.</span>user_scans <span class="token keyword">AS</span> 使用次数<span class="token punctuation">,</span>
    ius<span class="token punctuation">.</span>last_user_seek <span class="token keyword">AS</span> 最后查询时间
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_db_index_usage_stats ius
<span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>indexes i <span class="token keyword">ON</span> ius<span class="token punctuation">.</span>object_id <span class="token operator">=</span> i<span class="token punctuation">.</span>object_id 
    <span class="token operator">AND</span> ius<span class="token punctuation">.</span>index_id <span class="token operator">=</span> i<span class="token punctuation">.</span>index_id
<span class="token keyword">WHERE</span> database_id <span class="token operator">=</span> DB_ID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 3. 性能诊断（最常用）</span>
<span class="token comment">-- 查看执行计划</span>
<span class="token keyword">SET</span> <span class="token keyword">STATISTICS</span> IO <span class="token keyword">ON</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> <span class="token keyword">STATISTICS</span> <span class="token keyword">TIME</span> <span class="token keyword">ON</span><span class="token punctuation">;</span>
GO

<span class="token comment">-- 慢查询示例</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> 订单表 
<span class="token keyword">WHERE</span> 订单日期 <span class="token operator">BETWEEN</span> <span class="token string">'2024-01-01'</span> <span class="token operator">AND</span> <span class="token string">'2024-01-31'</span><span class="token punctuation">;</span>

<span class="token comment">-- 优化后的查询</span>
<span class="token keyword">SELECT</span> 订单号<span class="token punctuation">,</span> 订单日期<span class="token punctuation">,</span> 总金额 
<span class="token keyword">FROM</span> 订单表 <span class="token keyword">WITH</span><span class="token punctuation">(</span><span class="token keyword">INDEX</span><span class="token punctuation">(</span>IX_订单表_日期_金额<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">WHERE</span> 订单日期 <span class="token operator">BETWEEN</span> <span class="token string">'2024-01-01'</span> <span class="token operator">AND</span> <span class="token string">'2024-01-31'</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     🚀
     <strong>
      性能优化核心要点
     </strong>
     ：
    </p>
    <ol>
     <li>
      <p>
       索引使用原则：
      </p>
      <ul>
       <li>
        经常查询的列建立索引
       </li>
       <li>
        外键列必建索引
       </li>
       <li>
        避免对频繁更新的列建索引
       </li>
       <li>
        选择性高的列适合建索引
       </li>
      </ul>
     </li>
     <li>
      <p>
       最重要的优化技巧：
      </p>
      <ul>
       <li>
        使用覆盖索引避免回表
       </li>
       <li>
        避免索引列上使用函数
       </li>
       <li>
        避免隐式类型转换
       </li>
       <li>
        合理使用索引提示
       </li>
      </ul>
     </li>
     <li>
      <p>
       常见性能问题：
      </p>
      <ul>
       <li>
        索引碎片化：定期重建或重组
       </li>
       <li>
        统计信息过期：更新统计信息
       </li>
       <li>
        参数嗅探：使用OPTIMIZE FOR
       </li>
       <li>
        死锁：合理的事务处理
       </li>
      </ul>
     </li>
     <li>
      <p>
       性能监控工具：
      </p>
      <ul>
       <li>
        执行计划
       </li>
       <li>
        STATISTICS IO/TIME
       </li>
       <li>
        sys.dm_db_index_usage_stats
       </li>
       <li>
        数据库引擎优化顾问
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="4__239">
     </a>
     4. 事务和并发控制
    </h4>
    <p>
     让我们学习如何保证数据的一致性：
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- 1. 基本事务处理（最常用）</span>
<span class="token comment">-- 转账示例</span>
<span class="token keyword">BEGIN</span> TRY
    <span class="token keyword">BEGIN</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>
        <span class="token comment">-- 从账户A扣款</span>
        <span class="token keyword">UPDATE</span> 账户表
        <span class="token keyword">SET</span> 余额 <span class="token operator">=</span> 余额 <span class="token operator">-</span> <span class="token number">1000</span>
        <span class="token keyword">WHERE</span> 账户ID <span class="token operator">=</span> <span class="token string">'A'</span><span class="token punctuation">;</span>
        
        <span class="token comment">-- 给账户B存款</span>
        <span class="token keyword">UPDATE</span> 账户表
        <span class="token keyword">SET</span> 余额 <span class="token operator">=</span> 余额 <span class="token operator">+</span> <span class="token number">1000</span>
        <span class="token keyword">WHERE</span> 账户ID <span class="token operator">=</span> <span class="token string">'B'</span><span class="token punctuation">;</span>
        
        <span class="token comment">-- 记录交易日志</span>
        <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 交易日志<span class="token punctuation">(</span>交易类型<span class="token punctuation">,</span> 金额<span class="token punctuation">,</span> 时间<span class="token punctuation">)</span>
        <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'转账'</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">COMMIT</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> TRY
<span class="token keyword">BEGIN</span> CATCH
    <span class="token keyword">ROLLBACK</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>
    <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 错误日志<span class="token punctuation">(</span>错误信息<span class="token punctuation">,</span> 时间<span class="token punctuation">)</span>
    <span class="token keyword">VALUES</span> <span class="token punctuation">(</span>ERROR_MESSAGE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span> CATCH<span class="token punctuation">;</span>

<span class="token comment">-- 2. 事务隔离级别（重要）</span>
<span class="token comment">-- 设置隔离级别</span>
<span class="token keyword">SET</span> <span class="token keyword">TRANSACTION</span> <span class="token keyword">ISOLATION</span> <span class="token keyword">LEVEL</span> <span class="token keyword">READ</span> <span class="token keyword">COMMITTED</span><span class="token punctuation">;</span>

<span class="token comment">-- 处理并发访问</span>
<span class="token keyword">BEGIN</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>
    <span class="token comment">-- 使用锁提示</span>
    <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> 订单表 <span class="token keyword">WITH</span> <span class="token punctuation">(</span>UPDLOCK<span class="token punctuation">,</span> ROWLOCK<span class="token punctuation">)</span>
    <span class="token keyword">WHERE</span> 订单号 <span class="token operator">=</span> <span class="token string">'001'</span><span class="token punctuation">;</span>
    
    <span class="token comment">-- 更新订单</span>
    <span class="token keyword">UPDATE</span> 订单表
    <span class="token keyword">SET</span> 状态 <span class="token operator">=</span> <span class="token string">'已处理'</span>
    <span class="token keyword">WHERE</span> 订单号 <span class="token operator">=</span> <span class="token string">'001'</span><span class="token punctuation">;</span>
<span class="token keyword">COMMIT</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>

<span class="token comment">-- 3. 死锁处理（常见问题）</span>
<span class="token comment">-- 设置死锁优先级</span>
<span class="token keyword">SET</span> DEADLOCK_PRIORITY HIGH<span class="token punctuation">;</span>

<span class="token comment">-- 使用表锁提示避免死锁</span>
<span class="token keyword">UPDATE</span> 订单表 <span class="token keyword">WITH</span> <span class="token punctuation">(</span>ROWLOCK<span class="token punctuation">)</span>
<span class="token keyword">SET</span> 状态 <span class="token operator">=</span> <span class="token string">'处理中'</span>
<span class="token keyword">WHERE</span> 订单号 <span class="token operator">=</span> <span class="token string">'001'</span><span class="token punctuation">;</span>

<span class="token comment">-- 4. 并发控制最佳实践</span>
<span class="token comment">-- 使用乐观并发控制</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 商品表
<span class="token punctuation">(</span>
    商品ID <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    名称 NVARCHAR<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    库存 <span class="token keyword">INT</span><span class="token punctuation">,</span>
    版本号 ROWVERSION  <span class="token comment">-- 用于乐观并发控制</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 乐观并发更新示例</span>
<span class="token keyword">UPDATE</span> 商品表
<span class="token keyword">SET</span> 库存 <span class="token operator">=</span> 库存 <span class="token operator">-</span> <span class="token number">1</span>
<span class="token keyword">WHERE</span> 商品ID <span class="token operator">=</span> <span class="token number">1</span> 
<span class="token operator">AND</span> 版本号 <span class="token operator">=</span> @原版本号<span class="token punctuation">;</span>  <span class="token comment">-- 确保数据未被其他事务修改</span>
</code></pre>
    <p>
     🔒
     <strong>
      事务管理核心要点
     </strong>
     ：
    </p>
    <ol>
     <li>
      <p>
       事务ACID特性：
      </p>
      <ul>
       <li>
        原子性：要么全做要么全不做
       </li>
       <li>
        一致性：保持数据完整
       </li>
       <li>
        隔离性：事务间互不干扰
       </li>
       <li>
        持久性：提交后永久保存
       </li>
      </ul>
     </li>
     <li>
      <p>
       最常用的隔离级别：
      </p>
      <ul>
       <li>
        READ COMMITTED（默认）：防止脏读
       </li>
       <li>
        REPEATABLE READ：防止不可重复读
       </li>
       <li>
        SERIALIZABLE：最高隔离级别
       </li>
       <li>
        READ UNCOMMITTED：性能最好但不安全
       </li>
      </ul>
     </li>
     <li>
      <p>
       并发控制策略：
      </p>
      <ul>
       <li>
        悲观锁：适用于高并发更新
       </li>
       <li>
        乐观锁：适用于读多写少
       </li>
       <li>
        行级锁：粒度小，并发高
       </li>
       <li>
        表级锁：粒度大，阻塞多
       </li>
      </ul>
     </li>
     <li>
      <p>
       实践建议：
      </p>
      <ul>
       <li>
        事务尽可能短小
       </li>
       <li>
        合理设置隔离级别
       </li>
       <li>
        避免长时间持有锁
       </li>
       <li>
        正确的错误处理
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="5__335">
     </a>
     5. 备份和恢复
    </h4>
    <p>
     让我们学习如何保护数据安全：
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- 1. 完整备份（最基础最重要）</span>
<span class="token comment">-- 创建完整备份</span>
<span class="token keyword">BACKUP</span> <span class="token keyword">DATABASE</span> 学生管理系统
<span class="token keyword">TO</span> <span class="token keyword">DISK</span> <span class="token operator">=</span> <span class="token string">'D:\Backup\学生管理系统_Full.bak'</span>
<span class="token keyword">WITH</span> 
    COMPRESSION<span class="token punctuation">,</span>                 <span class="token comment">-- 启用压缩</span>
    CHECKSUM<span class="token punctuation">,</span>                   <span class="token comment">-- 验证备份完整性</span>
    DESCRIPTION <span class="token operator">=</span> <span class="token string">'完整备份'</span><span class="token punctuation">;</span>    <span class="token comment">-- 备份描述</span>

<span class="token comment">-- 2. 差异备份（节省空间和时间）</span>
<span class="token keyword">BACKUP</span> <span class="token keyword">DATABASE</span> 学生管理系统
<span class="token keyword">TO</span> <span class="token keyword">DISK</span> <span class="token operator">=</span> <span class="token string">'D:\Backup\学生管理系统_Diff.bak'</span>
<span class="token keyword">WITH</span> 
    DIFFERENTIAL<span class="token punctuation">,</span>               <span class="token comment">-- 差异备份</span>
    COMPRESSION<span class="token punctuation">;</span>

<span class="token comment">-- 3. 日志备份（保证时间点恢复）</span>
<span class="token keyword">BACKUP</span> LOG 学生管理系统
<span class="token keyword">TO</span> <span class="token keyword">DISK</span> <span class="token operator">=</span> <span class="token string">'D:\Backup\学生管理系统_Log.bak'</span>
<span class="token keyword">WITH</span> COMPRESSION<span class="token punctuation">;</span>

<span class="token comment">-- 4. 数据库恢复（最常用场景）</span>
<span class="token comment">-- 完整恢复</span>
<span class="token keyword">RESTORE</span> <span class="token keyword">DATABASE</span> 学生管理系统
<span class="token keyword">FROM</span> <span class="token keyword">DISK</span> <span class="token operator">=</span> <span class="token string">'D:\Backup\学生管理系统_Full.bak'</span>
<span class="token keyword">WITH</span> NORECOVERY<span class="token punctuation">;</span>  <span class="token comment">-- 允许继续还原其他备份</span>

<span class="token comment">-- 还原差异备份</span>
<span class="token keyword">RESTORE</span> <span class="token keyword">DATABASE</span> 学生管理系统
<span class="token keyword">FROM</span> <span class="token keyword">DISK</span> <span class="token operator">=</span> <span class="token string">'D:\Backup\学生管理系统_Diff.bak'</span>
<span class="token keyword">WITH</span> NORECOVERY<span class="token punctuation">;</span>

<span class="token comment">-- 还原日志备份到指定时间点</span>
<span class="token keyword">RESTORE</span> LOG 学生管理系统
<span class="token keyword">FROM</span> <span class="token keyword">DISK</span> <span class="token operator">=</span> <span class="token string">'D:\Backup\学生管理系统_Log.bak'</span>
<span class="token keyword">WITH</span> 
    STOPAT <span class="token operator">=</span> <span class="token string">'2024-01-15 14:30:00'</span><span class="token punctuation">,</span>  <span class="token comment">-- 指定恢复时间点</span>
    RECOVERY<span class="token punctuation">;</span>  <span class="token comment">-- 完成恢复，数据库可用</span>

<span class="token comment">-- 5. 自动化备份维护（生产环境必备）</span>
<span class="token comment">-- 清理过期备份文件</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@cmd</span> NVARCHAR<span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SET</span> <span class="token variable">@cmd</span> <span class="token operator">=</span> <span class="token string">'forfiles /p "D:\Backup" /s /m *.bak /d -30 /c "cmd /c del @path"'</span><span class="token punctuation">;</span>
<span class="token keyword">EXEC</span> xp_cmdshell <span class="token variable">@cmd</span><span class="token punctuation">;</span>

<span class="token comment">-- 验证备份有效性</span>
<span class="token keyword">RESTORE</span> VERIFYONLY 
<span class="token keyword">FROM</span> <span class="token keyword">DISK</span> <span class="token operator">=</span> <span class="token string">'D:\Backup\学生管理系统_Full.bak'</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     💾
     <strong>
      备份恢复核心要点
     </strong>
     ：
    </p>
    <ol>
     <li>
      <p>
       三种主要备份类型：
      </p>
      <ul>
       <li>
        完整备份：整个数据库的完整副本
       </li>
       <li>
        差异备份：自上次完整备份后的变化
       </li>
       <li>
        日志备份：记录详细的事务日志
       </li>
      </ul>
     </li>
     <li>
      <p>
       常用备份策略（最佳实践）：
      </p>
      <ul>
       <li>
        每周一次完整备份
       </li>
       <li>
        每天一次差异备份
       </li>
       <li>
        每小时一次日志备份
       </li>
       <li>
        定期验证备份有效性
       </li>
      </ul>
     </li>
     <li>
      <p>
       关键恢复场景：
      </p>
      <ul>
       <li>
        系统崩溃：使用最新的一致备份
       </li>
       <li>
        数据误删：使用时间点恢复
       </li>
       <li>
        硬件故障：完整恢复流程
       </li>
       <li>
        测试环境：快速还原生产数据
       </li>
      </ul>
     </li>
     <li>
      <p>
       备份管理要点：
      </p>
      <ul>
       <li>
        异地存储重要备份
       </li>
       <li>
        定期清理过期备份
       </li>
       <li>
        监控备份执行状态
       </li>
       <li>
        测试恢复流程
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="6__413">
     </a>
     6. 安全管理
    </h4>
    <p>
     让我们学习如何保护数据库安全：
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- 1. 用户和角色管理（基础安全）</span>
<span class="token comment">-- 创建登录名</span>
<span class="token keyword">CREATE</span> LOGIN 教师登录 
<span class="token keyword">WITH</span> PASSWORD <span class="token operator">=</span> <span class="token string">'P@ssw0rd123'</span><span class="token punctuation">,</span>
     CHECK_POLICY <span class="token operator">=</span> <span class="token keyword">ON</span><span class="token punctuation">;</span>  <span class="token comment">-- 启用密码策略</span>

<span class="token comment">-- 创建数据库用户</span>
<span class="token keyword">USE</span> 学生管理系统<span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">USER</span> 教师用户 <span class="token keyword">FOR</span> LOGIN 教师登录<span class="token punctuation">;</span>

<span class="token comment">-- 创建角色并分配权限</span>
<span class="token keyword">CREATE</span> ROLE 教师角色<span class="token punctuation">;</span>
<span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span><span class="token punctuation">,</span> <span class="token keyword">UPDATE</span> <span class="token keyword">ON</span> 成绩表 <span class="token keyword">TO</span> 教师角色<span class="token punctuation">;</span>
<span class="token keyword">GRANT</span> <span class="token keyword">SELECT</span> <span class="token keyword">ON</span> 学生表 <span class="token keyword">TO</span> 教师角色<span class="token punctuation">;</span>

<span class="token comment">-- 将用户添加到角色</span>
<span class="token keyword">ALTER</span> ROLE 教师角色 <span class="token keyword">ADD</span> MEMBER 教师用户<span class="token punctuation">;</span>

<span class="token comment">-- 2. 数据加密（敏感数据保护）</span>
<span class="token comment">-- 创建主密钥</span>
<span class="token keyword">CREATE</span> MASTER <span class="token keyword">KEY</span> ENCRYPTION 
<span class="token keyword">BY</span> PASSWORD <span class="token operator">=</span> <span class="token string">'YourStr0ngP@ssw0rd'</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建证书</span>
<span class="token keyword">CREATE</span> CERTIFICATE 学生信息证书
<span class="token keyword">WITH</span> SUBJECT <span class="token operator">=</span> <span class="token string">'学生敏感信息加密证书'</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建加密密钥</span>
<span class="token keyword">CREATE</span> SYMMETRIC <span class="token keyword">KEY</span> 学生信息加密密钥
<span class="token keyword">WITH</span> <span class="token keyword">ALGORITHM</span> <span class="token operator">=</span> AES_256
ENCRYPTION <span class="token keyword">BY</span> CERTIFICATE 学生信息证书<span class="token punctuation">;</span>

<span class="token comment">-- 加密数据示例</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 学生敏感信息
<span class="token punctuation">(</span>
    学号 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    姓名 NVARCHAR<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    身份证号 <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">-- 加密存储</span>
    联系电话 <span class="token keyword">VARBINARY</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span>   <span class="token comment">-- 加密存储</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 插入加密数据</span>
<span class="token keyword">OPEN</span> SYMMETRIC <span class="token keyword">KEY</span> 学生信息加密密钥
DECRYPTION <span class="token keyword">BY</span> CERTIFICATE 学生信息证书<span class="token punctuation">;</span>

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 学生敏感信息 
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2021001'</span><span class="token punctuation">,</span> <span class="token string">'张三'</span><span class="token punctuation">,</span>
    EncryptByKey<span class="token punctuation">(</span>Key_GUID<span class="token punctuation">(</span><span class="token string">'学生信息加密密钥'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'320123199901011234'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    EncryptByKey<span class="token punctuation">(</span>Key_GUID<span class="token punctuation">(</span><span class="token string">'学生信息加密密钥'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'13912345678'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CLOSE</span> SYMMETRIC <span class="token keyword">KEY</span> 学生信息加密密钥<span class="token punctuation">;</span>

<span class="token comment">-- 3. 审计跟踪（最重要的安全措施）</span>
<span class="token comment">-- 创建服务器审计</span>
<span class="token keyword">CREATE</span> SERVER AUDIT 数据库审计
<span class="token keyword">TO</span> <span class="token keyword">FILE</span> <span class="token punctuation">(</span>FILEPATH <span class="token operator">=</span> <span class="token string">'D:\Audit\');

-- 创建数据库审计规范
CREATE DATABASE AUDIT SPECIFICATION 学生数据审计
FOR SERVER AUDIT 数据库审计
ADD (SELECT, UPDATE, DELETE ON 学生表 BY PUBLIC),
ADD (SELECT, UPDATE ON 成绩表 BY PUBLIC);

-- 启用审计
ALTER SERVER AUDIT 数据库审计 WITH (STATE = ON);
ALTER DATABASE AUDIT SPECIFICATION 学生数据审计 WITH (STATE = ON);

-- 查看审计日志
SELECT * FROM fn_get_audit_file
('</span>D:\Audit\<span class="token operator">*</span><span class="token string">', DEFAULT, DEFAULT);

-- 4. 安全最佳实践
-- 定期修改密码
ALTER LOGIN 教师登录 
WITH PASSWORD = '</span>NewP<span class="token variable">@ssw0rd456</span><span class="token string">';

-- 禁用不用的账户
ALTER LOGIN 教师登录 DISABLE;

-- 回收不需要的权限
REVOKE UPDATE ON 成绩表 FROM 教师角色;

-- 监控登录失败
SELECT * FROM sys.dm_exec_sessions
WHERE login_time &gt; DATEADD(HOUR, -1, GETDATE())
AND login_name = '</span>教师登录'<span class="token punctuation">;</span>
</code></pre>
    <p>
     🔐
     <strong>
      安全管理核心要点
     </strong>
     ：
    </p>
    <ol>
     <li>
      <p>
       访问控制基础：
      </p>
      <ul>
       <li>
        最小权限原则
       </li>
       <li>
        基于角色的授权
       </li>
       <li>
        定期审查权限
       </li>
       <li>
        密码策略管理
       </li>
      </ul>
     </li>
     <li>
      <p>
       数据加密策略：
      </p>
      <ul>
       <li>
        敏感数据加密存储
       </li>
       <li>
        传输数据加密
       </li>
       <li>
        密钥定期轮换
       </li>
       <li>
        证书安全管理
       </li>
      </ul>
     </li>
     <li>
      <p>
       审计要点：
      </p>
      <ul>
       <li>
        重要操作必须审计
       </li>
       <li>
        定期检查审计日志
       </li>
       <li>
        异常行为告警
       </li>
       <li>
        审计日志安全存储
       </li>
      </ul>
     </li>
     <li>
      <p>
       安全维护：
      </p>
      <ul>
       <li>
        定期安全评估
       </li>
       <li>
        及时安装补丁
       </li>
       <li>
        监控可疑活动
       </li>
       <li>
        制定应急预案
       </li>
      </ul>
     </li>
    </ol>
    <h3>
     <a id="_531">
     </a>
     二、高级特性
    </h3>
    <p>
     让我们学习SQL Server最常用的高级功能：
    </p>
    <h4>
     <a id="1__534">
     </a>
     1. 存储过程和函数
    </h4>
    <pre><code class="prism language-sql"><span class="token comment">-- 1. 存储过程（最常用的封装方式）</span>
<span class="token comment">-- 创建成绩统计存储过程</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PROCEDURE</span> sp_统计学生成绩
    @班级 NVARCHAR<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    @及格率 <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> OUTPUT
<span class="token keyword">AS</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">SET</span> NOCOUNT <span class="token keyword">ON</span><span class="token punctuation">;</span>
    
    <span class="token comment">-- 计算及格率</span>
    <span class="token keyword">SELECT</span> @及格率 <span class="token operator">=</span> 
        <span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> 成绩 <span class="token operator">&gt;=</span> <span class="token number">60</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100.0</span> <span class="token operator">/</span> 
            <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">FROM</span> 成绩表 g
    <span class="token keyword">JOIN</span> 学生表 s <span class="token keyword">ON</span> g<span class="token punctuation">.</span>学号 <span class="token operator">=</span> s<span class="token punctuation">.</span>学号
    <span class="token keyword">WHERE</span> s<span class="token punctuation">.</span>班级 <span class="token operator">=</span> @班级<span class="token punctuation">;</span>
    
    <span class="token comment">-- 返回详细统计</span>
    <span class="token keyword">SELECT</span> 
        <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 总人数<span class="token punctuation">,</span>
        <span class="token function">AVG</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token keyword">AS</span> 平均分<span class="token punctuation">,</span>
        <span class="token function">MAX</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token keyword">AS</span> 最高分<span class="token punctuation">,</span>
        <span class="token function">MIN</span><span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token keyword">AS</span> 最低分
    <span class="token keyword">FROM</span> 成绩表 g
    <span class="token keyword">JOIN</span> 学生表 s <span class="token keyword">ON</span> g<span class="token punctuation">.</span>学号 <span class="token operator">=</span> s<span class="token punctuation">.</span>学号
    <span class="token keyword">WHERE</span> s<span class="token punctuation">.</span>班级 <span class="token operator">=</span> @班级<span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>

<span class="token comment">-- 调用存储过程</span>
<span class="token keyword">DECLARE</span> @及格率 <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">EXEC</span> sp_统计学生成绩 
    @班级 <span class="token operator">=</span> <span class="token string">'计算机1班'</span><span class="token punctuation">,</span>
    @及格率 <span class="token operator">=</span> @及格率 OUTPUT<span class="token punctuation">;</span>
<span class="token keyword">PRINT</span> <span class="token string">'及格率: '</span> <span class="token operator">+</span> CAST<span class="token punctuation">(</span>@及格率 <span class="token keyword">AS</span> <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'%'</span><span class="token punctuation">;</span>

<span class="token comment">-- 2. 自定义函数（常用计算封装）</span>
<span class="token comment">-- 创建年龄计算函数</span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> fn_计算年龄
<span class="token punctuation">(</span>
    @出生日期 <span class="token keyword">DATE</span>
<span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">INT</span>
<span class="token keyword">AS</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">RETURN</span> DATEDIFF<span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">,</span> @出生日期<span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span>
        <span class="token keyword">CASE</span> 
            <span class="token keyword">WHEN</span> DATEADD<span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">,</span> DATEDIFF<span class="token punctuation">(</span><span class="token keyword">YEAR</span><span class="token punctuation">,</span> @出生日期<span class="token punctuation">,</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> @出生日期<span class="token punctuation">)</span> <span class="token operator">&gt;</span> GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">THEN</span> <span class="token number">1</span> 
            <span class="token keyword">ELSE</span> <span class="token number">0</span> 
        <span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建成绩等级函数</span>
<span class="token keyword">CREATE</span> <span class="token keyword">FUNCTION</span> fn_计算等级
<span class="token punctuation">(</span>
    @成绩 <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
<span class="token keyword">RETURNS</span> <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token keyword">AS</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">RETURN</span> 
        <span class="token keyword">CASE</span> 
            <span class="token keyword">WHEN</span> @成绩 <span class="token operator">&gt;=</span> <span class="token number">90</span> <span class="token keyword">THEN</span> <span class="token string">'A'</span>
            <span class="token keyword">WHEN</span> @成绩 <span class="token operator">&gt;=</span> <span class="token number">80</span> <span class="token keyword">THEN</span> <span class="token string">'B'</span>
            <span class="token keyword">WHEN</span> @成绩 <span class="token operator">&gt;=</span> <span class="token number">70</span> <span class="token keyword">THEN</span> <span class="token string">'C'</span>
            <span class="token keyword">WHEN</span> @成绩 <span class="token operator">&gt;=</span> <span class="token number">60</span> <span class="token keyword">THEN</span> <span class="token string">'D'</span>
            <span class="token keyword">ELSE</span> <span class="token string">'F'</span>
        <span class="token keyword">END</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>

<span class="token comment">-- 使用函数</span>
<span class="token keyword">SELECT</span> 
    姓名<span class="token punctuation">,</span>
    dbo<span class="token punctuation">.</span>fn_计算年龄<span class="token punctuation">(</span>出生日期<span class="token punctuation">)</span> <span class="token keyword">AS</span> 年龄<span class="token punctuation">,</span>
    成绩<span class="token punctuation">,</span>
    dbo<span class="token punctuation">.</span>fn_计算等级<span class="token punctuation">(</span>成绩<span class="token punctuation">)</span> <span class="token keyword">AS</span> 等级
<span class="token keyword">FROM</span> 学生表 s
<span class="token keyword">JOIN</span> 成绩表 g <span class="token keyword">ON</span> s<span class="token punctuation">.</span>学号 <span class="token operator">=</span> g<span class="token punctuation">.</span>学号<span class="token punctuation">;</span>
</code></pre>
    <p>
     📦
     <strong>
      存储过程和函数要点
     </strong>
     ：
    </p>
    <ol>
     <li>
      <p>
       存储过程优势：
      </p>
      <ul>
       <li>
        减少网络流量
       </li>
       <li>
        重用业务逻辑
       </li>
       <li>
        提高执行效率
       </li>
       <li>
        增强安全性
       </li>
      </ul>
     </li>
     <li>
      <p>
       函数使用场景：
      </p>
      <ul>
       <li>
        复杂计算封装
       </li>
       <li>
        数据转换处理
       </li>
       <li>
        业务规则统一
       </li>
       <li>
        代码重用
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="2__630">
     </a>
     2. 触发器
    </h4>
    <pre><code class="prism language-sql"><span class="token comment">-- 1. 数据审计触发器（最常用）</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> tr_学生表_审计
<span class="token keyword">ON</span> 学生表
<span class="token keyword">AFTER</span> <span class="token keyword">INSERT</span><span class="token punctuation">,</span> <span class="token keyword">UPDATE</span><span class="token punctuation">,</span> <span class="token keyword">DELETE</span>
<span class="token keyword">AS</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">SET</span> NOCOUNT <span class="token keyword">ON</span><span class="token punctuation">;</span>
    
    <span class="token comment">-- 插入操作审计</span>
    <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 审计日志<span class="token punctuation">(</span>表名<span class="token punctuation">,</span> 操作类型<span class="token punctuation">,</span> 操作时间<span class="token punctuation">,</span> 操作用户<span class="token punctuation">,</span> 数据<span class="token punctuation">)</span>
    <span class="token keyword">SELECT</span> 
        <span class="token string">'学生表'</span><span class="token punctuation">,</span>
        <span class="token string">'INSERT'</span><span class="token punctuation">,</span>
        GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">SYSTEM_USER</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> inserted <span class="token keyword">FOR</span> JSON AUTO<span class="token punctuation">)</span>
    <span class="token keyword">FROM</span> inserted
    <span class="token keyword">WHERE</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span> <span class="token keyword">FROM</span> inserted<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">-- 删除操作审计</span>
    <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 审计日志<span class="token punctuation">(</span>表名<span class="token punctuation">,</span> 操作类型<span class="token punctuation">,</span> 操作时间<span class="token punctuation">,</span> 操作用户<span class="token punctuation">,</span> 数据<span class="token punctuation">)</span>
    <span class="token keyword">SELECT</span> 
        <span class="token string">'学生表'</span><span class="token punctuation">,</span>
        <span class="token string">'DELETE'</span><span class="token punctuation">,</span>
        GETDATE<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">SYSTEM_USER</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> deleted <span class="token keyword">FOR</span> JSON AUTO<span class="token punctuation">)</span>
    <span class="token keyword">FROM</span> deleted
    <span class="token keyword">WHERE</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token number">1</span> <span class="token keyword">FROM</span> deleted<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>

<span class="token comment">-- 2. 业务规则触发器（数据验证）</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TRIGGER</span> tr_成绩表_验证
<span class="token keyword">ON</span> 成绩表
INSTEAD <span class="token keyword">OF</span> <span class="token keyword">INSERT</span>
<span class="token keyword">AS</span>
<span class="token keyword">BEGIN</span>
    <span class="token keyword">SET</span> NOCOUNT <span class="token keyword">ON</span><span class="token punctuation">;</span>
    
    <span class="token comment">-- 验证成绩范围</span>
    <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> <span class="token number">1</span> <span class="token keyword">FROM</span> inserted 
        <span class="token keyword">WHERE</span> 成绩 <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">OR</span> 成绩 <span class="token operator">&gt;</span> <span class="token number">100</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">BEGIN</span>
        <span class="token keyword">RAISERROR</span> <span class="token punctuation">(</span><span class="token string">'成绩必须在0-100之间'</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">RETURN</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span><span class="token punctuation">;</span>
    
    <span class="token comment">-- 验证通过后插入数据</span>
    <span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 成绩表<span class="token punctuation">(</span>学号<span class="token punctuation">,</span> 课程号<span class="token punctuation">,</span> 成绩<span class="token punctuation">)</span>
    <span class="token keyword">SELECT</span> 学号<span class="token punctuation">,</span> 课程号<span class="token punctuation">,</span> 成绩
    <span class="token keyword">FROM</span> inserted<span class="token punctuation">;</span>
<span class="token keyword">END</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     🔄
     <strong>
      触发器使用要点
     </strong>
     ：
    </p>
    <ol>
     <li>
      <p>
       常用场景：
      </p>
      <ul>
       <li>
        数据审计跟踪
       </li>
       <li>
        业务规则验证
       </li>
       <li>
        数据同步更新
       </li>
       <li>
        自动计算汇总
       </li>
      </ul>
     </li>
     <li>
      <p>
       设计原则：
      </p>
      <ul>
       <li>
        触发器要简单
       </li>
       <li>
        避免长事务
       </li>
       <li>
        注意性能影响
       </li>
       <li>
        合理使用事务
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="3__701">
     </a>
     3. 视图
    </h4>
    <p>
     让我们继续学习视图的应用：
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- 1. 基础视图（最常用）</span>
<span class="token comment">-- 创建学生成绩汇总视图</span>
<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> v_学生成绩汇总
<span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> 
    s<span class="token punctuation">.</span>学号<span class="token punctuation">,</span>
    s<span class="token punctuation">.</span>姓名<span class="token punctuation">,</span>
    s<span class="token punctuation">.</span>班级<span class="token punctuation">,</span>
    <span class="token function">COUNT</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>课程号<span class="token punctuation">)</span> <span class="token keyword">AS</span> 课程数<span class="token punctuation">,</span>
    <span class="token function">AVG</span><span class="token punctuation">(</span>g<span class="token punctuation">.</span>成绩<span class="token punctuation">)</span> <span class="token keyword">AS</span> 平均分<span class="token punctuation">,</span>
    <span class="token function">SUM</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> g<span class="token punctuation">.</span>成绩 <span class="token operator">&gt;=</span> <span class="token number">60</span> <span class="token keyword">THEN</span> <span class="token number">1</span> <span class="token keyword">ELSE</span> <span class="token number">0</span> <span class="token keyword">END</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 及格课程数
<span class="token keyword">FROM</span> 学生表 s
<span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> 成绩表 g <span class="token keyword">ON</span> s<span class="token punctuation">.</span>学号 <span class="token operator">=</span> g<span class="token punctuation">.</span>学号
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> s<span class="token punctuation">.</span>学号<span class="token punctuation">,</span> s<span class="token punctuation">.</span>姓名<span class="token punctuation">,</span> s<span class="token punctuation">.</span>班级<span class="token punctuation">;</span>

<span class="token comment">-- 2. 带检查选项的视图（数据验证）</span>
<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> v_优秀学生
<span class="token keyword">WITH</span> SCHEMABINDING
<span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> 学号<span class="token punctuation">,</span> 姓名<span class="token punctuation">,</span> 班级<span class="token punctuation">,</span> 成绩
<span class="token keyword">FROM</span> dbo<span class="token punctuation">.</span>成绩表 g
<span class="token keyword">JOIN</span> dbo<span class="token punctuation">.</span>学生表 s <span class="token keyword">ON</span> g<span class="token punctuation">.</span>学号 <span class="token operator">=</span> s<span class="token punctuation">.</span>学号
<span class="token keyword">WHERE</span> 成绩 <span class="token operator">&gt;=</span> <span class="token number">90</span>
<span class="token keyword">WITH</span> <span class="token keyword">CHECK</span> <span class="token keyword">OPTION</span><span class="token punctuation">;</span>

<span class="token comment">-- 3. 索引视图（提高查询性能）</span>
<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> v_课程平均分
<span class="token keyword">WITH</span> SCHEMABINDING
<span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> 
    课程号<span class="token punctuation">,</span>
    COUNT_BIG<span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 学生数<span class="token punctuation">,</span>
    <span class="token function">AVG</span><span class="token punctuation">(</span><span class="token keyword">CONVERT</span><span class="token punctuation">(</span><span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 成绩<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 平均分
<span class="token keyword">FROM</span> dbo<span class="token punctuation">.</span>成绩表
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> 课程号<span class="token punctuation">;</span>

<span class="token comment">-- 在视图上创建唯一聚集索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">UNIQUE</span> <span class="token keyword">CLUSTERED</span> <span class="token keyword">INDEX</span> IX_课程平均分
<span class="token keyword">ON</span> v_课程平均分<span class="token punctuation">(</span>课程号<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 4. 分区视图（大表分区）</span>
<span class="token comment">-- 创建分区表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 历史成绩表_2023
<span class="token punctuation">(</span>
    学号 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    课程号 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    成绩 <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    学年 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>学年 <span class="token operator">=</span> <span class="token string">'2023'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 历史成绩表_2024
<span class="token punctuation">(</span>
    学号 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    课程号 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    成绩 <span class="token keyword">DECIMAL</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    学年 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>学年 <span class="token operator">=</span> <span class="token string">'2024'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建分区视图</span>
<span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> v_历史成绩
<span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> 历史成绩表_2023
<span class="token keyword">UNION</span> <span class="token keyword">ALL</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> 历史成绩表_2024<span class="token punctuation">;</span>

<span class="token comment">-- 5. 视图的使用示例</span>
<span class="token comment">-- 查询优秀学生</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> v_优秀学生
<span class="token keyword">WHERE</span> 班级 <span class="token operator">=</span> <span class="token string">'计算机1班'</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> 成绩 <span class="token keyword">DESC</span><span class="token punctuation">;</span>

<span class="token comment">-- 更新视图数据</span>
<span class="token keyword">UPDATE</span> v_学生成绩汇总
<span class="token keyword">SET</span> 班级 <span class="token operator">=</span> <span class="token string">'计算机2班'</span>
<span class="token keyword">WHERE</span> 学号 <span class="token operator">=</span> <span class="token string">'2021001'</span><span class="token punctuation">;</span>

<span class="token comment">-- 通过视图插入数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> v_优秀学生<span class="token punctuation">(</span>学号<span class="token punctuation">,</span> 姓名<span class="token punctuation">,</span> 班级<span class="token punctuation">,</span> 成绩<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token string">'2021010'</span><span class="token punctuation">,</span> <span class="token string">'李四'</span><span class="token punctuation">,</span> <span class="token string">'计算机1班'</span><span class="token punctuation">,</span> <span class="token number">95</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     👁️
     <strong>
      视图使用要点
     </strong>
     ：
    </p>
    <ol>
     <li>
      <p>
       视图的优势：
      </p>
      <ul>
       <li>
        简化复杂查询
       </li>
       <li>
        控制数据访问
       </li>
       <li>
        提供数据独立性
       </li>
       <li>
        实现数据安全
       </li>
      </ul>
     </li>
     <li>
      <p>
       常用视图类型：
      </p>
      <ul>
       <li>
        基础视图：简化查询
       </li>
       <li>
        索引视图：提升性能
       </li>
       <li>
        分区视图：管理大数据
       </li>
       <li>
        更新视图：维护数据
       </li>
      </ul>
     </li>
     <li>
      <p>
       设计原则：
      </p>
      <ul>
       <li>
        避免过于复杂的视图
       </li>
       <li>
        合理使用索引视图
       </li>
       <li>
        注意更新限制
       </li>
       <li>
        控制视图嵌套层数
       </li>
      </ul>
     </li>
     <li>
      <p>
       性能考虑：
      </p>
      <ul>
       <li>
        适当使用SCHEMABINDING
       </li>
       <li>
        避免使用SELECT *
       </li>
       <li>
        合理使用索引
       </li>
       <li>
        控制视图复杂度
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="4_XMLJSON_811">
     </a>
     4. XML和JSON
    </h4>
    <p>
     让我们学习如何处理结构化数据：
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- 1. XML数据处理（常用于数据交换）</span>
<span class="token comment">-- 创建包含XML列的表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 学生档案
<span class="token punctuation">(</span>
    学号 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    基本信息 XML<span class="token punctuation">,</span>
    成绩记录 XML
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 插入XML数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 学生档案<span class="token punctuation">(</span>学号<span class="token punctuation">,</span> 基本信息<span class="token punctuation">)</span>
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span>
    <span class="token string">'2021001'</span><span class="token punctuation">,</span>
    <span class="token string">'&lt;学生&gt;
        &lt;姓名&gt;张三&lt;/姓名&gt;
        &lt;性别&gt;男&lt;/性别&gt;
        &lt;联系方式&gt;
            &lt;电话&gt;13912345678&lt;/电话&gt;
            &lt;邮箱&gt;zhangsan@example.com&lt;/邮箱&gt;
        &lt;/联系方式&gt;
    &lt;/学生&gt;'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询XML数据</span>
<span class="token keyword">SELECT</span> 
    学号<span class="token punctuation">,</span>
    基本信息<span class="token punctuation">.</span><span class="token keyword">value</span><span class="token punctuation">(</span><span class="token string">'(/学生/姓名)[1]'</span><span class="token punctuation">,</span> <span class="token string">'NVARCHAR(20)'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 姓名<span class="token punctuation">,</span>
    基本信息<span class="token punctuation">.</span><span class="token keyword">value</span><span class="token punctuation">(</span><span class="token string">'(/学生/联系方式/电话)[1]'</span><span class="token punctuation">,</span> <span class="token string">'VARCHAR(20)'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 联系电话
<span class="token keyword">FROM</span> 学生档案<span class="token punctuation">;</span>

<span class="token comment">-- 使用XML索引提高查询性能</span>
<span class="token keyword">CREATE</span> <span class="token keyword">PRIMARY</span> XML <span class="token keyword">INDEX</span> PX_学生档案_基本信息
<span class="token keyword">ON</span> 学生档案<span class="token punctuation">(</span>基本信息<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 2. JSON数据处理（更现代的选择）</span>
<span class="token comment">-- 将查询结果转为JSON</span>
<span class="token keyword">SELECT</span> 
    学号<span class="token punctuation">,</span>
    姓名<span class="token punctuation">,</span>
    班级<span class="token punctuation">,</span>
    成绩
<span class="token keyword">FROM</span> 学生表 s
<span class="token keyword">JOIN</span> 成绩表 g <span class="token keyword">ON</span> s<span class="token punctuation">.</span>学号 <span class="token operator">=</span> g<span class="token punctuation">.</span>学号
<span class="token keyword">FOR</span> JSON PATH<span class="token punctuation">;</span>

<span class="token comment">-- 创建包含JSON的表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 学生信息扩展
<span class="token punctuation">(</span>
    学号 <span class="token keyword">CHAR</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    扩展信息 NVARCHAR<span class="token punctuation">(</span>MAX<span class="token punctuation">)</span>
    <span class="token keyword">CHECK</span> <span class="token punctuation">(</span>ISJSON<span class="token punctuation">(</span>扩展信息<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">-- 确保是有效的JSON</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 插入JSON数据</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> 学生信息扩展
<span class="token keyword">VALUES</span> <span class="token punctuation">(</span>
    <span class="token string">'2021001'</span><span class="token punctuation">,</span>
    <span class="token string">'{
        "兴趣爱好": ["编程", "篮球", "音乐"],
        "获奖记录": [
            {"时间": "2023-06", "奖项": "编程大赛一等奖"},
            {"时间": "2023-12", "奖项": "优秀学生"}
        ],
        "实习经历": {
            "公司": "科技公司",
            "职位": "开发实习生",
            "时间": "2023-07至2023-09"
        }
    }'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 查询JSON数据</span>
<span class="token keyword">SELECT</span> 
    学号<span class="token punctuation">,</span>
    JSON_VALUE<span class="token punctuation">(</span>扩展信息<span class="token punctuation">,</span> <span class="token string">'$.实习经历.公司'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 实习公司<span class="token punctuation">,</span>
    JSON_QUERY<span class="token punctuation">(</span>扩展信息<span class="token punctuation">,</span> <span class="token string">'$.兴趣爱好'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 兴趣爱好
<span class="token keyword">FROM</span> 学生信息扩展<span class="token punctuation">;</span>

<span class="token comment">-- 3. 结构化数据转换（常用场景）</span>
<span class="token comment">-- 行转列（XML方式）</span>
<span class="token keyword">SELECT</span> 
    学号<span class="token punctuation">,</span>
    姓名<span class="token punctuation">,</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> 课程号 <span class="token keyword">AS</span> <span class="token string">'@课程'</span><span class="token punctuation">,</span> 成绩 <span class="token keyword">AS</span> <span class="token string">'@分数'</span>
        <span class="token keyword">FROM</span> 成绩表
        <span class="token keyword">WHERE</span> 学号 <span class="token operator">=</span> s<span class="token punctuation">.</span>学号
        <span class="token keyword">FOR</span> XML PATH<span class="token punctuation">(</span><span class="token string">'课程'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ROOT<span class="token punctuation">(</span><span class="token string">'成绩记录'</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> 成绩XML
<span class="token keyword">FROM</span> 学生表 s<span class="token punctuation">;</span>

<span class="token comment">-- 行转列（JSON方式）</span>
<span class="token keyword">SELECT</span> 
    学号<span class="token punctuation">,</span>
    姓名<span class="token punctuation">,</span>
    <span class="token punctuation">(</span>
        <span class="token keyword">SELECT</span> 课程号<span class="token punctuation">,</span> 成绩
        <span class="token keyword">FROM</span> 成绩表
        <span class="token keyword">WHERE</span> 学号 <span class="token operator">=</span> s<span class="token punctuation">.</span>学号
        <span class="token keyword">FOR</span> JSON PATH
    <span class="token punctuation">)</span> <span class="token keyword">AS</span> 成绩JSON
<span class="token keyword">FROM</span> 学生表 s<span class="token punctuation">;</span>

<span class="token comment">-- 4. 数据导入导出</span>
<span class="token comment">-- 导出XML数据</span>
<span class="token keyword">SELECT</span> 学号<span class="token punctuation">,</span> 姓名<span class="token punctuation">,</span> 班级
<span class="token keyword">FROM</span> 学生表
<span class="token keyword">FOR</span> XML PATH<span class="token punctuation">(</span><span class="token string">'学生'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ROOT<span class="token punctuation">(</span><span class="token string">'学生列表'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 导出JSON数据</span>
<span class="token keyword">SELECT</span> 学号<span class="token punctuation">,</span> 姓名<span class="token punctuation">,</span> 班级
<span class="token keyword">FROM</span> 学生表
<span class="token keyword">FOR</span> JSON PATH<span class="token punctuation">,</span> ROOT<span class="token punctuation">(</span><span class="token string">'学生列表'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 解析JSON数组</span>
<span class="token keyword">SELECT</span> 
    学号<span class="token punctuation">,</span>
    兴趣
<span class="token keyword">FROM</span> 学生信息扩展
<span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> OPENJSON<span class="token punctuation">(</span>扩展信息<span class="token punctuation">,</span> <span class="token string">'$.兴趣爱好'</span><span class="token punctuation">)</span>
    <span class="token keyword">WITH</span> <span class="token punctuation">(</span>兴趣 NVARCHAR<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token string">'$'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     📊
     <strong>
      结构化数据处理要点
     </strong>
     ：
    </p>
    <ol>
     <li>
      <p>
       XML使用场景：
      </p>
      <ul>
       <li>
        数据交换接口
       </li>
       <li>
        配置文件存储
       </li>
       <li>
        复杂数据结构
       </li>
       <li>
        遗留系统集成
       </li>
      </ul>
     </li>
     <li>
      <p>
       JSON优势：
      </p>
      <ul>
       <li>
        更轻量级的格式
       </li>
       <li>
        更好的可读性
       </li>
       <li>
        前后端数据传输
       </li>
       <li>
        现代API集成
       </li>
      </ul>
     </li>
     <li>
      <p>
       性能考虑：
      </p>
      <ul>
       <li>
        适当使用XML索引
       </li>
       <li>
        JSON数据类型验证
       </li>
       <li>
        避免过大的文档
       </li>
       <li>
        合理的查询方式
       </li>
      </ul>
     </li>
     <li>
      <p>
       最佳实践：
      </p>
      <ul>
       <li>
        选择合适的格式
       </li>
       <li>
        规范的数据结构
       </li>
       <li>
        有效的错误处理
       </li>
       <li>
        定期数据维护
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="5__963">
     </a>
     5. 全文检索
    </h4>
    <p>
     让我们学习如何实现高效的文本搜索：
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- 1. 全文检索配置（基础设置）</span>
<span class="token comment">-- 创建全文目录</span>
<span class="token keyword">CREATE</span> FULLTEXT CATALOG 文章目录
<span class="token keyword">WITH</span> ACCENT_SENSITIVITY <span class="token operator">=</span> <span class="token keyword">OFF</span>
<span class="token keyword">AS</span> <span class="token keyword">DEFAULT</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建包含大文本的表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> 文章表
<span class="token punctuation">(</span>
    文章ID <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span><span class="token punctuation">,</span>
    标题 NVARCHAR<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    内容 NVARCHAR<span class="token punctuation">(</span>MAX<span class="token punctuation">)</span><span class="token punctuation">,</span>
    作者 NVARCHAR<span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    发布时间 DATETIME2
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 创建全文索引</span>
<span class="token keyword">CREATE</span> FULLTEXT <span class="token keyword">INDEX</span> <span class="token keyword">ON</span> 文章表
<span class="token punctuation">(</span>
    标题 <span class="token keyword">LANGUAGE</span> <span class="token number">2052</span><span class="token punctuation">,</span>  <span class="token comment">-- 简体中文</span>
    内容 <span class="token keyword">LANGUAGE</span> <span class="token number">2052</span>
<span class="token punctuation">)</span>
<span class="token keyword">KEY</span> <span class="token keyword">INDEX</span> PK__文章表__ID
<span class="token keyword">ON</span> 文章目录
<span class="token keyword">WITH</span> CHANGE_TRACKING AUTO<span class="token punctuation">;</span>

<span class="token comment">-- 2. 基本全文搜索（最常用）</span>
<span class="token comment">-- 简单匹配</span>
<span class="token keyword">SELECT</span> 文章ID<span class="token punctuation">,</span> 标题<span class="token punctuation">,</span> 作者
<span class="token keyword">FROM</span> 文章表
<span class="token keyword">WHERE</span> <span class="token keyword">CONTAINS</span><span class="token punctuation">(</span>内容<span class="token punctuation">,</span> <span class="token string">'数据库'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 多个关键词（任意匹配）</span>
<span class="token keyword">SELECT</span> 文章ID<span class="token punctuation">,</span> 标题
<span class="token keyword">FROM</span> 文章表
<span class="token keyword">WHERE</span> <span class="token keyword">CONTAINS</span><span class="token punctuation">(</span>内容<span class="token punctuation">,</span> <span class="token string">'SQL OR 数据库'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 精确短语匹配</span>
<span class="token keyword">SELECT</span> 文章ID<span class="token punctuation">,</span> 标题
<span class="token keyword">FROM</span> 文章表
<span class="token keyword">WHERE</span> <span class="token keyword">CONTAINS</span><span class="token punctuation">(</span>内容<span class="token punctuation">,</span> <span class="token string">'"SQL Server 优化"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 3. 高级搜索功能</span>
<span class="token comment">-- 近似匹配</span>
<span class="token keyword">SELECT</span> 文章ID<span class="token punctuation">,</span> 标题
<span class="token keyword">FROM</span> 文章表
<span class="token keyword">WHERE</span> <span class="token keyword">CONTAINS</span><span class="token punctuation">(</span>内容<span class="token punctuation">,</span> <span class="token string">'NEAR((数据库, 优化), 10)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 通配符搜索</span>
<span class="token keyword">SELECT</span> 文章ID<span class="token punctuation">,</span> 标题
<span class="token keyword">FROM</span> 文章表
<span class="token keyword">WHERE</span> <span class="token keyword">CONTAINS</span><span class="token punctuation">(</span>内容<span class="token punctuation">,</span> <span class="token string">'"SQL*"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 加权搜索</span>
<span class="token keyword">SELECT</span> 文章ID<span class="token punctuation">,</span> 标题<span class="token punctuation">,</span>
    RANK
<span class="token keyword">FROM</span> 文章表
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> <span class="token keyword">CONTAINSTABLE</span><span class="token punctuation">(</span>文章表<span class="token punctuation">,</span> <span class="token punctuation">(</span>标题<span class="token punctuation">,</span> 内容<span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token string">'数据库 OR 优化'</span><span class="token punctuation">,</span>
    <span class="token keyword">LANGUAGE</span> <span class="token number">2052</span>
<span class="token punctuation">)</span> <span class="token keyword">AS</span> KEY_TBL
<span class="token keyword">ON</span> 文章表<span class="token punctuation">.</span>文章ID <span class="token operator">=</span> KEY_TBL<span class="token punctuation">.</span><span class="token punctuation">[</span><span class="token keyword">KEY</span><span class="token punctuation">]</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> RANK <span class="token keyword">DESC</span><span class="token punctuation">;</span>

<span class="token comment">-- 4. 全文搜索最佳实践</span>
<span class="token comment">-- 创建复合全文索引</span>
<span class="token keyword">CREATE</span> FULLTEXT <span class="token keyword">INDEX</span> <span class="token keyword">ON</span> 文章表
<span class="token punctuation">(</span>
    标题 <span class="token keyword">LANGUAGE</span> <span class="token number">2052</span> STATISTICAL_SEMANTICS<span class="token punctuation">,</span>
    内容 <span class="token keyword">LANGUAGE</span> <span class="token number">2052</span> STATISTICAL_SEMANTICS<span class="token punctuation">,</span>
    作者 <span class="token keyword">LANGUAGE</span> <span class="token number">2052</span>
<span class="token punctuation">)</span>
<span class="token keyword">KEY</span> <span class="token keyword">INDEX</span> PK__文章表__ID
<span class="token keyword">ON</span> 文章目录
<span class="token keyword">WITH</span> CHANGE_TRACKING AUTO<span class="token punctuation">;</span>

<span class="token comment">-- 使用停用词</span>
<span class="token keyword">CREATE</span> FULLTEXT STOPLIST 自定义停用词
<span class="token keyword">FROM</span> SYSTEM STOPLIST<span class="token punctuation">;</span>

<span class="token keyword">ALTER</span> FULLTEXT STOPLIST 自定义停用词
<span class="token keyword">ADD</span> <span class="token string">'的'</span> <span class="token keyword">LANGUAGE</span> <span class="token number">2052</span><span class="token punctuation">;</span>

<span class="token comment">-- 更新全文索引</span>
<span class="token keyword">ALTER</span> FULLTEXT <span class="token keyword">INDEX</span> <span class="token keyword">ON</span> 文章表
<span class="token keyword">SET</span> STOPLIST 自定义停用词<span class="token punctuation">;</span>

<span class="token comment">-- 5. 性能优化示例</span>
<span class="token comment">-- 重建全文索引</span>
<span class="token keyword">ALTER</span> FULLTEXT <span class="token keyword">INDEX</span> <span class="token keyword">ON</span> 文章表
<span class="token keyword">START</span> <span class="token keyword">FULL</span> POPULATION<span class="token punctuation">;</span>

<span class="token comment">-- 增量更新</span>
<span class="token keyword">ALTER</span> FULLTEXT <span class="token keyword">INDEX</span> <span class="token keyword">ON</span> 文章表
<span class="token keyword">START</span> INCREMENTAL POPULATION<span class="token punctuation">;</span>

<span class="token comment">-- 查看索引状态</span>
<span class="token keyword">SELECT</span> 
    OBJECT_NAME<span class="token punctuation">(</span>object_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> 表名<span class="token punctuation">,</span>
    FULLTEXTCATALOGPROPERTY<span class="token punctuation">(</span><span class="token string">'文章目录'</span><span class="token punctuation">,</span> <span class="token string">'ItemCount'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 索引文档数<span class="token punctuation">,</span>
    FULLTEXTCATALOGPROPERTY<span class="token punctuation">(</span><span class="token string">'文章目录'</span><span class="token punctuation">,</span> <span class="token string">'PopulateStatus'</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> 填充状态
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>fulltext_indexes
<span class="token keyword">WHERE</span> object_id <span class="token operator">=</span> OBJECT_ID<span class="token punctuation">(</span><span class="token string">'文章表'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     🔍
     <strong>
      全文检索核心要点
     </strong>
     ：
    </p>
    <ol>
     <li>
      <p>
       基础配置：
      </p>
      <ul>
       <li>
        创建全文目录
       </li>
       <li>
        配置全文索引
       </li>
       <li>
        设置语言选项
       </li>
       <li>
        管理停用词
       </li>
      </ul>
     </li>
     <li>
      <p>
       搜索功能：
      </p>
      <ul>
       <li>
        简单关键词搜索
       </li>
       <li>
        精确短语匹配
       </li>
       <li>
        近似词搜索
       </li>
       <li>
        加权排序结果
       </li>
      </ul>
     </li>
     <li>
      <p>
       性能优化：
      </p>
      <ul>
       <li>
        合理使用索引
       </li>
       <li>
        定期重建索引
       </li>
       <li>
        增量更新策略
       </li>
       <li>
        监控索引状态
       </li>
      </ul>
     </li>
     <li>
      <p>
       使用建议：
      </p>
      <ul>
       <li>
        选择合适的列
       </li>
       <li>
        控制索引大小
       </li>
       <li>
        优化搜索语句
       </li>
       <li>
        定期维护索引
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <p>
     以上就是全部内容了，如果各位大佬有任何疑问，欢迎在评论区留言，你的点赞收藏我创作的最大动力！🥰🥰🥰
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f38303233353236322f:61727469636c652f64657461696c732f313436313132323434" class_="artid" style="display:none">
 </p>
</div>


