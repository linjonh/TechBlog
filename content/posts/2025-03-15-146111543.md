---
layout: post
title: "qwen2.5-vl多机多卡分布式部署"
date: 2025-03-15 17:52:48 +0800
description: "记录一下工作中进行多机多卡部署qwen2.5-vl多模态大模型踩过的坑第一个天坑就是官方提供的镜像qwenllm/qwenvl:2.5-cu121有问题，在titan显卡会抛出cuda error:no kernel image is availabe for execution on the device. 这是cuda内核与GPU不兼容的问题，可是手动制作的其他cuda12镜像就能跑。"
keywords: "qwen2.5-vl多机多卡分布式部署"
categories: ['未分类']
tags: ['语言模型', '自然语言处理', '深度学习', '分布式', '人工智能', 'Transformer', 'Chatgpt']
artid: "146111543"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146111543
    alt: "qwen2.5-vl多机多卡分布式部署"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146111543
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146111543
cover: https://bing.ee123.net/img/rand?artid=146111543
image: https://bing.ee123.net/img/rand?artid=146111543
img: https://bing.ee123.net/img/rand?artid=146111543
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     qwen2.5-vl多机多卡分布式部署
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     记录一下工作中进行多机多卡部署qwen2.5-vl多模态大模型踩过的坑
     <br/>
     第一个天坑就是官方提供的镜像qwenllm/qwenvl:2.5-cu121有问题，在titan显卡会抛出cuda error:no kernel image is availabe for execution on the device. 这是cuda内核与GPU不兼容的问题，可是手动制作的其他cuda12镜像就能跑。在官网镜像基础上重装cuda11.8，倒是可以用了，但在gradio页面调用时会出现卡死情况，最终还是自己从头配置环境。关于如何配置docker镜像，没啥技术点，这里不说了。
    </p>
    <h2>
     <a id="__3">
     </a>
     一 容器配置
    </h2>
    <p>
     使用ray+vllm方式进行分布式部署，采用host模式。当一台机器不是所有机器都可用时，需要通过CUDA_VISIBLE_DEVICES变量指定ray分布式使用的显卡编号，通常在起容器时指定，当使用显卡编号有变化时，停掉分布式，在容器内手动指定显卡后再重新搭建分布式集群。
    </p>
    <p>
     另外，机器之间的通信要指定网卡，host模式容器直接使用宿主机网卡，通过ifconfig查看当前机器可用网卡，每台机器网卡可能不同，所以在启动容器时将当前机器的网卡以环境变量的形式传入。下面就是集群中两台机器使用不同网卡的案例。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1c32ef7dadc0413785df0dead7dde8f3.png"/>
    </p>
    <p>
     下面是一个启动容器的docker-compose命令，容器不分head与work节点，在容器内搭建集群时指定。
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3"</span>

<span class="token key atrule">services</span><span class="token punctuation">:</span>
	<span class="token comment"># 服务名,可以不与container_name同名, 在Nginx中使用服务名做调度,</span>
    <span class="token key atrule">yblir_qwen2.5-vl</span><span class="token punctuation">:</span>
        <span class="token key atrule">image</span><span class="token punctuation">:</span> qwen2.5<span class="token punctuation">-</span>vl<span class="token punctuation">:</span>cu12<span class="token punctuation">-</span>torch25<span class="token punctuation">-</span>vllm073<span class="token punctuation">-</span>dist
        <span class="token key atrule">container_name</span><span class="token punctuation">:</span> dist_head_qwen2.5<span class="token punctuation">-</span>vl
        
        <span class="token comment"># 获取宿主机root权限,要映射端口也需要true</span>
        <span class="token key atrule">privileged</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        <span class="token comment"># 设置共享内存大小为16g,防止分布式训练dataloader时出错</span>
        <span class="token key atrule">shm_size</span><span class="token punctuation">:</span> <span class="token string">"32gb"</span>
		
		<span class="token comment"># 路径映射, 主机目录:容器内目录</span>
        <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> /home/data/liyabin_project<span class="token punctuation">:</span>/home
        <span class="token comment">#ports:</span>
        <span class="token comment">#    - "10086:22"        # 容器内22端口映射到外部10086,22端口通常用于在外部调用容器内Python环境</span>
        <span class="token comment">#    - "10087:10087"     # 用途待定,比如可以tensorboard --logdir=路径 --port 10087  </span>
        <span class="token comment"># 从外部传入变量</span>
        <span class="token key atrule">environment</span><span class="token punctuation">:</span>
             <span class="token punctuation">-</span> NVIDIA_VISIBLE_DEVICES=0<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span>
             <span class="token punctuation">-</span> GLOO_SOCKET_IFNAME=enp134s0f0
             <span class="token punctuation">-</span> NCCL_SOCKET_IFNAME=enp134s0f0

        <span class="token comment"># 容器重新启动,比如当容器被其他人kill了,会自动重启</span>
        <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
        <span class="token key atrule">entrypoint</span><span class="token punctuation">:</span> /bin/bash
        <span class="token comment"># command: ["-c", "ray start --head --dashboard-host=0.0.0 --port 6379"]</span>
        <span class="token key atrule">tty</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
        
        <span class="token key atrule">network_mode</span><span class="token punctuation">:</span>
            <span class="token string">"bridge"</span>    <span class="token comment"># 默认桥接模式,容器之间不须要互相通讯.</span>
            "host"    <span class="token comment"># 当前模式下ports端口映射失效, 容器环境不隔离，将使用主机的端口和ip.</span>
</code></pre>
    <p>
     注意，所有容器的环境，容器内模型文件路径必须一致。
    </p>
    <p>
     vllm官方给了一个部署脚本，不好用，这里使用更灵活的手动搭建集群的方法。前面说在搭建集群时确定head与work节点，
     <br/>
     在想做head节点的容器内执行如下命令：
    </p>
    <pre><code class="prism language-bash">ray start <span class="token parameter variable">--head</span> --dashboard-host<span class="token operator">=</span><span class="token number">0.0</span>.0.0 <span class="token parameter variable">--port</span><span class="token operator">=</span><span class="token number">6379</span>
</code></pre>
    <p>
     在work容器节点执行如下命令：
    </p>
    <pre><code class="prism language-bash">ray start <span class="token parameter variable">--address</span><span class="token operator">=</span><span class="token string">'xx.xx.xx.xx:6379'</span>
</code></pre>
    <p>
     只能有一个head节点，work可以有多个。
    </p>
    <p>
     在任意容器节点执行ray status,可以看到集群上所有节点设备情况
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2e87d60925e84633a15871a5ffca4c94.png">
      ray另一个常用命令是ray stop, 停止集群。在head节点上执行会杀掉整个集群，在work节点上执行则仅会卸载当前节点。
      <br/>
      关于ray, 会使用这两个命令就能应对绝大部分集群问题。
     </img>
    </p>
    <p>
     在head节点执行启动集群时，会暴露一个URL，在浏览器页面监控设备使用情况：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e9ae5363539a4eb59b852a709a62ba26.png">
      <br/>
      如果一切顺利，到此完成集群搭建工作了，不过过程中难免会出现各种各样的坑，比如我曾在2x8 2080ti设备上搭建集群，work节点介入集群后很快就掉线，推测大概率时机器间通信不稳定造成的，所以，搭建集群的机器尽量处在同一网段。
     </img>
    </p>
    <h2>
     <a id="__71">
     </a>
     二 环境测试
    </h2>
    <p>
     搭建好集群后，还需要对环境做测试，保证代码能跑通。
     <br/>
     部署qwen2.5-vl最低环境要求为vllm&gt;=0.7.2, transformers&gt;=4.49
    </p>
    <p>
     使用vllm命令行启动3b量化版来做测试：
    </p>
    <pre><code class="prism language-bash">vllm serve /home/Qwen2.5-VL-3B-Instruct-AWQ --tensor-parallel-size <span class="token number">2</span> --pipeline-parallel-size <span class="token number">2</span> <span class="token parameter variable">--dtype</span> float16 <span class="token punctuation">\</span>
<span class="token parameter variable">--port</span> <span class="token number">8811</span> --gpu-memory-untilization <span class="token number">0.5</span> --max-num-seqs <span class="token number">2</span> --max-model-len <span class="token number">4096</span> --enforce-eager
</code></pre>
    <ul>
     <li>
      问题1 cuda error: cuda error:no kernel image is availabe for execution on the device
      <br/>
      问题看起来是cuda内核与GPU不兼容，开始以为是各种依赖包和cuda装的版本太高，不兼容titan显卡了，多次排查无果，只得重装cuda11.8,问题解决。之后又从零构建了cuda12.1的镜像，可以正常使用，只能把锅甩给qwen官方提供的镜像有问题。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7280a616ba6f4bcbbc3d87d3e38438e1.png"/>
     </li>
     <li>
      问题2 attendtion计算后端不兼容问题
      <br/>
      xformers wasn’t build with CUDA suport
      <br/>
      requires device with capability &gt; (8, 0) but your GPU has capability (7, 5)
      <br/>
      原因：计算后端要在当前设备上现场编译，比如下面这个，xformers是在其他显卡预编译好的，使用时就会报错。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bf3b72329aed4fd69b3c85574c53a178.png">
       <br/>
       下载xformers源码编译安装，之后查看xformers详细信息。
      </img>
     </li>
    </ul>
    <pre><code class="prism language-python">python <span class="token operator">-</span>m xformers<span class="token punctuation">.</span>info
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1fec8912474c498eabf7040c01ed7e32.png"/>
    </p>
    <ul>
     <li>
      问题3 量化问题
      <br/>
      The input size is not aligned with the quantized weight shape. This can be casused by too large tensor parallel size
      <br/>
      官方早起Qwen2.5-VL-72B-Instruct-AWQ没做好，记得是FFN层参数不能整除的原因，不支持–tensor-parallel-size 2,4,8等设置，不过现在新版模型官方已经做好，不纠结这个问题了。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a8b79d4d10684475947357421789fa95.png">
       - 问题4 max_model_len设置问题
       <br/>
       valueerror: The model’s max seq len (10240) is larger than the maximum number of tokens that can be stored in KV cache (3408). Try increasing ‘gpu_memory_utilization’ or decreasing max_model_len when initializing the engine.
       <br/>
       原因: 这是设定最大上下文长度超过可存储的最大的kv-cache数量, 是显存不足的表现之一,增加gpu_memory_utilization或减少max_model_len可解决
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e203acd692b446849a6249f596233033.png"/>
       <br/>
       max_model_len由入参指定, kv-cache在初始化时配置, 二者是一对相互矛盾的值, 当把max_model_len从10240减小到5120时, cuda blocks可用之从213增加到2090.
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5e4bf632340f44d6994a3bf8dcd0221d.png"/>
      </img>
     </li>
     <li>
      问题5 显存不足的另一中表现
      <br/>
      torch.outofmemoryerror:cuda out of memory. tried to allocate 640.00MiB GPU 0 has a total capacity …
      <br/>
      解决方案同问题4, 当修改gpu_memory_utilization后,报错信息无变化(连报错数值都没变化), 基本可确定是max_model_len引起的. 这是因为vllm初始化时会提前开辟一块显存空间存储max_model_len个全0 kv-cache备用, 开启这块空间时显存不够引起了报错. 关于max_model_len与kv-cache的关系在问题4中有说明.
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6114877cbb344ff9bebee7faff8889af.png"/>
     </li>
     <li>
      问题6 head整除问题
      <br/>
      total number of attention heads(16) must be divisible by tensor parallel size(6)
      <br/>
      这是–tensor-parallel-size值没设定好,这个值必须被attention heads 整数. 模型head数量在模型文件config.json中可查看.
      <br/>
      vllm 中tensor-parallel-size=N是指张量并行,标准说法是将 QKV 投影的参数矩阵会被切分成 N 份，每个 GPU 只存储并计算其中的一部分. 说人话就是一个attention由多个head attention组成, 将所有heads均分到N个gpu上做计算(有行并行和列并行的两种方式), 然后合并结果.
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/03d07a51ce254f00a7c4cab45bf0ef10.png"/>
     </li>
     <li>
      问题7 分布式启动问题
      <br/>
      runtimeError: cannot re-initialize cuda in forked subprocess. To use CUDA with multiprocessing. you must use the ‘spawn’ start method
      <br/>
      原因: vllm与torch两个组件分布式模块冲突, 在环境变量或启动脚本中指定分布式方式就好.
     </li>
    </ul>
    <pre><code class="prism language-python"><span class="token keyword">import</span> os
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'VLLM_WORKER_MULTIPROC_METHOD'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">'spawn'</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6cc19f231e91417f9063869ca883bc28.png"/>
    </p>
    <h2>
     <a id="__123">
     </a>
     三 服务代码改写及部署
    </h2>
    <p>
     使用vllm serve启动服务,然后通过request请求调用, 这是常用的方式,在上一份工作
     <a href="https://blog.csdn.net/weixin_42479327/article/details/146199434">
      qwen2.5-vl使用vllm部署gradio页面调用
     </a>
     已经详细描述过
    </p>
    <p>
     工作中本地部署还尝试了另一方案,即改造qwen2.5-vl官方给的本地gradio页面调用的方式. vllm+gradio属于异步调用, 要使用vllm的AsyncLLMEngine来构建推理模型.
    </p>
    <pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>
<span class="token comment"># @Time    : 2025/3/10 下午19:31</span>
<span class="token comment"># @Author  : yblir</span>
<span class="token comment"># @File    : dist_demo_mm.py</span>
<span class="token comment"># explain  :</span>
<span class="token comment"># =======================================================</span>

<span class="token keyword">import</span> copy
<span class="token keyword">import</span> re
<span class="token keyword">from</span> argparse <span class="token keyword">import</span> ArgumentParser

<span class="token comment"># from threading import Thread</span>
<span class="token keyword">import</span> threading
<span class="token keyword">from</span> vllm <span class="token keyword">import</span> SamplingParams<span class="token punctuation">,</span> AsyncLLMEngine
<span class="token keyword">from</span> vllm<span class="token punctuation">.</span>engine<span class="token punctuation">.</span>arg_utils <span class="token keyword">import</span> AsyncEngineArgs

<span class="token keyword">import</span> gradio <span class="token keyword">as</span> gr
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> qwen_vl_utils <span class="token keyword">import</span> process_vision_info
<span class="token keyword">from</span> transformers <span class="token keyword">import</span> AutoProcessor<span class="token punctuation">,</span> Qwen2_5_VLForConditionalGeneration<span class="token punctuation">,</span> TextIteratorStreamer

<span class="token comment"># DEFAULT_CKPT_PATH = '/home/Qwen2.5-VL-7B-Instruct'</span>
<span class="token comment"># DEFAULT_CKPT_PATH = r'E:\PyCharm\PreTrainModel\Qwen2.5-VL-7B-Instruct'</span>
DEFAULT_CKPT_PATH <span class="token operator">=</span> <span class="token string">'/home/Qwen25-VL-3B-Instruct-AWQ'</span>


<span class="token keyword">def</span> <span class="token function">_get_args</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    parser <span class="token operator">=</span> ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>

    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-c'</span><span class="token punctuation">,</span>
                        <span class="token string">'--checkpoint-path'</span><span class="token punctuation">,</span>
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span>
                        default<span class="token operator">=</span>DEFAULT_CKPT_PATH<span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Checkpoint name or path, default to %(default)r'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--cpu-only'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Run demo with CPU only'</span><span class="token punctuation">)</span>

    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--flash-attn2'</span><span class="token punctuation">,</span>
                        action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span>
                        default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Enable flash_attention_2 when loading the model.'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--share'</span><span class="token punctuation">,</span>
                        action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span>
                        default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Create a publicly shareable link for the interface.'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--inbrowser'</span><span class="token punctuation">,</span>
                        action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span>
                        default<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Automatically launch the interface in a new tab on the default browser.'</span><span class="token punctuation">)</span>
    <span class="token comment"># ===================================================================================================================</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--server-port'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token number">7860</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Demo server port.'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--server-name'</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'Demo server name.'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--max-image-nums'</span><span class="token punctuation">,</span>
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span>
                        default<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'多轮对话时可接受的最大图片数量'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--dtype'</span><span class="token punctuation">,</span>
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">str</span><span class="token punctuation">,</span>
                        default<span class="token operator">=</span><span class="token string">'float16'</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'模型处理的数据类型,这里默认使用flaot16,减少显存'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--gpu-memory-utilization'</span><span class="token punctuation">,</span>
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">float</span><span class="token punctuation">,</span>
                        default<span class="token operator">=</span><span class="token number">0.15</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'vllm要占用的gpu显存比例,若有其他程序也在使用显卡, 需要把该值设小'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--enforce-eager'</span><span class="token punctuation">,</span>
                        action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span>
                        default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'false时使用cuda graph, 会增加显存占用'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--max-model-len'</span><span class="token punctuation">,</span>
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span>
                        default<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'可处理的最大输入token数量, 如果进行多轮对话,需要设置大值,不然token数量会超标,'</span>
                             <span class="token string">'也可以缺省,不设上限, 不过这样有报显存风险'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--tensor-parallel-size'</span><span class="token punctuation">,</span>
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span>
                        default<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'一台机器上使用的gpu数量, 该值的设定需要被attention的head数量整除'</span><span class="token punctuation">)</span>
    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--pipeline-parallel-size'</span><span class="token punctuation">,</span>
                        <span class="token builtin">type</span><span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">,</span>
                        default<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>
                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'分布式系统使用的机器数量'</span><span class="token punctuation">)</span>
    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> args


<span class="token keyword">def</span> <span class="token function">_parse_text</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    lines <span class="token operator">=</span> text<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span>
    lines <span class="token operator">=</span> <span class="token punctuation">[</span>line <span class="token keyword">for</span> line <span class="token keyword">in</span> lines <span class="token keyword">if</span> line <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">]</span>
    count <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> line <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>lines<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token string">'```'</span> <span class="token keyword">in</span> line<span class="token punctuation">:</span>
            count <span class="token operator">+=</span> <span class="token number">1</span>
            items <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> count <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'&lt;pre&gt;&lt;code class="language-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>items<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"&gt;'</span></span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'&lt;br&gt;&lt;/code&gt;&lt;/pre&gt;'</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> i <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> count <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
                    line <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'`'</span><span class="token punctuation">,</span> <span class="token string">r'\`'</span><span class="token punctuation">)</span>
                    line <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'&lt;'</span><span class="token punctuation">,</span> <span class="token string">'&amp;lt;'</span><span class="token punctuation">)</span>
                    line <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'&gt;'</span><span class="token punctuation">,</span> <span class="token string">'&amp;gt;'</span><span class="token punctuation">)</span>
                    line <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">,</span> <span class="token string">'&amp;nbsp;'</span><span class="token punctuation">)</span>
                    line <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token string">'&amp;ast;'</span><span class="token punctuation">)</span>
                    line <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'_'</span><span class="token punctuation">,</span> <span class="token string">'&amp;lowbar;'</span><span class="token punctuation">)</span>
                    line <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">,</span> <span class="token string">'&amp;#45;'</span><span class="token punctuation">)</span>
                    line <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">'&amp;#46;'</span><span class="token punctuation">)</span>
                    line <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'!'</span><span class="token punctuation">,</span> <span class="token string">'&amp;#33;'</span><span class="token punctuation">)</span>
                    line <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'('</span><span class="token punctuation">,</span> <span class="token string">'&amp;#40;'</span><span class="token punctuation">)</span>
                    line <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">')'</span><span class="token punctuation">,</span> <span class="token string">'&amp;#41;'</span><span class="token punctuation">)</span>
                    line <span class="token operator">=</span> line<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'$'</span><span class="token punctuation">,</span> <span class="token string">'&amp;#36;'</span><span class="token punctuation">)</span>
                lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'&lt;br&gt;'</span> <span class="token operator">+</span> line
    text <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>lines<span class="token punctuation">)</span>
    <span class="token keyword">return</span> text


<span class="token keyword">def</span> <span class="token function">_remove_image_special</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">:</span>
    text <span class="token operator">=</span> text<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'&lt;ref&gt;'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'&lt;/ref&gt;'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> re<span class="token punctuation">.</span>sub<span class="token punctuation">(</span><span class="token string">r'&lt;box&gt;.*?(&lt;/box&gt;|$)'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">,</span> text<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">_is_video_file</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
    video_extensions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'.mp4'</span><span class="token punctuation">,</span> <span class="token string">'.avi'</span><span class="token punctuation">,</span> <span class="token string">'.mkv'</span><span class="token punctuation">,</span> <span class="token string">'.mov'</span><span class="token punctuation">,</span> <span class="token string">'.wmv'</span><span class="token punctuation">,</span> <span class="token string">'.flv'</span><span class="token punctuation">,</span> <span class="token string">'.webm'</span><span class="token punctuation">,</span> <span class="token string">'.mpeg'</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token builtin">any</span><span class="token punctuation">(</span>filename<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>endswith<span class="token punctuation">(</span>ext<span class="token punctuation">)</span> <span class="token keyword">for</span> ext <span class="token keyword">in</span> video_extensions<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">_gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> gc
    gc<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>empty_cache<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">_transform_messages</span><span class="token punctuation">(</span>original_messages<span class="token punctuation">)</span><span class="token punctuation">:</span>
    transformed_messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> message <span class="token keyword">in</span> original_messages<span class="token punctuation">:</span>
        new_content <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> item <span class="token keyword">in</span> message<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token string">'image'</span> <span class="token keyword">in</span> item<span class="token punctuation">:</span>
                new_item <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'image'</span><span class="token punctuation">,</span> <span class="token string">'image'</span><span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
            <span class="token keyword">elif</span> <span class="token string">'text'</span> <span class="token keyword">in</span> item<span class="token punctuation">:</span>
                new_item <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'text'</span><span class="token punctuation">,</span> <span class="token string">'text'</span><span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
            <span class="token keyword">elif</span> <span class="token string">'video'</span> <span class="token keyword">in</span> item<span class="token punctuation">:</span>
                new_item <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'type'</span><span class="token punctuation">:</span> <span class="token string">'video'</span><span class="token punctuation">,</span> <span class="token string">'video'</span><span class="token punctuation">:</span> item<span class="token punctuation">[</span><span class="token string">'video'</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>
            new_content<span class="token punctuation">.</span>append<span class="token punctuation">(</span>new_item<span class="token punctuation">)</span>

        new_message <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> message<span class="token punctuation">[</span><span class="token string">'role'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> new_content<span class="token punctuation">}</span>
        transformed_messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span>new_message<span class="token punctuation">)</span>

    <span class="token keyword">return</span> transformed_messages


<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">async_generate</span><span class="token punctuation">(</span>request_id<span class="token punctuation">,</span> engine<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    sampling_params <span class="token operator">=</span> SamplingParams<span class="token punctuation">(</span>
            temperature<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">,</span>
            top_p<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">,</span>
            repetition_penalty<span class="token operator">=</span><span class="token number">1.05</span><span class="token punctuation">,</span>
            max_tokens<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span>
            stop_token_ids<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span>
    response_gen <span class="token operator">=</span> engine<span class="token punctuation">.</span>generate<span class="token punctuation">(</span>
            request_id<span class="token operator">=</span>request_id<span class="token punctuation">,</span>
            prompt<span class="token operator">=</span>inputs<span class="token punctuation">,</span>
            sampling_params<span class="token operator">=</span>sampling_params
    <span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">for</span> result <span class="token keyword">in</span> response_gen<span class="token punctuation">:</span>
        <span class="token keyword">for</span> output <span class="token keyword">in</span> result<span class="token punctuation">.</span>outputs<span class="token punctuation">:</span>
            <span class="token keyword">yield</span> output<span class="token punctuation">.</span>text


<span class="token keyword">def</span> <span class="token function">_launch_demo</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> model<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">call_local_model</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> processor<span class="token punctuation">,</span> messages<span class="token punctuation">)</span><span class="token punctuation">:</span>
        request_id <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"req-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>threading<span class="token punctuation">.</span>get_ident<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>

        messages <span class="token operator">=</span> _transform_messages<span class="token punctuation">(</span>messages<span class="token punctuation">)</span>
        text <span class="token operator">=</span> processor<span class="token punctuation">.</span>apply_chat_template<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> tokenize<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> add_generation_prompt<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token comment"># image_inputs, video_inputs = process_vision_info(messages)</span>
        image_inputs<span class="token punctuation">,</span> video_inputs<span class="token punctuation">,</span> video_kwargs <span class="token operator">=</span> process_vision_info<span class="token punctuation">(</span>messages<span class="token punctuation">,</span> return_video_kwargs<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        mm_data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token keyword">if</span> image_inputs <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            mm_data<span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">]</span> <span class="token operator">=</span> image_inputs
        <span class="token keyword">if</span> video_inputs <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            mm_data<span class="token punctuation">[</span><span class="token string">"video"</span><span class="token punctuation">]</span> <span class="token operator">=</span> video_inputs
        ll_inputs <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'prompt'</span>             <span class="token punctuation">:</span> text<span class="token punctuation">,</span>
            <span class="token string">'multi_modal_data'</span>   <span class="token punctuation">:</span> mm_data<span class="token punctuation">,</span>
            <span class="token comment"># FPS will be returned in video_kwargs</span>
            <span class="token string">"mm_processor_kwargs"</span><span class="token punctuation">:</span> video_kwargs
        <span class="token punctuation">}</span>

        <span class="token keyword">async</span> <span class="token keyword">for</span> new_next <span class="token keyword">in</span> async_generate<span class="token punctuation">(</span>request_id<span class="token punctuation">,</span> model<span class="token punctuation">,</span> ll_inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">yield</span> new_next

    <span class="token keyword">def</span> <span class="token function">create_predict_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">predict</span><span class="token punctuation">(</span>_chatbot<span class="token punctuation">,</span> task_history<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">nonlocal</span> model<span class="token punctuation">,</span> processor
            chat_query <span class="token operator">=</span> _chatbot<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            query <span class="token operator">=</span> task_history<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>chat_query<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                _chatbot<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
                task_history<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">yield</span> _chatbot
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'User: '</span> <span class="token operator">+</span> _parse_text<span class="token punctuation">(</span>query<span class="token punctuation">)</span><span class="token punctuation">)</span>
            history_cp <span class="token operator">=</span> copy<span class="token punctuation">.</span>deepcopy<span class="token punctuation">(</span>task_history<span class="token punctuation">)</span>
            full_response <span class="token operator">=</span> <span class="token string">''</span>
            messages <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            content <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            <span class="token keyword">for</span> q<span class="token punctuation">,</span> a <span class="token keyword">in</span> history_cp<span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token builtin">tuple</span><span class="token punctuation">,</span> <span class="token builtin">list</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    <span class="token keyword">if</span> _is_video_file<span class="token punctuation">(</span>q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                        content<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'video'</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f'file://</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        content<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'image'</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f'file://</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>q<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    content<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'text'</span><span class="token punctuation">:</span> q<span class="token punctuation">}</span><span class="token punctuation">)</span>
                    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> content<span class="token punctuation">}</span><span class="token punctuation">)</span>
                    messages<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'role'</span><span class="token punctuation">:</span> <span class="token string">'assistant'</span><span class="token punctuation">,</span> <span class="token string">'content'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">'text'</span><span class="token punctuation">:</span> a<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
                    content <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            messages<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token keyword">async</span> <span class="token keyword">for</span> response <span class="token keyword">in</span> call_local_model<span class="token punctuation">(</span>model<span class="token punctuation">,</span> processor<span class="token punctuation">,</span> messages<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token comment"># print("response=",response)</span>
                _chatbot<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>_parse_text<span class="token punctuation">(</span>chat_query<span class="token punctuation">)</span><span class="token punctuation">,</span> _remove_image_special<span class="token punctuation">(</span>_parse_text<span class="token punctuation">(</span>response<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                <span class="token keyword">yield</span> _chatbot
                full_response <span class="token operator">=</span> _parse_text<span class="token punctuation">(</span>response<span class="token punctuation">)</span>

            task_history<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>query<span class="token punctuation">,</span> full_response<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Qwen-VL-Chat: '</span> <span class="token operator">+</span> _parse_text<span class="token punctuation">(</span>full_response<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">yield</span> _chatbot

        <span class="token keyword">return</span> predict

    <span class="token keyword">def</span> <span class="token function">create_regenerate_fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">regenerate</span><span class="token punctuation">(</span>_chatbot<span class="token punctuation">,</span> task_history<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">nonlocal</span> model<span class="token punctuation">,</span> processor
            <span class="token keyword">if</span> <span class="token keyword">not</span> task_history<span class="token punctuation">:</span>
                <span class="token keyword">yield</span> _chatbot
            item <span class="token operator">=</span> task_history<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            <span class="token keyword">if</span> item<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token keyword">yield</span> _chatbot
            task_history<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
            chatbot_item <span class="token operator">=</span> _chatbot<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> chatbot_item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                _chatbot<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>_chatbot<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                _chatbot<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>chatbot_item<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            _chatbot_gen <span class="token operator">=</span> predict<span class="token punctuation">(</span>_chatbot<span class="token punctuation">,</span> task_history<span class="token punctuation">)</span>
            <span class="token keyword">async</span> <span class="token keyword">for</span> _chatbot <span class="token keyword">in</span> _chatbot_gen<span class="token punctuation">:</span>
                <span class="token keyword">yield</span> _chatbot

        <span class="token keyword">return</span> regenerate

    predict <span class="token operator">=</span> create_predict_fn<span class="token punctuation">(</span><span class="token punctuation">)</span>
    regenerate <span class="token operator">=</span> create_regenerate_fn<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">add_text</span><span class="token punctuation">(</span>history<span class="token punctuation">,</span> task_history<span class="token punctuation">,</span> text<span class="token punctuation">)</span><span class="token punctuation">:</span>
        task_text <span class="token operator">=</span> text
        history <span class="token operator">=</span> history <span class="token keyword">if</span> history <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        task_history <span class="token operator">=</span> task_history <span class="token keyword">if</span> task_history <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        history <span class="token operator">=</span> history <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>_parse_text<span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        task_history <span class="token operator">=</span> task_history <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>task_text<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> history<span class="token punctuation">,</span> task_history<span class="token punctuation">,</span> <span class="token string">''</span>

    <span class="token keyword">def</span> <span class="token function">add_file</span><span class="token punctuation">(</span>history<span class="token punctuation">,</span> task_history<span class="token punctuation">,</span> <span class="token builtin">file</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        history <span class="token operator">=</span> history <span class="token keyword">if</span> history <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        task_history <span class="token operator">=</span> task_history <span class="token keyword">if</span> task_history <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span> <span class="token keyword">else</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        history <span class="token operator">=</span> history <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        task_history <span class="token operator">=</span> task_history <span class="token operator">+</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">file</span><span class="token punctuation">.</span>name<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
        <span class="token keyword">return</span> history<span class="token punctuation">,</span> task_history

    <span class="token keyword">def</span> <span class="token function">reset_user_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> gr<span class="token punctuation">.</span>update<span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">reset_state</span><span class="token punctuation">(</span>_chatbot<span class="token punctuation">,</span> task_history<span class="token punctuation">)</span><span class="token punctuation">:</span>
        task_history<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        _chatbot<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
        _gc<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Blocks<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> demo<span class="token punctuation">:</span>
        gr<span class="token punctuation">.</span>Markdown<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""\
&lt;p align="center"&gt;&lt;img src="https://modelscope.oss-cn-beijing.aliyuncs.com/resource/qwen.png" style="height: 80px"/&gt;&lt;p&gt;"""</span>
                    <span class="token punctuation">)</span>
        gr<span class="token punctuation">.</span>Markdown<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""&lt;center&gt;&lt;font size=8&gt;Qwen2.5-VL&lt;/center&gt;"""</span><span class="token punctuation">)</span>
        gr<span class="token punctuation">.</span>Markdown<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""\
&lt;center&gt;&lt;font size=3&gt;This WebUI is based on Qwen2.5-VL, developed by Alibaba Cloud.&lt;/center&gt;"""</span><span class="token punctuation">)</span>
        gr<span class="token punctuation">.</span>Markdown<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""&lt;center&gt;&lt;font size=3&gt;本WebUI基于Qwen2.5-VL�?/center&gt;"""</span><span class="token punctuation">)</span>

        chatbot <span class="token operator">=</span> gr<span class="token punctuation">.</span>Chatbot<span class="token punctuation">(</span>label<span class="token operator">=</span><span class="token string">'Qwen2.5-VL'</span><span class="token punctuation">,</span> elem_classes<span class="token operator">=</span><span class="token string">'control-height'</span><span class="token punctuation">,</span> height<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">)</span>
        query <span class="token operator">=</span> gr<span class="token punctuation">.</span>Textbox<span class="token punctuation">(</span>lines<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Input'</span><span class="token punctuation">)</span>
        task_history <span class="token operator">=</span> gr<span class="token punctuation">.</span>State<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        <span class="token keyword">with</span> gr<span class="token punctuation">.</span>Row<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            addfile_btn <span class="token operator">=</span> gr<span class="token punctuation">.</span>UploadButton<span class="token punctuation">(</span><span class="token string">'📁 Upload (上传文件)'</span><span class="token punctuation">,</span> file_types<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'image'</span><span class="token punctuation">,</span> <span class="token string">'video'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            submit_btn <span class="token operator">=</span> gr<span class="token punctuation">.</span>Button<span class="token punctuation">(</span><span class="token string">'🚀 Submit (发送)'</span><span class="token punctuation">)</span>
            regen_btn <span class="token operator">=</span> gr<span class="token punctuation">.</span>Button<span class="token punctuation">(</span><span class="token string">'🤔️ Regenerate (重试)'</span><span class="token punctuation">)</span>
            empty_bin <span class="token operator">=</span> gr<span class="token punctuation">.</span>Button<span class="token punctuation">(</span><span class="token string">'🧹 Clear History (清除历史)'</span><span class="token punctuation">)</span>

        submit_btn<span class="token punctuation">.</span>click<span class="token punctuation">(</span>add_text<span class="token punctuation">,</span> <span class="token punctuation">[</span>chatbot<span class="token punctuation">,</span> task_history<span class="token punctuation">,</span> query<span class="token punctuation">]</span><span class="token punctuation">,</span>
                         <span class="token punctuation">[</span>chatbot<span class="token punctuation">,</span> task_history<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>then<span class="token punctuation">(</span>predict<span class="token punctuation">,</span> <span class="token punctuation">[</span>chatbot<span class="token punctuation">,</span> task_history<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>chatbot<span class="token punctuation">]</span><span class="token punctuation">,</span> show_progress<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        submit_btn<span class="token punctuation">.</span>click<span class="token punctuation">(</span>reset_user_input<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>query<span class="token punctuation">]</span><span class="token punctuation">)</span>
        empty_bin<span class="token punctuation">.</span>click<span class="token punctuation">(</span>reset_state<span class="token punctuation">,</span> <span class="token punctuation">[</span>chatbot<span class="token punctuation">,</span> task_history<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>chatbot<span class="token punctuation">]</span><span class="token punctuation">,</span> show_progress<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        regen_btn<span class="token punctuation">.</span>click<span class="token punctuation">(</span>regenerate<span class="token punctuation">,</span> <span class="token punctuation">[</span>chatbot<span class="token punctuation">,</span> task_history<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>chatbot<span class="token punctuation">]</span><span class="token punctuation">,</span> show_progress<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        addfile_btn<span class="token punctuation">.</span>upload<span class="token punctuation">(</span>add_file<span class="token punctuation">,</span> <span class="token punctuation">[</span>chatbot<span class="token punctuation">,</span> task_history<span class="token punctuation">,</span> addfile_btn<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>chatbot<span class="token punctuation">,</span> task_history<span class="token punctuation">]</span><span class="token punctuation">,</span> show_progress<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        gr<span class="token punctuation">.</span>Markdown<span class="token punctuation">(</span><span class="token triple-quoted-string string">"""\
&lt;font size=2&gt;Note: This demo is governed by the original license of Qwen2.5-VL. \
We strongly advise users not to knowingly generate or allow others to knowingly generate harmful content, \
including hate speech, violence, pornography, deception, etc. \
(注：本演示受Qwen2.5-VL的许可协议限制。我们强烈建议，用户不应传播及不应允许他人传播以下内容，\
包括但不限于仇恨言论、暴力、色情、欺诈相关的有害信息�?"""</span><span class="token punctuation">)</span>

    demo<span class="token punctuation">.</span>queue<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>launch<span class="token punctuation">(</span>
            share<span class="token operator">=</span>args<span class="token punctuation">.</span>share<span class="token punctuation">,</span>
            inbrowser<span class="token operator">=</span>args<span class="token punctuation">.</span>inbrowser<span class="token punctuation">,</span>
            server_port<span class="token operator">=</span>args<span class="token punctuation">.</span>server_port<span class="token punctuation">,</span>
            server_name<span class="token operator">=</span>args<span class="token punctuation">.</span>server_name<span class="token punctuation">,</span>
    <span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    args <span class="token operator">=</span> _get_args<span class="token punctuation">(</span><span class="token punctuation">)</span>
    engine_args <span class="token operator">=</span> AsyncEngineArgs<span class="token punctuation">(</span>
            model<span class="token operator">=</span>args<span class="token punctuation">.</span>checkpoint_path<span class="token punctuation">,</span>
            limit_mm_per_prompt<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">"image"</span><span class="token punctuation">:</span> args<span class="token punctuation">.</span>max_image_nums<span class="token punctuation">,</span> <span class="token string">"video"</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            dtype<span class="token operator">=</span>args<span class="token punctuation">.</span>dtype<span class="token punctuation">,</span>
            gpu_memory_utilization<span class="token operator">=</span>args<span class="token punctuation">.</span>gpu_memory_utilization<span class="token punctuation">,</span>
            enforce_eager<span class="token operator">=</span>args<span class="token punctuation">.</span>enforce_eager<span class="token punctuation">,</span>
            max_model_len<span class="token operator">=</span>args<span class="token punctuation">.</span>max_model_len<span class="token punctuation">,</span>
            tensor_parallel_size<span class="token operator">=</span>args<span class="token punctuation">.</span>tensor_parallel_size<span class="token punctuation">,</span>
            pipeline_parallel_size<span class="token operator">=</span>args<span class="token punctuation">.</span>pipeline_parallel_size
    <span class="token punctuation">)</span>
    model <span class="token operator">=</span> AsyncLLMEngine<span class="token punctuation">.</span>from_engine_args<span class="token punctuation">(</span>engine_args<span class="token punctuation">)</span>
    processor <span class="token operator">=</span> AutoProcessor<span class="token punctuation">.</span>from_pretrained<span class="token punctuation">(</span>args<span class="token punctuation">.</span>checkpoint_path<span class="token punctuation">)</span>
    _launch_demo<span class="token punctuation">(</span>args<span class="token punctuation">,</span> model<span class="token punctuation">,</span> processor<span class="token punctuation">)</span>


<span class="token comment"># 简单描述下这张图片</span>
<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre>
    <p>
     在2台 2080ti机器,共16张显卡上部署Qwen2.5-VL-72B-Instruct模型, 显存共占用约149GB
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/afabc2e89c144b3a9681e9261092acfb.png"/>
    </p>
    <p>
     关于bfloat16与float16的区别
     <br/>
     bfloat16只支持Ampere架构,公司大多数旧卡2080ti, rtx titan都用不了. 于是特地在RTX 4060上测试这两个数据类型对显存的占用情况.
    </p>
    <p>
     下图是在单机4张4060显卡上,分别使用两种类型部署Qwen2.5-VL-7B-Instruct的显存占用情况:
     <br/>
     (27966-17938)/1024=9.8GB
    </p>
    <p>
     bfloat16要比float16要整体增加约9.8G显存. 当显存资源紧张时, 建议使用float16类型.
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c64279b8e08f4bdc859e2c247d4056a6.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34323437393332372f:61727469636c652f64657461696c732f313436313131353433" class_="artid" style="display:none">
 </p>
</div>


