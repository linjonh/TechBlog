---
layout: post
title: "文件上传漏洞条件竞争"
date: 2025-03-11 19:43:27 +0800
description: "文件上传漏洞是一种常见的 Web 安全漏洞，攻击者可以通过该漏洞上传恶意文件，如 WebShell、木马或其他恶意代码脚本，以实现远程控制服务器、窃取数据或发起进一步攻击。这类漏洞通常源于 Web 应用在文件上传功能的安全校验不当，例如缺乏文件类型验证、文件存储位置不合理或服务器解析机制存在漏洞。"
keywords: "文件上传漏洞（条件竞争）"
categories: ['未分类']
tags: ['安全', 'Web']
artid: "146181052"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146181052
    alt: "文件上传漏洞条件竞争"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146181052
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146181052
cover: https://bing.ee123.net/img/rand?artid=146181052
image: https://bing.ee123.net/img/rand?artid=146181052
img: https://bing.ee123.net/img/rand?artid=146181052
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     文件上传漏洞（条件竞争）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     @[TCO]catalog
    </p>
    <h2>
     <a id="_1">
     </a>
     文件上传漏洞简介
    </h2>
    <p>
     文件上传漏洞是一种常见的 Web 安全漏洞，攻击者可以通过该漏洞上传恶意文件，如 WebShell、木马或其他恶意代码脚本，以实现远程控制服务器、窃取数据或发起进一步攻击。这类漏洞通常源于 Web 应用在文件上传功能的安全校验不当，例如缺乏文件类型验证、文件存储位置不合理或服务器解析机制存在漏洞。
    </p>
    <h2>
     <a id="_3">
     </a>
     文件上传漏洞的触发条件主要包括以下几点：
    </h2>
    <ol>
     <li>
      缺乏文件类型验证：
      <br/>
      服务器未严格检查上传文件的后缀（如允许 .php、.jsp 等执行脚本的文件）。
      <br/>
      仅通过 MIME 类型或后缀名来验证，攻击者可通过修改扩展名或伪造 MIME 类型绕过。
     </li>
     <li>
      文件内容未校验：
      <br/>
      仅检查文件扩展名，而未检查文件内容（如魔术字、MIME 头）。
      <br/>
      允许上传嵌入恶意代码的图片（如 PHP 代码伪装为 .jpg）。
     </li>
     <li>
      存储路径可控：
      <br/>
      服务器未对文件存储路径进行限制，导致攻击者可以上传到可访问目录（如 Web 目录）。
      <br/>
      可通过目录遍历漏洞（如 …/）指定任意存储位置。
     </li>
     <li>
      上传后可直接访问：
      <br/>
      文件上传后，服务器未限制执行权限，导致 .php、.jsp 等文件可直接访问并执行恶意代码。
      <br/>
      服务器对上传目录未作权限控制（如未禁用脚本执行）。
     </li>
     <li>
      文件解析漏洞：
      <br/>
      服务器解析规则存在缺陷，如 .php.jpg 在某些环境下仍可被解析为 PHP 文件。
      <br/>
      结合 Nginx/IIS/Apache 的解析特性（如 IIS 6.0 的 ;.jpg 绕过）。
     </li>
     <li>
      客户端验证绕过：
      <br/>
      仅依赖 JavaScript 进行文件类型验证，可通过禁用 JS 或拦截修改请求绕过。
      <br/>
      使用 Burp Suite 等工具修改上传请求的文件名或类型绕过前端限制。
     </li>
    </ol>
    <h2>
     <a id="_23">
     </a>
     条件竞争漏洞分析
    </h2>
    <p>
     条件竞争漏洞，本质上就是多个进程或线程同时操作同一个资源，导致意外行为，攻击者可以利用这个时机达到某种目的。简单来说，就是程序“插队”，导致安全问题。
    </p>
    <h3>
     <a id="_25">
     </a>
     类似代码
    </h3>
    <pre><code class="prism language-php"><span class="token class-name type-declaration">php</span>
<span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
<span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$ext_arr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'jpg'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'png'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'gif'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
    <span class="token variable">$temp_file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">,</span><span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$upload_file</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$file_name</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$temp_file</span><span class="token punctuation">,</span> <span class="token variable">$upload_file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">,</span><span class="token variable">$ext_arr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
             <span class="token variable">$img_path</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span><span class="token operator">.</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"YmdHis"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"."</span><span class="token operator">.</span><span class="token variable">$file_ext</span><span class="token punctuation">;</span>
             <span class="token function">rename</span><span class="token punctuation">(</span><span class="token variable">$upload_file</span><span class="token punctuation">,</span> <span class="token variable">$img_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"只允许上传.jpg|.png|.gif类型文件！"</span><span class="token punctuation">;</span>
            <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$upload_file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'上传出错！'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_52">
     </a>
     代码流程：
    </h3>
    <ol>
     <li>
      移动文件到指定路径
     </li>
     <li>
      判断文件后缀是否符合
     </li>
     <li>
      符合则重命名
     </li>
     <li>
      不符合则删除文件
      <br/>
      这里存在逻辑的问题，先移动文件到指定目录再判断是否符合并删除。服务器处理代码时总会存在一定的时间差，当我们在上传文件后就多次快速尝试访问目标文件，那么是不是有机会在删除前成功访问文件。而如果文件的代码是重新创建一个木马文件，新木马文件则永远不会被删除了！
     </li>
    </ol>
    <h3>
     <a id="_58">
     </a>
     方法
    </h3>
    <p>
     上传一个php文件，如果正常上传，上传之后，也会被删除，通过利用条件竞争机制可以有效避开php上传之后被删
     <br/>
     利用bp，一直爆破访问
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/db1e5acc740a4cd2a43d750ae13b8c80.png">
      <br/>
      最后可以在上传的路径中查找到php文件，同时，不断也可以在url中访问到
     </img>
    </p>
    <h2>
     <a id="apache_63">
     </a>
     条件竞争+apache解析漏洞
    </h2>
    <h3>
     <a id="apache_64">
     </a>
     apache解析漏洞
    </h3>
    <p>
     apache解析漏洞在低版本会有，现在的版本几乎没有
    </p>
    <p>
     Apache 解析漏洞主要是因为 Apache 在不同配置环境下解析文件的方式不一致，攻击者可以利用这一特性绕过文件上传的安全检测，最终执行恶意代码，比如 Webshell。
     <br/>
     Apache解析漏洞主要是因为Apache默认一个文件可以有多个用.分割得后缀，当最右边的后缀无法识别（mime.types文件中的为合法后缀）则继续向左看，直到碰到合法后缀才进行解析（以最后一个合法后缀为准）
    </p>
    <h3>
     <a id="_69">
     </a>
     代码
    </h3>
    <pre><code class="prism language-php"><span class="token comment">//index.php</span>
<span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
<span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"./myupload.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$imgFileName</span> <span class="token operator">=</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$u</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyUpload</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'size'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token variable">$imgFileName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$status_code</span> <span class="token operator">=</span> <span class="token variable">$u</span><span class="token operator">-&gt;</span><span class="token function">upload</span><span class="token punctuation">(</span><span class="token constant">UPLOAD_PATH</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$status_code</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
            <span class="token variable">$img_path</span> <span class="token operator">=</span> <span class="token variable">$u</span><span class="token operator">-&gt;</span><span class="token property">cls_upload_dir</span> <span class="token operator">.</span> <span class="token variable">$u</span><span class="token operator">-&gt;</span><span class="token property">cls_file_rename_to</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'文件已经被上传，但没有重命名。'</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> 
        <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'这个文件不能上传到服务器的临时文件存储目录。'</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> 
        <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'上传失败，上传目录不可写。'</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> 
        <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">:</span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'上传失败，无法上传该类型文件。'</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> 
        <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">:</span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'上传失败，上传的文件过大。'</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> 
        <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">5</span><span class="token punctuation">:</span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'上传失败，服务器已经存在相同名称文件。'</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> 
        <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">6</span><span class="token punctuation">:</span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'文件无法上传，文件不能复制到目标目录。'</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>      
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'未知错误！'</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//myupload.php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">MyUpload</span><span class="token punctuation">{<!-- --></span>
<span class="token operator">...</span><span class="token operator">...</span>
<span class="token operator">...</span><span class="token operator">...</span>
<span class="token operator">...</span><span class="token operator">...</span> 
  <span class="token keyword">var</span> <span class="token variable">$cls_arr_ext_accepted</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
      <span class="token string double-quoted-string">".doc"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">".xls"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">".txt"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">".pdf"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">".gif"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">".jpg"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">".zip"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">".rar"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">".7z"</span><span class="token punctuation">,</span><span class="token string double-quoted-string">".ppt"</span><span class="token punctuation">,</span>
      <span class="token string double-quoted-string">".html"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">".xml"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">".tiff"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">".jpeg"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">".png"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>


  <span class="token keyword">function</span> <span class="token function-definition function">upload</span><span class="token punctuation">(</span> <span class="token variable">$dir</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    
    <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">isUploadedFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$ret</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">resultUpload</span><span class="token punctuation">(</span> <span class="token variable">$ret</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">setDir</span><span class="token punctuation">(</span> <span class="token variable">$dir</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$ret</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">resultUpload</span><span class="token punctuation">(</span> <span class="token variable">$ret</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">checkExtension</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$ret</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">resultUpload</span><span class="token punctuation">(</span> <span class="token variable">$ret</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">checkSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$ret</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">resultUpload</span><span class="token punctuation">(</span> <span class="token variable">$ret</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token punctuation">}</span>
    
    <span class="token comment">// if flag to check if the file exists is set to 1</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">cls_file_exists</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      
      <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">checkFileExists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$ret</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">resultUpload</span><span class="token punctuation">(</span> <span class="token variable">$ret</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// if we are here, we are ready to move the file to destination</span>

    <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">move</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$ret</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">resultUpload</span><span class="token punctuation">(</span> <span class="token variable">$ret</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token punctuation">}</span>

    <span class="token comment">// check if we need to rename the file</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">cls_rename_file</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token variable">$ret</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">renameFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$ret</span> <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">resultUpload</span><span class="token punctuation">(</span> <span class="token variable">$ret</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">resultUpload</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"SUCCESS"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     注意，在upload-labs靶场中需要修改一点代码
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4ea24a7b3b994dbe9c398c099db76d99.png">
      <br/>
      这里要多加一个 / 否则，路径上传会有问题（不太符合实际）
     </img>
    </p>
    <h3>
     <a id="_180">
     </a>
     方法
    </h3>
    <p>
     利用利用多后缀方式上传并且抓包，利用竞争条件，竞争成功的话这个文件为被当成php文件
     <br/>
     <img alt="请添加图片描述" src="https://i-blog.csdnimg.cn/direct/ee8524c2ed174ea8ad0319de302bcd70.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f456e6a6f795f7a68756f2f:61727469636c652f64657461696c732f313436313831303532" class_="artid" style="display:none">
 </p>
</div>


