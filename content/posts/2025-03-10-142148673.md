---
layout: post
title: "Android操作CAN总线基于linux-canutils库,发送接收设置过滤器"
date: 2025-03-10 15:06:05 +0800
description: "can_aar"
keywords: "Android操作CAN总线（基于linux-canutils库，发送、接收、设置过滤器）"
categories: ['Android']
tags: ['Can', 'Android']
artid: "142148673"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=142148673
    alt: "Android操作CAN总线基于linux-canutils库,发送接收设置过滤器"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=142148673
featuredImagePreview: https://bing.ee123.net/img/rand?artid=142148673
cover: https://bing.ee123.net/img/rand?artid=142148673
image: https://bing.ee123.net/img/rand?artid=142148673
img: https://bing.ee123.net/img/rand?artid=142148673
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Android操作CAN总线（基于linux-canutils库，发送、接收、设置过滤器）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h3>
     <a id="_1">
     </a>
     一、前言
    </h3>
    <p>
     CAN总线（Controller Area Network Bus）控制器局域网总线 CAN总线是构建的一种局域网网络。
    </p>
    <p>
     最近工作涉及到在Android端发送和接收Can帧的内容，写一篇博客记录下。
     <br/>
     主要是移植了linux-canutils库中的candump.c和cansend.c代码到aar中。
     <br/>
     后续会给出aar和应用层代码的具体调用。
     <br/>
     aar源码见
     <strong>
      七、附录
     </strong>
    </p>
    <h3>
     <a id="2_8">
     </a>
     二、前言2
    </h3>
    <p>
     最开始的can_aar是基于SOCKETCAN实现的，这里给出SOCKET_CAN的官方文档（
     <a href="https://www.kernel.org/doc/html/v4.17/networking/can.html#socketcan-raw-sockets" rel="nofollow">
      https://www.kernel.org/doc/html/v4.17/networking/can.html#socketcan-raw-sockets
     </a>
     ），SOCKETCAN是使用一个socket绑定所有CAN口，但是如果是高速发送：比如每帧间隔1ms 连续发送几百帧以上会有丢帧的问题，表征为概率性无法收到can帧
     <br/>
     于是参照github上linux-canutils的代码对can_aar进行修改，设备有多个can口，
     <br/>
     <strong>
      效果：使用两个CAN口和电脑端连接，电脑端间隔1ms发送一帧，电脑端发送的同时，设备端也发送CAN帧，共发送3000000+帧未发生丢帧的情况。
     </strong>
    </p>
    <p>
     这里先给出linux-canutils candump.c和cansend.c的链接：
     <br/>
     <a href="https://github.com/linux-can/can-utils/blob/master/candump.c">
      https://github.com/linux-can/can-utils/blob/master/candump.c
     </a>
     <br/>
     <a href="https://github.com/linux-can/can-utils/blob/master/cansend.c">
      https://github.com/linux-can/can-utils/blob/master/cansend.c
     </a>
    </p>
    <p>
     candump对应通过can口读数据，cansend对应通过can口写数据，也分别对应cantest.c中的doRealCanReadBytes和canWriteBytesDebug两个函数。
    </p>
    <h3>
     <a id="_20">
     </a>
     三、前置知识
    </h3>
    <h4>
     <a id="31_epoll_21">
     </a>
     3.1 epoll
    </h4>
    <p>
     定位：Linux内核提供的一种高效I/O事件通知机制，专为处理大量并发连接设计（如Web服务器、实时通信系统）。
    </p>
    <p>
     核心功能：监控多个文件描述符（如Socket）的I/O状态变化（可读/可写/异常），避免轮询消耗CPU资源。
    </p>
    <p>
     设计目标：解决传统select/poll的性能瓶颈（线性扫描、内存拷贝、连接数限制）。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/36c30ca9e18e4585a89721be0eb01fd1.png"/>
    </p>
    <h4>
     <a id="32_jni_29">
     </a>
     3.2 jni
    </h4>
    <p>
     作为java代码调用c代码的媒介，详见《Android开发艺术探索》
    </p>
    <h3>
     <a id="_32">
     </a>
     四、具体实现
    </h3>
    <h4>
     <a id="41_aar_33">
     </a>
     4.1 aar设计
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f0a12e2074474a21bc2e0856cd64e731.png">
      <br/>
      can_test.c: 各类函数具体实现的代码
      <br/>
      com_example_x6_mc_cantest_CanUtils.h: jni函数
     </img>
    </p>
    <p>
     CanFilter: Can帧过滤器实体类
     <br/>
     CanFrame: Can帧实体类
     <br/>
     CanUtils: 封装给上层调用的工具类
     <br/>
     DataListener：接口类，用于向上层回调数据
    </p>
    <h4>
     <a id="42__42">
     </a>
     4.2 部分代码解读
    </h4>
    <p>
     CanUtils.java:
    </p>
    <pre><code class="prism language-java"><span class="token comment">// 打开can口并使能</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">canOpen</span><span class="token punctuation">(</span><span class="token class-name">String</span> can<span class="token punctuation">,</span> <span class="token class-name">String</span> baudRate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">execRootCmdSilent</span><span class="token punctuation">(</span><span class="token string">"ifconfig "</span> <span class="token operator">+</span> can <span class="token operator">+</span> <span class="token string">" down"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">execRootCmdSilent</span><span class="token punctuation">(</span><span class="token string">"ip link set "</span> <span class="token operator">+</span> can <span class="token operator">+</span> <span class="token string">" up type can bitrate "</span> <span class="token operator">+</span> baudRate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 提供给上层调用，也是jni函数，通过can口发送数据，具体实现见can_test.c</span>
<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">canWriteBytesDebug</span><span class="token punctuation">(</span><span class="token class-name">CanFrame</span> canFrame<span class="token punctuation">,</span> <span class="token class-name">String</span> canPort<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 提供给上层调用，通过can口接收数据，具体实现见can_test.c</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">canReadBytesDebug</span><span class="token punctuation">(</span><span class="token class-name">DataListener</span> listener<span class="token punctuation">,</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> can<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">createEpoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> can<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">doSocketBind</span><span class="token punctuation">(</span>can<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">doRealCanReadBytes</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 对上层不可见，jni函数，创建系统调用epoll，具体实现见can_test.c</span>
<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">createEpoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 对上层不可见，jni函数，真正实现读取can口数据的逻辑，监听并读取然后通过listener返回给上层</span>
<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">void</span> <span class="token function">doRealCanReadBytes</span><span class="token punctuation">(</span><span class="token class-name">DataListener</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 对上层可见，设置can帧过滤器</span>
<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">canSetFilters</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CanFilter</span><span class="token punctuation">&gt;</span></span> canFilters<span class="token punctuation">,</span> <span class="token class-name">String</span> can<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 对上层可见，清空过滤器</span>
<span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">canClearFilters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 对上层可见，关闭can口</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">canClose</span><span class="token punctuation">(</span><span class="token class-name">String</span> can<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">execRootCmdSilent</span><span class="token punctuation">(</span><span class="token string">"ifconfig "</span> <span class="token operator">+</span> can <span class="token operator">+</span> <span class="token string">" down"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span><span class="token string">"hello from before doRealCanClose"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">doRealCanClose</span><span class="token punctuation">(</span>can<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//对上层不可见，真正实现关闭can口，清空一些变量</span>
<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">doRealCanClose</span><span class="token punctuation">(</span><span class="token class-name">String</span> can<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 绑定socket到can口，对上层不可见，属于监听can口前的准备工作</span>
<span class="token keyword">private</span> <span class="token keyword">native</span> <span class="token keyword">int</span> <span class="token function">doSocketBind</span><span class="token punctuation">(</span><span class="token class-name">String</span> can<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token string">"mc_can"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     can_test.c:
    </p>
    <pre><code class="prism language-c"><span class="token comment">//关注CanUtils.java中的canReadBytesDebug</span>
<span class="token comment">// 1. canReadBytesDebug 先createEpoll()创建系统调用，再绑定socket到can接口，最后开启监听</span>

JNIEXPORT <span class="token keyword">void</span> JNICALL
<span class="token function">Java_com_example_x6_mc_1cantest_CanUtils_createEpoll</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"createEpoll begin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	fd_epoll <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>fd_epoll <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"epoll_create"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"createEpoll end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//该函数作用：1. 将Java字符串转为C字符串；</span>
<span class="token comment">//2. 创建CAN原始套接字；</span>
<span class="token comment">//3. 将套接字加入epoll监听队列；</span>
<span class="token comment">//4. 配置网络接口参数；</span>
<span class="token comment">//5. 绑定Socket到指定CAN接口，支持CAN FD模式。</span>
JNIEXPORT jint JNICALL
<span class="token function">Java_com_example_x6_mc_1cantest_CanUtils_doSocketBind</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span> jstring can<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> <span class="token operator">*</span>port <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetStringUTFChars</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> can<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"port = %s"</span><span class="token punctuation">,</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">if_info</span><span class="token operator">*</span> obj <span class="token operator">=</span> <span class="token operator">&amp;</span>sock_info<span class="token punctuation">[</span>port<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token char">'0'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	obj<span class="token operator">-&gt;</span>s <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>PF_CAN<span class="token punctuation">,</span> SOCK_RAW<span class="token punctuation">,</span> CAN_RAW<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span>s <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	event_setup<span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr <span class="token operator">=</span> obj<span class="token punctuation">;</span> <span class="token comment">/* remember the instance as private data */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">epoll_ctl</span><span class="token punctuation">(</span>fd_epoll<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> obj<span class="token operator">-&gt;</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event_setup<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"failed to add socket to epoll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	obj<span class="token operator">-&gt;</span>cmdlinename <span class="token operator">=</span> port<span class="token punctuation">;</span> <span class="token comment">/* save pointer to cmdline name of this socket */</span>
	nbytes <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* no ',' found =&gt; no filter definitions */</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>nbytes <span class="token operator">&gt;</span> max_devname_len<span class="token punctuation">)</span>
		max_devname_len <span class="token operator">=</span> nbytes<span class="token punctuation">;</span> <span class="token comment">/* for nice printing */</span>

	addr<span class="token punctuation">.</span>can_family <span class="token operator">=</span> AF_CAN<span class="token punctuation">;</span>

	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ifr<span class="token punctuation">.</span>ifr_name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ifr<span class="token punctuation">.</span>ifr_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">strncpy</span><span class="token punctuation">(</span>ifr<span class="token punctuation">.</span>ifr_name<span class="token punctuation">,</span> port<span class="token punctuation">,</span> nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>ANYDEV<span class="token punctuation">,</span> ifr<span class="token punctuation">.</span>ifr_name<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ioctl</span><span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span>s<span class="token punctuation">,</span> SIOCGIFINDEX<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ifr<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"SIOCGIFINDEX"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		addr<span class="token punctuation">.</span>can_ifindex <span class="token operator">=</span> ifr<span class="token punctuation">.</span>ifr_ifindex<span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span>
		addr<span class="token punctuation">.</span>can_ifindex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">/* any can interface */</span>

	<span class="token comment">/* try to switch the socket into CAN FD mode */</span>
	<span class="token function">setsockopt</span><span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span>s<span class="token punctuation">,</span> SOL_CAN_RAW<span class="token punctuation">,</span> CAN_RAW<span class="token punctuation">,</span> <span class="token operator">&amp;</span>canfd_on<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>canfd_on<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token comment">//	(*env)-&gt;DeleteLocalRef(env,port);</span>
<span class="token punctuation">}</span>

<span class="token comment">// 该函数实现：当epoll监听到有数据时，就回调数据给上层</span>
JNIEXPORT <span class="token keyword">void</span> JNICALL
<span class="token function">Java_com_example_x6_mc_1cantest_CanUtils_doRealCanReadBytes</span><span class="token punctuation">(</span>JNIEnv <span class="token operator">*</span>env<span class="token punctuation">,</span> jobject thiz<span class="token punctuation">,</span> jobject listener<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	running <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	jclass callClass <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetObjectClass</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
	jmethodID callMethod <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetMethodID</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>callClass<span class="token punctuation">,</span><span class="token string">"onData"</span><span class="token punctuation">,</span>
											   <span class="token string">"(Ljava/lang/String;Ljava/lang/String;I)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* these settings are static and can be held out of the hot path */</span>
	iov<span class="token punctuation">.</span>iov_base <span class="token operator">=</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">;</span>
	msg<span class="token punctuation">.</span>msg_name <span class="token operator">=</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">;</span>
	msg<span class="token punctuation">.</span>msg_iov <span class="token operator">=</span> <span class="token operator">&amp;</span>iov<span class="token punctuation">;</span>
	msg<span class="token punctuation">.</span>msg_iovlen <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	msg<span class="token punctuation">.</span>msg_control <span class="token operator">=</span> <span class="token operator">&amp;</span>ctrlmsg<span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span>running<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		num_events <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>fd_epoll<span class="token punctuation">,</span> events_pending<span class="token punctuation">,</span> currmax<span class="token punctuation">,</span> timeout_ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>num_events <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			running <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"num_events = %d"</span><span class="token punctuation">,</span>num_events<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_events<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token comment">/* check waiting CAN RAW sockets */</span>
			<span class="token keyword">struct</span> <span class="token class-name">if_info</span><span class="token operator">*</span> obj <span class="token operator">=</span> events_pending<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>ptr<span class="token punctuation">;</span>
			<span class="token comment">/* these settings may be modified by recvmsg() */</span>
			iov<span class="token punctuation">.</span>iov_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
			msg<span class="token punctuation">.</span>msg_namelen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
			msg<span class="token punctuation">.</span>msg_controllen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ctrlmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
			msg<span class="token punctuation">.</span>msg_flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

			nbytes <span class="token operator">=</span> <span class="token function">recvmsg</span><span class="token punctuation">(</span>obj<span class="token operator">-&gt;</span>s<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msg<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>nbytes <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"nbytes &lt; 0 is true\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>nbytes <span class="token operator">==</span> CAN_MTU<span class="token punctuation">)</span>
				maxdlen <span class="token operator">=</span> CAN_MAX_DLEN<span class="token punctuation">;</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">size_t</span><span class="token punctuation">)</span>nbytes <span class="token operator">==</span> CANFD_MTU<span class="token punctuation">)</span>
				maxdlen <span class="token operator">=</span> CANFD_MAX_DLEN<span class="token punctuation">;</span>
			<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"read: incomplete CAN frame\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span> <span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">int</span> idx <span class="token operator">=</span> <span class="token function">idx2dindex</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>can_ifindex<span class="token punctuation">,</span>obj<span class="token operator">-&gt;</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//			LOGE("CAN口 = %s",devname[idx]);</span>
			frame_count <span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"recv frame count = %d\n"</span><span class="token punctuation">,</span>frame_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">fprint_long_canframe</span><span class="token punctuation">(</span><span class="token constant">stdout</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>frame<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> view<span class="token punctuation">,</span> maxdlen<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//输出收到的can帧数据：canid can帧长度 can帧数据</span>
			jstring data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
			jstring canPort <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>devname<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">CallVoidMethod</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>listener<span class="token punctuation">,</span>callMethod<span class="token punctuation">,</span>data<span class="token punctuation">,</span>canPort<span class="token punctuation">,</span>frame_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>canPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
    <span class="token function">LOGE</span><span class="token punctuation">(</span><span class="token string">"canReadBytesDebug end"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">DeleteLocalRef</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span>callClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_220">
     </a>
     五、应用层调用示例
    </h3>
    <p>
     前言：
    </p>
    <p>
     TestCan是进行CAN测试的APK示例，基于can_aar (linux-can-utils)实现。
    </p>
    <p>
     目前只支持3位canid（表示标准帧）和8位canid（表示扩展帧），可以设置Can帧过滤器
    </p>
    <p>
     须在build.gradle中添加一行代码以使用can_aar
    </p>
    <pre><code>implementation files('libs/can-debug.aar')
</code></pre>
    <p>
     can_aar包含以下功能：
    </p>
    <h5>
     <a id="1_CAN_236">
     </a>
     1. 打开CAN口和接收功能
    </h5>
    <pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token class-name">CanUtils</span> canUtil<span class="token punctuation">;</span> <span class="token comment">//can工具类实例</span>

<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">openCan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    canUtil <span class="token operator">=</span> <span class="token class-name">CanUtils</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    canUtil<span class="token punctuation">.</span><span class="token function">canOpen</span><span class="token punctuation">(</span><span class="token string">"can0"</span><span class="token punctuation">,</span><span class="token string">"1000000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canUtil<span class="token punctuation">.</span><span class="token function">canOpen</span><span class="token punctuation">(</span><span class="token string">"can1"</span><span class="token punctuation">,</span><span class="token string">"1000000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canUtil<span class="token punctuation">.</span><span class="token function">canOpen</span><span class="token punctuation">(</span><span class="token string">"can2"</span><span class="token punctuation">,</span><span class="token string">"1000000"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> canList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"can0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	canList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"can1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	canList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">"can2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newCachedThreadPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            canUtil<span class="token punctuation">.</span><span class="token function">canReadBytesDebug</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DataListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onData</span><span class="token punctuation">(</span><span class="token class-name">String</span> data<span class="token punctuation">,</span> <span class="token class-name">String</span> canPort<span class="token punctuation">,</span> <span class="token keyword">int</span> frameCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"canPort == "</span> <span class="token operator">+</span> canPort <span class="token operator">+</span> <span class="token string">" data == "</span> <span class="token operator">+</span> data <span class="token operator">+</span> <span class="token string">" frameCount == "</span> <span class="token operator">+</span> frameCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> canList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//监听3个can口，就将can0,can1,can2都加入canList中</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="2_CAN_268">
     </a>
     2. 发送CAN帧
    </h5>
    <pre><code class="prism language-java"><span class="token comment">//CanFrame实体类</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CanFrame</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> canId<span class="token punctuation">;</span> <span class="token comment">//can帧id</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> data<span class="token punctuation">;</span> <span class="token comment">//can帧数据</span>

    <span class="token keyword">public</span> <span class="token class-name">CanFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-java"><span class="token comment">// 发送代码示例</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>canUtil <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">CanFrame</span> canFrame <span class="token operator">=</span> <span class="token function">makeCanFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canUtil<span class="token punctuation">.</span><span class="token function">canWriteBytesDebug</span><span class="token punctuation">(</span>canFrame<span class="token punctuation">,</span><span class="token string">"can0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过can0口发送</span>
    canUtil<span class="token punctuation">.</span><span class="token function">canWriteBytesDebug</span><span class="token punctuation">(</span>canFrame<span class="token punctuation">,</span><span class="token string">"can1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过can1口发送</span>
    canUtil<span class="token punctuation">.</span><span class="token function">canWriteBytesDebug</span><span class="token punctuation">(</span>canFrame<span class="token punctuation">,</span><span class="token string">"can2"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通过can2口发送</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">CanFrame</span> <span class="token function">makeCanFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">CanFrame</span> canFrame <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CanFrame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canFrame<span class="token punctuation">.</span>canId <span class="token operator">=</span> <span class="token string">"123"</span><span class="token punctuation">;</span>
    canFrame<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token string">"1122334455667788"</span>
    <span class="token keyword">return</span> canFrame<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <h5>
     <a id="3_CAN_299">
     </a>
     3. 关闭CAN口
    </h5>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeCan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>canUtil <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        canUtil<span class="token punctuation">.</span><span class="token function">canClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    canUtil <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_313">
     </a>
     六、参考文档
    </h3>
    <p>
     <a href="https://www.xiaolincoding.com/os/8_network_system/selete_poll_epoll.html#epoll" rel="nofollow">
      https://www.xiaolincoding.com/os/8_network_system/selete_poll_epoll.html#epoll
     </a>
     <br/>
     <a href="https://github.com/linux-can/can-utils">
      https://github.com/linux-can/can-utils
     </a>
    </p>
    <h3>
     <a id="_317">
     </a>
     七、附录
    </h3>
    <p>
     源码见：
     <a href="https://github.com/qilin02811/can_aar">
      https://github.com/qilin02811/can_aar
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34353933333530392f:61727469636c652f64657461696c732f313432313438363733" class_="artid" style="display:none">
 </p>
</div>


