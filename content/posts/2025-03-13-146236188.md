---
layout: post
title: "在uni-app中使用SQLite"
date: 2025-03-13 17:08:07 +0800
description: "后续的操作成功后，会在手机磁盘的根路径下生成transfer【数据库实例名】文件夹里面包含transfer.db、transfer.db-shm、transfer.db-wal其中transfer.db 可以通过navicat等工具打开。"
keywords: "在uni-app中使用SQLite"
categories: ['未分类']
tags: ['数据库', 'Sqlite', 'App']
artid: "146236188"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146236188
    alt: "在uni-app中使用SQLite"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146236188
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146236188
cover: https://bing.ee123.net/img/rand?artid=146236188
image: https://bing.ee123.net/img/rand?artid=146236188
img: https://bing.ee123.net/img/rand?artid=146236188
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     在uni-app中使用SQLite
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <hr id="hr-toc" name="tableOfContents"/>
    <p>
     SQLite是一个进程内的库，实现了自给自足的、无服务器的、零配置的、事务性的 SQL 数据库引擎。它是一个零配置的数据库，这意味着与其他数据库不一样，您不需要在系统中配置。
    </p>
    <p>
     就像其他数据库，SQLite 引擎不是一个独立的进程，可以按应用程序需求进行静态或动态连接。SQLite 直接访问其存储文件。
    </p>
    <h3 id="1%E3%80%81%E5%BC%95%E5%85%A5sqlite%E6%A8%A1%E5%9D%97" name="1%E3%80%81%E5%BC%95%E5%85%A5sqlite%E6%A8%A1%E5%9D%97">
     <br/>
     1、引入sqlite模块
    </h3>
    <h5 id="2%E3%80%81android%E6%9D%83%E9%99%90%E7%94%B3%E8%AF%B7" name="2%E3%80%81android%E6%9D%83%E9%99%90%E7%94%B3%E8%AF%B7">
     1.1、android权限申请
    </h5>
    <p>
     在App.vue 的onLaunch函数中定义，获取存储权限
    </p>
    <pre><code class="language-javascript">// 判断有没有存储权限
var _this = this
			plus.android.requestPermissions(['android.permission.WRITE_EXTERNAL_STORAGE'], function(e) {
				console.log(e.deniedPresent)
				if (e.deniedAlways.length &gt; 0) { //权限被永久拒绝
					// 弹出提示框解释为何需要读写手机储存权限，引导用户打开设置页面开启
					uni.showModal({
						title: '存储权限',
						content: '您拒绝了存储权限，请去设置-应用开启存储权限。',
						success: function (res) {
							if (res.confirm) {
								// console.log('用户点击确定');
							} else if (res.cancel) {
								// console.log('用户点击取消');
							}
						}
					});
				}
				if (e.deniedPresent.length &gt; 0) { //权限被临时拒绝
					// 弹出提示框解释为何需要读写手机储存权限，可再次调用plus.android.requestPermissions申请权限
					plus.android.requestPermissions(['android.permission.WRITE_EXTERNAL_STORAGE'])
					// console.log('666666666 ' + e.deniedPresent.toString());
				}
				if (e.granted.length &gt; 0) { //权限被允许
					//调用依赖获取读写手机储存权限的代码
					// _this.upload() // 获取权限成功之后调用的函数
					// console.log('2222222222 ' + e.granted.toString());
					
				}
				
				
				
			}, function(e) {
				// console.log('R12133313221' + JSON.stringify(e));
			});</code></pre>
    <h5 id="2.2%E3%80%81%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE" name="2.2%E3%80%81%E6%9D%83%E9%99%90%E9%85%8D%E7%BD%AE">
     1.2、权限配置
    </h5>
    <p>
     在manifest.json中提供可视化选择
    </p>
    <p>
     <img alt="" height="1301" src="https://i-blog.csdnimg.cn/direct/9d86abf9d26b4ad591c00d020e667b9e.png" width="2033"/>
    </p>
    <p>
     另外附上权限列表：
    </p>
    <pre><code class="language-javascript">&lt;uses-permission android:name="android.permission.CHANGE_NETWORK_STATE"/&gt;
&lt;uses-permission android:name="android.permission.MOUNT_UNMOUNT_FILESYSTEMS"/&gt;
&lt;uses-permission android:name="android.permission.VIBRATE"/&gt;
&lt;uses-permission android:name="android.permission.READ_LOGS"/&gt;
&lt;uses-permission android:name="android.permission.ACCESS_WIFI_STATE"/&gt;
&lt;uses-feature android:name="android.hardware.camera.autofocus"/&gt;
&lt;uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/&gt;
&lt;uses-permission android:name="android.permission.CAMERA"/&gt;
&lt;uses-permission android:name="android.permission.GET_ACCOUNTS"/&gt;
&lt;uses-permission android:name="android.permission.READ_PHONE_STATE"/&gt;
&lt;uses-permission android:name="android.permission.CHANGE_WIFI_STATE"/&gt;
&lt;uses-permission android:name="android.permission.WAKE_LOCK"/&gt;
&lt;uses-permission android:name="android.permission.FLASHLIGHT"/&gt;
&lt;uses-feature android:name="android.hardware.camera"/&gt;
&lt;uses-permission android:name="android.permission.WRITE_SETTINGS"/&gt;
&lt;uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/&gt;
&lt;uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/&gt;
&lt;uses-permission android:name="android.permission.ACCESS_MEDIA_LOCATION" /&gt;
&lt;uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE" /&gt;
&lt;uses-permission android:name="android.permission.ACCESS_DOWNLOAD_MANAGER" /&gt;
&lt;uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/&gt;
&lt;uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/&gt;
&lt;uses-permission android:name="android.permission.ACCESS_MOCK_LOCATION"/&gt;
&lt;uses-permission android:name="android.permission.GET_TASKS"/&gt;
&lt;uses-permission android:name="android.permission.INTERNET"/&gt;
&lt;uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS"/&gt;
&lt;uses-permission android:name="android.permission.READ_FRAME_BUFFER"/&gt;
&lt;uses-permission android:name="android.permission.READ_HISTORY_BOOKMARKS"/&gt;
&lt;uses-permission android:name="android.permission.READ_PROFILE"/&gt;
&lt;uses-permission android:name="android.permission.READ_USER_DICTIONARY"/&gt;
&lt;uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/&gt;
&lt;uses-permission android:name="android.permission.RECORD_AUDIO"/&gt;
&lt;uses-permission android:name="android.permission.SEND_SMS"/&gt;
&lt;uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/&gt;
&lt;uses-permission android:name="android.permission.WRITE_PROFILE"/&gt;
&lt;uses-permission android:name="android.permission.WRITE_SMS"/&gt;
&lt;uses-permission android:name="android.permission.WRITE_USER_DICTIONARY"/&gt;
&lt;uses-permission android:name="android.permission.RECEIVE_USER_PRESENT"/&gt;</code></pre>
    <h5 id="1.3%E3%80%81%E6%89%93%E5%8C%85%EF%BC%8C%E5%88%B6%E4%BD%9C%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9F%BA%E5%BA%A7%E8%BF%90%E8%A1%8C" name="1.3%E3%80%81%E6%89%93%E5%8C%85%EF%BC%8C%E5%88%B6%E4%BD%9C%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9F%BA%E5%BA%A7%E8%BF%90%E8%A1%8C">
     1.3、打包，制作自定义基座运行
    </h5>
    <p>
     后续的操作成功后，会在手机磁盘的根路径下生成transfer【数据库实例名】文件夹
    </p>
    <p>
     里面包含transfer.db、transfer.db-shm、transfer.db-wal
    </p>
    <p>
     其中transfer.db 可以通过navicat等工具打开
    </p>
    <h3 id="2%E3%80%81sqlite%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84" name="2%E3%80%81sqlite%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84">
     2、sqlite文件结构
    </h3>
    <p>
     在项目根路径下定义db\sqlite文件夹
    </p>
    <p>
     除了index.js属于
     <a href="https://so.csdn.net/so/search?q=%E5%88%9D%E5%A7%8B%E5%8C%96&amp;spm=1001.2101.3001.7020" title="初始化">
      初始化
     </a>
     sqlite库文件，其余文件均表示对数据库相关表的操作
    </p>
    <p>
     <img alt="" height="361" src="https://i-blog.csdnimg.cn/direct/ae7bc4888db447b385c290a26acc7338.png" width="423"/>
    </p>
    <p>
     以boxDetail.js文件为例
    </p>
    <p>
     在SysBoxDetail  函数内 init 方法，需要检查数据库表是否建立。
    </p>
    <p>
     以及在已安装的应用程序后，对应的新增字段、索引、表数据修改等升级操作
    </p>
    <p>
     提供对于表数据查询操作的相关函数
    </p>
    <pre><code class="language-javascript">import {sqlite} from '@/db/sqlite/index.js'
import {strUtil, dateUtils} from '@/common/util.js'
 
const tabName = "sys_box_detail";
 
 
const fields = "id  INTEGER PRIMARY KEY AUTOINCREMENT NOT NULL,batchId INTEGER  not null, " 
	+" boxId INTEGER,  boxNo INTEGER not null, archNo text not null, createTime text,"
	+" fileNum text not null, storeroom text"
	
// 类似于构造函数，必须定义
function BoxDetail(){
	
}
 
 
BoxDetail.prototype = {
  constructor: BoxDetail,
} 
 
export const SysBoxDetail = {
	init: function(){
		if(!sqlite.isOpen()){
			sqlite.openDb();
		}
		return sqlite.isTable(tabName).then((res) =&gt; {
			console.log(tabName+"是否存在：" + res)
			if(!res) {
				sqlite.createTab(tabName, fields)
			}  else {
				// 用于后续升级版本  新增 fileNum字段
				sqlite.existsField(tabName, 'fileNum').then(res =&gt; {
					if(res[0].num == 0){
						let sql = "ALTER TABLE "+tabName+" ADD COLUMN fileNum text DEFAULT 1"
						sqlite.updateBySQL(sql).then(res =&gt; {
							console.log(res)
							console.log("插入字段成功")
						})
					} 
				})
				
				// 新增 createTime字段
				sqlite.existsField(tabName, 'createTime').then(res =&gt; {
					if(res[0].num == 0){
						let sql = "ALTER TABLE "+tabName+" ADD COLUMN createTime text"
						sqlite.updateBySQL(sql).then(res =&gt; {
							console.log(res)
							console.log("插入字段成功")
						})
					} 
				})
			}
			// 新增索引
			sqlite.existsIndex(tabName, tabName + '_idx_archNo').then( (res) =&gt; {
				console.log('索引判断：',res)
				if(res[0].num == 0){
					sqlite.createIndex(tabName, tabName + '_idx_archNo', 'archNo')
					sqlite.createIndex(tabName, tabName + '_idx_boxId', 'boxId')
					sqlite.createIndex(tabName, tabName + '_idx_batchId', 'batchId')
					sqlite.createIndex(tabName, tabName + '_idx_boxNo', 'boxNo')
				}
			})
			// 移除不存在的批次数据 ,后期再有新版本可以删除该行
			this.deleteByNotExistsBatchId();
			
		})
		
	},
	insert: function(data){
		return sqlite.addTabItem(tabName, data);
	},
	count: function(queryParam){
		let sql = "select count(*) as num from " + tabName + this.where(queryParam);
		return sqlite.selectBySQL(sql);
	},
	selectAll: function(queryParam){
		let sql = "select * from " + tabName + this.where(queryParam);
		let order = " order by archNo asc ";
		return sqlite.selectBySQL(sql + order);
	},
	selectById: function(id){
		let sql = `select * from ${tabName} where id = ${id}`;
		return sqlite.selectBySQL(sql);
	},
	updateFileNumById: function(id, fileNum) {
		let sql = `update ${tabName} set fileNum = ${fileNum} where id = ${id}`;
		return sqlite.updateBySQL(sql);
	},
	deleteById: function(id){
		return sqlite.deleteInformationType(tabName, {'id': id});
	},
	deleteByBoxId: function(boxId) {
		return sqlite.deleteInformationType(tabName, {'boxId': boxId});
	},
	deleteByBatchId: function(batchId) {
		return sqlite.deleteInformationType(tabName, {'batchId': batchId});
	},
	/**
	 * 移除无效的批次数据
	 */
	deleteByNotExistsBatchId: function(){
		let sql = `delete from ${tabName} where batchId not in (select id from sys_batch )`;
		return sqlite.updateBySQL(sql);
	},
	select: function(queryParam){
		let sql = "select * from " + tabName + this.where(queryParam);
		let order = " order by boxNo, archNo asc ";
		let limit = this.limit(queryParam)
		return sqlite.selectBySQL(sql + order + limit);
	},
	/**
	 * 关联boxId 查询，显示是否封箱
	 * @param {Object} queryParam
	 */
	selectWithBox: function(queryParam){
		let sql = "select a.*,b.status from " + tabName + " as a left outer join sys_box as b on a.boxId = b.id " 
		let where = this.where(queryParam, 'a');
		let order = " order by a.boxNo, a.archNo asc ";
		let limit = this.limit(queryParam)
		
		return sqlite.selectBySQL(sql + where + order + limit);
	},
	countByBatchNo: function(batchNo){
		let sql = "select count(*) as num from " + tabName + this.where({batchNo: batchNo});
		return sqlite.selectBySQL(sql);
	},
	countByArchNoAndBatchId: function(archNo, batchId){
		let sql = "select count(*) as num from " + tabName + 
			this.where({archNo: archNo, batchId: batchId});
		return sqlite.selectBySQL(sql);
	},
	where: function(queryParam, alias){
		let where = ''
		if(strUtil.isEmpty(alias)){
			alias = ''
		} else {
			alias +='.'
		}
		if(queryParam){
			var batchId = queryParam.batchId;
			if(strUtil.isNotEmpty(batchId)){
				where += ` and ${alias}batchId = ${batchId} `;
			}
			var boxId = queryParam.boxId;
			if(strUtil.isNotEmpty(boxId)){
				where += ` and ${alias}boxId = ${boxId}`;
			}
			var archNo = queryParam.archNo;
			if(strUtil.isNotEmpty(archNo)){
				where += ` and ${alias}archNo = "${archNo}" `
			}
			var searchValue = queryParam.searchValue;
			if(strUtil.isNotEmpty(searchValue)){
				where += ` and ( ${alias}boxNo = "${searchValue}" or ${alias}storeroom = "${searchValue}" or ${alias}archNo like "%${searchValue}%" )`
			}
			
		}
		if(where.length &gt; 0){
			where = " where 1=1 " + where;
		}
		return where;
	},
	limit: function(queryParam){
		let num = queryParam.pageNum;
		let size = queryParam.pageSize
		let numindex = 0
		if(num &lt;= 1){
			numindex = 0
		} else {
			numindex = ((num - 1) * size)
		}
		return ` limit ${numindex},${size}`
	}
	
}
 </code></pre>
    <h3 id="3%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%87%E4%BB%B6index.js" name="3%E3%80%81%E5%88%9D%E5%A7%8B%E5%8C%96%E6%96%87%E4%BB%B6index.js">
     3、初始化文件index.js
    </h3>
    <p>
     注意实际数据文件存放位置 ，有的手机会限制根路径存储，要求在应用自身层级下
    </p>
    <p>
     path: `/storage/emulated/0/transfer/${dbName}.db`,
    </p>
    <pre><code class="language-javascript">// 定义数据库实例名称
let dbName = "transfer"
 
export const openDb = () =&gt; {
	//如果数据库存在则打开，不存在则创建。
	return new Promise((resolve, reject) =&gt; {
		plus.sqlite.openDatabase({
			name: dbName, //数据库名称
			// path: `_doc/${dbName}.db`, //数据库地址
			path: `/storage/emulated/0/transfer/${dbName}.db`,
			success(e) {
				console.log(e)
				resolve(e);
			},
			fail(e) {
				console.log(e)
				reject(e);
			}
		})
	})
}
// 查询所有数据表名
export const getTable = () =&gt; {
	return new Promise((resolve, reject) =&gt; {
		plus.sqlite.selectSql({
			name: dbName,
			sql: "select * FROM sqlite_master where type='table'",
			success(e) {
				resolve(e);
			},
			fail(e) {
				console.log(e)
				reject(e);
			}
		})
	})
}
// 查询表数据总条数
export const getCount = (tabName) =&gt; {
	return new Promise((resolve, reject) =&gt; {
		plus.sqlite.selectSql({
			name: dbName,
			sql: "select count(*) as num from " + tabName,
			success(e) {
				resolve(e);
			},
			fail(e) {
				reject(e);
			}
		})
	})
}
 
// 查询表是否存在
export const isTable = (tabName) =&gt; {
	return new Promise((resolve, reject) =&gt; {
		plus.sqlite.selectSql({
			name: dbName,
			sql: `select count(*) as isTable FROM sqlite_master where type='table' and name='${tabName}'`,
			success(e) {
				resolve(e[0].isTable ? true : false);
			},
			fail(e) {
				console.log(e)
				reject(e);
			}
		})
	})
}
 
 
// 修改数据
export const updateBySQL = (sql) =&gt; {
	console.log(sql)
	return new Promise((resolve, reject) =&gt; {
		plus.sqlite.executeSql({
			name: dbName,
			sql: sql,
			success(e) {
				console.log(e)
				resolve(e);
			},
			fail(e) {
				console.log(e)
				reject(e);
			}
		})
	})
	 
}
 
 
// 修改数据
export const updateSQL = (tabName, setData, setName, setVal) =&gt; {
	if (JSON.stringify(setData) !== '{}') {
		let dataKeys = Object.keys(setData)
		let setStr = ''
		dataKeys.forEach((item, index) =&gt; {
			console.log(setData[item])
			setStr += (
				`${item} = ${JSON.stringify(setData[item])}${dataKeys.length - 1 !== index ? "," : ""}`)
		})
		console.log(setStr)
		return new Promise((resolve, reject) =&gt; {
			plus.sqlite.executeSql({
				name: dbName,
				sql: `update ${tabName} set ${setStr} where ${setName} = "${setVal}"`,
				success(e) {
					console.log(e)
					resolve(e);
				},
				fail(e) {
					console.log(e)
					reject(e);
				}
			})
		})
	} else {
		return new Promise((resolve, reject) =&gt; {
			reject("错误")
		});
	}
}
 
//删除数据库数据
export const deleteInformationType = (tabName,setData) =&gt; {
	if (JSON.stringify(setData) !== '{}') {
		let dataKeys = Object.keys(setData)
		let setStr = ''
		dataKeys.forEach((item, index) =&gt; {
			console.log(setData[item])
			setStr += (
				`${item}=${JSON.stringify(setData[item])}${dataKeys.length - 1 !== index ? " and " : ""}`)
		})
		let sql = `delete from ${tabName} where ${setStr}`
		console.log(sql)
		return new Promise((resolve, reject) =&gt; {
			plus.sqlite.executeSql({
				name: dbName,
				sql: sql,
				success(e) {
					resolve(e);
				},
				fail(e) {
					reject(e);
				}
			})
		})
	} else {
		return new Promise((resolve, reject) =&gt; {
			reject("错误")
		});
	}
}
 
//关闭数据库
export const closeSQL = () =&gt; {
	return new Promise((resolve, reject) =&gt; {
		plus.sqlite.closeDatabase({
			name: dbName,
			success(e) {
				resolve(e);
			},
			fail(e) {
				reject(e);
			}
		})
	})
}
 
//监听数据库是否开启
export const isOpen = () =&gt; {
	let open = plus.sqlite.isOpenDatabase({
		name: dbName,
		path: `_doc/${dbName}.db`, 
	})
	return open;
}
// 创建表
export const createTab = (tabName, data) =&gt; {
	// tabName不能用数字作为表格名的开头
	return new Promise((resolve, reject) =&gt; {
		console.log("创建数据库表",tabName)
		plus.sqlite.executeSql({
			name: dbName,
			// sql: 'create table if not exists dataList("list" INTEGER PRIMARY KEY AUTOINCREMENT,"id" TEXT,"name" TEXT,"gender" TEXT,"avatar" TEXT)',
			sql: `create table if not exists ${tabName}(${data})`,
			success(e) {
				cosole.log("创建数据表成功")
				resolve(e);
			},
			fail(e) {
				console.log(e)
				reject(e);
			}
		})
	})
}
 
// 创建表
export const dropTab = (tabName) =&gt; {
	if(null == tabName || tabName.length == 0){
		return false;
	}
	// tabName不能用数字作为表格名的开头
	return new Promise((resolve, reject) =&gt; {
		plus.sqlite.executeSql({
			name: dbName,
			// sql: 'create table if not exists dataList("list" INTEGER PRIMARY KEY AUTOINCREMENT,"id" TEXT,"name" TEXT,"gender" TEXT,"avatar" TEXT)',
			sql: `DROP TABLE ${tabName}`,
			success(e) {
				cosole.log(`删除数据表成功`)
				resolve(e);
			},
			fail(e) {
				console.log(e)
				reject(e);
			}
		})
	})
}
 
// 添加数据
export const addTabItem = (tabName,obj) =&gt; {
	if (obj) {
		let keys = Object.keys(obj)
		let keyStr = keys.toString()
		let valStr = ''
		keys.forEach((item, index) =&gt; {
			if (keys.length - 1 == index) {
				valStr += ('"' + obj[item] + '"')
			} else {
				valStr += ('"' + obj[item] + '",')
			}
		})
		console.log(valStr)
		let sqlStr = `insert into ${tabName}(${keyStr}) values(${valStr})`
		console.log(sqlStr)
		return new Promise((resolve, reject) =&gt; {
			plus.sqlite.executeSql({
				name: dbName,
				sql: sqlStr,
				success(e) {
					resolve(e);
				},
				fail(e) {
					console.log(e)
					reject(e);
				}
			})
		})
	} else {
		return new Promise((resolve, reject) =&gt; {
			reject("错误")
		})
	}
}
// 合并数据
export const mergeSql = (tabName,tabs) =&gt; {
	if (!tabs || tabs.length == 0) {
		return new Promise((resolve, reject) =&gt; {
			reject("错误")
		})
	}
	let itemValStr = ''
	tabs.forEach((item, index) =&gt; {
		let itemKey = Object.keys(item)
		let itemVal = ''
		itemKey.forEach((key, i) =&gt; {
			if (itemKey.length - 1 == i) {
				if (typeof item[key] == 'object') {
					itemVal += (`'${JSON.stringify(item[key])}'`)
				} else {
					itemVal += (`'${item[key]}'`)
				}
			} else {
				if (typeof item[key] == 'object') {
					itemVal += (`'${JSON.stringify(item[key])}',`)
				} else {
					itemVal += (`'${item[key]}',`)
				}
			}
		})
		if (tabs.length - 1 == index) {
			itemValStr += ('(' + itemVal + ')')
		} else {
			itemValStr += ('(' + itemVal + '),')
		}
	})
	let keys = Object.keys(tabs[0])
	let keyStr = keys.toString()
	return new Promise((resolve, reject) =&gt; {
		plus.sqlite.executeSql({
			name: dbName,
			sql: `insert or ignore into ${tabName} (${keyStr}) values ${itemValStr}`,
			success(e) {
				resolve(e);
			},
			fail(e) {
				console.log(e)
				reject(e);
			}
		})
	})
}
// 获取分页数据库数据
export const getDataList = async (tabName, num, size,byName,byType) =&gt; {
	let count = 0
	let sql = ''
	let numindex = 0
	await getCount(tabName).then((resNum) =&gt; {
		count = Math.ceil(resNum[0].num / size)
	})
	if(((num - 1) * size) == 0) {
	    numindex = 0
	} else {
		numindex = ((num - 1) * size)
	}
	sql = `select * from ${tabName}`
	if(byName &amp;&amp; byType) {
		// desc asc
		sql += ` order by ${byName} ${byType}`
	}
	sql += ` limit ${numindex},${size}`
	console.log(sql)
	if (count &lt; num - 1) {
		return new Promise((resolve, reject) =&gt; {
			reject("无数据")
		});
	} else {
		return new Promise((resolve, reject) =&gt; {
			plus.sqlite.selectSql({
				name: dbName,
				// sql: "select * from userInfo limit 3 offset 3",
				sql:sql ,
				success(e) {
					resolve(e);
				},
				fail(e) {
					reject(e);
				}
			})
		})
	}
}
 
//查询数据库数据
export const selectDataList = (tabName,setData,byName,byType) =&gt; {
	let setStr = ''
	let sql = ''
	if (JSON.stringify(setData) !== '{}') {
		let dataKeys = Object.keys(setData)
		dataKeys.forEach((item, index) =&gt; {
			console.log(setData[item])
			setStr += (
				`${item}=${JSON.stringify(setData[item])}${dataKeys.length - 1 !== index ? " and " : ""}`)
		})
		sql = `select * from ${tabName} where ${setStr}`
	} else {
		sql = `select * from ${tabName}`
	}
	if(byName &amp;&amp; byType) {
		// desc asc
		sql += ` order by ${byName} ${byType}`
	}
	console.log(sql)
	if (tabName !== undefined) {
		return new Promise((resolve, reject) =&gt; {
			plus.sqlite.selectSql({
				name: dbName,
				sql: sql,
				success(e) {
					resolve(e);
				},
				fail(e) {
					console.log(e)
					reject(e);
				}
			})
		})
	} else {
		return new Promise((resolve, reject) =&gt; {
			reject("错误")
		});
	}
}
 
 
//查询数据库数据
export const selectBySQL = (sql) =&gt; {
	console.log(sql)
	return new Promise((resolve, reject) =&gt; {
		plus.sqlite.selectSql({
			name: dbName,
			sql: sql,
			success(e) {
				console.log('success')
				resolve(e);
			},
			fail(e) {
				console.log(e)
				reject(e);
			}
		})
	})
	 
}
 
/**
 * 创建一般索引
 * @param tableName 表名
 * @param indexName 索引名
 * @param fieldName 字段名
 */
export const createIndex = (tableName, indexName, fieldName) =&gt; {
	let sql = `CREATE INDEX ${indexName} ON ${tableName} (${fieldName})`
	console.log('新建索引', sql)
	return new Promise((resolve, reject) =&gt; {
		plus.sqlite.executeSql({
			name: dbName,
			sql: sql,
			success(e) {
				resolve(e);
			},
			fail(e) {
				console.log(e)
				reject(e);
			}
		})
	});
}
 
/**
 * 判断表索引是否存在
 * @param tableName 表名
 * @param indexName 索引名
 */
export const existsIndex = (tableName, indexName) =&gt; {
	let sql = `SELECT count(*)  num FROM sqlite_master WHERE type = 'index' and name = '${indexName}' and tbl_name = '${tableName}'`
	console.log(tableName, indexName, sql)
	return new Promise((resolve, reject) =&gt; {
		plus.sqlite.selectSql({
			name: dbName,
			sql: sql,
			success(e) {
				resolve(e);
			},
			fail(e) {
				console.log(e)
				reject(e);
			}
		})
	});
}
 
/**
 * 判断表字段是否存在
 * @param tableName 表名
 * @param fieldName 字段名
 */
export const existsField = (tableName, fieldName) =&gt; {
	let sql = `SELECT count(*)  num FROM sqlite_master WHERE type = 'table' and name = '${fieldName}' and tbl_name = '${tableName}'`
	console.log(tableName, fieldName, sql)
	return new Promise((resolve, reject) =&gt; {
		plus.sqlite.selectSql({
			name: dbName,
			sql: sql,
			success(e) {
				resolve(e);
			},
			fail(e) {
				console.log(e)
				reject(e);
			}
		})
	});
}
 
 
 
 
 
//把这些方法导出去
export const sqlite = {
	isOpen,
	openDb,
	createTab,dropTab,
	mergeSql,
	getDataList,
	addTabItem,
	closeSQL,
	deleteInformationType,
	getTable,
	getCount,
	updateSQL,
	isTable,
	selectDataList,
	selectBySQL,updateBySQL,
	createIndex, 
	existsIndex,
	existsField,
};</code></pre>
    <h3 id="4%E3%80%81%E6%89%93%E5%BC%80%E6%95%B0%E6%8D%AE%E5%BA%93" name="4%E3%80%81%E6%89%93%E5%BC%80%E6%95%B0%E6%8D%AE%E5%BA%93">
     4、
     <a href="https://so.csdn.net/so/search?q=%E6%89%93%E5%BC%80%E6%95%B0%E6%8D%AE%E5%BA%93&amp;spm=1001.2101.3001.7020" title="打开数据库">
      打开数据库
     </a>
    </h3>
    <p>
     在App.vue 文件的onLaunch: function() {} 函数中
    </p>
    <p>
     sqlite 需要依赖存储权限，因此需要在成功获取权限后，初始化相关操作
    </p>
    <pre><code class="language-javascript">// 判断有没有存储权限
			var _this = this
			plus.android.requestPermissions(['android.permission.WRITE_EXTERNAL_STORAGE'], function(e) {
				console.log(e.deniedPresent)
				if (e.deniedAlways.length &gt; 0) { //权限被永久拒绝
					// 弹出提示框解释为何需要读写手机储存权限，引导用户打开设置页面开启
					uni.showModal({
						title: '存储权限',
						content: '您拒绝了存储权限，请去设置-应用开启存储权限。',
						success: function (res) {
							if (res.confirm) {
								// console.log('用户点击确定');
							} else if (res.cancel) {
								// console.log('用户点击取消');
							}
						}
					});
				}
				if (e.deniedPresent.length &gt; 0) { //权限被临时拒绝
					// 弹出提示框解释为何需要读写手机储存权限，可再次调用plus.android.requestPermissions申请权限
					plus.android.requestPermissions(['android.permission.WRITE_EXTERNAL_STORAGE'])
					// console.log('666666666 ' + e.deniedPresent.toString());
				}
				if (e.granted.length &gt; 0) { //权限被允许
					//调用依赖获取读写手机储存权限的代码
					// _this.upload() // 获取权限成功之后调用的函数
					// console.log('2222222222 ' + e.granted.toString());
					if(!sqlite.isOpen()){
						sqlite.openDb().then((res) =&gt; {
							SysBoxDetail.init();
                            // ......
						});
					}
				}
				
				
				
			}, function(e) {
				// console.log('R12133313221' + JSON.stringify(e));
			});</code></pre>
    <h3 id="5%E3%80%81%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE" name="5%E3%80%81%E6%9F%A5%E8%AF%A2%E6%95%B0%E6%8D%AE">
     5、查询数据
    </h3>
    <p>
     在sqlite表的脚本文件中，已将所有函数export
    </p>
    <p>
     在vue中，先引入相关文件，后续可以直接使用
    </p>
    <pre><code class="language-javascript">import {SysBoxDetail}  from '@/db/sqlite/boxDetail.js'</code></pre>
    <pre><code class="language-javascript">SysBoxDetail.selectAll(this.queryParams).then((res) =&gt; {
	console.log(res)
})</code></pre>
    <h3 id="6%E3%80%81%E5%8F%AF%E8%A7%86%E5%8C%96%E6%B5%8B%E8%AF%95" name="6%E3%80%81%E5%8F%AF%E8%A7%86%E5%8C%96%E6%B5%8B%E8%AF%95">
     6、可视化测试
    </h3>
    <pre><code class="language-javascript">&lt;template&gt;
	&lt;view class="content"&gt;
		&lt;view class=""&gt;
			表名
		&lt;/view&gt;
		&lt;radio-group @change="radioChange"&gt;
			&lt;label class="uni-list-cell uni-list-cell-pd" v-for="(item, index) in tableList" :key="index"&gt;
				&lt;view&gt;
					&lt;radio :value="index" :checked="index == radioIndex" /&gt;{<!-- -->{item.name}}
				&lt;/view&gt;
			&lt;/label&gt;
		&lt;/radio-group&gt;
		&lt;button type="primary" @click="dbType"&gt;检查数据库打开状态&lt;/button&gt;
		&lt;button type="primary" @click="openDb"&gt;打开数据库&lt;/button&gt;
		&lt;button type="primary" @click="closeDb"&gt;关闭数据库&lt;/button&gt;
		&lt;input class="input_box" type="text" value="" v-model="valInp" placeholder="请输入聊天内容" /&gt;
		&lt;button type="primary" @click="addSql"&gt;添加数据&lt;/button&gt;
		&lt;button type="primary" @click="setSql"&gt;修改数据&lt;/button&gt;
		&lt;input class="input_box" type="text" value="" v-model="valTab" placeholder="请输入表名" /&gt;
		&lt;button type="primary" @click="addExecuteSql"&gt;添加表&lt;/button&gt;
		&lt;button type="primary" @click="tapMerge"&gt;合并数据&lt;/button&gt;
		&lt;button type="primary" @click="delSql"&gt;删除数据库数据&lt;/button&gt;
		&lt;button type="primary" @click="getTab"&gt;查询所有数据表名&lt;/button&gt;
		&lt;button type="primary" @click="tapIsTab"&gt;查询表是否存在&lt;/button&gt;
		&lt;button type="primary" @click="getNum"&gt;获取表数据总条数&lt;/button&gt;
		&lt;button type="primary" @click="getSql"&gt;获取数据库数据&lt;/button&gt;
		&lt;button type="primary" @click="getBranch"&gt;获取分页数据库数据+排序&lt;/button&gt;
		&lt;t-table class="table_box" :chatTableListLength="chatTableListLength" :chatTableList="chatTableList"&gt;
		&lt;/t-table&gt;
	&lt;/view&gt;
&lt;/template&gt;
 
&lt;script&gt;
	import {
		*
	} from '@/db/sqlite/index.js'
	export default {
		components: {
			tTable
		},
		data() {
			return {
				valTab:'',
				radioIndex:0,
				valInp: '',
				chatTableList: [],
				tableList:[],
				chatTableListLength: 0,
				tableName:''
			}
		},
		async onLoad() {
			await this.openDb()
			await this.getTab()
		},
		methods: {
			radioChange(val) {
				this.tableName = this.tableList[val.detail.value].name
				console.log(this.tableList)
			},
			tapMerge() {
				let tabs = [{
					"local_id": "3_wtsu83kox2",
					"id": "3_wtsu83koxx",
					"chat_friend_id": "兔兔",
					"content": 2
				}, {
					"local_id": "3_hq5uyx9vrd",
					"id": "3_hq5uyx9vrd",
					"chat_friend_id": "兔兔",
					"content": 2
				}]
				// 只会插入不重复的
				mergeSql('pop', this.tableName, tabs).then((res) =&gt; {
					console.log(res)
				})
			},
			tapIsTab() {
				isTable('pop', this.tableName).then((res) =&gt; {
					console.log(res)
				})
			},
			getTab() {
				getTable('pop').then((res) =&gt; {
					console.log(res)
					this.tableList = res
				})
			},
			addExecuteSql() {
				console.log(this.valTab)
				if(!this.valTab || this.valTab == '') return
				addTab('pop', this.valTab).then(res =&gt; {
					console.log(res)
					this.valTab = ''
					this.getTab()
				})
			},
			delSql() {
				deleteInformationType('pop', this.tableName, {
					"chat_i": 2,
				}).then(res =&gt; {
					console.log(res)
				})
			},
			dbType() {
				uni.showToast({
					icon: "none",
					title: isOpen('pop') ? '数据库已打开' : '数据库已关闭'
				})
			},
			closeDb() {
				closeSQL().then(res =&gt; {
					console.log(res)
 
				})
			},
			openDb() {
				if (isOpen('pop')) return
				openDb('pop').then(res =&gt; {
					console.log(res)
				})
			},
			setSql() {
				updateSQL('pop', this.tableName, {
					chat_friend_id: 'Texas3333666',
					content: '3333666'
				}, 'local_id', '3_bpu8sufahoe').then(res =&gt; {
					console.log('1111')
				})
			},
			addSql() {
				console.log(this.valInp)
				console.log(this.tableName)
				let _this = this
				if (this.valInp == '') {
					uni.showToast({
						icon: "none",
						title: "请输入聊天内容"
					})
					return
				}
				let objMsg = {}
				let local_id = 3 + '_' + this.getLocalId()
				let content = {}
				content.voiceTime = 0
				content.url = ''
				content.tempFilePath = ''
				content.text = this.valInp
				objMsg.id = local_id
				objMsg.chat_friend_id = 3
				objMsg.user_id = 1
				objMsg.local_id = local_id
				objMsg.is_read = 0
				objMsg.status = 0
				objMsg.send_time = parseInt(new Date().getTime() / 1000)
				objMsg.msg_type = 1
				objMsg.content = JSON.stringify(content)
				addTabItem('pop', _this.tableName, {
					id: objMsg.id,
					local_id: objMsg.id,
					content: '2',
					chat_friend_id: _this.valInp,
				}).then((res) =&gt; {
					_this.valInp = ''
					console.log(_this.valInp)
				})
			},
			// 获取本地id
			getLocalId() {
				return Math.random().toString(36).slice(2)
			},
			getSql() {
				selectDataList('pop', this.tableName,{}).then(res =&gt; {
					console.log(res)
					this.chatTableList = res
				})
			},
			getBranch() {
				getDataList('pop', this.tableName, 1, 20, 'chat_i', 'desc').then(res =&gt; {
					console.log(res)
					this.chatTableList = res
				}).catch(err =&gt; {
					console.log(err)
				})
			},
			getNum() {
				getCount('pop', this.tableName).then(res =&gt; {
					this.chatTableListLength = res[0].num
				})
			}
		}
	}
&lt;/script&gt;
 
&lt;style&gt;
	.content button {
		margin-bottom: 20rpx;
	}
 
	.input_box {
		width: 690rpx;
		height: 80rpx;
		font-size: 40rpx;
		line-height: 40rpx;
		margin: 10rpx auto;
		background-color: pink;
	}
 
	.table_box {
		width: 690rpx;
		margin: 10rpx auto;
		text-align: center;
	}
&lt;/style&gt;</code></pre>
    <p>
     参照文章
    </p>
    <p>
     <a href="https://www.runoob.com/sqlite/sqlite-create-table.html" rel="nofollow" title="SQLite 创建表 | 菜鸟教程">
      SQLite 创建表 | 菜鸟教程
     </a>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f7869616f5f7169616e673636362f:61727469636c652f64657461696c732f313436323336313838" class_="artid" style="display:none">
 </p>
</div>


