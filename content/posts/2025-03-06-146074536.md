---
layout: post
title: "dify-ollama-deepseek-r1-stable-diffusion-构建绘画智能体"
date: 2025-03-06 17:15:54 +0800
description: "stable-diffusion 集成进 dify 后，我们搭建一个小智能体，验证下文生图功能。"
keywords: "dify + ollama + deepseek-r1+ stable-diffusion 构建绘画智能体"
categories: ['未分类']
tags: ['Stable', 'Diffusion']
artid: "146074536"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146074536
    alt: "dify-ollama-deepseek-r1-stable-diffusion-构建绘画智能体"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146074536
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146074536
cover: https://bing.ee123.net/img/rand?artid=146074536
image: https://bing.ee123.net/img/rand?artid=146074536
img: https://bing.ee123.net/img/rand?artid=146074536
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     dify + ollama + deepseek-r1+ stable-diffusion 构建绘画智能体
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     故事背景
    </h2>
    <p>
     stable-diffusion 集成进 dify 后，我们搭建一个小智能体，验证下文生图功能
    </p>
    <h2>
     <a id="_2">
     </a>
     业务流程
    </h2>
    <div class="mermaid">
     <svg class="mermaid-svg" height="88" id="mermaid-svg-6nSwwp69eMizP6bt" viewbox="0 0 851.234375 88" width="851.234375" xmlns="http://www.w3.org/2000/svg">
      <style>
       #mermaid-svg-6nSwwp69eMizP6bt {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-6nSwwp69eMizP6bt .error-icon{fill:#552222;}#mermaid-svg-6nSwwp69eMizP6bt .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-6nSwwp69eMizP6bt .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-6nSwwp69eMizP6bt .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-6nSwwp69eMizP6bt .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-6nSwwp69eMizP6bt .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-6nSwwp69eMizP6bt .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-6nSwwp69eMizP6bt .marker{fill:#333333;stroke:#333333;}#mermaid-svg-6nSwwp69eMizP6bt .marker.cross{stroke:#333333;}#mermaid-svg-6nSwwp69eMizP6bt svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-6nSwwp69eMizP6bt .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-6nSwwp69eMizP6bt .cluster-label text{fill:#333;}#mermaid-svg-6nSwwp69eMizP6bt .cluster-label span{color:#333;}#mermaid-svg-6nSwwp69eMizP6bt .label text,#mermaid-svg-6nSwwp69eMizP6bt span{fill:#333;color:#333;}#mermaid-svg-6nSwwp69eMizP6bt .node rect,#mermaid-svg-6nSwwp69eMizP6bt .node circle,#mermaid-svg-6nSwwp69eMizP6bt .node ellipse,#mermaid-svg-6nSwwp69eMizP6bt .node polygon,#mermaid-svg-6nSwwp69eMizP6bt .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-6nSwwp69eMizP6bt .node .label{text-align:center;}#mermaid-svg-6nSwwp69eMizP6bt .node.clickable{cursor:pointer;}#mermaid-svg-6nSwwp69eMizP6bt .arrowheadPath{fill:#333333;}#mermaid-svg-6nSwwp69eMizP6bt .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-6nSwwp69eMizP6bt .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-6nSwwp69eMizP6bt .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-6nSwwp69eMizP6bt .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-6nSwwp69eMizP6bt .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-6nSwwp69eMizP6bt .cluster text{fill:#333;}#mermaid-svg-6nSwwp69eMizP6bt .cluster span{color:#333;}#mermaid-svg-6nSwwp69eMizP6bt div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-6nSwwp69eMizP6bt :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
      </style>
      <g>
       <g class="output">
        <g class="clusters">
        </g>
        <g class="edgePaths">
         <g class="edgePath LS-A LE-B" id="L-A-B" style="opacity: 1;">
          <path class="path" d="M124,44L128.16666666666666,44C132.33333333333334,44,140.66666666666666,44,149,44C157.33333333333334,44,165.66666666666666,44,169.83333333333334,44L174,44" marker-end="url(#arrowhead55)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead55" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B LE-C" id="L-B-C" style="opacity: 1;">
          <path class="path" d="M358.265625,44L362.4322916666667,44C366.5989583333333,44,374.9322916666667,44,383.265625,44C391.5989583333333,44,399.9322916666667,44,404.0989583333333,44L408.265625,44" marker-end="url(#arrowhead56)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead56" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-C LE-D" id="L-C-D" style="opacity: 1;">
          <path class="path" d="M608.96875,44L613.1354166666666,44C617.3020833333334,44,625.6354166666666,44,633.96875,44C642.3020833333334,44,650.6354166666666,44,654.8020833333334,44L658.96875,44" marker-end="url(#arrowhead57)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead57" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
        </g>
        <g class="edgeLabels">
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-A' L-LE-B" id="L-L-A-B">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B' L-LE-C" id="L-L-B-C">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-C' L-LE-D" id="L-L-C-D">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
        <g class="nodes">
         <g class="node default" id="flowchart-A-30" style="opacity: 1;" transform="translate(66,44)">
          <rect class="label-container" height="46" rx="0" ry="0" width="116" x="-58" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48,-13)">
            <foreignobject height="26" width="96">
             <div style="display: inline-block; white-space: nowrap;">
              用户输入文本
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-B-31" style="opacity: 1;" transform="translate(266.1328125,44)">
          <rect class="label-container" height="72" rx="0" ry="0" width="184.265625" x="-92.1328125" y="-36">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-82.1328125,-26)">
            <foreignobject height="52" width="164.265625">
             <div style="display: inline-block; white-space: nowrap;">
              LLM根据用户诉求,
              <br/>
              生成文生图英文prompt
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C-33" style="opacity: 1;" transform="translate(508.6171875,44)">
          <rect class="label-container" height="72" rx="0" ry="0" width="200.703125" x="-100.3515625" y="-36">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-90.3515625,-26)">
            <foreignobject height="52" width="180.703125">
             <div style="display: inline-block; white-space: nowrap;">
              根据文生图prompt调用
              <br/>
              stable-diffusion 生成图片
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-D-35" style="opacity: 1;" transform="translate(751.1015625,44)">
          <rect class="label-container" height="46" rx="0" ry="0" width="184.265625" x="-92.1328125" y="-23">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-82.1328125,-13)">
            <foreignobject height="26" width="164.265625">
             <div style="display: inline-block; white-space: nowrap;">
              输出图片和英文prompt
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
        </g>
       </g>
      </g>
     </svg>
    </div>
    <h2>
     <a id="_9">
     </a>
     节点图
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1f7009c91ce9402493e9877e3346042c.png"/>
    </p>
    <h2>
     <a id="_11">
     </a>
     节点说明
    </h2>
    <h3>
     <a id="LLM_12">
     </a>
     LLM
    </h3>
    <p>
     LLM 节点采用 deepseek-r1 模型，提示词为：
     <code>
      根据用户输入的文本，理解并转换成文生图提示词，且提示词必须是英文，输出​内容不带思考过程，以文本输出
     </code>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/37c8cb6842f648f5ba29e6c6792c6c1a.png"/>
    </p>
    <h3>
     <a id="_15">
     </a>
     代码执行
    </h3>
    <p>
     由于大模型生成的文本中，还存在思考过程，这里由于是demo，直接字符串截取，获取英文prompt
    </p>
    <h2>
     <a id="_17">
     </a>
     验证效果
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e622470805674dc99ad826f7c3b37bdc.png">
      <br/>
      LLM节点输出的数据为
     </img>
    </p>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"text"</span><span class="token operator">:</span> <span class="token string">"&lt;details style=\"color:gray;background-color: #f8f8f8;padding: 8px;border-radius: 4px;\" open&gt; &lt;summary&gt; Thinking... &lt;/summary&gt;\n好的，我现在需要处理用户的查询。用户提供了一段中文文本：“《红楼梦》中的林黛玉”，然后要求我将其转换为用于文生图的提示词，并且这个提示词必须是英文，同时不带任何思考过程，直接输出结果。\n\n首先，我要理解用户的需求。他们希望将中文描述转换成英文的提示词，用于生成图像。这可能是因为他们正在使用一个支持英文提示词的绘图工具或API，比如DALL·E、MidJourney或者Stable Diffusion等。这些工具通常需要明确且详细的英文提示词来生成高质量的图像。\n\n接下来，我分析用户提供的文本：“《红楼梦》中的林黛玉”。这句话提到了两个关键元素：一是作品名称《红楼梦》，二是人物林黛玉。因此，提示词需要包含这两个信息点，并且可能还需要一些额外的描述来帮助生成更准确的画面。\n\n考虑到绘图模型通常对细节和氛围比较敏感，我应该在提示词中添加一些环境或风格的描述。例如，“古典中国文学作品”可以传达出《红楼梦》的文化背景；“忧郁而优雅”则能描绘林黛玉的性格特点；再加上“传统服饰”来具体化人物的形象。\n\n然后，我会把这些元素组合成一个连贯的英文句子。确保用词准确且自然流畅，避免过于生硬或直译。例如，“A melancholic and elegant character from the classic Chinese literary work 'Dream of the Red Chamber'”能够很好地表达林黛玉的角色特质和作品背景；“dressed in traditional Chinese attire”则进一步细化了人物的外貌特征。\n\n最后，检查整个提示词是否完整，是否有遗漏的关键信息。确保没有语法错误，并且每个部分都清晰传达给绘图模型，以便生成符合预期的画面。\n&lt;/details&gt;\n\nA melancholic and elegant character from the classic Chinese literary work \"Dream of the Red Chamber\", dressed in traditional Chinese attire"</span><span class="token punctuation">,</span>
  <span class="token string-property property">"usage"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"prompt_tokens"</span><span class="token operator">:</span> <span class="token number">45</span><span class="token punctuation">,</span>
    <span class="token string-property property">"prompt_unit_price"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"prompt_price_unit"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"prompt_price"</span><span class="token operator">:</span> <span class="token string">"0E-7"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"completion_tokens"</span><span class="token operator">:</span> <span class="token number">402</span><span class="token punctuation">,</span>
    <span class="token string-property property">"completion_unit_price"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"completion_price_unit"</span><span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"completion_price"</span><span class="token operator">:</span> <span class="token string">"0E-7"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"total_tokens"</span><span class="token operator">:</span> <span class="token number">447</span><span class="token punctuation">,</span>
    <span class="token string-property property">"total_price"</span><span class="token operator">:</span> <span class="token string">"0E-7"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"currency"</span><span class="token operator">:</span> <span class="token string">"USD"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"latency"</span><span class="token operator">:</span> <span class="token number">42.33978042751551</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"finish_reason"</span><span class="token operator">:</span> <span class="token string">"stop"</span>
<span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f78687a71313938362f:61727469636c652f64657461696c732f313436303734353336" class_="artid" style="display:none">
 </p>
</div>


