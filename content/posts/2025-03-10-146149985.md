---
layout: post
title: "PostgreSQL的备份方式"
date: 2025-03-10 12:01:06 +0800
description: "是 PostgreSQL 内置的逻辑备份工具，可以将数据库导出为 SQL 脚本或二进制文件。WAL-G 是 PostgreSQL 的现代备份工具，支持增量备份和快速恢复，常用于云环境。按照这些方式定期备份 PostgreSQL 数据库，可以最大程度地保障数据的安全和可恢复性。Barman 是社区维护的 PostgreSQL 专用备份工具，支持物理备份和时间点恢复。PostgreSQL 提供多种方式进行备份，适用于不同需求的场景。是 PostgreSQL 提供的物理备份工具，适合对数据库进行完整二进制备份。"
keywords: "pgsql的备份"
categories: ['面试', '阿里巴巴', '学习路线']
tags: ['数据库', 'Postgresql']
artid: "146149985"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146149985
    alt: "PostgreSQL的备份方式"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146149985
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146149985
cover: https://bing.ee123.net/img/rand?artid=146149985
image: https://bing.ee123.net/img/rand?artid=146149985
img: https://bing.ee123.net/img/rand?artid=146149985
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     PostgreSQL的备份方式
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     PostgreSQL 提供多种方式进行备份，适用于不同需求的场景。常用的备份方法如下：
    </p>
    <hr/>
    <h4>
     <a id="1_pg_dump__pg_dumpall_8">
     </a>
     <strong>
      1. 逻辑备份（pg_dump 和 pg_dumpall）
     </strong>
    </h4>
    <h5>
     <a id="11__pg_dump__10">
     </a>
     <strong>
      1.1 使用 pg_dump 备份单个数据库
     </strong>
    </h5>
    <p>
     <code>
      pg_dump
     </code>
     是 PostgreSQL 内置的逻辑备份工具，可以将数据库导出为 SQL 脚本或二进制文件。
    </p>
    <h6>
     <a id="_14">
     </a>
     <strong>
      备份命令
     </strong>
    </h6>
    <ul>
     <li>
      <p>
       <strong>
        备份为 SQL 文件
       </strong>
       ：
      </p>
      <pre><code>pg_dump -U username -d database_name -F p -f /path/to/backup.sql
</code></pre>
      <p>
       参数说明：
      </p>
      <ul>
       <li>
        <code>
         -U
        </code>
        : 用户名。
       </li>
       <li>
        <code>
         -d
        </code>
        : 数据库名称。
       </li>
       <li>
        <code>
         -F p
        </code>
        : 输出为纯文本格式（Plain text）。
       </li>
       <li>
        <code>
         -f
        </code>
        : 指定备份文件路径。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        备份为压缩文件
       </strong>
       ：
      </p>
      <pre><code>pg_dump -U username -d database_name -F c -f /path/to/backup.dump
</code></pre>
      <p>
       参数说明：
      </p>
      <ul>
       <li>
        <code>
         -F c
        </code>
        : 压缩格式（Custom format）。
       </li>
       <li>
        压缩格式可以使用
        <code>
         pg_restore
        </code>
        还原。
       </li>
      </ul>
     </li>
    </ul>
    <h6>
     <a id="_37">
     </a>
     <strong>
      还原命令
     </strong>
    </h6>
    <ul>
     <li>
      <p>
       对于 SQL 文件：
      </p>
      <pre><code>psql -U username -d new_database_name -f /path/to/backup.sql
</code></pre>
     </li>
     <li>
      <p>
       对于压缩文件：
      </p>
      <pre><code>pg_restore -U username -d new_database_name /path/to/backup.dump
</code></pre>
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="12__pg_dumpall__52">
     </a>
     <strong>
      1.2 使用 pg_dumpall 备份所有数据库
     </strong>
    </h5>
    <p>
     <code>
      pg_dumpall
     </code>
     用于备份整个 PostgreSQL 实例（包括所有数据库和全局对象，如角色、权限等）。
    </p>
    <h6>
     <a id="_56">
     </a>
     <strong>
      备份命令
     </strong>
    </h6>
    <pre><code>pg_dumpall -U username -f /path/to/backup_all.sql
</code></pre>
    <h6>
     <a id="_61">
     </a>
     <strong>
      还原命令
     </strong>
    </h6>
    <pre><code>psql -U username -f /path/to/backup_all.sql
</code></pre>
    <hr/>
    <h4>
     <a id="2_pg_basebackup_68">
     </a>
     <strong>
      2. 物理备份（pg_basebackup）
     </strong>
    </h4>
    <h5>
     <a id="21__pg_basebackup_70">
     </a>
     <strong>
      2.1 使用 pg_basebackup
     </strong>
    </h5>
    <p>
     <code>
      pg_basebackup
     </code>
     是 PostgreSQL 提供的物理备份工具，适合对数据库进行完整二进制备份。
    </p>
    <h6>
     <a id="_74">
     </a>
     <strong>
      备份命令
     </strong>
    </h6>
    <pre><code>pg_basebackup -U replication_user -D /path/to/backup_directory -Fp -Xs -P
</code></pre>
    <p>
     参数说明：
    </p>
    <ul>
     <li>
      <code>
       -U
      </code>
      : 备份用户（需要配置
      <code>
       replication
      </code>
      权限）。
     </li>
     <li>
      <code>
       -D
      </code>
      : 目标备份目录。
     </li>
     <li>
      <code>
       -Fp
      </code>
      : 文件模式（Plain format）。
     </li>
     <li>
      <code>
       -Xs
      </code>
      : 包含 WAL 日志。
     </li>
     <li>
      <code>
       -P
      </code>
      : 显示进度。
     </li>
    </ul>
    <h6>
     <a id="_87">
     </a>
     <strong>
      还原步骤
     </strong>
    </h6>
    <ol>
     <li>
      <p>
       停止 PostgreSQL 服务：
      </p>
      <pre><code>systemctl stop postgresql
</code></pre>
     </li>
     <li>
      <p>
       将备份数据复制到 PostgreSQL 数据目录：
      </p>
      <pre><code>cp -r /path/to/backup_directory/* /var/lib/pgsql/data/
</code></pre>
     </li>
     <li>
      <p>
       启动 PostgreSQL 服务：
      </p>
      <pre><code>systemctl start postgresql
</code></pre>
     </li>
    </ol>
    <hr/>
    <h4>
     <a id="3_WAL__107">
     </a>
     <strong>
      3. 归档日志备份（WAL 日志）
     </strong>
    </h4>
    <p>
     归档日志备份适用于需要时间点恢复 (Point-in-Time Recovery, PITR) 的场景。
    </p>
    <h5>
     <a id="_111">
     </a>
     <strong>
      步骤
     </strong>
    </h5>
    <ol>
     <li>
      <p>
       <strong>
        配置归档模式
       </strong>
       ：
       <br/>
       编辑
       <code>
        postgresql.conf
       </code>
       ：
      </p>
      <pre><code>archive_mode = on
archive_command = 'cp %p /path/to/archive/%f'
</code></pre>
     </li>
     <li>
      <p>
       <strong>
        重启 PostgreSQL
       </strong>
       ：
      </p>
      <pre><code>systemctl restart postgresql
</code></pre>
     </li>
     <li>
      <p>
       <strong>
        定期备份归档日志
       </strong>
       ：
       <br/>
       配置脚本定期复制
       <code>
        /path/to/archive/
       </code>
       目录。
      </p>
     </li>
     <li>
      <p>
       <strong>
        使用日志和备份恢复
       </strong>
       ：
       <br/>
       在需要恢复时，结合初始物理备份和归档日志文件执行恢复。
      </p>
     </li>
    </ol>
    <hr/>
    <h4>
     <a id="4__134">
     </a>
     <strong>
      4. 其他备份工具
     </strong>
    </h4>
    <h5>
     <a id="41_Barman_136">
     </a>
     <strong>
      4.1 Barman
     </strong>
    </h5>
    <p>
     Barman 是社区维护的 PostgreSQL 专用备份工具，支持物理备份和时间点恢复。
    </p>
    <h6>
     <a id="_140">
     </a>
     <strong>
      备份命令
     </strong>
    </h6>
    <pre><code>barman backup server_name
</code></pre>
    <h6>
     <a id="_145">
     </a>
     <strong>
      恢复命令
     </strong>
    </h6>
    <pre><code>barman recover server_name backup_id /path/to/restore_directory
</code></pre>
    <hr/>
    <h5>
     <a id="42_WALG_152">
     </a>
     <strong>
      4.2 WAL-G
     </strong>
    </h5>
    <p>
     WAL-G 是 PostgreSQL 的现代备份工具，支持增量备份和快速恢复，常用于云环境。
    </p>
    <hr/>
    <h4>
     <a id="_158">
     </a>
     <strong>
      最佳实践
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        定期备份
       </strong>
       ：
      </p>
      <ul>
       <li>
        每天/每周使用
        <code>
         pg_dump
        </code>
        或
        <code>
         pg_basebackup
        </code>
        。
       </li>
       <li>
        实现自动化备份脚本。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        启用归档日志
       </strong>
       ：
      </p>
      <ul>
       <li>
        保证 WAL 日志可用于时间点恢复。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        多地存储备份
       </strong>
       ：
      </p>
      <ul>
       <li>
        本地存储 + 云存储（如 S3、Google Cloud Storage）。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        测试还原流程
       </strong>
       ：
      </p>
      <ul>
       <li>
        定期验证备份文件的完整性。
       </li>
       <li>
        演练灾难恢复。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        监控备份
       </strong>
       ：
      </p>
      <ul>
       <li>
        结合监控工具（如 Zabbix、Prometheus）监控备份进度和状态。
       </li>
      </ul>
     </li>
    </ol>
    <p>
     按照这些方式定期备份 PostgreSQL 数据库，可以最大程度地保障数据的安全和可恢复性。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f656b736b65665f7365662f:61727469636c652f64657461696c732f313436313439393835" class_="artid" style="display:none">
 </p>
</div>


