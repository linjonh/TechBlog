---
layout: post
title: "基于Kubernetes部署MySQL主从集群"
date: 2025-03-07 16:34:58 +0800
description: "以下是一个基于Kubernetes部署MySQL主从集群的详细YAML示例，包含StatefulSet、Service、ConfigMap和Secret等关键配置。MySQL主从集群需要至少1个主节点和多个从节点，这里使用实现主从自动配置。"
keywords: "kubernetes mysql 集群"
categories: ['未分类']
tags: ['Mysql', 'Kubernetes', 'Adb']
artid: "146099313"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146099313
    alt: "基于Kubernetes部署MySQL主从集群"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146099313
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146099313
cover: https://bing.ee123.net/img/rand?artid=146099313
image: https://bing.ee123.net/img/rand?artid=146099313
img: https://bing.ee123.net/img/rand?artid=146099313
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     基于Kubernetes部署MySQL主从集群
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     以下是一个基于Kubernetes部署MySQL主从集群的详细YAML示例，包含StatefulSet、Service、ConfigMap和Secret等关键配置。MySQL主从集群需要至少1个主节点和多个从节点，这里使用
     <strong>
      StatefulSet + 初始化脚本
     </strong>
     实现主从自动配置。
    </p>
    <hr/>
    <h4>
     <a id="1__Namespace__5">
     </a>
     1. 创建 Namespace (可选)
    </h4>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>cluster
</code></pre>
    <hr/>
    <h4>
     <a id="2__Secret_MySQL_15">
     </a>
     2. 创建 Secret (存储MySQL密码)
    </h4>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Secret
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>secrets
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>cluster
<span class="token key atrule">type</span><span class="token punctuation">:</span> Opaque
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">root-password</span><span class="token punctuation">:</span> eHg=  <span class="token comment"># echo -n "xx" | base64 (示例密码)</span>
  <span class="token key atrule">replication-password</span><span class="token punctuation">:</span> eHg=  <span class="token comment"># 主从同步专用密码</span>
</code></pre>
    <hr/>
    <h4>
     <a id="3__ConfigMap__30">
     </a>
     3. 创建 ConfigMap (主从配置文件)
    </h4>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ConfigMap
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>config
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>cluster
<span class="token key atrule">data</span><span class="token punctuation">:</span>
  <span class="token key atrule">master.cnf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    [mysqld]
    log-bin=mysql-bin
    server-id=1</span>
  <span class="token key atrule">slave.cnf</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string">
    [mysqld]
    log-bin=mysql-bin
    server-id=2</span>
  <span class="token key atrule">init.sql</span><span class="token punctuation">:</span> <span class="token punctuation">|</span>  <span class="token comment"># 初始化主从复制的SQL脚本</span>
    CREATE USER 'repl'@'%' IDENTIFIED BY 'xx';  <span class="token comment"># 密码需与Secret中一致</span>
    GRANT REPLICATION SLAVE ON <span class="token important">*.*</span> TO 'repl'@'%';
    FLUSH PRIVILEGES;
</code></pre>
    <hr/>
    <h4>
     <a id="4__Service__54">
     </a>
     4. 创建 Service (主从分离访问)
    </h4>
    <pre><code class="prism language-yaml"><span class="token comment"># 主节点服务</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>master
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>cluster
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">role</span><span class="token punctuation">:</span> master
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None

<span class="token comment"># 从节点服务</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>slave
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>cluster
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">3306</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
    <span class="token key atrule">role</span><span class="token punctuation">:</span> slave
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None
</code></pre>
    <hr/>
    <h4>
     <a id="5__StatefulSet_12_89">
     </a>
     5. 创建 StatefulSet (1主2从)
    </h4>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>cluster
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> mysql
        <span class="token key atrule">role</span><span class="token punctuation">:</span> slave  <span class="token comment"># 默认标记为slave，init容器中将修改第一个Pod为master</span>
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">initContainers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>mysql
        <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">8.0</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> bash
        <span class="token punctuation">-</span> <span class="token string">"-c"</span>
        <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
          # 根据Pod序号分配server-id和角色
          [[ `hostname` =~ -([0-9]+)$ ]] || exit 1
          ordinal=${BASH_REMATCH[1]}
          if [[ $ordinal -eq 0 ]]; then
            # 主节点配置
            cp /mnt/config/master.cnf /mnt/conf.d/
            echo "role=master" &gt; /mnt/conf.d/role
          else
            # 从节点配置
            cp /mnt/config/slave.cnf /mnt/conf.d/
            echo "role=slave" &gt; /mnt/conf.d/role
          fi</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> conf
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /mnt/conf.d
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>map
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /mnt/config
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> clone<span class="token punctuation">-</span>mysql
        <span class="token key atrule">image</span><span class="token punctuation">:</span> alpine<span class="token punctuation">:</span><span class="token number">3.18</span>
        <span class="token key atrule">command</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> bash
        <span class="token punctuation">-</span> <span class="token string">"-c"</span>
        <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
          # 只有从节点需要等待主节点初始化完成
          if [ -f /mnt/conf.d/role ] &amp;&amp; grep -q "slave" /mnt/conf.d/role; then
            until nslookup mysql-0.mysql; do
              sleep 2
            done
          fi</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> conf
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /mnt/conf.d
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
        <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql<span class="token punctuation">:</span><span class="token number">8.0</span>
        <span class="token key atrule">env</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_ROOT_PASSWORD
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>secrets
              <span class="token key atrule">key</span><span class="token punctuation">:</span> root<span class="token punctuation">-</span>password
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> MYSQL_REPL_PASSWORD
          <span class="token key atrule">valueFrom</span><span class="token punctuation">:</span>
            <span class="token key atrule">secretKeyRef</span><span class="token punctuation">:</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>secrets
              <span class="token key atrule">key</span><span class="token punctuation">:</span> replication<span class="token punctuation">-</span>password
        <span class="token key atrule">ports</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql
          <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">3306</span>
        <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> data
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /var/lib/mysql
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> conf
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /etc/mysql/conf.d
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>sql
          <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /docker<span class="token punctuation">-</span>entrypoint<span class="token punctuation">-</span>initdb.d
        <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">exec</span><span class="token punctuation">:</span>
            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"mysqladmin"</span><span class="token punctuation">,</span> <span class="token string">"ping"</span><span class="token punctuation">,</span> <span class="token string">"-uroot"</span><span class="token punctuation">,</span> <span class="token string">"-p${MYSQL_ROOT_PASSWORD}"</span><span class="token punctuation">]</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">10</span>
        <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
          <span class="token key atrule">exec</span><span class="token punctuation">:</span>
            <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token string">"-uroot"</span><span class="token punctuation">,</span> <span class="token string">"-p${MYSQL_ROOT_PASSWORD}"</span><span class="token punctuation">,</span> <span class="token string">"-e"</span><span class="token punctuation">,</span> <span class="token string">"SELECT 1"</span><span class="token punctuation">]</span>
          <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5</span>
      <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> conf
        <span class="token key atrule">emptyDir</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> config<span class="token punctuation">-</span>map
        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>config
          <span class="token key atrule">items</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> master.cnf
            <span class="token key atrule">path</span><span class="token punctuation">:</span> master.cnf
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> slave.cnf
            <span class="token key atrule">path</span><span class="token punctuation">:</span> slave.cnf
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> init<span class="token punctuation">-</span>sql
        <span class="token key atrule">configMap</span><span class="token punctuation">:</span>
          <span class="token key atrule">name</span><span class="token punctuation">:</span> mysql<span class="token punctuation">-</span>config
          <span class="token key atrule">items</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> init.sql
            <span class="token key atrule">path</span><span class="token punctuation">:</span> init.sql
  <span class="token key atrule">volumeClaimTemplates</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> data
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">accessModes</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"ReadWriteOnce"</span><span class="token punctuation">]</span>
      <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> <span class="token string">"standard"</span>  <span class="token comment"># 根据环境调整</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span>
        <span class="token key atrule">requests</span><span class="token punctuation">:</span>
          <span class="token key atrule">storage</span><span class="token punctuation">:</span> 10Gi
</code></pre>
    <hr/>
    <h4>
     <a id="6__StatefulSet_211">
     </a>
     6. 主从初始化自动化脚本 (StatefulSet启动后执行)
    </h4>
    <p>
     主节点启动后自动创建复制用户，从节点自动连接主节点：
    </p>
    <pre><code class="prism language-yaml"><span class="token comment"># 在StatefulSet的Pod模板中添加以下生命周期钩子</span>
<span class="token key atrule">lifecycle</span><span class="token punctuation">:</span>
  <span class="token key atrule">postStart</span><span class="token punctuation">:</span>
    <span class="token key atrule">exec</span><span class="token punctuation">:</span>
      <span class="token key atrule">command</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"/bin/bash"</span>
      <span class="token punctuation">-</span> <span class="token string">"-c"</span>
      <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
        if [ -f /etc/mysql/conf.d/role ] &amp;&amp; grep -q "master" /etc/mysql/conf.d/role; then
          # 主节点执行初始化SQL
          mysql -uroot -p${MYSQL_ROOT_PASSWORD} &lt; /docker-entrypoint-initdb.d/init.sql
        else
          # 从节点配置主从复制
          until mysql -h mysql-0.mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "SELECT 1"; do
            sleep 1
          done
          mysql -uroot -p${MYSQL_ROOT_PASSWORD} -e "
            CHANGE MASTER TO
            MASTER_HOST='mysql-0.mysql',
            MASTER_USER='repl',
            MASTER_PASSWORD='${MYSQL_REPL_PASSWORD}',
            MASTER_AUTO_POSITION=1;
            START SLAVE;
          "
        fi</span>
</code></pre>
    <hr/>
    <h4>
     <a id="_243">
     </a>
     验证主从同步
    </h4>
    <pre><code class="prism language-bash"><span class="token comment"># 检查主节点状态</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mysql-0 <span class="token parameter variable">-n</span> mysql-cluster -- mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span> <span class="token parameter variable">-e</span> <span class="token string">"SHOW MASTER STATUS\G"</span>

<span class="token comment"># 检查从节点同步状态</span>
kubectl <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> mysql-1 <span class="token parameter variable">-n</span> mysql-cluster -- mysql <span class="token parameter variable">-uroot</span> <span class="token parameter variable">-p</span> <span class="token parameter variable">-e</span> <span class="token string">"SHOW SLAVE STATUS\G"</span>
</code></pre>
    <hr/>
    <h4>
     <a id="_254">
     </a>
     关键注意事项：
    </h4>
    <ol>
     <li>
      <strong>
       主节点高可用
      </strong>
      ：此方案主节点单点，若需高可用，需结合
      <strong>
       Orchestrator
      </strong>
      或
      <strong>
       ProxySQL
      </strong>
      实现故障转移。
     </li>
     <li>
      <strong>
       数据持久化
      </strong>
      ：确保
      <code>
       storageClassName
      </code>
      与实际存储系统匹配（如
      <code>
       rook-cephfs
      </code>
      、
      <code>
       nfs
      </code>
      ）。
     </li>
     <li>
      <strong>
       密码安全
      </strong>
      ：通过Secret管理敏感信息，禁止明文存储。
     </li>
     <li>
      <strong>
       网络通信
      </strong>
      ：确保StatefulSet的Pod之间可通过DNS名称互相访问（如
      <code>
       mysql-0.mysql.mysql-cluster.svc.cluster.local
      </code>
      ）。
     </li>
     <li>
      <strong>
       扩展性
      </strong>
      ：通过增加
      <code>
       replicas
      </code>
      数量扩展从节点。
     </li>
    </ol>
    <hr/>
    <h4>
     <a id="_263">
     </a>
     完整架构示意图：
    </h4>
    <pre><code>Client -&gt; Service(mysql-master) -&gt; Pod(mysql-0) [Master]
Client -&gt; Service(mysql-slave)  -&gt; Pod(mysql-1, mysql-2) [Slave]
</code></pre>
    <p>
     可根据需求调整副本数量或增加读写分离中间件（如ProxySQL）。
    </p>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f5261696e7369726975732f:61727469636c652f64657461696c732f313436303939333133" class_="artid" style="display:none">
 </p>
</div>


