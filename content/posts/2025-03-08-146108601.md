---
layout: post
title: "åä¸‰Golang-é€šé“"
date: 2025-03-08 00:20:23 +0800
description: "é€šé“å°±æ˜¯ golang ä¸­å®ç° Goroutine ä¹‹é—´é€šä¿¡çš„æœºåˆ¶ã€‚å®ƒæ˜¯ä¸€ç§ç±»å‹åŒ–çš„é€šé“ï¼Œå…è®¸å¤šä¸ª Goroutine ä¹‹é—´å®‰å…¨åœ°ä¼ é€’æ•°æ®ã€‚é€šé“æ˜¯ Golang å¹¶å‘æ¨¡å‹çš„æ ¸å¿ƒï¼Œå®ƒè§£å†³äº†ä¼ ç»Ÿå¹¶å‘ç¼–ç¨‹ä¸­å…±äº«å†…å­˜å¸¦æ¥çš„å¤æ‚æ€§å’Œé£é™©ã€‚"
keywords: "ã€åä¸‰ã€‘Golang é€šé“"
categories: ['Golang']
tags: ['å¼€å‘è¯­è¨€', 'åç«¯', 'Golang']
artid: "146108601"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146108601
    alt: "åä¸‰Golang-é€šé“"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146108601
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146108601
cover: https://bing.ee123.net/img/rand?artid=146108601
image: https://bing.ee123.net/img/rand?artid=146108601
img: https://bing.ee123.net/img/rand?artid=146108601
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ã€åä¸‰ã€‘Golang é€šé“
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      ğŸ’¢æ¬¢è¿æ¥åˆ°å¼ èƒ¤å°˜çš„å¼€æºæŠ€æœ¯ç«™
      <br/>
      ğŸ’¥å¼€æºå¦‚æ±Ÿæ²³ï¼Œæ±‡èšä¼—å¿—æˆã€‚ä»£ç ä¼¼æ˜Ÿè¾°ï¼Œç…§äº®è¡Œå¾ç¨‹ã€‚å¼€æºç²¾ç¥é•¿ï¼Œä¼ æ‰¿æ°¸ä¸å¿˜ã€‚æºæ‰‹å…±å‰è¡Œï¼Œæœªæ¥æ›´è¾‰ç…ŒğŸ’¥
     </p>
    </blockquote>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="_5">
     </a>
     é€šé“
    </h2>
    <p>
     åœ¨ä¼ ç»Ÿçš„å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œå¤šä¸ªçº¿ç¨‹æˆ–è¿›ç¨‹ä¹‹é—´é€šå¸¸é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ã€‚è¿™ç§æ¨¡å‹è™½ç„¶é«˜æ•ˆï¼Œä½†å®¹æ˜“å¼•å‘
     <strong>
      ç«äº‰æ¡ä»¶
     </strong>
     å’Œ
     <strong>
      æ­»é”
     </strong>
     ç­‰é—®é¢˜ã€‚ä¸ºäº†é¿å…è¿™äº›é—®é¢˜ï¼Œç¨‹åºå‘˜åœ¨å¼€å‘æ—¶éœ€è¦ä½¿ç”¨å¤æ‚çš„åŒæ­¥æœºåˆ¶ï¼ˆä¾‹å¦‚ï¼šé”ã€ä¿¡å·é‡ç­‰ï¼‰æ¥ä¿æŠ¤å…±äº«æ•°æ®ã€‚ä½†æ˜¯
     <code>
      golang
     </code>
     é‡‡ç”¨äº†ä¸åŒçš„æ€è·¯ï¼š
     <strong>
      é¿å…å…±äº«å†…å­˜ï¼Œé€šè¿‡é€šä¿¡æ¥å®ç°å¹¶å‘
     </strong>
     ã€‚
    </p>
    <p>
     ç¤ºæ„å›¾æ‰€ä¸‹æ‰€ç¤ºï¼š
    </p>
    <p>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/62f98800d43642fa8f37dda53731d8d8.png"/>
    </p>
    <p>
     é€šé“å°±æ˜¯
     <code>
      golang
     </code>
     ä¸­å®ç°
     <code>
      Goroutine
     </code>
     ä¹‹é—´é€šä¿¡çš„æœºåˆ¶ã€‚å®ƒæ˜¯ä¸€ç§
     <strong>
      ç±»å‹åŒ–çš„é€šé“
     </strong>
     ï¼Œå…è®¸å¤šä¸ª
     <code>
      Goroutine
     </code>
     ä¹‹é—´å®‰å…¨åœ°ä¼ é€’æ•°æ®ã€‚é€šé“æ˜¯
     <code>
      Golang
     </code>
     å¹¶å‘æ¨¡å‹çš„æ ¸å¿ƒï¼Œå®ƒè§£å†³äº†ä¼ ç»Ÿå¹¶å‘ç¼–ç¨‹ä¸­å…±äº«å†…å­˜å¸¦æ¥çš„å¤æ‚æ€§å’Œé£é™©ã€‚
    </p>
    <blockquote>
     <p>
      æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»çš„æ˜¯é€šé“ï¼Œæœ‰å…³äºåç¨‹ã€å¹¶å‘ç¼–ç¨‹ç­‰ç›¸å…³çŸ¥è¯†ç‚¹è¯·å…³æ³¨åç»­æ–‡ç« ã€Š
      <code>
       Golang
      </code>
      åç¨‹ã€‹ã€ã€Š
      <code>
       Golang
      </code>
      å¹¶å‘ç¼–ç¨‹ã€‹ã€‚
     </p>
    </blockquote>
    <h3>
     <a id="_18">
     </a>
     é€šé“å£°æ˜
    </h3>
    <p>
     ä½¿ç”¨
     <code>
      var
     </code>
     å…³é”®å­—å£°æ˜é€šé“å˜é‡ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">var</span> ch <span class="token keyword">chan</span> <span class="token builtin">int</span>
</code></pre>
    <p>
     å£°æ˜åï¼Œ
     <code>
      ch
     </code>
     æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–çš„é€šé“ï¼Œå…¶é»˜è®¤å€¼ä¸º
     <code>
      nil
     </code>
     ã€‚
    </p>
    <h3>
     <a id="_28">
     </a>
     åˆå§‹åŒ–
    </h3>
    <p>
     ä½¿ç”¨
     <code>
      make
     </code>
     å‡½æ•°åˆå§‹åŒ–é€šé“ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go">ch <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     ä¹Ÿå¯ä»¥ä½¿ç”¨
     <code>
      make
     </code>
     å‡½æ•°åˆ›å»ºä¸€ä¸ªå¸¦ç¼“å†²åŒºçš„é€šé“ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go">ch <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_42">
     </a>
     ç¼“å†²æœºåˆ¶
    </h3>
    <p>
     é€šé“åˆ†ä¸º
     <strong>
      æ— ç¼“å†²é€šé“
     </strong>
     å’Œ
     <strong>
      å¸¦ç¼“å†²é€šé“
     </strong>
     ï¼Œå®ƒä»¬åœ¨è¡Œä¸ºå’Œä½¿ç”¨åœºæ™¯ä¸Šæœ‰ä¸€äº›å…³é”®åŒºåˆ«ã€‚
    </p>
    <h4>
     <a id="_46">
     </a>
     æ— ç¼“å†²é€šé“
    </h4>
    <p>
     åœ¨åˆå§‹åŒ–çš„å°ç»“ä¸­ï¼Œä½¿ç”¨
     <code>
      make
     </code>
     å‡½æ•°è¿›è¡Œåˆå§‹åŒ–é€šé“ï¼Œå½“æ²¡æœ‰æŒ‡å®šé€šé“çš„å®¹é‡ï¼Œæˆ–è€…è¯´é€šé“çš„å®¹é‡å¤§å°ä¸º 0 æ—¶ï¼Œç§°ä¸ºæ— ç¼“å†²é€šé“ã€‚
    </p>
    <p>
     æ— ç¼“å†²é€šé“åœ¨å‘é€æ•°æ®å’Œæ¥æ”¶æ•°æ®æ—¶å­˜åœ¨å¦‚ä¸‹çš„ç‰¹ç‚¹ï¼š
    </p>
    <ul>
     <li>
      <strong>
       å‘é€æ“ä½œ
      </strong>
      ï¼šå‘é€æ•°æ®æ—¶ï¼Œå‘é€æ–¹ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æ¥æ”¶æ–¹å‡†å¤‡æ¥æ”¶æ•°æ®ã€‚
     </li>
     <li>
      <strong>
       æ¥æ”¶æ“ä½œ
      </strong>
      ï¼šæ¥æ”¶æ–¹ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰å‘é€æ–¹å‘é€æ•°æ®ã€‚
     </li>
     <li>
      æ— ç¼“å†²é€šé“çš„å‘é€å’Œæ¥æ”¶æ“ä½œæ˜¯
      <strong>
       åŒæ­¥çš„
      </strong>
      ï¼Œå¿…é¡»æœ‰å‘é€æ–¹å’Œæ¥æ”¶æ–¹åŒæ—¶å‡†å¤‡å¥½ï¼Œæ‰èƒ½å®Œæˆé€šä¿¡ã€‚
     </li>
    </ul>
    <h5>
     <a id="_56">
     </a>
     ä»£ç ç¤ºä¾‹
    </h5>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"sync"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	unbufferedChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// åˆ›å»ºæ— ç¼“å†²é€šé“</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"receiver is waiting..."</span><span class="token punctuation">)</span> <span class="token comment">// receiver is waiting...</span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">)</span>	<span class="token comment">// æ¨¡æ‹Ÿ3ç§’çš„å‡†å¤‡æ—¶é—´</span>
		data <span class="token operator">:=</span> <span class="token operator">&lt;-</span>unbufferedChan <span class="token comment">// åœ¨è¿™è¡Œå‡½æ•°æ‰§è¡Œä¹‹å‰ï¼Œå‘é€æ–¹å¤„äºé˜»å¡çŠ¶æ€</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"received:"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	unbufferedChan <span class="token operator">&lt;-</span> <span class="token number">42</span> 	<span class="token comment">// å‘é€æ–¹é˜»å¡ï¼Œç›´åˆ°æ¥æ”¶æ–¹å‡†å¤‡å¥½</span>
    
    <span class="token function">close</span><span class="token punctuation">(</span>unbufferedChan<span class="token punctuation">)</span>	<span class="token comment">// å…³é—­é€šé“</span>
	
    wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_88">
     </a>
     å¸¦ç¼“å†²é€šé“
    </h4>
    <p>
     å½“æŒ‡å®šäº†é€šé“çš„å®¹é‡ï¼Œä¾‹å¦‚
     <code>
      make(chan int, 10)
     </code>
     ï¼Œåˆ™ç§°ä¸ºå¸¦ç¼“å†²é€šé“ã€‚
    </p>
    <p>
     å¸¦ç¼“å†²é€šé“åœ¨å‘é€æ•°æ®å’Œæ¥æ”¶æ•°æ®æ—¶å­˜åœ¨å¦‚ä¸‹çš„ç‰¹ç‚¹ï¼š
    </p>
    <ul>
     <li>
      <strong>
       å‘é€æ“ä½œ
      </strong>
      ï¼šå‘é€æ•°æ®æ—¶ï¼Œå¦‚æœç¼“å†²åŒºæœªæ»¡ï¼Œæ•°æ®ä¼šè¢«æ”¾å…¥ç¼“å†²åŒºï¼Œå‘é€æ–¹ä¸ä¼šé˜»å¡ï¼›å¦‚æœç¼“å†²åŒºå·²æ»¡ï¼Œå‘é€æ–¹ä¼šé˜»å¡ï¼Œç›´åˆ°ç¼“å†²åŒºæœ‰ç©ºé—´ã€‚
     </li>
     <li>
      <strong>
       æ¥æ”¶æ“ä½œ
      </strong>
      ï¼šæ¥æ”¶æ–¹ä»ç¼“å†²åŒºä¸­å–å‡ºæ•°æ®ï¼Œå¦‚æœç¼“å†²åŒºä¸ºç©ºï¼Œæ¥æ”¶æ–¹ä¼šé˜»å¡ï¼Œç›´åˆ°æœ‰æ•°æ®å¯ç”¨ã€‚
     </li>
     <li>
      å¸¦ç¼“å†²é€šé“çš„å‘é€å’Œæ¥æ”¶æ“ä½œæ˜¯
      <strong>
       å¼‚æ­¥çš„
      </strong>
      ï¼Œå‘é€æ–¹å’Œæ¥æ”¶æ–¹ä¸éœ€è¦åŒæ—¶å‡†å¤‡å¥½ã€‚ç¼“å†²åŒºçš„å­˜åœ¨å…è®¸æ•°æ®åœ¨å‘é€æ–¹å’Œæ¥æ”¶æ–¹ä¹‹é—´æš‚æ—¶å­˜å‚¨ã€‚
     </li>
    </ul>
    <h5>
     <a id="_98">
     </a>
     ä»£ç ç¤ºä¾‹
    </h5>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"sync"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	bufferedChan <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// åˆ›å»ºå¸¦ç¼“å†²é€šé“ï¼Œå®¹é‡å¤§å°ä¸º2</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup

	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"receiver is waiting..."</span><span class="token punctuation">)</span>
		<span class="token comment">// for {<!-- --></span>
		<span class="token comment">// 	select {<!-- --></span>
		<span class="token comment">// 	case data, ok := &lt;-bufferedChan:</span>
		<span class="token comment">// 		if ok {<!-- --></span>
		<span class="token comment">// 			fmt.Println("received:", data)</span>
		<span class="token comment">// 		} else {<!-- --></span>
		<span class="token comment">// 			fmt.Println("bufferedChan closed")</span>
		<span class="token comment">// 			return</span>
		<span class="token comment">// 		}</span>
		<span class="token comment">// 	}</span>
		<span class="token comment">// }</span>
		<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token comment">// æ¨¡æ‹Ÿæ¥æ”¶æ–¹ä¸ä»ç¼“å†²é€šé“ä¸­æ¥æ”¶æ•°æ®</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	bufferedChan <span class="token operator">&lt;-</span> <span class="token number">42</span>
	bufferedChan <span class="token operator">&lt;-</span> <span class="token number">43</span>
	bufferedChan <span class="token operator">&lt;-</span> <span class="token number">44</span> <span class="token comment">// å¦‚æœæ¥æ”¶æ–¹ä¸€ç›´æœªæ¥æ”¶æ•°æ®ï¼Œåˆ™åœ¨æ­¤å¤„ä¼šå‘é€é˜»å¡</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"send data over ..."</span><span class="token punctuation">)</span>

	<span class="token function">close</span><span class="token punctuation">(</span>bufferedChan<span class="token punctuation">)</span> <span class="token comment">// å…³é—­é€šé“</span>

	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_144">
     </a>
     é€šé“æ“ä½œ
    </h3>
    <h4>
     <a id="_146">
     </a>
     å‘é€æ•°æ®
    </h4>
    <p>
     ä½¿ç”¨
     <code>
      &lt;-
     </code>
     æ“ä½œç¬¦å°†æ•°æ®å‘é€åˆ°é€šé“ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">10</span> <span class="token comment">// å‘é€šé“ä¸­å‘é€ä¸€ä¸ª 10</span>
    
    <span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span> <span class="token comment">// å…³é—­é€šé“</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_161">
     </a>
     æ¥æ”¶æ•°æ®
    </h4>
    <p>
     ä½¿ç”¨
     <code>
      &lt;-
     </code>
     æ“ä½œç¬¦ä»é€šé“ä¸­è¯»å–æ•°æ®ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">10</span> <span class="token comment">// å‘é€šé“ä¸­å‘é€ä¸€ä¸ª 10</span>

	data <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch      <span class="token comment">// é€šé“ä¸­è¯»å–ä¸€ä¸ªæ•°æ®</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token comment">// 10</span>

	<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span> <span class="token comment">// å…³é—­é€šé“</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_181">
     </a>
     å•å‘é€šé“
    </h4>
    <p>
     <code>
      golang
     </code>
     ä¸­æä¾›äº†å•å‘é€šé“è¿™ä¹ˆä¸€ç§ç‰¹æ®Šçš„é€šé“ç±»å‹ï¼Œå®ƒåªèƒ½ç”¨äºå‘é€æˆ–æ¥æ”¶æ•°æ®ï¼Œè€Œä¸èƒ½åŒæ—¶è¿›è¡Œå‘é€å’Œæ¥æ”¶æ“ä½œã€‚å•å‘é€šé“åœ¨ç±»å‹å£°æ˜ä¸Šä¸æ™®é€šé€šé“ï¼ˆåŒå‘é€šé“ï¼‰æœ‰æ‰€ä¸åŒï¼Œä¸»è¦ç”¨äºé™åˆ¶é€šé“çš„ä½¿ç”¨æ–¹å¼ï¼Œä»è€Œæé«˜ä»£ç çš„å¯è¯»æ€§å’Œå®‰å…¨æ€§ã€‚
    </p>
    <p>
     å•å‘é€šé“æœ‰å¦‚ä¸‹ä¸¤ç§ç±»å‹ï¼š
    </p>
    <ul>
     <li>
      <strong>
       åªå‘é€é€šé“
      </strong>
      ï¼šç”¨äºå‘é€æ•°æ®ï¼Œä½†ä¸èƒ½æ¥æ”¶æ•°æ®ã€‚
     </li>
    </ul>
    <pre><code class="prism language-go"><span class="token keyword">chan</span><span class="token operator">&lt;-</span> Type
</code></pre>
    <ul>
     <li>
      <strong>
       åªæ¥æ”¶é€šé“
      </strong>
      ï¼šç”¨äºæ¥æ”¶æ•°æ®ï¼Œä½†ä¸èƒ½å‘é€æ•°æ®ã€‚
     </li>
    </ul>
    <pre><code class="prism language-go"><span class="token operator">&lt;-</span><span class="token keyword">chan</span> Type
</code></pre>
    <h5>
     <a id="_199">
     </a>
     å•å‘é€šé“çš„ç”¨é€”
    </h5>
    <p>
     å•å‘é€šé“çš„ä¸»è¦ç”¨é€”æ˜¯é™åˆ¶é€šé“çš„ä½¿ç”¨èŒƒå›´ï¼Œé¿å…åœ¨å‡½æ•°æˆ–æ–¹æ³•ä¸­æ»¥ç”¨é€šé“çš„å‘é€å’Œæ¥æ”¶åŠŸèƒ½ã€‚ä¾‹å¦‚ï¼š
    </p>
    <ul>
     <li>
      å½“ä¸€ä¸ªå‡½æ•°åªéœ€è¦ä»é€šé“ä¸­è¯»å–æ•°æ®æ—¶ï¼Œä½¿ç”¨åªæ¥æ”¶é€šé“å¯ä»¥æ˜ç¡®è¡¨ç¤ºè¯¥å‡½æ•°çš„æ„å›¾ã€‚
     </li>
     <li>
      å½“ä¸€ä¸ªå‡½æ•°åªéœ€è¦å‘é€šé“ä¸­å†™å…¥æ•°æ®æ—¶ï¼Œä½¿ç”¨åªå‘é€é€šé“å¯ä»¥é¿å…æ„å¤–è¯»å–é€šé“ä¸­çš„æ•°æ®ã€‚
     </li>
    </ul>
    <h5>
     <a id="_206">
     </a>
     ä»£ç ç¤ºä¾‹
    </h5>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"sync"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">producer</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">,</span> wg <span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// ch å‚æ•°ï¼šä¸€ä¸ªåªå‘é€é€šé“</span>
	<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
		ch <span class="token operator">&lt;-</span> i <span class="token comment">// å‘é€šé“å‘é€æ•°æ®</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"sent: %d\n"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span> <span class="token comment">// å…³é—­é€šé“</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">consumer</span><span class="token punctuation">(</span>ch <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> wg <span class="token operator">*</span>sync<span class="token punctuation">.</span>WaitGroup<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// ch å‚æ•°ï¼šä¸€ä¸ªåªæ¥æ”¶é€šé“</span>
	<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> data<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>	<span class="token comment">// è¯»å–é€šé“æ•°æ®</span>
			<span class="token keyword">if</span> ok <span class="token punctuation">{<!-- --></span>
				fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"received: %d\n"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"chan closed ..."</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// åˆ›å»ºä¸€ä¸ªåŒå‘é€šé“</span>
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

	<span class="token comment">// received: 0</span>
	<span class="token comment">// sent: 0</span>
	<span class="token comment">// sent: 1</span>
	<span class="token comment">// received: 1</span>
	<span class="token comment">// received: 2</span>
	<span class="token comment">// sent: 2</span>
	<span class="token comment">// sent: 3</span>
	<span class="token comment">// received: 3</span>
	<span class="token comment">// received: 4</span>
	<span class="token comment">// sent: 4</span>
	<span class="token comment">// chan closed ...</span>

	<span class="token keyword">go</span> <span class="token function">consumer</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wg<span class="token punctuation">)</span> <span class="token comment">// æ¥æ”¶è€…</span>
	<span class="token keyword">go</span> <span class="token function">producer</span><span class="token punctuation">(</span>ch<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wg<span class="token punctuation">)</span> <span class="token comment">// å‘é€è€…</span>

	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
    <h4>
     <a id="_266">
     </a>
     å¤šè·¯å¤ç”¨
    </h4>
    <p>
     é€šé“çš„å¤šè·¯å¤ç”¨æœºåˆ¶æ˜¯ä¸€ç§ç”¨äºå¤„ç†å¤šä¸ªé€šé“æ“ä½œçš„æŠ€æœ¯ï¼Œå®ƒå…è®¸ç¨‹åºåŒæ—¶ç­‰å¾…å¤šä¸ªé€šé“çš„è¯»å†™æ“ä½œã€‚è¿™ç§æœºåˆ¶çš„æ ¸å¿ƒæ˜¯
     <code>
      select...case
     </code>
     è¯­å¥ï¼Œå®ƒæä¾›äº†å¯¹å¤šä¸ªé€šé“æ“ä½œçš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚
    </p>
    <pre><code class="prism language-go"><span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ch1<span class="token punctuation">:</span>
    <span class="token comment">// å¤„ç† ch1 çš„è¯»æ“ä½œ</span>
<span class="token keyword">case</span> data <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch2<span class="token punctuation">:</span>
    <span class="token comment">// å¤„ç† ch2 çš„è¯»æ“ä½œï¼Œå¹¶å°†è¯»å–åˆ°çš„æ•°æ®èµ‹å€¼ç»™ data</span>
<span class="token keyword">case</span> ch3 <span class="token operator">&lt;-</span> value<span class="token punctuation">:</span>
    <span class="token comment">// å‘ ch3 ä¸­å‘é€å€¼</span>
<span class="token keyword">default</span><span class="token punctuation">:</span>
    <span class="token comment">// å¦‚æœæ²¡æœ‰é€šé“å‡†å¤‡å¥½ï¼Œåˆ™æ‰§è¡Œé»˜è®¤é€»è¾‘</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     å¦å¤–éœ€è¦å¼ºè°ƒçš„æ˜¯ï¼Œå¦‚æœå¤šä¸ªé€šé“åŒæ—¶å‡†å¤‡å¥½ï¼Œ
     <code>
      select...case
     </code>
     ä¼šéšæœºé€‰æ‹©ä¸€ä¸ªé€šé“æ‰§è¡Œæ“ä½œï¼›å¦‚æœæ²¡æœ‰ä»»ä½•ä¸€ä¸ª
     <strong>
      é€šé“å‡†å¤‡å¥½
     </strong>
     ï¼Œåˆ™
     <code>
      select
     </code>
     ä¼šé™·å…¥é˜»å¡ï¼Œé™¤éæœ‰
     <code>
      default
     </code>
     åˆ†æ”¯æ‰§è¡Œã€‚
    </p>
    <p>
     éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šé¢æåˆ°çš„
     <strong>
      é€šé“å‡†å¤‡å¥½
     </strong>
     æ˜¯ä¸ªå£è¯­ï¼Œå¯¹äºæ¥æ”¶æ“ä½œæ¥è¯´éœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªï¼š
    </p>
    <ul>
     <li>
      <strong>
       é€šé“ä¸­æœ‰æ•°æ®å¯è¯»
      </strong>
      ï¼šå¦‚æœé€šé“çš„ç¼“å†²åŒºä¸­æœ‰æ•°æ®ï¼Œæˆ–è€…æœ‰å‘é€æ“ä½œæ­£åœ¨ç­‰å¾…å‘é€æ•°æ®åˆ°é€šé“ä¸­ï¼Œé‚£ä¹ˆæ¥æ”¶æ“ä½œå°±å‡†å¤‡å¥½ã€‚
     </li>
     <li>
      <strong>
       é€šé“å·²å…³é—­
      </strong>
      ï¼šå³ä½¿é€šé“ä¸­æ²¡æœ‰æ•°æ®ï¼Œå¦‚æœé€šé“å·²ç»è¢«å…³é—­ï¼Œæ¥æ”¶æ“ä½œä¹Ÿä¼šç«‹å³è¿”å›é›¶å€¼ï¼Œå¹¶ä¸”
      <code>
       ok
      </code>
      ä¸º
      <code>
       false
      </code>
      ï¼ˆå¦‚æœä½¿ç”¨äº†
      <code>
       data, ok := &lt;-ch
      </code>
      çš„å½¢å¼ï¼‰ã€‚
     </li>
    </ul>
    <p>
     å¯¹å‘é€æ“ä½œæ¥è¯´ä¹Ÿéœ€è¦æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶ä¸­çš„ä»»æ„ä¸€ä¸ªï¼š
    </p>
    <ul>
     <li>
      <strong>
       é€šé“ä¸­æœ‰ç©ºé—´å¯å†™
      </strong>
      ï¼šå¦‚æœé€šé“æ˜¯æ— ç¼“å†²çš„ï¼Œå¹¶ä¸”æœ‰ç­‰å¾…æ¥æ”¶çš„åç¨‹ï¼Œæˆ–è€…é€šé“æ˜¯ç¼“å†²çš„ä¸”ç¼“å†²åŒºä¸­æœ‰ç©ºé—²ä½ç½®ï¼Œé‚£ä¹ˆå‘é€æ“ä½œå°±å‡†å¤‡å¥½ã€‚
     </li>
     <li>
      <strong>
       é€šé“å·²å…³é—­
      </strong>
      ï¼šå¦‚æœé€šé“å·²ç»è¢«å…³é—­ï¼Œå‘é€æ“ä½œä¼šè§¦å‘
      <code>
       panic("send on closed channel")
      </code>
      ã€‚
     </li>
    </ul>
    <h5>
     <a id="_295">
     </a>
     ä»£ç ç¤ºä¾‹
    </h5>
    <p>
     é€šè¿‡
     <code>
      select
     </code>
     åŒæ—¶å¤„ç†å¤šä¸ªé€šé“ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ch1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token comment">// åˆ›å»ºé€šé“ ch1</span>
	ch2 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token comment">// åˆ›å»ºé€šé“ ch2</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// æ¯é—´éš” 1 ç§’ï¼Œå‘é€šé“ ch1 ä¸­å‘é€æ•°æ®ï¼Œä¸€å…±å‘é€ 10 æ¡æ•°æ®</span>
		<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>ch1<span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
			ch1 <span class="token operator">&lt;-</span> <span class="token string">"message from ch1"</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// æ¯é—´éš” 2 ç§’ï¼Œå‘é€šé“ ch2 ä¸­å‘é€æ•°æ®ï¼Œä¸€å…±å‘é€ 10 æ¡æ•°æ®</span>
		<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>ch2<span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
			ch2 <span class="token operator">&lt;-</span> <span class="token string">"message from ch2"</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// no data reception ...</span>
	<span class="token comment">// recived:  message from ch2</span>
	<span class="token comment">// recived:  message from ch1</span>
	<span class="token comment">// no data reception ...</span>
	<span class="token comment">// no data reception ...</span>
	<span class="token comment">// recived:  message from ch1</span>
	<span class="token comment">// no data reception ...</span>
	<span class="token comment">// recived:  message from ch2</span>
	<span class="token comment">// recived:  message from ch1</span>
	<span class="token comment">// no data reception ...</span>
	<span class="token comment">// recived:  message from ch1</span>
	<span class="token comment">// no data reception ...</span>
	<span class="token comment">// no data reception ...</span>
	<span class="token comment">// recived:  message from ch1</span>
	<span class="token comment">// recived:  message from ch2</span>
	<span class="token comment">// no data reception ...</span>
	<span class="token comment">// recived:  message from ch1</span>
	<span class="token comment">// no data reception ...</span>
	<span class="token comment">// recived:  message from ch1</span>
	<span class="token comment">// recived:  message from ch2</span>
	<span class="token comment">// no data reception ...</span>
	<span class="token comment">// recived:  message from ch1</span>
	<span class="token comment">// no data reception ...</span>
	<span class="token comment">// no data reception ...</span>
	<span class="token comment">// recived:  message from ch1</span>
	<span class="token comment">// recived:  message from ch2</span>
	<span class="token comment">// no data reception ...</span>
	<span class="token comment">// recived:  message from ch1</span>
	<span class="token comment">// no data reception ...</span>
	<span class="token comment">// recived:  message from ch2</span>
	<span class="token comment">// ch1 chan closed ...</span>
	<span class="token comment">// recived:  message from ch2</span>
	<span class="token comment">// recived:  message from ch2</span>
	<span class="token comment">// recived:  message from ch2</span>
	<span class="token comment">// recived:  message from ch2</span>
	<span class="token comment">// ch2 chan closed ...</span>
	<span class="token comment">// both channels closed. exiting...</span>

	ch1_s<span class="token punctuation">,</span> ch2_s <span class="token operator">:=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span>

	<span class="token keyword">for</span> ch1_s <span class="token operator">||</span> ch2_s <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> data<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch1<span class="token punctuation">:</span>
			<span class="token keyword">if</span> ok <span class="token punctuation">{<!-- --></span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"recived: "</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> ch1_s <span class="token punctuation">{<!-- --></span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ch1 chan closed ..."</span><span class="token punctuation">)</span>
				ch1_s <span class="token operator">=</span> <span class="token boolean">false</span>
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> data<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch2<span class="token punctuation">:</span>
			<span class="token keyword">if</span> ok <span class="token punctuation">{<!-- --></span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"recived: "</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> ch2_s <span class="token punctuation">{<!-- --></span>
				fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ch2 chan closed ..."</span><span class="token punctuation">)</span>
				ch2_s <span class="token operator">=</span> <span class="token boolean">false</span>
			<span class="token punctuation">}</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"no data reception ..."</span><span class="token punctuation">)</span>
			time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"both channels closed. exiting..."</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</code></pre>
    <h5>
     <a id="_394">
     </a>
     é€šé“å¤ç”¨å™¨çš„å®ç°
    </h5>
    <p>
     åœ¨æŸäº›å¤æ‚åœºæ™¯ä¸­ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨å®ç°é€šé“å¤ç”¨å™¨ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥å°†å¤šä¸ªé€šé“çš„è¾“å‡ºåˆå¹¶åˆ°ä¸€ä¸ªé€šé“ä¸­ï¼Œä»è€Œç®€åŒ–åç»­çš„å¤„ç†é€»è¾‘ã€‚
    </p>
    <p>
     ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„é€šé“å¤ç”¨å™¨å®ç°æ€è·¯ï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"sync"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">send</span><span class="token punctuation">(</span>ch <span class="token keyword">chan</span><span class="token operator">&lt;-</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// æ¨¡æ‹Ÿæ•°æ®å‘é€ï¼Œæ¯ç§’å‘é€ä¸€ä¸ªæ•°å­—</span>
	<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{<!-- --></span>
		ch <span class="token operator">&lt;-</span> i
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">multiplexer</span><span class="token punctuation">(</span>channels <span class="token operator">...</span><span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// åˆå¹¶å¤šä¸ªé€šé“æ•°æ®ï¼Œå‡½æ•°è¿”å›æœ€ç»ˆçš„ä¸€ä¸ªåªè¯»é€šé“</span>
	out <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">defer</span> <span class="token function">close</span><span class="token punctuation">(</span>out<span class="token punctuation">)</span>
		<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ch <span class="token operator">:=</span> <span class="token keyword">range</span> channels <span class="token punctuation">{<!-- --></span>
			wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ch <span class="token operator">&lt;-</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
					<span class="token keyword">case</span> data<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
						<span class="token keyword">if</span> ok <span class="token punctuation">{<!-- --></span>
							out <span class="token operator">&lt;-</span> data <span class="token comment">// æ•°æ®å‘é€åˆ°æœ€ç»ˆçš„åªè¯»é€šé“</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
							<span class="token keyword">return</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">return</span> out
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	ch1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// åˆ›å»ºé€šé“ ch1</span>
	ch2 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// åˆ›å»ºé€šé“ ch2</span>
	ch3 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// åˆ›å»ºé€šé“ ch3</span>

	<span class="token keyword">go</span> <span class="token function">send</span><span class="token punctuation">(</span>ch1<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">send</span><span class="token punctuation">(</span>ch2<span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token function">send</span><span class="token punctuation">(</span>ch3<span class="token punctuation">)</span>

	ret_ch <span class="token operator">:=</span> <span class="token function">multiplexer</span><span class="token punctuation">(</span>ch1<span class="token punctuation">,</span> ch2<span class="token punctuation">,</span> ch3<span class="token punctuation">)</span> <span class="token comment">// æ¥æ”¶è¿”å›çš„é€šé“</span>

	<span class="token keyword">for</span> data <span class="token operator">:=</span> <span class="token keyword">range</span> ret_ch <span class="token punctuation">{<!-- --></span> <span class="token comment">// ä»åªè¯»é€šé“ä¸­è·å–åˆå¹¶åçš„æ•°æ®</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"ret received: %d\n"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ret chan closed ..."</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_464">
     </a>
     è¶…æ—¶æœºåˆ¶
    </h4>
    <p>
     åœ¨
     <code>
      golang
     </code>
     ä¸­ï¼Œé€šé“çš„è¶…æ—¶æœºåˆ¶å¯ä»¥é€šè¿‡
     <code>
      time.After
     </code>
     æˆ–
     <code>
      context
     </code>
     ä¸¤ç§æ–¹å¼æ¥å®ç°ã€‚
    </p>
    <h5>
     <a id="timeAfter_468">
     </a>
     <code>
      time.After
     </code>
    </h5>
    <p>
     <code>
      time.After
     </code>
     æ˜¯ä¸€ä¸ªè¿”å›é€šé“çš„å‡½æ•°ï¼Œä¼šåœ¨æŒ‡å®šçš„è¶…æ—¶æ—¶é—´åå‘é€šé“å‘é€ä¸€ä¸ªæ—¶é—´å€¼ã€‚ç»“åˆ
     <code>
      select...case
     </code>
     è¯­å¥ï¼Œå¯ä»¥å®ç°è¶…æ—¶é€»è¾‘ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token comment">// åˆ›å»ºé€šé“</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span> <span class="token comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span>
		ch <span class="token operator">&lt;-</span> <span class="token string">"ä»»åŠ¡å®Œæˆ"</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">case</span> res <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>time<span class="token punctuation">.</span><span class="token function">After</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">// è®¾ç½®è¶…æ—¶ä¸º2ç§’</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"è¶…æ—¶é€€å‡º"</span><span class="token punctuation">)</span> <span class="token comment">// æœ€ç»ˆæ‰“å° è¶…æ—¶é€€å‡º</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      time.After
     </code>
     æ˜¯ä¸€ç§éå¸¸ç®€æ´ä¸”æ˜“äºç†è§£çš„è¶…æ—¶æœºåˆ¶ï¼Œç‰¹åˆ«é€‚åˆç®€å•çš„è¶…æ—¶åœºæ™¯ã€‚
     <strong>
      ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ
      <code>
       time.After
      </code>
      ä¼šåœ¨åå°å¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨ï¼Œå³ä½¿
      <code>
       select
      </code>
      æå‰é€€å‡ºï¼Œå®šæ—¶å™¨ä¹Ÿä¸ä¼šç«‹åˆ»å›æ”¶ï¼Œå¯èƒ½å¯¼è‡´è½»å¾®çš„èµ„æºæ³„æ¼
     </strong>
     ã€‚
    </p>
    <h5>
     <a id="context_499">
     </a>
     <code>
      context
     </code>
    </h5>
    <p>
     <code>
      context
     </code>
     æ˜¯
     <code>
      golang
     </code>
     ä¸­ç”¨äºä¼ é€’å¯å–æ¶ˆä¿¡å·ã€è¶…æ—¶æ—¶é—´ç­‰çš„å·¥å…·ã€‚é€šè¿‡
     <code>
      context.WithTimeout
     </code>
     åˆ›å»ºä¸€ä¸ªå¸¦æœ‰è¶…æ—¶åŠŸèƒ½çš„ä¸Šä¸‹æ–‡ï¼Œå…¶
     <code>
      Done()
     </code>
     æ–¹æ³•è¿”å›ä¸€ä¸ªé€šé“ï¼Œç”¨äºè¶…æ—¶æ§åˆ¶ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"context"</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"time"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token comment">// åˆ›å»ºé€šé“</span>
	ctx<span class="token punctuation">,</span> cancel <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithTimeout</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">Background</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">*</span>time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// cancel() ä¼šé‡Šæ”¾ä¸ä¸Šä¸‹æ–‡ç›¸å…³çš„èµ„æºï¼Œé¿å…å†…å­˜æ³„æ¼</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">3</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span> <span class="token comment">// æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ</span>
		ch <span class="token operator">&lt;-</span> <span class="token string">"ä»»åŠ¡å®Œæˆ"</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">case</span> res <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">&lt;-</span>ctx<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">// ç›‘å¬è¶…æ—¶ä¿¡å·</span>
		fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"è¶…æ—¶é€€å‡º"</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span><span class="token function">Err</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     åœ¨ä¸Šé¢çš„è¿™ä¸ªä»£ç ä¸­ï¼š
    </p>
    <ul>
     <li>
      <code>
       context.WithTimeout
      </code>
      åˆ›å»ºäº†ä¸€ä¸ªå¸¦æœ‰è¶…æ—¶çš„ä¸Šä¸‹æ–‡ï¼Œå¹¶è®¾ç½®è¶…æ—¶æ—¶é—´ä¸º 2 ç§’ã€‚
     </li>
     <li>
      <code>
       defer cancel()
      </code>
      ç¡®ä¿åœ¨å‡½æ•°è¿”å›æ—¶è°ƒç”¨
      <code>
       cancel()
      </code>
      ï¼Œé‡Šæ”¾èµ„æºã€‚
     </li>
     <li>
      å¦‚æœä»»åŠ¡åœ¨è¶…æ—¶å‰å®Œæˆï¼Œ
      <code>
       cancel()
      </code>
      ä¼šè¢«è°ƒç”¨ï¼Œç»ˆæ­¢æ‰€æœ‰ç›‘å¬
      <code>
       ctx.Done()
      </code>
      çš„åç¨‹ã€‚
     </li>
    </ul>
    <p>
     æ€»çš„æ¥è¯´ï¼Œ
     <code>
      context
     </code>
     æ›´é€‚ç”¨äºå¤æ‚çš„å¹¶å‘åœºæ™¯ï¼Œä¾‹å¦‚å¤šä¸ªä»»åŠ¡çš„è¶…æ—¶æ§åˆ¶ã€ä»»åŠ¡å–æ¶ˆç­‰ï¼›
     <code>
      time.After
     </code>
     æ›´é€‚ç”¨äºç®€å•çš„è¶…æ—¶æ§åˆ¶ï¼Œä¾‹å¦‚å•ä¸ªä»»åŠ¡çš„è¶…æ—¶ã€‚
    </p>
    <h4>
     <a id="_539">
     </a>
     å…³é—­é€šé“
    </h4>
    <p>
     ä½¿ç”¨
     <code>
      close
     </code>
     å‡½æ•°å…³é—­é€šé“ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span> <span class="token comment">// å…³é—­é€šé“</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå½“å…³é—­é€šé“åï¼Œä¸èƒ½å†å‘é€šé“å‘é€æ•°æ®ï¼Œä½†å¯ä»¥ç»§ç»­ä»é€šé“ä¸­æ¥æ”¶æ•°æ®ã€‚
    </p>
    <h4>
     <a id="_554">
     </a>
     æ£€æŸ¥é€šé“æ˜¯å¦å…³é—­
    </h4>
    <p>
     æ¥æ”¶æ•°æ®æ—¶ä¼šæœ‰ä¸¤ä¸ªè¿”å›å€¼ï¼Œä¸€ä¸ªæ˜¯æ•°æ®å¦ä¸€ä¸ªæ˜¯å¸ƒå°”å€¼ï¼Œç”¨äºåˆ¤æ–­é€šé“æ˜¯å¦å…³é—­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"fmt"</span>
	<span class="token string">"sync"</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> wg sync<span class="token punctuation">.</span>WaitGroup
	wg<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">defer</span> wg<span class="token punctuation">.</span><span class="token function">Done</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> data<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch<span class="token punctuation">:</span> <span class="token comment">// data è¡¨ç¤ºæ•°æ®ï¼Œok è¡¨ç¤ºé€šé“æ˜¯å¦å…³é—­</span>
				<span class="token keyword">if</span> ok <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// received: 11</span>
					<span class="token comment">// received: 10</span>
					<span class="token comment">// received: 15</span>
					fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"received:"</span><span class="token punctuation">,</span> data<span class="token punctuation">)</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
					fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">"ch closed"</span><span class="token punctuation">)</span> <span class="token comment">// ch closed</span>
					<span class="token keyword">return</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	ch <span class="token operator">&lt;-</span> <span class="token number">11</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">10</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">15</span>

	<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span> <span class="token comment">// å…³é—­é€šé“</span>
	wg<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_598">
     </a>
     è·å–é€šé“é•¿åº¦
    </h4>
    <p>
     ä½¿ç”¨
     <code>
      len
     </code>
     å‡½æ•°è·å–é€šé“çš„å½“å‰é•¿åº¦ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 0</span>

	ch <span class="token operator">&lt;-</span> <span class="token number">10</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 1</span>

	<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span> <span class="token comment">// å…³é—­é€šé“</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_618">
     </a>
     è·å–é€šé“å®¹é‡
    </h4>
    <p>
     ä½¿ç”¨
     <code>
      cap
     </code>
     å‡½æ•°è·å–é€šé“çš„å½“å‰å®¹é‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">cap</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 5</span>

	ch1 <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token function">cap</span><span class="token punctuation">(</span>ch1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 0</span>

	<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>  <span class="token comment">// å…³é—­é€šé“ ch</span>
	<span class="token function">close</span><span class="token punctuation">(</span>ch1<span class="token punctuation">)</span> <span class="token comment">// å…³é—­é€šé“ ch1</span>
<span class="token punctuation">}</span>

</code></pre>
    <h3>
     <a id="_640">
     </a>
     æºç è§£æ
    </h3>
    <p>
     é’ˆå¯¹é€šé“çš„æºä»£ç è¿›è¡Œè§£æï¼Œä»ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
    </p>
    <ul>
     <li>
      åˆ›å»ºé€šé“
     </li>
     <li>
      å‘é€æ•°æ®
     </li>
     <li>
      æ¥æ”¶æ•°æ®
     </li>
     <li>
      å…³é—­é€šé“
     </li>
    </ul>
    <h4>
     <a id="_649">
     </a>
     é€šé“ç»“æ„ä½“
    </h4>
    <blockquote>
     <p>
      æºç ä½ç½®ï¼šsrc/runtime/chan.go
     </p>
    </blockquote>
    <pre><code class="prism language-go"><span class="token keyword">type</span> hchan <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	qcount   <span class="token builtin">uint</span>           <span class="token comment">// total data in the queue</span>
	dataqsiz <span class="token builtin">uint</span>           <span class="token comment">// size of the circular queue</span>
	buf      unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// points to an array of dataqsiz elements</span>
	elemsize <span class="token builtin">uint16</span>
	closed   <span class="token builtin">uint32</span>
	timer    <span class="token operator">*</span>timer <span class="token comment">// timer feeding this chan</span>
	elemtype <span class="token operator">*</span>_type <span class="token comment">// element type</span>
	sendx    <span class="token builtin">uint</span>   <span class="token comment">// send index</span>
	recvx    <span class="token builtin">uint</span>   <span class="token comment">// receive index</span>
	recvq    waitq  <span class="token comment">// list of recv waiters</span>
	sendq    waitq  <span class="token comment">// list of send waiters</span>

	<span class="token comment">// lock protects all fields in hchan, as well as several</span>
	<span class="token comment">// fields in sudogs blocked on this channel.</span>
	<span class="token comment">//</span>
	<span class="token comment">// Do not change another G's status while holding this lock</span>
	<span class="token comment">// (in particular, do not ready a G), as this can deadlock</span>
	<span class="token comment">// with stack shrinking.</span>
	lock mutex
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <code>
       qcount
      </code>
      ï¼šå½“å‰é€šé“ä¸­å­˜å‚¨çš„æ•°æ®æ•°é‡ï¼Œå¯¹äºæ— ç¼“å†²é€šé“ï¼Œ
      <code>
       qcount
      </code>
      çš„å€¼é€šå¸¸ä¸º 0 æˆ– 1ã€‚
     </li>
     <li>
      <code>
       dataqsiz
      </code>
      ï¼šå¯¹äºç¼“å†²é€šé“ï¼Œ
      <code>
       dataqsiz
      </code>
      è¡¨ç¤ºç¼“å†²åŒºå¯ä»¥å­˜å‚¨çš„æœ€å¤§å…ƒç´ æ•°é‡ã€‚å¯¹äºæ— ç¼“å†²é€šé“ï¼Œ
      <code>
       dataqsiz
      </code>
      ä¸º 0ã€‚
     </li>
     <li>
      <code>
       buf
      </code>
      ï¼šæŒ‡å‘ç¼“å†²åŒºçš„æŒ‡é’ˆã€‚ç¼“å†²åŒºæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œç”¨äºå­˜å‚¨é€šé“ä¸­çš„æ•°æ®ã€‚ä»…å¯¹ç¼“å†²é€šé“æœ‰æ•ˆã€‚æ— ç¼“å†²é€šé“çš„
      <code>
       buf
      </code>
      ä¸º
      <code>
       nil
      </code>
      ã€‚
     </li>
     <li>
      <code>
       elemsize
      </code>
      ï¼šé€šé“ä¸­æ¯ä¸ªå…ƒç´ çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚
     </li>
     <li>
      <code>
       closed
      </code>
      ï¼šæ ‡è®°é€šé“æ˜¯å¦å·²å…³é—­ã€‚å…³é—­çš„é€šé“ä¸èƒ½å†æ¬¡å‘é€æ•°æ®ï¼Œä½†å¯ä»¥ç»§ç»­æ¥æ”¶æ•°æ®ç›´åˆ°ç¼“å†²åŒºä¸ºç©ºã€‚
     </li>
     <li>
      <code>
       timer
      </code>
      ï¼šæŒ‡å‘ä¸€ä¸ªå®šæ—¶å™¨ï¼Œè¯¥å®šæ—¶å™¨ä¸é€šé“ç›¸å…³è”ï¼ˆä¾‹å¦‚ï¼Œç”¨äºè¶…æ—¶æ“ä½œï¼‰ã€‚
     </li>
     <li>
      <code>
       elemtype
      </code>
      ï¼šæŒ‡å‘é€šé“ä¸­å…ƒç´ çš„ç±»å‹ä¿¡æ¯ï¼Œç”¨äºåœ¨è¿è¡Œæ—¶æ£€æŸ¥é€šé“ä¸­å­˜å‚¨çš„æ•°æ®ç±»å‹æ˜¯å¦æ­£ç¡®ã€‚
     </li>
     <li>
      <code>
       sendx
      </code>
      ï¼šç”¨äºç®¡ç†ç¼“å†²åŒºçš„ç¯å½¢é˜Ÿåˆ—ï¼Œè®°å½•ä¸‹ä¸€æ¬¡å‘é€æ“ä½œåœ¨ç¼“å†²åŒºä¸­çš„ç´¢å¼•ã€‚
     </li>
     <li>
      <code>
       recvx
      </code>
      ï¼šç”¨äºç®¡ç†ç¼“å†²åŒºçš„ç¯å½¢é˜Ÿåˆ—ï¼Œè®°å½•ä¸‹ä¸€æ¬¡æ¥æ”¶æ“ä½œåœ¨ç¼“å†²åŒºä¸­çš„ç´¢å¼•ã€‚
     </li>
     <li>
      <code>
       recvq
      </code>
      ï¼šå­˜å‚¨ç­‰å¾…æ¥æ”¶çš„åç¨‹é˜Ÿåˆ—ï¼Œåœ¨å‘é€æ“ä½œä¸­ï¼Œå¦‚æœç¼“å†²åŒºå·²æ»¡ä¸”æ²¡æœ‰ç­‰å¾…æ¥æ”¶çš„åç¨‹ï¼Œåˆ™å‘é€åç¨‹ä¼šè¢«åŠ å…¥åˆ°
      <code>
       sendq
      </code>
      ã€‚
     </li>
     <li>
      <code>
       sendq
      </code>
      ï¼šå­˜å‚¨ç­‰å¾…å‘é€çš„åç¨‹é˜Ÿåˆ—ï¼Œåœ¨æ¥æ”¶æ“ä½œä¸­ï¼Œå¦‚æœç¼“å†²åŒºä¸ºç©ºä¸”æ²¡æœ‰ç­‰å¾…å‘é€çš„åç¨‹ï¼Œåˆ™æ¥æ”¶åç¨‹ä¼šè¢«åŠ å…¥åˆ°
      <code>
       recvq
      </code>
      ã€‚
     </li>
     <li>
      <code>
       lock
      </code>
      ï¼šä¿æŠ¤
      <code>
       hchan
      </code>
      ç»“æ„ä½“ä¸­æ‰€æœ‰å­—æ®µçš„äº’æ–¥é”ï¼Œç¡®ä¿é€šé“æ“ä½œçš„çº¿ç¨‹å®‰å…¨æ€§ã€‚åœ¨å‘é€ã€æ¥æ”¶å’Œå…³é—­æ“ä½œä¸­ï¼Œ
      <code>
       lock
      </code>
      ç”¨äºé˜²æ­¢å¤šä¸ªåç¨‹åŒæ—¶ä¿®æ”¹é€šé“çš„çŠ¶æ€ã€‚
     </li>
    </ul>
    <h4>
     <a id="_690">
     </a>
     åˆ›å»ºé€šé“
    </h4>
    <p>
     åœ¨
     <code>
      golang
     </code>
     çš„è¿è¡Œæ—¶ä¸­ï¼Œåˆ›å»ºé€šé“çš„ä»£ç ä¼šè¢«ç¼–è¯‘ä¸ºå¯¹
     <code>
      makechan
     </code>
     çš„è°ƒç”¨ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ç¼–è¯‘æˆæ±‡ç¼–ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-assembly">0x001a 00026        CALL    runtime.makechan(SB)
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šæ±‡ç¼–ä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <p>
     <code>
      makechan
     </code>
     å‡½æ•°æ˜¯è¿è¡Œæ—¶ä¸­ç”¨äºåˆ›å»ºé€šé“çš„æ ¸å¿ƒå‡½æ•°ã€‚å®ƒåˆå§‹åŒ–äº†ä¸€ä¸ª
     <code>
      hchan
     </code>
     ç»“æ„ä½“ï¼Œå¹¶æ ¹æ®æŒ‡å®šçš„ç±»å‹å’Œç¼“å†²åŒºå¤§å°åˆ†é…å†…å­˜ã€‚
    </p>
    <blockquote>
     <p>
      æºç ä½ç½®ï¼šsrc/runtime/chan.go
     </p>
    </blockquote>
    <h5>
     <a id="_714">
     </a>
     å‡½æ•°åŸå‹
    </h5>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">makechan</span><span class="token punctuation">(</span>t <span class="token operator">*</span>chantype<span class="token punctuation">,</span> size <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>hchan <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <code>
       t *chantype
      </code>
      ï¼šé€šé“çš„ç±»å‹ä¿¡æ¯ï¼ŒåŒ…å«é€šé“ä¸­å…ƒç´ çš„ç±»å‹ã€‚
     </li>
     <li>
      <code>
       size int
      </code>
      ï¼šé€šé“çš„ç¼“å†²åŒºå¤§å°ã€‚å¦‚æœä¸º 0ï¼Œåˆ™åˆ›å»ºæ— ç¼“å†²é€šé“ï¼›å¦‚æœå¤§äº 0ï¼Œåˆ™åˆ›å»ºæœ‰ç¼“å†²é€šé“ã€‚
     </li>
     <li>
      è¿”å›ä¸€ä¸ªåˆå§‹åŒ–åçš„
      <code>
       hchan
      </code>
      ç»“æ„ä½“æŒ‡é’ˆã€‚
     </li>
    </ul>
    <h5>
     <a id="_726">
     </a>
     å‡½æ•°å†…å®¹
    </h5>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">makechan</span><span class="token punctuation">(</span>t <span class="token operator">*</span>chantype<span class="token punctuation">,</span> size <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>hchan <span class="token punctuation">{<!-- --></span>
	elem <span class="token operator">:=</span> t<span class="token punctuation">.</span>Elem	<span class="token comment">// ä»é€šé“ç±»å‹ t ä¸­è·å–é€šé“ä¸­å…ƒç´ çš„ç±»å‹ä¿¡æ¯</span>

	<span class="token comment">// compiler checks this but be safe.</span>
    <span class="token comment">// æ£€æŸ¥é€šé“ä¸­å…ƒç´ çš„å¤§å°æ˜¯å¦è¶…è¿‡ 64KBï¼Œå¦‚æœè¶…è¿‡ï¼ŒæŠ›å‡ºå¼‚å¸¸</span>
	<span class="token keyword">if</span> elem<span class="token punctuation">.</span>Size_ <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"makechan: invalid channel element type"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    
    <span class="token comment">// ç¡®ä¿ hchan çš„å¤§å°æ˜¯æœ€å¤§å¯¹é½å•ä½çš„å€æ•°ï¼Œå¹¶ä¸”å…ƒç´ çš„å¯¹é½è¦æ±‚ä¸è¶…è¿‡æœ€å¤§å¯¹é½å•ä½</span>
    <span class="token comment">// maxAlign = 8</span>
	<span class="token keyword">if</span> hchanSize<span class="token operator">%</span>maxAlign <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> elem<span class="token punctuation">.</span>Align_ <span class="token operator">&gt;</span> maxAlign <span class="token punctuation">{<!-- --></span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"makechan: bad alignment"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

    <span class="token comment">// è®¡ç®—ç¼“å†²åŒºçš„æ€»å¤§å°ï¼šelem.Size_ * size</span>
	mem<span class="token punctuation">,</span> overflow <span class="token operator">:=</span> math<span class="token punctuation">.</span><span class="token function">MulUintptr</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span>Size_<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// æ£€æŸ¥æ˜¯å¦å‘ç”Ÿæº¢å‡ºï¼Œæˆ–è€…ç¼“å†²åŒºå¤§å°è¶…è¿‡æœ€å¤§åˆ†é…é™åˆ¶ï¼Œæˆ–è€…ç¼“å†²åŒºå¤§å°å°äº0ï¼ŒæŠ›å‡ºå¼‚å¸¸</span>
	<span class="token keyword">if</span> overflow <span class="token operator">||</span> mem <span class="token operator">&gt;</span> maxAlloc<span class="token operator">-</span>hchanSize <span class="token operator">||</span> size <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token function">plainError</span><span class="token punctuation">(</span><span class="token string">"makechan: size out of range"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Hchan does not contain pointers interesting for GC when elements stored in buf do not contain pointers.</span>
	<span class="token comment">// buf points into the same allocation, elemtype is persistent.</span>
	<span class="token comment">// SudoG's are referenced from their owning thread so they can't be collected.</span>
	<span class="token comment">// TODO(dvyukov,rlh): Rethink when collector can move allocated objects.</span>
    <span class="token comment">// å†…å­˜åˆ†é…</span>
	<span class="token keyword">var</span> c <span class="token operator">*</span>hchan
	<span class="token keyword">switch</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">case</span> mem <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token comment">// å¦‚æœç¼“å†²åŒºå¤§å°ä¸º 0ï¼ˆæ— ç¼“å†²é€šé“ï¼‰æˆ–å…ƒç´ å¤§å°ä¸º 0ï¼Œä»…åˆ†é… hchan çš„å†…å­˜</span>
		<span class="token comment">// Queue or element size is zero.</span>
		c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>hchan<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">mallocgc</span><span class="token punctuation">(</span>hchanSize<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token comment">// Race detector uses this location for synchronization.</span>
        <span class="token comment">// åˆå§‹åŒ–é€šé“çš„ç¼“å†²åŒºçš„æŒ‡é’ˆ</span>
        <span class="token comment">// buf æŒ‡å‘ hchan ç»“æ„ä½“æœ¬èº«ï¼Œè¡¨ç¤ºæ²¡æœ‰ç‹¬ç«‹çš„ç¼“å†²åŒº</span>
		c<span class="token punctuation">.</span>buf <span class="token operator">=</span> c<span class="token punctuation">.</span><span class="token function">raceaddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">!</span>elem<span class="token punctuation">.</span><span class="token function">Pointers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">// å¦‚æœå…ƒç´ ç±»å‹ä¸åŒ…å«æŒ‡é’ˆï¼ˆå¦‚åŸºæœ¬ç±»å‹æˆ–æ•°ç»„ï¼‰ï¼Œå°† hchan å’Œç¼“å†²åŒºåˆ†é…åœ¨åŒä¸€å—å†…å­˜ä¸­</span>
		<span class="token comment">// Elements do not contain pointers.</span>
		<span class="token comment">// Allocate hchan and buf in one call.</span>
		c <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">*</span>hchan<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">mallocgc</span><span class="token punctuation">(</span>hchanSize<span class="token operator">+</span>mem<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// åˆå§‹åŒ–é€šé“çš„ç¼“å†²åŒºçš„æŒ‡é’ˆ</span>
        <span class="token comment">// å°† c.buf æŒ‡å‘ hchan ç»“æ„ä½“ä¹‹åçš„å†…å­˜åŒºåŸŸï¼Œè¯¥åŒºåŸŸç”¨äºå­˜å‚¨ç¼“å†²åŒºæ•°æ®</span>
		c<span class="token punctuation">.</span>buf <span class="token operator">=</span> <span class="token function">add</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">,</span> hchanSize<span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token comment">// å¦‚æœå…ƒç´ ç±»å‹åŒ…å«æŒ‡é’ˆï¼ˆå¦‚ç»“æ„ä½“æˆ–åˆ‡ç‰‡ï¼‰ï¼Œåˆ†åˆ«åˆ†é… hchan å’Œç¼“å†²åŒºçš„å†…å­˜</span>
        <span class="token comment">// å› ä¸º gc éœ€è¦è·Ÿè¸ªæŒ‡é’ˆç±»å‹çš„å†…å­˜åˆ†é…</span>
		<span class="token comment">// Elements contain pointers.</span>
		c <span class="token operator">=</span> <span class="token function">new</span><span class="token punctuation">(</span>hchan<span class="token punctuation">)</span>
        <span class="token comment">// åˆå§‹åŒ–é€šé“çš„ç¼“å†²åŒºçš„æŒ‡é’ˆ</span>
		c<span class="token punctuation">.</span>buf <span class="token operator">=</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
    <span class="token comment">// è®¾ç½®é€šé“çš„å…ƒç´ å¤§å°</span>
	c<span class="token punctuation">.</span>elemsize <span class="token operator">=</span> <span class="token function">uint16</span><span class="token punctuation">(</span>elem<span class="token punctuation">.</span>Size_<span class="token punctuation">)</span>
    <span class="token comment">// è®¾ç½®é€šé“çš„å…ƒç´ ç±»å‹</span>
	c<span class="token punctuation">.</span>elemtype <span class="token operator">=</span> elem
    <span class="token comment">// è®¾ç½®é€šé“çš„ç¼“å†²åŒºå¤§å°</span>
	c<span class="token punctuation">.</span>dataqsiz <span class="token operator">=</span> <span class="token function">uint</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span>
    <span class="token comment">// åˆå§‹åŒ–é€šé“çš„äº’æ–¥é”</span>
	<span class="token function">lockInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">,</span> lockRankHchan<span class="token punctuation">)</span>
	
    <span class="token comment">// å¦‚æœå¯ç”¨äº†é€šé“è°ƒè¯•æ¨¡å¼ï¼Œæ‰“å°è°ƒè¯•ä¿¡æ¯</span>
	<span class="token keyword">if</span> debugChan <span class="token punctuation">{<!-- --></span>
		<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"makechan: chan="</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token string">"; elemsize="</span><span class="token punctuation">,</span> elem<span class="token punctuation">.</span>Size_<span class="token punctuation">,</span> <span class="token string">"; dataqsiz="</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    
    <span class="token comment">// è¿”å›é€šé“æŒ‡é’ˆ</span>
	<span class="token keyword">return</span> c
<span class="token punctuation">}</span>
</code></pre>
    <p>
     å…·ä½“åˆ†é…å†…å­˜
     <code>
      mallocgc
     </code>
     å‡½æ•°åŸå‹å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">mallocgc</span><span class="token punctuation">(</span>size <span class="token builtin">uintptr</span><span class="token punctuation">,</span> typ <span class="token operator">*</span>_type<span class="token punctuation">,</span> needzero <span class="token builtin">bool</span><span class="token punctuation">)</span> unsafe<span class="token punctuation">.</span>Pointer <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <code>
       size
      </code>
      ï¼šåˆ†é…çš„å†…å­˜å¤§å°ã€‚
     </li>
     <li>
      <code>
       typ
      </code>
      ï¼šåˆ†é…å†…å­˜çš„ç±»å‹ä¿¡æ¯ã€‚
     </li>
     <li>
      <code>
       needzero
      </code>
      ï¼šæ˜¯å¦éœ€è¦å°†åˆ†é…çš„å†…å­˜æ¸…é›¶ã€‚
     </li>
    </ul>
    <blockquote>
     <p>
      æ›´å¤šå…³äº
      <code>
       mallocgc
      </code>
      å‡½æ•°çš„å†…å®¹æœ¬æ–‡ç« ä¸å†èµ˜è¿°ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦è¯·å…³æ³¨åç»­æ–‡ç« ã€Š
      <code>
       Golang
      </code>
      å†…å­˜æ¨¡å‹ã€‹ã€‚
     </p>
    </blockquote>
    <h4>
     <a id="_816">
     </a>
     å‘é€æ•°æ®
    </h4>
    <p>
     åœ¨
     <code>
      golang
     </code>
     çš„è¿è¡Œæ—¶ä¸­ï¼Œå‘é€æ“ä½œçš„ä»£ç ä¼šè¢«ç¼–è¯‘ä¸ºå¯¹
     <code>
      chansend1
     </code>
     çš„è°ƒç”¨ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ç¼–è¯‘æˆæ±‡ç¼–ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-assembly">0x001a 00026        CALL    runtime.makechan(SB)
# ...
0x0026 00038        CALL    runtime.chansend1(SB)
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šæ±‡ç¼–ä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <p>
     è€Œåœ¨
     <code>
      chansend1
     </code>
     çš„å‡½æ•°å†…éƒ¨ï¼Œåˆæ˜¯å¯¹
     <code>
      chansend
     </code>
     çš„è°ƒç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <blockquote>
     <p>
      æºç ä½ç½®ï¼šsrc/runtime/chan.go
     </p>
    </blockquote>
    <pre><code class="prism language-go"><span class="token comment">// entry point for c &lt;- x from compiled code.</span>
<span class="token comment">//</span>
<span class="token comment">//go:nosplit</span>
<span class="token keyword">func</span> <span class="token function">chansend1</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> elem unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">chansend</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="_852">
     </a>
     å‡½æ•°åŸå‹
    </h5>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">chansend</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> ep unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> block <span class="token builtin">bool</span><span class="token punctuation">,</span> callerpc <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <code>
       c *hchan
      </code>
      ï¼šæŒ‡å‘é€šé“çš„æŒ‡é’ˆã€‚
     </li>
     <li>
      <code>
       ep unsafe.Pointer
      </code>
      ï¼šæŒ‡å‘æ•°æ®çš„æŒ‡é’ˆã€‚
     </li>
     <li>
      <code>
       block bool
      </code>
      ï¼šæ˜¯å¦é˜»å¡å‘é€ã€‚
      <ul>
       <li>
        å¦‚æœ
        <code>
         block == true
        </code>
        ï¼Œå‘é€æ“ä½œä¼šåœ¨é€šé“ç¼“å†²åŒºæ»¡æˆ–æ²¡æœ‰æ¥æ”¶æ–¹æ—¶é˜»å¡ï¼Œç›´åˆ°å¯ä»¥å‘é€æ•°æ®ã€‚
       </li>
       <li>
        å¦‚æœ
        <code>
         block == false
        </code>
        ï¼Œå‘é€æ“ä½œæ˜¯éé˜»å¡çš„ã€‚å¦‚æœå½“å‰æ— æ³•å‘é€æ•°æ®ï¼ˆç¼“å†²åŒºæ»¡æˆ–æ²¡æœ‰æ¥æ”¶æ–¹ï¼‰ï¼Œå‡½æ•°ä¼šç«‹å³è¿”å›
        <code>
         false
        </code>
        ã€‚
       </li>
      </ul>
     </li>
     <li>
      <code>
       callerpc uintptr
      </code>
      ï¼šç¨‹åºè®¡æ•°å™¨ï¼ˆPCï¼‰çš„å€¼ï¼Œä¸»è¦ç”¨äºè°ƒè¯•å’Œç«æ€æ£€æµ‹ã€‚
     </li>
     <li>
      å‘é€æ“ä½œæ˜¯å¦æˆåŠŸã€‚
     </li>
    </ul>
    <h5>
     <a id="_868">
     </a>
     å‡½æ•°å†…å®¹
    </h5>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">chansend</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> ep unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> block <span class="token builtin">bool</span><span class="token punctuation">,</span> callerpc <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// æ£€æŸ¥é€šé“æŒ‡é’ˆ c æ˜¯å¦ä¸º nil</span>
	<span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token operator">!</span>block <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// å¦‚æœé€šé“ä¸º nil ä¸”æ˜¯éé˜»å¡å‘é€ï¼Œç›´æ¥è¿”å› false</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// å¦‚æœæ˜¯é˜»å¡å‘é€ï¼Œåˆ™åç¨‹ä¼šé˜»å¡å¹¶æŠ›å‡ºå¼‚å¸¸</span>
		<span class="token function">gopark</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> waitReasonChanSendNilChan<span class="token punctuation">,</span> traceBlockForever<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"unreachable"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

    <span class="token comment">// å¦‚æœå¯ç”¨äº†é€šé“è°ƒè¯•æ¨¡å¼ï¼Œæ‰“å°è°ƒè¯•ä¿¡æ¯</span>
	<span class="token keyword">if</span> debugChan <span class="token punctuation">{<!-- --></span>
		<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"chansend: chan="</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
    <span class="token comment">// å¦‚æœå¯ç”¨äº†ç«æ€æ£€æµ‹å™¨ï¼Œè®°å½•å¯¹é€šé“çš„è¯»æ“ä½œ</span>
	<span class="token keyword">if</span> raceenabled <span class="token punctuation">{<!-- --></span>
		<span class="token function">racereadpc</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">raceaddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callerpc<span class="token punctuation">,</span> abi<span class="token punctuation">.</span><span class="token function">FuncPCABIInternal</span><span class="token punctuation">(</span>chansend<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Fast path: check for failed non-blocking operation without acquiring the lock.</span>
	<span class="token comment">//</span>
	<span class="token comment">// After observing that the channel is not closed, we observe that the channel is</span>
	<span class="token comment">// not ready for sending. Each of these observations is a single word-sized read</span>
	<span class="token comment">// (first c.closed and second full()).</span>
	<span class="token comment">// Because a closed channel cannot transition from 'ready for sending' to</span>
	<span class="token comment">// 'not ready for sending', even if the channel is closed between the two observations,</span>
	<span class="token comment">// they imply a moment between the two when the channel was both not yet closed</span>
	<span class="token comment">// and not ready for sending. We behave as if we observed the channel at that moment,</span>
	<span class="token comment">// and report that the send cannot proceed.</span>
	<span class="token comment">//</span>
	<span class="token comment">// It is okay if the reads are reordered here: if we observe that the channel is not</span>
	<span class="token comment">// ready for sending and then observe that it is not closed, that implies that the</span>
	<span class="token comment">// channel wasn't closed during the first observation. However, nothing here</span>
	<span class="token comment">// guarantees forward progress. We rely on the side effects of lock release in</span>
	<span class="token comment">// chanrecv() and closechan() to update this thread's view of c.closed and full().</span>
    
    <span class="token comment">// å¦‚æœæ˜¯éé˜»å¡å‘é€å¹¶ä¸”é€šé“æœªå…³é—­ä½†ç¼“å†²åŒºå·²æ»¡ï¼Œç›´æ¥è¿”å› false</span>
    <span class="token comment">// å‰ç½®åˆ¤æ–­ï¼Œé¿å…è¿›å…¥é”çš„å¼€é”€</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>block <span class="token operator">&amp;&amp;</span> c<span class="token punctuation">.</span>closed <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">full</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	
    <span class="token comment">// å¦‚æœå¯ç”¨äº†é˜»å¡å‰–æï¼Œè®°å½•å½“å‰æ—¶é—´æˆ³</span>
	<span class="token keyword">var</span> t0 <span class="token builtin">int64</span>
	<span class="token keyword">if</span> blockprofilerate <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		t0 <span class="token operator">=</span> <span class="token function">cputicks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
    <span class="token comment">// é”å®šé€šé“çš„äº’æ–¥é”ï¼Œç¡®ä¿æ“ä½œçš„åŸå­æ€§</span>
	<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	
    <span class="token comment">// å¦‚æœé€šé“å·²å…³é—­ï¼Œè§£é”å¹¶æŠ›å‡ºå¼‚å¸¸</span>
    <span class="token comment">// é˜…è¯»åˆ°æ­¤å¤„æ—¶ï¼Œè€ƒè™‘æ˜¯å¦æ”¹ä¸ºä½¿ç”¨åŸå­æ“ä½œï¼Œä»£æ›¿ lock/unlockï¼Ÿ</span>
    <span class="token comment">// å¯ï¼Ÿä¸å¯ï¼Ÿ</span>
    <span class="token comment">// è®°å½•å§ï¼ï¼ï¼</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>closed <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token function">plainError</span><span class="token punctuation">(</span><span class="token string">"send on closed channel"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
    <span class="token comment">// å¦‚æœæœ‰ç­‰å¾…æ¥æ”¶çš„åç¨‹ï¼Œç›´æ¥å°†æ•°æ®å‘é€ç»™æ¥æ”¶åç¨‹ï¼Œè·³è¿‡ç¼“å†²åŒº</span>
	<span class="token keyword">if</span> sg <span class="token operator">:=</span> c<span class="token punctuation">.</span>recvq<span class="token punctuation">.</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> sg <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Found a waiting receiver. We pass the value we want to send</span>
		<span class="token comment">// directly to the receiver, bypassing the channel buffer (if any).</span>
        <span class="token comment">// è°ƒç”¨ send å‡½æ•°å®Œæˆæ•°æ®ä¼ é€’ï¼Œå¹¶è§£é”</span>
		<span class="token function">send</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> sg<span class="token punctuation">,</span> ep<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>

    <span class="token comment">// å¦‚æœæ²¡æœ‰ç­‰å¾…æ¥æ”¶çš„åç¨‹ï¼Œåˆ™åˆ¤æ–­ç¼“å†²åŒºæ˜¯å¦æœ‰ç©ºé—´</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>qcount <span class="token operator">&lt;</span> c<span class="token punctuation">.</span>dataqsiz <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Space is available in the channel buffer. Enqueue the element to send.</span>
        <span class="token comment">// è®¡ç®—ç¼“å†²åŒºä¸­ä¸‹ä¸€ä¸ªå†™å…¥ä½ç½®çš„æŒ‡é’ˆ</span>
		qp <span class="token operator">:=</span> <span class="token function">chanbuf</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>sendx<span class="token punctuation">)</span>
		<span class="token keyword">if</span> raceenabled <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// é€šçŸ¥ç«æ€æ£€æµ‹å™¨å½“å‰æ“ä½œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œå¯¹ç¼“å†²åŒºçš„å†™å…¥æ“ä½œè¢«æ­£ç¡®è·Ÿè¸ª</span>
			<span class="token function">racenotify</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>sendx<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
        
        <span class="token comment">// å°†è¦å‘é€çš„æ•°æ®ä» ep å¤åˆ¶åˆ°ç¼“å†²åŒºçš„ qp ä½ç½®</span>
		<span class="token function">typedmemmove</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> qp<span class="token punctuation">,</span> ep<span class="token punctuation">)</span>
        <span class="token comment">// æ›´æ–°å‘é€ç´¢å¼•ä¸ºä¸‹ä¸€ä¸ªå†™å…¥ä½ç½®</span>
		c<span class="token punctuation">.</span>sendx<span class="token operator">++</span>
        <span class="token comment">// å¦‚æœ c.sendx è¾¾åˆ°ç¼“å†²åŒºå¤§å°ï¼Œåˆ™å°†å…¶é‡ç½®ä¸º 0ï¼Œå®ç°ç¯å½¢ç¼“å†²åŒºçš„æ•ˆæœ</span>
		<span class="token keyword">if</span> c<span class="token punctuation">.</span>sendx <span class="token operator">==</span> c<span class="token punctuation">.</span>dataqsiz <span class="token punctuation">{<!-- --></span>
			c<span class="token punctuation">.</span>sendx <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// æ¯æ¬¡æˆåŠŸå†™å…¥æ•°æ®åï¼Œc.qcount å¢åŠ  1</span>
		c<span class="token punctuation">.</span>qcount<span class="token operator">++</span>
        <span class="token comment">// è§£é”é€šé“çš„äº’æ–¥é”</span>
		<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
        <span class="token comment">// å†™å…¥æˆåŠŸï¼Œè¿”å› true</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>
	
    <span class="token comment">// å¦‚æœç¼“å†²åŒºå·²æ»¡ä¸”æ˜¯éé˜»å¡å‘é€ï¼Œè§£é”å¹¶è¿”å› false</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>block <span class="token punctuation">{<!-- --></span>
		<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
    
    <span class="token comment">// ä¸‹é¢æ˜¯é˜»å¡å‘é€çš„ä»£ç é€»è¾‘</span>

	<span class="token comment">// Block on the channel. Some receiver will complete our operation for us.</span>
    <span class="token comment">// è·å–å½“å‰æ­£åœ¨è¿è¡Œçš„åç¨‹çš„æŒ‡é’ˆ</span>
	gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// åˆ†é…ä¸€ä¸ª sudog å¯¹è±¡ï¼Œsudog æ˜¯ golang è¿è¡Œæ—¶ä¸­ç”¨äºè¡¨ç¤ºåç¨‹åœ¨é€šé“æ“ä½œä¸­ç­‰å¾…çš„ç»“æ„ä½“</span>
	mysg <span class="token operator">:=</span> <span class="token function">acquireSudog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	mysg<span class="token punctuation">.</span>releasetime <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token keyword">if</span> t0 <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		mysg<span class="token punctuation">.</span>releasetime <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// No stack splits between assigning elem and enqueuing mysg</span>
	<span class="token comment">// on gp.waiting where copystack can find it.</span>
    <span class="token comment">// ä¸‹é¢è¿™äº›æ˜¯åˆå§‹åŒ– sudog å¯¹è±¡å±æ€§</span>
	mysg<span class="token punctuation">.</span>elem <span class="token operator">=</span> ep	<span class="token comment">// æŒ‡å‘è¦å‘é€çš„æ•°æ®æŒ‡é’ˆ</span>
	mysg<span class="token punctuation">.</span>waitlink <span class="token operator">=</span> <span class="token boolean">nil</span>
	mysg<span class="token punctuation">.</span>g <span class="token operator">=</span> gp	<span class="token comment">// æŒ‡å‘å½“å‰åç¨‹</span>
	mysg<span class="token punctuation">.</span>isSelect <span class="token operator">=</span> <span class="token boolean">false</span>	<span class="token comment">// æ ‡è®°æ˜¯å¦æ˜¯ select æ“ä½œ</span>
	mysg<span class="token punctuation">.</span>c <span class="token operator">=</span> c	<span class="token comment">// æŒ‡å‘å½“å‰é€šé“</span>
	gp<span class="token punctuation">.</span>waiting <span class="token operator">=</span> mysg	<span class="token comment">// å°†å½“å‰åç¨‹çš„ sudog å¯¹è±¡è®¾ç½®ä¸ºç­‰å¾…çŠ¶æ€</span>
	gp<span class="token punctuation">.</span>param <span class="token operator">=</span> <span class="token boolean">nil</span>
    
    <span class="token comment">// å°† sudog å¯¹è±¡åŠ å…¥é€šé“çš„å‘é€ç­‰å¾…é˜Ÿåˆ—</span>
	c<span class="token punctuation">.</span>sendq<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>mysg<span class="token punctuation">)</span>
	<span class="token comment">// Signal to anyone trying to shrink our stack that we're about</span>
	<span class="token comment">// to park on a channel. The window between when this G's status</span>
	<span class="token comment">// changes and when we set gp.activeStackChans is not safe for</span>
	<span class="token comment">// stack shrinking.</span>
    <span class="token comment">// æ ‡è®°å½“å‰åç¨‹å³å°†é˜»å¡åœ¨é€šé“æ“ä½œ</span>
	gp<span class="token punctuation">.</span>parkingOnChan<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">// é˜»å¡å½“å‰åç¨‹ï¼Œç›´åˆ°è¢«æ¥æ”¶æ“ä½œå”¤é†’</span>
	<span class="token function">gopark</span><span class="token punctuation">(</span>chanparkcommit<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">,</span> waitReasonChanSend<span class="token punctuation">,</span> traceBlockChanSend<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token comment">// Ensure the value being sent is kept alive until the</span>
	<span class="token comment">// receiver copies it out. The sudog has a pointer to the</span>
	<span class="token comment">// stack object, but sudogs aren't considered as roots of the</span>
	<span class="token comment">// stack tracer.</span>
    <span class="token comment">// ç¡®ä¿å‘é€çš„æ•°æ®åœ¨æ¥æ”¶åç¨‹æ‹·è´ä¹‹å‰ä¸ä¼šè¢«å›æ”¶ï¼Œå› ä¸º ep æŒ‡å‘çš„æ•°æ®æœ‰å¯èƒ½æ˜¯æ ˆä¸Šçš„æ•°æ®</span>
    <span class="token comment">// è€Œæ ˆä¸Šçš„æ•°æ®å¯èƒ½åœ¨åç¨‹é˜»å¡åè¢«å›æ”¶</span>
	<span class="token function">KeepAlive</span><span class="token punctuation">(</span>ep<span class="token punctuation">)</span>
    
    <span class="token comment">// ä¸‹é¢æ˜¯åç¨‹è¢«å”¤é†’åçš„å¤„ç†ä»£ç </span>

	<span class="token comment">// someone woke us up.</span>
	<span class="token keyword">if</span> mysg <span class="token operator">!=</span> gp<span class="token punctuation">.</span>waiting <span class="token punctuation">{<!-- --></span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"G waiting list is corrupted"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// æ¸…ç©ºåç¨‹çš„ç­‰å¾…çŠ¶æ€</span>
	gp<span class="token punctuation">.</span>waiting <span class="token operator">=</span> <span class="token boolean">nil</span>	
    <span class="token comment">// æ ‡è®°åç¨‹ä¸å†é˜»å¡åœ¨é€šé“æ“ä½œä¸Š</span>
	gp<span class="token punctuation">.</span>activeStackChans <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token comment">// å‘é€æ“ä½œæ˜¯å¦æˆåŠŸï¼Œmysg.success è¡¨ç¤º true æˆåŠŸï¼Œfalse å¤±è´¥</span>
	closed <span class="token operator">:=</span> <span class="token operator">!</span>mysg<span class="token punctuation">.</span>success
	gp<span class="token punctuation">.</span>param <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token keyword">if</span> mysg<span class="token punctuation">.</span>releasetime <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// è®°å½•åç¨‹é˜»å¡çš„æ—¶é—´</span>
		<span class="token function">blockevent</span><span class="token punctuation">(</span>mysg<span class="token punctuation">.</span>releasetime<span class="token operator">-</span>t0<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// æ¸…ç©º sudog å¯¹è±¡çš„é€šé“æŒ‡é’ˆ</span>
	mysg<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token function">releaseSudog</span><span class="token punctuation">(</span>mysg<span class="token punctuation">)</span>
	<span class="token keyword">if</span> closed <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// å¦‚æœé€šé“æœªå…³é—­ä½†åç¨‹è¢«å”¤é†’ï¼ŒæŠ›å‡ºå¼‚å¸¸</span>
		<span class="token keyword">if</span> c<span class="token punctuation">.</span>closed <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"chansend: spurious wakeup"</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// é€šé“åœ¨å‘é€æ“ä½œå®Œæˆå‰è¢«å…³é—­ï¼ŒæŠ¥é”™ ï¼ï¼ï¼</span>
        <span class="token comment">// è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¯´å‘ä¸€ä¸ªå·²ç»å…³é—­é€šé“å†™æ•°æ®ä¼šæŠ¥é”™ï¼ŒåŸå› å°±åœ¨è¿™é‡Œ</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token function">plainError</span><span class="token punctuation">(</span><span class="token string">"send on closed channel"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// å‘é€æ“ä½œæˆåŠŸå®Œæˆ</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      send
     </code>
     å‡½æ•°çš„ä½œç”¨æ˜¯å°†æ•°æ®ç›´æ¥å‘é€ç»™ç­‰å¾…æ¥æ”¶çš„åç¨‹ï¼Œå¹¶å”¤é†’ç­‰å¾…æ¥æ”¶çš„åç¨‹ã€‚
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">send</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> sg <span class="token operator">*</span>sudog<span class="token punctuation">,</span> ep unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> unlockf <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> skip <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ç«æ€æ£€æµ‹</span>
	<span class="token keyword">if</span> raceenabled <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// æ— ç¼“å†²é€šé“</span>
		<span class="token keyword">if</span> c<span class="token punctuation">.</span>dataqsiz <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// é€šçŸ¥ç«æ€æ£€æµ‹å™¨å½“å‰æ“ä½œçš„ä¸Šä¸‹æ–‡</span>
			<span class="token function">racesync</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> sg<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// æœ‰ç¼“å†²é€šé“</span>
			<span class="token comment">// Pretend we go through the buffer, even though</span>
			<span class="token comment">// we copy directly. Note that we need to increment</span>
			<span class="token comment">// the head/tail locations only when raceenabled.</span>
            <span class="token comment">// å³ä½¿æ•°æ®æ˜¯ç›´æ¥å‘é€çš„ï¼Œç«æ€æ£€æµ‹å™¨ä¹Ÿä¼šæ¨¡æ‹Ÿæ•°æ®é€šè¿‡ç¼“å†²åŒºçš„æµç¨‹</span>
			<span class="token comment">// è°ƒç”¨ racenotifyï¼Œè®°å½•æ¥æ”¶ç´¢å¼•ï¼ˆc.recvxï¼‰çš„å˜åŒ–ã€‚</span>
			<span class="token function">racenotify</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>recvx<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">racenotify</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>recvx<span class="token punctuation">,</span> sg<span class="token punctuation">)</span>
            <span class="token comment">// æ›´æ–°æ¥æ”¶ç´¢å¼• c.recvx å’Œå‘é€ç´¢å¼• c.sendxï¼Œæ¨¡æ‹Ÿç¯å½¢ç¼“å†²åŒºçš„è¡Œä¸º</span>
			c<span class="token punctuation">.</span>recvx<span class="token operator">++</span>
			<span class="token keyword">if</span> c<span class="token punctuation">.</span>recvx <span class="token operator">==</span> c<span class="token punctuation">.</span>dataqsiz <span class="token punctuation">{<!-- --></span>
				c<span class="token punctuation">.</span>recvx <span class="token operator">=</span> <span class="token number">0</span>
			<span class="token punctuation">}</span>
			c<span class="token punctuation">.</span>sendx <span class="token operator">=</span> c<span class="token punctuation">.</span>recvx <span class="token comment">// c.sendx = (c.sendx+1) % c.dataqsiz</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
    
    <span class="token comment">// å¦‚æœ sg.elem ä¸ä¸º nilï¼Œè°ƒç”¨ sendDirect å°†æ•°æ®ä»å‘é€æ–¹ ep ç›´æ¥å‘é€åˆ°æ¥æ”¶æ–¹ sg.elem</span>
	<span class="token keyword">if</span> sg<span class="token punctuation">.</span>elem <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">sendDirect</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> sg<span class="token punctuation">,</span> ep<span class="token punctuation">)</span>
        <span class="token comment">// æ¸…ç©º sg.elemï¼Œè¡¨ç¤ºæ•°æ®å·²å‘é€</span>
		sg<span class="token punctuation">.</span>elem <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// è·å–ç­‰å¾…æ¥æ”¶çš„åç¨‹</span>
	gp <span class="token operator">:=</span> sg<span class="token punctuation">.</span>g
    <span class="token comment">// è°ƒç”¨è§£é”å‡½æ•°ï¼Œé‡Šæ”¾é€šé“çš„é”</span>
	<span class="token function">unlockf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// å°† sudog å¯¹è±¡ä¼ é€’ç»™æ¥æ”¶åç¨‹ï¼Œç”¨äºåç»­å¤„ç†</span>
	gp<span class="token punctuation">.</span>param <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span>
    <span class="token comment">// æ ‡è®°å‘é€æ“ä½œæˆåŠŸ</span>
	sg<span class="token punctuation">.</span>success <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token keyword">if</span> sg<span class="token punctuation">.</span>releasetime <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		sg<span class="token punctuation">.</span>releasetime <span class="token operator">=</span> <span class="token function">cputicks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// å°† gp åç¨‹æ ‡è®°ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œå¹¶å°†å…¶åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œ</span>
	<span class="token function">goready</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> skip<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      sendDirect
     </code>
     å‡½æ•°çš„ä½œç”¨æ˜¯å°†æ•°æ®ç›´æ¥ä»å‘é€æ–¹çš„å†…å­˜ä½ç½®å‘é€åˆ°ç­‰å¾…æ¥æ”¶çš„åç¨‹
     <code>
      sudog
     </code>
     å¯¹è±¡ ã€‚
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">sendDirect</span><span class="token punctuation">(</span>t <span class="token operator">*</span>_type<span class="token punctuation">,</span> sg <span class="token operator">*</span>sudog<span class="token punctuation">,</span> src unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// src is on our stack, dst is a slot on another stack.</span>

	<span class="token comment">// Once we read sg.elem out of sg, it will no longer</span>
	<span class="token comment">// be updated if the destination's stack gets copied (shrunk).</span>
	<span class="token comment">// So make sure that no preemption points can happen between read &amp; use.</span>
    <span class="token comment">// è·å–æ¥æ”¶æ–¹çš„å†…å­˜ä½ç½®ï¼Œä»¥ä¾¿å°†æ•°æ®ç›´æ¥å‘é€åˆ°è¯¥ä½ç½®</span>
	dst <span class="token operator">:=</span> sg<span class="token punctuation">.</span>elem
    <span class="token comment">// è§¦å‘å†™å±éšœ</span>
    <span class="token comment">// ç¡®ä¿åƒåœ¾å›æ”¶å™¨èƒ½å¤Ÿæ­£ç¡®è¿½è¸ªç›®æ ‡å†…å­˜åŒºåŸŸä¸­çš„æŒ‡é’ˆ</span>
	<span class="token function">typeBitsBulkBarrier</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Size_<span class="token punctuation">)</span>
	<span class="token comment">// No need for cgo write barrier checks because dst is always</span>
	<span class="token comment">// Go memory.</span>
    <span class="token comment">// è¿™æ˜¯ä¸€ä¸ªåº•å±‚å‡½æ•°ï¼Œç”¨äºåœ¨å†…å­˜ä¸­å®‰å…¨åœ°ç§»åŠ¨æ•°æ®</span>
    <span class="token comment">// dst ç›®æ ‡åœ°å€ï¼Œsrc æºåœ°å€</span>
	<span class="token function">memmove</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> src<span class="token punctuation">,</span> t<span class="token punctuation">.</span>Size_<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      å…³äºæ›´å¤šå†…å­˜ç®¡ç†çš„çŸ¥è¯†ç‚¹ï¼Œè¯·å…³æ³¨åç»­æ–‡ç« ã€Š
      <code>
       Golang
      </code>
      å†…å­˜æ¨¡å‹ã€‹ã€‚
     </p>
    </blockquote>
    <h4>
     <a id="_1123">
     </a>
     æ¥æ”¶æ•°æ®
    </h4>
    <p>
     åœ¨
     <code>
      golang
     </code>
     çš„è¿è¡Œæ—¶ä¸­ï¼Œæ¥æ”¶æ•°æ®æ“ä½œçš„ä»£ç ä¼šè¢«ç¼–è¯‘ä¸ºå¯¹
     <code>
      chanrecv1
     </code>
     çš„è°ƒç”¨ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	ch <span class="token operator">&lt;-</span> <span class="token number">1</span>

	data <span class="token operator">:=</span> <span class="token operator">&lt;-</span>ch
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ç¼–è¯‘æˆæ±‡ç¼–ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-assembly">0x001a 00026        CALL    runtime.makechan(SB)
# ...
0x0043 00067        CALL    runtime.chanrecv1(SB)
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šæ±‡ç¼–ä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <p>
     è€Œåœ¨
     <code>
      chanrecv1
     </code>
     çš„å‡½æ•°å†…éƒ¨ï¼Œåˆæ˜¯å¯¹
     <code>
      chanrecv
     </code>
     çš„è°ƒç”¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <blockquote>
     <p>
      æºç ä½ç½®ï¼šsrc/runtime/chan.go
     </p>
    </blockquote>
    <pre><code class="prism language-go"><span class="token comment">// entry points for &lt;- c from compiled code.</span>
<span class="token comment">//</span>
<span class="token comment">//go:nosplit</span>
<span class="token keyword">func</span> <span class="token function">chanrecv1</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> elem unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token function">chanrecv</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> elem<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="_1164">
     </a>
     å‡½æ•°åŸå‹
    </h5>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">chanrecv</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> ep unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> block <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>selected<span class="token punctuation">,</span> received <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <code>
       c *hchan
      </code>
      ï¼šæŒ‡å‘ç›®æ ‡é€šé“çš„æŒ‡é’ˆã€‚
     </li>
     <li>
      <code>
       ep unsafe.Pointer
      </code>
      ï¼šæŒ‡å‘æ¥æ”¶æ•°æ®çš„å†…å­˜ä½ç½®ã€‚å¦‚æœä¸º
      <code>
       nil
      </code>
      ï¼Œè¡¨ç¤ºä»…æ£€æŸ¥é€šé“çŠ¶æ€è€Œä¸æ¥æ”¶æ•°æ®ã€‚
     </li>
     <li>
      <code>
       block bool
      </code>
      ï¼šæ˜¯å¦å…è®¸é˜»å¡æ¥æ”¶ã€‚å¦‚æœä¸º
      <code>
       false
      </code>
      ï¼Œåˆ™åœ¨æ— æ³•ç«‹å³æ¥æ”¶æ•°æ®æ—¶è¿”å›ã€‚
     </li>
     <li>
      <code>
       selected bool
      </code>
      ï¼šè¡¨ç¤ºæ˜¯å¦æˆåŠŸæ¥æ”¶æ•°æ®ã€‚åœ¨
      <code>
       select
      </code>
      è¯­å¥ä¸­ï¼Œç”¨äºæ ‡è®°æ˜¯å¦é€‰æ‹©äº†å½“å‰é€šé“ã€‚
     </li>
     <li>
      <code>
       received bool
      </code>
      ï¼šè¡¨ç¤ºæ˜¯å¦å®é™…æ¥æ”¶åˆ°æ•°æ®ã€‚å¦‚æœé€šé“å…³é—­ä¸”ç¼“å†²åŒºä¸ºç©ºï¼Œ
      <code>
       received
      </code>
      ä¸º
      <code>
       false
      </code>
      ã€‚
     </li>
    </ul>
    <h5>
     <a id="_1178">
     </a>
     å‡½æ•°å†…å®¹
    </h5>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">chanrecv</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> ep unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> block <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>selected<span class="token punctuation">,</span> received <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// raceenabled: don't need to check ep, as it is always on the stack</span>
	<span class="token comment">// or is new memory allocated by reflect.</span>
	<span class="token comment">// å¦‚æœå¯ç”¨äº†é€šé“è°ƒè¯•æ¨¡å¼ï¼Œæ‰“å°è°ƒè¯•ä¿¡æ¯</span>
	<span class="token keyword">if</span> debugChan <span class="token punctuation">{<!-- --></span>
		<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"chanrecv: chan="</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// å¦‚æœé€šé“ä¸º nil</span>
	<span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token operator">!</span>block <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// éé˜»å¡æ¥æ”¶ï¼Œç›´æ¥è¿”å›</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// å¦‚æœæ˜¯é˜»å¡æ¥æ”¶ï¼Œåç¨‹ä¼šé˜»å¡å¹¶æŠ›å‡ºå¼‚å¸¸</span>
		<span class="token function">gopark</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> waitReasonChanReceiveNilChan<span class="token punctuation">,</span> traceBlockForever<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"unreachable"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
    <span class="token comment">// å¦‚æœé€šé“å…³è”äº†ä¸€ä¸ªå®šæ—¶å™¨,åˆ™è°ƒç”¨ maybeRunChan æ¥å¤„ç†å®šæ—¶å™¨äº‹ä»¶</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>timer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		c<span class="token punctuation">.</span>timer<span class="token punctuation">.</span><span class="token function">maybeRunChan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
    <span class="token comment">// å¦‚æœæ˜¯éé˜»å¡æ¥æ”¶ä¸”é€šé“ä¸ºç©º</span>
	<span class="token comment">// Fast path: check for failed non-blocking operation without acquiring the lock.</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>block <span class="token operator">&amp;&amp;</span> <span class="token function">empty</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// After observing that the channel is not ready for receiving, we observe whether the</span>
		<span class="token comment">// channel is closed.</span>
		<span class="token comment">//</span>
		<span class="token comment">// Reordering of these checks could lead to incorrect behavior when racing with a close.</span>
		<span class="token comment">// For example, if the channel was open and not empty, was closed, and then drained,</span>
		<span class="token comment">// reordered reads could incorrectly indicate "open and empty". To prevent reordering,</span>
		<span class="token comment">// we use atomic loads for both checks, and rely on emptying and closing to happen in</span>
		<span class="token comment">// separate critical sections under the same lock.  This assumption fails when closing</span>
		<span class="token comment">// an unbuffered channel with a blocked send, but that is an error condition anyway.</span>
        <span class="token comment">// æ£€æŸ¥é€šé“æ˜¯å¦å…³é—­</span>
		<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>closed<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Because a channel cannot be reopened, the later observation of the channel</span>
			<span class="token comment">// being not closed implies that it was also not closed at the moment of the</span>
			<span class="token comment">// first observation. We behave as if we observed the channel at that moment</span>
			<span class="token comment">// and report that the receive cannot proceed.</span>
            <span class="token comment">// å¦‚æœé€šé“æœªå…³é—­ï¼Œç›´æ¥è¿”å›</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// The channel is irreversibly closed. Re-check whether the channel has any pending data</span>
		<span class="token comment">// to receive, which could have arrived between the empty and closed checks above.</span>
		<span class="token comment">// Sequential consistency is also required here, when racing with such a send.</span>
        <span class="token comment">// å¦‚æœé€šé“å·²å…³é—­å¹¶ä¸”ä¸ºéé˜»å¡å¹¶ä¸”ç¼“å†²åŒºä¸ºç©º</span>
		<span class="token keyword">if</span> <span class="token function">empty</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// The channel is irreversibly closed and empty.</span>
			<span class="token keyword">if</span> raceenabled <span class="token punctuation">{<!-- --></span>
				<span class="token function">raceacquire</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">raceaddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
            <span class="token comment">// ep ä¸æ˜¯ç©ºï¼Œåˆ™æ¸…ç©ºç›®æ ‡å†…å­˜ ep</span>
			<span class="token keyword">if</span> ep <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">typedmemclr</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> ep<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
            
            <span class="token comment">// è¿”å›æˆåŠŸæ¥æ”¶æ•°æ®(true)ï¼Œæœªå®é™…æ¥æ”¶åˆ°æ•°æ®(false)</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> t0 <span class="token builtin">int64</span>
	<span class="token keyword">if</span> blockprofilerate <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		t0 <span class="token operator">=</span> <span class="token function">cputicks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
    <span class="token comment">// é”å®šé€šé“çš„äº’æ–¥é”ï¼Œç¡®ä¿æ“ä½œçš„åŸå­æ€§</span>
	<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>

    <span class="token comment">// å¦‚æœé€šé“å·²å…³é—­</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>closed <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ç¼“å†²åŒºä¸ºç©º</span>
		<span class="token keyword">if</span> c<span class="token punctuation">.</span>qcount <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> raceenabled <span class="token punctuation">{<!-- --></span>
				<span class="token function">raceacquire</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">raceaddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
            <span class="token comment">// è¿™é‡Œæ˜¯é€šé“å·²ç»å…³é—­äº†ï¼Œè€Œä¸”ç¼“å†²åŒºå·²ç»ä¸ºç©º</span>
            <span class="token comment">// è€ƒè™‘æ˜¯å¦å¯ä»¥é‡‡ç”¨åŸå­æ“ä½œæ¥ä»£æ›¿è¿™é‡Œçš„ lock/unlock æ“ä½œçš„æ“ä½œï¼Ÿ</span>
            <span class="token comment">// ...</span>
            <span class="token comment">// å’Œé€šé“å…³é—­æ—¶ï¼Œå‘é€è€…çš„æ£€æµ‹åŒç†</span>
           	<span class="token comment">// è™½ç„¶ç†è®ºä¸Šå¯ä»¥é€šè¿‡åŸå­æ“ä½œæ¥é¿å…åŠ é”ï¼Œä½†åœ¨å®é™…å®ç°ä¸­ï¼Œé”çš„ä½¿ç”¨æ˜¯ä¸ºäº†ç¡®ä¿çº¿ç¨‹å®‰å…¨å’Œä¸€è‡´æ€§ï¼Œå¦å¤–ï¼Œè™½ç„¶åŸå­æ“ä½œé¿å…äº†é”çš„å¼€é”€ï¼Œä½†å®ƒä»¬ä»ç„¶æœ‰ä¸€å®šçš„æ€§èƒ½å¼€é”€</span>
            <span class="token comment">// å³ä½¿ä½¿ç”¨åŸå­æ“ä½œï¼Œä¹Ÿéœ€è¦ç¡®ä¿åœ¨æ£€æŸ¥ c.closed å’Œ c.qcount æ—¶ä¸ä¼šå‡ºç°ç«æ€æ¡ä»¶ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªåç¨‹åœ¨æ£€æŸ¥ c.closed åä¿®æ”¹äº† c.qcountï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸ä¸€è‡´çš„è¡Œä¸º</span>
            <span class="token comment">// è®°å½•å§ï¼ï¼ï¼</span>
         	<span class="token comment">// è§£é”</span>
			<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
            <span class="token comment">// æ¸…ç©ºç›®æ ‡å†…å­˜ ep</span>
			<span class="token keyword">if</span> ep <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">typedmemclr</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> ep<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
            <span class="token comment">// è¿”å›æˆåŠŸæ¥æ”¶æ•°æ®(true)ï¼Œæœªå®é™…æ¥æ”¶åˆ°æ•°æ®(false)</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// The channel has been closed, but the channel's buffer have data.</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// é€šé“æœªå…³é—­ï¼Œå¹¶ä¸”æœ‰ç­‰å¾…å‘é€çš„åç¨‹</span>
		<span class="token comment">// Just found waiting sender with not closed.</span>
		<span class="token keyword">if</span> sg <span class="token operator">:=</span> c<span class="token punctuation">.</span>sendq<span class="token punctuation">.</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> sg <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Found a waiting sender. If buffer is size 0, receive value</span>
			<span class="token comment">// directly from sender. Otherwise, receive from head of queue</span>
			<span class="token comment">// and add sender's value to the tail of the queue (both map to</span>
			<span class="token comment">// the same buffer slot because the queue is full).</span>
            <span class="token comment">// è°ƒç”¨ recv å‡½æ•°ç›´æ¥ä»å‘é€åç¨‹æ¥æ”¶æ•°æ®ï¼Œè·³è¿‡ç¼“å†²åŒº</span>
            <span class="token comment">// è§£é”é€šé“</span>
			<span class="token function">recv</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> sg<span class="token punctuation">,</span> ep<span class="token punctuation">,</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
            <span class="token comment">// è¿”å›æˆåŠŸæ¥æ”¶æ•°æ®(true)ï¼Œå®é™…æ¥æ”¶åˆ°æ•°æ®(true)</span>
			<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	
    <span class="token comment">// å¦‚æœç¼“å†²åŒºä¸­æœ‰æ•°æ®</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>qcount <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Receive directly from queue</span>
        <span class="token comment">// å¾—åˆ°ç¼“å†²åŒºåœ°å€</span>
		qp <span class="token operator">:=</span> <span class="token function">chanbuf</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>recvx<span class="token punctuation">)</span>
		<span class="token keyword">if</span> raceenabled <span class="token punctuation">{<!-- --></span>
			<span class="token function">racenotify</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>recvx<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// ä»ç¼“å†²åŒºä¸­è¯»å–æ•°æ®åˆ°ç›®æ ‡å†…å­˜</span>
		<span class="token keyword">if</span> ep <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">typedmemmove</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> ep<span class="token punctuation">,</span> qp<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// æ¸…ç©ºç¼“å†²åŒºä¸­çš„æ•°æ®</span>
		<span class="token function">typedmemclr</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> qp<span class="token punctuation">)</span>
        <span class="token comment">// æ›´æ–°æ¥æ”¶ç´¢å¼• c.recvx</span>
		c<span class="token punctuation">.</span>recvx<span class="token operator">++</span>
        <span class="token comment">// å¦‚æœæ¥æ”¶ç´¢å¼• == ç¼“å†²åŒºå¤§å°ï¼Œåˆ™ä» 0 é‡æ–°å¼€å§‹</span>
		<span class="token keyword">if</span> c<span class="token punctuation">.</span>recvx <span class="token operator">==</span> c<span class="token punctuation">.</span>dataqsiz <span class="token punctuation">{<!-- --></span>
			c<span class="token punctuation">.</span>recvx <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// æ›´æ–°ç¼“å†²åŒºè®¡æ•° c.qcount</span>
		c<span class="token punctuation">.</span>qcount<span class="token operator">--</span>
        <span class="token comment">// è§£é”</span>
		<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
        <span class="token comment">// è¿”å›æˆåŠŸæ¥æ”¶æ•°æ®(true)ï¼Œå®é™…æ¥æ”¶åˆ°æ•°æ®(true)</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>

    <span class="token comment">// å¦‚æœæ˜¯éé˜»å¡æ¥æ”¶ä¸”ç¼“å†²åŒºä¸ºç©ºï¼Œè§£é”é€šé“å¹¶è¿”å›æœªæˆåŠŸæ¥æ”¶æ•°æ®(false)ï¼Œæœªå®é™…æ¥æ”¶åˆ°æ•°æ®(false)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>block <span class="token punctuation">{<!-- --></span>
		<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
    
    <span class="token comment">// ä¸‹é¢æ˜¯è¿›è¡Œé˜»å¡æ¥æ”¶æ•°æ®ä»£ç é€»è¾‘</span>

	<span class="token comment">// no sender available: block on this channel.</span>
    <span class="token comment">// è·å–å½“å‰åç¨‹</span>
	gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// åˆ†é…ä¸€ä¸ª sudog å¯¹è±¡</span>
	mysg <span class="token operator">:=</span> <span class="token function">acquireSudog</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// ä¸‹é¢æ˜¯é’ˆå¯¹ mysg å¯¹è±¡å±æ€§çš„åˆå§‹åŒ–</span>
	mysg<span class="token punctuation">.</span>releasetime <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token keyword">if</span> t0 <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		mysg<span class="token punctuation">.</span>releasetime <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// No stack splits between assigning elem and enqueuing mysg</span>
	<span class="token comment">// on gp.waiting where copystack can find it.</span>
	mysg<span class="token punctuation">.</span>elem <span class="token operator">=</span> ep
	mysg<span class="token punctuation">.</span>waitlink <span class="token operator">=</span> <span class="token boolean">nil</span>
	gp<span class="token punctuation">.</span>waiting <span class="token operator">=</span> mysg

	mysg<span class="token punctuation">.</span>g <span class="token operator">=</span> gp
	mysg<span class="token punctuation">.</span>isSelect <span class="token operator">=</span> <span class="token boolean">false</span>
	mysg<span class="token punctuation">.</span>c <span class="token operator">=</span> c
	gp<span class="token punctuation">.</span>param <span class="token operator">=</span> <span class="token boolean">nil</span>
    <span class="token comment">// å°†åç¨‹åŠ å…¥æ¥æ”¶ç­‰å¾…é˜Ÿåˆ—</span>
	c<span class="token punctuation">.</span>recvq<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>mysg<span class="token punctuation">)</span>
    <span class="token comment">// å¦‚æœé€šé“å…³è”äº†å®šæ—¶å™¨ï¼Œè°ƒç”¨ blockTimerChan</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>timer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">blockTimerChan</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Signal to anyone trying to shrink our stack that we're about</span>
	<span class="token comment">// to park on a channel. The window between when this G's status</span>
	<span class="token comment">// changes and when we set gp.activeStackChans is not safe for</span>
	<span class="token comment">// stack shrinking.</span>
    <span class="token comment">// æ ‡è®°åç¨‹å³å°†é˜»å¡åœ¨é€šé“æ“ä½œä¸Š</span>
	gp<span class="token punctuation">.</span>parkingOnChan<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token comment">// è°ƒç”¨ gopark é˜»å¡å½“å‰åç¨‹ï¼Œç›´åˆ°è¢«å‘é€æ“ä½œå”¤é†’</span>
	<span class="token function">gopark</span><span class="token punctuation">(</span>chanparkcommit<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span><span class="token punctuation">,</span> waitReasonChanReceive<span class="token punctuation">,</span> traceBlockChanRecv<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>

    <span class="token comment">// ä¸‹é¢æ˜¯åç¨‹è¢«å”¤é†’ä¹‹åçš„æ“ä½œæµç¨‹</span>
    
	<span class="token comment">// someone woke us up</span>
    <span class="token comment">// æ£€æŸ¥åç¨‹æ˜¯å¦è¢«æ­£ç¡®å”¤é†’</span>
	<span class="token keyword">if</span> mysg <span class="token operator">!=</span> gp<span class="token punctuation">.</span>waiting <span class="token punctuation">{<!-- --></span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">"G waiting list is corrupted"</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// å¦‚æœé€šé“å…³è”äº†å®šæ—¶å™¨ï¼Œè°ƒç”¨ unblockTimerChan</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>timer <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">unblockTimerChan</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// æ¸…ç†åç¨‹çŠ¶æ€</span>
	gp<span class="token punctuation">.</span>waiting <span class="token operator">=</span> <span class="token boolean">nil</span>
	gp<span class="token punctuation">.</span>activeStackChans <span class="token operator">=</span> <span class="token boolean">false</span>
	<span class="token keyword">if</span> mysg<span class="token punctuation">.</span>releasetime <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">blockevent</span><span class="token punctuation">(</span>mysg<span class="token punctuation">.</span>releasetime<span class="token operator">-</span>t0<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// è·å–æ¥æ”¶æ“ä½œçš„ç»“æœ</span>
	success <span class="token operator">:=</span> mysg<span class="token punctuation">.</span>success
	gp<span class="token punctuation">.</span>param <span class="token operator">=</span> <span class="token boolean">nil</span>
    <span class="token comment">// é‡Šæ”¾ sudog å¯¹è±¡</span>
	mysg<span class="token punctuation">.</span>c <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token function">releaseSudog</span><span class="token punctuation">(</span>mysg<span class="token punctuation">)</span>
    <span class="token comment">// è¿”å›æ¥æ”¶æ“ä½œç»“æœ</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">,</span> success
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      recv
     </code>
     å‡½æ•°ç”¨äºä»é€šé“ä¸­è¯»å–æ•°æ®ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ç­‰å¾…æ¥æ”¶çš„åç¨‹ã€‚
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">recv</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">,</span> sg <span class="token operator">*</span>sudog<span class="token punctuation">,</span> ep unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">,</span> unlockf <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> skip <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// å¦‚æœé€šé“æ— ç¼“å†²åŒº</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>dataqsiz <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> raceenabled <span class="token punctuation">{<!-- --></span>
			<span class="token function">racesync</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> sg<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// å¹¶ä¸”ç›®æ ‡å†…å­˜ä½ç½®ä¸æ˜¯ nilï¼Œ åˆ™ç›´æ¥æ‹·è´åˆ°ç›®æ ‡ä½ç½®</span>
		<span class="token keyword">if</span> ep <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// copy data from sender</span>
			<span class="token function">recvDirect</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> sg<span class="token punctuation">,</span> ep<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// é€šé“æœ‰ç¼“å†²åŒº</span>
		<span class="token comment">// Queue is full. Take the item at the</span>
		<span class="token comment">// head of the queue. Make the sender enqueue</span>
		<span class="token comment">// its item at the tail of the queue. Since the</span>
		<span class="token comment">// queue is full, those are both the same slot.</span>
        <span class="token comment">// è®¡ç®—ç¼“å†²åŒºä¸­æ¥æ”¶ä½ç½®çš„æŒ‡é’ˆ</span>
		qp <span class="token operator">:=</span> <span class="token function">chanbuf</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>recvx<span class="token punctuation">)</span>
		<span class="token keyword">if</span> raceenabled <span class="token punctuation">{<!-- --></span>
			<span class="token function">racenotify</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>recvx<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
			<span class="token function">racenotify</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> c<span class="token punctuation">.</span>recvx<span class="token punctuation">,</span> sg<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// copy data from queue to receiver</span>
		<span class="token keyword">if</span> ep <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// å¦‚æœç›®æ ‡å†…å­˜ä½ç½®ä¸æ˜¯ nilï¼Œ å°†æ•°æ®ä»ç¼“å†²åŒºå¤åˆ¶åˆ°æ¥æ”¶æ–¹çš„å†…å­˜ä½ç½®</span>
			<span class="token function">typedmemmove</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> ep<span class="token punctuation">,</span> qp<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token comment">// copy data from sender to queue</span>
        <span class="token comment">// å°†å‘é€æ–¹çš„æ•°æ®å¤åˆ¶åˆ°ç¼“å†²åŒºçš„å°¾éƒ¨</span>
		<span class="token function">typedmemmove</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> qp<span class="token punctuation">,</span> sg<span class="token punctuation">.</span>elem<span class="token punctuation">)</span>
        <span class="token comment">// å¢åŠ æ¥æ”¶ç´¢å¼•å¹¶å¤„ç†ç¯å½¢ç¼“å†²åŒºçš„è¾¹ç•Œæ¡ä»¶</span>
		c<span class="token punctuation">.</span>recvx<span class="token operator">++</span>
		<span class="token keyword">if</span> c<span class="token punctuation">.</span>recvx <span class="token operator">==</span> c<span class="token punctuation">.</span>dataqsiz <span class="token punctuation">{<!-- --></span>
			c<span class="token punctuation">.</span>recvx <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// æ›´æ–°å‘é€ç´¢å¼•ï¼Œä½¿å…¶æŒ‡å‘ä¸‹ä¸€ä¸ªå¯ç”¨ä½ç½®</span>
		c<span class="token punctuation">.</span>sendx <span class="token operator">=</span> c<span class="token punctuation">.</span>recvx <span class="token comment">// c.sendx = (c.sendx+1) % c.dataqsiz</span>
	<span class="token punctuation">}</span>
    
    <span class="token comment">// æ¸…ç©º sudog å¯¹è±¡ä¸­çš„æ•°æ®æŒ‡é’ˆ</span>
	sg<span class="token punctuation">.</span>elem <span class="token operator">=</span> <span class="token boolean">nil</span>
    <span class="token comment">// è·å–å‘é€åç¨‹çš„æŒ‡é’ˆ</span>
	gp <span class="token operator">:=</span> sg<span class="token punctuation">.</span>g
    <span class="token comment">// è°ƒç”¨è§£é”å‡½æ•°ï¼Œé‡Šæ”¾é€šé“çš„é”</span>
	<span class="token function">unlockf</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	gp<span class="token punctuation">.</span>param <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span>
    <span class="token comment">// æ ‡è®°æ¥æ”¶æ“ä½œæˆåŠŸ</span>
	sg<span class="token punctuation">.</span>success <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token keyword">if</span> sg<span class="token punctuation">.</span>releasetime <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
		sg<span class="token punctuation">.</span>releasetime <span class="token operator">=</span> <span class="token function">cputicks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    <span class="token comment">// å°† gp åç¨‹æ ‡è®°ä¸ºå¯è¿è¡ŒçŠ¶æ€ï¼Œå¹¶å°†å…¶åŠ å…¥è°ƒåº¦é˜Ÿåˆ—ä¸­ç­‰å¾…æ‰§è¡Œ</span>
	<span class="token function">goready</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> skip<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      recvDirect
     </code>
     å‡½æ•°çš„ä½œç”¨æ˜¯ä»å‘é€æ–¹ç›´æ¥æ¥æ”¶æ•°æ®ï¼Œå¹¶å°†å…¶å¤åˆ¶åˆ°æ¥æ”¶æ–¹çš„ç›®æ ‡å†…å­˜ä½ç½®ã€‚
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">recvDirect</span><span class="token punctuation">(</span>t <span class="token operator">*</span>_type<span class="token punctuation">,</span> sg <span class="token operator">*</span>sudog<span class="token punctuation">,</span> dst unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// dst is on our stack or the heap, src is on another stack.</span>
	<span class="token comment">// The channel is locked, so src will not move during this</span>
	<span class="token comment">// operation.</span>
    <span class="token comment">// æŒ‡å‘å‘é€æ–¹çš„å†…å­˜ä½ç½®</span>
	src <span class="token operator">:=</span> sg<span class="token punctuation">.</span>elem
    <span class="token comment">// å†™å±éšœ</span>
    <span class="token comment">// ç¡®ä¿ç›®æ ‡å†…å­˜ä½ç½®ä¸­çš„æŒ‡é’ˆè¢«åƒåœ¾å›æ”¶å™¨æ­£ç¡®è¿½è¸ª</span>
	<span class="token function">typeBitsBulkBarrier</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>Size_<span class="token punctuation">)</span>
    <span class="token comment">// å°†æ•°æ®ä»å‘é€æ–¹çš„å†…å­˜ä½ç½®å¤åˆ¶åˆ°æ¥æ”¶æ–¹çš„å†…å­˜ä½ç½®</span>
	<span class="token function">memmove</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> src<span class="token punctuation">,</span> t<span class="token punctuation">.</span>Size_<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <blockquote>
     <p>
      å…³äºæ›´å¤šå†…å­˜ç®¡ç†çš„çŸ¥è¯†ç‚¹ï¼Œè¯·å…³æ³¨åç»­æ–‡ç« ã€Š
      <code>
       Golang
      </code>
      å†…å­˜æ¨¡å‹ã€‹ã€‚
     </p>
    </blockquote>
    <h4>
     <a id="_1471">
     </a>
     å…³é—­é€šé“
    </h4>
    <p>
     åœ¨
     <code>
      golang
     </code>
     çš„è¿è¡Œæ—¶ä¸­ï¼Œå…³é—­é€šé“æ“ä½œçš„ä»£ç ä¼šè¢«ç¼–è¯‘ä¸ºå¯¹
     <code>
      closechan
     </code>
     çš„è°ƒç”¨ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token string">"fmt"</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token function">close</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ç¼–è¯‘æˆæ±‡ç¼–ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š
    </p>
    <pre><code class="prism language-assembly">0x001a 00026        CALL    runtime.makechan(SB)
# ...
0x0020 00032        CALL    runtime.closechan(SB)
</code></pre>
    <blockquote>
     <p>
      ä»¥ä¸Šæ±‡ç¼–ä»£ç åªæ˜¯éƒ¨åˆ†æˆªå–ï¼Œè¯·æ³¨æ„ç”„åˆ«ã€‚
     </p>
    </blockquote>
    <h5>
     <a id="_1496">
     </a>
     å‡½æ•°åŸå‹
    </h5>
    <blockquote>
     <p>
      æºç ä½ç½®ï¼šsrc/runtime/chan.go
     </p>
    </blockquote>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">closechan</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <code>
       c *hchan
      </code>
      ï¼šæŒ‡å‘è¦å…³é—­çš„é€šé“çš„æŒ‡é’ˆã€‚
     </li>
    </ul>
    <h5>
     <a id="_1508">
     </a>
     å‡½æ•°å†…å®¹
    </h5>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token function">closechan</span><span class="token punctuation">(</span>c <span class="token operator">*</span>hchan<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// å¦‚æœé€šé“ä¸º nilï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸</span>
	<span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token function">plainError</span><span class="token punctuation">(</span><span class="token string">"close of nil channel"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	
    <span class="token comment">// é”å®šé€šé“çš„äº’æ–¥é”ï¼Œç¡®ä¿å…³é—­æ“ä½œçš„åŸå­æ€§</span>
	<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	<span class="token keyword">if</span> c<span class="token punctuation">.</span>closed <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// å¦‚æœé€šé“å·²ç»å…³é—­ï¼Œè§£é”ï¼ŒæŠ›å‡ºå¼‚å¸¸</span>
		<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token function">plainError</span><span class="token punctuation">(</span><span class="token string">"close of closed channel"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> raceenabled <span class="token punctuation">{<!-- --></span>
		callerpc <span class="token operator">:=</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">racewritepc</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">raceaddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> callerpc<span class="token punctuation">,</span> abi<span class="token punctuation">.</span><span class="token function">FuncPCABIInternal</span><span class="token punctuation">(</span>closechan<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token function">racerelease</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">raceaddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

    <span class="token comment">// å°†é€šé“çš„ closed æ ‡å¿—è®¾ç½®ä¸º 1ï¼Œè¡¨ç¤ºé€šé“å·²å…³é—­</span>
	c<span class="token punctuation">.</span>closed <span class="token operator">=</span> <span class="token number">1</span>
	
    <span class="token comment">// éœ€è¦è¢«å”¤é†’çš„åç¨‹é›†åˆ</span>
	<span class="token keyword">var</span> glist gList

	<span class="token comment">// release all readers</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// éå†é€šé“çš„æ¥æ”¶ç­‰å¾…é˜Ÿåˆ—ï¼Œé‡Šæ”¾æ‰€æœ‰ç­‰å¾…æ¥æ”¶çš„åç¨‹</span>
		sg <span class="token operator">:=</span> c<span class="token punctuation">.</span>recvq<span class="token punctuation">.</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> sg <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// å¦‚æœ sg.elem ä¸ä¸º nil</span>
		<span class="token keyword">if</span> sg<span class="token punctuation">.</span>elem <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// æ¸…ç©ºæ¥æ”¶æ–¹çš„å†…å­˜ä½ç½®</span>
			<span class="token function">typedmemclr</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>elemtype<span class="token punctuation">,</span> sg<span class="token punctuation">.</span>elem<span class="token punctuation">)</span>
			sg<span class="token punctuation">.</span>elem <span class="token operator">=</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> sg<span class="token punctuation">.</span>releasetime <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
			sg<span class="token punctuation">.</span>releasetime <span class="token operator">=</span> <span class="token function">cputicks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
        
        <span class="token comment">// è·å–åˆ°æ¥æ”¶è€…åç¨‹</span>
		gp <span class="token operator">:=</span> sg<span class="token punctuation">.</span>g
		gp<span class="token punctuation">.</span>param <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span>
        <span class="token comment">// æ ‡è®°è·å–æ“ä½œå¤±è´¥</span>
		sg<span class="token punctuation">.</span>success <span class="token operator">=</span> <span class="token boolean">false</span>
		<span class="token keyword">if</span> raceenabled <span class="token punctuation">{<!-- --></span>
			<span class="token function">raceacquireg</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">raceaddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// å°†åç¨‹åŠ å…¥åˆ° glist ä¸­ï¼Œç¨åå”¤é†’</span>
		glist<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// release all writers (they will panic)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// éå†é€šé“çš„å‘é€ç­‰å¾…é˜Ÿåˆ—ï¼Œé‡Šæ”¾æ‰€æœ‰ç­‰å¾…å‘é€çš„åç¨‹</span>
		sg <span class="token operator">:=</span> c<span class="token punctuation">.</span>sendq<span class="token punctuation">.</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> sg <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// æ¸…ç©º sg.elemï¼Œé¿å…å†…å­˜æ³„æ¼</span>
		sg<span class="token punctuation">.</span>elem <span class="token operator">=</span> <span class="token boolean">nil</span>
		<span class="token keyword">if</span> sg<span class="token punctuation">.</span>releasetime <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
			sg<span class="token punctuation">.</span>releasetime <span class="token operator">=</span> <span class="token function">cputicks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
        
        <span class="token comment">// è·å–åˆ°å‘é€è€…åç¨‹</span>
		gp <span class="token operator">:=</span> sg<span class="token punctuation">.</span>g
		gp<span class="token punctuation">.</span>param <span class="token operator">=</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>sg<span class="token punctuation">)</span>
        <span class="token comment">// æ ‡è®°å‘é€æ“ä½œå¤±è´¥</span>
		sg<span class="token punctuation">.</span>success <span class="token operator">=</span> <span class="token boolean">false</span>
		<span class="token keyword">if</span> raceenabled <span class="token punctuation">{<!-- --></span>
			<span class="token function">raceacquireg</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">raceaddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
        <span class="token comment">// å°†åç¨‹åŠ å…¥åˆ° glist ä¸­ï¼Œç¨åå”¤é†’</span>
		glist<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>gp<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
    
    <span class="token comment">// è§£é”é€šé“çš„äº’æ–¥é”</span>
	<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>

	<span class="token comment">// Ready all Gs now that we've dropped the channel lock.</span>
    <span class="token comment">// éå† glistï¼Œå”¤é†’æ‰€æœ‰ç­‰å¾…çš„åç¨‹</span>
	<span class="token keyword">for</span> <span class="token operator">!</span>glist<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		gp <span class="token operator">:=</span> glist<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		gp<span class="token punctuation">.</span>schedlink <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token comment">// è°ƒç”¨ goready å°†åç¨‹æ ‡è®°ä¸ºå¯è¿è¡ŒçŠ¶æ€</span>
		<span class="token function">goready</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     ğŸŒºğŸŒºğŸŒºæ’’èŠ±ï¼
    </p>
    <p>
     å¦‚æœæœ¬æ–‡å¯¹ä½ æœ‰å¸®åŠ©ï¼Œå°±ç‚¹å…³æ³¨æˆ–è€…ç•™ä¸ªğŸ‘
     <br/>
     å¦‚æœæ‚¨æœ‰ä»»ä½•æŠ€æœ¯é—®é¢˜æˆ–è€…éœ€è¦æ›´å¤šå…¶ä»–çš„å†…å®¹ï¼Œè¯·éšæ—¶å‘æˆ‘æé—®ã€‚
     <br/>
     <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/3734a0d4d24847a6ad83ea7ad3b1a2c6.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f34363238373931382f:61727469636c652f64657461696c732f313436313038363031" class_="artid" style="display:none">
 </p>
</div>


