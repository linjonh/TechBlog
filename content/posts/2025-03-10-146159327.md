---
layout: post
title: "初次体验Tauri和Sycamore3通道实现"
date: 2025-03-10 17:32:59 +0800
description: "本文源自系列文章第1篇《初次体验Tauri和Sycamore (1)》，从中抽取出来独立成文（但并无更新和修订），专注于探究Tauri通道的底层实现（实际上也没有足够底层）。理由：1.原文已经很长，需要精简；2.原文主体是初级技术内容，仅这一节相对深入，显得格格不入。（如无意外，这将是本系列文章的终结。）"
keywords: "初次体验Tauri和Sycamore（3）通道实现"
categories: ['Web', 'Rust', 'Liigo']
tags: ['Tauri', 'Sycamore', 'Rust', 'Javascript', 'Electron', 'Channel']
artid: "146159327"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146159327
    alt: "初次体验Tauri和Sycamore3通道实现"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146159327
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146159327
cover: https://bing.ee123.net/img/rand?artid=146159327
image: https://bing.ee123.net/img/rand?artid=146159327
img: https://bing.ee123.net/img/rand?artid=146159327
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     初次体验Tauri和Sycamore（3）通道实现
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     ​
     <br/>
     原创作者：庄晓立（LIIGO）
     <br/>
     原创时间：2025年03月10日（发布时间）
     <br/>
     原创链接：https://blog.csdn.net/liigo/article/details/146159327
     <br/>
     版权所有，转载请注明出处。
    </p>
    <p>
     <img alt="tauri-splash" src="https://i-blog.csdnimg.cn/direct/698bfdee51cf4f8887bb6c073bcd27b3.png#pic_center"/>
    </p>
    <hr/>
    <p>
     <strong>
      20250310 LIIGO备注
     </strong>
     ：本文源自系列文章第1篇《
     <a href="https://blog.csdn.net/liigo/article/details/143666827">
      初次体验Tauri和Sycamore (1)
     </a>
     》，从中抽取出来独立成文（但并无更新和修订），专注于探究Tauri通道的底层实现（实际上也没有足够底层）。理由：1.原文已经很长，需要精简；2.原文主体是初级技术内容，仅这一节相对深入，显得格格不入。（如无意外，这将是本系列文章的终结。）
    </p>
    <hr/>
    <p>
     <strong>
      20241118 LIIGO补记
     </strong>
     ：出于好奇，简单研究一下Tauri通道的底层实现。
    </p>
    <p>
     在JS层，创建Channel对象生成通道ID，并关联onmessage处理函数；在传输层，通过
     <code>
      invoke()
     </code>
     调用后端Command，传入Channel对象作为参数（实质上是传入通道ID）；在Rust层，根据通道ID构造后端Channel对象，向客户端指定的Channel发送Message。如何向通道发送Message是后续关注的重点。
    </p>
    <hr/>
    <p>
     JS层创建Channel的
     <a href="https://github.com/tauri-apps/tauri/blob/72feaf99fc8d162ba5babf0c402959b9686fba9e/packages/api/src/core.ts#L87">
      源码
     </a>
     如下：
    </p>
    <pre><code class="prism language-ts"><span class="token keyword">class</span> <span class="token class-name">Channel<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
  id<span class="token operator">:</span> <span class="token builtin">number</span>
  <span class="token comment">// @ts-expect-error field used by the IPC serializer</span>
  <span class="token keyword">private</span> <span class="token keyword">readonly</span> __TAURI_CHANNEL_MARKER__ <span class="token operator">=</span> <span class="token boolean">true</span>
  <span class="token function-variable function">#onmessage</span><span class="token operator">:</span> <span class="token punctuation">(</span>response<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function-variable function">void</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// no-op</span>
  <span class="token punctuation">}</span>
  #nextMessageId <span class="token operator">=</span> <span class="token number">0</span>
  #pendingMessages<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token function">transformCallback</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> message<span class="token punctuation">,</span> id <span class="token punctuation">}</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> message<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span> id<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// the id is used as a mechanism to preserve message order</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>#nextMessageId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>#nextMessageId <span class="token operator">=</span> id <span class="token operator">+</span> <span class="token number">1</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">#onmessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token comment">// 前端用户收到此message</span>
          <span class="token comment">// process pending messages</span>
          <span class="token comment">// ...</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>#pendingMessages<span class="token punctuation">[</span>id<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> message
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">transformCallback</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">unknown</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>callback<span class="token operator">?</span><span class="token operator">:</span> <span class="token punctuation">(</span>response<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">,</span> once <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> window<span class="token punctuation">.</span>__TAURI_INTERNALS__<span class="token punctuation">.</span><span class="token function">transformCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> once<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     JS层Channel构造函数内部，调用
     <a href="https://github.com/tauri-apps/tauri/blob/b37c208d616a8ecef4a8e032113a3ba1d8536136/crates/tauri/scripts/core.js#L22">
      <code>
       transformCallback
      </code>
     </a>
     为一个回调函数生成唯一ID（它基于
     <code>
      Crypto.getRandomValues()
     </code>
     的实现能保证ID唯一吗我存疑），并将二者关联至window对象：
     <code>
      window['_回调ID'] = ({message, id})=&gt;{ /*...*/};
     </code>
     。此处生成的ID也称为通道ID，将被invoke函数传递给Rust层（参见上文前端调用Command）。后端数据通过通道到达前端后，可通过通道ID反查并调用该回调函数接收后端数据。注意区分通道ID、消息ID和后文的数据ID。
    </p>
    <hr/>
    <p>
     Rust层通过
     <a href="https://github.com/tauri-apps/tauri/blob/72feaf99fc8d162ba5babf0c402959b9686fba9e/crates/tauri/src/ipc/channel.rs#L98">
      <code>
       JavaScriptChannelId::channel_on
      </code>
     </a>
     和
     <a href="https://github.com/tauri-apps/tauri/blob/72feaf99fc8d162ba5babf0c402959b9686fba9e/crates/tauri/src/ipc/channel.rs#L152">
      <code>
       Channel::new_with_id
      </code>
     </a>
     构造Channel对象实例。
    </p>
    <pre><code class="prism language-rust"><span class="token keyword">impl</span> <span class="token class-name">JavaScriptChannelId</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/// Gets a [`Channel`] for this channel ID on the given [`Webview`].</span>
  <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">channel_on</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token punctuation">:</span> <span class="token class-name">Runtime</span><span class="token punctuation">,</span> <span class="token class-name">TSend</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> webview<span class="token punctuation">:</span> <span class="token class-name">Webview</span><span class="token operator">&lt;</span><span class="token class-name">R</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Channel</span><span class="token operator">&lt;</span><span class="token class-name">TSend</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">let</span> callback_id <span class="token operator">=</span> <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> counter <span class="token operator">=</span> <span class="token class-name">AtomicUsize</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">Channel</span><span class="token punctuation">::</span><span class="token function">new_with_id</span><span class="token punctuation">(</span>callback_id<span class="token number">.0</span><span class="token punctuation">,</span> <span class="token keyword">move</span> <span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>body<span class="token closure-punctuation punctuation">|</span></span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">let</span> i <span class="token operator">=</span> counter<span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>interceptor<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>webview<span class="token punctuation">.</span>manager<span class="token punctuation">.</span>channel_interceptor <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token function">interceptor</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>webview<span class="token punctuation">,</span> callback_id<span class="token punctuation">,</span> i<span class="token punctuation">,</span> <span class="token operator">&amp;</span>body<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">let</span> data_id <span class="token operator">=</span> <span class="token constant">CHANNEL_DATA_COUNTER</span><span class="token punctuation">.</span><span class="token function">fetch_add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Ordering</span><span class="token punctuation">::</span><span class="token class-name">Relaxed</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      webview
        <span class="token punctuation">.</span><span class="token function">state</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">ChannelDataIpcQueue</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token number">0</span>
        <span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>data_id<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>

      webview<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token macro property">format!</span><span class="token punctuation">(</span>
        <span class="token string">"window.__TAURI_INTERNALS__.invoke('{FETCH_CHANNEL_DATA_COMMAND}', null, {<!-- -->{ headers: {<!-- -->{ '{CHANNEL_ID_HEADER_NAME}': '{data_id}' }} }}).then((response) =&gt; window['_' + {}]({<!-- -->{ message: response, id: {i} }})).catch(console.error)"</span><span class="token punctuation">,</span>
        callback_id<span class="token number">.0</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

      <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      Channel::new_with_id
     </code>
     有两个参数，一个是通道ID（或称callback_id），一个是向前端发送数据的on_message函数。这个on_message的命名有误导性，让人以为是接收函数，但看
     <a href="https://hiany.deno.dev/tauri-apps/tauri/blob/72feaf99fc8d162ba5babf0c402959b9686fba9e/crates/tauri/src/ipc/channel.rs#L199" rel="nofollow">
      <code>
       Channel::send()
      </code>
     </a>
     函数源码可以确认on_message是发送函数。
    </p>
    <pre><code class="prism language-rust"><span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">TSend</span><span class="token operator">&gt;</span> <span class="token class-name">Channel</span><span class="token operator">&lt;</span><span class="token class-name">TSend</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">fn</span> <span class="token function-definition function">new_with_id</span><span class="token operator">&lt;</span><span class="token class-name">F</span><span class="token punctuation">:</span> <span class="token class-name">Fn</span><span class="token punctuation">(</span><span class="token class-name">InvokeResponseBody</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token operator">+</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token class-name">Sync</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    id<span class="token punctuation">:</span> <span class="token keyword">u32</span><span class="token punctuation">,</span>
    on_message<span class="token punctuation">:</span> <span class="token class-name">F</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">Self</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/// Sends the given data through the channel.</span>
  <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token class-name">TSend</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;</span> <span class="token keyword">where</span> <span class="token class-name">TSend</span><span class="token punctuation">:</span> <span class="token class-name">IpcResponse</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">(</span><span class="token keyword">self</span><span class="token punctuation">.</span>on_message<span class="token punctuation">)</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     Rust层Channel发送数据的实现代码就在上面
     <code>
      JavaScriptChannelId::channel_on(webview)
     </code>
     函数内部，即
     <code>
      new_with_id()
     </code>
     的on_message参数闭包函数内，它主要干了如下几件事：
    </p>
    <ul>
     <li>
      生成数据ID(data_id)：
      <code>
       let data_id = CHANNEL_DATA_COUNTER.fetch_add(1, Ordering::Relaxed);
      </code>
     </li>
     <li>
      将要数据存入发送缓存队列并关联data_id：
      <code>
       webview.state::&lt;ChannelDataIpcQueue&gt;()...insert(data_id, body)
      </code>
     </li>
     <li>
      生成JS代码并提交给前端执行（分两步）：
      <code>
       webview.eval(JSCODE)
      </code>
      <ul>
       <li>
        fetch:
        <code>
         invoke('plugin:__TAURI_CHANNEL__|fetch', null, ...data_id...)
        </code>
       </li>
       <li>
        callback:
        <code>
         window['_通道ID']({ message: response, id: {i} })
        </code>
        (调用JS端回调函数,
        <code>
         {i}
        </code>
        为此通道内消息ID，即序号)
       </li>
      </ul>
     </li>
    </ul>
    <p>
     再看一下
     <a href="https://github.com/tauri-apps/tauri/blob/72feaf99fc8d162ba5babf0c402959b9686fba9e/crates/tauri/src/ipc/channel.rs#L226">
      <code>
       fetch
      </code>
     </a>
     源码（上文
     <code>
      invoke('plugin:__TAURI_CHANNEL__|fetch', ...)
     </code>
     将调用此后端Command）：
    </p>
    <pre><code class="prism language-rust"><span class="token attribute attr-name">#[command(root = <span class="token string">"crate"</span>)]</span>
<span class="token keyword">fn</span> <span class="token function-definition function">fetch</span><span class="token punctuation">(</span>
  request<span class="token punctuation">:</span> <span class="token class-name">Request</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  cache<span class="token punctuation">:</span> <span class="token class-name">State</span><span class="token operator">&lt;</span><span class="token lifetime-annotation symbol">'_</span><span class="token punctuation">,</span> <span class="token class-name">ChannelDataIpcQueue</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Response</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token operator">=</span> request
    <span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token constant">CHANNEL_ID_HEADER_NAME</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">and_then</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>v<span class="token closure-punctuation punctuation">|</span></span> v<span class="token punctuation">.</span><span class="token function">to_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">and_then</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>id<span class="token closure-punctuation punctuation">|</span></span> id<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token operator">=</span> cache<span class="token number">.0</span><span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Response</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token string">"data not found"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token string">"missing channel id header"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      fetch
     </code>
     命令的作用是从发送缓存队列中取出与参数data_id关联的数据返回给前端，同时从发送缓存队列中移除。fetch执行后，通过通道发送的数据就从后端到了前端。注意时序，是后端主动提交JS代码让前端执行，前端才被动发起fetch调用，Tauri正是通过这种方式实现后端向前端“推送”数据。数据被推送至前端后，可能还要经历缓存阶段才提交给Channel用户，确保用户有序接收。
    </p>
    <hr/>
    <p>
     调用链：（JS层）创建Channel，发起调用后端某Command（传入通道ID），（Rust层）把通道ID反序列化为Channel，将待发送数据缓存，调度前端执行JS代码（
     <code>
      webview.eval()
     </code>
     ），（JS层）通过
     <code>
      fetch
     </code>
     Command拉取后端缓存数据，处理乱序数据接收，执行用户层onmessage回调，完成单次数据传输。
    </p>
    <p>
     我原来猜测通道Channel是Command之外另一种更高效的数据传输方案，但事实证明我错了。通过上述源码分析可知，Channel实际上是基于Command实现的更高层的逻辑抽象。Tauri通道发送数据，本质上还是调用Command，只是经过封装之后更适合“后端推送流式数据”应用场景。相比使用普通无通道Command传输数据，其区别在于工作模式：无通道传输，是前端单次主动拉取；有通道传输，是后端多次主动推送，且保证有序送达。
    </p>
    <p>
     ​
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="687474:70733a2f2f626c6f672e6373646e2e6e65742f6c6969676f2f:61727469636c652f64657461696c732f313436313539333237" class_="artid" style="display:none">
 </p>
</div>


