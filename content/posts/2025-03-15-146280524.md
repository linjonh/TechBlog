---
layout: post
title: "Linuxä¸‹å…±äº«å†…å­˜-å’Œ-å‘½åç®¡é“-çš„ä½¿ç”¨"
date: 2025-03-15 16:35:21 +0800
description: "Linuxä¸‹å…±äº«å†…å­˜ å’Œ å‘½åç®¡é“ çš„ä½¿ç”¨"
keywords: "Linuxä¸‹å…±äº«å†…å­˜ å’Œ å‘½åç®¡é“ çš„ä½¿ç”¨"
categories: ['Linux']
tags: ['ç®—æ³•', 'æœåŠ¡å™¨', 'Linux', 'C']
artid: "146280524"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146280524
    alt: "Linuxä¸‹å…±äº«å†…å­˜-å’Œ-å‘½åç®¡é“-çš„ä½¿ç”¨"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146280524
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146280524
cover: https://bing.ee123.net/img/rand?artid=146280524
image: https://bing.ee123.net/img/rand?artid=146280524
img: https://bing.ee123.net/img/rand?artid=146280524
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Linuxä¸‹å…±äº«å†…å­˜ å’Œ å‘½åç®¡é“ çš„ä½¿ç”¨
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <br/>
    <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/392d6b52781c4a35b77b6cc45b572d1f.png">
     <p>
     </p>
     <h2>
      <a id="Linux__3">
      </a>
      Linuxå…±äº«å†…å­˜ï¼šå®Œæ•´ä»£ç å±•ç¤ºä¸å‰–æ ğŸš€
     </h2>
     <p>
      å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰æ˜¯Linuxç³»ç»Ÿä¸­ä¸€ç§é«˜æ•ˆçš„è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æœºåˆ¶ï¼Œå…è®¸å¤šä¸ªè¿›ç¨‹å…±äº«åŒä¸€å—ç‰©ç†å†…å­˜åŒºåŸŸï¼Œä»è€Œå®ç°å¿«é€Ÿçš„æ•°æ®äº¤æ¢ã€‚æœ¬æ–‡å°†æä¾›å®Œæ•´çš„C++ä»£ç ç¤ºä¾‹ï¼ŒåŒ…æ‹¬å¤´æ–‡ä»¶ã€å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å®ç°ï¼Œè¯¦ç»†å±•ç¤ºå…±äº«å†…å­˜çš„åˆ›å»ºã€ä½¿ç”¨ã€åŒæ­¥åŠç®¡ç†è¿‡ç¨‹ã€‚âœ¨
     </p>
     <hr/>
     <h3>
      <a id="__9">
      </a>
      å…±äº«å†…å­˜ï¼šåŸç†ã€æ¥å£ä¸åº”ç”¨å®è·µ ğŸ”
     </h3>
     <h4>
      <a id="__11">
      </a>
      å¼•è¨€ ğŸŒŸ
     </h4>
     <p>
      å…±äº«å†…å­˜æ˜¯Linuxç³»ç»Ÿè¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰ä¸­æœ€å¿«çš„ä¸€ç§æ–¹å¼ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯è®©å¤šä¸ªè¿›ç¨‹é€šè¿‡æ˜ å°„åŒä¸€å—ç‰©ç†å†…å­˜æ¥å®ç°æ•°æ®å…±äº«ã€‚
     </p>
     <hr/>
     <h4>
      <a id="__17">
      </a>
      ä¸€ã€å…±äº«å†…å­˜æ ¸å¿ƒåŸç† âš™ï¸
     </h4>
     <h5>
      <a id="11___19">
      </a>
      1.1 å…±äº«å†…å­˜çš„ç‰¹ç‚¹ ğŸ“Œ
     </h5>
     <ul>
      <li>
       <strong>
        é›¶æ‹·è´
       </strong>
       ï¼šæ•°æ®ç›´æ¥æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œæ— éœ€å†…æ ¸ä¸­è½¬ ğŸš«ğŸ“¦
      </li>
      <li>
       <strong>
        é«˜æ•ˆæ€§
       </strong>
       ï¼šé€‚åˆä¼ è¾“å¤§å—æ•°æ®ï¼ˆå¦‚è§†é¢‘æµã€å¤§å‹çŸ©é˜µï¼‰ ğŸ’¨
      </li>
      <li>
       <strong>
        æ— åŒæ­¥æœºåˆ¶
       </strong>
       ï¼šéœ€ç»“åˆå…¶ä»–IPCï¼ˆå¦‚ä¿¡å·é‡ã€ç®¡é“ï¼‰å®ç°åŒæ­¥ ğŸ”„
      </li>
     </ul>
     <h5>
      <a id="12___24">
      </a>
      1.2 ç”Ÿå‘½å‘¨æœŸç®¡ç† â³
     </h5>
     <ul>
      <li>
       <strong>
        éšå†…æ ¸æŒç»­
       </strong>
       ï¼šå³ä½¿è¿›ç¨‹é€€å‡ºï¼Œå…±äº«å†…å­˜ä»å­˜åœ¨ ğŸ’¾
      </li>
      <li>
       <strong>
        ä¸»åŠ¨é‡Šæ”¾
       </strong>
       ï¼šéœ€è°ƒç”¨
       <code>
        shmctl
       </code>
       æˆ–ä½¿ç”¨
       <code>
        ipcrm
       </code>
       å‘½ä»¤åˆ é™¤ ğŸ—‘ï¸
      </li>
     </ul>
     <hr/>
     <h4>
      <a id="__30">
      </a>
      äºŒã€å…³é”®ç³»ç»Ÿæ¥å£è§£æ ğŸ”§
     </h4>
     <h5>
      <a id="21_Key__32">
      </a>
      2.1 ç”Ÿæˆå”¯ä¸€æ ‡è¯†Key ğŸ”‘
     </h5>
     <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
key_t <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> proj_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
     <ul>
      <li>
       <strong>
        å‚æ•°
       </strong>
       ï¼š
       <ul>
        <li>
         <code>
          pathname
         </code>
         ï¼šå·²å­˜åœ¨çš„æ–‡ä»¶è·¯å¾„ï¼ˆå¦‚
         <code>
          /home/user/config
         </code>
         ğŸ“ï¼‰
        </li>
        <li>
         <code>
          proj_id
         </code>
         ï¼šé¡¹ç›®IDï¼ˆ0-255ï¼‰ ğŸ”¢
        </li>
       </ul>
      </li>
      <li>
       <strong>
        è¿”å›å€¼
       </strong>
       ï¼šå”¯ä¸€Keyï¼Œç”¨äºåç»­æ“ä½œ ğŸ¯
      </li>
     </ul>
     <h5>
      <a id="22___43">
      </a>
      2.2 åˆ›å»º/è·å–å…±äº«å†…å­˜ ğŸ› ï¸
     </h5>
     <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">shmget</span><span class="token punctuation">(</span>key_t key<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
     <ul>
      <li>
       <strong>
        æ ‡å¿—ä½
       </strong>
       ï¼š
       <ul>
        <li>
         <code>
          IPC_CREAT
         </code>
         ï¼šä¸å­˜åœ¨åˆ™åˆ›å»º ğŸ†•
        </li>
        <li>
         <code>
          IPC_EXCL
         </code>
         ï¼šé…åˆ
         <code>
          IPC_CREAT
         </code>
         ä½¿ç”¨ï¼Œå­˜åœ¨åˆ™æŠ¥é”™ âŒ
        </li>
        <li>
         æƒé™ä½ï¼ˆå¦‚
         <code>
          0666
         </code>
         ğŸ”’ï¼‰
        </li>
       </ul>
      </li>
     </ul>
     <h5>
      <a id="23___53">
      </a>
      2.3 å†…å­˜æŒ‚æ¥ä¸å»å…³è” ğŸ”—
     </h5>
     <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">shmat</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>shmaddr<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">shmdt</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>shmaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
     <ul>
      <li>
       <strong>
        æŒ‚æ¥ç­–ç•¥
       </strong>
       ï¼š
       <ul>
        <li>
         <code>
          shmaddr
         </code>
         è®¾ä¸º
         <code>
          NULL
         </code>
         ç”±ç³»ç»Ÿé€‰æ‹©åœ°å€ ğŸ¯
        </li>
        <li>
         <code>
          SHM_RDONLY
         </code>
         ä»¥åªè¯»æ–¹å¼æŒ‚æ¥ ğŸ“–
        </li>
       </ul>
      </li>
     </ul>
     <h5>
      <a id="24___63">
      </a>
      2.4 æ§åˆ¶æ“ä½œ ğŸ®
     </h5>
     <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">shmctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
     <ul>
      <li>
       <strong>
        æ§åˆ¶å‘½ä»¤
       </strong>
       ï¼š
       <ul>
        <li>
         <code>
          IPC_STAT
         </code>
         ï¼šè·å–çŠ¶æ€ä¿¡æ¯ ğŸ“Š
        </li>
        <li>
         <code>
          IPC_RMID
         </code>
         ï¼šæ ‡è®°åˆ é™¤ ğŸ—‘ï¸
        </li>
       </ul>
      </li>
     </ul>
     <hr/>
     <h3>
      <a id="__74">
      </a>
      å®Œæ•´ä»£ç å±•ç¤º ğŸ’»
     </h3>
     <p>
      ä»¥ä¸‹æ˜¯å®ç°å…±äº«å†…å­˜é€šä¿¡çš„å®Œæ•´ä»£ç ï¼Œåˆ†ä¸ºä¸‰ä¸ªæ–‡ä»¶ï¼š
      <code>
       common.hpp
      </code>
      ï¼ˆå…¬ç”¨å¤´æ–‡ä»¶ï¼‰ã€
      <code>
       client.cc
      </code>
      ï¼ˆå®¢æˆ·ç«¯ï¼‰å’Œ
      <code>
       server.cc
      </code>
      ï¼ˆæœåŠ¡ç«¯ï¼‰ã€‚
     </p>
     <h4>
      <a id="1__commonhpp__78">
      </a>
      1. å…¬ç”¨å¤´æ–‡ä»¶
      <code>
       common.hpp
      </code>
      ğŸ“œ
     </h4>
     <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__COMMON_HPP__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__COMMON_HPP__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">const</span> string pathname <span class="token operator">=</span> <span class="token string">"/home"</span><span class="token punctuation">;</span> <span class="token comment">// ftokä½¿ç”¨çš„è·¯å¾„å ğŸ </span>
<span class="token keyword">const</span> <span class="token keyword">int</span> proj_id <span class="token operator">=</span> <span class="token number">0x666</span><span class="token punctuation">;</span>       <span class="token comment">// ftokçš„é¡¹ç›®ID ğŸ†”</span>
<span class="token keyword">const</span> string FIFO_FILE <span class="token operator">=</span> <span class="token string">"./myfifo"</span><span class="token punctuation">;</span> <span class="token comment">// å‘½åç®¡é“æ–‡ä»¶è·¯å¾„ ğŸš‡</span>
<span class="token keyword">const</span> mode_t MODE <span class="token operator">=</span> <span class="token number">0664</span><span class="token punctuation">;</span>        <span class="token comment">// å‘½åç®¡é“æƒé™ ğŸ”’</span>

<span class="token keyword">enum</span> <span class="token class-name">Mistake</span>
<span class="token punctuation">{<!-- --></span>
    FTOK_ERROR <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    SHMGET_ERROR<span class="token punctuation">,</span>
    SHMAT_ERROR<span class="token punctuation">,</span>
    FIFO_CREATE_ERR<span class="token punctuation">,</span>
    FIFO_DELETE_ERR
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// ç”Ÿæˆå”¯ä¸€çš„key_té”®å€¼ ğŸ”‘</span>
key_t <span class="token function">GetKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    key_t key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span>pathname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proj_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
       <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ftok error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">exit</span><span class="token punctuation">(</span>FTOK_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> key<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// å…±äº«å†…å­˜è¾…åŠ©å‡½æ•° ğŸ› ï¸</span>
<span class="token keyword">int</span> <span class="token function">GetShareMemHelper</span><span class="token punctuation">(</span><span class="token keyword">int</span> flag<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    key_t key <span class="token operator">=</span> <span class="token function">GetKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// åˆ›å»ºæˆ–è·å–4096å­—èŠ‚çš„å…±äº«å†…å­˜ ğŸ’¾</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shmid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
       <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"shmget error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">exit</span><span class="token punctuation">(</span>SHMGET_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> shmid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// åˆ›å»ºå…±äº«å†…å­˜ ğŸ†•</span>
<span class="token keyword">int</span> <span class="token function">CreateShm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">GetShareMemHelper</span><span class="token punctuation">(</span>IPC_CREAT <span class="token operator">|</span> IPC_EXCL <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// è·å–å…±äº«å†…å­˜ ğŸ”</span>
<span class="token keyword">int</span> <span class="token function">GetShm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">GetShareMemHelper</span><span class="token punctuation">(</span>IPC_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// åˆå§‹åŒ–ç±»ï¼šåˆ›å»ºå’Œé”€æ¯å‘½åç®¡é“ ğŸš§</span>
<span class="token keyword">class</span> <span class="token class-name">Init</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span>FIFO_FILE<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EEXIST<span class="token punctuation">)</span> <span class="token comment">// å¦‚æœç®¡é“å·²å­˜åœ¨åˆ™å¿½ç•¥é”™è¯¯ âš ï¸</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkfifo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>FIFO_CREATE_ERR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token function">unlink</span><span class="token punctuation">(</span>FIFO_FILE<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"unlink"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>FIFO_DELETE_ERR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre>
     <hr/>
     <h4>
      <a id="2__clientcc__176">
      </a>
      2. å®¢æˆ·ç«¯ä»£ç 
      <code>
       client.cc
      </code>
      ğŸ‘¨ğŸ’»
     </h4>
     <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"common.hpp"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token comment">// è·å–å…±äº«å†…å­˜ ğŸ’¾</span>
    <span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">GetShm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>shmaddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shmaddr <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"shmat error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>SHMAT_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ‰“å¼€å‘½åç®¡é“å¹¶å‘é€ä¿¡å· ğŸ“¤</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>FIFO_FILE<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Please Enter :"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token comment">// ä»æ ‡å‡†è¾“å…¥è¯»å–æ•°æ®å¹¶å†™å…¥å…±äº«å†…å­˜ âŒ¨ï¸</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">fgets</span><span class="token punctuation">(</span>shmaddr<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// é€šçŸ¥æœåŠ¡ç«¯æ•°æ®å·²å†™å…¥ ğŸ“¨</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆ†ç¦»å…±äº«å†…å­˜ ğŸ”—</span>
    <span class="token function">shmdt</span><span class="token punctuation">(</span>shmaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
     <hr/>
     <h4>
      <a id="3__servercc__219">
      </a>
      3. æœåŠ¡ç«¯ä»£ç 
      <code>
       server.cc
      </code>
      ğŸ‘©ğŸ’»
     </h4>
     <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"common.hpp"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// åˆ›å»ºå‘½åç®¡é“ ğŸš‡</span>
    Init init<span class="token punctuation">;</span>

    <span class="token comment">// åˆ›å»ºå…±äº«å†…å­˜ ğŸ†•</span>
    <span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">CreateShm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>shmaddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shmaddr <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"shmat error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>SHMAT_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ‰“å¼€å‘½åç®¡é“ï¼Œç­‰å¾…å®¢æˆ·ç«¯ä¿¡å· ğŸ“­</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>FIFO_FILE<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"server start sucess"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> c<span class="token punctuation">;</span>
        ssize_t s <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// è¯»å–ä¿¡å· ğŸ“¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// å½“så°äº0è¯´æ˜å†™ç«¯å…³é—­è·³å‡ºå¾ªç¯å…³é—­å…±äº«å†…å­˜</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"client say@ "</span> <span class="token operator">&lt;&lt;</span> shmaddr<span class="token punctuation">;</span> <span class="token comment">// è¾“å‡ºå…±äº«å†…å­˜å†…å®¹ ğŸ’¬                                                       // è·å–å…±äº«å†…å­˜çŠ¶æ€ ğŸ“Š</span>
            <span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> shmds<span class="token punctuation">;</span>
            <span class="token function">shmctl</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> IPC_STAT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shmds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"shm size: "</span> <span class="token operator">&lt;&lt;</span> shmds<span class="token punctuation">.</span>shm_segsz <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"shm nattch: "</span> <span class="token operator">&lt;&lt;</span> shmds<span class="token punctuation">.</span>shm_nattch <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"shm __key: 0x%x\n"</span><span class="token punctuation">,</span> shmds<span class="token punctuation">.</span>shm_perm<span class="token punctuation">.</span>__key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"shm shm_perm.mode: "</span> <span class="token operator">&lt;&lt;</span> shmds<span class="token punctuation">.</span>shm_perm<span class="token punctuation">.</span>mode <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"---------------------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// åˆ†ç¦»å¹¶åˆ é™¤å…±äº«å†…å­˜ ğŸ—‘ï¸</span>
    <span class="token function">shmdt</span><span class="token punctuation">(</span>shmaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">shmctl</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
     <hr/>
     <h3>
      <a id="__278">
      </a>
      ç¼–è¯‘ä¸è¿è¡Œ ğŸš€
     </h3>
     <h4>
      <a id="__280">
      </a>
      ç¼–è¯‘å‘½ä»¤ ğŸ”§
     </h4>
     <pre><code class="prism language-bash">g++ <span class="token parameter variable">-o</span> client client.cc
g++ <span class="token parameter variable">-o</span> server server.cc
</code></pre>
     <h4>
      <a id="__287">
      </a>
      è¿è¡Œæ­¥éª¤ â–¶ï¸
     </h4>
     <ol>
      <li>
       <p>
        <strong>
         åœ¨ä¸€ä¸ªç»ˆç«¯è¿è¡ŒæœåŠ¡ç«¯
        </strong>
        ï¼š
       </p>
       <pre><code class="prism language-bash">./server
</code></pre>
      </li>
      <li>
       <p>
        <strong>
         åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œå®¢æˆ·ç«¯
        </strong>
        ï¼š
       </p>
       <pre><code class="prism language-bash">./client
</code></pre>
      </li>
      <li>
       <p>
        <strong>
         åœ¨å®¢æˆ·ç«¯ç»ˆç«¯è¾“å…¥æ¶ˆæ¯
        </strong>
        ï¼ˆä¾‹å¦‚
        <code>
         "Hello, shared memory!"
        </code>
        ï¼‰å¹¶æŒ‰å›è½¦ â†µ
       </p>
      </li>
     </ol>
     <p>
      <img alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°" src="https://i-blog.csdnimg.cn/direct/90c647f79a664fb5812b406cfaf7ff7d.png"/>
     </p>
     <hr/>
     <h3>
      <a id="__306">
      </a>
      ä»£ç å·¥ä½œåŸç† ğŸ§ 
     </h3>
     <ol>
      <li>
       <p>
        <strong>
         å…±äº«å†…å­˜åˆ›å»ºä¸é™„åŠ 
        </strong>
        ğŸ”—
       </p>
       <ul>
        <li>
         æœåŠ¡ç«¯ä½¿ç”¨
         <code>
          shmget
         </code>
         åˆ›å»ºå…±äº«å†…å­˜ï¼Œå®¢æˆ·ç«¯é€šè¿‡ç›¸åŒçš„é”®å€¼è·å–ã€‚
        </li>
        <li>
         <code>
          shmat
         </code>
         å°†å…±äº«å†…å­˜æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œè¿”å›æŒ‡é’ˆä¾›ç›´æ¥æ“ä½œã€‚
        </li>
       </ul>
      </li>
      <li>
       <p>
        <strong>
         æ•°æ®é€šä¿¡
        </strong>
        ğŸ“¡
       </p>
       <ul>
        <li>
         å®¢æˆ·ç«¯å°†è¾“å…¥å†™å…¥å…±äº«å†…å­˜ï¼ŒæœåŠ¡ç«¯ç›´æ¥è¯»å–è¯¥å†…å­˜åŒºåŸŸçš„å†…å®¹ã€‚
        </li>
       </ul>
      </li>
      <li>
       <p>
        <strong>
         åŒæ­¥æœºåˆ¶
        </strong>
        âš¡
       </p>
       <ul>
        <li>
         ä½¿ç”¨å‘½åç®¡é“ï¼ˆFIFOï¼‰å®ç°åŒæ­¥ï¼Œå®¢æˆ·ç«¯å†™å…¥æ•°æ®åé€šè¿‡ç®¡é“å‘é€ä¿¡å·ï¼ŒæœåŠ¡ç«¯æ¥æ”¶ä¿¡å·åè¯»å–æ•°æ®ã€‚
        </li>
       </ul>
      </li>
      <li>
       <p>
        <strong>
         èµ„æºç®¡ç†
        </strong>
        ğŸ› ï¸
       </p>
       <ul>
        <li>
         æœåŠ¡ç«¯åœ¨ç»“æŸæ—¶ä½¿ç”¨
         <code>
          shmctl(IPC_RMID)
         </code>
         åˆ é™¤å…±äº«å†…å­˜ï¼Œ
         <code>
          Init
         </code>
         ç±»çš„ææ„å‡½æ•°æ¸…ç†å‘½åç®¡é“ã€‚
        </li>
       </ul>
      </li>
     </ol>
     <hr/>
    </img>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34363533383938352f:61727469636c652f64657461696c732f313436323830353234" class_="artid" style="display:none">
 </p>
</div>


