---
arturl_encode: "68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34363533383938352f:61727469636c652f64657461696c732f313436323830353234"
layout: post
title: "Linuxä¸‹å…±äº«å†…å­˜-å’Œ-å‘½åç®¡é“-çš„ä½¿ç”¨"
date: 2025-03-15 16:35:21 +08:00
description: "Linuxä¸‹å…±äº«å†…å­˜ å’Œ å‘½åç®¡é“ çš„ä½¿ç”¨"
keywords: "Linuxä¸‹å…±äº«å†…å­˜ å’Œ å‘½åç®¡é“ çš„ä½¿ç”¨"
categories: ['Linux']
tags: ['ç®—æ³•', 'æœåŠ¡å™¨', 'Linux', 'C']
artid: "146280524"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146280524
    alt: "Linuxä¸‹å…±äº«å†…å­˜-å’Œ-å‘½åç®¡é“-çš„ä½¿ç”¨"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146280524
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146280524
cover: https://bing.ee123.net/img/rand?artid=146280524
image: https://bing.ee123.net/img/rand?artid=146280524
img: https://bing.ee123.net/img/rand?artid=146280524
---

# Linuxä¸‹å…±äº«å†…å­˜ å’Œ å‘½åç®¡é“ çš„ä½¿ç”¨

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/392d6b52781c4a35b77b6cc45b572d1f.png)

## Linuxå…±äº«å†…å­˜ï¼šå®Œæ•´ä»£ç å±•ç¤ºä¸å‰–æ ğŸš€

å…±äº«å†…å­˜ï¼ˆShared Memoryï¼‰æ˜¯Linuxç³»ç»Ÿä¸­ä¸€ç§é«˜æ•ˆçš„è¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰æœºåˆ¶ï¼Œå…è®¸å¤šä¸ªè¿›ç¨‹å…±äº«åŒä¸€å—ç‰©ç†å†…å­˜åŒºåŸŸï¼Œä»è€Œå®ç°å¿«é€Ÿçš„æ•°æ®äº¤æ¢ã€‚æœ¬æ–‡å°†æä¾›å®Œæ•´çš„C++ä»£ç ç¤ºä¾‹ï¼ŒåŒ…æ‹¬å¤´æ–‡ä»¶ã€å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å®ç°ï¼Œè¯¦ç»†å±•ç¤ºå…±äº«å†…å­˜çš„åˆ›å»ºã€ä½¿ç”¨ã€åŒæ­¥åŠç®¡ç†è¿‡ç¨‹ã€‚âœ¨

---

### å…±äº«å†…å­˜ï¼šåŸç†ã€æ¥å£ä¸åº”ç”¨å®è·µ ğŸ”

#### å¼•è¨€ ğŸŒŸ

å…±äº«å†…å­˜æ˜¯Linuxç³»ç»Ÿè¿›ç¨‹é—´é€šä¿¡ï¼ˆIPCï¼‰ä¸­æœ€å¿«çš„ä¸€ç§æ–¹å¼ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯è®©å¤šä¸ªè¿›ç¨‹é€šè¿‡æ˜ å°„åŒä¸€å—ç‰©ç†å†…å­˜æ¥å®ç°æ•°æ®å…±äº«ã€‚

---

#### ä¸€ã€å…±äº«å†…å­˜æ ¸å¿ƒåŸç† âš™ï¸

##### 1.1 å…±äº«å†…å­˜çš„ç‰¹ç‚¹ ğŸ“Œ

* **é›¶æ‹·è´**
  ï¼šæ•°æ®ç›´æ¥æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œæ— éœ€å†…æ ¸ä¸­è½¬ ğŸš«ğŸ“¦
* **é«˜æ•ˆæ€§**
  ï¼šé€‚åˆä¼ è¾“å¤§å—æ•°æ®ï¼ˆå¦‚è§†é¢‘æµã€å¤§å‹çŸ©é˜µï¼‰ ğŸ’¨
* **æ— åŒæ­¥æœºåˆ¶**
  ï¼šéœ€ç»“åˆå…¶ä»–IPCï¼ˆå¦‚ä¿¡å·é‡ã€ç®¡é“ï¼‰å®ç°åŒæ­¥ ğŸ”„

##### 1.2 ç”Ÿå‘½å‘¨æœŸç®¡ç† â³

* **éšå†…æ ¸æŒç»­**
  ï¼šå³ä½¿è¿›ç¨‹é€€å‡ºï¼Œå…±äº«å†…å­˜ä»å­˜åœ¨ ğŸ’¾
* **ä¸»åŠ¨é‡Šæ”¾**
  ï¼šéœ€è°ƒç”¨
  `shmctl`
  æˆ–ä½¿ç”¨
  `ipcrm`
  å‘½ä»¤åˆ é™¤ ğŸ—‘ï¸

---

#### äºŒã€å…³é”®ç³»ç»Ÿæ¥å£è§£æ ğŸ”§

##### 2.1 ç”Ÿæˆå”¯ä¸€æ ‡è¯†Key ğŸ”‘

```cpp
#include <sys/ipc.h>
key_t ftok(const char *pathname, int proj_id);

```

* **å‚æ•°**
  ï¼š
  + `pathname`
    ï¼šå·²å­˜åœ¨çš„æ–‡ä»¶è·¯å¾„ï¼ˆå¦‚
    `/home/user/config`
    ğŸ“ï¼‰
  + `proj_id`
    ï¼šé¡¹ç›®IDï¼ˆ0-255ï¼‰ ğŸ”¢
* **è¿”å›å€¼**
  ï¼šå”¯ä¸€Keyï¼Œç”¨äºåç»­æ“ä½œ ğŸ¯

##### 2.2 åˆ›å»º/è·å–å…±äº«å†…å­˜ ğŸ› ï¸

```cpp
int shmget(key_t key, size_t size, int shmflg);

```

* **æ ‡å¿—ä½**
  ï¼š
  + `IPC_CREAT`
    ï¼šä¸å­˜åœ¨åˆ™åˆ›å»º ğŸ†•
  + `IPC_EXCL`
    ï¼šé…åˆ
    `IPC_CREAT`
    ä½¿ç”¨ï¼Œå­˜åœ¨åˆ™æŠ¥é”™ âŒ
  + æƒé™ä½ï¼ˆå¦‚
    `0666`
    ğŸ”’ï¼‰

##### 2.3 å†…å­˜æŒ‚æ¥ä¸å»å…³è” ğŸ”—

```cpp
void *shmat(int shmid, const void *shmaddr, int shmflg);
int shmdt(const void *shmaddr);

```

* **æŒ‚æ¥ç­–ç•¥**
  ï¼š
  + `shmaddr`
    è®¾ä¸º
    `NULL`
    ç”±ç³»ç»Ÿé€‰æ‹©åœ°å€ ğŸ¯
  + `SHM_RDONLY`
    ä»¥åªè¯»æ–¹å¼æŒ‚æ¥ ğŸ“–

##### 2.4 æ§åˆ¶æ“ä½œ ğŸ®

```cpp
int shmctl(int shmid, int cmd, struct shmid_ds *buf);

```

* **æ§åˆ¶å‘½ä»¤**
  ï¼š
  + `IPC_STAT`
    ï¼šè·å–çŠ¶æ€ä¿¡æ¯ ğŸ“Š
  + `IPC_RMID`
    ï¼šæ ‡è®°åˆ é™¤ ğŸ—‘ï¸

---

### å®Œæ•´ä»£ç å±•ç¤º ğŸ’»

ä»¥ä¸‹æ˜¯å®ç°å…±äº«å†…å­˜é€šä¿¡çš„å®Œæ•´ä»£ç ï¼Œåˆ†ä¸ºä¸‰ä¸ªæ–‡ä»¶ï¼š
`common.hpp`
ï¼ˆå…¬ç”¨å¤´æ–‡ä»¶ï¼‰ã€
`client.cc`
ï¼ˆå®¢æˆ·ç«¯ï¼‰å’Œ
`server.cc`
ï¼ˆæœåŠ¡ç«¯ï¼‰ã€‚

#### 1. å…¬ç”¨å¤´æ–‡ä»¶ `common.hpp` ğŸ“œ

```cpp
#ifndef __COMMON_HPP__
#define __COMMON_HPP__

#include <iostream>
#include <string>
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <unistd.h>

using namespace std;

const string pathname = "/home"; // ftokä½¿ç”¨çš„è·¯å¾„å ğŸ 
const int proj_id = 0x666;       // ftokçš„é¡¹ç›®ID ğŸ†”
const string FIFO_FILE = "./myfifo"; // å‘½åç®¡é“æ–‡ä»¶è·¯å¾„ ğŸš‡
const mode_t MODE = 0664;        // å‘½åç®¡é“æƒé™ ğŸ”’

enum Mistake
{
    FTOK_ERROR = 1,
    SHMGET_ERROR,
    SHMAT_ERROR,
    FIFO_CREATE_ERR,
    FIFO_DELETE_ERR
};

// ç”Ÿæˆå”¯ä¸€çš„key_té”®å€¼ ğŸ”‘
key_t GetKey()
{
    key_t key = ftok(pathname.c_str(), proj_id);
    if (key < 0)
    {
       perror("ftok error");
       exit(FTOK_ERROR);
    }
    return key;
}

// å…±äº«å†…å­˜è¾…åŠ©å‡½æ•° ğŸ› ï¸
int GetShareMemHelper(int flag)
{
    key_t key = GetKey();
    int shmid = shmget(key, 4096, flag); // åˆ›å»ºæˆ–è·å–4096å­—èŠ‚çš„å…±äº«å†…å­˜ ğŸ’¾
    if (shmid < 0)
    {
       perror("shmget error");
       exit(SHMGET_ERROR);
    }
    return shmid;
}

// åˆ›å»ºå…±äº«å†…å­˜ ğŸ†•
int CreateShm()
{
    return GetShareMemHelper(IPC_CREAT | IPC_EXCL | 0666);
}

// è·å–å…±äº«å†…å­˜ ğŸ”
int GetShm()
{
    return GetShareMemHelper(IPC_CREAT);
}

// åˆå§‹åŒ–ç±»ï¼šåˆ›å»ºå’Œé”€æ¯å‘½åç®¡é“ ğŸš§
class Init
{
public:
    Init()
    {
        int n = mkfifo(FIFO_FILE.c_str(), MODE);
        if (n == -1 && errno != EEXIST) // å¦‚æœç®¡é“å·²å­˜åœ¨åˆ™å¿½ç•¥é”™è¯¯ âš ï¸
        {
            perror("mkfifo");
            exit(FIFO_CREATE_ERR);
        }
    }
    ~Init()
    {
        int m = unlink(FIFO_FILE.c_str());
        if (m == -1)
        {
            perror("unlink");
            exit(FIFO_DELETE_ERR);
        }
    }
};

#endif


```

---

#### 2. å®¢æˆ·ç«¯ä»£ç  `client.cc` ğŸ‘¨ğŸ’»

```cpp
#include "common.hpp"

int main()
{

    // è·å–å…±äº«å†…å­˜ ğŸ’¾
    int shmid = GetShm();
    char *shmaddr = (char *)shmat(shmid, nullptr, 0);
    if (shmaddr == (char *)-1)
    {
        perror("shmat error");
        exit(SHMAT_ERROR);
    }

    // æ‰“å¼€å‘½åç®¡é“å¹¶å‘é€ä¿¡å· ğŸ“¤
    int fd = open(FIFO_FILE.c_str(), O_WRONLY);
    if (fd < 0)
    {
        perror("open");
        exit(1);
    }

    cout << "Please Enter :" << endl;
    // ä»æ ‡å‡†è¾“å…¥è¯»å–æ•°æ®å¹¶å†™å…¥å…±äº«å†…å­˜ âŒ¨ï¸
    while (true)
    {
        fgets(shmaddr, 4096, stdin);
        write(fd, "c", 1); // é€šçŸ¥æœåŠ¡ç«¯æ•°æ®å·²å†™å…¥ ğŸ“¨
    }

    // åˆ†ç¦»å…±äº«å†…å­˜ ğŸ”—
    shmdt(shmaddr);
    close(fd);

    return 0;
}

```

---

#### 3. æœåŠ¡ç«¯ä»£ç  `server.cc` ğŸ‘©ğŸ’»

```cpp
#include "common.hpp"

int main()
{
    // åˆ›å»ºå‘½åç®¡é“ ğŸš‡
    Init init;

    // åˆ›å»ºå…±äº«å†…å­˜ ğŸ†•
    int shmid = CreateShm();
    char *shmaddr = (char *)shmat(shmid, nullptr, 0);
    if (shmaddr == (char *)-1)
    {
        perror("shmat error");
        exit(SHMAT_ERROR);
    }

    // æ‰“å¼€å‘½åç®¡é“ï¼Œç­‰å¾…å®¢æˆ·ç«¯ä¿¡å· ğŸ“­
    int fd = open(FIFO_FILE.c_str(), O_RDONLY);
    if (fd < 0)
    {
        perror("open");
        exit(1);
    }

    std::cout << "server start sucess" << endl;
    
    while (true)
    {
        char c;
        ssize_t s = read(fd, &c, 1); // è¯»å–ä¿¡å· ğŸ“¨
        if (s <= 0)
            break; // å½“så°äº0è¯´æ˜å†™ç«¯å…³é—­è·³å‡ºå¾ªç¯å…³é—­å…±äº«å†…å­˜
        else if (s > 0)
        {
            cout << "client say@ " << shmaddr; // è¾“å‡ºå…±äº«å†…å­˜å†…å®¹ ğŸ’¬                                                       // è·å–å…±äº«å†…å­˜çŠ¶æ€ ğŸ“Š
            struct shmid_ds shmds;
            shmctl(shmid, IPC_STAT, &shmds);
            cout << "shm size: " << shmds.shm_segsz << endl;
            cout << "shm nattch: " << shmds.shm_nattch << endl;
            printf("shm __key: 0x%x\n", shmds.shm_perm.__key);
            cout << "shm shm_perm.mode: " << shmds.shm_perm.mode << endl;
            cout << "---------------------" << endl;
        }
    }

    // åˆ†ç¦»å¹¶åˆ é™¤å…±äº«å†…å­˜ ğŸ—‘ï¸
    shmdt(shmaddr);
    shmctl(shmid, IPC_RMID, nullptr);
    close(fd);

    return 0;
}

```

---

### ç¼–è¯‘ä¸è¿è¡Œ ğŸš€

#### ç¼–è¯‘å‘½ä»¤ ğŸ”§

```bash
g++ -o client client.cc
g++ -o server server.cc

```

#### è¿è¡Œæ­¥éª¤ â–¶ï¸

1. **åœ¨ä¸€ä¸ªç»ˆç«¯è¿è¡ŒæœåŠ¡ç«¯**
   ï¼š

   ```bash
   ./server

   ```
2. **åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œå®¢æˆ·ç«¯**
   ï¼š

   ```bash
   ./client

   ```
3. **åœ¨å®¢æˆ·ç«¯ç»ˆç«¯è¾“å…¥æ¶ˆæ¯**
   ï¼ˆä¾‹å¦‚
   `"Hello, shared memory!"`
   ï¼‰å¹¶æŒ‰å›è½¦ â†µ

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/90c647f79a664fb5812b406cfaf7ff7d.png)

---

### ä»£ç å·¥ä½œåŸç† ğŸ§ 

1. **å…±äº«å†…å­˜åˆ›å»ºä¸é™„åŠ **
   ğŸ”—

   * æœåŠ¡ç«¯ä½¿ç”¨
     `shmget`
     åˆ›å»ºå…±äº«å†…å­˜ï¼Œå®¢æˆ·ç«¯é€šè¿‡ç›¸åŒçš„é”®å€¼è·å–ã€‚
   * `shmat`
     å°†å…±äº«å†…å­˜æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´ï¼Œè¿”å›æŒ‡é’ˆä¾›ç›´æ¥æ“ä½œã€‚
2. **æ•°æ®é€šä¿¡**
   ğŸ“¡

   * å®¢æˆ·ç«¯å°†è¾“å…¥å†™å…¥å…±äº«å†…å­˜ï¼ŒæœåŠ¡ç«¯ç›´æ¥è¯»å–è¯¥å†…å­˜åŒºåŸŸçš„å†…å®¹ã€‚
3. **åŒæ­¥æœºåˆ¶**
   âš¡

   * ä½¿ç”¨å‘½åç®¡é“ï¼ˆFIFOï¼‰å®ç°åŒæ­¥ï¼Œå®¢æˆ·ç«¯å†™å…¥æ•°æ®åé€šè¿‡ç®¡é“å‘é€ä¿¡å·ï¼ŒæœåŠ¡ç«¯æ¥æ”¶ä¿¡å·åè¯»å–æ•°æ®ã€‚
4. **èµ„æºç®¡ç†**
   ğŸ› ï¸

   * æœåŠ¡ç«¯åœ¨ç»“æŸæ—¶ä½¿ç”¨
     `shmctl(IPC_RMID)`
     åˆ é™¤å…±äº«å†…å­˜ï¼Œ
     `Init`
     ç±»çš„ææ„å‡½æ•°æ¸…ç†å‘½åç®¡é“ã€‚

---