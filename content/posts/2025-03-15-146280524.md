---
layout: post
title: "Linux下共享内存-和-命名管道-的使用"
date: 2025-03-15 16:35:21 +0800
description: "Linux下共享内存 和 命名管道 的使用"
keywords: "Linux下共享内存 和 命名管道 的使用"
categories: ['Linux']
tags: ['算法', '服务器', 'Linux', 'C']
artid: "146280524"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146280524
    alt: "Linux下共享内存-和-命名管道-的使用"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146280524
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146280524
cover: https://bing.ee123.net/img/rand?artid=146280524
image: https://bing.ee123.net/img/rand?artid=146280524
img: https://bing.ee123.net/img/rand?artid=146280524
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Linux下共享内存 和 命名管道 的使用
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <br/>
    <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/392d6b52781c4a35b77b6cc45b572d1f.png">
     <p>
     </p>
     <h2>
      <a id="Linux__3">
      </a>
      Linux共享内存：完整代码展示与剖析 🚀
     </h2>
     <p>
      共享内存（Shared Memory）是Linux系统中一种高效的进程间通信（IPC）机制，允许多个进程共享同一块物理内存区域，从而实现快速的数据交换。本文将提供完整的C++代码示例，包括头文件、客户端和服务端实现，详细展示共享内存的创建、使用、同步及管理过程。✨
     </p>
     <hr/>
     <h3>
      <a id="__9">
      </a>
      共享内存：原理、接口与应用实践 🔍
     </h3>
     <h4>
      <a id="__11">
      </a>
      引言 🌟
     </h4>
     <p>
      共享内存是Linux系统进程间通信（IPC）中最快的一种方式，其核心思想是让多个进程通过映射同一块物理内存来实现数据共享。
     </p>
     <hr/>
     <h4>
      <a id="__17">
      </a>
      一、共享内存核心原理 ⚙️
     </h4>
     <h5>
      <a id="11___19">
      </a>
      1.1 共享内存的特点 📌
     </h5>
     <ul>
      <li>
       <strong>
        零拷贝
       </strong>
       ：数据直接映射到进程地址空间，无需内核中转 🚫📦
      </li>
      <li>
       <strong>
        高效性
       </strong>
       ：适合传输大块数据（如视频流、大型矩阵） 💨
      </li>
      <li>
       <strong>
        无同步机制
       </strong>
       ：需结合其他IPC（如信号量、管道）实现同步 🔄
      </li>
     </ul>
     <h5>
      <a id="12___24">
      </a>
      1.2 生命周期管理 ⏳
     </h5>
     <ul>
      <li>
       <strong>
        随内核持续
       </strong>
       ：即使进程退出，共享内存仍存在 💾
      </li>
      <li>
       <strong>
        主动释放
       </strong>
       ：需调用
       <code>
        shmctl
       </code>
       或使用
       <code>
        ipcrm
       </code>
       命令删除 🗑️
      </li>
     </ul>
     <hr/>
     <h4>
      <a id="__30">
      </a>
      二、关键系统接口解析 🔧
     </h4>
     <h5>
      <a id="21_Key__32">
      </a>
      2.1 生成唯一标识Key 🔑
     </h5>
     <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
key_t <span class="token function">ftok</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathname<span class="token punctuation">,</span> <span class="token keyword">int</span> proj_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
     <ul>
      <li>
       <strong>
        参数
       </strong>
       ：
       <ul>
        <li>
         <code>
          pathname
         </code>
         ：已存在的文件路径（如
         <code>
          /home/user/config
         </code>
         📁）
        </li>
        <li>
         <code>
          proj_id
         </code>
         ：项目ID（0-255） 🔢
        </li>
       </ul>
      </li>
      <li>
       <strong>
        返回值
       </strong>
       ：唯一Key，用于后续操作 🎯
      </li>
     </ul>
     <h5>
      <a id="22___43">
      </a>
      2.2 创建/获取共享内存 🛠️
     </h5>
     <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">shmget</span><span class="token punctuation">(</span>key_t key<span class="token punctuation">,</span> size_t size<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
     <ul>
      <li>
       <strong>
        标志位
       </strong>
       ：
       <ul>
        <li>
         <code>
          IPC_CREAT
         </code>
         ：不存在则创建 🆕
        </li>
        <li>
         <code>
          IPC_EXCL
         </code>
         ：配合
         <code>
          IPC_CREAT
         </code>
         使用，存在则报错 ❌
        </li>
        <li>
         权限位（如
         <code>
          0666
         </code>
         🔒）
        </li>
       </ul>
      </li>
     </ul>
     <h5>
      <a id="23___53">
      </a>
      2.3 内存挂接与去关联 🔗
     </h5>
     <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">shmat</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>shmaddr<span class="token punctuation">,</span> <span class="token keyword">int</span> shmflg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">shmdt</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>shmaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
     <ul>
      <li>
       <strong>
        挂接策略
       </strong>
       ：
       <ul>
        <li>
         <code>
          shmaddr
         </code>
         设为
         <code>
          NULL
         </code>
         由系统选择地址 🎯
        </li>
        <li>
         <code>
          SHM_RDONLY
         </code>
         以只读方式挂接 📖
        </li>
       </ul>
      </li>
     </ul>
     <h5>
      <a id="24___63">
      </a>
      2.4 控制操作 🎮
     </h5>
     <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">shmctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> shmid<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
     <ul>
      <li>
       <strong>
        控制命令
       </strong>
       ：
       <ul>
        <li>
         <code>
          IPC_STAT
         </code>
         ：获取状态信息 📊
        </li>
        <li>
         <code>
          IPC_RMID
         </code>
         ：标记删除 🗑️
        </li>
       </ul>
      </li>
     </ul>
     <hr/>
     <h3>
      <a id="__74">
      </a>
      完整代码展示 💻
     </h3>
     <p>
      以下是实现共享内存通信的完整代码，分为三个文件：
      <code>
       common.hpp
      </code>
      （公用头文件）、
      <code>
       client.cc
      </code>
      （客户端）和
      <code>
       server.cc
      </code>
      （服务端）。
     </p>
     <h4>
      <a id="1__commonhpp__78">
      </a>
      1. 公用头文件
      <code>
       common.hpp
      </code>
      📜
     </h4>
     <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__COMMON_HPP__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__COMMON_HPP__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/ipc.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/shm.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/stat.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">const</span> string pathname <span class="token operator">=</span> <span class="token string">"/home"</span><span class="token punctuation">;</span> <span class="token comment">// ftok使用的路径名 🏠</span>
<span class="token keyword">const</span> <span class="token keyword">int</span> proj_id <span class="token operator">=</span> <span class="token number">0x666</span><span class="token punctuation">;</span>       <span class="token comment">// ftok的项目ID 🆔</span>
<span class="token keyword">const</span> string FIFO_FILE <span class="token operator">=</span> <span class="token string">"./myfifo"</span><span class="token punctuation">;</span> <span class="token comment">// 命名管道文件路径 🚇</span>
<span class="token keyword">const</span> mode_t MODE <span class="token operator">=</span> <span class="token number">0664</span><span class="token punctuation">;</span>        <span class="token comment">// 命名管道权限 🔒</span>

<span class="token keyword">enum</span> <span class="token class-name">Mistake</span>
<span class="token punctuation">{<!-- --></span>
    FTOK_ERROR <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    SHMGET_ERROR<span class="token punctuation">,</span>
    SHMAT_ERROR<span class="token punctuation">,</span>
    FIFO_CREATE_ERR<span class="token punctuation">,</span>
    FIFO_DELETE_ERR
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 生成唯一的key_t键值 🔑</span>
key_t <span class="token function">GetKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    key_t key <span class="token operator">=</span> <span class="token function">ftok</span><span class="token punctuation">(</span>pathname<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> proj_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
       <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"ftok error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">exit</span><span class="token punctuation">(</span>FTOK_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> key<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 共享内存辅助函数 🛠️</span>
<span class="token keyword">int</span> <span class="token function">GetShareMemHelper</span><span class="token punctuation">(</span><span class="token keyword">int</span> flag<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    key_t key <span class="token operator">=</span> <span class="token function">GetKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">shmget</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 创建或获取4096字节的共享内存 💾</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shmid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
       <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"shmget error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token function">exit</span><span class="token punctuation">(</span>SHMGET_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> shmid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 创建共享内存 🆕</span>
<span class="token keyword">int</span> <span class="token function">CreateShm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">GetShareMemHelper</span><span class="token punctuation">(</span>IPC_CREAT <span class="token operator">|</span> IPC_EXCL <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 获取共享内存 🔍</span>
<span class="token keyword">int</span> <span class="token function">GetShm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">GetShareMemHelper</span><span class="token punctuation">(</span>IPC_CREAT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 初始化类：创建和销毁命名管道 🚧</span>
<span class="token keyword">class</span> <span class="token class-name">Init</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">mkfifo</span><span class="token punctuation">(</span>FIFO_FILE<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">!=</span> EEXIST<span class="token punctuation">)</span> <span class="token comment">// 如果管道已存在则忽略错误 ⚠️</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"mkfifo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>FIFO_CREATE_ERR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token function">unlink</span><span class="token punctuation">(</span>FIFO_FILE<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"unlink"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>FIFO_DELETE_ERR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre>
     <hr/>
     <h4>
      <a id="2__clientcc__176">
      </a>
      2. 客户端代码
      <code>
       client.cc
      </code>
      👨💻
     </h4>
     <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"common.hpp"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 获取共享内存 💾</span>
    <span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">GetShm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>shmaddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shmaddr <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"shmat error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>SHMAT_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 打开命名管道并发送信号 📤</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>FIFO_FILE<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> O_WRONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Please Enter :"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token comment">// 从标准输入读取数据并写入共享内存 ⌨️</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">fgets</span><span class="token punctuation">(</span>shmaddr<span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token string">"c"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通知服务端数据已写入 📨</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 分离共享内存 🔗</span>
    <span class="token function">shmdt</span><span class="token punctuation">(</span>shmaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
     <hr/>
     <h4>
      <a id="3__servercc__219">
      </a>
      3. 服务端代码
      <code>
       server.cc
      </code>
      👩💻
     </h4>
     <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"common.hpp"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建命名管道 🚇</span>
    Init init<span class="token punctuation">;</span>

    <span class="token comment">// 创建共享内存 🆕</span>
    <span class="token keyword">int</span> shmid <span class="token operator">=</span> <span class="token function">CreateShm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>shmaddr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">shmat</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shmaddr <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"shmat error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span>SHMAT_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 打开命名管道，等待客户端信号 📭</span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>FIFO_FILE<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"server start sucess"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> c<span class="token punctuation">;</span>
        ssize_t s <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取信号 📨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// 当s小于0说明写端关闭跳出循环关闭共享内存</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"client say@ "</span> <span class="token operator">&lt;&lt;</span> shmaddr<span class="token punctuation">;</span> <span class="token comment">// 输出共享内存内容 💬                                                       // 获取共享内存状态 📊</span>
            <span class="token keyword">struct</span> <span class="token class-name">shmid_ds</span> shmds<span class="token punctuation">;</span>
            <span class="token function">shmctl</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> IPC_STAT<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shmds<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"shm size: "</span> <span class="token operator">&lt;&lt;</span> shmds<span class="token punctuation">.</span>shm_segsz <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"shm nattch: "</span> <span class="token operator">&lt;&lt;</span> shmds<span class="token punctuation">.</span>shm_nattch <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"shm __key: 0x%x\n"</span><span class="token punctuation">,</span> shmds<span class="token punctuation">.</span>shm_perm<span class="token punctuation">.</span>__key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"shm shm_perm.mode: "</span> <span class="token operator">&lt;&lt;</span> shmds<span class="token punctuation">.</span>shm_perm<span class="token punctuation">.</span>mode <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"---------------------"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 分离并删除共享内存 🗑️</span>
    <span class="token function">shmdt</span><span class="token punctuation">(</span>shmaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">shmctl</span><span class="token punctuation">(</span>shmid<span class="token punctuation">,</span> IPC_RMID<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
     <hr/>
     <h3>
      <a id="__278">
      </a>
      编译与运行 🚀
     </h3>
     <h4>
      <a id="__280">
      </a>
      编译命令 🔧
     </h4>
     <pre><code class="prism language-bash">g++ <span class="token parameter variable">-o</span> client client.cc
g++ <span class="token parameter variable">-o</span> server server.cc
</code></pre>
     <h4>
      <a id="__287">
      </a>
      运行步骤 ▶️
     </h4>
     <ol>
      <li>
       <p>
        <strong>
         在一个终端运行服务端
        </strong>
        ：
       </p>
       <pre><code class="prism language-bash">./server
</code></pre>
      </li>
      <li>
       <p>
        <strong>
         在另一个终端运行客户端
        </strong>
        ：
       </p>
       <pre><code class="prism language-bash">./client
</code></pre>
      </li>
      <li>
       <p>
        <strong>
         在客户端终端输入消息
        </strong>
        （例如
        <code>
         "Hello, shared memory!"
        </code>
        ）并按回车 ↵
       </p>
      </li>
     </ol>
     <p>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/90c647f79a664fb5812b406cfaf7ff7d.png"/>
     </p>
     <hr/>
     <h3>
      <a id="__306">
      </a>
      代码工作原理 🧠
     </h3>
     <ol>
      <li>
       <p>
        <strong>
         共享内存创建与附加
        </strong>
        🔗
       </p>
       <ul>
        <li>
         服务端使用
         <code>
          shmget
         </code>
         创建共享内存，客户端通过相同的键值获取。
        </li>
        <li>
         <code>
          shmat
         </code>
         将共享内存映射到进程地址空间，返回指针供直接操作。
        </li>
       </ul>
      </li>
      <li>
       <p>
        <strong>
         数据通信
        </strong>
        📡
       </p>
       <ul>
        <li>
         客户端将输入写入共享内存，服务端直接读取该内存区域的内容。
        </li>
       </ul>
      </li>
      <li>
       <p>
        <strong>
         同步机制
        </strong>
        ⚡
       </p>
       <ul>
        <li>
         使用命名管道（FIFO）实现同步，客户端写入数据后通过管道发送信号，服务端接收信号后读取数据。
        </li>
       </ul>
      </li>
      <li>
       <p>
        <strong>
         资源管理
        </strong>
        🛠️
       </p>
       <ul>
        <li>
         服务端在结束时使用
         <code>
          shmctl(IPC_RMID)
         </code>
         删除共享内存，
         <code>
          Init
         </code>
         类的析构函数清理命名管道。
        </li>
       </ul>
      </li>
     </ol>
     <hr/>
    </img>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34363533383938352f:61727469636c652f64657461696c732f313436323830353234" class_="artid" style="display:none">
 </p>
</div>


