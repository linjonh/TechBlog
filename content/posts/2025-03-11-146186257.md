---
layout: post
title: "Ansible运行原理揭秘如何用YAML脚本掌控数服务器"
date: 2025-03-11 20:11:29 +0800
description: "Ansible主要功能在于批量主机操作，为了便捷地使用其中的部分主机，可以在inventory中将主机进行分组命名。默认的inventory file为/etc/ansible/hosts。inventory文件可以有多个，也可以通过Dynamic Inventory来动态生成。"
keywords: "Ansible运行原理揭秘：如何用YAML脚本掌控数服务器？"
categories: ['自动化运维技术探索', '技术探索与实践', 'Linux']
tags: ['运维', '架构与原理', '服务器', 'Ansible']
artid: "146186257"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146186257
    alt: "Ansible运行原理揭秘如何用YAML脚本掌控数服务器"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146186257
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146186257
cover: https://bing.ee123.net/img/rand?artid=146186257
image: https://bing.ee123.net/img/rand?artid=146186257
img: https://bing.ee123.net/img/rand?artid=146186257
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Ansible运行原理揭秘：如何用YAML脚本掌控数服务器？
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h2 id="YSvD-1741689433545" style="text-align:left">
     <strong>
      1 Ansible基本架构
     </strong>
    </h2>
    <h3 id="qqor-1741689433547" style="text-align:left">
     <strong>
      1.1
     </strong>
     <span style="color:#000000">
      <strong>
       Ansible工作模式
      </strong>
     </span>
    </h3>
    <blockquote>
     <div style="text-align:left">
      <span style="color:#000000">
       Ansible是基于模块工作的，本身没有批量部署的能力，真正具有批量部署能力的是Ansible所运行的模块，Ansible只是提供一种框架。
      </span>
     </div>
    </blockquote>
    <div style="text-align:left">
     <img alt="" height="603" src="https://i-blog.csdnimg.cn/direct/87392529d3c2481ba93eb5bd917a6db9.png" width="1017">
     </img>
    </div>
    <h3 id="VVaz-1741689433553" style="text-align:left">
     <strong>
      1.2 Ansible组件
     </strong>
    </h3>
    <div>
     <blockquote>
      <ul style="margin-left:0; margin-right:0">
       <li style="text-align:left">
        Ansible：Ansible核心程序
       </li>
       <li style="text-align:left">
        Play books：任务剧本（任务集），编排定义Ansible任务集的配置文件，由Ansible依次执行多个任务，通常是JSON格式的YML文件
       </li>
       <li style="text-align:left">
        Host inventory：Ansible管理主机的清单，记录由Ansible管理的主机信息，包括端口、密码、IP等
       </li>
       <li style="text-align:left">
        Modules：核心模块，主要操作是通过调用核心模块来完成管理任务
       </li>
       <li style="text-align:left">
        CustomModules：自定义模块，完成核心模块无法完成的功能，支持多种语言
       </li>
       <li style="text-align:left">
        Connection plugins：基于连接插件连接到各个主机上，即Ansible和Host通信使用，默认是使用SSH
       </li>
       <li style="text-align:left">
        Plugins：模块功能的补充，如连接类型插件、循环插件、变量插件等，可借助于插件完成更丰富的功能
       </li>
       <li style="text-align:left">
        Playbooks：批量的命令文件
       </li>
      </ul>
     </blockquote>
    </div>
    <blockquote>
     <div style="text-align:left">
      用户请求发送给Ansible核心模块，Ansible核心模块通过Host inventory模块寻找需要运行的主机，然后通过Connection plugins连接远程的主机，并发送命令。Ansible使用插件来连接每一个被控制端Host，此外，也通过插件来记录日志等信息。
     </div>
    </blockquote>
    <h3 id="wXt2-1741689433574" style="text-align:left">
     <strong>
      1.3 Ansible生成的主要文件
     </strong>
    </h3>
    <blockquote>
     <div style="text-align:left">
      <strong>
       /etc/ansible
      </strong>
     </div>
     <div>
      <ul style="margin-left:0; margin-right:0">
       <li style="text-align:left">
        /etc/ansible/ansible.cfg ：配置文件
       </li>
       <li style="text-align:left">
        /etc/ansible/hosts ：主机库（host inventory），管理被监控的主机
       </li>
       <li style="text-align:left">
        /usr/bin/ansible：主程序
       </li>
       <li style="text-align:left">
        /usr/bin/ansible-doc：文档
       </li>
       <li style="text-align:left">
        /usr/bin/ansible-playbook：剧本
       </li>
      </ul>
     </div>
    </blockquote>
    <h2 id="8OfG-1741689433589" style="text-align:left">
     <strong>
      2 Ansible任务执行模式
     </strong>
    </h2>
    <h3 id="FCAQ-1741689433591" style="text-align:left">
     <strong>
      2.1 Ansible任务执行模式
     </strong>
    </h3>
    <blockquote>
     <div style="text-align:left">
      <strong>
       Ansible任务执行模式分为2种：
      </strong>
     </div>
     <div>
      <ul style="margin-left:0; margin-right:0">
       <li style="text-align:left">
        ad-hoc模式（点对点模块）：使用单个模块，支持批量执行单条命令，相当与在bash中执行一句Shell命
       </li>
       <li style="text-align:left">
        playbook模式（剧本模式）：Ansible主要的管理方式，通过多个task的集合完成一类功能，可以理解为多个ad-hoc的配置文件
       </li>
      </ul>
     </div>
    </blockquote>
    <h3 id="LCKl-1741689433600" style="text-align:left">
     <strong>
      2.2 Ansible任务执行流程
     </strong>
    </h3>
    <div style="text-align:left">
     <img alt="" height="466" src="https://i-blog.csdnimg.cn/direct/17ec0843a9ae4b5fb4b91d8cf00e3a2c.png" width="610">
     </img>
    </div>
    <h2 id="EMiB-1741689433603" style="text-align:left">
     <strong>
      3 Ansible应用
     </strong>
    </h2>
    <h3 id="Xpcz-1741689433605" style="text-align:left">
     <strong>
      3.1 定义主机列表（Inventory）
     </strong>
    </h3>
    <blockquote>
     <div style="text-align:left">
      Ansible主要功能在于批量主机操作，为了便捷地使用其中的部分主机，可以在inventory中将主机进行分组命名。默认的inventory file为/etc/ansible/hosts。inventory文件可以有多个，也可以通过Dynamic Inventory来动态生成。
     </div>
    </blockquote>
    <blockquote>
     <div style="text-align:left">
      <span style="color:#000000">
       <strong>
        Inventory文件格式：
       </strong>
      </span>
     </div>
     <div>
      <ul style="margin-left:0; margin-right:0">
       <li style="text-align:left">
        <span style="color:#000000">
         <strong>
          Inventory文件遵循ini文件风格，中括号[]中的字符为组名
         </strong>
        </span>
       </li>
       <li style="text-align:left">
        <span style="color:#000000">
         <strong>
          可以将同一个主机同时放到不同的组当中
         </strong>
        </span>
       </li>
       <li style="text-align:left">
        <span style="color:#000000">
         <strong>
          如果主机采用的是非ssh默认端口时，可以在主机名称之后采用冒号加具体端口号来注明
         </strong>
        </span>
       </li>
       <li style="text-align:left">
        <span style="color:#000000">
         <strong>
          如果主机名遵循相似的命名模式，可以使用列表的形式来表示主机名
         </strong>
        </span>
       </li>
       <li style="text-align:left">
        <span style="color:#000000">
         <strong>
          主机变量可以在Inventory中定义主机时进行添加，便于在playbook中进行使用
         </strong>
        </span>
       </li>
      </ul>
     </div>
    </blockquote>
    <pre><code class="hljs">示例：
1.Inventory文件遵循ini文件风格，中括号[]中的字符为组名可以将同一个主机同时放到不同的组当中
[webservers]
node1



[dbservers]
node1

2.如果主机采用的是非ssh默认端口时，可以在主机名称之后采用冒号加具体端口号来注明
[webservers]
node1:2022



[dbservers]
node1

2.如果主机名遵循相似的命名模式，可以使用列表的形式来表示主机名
[webservers]
node[1:3]



[dbservers]
node[1:2]

3.主机变量可以在Inventory中定义主机时进行添加，便于在playbook中进行使用
[webservers]
node1 http_port=80 maxRequestsPerChild=808
node2 http_port=8080 maxRequestsPerChild=909</code></pre>
    <blockquote>
     <p>
      <strong>
       Inventory参数：
      </strong>
      Ansible在基于ssh连接Inventory中指定的远程主机时，可以通过指定参数来指定其交互方式，常用参数如下：
     </p>
     <div>
      <ul style="margin-left:0; margin-right:0">
       <li style="text-align:left">
        ansible_ssh_host：远程主机
       </li>
       <li style="text-align:left">
        ansible_ssh_user：指定远程主机ssh端口
       </li>
       <li style="text-align:left">
        ansible_ssh_pass：连接远程主机使用的密码
       </li>
       <li style="text-align:left">
        ansible_sudo_pass：sudo密码，建议使用--ask-sudo-pass命令
       </li>
       <li style="text-align:left">
        ansible_connection：指定连接类型，类型包括：local、ssh、paramiko
       </li>
       <li style="text-align:left">
        ansible_shell_type：指定连接对端的shell类型，默认支持sh
       </li>
       <li style="text-align:left">
        ansible_ssh_private_key_file：ssh连接使用的私钥
       </li>
       <li style="text-align:left">
        ansible_python_interpreter：指定对端使用的python编译器路径
       </li>
      </ul>
     </div>
    </blockquote>
    <pre><code class="hljs">示例：
根据定义的Inventory调用ping检测网络是否可达：
检测Inventory中定义的所有主机：ansible all -m ping

[root@node2 ~]# ansible all -m ping
192.168.10.32 | SUCCESS =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
192.168.10.30 | SUCCESS =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
192.168.10.31 | SUCCESS =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
[root@node2 ~]# 


检测Inventory中定义的dbservers组的主机：ansible dbservers -m ping
[root@node2 ~]# ansible dbservers -m ping
192.168.10.30 | SUCCESS =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
[root@node2 ~]# 

检测指定单台主机：ansible 192.168.10.30 -m ping
[root@node2 ~]# ansible 192.168.10.30 -m ping
192.168.10.30 | SUCCESS =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": false, 
    "ping": "pong"
}
[root@node2 ~]# </code></pre>
    <h3 id="MqaA-1741689578475">
     3.2 基于ad-hoc模式运行
    </h3>
    <blockquote>
     <p>
      Ansible通过ssh实现目标主机的配置管理、应用部署、任务执行等操作，故而需要事先配置Ansible端能基于秘钥认证的方式连接各被管理节点。
     </p>
    </blockquote>
    <pre><code class="hljs">基本语法：
ansible &lt;pattern&gt; -m &lt;module_name&gt; -a &lt;module_arguments&gt; [options]

解释：
&lt;pattern&gt;：目标主机或主机组，可以是Inventory中的主机名、IP地址、主机组或关键字（如all）
-m &lt;module_name&gt;：指定要使用的模块（如ping、shell、copy等）
-a &lt;module_arguments&gt;：传递给模块的参数
[options]：可选参数，用于控制Ansible行为</code></pre>
    <h4 id="p7uX-1741689611005">
     3.2.1 常用选项
    </h4>
    <table>
     <tbody>
      <tr>
       <td>
        <p>
         模块
        </p>
       </td>
       <td>
        <p>
         描述
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         -i
        </p>
       </td>
       <td>
        <p>
         指定自定义的Inventory文件
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         --private-key
        </p>
       </td>
       <td>
        <p>
         指定SSH私钥文件
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         -u
        </p>
       </td>
       <td>
        <p>
         指定SSH用户
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         -k
        </p>
       </td>
       <td>
        <p>
         提示输入SSH密码
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         -K
        </p>
       </td>
       <td>
        <p>
         提示输入become（提权）密码（如sudo密码）
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         -b
        </p>
       </td>
       <td>
        <p>
         使用become（提权）执行任务（如sudo）
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         --become-user
        </p>
       </td>
       <td>
        <p>
         指定提权后的用户（默认为root）
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         -v
        </p>
       </td>
       <td>
        <p>
         输出详细信息（-vvv或-vvvv可增加调试信息）
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         --check
        </p>
       </td>
       <td>
        <p>
         模拟运行（不实际执行任何更改）
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         --diff
        </p>
       </td>
       <td>
        <p>
         显示文件的差异（适用于文件相关模块，如copy、template）
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         --ask-pass
        </p>
       </td>
       <td>
        <p>
         提示输入SSH密码
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         --limit
        </p>
       </td>
       <td>
        <p>
         限制运行的主机范围（如limit webservers只对webservers组的主机生效）
        </p>
       </td>
      </tr>
     </tbody>
    </table>
    <pre><code class="hljs">示例：使用shell模块检查/etc/passwd文件中是否包含 root
ansible all -m shell -a 'grep root /etc/passwd'

[root@node2 ~]# ansible all -m shell -a 'grep root /etc/passwd'
192.168.10.30 | CHANGED | rc=0 &gt;&gt;
root:x:0:0:root:/root:/bin/bash
operator:x:11:0:operator:/root:/sbin/nologin
192.168.10.32 | CHANGED | rc=0 &gt;&gt;
root:x:0:0:root:/root:/bin/bash
operator:x:11:0:operator:/root:/sbin/nologin
192.168.10.31 | CHANGED | rc=0 &gt;&gt;
root:x:0:0:root:/root:/bin/bash
operator:x:11:0:operator:/root:/sbin/nologin
[root@node2 ~]# </code></pre>
    <h4 id="PoZA-1741689638580">
     3.2.2 常用模块
    </h4>
    <table>
     <tbody>
      <tr>
       <td>
        <p>
         选项
        </p>
       </td>
       <td>
        <p>
         解释
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         ping
        </p>
       </td>
       <td>
        <p>
         目标主机连通性测试
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         command
        </p>
       </td>
       <td>
        <p>
         在远程主机上执行命令，不支持管道
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         shell
        </p>
       </td>
       <td>
        <p>
         在目标远程主机上调用shell解释器，支持管道命令
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         copy
        </p>
       </td>
       <td>
        <p>
         复制文件到目标远程服务器主机上，支持设定内容和修改权限
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         file
        </p>
       </td>
       <td>
        <p>
         创建文件、链接文件以及删除文件等操作
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         yum
        </p>
       </td>
       <td>
        <p>
         服务安装
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         fetch
        </p>
       </td>
       <td>
        <p>
         从远程目标主机复制文件到本地
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         cron
        </p>
       </td>
       <td>
        <p>
         crontab计划任务管理
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         service
        </p>
       </td>
       <td>
        <p>
         服务管理
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         user
        </p>
       </td>
       <td>
        <p>
         用户管理
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         group
        </p>
       </td>
       <td>
        <p>
         用户组管理
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         setup
        </p>
       </td>
       <td>
        <p>
         主要是收集信息
        </p>
       </td>
      </tr>
      <tr>
       <td>
        <p>
         script
        </p>
       </td>
       <td>
        <p>
         将本地脚本在目标远端服务器主机上运行
        </p>
       </td>
      </tr>
     </tbody>
    </table>
    <pre><code class="hljs">示例：使用file模块在目标远程主机上创建文件
ansible all -m file -a "path=/tmp/tmp.txt state=touch"

[root@node2 ~]# ansible all -m file -a "path=/tmp/tmp.txt state=touch"
192.168.10.31 | CHANGED =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": true, 
    "dest": "/tmp/tmp.txt", 
    "gid": 0, 
    "group": "root", 
    "mode": "0644", 
    "owner": "root", 
    "secontext": "unconfined_u:object_r:user_tmp_t:s0", 
    "size": 0, 
    "state": "file", 
    "uid": 0
}
192.168.10.32 | CHANGED =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": true, 
    "dest": "/tmp/tmp.txt", 
    "gid": 0, 
    "group": "root", 
    "mode": "0644", 
    "owner": "root", 
    "size": 0, 
    "state": "file", 
    "uid": 0
}
192.168.10.30 | CHANGED =&gt; {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python"
    }, 
    "changed": true, 
    "dest": "/tmp/tmp.txt", 
    "gid": 0, 
    "group": "root", 
    "mode": "0644", 
    "owner": "root", 
    "size": 0, 
    "state": "file", 
    "uid": 0
}</code></pre>
    <h3 id="QyhF-1741689679752" style="text-align:left">
     <strong>
      3.3 基于playbook模式执行
     </strong>
    </h3>
    <blockquote>
     <div style="text-align:left">
      Playbook模式是一种通过编写YAML格式的脚本文件（称为 playbook）来定义和执行自动化任务的方式，playbook是由一个或者多个play组成的列表，play主要功能是将事先归并为一组的主机装扮成事先通过task定义好角色，task就是调用的AnsiBle的一个模块（module）。
     </div>
    </blockquote>
    <blockquote>
     <div style="text-align:left">
      <strong>
       playbook的组成部分：
      </strong>
     </div>
     <div>
      <ul style="margin-left:0; margin-right:0">
       <li style="text-align:left">
        hosts：用于指定要执行的指定任务的主机组，其可以是一个或者多个由冒号组成的主机组
       </li>
       <li style="text-align:left">
        user：指定远程主机上执行任务的用户，也可以自定sudo的用户
       </li>
       <li style="text-align:left">
        variable：用于定义playbook运行时使用的变量
       </li>
       <li style="text-align:left">
        tasks：用于定义在远程目标主机上执行的任务列表，包括
       </li>
      </ul>
     </div>
     <div style="text-align:left">
      1）name：任务的名称，建议描述任务执行步骤
     </div>
     <div style="text-align:left">
      2）module:options：调用Ansible的模块module和传入的参数
     </div>
     <div>
      <ul style="margin-left:0; margin-right:0">
       <li style="text-align:left">
        handler：用于定义task完成后需要调用的任务，包括
       </li>
      </ul>
     </div>
     <div style="text-align:left">
      1）notify：在每个paly的最后触发，调用在handler中定义的操作
     </div>
     <div style="text-align:left">
      2）handler：task的列表
     </div>
    </blockquote>
    <pre><code class="hljs">playbook示例：
---
- hosts: web  # 目标主机组
  become: yes  # 使用提权（如 sudo）
  tasks:
    - name: Ensure Apache is installed
      yum:
        name: httpd
        state: present

    - name: Ensure Apache is running
      service:
        name: httpd
        state: started</code></pre>
    <h4 id="Nz0T-1741689815841" style="text-align:left">
     <strong>
      3.3.1 playbook核心组件
     </strong>
    </h4>
    <div>
     1. hosts
    </div>
    <div>
     <pre><code class="hljs">作用：指定目标主机或主机组（在Inventory）中定义
示例：
hosts: webserver</code></pre>
    </div>
    <div>
     2. tasks
    </div>
    <div>
     <pre><code class="hljs">作用：定义要执行的任务列表
每个任务包含内容：
name：任务描述（可选，推荐使用）
模块名称（如yum、copy、service等）
模块参数

示例：
tasks:
  - name: Ensure Apache is installed
    yum:
      name: httpd
      state: present</code></pre>
    </div>
    <p>
     3. vars
    </p>
    <div>
     <pre><code class="hljs">作用：定义变量
示例：
vars:
  http_port: 80</code></pre>
     <p>
      4. handlers
     </p>
     <pre><code class="hljs">作用：定义处理器，通常用于重启服务
示例：
handlers:
  - name: Restart Apache
    service:
      name: httpd
      state: restarted</code></pre>
    </div>
    <div>
     5.  become
    </div>
    <div>
     <pre><code class="hljs">作用：是否使用提权（如sudo）
示例：
become: yes</code></pre>
     <h4 id="jVb2-1741689975016">
      3.3.2 playbook的执行
     </h4>
     <pre><code class="hljs">ansible-playbook playbook.yml</code></pre>
     <p>
      常用选项：
     </p>
     <table>
      <tbody>
       <tr>
        <td>
         <p>
          选项
         </p>
        </td>
        <td>
         <p>
          描述
         </p>
        </td>
       </tr>
       <tr>
        <td>
         <p>
          -i
         </p>
        </td>
        <td>
         <p>
          指定自定义的Inventory文件
         </p>
        </td>
       </tr>
       <tr>
        <td>
         <p>
          --limit
         </p>
        </td>
        <td>
         <p>
          限制运行的主机范围
         </p>
        </td>
       </tr>
       <tr>
        <td>
         <p>
          --check
         </p>
        </td>
        <td>
         <p>
          模拟运行（不实际执行任何更改）
         </p>
        </td>
       </tr>
       <tr>
        <td>
         <p>
          --diff
         </p>
        </td>
        <td>
         <p>
          显示文件的差异（适用于文件相关模块，如copy、template）
         </p>
        </td>
       </tr>
       <tr>
        <td>
         <p>
          --tags
         </p>
        </td>
        <td>
         <p>
          只运行指定标签的任务
         </p>
        </td>
       </tr>
       <tr>
        <td>
         <p>
          --skip-tags
         </p>
        </td>
        <td>
         <p>
          跳过指定标签的任务
         </p>
        </td>
       </tr>
       <tr>
        <td>
         <p>
          -v
         </p>
        </td>
        <td>
         <p>
          输出详细信息（-vvv或-vvvv可增加调试信息）
         </p>
        </td>
       </tr>
      </tbody>
     </table>
     <h4 id="6dJn-1741690012029" style="text-align:left">
      <strong>
       3.3.3 playbook高级用法
      </strong>
     </h4>
     <p>
      1.条件判断
     </p>
     <pre><code class="hljs">使用when关键字根据条件执行任务
示例：
tasks:
  - name: Install Apache on CentOS
    yum:
      name: httpd
      state: present
    when: ansible_os_family == "RedHat"</code></pre>
     <p>
      2. 循环
     </p>
     <pre><code class="hljs">使用loop关键字实现循环
示例：
tasks:
  - name: Ensure users are present
    user:
      name: "{<!-- -->{ item }}"
      state: present
    loop:
      - alice</code></pre>
     <p>
      3. 模版
     </p>
     <pre><code class="hljs">使用template模块生成动态配置文件
示例：
tasks:
  - name: Configure Apache
    template:
      src: templates/httpd.conf.j2
      dest: /etc/httpd/httpd.conf</code></pre>
     <p>
      4. 角色
     </p>
     <pre><code class="hljs">将Playbook分解为可重用的角色
示例：
roles:
  - common
  - webserver</code></pre>
     <h4 id="NcEI-1741690093031" style="background-color:transparent">
      3.3.4 案例：安装httpd
     </h4>
     <p>
      1.创建playbook相关目录
     </p>
     <pre><code class="hljs">[root@node2 ansible]# mkdir apache-playbook
[root@node2 ansible]# cd apache-playbook
[root@node2 ansible]# mkdir files
[root@node2 ansible]# mkdir templates</code></pre>
     <p>
      2.编辑Inventory文件，增加主机组web
     </p>
     <pre><code class="hljs">[root@node2 ansible]# echo "[web]" &gt;&gt;/etc/ansible/hosts

[root@node2 ansible]# echo "192.168.10.32" &gt;&gt;/etc/ansible/hosts
[root@node2 ansible]# </code></pre>
     <p>
      3.创建plalybook.yml文件，增加如下内容
     </p>
     <pre><code class="hljs">---
- hosts: web  # 目标主机组
  become: yes  # 使用提权（如 sudo）
  vars:
    http_port: 80  # 定义 HTTP 端口
    html_content: "Hello, Ansible!"  # 定义 HTML 页面内容

  tasks:
    # 1. 安装 Apache
    - name: Ensure Apache is installed
      yum:
        name: httpd
        state: present

    # 2. 配置 Apache
    - name: Configure Apache
      template:
        src: templates/httpd.conf.j2  # 模板文件
        dest: /etc/httpd/conf/httpd.conf  # 目标配置文件
      notify: Restart Apache  # 触发处理器

    # 3. 部署 HTML 页面
    - name: Deploy HTML page
      copy:
        content: "{<!-- -->{ html_content }}"
        dest: /var/www/html/index.html

    # 4. 启动 Apache 并设置开机自启
    - name: Ensure Apache is running and enabled
      service:
        name: httpd
        state: started
        enabled: yes

  handlers:
    # 定义处理器，用于重启 Apache
    - name: Restart Apache
      service:
        name: httpd
        state: restarted</code></pre>
     <p>
      4.创建模版文件，在templates目录下创建httpd.conf.j2文件，并增加如下内容
     </p>
     <pre><code class="hljs"># {<!-- -->{ ansible_managed }} - DO NOT EDIT MANUALLY

Listen {<!-- -->{ http_port }}

&lt;VirtualHost *:{<!-- -->{ http_port }}&gt;
    DocumentRoot "/var/www/html"
    ServerAdmin webmaster@localhost
    ErrorLog /var/log/httpd/error.log
    CustomLog /var/log/httpd/access.log combined
&lt;/VirtualHost&gt;</code></pre>
     <p>
      5.运行playbook
     </p>
     <pre><code class="hljs">ansible-playbook -i /etc/ansible/hosts playbook.yml</code></pre>
     <pre><code class="hljs">[root@node2 apache-playbook]# ansible-playbook -i /etc/ansible/hosts playbook.yml

PLAY [web] **********************************************************************************************************************************************************************

TASK [Gathering Facts] **********************************************************************************************************************************************************
ok: [192.168.10.32]

TASK [Ensure Apache is installed] ***********************************************************************************************************************************************
ok: [192.168.10.32]

TASK [Configure Apache] *********************************************************************************************************************************************************
ok: [192.168.10.32]

TASK [Deploy HTML page] *********************************************************************************************************************************************************
ok: [192.168.10.32]

TASK [Ensure Apache is running and enabled] *************************************************************************************************************************************
ok: [192.168.10.32]

PLAY RECAP **********************************************************************************************************************************************************************
192.168.10.32              : ok=5    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

[root@node2 apache-playbook]# </code></pre>
     <p>
      6.验证结果
     </p>
     <pre><code class="hljs">[root@node2 apache-playbook]# curl http://192.168.10.30
Hello, Ansible!
[root@node2 apache-playbook]# </code></pre>
    </div>
    <p>
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34333731353131312f:61727469636c652f64657461696c732f313436313836323537" class_="artid" style="display:none">
 </p>
</div>


