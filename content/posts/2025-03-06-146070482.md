---
arturl_encode: "68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34353531313638322f:61727469636c652f64657461696c732f313436303730343832"
layout: post
title: "å‰ç«¯å®ç°ç‰ˆæœ¬æ›´æ–°è‡ªåŠ¨æ£€æµ‹"
date: 2025-03-06 17:01:11 +08:00
description: "æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†åœ¨ç°ä»£Webåº”ç”¨ä¸­ï¼Œç‰¹åˆ«æ˜¯åœ¨å•é¡µé¢åº”ç”¨ï¼ˆSPAï¼‰ç¯å¢ƒä¸‹ï¼Œå¦‚ä½•å®ç°å‰ç«¯ç‰ˆæœ¬æ›´æ–°çš„è‡ªåŠ¨æ£€æµ‹å’Œæç¤ºç”¨æˆ·åˆ·æ–°çš„åŠŸèƒ½ã€‚é€šè¿‡è¿™ç§æœºåˆ¶ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…ç”¨æˆ·å› ä½¿ç”¨æ—§ç‰ˆä»£ç è€Œé‡åˆ°çš„é—®é¢˜ï¼Œç¡®ä¿åŠŸèƒ½ä¸€è‡´æ€§ã€å‡å°‘æ¥å£å…¼å®¹æ€§é—®é¢˜å¹¶æé«˜åº”ç”¨çš„å¯é æ€§ã€‚"
keywords: "å‰ç«¯å®ç°ç‰ˆæœ¬æ›´æ–°è‡ªåŠ¨æ£€æµ‹âœ…"
categories: ['å‰ç«¯', 'Vue', 'Javascript']
tags: ['å‰ç«¯', 'Vue', 'Javascript']
artid: "146070482"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146070482
    alt: "å‰ç«¯å®ç°ç‰ˆæœ¬æ›´æ–°è‡ªåŠ¨æ£€æµ‹"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146070482
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146070482
cover: https://bing.ee123.net/img/rand?artid=146070482
image: https://bing.ee123.net/img/rand?artid=146070482
img: https://bing.ee123.net/img/rand?artid=146070482
---

# å‰ç«¯å®ç°ç‰ˆæœ¬æ›´æ–°è‡ªåŠ¨æ£€æµ‹âœ…

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/0d39c3a024a643c2a5bbef84b47b8b23.gif#pic_center)

> ğŸ¤– ä½œè€…ç®€ä»‹ï¼šæ°´ç…®ç™½èœç‹ï¼Œä¸€ä½èµ„æ·±å‰ç«¯åŠé€€å¸ˆ ğŸ‘»
>   
> ğŸ‘€ æ–‡ç« ä¸“æ ï¼š
> [å‰ç«¯ä¸“æ ](https://blog.csdn.net/weixin_45511682/category_12694415.html)
> ï¼Œè®°å½•ä¸€ä¸‹å¹³æ—¶åœ¨åšå®¢å†™ä½œä¸­ï¼Œæ€»ç»“å‡ºçš„ä¸€äº›å¼€å‘æŠ€å·§å’ŒçŸ¥è¯†å½’çº³æ€»ç»“âœã€‚
>   
> æ„Ÿè°¢æ”¯æŒğŸ’•ğŸ’•ğŸ’•

## ä¸€ã€èƒŒæ™¯

åœ¨ç°ä»£Webåº”ç”¨ä¸­ï¼Œéƒ¨ç½²å‰ç«¯ç‰ˆæœ¬æ›´æ–°ååŠæ—¶æé†’ç”¨æˆ·è¿›è¡Œé¡µé¢åˆ·æ–°æ˜¯å¿…è¦çš„ã€‚ç”±äºå•é¡µé¢åº”ç”¨ï¼ˆSPAï¼‰çš„è·¯ç”±ç‰¹æ€§å’Œæµè§ˆå™¨ç¼“å­˜æœºåˆ¶ï¼Œç”¨æˆ·æµè§ˆå™¨å¯èƒ½ä¸ä¼šè‡ªåŠ¨åŠ è½½æœ€æ–°çš„ä»£ç èµ„æºã€‚è¿™ä¼šå¯¼è‡´ç”¨æˆ·æœªèƒ½ä½“éªŒåˆ°æœ€æ–°çš„åŠŸèƒ½å˜åŒ–ï¼Œç”šè‡³é‡Bugæˆ–ä¸ä¸€è‡´çš„è¡Œä¸ºã€‚é€šè¿‡å®ç°ä¸€ç§è‡ªåŠ¨æ£€æµ‹æœºåˆ¶æ¥æé†’ç”¨æˆ·æœ‰æ–°çš„ç‰ˆæœ¬ï¼Œå¹¶å¼•å¯¼å…¶åˆ·æ–°é¡µé¢ï¼Œå¯ä»¥æœ‰æ•ˆåœ°è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä¿è¯æ‰€æœ‰ç”¨æˆ·éƒ½èƒ½åŠæ—¶ä½¿ç”¨æœ€æ–°ç‰ˆåº”ç”¨çš„åŠŸèƒ½ã€‚

## äºŒã€å®ç°åŸç†

### 2.1 é€»è¾‘

æ˜¯







å¦




























æ˜¯







å¦














å˜åŒ–





















æ˜¯







å¦







æœªå˜åŒ–









åº”ç”¨å¯åŠ¨








ç”Ÿäº§ç¯å¢ƒ?








å¯åŠ¨å®šæ—¶å™¨








ç»“æŸæµç¨‹








ç­‰å¾…60ç§’








è·å–å½“å‰è„šæœ¬å“ˆå¸Œ








é¦–æ¬¡è¿è¡Œ?








ä¿å­˜åˆå§‹å“ˆå¸Œ








å“ˆå¸Œå˜åŒ–?








åœæ­¢å®šæ—¶å™¨








æ˜¾ç¤ºæ›´æ–°æç¤º








ç”¨æˆ·ç¡®è®¤?








åˆ·æ–°é¡µé¢








è®°å½•å–æ¶ˆæ“ä½œ

é€šè¿‡å¯¹æ¯”æ„å»ºæ‰“åŒ…å‡ºæ–‡ä»¶çš„å“ˆå¸Œå€¼å˜åŒ–å®ç°ç‰ˆæœ¬æ£€æµ‹ï¼š

1. å®šæ—¶è½®è¯¢ï¼šæ¯åˆ†é’Ÿæ£€æŸ¥é™æ€èµ„æºå˜åŒ–
2. å“ˆå¸Œå¯¹æ¯”ï¼šé€šè¿‡è§£æHTMLä¸­scriptæ ‡ç­¾æŒ‡çº¹åˆ¤æ–­æ›´æ–°
3. å¼ºåˆ¶åˆ·æ–°ï¼šæ£€æµ‹åˆ°æ›´æ–°åæç¤ºç”¨æˆ·åˆ·æ–°é¡µé¢

```javascript
// æ ¸å¿ƒå¯¹æ¯”é€»è¾‘
const isChanged = (oldSet, newSet) => {
  return oldSet.size !== newSet.size || 
         ![...oldSet].every(hash => newSet.has(hash))
}

```

### 2.2 ä¸€äº›å¥½å¤„

* é€šç”¨æ€§å¼ºï¼šé€‚ç”¨äºä»»æ„å‰ç«¯æ¡†æ¶
* æ— ä¾µå…¥å¼æ£€æµ‹ï¼šä¸ä¾èµ–æ„å»ºå·¥å…·é…ç½®
* ç”¨æˆ·å¯æ§ï¼šæç¤ºæ¡†è®©ç”¨æˆ·é€‰æ‹©åˆ·æ–°æ—¶æœº
* ç²¾å‡†æ£€æµ‹ï¼šé€šè¿‡å¯¹æ¯”scriptæ ‡ç­¾å†…å®¹å“ˆå¸Œå€¼
* ä½èµ„æºæ¶ˆè€—ï¼šæ¯åˆ†é’Ÿæ£€æµ‹ä¸€æ¬¡ï¼Œå•æ¬¡è¯·æ±‚æ€§èƒ½æ¶ˆè€—ä½

## ä¸‰ ã€å…·ä½“å®ç°

### 3.1 å·¥ç¨‹åŒ–å°è£…

```javascript
// useVersionHash.js æ ¸å¿ƒå®ç°
export default function useVersionHash() {
  // çŠ¶æ€ç®¡ç†
  const timerUpdate = ref(null)
  let scriptHashes = new Set()

  // ç”Ÿå‘½å‘¨æœŸ
  onMounted(() => startTimer())
  onBeforeUnmount(() => stopTimer())

  // ä¸šåŠ¡æ–¹æ³•
  const fetchScriptHashes = async () => { /*...*/ }
  const compareScriptHashes = async () => { /*...*/ }
  
  return { compareScriptHashes }
}

```

### 3.2 å…³é”®æ–¹æ³•è§£æ

#### è„šæœ¬å“ˆå¸Œè·å–ï¼š

```javascript
const fetchScriptHashes = async () => {
  const html = await fetch('/').then(res => res.text())
  const scriptRegex = /<script(?:\s+[^>]*)?>(.*?)<\/script\s*>/gi
  return new Set(html?.match(scriptRegex) || [])
}

```

#### å¯¹æ¯”é€»è¾‘ï¼š

```javascript
if (scriptHashes.size === 0) {
  // åˆå§‹åŒ–åŸºå‡†å€¼
  scriptHashes = newScriptHashes  
} else if (
  scriptHashes.size !== newScriptHashes.size ||
  ![...scriptHashes].every(hash => newScriptHashes.has(hash))
) {
  // è§¦å‘æ›´æ–°æµç¨‹
  stopTimer()
  showUpdateDialog()
}

```

## å››ã€å…¨éƒ¨ä»£ç ğŸš€ğŸš€ğŸš€

### 4.1 vue3

1ã€use-version-update.jså…·ä½“é€»è¾‘

```javascript
// @/utils/use-version-update.js
import { ref, onMounted, onBeforeUnmount } from 'vue'
import { ElMessageBox } from 'element-plus'

let scriptHashes = new Set()
const timerUpdate = ref(null)

export default function useVersionHash() {
  const isProduction = import.meta.env.MODE === 'production'

  const fetchScriptHashes = async () => {
    try {
      const html = await fetch('/').then((res) => res.text())
      const scriptRegex = /<script(?:\s+[^>]*)?>(.*?)<\/script\s*>/gi
      return new Set(html?.match(scriptRegex) || [])
    } catch (error) {
      console.error('è·å–è„šæœ¬å“ˆå¸Œå¤±è´¥:', error)
      return new Set()
    }
  }

  const compareScriptHashes = async () => {
    try {
      const newScriptHashes = await fetchScriptHashes()

      if (scriptHashes.size === 0) {
        scriptHashes = newScriptHashes
      } else if (
        scriptHashes.size !== newScriptHashes.size ||
        ![...scriptHashes].every(hash => newScriptHashes.has(hash))
      ) {
        stopTimer()
        updateNotice()
      }
    } catch (error) {
      console.error('ç‰ˆæœ¬æ£€æŸ¥å¤±è´¥:', error)
    }
  }

  const updateNotice = () => {
    ElMessageBox.confirm(
      'æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼Œå»ºè®®ç«‹å³æ›´æ–°ä»¥ç¡®ä¿å¹³å°æ­£å¸¸ä½¿ç”¨',
      'æ›´æ–°æç¤º',
      {
        confirmButtonText: 'ç¡®å®š',
        cancelButtonText: 'å–æ¶ˆ',
        type: 'warning'
      }
    ).then(() => window.location.reload())
  }

  const startTimer = () => {
    if (!isProduction) return
    timerUpdate.value = setInterval(compareScriptHashes, 60000)
  }

  const stopTimer = () => {
    timerUpdate.value && clearInterval(timerUpdate.value)
  }

  onMounted(startTimer)
  onBeforeUnmount(stopTimer)

  return { compareScriptHashes, updateNotice }
}

```

2ã€å¼•å…¥use-version-update.js

```javascript
// App.vue
import versionUpdatefrom '@/utils/use-version-update.js'
export default {
  setup() {
    const { updateNotice } = versionUpdate()
    return { updateNotice }
  }
}

```

3ã€Vite ç›¸å…³é…ç½®

```javascript
// vite.config.js
import { defineConfig } from 'vite'

export default defineConfig({
  build: {
    rollupOptions: {
      output: {
         // ä¸»å…¥å£æ–‡ä»¶å‘½åè§„åˆ™
        entryFileNames: 'js/[name]-[hash:8].js',
        
        // ä»£ç åˆ†å‰²å—å‘½åè§„åˆ™
        chunkFileNames: 'js/[name]-[hash:8].js',
        
        // é™æ€èµ„æºæ–‡ä»¶å‘½åè§„åˆ™
        assetFileNames: ({ name }) => {
          const ext = name?.split('.').pop()
          return `assets/${ext}/[name]-[hash:8].[ext]`
        }
      }
    },
    // å¯ç”¨æ–‡ä»¶å“ˆå¸Œçš„manifestç”Ÿæˆ
    manifest: true
  }
})

```

ä¹Ÿå¯ä»¥å°†use-version-updateå†™æˆä»¥JSã€TSæ¨¡å—åŒ–å°è£…ï¼Œåœ¨å…¥å£æ–‡ä»¶ä¸­main.tså¼•å…¥

```javascript
// use-version-update.ts
export const versionUpdate = () => {
  ... å…·ä½“å¤„ç†é€»è¾‘
}

// main.ts
import { versionUpdate} from "@/utils/use-version-update"
if (import.meta.env.MODE == 'production') {
  versionUpdate()
}

```

### 4.2 vue2

1ã€use-version-update.jså…·ä½“é€»è¾‘

```javascript
/*
 * @Author: baicaiKing
 * @Date: 2025-01-02 13:50:33
 * @LastEditors: Do not edit
 * @LastEditTime: 2025-01-03 09:40:36
 * @FilePath: \code\src\utils\use-version-update.js
 */
// å­˜å‚¨å½“å‰è„šæœ¬æ ‡ç­¾çš„å“ˆå¸Œå€¼é›†åˆ
let scriptHashes = new Set();
let timerUpdate = undefined;
export default {
    data() {
        return {
        };
    },
    created() {
    },
    mounted() {
        // æ¯60ç§’æ£€æŸ¥ä¸€æ¬¡æ˜¯å¦æœ‰æ–°çš„è„šæœ¬æ ‡ç­¾æ›´æ–°
        if (process.env.NODE_ENV === 'production') { // åªé’ˆå¯¹ç”Ÿäº§ç¯å¢ƒ
            timerUpdate= setInterval(() => {
                this.compareScriptHashes()
            }, 60000);
        }
    },
    beforeDestroy() {
        clearInterval(timerUpdate);
        timerUpdate = null;
    },
    methods: {
        /**
         * ä»é¦–é¡µè·å–è„šæœ¬æ ‡ç­¾çš„å“ˆå¸Œå€¼é›†åˆ
         * @returns {Promise<Set<string>>} è¿”å›åŒ…å«è„šæœ¬æ ‡ç­¾çš„å“ˆå¸Œå€¼çš„é›†åˆ
         */
        async fetchScriptHashes() {
            // è·å–é¦–é¡µHTMLå†…å®¹
            const html = await fetch('/').then((res) => res.text());
            // æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ‰€æœ‰<script>æ ‡ç­¾
            const scriptRegex = /<script(?:\s+[^>]*)?>(.*?)<\/script\s*>/gi;
            // è·å–åŒ¹é…åˆ°çš„æ‰€æœ‰<script>æ ‡ç­¾å†…å®¹
            // const scripts = html.match(scriptRegex) ?? [];
            const scripts = html ? html.match(scriptRegex) || [] : [];
            // å°†è„šæœ¬æ ‡ç­¾å†…å®¹å­˜å…¥é›†åˆå¹¶è¿”å›
            return new Set(scripts);
        },
        /**
         * æ¯”è¾ƒå½“å‰è„šæœ¬æ ‡ç­¾çš„å“ˆå¸Œå€¼é›†åˆä¸æ–°è·å–çš„é›†åˆï¼Œæ£€æµ‹æ˜¯å¦æœ‰æ›´æ–°
         */
        async compareScriptHashes() {
            // è·å–æ–°çš„è„šæœ¬æ ‡ç­¾å“ˆå¸Œå€¼é›†åˆ
            const newScriptHashes = await this.fetchScriptHashes();

            if (scriptHashes.size === 0) {
                // åˆæ¬¡è¿è¡Œæ—¶ï¼Œå­˜å‚¨å½“å‰è„šæœ¬æ ‡ç­¾å“ˆå¸Œå€¼
                scriptHashes = newScriptHashes;
            } else if (
                scriptHashes.size !== newScriptHashes.size ||
                ![...scriptHashes].every((hash) => newScriptHashes.has(hash))
            ) {
                // å¦‚æœè„šæœ¬æ ‡ç­¾æ•°é‡æˆ–å†…å®¹å‘ç”Ÿå˜åŒ–ï¼Œåˆ™è®¤ä¸ºæœ‰æ›´æ–°
                console.info('å·²æ£€æµ‹åˆ°æ›´æ–°æ–‡ä»¶', {
                    oldScript: [...scriptHashes],
                    newScript: [...newScriptHashes],
                });
                // æ¸…é™¤å®šæ—¶å™¨
                clearInterval(timerUpdate);
                // æç¤ºç”¨æˆ·æ›´æ–°
                this.updateNotice();
            } else {
                // æ²¡æœ‰æ›´æ–°
                console.info('æœªæ£€æµ‹åˆ°æ›´æ–°æ—¶æœº', {
                    oldScript: [...scriptHashes],
                });
            }
        },
        updateNotice() {
            this.$confirm('æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼Œå»ºè®®ç«‹å³æ›´æ–°ä»¥ç¡®ä¿å¹³å°æ­£å¸¸ä½¿ç”¨', 'æ›´æ–°æç¤º', {
                confirmButtonText: 'ç¡®å®š',
                cancelButtonText: 'å–æ¶ˆï¼ˆè‡ªè¡Œåˆ·æ–°ï¼‰',
                type: 'warning'
            }).then(() => {
                window.location.reload();
            }).catch(() => {
                console.eror('ç”¨æˆ·å–æ¶ˆåˆ·æ–°ï¼');

            });
        }
    },

};

```

2ã€å¼•å…¥use-version-update.js

```javascript
// App.vue
import versionUpdate from "@/util/use-version-update.js";
export default {
  name: "app",
  mixins: [versionUpdate],
  data() {
    return {};
  },
};

```

3ã€Webpack ç›¸å…³é…ç½®

```javascript

// vue.config
module.exports = {
  configureWebpack: {
    output: {
      filename: 'js/[name].[hash].js',
      // filename: 'js/[name].[contenthash].js',
    },
  },
  devServer: {
  },
};


```

## äº”ã€æ³¨æ„äº‹é¡¹ä¸å¸¸è§é—®é¢˜

### 5.1 å¯èƒ½å‡ºç°çš„é—®é¢˜

| é—®é¢˜ç°è±¡ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
| --- | --- | --- |
| æ£€æµ‹ä¸å‡†ç¡® | æ­£åˆ™åŒ¹é…å¤±æ•ˆ | æ›´æ–°æ­£åˆ™è¡¨è¾¾å¼ |
| ç”Ÿäº§ç¯å¢ƒæœªç”Ÿæ•ˆ | ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯ | æ£€æŸ¥æ„å»ºé…ç½® |
| è·¨åŸŸè¯·æ±‚å¤±è´¥ | éƒ¨ç½²è·¯å¾„ä¸åŒ¹é… | è°ƒæ•´fetchè¯·æ±‚è·¯å¾„ |
| å†…å­˜æ³„æ¼ | å®šæ—¶å™¨æœªæ­£ç¡®æ¸…é™¤ | ä½¿ç”¨ `WeakRef` ä¼˜åŒ– |

### 5.2 æµè§ˆå™¨å…¼å®¹æ–¹æ¡ˆ

å¯ç»“åˆService Workerå®ç°æ— ç¼æ›´æ–°

```javascript
// æ”¯æŒService Workerçš„æ¸è¿›å¢å¼ºæ–¹æ¡ˆ
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(reg => {
      reg.addEventListener('updatefound', () => {
        showUpdateNotification()
      })
    })
}

```

> åŒæ—¶è¦ç¡®ä¿æœåŠ¡å™¨é…ç½®æ­£ç¡®ç¼“å­˜ç­–ç•¥ï¼Œé€šå¸¸Nginxç¼“å­˜ç­–ç•¥é»˜è®¤ä¸ç”¨æ‰“ç†

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/dd89a0e5fb7e4127bfc8f5845cd5b1a8.gif#pic_center)
  
å¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©ï¼Œè¯·ç‚¹èµ ğŸ‘ã€æ”¶è— ğŸ‘ å¹¶å…³æ³¨æˆ‘ï¼ğŸ‘€
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/8c3262cc0cbb4faa8d255526766834ae.gif#pic_center)