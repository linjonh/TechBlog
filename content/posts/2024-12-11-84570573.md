---
layout: post
title: "JAVA-导入信任证书-Keytool-的使用"
date: 2024-12-11 11:44:03 +0800
description: "文章目录1. 问题背景2. 诊断方式3. 解决方式1). 列出 keystore 中的证书。2). "
keywords: "java如何将第三方证书设置为可信任"
categories: ['运维管理']
tags: ['Ssl']
artid: "84570573"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=84570573
    alt: "JAVA-导入信任证书-Keytool-的使用"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=84570573
featuredImagePreview: https://bing.ee123.net/img/rand?artid=84570573
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     JAVA 导入信任证书 (Keytool 的使用)
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atelier-sulphurpool-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <a href="#1__2" rel="nofollow">
        1. 问题背景
       </a>
      </li>
      <li>
       <a href="#2__13" rel="nofollow">
        2. 诊断方式
       </a>
      </li>
      <li>
       <a href="#3__63" rel="nofollow">
        3. 解决方式
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1__keystore__70" rel="nofollow">
          1). 列出 keystore 中的证书。
         </a>
        </li>
        <li>
         <a href="#2__88" rel="nofollow">
          2). 导入证书。
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#4_94" rel="nofollow">
        4.附加内容：如何获取一个网站的证书
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h2>
     <a id="1__2">
     </a>
     1. 问题背景
    </h2>
    <p>
     使用 ssl 连接时，遇到不信任的证书，应用程序一般都会拒绝连接。
    </p>
    <p>
     浏览网站时，我们可以通过在浏览器的设置中导入证书，把证书加入到信任列表中。
    </p>
    <p>
     而在 JAVA 直接进行 SSL 连接应用时，默认没有一个界面来导入证书。JAVA 进行不信任的 ssl 连接时，会报如下异常：
    </p>
    <pre><code class="prism language-java">javax<span class="token punctuation">.</span>net<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>SSLHandshakeException<span class="token operator">:</span> sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>ValidatorException<span class="token operator">:</span> PKIX path building failed<span class="token operator">:</span> sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>certpath<span class="token punctuation">.</span>SunCertPathBuilderException<span class="token operator">:</span> unable to find valid certification path to requested target
</code></pre>
    <p>
     这时候，就要找到一种方式，在 JAVA 的运行环境中导入信任证书。
    </p>
    <h2>
     <a id="2__13">
     </a>
     2. 诊断方式
    </h2>
    <p>
     参照链接：
     <a href="https://confluence.atlassian.com/kb/unable-to-connect-to-ssl-services-due-to-pkix-path-building-failed-779355358.html" rel="nofollow">
      https://confluence.atlassian.com/kb/unable-to-connect-to-ssl-services-due-to-pkix-path-building-failed-779355358.html
     </a>
    </p>
    <p>
     以上链接中提供了一种方式，用于诊断你的 Java 环境中是否包含了相应的信任证书。此方式可诊断
     <strong>
      HTTPS, IMAPS, LDAPS
     </strong>
     等。
    </p>
    <ol>
     <li>
      下载
      <a href="https://confluence.atlassian.com/kb/files/779355358/779355357/1/1441897666313/SSLPoke.class" rel="nofollow">
       https://confluence.atlassian.com/kb/files/779355358/779355357/1/1441897666313/SSLPoke.class
      </a>
     </li>
     <li>
      运行如下命令，诊断连接是否可信。
     </li>
    </ol>
    <pre><code class="prism language-bash"><span class="token variable">$JAVA_HOME</span>/bin/java SSLPoke jira.example.com 443
</code></pre>
    <p>
     其中 java 是你要使用的 java 环境，后面是你要诊断的 url 和 port 。
    </p>
    <p>
     如果连接
     <mark>
      成功
     </mark>
     ，则出现如下结果：
    </p>
    <pre><code class="prism language-bash"><span class="token variable">$JAVA_HOME</span>/bin/java SSLPoke jira.example.com 443
Successfully connected
</code></pre>
    <p>
     而连接
     <mark>
      失败
     </mark>
     时，则出现如下异常：
    </p>
    <pre><code class="prism language-java">sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>ValidatorException<span class="token operator">:</span> PKIX path building failed<span class="token operator">:</span> sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>certpath<span class="token punctuation">.</span>SunCertPathBuilderException<span class="token operator">:</span> unable to find valid certification path to requested target
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>PKIXValidator<span class="token punctuation">.</span><span class="token function">doBuild</span><span class="token punctuation">(</span>PKIXValidator<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">387</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>PKIXValidator<span class="token punctuation">.</span><span class="token function">engineValidate</span><span class="token punctuation">(</span>PKIXValidator<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">292</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>Validator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>Validator<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">260</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>X509TrustManagerImpl<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>X509TrustManagerImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">324</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>X509TrustManagerImpl<span class="token punctuation">.</span><span class="token function">checkTrusted</span><span class="token punctuation">(</span>X509TrustManagerImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">229</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>X509TrustManagerImpl<span class="token punctuation">.</span><span class="token function">checkServerTrusted</span><span class="token punctuation">(</span>X509TrustManagerImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">124</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>ClientHandshaker<span class="token punctuation">.</span><span class="token function">serverCertificate</span><span class="token punctuation">(</span>ClientHandshaker<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1351</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>ClientHandshaker<span class="token punctuation">.</span><span class="token function">processMessage</span><span class="token punctuation">(</span>ClientHandshaker<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">156</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>Handshaker<span class="token punctuation">.</span><span class="token function">processLoop</span><span class="token punctuation">(</span>Handshaker<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">925</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>Handshaker<span class="token punctuation">.</span><span class="token function">process_record</span><span class="token punctuation">(</span>Handshaker<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">860</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>SSLSocketImpl<span class="token punctuation">.</span><span class="token function">readRecord</span><span class="token punctuation">(</span>SSLSocketImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1043</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>SSLSocketImpl<span class="token punctuation">.</span><span class="token function">performInitialHandshake</span><span class="token punctuation">(</span>SSLSocketImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">1343</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>SSLSocketImpl<span class="token punctuation">.</span><span class="token function">writeRecord</span><span class="token punctuation">(</span>SSLSocketImpl<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">728</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>AppOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>AppOutputStream<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">123</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>ssl<span class="token punctuation">.</span>AppOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>AppOutputStream<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">138</span><span class="token punctuation">)</span>
	at SSLPoke<span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span>SSLPoke<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">31</span><span class="token punctuation">)</span>
Caused by<span class="token operator">:</span> sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>certpath<span class="token punctuation">.</span>SunCertPathBuilderException<span class="token operator">:</span> unable to find valid certification path to requested target
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>certpath<span class="token punctuation">.</span>SunCertPathBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>SunCertPathBuilder<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">145</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>certpath<span class="token punctuation">.</span>SunCertPathBuilder<span class="token punctuation">.</span><span class="token function">engineBuild</span><span class="token punctuation">(</span>SunCertPathBuilder<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">131</span><span class="token punctuation">)</span>
	at java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>cert<span class="token punctuation">.</span>CertPathBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>CertPathBuilder<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">280</span><span class="token punctuation">)</span>
	at sun<span class="token punctuation">.</span>security<span class="token punctuation">.</span>validator<span class="token punctuation">.</span>PKIXValidator<span class="token punctuation">.</span><span class="token function">doBuild</span><span class="token punctuation">(</span>PKIXValidator<span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">382</span><span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">15</span> more
</code></pre>
    <p>
     此方式还能诊断
     <strong>
      LDAPS
     </strong>
     等 SSL 连接， 如
     <strong>
      LDAPS
     </strong>
     常用
     <strong>
      636
     </strong>
     端口：
    </p>
    <pre><code class="prism language-bash"><span class="token variable">$JAVA_HOME</span>/bin/java SSLPoke ldap.example.com 636
Successfully connected
</code></pre>
    <h2>
     <a id="3__63">
     </a>
     3. 解决方式
    </h2>
    <p>
     Java 使用了一种叫
     <strong>
      keystore
     </strong>
     的文件来存储证书 (默认是位于
     <strong>
      $JAVA_HOME/lib/security/cacerts
     </strong>
     ) 。
    </p>
    <p>
     该文件使用
     <code>
      keytool
     </code>
     工具去管理 (该工具默认位于
     <strong>
      $JAVA_HOME/bin/keytool
     </strong>
     )。
    </p>
    <p>
     keytool 工具的使用不在这里展开，网上有比较详细的说明。这里主要列举几个会用到的命令。
    </p>
    <h3>
     <a id="1__keystore__70">
     </a>
     1). 列出 keystore 中的证书。
    </h3>
    <pre><code class="prism language-bash">keytool -list
</code></pre>
    <p>
     默认情况下，它会在你的 $HOME 目录下产生一个空的 .keystore 文件。如要指定 Java 正在用的 keystore 文件，使用以下参数
    </p>
    <pre><code class="prism language-bash">keytool -list -keystore <span class="token variable">$JAVA_HOME</span>/lib/security/cacerts
</code></pre>
    <p>
     注意一下， keystore 文件都受 密码 保护。生成新的 keystore 文件时，会要求你输入一个新密码；而当访问一个已有的 keystore 文件时，会要求你验证密码。
    </p>
    <p>
     $JAVA_HOME/lib/security/cacerts 的默认密码为 “
     <mark>
      changeit
     </mark>
     ” ！！！
    </p>
    <p>
     $JAVA_HOME/lib/security/cacerts 的默认密码为 “
     <mark>
      changeit
     </mark>
     ” ！！！
    </p>
    <p>
     $JAVA_HOME/lib/security/cacerts 的默认密码为 “
     <mark>
      changeit
     </mark>
     ” ！！！
    </p>
    <p>
     <strong>
      重要的事情说三遍！！！
     </strong>
    </p>
    <h3>
     <a id="2__88">
     </a>
     2). 导入证书。
    </h3>
    <pre><code class="prism language-bash">keytool -import -alias <span class="token operator">&lt;</span>证书别名<span class="token operator">&gt;</span> -keystore <span class="token variable">$JAVA_HOME</span>/jre/lib/security/cacerts -file your.crt
</code></pre>
    <p>
     导入时会需要验证密码，默认密码见上面。
    </p>
    <h2>
     <a id="4_94">
     </a>
     4.附加内容：如何获取一个网站的证书
    </h2>
    <p>
     参考链接：
     <a href="https://confluence.atlassian.com/kb/connecting-to-ssl-services-802171215.html" rel="nofollow">
      https://confluence.atlassian.com/kb/connecting-to-ssl-services-802171215.html
     </a>
    </p>
    <p>
     以
     <a href="http://google.com" rel="nofollow">
      google.com
     </a>
     为例。
    </p>
    <p>
     Unix 方式
    </p>
    <pre><code class="prism language-bash">openssl s_client -connect google.com:443 <span class="token operator">&lt;</span> /dev/null <span class="token operator">|</span> <span class="token function">sed</span> -ne <span class="token string">'/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p'</span> <span class="token operator">&gt;</span> public.crt
</code></pre>
    <p>
     Windows 方式
    </p>
    <pre><code class="prism language-cmd">openssl s_client -connect google.com:443 &lt; NUL | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' &gt; public.crt
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874:7470733a2f2f626c6f672e6373646e2e6e65742f6c6a736b72:2f61727469636c652f64657461696c732f3834353730353733" class_="artid" style="display:none">
 </p>
</div>


