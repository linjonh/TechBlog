---
layout: post
title: "深度学习篇-分类任务图像预处理模型训练"
date: 2025-03-16 09:41:56 +0800
description: "本文简单介绍了pytoch、paddlepaddle框架下的分类任务的图像预处理、模型训练以及模型保存的流程。# 初始化数据集路径和标签self.classes = os.listdir(data_dir) # 获取类别文件夹（如class1, class2）self.image_paths = [] # 存储所有图像路径self.labels = [] # 存储对应标签# 遍历子文件夹，构建路径和标签的映射self.transform = transform # 数据增强/归一化操作。"
keywords: "深度学习篇---分类任务图像预处理&模型训练"
categories: ['程序代码篇', '深度学习篇', '图像处理篇']
tags: ['深度学习', '模型训练', '机器学习', '分类任务', '分类', '人工智能', 'Python']
artid: "146290658"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146290658
    alt: "深度学习篇-分类任务图像预处理模型训练"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146290658
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146290658
cover: https://bing.ee123.net/img/rand?artid=146290658
image: https://bing.ee123.net/img/rand?artid=146290658
img: https://bing.ee123.net/img/rand?artid=146290658
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     深度学习篇---分类任务图像预处理&amp;模型训练
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <hr/>
    <p>
    </p>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="_10">
     </a>
     前言
    </h2>
    <p>
     本文简单介绍了pytoch、paddlepaddle框架下的分类任务的图像预处理、模型训练以及模型保存的流程。
    </p>
    <hr/>
    <h2>
     <a id="Pytorch_15">
     </a>
     一、Pytorch
    </h2>
    <pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn<span class="token punctuation">,</span> optim
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset<span class="token punctuation">,</span> DataLoader
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms
<span class="token keyword">from</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">import</span> resnet18

<span class="token comment">#-------------------- 数据读取与预处理 --------------------</span>
<span class="token keyword">class</span> <span class="token class-name">CustomDataset</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_dir<span class="token punctuation">,</span> transform<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>data_dir <span class="token operator">=</span> data_dir
        self<span class="token punctuation">.</span>classes <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>image_paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token comment"># 遍历目录，获取所有图像路径和标签</span>
        <span class="token keyword">for</span> label<span class="token punctuation">,</span> cls <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
            cls_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> cls<span class="token punctuation">)</span>
            <span class="token keyword">for</span> img_name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>cls_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>image_paths<span class="token punctuation">.</span>append<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>cls_dir<span class="token punctuation">,</span> img_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transform

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>image_paths<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        img_path <span class="token operator">=</span> self<span class="token punctuation">.</span>image_paths<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>  <span class="token comment"># 使用OpenCV读取图像</span>
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>  <span class="token comment"># 转为RGB格式</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">:</span>
            image <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        
        label <span class="token operator">=</span> self<span class="token punctuation">.</span>labels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        <span class="token keyword">return</span> image<span class="token punctuation">,</span> label

<span class="token comment">#定义数据增强和归一化</span>
train_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    transforms<span class="token punctuation">.</span>ToPILImage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># OpenCV图像转PIL格式</span>
    transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>RandomRotation<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

val_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    transforms<span class="token punctuation">.</span>ToPILImage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">#创建Dataset和DataLoader</span>
train_dataset <span class="token operator">=</span> CustomDataset<span class="token punctuation">(</span><span class="token string">'data/train'</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>train_transform<span class="token punctuation">)</span>
val_dataset <span class="token operator">=</span> CustomDataset<span class="token punctuation">(</span><span class="token string">'data/val'</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>val_transform<span class="token punctuation">)</span>

train_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
val_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>val_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token comment">#-------------------- 模型定义 --------------------</span>
<span class="token keyword">class</span> <span class="token class-name">CustomModel</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>backbone <span class="token operator">=</span> resnet18<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>backbone<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>self<span class="token punctuation">.</span>backbone<span class="token punctuation">.</span>fc<span class="token punctuation">.</span>in_features<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

model <span class="token operator">=</span> CustomModel<span class="token punctuation">(</span>num_classes<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">'cuda'</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">'cpu'</span><span class="token punctuation">)</span>
model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

<span class="token comment">#-------------------- 训练配置 --------------------</span>
criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">1e-4</span><span class="token punctuation">)</span>

<span class="token comment">#-------------------- 训练循环 --------------------</span>
<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
    train_loss <span class="token operator">=</span> <span class="token number">0.0</span>

    <span class="token keyword">for</span> images<span class="token punctuation">,</span> labels <span class="token keyword">in</span> train_loader<span class="token punctuation">:</span>
        images <span class="token operator">=</span> images<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>images<span class="token punctuation">)</span>
        loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

        train_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 验证</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    val_loss <span class="token operator">=</span> <span class="token number">0.0</span>
    correct <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">for</span> images<span class="token punctuation">,</span> labels <span class="token keyword">in</span> val_loader<span class="token punctuation">:</span>
            images <span class="token operator">=</span> images<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>images<span class="token punctuation">)</span>
            val_loss <span class="token operator">+=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            _<span class="token punctuation">,</span> preds <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            correct <span class="token operator">+=</span> <span class="token punctuation">(</span>preds <span class="token operator">==</span> labels<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Epoch </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">, Train Loss: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>train_loss<span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">, Val Acc: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>correct<span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>val_dataset<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token format-spec">.4f</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

<span class="token comment">#-------------------- 模型导出 --------------------</span>
<span class="token comment">#保存PyTorch模型权重</span>
torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'model.pth'</span><span class="token punctuation">)</span>

<span class="token comment">#导出为ONNX格式（可选）</span>
dummy_input <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
torch<span class="token punctuation">.</span>onnx<span class="token punctuation">.</span>export<span class="token punctuation">(</span>model<span class="token punctuation">,</span> dummy_input<span class="token punctuation">,</span> <span class="token string">'model.onnx'</span><span class="token punctuation">,</span> input_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'input'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> output_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="1__CustomDataset_141">
     </a>
     1. 自定义数据集类 CustomDataset
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">CustomDataset</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_dir<span class="token punctuation">,</span> transform<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 初始化数据集路径和标签</span>
        self<span class="token punctuation">.</span>data_dir <span class="token operator">=</span> data_dir
        self<span class="token punctuation">.</span>classes <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span>  <span class="token comment"># 获取类别文件夹（如class1, class2）</span>
        self<span class="token punctuation">.</span>image_paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 存储所有图像路径</span>
        self<span class="token punctuation">.</span>labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token comment"># 存储对应标签</span>
        <span class="token comment"># 遍历子文件夹，构建路径和标签的映射</span>
        <span class="token keyword">for</span> label<span class="token punctuation">,</span> cls <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
            cls_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> cls<span class="token punctuation">)</span>
            <span class="token keyword">for</span> img_name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>cls_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>image_paths<span class="token punctuation">.</span>append<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>cls_dir<span class="token punctuation">,</span> img_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transform  <span class="token comment"># 数据增强/归一化操作</span>

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>image_paths<span class="token punctuation">)</span>  <span class="token comment"># 返回数据集总样本数</span>

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        img_path <span class="token operator">=</span> self<span class="token punctuation">.</span>image_paths<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>  <span class="token comment"># 用OpenCV读取图像（BGR格式）</span>
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>  <span class="token comment"># 转为RGB格式（适配模型输入）</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">:</span>
            image <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span>  <span class="token comment"># 应用预处理</span>
        label <span class="token operator">=</span> self<span class="token punctuation">.</span>labels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        <span class="token keyword">return</span> image<span class="token punctuation">,</span> label  <span class="token comment"># 返回张量和标签</span>
</code></pre>
    <h4>
     <a id="_171">
     </a>
     关键点
    </h4>
    <h5>
     <a id="__init___172">
     </a>
     <strong>
      init
     </strong>
    </h5>
    <p>
     <strong>
      init
     </strong>
     : 递归遍历文件夹，生成
     <strong>
      图像路径与标签的映射
     </strong>
     。
    </p>
    <h5>
     <a id="__getitem___174">
     </a>
     <strong>
      getitem
     </strong>
    </h5>
    <p>
     <strong>
      getitem
     </strong>
     : 动态
     <strong>
      加载图像
     </strong>
     ，
     <strong>
      OpenCV读取后需转为RGB
     </strong>
     （因PyTorch模型默认处理RGB）。
    </p>
    <h5>
     <a id="transform_178">
     </a>
     transform
    </h5>
    <p>
     transform: 接收
     <strong>
      外部定义的数据增强操作
     </strong>
     （如归一化、翻转）。
    </p>
    <h3>
     <a id="2__transformsCompose_182">
     </a>
     2. 数据预处理 transforms.Compose
    </h3>
    <pre><code class="prism language-python">train_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    transforms<span class="token punctuation">.</span>ToPILImage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 将numpy数组或OpenCV图像转为PIL格式（后续操作需要）</span>
    transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 调整图像尺寸为224x224</span>
    transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 随机水平翻转（概率默认0.5）</span>
    transforms<span class="token punctuation">.</span>RandomRotation<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment"># 随机旋转（-15度到+15度）</span>
    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 转为Tensor格式（维度变为CxHxW，像素值范围[0,1]）</span>
    transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># ImageNet统计量归一化</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_195">
     </a>
     关键点
    </h4>
    <h5>
     <a id="ToPILmage_196">
     </a>
     ToPILmage
    </h5>
    <p>
     ToPILImage: PyTorch的
     <strong>
      transforms
     </strong>
     多数操作基于
     <strong>
      PIL图像
     </strong>
     ，需先转换格式。
    </p>
    <h5>
     <a id="Normalize_198">
     </a>
     Normalize
    </h5>
    <p>
     Normalize: 使用ImageNet的
     <strong>
      均值和标准差
     </strong>
     ，适配预训练模型输入分布。
    </p>
    <h5>
     <a id="_200">
     </a>
     验证集无需数据增强
    </h5>
    <p>
     验证集无需数据增强：仅保留
     <strong>
      尺寸调整和归一化
     </strong>
     。
    </p>
    <h3>
     <a id="3__DataLoader_203">
     </a>
     3. 数据加载器 DataLoader
    </h3>
    <pre><code class="prism language-python">train_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>
    train_dataset<span class="token punctuation">,</span> 
    batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>   <span class="token comment"># 每个批次的样本数</span>
    shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>    <span class="token comment"># 打乱训练数据顺序（防止过拟合）</span>
    num_workers<span class="token operator">=</span><span class="token number">4</span>    <span class="token comment"># 使用4个子进程加载数据（加速数据读取）</span>
<span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_213">
     </a>
     作用
    </h4>
    <blockquote>
     <p>
      作用：将数据集按批次加载，支持
      <strong>
       多进程加速
      </strong>
      。
     </p>
    </blockquote>
    <h4>
     <a id="_216">
     </a>
     参数
    </h4>
    <blockquote>
     <p>
      num_workers: 根据
      <strong>
       CPU核心数调整
      </strong>
      ，避免过高导致内存溢出。
     </p>
    </blockquote>
    <h3>
     <a id="4__CustomModel_220">
     </a>
     4. 模型定义 CustomModel
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">CustomModel</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>backbone <span class="token operator">=</span> resnet18<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 加载预训练ResNet18</span>
        <span class="token comment"># 修改全连接层，适配自定义类别数</span>
        self<span class="token punctuation">.</span>backbone<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>self<span class="token punctuation">.</span>backbone<span class="token punctuation">.</span>fc<span class="token punctuation">.</span>in_features<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_234">
     </a>
     关键点
    </h4>
    <h5>
     <a id="_235">
     </a>
     预训练权重
    </h5>
    <p>
     预训练权重：pretrained=True 加载ImageNet预训练参数，加速收敛。
    </p>
    <h5>
     <a id="_237">
     </a>
     修改全连接层
    </h5>
    <p>
     修改全连接层：原始ResNet输出
     <strong>
      1000类
     </strong>
     ，需替换为
     <strong>
      任务实际类别数（如2类）
     </strong>
     。
    </p>
    <h3>
     <a id="5__240">
     </a>
     5. 训练循环
    </h3>
    <pre><code class="prism language-python">model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 将模型移至GPU（若可用）</span>
criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 分类任务常用损失函数</span>
optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">1e-4</span><span class="token punctuation">)</span>  <span class="token comment"># Adam优化器</span>

<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 设置为训练模式（启用BatchNorm和Dropout）</span>
    train_loss <span class="token operator">=</span> <span class="token number">0.0</span>
    <span class="token keyword">for</span> images<span class="token punctuation">,</span> labels <span class="token keyword">in</span> train_loader<span class="token punctuation">:</span>
        images <span class="token operator">=</span> images<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 数据移至GPU</span>
        labels <span class="token operator">=</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 清空梯度（防止累积）</span>
        outputs <span class="token operator">=</span> model<span class="token punctuation">(</span>images<span class="token punctuation">)</span>  <span class="token comment"># 前向传播</span>
        loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>  <span class="token comment"># 计算损失</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token comment"># 反向传播计算梯度</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token comment"># 更新权重</span>
        train_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 累加损失</span>

    <span class="token comment"># 验证阶段</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 设置为评估模式（关闭BatchNorm和Dropout）</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 禁用梯度计算（节省内存）</span>
        <span class="token keyword">for</span> images<span class="token punctuation">,</span> labels <span class="token keyword">in</span> val_loader<span class="token punctuation">:</span>
            <span class="token comment"># ...（类似训练循环，但只计算损失和精度）</span>
</code></pre>
    <h4>
     <a id="_267">
     </a>
     关键点
    </h4>
    <h5>
     <a id="modeltrainmodelevel_268">
     </a>
     model.train()和model.evel()
    </h5>
    <p>
     model.train() 和 model.eval(): 控
     <strong>
      制模型训练/评估模式
     </strong>
     ，影响某些层的行为。
    </p>
    <h5>
     <a id="optimizerzero_grad_270">
     </a>
     optimizer.zero_grad()
    </h5>
    <p>
     optimizer.zero_grad(): 必须
     <strong>
      清空梯度
     </strong>
     ，否则
     <strong>
      梯度会累积导致训练异常
     </strong>
     。
    </p>
    <h3>
     <a id="6__273">
     </a>
     6. 模型导出
    </h3>
    <pre><code class="prism language-python"><span class="token comment">#保存PyTorch权重</span>
torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'model.pth'</span><span class="token punctuation">)</span>  <span class="token comment"># 仅保存模型参数（轻量）</span>

<span class="token comment">#导出为ONNX格式（跨框架部署）</span>
dummy_input <span class="token operator">=</span> torch<span class="token punctuation">.</span>randn<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>  <span class="token comment"># 生成虚拟输入</span>
torch<span class="token punctuation">.</span>onnx<span class="token punctuation">.</span>export<span class="token punctuation">(</span>
    model<span class="token punctuation">,</span> 
    dummy_input<span class="token punctuation">,</span> 
    <span class="token string">'model.onnx'</span><span class="token punctuation">,</span> 
    input_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'input'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 输入/输出名称（部署时标识）</span>
    output_names<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'output'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_290">
     </a>
     关键点
    </h4>
    <h5>
     <a id="ONNX_291">
     </a>
     ONNX导出
    </h5>
    <p>
     ONNX导出：需定义
     <strong>
      输入张量的形状（如 1,3,224,224）
     </strong>
     ，便于
     <strong>
      后续部署到不同框架
     </strong>
     。
    </p>
    <h2>
     <a id="Paddlepaddle_297">
     </a>
     二、Paddlepaddle
    </h2>
    <pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> paddle
<span class="token keyword">from</span> paddle<span class="token punctuation">.</span>io <span class="token keyword">import</span> Dataset<span class="token punctuation">,</span> DataLoader
<span class="token keyword">from</span> paddle<span class="token punctuation">.</span>vision <span class="token keyword">import</span> transforms
<span class="token keyword">from</span> paddle<span class="token punctuation">.</span>vision<span class="token punctuation">.</span>models <span class="token keyword">import</span> resnet18

<span class="token comment">#-------------------- 数据读取与预处理 --------------------</span>
<span class="token keyword">class</span> <span class="token class-name">CustomDataset</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_dir<span class="token punctuation">,</span> transform<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>data_dir <span class="token operator">=</span> data_dir
        self<span class="token punctuation">.</span>classes <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>data_dir<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>image_paths <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

        <span class="token keyword">for</span> label<span class="token punctuation">,</span> cls <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
            cls_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>data_dir<span class="token punctuation">,</span> cls<span class="token punctuation">)</span>
            <span class="token keyword">for</span> img_name <span class="token keyword">in</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>cls_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>image_paths<span class="token punctuation">.</span>append<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>cls_dir<span class="token punctuation">,</span> img_name<span class="token punctuation">)</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transform

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> idx<span class="token punctuation">)</span><span class="token punctuation">:</span>
        img_path <span class="token operator">=</span> self<span class="token punctuation">.</span>image_paths<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>
        image <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>image<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">:</span>
            image <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        
        label <span class="token operator">=</span> self<span class="token punctuation">.</span>labels<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
        <span class="token keyword">return</span> image<span class="token punctuation">,</span> label

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>image_paths<span class="token punctuation">)</span>

<span class="token comment">#数据增强与归一化</span>
train_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>RandomRotation<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

val_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">#创建DataLoader</span>
train_dataset <span class="token operator">=</span> CustomDataset<span class="token punctuation">(</span><span class="token string">'data/train'</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>train_transform<span class="token punctuation">)</span>
val_dataset <span class="token operator">=</span> CustomDataset<span class="token punctuation">(</span><span class="token string">'data/val'</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>val_transform<span class="token punctuation">)</span>

train_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>train_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
val_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>val_dataset<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token comment">#-------------------- 模型定义 --------------------</span>
<span class="token keyword">class</span> <span class="token class-name">CustomModel</span><span class="token punctuation">(</span>paddle<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>backbone <span class="token operator">=</span> resnet18<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>backbone<span class="token punctuation">.</span>fc <span class="token operator">=</span> paddle<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>self<span class="token punctuation">.</span>backbone<span class="token punctuation">.</span>fc<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

model <span class="token operator">=</span> CustomModel<span class="token punctuation">(</span>num_classes<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
model <span class="token operator">=</span> paddle<span class="token punctuation">.</span>Model<span class="token punctuation">(</span>model<span class="token punctuation">)</span>

<span class="token comment">#-------------------- 训练配置 --------------------</span>
optimizer <span class="token operator">=</span> paddle<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>parameters<span class="token operator">=</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> learning_rate<span class="token operator">=</span><span class="token number">1e-4</span><span class="token punctuation">)</span>
loss_fn <span class="token operator">=</span> paddle<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
metric <span class="token operator">=</span> paddle<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>Accuracy<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">#-------------------- 训练循环 --------------------</span>
model<span class="token punctuation">.</span>prepare<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> loss_fn<span class="token punctuation">,</span> metric<span class="token punctuation">)</span>
model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_loader<span class="token punctuation">,</span> val_loader<span class="token punctuation">,</span> epochs<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

<span class="token comment">#-------------------- 模型导出 --------------------</span>
<span class="token comment">#保存Paddle模型权重</span>
paddle<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'model.pdparams'</span><span class="token punctuation">)</span>

<span class="token comment">#导出为推理模型（静态图）</span>
input_spec <span class="token operator">=</span> paddle<span class="token punctuation">.</span>static<span class="token punctuation">.</span>InputSpec<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token string">'float32'</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'input'</span><span class="token punctuation">)</span>
paddle<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>network<span class="token punctuation">,</span> <span class="token string">'inference_model'</span><span class="token punctuation">,</span> input_spec<span class="token operator">=</span><span class="token punctuation">[</span>input_spec<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="1__CustomDataset_392">
     </a>
     1. 数据集类 CustomDataset
    </h3>
    <p>
     与PyTorch实现逻辑一致，但继承自
     <strong>
      paddle.io.Dataset
     </strong>
     ，代码结构相同。
    </p>
    <h3>
     <a id="2__transforms_395">
     </a>
     2. 数据预处理 transforms
    </h3>
    <pre><code class="prism language-python">train_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
    transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 直接支持numpy数组，无需转为PIL</span>
    transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>RandomRotation<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment"># 转为Tensor（维度为CxHxW）</span>
    transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_407">
     </a>
     差异点
    </h4>
    <blockquote>
     <p>
      差异点：Paddle的 transforms 直接支持
      <strong>
       numpy
      </strong>
      输入，无需 ToPILImage 转换。
     </p>
    </blockquote>
    <h3>
     <a id="3__CustomModel_410">
     </a>
     3. 模型定义 CustomModel
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">CustomModel</span><span class="token punctuation">(</span>paddle<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Layer<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>backbone <span class="token operator">=</span> resnet18<span class="token punctuation">(</span>pretrained<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token comment"># 修改全连接层（需手动获取输入维度）</span>
        self<span class="token punctuation">.</span>backbone<span class="token punctuation">.</span>fc <span class="token operator">=</span> paddle<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>self<span class="token punctuation">.</span>backbone<span class="token punctuation">.</span>fc<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>backbone<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_423">
     </a>
     差异点
    </h4>
    <p>
     差异点：Paddle的
     <strong>
      resnet18 全连接层属性名称为 fc
     </strong>
     ，与PyTorch一致，但需通过
     <strong>
      weight.shape[0]
     </strong>
     获取输入维度。
    </p>
    <h3>
     <a id="4__426">
     </a>
     4. 训练配置与执行
    </h3>
    <pre><code class="prism language-python">model <span class="token operator">=</span> paddle<span class="token punctuation">.</span>Model<span class="token punctuation">(</span>model<span class="token punctuation">)</span>  <span class="token comment"># 高层API封装</span>
model<span class="token punctuation">.</span>prepare<span class="token punctuation">(</span>
    optimizer<span class="token operator">=</span>paddle<span class="token punctuation">.</span>optimizer<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>parameters<span class="token operator">=</span>model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> learning_rate<span class="token operator">=</span><span class="token number">1e-4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    loss<span class="token operator">=</span>paddle<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    metrics<span class="token operator">=</span>paddle<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>Accuracy<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 内置评估指标</span>
<span class="token punctuation">)</span>
model<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>train_loader<span class="token punctuation">,</span> val_loader<span class="token punctuation">,</span> epochs<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">,</span> verbose<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 自动执行训练和验证</span>
</code></pre>
    <h4>
     <a id="_438">
     </a>
     关键点
    </h4>
    <h5>
     <a id="API_439">
     </a>
     高层API
    </h5>
    <blockquote>
     <p>
      高层API: PaddlePaddle的 Model 类封装了
      <strong>
       训练循环，简化代码
      </strong>
      。
     </p>
    </blockquote>
    <h5>
     <a id="modelprepare_441">
     </a>
     model.prepare(）
    </h5>
    <blockquote>
     <p>
      model.prepare(): 绑定
      <strong>
       优化器、损失函数和评估指标
      </strong>
      。
     </p>
    </blockquote>
    <h5>
     <a id="modelfit_443">
     </a>
     model.fit()
    </h5>
    <blockquote>
     <p>
      model.fit(): 自动执行
      <strong>
       多轮训练和验证
      </strong>
      ，无需
      <strong>
       手动编写循环
      </strong>
      。
     </p>
    </blockquote>
    <h3>
     <a id="5__446">
     </a>
     5. 模型导出
    </h3>
    <pre><code class="prism language-python"><span class="token comment">#保存权重</span>
paddle<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'model.pdparams'</span><span class="token punctuation">)</span>  <span class="token comment"># 类似PyTorch的.pth</span>

<span class="token comment">#导出静态图模型（用于部署）</span>
input_spec <span class="token operator">=</span> paddle<span class="token punctuation">.</span>static<span class="token punctuation">.</span>InputSpec<span class="token punctuation">(</span>
    shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token comment"># 支持动态batch（None）</span>
    dtype<span class="token operator">=</span><span class="token string">'float32'</span><span class="token punctuation">,</span> 
    name<span class="token operator">=</span><span class="token string">'input'</span>
<span class="token punctuation">)</span>
paddle<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>save<span class="token punctuation">(</span>model<span class="token punctuation">.</span>network<span class="token punctuation">,</span> <span class="token string">'inference_model'</span><span class="token punctuation">,</span> input_spec<span class="token operator">=</span><span class="token punctuation">[</span>input_spec<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="_461">
     </a>
     关键点
    </h4>
    <h5>
     <a id="_462">
     </a>
     静态图导出
    </h5>
    <blockquote>
     <p>
      静态图导出: Paddle的 paddle.jit.save 生成
      <strong>
       部署专用模型
      </strong>
      ，支持推理优化。
     </p>
    </blockquote>
    <h2>
     <a id="_465">
     </a>
     三、核心差异总结
    </h2>
    <blockquote>
     <p>
      功能 PyTorch PaddlePaddle
      <br/>
      数据读取 需
      <strong>
       手动转为PIL格式
      </strong>
      <strong>
       直接支持numpy数组
      </strong>
      <br/>
      模型定义
      <strong>
       nn.Module + 手动训练循环
      </strong>
      <strong>
       paddle.nn.Layer + 高层API Model
      </strong>
      <br/>
      训练循环
      <strong>
       手动编写循环（灵活）
      </strong>
      <strong>
       封装为 model.fit()（简洁）
      </strong>
      <br/>
      模型导出
      <strong>
       支持 .pth 和 ONNX
      </strong>
      <strong>
       支持 .pdparams 和静态图模型
      </strong>
     </p>
    </blockquote>
    <h2>
     <a id="_473">
     </a>
     四、常见问题
    </h2>
    <ol>
     <li>
      为何使用OpenCV而非PIL读取图像？
     </li>
    </ol>
    <blockquote>
     <p>
      OpenCV
      <strong>
       读取速度快
      </strong>
      ，且
      <strong>
       支持更多格式（如16位图像）
      </strong>
      ，但需
      <strong>
       注意BGR转RGB
      </strong>
      。
     </p>
    </blockquote>
    <ol start="2">
     <li>
      num_workers 设置多少合适？
     </li>
    </ol>
    <blockquote>
     <p>
      通常设为
      <strong>
       CPU核心数的2~4倍
      </strong>
      ，但需根据内存调整。设为0时禁用多进程。
     </p>
    </blockquote>
    <ol start="3">
     <li>
      验证集是否需要 shuffle=False？
     </li>
    </ol>
    <blockquote>
     <p>
      是的，验证集需
      <strong>
       保持顺序一致
      </strong>
      ，确保评估结果稳定。
     </p>
    </blockquote>
    <ol start="4">
     <li>
      如何适配其他模型（如Vision Transformer）？
     </li>
    </ol>
    <blockquote>
     <p>
      修改
      <strong>
       CustomModel
      </strong>
      中的
      <strong>
       backbone
      </strong>
      ，替换为对应模型结构。
     </p>
    </blockquote>
    <hr/>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f37393535363430322f:61727469636c652f64657461696c732f313436323930363538" class_="artid" style="display:none">
 </p>
</div>


