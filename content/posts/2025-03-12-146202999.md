---
layout: post
title: "深入理解Linux网络随笔七容器网络虚拟化-Veth设备对"
date: 2025-03-12 13:38:21 +0800
description: "微服务架构中服务被拆分成多个独立的容器，docker网络虚拟化的核心技术为：Veth设备对、Network Namespace、Bridg。"
keywords: "veth device"
categories: ['深入理解Linux网络']
tags: ['网络', 'Linux']
artid: "146202999"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146202999
    alt: "深入理解Linux网络随笔七容器网络虚拟化-Veth设备对"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146202999
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146202999
cover: https://bing.ee123.net/img/rand?artid=146202999
image: https://bing.ee123.net/img/rand?artid=146202999
img: https://bing.ee123.net/img/rand?artid=146202999
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     深入理解Linux网络随笔（七）：容器网络虚拟化--Veth设备对
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="Linux_0">
     </a>
     深入理解Linux网络随笔（七）：容器网络虚拟化
    </h2>
    <p>
     微服务架构中服务被拆分成多个独立的容器，docker网络虚拟化的核心技术为：Veth设备对、Network Namespace、Bridg。
    </p>
    <h3>
     <a id="Veth_4">
     </a>
     Veth设备对
    </h3>
    <p>
     <code>
      veth
     </code>
     设备是一种
     <strong>
      成对
     </strong>
     出现的虚拟网络接口，作用是
     <strong>
      在 Linux 网络命名空间或不同网络栈之间建立一个虚拟的点对点连接
     </strong>
     ，实现数据通信。例如实现容器与宿主机间的通信、不同neths间传递流量。
    </p>
    <p>
     如图所示：
    </p>
    <p>
     虚拟网络设备并不会直接连接物理网络设备，而是一端连接到协议栈，另一端连接到另一个 veth 设备。从一对 veth 设备中发出的数据包会直接传送到另一个 veth 设备。每个 veth 设备都可以配置 IP 地址，并作为 路由的一个接口，可以进行IP层通信。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5edc4a621c804c3fbd6d85905f0831d4.png"/>
    </p>
    <p>
     特点：
    </p>
    <p>
     （1）成对出现：创建时总是 两个设备*成对出现，例如
     <code>
      veth0
     </code>
     和
     <code>
      veth1
     </code>
     ，它们之间类似于一条网络隧道
    </p>
    <p>
     （2）工作方式：一端发送的流量会从另一端收到，就像网线直连一样
    </p>
    <p>
     （3）不处理 L2/L3 转发：
     <code>
      veth
     </code>
     设备 不会执行交换、路由*等功能，只是简单地在两端传输数据包
    </p>
    <h5>
     <a id="_21">
     </a>
     底层源码分析
    </h5>
    <p>
     <img alt="外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传" src="https://i-blog.csdnimg.cn/direct/fdddec9a8ad74401b3890caf6f660202.png"/>
    </p>
    <p>
     veth设备的初始化通过函数veth_init进行。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> __init <span class="token keyword">int</span> <span class="token function">veth_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//注册veth_link_ops veth设备的操作方法</span>
	<span class="token keyword">return</span> <span class="token function">rtnl_link_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>veth_link_ops<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      veth_link_ops
     </code>
     中定义了veth设备的操作回调函数。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">rtnl_link_ops</span> veth_link_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>kind		<span class="token operator">=</span> DRV_NAME<span class="token punctuation">,</span><span class="token comment">//设备类型</span>
	<span class="token punctuation">.</span>priv_size	<span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">veth_priv</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//私有数据大小</span>
	<span class="token punctuation">.</span>setup		<span class="token operator">=</span> veth_setup<span class="token punctuation">,</span><span class="token comment">//设备启动</span>
	<span class="token punctuation">.</span>validate	<span class="token operator">=</span> veth_validate<span class="token punctuation">,</span><span class="token comment">//检查netlink请求参数的合法性</span>
	<span class="token punctuation">.</span>newlink	<span class="token operator">=</span> veth_newlink<span class="token punctuation">,</span><span class="token comment">//处理新建的veth设备回调函数</span>
	<span class="token punctuation">.</span>dellink	<span class="token operator">=</span> veth_dellink<span class="token punctuation">,</span><span class="token comment">//处理删除的veth设备回调函数</span>
	<span class="token punctuation">.</span>policy		<span class="token operator">=</span> veth_policy<span class="token punctuation">,</span><span class="token comment">//netlink配置参数解析策略</span>
	<span class="token punctuation">.</span>maxtype	<span class="token operator">=</span> VETH_INFO_MAX<span class="token punctuation">,</span><span class="token comment">// netlink 解析时允许的最大属性编号</span>
	<span class="token punctuation">.</span>get_link_net	<span class="token operator">=</span> veth_get_link_net<span class="token punctuation">,</span><span class="token comment">// 获取 veth 设备所在的网络命名空间</span>
	<span class="token punctuation">.</span>get_num_tx_queues	<span class="token operator">=</span> veth_get_num_queues<span class="token punctuation">,</span><span class="token comment">// 获取设备的 TX 队列数</span>
	<span class="token punctuation">.</span>get_num_rx_queues	<span class="token operator">=</span> veth_get_num_queues<span class="token punctuation">,</span><span class="token comment">// 获取设备的 RX 队列数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     veth设备创建调用
     <code>
      veth_newlink
     </code>
     函数。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">veth_newlink</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net</span> <span class="token operator">*</span>src_net<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
			<span class="token keyword">struct</span> <span class="token class-name">nlattr</span> <span class="token operator">*</span>tb<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">nlattr</span> <span class="token operator">*</span>data<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
			<span class="token keyword">struct</span> <span class="token class-name">netlink_ext_ack</span> <span class="token operator">*</span>extack<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> err<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>peer<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">veth_priv</span> <span class="token operator">*</span>priv<span class="token punctuation">;</span>
	<span class="token keyword">char</span> ifname<span class="token punctuation">[</span>IFNAMSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">nlattr</span> <span class="token operator">*</span>peer_tb<span class="token punctuation">[</span>IFLA_MAX <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token operator">*</span>tbp<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> name_assign_type<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">ifinfomsg</span> <span class="token operator">*</span>ifmp<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">net</span> <span class="token operator">*</span>net<span class="token punctuation">;</span>

	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">//创建peer设备</span>
	peer <span class="token operator">=</span> <span class="token function">rtnl_create_link</span><span class="token punctuation">(</span>net<span class="token punctuation">,</span> ifname<span class="token punctuation">,</span> name_assign_type<span class="token punctuation">,</span>
				<span class="token operator">&amp;</span>veth_link_ops<span class="token punctuation">,</span> tbp<span class="token punctuation">,</span> extack<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">put_net</span><span class="token punctuation">(</span>net<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">//注册peer设备</span>
	err <span class="token operator">=</span> <span class="token function">register_netdevice</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">//获取dev的私有数据priv</span>
	priv <span class="token operator">=</span> <span class="token function">netdev_priv</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//将dev的指针赋值给peer的私有数据peer-&gt;priv，建立连接，通过dev访问peer设备</span>
	<span class="token function">rcu_assign_pointer</span><span class="token punctuation">(</span>priv<span class="token operator">-&gt;</span>peer<span class="token punctuation">,</span> peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//初始化dev的TX、RX队列</span>
	err <span class="token operator">=</span> <span class="token function">veth_init_queues</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> tb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> err_queues<span class="token punctuation">;</span>
	<span class="token comment">//获取 peer 设备的 priv 结构体</span>
	priv <span class="token operator">=</span> <span class="token function">netdev_priv</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//让 peer-&gt;priv-&gt;peer 指向 dev，建立 veth 设备对的双向连接</span>
	<span class="token function">rcu_assign_pointer</span><span class="token punctuation">(</span>priv<span class="token operator">-&gt;</span>peer<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//初始化peer设备的队列</span>
	err <span class="token operator">=</span> <span class="token function">veth_init_queues</span><span class="token punctuation">(</span>peer<span class="token punctuation">,</span> tb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> err_queues<span class="token punctuation">;</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     启动veth设备，通过
     <code>
      veth_netdev_ops
     </code>
     操作表找到发送过程中的回调函数veth_xmit。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">veth_setup</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">ether_setup</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

	dev<span class="token operator">-&gt;</span>priv_flags <span class="token operator">&amp;=</span> <span class="token operator">~</span>IFF_TX_SKB_SHARING<span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>priv_flags <span class="token operator">|=</span> IFF_LIVE_ADDR_CHANGE<span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>priv_flags <span class="token operator">|=</span> IFF_NO_QUEUE<span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>priv_flags <span class="token operator">|=</span> IFF_PHONY_HEADROOM<span class="token punctuation">;</span>
	<span class="token comment">//veth操作列表</span>
	dev<span class="token operator">-&gt;</span>netdev_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>veth_netdev_ops<span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>ethtool_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>veth_ethtool_ops<span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>features <span class="token operator">|=</span> NETIF_F_LLTX<span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>features <span class="token operator">|=</span> VETH_FEATURES<span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>vlan_features <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>features <span class="token operator">&amp;</span>
			     <span class="token operator">~</span><span class="token punctuation">(</span>NETIF_F_HW_VLAN_CTAG_TX <span class="token operator">|</span>
			       NETIF_F_HW_VLAN_STAG_TX <span class="token operator">|</span>
			       NETIF_F_HW_VLAN_CTAG_RX <span class="token operator">|</span>
			       NETIF_F_HW_VLAN_STAG_RX<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>needs_free_netdev <span class="token operator">=</span> true<span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>priv_destructor <span class="token operator">=</span> veth_dev_free<span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>pcpu_stat_type <span class="token operator">=</span> NETDEV_PCPU_STAT_TSTATS<span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>max_mtu <span class="token operator">=</span> ETH_MAX_MTU<span class="token punctuation">;</span>

	dev<span class="token operator">-&gt;</span>hw_features <span class="token operator">=</span> VETH_FEATURES<span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>hw_enc_features <span class="token operator">=</span> VETH_FEATURES<span class="token punctuation">;</span>
	dev<span class="token operator">-&gt;</span>mpls_features <span class="token operator">=</span> NETIF_F_HW_CSUM <span class="token operator">|</span> NETIF_F_GSO_SOFTWARE<span class="token punctuation">;</span>
	<span class="token function">netif_set_tso_max_size</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> GSO_MAX_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">net_device_ops</span> veth_netdev_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span>ndo_init            <span class="token operator">=</span> veth_dev_init<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ndo_open            <span class="token operator">=</span> veth_open<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ndo_stop            <span class="token operator">=</span> veth_close<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ndo_start_xmit      <span class="token operator">=</span> veth_xmit<span class="token punctuation">,</span><span class="token comment">//veth发送函数</span>
	<span class="token punctuation">.</span>ndo_get_stats64     <span class="token operator">=</span> veth_get_stats64<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ndo_set_rx_mode     <span class="token operator">=</span> veth_set_multicast_list<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ndo_set_mac_address <span class="token operator">=</span> eth_mac_addr<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_NET_POLL_CONTROLLER</span></span>
	<span class="token punctuation">.</span>ndo_poll_controller	<span class="token operator">=</span> veth_poll_controller<span class="token punctuation">,</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token punctuation">.</span>ndo_get_iflink		<span class="token operator">=</span> veth_get_iflink<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ndo_fix_features	<span class="token operator">=</span> veth_fix_features<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ndo_set_features	<span class="token operator">=</span> veth_set_features<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ndo_features_check	<span class="token operator">=</span> passthru_features_check<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ndo_set_rx_headroom	<span class="token operator">=</span> veth_set_rx_headroom<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ndo_bpf		<span class="token operator">=</span> veth_xdp<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ndo_xdp_xmit		<span class="token operator">=</span> veth_ndo_xdp_xmit<span class="token punctuation">,</span>
	<span class="token punctuation">.</span>ndo_get_peer_dev	<span class="token operator">=</span> veth_peer_dev<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h5>
     <a id="_158">
     </a>
     通信过程
    </h5>
    <p>
     数据包发送过程中到达网络设备层会进入
     <code>
      dev_hard_start_xmit
     </code>
     函数，遍历链表上的所有skb包调用
     <code>
      xmit_one
     </code>
     发送数据包。
    </p>
    <pre><code class="prism language-c"><span class="token comment">//网络设备数据包发送路径（TX Path） 的关键部分，负责调用底层驱动的 ndo_start_xmit() 发送数据包</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">xmit_one</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
		    <span class="token keyword">struct</span> <span class="token class-name">netdev_queue</span> <span class="token operator">*</span>txq<span class="token punctuation">,</span> bool more<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">;</span>
	<span class="token keyword">int</span> rc<span class="token punctuation">;</span>
	<span class="token comment">//监测是否有协议栈上层监听</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">dev_nit_active</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token comment">//AF_PACKET 套接字正在监听，发送数据包副本给监听进程</span>
		<span class="token function">dev_queue_xmit_nit</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//记录数据包长度</span>
	len <span class="token operator">=</span> skb<span class="token operator">-&gt;</span>len<span class="token punctuation">;</span>
	<span class="token comment">//触发tracepoint机制，记录数据包发送开始</span>
	<span class="token function">trace_net_dev_start_xmit</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//调用底层驱动的ndo_start_xmit()方法发送数据包</span>
	rc <span class="token operator">=</span> <span class="token function">netdev_start_xmit</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> txq<span class="token punctuation">,</span> more<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">trace_net_dev_xmit</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> rc<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> rc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     获取驱动设备回调函数集合ops，结构体
     <code>
      net_device_ops
     </code>
     ，调用
     <code>
      __netdev_start_xmit
     </code>
     发送数据包。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token class-name">netdev_tx_t</span> <span class="token function">netdev_start_xmit</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
					    <span class="token keyword">struct</span> <span class="token class-name">netdev_queue</span> <span class="token operator">*</span>txq<span class="token punctuation">,</span> bool more<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">net_device_ops</span> <span class="token operator">*</span>ops <span class="token operator">=</span> dev<span class="token operator">-&gt;</span>netdev_ops<span class="token punctuation">;</span>
	<span class="token class-name">netdev_tx_t</span> rc<span class="token punctuation">;</span>
	<span class="token comment">//发送数据包</span>
	rc <span class="token operator">=</span> <span class="token function">__netdev_start_xmit</span><span class="token punctuation">(</span>ops<span class="token punctuation">,</span> skb<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> more<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">==</span> NETDEV_TX_OK<span class="token punctuation">)</span>
		<span class="token function">txq_trans_update</span><span class="token punctuation">(</span>txq<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> rc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在这里会首先判断当前cpu发送队列是否还有数据待处理，然后调用驱动的ndo_start_xmit函数发送数据包，回调函数veth_xmit，lo是loopback_xmit。也就是在veth启动的时候注册的回调函数。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token class-name">netdev_tx_t</span> <span class="token function">__netdev_start_xmit</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">net_device_ops</span> <span class="token operator">*</span>ops<span class="token punctuation">,</span>
					      <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
					      bool more<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>softnet_data<span class="token punctuation">.</span>xmit<span class="token punctuation">.</span>more<span class="token punctuation">,</span> more<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> ops<span class="token operator">-&gt;</span><span class="token function">ndo_start_xmit</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在
     <code>
      veth_xmit
     </code>
     核心是获取veth设备数据，将数据发送到对端设备。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token class-name">netdev_tx_t</span> <span class="token function">veth_xmit</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">veth_priv</span> <span class="token operator">*</span>rcv_priv<span class="token punctuation">,</span> <span class="token operator">*</span>priv <span class="token operator">=</span> <span class="token function">netdev_priv</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">veth_rq</span> <span class="token operator">*</span>rq <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> NETDEV_TX_OK<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>rcv<span class="token punctuation">;</span>
	<span class="token keyword">int</span> length <span class="token operator">=</span> skb<span class="token operator">-&gt;</span>len<span class="token punctuation">;</span>
	bool use_napi <span class="token operator">=</span> false<span class="token punctuation">;</span>
	<span class="token keyword">int</span> rxq<span class="token punctuation">;</span>

	<span class="token function">rcu_read_lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//获取veth设备</span>
	rcv <span class="token operator">=</span> <span class="token function">rcu_dereference</span><span class="token punctuation">(</span>priv<span class="token operator">-&gt;</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">//获取rcv设备私有数据</span>
	rcv_priv <span class="token operator">=</span> <span class="token function">netdev_priv</span><span class="token punctuation">(</span>rcv<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//获取skb队列索引</span>
	rxq <span class="token operator">=</span> <span class="token function">skb_get_queue_mapping</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>rxq <span class="token operator">&lt;</span> rcv<span class="token operator">-&gt;</span>real_num_rx_queues<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		rq <span class="token operator">=</span> <span class="token operator">&amp;</span>rcv_priv<span class="token operator">-&gt;</span>rq<span class="token punctuation">[</span>rxq<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token comment">//rq绑定了napi，且数据包适合GRO，开启NAPI机制轮询数据包</span>
		use_napi <span class="token operator">=</span> <span class="token function">rcu_access_pointer</span><span class="token punctuation">(</span>rq<span class="token operator">-&gt;</span>napi<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
			   <span class="token function">veth_skb_is_eligible_for_gro</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> rcv<span class="token punctuation">,</span> skb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">skb_tx_timestamp</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//尝试将skb转发到对端veth设备</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span><span class="token function">veth_forward_skb</span><span class="token punctuation">(</span>rcv<span class="token punctuation">,</span> skb<span class="token punctuation">,</span> rq<span class="token punctuation">,</span> use_napi<span class="token punctuation">)</span> <span class="token operator">==</span> NET_RX_SUCCESS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//未使用NAPI机制，更新统计信息</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>use_napi<span class="token punctuation">)</span>
			<span class="token function">dev_sw_netstats_tx_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      veth_forward_skb
     </code>
     会根据数据包选择不同路径，数据包转发到对端设备
     <code>
      dev_forward_skb
     </code>
     ，对端开启XDP则调用
     <code>
      veth_xdp_rx
     </code>
     ，普通数据包调用
     <code>
      netif_rx
     </code>
     。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">veth_forward_skb</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span>
			    <span class="token keyword">struct</span> <span class="token class-name">veth_rq</span> <span class="token operator">*</span>rq<span class="token punctuation">,</span> bool xdp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">__dev_forward_skb</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> skb<span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">:</span> xdp <span class="token operator">?</span>
		<span class="token function">veth_xdp_rx</span><span class="token punctuation">(</span>rq<span class="token punctuation">,</span> skb<span class="token punctuation">)</span> <span class="token operator">:</span>
		<span class="token function">__netif_rx</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     函数调用关系：
     <code>
      __dev_forward_skb--&gt;__dev_forward_skb2--&gt;____dev_forward_skb
     </code>
     。
    </p>
    <pre><code class="prism language-c"><span class="token comment">//处理dev设备的转发数据包</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__dev_forward_skb2</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span>
			      bool check_mtu<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//实际数据包转发处理</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">____dev_forward_skb</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> skb<span class="token punctuation">,</span> check_mtu<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span><span class="token operator">!</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//将skb所属设备设置成刚才取到的veth对端设备rcv</span>
		skb<span class="token operator">-&gt;</span>protocol <span class="token operator">=</span> <span class="token function">eth_type_trans</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//修正skb校验和</span>
		<span class="token function">skb_postpull_rcsum</span><span class="token punctuation">(</span>skb<span class="token punctuation">,</span> <span class="token function">eth_hdr</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token punctuation">,</span> ETH_HLEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在
     <code>
      eth_type_trans
     </code>
     设置完成会继续执行
     <code>
      __netif_rx
     </code>
     路径，函数调用逻辑
     <code>
      netif_rx_internal--&gt;enqueue_to_backlog
     </code>
     ，在这里获取每个CPU核心对应的softnet_data数据结构，将skb添加到等待队列
     <code>
      input_pkt_queue
     </code>
     ，在函数
     <code>
      __test_and_set_bit
     </code>
     检查
     <code>
      sd-&gt;backlog.state
     </code>
     是否已包含
     <code>
      NAPI_STATE_SCHED
     </code>
     ，
     <code>
      NAPI_STATE_SCHED
     </code>
     是NAPI轮询处理的一个
     <strong>
      状态标志位
     </strong>
     ，
     <strong>
      防止同一个
      <code>
       NAPI
      </code>
      任务被重复调度
     </strong>
     ，未设置调用
     <code>
      napi_schedule_rps
     </code>
     触发NAPI调度，触发软中断
     <code>
      NET_RX_SOFTIRQ
     </code>
     。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">enqueue_to_backlog</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">int</span> cpu<span class="token punctuation">,</span>
			      <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>qtail<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">enum</span> <span class="token class-name">skb_drop_reason</span> reason<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">softnet_data</span> <span class="token operator">*</span>sd<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> qlen<span class="token punctuation">;</span>
	<span class="token comment">//丢包原因：未指定</span>
	reason <span class="token operator">=</span> SKB_DROP_REASON_NOT_SPECIFIED<span class="token punctuation">;</span>
	sd <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">per_cpu</span><span class="token punctuation">(</span>softnet_data<span class="token punctuation">,</span> cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">__test_and_set_bit</span><span class="token punctuation">(</span>NAPI_STATE_SCHED<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sd<span class="token operator">-&gt;</span>backlog<span class="token punctuation">.</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token function">napi_schedule_rps</span><span class="token punctuation">(</span>sd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     在这里根据是否开启RPS机制走不同的路径，
     <strong>
      <strong>
       RPS 是 Linux 内核的一种
       <strong>
        多核负载均衡机制
       </strong>
       ，
       <strong>
        将收到的数据包分配到多个 CPU 进行处理
       </strong>
       ，避免所有网络流量只由单个 CPU 处理，减少
       <strong>
        CPU 瓶颈
       </strong>
       ，在这里通过rps_ipi_list将数据包从一个CPU转发到另外一个CPU上，提高多核环境下的负载均衡，减少CPU之间的竞争
      </strong>
     </strong>
     。如果没有开启RPS机制，数据包会在当前CPU软中断上下文中处理NAP任务。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">napi_schedule_rps</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">softnet_data</span> <span class="token operator">*</span>sd<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">softnet_data</span> <span class="token operator">*</span>mysd <span class="token operator">=</span> <span class="token function">this_cpu_ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>softnet_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// RPS将接收的数据包调度到 不同的 CPU 进行处理</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_RPS</span></span>
<span class="token comment">//sd不等于mysd，说明要在另一个 CPU 上执行 NAPI 任务，而不是本 CPU 处理</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>sd <span class="token operator">!=</span> mysd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">//rps_ipi_list 负责存储要在其他 CPU 处理的 softnet_data 队列，并通过 NET_RX_SOFTIRQ 触发软中断来完成调度。</span>
		sd<span class="token operator">-&gt;</span>rps_ipi_next <span class="token operator">=</span> mysd<span class="token operator">-&gt;</span>rps_ipi_list<span class="token punctuation">;</span>
		mysd<span class="token operator">-&gt;</span>rps_ipi_list <span class="token operator">=</span> sd<span class="token punctuation">;</span>
		<span class="token comment">//出发软中断，处理softnet_data队列的NAPI任务</span>
		<span class="token function">__raise_softirq_irqoff</span><span class="token punctuation">(</span>NET_RX_SOFTIRQ<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token comment">//本地CPU处理</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* CONFIG_RPS */</span></span>
<span class="token comment">//直接调度 mysd-&gt;backlog 设备的 NAPI 任务，并安排 net_rx_action() 来执行数据包处理。</span>
	<span class="token function">__napi_schedule_irqoff</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mysd<span class="token operator">-&gt;</span>backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_329">
     </a>
     实践操作
    </h4>
    <p>
     Linux 中创建 veth 设备对，设备名veth，指定的虚拟网卡类型为veth，创建的另一端设备名为veth1。
    </p>
    <pre><code class="prism language-c">ip link add veth0 type veth peer name veth1
</code></pre>
    <p>
     使用
     <code>
      ip link show
     </code>
     可以看到
     <code>
      veth0
     </code>
     和
     <code>
      veth1
     </code>
     设备已创建，但还未启用。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9004d6cec9e940f2846e8da955167e10.png"/>
    </p>
    <p>
     veth设备需要配置IP地址才能进行通信，为
     <code>
      veth0
     </code>
     和
     <code>
      veth1
     </code>
     设备配置ip。
    </p>
    <pre><code class="prism language-c">sudo ip addr add <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.1</span><span class="token operator">/</span><span class="token number">24</span> dev veth0
sudo ip addr add <span class="token number">192.168</span><span class="token number">.1</span><span class="token number">.2</span><span class="token operator">/</span><span class="token number">24</span> dev veth1
</code></pre>
    <p>
     启动设备
    </p>
    <pre><code class="prism language-c">sudo ip link set veth1 up
sudo ip link set veth0 up
</code></pre>
    <p>
     使用
     <code>
      ip link show
     </code>
     可以看到
     <code>
      veth0
     </code>
     和
     <code>
      veth1
     </code>
     设备状态已变成开启
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b347720bfa954091b2c8f3645f535da1.png"/>
    </p>
    <p>
     为了使veth设备之间能够顺利通信，需要关闭反向路径过滤（rp_filter）并设置允许接收本机数据包。root角色下修改系统配置如下：
    </p>
    <p>
     <img alt="!" src="https://i-blog.csdnimg.cn/direct/cb97242608124f7b897c0accc3ab183f.png"/>
    </p>
    <p>
     ping测试
     <code>
      veth0
     </code>
     和
     <code>
      veth1
     </code>
     设备间通信
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/3dd11655c6d342bc8726fb026d0bac08.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34383430353635342f:61727469636c652f64657461696c732f313436323032393939" class_="artid" style="display:none">
 </p>
</div>


