---
layout: post
title: "项目中通过SSH链接mysql数据库"
date: 2022-05-05 15:43:54 +0800
description: "本文章解决的问题：当你没有数据库公网权限但是拥有与该数据库内网通信的服务器的链接权限时，可通过该服务"
keywords: "微服务yml中如何通过ssh连接数据库"
categories: ['未分类']
tags: ['服务器', '数据库', 'Ssh', 'Mysql']
artid: "124590074"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=124590074
  alt: "项目中通过SSH链接mysql数据库"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=124590074
featuredImagePreview: https://bing.ee123.net/img/rand?artid=124590074
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     项目中通过SSH链接mysql数据库~
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <strong>
      本文章解决的问题
     </strong>
     ：当你没有数据库公网权限但是拥有与该数据库内网通信的服务器的链接权限时，可通过该服务器SSH跳转链接到mysql服务器，本文章是具体代码实现。
    </p>
    <p>
     1，引入jsch依赖坐标：
    </p>
    <pre><code class="prism language-java">        <span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
            <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>com<span class="token punctuation">.</span>jcraft<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>jsch<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
            <span class="token generics"><span class="token punctuation">&lt;</span>version<span class="token punctuation">&gt;</span></span><span class="token number">0.1</span><span class="token number">.53</span><span class="token operator">&lt;</span><span class="token operator">/</span>version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre>
    <p>
     2，需要添加两个配置文件：
     <br/>
     链接配置：
    </p>
    <pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>sshConfig</span><span class="token punctuation">;</span>

<span class="token comment">/\*\*

- @author liuwenpo
- @className: SSHConnection
- @description: TODO
- @date 2022/3/31
  \*/</span>

<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>jcraft<span class="token punctuation">.</span>jsch<span class="token punctuation">.</span></span><span class="token class-name">JSch</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>jcraft<span class="token punctuation">.</span>jsch<span class="token punctuation">.</span></span><span class="token class-name">Session</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SSHConnection</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 自定义的映射端口，需要和yml中的port保持一致</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token class-name">LOCAl_PORT</span> <span class="token operator">=</span> <span class="token number">3307</span><span class="token punctuation">;</span>

    <span class="token comment">// SSH远程服务器配置</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> SSH_REMOTE_SERVER <span class="token operator">=</span> <span class="token string">"被链接的服务器ip"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> SSH_REMOTE_PORT <span class="token operator">=</span> SSH远程服务器端口号<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> SSH_USER <span class="token operator">=</span> <span class="token string">"SSH远程服务器账号"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> SSH_PASSWORD <span class="token operator">=</span> <span class="token string">"SSH远程服务器密码"</span><span class="token punctuation">;</span>

    <span class="token comment">// 远程数据库配置</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> MYSQL_REMOTE_SERVER <span class="token operator">=</span> <span class="token string">"被链接的数据库ip"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">int</span> REMOTE_PORT <span class="token operator">=</span> <span class="token number">3306</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Session</span> sesion<span class="token punctuation">;</span> <span class="token comment">//represents each ssh session</span>

    <span class="token comment">// 测试连接</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SSHConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">SSHConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{<!-- --></span>

        <span class="token class-name">JSch</span> jsch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 需要用到了开启</span>
        <span class="token comment">// jsch.setKnownHosts(S_PATH_FILE_KNOWN_HOSTS);</span>
        <span class="token comment">//jsch.addIdentity(S_PATH_FILE_PRIVATE_KEY);</span>

        sesion <span class="token operator">=</span> jsch<span class="token punctuation">.</span><span class="token function">getSession</span><span class="token punctuation">(</span>SSH_USER<span class="token punctuation">,</span> SSH_REMOTE_SERVER<span class="token punctuation">,</span> SSH_REMOTE_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
        sesion<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>SSH_PASSWORD<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Properties</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"StrictHostKeyChecking"</span><span class="token punctuation">,</span> <span class="token string">"no"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sesion<span class="token punctuation">.</span><span class="token function">setConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 去连接</span>
        sesion<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//ssh connection established!</span>
        <span class="token comment">//  设置转发</span>
        sesion<span class="token punctuation">.</span><span class="token function">setPortForwardingL</span><span class="token punctuation">(</span><span class="token class-name">LOCAl_PORT</span><span class="token punctuation">,</span> MYSQL_REMOTE_SERVER<span class="token punctuation">,</span> REMOTE_PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"SSHConnection--运行OK"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">closeSSH</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        sesion<span class="token punctuation">.</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre>
<p>
监听配置：
</p>
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>demo<span class="token punctuation">.</span>sshConfig</span><span class="token punctuation">;</span>

<span class="token comment">/\*\*

- @author liuwenpo
- @className: SSHWebListener
- @description: TODO
- @date 2022/3/31
  \*/</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletContextEvent</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span></span><span class="token class-name">ServletContextListener</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">WebListener</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@WebListener</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SSHWebListener</span> <span class="token keyword">implements</span> <span class="token class-name">ServletContextListener</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">SSHConnection</span> sshConnection<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SSHWebListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextInitialized</span><span class="token punctuation">(</span><span class="token class-name">ServletContextEvent</span> arg0<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"SSHWebListener initialized ... !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            sshConnection<span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SSHConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">contextDestroyed</span><span class="token punctuation">(</span><span class="token class-name">ServletContextEvent</span> arg0<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"SSHWebListener destroyed ... !"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sshConnection<span class="token punctuation">.</span><span class="token function">closeSSH</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre>
<p>
3，yml 配置文件需要添加的配置：
</p>
<pre><code class="prism language-java">

# datasource

spring<span class="token operator">:</span>
datasource<span class="token operator">:</span>
driver<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">:</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>cj<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Driver</span>
url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span><span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span><span class="token operator">:</span><span class="token number">3307</span><span class="token operator">/</span>sshtest<span class="token operator">?</span>useUnicode<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>characterEncoding<span class="token operator">=</span>UTF<span class="token operator">-</span><span class="token number">8</span><span class="token operator">&amp;</span>autoReconnect<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>useServerPrepStmts<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>allowMultiQueries<span class="token operator">=</span><span class="token boolean">true</span><span class="token operator">&amp;</span>serverTimezone<span class="token operator">=</span><span class="token class-name">Asia</span><span class="token operator">/</span><span class="token class-name">Shanghai</span>
username<span class="token operator">:</span> root
password<span class="token operator">:</span> <span class="token number">123456</span>
</code></pre>
<p>
<strong>
注意
</strong>
：yml 中的数据库链接 ip,就用本机 ip,端口号要与 SSHConnection 配置文件中的 LOCAl_PORT 保持一致，否则无法映射链接
</p>
<p>
<strong>
原理
</strong>
：先通过本机连接到远程服务器，再通过本机的链接信息映射中转链接远程 mysql 数据库。
</p>

   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f5461697969692f:61727469636c652f64657461696c732f313234353930303734" class_="artid" style="display:none">
 </p>
</div>
