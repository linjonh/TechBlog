---
layout: post
title: "Objective-c-åˆé˜¶-Runtimeæ–¹æ³•äº¤æ¢-æ¶ˆæ¯ä¼ é€’"
date: 2025-07-14T03:16:06+0800
description: "selector å°±æ˜¯ä¸€ä¸ªå‡½æ•°åŒºåˆ†å™¨ã€‚å®ƒåªä¼šç»™è¿™ä¸ªæ–¹æ³•åä¸€ä¸ªå”¯ä¸€çš„å“ˆå¸Œå€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœåªè¦ä¸¤ä¸ªå‡½æ•°çš„æ–¹æ³•åæ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆä»–ä»¬çš„ selector çš„å“ˆå¸Œå€¼å°±æ˜¯ä¸€æ ·çš„ã€‚æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ª isa æŒ‡é’ˆã€‚å®ä¾‹å¯¹è±¡çš„ isa æŒ‡é’ˆæŒ‡å‘çš„æ˜¯è¯¥å®ä¾‹æ‰€å±çš„ç±»å¯¹è±¡ï¼Œè€Œç±»å¯¹è±¡çš„ isa æŒ‡é’ˆæŒ‡å‘å…ƒç±»å¯¹è±¡ã€‚é‚£ä¹ˆå¦‚ä½•åŒºåˆ†ç±»å¯¹è±¡å’Œå…ƒç±»å¯¹è±¡å‘¢ï¼Ÿç±»å¯¹è±¡å­˜çš„æ˜¯å®ä¾‹æ–¹æ³•ï¼Œä¸å­˜ç±»æ–¹æ³•ï¼Œè€Œå…ƒç±»å­˜çš„æ˜¯ç±»æ–¹æ³•ã€‚æ¶ˆæ¯è½¬å‘å°±æ˜¯å½“ runtime åœ¨ç»§æ‰¿é“¾ä¸­æ‰¾ä¸åˆ° selector å¯¹åº”çš„å‡½æ•°å®ç°åï¼Œå°±ä¼šè¿›è¡Œæ¶ˆæ¯è½¬å‘ï¼Œå³ç”¨å…¶ä»–å¯¹è±¡æ¥è°ƒè¿™ä¸ªæ–¹æ³•ã€‚"
keywords: "runtime æ–¹æ³•äº¤æ¢"
categories: ['æœªåˆ†ç±»']
tags: ['å¼€å‘è¯­è¨€', 'Ios', 'C']
artid: "149302631"
arturl: "https://blog.csdn.net/m0_73093743/article/details/149302631"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=149302631
    alt: "Objective-c-åˆé˜¶-Runtimeæ–¹æ³•äº¤æ¢-æ¶ˆæ¯ä¼ é€’"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=149302631
featuredImagePreview: https://bing.ee123.net/img/rand?artid=149302631
cover: https://bing.ee123.net/img/rand?artid=149302631
image: https://bing.ee123.net/img/rand?artid=149302631
img: https://bing.ee123.net/img/rand?artid=149302631
---



# Objective-c åˆé˜¶ â€”â€” Runtimeï¼ˆæ–¹æ³•äº¤æ¢ & æ¶ˆæ¯ä¼ é€’ï¼‰

## ä¸€ã€æ¶ˆæ¯ä¼ é€’

### 1ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯

```

[a func1];
```

æˆ‘ä»¬ä¼šæŠŠè¿™ç§ç”¨æ–¹æ‹¬å·æ¥è°ƒå‡½æ•°çš„æ–¹å¼ç§°ä¸ºå‘æ¶ˆæ¯ã€‚å¯¹äºè¿™ä¸ªä¾‹å­ï¼Œå°±ç›¸å½“äºæˆ‘ä»¬ç»™ a è¿™ä¸ªå¯¹è±¡å‘äº†ä¸ª func1 çš„æ¶ˆæ¯ï¼ˆä¸ªäººè®¤ä¸ºæŒ‡ä»¤æ›´å¥½ç†è§£ï¼‰ã€‚

### 2ã€ä»€ä¹ˆæ˜¯ selector

selector å°±æ˜¯ä¸€ä¸ªå‡½æ•°åŒºåˆ†å™¨ã€‚å®ƒåªä¼šç»™è¿™ä¸ªæ–¹æ³•åä¸€ä¸ªå”¯ä¸€çš„å“ˆå¸Œå€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœåªè¦ä¸¤ä¸ªå‡½æ•°çš„æ–¹æ³•åæ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆä»–ä»¬çš„ selector çš„å“ˆå¸Œå€¼å°±æ˜¯ä¸€æ ·çš„ã€‚

### 3ã€ä»€ä¹ˆæ˜¯ isa æŒ‡é’ˆ

æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ª isa æŒ‡é’ˆã€‚

å®ä¾‹å¯¹è±¡çš„Â isa æŒ‡é’ˆæŒ‡å‘çš„æ˜¯è¯¥å®ä¾‹æ‰€å±çš„ç±»å¯¹è±¡ï¼Œè€Œç±»å¯¹è±¡çš„ isa æŒ‡é’ˆæŒ‡å‘å…ƒç±»å¯¹è±¡ã€‚

é‚£ä¹ˆå¦‚ä½•åŒºåˆ†ç±»å¯¹è±¡å’Œå…ƒç±»å¯¹è±¡å‘¢ï¼Ÿç±»å¯¹è±¡å­˜çš„æ˜¯å®ä¾‹æ–¹æ³•ï¼Œä¸å­˜ç±»æ–¹æ³•ï¼Œè€Œå…ƒç±»å­˜çš„æ˜¯ç±»æ–¹æ³•ã€‚

![](https://i-blog.csdnimg.cn/direct/185f439bb6c24fe9a5c840d63c349b52.png)

### 4ã€æ¶ˆæ¯ä¼ é€’è¿‡ç¨‹

![](https://i-blog.csdnimg.cn/direct/1a37bc685e1446d5aae5ae2bc69d2b62.png)

1. å½“ä¸€ä¸ªæ–¹æ³•è¦ä¼ ç»™ä¸€ä¸ªå®ä¾‹å¯¹è±¡ï¼Œé‚£ä¹ˆ runtime ç³»ç»Ÿå°±ä¼šé€šè¿‡è¿™ä¸ªå®ä¾‹å¯¹è±¡çš„ isa æŒ‡é’ˆæ‰¾åˆ°è¯¥å¯¹è±¡å±äºå“ªä¸ªç±»å¯¹è±¡

2. åœ¨è¿™ä¸ªç±»å¯¹è±¡é‡Œçš„ dispatch table æ‰¾æœ‰æ²¡æœ‰ç¬¦åˆå½“å‰ selector çš„å‡½æ•°å®ç°

3. å¦‚æœæœ‰ï¼Œç›´æ¥è°ƒç”¨ã€‚

4. å¦‚æœæ²¡æœ‰ï¼Œå°±ä¸æ–­åœ°æ²¿ç€è¿™ä¸ªç±»å¯¹è±¡çš„ superclass æŒ‡é’ˆä¸€è·¯æ²¿ç€ç»§æ‰¿é“¾å‘ä¸Šæ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ç¬¦åˆçš„å‡½æ•°å®ç°æˆ–æ‰¾åˆ° NSObject ç±»ã€‚

5. å¦‚æœç›´åˆ° NSObject ç±»éƒ½æ²¡æ‰¾åˆ°ï¼Œå°±è¿›å…¥â€œæ¶ˆæ¯è½¬å‘â€çš„ç¯èŠ‚ã€‚

> æ ¹æ® selector æ‰¾å¯¹åº”çš„å‡½æ•°å®ç°ï¼Œruntime åšäº†ä¸€ä¸ªå°å°çš„ä¼˜åŒ–ã€‚å°±æ˜¯ç»™æ¯ä¸ªç±»å¯¹è±¡ä¸€ä¸ªç¼“å­˜ã€‚è¿™ä¸ªç¼“å­˜å­˜çš„æ˜¯åœ¨è¯¥ç±»æ‰¾è¿‡çš„å®ä¾‹æ–¹æ³•å®ç°å’Œè¯¥ç±»é€šè¿‡ç»§æ‰¿å¾—æ¥çš„å‡½æ•°å®ç°çš„åœ°å€ã€‚äºæ˜¯åœ¨æ‰¾å‡½æ•°å®ç°æ—¶ï¼Œruntime ä¼šå…ˆåœ¨è¿™ä¸ªç±»çš„ç¼“å­˜é‡Œæ‰¾ã€‚å¦‚æœæ²¡æ‰¾åˆ°æ‰å»è¿™ä¸ªç±»çš„ dispatch table é‡Œæ‰¾ï¼›å†æ‰¾ä¸åˆ°å°±æ²¿ç€ç»§æ‰¿é“¾å¾€ä¸Šæ‰¾ã€‚

## äºŒã€æ¶ˆæ¯è½¬å‘çš„è¿‡ç¨‹

### 1ã€ä»€ä¹ˆæ˜¯æ¶ˆæ¯è½¬å‘

æ¶ˆæ¯è½¬å‘å°±æ˜¯å½“ runtime åœ¨ç»§æ‰¿é“¾ä¸­æ‰¾ä¸åˆ° selector å¯¹åº”çš„å‡½æ•°å®ç°åï¼Œå°±ä¼šè¿›è¡Œæ¶ˆæ¯è½¬å‘ï¼Œå³ç”¨å…¶ä»–å¯¹è±¡æ¥è°ƒè¿™ä¸ªæ–¹æ³•ã€‚å¦‚æœæ²¡æœ‰å…¶ä»–ç±»èƒ½æˆåŠŸè°ƒç”¨è¿™ä¸ªæ–¹æ³•ï¼Œæ‰ä¼šæŠ¥é”™ã€‚æ‰€ä»¥å¯ä»¥ç†è§£æˆæ¶ˆæ¯è½¬å‘å°±æ˜¯æŠ¥é”™å‰çš„æœ€åä¸€é“é˜²çº¿ã€‚

### 2ã€æ¶ˆæ¯è½¬å‘çš„è¿‡ç¨‹

![](https://i-blog.csdnimg.cn/direct/d90a8f30768f4d0d931cc1d0e4b949ed.png)

#### 2.1. åŠ¨æ€æ–¹æ³•è§£æï¼ˆresolveInstanceMethod:ï¼‰

```

+ (BOOL)resolveInstanceMethod:(SEL)selector //å®ä¾‹å¯¹è±¡çš„åŠ¨æ€æ–¹æ³•è§£æè°ƒ

+ (BOOL)resolveClassMethod:(SEL)selector //ç±»å¯¹è±¡çš„åŠ¨æ€æ–¹æ³•è§£æè°ƒ
```

```

@implementation Person

// åŠ¨æ€æ–¹æ³•è§£æå…¥å£ï¼šå½“æ‰¾ä¸åˆ°å®ä¾‹æ–¹æ³• sayHello æ—¶ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•
+ (BOOL)resolveInstanceMethod:(SEL)sel {
    if (sel == @selector(sayHello)) {
        // ä½¿ç”¨ class_addMethod åŠ¨æ€æ·»åŠ æ–¹æ³•å®ç°
        class_addMethod(self, sel, (IMP)dynamicSayHello, "v@:");
        return YES;
    }
    return [super resolveInstanceMethod:sel];
}

// åŠ¨æ€æ·»åŠ çš„æ–¹æ³•å®ç°
void dynamicSayHello(id self, SEL _cmd) {
    NSLog(@"Hello from dynamic method!");
}

@end
```

Â å…¶ä¸­ selector æ˜¯æœªå¤„ç†çš„æ–¹æ³•ã€‚Â è¿”å›å€¼è¡¨ç¤ºèƒ½å¦æ–°å¢ä¸€ä¸ªæ–¹æ³•æ¥å¤„ç†ã€‚å¦‚æœå¯ä»¥ï¼Œè¿”å› YESï¼›å¦åˆ™å°±çœ‹çœ‹åŸºç±»èƒ½ä¸èƒ½å¤„ç†è¿™ä¸ª selectorã€‚

#### 2.2. å¤‡ç”¨æ¥æ”¶è€…

```

- (id)forwardingTargetForSelector:(SEL)aSelector;
```

```

// å¤‡ç”¨æ¥æ”¶è€…ç±»
@interface BackupHandler : NSObject
- (void)sayHello;
@end

@implementation BackupHandler
- (void)sayHello {
    NSLog(@"ğŸ‘‰ BackupHandler æ”¶åˆ°äº† sayHello æ¶ˆæ¯ï¼");
}
@end

// åŸå§‹ç±»ï¼šæ²¡æœ‰å®ç° sayHelloï¼Œä½†å¯ä»¥è½¬å‘ç»™ backup
@interface MainObject : NSObject
@property (nonatomic, strong) BackupHandler *backup;
@end

@implementation MainObject

// å¿«é€Ÿæ¶ˆæ¯è½¬å‘ï¼šè¿”å›å¤‡ç”¨æ¥æ”¶è€…
- (id)forwardingTargetForSelector:(SEL)aSelector {
    if (aSelector == @selector(sayHello)) {
        return self.backup; // è½¬å‘ç»™å¤‡ç”¨å¯¹è±¡
    }
    return [super forwardingTargetForSelector:aSelector];
}

@end
```

Â è¿™é‡Œ selector ä¹Ÿæ˜¯æœªå¤„ç†çš„æ–¹æ³•ã€‚è¿”å›å€¼ä¸ºå½“å‰æ‰¾åˆ°çš„å¤‡æ´æ¥å—è€…ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›nilï¼Œè¿›å…¥ä¸‹ä¸€é˜¶æ®µã€‚

#### 2.3. å®Œæ•´æ¶ˆæ¯è½¬å‘

```

- (void)forwardInvocation:(NSInvocation *)anInvocation;
```

```

// ç›®æ ‡å¤„ç†è€…ç±»
@interface RealHandler : NSObject
- (void)sayHello;
@end

@implementation RealHandler
- (void)sayHello {
    NSLog(@"âœ… RealHandler å¤„ç†äº† sayHello æ–¹æ³•ï¼");
}
@end

// åŸå§‹ç±»ï¼šå®Œå…¨ä¸å®ç° sayHello
@interface MainObject : NSObject
@property (nonatomic, strong) RealHandler *handler;
@end

@implementation MainObject

// ç¬¬ä¸€æ­¥ï¼šæä¾›æ–¹æ³•ç­¾åï¼Œå‘Šè¯‰ runtime æ–¹æ³•æ˜¯æ€æ ·çš„
- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector {
    if (aSelector == @selector(sayHello)) {
        // v@: â†’ è¿”å› void, å‚æ•°æ˜¯ self å’Œ _cmd
        return [NSMethodSignature signatureWithObjCTypes:"v@:"];
    }
    return [super methodSignatureForSelector:aSelector];
}

// ç¬¬äºŒæ­¥ï¼šæ”¶åˆ°å®Œæ•´è°ƒç”¨å¯¹è±¡ï¼Œè‡ªå·±å†³å®šæ€ä¹ˆå¤„ç†
- (void)forwardInvocation:(NSInvocation *)anInvocation {
    SEL sel = [anInvocation selector];
    if ([self.handler respondsToSelector:sel]) {
        [anInvocation invokeWithTarget:self.handler]; // æ‰‹åŠ¨è½¬å‘
    } else {
        [super forwardInvocation:anInvocation]; // æ²¡æ³•å¤„ç†å°±å´©æºƒ
    }
}

@end
```

Â å…¶ä¸­ anInvocation é‡Œé¢æœ‰åŸæ¥æ¶ˆæ¯çš„æ¥æ”¶è€…ã€selectorÂ ã€å…¨éƒ¨å®å‚ã€è¿”å›å€¼ã€‚

#### 2.4. æŠ¥é”™ä¸­æ–­

## ä¸‰ã€æ–¹æ³•äº¤æ¢

### 1ã€dispatch table

![](https://i-blog.csdnimg.cn/direct/1a37bc685e1446d5aae5ae2bc69d2b62.png)

æ¯ä¸ªç±»ç»“æ„éƒ½åŒ…æ‹¬ä»¥ä¸‹ä¸¤ä¸ªåŸºæœ¬å…ƒç´ ï¼šæŒ‡å‘åŸºç±»çš„æŒ‡é’ˆ & dispatch tableã€‚å…¶ä¸­ dispatch table å°±æ˜¯ä¸€ä¸ª 2 åˆ—çš„å‡½æ•°è¡¨ï¼Œå·¦è¾¹æ˜¯æŸä¸ªå‡½æ•°çš„Â selectorï¼Œå³è¾¹æ˜¯è¿™ä¸ªå‡½æ•°çš„å…·ä½“å®ç°çš„åœ°å€ã€‚

### 2ã€æ–¹æ³•äº¤æ¢

æœ¬è´¨å°±æ˜¯æŠŠ dispatch table é‡Œçš„ä¸¤ä¸ª address çš„å€¼äº¤æ¢ã€‚



