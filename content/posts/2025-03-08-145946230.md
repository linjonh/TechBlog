---
layout: post
title: "swift-5-汇编分析结构体类的内存布局"
date: 2025-03-08 16:01:32 +0800
description: "在 Swift 标准库中，绝大多数的公开类型都是结构体，而枚举和类只占很小一部分比如BoolIntDoubleStringArrayDictionary等常见类型都是结构体所有的结构体都有一个编译器自动生成的初始化器（ initializer ，初始化方法、构造器、构造方法）在第⑥行调用的，可以传入所有成员值，用以初始化所有成员（存储属性，StoredProperty。"
keywords: "swift -(5) 汇编分析结构体、类的内存布局"
categories: ['未分类']
tags: ['汇编']
artid: "145946230"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145946230
    alt: "swift-5-汇编分析结构体类的内存布局"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145946230
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145946230
cover: https://bing.ee123.net/img/rand?artid=145946230
image: https://bing.ee123.net/img/rand?artid=145946230
img: https://bing.ee123.net/img/rand?artid=145946230
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     swift -(5) 汇编分析结构体、类的内存布局
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h2>
     一、结构体
    </h2>
    <blockquote>
     <p style="margin-left:.0001pt; margin-right:0; text-align:left">
      <span style="color:#000000">
       <span style="color:#595959">
        在 Swift 标准库中，绝大多数的公开类型都是结构体，而枚举和类只占很小一部分
       </span>
      </span>
     </p>
     <p style="margin-left:.0001pt; margin-right:0; text-align:left">
      <span style="color:#000000">
       <span style="color:#595959">
        比如
       </span>
       <span style="color:#5c2699">
        Bool
       </span>
       <span style="color:#595959">
        、
       </span>
       <span style="color:#5c2699">
        Int
       </span>
       <span style="color:#595959">
        、
       </span>
       <span style="color:#5c2699">
        Double
       </span>
       <span style="color:#595959">
        、
       </span>
       <span style="color:#5c2699">
        String
       </span>
       <span style="color:#595959">
        、
       </span>
       <span style="color:#5c2699">
        Array
       </span>
       <span style="color:#595959">
        、
       </span>
       <span style="color:#5c2699">
        Dictionary
       </span>
       <span style="color:#595959">
        等常见类型都是结构体
       </span>
      </span>
     </p>
    </blockquote>
    <pre><code class="language-Swift">①  struct Date {
②         var year: Int
③         var month: Int
④         var day: Int ⑤  }
⑥  var date = Date(year: 2019, month: 6, day: 23)</code></pre>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     <span style="color:#000000">
      <span style="color:#595959">
       所有的结构体都有一个编译器自动生成的初始化器（ initializer ，初始化方法、构造器、构造方法）
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     <span style="color:#000000">
      <span style="color:#595959">
       在第⑥行调用的，可以传入所有成员值，用以初始化所有成员（存储属性，Stored
      </span>
      <span style="color:#595959">
       Property
      </span>
      <span style="color:#595959">
       ）
      </span>
     </span>
    </p>
    <h2>
     二、结构体的初始化器
    </h2>
    <blockquote>
     <p>
      编译器会根据情况，可能会为结构体生成多个初始化器，宗旨是：保证所有成员都有初始值
     </p>
    </blockquote>
    <p>
     <img alt="" height="1218" src="https://i-blog.csdnimg.cn/direct/070c316969a84e83bd04cabbedb12541.png" width="2964"/>
    </p>
    <p>
     从这列子中可以看出，编译器最终选择什么初始化器和结构体原始定义有没有赋默认值有关，编译器选择的初始化器会保证所有成员都有初始值；
    </p>
    <h2>
     三、这
     <span style="color:#000000">
      <strong>
       <span style="color:#404040">
        <strong>
         能编译通过么
        </strong>
       </span>
      </strong>
     </span>
    </h2>
    <pre><code class="language-Swift">struct Point {  var x: Int? var y: Int?
}
var p1 = Point(x: 10, y: 10)
var p2 = Point(y: 10)
var p3 = Point(x: 10)
var p4 = Point()</code></pre>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     <span style="color:#000000">
      <span style="color:#595959">
       根据编译器初使化饿的本质
      </span>
     </span>
     保证所有成员都有初始值
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     <span style="color:#000000">
      <span style="color:#595959">
       可选项都有个默认值
      </span>
      <span style="color:#b40062">
       nil
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     <span style="color:#000000">
      <span style="color:#595959">
       因此可以编译通过
      </span>
     </span>
    </p>
    <h2 style="margin-left:0.0001pt; margin-right:0px; text-align:left">
     <span style="color:#000000">
      <span style="color:#595959">
       四、
      </span>
     </span>
     <span style="color:#000000">
      <strong>
       <span style="color:#404040">
        <strong>
         自定义初始化器
        </strong>
       </span>
      </strong>
     </span>
    </h2>
    <blockquote>
     <p style="margin-left:.0001pt; margin-right:0; text-align:left">
      <span style="color:#000000">
       注：
       <span style="color:#595959">
        一旦在定义结构体时自定义了初始化器，编译器就不会再帮它自动生
       </span>
       <span style="color:#595959">
        成其他初始化器
       </span>
      </span>
     </p>
    </blockquote>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     <span style="color:#595959">
      因此下边的代码后边三句会拨错
     </span>
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
    </p>
    <h2 style="margin-left:0.0001pt; margin-right:0px; text-align:left">
     <img alt="" height="888" src="https://i-blog.csdnimg.cn/direct/010996021c664228aea9314bafb74bf0.png" width="1184"/>
    </h2>
    <h2 style="margin-left:0.0001pt; margin-right:0px; text-align:left">
     五、
     <span style="color:#000000">
      <strong>
       <span style="color:#404040">
        <strong>
         窥探初始化器的本质分析自定义
        </strong>
       </span>
      </strong>
      <span style="color:#595959">
       初始化器
      </span>
      <strong>
       <span style="color:#404040">
        <strong>
         和编译器会我们生成的
        </strong>
       </span>
      </strong>
      <span style="color:#595959">
       初始化器是一样的么
      </span>
     </span>
    </h2>
    <p>
    </p>
    <pre><code class="language-Swift">第一句 编译器的初始化qi
struct Point {
var x: Int = 0 var
y: Int = 0
}
var p = Point()

第二句  自己的初始化qi
struct Point { 
var x: Int 
var y: Int
init() {  
x = 0 
y = 0
   }
}
var p = Point()</code></pre>
    <h2 style="margin-left:0.0001pt; margin-right:0px; text-align:left">
     <img alt="" height="636" src="https://i-blog.csdnimg.cn/direct/6fdb042225cd487eacd2616bf7c5e0e4.png" width="1870">
      <br/>
      <img alt="" height="458" src="https://i-blog.csdnimg.cn/direct/0d1e9dc8cff94224ac50363973b63742.png" width="1544"/>
     </img>
    </h2>
    <p>
     通过上面的汇编指令可以看出 编译器自己调用的初始化qi和我们自己写的初始化qi其实是一样的
    </p>
    <h2>
     六、结构体占用内存大小
    </h2>
    <p>
     <img alt="" height="974" src="https://i-blog.csdnimg.cn/direct/cb1846e797f0427d8872bd4eb7bda448.png" width="1948"/>
    </p>
    <h2>
     七、
     <span style="color:#000000">
      <strong>
       <span style="color:#404040">
        <strong>
         类
        </strong>
       </span>
      </strong>
     </span>
    </h2>
    <blockquote>
     <p style="margin-left:.0001pt; margin-right:0; text-align:left">
      <span style="color:#000000">
       <span style="color:#595959">
        类的定义和结构体类似，但编译器并没有为类自动生成可以传
       </span>
       <span style="color:#595959">
        入成员值的初始化器
       </span>
      </span>
     </p>
    </blockquote>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     <img alt="" height="1026" src="https://i-blog.csdnimg.cn/direct/6d76b33e003543bf97d3162dc48c998f.png" width="2514"/>
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     如何里面的x和y 没有初使值，你调用无参会报错，因为你的对象创建完成后，你里面的x和y成员没有值是不安全的
    </p>
    <blockquote>
     <p style="margin-left:.0001pt; margin-right:0; text-align:left">
      <span style="color:#000000">
       <span style="color:#595959">
        如果类的所有成员都在定义的时候指定了初始值，编译器会为类生成无
       </span>
       <span style="color:#595959">
        参的初始化器；
       </span>
      </span>
     </p>
     <p style="margin-left:.0001pt; margin-right:0; text-align:left">
      <span style="color:#000000">
       <span style="color:#595959">
        成员的初始化是在这个初始化器中完成的
       </span>
      </span>
     </p>
    </blockquote>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     <img alt="" height="938" src="https://i-blog.csdnimg.cn/direct/1908626559514ce5a7a1c8c9dbb5af8a.png" width="1744"/>
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
    </p>
    <h2 style="margin-left:0.0001pt; margin-right:0px; text-align:left">
     八、
     <span style="color:#000000">
      <strong>
       <span style="color:#404040">
        <strong>
         结构体与类的本质区别
        </strong>
       </span>
      </strong>
     </span>
    </h2>
    <p>
     <span style="color:#000000">
      <span style="color:#595959">
       结构体是值类型（枚举也是值类型），类是引用类型（指针类型）
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     <img alt="" height="1056" src="https://i-blog.csdnimg.cn/direct/482eed0eb0c94d3193a442c23e35b6f5.png" width="2962"/>
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     <img alt="" height="1612" src="https://i-blog.csdnimg.cn/direct/7fa8a2c34386482c87f50565a7af3abf.png" width="1958"/>
    </p>
    <h2 style="margin-left:0.0001pt; margin-right:0px; text-align:left">
     九、
     <strong>
      <span style="color:#404040">
       <strong>
        值类型 的深拷贝
       </strong>
      </span>
     </strong>
    </h2>
    <blockquote>
     <p>
     </p>
     <p style="margin-left:.0001pt; margin-right:0; text-align:left">
      <span style="color:#000000">
       <span style="color:#595959">
        值类型赋值给
       </span>
       <span style="color:#b40062">
        var
       </span>
       <span style="color:#595959">
        、
       </span>
       <span style="color:#b40062">
        let
       </span>
       <span style="color:#595959">
        或者给函数传参，是直接将所有内容拷
       </span>
       <span style="color:#595959">
        贝一份
       </span>
      </span>
     </p>
     <p style="margin-left:.0001pt; margin-right:0; text-align:left">
      <span style="color:#000000">
       <span style="color:#595959">
        类似于对文件进行
       </span>
       <span style="color:#595959">
        copy
       </span>
       <span style="color:#595959">
        、
       </span>
       <span style="color:#595959">
        paste
       </span>
       <span style="color:#595959">
        操作，产生了全新的文件副本。属于深拷贝（
       </span>
       <span style="color:#595959">
        deep
       </span>
       <span style="color:#595959">
        copy
       </span>
       <span style="color:#595959">
        ）
       </span>
      </span>
     </p>
    </blockquote>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     <img alt="" height="1076" src="https://i-blog.csdnimg.cn/direct/3ccc3e865b9e4247a409c5923d2d6a6d.png" width="2034"/>
    </p>
    <pre><code class="language-Swift">p2.x = 11 p2.y = 22
// 请问p1.x和p1.y是多少？

依然是原来的10和20</code></pre>
    <h2>
     十 、
     <span style="color:#000000">
      <strong>
       <span style="color:#404040">
        <strong>
         值类型的赋值操作
        </strong>
       </span>
      </strong>
     </span>
    </h2>
    <blockquote>
     <p style="margin-left:.0001pt; margin-right:0; text-align:left">
      <span style="color:#000000">
       <span style="color:#595959">
        在Swift标准库中，为了提升性能，
       </span>
       <span style="color:#5c2699">
        String
       </span>
       <span style="color:#595959">
        、
       </span>
       <span style="color:#5c2699">
        Array
       </span>
       <span style="color:#595959">
        、
       </span>
       <span style="color:#5c2699">
        Dictionary
       </span>
       <span style="color:#595959">
        、
       </span>
       <span style="color:#5c2699">
        Set
       </span>
       <span style="color:#595959">
        采取了Copy On Write的技术
       </span>
      </span>
      <span style="color:#000000">
       <span style="color:#595959">
        比如仅当有“写”操作时，才会真正执行拷贝操作
       </span>
      </span>
     </p>
     <p style="margin-left:.0001pt; margin-right:0; text-align:left">
      <span style="color:#000000">
       <span style="color:#595959">
        对于标准库值类型的赋值操作，
       </span>
       <span style="color:#595959">
        Swift 能确保最佳性能，所有没必要为了保证最佳性能来避免赋值
       </span>
      </span>
     </p>
     <p style="margin-left:.0001pt; margin-right:0; text-align:left">
      <span style="color:#000000">
       <span style="color:#595959">
        建议
       </span>
       <span style="color:#595959">
        ：不需要修改的，尽量定义成
       </span>
       <span style="color:#b40062">
        let
       </span>
      </span>
     </p>
    </blockquote>
    <p>
     <img alt="" height="990" src="https://i-blog.csdnimg.cn/direct/59ef5690afd64484b3591967db2bb19e.png" width="1924"/>
    </p>
    <p>
     <span style="color:#000000">
      <span style="color:#595959">
       为了提升性能，
      </span>
      <span style="color:#5c2699">
       String
      </span>
      <span style="color:#595959">
       、
      </span>
      <span style="color:#5c2699">
       Array
      </span>
      <span style="color:#595959">
       、
      </span>
      <span style="color:#5c2699">
       Dictionary
      </span>
      <span style="color:#595959">
       、
      </span>
      <span style="color:#5c2699">
       Set
      </span>
      <span style="color:#595959">
       采取了Copy On Write的
      </span>
     </span>
    </p>
    <p style="margin-left:7.8500pt; margin-right:107.7000pt">
     <span style="color:#b40062">
      var
     </span>
     <span style="color:#0f68a0">
      s1
     </span>
     <span style="color:#000000">
      =
     </span>
     <span style="color:#ba0011">
      "Jack"
     </span>
     <span style="color:#b40062">
      var
     </span>
     <span style="color:#0f68a0">
      s2
     </span>
     <span style="color:#000000">
      =
     </span>
     <span style="color:#448993">
      s1
     </span>
    </p>
    <p style="margin-left:7.8500pt; margin-right:107.7000pt">
     <span style="color:#448993">
      如有了这句才会有深拷贝，在之前没有发生写操作，直接就是浅拷贝
     </span>
    </p>
    <p style="margin-left:8.7000pt">
     <span style="color:#448993">
      s2
     </span>
     <span style="color:#000000">
      .
     </span>
     <span style="color:#2e0d6e">
      append
     </span>
     <span style="color:#000000">
      (
     </span>
     <span style="color:#ba0011">
      "_
     </span>
     <span style="color:#ba0011">
      Rose
     </span>
     <span style="color:#ba0011">
      "
     </span>
     <span style="color:#000000">
      )
     </span>
    </p>
    <p style="margin-left:8.5500pt">
     <span style="color:#2e0d6e">
      print
     </span>
     <span style="color:#000000">
      (
     </span>
     <span style="color:#448993">
      s1
     </span>
     <span style="color:#000000">
      )
     </span>
     <span style="color:#1d8519">
      //
     </span>
     <span style="color:#1d8519">
      Jack
     </span>
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     <span style="color:#000000">
      <span style="color:#2e0d6e">
       print
      </span>
      <span style="color:#000000">
       (
      </span>
      <span style="color:#448993">
       s2
      </span>
      <span style="color:#000000">
       )
      </span>
      <span style="color:#1d8519">
       //
      </span>
      <span style="color:#1d8519">
       Jack_Rose
      </span>
     </span>
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     <img alt="" height="798" src="https://i-blog.csdnimg.cn/direct/05de6bb4499740cab3e312cc90dec71b.png" width="1720"/>
    </p>
    <h2>
    </h2>
    <h2>
     十一、
     <span style="color:#000000">
      <strong>
       <span style="color:#404040">
        <strong>
         引用类型的赋值
        </strong>
       </span>
      </strong>
     </span>
    </h2>
    <p>
     <img alt="" height="1350" src="https://i-blog.csdnimg.cn/direct/362e8001afa64f658fb1944eabac29d7.png" width="2954"/>
    </p>
    <p style="margin-left:8.5000pt; margin-right:159.7000pt">
     <span style="color:#000000">
      s2.
     </span>
     <span style="color:#448993">
      width
     </span>
     <span style="color:#000000">
      =
     </span>
     <span style="color:#000bff">
      11
     </span>
     <span style="color:#000000">
      s2.
     </span>
     <span style="color:#448993">
      height
     </span>
     <span style="color:#000000">
      =
     </span>
     <span style="color:#000bff">
      22
     </span>
    </p>
    <p style="margin-left:.0001pt; margin-right:0; text-align:left">
     <span style="color:#000000">
      <span style="color:#1d8519">
       //
      </span>
      <span style="color:#1d8519">
       请问
      </span>
      <span style="color:#1d8519">
       s1.width
      </span>
      <span style="color:#1d8519">
       和
      </span>
      <span style="color:#1d8519">
       s1.height
      </span>
      <span style="color:#1d8519">
       是多少 11 22
      </span>
     </span>
    </p>
    <h2 style="margin-left:0.0001pt; margin-right:0px; text-align:left">
     十二、堆空间内存占用情况
    </h2>
    <pre><code class="language-Swift">class Point  {
var x = 11
var test = true 
var y = 22
}
var p = Point()
class_getInstanceSize(type(of: p)) // 40
class_getInstanceSize(Point.self) // 40

内存地址的前16字节存的是p的地址，堆空间会检查是不是16的倍数，对空间内存对其是48
根据内存对其 分配40哥字节，内存地址按8对其，实际用到的是16+8+8+3 =33
</code></pre>
    <h2>
     总结-汇编内存存值总结 5  1.30
    </h2>
    <blockquote>
     <p>
      内存地址格式为：0x4bdc(%rip) ，一般是全局变量 ，全局区（数据段）
     </p>
     <p>
      内存地址格式为：-0x78(%rbp) ，一般是局部变量 ，栈空间
     </p>
     <p>
      内存地址格式为：0x10(%rax) ，一般是堆空间
     </p>
    </blockquote>
    <p>
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f36313136343033382f:61727469636c652f64657461696c732f313435393436323330" class_="artid" style="display:none">
 </p>
</div>


