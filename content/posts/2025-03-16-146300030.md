---
layout: post
title: "使用python反射,实现pytest读取yaml并发送请求"
date: 2025-03-16 19:42:27 +0800
description: "【代码】使用python反射，实现pytest读取yaml并发送请求。"
keywords: "使用python反射，实现pytest读取yaml并发送请求"
categories: ['Python']
tags: ['Python', 'Pytest']
artid: "146300030"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146300030
    alt: "使用python反射,实现pytest读取yaml并发送请求"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146300030
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146300030
cover: https://bing.ee123.net/img/rand?artid=146300030
image: https://bing.ee123.net/img/rand?artid=146300030
img: https://bing.ee123.net/img/rand?artid=146300030
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     使用python反射，实现pytest读取yaml并发送请求
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="pytest__yaml_0">
     </a>
     pytest + yaml
    </h2>
    <h3>
     <a id="yaml_1">
     </a>
     yaml
    </h3>
    <pre><code class="prism language-yaml"><span class="token punctuation">-</span> <span class="token key atrule">feature</span><span class="token punctuation">:</span> 用户模块
  <span class="token key atrule">story</span><span class="token punctuation">:</span> 登录
  <span class="token key atrule">title</span><span class="token punctuation">:</span> 添加用户
  <span class="token key atrule">request</span><span class="token punctuation">:</span>
    <span class="token key atrule">method</span><span class="token punctuation">:</span> POST
    <span class="token key atrule">url</span><span class="token punctuation">:</span> /system/user/list
    <span class="token key atrule">headers</span><span class="token punctuation">:</span> <span class="token null important">null</span>
    <span class="token key atrule">params</span><span class="token punctuation">:</span> <span class="token null important">null</span>
  <span class="token key atrule">validate</span><span class="token punctuation">:</span> <span class="token null important">null</span>
</code></pre>
    <h3>
     <a id="read_yaml_all_13">
     </a>
     read_yaml_all
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">read_yaml_all</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        value <span class="token operator">=</span> yaml<span class="token punctuation">.</span>safe_load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
        <span class="token keyword">return</span> value
</code></pre>
    <h3>
     <a id="dataclasspy_20">
     </a>
     dataclass.py
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass


<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">CaseInfo</span><span class="token punctuation">:</span>
    feature<span class="token punctuation">:</span> <span class="token builtin">str</span>
    story<span class="token punctuation">:</span> <span class="token builtin">str</span>
    title<span class="token punctuation">:</span> <span class="token builtin">str</span>
    request<span class="token punctuation">:</span> <span class="token builtin">dict</span>
    validate<span class="token punctuation">:</span> <span class="token builtin">dict</span>


<span class="token keyword">def</span> <span class="token function">verify_yaml</span><span class="token punctuation">(</span>case_info<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    通过解包的方式，校验yaml格式是否正确
    :param case_info:
    :return:
    """</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token keyword">case</span> <span class="token operator">=</span> CaseInfo<span class="token punctuation">(</span><span class="token operator">**</span>case_info<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">case</span>
    <span class="token keyword">except</span> Exception<span class="token punctuation">:</span>
        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"YAML测试用例不符合规范！"</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="test_yaml_classpy_46">
     </a>
     test_yaml_class.py
    </h3>
    <pre><code class="prism language-python">
<span class="token keyword">from</span> pathlib <span class="token keyword">import</span> Path

<span class="token keyword">import</span> pytest

<span class="token keyword">from</span> lib <span class="token keyword">import</span> read_yaml_all<span class="token punctuation">,</span> verify_yaml


<span class="token keyword">class</span> <span class="token class-name">TestYamlCases</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>


<span class="token keyword">def</span> <span class="token function">create_case_by_yaml</span><span class="token punctuation">(</span>yaml_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 读取yaml</span>
    <span class="token decorator annotation punctuation">@pytest<span class="token punctuation">.</span>mark<span class="token punctuation">.</span>parametrize</span><span class="token punctuation">(</span><span class="token string">'case'</span><span class="token punctuation">,</span> read_yaml_all<span class="token punctuation">(</span>yaml_path<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">yaml_function</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> session<span class="token punctuation">,</span> <span class="token keyword">case</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        :param self: TestYamlCases类对象
        :param session: 夹具
        :param case: 参数化
        :return:
        """</span>
        <span class="token comment"># 校验yaml格式是否与数据类字段一致</span>
        case_info <span class="token operator">=</span> verify_yaml<span class="token punctuation">(</span><span class="token keyword">case</span><span class="token punctuation">)</span>
        <span class="token comment"># 发送请求</span>
        session<span class="token punctuation">.</span>request<span class="token punctuation">(</span><span class="token operator">**</span>case_info<span class="token punctuation">.</span>request<span class="token punctuation">)</span>
    <span class="token comment"># return方法与def平级，切记</span>
    <span class="token keyword">return</span> yaml_function


test_case_yaml_paths <span class="token operator">=</span> Path<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">.</span>parent
case_yaml_list <span class="token operator">=</span> test_case_yaml_paths<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">"**/*.yaml"</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> yaml_file <span class="token keyword">in</span> case_yaml_list<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>yaml_file<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>yaml_file<span class="token punctuation">.</span>stem<span class="token punctuation">)</span>
    <span class="token comment"># python 反射，通过反射的方式将pytest的测试用例传入TestYamlCases中</span>
    <span class="token builtin">setattr</span><span class="token punctuation">(</span>TestYamlCases<span class="token punctuation">,</span> <span class="token string">"test_"</span> <span class="token operator">+</span> yaml_file<span class="token punctuation">.</span>stem<span class="token punctuation">,</span> create_case_by_yaml<span class="token punctuation">(</span>yaml_file<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre>
    <h3>
     <a id="_88">
     </a>
     成功
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d25935893cdb48f7b7c7aec0881c97c6.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33333138313239322f:61727469636c652f64657461696c732f313436333030303330" class_="artid" style="display:none">
 </p>
</div>


