---
layout: post
title: "MySQL-æŠ€æœ¯æµ…æèšç°‡ç´¢å¼•UndoLogRedoLogMVCC"
date: 2025-03-11 03:36:30 +0800
description: "InnoDB ä¸­ï¼Œèšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ç›´æ¥å­˜å‚¨ï¼Œæ•°æ®æŒ‰ä¸»é”®å€¼ç‰©ç†æ’åºå­˜å‚¨ã€‚"
keywords: "MySQL æŠ€æœ¯æµ…æï¼ˆèšç°‡ç´¢å¼•ã€UndoLogã€RedoLogã€MVCCï¼‰"
categories: ['æœªåˆ†ç±»']
tags: ['æ•°æ®åº“', 'Mysql']
artid: "146168248"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146168248
    alt: "MySQL-æŠ€æœ¯æµ…æèšç°‡ç´¢å¼•UndoLogRedoLogMVCC"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146168248
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146168248
cover: https://bing.ee123.net/img/rand?artid=146168248
image: https://bing.ee123.net/img/rand?artid=146168248
img: https://bing.ee123.net/img/rand?artid=146168248
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     MySQL æŠ€æœ¯æµ…æï¼ˆèšç°‡ç´¢å¼•ã€UndoLogã€RedoLogã€MVCCï¼‰
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="MySQL__0">
     </a>
     MySQL æ ¸å¿ƒæŠ€æœ¯æ·±åº¦è§£æ
    </h2>
    <h3>
     <a id="_2">
     </a>
     ä¸€ã€èšç°‡ç´¢å¼•ä¸éèšç°‡ç´¢å¼•
    </h3>
    <h4>
     <a id="1__4">
     </a>
     1. èšç°‡ç´¢å¼•ç»“æ„
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        å­˜å‚¨æ–¹å¼
       </strong>
       <br/>
       InnoDB ä¸­ï¼Œèšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹ç›´æ¥å­˜å‚¨
       <strong>
        å®Œæ•´æ•°æ®è¡Œ
       </strong>
       ï¼Œæ•°æ®æŒ‰ä¸»é”®å€¼ç‰©ç†æ’åºå­˜å‚¨ã€‚
      </p>
      <ul>
       <li>
        ä¸»é”®ç´¢å¼•å³æ•°æ®æ–‡ä»¶ï¼Œéå¶å­èŠ‚ç‚¹å­˜å‚¨ä¸»é”®èŒƒå›´å’Œå­èŠ‚ç‚¹æŒ‡é’ˆ
       </li>
       <li>
        æ•°æ®è¡Œä¸ä¸»é”®ç´¢å¼•ç»‘å®šï¼Œä¸»é”®é¡ºåºå†³å®šç£ç›˜å­˜å‚¨é¡ºåº
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        ç¤ºä¾‹å­˜å‚¨ç»“æ„
       </strong>
      </p>
      <pre><code class="prism language-plaintext">B+æ ‘ç»“æ„ï¼š
æ ¹èŠ‚ç‚¹ â†’ [id&lt;100, page1] [100â‰¤id&lt;200, page2]
å¶å­èŠ‚ç‚¹ï¼ˆpage1ï¼‰â†’ | id=50 | Alice | 25 | â†’ | id=80 | Bob | 30 |  
ï¼ˆæ•°æ®è¡ŒæŒ‰idæ’åºå­˜å‚¨ï¼‰
</code></pre>
     </li>
    </ul>
    <h4>
     <a id="2__vs__18">
     </a>
     2. èšç°‡ç´¢å¼• vs éèšç°‡ç´¢å¼•æŸ¥è¯¢é€Ÿåº¦å¯¹æ¯”
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        <strong>
         æŸ¥è¯¢ç±»å‹
        </strong>
       </th>
       <th>
        èšç°‡ç´¢å¼•æ€§èƒ½
       </th>
       <th>
        éèšç°‡ç´¢å¼•æ€§èƒ½
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        ä¸»é”®æŸ¥è¯¢
       </td>
       <td>
        âš¡ï¸
        <strong>
         O(1)
        </strong>
        ç›´æ¥å®šä½æ•°æ®
       </td>
       <td>
        ğŸ¢ éœ€ä¸¤æ¬¡æŸ¥æ‰¾ï¼ˆç´¢å¼•+å›è¡¨ï¼‰
       </td>
      </tr>
      <tr>
       <td>
        èŒƒå›´æŸ¥è¯¢
       </td>
       <td>
        âš¡ï¸ é¡ºåºI/Oå¿«ï¼ˆæ•°æ®è¿ç»­å­˜å‚¨ï¼‰
       </td>
       <td>
        ğŸ¢ éšæœºI/Oå¤šï¼ˆæ•°æ®åˆ†æ•£ï¼‰
       </td>
      </tr>
      <tr>
       <td>
        è¦†ç›–æŸ¥è¯¢
       </td>
       <td>
        âœ… æ— éœ€å›è¡¨
       </td>
       <td>
        è‹¥ç´¢å¼•åŒ…å«æŸ¥è¯¢å­—æ®µå¯é¿å…å›è¡¨
       </td>
      </tr>
     </tbody>
    </table>
    <blockquote>
     <p>
      <strong>
       ç»“è®º
      </strong>
      ï¼šä¸»é”®æŸ¥è¯¢ä¼˜å…ˆä½¿ç”¨èšç°‡ç´¢å¼•ï¼ŒäºŒçº§ç´¢å¼•éœ€è¯„ä¼°å›è¡¨ä»£ä»·
     </p>
    </blockquote>
    <hr/>
    <h3>
     <a id="_29">
     </a>
     äºŒã€äº‹åŠ¡æ—¥å¿—æœºåˆ¶
    </h3>
    <h4>
     <a id="1_Undo_Log_31">
     </a>
     1. Undo Logï¼ˆå›æ»šæ—¥å¿—ï¼‰
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        æ ¸å¿ƒä½œç”¨
       </strong>
      </p>
      <ul>
       <li>
        äº‹åŠ¡å›æ»šï¼šè®°å½•æ•°æ®ä¿®æ”¹å‰çš„æ—§å€¼
       </li>
       <li>
        MVCC æ”¯æŒï¼šå­˜å‚¨å¤šç‰ˆæœ¬æ•°æ®å®ç°éé˜»å¡è¯»
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        å­˜å‚¨ç»“æ„
       </strong>
      </p>
      <pre><code class="prism language-plaintext">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
| Undo Log Segment |
| - INSERT â†’ è®°å½•ä¸»é”®å€¼         |
| - UPDATE â†’ æ—§æ•°æ®é•œåƒ         |
| - DELETE â†’ æ•°æ®å®Œæ•´æ‹·è´       |
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
      <ul>
       <li>
        é€šè¿‡ purge çº¿ç¨‹å®šæœŸæ¸…ç†å·²æäº¤äº‹åŠ¡çš„æ—§ç‰ˆæœ¬
       </li>
      </ul>
     </li>
    </ul>
    <h4>
     <a id="2_Redo_Log_47">
     </a>
     2. Redo Logï¼ˆé‡åšæ—¥å¿—ï¼‰
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        æ ¸å¿ƒä½œç”¨
       </strong>
       <br/>
       ç¡®ä¿äº‹åŠ¡æŒä¹…æ€§ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±
      </p>
     </li>
     <li>
      <p>
       <strong>
        å·¥ä½œæµç¨‹
       </strong>
      </p>
      <div class="mermaid">
       <svg class="mermaid-svg" height="158" id="mermaid-svg-3ycYn4Zx2jUK6okV" viewbox="0 0 893 158" width="893" xmlns="http://www.w3.org/2000/svg">
        <style>
         #mermaid-svg-3ycYn4Zx2jUK6okV {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-3ycYn4Zx2jUK6okV .error-icon{fill:#552222;}#mermaid-svg-3ycYn4Zx2jUK6okV .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-3ycYn4Zx2jUK6okV .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-3ycYn4Zx2jUK6okV .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-3ycYn4Zx2jUK6okV .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-3ycYn4Zx2jUK6okV .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-3ycYn4Zx2jUK6okV .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-3ycYn4Zx2jUK6okV .marker{fill:#333333;stroke:#333333;}#mermaid-svg-3ycYn4Zx2jUK6okV .marker.cross{stroke:#333333;}#mermaid-svg-3ycYn4Zx2jUK6okV svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-3ycYn4Zx2jUK6okV .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-3ycYn4Zx2jUK6okV .cluster-label text{fill:#333;}#mermaid-svg-3ycYn4Zx2jUK6okV .cluster-label span{color:#333;}#mermaid-svg-3ycYn4Zx2jUK6okV .label text,#mermaid-svg-3ycYn4Zx2jUK6okV span{fill:#333;color:#333;}#mermaid-svg-3ycYn4Zx2jUK6okV .node rect,#mermaid-svg-3ycYn4Zx2jUK6okV .node circle,#mermaid-svg-3ycYn4Zx2jUK6okV .node ellipse,#mermaid-svg-3ycYn4Zx2jUK6okV .node polygon,#mermaid-svg-3ycYn4Zx2jUK6okV .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-3ycYn4Zx2jUK6okV .node .label{text-align:center;}#mermaid-svg-3ycYn4Zx2jUK6okV .node.clickable{cursor:pointer;}#mermaid-svg-3ycYn4Zx2jUK6okV .arrowheadPath{fill:#333333;}#mermaid-svg-3ycYn4Zx2jUK6okV .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-3ycYn4Zx2jUK6okV .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-3ycYn4Zx2jUK6okV .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-3ycYn4Zx2jUK6okV .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-3ycYn4Zx2jUK6okV .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-3ycYn4Zx2jUK6okV .cluster text{fill:#333;}#mermaid-svg-3ycYn4Zx2jUK6okV .cluster span{color:#333;}#mermaid-svg-3ycYn4Zx2jUK6okV div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-3ycYn4Zx2jUK6okV :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
        </style>
        <g>
         <g class="output">
          <g class="clusters">
          </g>
          <g class="edgePaths">
           <g class="edgePath LS-A LE-B" id="L-A-B" style="opacity: 1;">
            <path class="path" d="M124,79L128.16666666666666,79C132.33333333333334,79,140.66666666666666,79,149,79C157.33333333333334,79,165.66666666666666,79,169.83333333333334,79L174,79" marker-end="url(#arrowhead112)" style="fill:none">
            </path>
            <defs>
             <marker id="arrowhead112" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
              <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
              </path>
             </marker>
            </defs>
           </g>
           <g class="edgePath LS-B LE-C" id="L-B-C" style="opacity: 1;">
            <path class="path" d="M301,79L305.1666666666667,79C309.3333333333333,79,317.6666666666667,79,326.0833333333333,79.08333333333333C334.5,79.16666666666667,343,79.33333333333333,347.25,79.41666666666667L351.5,79.5" marker-end="url(#arrowhead113)" style="fill:none">
            </path>
            <defs>
             <marker id="arrowhead113" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
              <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
              </path>
             </marker>
            </defs>
           </g>
           <g class="edgePath LS-C LE-D" id="L-C-D" style="opacity: 1;">
            <path class="path" d="M457.5739299610895,68.57392996108949L484.3949416342412,62.31160830090791C511.215953307393,56.04928664072633,564.8579766536965,43.52464332036317,619.4289883268483,37.262321660181584C674,31,729.5,31,757.25,31L785,31" marker-end="url(#arrowhead114)" style="fill:none">
            </path>
            <defs>
             <marker id="arrowhead114" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
              <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
              </path>
             </marker>
            </defs>
           </g>
           <g class="edgePath LS-C LE-E" id="L-C-E" style="opacity: 1;">
            <path class="path" d="M457.5739299610895,90.42607003891051L484.3949416342412,96.52172503242542C511.215953307393,102.61738002594034,564.8579766536965,114.80869001297016,616.7623216601816,120.90434500648509C668.6666666666666,127,718.8333333333334,127,743.9166666666666,127L769,127" marker-end="url(#arrowhead115)" style="fill:none">
            </path>
            <defs>
             <marker id="arrowhead115" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
              <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
              </path>
             </marker>
            </defs>
           </g>
          </g>
          <g class="edgeLabels">
           <g class="edgeLabel" style="opacity: 1;" transform="">
            <g class="label" transform="translate(0,0)">
             <rect height="0" rx="0" ry="0" width="0">
             </rect>
             <foreignobject height="0" width="0">
              <div style="display: inline-block; white-space: nowrap;">
               <span class="edgeLabel L-LS-A' L-LE-B" id="L-L-A-B">
               </span>
              </div>
             </foreignobject>
            </g>
           </g>
           <g class="edgeLabel" style="opacity: 1;" transform="">
            <g class="label" transform="translate(0,0)">
             <rect height="0" rx="0" ry="0" width="0">
             </rect>
             <foreignobject height="0" width="0">
              <div style="display: inline-block; white-space: nowrap;">
               <span class="edgeLabel L-LS-B' L-LE-C" id="L-L-B-C">
               </span>
              </div>
             </foreignobject>
            </g>
           </g>
           <g class="edgeLabel" style="opacity: 1;" transform="translate(618.5,31)">
            <g class="label" transform="translate(-125.5,-13)">
             <rect height="26" rx="0" ry="0" width="251">
             </rect>
             <foreignobject height="26" width="251">
              <div style="display: inline-block; white-space: nowrap;">
               <span class="edgeLabel L-LS-C' L-LE-D" id="L-L-C-D">
                innodb_flush_log_at_trx_commit=1
               </span>
              </div>
             </foreignobject>
            </g>
           </g>
           <g class="edgeLabel" style="opacity: 1;" transform="translate(618.5,127)">
            <g class="label" transform="translate(-125.5,-13)">
             <rect height="26" rx="0" ry="0" width="251">
             </rect>
             <foreignobject height="26" width="251">
              <div style="display: inline-block; white-space: nowrap;">
               <span class="edgeLabel L-LS-C' L-LE-E" id="L-L-C-E">
                innodb_flush_log_at_trx_commit=0
               </span>
              </div>
             </foreignobject>
            </g>
           </g>
          </g>
          <g class="nodes">
           <g class="node default" id="flowchart-A-72" style="opacity: 1;" transform="translate(66,79)">
            <rect class="label-container" height="46" rx="0" ry="0" width="116" x="-58" y="-23">
            </rect>
            <g class="label" transform="translate(0,0)">
             <g transform="translate(-48,-13)">
              <foreignobject height="26" width="96">
               <div style="display: inline-block; white-space: nowrap;">
                äº‹åŠ¡ä¿®æ”¹æ•°æ®
               </div>
              </foreignobject>
             </g>
            </g>
           </g>
           <g class="node default" id="flowchart-B-73" style="opacity: 1;" transform="translate(237.5,79)">
            <rect class="label-container" height="46" rx="0" ry="0" width="127" x="-63.5" y="-23">
            </rect>
            <g class="label" transform="translate(0,0)">
             <g transform="translate(-53.5,-13)">
              <foreignobject height="26" width="107">
               <div style="display: inline-block; white-space: nowrap;">
                å†™å…¥Log Buffer
               </div>
              </foreignobject>
             </g>
            </g>
           </g>
           <g class="node default" id="flowchart-C-75" style="opacity: 1;" transform="translate(409.5,79)">
            <polygon class="label-container" points="58.5,0 117,-58.5 58.5,-117 0,-58.5" transform="translate(-58.5,58.5)">
            </polygon>
            <g class="label" transform="translate(0,0)">
             <g transform="translate(-32,-13)">
              <foreignobject height="26" width="64">
               <div style="display: inline-block; white-space: nowrap;">
                åˆ·ç›˜ç­–ç•¥
               </div>
              </foreignobject>
             </g>
            </g>
           </g>
           <g class="node default" id="flowchart-D-77" style="opacity: 1;" transform="translate(827,31)">
            <rect class="label-container" height="46" rx="0" ry="0" width="84" x="-42" y="-23">
            </rect>
            <g class="label" transform="translate(0,0)">
             <g transform="translate(-32,-13)">
              <foreignobject height="26" width="64">
               <div style="display: inline-block; white-space: nowrap;">
                åŒæ­¥åˆ·ç›˜
               </div>
              </foreignobject>
             </g>
            </g>
           </g>
           <g class="node default" id="flowchart-E-79" style="opacity: 1;" transform="translate(827,127)">
            <rect class="label-container" height="46" rx="0" ry="0" width="116" x="-58" y="-23">
            </rect>
            <g class="label" transform="translate(0,0)">
             <g transform="translate(-48,-13)">
              <foreignobject height="26" width="96">
               <div style="display: inline-block; white-space: nowrap;">
                æ¯ç§’å¼‚æ­¥åˆ·ç›˜
               </div>
              </foreignobject>
             </g>
            </g>
           </g>
          </g>
         </g>
        </g>
       </svg>
      </div>
      <ul>
       <li>
        <strong>
         ç‰©ç†æ—¥å¿—
        </strong>
        ï¼šè®°å½•æ•°æ®é¡µçš„ç‰©ç†ä¿®æ”¹ï¼ˆå¦‚"page5 offset10 å€¼ä»â€™Aâ€™æ”¹ä¸ºâ€™Bâ€™"ï¼‰
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="MVCC_63">
     </a>
     ä¸‰ã€MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰
    </h3>
    <h4>
     <a id="1__65">
     </a>
     1. å®ç°ä¸‰è¦ç´ 
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        <strong>
         è¦ç´ 
        </strong>
       </th>
       <th>
        è¯´æ˜
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        éšè—å­—æ®µ
       </td>
       <td>
        <code>
         DB_TRX_ID
        </code>
        ï¼ˆæœ€åä¿®æ”¹äº‹åŠ¡IDï¼‰ã€
        <code>
         DB_ROLL_PTR
        </code>
        ï¼ˆå›æ»šæŒ‡é’ˆæŒ‡å‘æ—§ç‰ˆæœ¬ï¼‰
       </td>
      </tr>
      <tr>
       <td>
        ç‰ˆæœ¬é“¾
       </td>
       <td>
        æ•°æ®é€šè¿‡å›æ»šæŒ‡é’ˆå½¢æˆå¤šç‰ˆæœ¬é“¾
       </td>
      </tr>
      <tr>
       <td>
        ReadView
       </td>
       <td>
        å†³å®šäº‹åŠ¡å¯è§å“ªä¸ªç‰ˆæœ¬ï¼ˆåŒ…å«æ´»è·ƒäº‹åŠ¡IDåˆ—è¡¨ï¼‰
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="2__72">
     </a>
     2. å¯è§æ€§åˆ¤æ–­é€»è¾‘
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">is_visible</span><span class="token punctuation">(</span>trx_id<span class="token punctuation">,</span> read_view<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> trx_id <span class="token operator">&lt;</span> read_view<span class="token punctuation">.</span>min_trx_id<span class="token punctuation">:</span> 
        <span class="token keyword">return</span> <span class="token boolean">True</span>  <span class="token comment"># å·²æäº¤çš„æ—§äº‹åŠ¡</span>
    <span class="token keyword">elif</span> trx_id <span class="token keyword">in</span> read_view<span class="token punctuation">.</span>active_trx_ids<span class="token punctuation">:</span> 
        <span class="token keyword">return</span> <span class="token boolean">False</span> <span class="token comment"># æœªæäº¤çš„æ´»è·ƒäº‹åŠ¡</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span> 
        <span class="token keyword">return</span> trx_id <span class="token operator">&lt;=</span> read_view<span class="token punctuation">.</span>creator_trx_id
</code></pre>
    <h4>
     <a id="3_MVCC_83">
     </a>
     3. éš”ç¦»çº§åˆ«ä¸MVCC
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        éš”ç¦»çº§åˆ«
       </th>
       <th>
        MVCC è¡Œä¸º
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        è¯»å·²æäº¤ï¼ˆRCï¼‰
       </td>
       <td>
        æ¯æ¬¡æŸ¥è¯¢ç”Ÿæˆæ–° ReadView
       </td>
      </tr>
      <tr>
       <td>
        å¯é‡å¤è¯»ï¼ˆRRï¼‰
       </td>
       <td>
        äº‹åŠ¡å†…å¤ç”¨åŒä¸€ä¸ª ReadView
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h3>
     <a id="_91">
     </a>
     å››ã€é”æœºåˆ¶ä¸éš”ç¦»æ€§å®ç°
    </h3>
    <h4>
     <a id="1__93">
     </a>
     1. æ ¸å¿ƒé”ç±»å‹
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        é”ç±»å‹
       </th>
       <th>
        æè¿°
       </th>
       <th>
        åº”ç”¨åœºæ™¯
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        å…±äº«é”ï¼ˆS Lockï¼‰
       </td>
       <td>
        å…è®¸å…¶ä»–è¯»é”ï¼Œé˜»å¡å†™é”
       </td>
       <td>
        <code>
         SELECT ... LOCK IN SHARE MODE
        </code>
       </td>
      </tr>
      <tr>
       <td>
        æ’ä»–é”ï¼ˆX Lockï¼‰
       </td>
       <td>
        é˜»å¡å…¶ä»–æ‰€æœ‰é”
       </td>
       <td>
        <code>
         SELECT ... FOR UPDATE
        </code>
       </td>
      </tr>
      <tr>
       <td>
        é—´éš™é”ï¼ˆGap Lockï¼‰
       </td>
       <td>
        é”å®šç´¢å¼•è®°å½•é—´çš„é—´éš™
       </td>
       <td>
        é˜²æ­¢å¹»è¯»ï¼ˆRRçº§åˆ«ï¼‰
       </td>
      </tr>
      <tr>
       <td>
        Next-Key Lock
       </td>
       <td>
        è¡Œé”+é—´éš™é”ç»„åˆ
       </td>
       <td>
        åŒæ—¶é˜²æ­¢å¹»è¯»å’Œå†™å†²çª
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="2__101">
     </a>
     2. éš”ç¦»çº§åˆ«å®ç°æ–¹æ¡ˆ
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        éš”ç¦»çº§åˆ«
       </th>
       <th>
        å®ç°æœºåˆ¶
       </th>
       <th>
        å…¸å‹åœºæ™¯
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        è¯»æœªæäº¤ï¼ˆRUï¼‰
       </td>
       <td>
        æ— é”ç›´æ¥è¯»æœ€æ–°æ•°æ®
       </td>
       <td>
        å®æ—¶ç»Ÿè®¡
       </td>
      </tr>
      <tr>
       <td>
        è¯»å·²æäº¤ï¼ˆRCï¼‰
       </td>
       <td>
        è¯­å¥çº§å¿«ç…§è¯» + è¡Œé”
       </td>
       <td>
        é«˜å¹¶å‘OLTP
       </td>
      </tr>
      <tr>
       <td>
        å¯é‡å¤è¯»ï¼ˆRRï¼‰
       </td>
       <td>
        äº‹åŠ¡çº§å¿«ç…§è¯» + Next-Key Lock
       </td>
       <td>
        MySQLé»˜è®¤çº§åˆ«
       </td>
      </tr>
      <tr>
       <td>
        ä¸²è¡ŒåŒ–ï¼ˆSerialï¼‰
       </td>
       <td>
        å…¨è¡¨èŒƒå›´é” + ä¸¥æ ¼ä¸²è¡Œæ‰§è¡Œ
       </td>
       <td>
        é‡‘èäº¤æ˜“
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="3__109">
     </a>
     3. æ­»é”å¤„ç†ç¤ºä¾‹
    </h4>
    <pre><code class="prism language-sql"><span class="token comment">-- äº‹åŠ¡1</span>
<span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> accounts <span class="token keyword">SET</span> balance<span class="token operator">=</span>balance<span class="token operator">-</span><span class="token number">100</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">-- è·å¾—Xé”</span>
<span class="token keyword">UPDATE</span> accounts <span class="token keyword">SET</span> balance<span class="token operator">=</span>balance<span class="token operator">+</span><span class="token number">100</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">-- ç­‰å¾…äº‹åŠ¡2é‡Šæ”¾é”</span>

<span class="token comment">-- äº‹åŠ¡2</span>
<span class="token keyword">BEGIN</span><span class="token punctuation">;</span>
<span class="token keyword">UPDATE</span> accounts <span class="token keyword">SET</span> balance<span class="token operator">=</span>balance<span class="token operator">-</span><span class="token number">50</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>  <span class="token comment">-- è·å¾—Xé”</span>
<span class="token keyword">UPDATE</span> accounts <span class="token keyword">SET</span> balance<span class="token operator">=</span>balance<span class="token operator">+</span><span class="token number">50</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">-- ç­‰å¾…äº‹åŠ¡1é‡Šæ”¾é”</span>

<span class="token comment">-- InnoDB æ£€æµ‹åˆ°æ­»é”åï¼Œè‡ªåŠ¨å›æ»šä»£ä»·è¾ƒå°çš„äº‹åŠ¡</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_126">
     </a>
     äº”ã€æ€§èƒ½ä¼˜åŒ–å®è·µ
    </h3>
    <h4>
     <a id="1__128">
     </a>
     1. ç´¢å¼•ä¼˜åŒ–æŠ€å·§
    </h4>
    <ul>
     <li>
      ä¸»é”®è®¾è®¡ä¸ºè‡ªå¢æ•´å‹ï¼ˆå‡å°‘é¡µåˆ†è£‚ï¼‰
     </li>
     <li>
      è”åˆç´¢å¼•éµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™
      <pre><code class="prism language-sql"><span class="token comment">-- æœ‰æ•ˆä½¿ç”¨ç´¢å¼•</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> users <span class="token keyword">WHERE</span> name<span class="token operator">=</span><span class="token string">'Alice'</span> <span class="token operator">AND</span> age<span class="token operator">&gt;</span><span class="token number">20</span><span class="token punctuation">;</span> 
<span class="token comment">-- ç´¢å¼•è®¾è®¡ä¸º (name, age)</span>
</code></pre>
     </li>
    </ul>
    <h4>
     <a id="2__137">
     </a>
     2. äº‹åŠ¡æ§åˆ¶å»ºè®®
    </h4>
    <ul>
     <li>
      æ§åˆ¶äº‹åŠ¡ç²’åº¦ï¼šå•ä¸ªäº‹åŠ¡æ‰§è¡Œæ—¶é—´ &lt; 1ç§’
     </li>
     <li>
      æ‰¹é‡æ“ä½œåˆ†æ‰¹æ¬¡æäº¤
      <pre><code class="prism language-sql"><span class="token keyword">SET</span> autocommit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> big_table <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">-- æ‰§è¡Œ1000æ¬¡</span>
<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
</code></pre>
     </li>
    </ul>
    <h4>
     <a id="3__146">
     </a>
     3. é”ä¼˜åŒ–ç­–ç•¥
    </h4>
    <ul>
     <li>
      é¿å…é•¿äº‹åŠ¡ï¼šå‡å°‘é”æŒæœ‰æ—¶é—´
     </li>
     <li>
      ä½¿ç”¨ç­‰å€¼æŸ¥è¯¢ï¼š
      <code>
       WHERE id=123
      </code>
      ï¼ˆæ¯”èŒƒå›´æŸ¥è¯¢æ›´é«˜æ•ˆï¼‰
     </li>
     <li>
      è®¾ç½®åˆç†é”è¶…æ—¶ï¼š
      <pre><code class="prism language-sql"><span class="token keyword">SET</span> innodb_lock_wait_timeout<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>  <span class="token comment">-- é”ç­‰å¾…è¶…æ—¶3ç§’</span>
</code></pre>
     </li>
    </ul>
    <hr/>
    <blockquote>
     <p>
      é€šè¿‡æ·±å…¥ç†è§£å­˜å‚¨å¼•æ“æœºåˆ¶ï¼Œå¯é’ˆå¯¹æ€§ä¼˜åŒ–æ•°æ®åº“è®¾è®¡ï¼Œæå‡ç³»ç»Ÿå¹¶å‘æ€§èƒ½ä¸æ•°æ®å¯é æ€§ã€‚
     </p>
    </blockquote>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33373230353539372f:61727469636c652f64657461696c732f313436313638323438" class_="artid" style="display:none">
 </p>
</div>


