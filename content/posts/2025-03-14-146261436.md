---
layout: post
title: "Spring-Cloud-LoadBalancer-原理与实践"
date: 2025-03-14 16:54:17 +0800
description: "RandomLoadBalancer：随机选择RoundRobinLoadBalancer：轮询同时，他们又是被 @ConditionalOnMissingBean修饰，所以，如果我们想自定义自己的策略规则，我们直接通过 @Configuration和@Bean，注入自己的策略就行，以下是一个简单示例/*** 自定义负载均衡器*/@Bean其中MyLoadBalancer是我们自定义的规则@Slf4j//服务列表@Override/*** 进行路由选择*/..."
keywords: "Spring Cloud LoadBalancer 原理与实践"
categories: ['Java']
tags: ['灰度', 'Spring', 'Loadbalancer', 'Cloud']
artid: "146261436"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146261436
    alt: "Spring-Cloud-LoadBalancer-原理与实践"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146261436
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146261436
cover: https://bing.ee123.net/img/rand?artid=146261436
image: https://bing.ee123.net/img/rand?artid=146261436
img: https://bing.ee123.net/img/rand?artid=146261436
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Spring Cloud LoadBalancer 原理与实践
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-github-gist" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     背景
    </h3>
    <p>
     当前我们的微服务架构基于Spring Cloud Alibaba体系，通过定制NacosRule实现了跨集群访问和灰度发布功能。但随着Spring Cloud与Nacos版本升级，官方已弃用Ribbon转向LoadBalancer，这要求我们完成以下技术升级：
    </p>
    <ol>
     <li>
      负载均衡机制迁移：将原有Ribbon规则适配到LoadBalancer
     </li>
     <li>
      功能继承保障：保持跨集群路由和灰度能力
     </li>
     <li>
      技术风险控制：深入理解底层机制以提升问题排查效率
     </li>
    </ol>
    <p>
     技术选型对比
    </p>
    <table>
     <thead>
      <tr>
       <th align="left">
        特性
       </th>
       <th align="left">
        Ribbon
       </th>
       <th align="left">
        LoadBalancer
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="left">
        维护状态
       </td>
       <td align="left">
        停止更新
       </td>
       <td align="left">
        官方维护
       </td>
      </tr>
      <tr>
       <td align="left">
        响应式支持
       </td>
       <td align="left">
        不支持
       </td>
       <td align="left">
        原生支持
       </td>
      </tr>
      <tr>
       <td align="left">
        配置灵活性
       </td>
       <td align="left">
        XML/注解
       </td>
       <td align="left">
        全Java配置
       </td>
      </tr>
      <tr>
       <td align="left">
        扩展性
       </td>
       <td align="left">
        中等
       </td>
       <td align="left">
        高
       </td>
      </tr>
      <tr>
       <td align="left">
        服务发现集成
       </td>
       <td align="left">
        需要适配
       </td>
       <td align="left">
        深度整合
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="_20">
     </a>
     负载均衡
    </h3>
    <p>
     什么是负载均衡？简单来说，负载均衡就是将网络流量（负载）分摊到不同的网络服务器（可以平均分配，也可以不平均），系统就可以实现服务的水平横向扩展。
    </p>
    <h4>
     <a id="_24">
     </a>
     服务端负载均衡
    </h4>
    <p>
     服务器端负载均衡指的是存放在服务器端的负载均衡器，例如 Nginx、HAProxy、F5 等。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0fec7de438c9442cab0c0aca92c73da8.png#pic_center"/>
    </p>
    <h4>
     <a id="_31">
     </a>
     客户端负载均衡
    </h4>
    <p>
     客户端负载均衡指的是嵌套在客户端的负载均衡器，例如 Ribbon、Loadbalancer。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9a51576af25a496bbc3e5bf6e7a12f30.png#pic_center"/>
    </p>
    <h3>
     <a id="Spring_cloud_loadbalancer_40">
     </a>
     Spring cloud loadbalancer
    </h3>
    <p>
     在介绍loadbalancer之前，如果让你来设计一个负载均衡组件，你会怎么设计？
    </p>
    <p>
     我们可能需要考虑以下这几个问题：
    </p>
    <ul>
     <li>
      如何获取服务器列表？
     </li>
     <li>
      服务器列表发生变更如何监听同步？
     </li>
     <li>
      如何将客户端请求进行拦截然后选择服务器进行转发？
     </li>
     <li>
      如何将负载进行分摊？
     </li>
    </ul>
    <p>
     带着这些问题，我们来深入了解Spring Cloud LoadBalancer的实现机制。
    </p>
    <h4>
     <a id="_53">
     </a>
     服务器列表获取
    </h4>
    <p>
     <strong>
      ServiceInstanceListSupplier
     </strong>
    </p>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServiceInstanceListSupplier</span>
		<span class="token keyword">extends</span> <span class="token class-name">Supplier</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Flux</span><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">// 服务id</span>
	<span class="token class-name">String</span> <span class="token function">getServiceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 构造器</span>
	<span class="token keyword">static</span> <span class="token class-name">ServiceInstanceListSupplierBuilder</span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ServiceInstanceListSupplierBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token comment">//用于创建一个 固定的 ServiceInstanceListSupplier（实例列表不会变）。</span>
    <span class="token comment">//允许从 Spring Environment 读取配置来构造 FixedServiceInstanceListSupplier。</span>
    <span class="token keyword">static</span> <span class="token class-name">FixedServiceInstanceListSupplier<span class="token punctuation">.</span>Builder</span> <span class="token function">fixed</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FixedServiceInstanceListSupplier<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//直接返回 serviceId 对应的 FixedServiceInstanceListSupplier。</span>
	<span class="token keyword">static</span> <span class="token class-name">FixedServiceInstanceListSupplier<span class="token punctuation">.</span>SimpleBuilder</span> <span class="token function">fixed</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">FixedServiceInstanceListSupplier<span class="token punctuation">.</span>SimpleBuilder</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//实现 ServiceInstanceListSupplier，用于返回一个固定的实例列表，不会动态更新。</span>
    <span class="token comment">//适用于测试环境或者静态服务发现场景。</span>
	<span class="token keyword">class</span> <span class="token class-name">FixedServiceInstanceListSupplier</span> <span class="token keyword">implements</span> <span class="token class-name">ServiceInstanceListSupplier</span> <span class="token punctuation">{<!-- --></span>

		<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> serviceId<span class="token punctuation">;</span>

		<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances<span class="token punctuation">;</span>

		<span class="token annotation punctuation">@Deprecated</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Builder</span> <span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> env<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Builder</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//构造 FixedServiceInstanceListSupplier，接受服务 ID 和实例列表。</span>
		<span class="token keyword">private</span> <span class="token class-name">FixedServiceInstanceListSupplier</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">,</span>
				<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>serviceId <span class="token operator">=</span> serviceId<span class="token punctuation">;</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>instances <span class="token operator">=</span> instances<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//返回当前 FixedServiceInstanceListSupplier 所管理的 serviceId。</span>
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getServiceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> serviceId<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token comment">//返回固定的实例列表，不会随 Nacos 或 Eureka 变化。</span>
		<span class="token annotation punctuation">@Override</span>
		<span class="token keyword">public</span> <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>instances<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
</code></pre>
    <p>
     该接口提供符合条件的实例列表，并提供了 builder 方法返回 ServiceInstanceListSupplierBuilder 实例用来构造 ServiceInstanceListSupplier
    </p>
    <p>
     同时
     <code>
      FixedServiceInstanceListSupplier
     </code>
     ，它返回固定的服务实例列表。它主要用于
    </p>
    <ul>
     <li>
      ** 测试负载均衡逻辑**（在不依赖 Nacos/Eureka 的情况下提供固定实例）。**
     </li>
     <li>
      <strong>
       静态配置服务实例
      </strong>
      （比如在某些特殊场景下，不使用注册中心，而是固定 IP+端口）。
     </li>
    </ul>
    <p>
     示例
    </p>
    <pre><code class="prism language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> instances <span class="token operator">=</span> <span class="token class-name">List</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">DefaultServiceInstance</span><span class="token punctuation">(</span><span class="token string">"id1"</span><span class="token punctuation">,</span> <span class="token string">"my-service"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">8080</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">DefaultServiceInstance</span><span class="token punctuation">(</span><span class="token string">"id2"</span><span class="token punctuation">,</span> <span class="token string">"my-service"</span><span class="token punctuation">,</span> <span class="token string">"127.0.0.2"</span><span class="token punctuation">,</span> <span class="token number">8081</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ServiceInstanceListSupplier</span> supplier <span class="token operator">=</span> <span class="token class-name">ServiceInstanceListSupplier</span><span class="token punctuation">.</span><span class="token function">fixed</span><span class="token punctuation">(</span><span class="token string">"my-service"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">withInstances</span><span class="token punctuation">(</span>instances<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取实例列表</span>
supplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>list <span class="token operator">-&gt;</span> list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>instance <span class="token operator">-&gt;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> instance<span class="token punctuation">.</span><span class="token function">getPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
    <p>
     整个 ServiceInstanceListSupplier 的实现类都是 rx式 编程风格，但核心逻辑不难看懂，下面就贴出几个实现类简单了解下
    </p>
    <p>
     <strong>
      DiscoveryClientServiceInstanceListSupplier
     </strong>
    </p>
    <pre><code class="prism language-java"><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>	
<span class="token comment">// 普通mvc项目获取获取实例列表</span>
<span class="token keyword">public</span> <span class="token class-name">DiscoveryClientServiceInstanceListSupplier</span><span class="token punctuation">(</span><span class="token class-name">DiscoveryClient</span> delegate<span class="token punctuation">,</span>
			<span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>serviceId <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token constant">PROPERTY_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">resolveTimeout</span><span class="token punctuation">(</span>environment<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>serviceInstances <span class="token operator">=</span> <span class="token class-name">Flux</span>
				<span class="token punctuation">.</span><span class="token function">defer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">fromCallable</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> delegate<span class="token punctuation">.</span><span class="token function">getInstances</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">timeout</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">defer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
					<span class="token function">logTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Schedulers</span><span class="token punctuation">.</span><span class="token function">boundedElastic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onErrorResume</span><span class="token punctuation">(</span>error <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
					<span class="token function">logException</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">return</span> <span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// webflux项目获取获取实例列表</span>
	<span class="token keyword">public</span> <span class="token class-name">DiscoveryClientServiceInstanceListSupplier</span><span class="token punctuation">(</span><span class="token class-name">ReactiveDiscoveryClient</span> delegate<span class="token punctuation">,</span>
			<span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
    <p>
     主要逻辑在构造方法中，等价于 this.serviceInstances = discoveryClient.getInstances(serviceId)，不难理解：从注册中心拉去实例列表
    </p>
    <p>
     <strong>
      DelegatingServiceInstanceListSupplier
     </strong>
    </p>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">DelegatingServiceInstanceListSupplier</span>
		<span class="token keyword">implements</span> <span class="token class-name">ServiceInstanceListSupplier</span><span class="token punctuation">,</span> <span class="token class-name">InitializingBean</span><span class="token punctuation">,</span> <span class="token class-name">DisposableBean</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">ServiceInstanceListSupplier</span> delegate<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">DelegatingServiceInstanceListSupplier</span><span class="token punctuation">(</span><span class="token class-name">ServiceInstanceListSupplier</span> delegate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">Assert</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>delegate<span class="token punctuation">,</span> <span class="token string">"delegate may not be null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>delegate <span class="token operator">=</span> delegate<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre>
    <p>
     装饰层，内嵌一个代理对象，一般就是 DiscoveryClientServiceInstanceListSupplier 来获取实例列表，装饰逻辑就是过滤对应的列表
    </p>
    <p>
     其下面有n个实现子类，暂不贴代码了
    </p>
    <p>
     主要功能为：
    </p>
    <ul>
     <li>
      ZonePreferenceServiceInstanceListSupplier：区域优先选择，优先选择与当前客户端在相同
      <code>
       zone
      </code>
      （可用区）的实例，提高访问效率，降低跨区域流量消耗。
     </li>
     <li>
      CachingServiceInstanceListSupplier：缓存
      <code>
       ServiceInstanceListSupplier
      </code>
      的返回结果，减少注册中心查询次数，提升性能。
     </li>
     <li>
      SameInstancePreferenceServiceInstanceListSupplier：
      <strong>
       尽量路由到之前选中的实例
      </strong>
      ，减少服务间的切换，提高请求一致性。
     </li>
     <li>
      HealthCheckServiceInstanceListSupplier：在负载均衡前，
      <strong>
       过滤掉不健康的服务实例
      </strong>
      ，确保请求不会路由到故障实例。
     </li>
    </ul>
    <h4>
     <a id="_190">
     </a>
     选择实例以及转发
    </h4>
    <p>
     <strong>
      ReactorLoadBalancer
     </strong>
    </p>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ReactorLoadBalancer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">extends</span> <span class="token class-name">ReactiveLoadBalancer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment">/**
	 * Choose the next server based on the load balancing algorithm.
	 * @param request - an input request
	 * @return - mono of response
	 */</span>
	<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"rawtypes"</span><span class="token punctuation">)</span>
	<span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Response</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">default</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Response</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token constant">REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
    <p>
     该接口从 ServiceInstanceListSupplier 返回的实例中选择最终目标，其中也分为普通mvc项目和webflux项目，spring-cloud-loadbalancer 默认只提供了两个实现：
    </p>
    <ul>
     <li>
      RandomLoadBalancer：随机选择
     </li>
     <li>
      RoundRobinLoadBalancer：轮询
     </li>
    </ul>
    <p>
     如果不明白这两区别，可以看文章最后的部分
    </p>
    <h4>
     <a id="_219">
     </a>
     服务装配
    </h4>
    <p>
     LoadBalancerClientConfiguration
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@ConditionalOnDiscoveryEnabled</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoadBalancerClientConfiguration</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">REACTIVE_SERVICE_INSTANCE_SUPPLIER_ORDER</span> <span class="token operator">=</span> <span class="token number">193827465</span><span class="token punctuation">;</span>

    <span class="token comment">//实例选择规则：默认轮询</span>
	<span class="token annotation punctuation">@Bean</span>
	<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
	<span class="token keyword">public</span> <span class="token class-name">ReactorLoadBalancer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> <span class="token function">reactorServiceInstanceLoadBalancer</span><span class="token punctuation">(</span>
			<span class="token class-name">Environment</span> environment<span class="token punctuation">,</span>
			<span class="token class-name">LoadBalancerClientFactory</span> loadBalancerClientFactory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">String</span> name <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerClientFactory</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RoundRobinLoadBalancer</span><span class="token punctuation">(</span>loadBalancerClientFactory<span class="token punctuation">.</span><span class="token function">getLazyProvider</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span>
				<span class="token class-name">ServiceInstanceListSupplier</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">//WebFlux 环境下的默认 ServiceInstanceListSupplier 配置</span>
	<span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@ConditionalOnReactiveDiscoveryEnabled</span>
	<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token constant">REACTIVE_SERVICE_INSTANCE_SUPPLIER_ORDER</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ReactiveSupportConfiguration</span> <span class="token punctuation">{<!-- --></span>

		<span class="token annotation punctuation">@Bean</span>
		<span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span><span class="token class-name">ReactiveDiscoveryClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
		<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
		<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"spring.cloud.loadbalancer.configurations"</span><span class="token punctuation">,</span>
				havingValue <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">,</span> matchIfMissing <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
		<span class="token keyword">public</span> <span class="token class-name">ServiceInstanceListSupplier</span> <span class="token function">discoveryClientServiceInstanceListSupplier</span><span class="token punctuation">(</span>
				<span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token class-name">ServiceInstanceListSupplier</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withDiscoveryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">withCaching</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//普通 web 环境下的配置</span>
	<span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	<span class="token annotation punctuation">@ConditionalOnBlockingDiscoveryEnabled</span>
	<span class="token annotation punctuation">@Order</span><span class="token punctuation">(</span><span class="token constant">REACTIVE_SERVICE_INSTANCE_SUPPLIER_ORDER</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">BlockingSupportConfiguration</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

		<span class="token annotation punctuation">@Bean</span>
		<span class="token annotation punctuation">@ConditionalOnBean</span><span class="token punctuation">(</span><span class="token class-name">DiscoveryClient</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
		<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
		<span class="token annotation punctuation">@ConditionalOnProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"spring.cloud.loadbalancer.configurations"</span><span class="token punctuation">,</span>
				havingValue <span class="token operator">=</span> <span class="token string">"health-check"</span><span class="token punctuation">)</span>
		<span class="token keyword">public</span> <span class="token class-name">ServiceInstanceListSupplier</span> <span class="token function">healthCheckDiscoveryClientServiceInstanceListSupplier</span><span class="token punctuation">(</span>
				<span class="token class-name">ConfigurableApplicationContext</span> context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token class-name">ServiceInstanceListSupplier</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withBlockingDiscoveryClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token punctuation">.</span><span class="token function">withHealthChecks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre>
    <p>
     现在回过头来看每个 LoadBalancerClient 容器实例下默认注册的配置类 LoadBalancerClientConfiguration，如代码所示：
    </p>
    <p>
     默认的实例选择规则是 轮询
     <br/>
     对应的实例列表获取规则取决于 spring.cloud.loadbalancer.configurations 属性配置
    </p>
    <p>
     <strong>
      LoadBalancerAutoConfiguration
     </strong>
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span><span class="token punctuation">(</span>proxyBeanMethods <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@LoadBalancerClients</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AutoConfigureBefore</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token class-name">ReactorLoadBalancerClientAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
		<span class="token class-name">LoadBalancerBeanPostProcessorAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
		<span class="token class-name">ReactiveLoadBalancerAutoConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoadBalancerAutoConfiguration</span> <span class="token punctuation">{<!-- --></span>

	<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">LoadBalancerClientSpecification</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configurations<span class="token punctuation">;</span>

	<span class="token keyword">public</span> <span class="token class-name">LoadBalancerAutoConfiguration</span><span class="token punctuation">(</span>
			<span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">LoadBalancerClientSpecification</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> configurations<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>configurations <span class="token operator">=</span> configurations<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Bean</span>
	<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
	<span class="token keyword">public</span> <span class="token class-name">LoadBalancerZoneConfig</span> <span class="token function">zoneConfig</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> environment<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LoadBalancerZoneConfig</span><span class="token punctuation">(</span>
				environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"spring.cloud.loadbalancer.zone"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@ConditionalOnMissingBean</span>
	<span class="token annotation punctuation">@Bean</span>
	<span class="token keyword">public</span> <span class="token class-name">LoadBalancerClientFactory</span> <span class="token function">loadBalancerClientFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">LoadBalancerClientFactory</span> clientFactory <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LoadBalancerClientFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		clientFactory<span class="token punctuation">.</span><span class="token function">setConfigurations</span><span class="token punctuation">(</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>configurations<span class="token punctuation">.</span><span class="token function">getIfAvailable</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token operator">::</span><span class="token function">emptyList</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> clientFactory<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre>
    <p>
     等上述所有实例加载完，最后整体装配
    </p>
    <h4>
     <a id="_328">
     </a>
     执行最终实例
    </h4>
    <p>
     <strong>
      BlockingLoadBalancerClient
     </strong>
    </p>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BlockingLoadBalancerClient</span> <span class="token keyword">implements</span> <span class="token class-name">LoadBalancerClient</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">,</span> <span class="token class-name">LoadBalancerRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> request<span class="token punctuation">)</span>
			<span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">ServiceInstance</span> serviceInstance <span class="token operator">=</span> <span class="token function">choose</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>serviceInstance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"No instances available for "</span> <span class="token operator">+</span> serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">execute</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">,</span> serviceInstance<span class="token punctuation">,</span> request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

    <span class="token comment">//执行request请求</span>
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">,</span> <span class="token class-name">ServiceInstance</span> serviceInstance<span class="token punctuation">,</span>
			<span class="token class-name">LoadBalancerRequest</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> request<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> request<span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>serviceInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> iOException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">throw</span> iOException<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> exception<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token class-name">ReflectionUtils</span><span class="token punctuation">.</span><span class="token function">rethrowRuntimeException</span><span class="token punctuation">(</span>exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">URI</span> <span class="token function">reconstructURI</span><span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span> serviceInstance<span class="token punctuation">,</span> <span class="token class-name">URI</span> original<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token class-name">LoadBalancerUriTools</span><span class="token punctuation">.</span><span class="token function">reconstructURI</span><span class="token punctuation">(</span>serviceInstance<span class="token punctuation">,</span> original<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token annotation punctuation">@Override</span>
	<span class="token keyword">public</span> <span class="token class-name">ServiceInstance</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取 serviceId 容器中的 ReactiveLoadBalancer 实例</span>
		<span class="token class-name">ReactiveLoadBalancer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> loadBalancer <span class="token operator">=</span> loadBalancerClientFactory
				<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>serviceId<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>loadBalancer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token class-name">Response</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> loadBalancerResponse <span class="token operator">=</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>loadBalancer<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token punctuation">.</span><span class="token function">block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>loadBalancerResponse <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> loadBalancerResponse<span class="token punctuation">.</span><span class="token function">getServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre>
    <p>
     最后回到 BlockingLoadBalancerClient#execute 逻辑（容器中默认装配的 LoadBalancerClient）：
    </p>
    <p>
     逻辑无非就是选择最终的实例来执行请求
     <br/>
     底层逻辑就是从隔离好的 容器 中获取对应的 ServiceInstanceListSupplier 和 ReactiveLoadBalancer 来选择实例
    </p>
    <h3>
     <a id="_392">
     </a>
     实践指南
    </h3>
    <h4>
     <a id="_394">
     </a>
     配置类
    </h4>
    <ul>
     <li>
      注册中心维度，相当于每个client端隔离一份配置，都走自己定义的逻辑，通过@LoadBalancerClients注解整合到一份配置类中，具体配置一内部类的形式维护，缺点就是，client端规则发生变化时，需要修改对应配置类
     </li>
     <li>
      通用策略配置，每种策略配置隔离一份，通过@LoadBalancerClients注解整合到一份配置类中，client端选择对应的配置即可，缺点就是，组合会很多，比较复杂，但是好处时，如果发生变更的话，只需要更改@LoadBalancerClients的属性值，拓展性也比较好
     </li>
    </ul>
    <p>
     注册中心维度
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@LoadBalancerClients</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@LoadBalancerClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"eureka-client-1"</span><span class="token punctuation">,</span> configuration <span class="token operator">=</span> <span class="token class-name">ClietConfig<span class="token punctuation">.</span>EurekaClient1Config</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token annotation punctuation">@LoadBalancerClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"eureka-client-2"</span><span class="token punctuation">,</span> configuration <span class="token operator">=</span> <span class="token class-name">ClietConfig<span class="token punctuation">.</span>EurekaClient2Config</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ClietConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//如果这里面的规则发生变化，就得改这里面的东西</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EurekaClient1Config</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ... </span>
    <span class="token punctuation">}</span>
    <span class="token comment">//如果这里面的规则发生变化，就得改这里面的东西</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EurekaClient2Config</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     通用策略维度
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@LoadBalancerClients</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@LoadBalancerClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"eureka-client-1"</span><span class="token punctuation">,</span> configuration <span class="token operator">=</span> <span class="token class-name">LoadBalanceConfig<span class="token punctuation">.</span>RandomLoadBalancerConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token punctuation">,</span> <span class="token annotation punctuation">@LoadBalancerClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"eureka-client-2"</span><span class="token punctuation">,</span> configuration <span class="token operator">=</span> <span class="token class-name">LoadBalanceConfig<span class="token punctuation">.</span>ZonePerferServiceListConfig</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoadBalanceConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//这些策略不用更改，一般时通用</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RandomLoadBalancerConfig</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//这些策略不用更改，一般时通用</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">HintServiceListConfig</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ... </span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_438">
     </a>
     灰度切入
    </h4>
    <p>
     目前根据loadbalancer提供的类来看，可以实现灰度切入的有两个地方，分别为：
    </p>
    <ul>
     <li>
      ReactiveLoadBalancer：选择实例
     </li>
     <li>
      ServiceInstanceListSupplier：过滤实例
     </li>
    </ul>
    <p>
     严格意义上来说，我的理解是灰度功能是来选择示例的，并不是过滤实例的，所以我可能更倾向于通过ReactiveLoadBalancer来实现，实现他的choose方法；
    </p>
    <blockquote>
     <p>
      但是这里有个坑是啥？
     </p>
     <p>
      如果你想在ReactiveLoadBalancer层面实现基于请求头的路由决策，你需要在调用choose方法时传递一些上下文信息。Spring Cloud LoadBalancer中的Request接口可以携带这些信息。然而，Request对象需要在调用choose之前构建，并且Spring Cloud LoadBalancer并没有提供一个内置的方式来根据传入的HTTP请求构建这个Request对象。
     </p>
     <p>
      不过这个可以通过上下文来传递下来，需要自己来做一些封装
     </p>
     <p>
      本文暂时不细讲灰度的实现，后续有时间的话，我专门出一篇文章来说
     </p>
    </blockquote>
    <h4>
     <a id="_455">
     </a>
     自定义负载策略
    </h4>
    <p>
     通过"选择实例以及转发"章节的介绍，我们可以发现，loadbalancer主要提供了两个默认策略：
    </p>
    <ul>
     <li>
      RandomLoadBalancer：随机选择
     </li>
     <li>
      RoundRobinLoadBalancer：轮询
     </li>
    </ul>
    <p>
     同时，他们又是被 @ConditionalOnMissingBean修饰，所以，如果我们想自定义自己的策略规则，我们直接通过 @Configuration和@Bean，注入自己的策略就行，以下是一个简单示例
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@LoadBalancerClients</span><span class="token punctuation">(</span>defaultConfiguration <span class="token operator">=</span> <span class="token class-name">MyBalancerConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyBalancerConfiguration</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">/**
     * 自定义负载均衡器
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ReactorLoadBalancer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> <span class="token function">reactorServiceInstanceLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">Environment</span> environment<span class="token punctuation">,</span>
        <span class="token class-name">LoadBalancerClientFactory</span> loadBalancerClientFactory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> name <span class="token operator">=</span> environment<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerClientFactory</span><span class="token punctuation">.</span><span class="token constant">PROPERTY_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyLoadBalancer</span><span class="token punctuation">(</span>
            loadBalancerClientFactory<span class="token punctuation">.</span><span class="token function">getLazyProvider</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token class-name">ServiceInstanceListSupplier</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     其中MyLoadBalancer是我们自定义的规则
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyLoadBalancer</span> <span class="token keyword">implements</span> <span class="token class-name">ReactorServiceInstanceLoadBalancer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> serviceId<span class="token punctuation">;</span>
    <span class="token comment">//服务列表</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstanceListSupplier</span><span class="token punctuation">&gt;</span></span> serviceInstanceListSupplierProvider<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">MyLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">ObjectProvider</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstanceListSupplier</span><span class="token punctuation">&gt;</span></span> supplier<span class="token punctuation">,</span> <span class="token class-name">String</span> serviceId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>serviceId <span class="token operator">=</span> serviceId<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>serviceInstanceListSupplierProvider <span class="token operator">=</span> supplier<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Response</span><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/**
         * 进行路由选择
         */</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_508">
     </a>
     拓展
    </h3>
    <h4>
     <a id="ReactiveLoadBalancer_ServiceInstanceListSupplier__510">
     </a>
     ReactiveLoadBalancer 和ServiceInstanceListSupplier 区别
    </h4>
    <h5>
     <a id="_512">
     </a>
     <strong>
      概念区分
     </strong>
    </h5>
    <table>
     <thead>
      <tr>
       <th>
        组件名称
       </th>
       <th>
        作用
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <strong>
         <code>
          ServiceInstanceListSupplier
         </code>
        </strong>
       </td>
       <td>
        负责提供某个服务的所有可用实例列表（获取并缓存服务实例列表）。
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         <code>
          ReactiveLoadBalancer
         </code>
        </strong>
       </td>
       <td>
        负责基于负载均衡策略，从
        <code>
         ServiceInstanceListSupplier
        </code>
        提供的实例列表中选择一个合适的实例。
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     简单来说：
    </p>
    <ul>
     <li>
      <code>
       ServiceInstanceListSupplier
      </code>
      负责提供
      <strong>
       候选实例列表
      </strong>
      。
     </li>
     <li>
      <code>
       ReactiveLoadBalancer
      </code>
      负责
      <strong>
       从这些候选实例中挑选一个最终的实例
      </strong>
      。
     </li>
    </ul>
    <h5>
     <a id="_524">
     </a>
     <strong>
      核心职责
     </strong>
    </h5>
    <p>
     <strong>
      ServiceInstanceListSupplier
     </strong>
    </p>
    <ul>
     <li>
      <p>
       <strong>
        主要作用
       </strong>
       ：提供目标服务的可用
       <code>
        ServiceInstance
       </code>
       列表。
      </p>
     </li>
     <li>
      <p>
       <strong>
        底层实现
       </strong>
       ：它会通过
       <code>
        DiscoveryClient
       </code>
       （如 Nacos、Eureka 等）获取服务实例列表，并可能会对实例进行缓存、筛选、排序等操作。
      </p>
     </li>
     <li>
      <p>
       <strong>
        接口定义
       </strong>
       ：
      </p>
      <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ServiceInstanceListSupplier</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Flux</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      <ul>
       <li>
        该接口返回一个
        <code>
         Flux&lt;List&lt;ServiceInstance&gt;&gt;
        </code>
        ，代表着它是
        <strong>
         响应式的
        </strong>
        ，能够
        <strong>
         动态推送
        </strong>
        服务实例列表更新（比如当 Nacos 服务实例变更时）。
       </li>
       <li>
        其默认实现
        <code>
         DiscoveryClientServiceInstanceListSupplier
        </code>
        会基于
        <code>
         DiscoveryClient
        </code>
        获取实例信息。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        可以自定义过滤、排序规则
       </strong>
       ：
      </p>
      <ul>
       <li>
        <p>
         例如，你可以扩展
         <code>
          ServiceInstanceListSupplier
         </code>
         ，让它优先返回
         <strong>
          健康检查通过的实例
         </strong>
         ，或者
         <strong>
          特定版本的实例
         </strong>
         。
        </p>
       </li>
       <li>
        <p>
         代码示例：
        </p>
        <pre><code class="prism language-Java">@Component
public class MyCustomInstanceSupplier implements ServiceInstanceListSupplier {
    private final DiscoveryClient discoveryClient;

    public MyCustomInstanceSupplier(DiscoveryClient discoveryClient) {
        this.discoveryClient = discoveryClient;
    }

    @Override
    public Flux&lt;List&lt;ServiceInstance&gt;&gt; get() {
        return Flux.defer(() -&gt; {
            List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances("my-service");
            // 自定义筛选逻辑，比如过滤掉某些状态的实例
            List&lt;ServiceInstance&gt; filteredInstances = instances.stream()
                .filter(instance -&gt; instance.getMetadata().get("status").equals("UP"))
                .collect(Collectors.toList());
            return Flux.just(filteredInstances);
        });
    }
}
</code></pre>
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <p>
     <strong>
      <code>
       ReactiveLoadBalancer
      </code>
     </strong>
    </p>
    <ul>
     <li>
      <p>
       <strong>
        主要作用
       </strong>
       ：根据某种负载均衡算法，从
       <code>
        ServiceInstanceListSupplier
       </code>
       提供的实例中挑选一个。
      </p>
     </li>
     <li>
      <p>
       <strong>
        底层实现
       </strong>
       ：它的核心方法是：
      </p>
      <pre><code class="prism language-Java">public interface ReactiveLoadBalancer&lt;T&gt; {
    Mono&lt;Response&lt;T&gt;&gt; choose(Request request);
}
</code></pre>
      <ul>
       <li>
        <code>
         choose(Request request)
        </code>
        : 选择一个具体的
        <code>
         ServiceInstance
        </code>
        。
       </li>
       <li>
        其中
        <code>
         T
        </code>
        通常是
        <code>
         ServiceInstance
        </code>
        ，也可以是
        <code>
         Response&lt;ServiceInstance&gt;
        </code>
        （包含 metadata）。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        默认实现
       </strong>
      </p>
      <ul>
       <li>
        <code>
         RoundRobinLoadBalancer
        </code>
        ：基于轮询算法选择实例。
       </li>
       <li>
        <code>
         RandomLoadBalancer
        </code>
        ：随机选择一个实例。
       </li>
       <li>
        <code>
         CachingServiceInstanceListSupplier
        </code>
        ：基于缓存提高性能，避免频繁查询服务列表。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        示例：自定义
        <code>
         ReactiveLoadBalancer
        </code>
       </strong>
      </p>
      <ul>
       <li>
        <p>
         例如，你可以自定义负载均衡算法，优先选择 CPU 负载最低的实例：
        </p>
        <pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyCustomLoadBalancer</span> <span class="token keyword">implements</span> <span class="token class-name">ReactiveLoadBalancer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ServiceInstanceListSupplier</span> supplier<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyCustomLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">ServiceInstanceListSupplier</span> supplier<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>supplier <span class="token operator">=</span> supplier<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Response</span><span class="token punctuation">&lt;</span><span class="token class-name">ServiceInstance</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Request</span> request<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> supplier<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>instances <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 选择 CPU 负载最低的实例</span>
                <span class="token class-name">ServiceInstance</span> selectedInstance <span class="token operator">=</span> instances<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span>instance <span class="token operator">-&gt;</span> <span class="token function">getCpuLoad</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultResponse</span><span class="token punctuation">(</span>selectedInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">double</span> <span class="token function">getCpuLoad</span><span class="token punctuation">(</span><span class="token class-name">ServiceInstance</span> instance<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 这里假设实例 metadata 里包含 cpu_load</span>
        <span class="token keyword">return</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span><span class="token function">getMetadata</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token string">"cpu_load"</span><span class="token punctuation">,</span> <span class="token string">"100"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="_627">
     </a>
     <strong>
      完整负载均衡流程
     </strong>
    </h5>
    <ol>
     <li>
      客户端发起请求
      <ul>
       <li>
        例如，Spring Cloud Gateway 或 RestTemplate 发起对
        <code>
         my-service
        </code>
        的调用。
       </li>
      </ul>
     </li>
     <li>
      获取可用实例列表
      <ul>
       <li>
        <code>
         ServiceInstanceListSupplier.get()
        </code>
        从注册中心（Nacos、Eureka）获取
        <code>
         my-service
        </code>
        的所有实例。
       </li>
      </ul>
     </li>
     <li>
      选择负载均衡策略
      <ul>
       <li>
        <code>
         ReactiveLoadBalancer.choose(request)
        </code>
        使用
        <code>
         RoundRobinLoadBalancer
        </code>
        或自定义策略，选择一个实例。
       </li>
      </ul>
     </li>
     <li>
      最终返回一个实例
      <ul>
       <li>
        <code>
         ReactiveLoadBalancer
        </code>
        选出具体的
        <code>
         ServiceInstance
        </code>
        ，并返回给
        <code>
         WebClient
        </code>
        或
        <code>
         RestTemplate
        </code>
        进行请求。
       </li>
      </ul>
     </li>
    </ol>
    <p>
     <strong>
      示意图：
     </strong>
    </p>
    <pre><code>请求 -&gt; ServiceInstanceListSupplier 获取实例列表 -&gt; ReactiveLoadBalancer 选择实例 -&gt; 返回实例给调用方
</code></pre>
    <hr/>
    <h5>
     <a id="_646">
     </a>
     <strong>
      总结
     </strong>
    </h5>
    <table>
     <thead>
      <tr>
       <th>
        组件
       </th>
       <th>
        主要作用
       </th>
       <th>
        关键方法
       </th>
       <th>
        关系
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <strong>
         <code>
          ServiceInstanceListSupplier
         </code>
        </strong>
       </td>
       <td>
        提供某个服务的可用实例列表
       </td>
       <td>
        <code>
         Flux&lt;List&lt;ServiceInstance&gt;&gt; get()
        </code>
       </td>
       <td>
        负责获取
        <strong>
         候选服务实例
        </strong>
       </td>
      </tr>
      <tr>
       <td>
        <strong>
         <code>
          ReactiveLoadBalancer
         </code>
        </strong>
       </td>
       <td>
        依据负载均衡策略选择具体实例
       </td>
       <td>
        <code>
         Mono&lt;Response&lt;ServiceInstance&gt;&gt; choose(Request request)
        </code>
       </td>
       <td>
        负责
        <strong>
         选择最终的服务实例
        </strong>
       </td>
      </tr>
     </tbody>
    </table>
    <ul>
     <li>
      <code>
       ServiceInstanceListSupplier
      </code>
      负责从服务发现组件（如 Nacos）获取所有可用实例，可能还会做
      <strong>
       缓存、排序、过滤
      </strong>
      。
     </li>
     <li>
      <code>
       ReactiveLoadBalancer
      </code>
      负责根据负载均衡策略（轮询、随机、自定义策略）从
      <code>
       ServiceInstanceListSupplier
      </code>
      获取的实例中挑选一个最终的实例。
     </li>
     <li>
      <code>
       ReactiveLoadBalancer
      </code>
      <strong>
       依赖
      </strong>
      <code>
       ServiceInstanceListSupplier
      </code>
      ，它无法直接从 Nacos 之类的服务注册中心获取实例，而是必须由
      <code>
       ServiceInstanceListSupplier
      </code>
      提供候选实例。
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f7a7a31383433353834323637352f:61727469636c652f64657461696c732f313436323631343336" class_="artid" style="display:none">
 </p>
</div>


