---
layout: post
title: "Android12-添加开机铃声"
date: 2025-03-06 10:04:05 +0800
description: "系统默认是没有播放开机铃声的功能，MTK有一套自己的开机铃声处理逻辑，代码在下，但是在10之后MTK就不在维护这部分代码了。直接使用会有很多编译报错，现在把MTK播放铃声的逻辑移植过来。"
keywords: "Android12 添加开机铃声"
categories: ['系统修改与定制', 'Android']
tags: ['Bootanim', 'Audio']
artid: "146059650"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146059650
    alt: "Android12-添加开机铃声"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146059650
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146059650
cover: https://bing.ee123.net/img/rand?artid=146059650
image: https://bing.ee123.net/img/rand?artid=146059650
img: https://bing.ee123.net/img/rand?artid=146059650
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Android12 添加开机铃声
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     系统默认是没有播放开机铃声的功能，MTK有一套自己的开机铃声处理逻辑，代码在
     <code>
      /vendor/mediatek/proprietary/operator/frameworks/bootanimation/MtkBootanimation
     </code>
     下，但是在10之后MTK就不在维护这部分代码了。直接使用会有很多编译报错，现在把MTK播放铃声的逻辑移植过来。
    </p>
    <h6>
     <a id="_1">
     </a>
     移植铃声播放功能
    </h6>
    <ul>
     <li>
      /frameworks/base/cmds/bootanimation/BootAnimation.cpp
     </li>
    </ul>
    <pre><code class="prism language-java">index <span class="token number">958558669</span>ef<span class="token punctuation">.</span><span class="token number">.3</span>b4eb12ee00 <span class="token number">100755</span>
<span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>cmds<span class="token operator">/</span>bootanimation<span class="token operator">/</span><span class="token class-name">BootAnimation</span><span class="token punctuation">.</span>cpp
<span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>cmds<span class="token operator">/</span>bootanimation<span class="token operator">/</span><span class="token class-name">BootAnimation</span><span class="token punctuation">.</span>cpp
@@ <span class="token operator">-</span><span class="token number">59</span><span class="token punctuation">,</span><span class="token number">10</span> <span class="token operator">+</span><span class="token number">59</span><span class="token punctuation">,</span><span class="token number">20</span> @@
 
 #include <span class="token string">"BootAnimation.h"</span>
 
<span class="token operator">+</span>#include <span class="token operator">&lt;</span>media<span class="token operator">/</span><span class="token class-name">IMediaHTTPService</span><span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
<span class="token operator">+</span>#include <span class="token operator">&lt;</span>media<span class="token operator">/</span>mediaplayer<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
<span class="token operator">+</span>#include <span class="token operator">&lt;</span>media<span class="token operator">/</span><span class="token class-name">MediaPlayerInterface</span><span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
<span class="token operator">+</span>
 #define <span class="token constant">ANIM_PATH_MAX</span> <span class="token number">255</span>
 #define <span class="token function">STR</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>   #x
 #define <span class="token function">STRTO</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token function">STR</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
 
<span class="token operator">+</span>#define <span class="token constant">PATH_COUNT</span> <span class="token number">2</span>
<span class="token operator">+</span><span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> mAudioPath<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token constant">PATH_COUNT</span><span class="token punctuation">]</span> <span class="token operator">=</span>
<span class="token operator">+</span>    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token string">"/system/media/bootaudio.mp3"</span><span class="token punctuation">,</span> <span class="token string">"/custom/media/bootaudio.mp3"</span><span class="token punctuation">}</span> <span class="token punctuation">,</span> <span class="token comment">/*  bootaudio path  */</span>
<span class="token operator">+</span>     <span class="token punctuation">{<!-- --></span><span class="token string">"/system/media/shutaudio.mp3"</span><span class="token punctuation">,</span> <span class="token string">"/custom/media/shutaudio.mp3"</span><span class="token punctuation">}</span> <span class="token comment">/*  shutaudio path  */</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">+</span>
 namespace android <span class="token punctuation">{<!-- --></span>
 
 using ui<span class="token operator">::</span><span class="token class-name">DisplayMode</span><span class="token punctuation">;</span>
@@ <span class="token operator">-</span><span class="token number">123</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">133</span><span class="token punctuation">,</span><span class="token number">11</span> @@ <span class="token class-name">BootAnimation</span><span class="token operator">::</span><span class="token class-name">BootAnimation</span><span class="token punctuation">(</span>sp<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Callbacks</span><span class="token punctuation">&gt;</span></span> callbacks<span class="token punctuation">)</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
         mShuttingDown <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>    bPlayMP3 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    mBootVideoPlayState <span class="token operator">=</span> <span class="token constant">MEDIA_NOP</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    bAudioStarted <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token operator">+</span>
     <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"%sAnimationStartTiming start time: %"</span> <span class="token class-name">PRId64</span> <span class="token string">"ms"</span><span class="token punctuation">,</span> mShuttingDown <span class="token operator">?</span> <span class="token string">"Shutdown"</span> <span class="token operator">:</span> <span class="token string">"Boot"</span><span class="token punctuation">,</span>
             <span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
@@ <span class="token operator">-</span><span class="token number">136</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">151</span><span class="token punctuation">,</span><span class="token number">50</span> @@ <span class="token class-name">BootAnimation</span><span class="token operator">::</span><span class="token operator">~</span><span class="token class-name">BootAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
             <span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
<span class="token operator">+</span><span class="token class-name">BootVideoListener</span><span class="token operator">::</span><span class="token class-name">BootVideoListener</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BootAnimation</span><span class="token punctuation">&gt;</span></span> <span class="token operator">&amp;</span>bootanim<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>    <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"[MtkBootAnimation %s %d]"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>__LINE__<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    mBootanim <span class="token operator">=</span> bootanim<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span><span class="token class-name">BootVideoListener</span><span class="token operator">::</span><span class="token operator">~</span><span class="token class-name">BootVideoListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>    <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"[MtkBootAnimation %s %d]"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>__LINE__<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span><span class="token keyword">void</span> <span class="token class-name">BootVideoListener</span><span class="token operator">::</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token keyword">int</span> msg<span class="token punctuation">,</span> <span class="token keyword">int</span> ext1<span class="token punctuation">,</span> <span class="token keyword">int</span> ext2<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">Parcel</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>    <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"[MtkBootAnimation %s %d] msg=%d ext1=%d ext2=%d"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>__LINE__<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> ext1<span class="token punctuation">,</span> ext2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token constant">MEDIA_PLAYBACK_COMPLETE</span> <span class="token operator">||</span> msg <span class="token operator">==</span> <span class="token constant">MEDIA_SEEK_COMPLETE</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>        mBootanim<span class="token operator">-&gt;</span><span class="token function">setBootVideoPlayState</span><span class="token punctuation">(</span><span class="token constant">MEDIA_PLAYBACK_COMPLETE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"[MtkBootAnimation %s %d] media player complete"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>__LINE__<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token constant">MEDIA_ERROR</span> <span class="token operator">||</span> msg <span class="token operator">==</span> <span class="token constant">MEDIA_SKIPPED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>        mBootanim<span class="token operator">-&gt;</span><span class="token function">setBootVideoPlayState</span><span class="token punctuation">(</span><span class="token constant">MEDIA_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"[MtkBootAnimation %s %d] media player error"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>__LINE__<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>msg <span class="token operator">==</span> <span class="token constant">MEDIA_STARTED</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>        mBootanim<span class="token operator">-&gt;</span><span class="token function">setBootAudioStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"[MtkBootAnimation %s %d] AudioStarted"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>__LINE__<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span>#ifdef <span class="token constant">MTK_AOSP_ENHANCEMENT</span>
<span class="token operator">+</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>msg <span class="token operator">==</span>  <span class="token constant">MEDIA_ERROR_TYPE_NOT_SUPPORTED</span> <span class="token operator">||</span> msg <span class="token operator">==</span>  <span class="token constant">MEDIA_ERROR_BAD_FILE</span>
<span class="token operator">+</span>        <span class="token operator">||</span> msg <span class="token operator">==</span> <span class="token constant">MEDIA_ERROR_CANNOT_CONNECT_TO_SERVER</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>        mBootanim<span class="token operator">-&gt;</span><span class="token function">setBootVideoPlayState</span><span class="token punctuation">(</span><span class="token constant">MEDIA_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"[MtkBootAnimation %s %d] media player error"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>__LINE__<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span>#endif
<span class="token operator">+</span>    <span class="token keyword">if</span><span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>        <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"[MtkBootAnimation %s %d]obj is null \n"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>__LINE__<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span><span class="token keyword">void</span> <span class="token class-name">BootAnimation</span><span class="token operator">::</span><span class="token function">setBootVideoPlayState</span><span class="token punctuation">(</span><span class="token keyword">int</span> playState<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>    mBootVideoPlayState <span class="token operator">=</span> playState<span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"[MtkBootAnimation %s %d]mBootVideoPlayState=%d"</span><span class="token punctuation">,</span>__FUNCTION__<span class="token punctuation">,</span>__LINE__<span class="token punctuation">,</span> mBootVideoPlayState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span><span class="token keyword">void</span> <span class="token class-name">BootAnimation</span><span class="token operator">::</span><span class="token function">setBootAudioStarted</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token operator">+</span><span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>    <span class="token class-name">AutoMutex</span> <span class="token function">_l</span><span class="token punctuation">(</span>mMyLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    bAudioStarted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    mCondition<span class="token punctuation">.</span><span class="token function">signal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
 <span class="token keyword">void</span> <span class="token class-name">BootAnimation</span><span class="token operator">::</span><span class="token function">onFirstRef</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     status_t err <span class="token operator">=</span> mSession<span class="token operator">-&gt;</span><span class="token function">linkToComposerDeath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">SLOGE_IF</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span> <span class="token string">"linkToComposerDeath failed (%s) "</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token operator">-</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@ <span class="token operator">-</span><span class="token number">606</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">665</span><span class="token punctuation">,</span><span class="token number">51</span> @@ <span class="token keyword">void</span> <span class="token class-name">BootAnimation</span><span class="token operator">::</span><span class="token function">findBootAnimationFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
 <span class="token punctuation">}</span>
 
 bool <span class="token class-name">BootAnimation</span><span class="token operator">::</span><span class="token function">threadLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>    sp<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MediaPlayer</span><span class="token punctuation">&gt;</span></span> mediaplayer<span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> resourcePath <span class="token operator">=</span> <span class="token function">initAudioPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    status_t mediastatus <span class="token operator">=</span> <span class="token constant">NO_ERROR</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>resourcePath <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>        bPlayMP3 <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"sound file path: %s"</span><span class="token punctuation">,</span> resourcePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        mediaplayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MediaPlayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        mediastatus <span class="token operator">=</span> mediaplayer<span class="token operator">-&gt;</span><span class="token function">setDataSource</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> resourcePath<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span>        sp<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BootVideoListener</span><span class="token punctuation">&gt;</span></span> listener <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BootVideoListener</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        mediaplayer<span class="token operator">-&gt;</span><span class="token function">setListener</span><span class="token punctuation">(</span>listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mediastatus <span class="token operator">==</span> <span class="token constant">NO_ERROR</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>            <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"mediaplayer is initialized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token class-name">Parcel</span><span class="token operator">*</span> attributes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Parcel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            attributes<span class="token operator">-&gt;</span><span class="token function">writeInt32</span><span class="token punctuation">(</span><span class="token constant">AUDIO_USAGE_MEDIA</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//usage</span>
<span class="token operator">+</span>            attributes<span class="token operator">-&gt;</span><span class="token function">writeInt32</span><span class="token punctuation">(</span><span class="token constant">AUDIO_CONTENT_TYPE_MUSIC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//audio_content_type_t</span>
<span class="token operator">+</span>            attributes<span class="token operator">-&gt;</span><span class="token function">writeInt32</span><span class="token punctuation">(</span><span class="token constant">AUDIO_SOURCE_DEFAULT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//audio_source_t</span>
<span class="token operator">+</span>            attributes<span class="token operator">-&gt;</span><span class="token function">writeInt32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">//audio_flags_mask_t</span>
<span class="token operator">+</span>            attributes<span class="token operator">-&gt;</span><span class="token function">writeInt32</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">//kAudioAttributesMarshallTagFlattenTags of mediaplayerservice.cpp</span>
<span class="token operator">+</span>            attributes<span class="token operator">-&gt;</span><span class="token function">writeString16</span><span class="token punctuation">(</span><span class="token class-name">String16</span><span class="token punctuation">(</span><span class="token string">"BootAnimationAudioTrack"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// tags</span>
<span class="token operator">+</span>            mediaplayer<span class="token operator">-&gt;</span><span class="token function">setParameter</span><span class="token punctuation">(</span><span class="token constant">KEY_PARAMETER_AUDIO_ATTRIBUTES</span><span class="token punctuation">,</span> <span class="token operator">*</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            mediaplayer<span class="token operator">-&gt;</span><span class="token function">setAudioStreamType</span><span class="token punctuation">(</span><span class="token constant">AUDIO_STREAM_MUSIC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token comment">//mediaplayer-&gt;setVolume(1.0, 1.0);</span>
<span class="token operator">+</span>            mediastatus <span class="token operator">=</span> mediaplayer<span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token punctuation">}</span>
<span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mediastatus <span class="token operator">==</span> <span class="token constant">NO_ERROR</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>            <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"media player is prepared"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            mediastatus <span class="token operator">=</span> mediaplayer<span class="token operator">-&gt;</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>        bPlayMP3 <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>    <span class="token comment">//mediaplayer start is an async API, and it will be ready after mediaserver parsing all</span>
<span class="token operator">+</span>    <span class="token comment">// components which will take some time and cause aduio and video not sync.</span>
<span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>bPlayMP3 <span class="token operator">&amp;&amp;</span> mediastatus <span class="token operator">==</span> <span class="token constant">NO_ERROR</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>        <span class="token class-name">AutoMutex</span> <span class="token function">_l</span><span class="token punctuation">(</span>mMyLock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bAudioStarted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>            status_t err <span class="token operator">=</span> mCondition<span class="token punctuation">.</span><span class="token function">waitRelative</span><span class="token punctuation">(</span>mMyLock<span class="token punctuation">,</span> <span class="token function">s2ns</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"audio started re %d"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token punctuation">}</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span>
     bool result<span class="token punctuation">;</span>
     <span class="token comment">// We have no bootanimation file, so we use the stock android logo</span>
     <span class="token comment">// animation.</span>
@@ <span class="token operator">-</span><span class="token number">615</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">719</span><span class="token punctuation">,</span><span class="token number">15</span> @@ bool <span class="token class-name">BootAnimation</span><span class="token operator">::</span><span class="token function">threadLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         result <span class="token operator">=</span> <span class="token function">movie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 
<span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>resourcePath <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mediastatus <span class="token operator">==</span> <span class="token constant">NO_ERROR</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>            <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"mediaplayer was stareted successfully, now it is going to be stoped"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            mediaplayer<span class="token operator">-&gt;</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            mediaplayer<span class="token operator">-&gt;</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            mediaplayer<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token punctuation">}</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span>
     mCallbacks<span class="token operator">-&gt;</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">eglMakeCurrent</span><span class="token punctuation">(</span>mDisplay<span class="token punctuation">,</span> <span class="token constant">EGL_NO_SURFACE</span><span class="token punctuation">,</span> <span class="token constant">EGL_NO_SURFACE</span><span class="token punctuation">,</span> <span class="token constant">EGL_NO_CONTEXT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token function">eglDestroyContext</span><span class="token punctuation">(</span>mDisplay<span class="token punctuation">,</span> mContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
@@ <span class="token operator">-</span><span class="token number">694</span><span class="token punctuation">,</span><span class="token number">7</span> <span class="token operator">+</span><span class="token number">807</span><span class="token punctuation">,</span><span class="token number">13</span> @@ bool <span class="token class-name">BootAnimation</span><span class="token operator">::</span><span class="token function">android</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>sleepTime <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
             <span class="token function">usleep</span><span class="token punctuation">(</span>sleepTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token operator">-</span>        <span class="token function">checkExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bPlayMP3<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>            <span class="token function">checkExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>mBootVideoPlayState <span class="token operator">==</span> <span class="token constant">MEDIA_PLAYBACK_COMPLETE</span> <span class="token operator">||</span> mBootVideoPlayState <span class="token operator">==</span> <span class="token constant">MEDIA_ERROR</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>               <span class="token function">checkExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token punctuation">}</span>
<span class="token operator">+</span>        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">exitPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
     <span class="token function">glDeleteTextures</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>mAndroid<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
@@ <span class="token operator">-</span><span class="token number">1363</span><span class="token punctuation">,</span><span class="token number">7</span> <span class="token operator">+</span><span class="token number">1482</span><span class="token punctuation">,</span><span class="token number">13</span> @@ bool <span class="token class-name">BootAnimation</span><span class="token operator">::</span><span class="token function">playAnimation</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">Animation</span><span class="token operator">&amp;</span> animation<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                     <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>err<span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> errno <span class="token operator">==</span> <span class="token constant">EINTR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
 
<span class="token operator">-</span>                <span class="token function">checkExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>bPlayMP3<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>                    <span class="token function">checkExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>                    <span class="token keyword">if</span><span class="token punctuation">(</span>mBootVideoPlayState <span class="token operator">==</span> <span class="token constant">MEDIA_PLAYBACK_COMPLETE</span> <span class="token operator">||</span> mBootVideoPlayState <span class="token operator">==</span> <span class="token constant">MEDIA_ERROR</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>                       <span class="token function">checkExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>                    <span class="token punctuation">}</span>
<span class="token operator">+</span>                <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
 
             <span class="token function">usleep</span><span class="token punctuation">(</span>part<span class="token punctuation">.</span>pause <span class="token operator">*</span> <span class="token function">ns2us</span><span class="token punctuation">(</span>frameDuration<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
@@ <span class="token operator">-</span><span class="token number">1612</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">1737</span><span class="token punctuation">,</span><span class="token number">23</span> @@ status_t <span class="token class-name">BootAnimation</span><span class="token operator">::</span><span class="token class-name">TimeCheckThread</span><span class="token operator">::</span><span class="token function">readyToRun</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     <span class="token keyword">return</span> <span class="token constant">NO_ERROR</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
 
<span class="token operator">+</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token class-name">BootAnimation</span><span class="token operator">::</span><span class="token function">initAudioPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>    <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>mShuttingDown<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>        index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>        index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span>
<span class="token operator">+</span>    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">PATH_COUNT</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span>mAudioPath<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">F_OK</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>            <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"initAudioPath: audio path = %s"</span><span class="token punctuation">,</span> mAudioPath<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token keyword">return</span> mAudioPath<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">+</span>        <span class="token punctuation">}</span>
<span class="token operator">+</span>    <span class="token punctuation">}</span>
<span class="token operator">+</span>    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span>
<span class="token operator">+</span>
 <span class="token comment">// ---------------------------------------------------------------------------</span>
 
 <span class="token punctuation">}</span> <span class="token comment">// namespace android</span>
</code></pre>
    <ul>
     <li>
      /frameworks/base/cmds/bootanimation/BootAnimation.h
     </li>
    </ul>
    <pre><code class="prism language-java">index f8a31c6d879<span class="token punctuation">.</span><span class="token number">.2e3</span>c0c2430e <span class="token number">100755</span>
<span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>cmds<span class="token operator">/</span>bootanimation<span class="token operator">/</span><span class="token class-name">BootAnimation</span><span class="token punctuation">.</span>h
<span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>cmds<span class="token operator">/</span>bootanimation<span class="token operator">/</span><span class="token class-name">BootAnimation</span><span class="token punctuation">.</span>h
@@ <span class="token operator">-</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">33</span><span class="token punctuation">,</span><span class="token number">8</span> @@
 #include <span class="token operator">&lt;</span><span class="token constant">EGL</span><span class="token operator">/</span>egl<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
 #include <span class="token operator">&lt;</span><span class="token constant">GLES</span><span class="token operator">/</span>gl<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
 
<span class="token operator">+</span>#include <span class="token operator">&lt;</span>media<span class="token operator">/</span>mediaplayer<span class="token punctuation">.</span>h<span class="token operator">&gt;</span>
<span class="token operator">+</span>
 namespace android <span class="token punctuation">{<!-- --></span>
 
 <span class="token keyword">class</span> <span class="token class-name">Surface</span><span class="token punctuation">;</span>
@@ <span class="token operator">-</span><span class="token number">129</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">131</span><span class="token punctuation">,</span><span class="token number">8</span> @@ <span class="token keyword">public</span><span class="token operator">:</span>
 
     explicit <span class="token class-name">BootAnimation</span><span class="token punctuation">(</span>sp<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Callbacks</span><span class="token punctuation">&gt;</span></span> callbacks<span class="token punctuation">)</span><span class="token punctuation">;</span>
     virtual <span class="token operator">~</span><span class="token class-name">BootAnimation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">void</span> <span class="token function">setBootVideoPlayState</span><span class="token punctuation">(</span><span class="token keyword">int</span> playState<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">void</span> <span class="token function">setBootAudioStarted</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 
     sp<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SurfaceComposerClient</span><span class="token punctuation">&gt;</span></span> <span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
 
@@ <span class="token operator">-</span><span class="token number">193</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">197</span><span class="token punctuation">,</span><span class="token number">14</span> @@ <span class="token keyword">private</span><span class="token operator">:</span>
 
     <span class="token keyword">void</span> <span class="token function">handleViewport</span><span class="token punctuation">(</span>nsecs_t timestep<span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token operator">+</span>    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">initAudioPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span>    bool bPlayMP3<span class="token punctuation">;</span>
<span class="token operator">+</span>    bool bAudioStarted<span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token keyword">int</span> mBootVideoPlayState<span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token class-name">Mutex</span>  mMyLock<span class="token punctuation">;</span>
<span class="token operator">+</span>    <span class="token class-name">Condition</span> mCondition<span class="token punctuation">;</span>
<span class="token operator">+</span>
     sp<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SurfaceComposerClient</span><span class="token punctuation">&gt;</span></span>       mSession<span class="token punctuation">;</span>
     <span class="token class-name">AssetManager</span> mAssets<span class="token punctuation">;</span>
     <span class="token class-name">Texture</span>     mAndroid<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
@@ <span class="token operator">-</span><span class="token number">220</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">232</span><span class="token punctuation">,</span><span class="token number">14</span> @@ <span class="token keyword">private</span><span class="token operator">:</span>
     <span class="token class-name">Animation</span><span class="token operator">*</span> mAnimation <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token operator">+</span><span class="token keyword">class</span> <span class="token class-name">BootVideoListener</span><span class="token operator">:</span> <span class="token keyword">public</span> <span class="token class-name">MediaPlayerListener</span><span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span><span class="token keyword">public</span><span class="token operator">:</span>
<span class="token operator">+</span>                <span class="token class-name">BootVideoListener</span><span class="token punctuation">(</span><span class="token keyword">const</span> sp<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BootAnimation</span><span class="token punctuation">&gt;</span></span> <span class="token operator">&amp;</span>player<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    virtual     <span class="token operator">~</span><span class="token class-name">BootVideoListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    virtual <span class="token keyword">void</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token keyword">int</span> msg<span class="token punctuation">,</span> <span class="token keyword">int</span> ext1<span class="token punctuation">,</span> <span class="token keyword">int</span> ext2<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">Parcel</span> <span class="token operator">*</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>    sp<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">BootAnimation</span><span class="token punctuation">&gt;</span></span> mBootanim<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">+</span>
 <span class="token comment">// ---------------------------------------------------------------------------</span>
 
 <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// namespace android</span>
</code></pre>
    <h6>
     <a id="lib_270">
     </a>
     添加lib库
    </h6>
    <ul>
     <li>
      /frameworks/base/cmds/bootanimation/Android.bp
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>cmds<span class="token operator">/</span>bootanimation<span class="token operator">/</span><span class="token class-name">Android</span><span class="token punctuation">.</span>bp
<span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>frameworks<span class="token operator">/</span>base<span class="token operator">/</span>cmds<span class="token operator">/</span>bootanimation<span class="token operator">/</span><span class="token class-name">Android</span><span class="token punctuation">.</span>bp
@@ <span class="token operator">-</span><span class="token number">73</span><span class="token punctuation">,</span><span class="token number">5</span> <span class="token operator">+</span><span class="token number">73</span><span class="token punctuation">,</span><span class="token number">6</span> @@ cc_library_shared <span class="token punctuation">{<!-- --></span>
         <span class="token string">"libEGL"</span><span class="token punctuation">,</span>
         <span class="token string">"libGLESv1_CM"</span><span class="token punctuation">,</span>
         <span class="token string">"libgui"</span><span class="token punctuation">,</span>
<span class="token operator">+</span>        <span class="token string">"libmedia"</span><span class="token punctuation">,</span>
     <span class="token punctuation">]</span><span class="token punctuation">,</span>
 <span class="token punctuation">}</span>
</code></pre>
    <h6>
     <a id="_284">
     </a>
     第一次开机铃声不全
    </h6>
    <ul>
     <li>
      /frameworks/av/services/audioflinger/Threads.cpp
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>frameworks<span class="token operator">/</span>av<span class="token operator">/</span>services<span class="token operator">/</span>audioflinger<span class="token operator">/</span><span class="token class-name">Threads</span><span class="token punctuation">.</span>cpp
<span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>frameworks<span class="token operator">/</span>av<span class="token operator">/</span>services<span class="token operator">/</span>audioflinger<span class="token operator">/</span><span class="token class-name">Threads</span><span class="token punctuation">.</span>cpp
@@ <span class="token operator">-</span><span class="token number">5734</span><span class="token punctuation">,</span><span class="token number">6</span> <span class="token operator">+</span><span class="token number">5734</span><span class="token punctuation">,</span><span class="token number">17</span> @@ <span class="token class-name">AudioFlinger</span><span class="token operator">::</span><span class="token class-name">PlaybackThread</span><span class="token operator">::</span><span class="token function">mixer_state</span> <span class="token class-name">AudioFlinger</span><span class="token operator">::</span><span class="token class-name">MixerThread</span><span class="token operator">::</span><span class="token function">prepareTrac</span>
                 track<span class="token operator">-&gt;</span>mHasVolumeController <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>
 
<span class="token operator">+</span>            <span class="token comment">//add begin</span>
<span class="token operator">+</span>            <span class="token keyword">char</span> mvalue<span class="token punctuation">[</span><span class="token constant">PROPERTY_VALUE_MAX</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token function">property_get</span><span class="token punctuation">(</span><span class="token string">"service.bootanim.exit"</span><span class="token punctuation">,</span> mvalue<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>mvalue<span class="token punctuation">,</span><span class="token string">"0"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token operator">+</span>                <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"bootanim volume setting"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span>                vlf <span class="token operator">=</span> <span class="token number">0.25f</span><span class="token punctuation">;</span>
<span class="token operator">+</span>                vrf <span class="token operator">=</span> <span class="token number">0.25f</span><span class="token punctuation">;</span>
<span class="token operator">+</span>            <span class="token punctuation">}</span>
<span class="token operator">+</span>            <span class="token comment">//add end</span>
<span class="token operator">+</span>
             <span class="token comment">// XXX: these things DON'T need to be done each time</span>
             mAudioMixer<span class="token operator">-&gt;</span><span class="token function">setBufferProvider</span><span class="token punctuation">(</span>trackId<span class="token punctuation">,</span> track<span class="token punctuation">)</span><span class="token punctuation">;</span>
             mAudioMixer<span class="token operator">-&gt;</span><span class="token function">enable</span><span class="token punctuation">(</span>trackId<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
    <h6>
     <a id="_309">
     </a>
     添加权限
    </h6>
    <ul>
     <li>
      /device/mediatek/sepolicy/bsp/plat_private/audioserver.te
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token operator">--</span><span class="token operator">-</span> a<span class="token operator">/</span>device<span class="token operator">/</span>mediatek<span class="token operator">/</span>sepolicy<span class="token operator">/</span>bsp<span class="token operator">/</span>plat_private<span class="token operator">/</span>audioserver<span class="token punctuation">.</span>te
<span class="token operator">++</span><span class="token operator">+</span> b<span class="token operator">/</span>device<span class="token operator">/</span>mediatek<span class="token operator">/</span>sepolicy<span class="token operator">/</span>bsp<span class="token operator">/</span>plat_private<span class="token operator">/</span>audioserver<span class="token punctuation">.</span>te
@@ <span class="token operator">-</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token operator">+</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">5</span> @@ allow audioserver mtk_perf_service<span class="token operator">:</span>service_manager find<span class="token punctuation">;</span>
 
 allow audioserver debuglog_data_file<span class="token operator">:</span>dir <span class="token punctuation">{<!-- --></span> relabelto create_dir_perms <span class="token punctuation">}</span><span class="token punctuation">;</span>
 allow audioserver debuglog_data_file<span class="token operator">:</span>file create_file_perms<span class="token punctuation">;</span>
<span class="token operator">+</span>
<span class="token operator">+</span>allow audioserver bootanim_system_prop<span class="token operator">:</span>file <span class="token punctuation">{<!-- --></span> read <span class="token keyword">open</span> <span class="token namespace">getattr</span> map<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h6>
     <a id="_322">
     </a>
     复制铃声文件
    </h6>
    <ul>
     <li>
      /vendor/audio-logo/products/resource-copy.mk
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token constant">LOCAL_PATH</span><span class="token operator">:</span><span class="token operator">=</span> vendor<span class="token operator">/</span>audio<span class="token operator">-</span>logo<span class="token operator">/</span>
#boot animation
zip_files<span class="token operator">:</span><span class="token operator">=</span> $<span class="token punctuation">(</span>notdir $<span class="token punctuation">(</span>wildcard $<span class="token punctuation">(</span><span class="token constant">LOCAL_PATH</span><span class="token punctuation">)</span><span class="token operator">/</span>animation<span class="token comment">/*.zip))
PRODUCT_COPY_FILES += $(foreach file, $(zip_files), \
	$(LOCAL_PATH)/animation/$(file):system/media/$(file))

#boot/shut audio
mp3_files:= $(notdir $(wildcard $(LOCAL_PATH)/animation/*.mp3))
PRODUCT_COPY_FILES += $(foreach file, $(mp3_files), \
	$(LOCAL_PATH)/animation/$(file):system/media/$(file))
</span></code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f7778645f6373646e5f323031362f:61727469636c652f64657461696c732f313436303539363530" class_="artid" style="display:none">
 </p>
</div>


