---
layout: post
title: "基于GrafanaPrometheus的IB网卡硬件计数器监控方案"
date: 2025-03-13 16:25:49 +0800
description: "基于Grafana+Prometheus的IB网卡硬件计数器监控方案"
keywords: "基于Grafana+Prometheus的IB网卡硬件计数器监控方案"
categories: ['调试工具']
tags: ['信息可视化', 'Prometheus', 'Grafana']
artid: "146234639"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146234639
    alt: "基于GrafanaPrometheus的IB网卡硬件计数器监控方案"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146234639
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146234639
cover: https://bing.ee123.net/img/rand?artid=146234639
image: https://bing.ee123.net/img/rand?artid=146234639
img: https://bing.ee123.net/img/rand?artid=146234639
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     基于Grafana+Prometheus的IB网卡硬件计数器监控方案
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h3>
     <a id="_1">
     </a>
     一、环境准备
    </h3>
    <h4>
     <a id="11_IB_2">
     </a>
     1.1 验证IB网卡工具
    </h4>
    <p>
     首先确认节点已安装Mellanox InfiniBand网卡驱动及管理工具，执行以下命令验证硬件计数器功能：
    </p>
    <pre><code class="prism language-bash"><span class="token comment"># 查看mlx5_0端口的硬件计数器</span>
show_counters mlx5_0

<span class="token comment"># 预期输出示例（关键指标说明）：</span>
Port <span class="token number">1</span> hw counters:
out_of_sequence: <span class="token number">129759255</span>    <span class="token comment"># 序列号异常包计数</span>
packet_seq_err: <span class="token number">131851200</span>     <span class="token comment"># 数据包序列错误</span>
roce_adp_retrans: <span class="token number">3397922</span>     <span class="token comment"># ROCE协议自适应重传次数</span>
rx_read_requests: <span class="token number">306715884</span>   <span class="token comment"># 接收的Read请求数</span>
rx_write_requests: <span class="token number">1192749531</span> <span class="token comment"># 接收的Write请求数</span>
</code></pre>
    <h3>
     <a id="_17">
     </a>
     二、指标采集实现
    </h3>
    <h4>
     <a id="21__19">
     </a>
     2.1 指标暴露脚本
    </h4>
    <p>
     创建Python采集服务（建议保存为
     <code>
      ib_metrics_exporter.py
     </code>
     ）：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> time
<span class="token keyword">from</span> prometheus_client <span class="token keyword">import</span> Gauge<span class="token punctuation">,</span> start_http_server
<span class="token keyword">import</span> subprocess

<span class="token keyword">class</span> <span class="token class-name">IBMetricsCollector</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8006</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>metric <span class="token operator">=</span> Gauge<span class="token punctuation">(</span><span class="token string">'ib_hw_counters'</span><span class="token punctuation">,</span> 
                          <span class="token string">'InfiniBand Hardware Counters'</span><span class="token punctuation">,</span> 
                          <span class="token punctuation">[</span><span class="token string">'ib_device'</span><span class="token punctuation">,</span> <span class="token string">'counter_name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        start_http_server<span class="token punctuation">(</span>port<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">collect_metrics</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> devices<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""采集指定IB设备的指标"""</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>clear<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> dev <span class="token keyword">in</span> devices<span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>_get_single_device_metrics<span class="token punctuation">(</span>dev<span class="token punctuation">)</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_get_single_device_metrics</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> device<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            output <span class="token operator">=</span> subprocess<span class="token punctuation">.</span>check_output<span class="token punctuation">(</span>
                <span class="token punctuation">[</span><span class="token string">'show_counters'</span><span class="token punctuation">,</span> device<span class="token punctuation">]</span><span class="token punctuation">,</span>
                stderr<span class="token operator">=</span>subprocess<span class="token punctuation">.</span>STDOUT<span class="token punctuation">,</span>
                universal_newlines<span class="token operator">=</span><span class="token boolean">True</span>
            <span class="token punctuation">)</span>
            <span class="token keyword">for</span> line <span class="token keyword">in</span> output<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'\n'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token string">':'</span> <span class="token keyword">in</span> line<span class="token punctuation">:</span>
                    name<span class="token punctuation">,</span> value <span class="token operator">=</span> line<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">':'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> value<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>isdigit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                        self<span class="token punctuation">.</span>metric<span class="token punctuation">.</span>labels<span class="token punctuation">(</span>
                            ib_device<span class="token operator">=</span>device<span class="token punctuation">,</span>
                            counter_name<span class="token operator">=</span>name<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Error collecting </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>device<span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    <span class="token comment"># 监控4个IB设备（根据实际设备数量调整）</span>
    collector <span class="token operator">=</span> IBMetricsCollector<span class="token punctuation">(</span>port<span class="token operator">=</span><span class="token number">8006</span><span class="token punctuation">)</span>
    collector<span class="token punctuation">.</span>collect_metrics<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string-interpolation"><span class="token string">f"mlx5_</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">"</span></span> <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="22__65">
     </a>
     2.2 服务部署
    </h4>
    <pre><code class="prism language-bash"><span class="token comment"># 安装依赖</span>
pip <span class="token function">install</span> prometheus-client

<span class="token comment"># 后台运行服务（建议使用systemd托管）</span>
<span class="token function">nohup</span> python ib_metrics_exporter.py <span class="token operator">&gt;</span> exporter.log <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
</code></pre>
    <h3>
     <a id="_74">
     </a>
     三、监控系统配置
    </h3>
    <h4>
     <a id="31_Prometheus_76">
     </a>
     3.1 Prometheus配置
    </h4>
    <p>
     修改
     <code>
      prometheus.yml
     </code>
     添加抓取任务：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">scrape_configs</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">job_name</span><span class="token punctuation">:</span> <span class="token string">'ib_metrics'</span>
    <span class="token key atrule">scrape_interval</span><span class="token punctuation">:</span> 15s
    <span class="token key atrule">static_configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">targets</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> 192.168.1.5<span class="token punctuation">:</span><span class="token number">8006</span>  <span class="token comment"># 节点1</span>
        <span class="token punctuation">-</span> 192.168.1.6<span class="token punctuation">:</span><span class="token number">8006</span>  <span class="token comment"># 节点2</span>
        <span class="token key atrule">labels</span><span class="token punctuation">:</span>
          <span class="token key atrule">cluster</span><span class="token punctuation">:</span> HPC_Cluster  <span class="token comment"># 自定义集群标识</span>
</code></pre>
    <h4>
     <a id="32__90">
     </a>
     3.2 配置验证
    </h4>
    <pre><code class="prism language-bash"><span class="token comment"># 重启Prometheus服务</span>
systemctl restart prometheus

<span class="token comment"># 检查Target状态（应显示UP状态）</span>
http://localhost:9090/targets
</code></pre>
    <h3>
     <a id="_99">
     </a>
     四、数据可视化
    </h3>
    <h4>
     <a id="41_Grafana_101">
     </a>
     4.1 Grafana配置
    </h4>
    <ol>
     <li>
      <p>
       添加Prometheus数据源
      </p>
      <ul>
       <li>
        URL:
        <code>
         http://prometheus-server:9090
        </code>
       </li>
       <li>
        Auth: 根据实际情况配置
       </li>
      </ul>
     </li>
     <li>
      <p>
       创建监控看板
      </p>
      <pre><code class="prism language-promql"># 重传率计算
rate(ib_hw_counters{counter_name="roce_adp_retrans"}[5m])
/
rate(ib_hw_counters{counter_name="rx_write_requests"}[5m])
</code></pre>
     </li>
     <li>
      <p>
       推荐可视化组件：
      </p>
      <ul>
       <li>
        Time series: 时序趋势分析
       </li>
       <li>
        Stat：关键指标实时值
       </li>
       <li>
        Heatmap：错误分布分析
       </li>
      </ul>
     </li>
    </ol>
    <h3>
     <a id="_119">
     </a>
     五、应用场景
    </h3>
    <p>
     本方案可有效监控：
    </p>
    <ol>
     <li>
      网络重传率异常
     </li>
     <li>
      数据包序列错误
     </li>
     <li>
      远程直接内存访问(RDMA)性能
     </li>
     <li>
      网络拥塞检测
     </li>
     <li>
      硬件级故障预警
     </li>
    </ol>
    <blockquote>
     <p>
      <strong>
       最佳实践建议
      </strong>
      ：
     </p>
     <ol>
      <li>
       设置关键指标的阈值告警（如重传率&gt;0.1%）
      </li>
      <li>
       定期归档历史数据用于性能分析
      </li>
      <li>
       结合节点级指标（CPU/内存）进行关联分析
      </li>
      <li>
       对不同IB端口进行对比监控
      </li>
     </ol>
    </blockquote>
    <p>
     通过本方案，运维团队可以实现：
    </p>
    <ul>
     <li>
      实时掌握IB网络健康状态
     </li>
     <li>
      快速定位硬件层问题
     </li>
     <li>
      历史性能趋势分析
     </li>
     <li>
      容量规划数据支持
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f36313836343537372f:61727469636c652f64657461696c732f313436323334363339" class_="artid" style="display:none">
 </p>
</div>


