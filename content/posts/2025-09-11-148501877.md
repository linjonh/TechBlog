---
layout: post
title: "Javaåç«¯æµ‹è¯•"
date: 2025-09-11T15:45:30+0800
description: "å¦‚æœæ–­è¨€æˆåŠŸï¼šæµ‹è¯•é€šè¿‡ âœ…å¦‚æœæ–­è¨€å¤±è´¥ï¼šæµ‹è¯•å¤±è´¥ âŒï¼ˆä¼šæŠ›å‡º AssertionFailedErrorï¼‰"
keywords: "Javaåç«¯æµ‹è¯•"
categories: ['æœªåˆ†ç±»']
tags: ['å¼€å‘è¯­è¨€', 'Java']
artid: "148501877"
arturl: "https://blog.csdn.net/m0_73837751/article/details/148501877"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=148501877
    alt: "Javaåç«¯æµ‹è¯•"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=148501877
featuredImagePreview: https://bing.ee123.net/img/rand?artid=148501877
cover: https://bing.ee123.net/img/rand?artid=148501877
image: https://bing.ee123.net/img/rand?artid=148501877
img: https://bing.ee123.net/img/rand?artid=148501877
---



# Javaåç«¯æµ‹è¯•

## ä¸€ã€å•å…ƒæµ‹è¯•

### 1.1 å•å…ƒæµ‹è¯•åŸºç¡€æ¦‚å¿µ

å•å…ƒæµ‹è¯•æ˜¯é’ˆå¯¹è½¯ä»¶ä¸­æœ€å°å¯æµ‹è¯•å•å…ƒï¼ˆé€šå¸¸æ˜¯æ–¹æ³•æˆ–ç±»ï¼‰è¿›è¡Œæ£€æŸ¥å’ŒéªŒè¯çš„è¿‡ç¨‹ã€‚åœ¨Javaåç«¯å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¸»è¦æµ‹è¯•Serviceå±‚çš„ä¸šåŠ¡é€»è¾‘ã€‚

**ä¸ºä»€ä¹ˆéœ€è¦å•å…ƒæµ‹è¯•ï¼Ÿ**

* æ—©æœŸå‘ç°ä»£ç ç¼ºé™·
* ç¡®ä¿ä»£ç ä¿®æ”¹ä¸ä¼šç ´åç°æœ‰åŠŸèƒ½
* ä½œä¸ºä»£ç æ–‡æ¡£ï¼Œå±•ç¤ºå¦‚ä½•ä½¿ç”¨è¢«æµ‹è¯•ä»£ç 
* ä¿ƒè¿›æ›´å¥½çš„ä»£ç è®¾è®¡ï¼ˆå¯æµ‹è¯•çš„ä»£ç é€šå¸¸ç»“æ„æ›´å¥½ï¼‰

**å¸¸è§æµ‹è¯•ç±»ç»“æ„æ˜¯æ€æ ·çš„ï¼Ÿ**

æ˜¯çš„ï¼Œ**æ ‡å‡†åšæ³•**æ˜¯æ¯ä¸ªä¸šåŠ¡ç±»ï¼ˆå¦‚ `UserService`ï¼‰ï¼Œå¯¹åº”ä¸€ä¸ªæµ‹è¯•ç±»ï¼š

```

src/
â”œâ”€ main/
â”‚  â””â”€ java/com/example/service/UserService.java
â””â”€ test/
   â””â”€ java/com/example/service/UserServiceTest.java

```

åœ¨æµ‹è¯•ç±»ä¸­ï¼Œä½ ï¼š

* åˆ›å»º `@Mock` ä¾èµ–ï¼ˆå¦‚ Mapperï¼‰
* åˆ›å»º `@InjectMocks` çš„ Service
* ç¼–å†™ `@Test` æ–¹æ³•ï¼Œä½¿ç”¨æ–­è¨€éªŒè¯è¡Œä¸º

### 1.2Â å•å…ƒæµ‹è¯•å®Œæ•´ä¾èµ–

å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ Spring Bootï¼Œå¯ä»¥é€‰æ‹©ç›´æ¥å¼•å…¥ï¼š

```

<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-test</artifactId>
    <scope>test</scope>
</dependency>

```

> è¿™ä¸ª starter **å·²ç»é›†æˆäº† JUnit5 + Mockito + AssertJ ç­‰æµ‹è¯•ä¾èµ–**ï¼Œé€‚åˆå¤§éƒ¨åˆ†é¡¹ç›®ã€‚

```

<!-- JUnit5 -->
<dependency>
    <groupId>org.junit.jupiter</groupId>
    <artifactId>junit-jupiter</artifactId>
    <version>5.9.3</version>
    <scope>test</scope>
</dependency>

<!-- Mockito æ ¸å¿ƒ -->
<dependency>
    <groupId>org.mockito</groupId>
    <artifactId>mockito-core</artifactId>
    <version>5.8.0</version>
    <scope>test</scope>
</dependency>

<!-- Mockito + JUnit5 é›†æˆæ”¯æŒï¼ˆå¿…é¡»åŠ ä¸Šï¼‰ -->
<dependency>
    <groupId>org.mockito</groupId>
    <artifactId>mockito-junit-jupiter</artifactId>
    <version>5.8.0</version>
    <scope>test</scope>
</dependency>

```

`mockito-junit-jupiter` è¿™ä¸ªä¾èµ–æ˜¯ä¸ºäº†è®©ä½ å¯ä»¥ä½¿ç”¨`@ExtendWith(MockitoExtension.class)` ä¸ JUnit5 é…åˆã€‚ å¦‚æœä¸ä½¿ç”¨è¿™ç§æ–¹å¼å°±è¦é€šè¿‡ä¸‹é¢è¿™ç§æ–¹å¼å‘Šè¯‰ Mockitoâ€œè¯·æ‰«æå½“å‰ç±»ä¸­çš„ @Mockã€@InjectMocks æ³¨è§£ï¼Œåˆ›å»º Mock å¯¹è±¡å¹¶æ³¨å…¥â€ã€‚

```

@BeforeEach
void setUp() {
    MockitoAnnotations.openMocks(this);
}

```

### 1.3Â JUnit5 åŸºæœ¬ç”¨æ³•

#### 1.3.1Â åŸºæœ¬æ³¨è§£

* **`@Test`: æ ‡è®°ä¸€ä¸ªæ–¹æ³•ä¸ºæµ‹è¯•æ–¹æ³•**
* **`@BeforeEach`: åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•å‰æ‰§è¡Œ**
* **`@AfterEach`: åœ¨æ¯ä¸ªæµ‹è¯•æ–¹æ³•åæ‰§è¡Œ**
* **`@BeforeAll`: åœ¨æ‰€æœ‰æµ‹è¯•æ–¹æ³•å‰æ‰§è¡Œï¼ˆé™æ€æ–¹æ³•ï¼‰**
* **`@AfterAll`: åœ¨æ‰€æœ‰æµ‹è¯•æ–¹æ³•åæ‰§è¡Œï¼ˆé™æ€æ–¹æ³•ï¼‰**
* **`@DisplayName`: ä¸ºæµ‹è¯•ç±»æˆ–æ–¹æ³•æŒ‡å®šæ˜¾ç¤ºåç§°**

**ï¼ˆ1ï¼‰`@BeforeAll`Â å’ŒÂ `@AfterAll`**

**æ‰§è¡Œæ—¶æœº**ï¼š

* `@BeforeAll`ï¼šåœ¨**æ•´ä¸ªæµ‹è¯•ç±»**çš„æ‰€æœ‰æµ‹è¯•æ–¹æ³•æ‰§è¡Œ**ä¹‹å‰**è¿è¡Œä¸€æ¬¡
* `@AfterAll`ï¼šåœ¨**æ•´ä¸ªæµ‹è¯•ç±»**çš„æ‰€æœ‰æµ‹è¯•æ–¹æ³•æ‰§è¡Œ**ä¹‹å**è¿è¡Œä¸€æ¬¡

**é™æ€æ–¹æ³•è¦æ±‚**ï¼šè¿™ä¸¤ä¸ªæ³¨è§£æ ‡è®°çš„æ–¹æ³•å¿…é¡»æ˜¯`static`ï¼Œå› ä¸ºå®ƒä»¬åœ¨ç±»çº§åˆ«æ‰§è¡Œï¼Œä¸ä¾èµ–äºä»»ä½•æµ‹è¯•å®ä¾‹

**å…¸å‹ç”¨é€”**ï¼š

```

class DatabaseTest {
    static Connection connection;
    
    @BeforeAll
    static void initDatabase() {
        connection = Database.connect(); // æ‰€æœ‰æµ‹è¯•å…±äº«çš„æ˜‚è´µèµ„æº
    }
    
    @AfterAll
    static void closeDatabase() {
        connection.close(); // æ‰€æœ‰æµ‹è¯•å®Œæˆåæ¸…ç†èµ„æº
    }
    
    @Test void testQuery1() { /* ä½¿ç”¨connection */ }
    @Test void testQuery2() { /* ä½¿ç”¨connection */ }
}
```

**ï¼ˆ2ï¼‰`@BeforeEach`Â å’ŒÂ `@AfterEach`**

**æ‰§è¡Œæ—¶æœº**ï¼š

* `@BeforeEach`ï¼šåœ¨**æ¯ä¸ª**æµ‹è¯•æ–¹æ³•æ‰§è¡Œ**ä¹‹å‰**è¿è¡Œ
* `@AfterEach`ï¼šåœ¨**æ¯ä¸ª**æµ‹è¯•æ–¹æ³•æ‰§è¡Œ**ä¹‹å**è¿è¡Œ

**éé™æ€æ–¹æ³•**ï¼šä¸éœ€è¦`static`ä¿®é¥°

**å…¸å‹ç”¨é€”**ï¼š

```

class CalculatorTest {
    Calculator calculator;
    
    @BeforeEach
    void init() {
        calculator = new Calculator(); // æ¯ä¸ªæµ‹è¯•å‰åˆ›å»ºæ–°å®ä¾‹
    }
    
    @AfterEach
    void cleanup() {
        calculator.reset(); // æ¯ä¸ªæµ‹è¯•åæ¸…ç†çŠ¶æ€
    }
    
    @Test void testAdd() { /* ä½¿ç”¨æ–°å®ä¾‹ */ }
    @Test void testSubtract() { /* ä½¿ç”¨æ–°å®ä¾‹ */ }
}
```

#### 1.3.2Â å¸¸ç”¨æ–­è¨€æ–¹æ³•

**å®šä¹‰ï¼š**

**æ–­è¨€ï¼ˆassertï¼‰æ˜¯ç”¨äºåˆ¤æ–­å®é™…ç»“æœæ˜¯å¦ç¬¦åˆé¢„æœŸç»“æœçš„â€œæµ‹è¯•åˆ¤æ–­è¯­å¥â€ã€‚**

* å¦‚æœæ–­è¨€æˆåŠŸï¼šæµ‹è¯•é€šè¿‡ âœ…
* å¦‚æœæ–­è¨€å¤±è´¥ï¼šæµ‹è¯•å¤±è´¥ âŒï¼ˆä¼šæŠ›å‡º AssertionFailedErrorï¼‰

**ä¸ºä»€ä¹ˆæ–­è¨€å¾ˆé‡è¦ï¼Ÿ**

* æ²¡æœ‰æ–­è¨€ï¼Œåªæ˜¯â€œè¿è¡Œä»£ç â€ï¼›
* æœ‰äº†æ–­è¨€ï¼Œæ‰èƒ½â€œéªŒè¯ç»“æœæ˜¯å¦æ­£ç¡®â€ã€‚

| æ–¹æ³• | ç”¨é€” | ç¤ºä¾‹ |
| --- | --- | --- |
| **`assertEquals`** | éªŒè¯é¢„æœŸå€¼=å®é™…å€¼ | **`assertEquals(10, result)`** |
| **`assertTrue`** | éªŒè¯æ¡ä»¶ä¸ºçœŸ | **`assertTrue(list.isEmpty())`** |
| **`assertFalse`** | éªŒè¯æ¡ä»¶ä¸ºå‡ | **`assertFalse(user.isActive())`** |
| **`assertNull`** | éªŒè¯å¯¹è±¡ä¸ºnull | **`assertNull(error)`** |
| **`assertNotNull`** | éªŒè¯å¯¹è±¡énull | **`assertNotNull(response)`** |
| **`assertThrows`** | éªŒè¯æ˜¯å¦æŠ›å‡ºæŒ‡å®šå¼‚å¸¸ | **`assertThrows(IllegalArgumentException.class, () â†’ service.method(null))`** |
| **`assertAll`** | åˆ†ç»„æ‰§è¡Œå¤šä¸ªæ–­è¨€ | **`assertAll("ç”¨æˆ·å±æ€§", () â†’ assertEquals("John", user.name), () â†’ assertEquals(30, user.age))`** |

#### 1.3.3Â ç¤ºä¾‹ï¼šæµ‹è¯•å·¥å…·ç±»æ–¹æ³•

```

class DateUtilsTest {

    @Test
    @DisplayName("æµ‹è¯•æ—¥æœŸæ ¼å¼åŒ–")
    void testFormatDate() {
        LocalDate date = LocalDate.of(2023, 5, 15);
        String expected = "2023-05-15";
        
        assertEquals(expected, DateUtils.formatDate(date));
    }

    @Test
    @DisplayName("æµ‹è¯•è§£ææ—¥æœŸ")
    void testParseDate() {
        String dateStr = "2023-05-15";
        LocalDate expected = LocalDate.of(2023, 5, 15);
        
        assertEquals(expected, DateUtils.parseDate(dateStr));
    }

    @Test
    @DisplayName("æµ‹è¯•éæ³•æ—¥æœŸæ ¼å¼")
    void testInvalidDateFormat() {
        assertThrows(DateTimeParseException.class, () -> {
            DateUtils.parseDate("2023/05/15");
        });
    }

    @Test
    @DisplayName("æµ‹è¯•è®¡ç®—æ—¥æœŸå·®")
    void testDaysBetween() {
        LocalDate start = LocalDate.of(2023, 5, 10);
        LocalDate end = LocalDate.of(2023, 5, 15);
        
        assertEquals(5, DateUtils.daysBetween(start, end));
    }
}

class ValidationUtilsTest {

    @Test
    @DisplayName("æµ‹è¯•é‚®ç®±éªŒè¯")
    void testEmailValidation() {
        assertAll("é‚®ç®±éªŒè¯æµ‹è¯•",
            () -> assertTrue(ValidationUtils.isValidEmail("test@example.com")),
            () -> assertTrue(ValidationUtils.isValidEmail("user.name+tag@domain.co")),
            () -> assertFalse(ValidationUtils.isValidEmail("invalid.email")),
            () -> assertFalse(ValidationUtils.isValidEmail("user@.com")),
            () -> assertFalse(ValidationUtils.isValidEmail(null))
        );
    }

    @Test
    @DisplayName("æµ‹è¯•æ‰‹æœºå·éªŒè¯")
    void testPhoneValidation() {
        assertAll("æ‰‹æœºå·éªŒè¯æµ‹è¯•",
            () -> assertTrue(ValidationUtils.isValidPhone("13812345678")),
            () -> assertFalse(ValidationUtils.isValidPhone("12345678")),
            () -> assertFalse(ValidationUtils.isValidPhone("138123456789")),
            () -> assertFalse(ValidationUtils.isValidPhone("abc12345678"))
        );
    }
}
```

### 1.4Â Mockito ä½¿ç”¨

Mockitoæ˜¯ä¸€ä¸ªæµè¡Œçš„Mockæ¡†æ¶ï¼Œç”¨äºåˆ›å»ºå’Œé…ç½®æ¨¡æ‹Ÿå¯¹è±¡ï¼Œç‰¹åˆ«é€‚åˆæµ‹è¯•Serviceå±‚æ—¶æ¨¡æ‹ŸRepository/DAOå±‚ã€‚

**æ ¸å¿ƒæ¦‚å¿µ**

* **Mockå¯¹è±¡**ï¼šæ¨¡æ‹ŸçœŸå®å¯¹è±¡çš„æ›¿ä»£å“ï¼Œå¯ä»¥é¢„è®¾è¡Œä¸ºå’Œè¿”å›å€¼
* **Spyå¯¹è±¡**ï¼šéƒ¨åˆ†æ¨¡æ‹Ÿï¼Œå¯¹æœªå­˜æ ¹çš„æ–¹æ³•è°ƒç”¨çœŸå®æ–¹æ³•

#### 1.4.1 å¸¸ç”¨æ³¨è§£

* **`@Mock`: åˆ›å»ºæ¨¡æ‹Ÿå¯¹è±¡**
* **`@InjectMocks`: åˆ›å»ºå®ä¾‹å¹¶è‡ªåŠ¨æ³¨å…¥@Mockæˆ–@Spyå­—æ®µ**
* **`@Spy`: åˆ›å»ºspyå¯¹è±¡**

**ä¸€ä¸ªæµ‹è¯•ç±»ä¸­æ˜¯å¦åªèƒ½æœ‰ä¸€ä¸ª `@InjectMocks`ï¼Ÿ**

**ä¸æ˜¯åªèƒ½æœ‰ä¸€ä¸ªï¼Œä½†ä½ å¿…é¡»æ˜ç¡®æ¯ä¸ªè¦æ³¨å…¥çš„å¯¹è±¡ï¼Œå¹¶ä¸”ä¸èƒ½å­˜åœ¨æ³¨å…¥å†²çªã€‚**

**ğŸŸ¡ å¤šä¸ª `@InjectMocks` æ˜¯å¯ä»¥çš„ï¼Œåªè¦ä¸å†²çªï¼**

```

@InjectMocks
private UserServiceImpl userService;

@InjectMocks
private OrderServiceImpl orderService;

```

> è¿™ç§å†™æ³•æ˜¯å…è®¸çš„ï¼Œåªè¦è¿™äº› service æ‰€ä¾èµ–çš„ mock å­—æ®µï¼ˆ`@Mock`ï¼‰éƒ½èƒ½è¢«å”¯ä¸€åœ°è¯†åˆ«å‡ºæ¥ã€‚

**âŒ ä»€ä¹ˆæ—¶å€™ä¼šå†²çªï¼Ÿ**

å¦‚æœä¸¤ä¸ª `@InjectMocks` ä¿®é¥°çš„ç±»ä¾èµ–çš„æ˜¯åŒä¸€ä¸ª `@Mock`ï¼Œä½†ä½ æ²¡æœ‰æ˜ç¡®åŒºåˆ†ï¼Œé‚£ä¹ˆ Mockito å°±æ— æ³•åˆ¤æ–­è¯¥æŠŠ mock æ³¨å…¥ç»™å“ªä¸ªå¯¹è±¡ï¼Œä¼šæŠ¥é”™æˆ–è¡Œä¸ºæ··ä¹±ã€‚

#### 1.4.2 å¸¸ç”¨æ–¹æ³•

> **è¡¨ç¤º `when(...)` é‡Œçš„å†…å®¹ å¿…é¡»æ˜¯â€œå¯¹ mock å¯¹è±¡çš„æ–¹æ³•è°ƒç”¨â€è€Œä¸èƒ½æ˜¯é™æ€æ–¹æ³•ã€‚**
>
> **å¦‚æœæƒ³åœ¨ä¸­è°ƒç”¨ä¸€ä¸ªé™æ€æ–¹æ³•ï¼Œå¿…é¡»æŒ‰ç…§ä»¥ä¸‹æ–¹å¼ï¼š**
>
> **ä½ éœ€è¦ç”¨ `try (MockedStatic<...> ignored = ...)` çš„æ–¹å¼åŒ…è£…è°ƒç”¨ï¼š**
>
> âœ… ç¤ºä¾‹ï¼šmock `SecurityContextUtil.getUserId()`
>
> ```
>
> import org.mockito.MockedStatic;
> import org.mockito.Mockito;
>
> @Test
> public void testAddFavorite() {
>     Long userId = 1L;
>     Long resourceId = 1L;
>
>     // Mock é™æ€æ–¹æ³•
>     try (MockedStatic<SecurityContextUtil> mockedStatic = Mockito.mockStatic(SecurityContextUtil.class)) {
>         mockedStatic.when(SecurityContextUtil::getUserId).thenReturn(userId);
>
>         when(resourceService.checkResourceExist(resourceId)).thenReturn(true);
>         when(redisTemplate.execute(any(), any(), any(), any())).thenReturn(1L);
>
>         Boolean result = resourceFavoriteService.addFavorite(resourceId);
>         assertTrue(result);
>     }
> }
>
> ```
>
> **âš  æ³¨æ„äº‹é¡¹**
>
> * `mockStatic(...)` è¿”å›çš„æ˜¯ `MockedStatic<T>` ç±»å‹ï¼Œå¿…é¡»ç”¨ try-with-resources åŒ…è£¹ï¼Œå¦åˆ™ mock ä¸ç”Ÿæ•ˆï¼›
> * é™æ€æ–¹æ³•çš„ mock æ˜¯**çº¿ç¨‹éš”ç¦»çš„**ï¼Œåªåœ¨ try å—ä¸­æœ‰æ•ˆï¼›
> * ä¸æ”¯æŒ mock final ç±»æˆ– native æ–¹æ³•ï¼›
> * IDEï¼ˆå¦‚ IntelliJ IDEAï¼‰æœ‰æ—¶ä¸èƒ½æ­£ç¡®è¯†åˆ«é™æ€ mockï¼Œéœ€è¦ä½ åŠ  `mockito-inline` ä¾èµ–ï¼›

**`ï¼ˆ1ï¼‰when(...).thenReturn(...)` â€”â€” æ¨¡æ‹Ÿæ–¹æ³•è¿”å›å€¼**

**ä½œç”¨ï¼š**å‘Šè¯‰ Mockitoï¼šâ€œå½“è¿™ä¸ª mock å¯¹è±¡è°ƒç”¨æŸä¸ªæ–¹æ³•æ—¶ï¼Œè¯·è¿”å›æˆ‘æŒ‡å®šçš„å€¼â€ã€‚

> é»˜è®¤æƒ…å†µä¸‹ï¼Œ**mock å¯¹è±¡çš„æ–¹æ³•å¦‚æœæ²¡æœ‰ç”¨ `when(...).thenReturn(...)` æŒ‡å®šè¡Œä¸ºï¼Œä¼šè¿”å›è¯¥æ–¹æ³•è¿”å›ç±»å‹çš„é»˜è®¤å€¼**ï¼š
>
> | æ–¹æ³•è¿”å›ç±»å‹ | é»˜è®¤è¿”å›å€¼ |
> | --- | --- |
> | `boolean` | `false` |
> | `int` | `0` |
> | `Object` | `null` |
> | `List` | ç©ºåˆ—è¡¨/null |

**ç¤ºä¾‹ï¼š**

```

when(userMapper.selectById(1L)).thenReturn(new User(1L, "å¼ ä¸‰"));

```

> âœ… è¡¨ç¤ºï¼šå¦‚æœæµ‹è¯•ä»£ç ä¸­è°ƒç”¨ `userMapper.selectById(1L)`ï¼Œå°±è¿”å›ä¸€ä¸ªå¼ ä¸‰å¯¹è±¡ï¼Œè€Œä¸ä¼šçœŸçš„è®¿é—®æ•°æ®åº“ã€‚
>
> **åœ¨ä½ è‡ªå®šä¹‰çš„è¢«@Testæ³¨è§£çš„æ–¹æ³•ä¸­ï¼Œåœ¨è°ƒç”¨åŒ…å«userMapper.selectById(1L)çš„serviceå±‚çš„æ–¹æ³•ä¹‹å‰ä½¿ç”¨è¿™è¡Œä»£ç ï¼Œå®ƒä¼šåœ¨ä½ è°ƒç”¨è¿™ä¸ªserviceå±‚çš„æ–¹æ³•ä¸­çš„userMapper.selectById(1L)æ—¶è¿›è¡Œæ‹¦æˆªè¿”å›å¯¹åº”çš„å€¼ã€‚**
>
> ```
>
> @ExtendWith(MockitoExtension.class)
> class UserServiceTest {
>
>     @Mock
>     private UserMapper userMapper;
>
>     @InjectMocks
>     private UserService userService;
>
>     @Test
>     void testGetUserName() {
>         // 1. å‡†å¤‡é˜¶æ®µï¼šå‘Šè¯‰ mock å¯¹è±¡è¯¥å¦‚ä½•å“åº”
>         when(userMapper.selectById(1L))
>             .thenReturn(new User(1L, "å¼ ä¸‰"));
>
>         // 2. æ‰§è¡Œé˜¶æ®µï¼šè°ƒç”¨ä½ è¦æµ‹è¯•çš„ä¸šåŠ¡æ–¹æ³•
>         String name = userService.getUserName(1L);
>
>         // 3. æ–­è¨€é˜¶æ®µï¼šéªŒè¯è¿”å›å€¼
>         assertEquals("å¼ ä¸‰", name);
>
>         // 4.ï¼ˆå¯é€‰ï¼‰äº¤äº’éªŒè¯ï¼šç¡®è®¤åº•å±‚ mapper æ–¹æ³•è¢«è°ƒç”¨
>         verify(userMapper).selectById(1L);
>     }
> }
>
> ```

> ä½ åœ¨ `when()` ä¸­æŒ‡å®šçš„å‚æ•°ï¼Œè¦ä¸**è¢«æµ‹ä»£ç è°ƒç”¨ mock æ–¹æ³•æ—¶ä¼ å…¥çš„å‚æ•°å€¼å®Œå…¨ä¸€è‡´**ï¼Œå¦åˆ™ä¸ä¼šå‘½ä¸­ï¼Œè¿”å›é»˜è®¤å€¼ï¼ˆå¦‚ nullã€falseã€0ï¼‰ã€‚
>
> **æƒ³åŒ¹é…â€œä»»æ„å‚æ•°â€ï¼Ÿç”¨å‚æ•°åŒ¹é…å™¨ï¼š`anyXXX()`**
>
> Mockito æä¾›äº†å‚æ•°åŒ¹é…å™¨ï¼Œæ¯”å¦‚ï¼š
>
> | åŒ¹é…å™¨æ–¹æ³• | è¯´æ˜ |
> | --- | --- |
> | `any()` | åŒ¹é…ä»»æ„ç±»å‹å¯¹è±¡ |
> | `anyLong()` | åŒ¹é…ä»»æ„ long å€¼ |
> | `anyInt()` | åŒ¹é…ä»»æ„ int å€¼ |
> | `anyString()` | åŒ¹é…ä»»æ„å­—ç¬¦ä¸² |

**ğŸ” å¤šæ¬¡è°ƒç”¨è¿”å›ä¸åŒç»“æœï¼š**

```

when(service.getValue()).thenReturn("A").thenReturn("B");

```

> ç¬¬ä¸€æ¬¡è°ƒç”¨è¿”å› Aï¼Œç¬¬äºŒæ¬¡è¿”å› Bã€‚

---

**`ï¼ˆ2ï¼‰verify(mock).method()` â€”â€” éªŒè¯æ–¹æ³•æ˜¯å¦è¢«è°ƒç”¨**

**ä½œç”¨ï¼š**æµ‹è¯•ä»£ç æ˜¯å¦â€œçœŸçš„â€è°ƒç”¨äº†æŸä¸ªæ–¹æ³•ã€‚

> é€šå¸¸ç”¨äºéªŒè¯é€»è¾‘æµç¨‹æ˜¯å¦æ­£ç¡®ï¼Œå¦‚åˆ é™¤ç”¨æˆ·æ—¶æ˜¯å¦è°ƒç”¨äº†æ•°æ®åº“åˆ é™¤æ–¹æ³•ã€‚

**ç¤ºä¾‹ï¼š**

```

userService.deleteUser(1L);
verify(userMapper).deleteById(1L); // æ£€æŸ¥æ˜¯å¦è°ƒç”¨äº† deleteById

```

---

**`ï¼ˆ3ï¼‰verify(mock, times(n)).method()` â€”â€” éªŒè¯æ–¹æ³•è¢«è°ƒç”¨ n æ¬¡**

**ä½œç”¨ï¼š**åœ¨ä¸€äº›åœºæ™¯ä¸­æˆ‘ä»¬æœŸæœ›æŸä¸ªæ–¹æ³•è¢«è°ƒç”¨**å¤šæ¬¡æˆ–æŒ‡å®šæ¬¡æ•°**ï¼Œè¿™æ—¶ç”¨ `times(n)`ã€‚

**ç¤ºä¾‹ï¼š**

```

userService.batchDelete(Arrays.asList(1L, 2L, 3L));
verify(userMapper, times(3)).deleteById(anyLong());

```

> æ£€æŸ¥ `userMapper.deleteById` æ˜¯å¦è¢«è°ƒç”¨äº† 3 æ¬¡ã€‚

---

**`ï¼ˆ4ï¼‰any()`, `anyString()`, `anyInt()` ç­‰å‚æ•°åŒ¹é…å™¨**

**ä½œç”¨ï¼š**ç”¨äºè®¾ç½®/éªŒè¯æ—¶å¯¹â€œä»»æ„å‚æ•°â€çš„åŒ¹é…ï¼Œä¸ç”¨å†™æ­»å…·ä½“å‚æ•°ã€‚

> é¿å…ä½ å†™æ­»å…·ä½“å€¼ï¼Œæµ‹è¯•æ›´çµæ´»ã€å¥å£®ã€‚

**ç¤ºä¾‹1ï¼šæ¨¡æ‹Ÿè¿”å›å€¼**

```

when(userMapper.selectById(anyLong())).thenReturn(new User(1L, "é»˜è®¤ç”¨æˆ·"));

```

> è¡¨ç¤ºæ— è®ºä½ ä¼ ä»€ä¹ˆ long ç±»å‹å‚æ•°ï¼Œéƒ½è¿”å›è¿™ä¸ªé»˜è®¤ç”¨æˆ·ã€‚

**ç¤ºä¾‹2ï¼šéªŒè¯æ–¹æ³•è°ƒç”¨**

```

verify(userMapper).selectById(anyLong());

```

> è¡¨ç¤ºåªè¦è¿™ä¸ªæ–¹æ³•è¢«è°ƒç”¨ï¼Œä¸ç®¡å‚æ•°æ˜¯ä»€ä¹ˆï¼Œå°±ç®—éªŒè¯é€šè¿‡ã€‚

---

**å°æ€»ç»“ï¼šè¿™äº›æ–¹æ³•çš„é…åˆä½¿ç”¨**

| åœºæ™¯ | ä½¿ç”¨æ–¹æ³• |
| --- | --- |
| è®¾ç½® mock è¿”å›å€¼ | `when(...).thenReturn(...)` |
| éªŒè¯æ–¹æ³•æ˜¯å¦è°ƒç”¨ | `verify(...)` |
| éªŒè¯è°ƒç”¨æ¬¡æ•° | `verify(..., times(n))` |
| æ¨¡æ‹Ÿä»»æ„å‚æ•°è°ƒç”¨ | `any()`, `anyString()` ç­‰ |

#### 1.4.3 ç¤ºä¾‹ï¼šUserServiceæµ‹è¯•

> **åœ¨ç±»ä¸Šä¸€å®šè¦ä½¿ç”¨`@ExtendWith(MockitoExtension.class)`Â å‘Šè¯‰ Mockitoâ€œè¯·æ‰«æå½“å‰ç±»ä¸­çš„ @Mockã€@InjectMocks æ³¨è§£ï¼Œåˆ›å»º Mock å¯¹è±¡å¹¶æ³¨å…¥â€ã€‚**

```

class UserServiceTest {

    @Mock
    private UserMapper userMapper;

    @InjectMocks
    private UserService userService;

    @Test
    @DisplayName("æµ‹è¯•ç”¨æˆ·ç™»å½•æˆåŠŸ")
    void testLoginSuccess() {
        String username = "testUser";
        String password = "correctPassword";
        String encryptedPassword = PasswordUtil.encrypt(password);
        User mockUser = new User(1L, username, encryptedPassword);
        
        when(userMapper.findByUsername(username)).thenReturn(mockUser);
        
        User result = userService.login(username, password);
        
        assertNotNull(result);
        assertEquals(username, result.getUsername());
        verify(userMapper).findByUsername(username);
    }

    @Test
    @DisplayName("æµ‹è¯•ç”¨æˆ·ç™»å½• - å¯†ç é”™è¯¯")
    void testLoginWithWrongPassword() {
        String username = "testUser";
        String correctPassword = "correctPassword";
        String wrongPassword = "wrongPassword";
        User mockUser = new User(1L, username, PasswordUtil.encrypt(correctPassword));
        
        when(userMapper.findByUsername(username)).thenReturn(mockUser);
        
        assertThrows(AuthenticationException.class, () -> {
            userService.login(username, wrongPassword);
        });
    }

    @Test
    @DisplayName("æµ‹è¯•ç”¨æˆ·ç™»å½• - ç”¨æˆ·ä¸å­˜åœ¨")
    void testLoginWithNonExistentUser() {
        String username = "nonExistentUser";
        
        when(userMapper.findByUsername(username)).thenReturn(null);
        
        assertThrows(UserNotFoundException.class, () -> {
            userService.login(username, "anyPassword");
        });
    }
}
```

---

## **äºŒã€é›†æˆæµ‹è¯•**

### 2.1 é›†æˆæµ‹è¯• vs å•å…ƒæµ‹è¯•çš„åŒºåˆ«

| ç»´åº¦ | å•å…ƒæµ‹è¯•ï¼ˆUnit Testï¼‰ | é›†æˆæµ‹è¯•ï¼ˆIntegration Testï¼‰ |
| --- | --- | --- |
| æµ‹è¯•ç²’åº¦ | æµ‹ä¸€ä¸ªç±»ï¼ˆå¦‚ Serviceï¼‰ | æµ‹å¤šä¸ª Bean çš„åä½œï¼ˆå¦‚ Controllerâ†’Serviceâ†’DBï¼‰ |
| æ˜¯å¦å¯åŠ¨ Spring | âŒ ä¸å¯åŠ¨å®¹å™¨ | âœ… å¯åŠ¨æ•´ä¸ª Spring Boot å®¹å™¨ |
| ä¾èµ–æ³¨å…¥æ–¹å¼ | `@Mock` + `@InjectMocks` | `@Autowired` æ³¨å…¥çœŸå® Bean |
| æ•°æ®åº“è¿æ¥ | æ— æ•°æ®åº“ / Mock Mapper | çœŸå®æ•°æ®åº“ï¼ˆH2 æˆ– MySQLï¼‰ |
| æµ‹è¯•ç±»ä¸Šæ³¨è§£ | `@ExtendWith(MockitoExtension.class)` | `@SpringBootTest` |

### 2.2 Testcontainers åŸç†ä¸ä¾èµ–

> **Testcontainersåªæ˜¯åœ¨æ›¿ä»£æœ¬åœ°è¿è¡Œçš„MySQLå’ŒRedisï¼Œå¹¶éæ˜¯çœŸå®çš„ç”Ÿäº§ç¯å¢ƒï¼ˆäº‘ç«¯ï¼‰**

> **Testcontainers å¯åŠ¨çš„ MySQL/Redis å®Œå…¨æ˜¯ Docker å®¹å™¨é‡Œè·‘çš„å®ä¾‹**ï¼Œå’Œä½ æœºå™¨ä¸Šæ‰‹åŠ¨å®‰è£…çš„æœåŠ¡ **æ¯«æ— å…³ç³»**ã€‚
>
> * **Docker å®¹å™¨é‡Œçš„æœåŠ¡**
>
>   + é•œåƒï¼ˆä¾‹å¦‚ `mysql:8.0`ã€`redis:7.0`ï¼‰è¢«æ‹‰ä¸‹æ¥ï¼Œä½œä¸ºä¸€ä¸ªéš”ç¦»çš„è¿›ç¨‹ç»„è¿è¡Œåœ¨ Docker å®ˆæŠ¤è¿›ç¨‹ä¸‹ã€‚
>   + å®¹å™¨æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œç«¯å£ã€å­˜å‚¨å·éƒ½ä¸æœ¬åœ°å®‰è£…çš„æœåŠ¡éš”ç¦»å¼€æ¥ã€‚
> * **æœ¬åœ°å®‰è£…çš„æœåŠ¡**
>
>   + æ˜¯ä½ é€šè¿‡ç³»ç»ŸåŒ…ç®¡ç†ï¼ˆaptã€yumã€brewï¼‰æˆ–å®˜æ–¹å®‰è£…åŒ…å®‰è£…çš„ï¼Œè¿è¡Œåœ¨ç³»ç»Ÿçš„æœåŠ¡ç®¡ç†å™¨ï¼ˆsystemdã€launchctlï¼‰ä¸­ã€‚
>
> å› æ­¤ï¼Œä½¿ç”¨ Testcontainers **ä¸ä¼šå½±å“**ä¹Ÿ**ä¸ä¼šä½¿ç”¨**ä½ æœ¬åœ°å®‰è£…çš„é‚£å¥— MySQL/Redisï¼›å®ƒä¼šæ–°å»ºä¸€ä¸ªä¸´æ—¶ã€ç‹¬ç«‹ã€å¹²å‡€çš„å®¹å™¨ç¯å¢ƒï¼Œæµ‹è¯•ç»“æŸåå†æŠŠå®¹å™¨åˆ æ‰ã€‚
>
> | æ ¸å¿ƒç»´åº¦ | æœ¬åœ°å®‰è£…æœåŠ¡ | Testcontainersï¼ˆæ¨èæµ‹è¯•ç”¨ï¼‰ |
> | --- | --- | --- |
> | âœ… æµ‹è¯•éš”ç¦»æ€§ | å¤šæµ‹è¯•å…±äº«æœåŠ¡ï¼Œæ˜“æ•°æ®æ±¡æŸ“ | æ¯æ¬¡æµ‹è¯•ç‹¬ç«‹å®¹å™¨ï¼Œè‡ªåŠ¨æ¸…ç† |
> | âœ… é…ç½®ä¸€è‡´æ€§ | æ‰‹åŠ¨é…ç½®ï¼Œç‰ˆæœ¬å¯èƒ½ä¸ä¸€è‡´ | é…ç½®å†™åœ¨æµ‹è¯•ä»£ç ä¸­ï¼Œå›¢é˜Ÿä¸€è‡´ |
> | âœ… è‡ªåŠ¨åŒ–/CIæ”¯æŒ | éœ€æ‰‹åŠ¨å®‰è£…æœåŠ¡ï¼ŒCIä¸å‹å¥½ | è‡ªåŠ¨æ‹‰é•œåƒå¹¶å¯åŠ¨ï¼Œå®Œç¾æ”¯æŒ CI æµç¨‹ |
> | âœ… å¯åŠ¨ä¸é”€æ¯ | å¯åŠ¨æ…¢ã€éœ€æ¸…ç† | å¯åŠ¨å¿«ã€æµ‹è¯•åè‡ªåŠ¨é”€æ¯ |
> | âœ… ç‰ˆæœ¬åˆ‡æ¢çµæ´»æ€§ | å®‰è£…/åˆ‡æ¢éº»çƒ¦ | ä¸€è¡Œä»£ç æ¢ç‰ˆæœ¬ï¼ˆå¦‚ `mysql:8.0`ï¼‰ |

* CI = Continuous Integrationï¼ˆæŒç»­é›†æˆï¼‰ï¼ŒæŒ‡çš„æ˜¯æ¯æ¬¡ä»£ç æäº¤éƒ½è‡ªåŠ¨è§¦å‘æ„å»ºå’Œæµ‹è¯•çš„æµç¨‹ã€‚Testcontainers + CI èƒ½ä¿è¯åœ¨â€œæ— äººå€¼å®ˆâ€çš„ç¯å¢ƒé‡Œä¹Ÿèƒ½**è‡ªåŠ¨**å¯åŠ¨ä¾èµ–æœåŠ¡å¹¶è·‘å®Œæµ‹è¯•ã€‚
* **â€œä»£ç å³ç¯å¢ƒâ€**ï¼šä½ åœ¨æµ‹è¯•ä»£ç é‡Œå£°æ˜è¦ç”¨ `mysql:8.0`ã€`redis:7.0` é•œåƒï¼Œç¡®ä¿æ¯ä¸ªäººæœ¬åœ°å’Œ CI ä¸Šç”¨çš„éƒ½æ˜¯**åŒä¸€ä¸ªç‰ˆæœ¬ã€åŒä¸€å¥—é…ç½®**ï¼›
* **Docker åŒ–ä¸€è‡´æ€§**ï¼šTestcontainers å¯åŠ¨çš„å®¹å™¨å’Œä½ ç”Ÿäº§ç¯å¢ƒé‡Œè·‘çš„ Docker å®¹å™¨**ç¯å¢ƒæä¸ºç›¸ä¼¼**ï¼Œèƒ½æ›´æ—©åœ°å‘ç°å®¹å™¨åŒ–éƒ¨ç½²æ—¶æ‰ä¼šå‡ºç°çš„é—®é¢˜ï¼›
* **é›¶è¿ç»´è´Ÿæ‹…**ï¼šä¸éœ€è¦åœ¨æœ¬æœºæˆ– CI èŠ‚ç‚¹é¢„å…ˆå®‰è£… MySQL/Redisï¼Œåªè¦ Docker åœ¨ï¼Œå°±èƒ½â€œä¸€é”®å¯åŠ¨ã€æµ‹è¯•ã€é”€æ¯â€ã€‚

#### **2.2.1 åŸç†**

**Testcontainers** æ˜¯ä¸€ä¸ª Java åº“ï¼Œå†…éƒ¨ä½¿ç”¨ Docker å¯åŠ¨ä¸´æ—¶å®¹å™¨ï¼Œåˆ›å»ºçœŸå®ç¯å¢ƒï¼ˆMySQLã€Redisã€RabbitMQç­‰ï¼‰ï¼Œç”¨äºæµ‹è¯•ã€‚

* å¯åŠ¨å‰è‡ªåŠ¨æ‹‰å–é•œåƒå¹¶è¿è¡Œå®¹å™¨ï¼›
* å®¹å™¨å¯åŠ¨åï¼Œé€šè¿‡ `@DynamicPropertySource` å°†è¿æ¥ä¿¡æ¯æ³¨å…¥åˆ° Springï¼›
* æµ‹è¯•å®Œæˆåï¼Œè‡ªåŠ¨é”€æ¯å®¹å™¨ï¼Œä¿æŒæµ‹è¯•ç¯å¢ƒå¹²å‡€ã€‚

#### **2.2.2 Testcontainers ä¸æ˜¯ Spring Boot çš„å†…ç½®ä¾èµ–ï¼Œéœ€è¦ä½ å•ç‹¬æ·»åŠ ã€‚**

| ç»„ä»¶ | ä¾èµ–åæ ‡ | å¿…é€‰ |
| --- | --- | --- |
| **æ ¸å¿ƒåº“** | org.testcontainers:testcontainers | âœ… |
| **JUnit** | org.testcontainers:junit-jupiter | âœ… |
| **MySQL** | org.testcontainers:mysql | æŒ‰éœ€ |
| **Redis** | org.testcontainers:redis | æŒ‰éœ€ |
| **RabbitMQ** | org.testcontainers:rabbitmq | æŒ‰éœ€ |
| **Kafka** | org.testcontainers:kafka | æŒ‰éœ€ |

```

<!-- åŸºç¡€æµ‹è¯•ä¾èµ– -->
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>testcontainers</artifactId>
    <version>1.16.3</version>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>junit-jupiter</artifactId>
    <version>1.16.3</version>
    <scope>test</scope>
</dependency>

<!-- æŒ‰éœ€æ·»åŠ æ¨¡å— -->
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>mysql</artifactId>
    <version>1.16.3</version>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>redis</artifactId>
    <version>1.16.3</version>
    <scope>test</scope>
</dependency>
<dependency>
    <groupId>org.testcontainers</groupId>
    <artifactId>rabbitmq</artifactId>
    <version>1.16.3</version>
    <scope>test</scope>
</dependency>
```

#### **2.2.3 åŸºç¡€ä½¿ç”¨æ–¹å¼**

```

@Testcontainers
@SpringBootTest
class MyIntegrationTest {

    // å…±äº«å®¹å™¨ï¼ˆæ‰€æœ‰æµ‹è¯•æ–¹æ³•å…±ç”¨ï¼‰
    @Container
    static final MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0");

    // åŠ¨æ€æ³¨å…¥é…ç½®
    @DynamicPropertySource
    static void registerProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", mysql::getJdbcUrl);
        registry.add("spring.datasource.username", mysql::getUsername);
        registry.add("spring.datasource.password", mysql::getPassword);
    }

    @Test
    void testWithRealMySQL() {
        // ä½¿ç”¨çœŸå®MySQLæµ‹è¯•...
    }
}
```

#### **2.2.4** å¤ç”¨**ä»£ç ç»“æ„æ–¹å¼**

```

// åœ¨src/test/javaä¸‹åˆ›å»º
public abstract class BaseContainerTest {
    @Container
    static final MySQLContainer<?> MYSQL = new MySQLContainer<>("mysql:8.0")
        .withDatabaseName("test")
        .withUsername("test")
        .withPassword("test");
    
    @Container
    static final RedisContainer REDIS = new RedisContainer("redis:6-alpine");
    
    @DynamicPropertySource
    static void setupContainers(DynamicPropertyRegistry registry) {
        // å…¬å…±é…ç½®...
    }
}

// æµ‹è¯•ç±»ç»§æ‰¿å³å¯
class MyTest extends BaseContainerTest {
    // ç›´æ¥ä½¿ç”¨å·²å¯åŠ¨çš„å®¹å™¨
}
```

* **å®¹å™¨å…±äº«**ï¼šä½¿ç”¨`static`å®¹å™¨å˜é‡è®©æ‰€æœ‰æµ‹è¯•æ–¹æ³•å…±äº«åŒä¸€å®¹å™¨
* **åŸºç±»å°è£…**ï¼šå°†å®¹å™¨é…ç½®æ”¾åœ¨æŠ½è±¡åŸºç±»ä¸­å¤ç”¨
* **èµ„æºæ¸…ç†**ï¼š

  ```

  @AfterEach
  void cleanup() {
      // æ¸…ç†Redisæ•°æ®
      redisTemplate.getConnectionFactory().getConnection().flushAll();
  }
  ```

#### 2.2.5 å®¹å™¨å¤ç”¨æ–¹æ³•

âœ… **åœ¨å…¨å±€é…ç½®æ–‡ä»¶ä¸­æ‰“å¼€å¤ç”¨ï¼š**

**~/.testcontainers.propertiesï¼ˆæ¨èï¼‰**

```

testcontainers.reuse.enable=true
```

**æˆ– src/test/resources/testcontainers.propertiesï¼ˆä¹Ÿå¯ä»¥ï¼‰**

```

testcontainers.reuse.enable=true
```

è¡¨ç¤ºä½ **å…è®¸ Testcontainers å¯åŠ¨çš„å®¹å™¨å¤ç”¨ï¼ˆreuseï¼‰**ï¼Œå³ï¼š

* ä¸ä¼šæ¯æ¬¡æµ‹è¯•éƒ½é”€æ¯å¹¶é‡æ–°å¯åŠ¨ Redis/MySQL/RabbitMQ å®¹å™¨ï¼›
* å¯åŠ¨é€Ÿåº¦æ˜¾è‘—åŠ å¿«ï¼ˆèŠ‚çœ Docker èµ„æºï¼‰ï¼›
* **å°¤å…¶é€‚åˆ**è¿›è¡Œå¤šçº¿ç¨‹/å¹¶å‘/æ€§èƒ½æµ‹è¯•ã€‚

---

**âœ… å¼€å¯å¤ç”¨åå¦‚ä½•ä½¿ç”¨ï¼š**

åªè¦åœ¨å®¹å™¨å®šä¹‰æ—¶åŠ  `.withReuse(true)`ï¼š

```

@Container
static final MySQLContainer<?> MYSQL = new MySQLContainer<>("mysql:8.0")
    .withReuse(true); // âœ… æ˜¾å¼å£°æ˜å…è®¸å¤ç”¨

@Container
static final RedisContainer REDIS = new RedisContainer("redis:6-alpine")
    .withReuse(true);

```

---

**âœ… å¦‚æœä¸å¯ç”¨å¤ç”¨ï¼Œä¼šæ€æ ·ï¼Ÿ**

* æ¯æ¬¡æµ‹è¯•éƒ½ä¼šå¯åŠ¨æ–°å®¹å™¨ï¼ˆ30s+å»¶è¿Ÿï¼‰ï¼Œä¸é€‚åˆå‹åŠ›æµ‹è¯•ï¼›
* Docker å®¹å™¨è¿‡å¤šè¿˜å¯èƒ½æ®‹ç•™å ç”¨èµ„æºï¼›
* æ€§èƒ½æµ‹è¯•æ—¶æ¯è½®åˆå§‹åŒ–éƒ½å¤ªæ…¢ï¼Œæ— æ³•æ¨¡æ‹ŸçœŸå®é«˜å¹¶å‘åœºæ™¯ã€‚

### 2.3Â é›†æˆMySQL

**ğŸ“„ æ–‡ä»¶ç»“æ„ï¼š**

```

src/
â”œâ”€ main/
â”‚  â””â”€ resources/
â”‚     â””â”€ application.yml           <-- æ­£å¼ç¯å¢ƒé…ç½®ï¼ˆMySQLã€Redisï¼‰
â””â”€ test/
   â””â”€ resources/
      â””â”€ application-test.yml      <-- æµ‹è¯•ç¯å¢ƒé…ç½®ï¼ˆH2ã€å†…å­˜é…ç½®ï¼‰

```

#### 2.3.1Â ä½¿ç”¨ H2 å†…å­˜æ•°æ®åº“æµ‹è¯•

**âœ… æ‰€éœ€ä¾èµ–ï¼ˆMavenï¼‰**

```

<dependency>
    <groupId>com.h2database</groupId>
    <artifactId>h2</artifactId>
    <version>2.2.224</version> <!-- æˆ–ä½¿ç”¨ç¨³å®šç‰ˆ -->
    <scope>runtime</scope>
</dependency>

```

**ä½¿ç”¨ `application-test.yml` ä¸“ç”¨äºæµ‹è¯•ç¯å¢ƒ**

```

# src/main/resources/application.ymlï¼ˆä¸»é…ç½®ï¼‰
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/prod_db
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: prod_user
    password: ${DB_PASSWORD}


```

```

@SpringBootTest
@Transactional
@Rollback
@ActiveProfiles("test")
class UserMapperH2Test {

    @Autowired
    private UserMapper userMapper;

    @Test
    void testInsert() {
        User user = new User();
        user.setUsername("h2User");
        user.setEmail("h2@example.com");

        int result = userMapper.insert(user);
        assertEquals(1, result);
        assertNotNull(user.getId());
    }
}

```

#### 2.3.2 ä½¿ç”¨**Testcontainers**Â MySQL æ•°æ®åº“æµ‹è¯•

```

# src/test/resources/application-test.ymlï¼ˆæµ‹è¯•é…ç½®ï¼‰
spring:
  datasource:
    url: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;MODE=MySQL
    driver-class-name: org.h2.Driver
  sql:
    init:
      schema-locations: classpath:schema.sql
      data-locations: classpath:data.sql
  h2:
    console:
      enabled: true
      path: /h2-console
```

> åœ¨é›†æˆæµ‹è¯•ç±»ä¸Šç»Ÿä¸€åŠ ä¸Šï¼š
>
> ```
>
> @ActiveProfiles("test") // æ˜ç¡®ä½¿ç”¨æµ‹è¯•ç¯å¢ƒé…ç½® @SpringBootTest
> ```
>
> å¦‚æœä¸å†™é»˜è®¤åŠ è½½ `application-test.yml`

```

@SpringBootTest
@Testcontainers
@ActiveProfiles("test")
class UserMapperMySQLTest {

    @Container
    static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0")
            .withDatabaseName("test")
            .withUsername("test")
            .withPassword("test")
            .withReuse(true);

    @DynamicPropertySource
    static void configure(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", mysql::getJdbcUrl);
        registry.add("spring.datasource.username", mysql::getUsername);
        registry.add("spring.datasource.password", mysql::getPassword);
        registry.add("spring.datasource.driver-class-name", mysql::getDriverClassName);
    }

    @Autowired
    private UserMapper userMapper;

    @Test
    void testInsert() {
        User user = new User();
        user.setUsername("tcUser");
        user.setEmail("tc@example.com");

        int result = userMapper.insert(user);
        assertEquals(1, result);
        assertNotNull(user.getId());
    }
}

```

> **`@Rollback` æ³¨è§£ä½œç”¨**ï¼šé…åˆ `@Transactional` ä½¿ç”¨ï¼Œè¡¨ç¤ºæµ‹è¯•æ–¹æ³•**æ‰§è¡Œå®Œæˆåå›æ»šäº‹åŠ¡ï¼Œä¸ç•™ä»»ä½•æ•°æ®ç—•è¿¹**ï¼›

### 2.4 é›†æˆRedis

#### 2.4.1Â ä½¿ç”¨ Embedded Redis æµ‹è¯•

**Embedded Redisä¾èµ–**

```

<dependency>
    <groupId>it.ozimov</groupId>
    <artifactId>embedded-redis</artifactId>
    <version>0.7.3</version>
    <scope>test</scope>
</dependency>
```

| ç‰¹æ€§ | Embedded Redis | çœŸå®Redis/Testcontainers |
| --- | --- | --- |
| **å¯åŠ¨é€Ÿåº¦** | å¿«ï¼ˆè¿›ç¨‹å†…ï¼‰ | è¾ƒæ…¢ï¼ˆéœ€å¯åŠ¨Dockerï¼‰ |
| **åŠŸèƒ½å®Œæ•´æ€§** | æœ‰é™ï¼ˆéå…¨åŠŸèƒ½å®ç°ï¼‰ | 100%å…¼å®¹ |
| **è°ƒè¯•å¤æ‚åº¦** | ç®€å• | éœ€è¦æŸ¥çœ‹å®¹å™¨æ—¥å¿— |
| **é€‚åˆåœºæ™¯** | ç®€å•æ“ä½œéªŒè¯ | éœ€è¦å®Œæ•´Redisç‰¹æ€§æµ‹è¯• |

```

@SpringBootTest
@TestInstance(TestInstance.Lifecycle.PER_CLASS)
class RedisEmbeddedTest {

    private RedisServer redisServer;

    @BeforeAll
    void startRedis() throws IOException {
        redisServer = new RedisServer(6379);
        redisServer.start();
    }

    @AfterAll
    void stopRedis() {
        redisServer.stop();
    }

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    @Test
    void testSetGet() {
        redisTemplate.opsForValue().set("key", "val");
        String value = redisTemplate.opsForValue().get("key");
        assertEquals("val", value);
    }
}

```

#### 2.4.2 ä½¿ç”¨**Testcontainers**Â Redis æµ‹è¯•

```

@SpringBootTest
@Testcontainers
@ActiveProfiles("test")
class RedisTestcontainersTest {

    @Container
    static GenericContainer<?> redis = new GenericContainer<>("redis:7.0")
            .withExposedPorts(6379)
            .withReuse(true);

    @DynamicPropertySource
    static void configure(DynamicPropertyRegistry registry) {
        registry.add("spring.redis.host", redis::getHost);
        registry.add("spring.redis.port", () -> redis.getMappedPort(6379));
    }

    @Autowired
    private RedisTemplate<String, String> redisTemplate;

    @Test
    void testRedisSetGet() {
        redisTemplate.opsForValue().set("k1", "v1");
        String value = redisTemplate.opsForValue().get("k1");
        assertEquals("v1", value);
    }
}

```

## 2.5 é›†æˆRabbitMQ

#### 2.5.1 æ··ç”¨äº‘ç«¯ RabbitMQ å’Œ**Testcontainers** MySQL/Redis

```

spring:
  rabbitmq:
    host: your-cloud-host.aliyuncs.com
    port: 5672
    username: yourUser
    password: yourPass
```

```

@Testcontainers
@SpringBootTest
@ActiveProfiles("test")
class MixedIntegrationTest {

  // ---- å®¹å™¨åŒ– MySQL ----
  @Container
  static MySQLContainer<?> mysql = new MySQLContainer<>("mysql:8.0")
    .withReuse(true);

  // ---- å®¹å™¨åŒ– Redis ----
  @Container
  static GenericContainer<?> redis = new GenericContainer<>("redis:7.0")
    .withExposedPorts(6379)
    .withReuse(true);

  @DynamicPropertySource
  static void dynamicProperties(DynamicPropertyRegistry registry) {
    registry.add("spring.datasource.url", mysql::getJdbcUrl);
    registry.add("spring.datasource.username", mysql::getUsername);
    registry.add("spring.datasource.password", mysql::getPassword);

    registry.add("spring.redis.host", redis::getHost);
    registry.add("spring.redis.port", () -> redis.getMappedPort(6379));
    // æ³¨æ„ï¼šrabbitmq ä¸åœ¨è¿™é‡Œé‡å†™ï¼Œè¿˜æ˜¯ç”¨ application-test.yml é‡Œçš„äº‘ç«¯é…ç½®
  }

  @Autowired
  private RabbitTemplate rabbitTemplate;    // ä¼šè¿æ¥åˆ°é˜¿é‡Œäº‘çš„ RabbitMQ

  @Test
  void testCloudRabbitAndLocalDb() {
    // 1ï¼‰æ•°æ®åº“æ“ä½œèµ° Testcontainers æä¾›çš„ MySQL å®¹å™¨
    // 2ï¼‰ç¼“å­˜æ“ä½œèµ° Testcontainers æä¾›çš„ Redis å®¹å™¨
    // 3ï¼‰æ¶ˆæ¯æ“ä½œèµ°é˜¿é‡Œäº‘ RabbitMQ
    Object msg = rabbitTemplate.receiveAndConvert("cloud.test.queue");
    // ...
  }
}

```

* Testcontainers **åªç®¡ç†é‚£äº›ä½ ç”¨ `@Container` å¯åŠ¨çš„æœåŠ¡**ã€‚
* å¯¹äºæ²¡æœ‰å®¹å™¨åŒ–å£°æ˜çš„ç»„ä»¶ï¼ˆå¦‚ä¸Šä¾‹çš„ RabbitMQï¼‰ï¼ŒSpring è¿˜æ˜¯ä¼šæŒ‰é…ç½®æ–‡ä»¶ï¼ˆ`application-test.yml` æˆ– `application.yml`ï¼‰å»è¿æ¥é˜¿é‡Œäº‘ã€‚
* è¿™æ ·å°±å¯ä»¥æ—¢ç”¨æœ¬åœ° Docker å®¹å™¨æ¥åšæ•°æ®åº“/ç¼“å­˜çš„éš”ç¦»æµ‹è¯•ï¼Œåˆç”¨äº‘ç«¯å®ä¾‹æ¥åšæ¶ˆæ¯é˜Ÿåˆ—çš„åŠŸèƒ½è”è°ƒã€‚

#### 2.5.2Â ä½¿ç”¨ Testcontainers å¯åŠ¨ RabbitMQ å®¹å™¨

```

import org.junit.jupiter.api.Test;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ActiveProfiles;
import org.testcontainers.containers.RabbitMQContainer;
import org.testcontainers.junit.jupiter.Container;
import org.testcontainers.junit.jupiter.Testcontainers;
import org.testcontainers.utility.DockerImageName;

import static org.junit.jupiter.api.Assertions.assertEquals;

@Testcontainers
@SpringBootTest
@ActiveProfiles("test")
class RabbitMQTestContainersTest {

    @Container
    static final RabbitMQContainer rabbitMQ =
        new RabbitMQContainer(DockerImageName.parse("rabbitmq:3.10-management"))
            .withExposedPorts(5672, 15672)
            .withReuse(true);

    @DynamicPropertySource
    static void rabbitProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.rabbitmq.host", rabbitMQ::getHost);
        registry.add("spring.rabbitmq.port", rabbitMQ::getAmqpPort);
        registry.add("spring.rabbitmq.username", rabbitMQ::getAdminUsername);
        registry.add("spring.rabbitmq.password", rabbitMQ::getAdminPassword);
    }

    @Autowired
    private RabbitTemplate rabbitTemplate;

    @Test
    void testSendAndReceive() {
        String queue = "tc.test.queue";
        // åœ¨å®¹å™¨ä¸­å£°æ˜é˜Ÿåˆ—
        rabbitTemplate.execute(channel -> {
            channel.queueDeclare(queue, false, false, false, null);
            return null;
        });

        // å‘é€å¹¶æ¥æ”¶æ¶ˆæ¯
        rabbitTemplate.convertAndSend(queue, "hello-tc");
        Object received = rabbitTemplate.receiveAndConvert(queue);

        assertEquals("hello-tc", received);
    }
}

```



