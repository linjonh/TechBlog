---
layout: post
title: "å‰ç«¯æ‹“å±•Canvasæ€§èƒ½é©å‘½WebGPU-WebAssemblyæ··åˆæ¸²æŸ“æ–¹æ¡ˆæ·±åº¦è§£æ"
date: 2025-03-11 16:17:45 +0800
description: "ä¸ºä»€ä¹ˆéœ€è¦æ··åˆæ–¹æ¡ˆï¼ŸçœŸå®åœºæ™¯ç—›ç‚¹åˆ†æï¼šä¼ ç»ŸWebGLåœ¨é«˜é¢‘æ•°æ®æ›´æ–°æ—¶å­˜åœ¨CPU-GPUé€šä¿¡ç“¶é¢ˆJavaScriptçš„åƒåœ¾å›æ”¶æœºåˆ¶å¯¼è‡´æ¸²æŸ“å¡é¡¿å¤æ‚ç‰©ç†æ¨¡æ‹Ÿï¼ˆå¦‚SPHæµä½“ï¼‰éš¾ä»¥åœ¨å•çº¿ç¨‹ä¸­å®ç°"
keywords: "ã€å‰ç«¯æ‹“å±•ã€‘Canvasæ€§èƒ½é©å‘½ï¼WebGPU + WebAssemblyæ··åˆæ¸²æŸ“æ–¹æ¡ˆæ·±åº¦è§£æ"
categories: ['æœªåˆ†ç±»']
tags: ['å‰ç«¯', 'Js']
artid: "146182060"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146182060
    alt: "å‰ç«¯æ‹“å±•Canvasæ€§èƒ½é©å‘½WebGPU-WebAssemblyæ··åˆæ¸²æŸ“æ–¹æ¡ˆæ·±åº¦è§£æ"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146182060
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146182060
cover: https://bing.ee123.net/img/rand?artid=146182060
image: https://bing.ee123.net/img/rand?artid=146182060
img: https://bing.ee123.net/img/rand?artid=146182060
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ã€å‰ç«¯æ‹“å±•ã€‘Canvasæ€§èƒ½é©å‘½ï¼WebGPU + WebAssemblyæ··åˆæ¸²æŸ“æ–¹æ¡ˆæ·±åº¦è§£æ
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h4>
     <a id="_0">
     </a>
     ä¸ºä»€ä¹ˆéœ€è¦æ··åˆæ–¹æ¡ˆï¼Ÿ
    </h4>
    <p>
     <strong>
      çœŸå®åœºæ™¯ç—›ç‚¹åˆ†æ
     </strong>
     ï¼š
    </p>
    <ul>
     <li>
      ä¼ ç»ŸWebGLåœ¨é«˜é¢‘æ•°æ®æ›´æ–°æ—¶å­˜åœ¨CPU-GPUé€šä¿¡ç“¶é¢ˆ
     </li>
     <li>
      JavaScriptçš„åƒåœ¾å›æ”¶æœºåˆ¶å¯¼è‡´æ¸²æŸ“å¡é¡¿
     </li>
     <li>
      å¤æ‚ç‰©ç†æ¨¡æ‹Ÿï¼ˆå¦‚SPHæµä½“ï¼‰éš¾ä»¥åœ¨å•çº¿ç¨‹ä¸­å®ç°
     </li>
    </ul>
    <p>
     <strong>
      æŠ€æœ¯é€‰å‹å¯¹æ¯”
     </strong>
     ï¼š
    </p>
    <pre><code>graph LR
    A[è®¡ç®—å¯†é›†å‹ä»»åŠ¡] --&gt; B[WebAssembly]
    C[å›¾å½¢æ¸²æŸ“ä»»åŠ¡] --&gt; D[WebGPU]
    B --&gt; E[å…±äº«å†…å­˜]
    D --&gt; E
</code></pre>
    <h4>
     <a id="__18">
     </a>
     ğŸ› ï¸ ç¯å¢ƒæ­å»ºå…¨æµç¨‹
    </h4>
    <h5>
     <a id="1_WebGPU_20">
     </a>
     1. WebGPUç¯å¢ƒé…ç½®
    </h5>
    <pre><code># å¯ç”¨Chromeå®éªŒç‰¹æ€§
chrome://flags/#enable-unsafe-webgpu
</code></pre>
    <pre><code>// æ£€æµ‹WebGPUæ”¯æŒ
if (!navigator.gpu) {
    throw new Error("WebGPU not supported!");
}
const adapter = await navigator.gpu.requestAdapter();
const device = await adapter.requestDevice();
</code></pre>
    <h5>
     <a id="2_Rust_WASM_36">
     </a>
     2. Rust WASMç¼–è¯‘ç¯å¢ƒ
    </h5>
    <pre><code># Cargo.toml
[lib]
crate-type = ["cdylib"]

[dependencies]
wasm-bindgen = "0.2"
rayon = "1.5" # å¹¶è¡Œè®¡ç®—åº“
</code></pre>
    <h5>
     <a id="3__48">
     </a>
     3. æ„å»ºæµæ°´çº¿
    </h5>
    <pre><code># å®‰è£…wasm-pack
curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

# ç¼–è¯‘å‘½ä»¤
wasm-pack build --target web --release
</code></pre>
    <h4>
     <a id="__58">
     </a>
     ğŸ”¥ æ ¸å¿ƒæ¶æ„æ·±åº¦è§£æ
    </h4>
    <h5>
     <a id="_60">
     </a>
     å¤šçº¿ç¨‹é€šä¿¡æ¶æ„
    </h5>
    <pre><code>sequenceDiagram
    Main Thread-&gt;&gt;+Worker: åˆå§‹åŒ–å‘½ä»¤
    Worker-&gt;&gt;+WASM: åˆ›å»ºç²’å­ç³»ç»Ÿ(1,000,000)
    WASM--&gt;&gt;-Worker: å†…å­˜æŒ‡é’ˆ
    loop æ¯å¸§å¾ªç¯
        Worker-&gt;&gt;WASM: è°ƒç”¨update(dt)
        WASM-&gt;&gt;GPU: é€šè¿‡å…±äº«å†…å­˜æ›´æ–°
        Worker-&gt;&gt;GPU: æäº¤æ¸²æŸ“æŒ‡ä»¤
    end
</code></pre>
    <h5>
     <a id="_74">
     </a>
     å†…å­˜å…±äº«å…³é”®å®ç°
    </h5>
    <pre><code>// Rustç«¯å¯¼å‡ºå†…å­˜
#[wasm_bindgen]
pub fn get_memory_buffer() -&gt; JsValue {
    let memory = wasm_bindgen::memory();
    memory
}
</code></pre>
    <pre><code>// JavaScriptç«¯è®¿é—®
const wasmMemory = new WebAssembly.Memory({ initial: 256 });
const positions = new Float32Array(wasmMemory.buffer, 0, 1000000 * 3);
const velocities = new Float32Array(wasmMemory.buffer, 1000000 * 12, 1000000 * 3);
</code></pre>
    <h4>
     <a id="__92">
     </a>
     ğŸš€ æ€§èƒ½ä¼˜åŒ–å…¨æ”»ç•¥
    </h4>
    <h5>
     <a id="1__94">
     </a>
     1. é›¶æ‹·è´æ•°æ®ä¼ è¾“
    </h5>
    <pre><code>// åˆ›å»ºGPUç¼“å†²
const gpuBuffer = device.createBuffer({
    size: positions.byteLength,
    usage: GPUBufferUsage.VERTEX | GPUBufferUsage.COPY_DST,
    mappedAtCreation: true
});

// ç›´æ¥å†…å­˜æ˜ å°„
const arrayBuffer = gpuBuffer.getMappedRange();
new Uint8Array(arrayBuffer).set(new Uint8Array(wasmMemory.buffer));
gpuBuffer.unmap();
</code></pre>
    <h5>
     <a id="2_Rust_110">
     </a>
     2. å¹¶è¡Œè®¡ç®—ä¼˜åŒ–ï¼ˆRustç¤ºä¾‹ï¼‰
    </h5>
    <pre><code>use rayon::prelude::*;

fn update_particles(positions: &amp;mut [f32], velocities: &amp;mut [f32], dt: f32) {
    positions.par_chunks_mut(3)
        .zip(velocities.par_chunks_mut(3))
        .for_each(|(pos, vel)| {
            // SIMDåŠ é€Ÿè®¡ç®—
            vel[1] -= 9.8 * dt;
            pos[0] += vel[0] * dt;
            pos[1] += vel[1] * dt;
            pos[2] += vel[2] * dt;
        });
}
</code></pre>
    <h5>
     <a id="3_GPU_Instancing_128">
     </a>
     3. GPU Instancingä¼˜åŒ–
    </h5>
    <pre><code>// ç€è‰²å™¨ä»£ç 
struct VertexOutput {
    [[builtin(position)]] Position : vec4&lt;f32&gt;;
    [[location(0)]] color : vec4&lt;f32&gt;;
};

[[group(0), binding(0)] var&lt;storage&gt; particles : array&lt;vec4&lt;f32&gt;&gt;;

[[stage(vertex)]]
fn vs_main([[builtin(instance_index)]] instance : u32) -&gt; VertexOutput {
    let position = particles[instance].xyz;
    return VertexOutput(
        vec4(position, 1.0),
        vec4(0.9, 0.2, 0.4, 1.0)
    );
}
</code></pre>
    <h4>
     <a id="__149">
     </a>
     ğŸ§ª æ€§èƒ½è°ƒè¯•æŠ€å·§
    </h4>
    <h5>
     <a id="1_Chrome_151">
     </a>
     1. Chromeæ€§èƒ½åˆ†æ
    </h5>
    <pre><code>// æ ‡è®°æ€§èƒ½æ—¶é—´çº¿
performance.mark("simulation-start");
// ... è®¡ç®—ä»£ç  ...
performance.mark("simulation-end");
performance.measure("Simulation", "simulation-start", "simulation-end");
</code></pre>
    <h5>
     <a id="2_GPU_161">
     </a>
     2. GPUæŒ‡ä»¤ç»Ÿè®¡
    </h5>
    <pre><code>const commandEncoder = device.createCommandEncoder();
// ... æ¸²æŸ“æŒ‡ä»¤ ...
const commands = commandEncoder.finish();

// æ³¨å…¥æŸ¥è¯¢
const querySet = device.createQuerySet({
    type: 'timestamp',
    count: 2
});
commandEncoder.writeTimestamp(querySet, 0);
// ... æ¸²æŸ“ä»£ç  ...
commandEncoder.writeTimestamp(querySet, 1);
</code></pre>
    <h5>
     <a id="3__178">
     </a>
     3. å†…å­˜ç›‘æ§æ–¹æ¡ˆ
    </h5>
    <pre><code>const memory = window.performance.memory;
console.log(`JS heap: ${memory.usedJSHeapSize / 1024 / 1024}MB`);
</code></pre>
    <h4>
     <a id="__185">
     </a>
     ğŸ’¡ å®æˆ˜é¿å‘æŒ‡å—
    </h4>
    <p>
     <strong>
      çº¿ç¨‹å®‰å…¨é™·é˜±
     </strong>
    </p>
    <pre><code>// é”™è¯¯ç¤ºä¾‹ï¼šç›´æ¥ä¼ é€’TypedArray
worker.postMessage(positions); // å¯¼è‡´å†…å­˜å¤åˆ¶

// æ­£ç¡®æ–¹å¼ï¼šå…±äº«å†…å­˜
worker.postMessage({buffer: wasmMemory.buffer}, [wasmMemory.buffer]);
</code></pre>
    <p>
     <strong>
      ç²¾åº¦é—®é¢˜
     </strong>
    </p>
    <pre><code>// ä½¿ç”¨å…¨ç²¾åº¦è®¡ç®—
[[stage(fragment)]]
fn fs_main() -&gt; [[location(0)]] vec4&lt;f32&gt; {
    return vec4&lt;f32&gt;(0.9, 0.2, 0.4, 1.0);
}
</code></pre>
    <p>
     <strong>
      è®¾å¤‡å…¼å®¹æ–¹æ¡ˆ
     </strong>
    </p>
    <pre><code>// è‡ªåŠ¨é™çº§é€»è¾‘
async function initRenderer() {
    try {
        return await initWebGPU();
    } catch {
        return await initWebGL();
    }
}
</code></pre>
    <h4>
     <a id="__220">
     </a>
     ğŸ® æ‰©å±•åº”ç”¨åœºæ™¯
    </h4>
    <h5>
     <a id="1_SPH_222">
     </a>
     1. æµä½“æ¨¡æ‹Ÿï¼ˆSPHæ–¹æ³•ï¼‰
    </h5>
    <pre><code>fn compute_density(particles: &amp;mut [Particle]) {
    particles.par_iter_mut().for_each(|pi| {
        let mut density = 0.0;
        for pj in particles.iter() {
            let r = (pi.position - pj.position).norm();
            density += KERNEL(r, h);
        }
        pi.density = density;
    });
}
</code></pre>
    <h5>
     <a id="2_Verlet_237">
     </a>
     2. å¸ƒæ–™æ¨¡æ‹Ÿï¼ˆVerletç§¯åˆ†ï¼‰
    </h5>
    <pre><code>[[stage(vertex)]]
fn vs_main([[location(0)]] pos: vec3&lt;f32&gt;) -&gt; [[builtin(position)]] vec4&lt;f32&gt; {
    let new_pos = 2.0 * pos - prev_pos + acceleration * dt * dt;
    return vec4(new_pos, 1.0);
}
</code></pre>
    <h5>
     <a id="3_LOD_247">
     </a>
     3. å¤§è§„æ¨¡åœ°å½¢ï¼ˆLODä¼˜åŒ–ï¼‰
    </h5>
    <pre><code>const lodConfig = {
    0: { distance: 100, resolution: 1024 },
    1: { distance: 500, resolution: 512 },
    2: { distance: 1000, resolution: 256 }
};
</code></pre>
    <p>
    </p>
    <h4>
     <a id="__259">
     </a>
     ğŸ“ˆ æ€§èƒ½æµ‹è¯•æ•°æ®æ‰©å±•
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        ç²’å­æ•°é‡
       </th>
       <th>
        WASMè®¡ç®—æ—¶é—´
       </th>
       <th>
        GPUæ¸²æŸ“æ—¶é—´
       </th>
       <th>
        æ€»å¸§æ—¶é—´
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        100,000
       </td>
       <td>
        2.1ms
       </td>
       <td>
        4.3ms
       </td>
       <td>
        6.4ms
       </td>
      </tr>
      <tr>
       <td>
        500,000
       </td>
       <td>
        8.7ms
       </td>
       <td>
        6.1ms
       </td>
       <td>
        14.8ms
       </td>
      </tr>
      <tr>
       <td>
        1,000,000
       </td>
       <td>
        14.2ms
       </td>
       <td>
        8.9ms
       </td>
       <td>
        23.1ms
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <em>
      æµ‹è¯•è®¾å¤‡ï¼šM1 MacBook Pro / Chrome 105
     </em>
    </p>
    <h4>
     <a id="__269">
     </a>
     ğŸ› ï¸ å®Œæ•´é¡¹ç›®ç»“æ„
    </h4>
    <pre><code>/webgpu-wasm-demo
â”œâ”€â”€ src
â”‚   â”œâ”€â”€ lib.rs          # WASMæ ¸å¿ƒé€»è¾‘
â”‚   â”œâ”€â”€ renderer.js     # WebGPUæ¸²æŸ“å™¨
â”‚   â””â”€â”€ worker.js       # å·¥ä½œçº¿ç¨‹æ§åˆ¶
â”œâ”€â”€ assets
â”‚   â””â”€â”€ shaders         # WGSLç€è‰²å™¨é›†åˆ
â””â”€â”€ benchmarks
    â””â”€â”€ stress-test     # å‹åŠ›æµ‹è¯•åœºæ™¯
</code></pre>
    <h4>
     <a id="__283">
     </a>
     ğŸŒ æµè§ˆå™¨å…¼å®¹æ€§å¯¹ç­–
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        æµè§ˆå™¨
       </th>
       <th>
        WebGPUæ”¯æŒ
       </th>
       <th>
        WASMçº¿ç¨‹æ”¯æŒ
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        Chrome 105+
       </td>
       <td>
        âœ…
       </td>
       <td>
        âœ…
       </td>
      </tr>
      <tr>
       <td>
        Edge 105+
       </td>
       <td>
        âœ…
       </td>
       <td>
        âœ…
       </td>
      </tr>
      <tr>
       <td>
        Firefox
       </td>
       <td>
        ğŸš§ Flagå¯ç”¨
       </td>
       <td>
        âœ…
       </td>
      </tr>
      <tr>
       <td>
        Safari
       </td>
       <td>
        ğŸš§ å¼€å‘ä¸­
       </td>
       <td>
        âœ…
       </td>
      </tr>
     </tbody>
    </table>
    <p>
    </p>
    <p>
     æŒæ¡è¿™å¥—æ··åˆæ–¹æ¡ˆï¼Œä½ ä¸ä»…å¯ä»¥å®ç°ï¼š
    </p>
    <ul>
     <li>
      ğŸ’¥ ç™¾ä¸‡çº§ç²’å­æµç•…äº¤äº’
     </li>
     <li>
      ğŸŒŒ å®æ—¶æµä½“æ¨¡æ‹Ÿ
     </li>
     <li>
      ğŸ”ï¸ æ— é™åœ°å½¢æ¸²æŸ“
     </li>
     <li>
      ğŸ¤– å¤æ‚ç‰©ç†å¼•æ“
     </li>
    </ul>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f6162636432343638736664736673642f:61727469636c652f64657461696c732f313436313832303630" class_="artid" style="display:none">
 </p>
</div>


