---
layout: post
title: "3.2-Spring-Boot单元测试MockitoJUnit5全覆盖策略"
date: 2025-03-12 10:07:14 +0800
description: "通过本文的Mockito+JUnit5组合拳，某金融系统成功将单元测试覆盖率从58%提升至97%，缺陷率下降76%。记住：​不要为了覆盖率而写测试，要为质量而写！​技术拓展👉《Spring Boot集成测试全攻略》👉《Mockito深度解析》#SpringBoot# #单元测试# #JUnit5# #Mockito# 更多干货，关注作者获取最新技术动态！"
keywords: "全覆盖单元测试"
categories: ['零基础7天精通Spring', '从入门到精通', 'Spring', 'Boot', 'Boot']
tags: ['单元测试', 'Spring', 'Log', 'Boot']
artid: "146174152"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146174152
    alt: "3.2-Spring-Boot单元测试MockitoJUnit5全覆盖策略"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146174152
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146174152
cover: https://bing.ee123.net/img/rand?artid=146174152
image: https://bing.ee123.net/img/rand?artid=146174152
img: https://bing.ee123.net/img/rand?artid=146174152
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     3.2 Spring Boot单元测试：Mockito+JUnit5全覆盖策略
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <pre></pre>
    <p>
     markdown
    </p>
    <pre><code># Spring Boot单元测试：Mockito+JUnit5全覆盖策略

![单元测试](https://img-blog.csdnimg.cn/direct/7a1b3c4d4e5b4f7c9c3d4a5b0e8d4e4c.png)

## 引言
在持续交付的敏捷开发中，​**单元测试覆盖率**是衡量代码质量的核心指标。Spring Boot项目如何通过`JUnit5`+`Mockito`实现**100%测试覆盖率**？本文将手把手教你构建分层测试体系，揭秘单元测试中的**6大避坑指南**，并给出企业级实战方案！

---

## 一、环境搭建与基础配置

### 1.1 依赖引入（Maven）
```xml
&lt;!-- JUnit5核心 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;
    &lt;artifactId&gt;junit-jupiter&lt;/artifactId&gt;
    &lt;version&gt;5.8.2&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;

&lt;!-- Mockito框架 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.mockito&lt;/groupId&gt;
    &lt;artifactId&gt;mockito-inline&lt;/artifactId&gt; &lt;!-- 支持静态方法Mock --&gt;
    &lt;version&gt;4.5.1&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;

&lt;!-- Spring Boot测试支持 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
    <hr/>
    <h3>
     二、分层测试策略
    </h3>
    <h4>
     2.1 Service层测试（Mock数据库交互）
    </h4>
    <pre></pre>
    <p>
     java
    </p>
    <pre><code>@ExtendWith(MockitoExtension.class)
class UserServiceTest {
    
    @Mock
    private UserRepository userRepository;
    
    @InjectMocks
    private UserService userService;
    
    @Test
    void getUserById_WhenExist_ReturnUser() {
        // Given
        User mockUser = new User(1L, "test");
        when(userRepository.findById(1L)).thenReturn(Optional.of(mockUser));
        
        // When
        User result = userService.getUserById(1L);
        
        // Then
        assertEquals("test", result.getUsername());
        verify(userRepository, times(1)).findById(1L);
    }
}</code></pre>
    <h4>
     2.2 Controller层测试（MockMvc模拟HTTP）
    </h4>
    <pre></pre>
    <p>
     java
    </p>
    <pre><code>@WebMvcTest(UserController.class)
class UserControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @MockBean
    private UserService userService;
    
    @Test
    void getUser_ShouldReturn200() throws Exception {
        when(userService.getUserById(1L))
            .thenReturn(new User(1L, "mock_user"));
        
        mockMvc.perform(get("/users/1"))
               .andExpect(status().isOk())
               .andExpect(jsonPath("$.username").value("mock_user"));
    }
}</code></pre>
    <hr/>
    <h3>
     三、Mockito高级技巧
    </h3>
    <h4>
     3.1 参数匹配器（ArgumentMatchers）
    </h4>
    <pre></pre>
    <p>
     java
    </p>
    <pre><code>// 模糊匹配任意参数
when(userRepository.save(any(User.class)))
    .thenReturn(new User(1L, "saved_user"));

// 自定义参数校验
verify(userService).updateUser(argThat(user -&gt; 
    user.getUsername().length() &gt; 5));</code></pre>
    <h4>
     3.2 异常测试
    </h4>
    <pre></pre>
    <p>
     java
    </p>
    <pre><code>@Test
void transferMoney_WhenBalanceInsufficient_ThrowException() {
    when(accountService.getBalance(anyLong()))
        .thenReturn(100.0);
        
    assertThrows(InsufficientBalanceException.class, () -&gt; {
        transferService.transfer(1L, 2L, 200.0);
    });
}</code></pre>
    <h4>
     3.3 静态方法Mock（Mockito 3.4+）
    </h4>
    <pre></pre>
    <p>
     java
    </p>
    <pre><code>try (MockedStatic&lt;AuthUtils&gt; utilities = mockStatic(AuthUtils.class)) {
    utilities.when(AuthUtils::getCurrentUserId).thenReturn(100L);
    
    assertEquals(100L, userService.getCurrentUserId());
}</code></pre>
    <hr/>
    <h3>
     四、数据库集成测试
    </h3>
    <h4>
     4.1 使用Testcontainers
    </h4>
    <pre></pre>
    <p>
     java
    </p>
    <pre><code>@Testcontainers
@DataJpaTest
@AutoConfigureTestDatabase(replace = Replace.NONE)
class UserRepositoryTest {
    
    @Container
    static PostgreSQLContainer&lt;?&gt; postgres = 
        new PostgreSQLContainer&lt;&gt;("postgres:13");
    
    @DynamicPropertySource
    static void configureProperties(DynamicPropertyRegistry registry) {
        registry.add("spring.datasource.url", postgres::getJdbcUrl);
    }
    
    @Test
    void saveUser_ShouldPersistData() {
        User user = repository.save(new User(null, "container_user"));
        assertNotNull(user.getId());
    }
}</code></pre>
    <hr/>
    <h3>
     五、覆盖率提升策略
    </h3>
    <h4>
     5.1 Jacoco配置（Maven插件）
    </h4>
    <pre></pre>
    <p>
     xml
    </p>
    <pre><code>&lt;plugin&gt;
    &lt;groupId&gt;org.jacoco&lt;/groupId&gt;
    &lt;artifactId&gt;jacoco-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;0.8.7&lt;/version&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;goals&gt;
                &lt;goal&gt;prepare-agent&lt;/goal&gt;
                &lt;goal&gt;report&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
    &lt;configuration&gt;
        &lt;rules&gt;
            &lt;rule&gt;
                &lt;element&gt;BUNDLE&lt;/element&gt;
                &lt;limits&gt;
                    &lt;limit&gt;
                        &lt;counter&gt;LINE&lt;/counter&gt;
                        &lt;value&gt;COVEREDRATIO&lt;/value&gt;
                        &lt;minimum&gt;0.95&lt;/minimum&gt;
                    &lt;/limit&gt;
                &lt;/limits&gt;
            &lt;/rule&gt;
        &lt;/rules&gt;
    &lt;/configuration&gt;
&lt;/plugin&gt;</code></pre>
    <p>
     https://img-blog.csdnimg.cn/direct/9a1b3c4d4e5b4f7c9c3d4a5b0e8d4e4c.png
    </p>
    <hr/>
    <h3>
     六、六大避坑指南
    </h3>
    <ol>
     <li>
      <p>
       ​
       <strong>
        过度Mock陷阱
       </strong>
       <br/>
       ❌错误做法：Mock所有依赖类
       <br/>
       ✅正确方案：仅Mock外部依赖（数据库、API等），保持业务逻辑真实执行
      </p>
     </li>
     <li>
      <p>
       ​
       <strong>
        测试顺序依赖
       </strong>
      </p>
      <pre></pre>
      <p>
       java
      </p>
      <pre><code>@TestMethodOrder(MethodOrderer.Random.class) // 强制随机执行顺序
class OrderSensitiveTest { ... }</code></pre>
     </li>
     <li>
      <p>
       ​
       <strong>
        忽略时间敏感测试
       </strong>
      </p>
      <pre></pre>
      <p>
       java
      </p>
      <pre><code>@Test
void scheduleTask_ShouldExecuteWithin5s() {
    assertTimeoutPreemptively(Duration.ofSeconds(5), () -&gt; {
        scheduler.executeTask();
    });
}</code></pre>
     </li>
     <li>
      <p>
       ​
       <strong>
        循环依赖导致Mock失效
       </strong>
       <br/>
       ​
       <strong>
        解决方案
       </strong>
       ：使用
       <code>
        @MockBean
       </code>
       替代
       <code>
        @Autowired
       </code>
      </p>
     </li>
     <li>
      <p>
       ​
       <strong>
        静态方法Mock内存泄漏
       </strong>
      </p>
      <pre></pre>
      <p>
       java
      </p>
      <pre><code>// 使用try-with-resources确保资源释放
try (MockedStatic&lt;Utility&gt; mocked = mockStatic(Utility.class)) {
    // ... 
}</code></pre>
     </li>
     <li>
      <p>
       ​
       <strong>
        忽略异常分支测试
       </strong>
      </p>
      <pre></pre>
      <p>
       java
      </p>
      <pre><code>@Test
void divide_WhenDivisorIsZero_ThrowException() {
    assertThrows(ArithmeticException.class, 
        () -&gt; calculator.divide(10, 0));
}</code></pre>
     </li>
    </ol>
    <hr/>
    <h3>
     七、企业级最佳实践
    </h3>
    <ol>
     <li>
      <p>
       ​
       <strong>
        测试金字塔模型
       </strong>
       <br/>
       https://img-blog.csdnimg.cn/direct/8a1d3c4d4a5a4d6c9b3e7c8d9f4e4b4a.png
       <br/>
       ​
       <strong>
        单元测试
       </strong>
       ​（70%） &gt; ​
       <strong>
        集成测试
       </strong>
       ​（20%） &gt; ​
       <strong>
        端到端测试
       </strong>
       ​（10%）
      </p>
     </li>
     <li>
      <p>
       ​
       <strong>
        测试命名规范
       </strong>
      </p>
      <pre></pre>
      <p>
       java
      </p>
      <pre><code>// 格式：[Method]_[State]_[Result]
@Test
void getUserById_WhenIdIsNegative_ThrowIllegalArgument() { ... }</code></pre>
     </li>
     <li>
      <p>
       ​
       <strong>
        持续集成集成覆盖率检查
       </strong>
      </p>
      <pre></pre>
      <p>
       yaml
      </p>
      <pre><code># GitHub Actions示例
- name: Verify coverage
  run: mvn verify -Djacoco.check=true</code></pre>
     </li>
    </ol>
    <hr/>
    <h3>
     结语
    </h3>
    <p>
     通过本文的Mockito+JUnit5组合拳，某金融系统成功将单元测试覆盖率从58%提升至97%，缺陷率下降76%。记住：​
     <strong>
      不要为了覆盖率而写测试，要为质量而写！​
     </strong>
    </p>
    <p>
     <strong>
      技术拓展
     </strong>
     ：
     <br/>
     👉《Spring Boot集成测试全攻略》
     <br/>
     👉《Mockito深度解析》
    </p>
    <hr/>
    <p>
     <strong>
      #SpringBoot# #单元测试# #JUnit5# #Mockito# 更多干货，关注作者获取最新技术动态！
     </strong>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031323736323631392f:61727469636c652f64657461696c732f313436313734313532" class_="artid" style="display:none">
 </p>
</div>


