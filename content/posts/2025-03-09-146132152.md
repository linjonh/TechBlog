---
layout: post
title: "Windows软件插件-音视频文件读取器"
date: 2025-03-09 15:58:25 +0800
description: "介绍“音视频文件读取器”的开发。"
keywords: "Windows软件插件-音视频文件读取器"
categories: ['未分类']
tags: ['音视频', 'Windows', 'C']
artid: "146132152"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146132152
    alt: "Windows软件插件-音视频文件读取器"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146132152
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146132152
cover: https://bing.ee123.net/img/rand?artid=146132152
image: https://bing.ee123.net/img/rand?artid=146132152
img: https://bing.ee123.net/img/rand?artid=146132152
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Windows软件插件-音视频文件读取器
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <a href="https://download.csdn.net/download/h3974/90469029">
      下载本插件
     </a>
     <br/>
     本插件读取音频和视频文件，输出音频样本和视频样本，音频样本为16位PCM，采样率48000；视频样本为RGB32。大部分音频和视频文件格式都可以读取。本插件类型为DLL。
     <br/>
     本插件是通过创建媒体基础“源读取器”对象实现读取音视频文件。使用MFCreateSourceReaderFromURL函数创建源读取器，源读取器接口为IMFSourceReader，如果读取的是音频文件，只创建音频线程，如果读取视频文件，将创建视频线程和音频线程，在线程中使用IMFSourceReader接口的ReadSample方法读取样本，样本为媒体基础样本；使用IMFSourceReader接口的SetCurrentPosition方法更改当前位置。定义了7个导出函数，用于对本读取器的操作。
    </p>
    <h3>
     <a id="_4">
     </a>
     使用方法
    </h3>
    <p>
     首先，加载本读取器DLL，获得读取器模块句柄。
    </p>
    <pre><code class="prism language-cpp">	HMODULE hSReader <span class="token operator">=</span> <span class="token function">LoadLibrary</span><span class="token punctuation">(</span>L<span class="token string">"SReader.dll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     定义媒体信息和样本信息结构，定义接收当前位置信息的函数（如果不需要，也可以不定义），定义视频音频样本接收函数：
    </p>
    <pre><code class="prism language-cpp"><span class="token keyword">struct</span> <span class="token class-name">INFO</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> VideoWidth<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//视频宽，单位像素</span>
	<span class="token keyword">int</span> VideoHeight<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//视频高，单位像素</span>
	LONGLONG FrameCur<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//帧持续时间，单位100纳秒</span>
	LONGLONG DUR<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//媒体时长，单位100纳秒</span>
	DWORD AudioSamplePerSec<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//音频样本采样率</span>
	DWORD StreamCount<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//流数量</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">SAMPLE_INFO</span><span class="token comment">//样本信息</span>
<span class="token punctuation">{<!-- --></span>
	BOOL B<span class="token punctuation">;</span><span class="token comment">//为TRUE，样本为第1个样本</span>
	DWORD STAR<span class="token punctuation">;</span><span class="token comment">//运行开始时间，单位毫秒</span>
	LONGLONG star<span class="token punctuation">;</span><span class="token comment">//样本开始时间，单位100纳秒</span>
	LONGLONG end<span class="token punctuation">;</span><span class="token comment">//样本结束时间，单位100纳秒</span>
	BYTE<span class="token operator">*</span> pB<span class="token punctuation">;</span><span class="token comment">//样本缓冲区指针</span>
	<span class="token keyword">int</span> len<span class="token punctuation">;</span><span class="token comment">//样本的字节大小</span>
	HANDLE hRun<span class="token punctuation">;</span><span class="token comment">//“运行”事件句柄</span>
	HANDLE hSeek<span class="token punctuation">;</span><span class="token comment">//“定位”事件句柄</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">SliderSetPosition</span><span class="token punctuation">(</span>LONGLONG pos<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">ReceiveVideoSample</span><span class="token punctuation">(</span>SAMPLE_INFO SampleInfo<span class="token punctuation">)</span><span class="token comment">//视频样本接收函数</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">ReceiveAudioSample</span><span class="token punctuation">(</span>SAMPLE_INFO SampleInfo<span class="token punctuation">)</span><span class="token comment">//音频样本接收函数</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     定义函数指针：
    </p>
    <pre><code class="prism language-cpp">	<span class="token keyword">typedef</span> <span class="token keyword">int</span><span class="token punctuation">(</span>__thiscall <span class="token operator">*</span>MYPROC_ReceiveSample<span class="token punctuation">)</span><span class="token punctuation">(</span>SAMPLE_INFO info<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">typedef</span> <span class="token keyword">void</span><span class="token punctuation">(</span>__thiscall <span class="token operator">*</span>MYPROC_GetPos<span class="token punctuation">)</span><span class="token punctuation">(</span>LONGLONG pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">typedef</span> <span class="token function">INFO</span><span class="token punctuation">(</span>__cdecl <span class="token operator">*</span>MYPROC_SReader_Init<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">wchar_t</span><span class="token operator">*</span> Path<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">typedef</span> <span class="token keyword">int</span><span class="token punctuation">(</span>__cdecl <span class="token operator">*</span>MYPROC_SReader_Run<span class="token punctuation">)</span><span class="token punctuation">(</span>MYPROC_ReceiveSample VideoSample<span class="token punctuation">,</span> MYPROC_ReceiveSample AudioSample<span class="token punctuation">,</span> MYPROC_GetPos Pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">typedef</span> <span class="token keyword">int</span><span class="token punctuation">(</span>__cdecl <span class="token operator">*</span>MYPROC_SReader_Pause<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">typedef</span> <span class="token keyword">int</span><span class="token punctuation">(</span>__cdecl <span class="token operator">*</span>MYPROC_SReader_Stop<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">typedef</span> <span class="token keyword">int</span><span class="token punctuation">(</span>__cdecl <span class="token operator">*</span>MYPROC_SReader_Seek<span class="token punctuation">)</span><span class="token punctuation">(</span>LONGLONG SeekPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">typedef</span> <span class="token keyword">int</span><span class="token punctuation">(</span>__cdecl <span class="token operator">*</span>MYPROC_SReader_GetState<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">typedef</span> <span class="token keyword">int</span><span class="token punctuation">(</span>__cdecl <span class="token operator">*</span>MYPROC_SReader_Exit<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     获取本读取器导出函数的地址：
    </p>
    <pre><code class="prism language-cpp">	MYPROC_SReader_Init SReader_Init <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	MYPROC_SReader_GetState SReader_GetState <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	MYPROC_SReader_Run SReader_Run <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	MYPROC_SReader_Pause SReader_Pause <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	MYPROC_SReader_Stop SReader_Stop <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	MYPROC_SReader_Seek SReader_Seek <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	MYPROC_SReader_Exit SReader_Exit <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	MYPROC_GetPos GetPos<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
	MYPROC_ReceiveSample ReceiveVideo<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
	MYPROC_ReceiveSample ReceiveAudio<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>hSReader<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		SReader_Init <span class="token operator">=</span> <span class="token punctuation">(</span>MYPROC_SReader_Init<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>hSReader<span class="token punctuation">,</span> <span class="token string">"Init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		SReader_GetState <span class="token operator">=</span> <span class="token punctuation">(</span>MYPROC_SReader_GetState<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>hSReader<span class="token punctuation">,</span> <span class="token string">"GetState"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		SReader_Run <span class="token operator">=</span> <span class="token punctuation">(</span>MYPROC_SReader_Run<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>hSReader<span class="token punctuation">,</span> <span class="token string">"Run"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		SReader_Pause <span class="token operator">=</span> <span class="token punctuation">(</span>MYPROC_SReader_Pause<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>hSReader<span class="token punctuation">,</span> <span class="token string">"Pause"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		SReader_Stop <span class="token operator">=</span> <span class="token punctuation">(</span>MYPROC_SReader_Stop<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>hSReader<span class="token punctuation">,</span> <span class="token string">"Stop"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		SReader_Seek <span class="token operator">=</span> <span class="token punctuation">(</span>MYPROC_SReader_Seek<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>hSReader<span class="token punctuation">,</span> <span class="token string">"Seek"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		SReader_Exit <span class="token operator">=</span> <span class="token punctuation">(</span>MYPROC_SReader_Exit<span class="token punctuation">)</span><span class="token function">GetProcAddress</span><span class="token punctuation">(</span>hSReader<span class="token punctuation">,</span> <span class="token string">"Exit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		GetPos <span class="token operator">=</span> <span class="token punctuation">(</span>MYPROC_GetPos<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>SliderSetPosition<span class="token punctuation">)</span><span class="token punctuation">;</span>	
		ReceiveVideo<span class="token operator">=</span><span class="token punctuation">(</span>MYPROC_ReceiveSample<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ReceiveVideoSample<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ReceiveAudio<span class="token operator">=</span><span class="token punctuation">(</span>MYPROC_ReceiveSample<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ReceiveAudioSample<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre>
    <p>
     初始化本读取器，获取文件媒体信息：
    </p>
    <pre><code class="prism language-cpp">	INFO info<span class="token punctuation">;</span>
	<span class="token keyword">wchar_t</span><span class="token operator">*</span> path <span class="token operator">=</span> L<span class="token string">"某视频文件.mp4"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>SReader_Init <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
		info <span class="token operator">=</span> <span class="token function">SReader_Init</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     为读取器指定视频样本和音频样本接收函数，和接收位置信息函数（不需要位置信息时，GetPos可以为NULL）；运行读取器:
    </p>
    <pre><code class="prism language-cpp">	<span class="token keyword">if</span> <span class="token punctuation">(</span>SReader_Run<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">SReader_Run</span><span class="token punctuation">(</span>ReceiveVideo<span class="token punctuation">,</span> ReceiveAudio<span class="token punctuation">,</span> GetPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre>
    <p>
     这样视频音频样本接收函数将被反复调用，参数提供样本的数据和信息。其它导出函数用于读取器的暂停，停止和退出；获取读取器当前状态，调用SReader_GetState()，返回状态值。
     <br/>
     本读取器为后续文章“播放视频”而设计，读者可以在本代码的基础上添加自己想要的功能，也可以进行更改。
    </p>
    <h3>
     <a id="_110">
     </a>
     本读取器的全部代码
    </h3>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"windows.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mmsystem.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">"winmm"</span><span class="token expression"><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mfapi.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mfidl.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"mfreadwrite.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">"mfplat"</span><span class="token expression"><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">"mfreadwrite"</span><span class="token expression"><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">comment</span><span class="token punctuation">(</span>lib<span class="token punctuation">,</span> </span><span class="token string">"mfuuid"</span><span class="token expression"><span class="token punctuation">)</span></span></span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token keyword">void</span> <span class="token function">SafeRelease</span><span class="token punctuation">(</span>T<span class="token operator">*</span><span class="token operator">*</span> ppT<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>ppT<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">(</span><span class="token operator">*</span>ppT<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">Release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span>ppT <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">struct</span> <span class="token class-name">INFO</span><span class="token comment">//媒体信息</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> VideoWidth<span class="token punctuation">;</span><span class="token comment">//视频宽，单位像素</span>
	<span class="token keyword">int</span> VideoHeight<span class="token punctuation">;</span><span class="token comment">//视频高，单位像素</span>
	LONGLONG FrameCur<span class="token punctuation">;</span><span class="token comment">//帧持续时间，单位100纳秒</span>
	LONGLONG DUR<span class="token punctuation">;</span><span class="token comment">//媒体时长，单位100纳秒</span>
	DWORD AudioSamplePerSec<span class="token punctuation">;</span><span class="token comment">//音频样本采样率</span>
	DWORD StreamCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//流数量</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">SAMPLE_INFO</span><span class="token comment">//样本信息</span>
<span class="token punctuation">{<!-- --></span>
	BOOL B<span class="token punctuation">;</span><span class="token comment">//为TRUE，样本为第1个样本</span>
	DWORD STAR<span class="token punctuation">;</span><span class="token comment">//运行开始时间，单位毫秒</span>
	LONGLONG star<span class="token punctuation">;</span><span class="token comment">//样本开始时间，单位100纳秒</span>
	LONGLONG end<span class="token punctuation">;</span><span class="token comment">//样本结束时间，单位100纳秒</span>
	BYTE<span class="token operator">*</span> pB<span class="token punctuation">;</span><span class="token comment">//样本缓冲区指针</span>
	<span class="token keyword">int</span> len<span class="token punctuation">;</span><span class="token comment">//样本的字节大小</span>
	HANDLE hRun<span class="token punctuation">;</span><span class="token comment">//“运行”事件句柄</span>
	HANDLE hSeek<span class="token punctuation">;</span><span class="token comment">//“定位”事件句柄</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">typedef</span> <span class="token keyword">int</span><span class="token punctuation">(</span>__cdecl <span class="token operator">*</span>MYPROC_SendVideo<span class="token punctuation">)</span><span class="token punctuation">(</span>SAMPLE_INFO SampleInfo<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//定义函数指针</span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span><span class="token punctuation">(</span>__cdecl <span class="token operator">*</span>MYPROC_SendAudio<span class="token punctuation">)</span><span class="token punctuation">(</span>SAMPLE_INFO SampleInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">int</span><span class="token punctuation">(</span>__cdecl <span class="token operator">*</span>MYPROC_SendPos<span class="token punctuation">)</span><span class="token punctuation">(</span>LONGLONG pos<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">SReader</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">SReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		HRESULT hr <span class="token operator">=</span> <span class="token function">MFStartup</span><span class="token punctuation">(</span>MF_VERSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>hr <span class="token operator">!=</span> S_OK<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">MessageBox</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> L<span class="token string">"初始化媒体基础失败"</span><span class="token punctuation">,</span> L<span class="token string">"SourceReader"</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		hRun <span class="token operator">=</span> <span class="token function">CreateEvent</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> TRUE<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//手动重置，初始无信号</span>
		hExit <span class="token operator">=</span> <span class="token function">CreateEvent</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> TRUE<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//手动重置，初始无信号</span>
		hSeek <span class="token operator">=</span> <span class="token function">CreateEvent</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> TRUE<span class="token punctuation">,</span> FALSE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//手动重置，初始无信号</span>
	<span class="token punctuation">}</span>
	<span class="token operator">~</span><span class="token function">SReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">SafeRelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pIMFSourceReader<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hRun<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hExit<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hSeek<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">MFShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//关闭媒体基础</span>
	<span class="token punctuation">}</span>
	HANDLE hRun<span class="token punctuation">,</span> hExit<span class="token punctuation">,</span> hSeek<span class="token punctuation">;</span>
	IMFSourceReader<span class="token operator">*</span> pIMFSourceReader <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//源读取器接口指针</span>
	UINT32 Width<span class="token punctuation">,</span> Height<span class="token punctuation">;</span><span class="token comment">//视频宽高</span>
	LONGLONG DUR<span class="token punctuation">;</span><span class="token comment">//媒体持续时间，100纳秒单位</span>
	LONGLONG CUR<span class="token punctuation">;</span><span class="token comment">//当前位置，100纳秒单位</span>
	LONGLONG SeekPos<span class="token punctuation">;</span><span class="token comment">//定位位置</span>
	DWORD STAR<span class="token punctuation">;</span><span class="token comment">//开始时间</span>
	BOOL VFirst<span class="token punctuation">,</span> AFirst<span class="token punctuation">;</span><span class="token comment">//为TRUE标明第1个样本</span>
	<span class="token keyword">int</span> mState<span class="token punctuation">;</span><span class="token comment">//状态；0停止，1运行，2暂停</span>
	INFO info<span class="token punctuation">;</span><span class="token comment">//媒体信息对象</span>
	MYPROC_SendVideo SendVideo <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//视频样本输出函数指针</span>
	MYPROC_SendAudio SendAudio <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//音频样本输出函数指针</span>
	MYPROC_SendPos SendPos <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//当前位置输出函数指针</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

HRESULT <span class="token function">GetSample</span><span class="token punctuation">(</span>IMFSourceReader<span class="token operator">*</span> pIMFSourceReader<span class="token punctuation">,</span> UINT SOURCE<span class="token punctuation">,</span> LONGLONG<span class="token operator">&amp;</span> Cur<span class="token punctuation">,</span> LONGLONG<span class="token operator">&amp;</span> Dur<span class="token punctuation">)</span><span class="token comment">//获取样本</span>
<span class="token punctuation">{<!-- --></span>
	IMFSample<span class="token operator">*</span> pMFSample <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> DWORD flags<span class="token punctuation">;</span>
	HRESULT hr <span class="token operator">=</span> pIMFSourceReader<span class="token operator">-&gt;</span><span class="token function">ReadSample</span><span class="token punctuation">(</span>SOURCE<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>flags<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pMFSample<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取视频样本</span>
	hr <span class="token operator">=</span> pMFSample<span class="token operator">-&gt;</span><span class="token function">GetSampleTime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Cur<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取显示时间</span>
	hr <span class="token operator">=</span> pMFSample<span class="token operator">-&gt;</span><span class="token function">GetSampleDuration</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Dur<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取持续时间</span>
	<span class="token function">SafeRelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pMFSample<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放接口</span>
	<span class="token keyword">return</span> hr<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

SReader<span class="token operator">*</span> pSReader <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//SReader类对象指针</span>
HANDLE hVthread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> hAthread <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//视频音频线程句柄</span>

DWORD WINAPI <span class="token function">VideoThread</span><span class="token punctuation">(</span>LPVOID lp<span class="token punctuation">)</span><span class="token comment">//视频线程</span>
<span class="token punctuation">{<!-- --></span>
	HRESULT hr<span class="token punctuation">;</span> pSReader<span class="token operator">-&gt;</span>VFirst <span class="token operator">=</span> TRUE<span class="token punctuation">;</span> IMFSample<span class="token operator">*</span> pMFSample <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> DWORD flags<span class="token punctuation">;</span>
Agan<span class="token operator">:</span>
	DWORD mRun <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hRun<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检测“运行”信号，不等待</span>
	DWORD mSeek <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hSeek<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检测“定位”信号，不等待</span>
	DWORD mExit <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hExit<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检测“退出”信号，不等待</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mExit <span class="token operator">==</span> WAIT_OBJECT_0<span class="token punctuation">)</span><span class="token comment">//有“退出”信号</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//退出线程</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mSeek <span class="token operator">==</span> WAIT_OBJECT_0<span class="token punctuation">)</span><span class="token comment">//有“定位”信号</span>
	<span class="token punctuation">{<!-- --></span>
		hr <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token operator">-&gt;</span><span class="token function">Flush</span><span class="token punctuation">(</span>MF_SOURCE_READER_ALL_STREAMS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//丢弃所有排队的样本并取消所有挂起的样本请求</span>
		PROPVARIANT pv<span class="token punctuation">;</span>
		<span class="token function">PropVariantInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pv<span class="token punctuation">)</span><span class="token punctuation">;</span>
		pv<span class="token punctuation">.</span>vt <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
		pv<span class="token punctuation">.</span>hVal<span class="token punctuation">.</span>QuadPart <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>SeekPos<span class="token punctuation">;</span>
		hr <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token operator">-&gt;</span><span class="token function">SetCurrentPosition</span><span class="token punctuation">(</span>GUID_NULL<span class="token punctuation">,</span> pv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更改源读取器位置</span>
		<span class="token function">PropVariantClear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pv<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">/*试验发现，源读取器在媒体中间时间段定位后，音频视频样本不同步（时间戳相差约2秒钟），故添加下面代码以使样本时间同步*/</span>
		LONGLONG VCur<span class="token punctuation">,</span> VDur<span class="token punctuation">;</span>
		hr <span class="token operator">=</span> <span class="token function">GetSample</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token punctuation">,</span> MF_SOURCE_READER_FIRST_VIDEO_STREAM<span class="token punctuation">,</span> VCur<span class="token punctuation">,</span> VDur<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取视频样本时间</span>
		LONGLONG ACur<span class="token punctuation">,</span> ADur<span class="token punctuation">;</span>
		hr <span class="token operator">=</span> <span class="token function">GetSample</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token punctuation">,</span> MF_SOURCE_READER_FIRST_AUDIO_STREAM<span class="token punctuation">,</span> ACur<span class="token punctuation">,</span> ADur<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取音频样本时间</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ACur <span class="token operator">&gt;</span> VCur <span class="token operator">+</span> VDur <span class="token operator">+</span> <span class="token number">100000</span><span class="token punctuation">)</span><span class="token comment">//如果音频样本时间过大</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span>ACur <span class="token operator">&gt;</span> VCur <span class="token operator">+</span> VDur <span class="token operator">+</span> <span class="token number">100000</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				hr <span class="token operator">=</span> <span class="token function">GetSample</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token punctuation">,</span> MF_SOURCE_READER_FIRST_VIDEO_STREAM<span class="token punctuation">,</span> VCur<span class="token punctuation">,</span> VDur<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取下一个视频样本</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>VCur <span class="token operator">&gt;</span> ACur <span class="token operator">+</span> ADur <span class="token operator">+</span> <span class="token number">100000</span><span class="token punctuation">)</span><span class="token comment">//如果视频样本时间过大</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">while</span> <span class="token punctuation">(</span>VCur <span class="token operator">&gt;</span> ACur <span class="token operator">+</span> ADur <span class="token operator">+</span> <span class="token number">100000</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				hr <span class="token operator">=</span> <span class="token function">GetSample</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token punctuation">,</span> MF_SOURCE_READER_FIRST_AUDIO_STREAM<span class="token punctuation">,</span> ACur<span class="token punctuation">,</span> ADur<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取下一个音频样本</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		pSReader<span class="token operator">-&gt;</span>STAR <span class="token operator">=</span> <span class="token function">timeGetTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//记录运行开始时间，单位毫秒</span>
		pSReader<span class="token operator">-&gt;</span>VFirst <span class="token operator">=</span> TRUE<span class="token punctuation">;</span> pSReader<span class="token operator">-&gt;</span>AFirst <span class="token operator">=</span> TRUE<span class="token punctuation">;</span><span class="token comment">//设置第1个样本标记为TRUE</span>
		<span class="token function">ResetEvent</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hSeek<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置“定位”无信号</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mRun <span class="token operator">==</span> WAIT_OBJECT_0<span class="token punctuation">)</span><span class="token comment">//有“运行”信号</span>
	<span class="token punctuation">{<!-- --></span>
		hr <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token operator">-&gt;</span><span class="token function">ReadSample</span><span class="token punctuation">(</span>MF_SOURCE_READER_FIRST_VIDEO_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>flags<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pMFSample<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取视频样本</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>hr <span class="token operator">==</span> S_OK <span class="token operator">&amp;&amp;</span> pMFSample<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			LONGLONG Cur<span class="token punctuation">,</span> Dur<span class="token punctuation">;</span>
			hr <span class="token operator">=</span> pMFSample<span class="token operator">-&gt;</span><span class="token function">GetSampleTime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Cur<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取显示时间</span>
			hr <span class="token operator">=</span> pMFSample<span class="token operator">-&gt;</span><span class="token function">GetSampleDuration</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Dur<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取持续时间</span>
			DWORD Lt<span class="token punctuation">;</span>
			hr <span class="token operator">=</span> pMFSample<span class="token operator">-&gt;</span><span class="token function">GetTotalLength</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Lt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取有效长度</span>
			DWORD count<span class="token punctuation">;</span>
			hr <span class="token operator">=</span> pMFSample<span class="token operator">-&gt;</span><span class="token function">GetBufferCount</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取缓冲区数量</span>
			IMFMediaBuffer<span class="token operator">*</span> pMFBuffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//如果只有1个缓冲区</span>
			<span class="token punctuation">{<!-- --></span>
				hr <span class="token operator">=</span> pMFSample<span class="token operator">-&gt;</span><span class="token function">GetBufferByIndex</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pMFBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span><span class="token comment">//如果有多个缓冲区</span>
			<span class="token punctuation">{<!-- --></span>
				hr <span class="token operator">=</span> pMFSample<span class="token operator">-&gt;</span><span class="token function">ConvertToContiguousBuffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pMFBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			BYTE<span class="token operator">*</span> pSB <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			hr <span class="token operator">=</span> pMFBuffer<span class="token operator">-&gt;</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pSB<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//锁定缓冲区</span>
			SAMPLE_INFO info<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>B <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>VFirst<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>STAR <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>STAR<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>star <span class="token operator">=</span> Cur<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>end <span class="token operator">=</span> Cur <span class="token operator">+</span> Dur<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>pB <span class="token operator">=</span> pSB<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>len <span class="token operator">=</span> Lt<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>hRun <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>hRun<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>hSeek <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>hSeek<span class="token punctuation">;</span>
			pSReader<span class="token operator">-&gt;</span><span class="token function">SendVideo</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用视频输出函数，输出样本</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>VFirst<span class="token punctuation">)</span>pSReader<span class="token operator">-&gt;</span>VFirst <span class="token operator">=</span> FALSE<span class="token punctuation">;</span><span class="token comment">//只有第1个样本标记为TRUE</span>
			hr <span class="token operator">=</span> pMFBuffer<span class="token operator">-&gt;</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解锁缓冲区</span>
			<span class="token function">SafeRelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pMFBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">SafeRelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pMFSample<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放接口</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">goto</span> Agan<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

DWORD WINAPI <span class="token function">AudioThread</span><span class="token punctuation">(</span>LPVOID lp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	HRESULT hr<span class="token punctuation">;</span> pSReader<span class="token operator">-&gt;</span>AFirst <span class="token operator">=</span> TRUE<span class="token punctuation">;</span> IMFSample<span class="token operator">*</span> pMFSample <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> DWORD flags<span class="token punctuation">;</span> pSReader<span class="token operator">-&gt;</span>CUR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">int</span> Count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
Agan<span class="token operator">:</span>
	DWORD mRun <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hRun<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检测“运行”信号，不等待</span>
	DWORD mSeek <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hSeek<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检测“定位”信号，不等待</span>
	DWORD mExit <span class="token operator">=</span> <span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hExit<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检测“退出”信号，不等待</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mExit <span class="token operator">==</span> WAIT_OBJECT_0<span class="token punctuation">)</span><span class="token comment">//有“退出”信号</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//退出线程</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mSeek <span class="token operator">==</span> WAIT_OBJECT_0<span class="token punctuation">)</span><span class="token comment">//有“定位”信号</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>info<span class="token punctuation">.</span>StreamCount <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token comment">//如果有视频流和音频流</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">goto</span> Agan<span class="token punctuation">;</span><span class="token comment">//阻塞（更改位置操作在视频线程中，音频线程等待操作完成）</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span><span class="token comment">//如果只有音频流，在此更改源读取器位置</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token operator">-&gt;</span><span class="token function">Flush</span><span class="token punctuation">(</span>MF_SOURCE_READER_ALL_STREAMS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//丢弃所有排队的样本并取消所有挂起的样本请求</span>
			PROPVARIANT pv<span class="token punctuation">;</span>
			<span class="token function">PropVariantInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pv<span class="token punctuation">)</span><span class="token punctuation">;</span>
			pv<span class="token punctuation">.</span>vt <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
			pv<span class="token punctuation">.</span>hVal<span class="token punctuation">.</span>QuadPart <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>SeekPos<span class="token punctuation">;</span>
			hr <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token operator">-&gt;</span><span class="token function">SetCurrentPosition</span><span class="token punctuation">(</span>GUID_NULL<span class="token punctuation">,</span> pv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//更改源读取器位置</span>
			<span class="token function">PropVariantClear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pv<span class="token punctuation">)</span><span class="token punctuation">;</span>
			pSReader<span class="token operator">-&gt;</span>STAR <span class="token operator">=</span> <span class="token function">timeGetTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//记录运行开始时间</span>
			pSReader<span class="token operator">-&gt;</span>AFirst <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>
			<span class="token function">ResetEvent</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hSeek<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置“定位”无信号</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>mRun <span class="token operator">==</span> WAIT_OBJECT_0<span class="token punctuation">)</span><span class="token comment">//有“运行”信号</span>
	<span class="token punctuation">{<!-- --></span>
		hr <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token operator">-&gt;</span><span class="token function">ReadSample</span><span class="token punctuation">(</span>MF_SOURCE_READER_FIRST_AUDIO_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>flags<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pMFSample<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取音频样本</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>hr <span class="token operator">==</span> S_OK <span class="token operator">&amp;&amp;</span> pMFSample<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			LONGLONG Cur<span class="token punctuation">,</span> Dur<span class="token punctuation">;</span>
			hr <span class="token operator">=</span> pMFSample<span class="token operator">-&gt;</span><span class="token function">GetSampleTime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Cur<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取显示时间</span>
			hr <span class="token operator">=</span> pMFSample<span class="token operator">-&gt;</span><span class="token function">GetSampleDuration</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Dur<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取持续时间</span>
			Count<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>Count <span class="token operator">&gt;</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token comment">//每10个样本，发送一次当前位置</span>
			<span class="token punctuation">{<!-- --></span>
				pSReader<span class="token operator">-&gt;</span>CUR <span class="token operator">=</span> Cur<span class="token punctuation">;</span><span class="token comment">//赋值当前时间</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>SendPos<span class="token punctuation">)</span>pSReader<span class="token operator">-&gt;</span><span class="token function">SendPos</span><span class="token punctuation">(</span>Cur<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送当前时间位置值</span>
				Count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			DWORD Lt<span class="token punctuation">;</span>
			hr <span class="token operator">=</span> pMFSample<span class="token operator">-&gt;</span><span class="token function">GetTotalLength</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>Lt<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取有效长度</span>
			DWORD count<span class="token punctuation">;</span>
			hr <span class="token operator">=</span> pMFSample<span class="token operator">-&gt;</span><span class="token function">GetBufferCount</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取缓冲区数量</span>
			IMFMediaBuffer<span class="token operator">*</span> pMFBuffer <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">//如果只有1个缓冲区</span>
			<span class="token punctuation">{<!-- --></span>
				hr <span class="token operator">=</span> pMFSample<span class="token operator">-&gt;</span><span class="token function">GetBufferByIndex</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pMFBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span><span class="token comment">//如果有多个缓冲区</span>
			<span class="token punctuation">{<!-- --></span>
				hr <span class="token operator">=</span> pMFSample<span class="token operator">-&gt;</span><span class="token function">ConvertToContiguousBuffer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pMFBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			BYTE<span class="token operator">*</span> pSB <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			hr <span class="token operator">=</span> pMFBuffer<span class="token operator">-&gt;</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pSB<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//锁定缓冲区</span>
			SAMPLE_INFO info<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>B <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>AFirst<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>STAR <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>STAR<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>star <span class="token operator">=</span> Cur<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>end <span class="token operator">=</span> Cur <span class="token operator">+</span> Dur<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>pB <span class="token operator">=</span> pSB<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>len <span class="token operator">=</span> Lt<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>hRun <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>hRun<span class="token punctuation">;</span>
			info<span class="token punctuation">.</span>hSeek <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>hSeek<span class="token punctuation">;</span>
			pSReader<span class="token operator">-&gt;</span><span class="token function">SendAudio</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用音频样本输出函数，发送音频样本</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>AFirst<span class="token punctuation">)</span>pSReader<span class="token operator">-&gt;</span>AFirst <span class="token operator">=</span> FALSE<span class="token punctuation">;</span><span class="token comment">//只有第1个样本标记为TRUE</span>
			hr <span class="token operator">=</span> pMFBuffer<span class="token operator">-&gt;</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解锁缓冲区</span>
			<span class="token function">SafeRelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pMFBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">SafeRelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pMFSample<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//释放接口</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">goto</span> Agan<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">//下面是导出函数定义</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">warning</span><span class="token punctuation">(</span>disable<span class="token operator">:</span><span class="token number">4190</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus    </span><span class="token comment">// If used by C++ code, </span></span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token punctuation">{<!-- --></span>          <span class="token comment">// we need to export the C interface</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span> INFO __cdecl <span class="token function">Init</span><span class="token punctuation">(</span><span class="token keyword">wchar_t</span><span class="token operator">*</span> Path<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pSReader<span class="token punctuation">)</span><span class="token comment">//如果SReader对象已存在</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">SetEvent</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hExit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置“退出”有信号</span>
			<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hVthread<span class="token punctuation">,</span> INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待视频线程退出</span>
			<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hAthread<span class="token punctuation">,</span> INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待音频线程退出</span>
			<span class="token keyword">delete</span> pSReader<span class="token punctuation">;</span><span class="token comment">//删除SReader对象</span>
		<span class="token punctuation">}</span>
		pSReader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">SReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建SReader对象</span>
		IMFAttributes<span class="token operator">*</span> pIMFAttributes <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		HRESULT hr <span class="token operator">=</span> <span class="token function">MFCreateAttributes</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pIMFAttributes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> pIMFAttributes<span class="token operator">-&gt;</span><span class="token function">SetUINT32</span><span class="token punctuation">(</span>MF_READWRITE_ENABLE_HARDWARE_TRANSFORMS<span class="token punctuation">,</span> <span class="token punctuation">(</span>UINT32<span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//使用基于硬件的媒体基础转换</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> pIMFAttributes<span class="token operator">-&gt;</span><span class="token function">SetUINT32</span><span class="token punctuation">(</span>MF_SOURCE_READER_ENABLE_VIDEO_PROCESSING<span class="token punctuation">,</span> <span class="token punctuation">(</span>UINT32<span class="token punctuation">)</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//允许源读取器进行有限的视频处理</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> <span class="token function">MFCreateSourceReaderFromURL</span><span class="token punctuation">(</span>Path<span class="token punctuation">,</span> pIMFAttributes<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建源读取器</span>
		<span class="token punctuation">}</span>
		<span class="token function">SafeRelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pIMFAttributes<span class="token punctuation">)</span><span class="token punctuation">;</span>
		PROPVARIANT var<span class="token punctuation">;</span>
		<span class="token function">PropVariantInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>var<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token operator">-&gt;</span><span class="token function">GetPresentationAttribute</span><span class="token punctuation">(</span>MF_SOURCE_READER_MEDIASOURCE<span class="token punctuation">,</span> MF_PD_DURATION<span class="token punctuation">,</span> <span class="token operator">&amp;</span>var<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取媒体时间长度，100纳秒单位</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			pSReader<span class="token operator">-&gt;</span>info<span class="token punctuation">.</span>DUR <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>DUR <span class="token operator">=</span> <span class="token punctuation">(</span>LONGLONG<span class="token punctuation">)</span>var<span class="token punctuation">.</span>uhVal<span class="token punctuation">.</span>QuadPart<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">PropVariantClear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>var<span class="token punctuation">)</span><span class="token punctuation">;</span>
		IMFMediaType<span class="token operator">*</span> pAudioMTA <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> <span class="token function">MFCreateMediaType</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pAudioMTA<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建空的媒体类型</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> pAudioMTA<span class="token operator">-&gt;</span><span class="token function">SetGUID</span><span class="token punctuation">(</span>MF_MT_MAJOR_TYPE<span class="token punctuation">,</span> MFMediaType_Audio<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置主要类型音频</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> pAudioMTA<span class="token operator">-&gt;</span><span class="token function">SetGUID</span><span class="token punctuation">(</span>MF_MT_SUBTYPE<span class="token punctuation">,</span> MFAudioFormat_PCM<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置子类型PCM</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> pAudioMTA<span class="token operator">-&gt;</span><span class="token function">SetUINT32</span><span class="token punctuation">(</span>MF_MT_AUDIO_BITS_PER_SAMPLE<span class="token punctuation">,</span> <span class="token punctuation">(</span>UINT32<span class="token punctuation">)</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置样本16位</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> pAudioMTA<span class="token operator">-&gt;</span><span class="token function">SetUINT32</span><span class="token punctuation">(</span>MF_MT_AUDIO_SAMPLES_PER_SECOND<span class="token punctuation">,</span> <span class="token punctuation">(</span>UINT32<span class="token punctuation">)</span><span class="token number">48000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置样本采样率48000</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			pSReader<span class="token operator">-&gt;</span>info<span class="token punctuation">.</span>AudioSamplePerSec <span class="token operator">=</span> <span class="token number">48000</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token operator">-&gt;</span><span class="token function">SetCurrentMediaType</span><span class="token punctuation">(</span>MF_SOURCE_READER_FIRST_AUDIO_STREAM<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pAudioMTA<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置音频输出媒体类型（此时未提供媒体类型全部信息）</span>
		<span class="token punctuation">}</span>
		<span class="token function">SafeRelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pAudioMTA<span class="token punctuation">)</span><span class="token punctuation">;</span>
		IMFMediaType<span class="token operator">*</span> pAudioMT <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token operator">-&gt;</span><span class="token function">GetCurrentMediaType</span><span class="token punctuation">(</span>MF_SOURCE_READER_FIRST_AUDIO_STREAM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pAudioMT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取当前音频输出媒体类型（获取的媒体类型将包含全部信息）</span>
		<span class="token punctuation">}</span>
		UINT32 SamplePerSec<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> pAudioMT<span class="token operator">-&gt;</span><span class="token function">GetUINT32</span><span class="token punctuation">(</span>MF_MT_AUDIO_SAMPLES_PER_SECOND<span class="token punctuation">,</span> <span class="token operator">&amp;</span>SamplePerSec<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取采样率</span>
		<span class="token punctuation">}</span>
		<span class="token function">SafeRelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pAudioMT<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			pSReader<span class="token operator">-&gt;</span>info<span class="token punctuation">.</span>AudioSamplePerSec <span class="token operator">=</span> SamplePerSec<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		pSReader<span class="token operator">-&gt;</span>info<span class="token punctuation">.</span>StreamCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">ResetEvent</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hExit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置“退出”无信号</span>
			pSReader<span class="token operator">-&gt;</span>info<span class="token punctuation">.</span>StreamCount<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//流数量</span>
			hAthread <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> AudioThread<span class="token punctuation">,</span> pSReader<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建音频线程</span>
		<span class="token punctuation">}</span>
		IMFMediaType<span class="token operator">*</span> pVideoMTV <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> <span class="token function">MFCreateMediaType</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pVideoMTV<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建空的媒体类型</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> pVideoMTV<span class="token operator">-&gt;</span><span class="token function">SetGUID</span><span class="token punctuation">(</span>MF_MT_MAJOR_TYPE<span class="token punctuation">,</span> MFMediaType_Video<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置主要类型为视频</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> pVideoMTV<span class="token operator">-&gt;</span><span class="token function">SetGUID</span><span class="token punctuation">(</span>MF_MT_SUBTYPE<span class="token punctuation">,</span> MFVideoFormat_RGB32<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置子类型RGB32</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hr <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token operator">-&gt;</span><span class="token function">SetCurrentMediaType</span><span class="token punctuation">(</span>MF_SOURCE_READER_FIRST_VIDEO_STREAM<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pVideoMTV<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置视频输出媒体类型</span>
		<span class="token punctuation">}</span>
		<span class="token function">SafeRelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pVideoMTV<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			IMFMediaType<span class="token operator">*</span> pVideoMT <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				hr <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token operator">-&gt;</span><span class="token function">GetCurrentMediaType</span><span class="token punctuation">(</span>MF_SOURCE_READER_FIRST_VIDEO_STREAM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pVideoMT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取当前视频媒体类型（此时的媒体类型将包含全部信息）</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				hr <span class="token operator">=</span> <span class="token function">MFGetAttributeSize</span><span class="token punctuation">(</span>pVideoMT<span class="token punctuation">,</span> MF_MT_FRAME_SIZE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pSReader<span class="token operator">-&gt;</span>Width<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pSReader<span class="token operator">-&gt;</span>Height<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取视频图像宽高</span>
			<span class="token punctuation">}</span>
			<span class="token function">SafeRelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pVideoMT<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">SUCCEEDED</span><span class="token punctuation">(</span>hr<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				pSReader<span class="token operator">-&gt;</span>info<span class="token punctuation">.</span>VideoWidth <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>Width<span class="token punctuation">;</span> pSReader<span class="token operator">-&gt;</span>info<span class="token punctuation">.</span>VideoHeight <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>Height<span class="token punctuation">;</span> pSReader<span class="token operator">-&gt;</span>info<span class="token punctuation">.</span>StreamCount<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			hVthread <span class="token operator">=</span> <span class="token function">CreateThread</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> VideoThread<span class="token punctuation">,</span> pSReader<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建视频线程</span>
		<span class="token punctuation">}</span>
		<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待线程初始化完成</span>
		<span class="token keyword">return</span> pSReader<span class="token operator">-&gt;</span>info<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span> <span class="token keyword">int</span> __cdecl <span class="token function">Run</span><span class="token punctuation">(</span>MYPROC_SendVideo SendVideo<span class="token punctuation">,</span> MYPROC_SendAudio SendAudio<span class="token punctuation">,</span> MYPROC_SendPos SendPos<span class="token punctuation">)</span><span class="token comment">//运行</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pSReader<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			pSReader<span class="token operator">-&gt;</span>SendVideo <span class="token operator">=</span> SendVideo<span class="token punctuation">;</span> pSReader<span class="token operator">-&gt;</span>SendAudio <span class="token operator">=</span> SendAudio<span class="token punctuation">;</span> pSReader<span class="token operator">-&gt;</span>SendPos <span class="token operator">=</span> SendPos<span class="token punctuation">;</span>
			pSReader<span class="token operator">-&gt;</span>STAR <span class="token operator">=</span> <span class="token function">timeGetTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//记录运行开始时间</span>
			pSReader<span class="token operator">-&gt;</span>VFirst <span class="token operator">=</span> TRUE<span class="token punctuation">;</span> pSReader<span class="token operator">-&gt;</span>AFirst <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>
			<span class="token function">SetEvent</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hRun<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置“运行”有信号</span>
			pSReader<span class="token operator">-&gt;</span>mState <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//状态标记置1</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span> <span class="token keyword">int</span> __cdecl <span class="token function">Pause</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token comment">//暂停</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pSReader<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">ResetEvent</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hRun<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置“运行”无信号</span>
			pSReader<span class="token operator">-&gt;</span>mState <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span><span class="token comment">//状态标记置2</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span> <span class="token keyword">int</span> __cdecl <span class="token function">Stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token comment">//停止</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pSReader<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">ResetEvent</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hRun<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置“运行”无信号</span>
			HRESULT hr <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token operator">-&gt;</span><span class="token function">Flush</span><span class="token punctuation">(</span>MF_SOURCE_READER_ALL_STREAMS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//丢弃所有排队的样本并取消所有挂起的样本请求</span>
			<span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			pSReader<span class="token operator">-&gt;</span>SeekPos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			PROPVARIANT pv<span class="token punctuation">;</span>
			<span class="token function">PropVariantInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pv<span class="token punctuation">)</span><span class="token punctuation">;</span>
			pv<span class="token punctuation">.</span>vt <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>
			pv<span class="token punctuation">.</span>hVal<span class="token punctuation">.</span>QuadPart <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			hr <span class="token operator">=</span> pSReader<span class="token operator">-&gt;</span>pIMFSourceReader<span class="token operator">-&gt;</span><span class="token function">SetCurrentPosition</span><span class="token punctuation">(</span>GUID_NULL<span class="token punctuation">,</span> pv<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置源读取器位置0</span>
			<span class="token function">PropVariantClear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pv<span class="token punctuation">)</span><span class="token punctuation">;</span>
			pSReader<span class="token operator">-&gt;</span>mState <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//状态标记置0</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span> <span class="token keyword">int</span> __cdecl <span class="token function">Seek</span><span class="token punctuation">(</span>LONGLONG SeekPos<span class="token punctuation">)</span><span class="token comment">//定位</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pSReader<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			pSReader<span class="token operator">-&gt;</span>SeekPos <span class="token operator">=</span> SeekPos<span class="token punctuation">;</span><span class="token comment">//赋值定位位置</span>
			<span class="token function">SetEvent</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hSeek<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置“定位”有信号</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span> <span class="token keyword">int</span> __cdecl <span class="token function">GetState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//获取状态</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pSReader<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> pSReader<span class="token operator">-&gt;</span>mState<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span> <span class="token keyword">int</span> __cdecl <span class="token function">Exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token comment">//退出</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pSReader<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">ResetEvent</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hRun<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置“运行”无信号</span>
			<span class="token function">SetEvent</span><span class="token punctuation">(</span>pSReader<span class="token operator">-&gt;</span>hExit<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置“退出”有信号</span>
			<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hVthread<span class="token punctuation">,</span> INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待视频线程已退出</span>
			<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span>hAthread<span class="token punctuation">,</span> INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待音频线程已退出</span>
			<span class="token keyword">delete</span> pSReader<span class="token punctuation">;</span> pSReader <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//删除SReader对象</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre>
    <p>
     <a href="https://download.csdn.net/download/h3974/90469029">
      下载本插件
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="687474:70733a2f2f626c6f672e6373646e2e6e65742f68333937342f:61727469636c652f64657461696c732f313436313332313532" class_="artid" style="display:none">
 </p>
</div>


