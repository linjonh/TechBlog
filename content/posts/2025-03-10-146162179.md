---
layout: post
title: "NVIDIA-k8s-device-plugin源码分析与安装部署"
date: 2025-03-10 19:41:38 +0800
description: "在一文中，我们从源码层面了解了kubelet侧关于device plugin逻辑的实现逻辑，本文以nvidia管理GPU的开源github项目为例，来看看设备插件侧的实现示例。"
keywords: "NVIDIA k8s-device-plugin源码分析与安装部署"
categories: ['Kubernetes', 'Gpu']
tags: ['Nvidia', 'Kubernetes', 'K', 'Gpu', 'Cuda']
artid: "146162179"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146162179
    alt: "NVIDIA-k8s-device-plugin源码分析与安装部署"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146162179
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146162179
cover: https://bing.ee123.net/img/rand?artid=146162179
image: https://bing.ee123.net/img/rand?artid=146162179
img: https://bing.ee123.net/img/rand?artid=146162179
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     NVIDIA k8s-device-plugin源码分析与安装部署
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     在
     <a href="https://blog.csdn.net/NUCEMLS/article/details/145950479">
      《kubernetes Device Plugin原理与源码分析》
     </a>
     一文中，我们从源码层面了解了kubelet侧关于device plugin逻辑的实现逻辑，本文以nvidia管理GPU的开源github项目
     <a href="https://github.com/NVIDIA/k8s-device-plugin">
      k8s-device-plugin
     </a>
     为例，来看看设备插件侧的实现示例。
    </p>
    <h2>
     <a id="Kubernetes_Device_Plugin_2">
     </a>
     一、Kubernetes Device Plugin
    </h2>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/direct/c07dbff446754ffabfb2988af599c91a.png"/>
    </p>
    <p>
     回顾上文kubelet侧的实现逻辑可知，设备插件侧应该实现如下逻辑：
    </p>
    <ul>
     <li>
      启动一个GRPC service，该service需实现以下方法（v1beta1）：
     </li>
    </ul>
    <pre><code class="prism language-protobuf">// DevicePlugin is the service advertised by Device Plugins
service DevicePlugin {
    // GetDevicePluginOptions returns options to be communicated with Device
    // Manager
    rpc GetDevicePluginOptions(Empty) returns (DevicePluginOptions) {}

    // ListAndWatch returns a stream of List of Devices
    // Whenever a Device state change or a Device disappears, ListAndWatch
    // returns the new list
    rpc ListAndWatch(Empty) returns (stream ListAndWatchResponse) {}

    // GetPreferredAllocation returns a preferred set of devices to allocate
    // from a list of available ones. The resulting preferred allocation is not
    // guaranteed to be the allocation ultimately performed by the
    // devicemanager. It is only designed to help the devicemanager make a more
    // informed allocation decision when possible.
    rpc GetPreferredAllocation(PreferredAllocationRequest) returns (PreferredAllocationResponse) {}

    // Allocate is called during container creation so that the Device
    // Plugin can run device specific operations and instruct Kubelet
    // of the steps to make the Device available in the container
    rpc Allocate(AllocateRequest) returns (AllocateResponse) {}

    // PreStartContainer is called, if indicated by Device Plugin during registeration phase,
    // before each container start. Device plugin can run device specific operations
    // such as resetting the device before making devices available to the container
    rpc PreStartContainer(PreStartContainerRequest) returns (PreStartContainerResponse) {}
}
</code></pre>
    <p>
     最主要的是
     <code>
      ListAndWatch
     </code>
     和
     <code>
      Allocate
     </code>
     两个方法，其中ListAndWatch方法负责上报设备上GPU的状态数据给kubelet，Allocate方法则是kubelet创建带有GPU资源的pod容器真正分配资源的方法。
    </p>
    <ul>
     <li>
      启动上述GRPC service后调用kubelet的Register方法，把自己注册到k8s中
     </li>
    </ul>
    <h2>
     <a id="k8sdeviceplugin_45">
     </a>
     二、k8s-device-plugin源码解读
    </h2>
    <blockquote>
     <p>
      以下内容基于github.com/NVIDIA/k8s-device-plugin@v0.16.2
     </p>
    </blockquote>
    <h3>
     <a id="21_main_49">
     </a>
     2.1 main
    </h3>
    <p>
     由于k8s-device-plugin代码量和逻辑并不算复杂，我们直接从main函数开始：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// k8s-device-plugin/cmd/nvidia-device-plugin/main.go</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">...</span>
    c<span class="token punctuation">.</span>Action <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>ctx <span class="token operator">*</span>cli<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">start</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> c<span class="token punctuation">.</span>Flags<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>

<span class="token comment">// k8s-device-plugin/cmd/nvidia-device-plugin/main.go</span>
<span class="token keyword">func</span> <span class="token function">start</span><span class="token punctuation">(</span>c <span class="token operator">*</span>cli<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> flags <span class="token punctuation">[</span><span class="token punctuation">]</span>cli<span class="token punctuation">.</span>Flag<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">...</span>
    klog<span class="token punctuation">.</span><span class="token function">Info</span><span class="token punctuation">(</span><span class="token string">"Starting FS watcher."</span><span class="token punctuation">)</span>
    <span class="token comment">// pluginapi.DevicePluginPath = /var/lib/kubelet/device-plugins/</span>
    watcher<span class="token punctuation">,</span> err <span class="token operator">:=</span> watch<span class="token punctuation">.</span><span class="token function">Files</span><span class="token punctuation">(</span>pluginapi<span class="token punctuation">.</span>DevicePluginPath<span class="token punctuation">)</span> 
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create FS watcher for %s: %v"</span><span class="token punctuation">,</span> pluginapi<span class="token punctuation">.</span>DevicePluginPath<span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">defer</span> watcher<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
    plugins<span class="token punctuation">,</span> restartPlugins<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">startPlugins</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> flags<span class="token punctuation">)</span>
    <span class="token operator">...</span>
    <span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">...</span>
            <span class="token keyword">case</span> event <span class="token operator">:=</span> <span class="token operator">&lt;-</span>watcher<span class="token punctuation">.</span>Events<span class="token punctuation">:</span>
            <span class="token comment">// pluginapi.KubeletSocket = /var/lib/kubelet/device-plugins/kubelet.sock</span>
            <span class="token keyword">if</span> event<span class="token punctuation">.</span>Name <span class="token operator">==</span> pluginapi<span class="token punctuation">.</span>KubeletSocket <span class="token operator">&amp;&amp;</span> event<span class="token punctuation">.</span>Op<span class="token operator">&amp;</span>fsnotify<span class="token punctuation">.</span>Create <span class="token operator">==</span> fsnotify<span class="token punctuation">.</span>Create <span class="token punctuation">{<!-- --></span>
                klog<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"inotify: %s created, restarting."</span><span class="token punctuation">,</span> pluginapi<span class="token punctuation">.</span>KubeletSocket<span class="token punctuation">)</span>
                <span class="token keyword">goto</span> restart
            <span class="token punctuation">}</span>
            <span class="token operator">...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这里注意一个逻辑：k8s-device-plugin在启动的时候会监听
     <code>
      /var/lib/kubelet/device-plugins/kubelet.sock
     </code>
     文件，当创建这个文件后，k8s-device-plugin会重启（goto restart）。之所以有这个逻辑，是因为kubelet重启会重新创建这个文件，而kubelet重启会清除其它设备插件放在这个目录下的socket文件，而且由于kubelet和设备插件之间通过ListAndWatch方法建立了长连接，这个长连接需要设备插件调用kubelet的Register方法触发，断连后k8s-device-plugin goto restart才能重新建立连接。
    </p>
    <h3>
     <a id="22_startPlugins_92">
     </a>
     2.2 startPlugins
    </h3>
    <p>
     startPlugins主要代码逻辑如下：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// k8s-device-plugin/cmd/nvidia-device-plugin/main.go</span>
<span class="token keyword">func</span> <span class="token function">startPlugins</span><span class="token punctuation">(</span>c <span class="token operator">*</span>cli<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> flags <span class="token punctuation">[</span><span class="token punctuation">]</span>cli<span class="token punctuation">.</span>Flag<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>plugin<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">...</span>
    driverRoot <span class="token operator">:=</span> <span class="token function">root</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>Plugin<span class="token punctuation">.</span>ContainerDriverRoot<span class="token punctuation">)</span>
    <span class="token comment">// We construct an NVML library specifying the path to libnvidia-ml.so.1</span>
    <span class="token comment">// explicitly so that we don't have to rely on the library path.</span>
    nvmllib <span class="token operator">:=</span> nvml<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>
        nvml<span class="token punctuation">.</span><span class="token function">WithLibraryPath</span><span class="token punctuation">(</span>driverRoot<span class="token punctuation">.</span><span class="token function">tryResolveLibrary</span><span class="token punctuation">(</span><span class="token string">"libnvidia-ml.so.1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    devicelib <span class="token operator">:=</span> device<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>nvmllib<span class="token punctuation">)</span>
    infolib <span class="token operator">:=</span> nvinfo<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>
        nvinfo<span class="token punctuation">.</span><span class="token function">WithNvmlLib</span><span class="token punctuation">(</span>nvmllib<span class="token punctuation">)</span><span class="token punctuation">,</span>
        nvinfo<span class="token punctuation">.</span><span class="token function">WithDeviceLib</span><span class="token punctuation">(</span>devicelib<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token operator">...</span>
    pluginManager<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">NewPluginManager</span><span class="token punctuation">(</span>infolib<span class="token punctuation">,</span> nvmllib<span class="token punctuation">,</span> devicelib<span class="token punctuation">,</span> config<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"error creating plugin manager: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    plugins<span class="token punctuation">,</span> err <span class="token operator">:=</span> pluginManager<span class="token punctuation">.</span><span class="token function">GetPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"error getting plugins: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> p <span class="token operator">:=</span> <span class="token keyword">range</span> plugins <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Just continue if there are no devices to serve for plugin p.</span>
        <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">Devices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Start the gRPC server for plugin p and connect it with the kubelet.</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> p<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            klog<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"Failed to start plugin: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
            <span class="token keyword">return</span> plugins<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span>
        <span class="token punctuation">}</span>
        started<span class="token operator">++</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在startPlugins函数中，有以下几个逻辑本文会深入解读下：
    </p>
    <h4>
     <a id="221_nvmllib_139">
     </a>
     2.2.1 初始化nvmllib对象
    </h4>
    <pre><code class="prism language-go">    driverRoot <span class="token operator">:=</span> <span class="token function">root</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>Plugin<span class="token punctuation">.</span>ContainerDriverRoot<span class="token punctuation">)</span>
    <span class="token comment">// We construct an NVML library specifying the path to libnvidia-ml.so.1</span>
    <span class="token comment">// explicitly so that we don't have to rely on the library path.</span>
    nvmllib <span class="token operator">:=</span> nvml<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>
        nvml<span class="token punctuation">.</span><span class="token function">WithLibraryPath</span><span class="token punctuation">(</span>driverRoot<span class="token punctuation">.</span><span class="token function">tryResolveLibrary</span><span class="token punctuation">(</span><span class="token string">"libnvidia-ml.so.1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
</code></pre>
    <p>
     调用nvml.New方法基于动态库
     <code>
      libnvidia-ml.so.1
     </code>
     初始化好一个nvmllib对象，nvml是NVIDIA Management Library的简写，nvmllib对象显然就是对接nvml库的一个对象，而查找libnvidia-ml.so.1动态库则会按顺序在（默认）/driver-root子目录/usr/lib64、/usr/lib/x86_64-linux-gnu、/usr/lib/aarch64-linux-gnu、/lib64、/lib/x86_64-linux-gnu、/lib/aarch64-linux-gnu目录下查找，知道找到第一个符合条件的库文件。
    </p>
    <pre><code class="prism language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>r root<span class="token punctuation">)</span> <span class="token function">tryResolveLibrary</span><span class="token punctuation">(</span>libraryName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> r <span class="token operator">==</span> <span class="token string">""</span> <span class="token operator">||</span> r <span class="token operator">==</span> <span class="token string">"/"</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> libraryName
    <span class="token punctuation">}</span>

    librarySearchPaths <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"/usr/lib64"</span><span class="token punctuation">,</span>
        <span class="token string">"/usr/lib/x86_64-linux-gnu"</span><span class="token punctuation">,</span>
        <span class="token string">"/usr/lib/aarch64-linux-gnu"</span><span class="token punctuation">,</span>
        <span class="token string">"/lib64"</span><span class="token punctuation">,</span>
        <span class="token string">"/lib/x86_64-linux-gnu"</span><span class="token punctuation">,</span>
        <span class="token string">"/lib/aarch64-linux-gnu"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> d <span class="token operator">:=</span> <span class="token keyword">range</span> librarySearchPaths <span class="token punctuation">{<!-- --></span>
        l <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> libraryName<span class="token punctuation">)</span>
        resolved<span class="token punctuation">,</span> err <span class="token operator">:=</span> <span class="token function">resolveLink</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> resolved
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> libraryName
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="222_devicelib_177">
     </a>
     2.2.2 初始化devicelib对象
    </h4>
    <p>
     调用device.New方法基于nvmllib初始化一个用于设备管理的对象，初始化时WithSkippedDevices初始化好后续会跳过的设备"DGX Display"、“NVIDIA DGX Display”。
    </p>
    <pre><code class="prism language-go"><span class="token comment">// New creates a new instance of the 'device' interface.</span>
<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>nvmllib nvml<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> opts <span class="token operator">...</span>Option<span class="token punctuation">)</span> Interface <span class="token punctuation">{<!-- --></span>
    d <span class="token operator">:=</span> <span class="token operator">&amp;</span>devicelib<span class="token punctuation">{<!-- --></span>
        nvmllib<span class="token punctuation">:</span> nvmllib<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{<!-- --></span>
        <span class="token function">opt</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> d<span class="token punctuation">.</span>verifySymbols <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        verify <span class="token operator">:=</span> <span class="token boolean">true</span>
        d<span class="token punctuation">.</span>verifySymbols <span class="token operator">=</span> <span class="token operator">&amp;</span>verify
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> d<span class="token punctuation">.</span>skippedDevices <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">WithSkippedDevices</span><span class="token punctuation">(</span>
            <span class="token string">"DGX Display"</span><span class="token punctuation">,</span>
            <span class="token string">"NVIDIA DGX Display"</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> d
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="223_infolib_203">
     </a>
     2.2.3 初始化infolib对象
    </h4>
    <p>
     调用nvinfo.New方法基于nvmllib和devicelib初始化一个nvidia设备汇总信息的对象：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// New creates a new instance of the 'info' interface.</span>
<span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span>opts <span class="token operator">...</span>Option<span class="token punctuation">)</span> Interface <span class="token punctuation">{<!-- --></span>
    o <span class="token operator">:=</span> <span class="token operator">&amp;</span>options<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> opt <span class="token operator">:=</span> <span class="token keyword">range</span> opts <span class="token punctuation">{<!-- --></span>
        <span class="token function">opt</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> o<span class="token punctuation">.</span>logger <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        o<span class="token punctuation">.</span>logger <span class="token operator">=</span> <span class="token operator">&amp;</span>nullLogger<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> o<span class="token punctuation">.</span>root <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
        o<span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token string">"/"</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> o<span class="token punctuation">.</span>nvmllib <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        o<span class="token punctuation">.</span>nvmllib <span class="token operator">=</span> nvml<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>
            nvml<span class="token punctuation">.</span><span class="token function">WithLibraryPath</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>root<span class="token punctuation">.</span><span class="token function">tryResolveLibrary</span><span class="token punctuation">(</span><span class="token string">"libnvidia-ml.so.1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> o<span class="token punctuation">.</span>devicelib <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        o<span class="token punctuation">.</span>devicelib <span class="token operator">=</span> device<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>nvmllib<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> o<span class="token punctuation">.</span>platform <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
        o<span class="token punctuation">.</span>platform <span class="token operator">=</span> PlatformAuto
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> o<span class="token punctuation">.</span>propertyExtractor <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        o<span class="token punctuation">.</span>propertyExtractor <span class="token operator">=</span> <span class="token operator">&amp;</span>propertyExtractor<span class="token punctuation">{<!-- --></span>
            root<span class="token punctuation">:</span>      o<span class="token punctuation">.</span>root<span class="token punctuation">,</span>
            nvmllib<span class="token punctuation">:</span>   o<span class="token punctuation">.</span>nvmllib<span class="token punctuation">,</span>
            devicelib<span class="token punctuation">:</span> o<span class="token punctuation">.</span>devicelib<span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token operator">&amp;</span>infolib<span class="token punctuation">{<!-- --></span>
        PlatformResolver<span class="token punctuation">:</span> <span class="token operator">&amp;</span>platformResolver<span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">:</span>            o<span class="token punctuation">.</span>logger<span class="token punctuation">,</span>
            platform<span class="token punctuation">:</span>          o<span class="token punctuation">.</span>platform<span class="token punctuation">,</span>
            propertyExtractor<span class="token punctuation">:</span> o<span class="token punctuation">.</span>propertyExtractor<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        PropertyExtractor<span class="token punctuation">:</span> o<span class="token punctuation">.</span>propertyExtractor<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="224_pluginManagerplugin_248">
     </a>
     2.2.4 初始化pluginManager对象并获取plugin列表
    </h4>
    <p>
     先调用NewPluginManager方法得到pluginManager设备管理对象，再调用该对象的GetPlugins方法获取插件列表。先思考这里的plugins指什么呢？这里的plugins其实指的是一组
     <code>
      具体管理某种特定类型GPU资源的插件实例
     </code>
     ，这些实例会根据GPU硬件配置和用户策略动态生成，每个插件负责一种特定资源类型的上报和分配。
    </p>
    <p>
     常见的GPU“类型”有：
    </p>
    <p>
     1）基础GPU设备：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// 节点有2块未启用MIG的T4 GPU</span>
plugins <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token operator">&amp;</span>NvidiaDevicePlugin<span class="token punctuation">{<!-- --></span>
    resourceName<span class="token punctuation">:</span> <span class="token string">"nvidia.com/gpu"</span><span class="token punctuation">,</span> 
    devices<span class="token punctuation">:</span> <span class="token punctuation">[</span>GPU0<span class="token punctuation">,</span> GPU1<span class="token punctuation">]</span> <span class="token comment">// 管理所有基础GPU设备</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre>
    <p>
     资源类型：nvidia.com/gpu
    </p>
    <p>
     调度表现：
    </p>
    <pre><code class="prism language-bash">$ kubectl describe <span class="token function">node</span>
Capacity:
  nvidia.com/gpu: <span class="token number">2</span>
</code></pre>
    <p>
     2）启用MIG的A100
    </p>
    <pre><code class="prism language-go"><span class="token comment">// A100 GPU被切分为4个1g.10gb实例</span>
plugins <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token operator">&amp;</span>NvidiaDevicePlugin<span class="token punctuation">{<!-- --></span>
    resourceName<span class="token punctuation">:</span> <span class="token string">"nvidia.com/mig-1g.10gb"</span><span class="token punctuation">,</span>
    devices<span class="token punctuation">:</span> <span class="token punctuation">[</span>MIG0<span class="token punctuation">,</span> MIG1<span class="token punctuation">,</span> MIG2<span class="token punctuation">,</span> MIG3<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre>
    <p>
     资源类型：nvidia.com/mig-1g.10gb
    </p>
    <p>
     调度表现：
    </p>
    <pre><code class="prism language-bash">$ kubectl describe <span class="token function">node</span>
Capacity:
  nvidia.com/mig-1g.10gb: <span class="token number">4</span>
</code></pre>
    <p>
     3）时间切片配置
    </p>
    <pre><code class="prism language-yaml"><span class="token comment"># values.yaml配置</span>
<span class="token key atrule">timeSlicing</span><span class="token punctuation">:</span>
  <span class="token key atrule">resources</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nvidia.com/gpu
    <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">4</span>
</code></pre>
    <pre><code class="prism language-go"><span class="token comment">// 生成虚拟设备</span>
plugins <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token operator">&amp;</span>NvidiaDevicePlugin<span class="token punctuation">{<!-- --></span>
    resourceName<span class="token punctuation">:</span> <span class="token string">"nvidia.com/gpu"</span><span class="token punctuation">,</span>
    devices<span class="token punctuation">:</span> <span class="token punctuation">[</span>GPU0<span class="token operator">-</span><span class="token number">0</span><span class="token punctuation">,</span> GPU0<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> GPU0<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> GPU0<span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token comment">// 单卡虚拟为4个设备</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre>
    <p>
     资源类型：nvidia.com/gpu（虚拟化后）
    </p>
    <p>
     调度表现：
    </p>
    <pre><code class="prism language-bash">$ kubectl describe <span class="token function">node</span>
Capacity:
  nvidia.com/gpu: <span class="token number">4</span> <span class="token comment"># 物理卡数*replicas</span>
</code></pre>
    <p>
     当一台机器上同时存在基础GPU和MIG设备时：
    </p>
    <pre><code class="prism language-go">plugins <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token operator">&amp;</span>NvidiaDevicePlugin<span class="token punctuation">{<!-- --></span> <span class="token comment">// 管理非MIG设备</span>
    resourceName<span class="token punctuation">:</span> <span class="token string">"nvidia.com/gpu"</span><span class="token punctuation">,</span>
    devices<span class="token punctuation">:</span> <span class="token punctuation">[</span>GPU0<span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token operator">&amp;</span>NvidiaDevicePlugin<span class="token punctuation">{<!-- --></span> <span class="token comment">// 管理MIG切片</span>
    resourceName<span class="token punctuation">:</span> <span class="token string">"nvidia.com/mig-2g.20gb"</span><span class="token punctuation">,</span>
    devices<span class="token punctuation">:</span> <span class="token punctuation">[</span>MIG0<span class="token punctuation">,</span> MIG1<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre>
    <p>
     此时k8s-device-plugin将同时上报两种资源：
    </p>
    <pre><code class="prism language-bash">$ kubectl describe <span class="token function">node</span>
Capacity:
  nvidia.com/gpu: <span class="token number">1</span>
  nvidia.com/mig-2g.20gb: <span class="token number">2</span>
</code></pre>
    <p>
     k8s-device-plugin这么设计的意义：
    </p>
    <p>
     1）架构灵活性：支持混合部署不同GPU类型
    </p>
    <p>
     2）资源隔离性：不同插件管理独立资源池
    </p>
    <p>
     3）策略扩展性：新增策略只需实现新的Plugin生成逻辑
    </p>
    <p>
     通过这种设计，k8s-device-plugin可以同时支持裸金属GPU、MIG切片、时间切片等多种资源管理模式，而无需修改核心分配逻辑。
    </p>
    <p>
     再来看看NewPluginManager和pluginManager.GetPlugins的实现。先是NewPluginManager：判断MigStrategy，有三种选项：none、single、mixed。之后用cdi.New方法初始化一个cdiHandler，这里的cdi是Container Device Interface的简写，CDI也是社区设备管理的一个方向。
    </p>
    <pre><code class="prism language-go"><span class="token comment">// NewPluginManager creates an NVML-based plugin manager</span>
<span class="token keyword">func</span> <span class="token function">NewPluginManager</span><span class="token punctuation">(</span>infolib info<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> nvmllib nvml<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> devicelib device<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> config <span class="token operator">*</span>spec<span class="token punctuation">.</span>Config<span class="token punctuation">)</span> <span class="token punctuation">(</span>manager<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> err <span class="token builtin">error</span>
    <span class="token keyword">switch</span> <span class="token operator">*</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>MigStrategy <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> spec<span class="token punctuation">.</span>MigStrategyNone<span class="token punctuation">:</span>
    <span class="token keyword">case</span> spec<span class="token punctuation">.</span>MigStrategySingle<span class="token punctuation">:</span>
    <span class="token keyword">case</span> spec<span class="token punctuation">.</span>MigStrategyMixed<span class="token punctuation">:</span>
    <span class="token keyword">default</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unknown strategy: %v"</span><span class="token punctuation">,</span> <span class="token operator">*</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>MigStrategy<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// TODO: We could consider passing this as an argument since it should already be used to construct nvmllib.</span>
    driverRoot <span class="token operator">:=</span> <span class="token function">root</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>Plugin<span class="token punctuation">.</span>ContainerDriverRoot<span class="token punctuation">)</span>

    deviceListStrategies<span class="token punctuation">,</span> err <span class="token operator">:=</span> spec<span class="token punctuation">.</span><span class="token function">NewDeviceListStrategies</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>Plugin<span class="token punctuation">.</span>DeviceListStrategy<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid device list strategy: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    cdiHandler<span class="token punctuation">,</span> err <span class="token operator">:=</span> cdi<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>infolib<span class="token punctuation">,</span> nvmllib<span class="token punctuation">,</span> devicelib<span class="token punctuation">,</span>
        cdi<span class="token punctuation">.</span><span class="token function">WithDeviceListStrategies</span><span class="token punctuation">(</span>deviceListStrategies<span class="token punctuation">)</span><span class="token punctuation">,</span>
        cdi<span class="token punctuation">.</span><span class="token function">WithDriverRoot</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>driverRoot<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        cdi<span class="token punctuation">.</span><span class="token function">WithDevRoot</span><span class="token punctuation">(</span>driverRoot<span class="token punctuation">.</span><span class="token function">getDevRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        cdi<span class="token punctuation">.</span><span class="token function">WithTargetDriverRoot</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>NvidiaDriverRoot<span class="token punctuation">)</span><span class="token punctuation">,</span>
        cdi<span class="token punctuation">.</span><span class="token function">WithTargetDevRoot</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>NvidiaDevRoot<span class="token punctuation">)</span><span class="token punctuation">,</span>
        cdi<span class="token punctuation">.</span><span class="token function">WithNvidiaCTKPath</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>Plugin<span class="token punctuation">.</span>NvidiaCTKPath<span class="token punctuation">)</span><span class="token punctuation">,</span>
        cdi<span class="token punctuation">.</span><span class="token function">WithDeviceIDStrategy</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>Plugin<span class="token punctuation">.</span>DeviceIDStrategy<span class="token punctuation">)</span><span class="token punctuation">,</span>
        cdi<span class="token punctuation">.</span><span class="token function">WithVendor</span><span class="token punctuation">(</span><span class="token string">"k8s.device-plugin.nvidia.com"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        cdi<span class="token punctuation">.</span><span class="token function">WithGdsEnabled</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>GDSEnabled<span class="token punctuation">)</span><span class="token punctuation">,</span>
        cdi<span class="token punctuation">.</span><span class="token function">WithMofedEnabled</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>MOFEDEnabled<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unable to create cdi handler: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    m<span class="token punctuation">,</span> err <span class="token operator">:=</span> manager<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>infolib<span class="token punctuation">,</span> nvmllib<span class="token punctuation">,</span> devicelib<span class="token punctuation">,</span>
        manager<span class="token punctuation">.</span><span class="token function">WithCDIHandler</span><span class="token punctuation">(</span>cdiHandler<span class="token punctuation">)</span><span class="token punctuation">,</span>
        manager<span class="token punctuation">.</span><span class="token function">WithConfig</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">,</span>
        manager<span class="token punctuation">.</span><span class="token function">WithFailOnInitError</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>FailOnInitError<span class="token punctuation">)</span><span class="token punctuation">,</span>
        manager<span class="token punctuation">.</span><span class="token function">WithMigStrategy</span><span class="token punctuation">(</span><span class="token operator">*</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>MigStrategy<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unable to create plugin manager: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> err <span class="token operator">:=</span> m<span class="token punctuation">.</span><span class="token function">CreateCDISpecFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"unable to create cdi spec file: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> m<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     pluginManager.GetPlugins则是借助nvml对象获取机器上的设备信息：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// GetPlugins returns the plugins associated with the NVML resources available on the node</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>nvmlmanager<span class="token punctuation">)</span> <span class="token function">GetPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>plugin<span class="token punctuation">.</span>Interface<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    rms<span class="token punctuation">,</span> err <span class="token operator">:=</span> rm<span class="token punctuation">.</span><span class="token function">NewNVMLResourceManagers</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>infolib<span class="token punctuation">,</span> m<span class="token punctuation">.</span>nvmllib<span class="token punctuation">,</span> m<span class="token punctuation">.</span>devicelib<span class="token punctuation">,</span> m<span class="token punctuation">.</span>config<span class="token punctuation">)</span>
    <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to construct NVML resource managers: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> plugins <span class="token punctuation">[</span><span class="token punctuation">]</span>plugin<span class="token punctuation">.</span>Interface
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> r <span class="token operator">:=</span> <span class="token keyword">range</span> rms <span class="token punctuation">{<!-- --></span>
        plugin<span class="token punctuation">,</span> err <span class="token operator">:=</span> plugin<span class="token punctuation">.</span><span class="token function">NewNvidiaDevicePlugin</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>config<span class="token punctuation">,</span> r<span class="token punctuation">,</span> m<span class="token punctuation">.</span>cdiHandler<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to create plugin: %w"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        plugins <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>plugins<span class="token punctuation">,</span> plugin<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> plugins<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="23_pluginStart_430">
     </a>
     2.3 plugin.Start
    </h3>
    <pre><code class="prism language-go"><span class="token comment">// k8s-device-plugin/internal/plugin/server.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>plugin <span class="token operator">*</span>NvidiaDevicePlugin<span class="token punctuation">)</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token operator">...</span>
    <span class="token comment">// 启动gRPC服务</span>
    err <span class="token operator">:=</span> plugin<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
    <span class="token comment">// 向kubelet注册插件</span>
    err <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token operator">...</span>
    <span class="token comment">// 启动一个协程对设备</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// TODO: add MPS health check</span>
        err <span class="token operator">:=</span> plugin<span class="token punctuation">.</span>rm<span class="token punctuation">.</span><span class="token function">CheckHealth</span><span class="token punctuation">(</span>plugin<span class="token punctuation">.</span>stop<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span>health<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            klog<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"Failed to start health check: %v; continuing with health checks disabled"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    
    <span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在plugin.Start函数中主要做了三件事：
    </p>
    <p>
     1）plugin.Serve启动一个gRPC服务，该服务实现如下方法
    </p>
    <pre><code class="prism language-protobuf">// DevicePlugin is the service advertised by Device Plugins
service DevicePlugin {
    // GetDevicePluginOptions returns options to be communicated with Device
    // Manager
    rpc GetDevicePluginOptions(Empty) returns (DevicePluginOptions) {}

    // ListAndWatch returns a stream of List of Devices
    // Whenever a Device state change or a Device disappears, ListAndWatch
    // returns the new list
    rpc ListAndWatch(Empty) returns (stream ListAndWatchResponse) {}

    // GetPreferredAllocation returns a preferred set of devices to allocate
    // from a list of available ones. The resulting preferred allocation is not
    // guaranteed to be the allocation ultimately performed by the
    // devicemanager. It is only designed to help the devicemanager make a more
    // informed allocation decision when possible.
    rpc GetPreferredAllocation(PreferredAllocationRequest) returns (PreferredAllocationResponse) {}

    // Allocate is called during container creation so that the Device
    // Plugin can run device specific operations and instruct Kubelet
    // of the steps to make the Device available in the container
    rpc Allocate(AllocateRequest) returns (AllocateResponse) {}

    // PreStartContainer is called, if indicated by Device Plugin during registeration phase,
    // before each container start. Device plugin can run device specific operations
    // such as resetting the device before making devices available to the container
    rpc PreStartContainer(PreStartContainerRequest) returns (PreStartContainerResponse) {}
}
</code></pre>
    <p>
     2）plugin.Register向kubelet注册自己
    </p>
    <p>
     3）plugin.rm.CheckHealth启动一个协程对相关设备做健康检查
    </p>
    <h3>
     <a id="24_pluginrmCheckHealth_492">
     </a>
     2.4 plugin.rm.CheckHealth
    </h3>
    <p>
     当前版本实现了nvml和tegra（always ok）的健康检查，以nvml为例，CheckHealth的实现方式如下，其实就是一个for循环调用nvml对设备进行检查：
    </p>
    <pre><code>// k8s-device-plugin/internal/rm/nvml_manager.go
// CheckHealth performs health checks on a set of devices, writing to the 'unhealthy' channel with any unhealthy devices
func (r *nvmlResourceManager) CheckHealth(stop &lt;-chan interface{}, unhealthy chan&lt;- *Device) error {
    return r.checkHealth(stop, r.devices, unhealthy)
}

// k8s-device-plugin/internal/rm/health.go
func (r *nvmlResourceManager) checkHealth(stop &lt;-chan interface{}, devices Devices, unhealthy chan&lt;- *Device) error {
    ...
    eventSet, ret := r.nvml.EventSetCreate()
    ...
    for {
        select {
        case &lt;-stop:
            return nil
        default:
        }

        e, ret := eventSet.Wait(5000)
        if ret == nvml.ERROR_TIMEOUT {
            continue
        }
        if ret != nvml.SUCCESS {
            klog.Infof("Error waiting for event: %v; Marking all devices as unhealthy", ret)
            for _, d := range devices {
                unhealthy &lt;- d
            }
            continue
        }

        if e.EventType != nvml.EventTypeXidCriticalError {
            klog.Infof("Skipping non-nvmlEventTypeXidCriticalError event: %+v", e)
            continue
        }

        if skippedXids[e.EventData] {
            klog.Infof("Skipping event %+v", e)
            continue
        }

        klog.Infof("Processing event %+v", e)
        eventUUID, ret := e.Device.GetUUID()
        if ret != nvml.SUCCESS {
            // If we cannot reliably determine the device UUID, we mark all devices as unhealthy.
            klog.Infof("Failed to determine uuid for event %v: %v; Marking all devices as unhealthy.", e, ret)
            for _, d := range devices {
                unhealthy &lt;- d
            }
            continue
        }

        d, exists := parentToDeviceMap[eventUUID]
        if !exists {
            klog.Infof("Ignoring event for unexpected device: %v", eventUUID)
            continue
        }

        if d.IsMigDevice() &amp;&amp; e.GpuInstanceId != 0xFFFFFFFF &amp;&amp; e.ComputeInstanceId != 0xFFFFFFFF {
            gi := deviceIDToGiMap[d.ID]
            ci := deviceIDToCiMap[d.ID]
            if !(uint32(gi) == e.GpuInstanceId &amp;&amp; uint32(ci) == e.ComputeInstanceId) {
                continue
            }
            klog.Infof("Event for mig device %v (gi=%v, ci=%v)", d.ID, gi, ci)
        }

        klog.Infof("XidCriticalError: Xid=%d on Device=%s; marking device as unhealthy.", e.EventData, d.ID)
        unhealthy &lt;- d
    }
}
</code></pre>
    <h3>
     <a id="25_ListAndWatch_568">
     </a>
     2.5 ListAndWatch
    </h3>
    <p>
     ListAndWatch负责向kubelet上报设备健康状态的方法，实现逻辑如下，逻辑比较简单：先调用s.Send通过gRPC长连接向kubelet上报当前插件类型所有设备信息，之后监听plugin.health，而plugin.health来源于前文的健康检查。当从plugin.health收到有设备异常的消息后，会立刻调用s.Send向kubelet上报该信息。
    </p>
    <pre><code class="prism language-go"><span class="token comment">// k8s-device-plugin/internal/plugin/server.go</span>
<span class="token comment">// ListAndWatch lists devices and update that list according to the health status</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>plugin <span class="token operator">*</span>NvidiaDevicePlugin<span class="token punctuation">)</span> <span class="token function">ListAndWatch</span><span class="token punctuation">(</span>e <span class="token operator">*</span>pluginapi<span class="token punctuation">.</span>Empty<span class="token punctuation">,</span> s pluginapi<span class="token punctuation">.</span>DevicePlugin_ListAndWatchServer<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pluginapi<span class="token punctuation">.</span>ListAndWatchResponse<span class="token punctuation">{<!-- --></span>Devices<span class="token punctuation">:</span> plugin<span class="token punctuation">.</span><span class="token function">apiDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> err
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token operator">&lt;-</span>plugin<span class="token punctuation">.</span>stop<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span>
        <span class="token keyword">case</span> d <span class="token operator">:=</span> <span class="token operator">&lt;-</span>plugin<span class="token punctuation">.</span>health<span class="token punctuation">:</span>
            <span class="token comment">// FIXME: there is no way to recover from the Unhealthy state.</span>
            d<span class="token punctuation">.</span>Health <span class="token operator">=</span> pluginapi<span class="token punctuation">.</span>Unhealthy
            klog<span class="token punctuation">.</span><span class="token function">Infof</span><span class="token punctuation">(</span><span class="token string">"'%s' device marked unhealthy: %s"</span><span class="token punctuation">,</span> plugin<span class="token punctuation">.</span>rm<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span>ID<span class="token punctuation">)</span>
            <span class="token keyword">if</span> err <span class="token operator">:=</span> s<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pluginapi<span class="token punctuation">.</span>ListAndWatchResponse<span class="token punctuation">{<!-- --></span>Devices<span class="token punctuation">:</span> plugin<span class="token punctuation">.</span><span class="token function">apiDevices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">nil</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="26_Allocate_595">
     </a>
     2.6 Allocate
    </h3>
    <p>
     Allocate作为kubelet创建pod容器时分配设备资源调用的方法，实现逻辑如下：
    </p>
    <pre><code class="prism language-go"><span class="token comment">// k8s-device-plugin/internal/plugin/server.go</span>
<span class="token comment">// Allocate which return list of devices.</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>plugin <span class="token operator">*</span>NvidiaDevicePlugin<span class="token punctuation">)</span> <span class="token function">Allocate</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> reqs <span class="token operator">*</span>pluginapi<span class="token punctuation">.</span>AllocateRequest<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pluginapi<span class="token punctuation">.</span>AllocateResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    responses <span class="token operator">:=</span> pluginapi<span class="token punctuation">.</span>AllocateResponse<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> req <span class="token operator">:=</span> <span class="token keyword">range</span> reqs<span class="token punctuation">.</span>ContainerRequests <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> plugin<span class="token punctuation">.</span>rm<span class="token punctuation">.</span><span class="token function">ValidateRequest</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>DevicesIDs<span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"invalid allocation request for %q: %w"</span><span class="token punctuation">,</span> plugin<span class="token punctuation">.</span>rm<span class="token punctuation">.</span><span class="token function">Resource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        response<span class="token punctuation">,</span> err <span class="token operator">:=</span> plugin<span class="token punctuation">.</span><span class="token function">getAllocateResponse</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>DevicesIDs<span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to get allocate response: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        responses<span class="token punctuation">.</span>ContainerResponses <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>responses<span class="token punctuation">.</span>ContainerResponses<span class="token punctuation">,</span> response<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">&amp;</span>responses<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// k8s-device-plugin/internal/plugin/server.go</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>plugin <span class="token operator">*</span>NvidiaDevicePlugin<span class="token punctuation">)</span> <span class="token function">getAllocateResponse</span><span class="token punctuation">(</span>requestIds <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pluginapi<span class="token punctuation">.</span>ContainerAllocateResponse<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    deviceIDs <span class="token operator">:=</span> plugin<span class="token punctuation">.</span><span class="token function">deviceIDsFromAnnotatedDeviceIDs</span><span class="token punctuation">(</span>requestIds<span class="token punctuation">)</span>

    <span class="token comment">// Create an empty response that will be updated as required below.</span>
    response <span class="token operator">:=</span> <span class="token operator">&amp;</span>pluginapi<span class="token punctuation">.</span>ContainerAllocateResponse<span class="token punctuation">{<!-- --></span>
        Envs<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> plugin<span class="token punctuation">.</span>deviceListStrategies<span class="token punctuation">.</span><span class="token function">AnyCDIEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        responseID <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> err <span class="token operator">:=</span> plugin<span class="token punctuation">.</span><span class="token function">updateResponseForCDI</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> responseID<span class="token punctuation">,</span> deviceIDs<span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> fmt<span class="token punctuation">.</span><span class="token function">Errorf</span><span class="token punctuation">(</span><span class="token string">"failed to get allocate response for CDI: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> plugin<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Sharing<span class="token punctuation">.</span><span class="token function">SharingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> spec<span class="token punctuation">.</span>SharingStrategyMPS <span class="token punctuation">{<!-- --></span>
        plugin<span class="token punctuation">.</span><span class="token function">updateResponseForMPS</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// The following modifications are only made if at least one non-CDI device</span>
    <span class="token comment">// list strategy is selected.</span>
    <span class="token keyword">if</span> plugin<span class="token punctuation">.</span>deviceListStrategies<span class="token punctuation">.</span><span class="token function">AllCDIEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> response<span class="token punctuation">,</span> <span class="token boolean">nil</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> plugin<span class="token punctuation">.</span>deviceListStrategies<span class="token punctuation">.</span><span class="token function">Includes</span><span class="token punctuation">(</span>spec<span class="token punctuation">.</span>DeviceListStrategyEnvvar<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        plugin<span class="token punctuation">.</span><span class="token function">updateResponseForDeviceListEnvvar</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> deviceIDs<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> plugin<span class="token punctuation">.</span>deviceListStrategies<span class="token punctuation">.</span><span class="token function">Includes</span><span class="token punctuation">(</span>spec<span class="token punctuation">.</span>DeviceListStrategyVolumeMounts<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        plugin<span class="token punctuation">.</span><span class="token function">updateResponseForDeviceMounts</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> deviceIDs<span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">*</span>plugin<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>Plugin<span class="token punctuation">.</span>PassDeviceSpecs <span class="token punctuation">{<!-- --></span>
        response<span class="token punctuation">.</span>Devices <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>Devices<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span><span class="token function">apiDeviceSpecs</span><span class="token punctuation">(</span><span class="token operator">*</span>plugin<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>NvidiaDevRoot<span class="token punctuation">,</span> requestIds<span class="token punctuation">)</span><span class="token operator">...</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">*</span>plugin<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>GDSEnabled <span class="token punctuation">{<!-- --></span>
        response<span class="token punctuation">.</span>Envs<span class="token punctuation">[</span><span class="token string">"NVIDIA_GDS"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"enabled"</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token operator">*</span>plugin<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>MOFEDEnabled <span class="token punctuation">{<!-- --></span>
        response<span class="token punctuation">.</span>Envs<span class="token punctuation">[</span><span class="token string">"NVIDIA_MOFED"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"enabled"</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> response<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     getAllocateResponse是nvidia k8s-device-plugin的核心函数，它负责根据Pod的GPU资源请求生成容器级别的设备分配响应。其核心作用是将GPU设备的物理资源映射到容器的运行时环境中，确保容器能正确访问分配的GPU。代码逐段解析：
    </p>
    <p>
     1）设备 ID 转换
    </p>
    <pre><code class="prism language-go">deviceIDs <span class="token operator">:=</span> plugin<span class="token punctuation">.</span><span class="token function">deviceIDsFromAnnotatedDeviceIDs</span><span class="token punctuation">(</span>requestIds<span class="token punctuation">)</span>
</code></pre>
    <p>
     作用：将Kubernetes传递的抽象设备请求ID（如GPU-fef8089b）转换为实际的物理设备ID（如0表示第0号GPU）
    </p>
    <p>
     输入：requestIds来自Kubelet的AllocateRequest
    </p>
    <p>
     输出：物理设备ID列表（例如 [“0”, “1”]）
    </p>
    <p>
     2）响应体初始化
    </p>
    <pre><code class="prism language-go">response <span class="token operator">:=</span> <span class="token operator">&amp;</span>pluginapi<span class="token punctuation">.</span>ContainerAllocateResponse<span class="token punctuation">{<!-- --></span>
    Envs<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     作用：创建空的响应对象，后续逐步填充环境变量、设备挂载等信息
    </p>
    <p>
     3）CDI（Container Device Interface）处理
    </p>
    <pre><code class="prism language-go"><span class="token keyword">if</span> plugin<span class="token punctuation">.</span>deviceListStrategies<span class="token punctuation">.</span><span class="token function">AnyCDIEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    responseID <span class="token operator">:=</span> uuid<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    plugin<span class="token punctuation">.</span><span class="token function">updateResponseForCDI</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> responseID<span class="token punctuation">,</span> deviceIDs<span class="token operator">...</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     CDI是什么：新一代容器设备接口标准，替代传统的环境变量/Volume挂载方式
    </p>
    <p>
     关键行为：生成唯一响应ID（用于审计追踪）；将设备信息按CDI规范注入响应（生成
     <code>
      cdi.k8s.io/&lt;device&gt;=&lt;cdi-device-name&gt;
     </code>
     注解）；
    </p>
    <p>
     4）MPS（Multi-Process Service）支持
    </p>
    <pre><code class="prism language-go"><span class="token keyword">if</span> plugin<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Sharing<span class="token punctuation">.</span><span class="token function">SharingStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> spec<span class="token punctuation">.</span>SharingStrategyMPS <span class="token punctuation">{<!-- --></span>
    plugin<span class="token punctuation">.</span><span class="token function">updateResponseForMPS</span><span class="token punctuation">(</span>response<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     MPS作用：允许多个进程共享同一GPU的算力
    </p>
    <p>
     注入内容：设置NVIDIA_MPS_ENABLED=1；挂载MPS控制目录（如/var/run/nvidia/mps）
    </p>
    <p>
     5）传统设备列表策略处理
    </p>
    <pre><code class="prism language-go"><span class="token comment">// 环境变量模式（默认启用）</span>
<span class="token keyword">if</span> plugin<span class="token punctuation">.</span>deviceListStrategies<span class="token punctuation">.</span><span class="token function">Includes</span><span class="token punctuation">(</span>spec<span class="token punctuation">.</span>DeviceListStrategyEnvvar<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    response<span class="token punctuation">.</span>Envs<span class="token punctuation">[</span><span class="token string">"NVIDIA_VISIBLE_DEVICES"</span><span class="token punctuation">]</span> <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span>deviceIDs<span class="token punctuation">,</span> <span class="token string">","</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// Volume 挂载模式（已废弃）</span>
<span class="token keyword">if</span> plugin<span class="token punctuation">.</span>deviceListStrategies<span class="token punctuation">.</span><span class="token function">Includes</span><span class="token punctuation">(</span>spec<span class="token punctuation">.</span>DeviceListStrategyVolumeMounts<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    response<span class="token punctuation">.</span>Mounts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>Mounts<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pluginapi<span class="token punctuation">.</span>Mount<span class="token punctuation">{<!-- --></span>
        ContainerPath<span class="token punctuation">:</span> <span class="token string">"/var/run/nvidia-container-devices"</span><span class="token punctuation">,</span>
        HostPath<span class="token punctuation">:</span>      plugin<span class="token punctuation">.</span><span class="token function">deviceListAsVolumeMounts</span><span class="token punctuation">(</span>deviceIDs<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     环境变量模式：设置NVIDIA_VISIBLE_DEVICES=0,1，由nvidia-container-runtime根据该变量挂载设备
    </p>
    <p>
     Volume挂载模式：旧版本兼容方式，通过文件传递设备列表（现已被CDI取代）
    </p>
    <p>
     6）设备规格透传
    </p>
    <pre><code class="prism language-go"><span class="token keyword">if</span> <span class="token operator">*</span>plugin<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>Plugin<span class="token punctuation">.</span>PassDeviceSpecs <span class="token punctuation">{<!-- --></span>
    response<span class="token punctuation">.</span>Devices <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>Devices<span class="token punctuation">,</span> plugin<span class="token punctuation">.</span><span class="token function">apiDeviceSpecs</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     作用：将GPU设备文件（如/dev/nvidia0）直接暴露给容器
    </p>
    <p>
     典型场景：需要直接访问GPU设备文件的特殊应用
    </p>
    <p>
     7）高级功能标记
    </p>
    <pre><code class="prism language-go"><span class="token comment">// GPU 直接存储（GDS）</span>
<span class="token keyword">if</span> <span class="token operator">*</span>plugin<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>GDSEnabled <span class="token punctuation">{<!-- --></span>
    response<span class="token punctuation">.</span>Envs<span class="token punctuation">[</span><span class="token string">"NVIDIA_GDS"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"enabled"</span>
<span class="token punctuation">}</span>

<span class="token comment">// Mellanox 网络加速（MOFED）</span>
<span class="token keyword">if</span> <span class="token operator">*</span>plugin<span class="token punctuation">.</span>config<span class="token punctuation">.</span>Flags<span class="token punctuation">.</span>MOFEDEnabled <span class="token punctuation">{<!-- --></span>
    response<span class="token punctuation">.</span>Envs<span class="token punctuation">[</span><span class="token string">"NVIDIA_MOFED"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"enabled"</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     GDS：启用GPU直接访问存储的能力（需硬件支持）
    </p>
    <p>
     MOFED：集成Mellanox网络加速库（用于RDMA场景）
    </p>
    <p>
     总结起来该函数实现了GPU资源的多维度适配：
    </p>
    <ul>
     <li>
      兼容性：同时支持CDI 新标准和传统环境变量模式
     </li>
     <li>
      灵活性：通过策略开关支持不同共享策略（MPS/Time-Slicing）
     </li>
     <li>
      扩展性：可扩展注入GDS/MOFED等高级功能
     </li>
     <li>
      安全性：通过设备ID转换实现物理资源到逻辑资源的映射隔离
     </li>
    </ul>
    <h2>
     <a id="_757">
     </a>
     三、部署实践
    </h2>
    <h3>
     <a id="31__759">
     </a>
     3.1 环境配置
    </h3>
    <p>
     在安装部署前先介绍下我本地环境：
    </p>
    <ul>
     <li>
      运行环境
     </li>
    </ul>
    <p>
     windows WSL ubuntu22.04
    </p>
    <pre><code class="prism language-bash">$ <span class="token function">uname</span> <span class="token parameter variable">-a</span>
Linux DESKTOP-72RD6OV <span class="token number">5.15</span>.167.4-microsoft-standard-WSL2 <span class="token comment">#1 SMP Tue Nov 5 00:21:55 UTC 2024 x86_64 x86_64 x86_64 GNU/Linux</span>
</code></pre>
    <ul>
     <li>
      k8s信息
     </li>
    </ul>
    <pre><code class="prism language-bash">$ kubectl version
Client Version: version.Info<span class="token punctuation">{<!-- --></span>Major:<span class="token string">"1"</span>, Minor:<span class="token string">"22"</span>, GitVersion:<span class="token string">"v1.22.7"</span>, GitCommit:<span class="token string">"b56e432f2191419647a6a13b9f5867801850f969"</span>, GitTreeState:<span class="token string">"clean"</span>, BuildDate:<span class="token string">"2022-02-16T11:50:27Z"</span>, GoVersion:<span class="token string">"go1.16.14"</span>, Compiler:<span class="token string">"gc"</span>, Platform:<span class="token string">"linux/amd64"</span><span class="token punctuation">}</span>
Server Version: version.Info<span class="token punctuation">{<!-- --></span>Major:<span class="token string">"1"</span>, Minor:<span class="token string">"22"</span>, GitVersion:<span class="token string">"v1.22.7"</span>, GitCommit:<span class="token string">"b56e432f2191419647a6a13b9f5867801850f969"</span>, GitTreeState:<span class="token string">"clean"</span>, BuildDate:<span class="token string">"2022-02-16T11:43:55Z"</span>, GoVersion:<span class="token string">"go1.16.14"</span>, Compiler:<span class="token string">"gc"</span>, Platform:<span class="token string">"linux/amd64"</span><span class="token punctuation">}</span>

$ kubectl get <span class="token function">node</span>
NAME              STATUS   ROLES                  AGE    VERSION
desktop-72rd6ov   Ready    control-plane,master   333d   v1.22.7

$ kubectl get pod <span class="token parameter variable">-A</span>
NAMESPACE      NAME                                      READY   STATUS    RESTARTS        AGE
kube-flannel   kube-flannel-ds-bpxfq                     <span class="token number">1</span>/1     Running   <span class="token number">41</span> <span class="token punctuation">(</span>133m ago<span class="token punctuation">)</span>   333d
kube-system    coredns-7f6cbbb7b8-lqfrh                  <span class="token number">1</span>/1     Running   <span class="token number">39</span> <span class="token punctuation">(</span>132m ago<span class="token punctuation">)</span>   333d
kube-system    coredns-7f6cbbb7b8-n4snt                  <span class="token number">1</span>/1     Running   <span class="token number">39</span> <span class="token punctuation">(</span>132m ago<span class="token punctuation">)</span>   333d
kube-system    etcd-desktop-72rd6ov                      <span class="token number">1</span>/1     Running   <span class="token number">41</span> <span class="token punctuation">(</span>133m ago<span class="token punctuation">)</span>   333d
kube-system    kube-apiserver-desktop-72rd6ov            <span class="token number">1</span>/1     Running   <span class="token number">41</span> <span class="token punctuation">(</span>132m ago<span class="token punctuation">)</span>   333d
kube-system    kube-controller-manager-desktop-72rd6ov   <span class="token number">1</span>/1     Running   <span class="token number">40</span> <span class="token punctuation">(</span>133m ago<span class="token punctuation">)</span>   333d
kube-system    kube-proxy-rtjfm                          <span class="token number">1</span>/1     Running   <span class="token number">38</span> <span class="token punctuation">(</span>133m ago<span class="token punctuation">)</span>   333d
kube-system    kube-scheduler-desktop-72rd6ov            <span class="token number">1</span>/1     Running   <span class="token number">42</span> <span class="token punctuation">(</span>132m ago<span class="token punctuation">)</span>   333d
</code></pre>
    <ul>
     <li>
      容器运行时
     </li>
    </ul>
    <pre><code class="prism language-bash">$ kubectl describe <span class="token function">node</span> desktop-72rd6ov <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">'Container Runtime Version'</span>
  Container Runtime Version:  docker://26.0.0
</code></pre>
    <ul>
     <li>
      GPU设备与cuda
     </li>
    </ul>
    <p>
     GPU：NVIDIA GeForce RTX4060Ti，16G显存
    </p>
    <p>
     cuda：12.6
    </p>
    <pre><code class="prism language-bash">$ nvidia-smi
Sat Mar  <span class="token number">8</span> <span class="token number">10</span>:20:00 <span class="token number">2025</span>
+-----------------------------------------------------------------------------------------+
<span class="token operator">|</span> NVIDIA-SMI <span class="token number">560.35</span>.02              Driver Version: <span class="token number">560.94</span>         CUDA Version: <span class="token number">12.6</span>     <span class="token operator">|</span>
<span class="token operator">|</span>-----------------------------------------+------------------------+----------------------+
<span class="token operator">|</span> GPU  Name                 Persistence-M <span class="token operator">|</span> Bus-Id          Disp.A <span class="token operator">|</span> Volatile Uncorr. ECC <span class="token operator">|</span>
<span class="token operator">|</span> Fan  Temp   Perf          Pwr:Usage/Cap <span class="token operator">|</span>           Memory-Usage <span class="token operator">|</span> GPU-Util  Compute M. <span class="token operator">|</span>
<span class="token operator">|</span>                                         <span class="token operator">|</span>                        <span class="token operator">|</span>               MIG M. <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">+=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">+=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">0</span>  NVIDIA GeForce RTX <span class="token number">4060</span> Ti     On  <span class="token operator">|</span>   00000000:01:00.0  On <span class="token operator">|</span>                  N/A <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">0</span>%   32C    P8              8W /  165W <span class="token operator">|</span>     954MiB /  16380MiB <span class="token operator">|</span>      <span class="token number">9</span>%      Default <span class="token operator">|</span>
<span class="token operator">|</span>                                         <span class="token operator">|</span>                        <span class="token operator">|</span>                  N/A <span class="token operator">|</span>
+-----------------------------------------+------------------------+----------------------+

+-----------------------------------------------------------------------------------------+
<span class="token operator">|</span> Processes:                                                                              <span class="token operator">|</span>
<span class="token operator">|</span>  GPU   GI   CI        PID   Type   Process name                              GPU Memory <span class="token operator">|</span>
<span class="token operator">|</span>        ID   ID                                                               Usage      <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">0</span>   N/A  N/A        <span class="token number">33</span>      G   /Xwayland                                   N/A      <span class="token operator">|</span>
+-----------------------------------------------------------------------------------------+

$ nvcc <span class="token parameter variable">--version</span>
nvcc: NVIDIA <span class="token punctuation">(</span>R<span class="token punctuation">)</span> Cuda compiler driver
Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2005</span>-2024 NVIDIA Corporation
Built on Tue_Oct_29_23:50:19_PDT_2024
Cuda compilation tools, release <span class="token number">12.6</span>, V12.6.85
Build cuda_12.6.r12.6/compiler.35059454_0
</code></pre>
    <h3>
     <a id="32__835">
     </a>
     3.2 安装部署
    </h3>
    <h4>
     <a id="321_nvidiacontainertoolkit_837">
     </a>
     3.2.1 安装nvidia-container-toolkit
    </h4>
    <p>
     <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/index.html" rel="nofollow">
      nvidia-container-toolkit官网
     </a>
     ：https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/index.html
    </p>
    <p>
     <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html" rel="nofollow">
      官方安装流程
     </a>
     ：https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html
    </p>
    <p>
     国内可使用国内镜像源安装，也是本文的安装方法：
    </p>
    <ul>
     <li>
      下载中国科技大学（USTC）镜像gpgkey
     </li>
    </ul>
    <pre><code class="prism language-bash"><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> https://mirrors.ustc.edu.cn/libnvidia-container/gpgkey <span class="token operator">|</span> <span class="token function">sudo</span> gpg <span class="token parameter variable">--dearmor</span> <span class="token parameter variable">-o</span> /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg
</code></pre>
    <ul>
     <li>
      配置中国科技大学（USTC）镜像APT源
     </li>
    </ul>
    <pre><code class="prism language-bash"><span class="token function">curl</span> <span class="token parameter variable">-s</span> <span class="token parameter variable">-L</span> https://mirrors.ustc.edu.cn/libnvidia-container/stable/deb/nvidia-container-toolkit.list <span class="token operator">|</span> <span class="token punctuation">\</span>
  <span class="token function">sed</span> <span class="token string">'s#deb https://nvidia.github.io#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://mirrors.ustc.edu.cn#g'</span> <span class="token operator">|</span> <span class="token punctuation">\</span>
  <span class="token function">sudo</span> <span class="token function">tee</span> /etc/apt/sources.list.d/nvidia-container-toolkit.list
</code></pre>
    <ul>
     <li>
      更新APT包列表
     </li>
    </ul>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> update
</code></pre>
    <ul>
     <li>
      安装NVIDIA Container Toolkit
     </li>
    </ul>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> <span class="token parameter variable">-y</span> nvidia-container-toolkit
</code></pre>
    <ul>
     <li>
      验证安装
     </li>
    </ul>
    <pre><code class="prism language-bash">$ nvidia-container-cli <span class="token parameter variable">--version</span>
cli-version: <span class="token number">1.17</span>.4
lib-version: <span class="token number">1.17</span>.4
build date: <span class="token number">2025</span>-01-23T10:53+00:00
build revision: f23e5e55ea27b3680aef363436d4bcf7659e0bfc
build compiler: x86_64-linux-gnu-gcc-7 <span class="token number">7.5</span>.0
build platform: x86_64
build flags: <span class="token parameter variable">-D_GNU_SOURCE</span> <span class="token parameter variable">-D_FORTIFY_SOURCE</span><span class="token operator">=</span><span class="token number">2</span> <span class="token parameter variable">-DNDEBUG</span> <span class="token parameter variable">-std</span><span class="token operator">=</span>gnu11 <span class="token parameter variable">-O2</span> <span class="token parameter variable">-g</span> -fdata-sections -ffunction-sections -fplan9-extensions -fstack-protector -fno-strict-aliasing <span class="token parameter variable">-fvisibility</span><span class="token operator">=</span>hidden <span class="token parameter variable">-Wall</span> <span class="token parameter variable">-Wextra</span> -Wcast-align -Wpointer-arith -Wmissing-prototypes <span class="token parameter variable">-Wnonnull</span> -Wwrite-strings -Wlogical-op <span class="token parameter variable">-Wformat</span><span class="token operator">=</span><span class="token number">2</span> -Wmissing-format-attribute -Winit-self <span class="token parameter variable">-Wshadow</span> -Wstrict-prototypes -Wunreachable-code <span class="token parameter variable">-Wconversion</span> -Wsign-conversion -Wno-unknown-warning-option -Wno-format-extra-args -Wno-gnu-alignof-expression -Wl,-zrelro -Wl,-znow -Wl,-zdefs -Wl,--gc-sections

// 输入后按tab键
$ nvidia-
nvidia-cdi-hook                nvidia-container-cli           nvidia-container-runtime       nvidia-container-runtime-hook  nvidia-container-toolkit       nvidia-ctk                     nvidia-pcc.exe                 nvidia-smi                     nvidia-smi.exe

$ <span class="token function">whereis</span> nvidia-container-runtime
nvidia-container-runtime: /usr/bin/nvidia-container-runtime /etc/nvidia-container-runtime
</code></pre>
    <ul>
     <li>
      修改docker配置
     </li>
    </ul>
    <p>
     新版本执行以下命令配置/etc/docker/daemon.json使用nvidia的runtime：
    </p>
    <pre><code class="prism language-bash">$ <span class="token function">sudo</span> nvidia-ctk runtime configure <span class="token parameter variable">--runtime</span><span class="token operator">=</span>docker
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Loading config from /etc/docker/daemon.json
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> Wrote updated config to /etc/docker/daemon.json
INFO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> It is recommended that <span class="token function">docker</span> daemon be restarted.

$ <span class="token function">cat</span> /etc/docker/daemon.json
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"default-runtime"</span><span class="token builtin class-name">:</span> <span class="token string">"nvidia"</span>, <span class="token comment"># 注意一定要有这一行</span>
    <span class="token string">"registry-mirrors"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"https://hub-mirror.c.163.com"</span>,
        <span class="token string">"https://ustc-edu-cn.mirror.aliyuncs.com"</span>,
        <span class="token string">"https://ghcr.io"</span>,
        <span class="token string">"https://mirror.baidubce.com"</span>
    <span class="token punctuation">]</span>,
    <span class="token string">"runtimes"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span> <span class="token comment"># 注意一定要有这一个配置</span>
        <span class="token string">"nvidia"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"args"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
            <span class="token string">"path"</span><span class="token builtin class-name">:</span> <span class="token string">"nvidia-container-runtime"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      重启docker
     </li>
    </ul>
    <pre><code class="prism language-bash">$ <span class="token function">sudo</span> systemctl restart <span class="token function">docker</span>
$ <span class="token function">docker</span> info <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> runtime
 Runtimes: nvidia runc io.containerd.runc.v2
 Default Runtime: runc

$ <span class="token function">docker</span> info <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-i</span> runtime
 Runtimes: io.containerd.runc.v2 nvidia runc
 Default Runtime: nvidia
</code></pre>
    <ul>
     <li>
      验证
     </li>
    </ul>
    <pre><code class="prism language-bash">$ <span class="token function">docker</span> run <span class="token parameter variable">--rm</span> <span class="token parameter variable">--gpus</span> all nvcr.io/nvidia/cuda:12.2.0-runtime-ubuntu22.04 nvidia-smi

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
<span class="token operator">==</span> CUDA <span class="token operator">==</span>
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>

CUDA Version <span class="token number">12.2</span>.0

Container image Copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2016</span>-2023, NVIDIA CORPORATION <span class="token operator">&amp;</span> AFFILIATES. All rights reserved.

This container image and its contents are governed by the NVIDIA Deep Learning Container License.
By pulling and using the container, you accept the terms and conditions of this license:
https://developer.nvidia.com/ngc/nvidia-deep-learning-container-license

A copy of this license is made available <span class="token keyword">in</span> this container at /NGC-DL-CONTAINER-LICENSE <span class="token keyword">for</span> your convenience.

Sat Mar  <span class="token number">8</span> 06:26:38 <span class="token number">2025</span>
+-----------------------------------------------------------------------------------------+
<span class="token operator">|</span> NVIDIA-SMI <span class="token number">560.35</span>.02              Driver Version: <span class="token number">560.94</span>         CUDA Version: <span class="token number">12.6</span>     <span class="token operator">|</span>
<span class="token operator">|</span>-----------------------------------------+------------------------+----------------------+
<span class="token operator">|</span> GPU  Name                 Persistence-M <span class="token operator">|</span> Bus-Id          Disp.A <span class="token operator">|</span> Volatile Uncorr. ECC <span class="token operator">|</span>
<span class="token operator">|</span> Fan  Temp   Perf          Pwr:Usage/Cap <span class="token operator">|</span>           Memory-Usage <span class="token operator">|</span> GPU-Util  Compute M. <span class="token operator">|</span>
<span class="token operator">|</span>                                         <span class="token operator">|</span>                        <span class="token operator">|</span>               MIG M. <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">+=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">+=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">0</span>  NVIDIA GeForce RTX <span class="token number">4060</span> Ti     On  <span class="token operator">|</span>   00000000:01:00.0  On <span class="token operator">|</span>                  N/A <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">0</span>%   34C    P8              8W /  165W <span class="token operator">|</span>    1162MiB /  16380MiB <span class="token operator">|</span>      <span class="token number">0</span>%      Default <span class="token operator">|</span>
<span class="token operator">|</span>                                         <span class="token operator">|</span>                        <span class="token operator">|</span>                  N/A <span class="token operator">|</span>
+-----------------------------------------+------------------------+----------------------+

+-----------------------------------------------------------------------------------------+
<span class="token operator">|</span> Processes:                                                                              <span class="token operator">|</span>
<span class="token operator">|</span>  GPU   GI   CI        PID   Type   Process name                              GPU Memory <span class="token operator">|</span>
<span class="token operator">|</span>        ID   ID                                                               Usage      <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">0</span>   N/A  N/A        <span class="token number">33</span>      G   /Xwayland                                   N/A      <span class="token operator">|</span>
+-----------------------------------------------------------------------------------------+
</code></pre>
    <h4>
     <a id="322_nvidia_k8sdeviceplugin_958">
     </a>
     3.2.2 安装nvidia k8s-device-plugin
    </h4>
    <p>
     执行以下命令安装k8s-device-plugin@v0.16.2（官网yaml：https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/v0.16.2/deployments/static/nvidia-device-plugin.yml）：
    </p>
    <pre><code class="prism language-bash">$ kubectl apply <span class="token parameter variable">-f</span> - <span class="token operator">&lt;&lt;</span><span class="token string">EOF
# Copyright (c) 2019, NVIDIA CORPORATION.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: nvidia-device-plugin-daemonset
  namespace: kube-system
spec:
  selector:
    matchLabels:
      name: nvidia-device-plugin-ds
  updateStrategy:
    type: RollingUpdate
  template:
    metadata:
      labels:
        name: nvidia-device-plugin-ds
    spec:
      tolerations:
      - key: nvidia.com/gpu
        operator: Exists
        effect: NoSchedule
      - effect: NoSchedule # 由于我只有一个master节点，该节点打了污点，因此需要加上这个容忍，否则无法调度pod
        key: node-role.kubernetes.io/master
        operator: Exists
      # Mark this pod as a critical add-on; when enabled, the critical add-on
      # scheduler reserves resources for critical add-on pods so that they can
      # be rescheduled after a failure.
      # See https://kubernetes.io/docs/tasks/administer-cluster/guaranteed-scheduling-critical-addon-pods/
      priorityClassName: "system-node-critical"
      containers:
      - image: nvcr.io/nvidia/k8s-device-plugin:v0.16.2
        name: nvidia-device-plugin-ctr
        env:
          - name: FAIL_ON_INIT_ERROR
            value: "false"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
        volumeMounts:
        - name: device-plugin
          mountPath: /var/lib/kubelet/device-plugins
      volumes:
      - name: device-plugin
        hostPath:
          path: /var/lib/kubelet/device-plugins
EOF</span>
</code></pre>
    <p>
     检查daemonset：
    </p>
    <pre><code class="prism language-bash">$ kubectl <span class="token parameter variable">-n</span> kube-system get ds nvidia-device-plugin-daemonset
NAME                             DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
nvidia-device-plugin-daemonset   <span class="token number">1</span>         <span class="token number">1</span>         <span class="token number">0</span>       <span class="token number">1</span>            <span class="token number">0</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>          38m

$ kubectl <span class="token parameter variable">-n</span> kube-system get pod nvidia-device-plugin-daemonset-jl6nc <span class="token parameter variable">-o</span> wide
NAME                                   READY   STATUS    RESTARTS   AGE   IP            NODE              NOMINATED NODE   READINESS GATES
nvidia-device-plugin-daemonset-jl6nc   <span class="token number">1</span>/1     Running   <span class="token number">0</span>          78s   <span class="token number">10.244</span>.0.80   desktop-72rd6ov   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

$ kubectl <span class="token parameter variable">-n</span> kube-system logs nvidia-device-plugin-daemonset-jl6nc
I0310 <span class="token number">11</span>:30:39.696659       <span class="token number">1</span> main.go:199<span class="token punctuation">]</span> Starting FS watcher.
I0310 <span class="token number">11</span>:30:39.696723       <span class="token number">1</span> main.go:206<span class="token punctuation">]</span> Starting OS watcher.
I0310 <span class="token number">11</span>:30:39.697075       <span class="token number">1</span> main.go:221<span class="token punctuation">]</span> Starting Plugins.
I0310 <span class="token number">11</span>:30:39.697092       <span class="token number">1</span> main.go:278<span class="token punctuation">]</span> Loading configuration.
I0310 <span class="token number">11</span>:30:39.699210       <span class="token number">1</span> main.go:303<span class="token punctuation">]</span> Updating config with default resource matching patterns.
I0310 <span class="token number">11</span>:30:39.699332       <span class="token number">1</span> main.go:314<span class="token punctuation">]</span>
Running with config:
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"version"</span><span class="token builtin class-name">:</span> <span class="token string">"v1"</span>,
  <span class="token string">"flags"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"migStrategy"</span><span class="token builtin class-name">:</span> <span class="token string">"none"</span>,
    <span class="token string">"failOnInitError"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"mpsRoot"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
    <span class="token string">"nvidiaDriverRoot"</span><span class="token builtin class-name">:</span> <span class="token string">"/"</span>,
    <span class="token string">"nvidiaDevRoot"</span><span class="token builtin class-name">:</span> <span class="token string">"/"</span>,
    <span class="token string">"gdsEnabled"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"mofedEnabled"</span><span class="token builtin class-name">:</span> false,
    <span class="token string">"useNodeFeatureAPI"</span><span class="token builtin class-name">:</span> null,
    <span class="token string">"deviceDiscoveryStrategy"</span><span class="token builtin class-name">:</span> <span class="token string">"auto"</span>,
    <span class="token string">"plugin"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"passDeviceSpecs"</span><span class="token builtin class-name">:</span> false,
      <span class="token string">"deviceListStrategy"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
        <span class="token string">"envvar"</span>
      <span class="token punctuation">]</span>,
      <span class="token string">"deviceIDStrategy"</span><span class="token builtin class-name">:</span> <span class="token string">"uuid"</span>,
      <span class="token string">"cdiAnnotationPrefix"</span><span class="token builtin class-name">:</span> <span class="token string">"cdi.k8s.io/"</span>,
      <span class="token string">"nvidiaCTKPath"</span><span class="token builtin class-name">:</span> <span class="token string">"/usr/bin/nvidia-ctk"</span>,
      <span class="token string">"containerDriverRoot"</span><span class="token builtin class-name">:</span> <span class="token string">"/driver-root"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"resources"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"gpus"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token string">"pattern"</span><span class="token builtin class-name">:</span> <span class="token string">"*"</span>,
        <span class="token string">"name"</span><span class="token builtin class-name">:</span> <span class="token string">"nvidia.com/gpu"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"sharing"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"timeSlicing"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
I0310 <span class="token number">11</span>:30:39.699348       <span class="token number">1</span> main.go:317<span class="token punctuation">]</span> Retrieving plugins.
I0310 <span class="token number">11</span>:30:39.729583       <span class="token number">1</span> server.go:216<span class="token punctuation">]</span> Starting GRPC server <span class="token keyword">for</span> <span class="token string">'nvidia.com/gpu'</span>
I0310 <span class="token number">11</span>:30:39.729982       <span class="token number">1</span> server.go:147<span class="token punctuation">]</span> Starting to serve <span class="token string">'nvidia.com/gpu'</span> on /var/lib/kubelet/device-plugins/nvidia-gpu.sock
I0310 <span class="token number">11</span>:30:39.730798       <span class="token number">1</span> server.go:154<span class="token punctuation">]</span> Registered device plugin <span class="token keyword">for</span> <span class="token string">'nvidia.com/gpu'</span> with Kubelet
</code></pre>
    <p>
     到这里其实就部署成功了，查看节点信息验证一下：
    </p>
    <pre><code class="prism language-text">$ kubectl get node
NAME              STATUS   ROLES                  AGE    VERSION
desktop-72rd6ov   Ready    control-plane,master   334d   v1.22.7

$ kubectl get node desktop-72rd6ov -oyaml
...
status:
  ...
  allocatable:
    cpu: "16"
    ephemeral-storage: "972991057538"
    hugepages-1Gi: "0"
    hugepages-2Mi: "0"
    memory: 16146768Ki
    nvidia.com/gpu: "1" # 上报上来的GPU数据
    pods: "110"
  capacity:
    cpu: "16"
    ephemeral-storage: 1055762868Ki
    hugepages-1Gi: "0"
    hugepages-2Mi: "0"
    memory: 16249168Ki
    nvidia.com/gpu: "1" # 上报上来的GPU数据
    pods: "110"
</code></pre>
    <h3>
     <a id="33_k8sGPU_1110">
     </a>
     3.3 k8s调度GPU功能验证
    </h3>
    <p>
     准备如下pod：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> gpu<span class="token punctuation">-</span>pod
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">restartPolicy</span><span class="token punctuation">:</span> Never
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cuda<span class="token punctuation">-</span>container
      <span class="token key atrule">image</span><span class="token punctuation">:</span> nvcr.io/nvidia/cuda<span class="token punctuation">:</span>12.2.0<span class="token punctuation">-</span>runtime<span class="token punctuation">-</span>ubuntu22.04
      <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
      <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"nvidia-smi"</span><span class="token punctuation">]</span>
      <span class="token key atrule">resources</span><span class="token punctuation">:</span>
        <span class="token key atrule">limits</span><span class="token punctuation">:</span>
          <span class="token key atrule">nvidia.com/gpu</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment"># requesting 1 GPU</span>
      <span class="token key atrule">securityContext</span><span class="token punctuation">:</span>
        <span class="token key atrule">capabilities</span><span class="token punctuation">:</span>
          <span class="token key atrule">add</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"SYS_ADMIN"</span><span class="token punctuation">]</span>
  <span class="token key atrule">tolerations</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">key</span><span class="token punctuation">:</span> nvidia.com/gpu
    <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
    <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule
  <span class="token punctuation">-</span> <span class="token key atrule">effect</span><span class="token punctuation">:</span> NoSchedule <span class="token comment"># 由于我只有一个master节点，该节点打了污点，因此需要加上这个容忍，否则无法调度pod</span>
    <span class="token key atrule">key</span><span class="token punctuation">:</span> node<span class="token punctuation">-</span>role.kubernetes.io/master
    <span class="token key atrule">operator</span><span class="token punctuation">:</span> Exists
</code></pre>
    <p>
     apply该yaml并查看pod日志：
    </p>
    <pre><code class="prism language-bash">$ kubectl apply <span class="token parameter variable">-f</span> pod.yaml
pod/gpu-pod created

$ kubectl get pod <span class="token parameter variable">-o</span> wide
NAME      READY   STATUS      RESTARTS   AGE   IP             NODE              NOMINATED NODE   READINESS GATES
gpu-pod   <span class="token number">0</span>/1     Completed   <span class="token number">0</span>          5s    <span class="token number">10.244</span>.0.127   desktop-72rd6ov   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

$ kubectl logs gpu-pod
Mon Mar <span class="token number">10</span> <span class="token number">11</span>:35:13 <span class="token number">2025</span>
+-----------------------------------------------------------------------------------------+
<span class="token operator">|</span> NVIDIA-SMI <span class="token number">560.35</span>.02              Driver Version: <span class="token number">560.94</span>         CUDA Version: <span class="token number">12.6</span>     <span class="token operator">|</span>
<span class="token operator">|</span>-----------------------------------------+------------------------+----------------------+
<span class="token operator">|</span> GPU  Name                 Persistence-M <span class="token operator">|</span> Bus-Id          Disp.A <span class="token operator">|</span> Volatile Uncorr. ECC <span class="token operator">|</span>
<span class="token operator">|</span> Fan  Temp   Perf          Pwr:Usage/Cap <span class="token operator">|</span>           Memory-Usage <span class="token operator">|</span> GPU-Util  Compute M. <span class="token operator">|</span>
<span class="token operator">|</span>                                         <span class="token operator">|</span>                        <span class="token operator">|</span>               MIG M. <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">+=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">+=</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">|</span>
<span class="token operator">|</span>   <span class="token number">0</span>  NVIDIA GeForce RTX <span class="token number">4060</span> Ti     On  <span class="token operator">|</span>   00000000:01:00.0  On <span class="token operator">|</span>                  N/A <span class="token operator">|</span>
<span class="token operator">|</span>  <span class="token number">0</span>%   38C    P8              7W /  165W <span class="token operator">|</span>    1058MiB /  16380MiB <span class="token operator">|</span>      <span class="token number">0</span>%      Default <span class="token operator">|</span>
<span class="token operator">|</span>                                         <span class="token operator">|</span>                        <span class="token operator">|</span>                  N/A <span class="token operator">|</span>
+-----------------------------------------+------------------------+----------------------+

+-----------------------------------------------------------------------------------------+
<span class="token operator">|</span> Processes:                                                                              <span class="token operator">|</span>
<span class="token operator">|</span>  GPU   GI   CI        PID   Type   Process name                              GPU Memory <span class="token operator">|</span>
<span class="token operator">|</span>        ID   ID                                                               Usage      <span class="token operator">|</span>
<span class="token operator">|</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">=</span><span class="token operator">|</span>
<span class="token operator">|</span>    <span class="token number">0</span>   N/A  N/A        <span class="token number">33</span>      G   /Xwayland                                   N/A      <span class="token operator">|</span>
+-----------------------------------------------------------------------------------------+
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f4e5543454d4c532f:61727469636c652f64657461696c732f313436313632313739" class_="artid" style="display:none">
 </p>
</div>


