---
layout: post
title: "计算机网络开发3端口复用IO多路复用"
date: 2025-03-11 21:01:48 +0800
description: "由于有一个MSL，所以上一秒关闭的服务器，可能之前的端口还未释放；又或者是程序突然退出系统没有释放端口，导致端口被占用。当有新的服务想要用这个端口的时候，会出现错误：服务会出现。"
keywords: "计算机网络开发（3）——端口复用、I\\O多路复用"
categories: ['八股', 'Linux']
tags: ['计算机网络', '网络']
artid: "146186923"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146186923
    alt: "计算机网络开发3端口复用IO多路复用"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146186923
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146186923
cover: https://bing.ee123.net/img/rand?artid=146186923
image: https://bing.ee123.net/img/rand?artid=146186923
img: https://bing.ee123.net/img/rand?artid=146186923
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     计算机网络开发（3）——端口复用、I\O多路复用
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     端口复用
    </h2>
    <p>
     由于有一个MSL，所以上一秒关闭的服务器，可能之前的端口还未释放；又或者是程序突然退出系统没有释放端口，导致端口被占用。
     <br/>
     当有新的服务想要用这个端口的时候，会出现错误：服务会出现
     <code>
      Bind error:Address already in use
     </code>
    </p>
    <h3>
     <a id="_3">
     </a>
     解决办法
    </h3>
    <p>
     设置套接字属性，
     <br/>
     <code>
      int setsockopt(int sockfd, int level, int optname, const void *optval, socklen_t optlen);
     </code>
    </p>
    <ul>
     <li>
      功能：设置套接字的属性（不仅仅能设置端口复用）
     </li>
     <li>
      参数
      <ul>
       <li>
        <code>
         sockfd
        </code>
        ：要操作的文件描述符
       </li>
       <li>
        <code>
         level
        </code>
        ：级别，
        <code>
         SOL_SOCKET
        </code>
        (端口复用的级别)
       </li>
       <li>
        <code>
         optname
        </code>
        ：选项的名称，使用
        <code>
         SO_REUSEADDR
        </code>
        (解决在TimeWait的情况)或
        <code>
         SO_REUSEPORT
        </code>
        (允许多个线程、进程绑在同一个端口上）
       </li>
       <li>
        <code>
         optval
        </code>
        ：端口复用的值（整形） ，1表示可复用，0表示不可复用
       </li>
       <li>
        <code>
         optlen
        </code>
        ：optval参数的大小
       </li>
      </ul>
     </li>
    </ul>
    <h2>
     <a id="netstat__15">
     </a>
     netstat -参数名
    </h2>
    <p>
     a:所有的socket
     <br/>
     p:显示正在使用socket的程序名称
     <br/>
     n:直接使用IP地址，不通过域名服务器
    </p>
    <h2>
     <a id="IOIO_20">
     </a>
     I\O多路复用（IO多路转接
    </h2>
    <h3>
     <a id="BIO_21">
     </a>
     BIO模型
    </h3>
    <p>
     遇到read/recv/accept的时候，需要阻塞等待，直到有数据或者连接的时候才能继续往下执行
     <br/>
     要么是单任务的时候，一个时刻只能处理一个操作，效率低；
     <br/>
     要么是多任务的时候，虽然是多进程、多线程，一个线程或者进程对应一个任务， 但在进程线程之间的切换会消耗CPU资源。
     <br/>
     这些的根本问题都是阻塞在那。
    </p>
    <h3>
     <a id="select_27">
     </a>
     select
    </h3>
    <p>
     大概思想是：将要
     <strong>
      监听的
     </strong>
     文件的
     <strong>
      文件描述符表
     </strong>
     放到一个列表里面，需
     <strong>
      要监听的就置为1
     </strong>
     ，然后把这个
     <strong>
      交给内核
     </strong>
     ，由
     <strong>
      内核对
     </strong>
     这些文件描述符进行
     <strong>
      检测
     </strong>
     （我们不需要知道他是怎么检测的，反正他就是知道了）。最后内核
     <strong>
      返回有变动的文件描述符的数量
     </strong>
     ，和文件描述符列表。我们再从这之中遍历。去读取
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/time.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span> </span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/select.h&gt;</span> </span>

<span class="token keyword">int</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">int</span> nfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>readfds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>writefds<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>exceptfds<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token operator">*</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
	 	nfds：委托内核检测的最大文件描述符的值 <span class="token operator">+</span> <span class="token number">1</span>（<span class="token operator">+</span><span class="token number">1</span>是因为遍历是下标从<span class="token number">0</span>开始，<span class="token keyword">for</span>循环＜设定）
	   	readfds：要检测的文件描述符的读的集合，委托内核检测哪些文件描述符的读的属性一般检测读操作
	     		对应的是对方发送过来的数据，因为读是被动的接收数据，检测的就是读缓冲区是一个传入传出参数
	  	writefds：要检测的文件描述符的写的集合，委托内核检测哪些文件描述符的写的属性
	     		委托内核检测写缓冲区是不是还可以写数据（不满的就可以写）
	  	exceptfds：检测发生异常的文件描述符的集合，一般不用
	  	timeout：设置的超时时间，含义见select参数列表说明
	    		<span class="token constant">NULL</span>：永久阻塞，直到检测到了文件描述符有变化
     			tv_sec <span class="token operator">=</span> tv_usec <span class="token operator">=</span> <span class="token number">0</span> 不阻塞
	     		tv_sec <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">,</span>tv_usec <span class="token operator">&gt;</span> <span class="token number">0</span>：阻塞对应的时间
	<span class="token operator">*</span> 返回值
	  <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">1</span>：失败
	  <span class="token operator">*</span> \<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>：检测的集合中有n个文件描述符发生了变化


<span class="token comment">// 将参数文件描述符fd对应的标志位设置为0 </span>
<span class="token keyword">void</span> <span class="token function">FD_CLR</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 判断fd对应的标志位是0还是1， 返回值 ： fd对应的标志位的值，0，返回0， 1，返回1 </span>
<span class="token keyword">int</span> <span class="token function">FD_ISSET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 将参数文件描述符fd 对应的标志位，设置为1 </span>
<span class="token keyword">void</span> <span class="token function">FD_SET</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// fd_set一共有1024 bit, 全部初始化为0 </span>
<span class="token keyword">void</span> <span class="token function">FD_ZERO</span><span class="token punctuation">(</span>fd_set <span class="token operator">*</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b161f4888b8447e098444770c9c65478.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0a6402cac0b24a0f86b0a24c1b925739.png">
       <br/>
       <strong>
        注意事项
       </strong>
       ：因为内核返回去会改变这个文件包描述符列表，所以最好：
       <br/>
       <code>
        select
       </code>
       中需要的监听集合需要两个：
      </img>
     </img>
    </p>
    <ul>
     <li>
      一个是用户态真正需要监听的集合
      <code>
       rSet
      </code>
     </li>
     <li>
      一个是内核态返回给用户态的修改集合
      <code>
       tmpSet
      </code>
     </li>
    </ul>
    <h4>
     <a id="_69">
     </a>
     会存在的问题
    </h4>
    <ul>
     <li>
      每次都需要利用
      <code>
       FD_ISSET
      </code>
      轮训
      <code>
       [0, maxfd]
      </code>
      之间的连接状态，
      <font color="red">
       如果位于中间的某一个客户端断开了连接
      </font>
      ，此时不应该再去利用
      <code>
       FD_ISSET
      </code>
      轮训，造成资源浪费
     </li>
     <li>
      如果在处理客户端数据时，某一次read没有对数据读完，那么造成重新进行下一次时select，获取上一次未处理完的文件描述符，从0开始遍历到maxfd，对上一次的进行再一次操作，效率十分低下
     </li>
    </ul>
    <p>
     解决：
    </p>
    <ul>
     <li>
      考虑到
      <code>
       select
      </code>
      只有
      <code>
       1024
      </code>
      个最大可监听数量，可以
      <font color="red">
       申请等量客户端数组
      </font>
      <ul>
       <li>
        初始置为-1，当有状态改变时，置为相应文件描述符
       </li>
       <li>
        此时再用
        <code>
         FD_ISSET
        </code>
        轮训时，跳过标记为-1的客户端，加快遍历速度
       </li>
      </ul>
     </li>
     <li>
      对于问题二：对读缓存区循环读，直到返回
      <code>
       EAGAIN
      </code>
      再处理数据
     </li>
    </ul>
    <h4>
     <a id="select_79">
     </a>
     select缺点：
    </h4>
    <ul>
     <li>
      每次调用select，都需要把fd集合从用户态拷贝到内核态，这个开销在fd很多时会很大
     </li>
     <li>
      同时每次调用select都需要在内核遍历传递进来的所有fd，这个开销在fd很多时也很大
     </li>
     <li>
      select支持的文件描述符数量太小了，默认是1024
     </li>
     <li>
      fds集合不能重用，每次都需要重置
     </li>
    </ul>
    <h3>
     <a id="poll_85">
     </a>
     poll
    </h3>
    <p>
     解决了上面缺点的三四条
    </p>
    <h3>
     <a id="epoll_88">
     </a>
     epoll
    </h3>
    <ul>
     <li>
      直接在
      <strong>
       内核态
      </strong>
      创建
      <code>
       eventpoll实例
      </code>
      (结构体)，通过
      <code>
       epoll
      </code>
      提供的API操作该实例 （解决了总是在内核态和用户态拷贝转化内的资源浪费）
     </li>
     <li>
      结构体中有
      <code>
       红黑树
      </code>
      和
      <code>
       双链表
      </code>
      ，分别用来
      <strong>
       存储需要检测的文件描述符
      </strong>
      和**存储已经发生改变的文件描述符
     </li>
    </ul>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token comment">// 创建一个新的epoll实例</span>
<span class="token comment">// 在内核中创建了一个数据，这个数据中有两个比较重要的数据，一个是需要检测的文件描述符的信息（红黑树），还有一个是就绪列表，存放检测到数据发送改变的文件描述符信息（双向链表）</span>
<span class="token keyword">int</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token keyword">int</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 对epoll实例进行管理：添加文件描述符信息，删除信息，修改信息</span>
<span class="token keyword">int</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">int</span> op<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">uint32_t</span> events<span class="token punctuation">;</span> <span class="token comment">/* Epoll events */</span> 
    epoll_data_t data<span class="token punctuation">;</span> <span class="token comment">/* User data variable */</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">union</span> epoll_data <span class="token punctuation">{<!-- --></span> 
    <span class="token keyword">void</span> <span class="token operator">*</span>ptr<span class="token punctuation">;</span> 
    <span class="token keyword">int</span> fd<span class="token punctuation">;</span> 
    <span class="token keyword">uint32_t</span> u32<span class="token punctuation">;</span> 
    <span class="token keyword">uint64_t</span> u64<span class="token punctuation">;</span> 
<span class="token punctuation">}</span> epoll_data_t<span class="token punctuation">;</span>

<span class="token comment">// 检测函数</span>
<span class="token keyword">int</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span><span class="token keyword">int</span> epfd<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> <span class="token operator">*</span>events<span class="token punctuation">,</span> <span class="token keyword">int</span> maxevents<span class="token punctuation">,</span> <span class="token keyword">int</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <code>
      int epoll_create(int size);
     </code>
    </p>
    <ul>
     <li>
      功能：创建一个新的epoll实例
     </li>
     <li>
      参数：
      <code>
       size
      </code>
      ，目前没有意义了(之前底层实现是哈希表，现在是红黑树)，随便写一个数，必须大于0
     </li>
     <li>
      返回值
      <ul>
       <li>
        -1：失败
       </li>
       <li>
        &gt;0：操作
        <code>
         epoll实例
        </code>
        的文件描述符 epfd
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <p>
     <code>
      int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);
     </code>
    </p>
    <ul>
     <li>
      功能：对epoll实例进行管理：添加文件描述符信息，删除信息，修改信息
     </li>
     <li>
      参数：
      <ul>
       <li>
        <code>
         epfd
        </code>
        ：epoll实例对应的文件描述符
       </li>
       <li>
        <code>
         op
        </code>
        ：要进行什么操作
        <ul>
         <li>
          添加：
          <code>
           EPOLL_CTL_ADD
          </code>
         </li>
         <li>
          删除：
          <code>
           EPOLL_CTL_DEL
          </code>
         </li>
         <li>
          修改：
          <code>
           EPOLL_CTL_MOD
          </code>
         </li>
        </ul>
       </li>
       <li>
        <code>
         fd
        </code>
        ：要检测的文件描述符
       </li>
       <li>
        <code>
         event
        </code>
        ：检测文件描述符什么事情，通过设置
        <code>
         epoll_event.events
        </code>
        ，常见操作
        <ul>
         <li>
          读事件：
          <code>
           EPOLLIN
          </code>
         </li>
         <li>
          写事件：
          <code>
           EPOLLOUT
          </code>
         </li>
         <li>
          错误事件：
          <code>
           EPOLLERR
          </code>
         </li>
         <li>
          设置边沿触发：
          <code>
           EPOLLET
          </code>
          （默认水平触发）
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      返回值：成功0，失败-1
     </li>
    </ul>
    <hr/>
    <ul>
     <li>
      <p>
       <code>
        int epoll_wait(int epfd, struct epoll_event *events, int maxevents, int timeout);
       </code>
      </p>
      <ul>
       <li>
        功能：检测哪些文件描述符发生了改变
       </li>
       <li>
        参数：
        <ul>
         <li>
          <code>
           epfd
          </code>
          ：epoll实例对应的文件描述符
         </li>
         <li>
          <code>
           events
          </code>
          ：传出参数，这个结构体保存了发生了变化的文件描述符的信息
         </li>
         <li>
          <code>
           maxevents
          </code>
          ：第二个参数结构体数组的大小
         </li>
         <li>
          <code>
           timeout
          </code>
          ：阻塞时长
          <ul>
           <li>
            0：不阻塞
           </li>
           <li>
            -1：阻塞，当检测到需要检测的文件描述符有变化，解除阻塞
           </li>
           <li>
            &gt;0：具体的阻塞时长(ms)
           </li>
          </ul>
         </li>
        </ul>
       </li>
       <li>
        返回值：
        <ul>
         <li>
          &gt; 0：成功，返回发送变化的文件描述符的个数
         </li>
         <li>
          -1：失败
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <h4>
     <a id="_155">
     </a>
     实现代码
    </h4>
    <p>
     里面的events是一个结构体，用于存放文件描述符的信息，看可以重用。
     <br/>
     如果有多个监听文件例如读和写分开监听，那就分开设置。这里就设置了监听读
    </p>
    <pre><code class="prism language-cpp">服务端：
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/epoll.h&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SERVERIP</span> <span class="token string">"127.0.0.1"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PORT</span> <span class="token expression"><span class="token number">6789</span></span></span>


<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1. 创建socket（用于监听的套接字）</span>
    <span class="token keyword">int</span> listenfd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>listenfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"socket"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2. 绑定</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server_addr<span class="token punctuation">;</span>
    server_addr<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> PF_INET<span class="token punctuation">;</span>
    <span class="token comment">// 点分十进制转换为网络字节序</span>
    <span class="token function">inet_pton</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SERVERIP<span class="token punctuation">,</span> <span class="token operator">&amp;</span>server_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 服务端也可以绑定0.0.0.0即任意地址</span>
    <span class="token comment">// server_addr.sin_addr.s_addr = INADDR_ANY;</span>
    server_addr<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>PORT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"bind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3. 监听</span>
    ret <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"listen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建epoll实例</span>
    <span class="token keyword">int</span> epfd <span class="token operator">=</span> <span class="token function">epoll_create</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//随便写一个大于0的就行</span>
    <span class="token comment">// 将监听文件描述符加入实例</span>
    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> event<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> listenfd<span class="token punctuation">;</span>
    ret <span class="token operator">=</span> <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> listenfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"epoll_ctl"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 此结构体用来保存内核态返回给用户态发生改变的文件描述符信息</span>
    <span class="token keyword">struct</span> <span class="token class-name">epoll_event</span> events<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//这里设置1024个结构体，那么就是最多同时连接1024个，具体个数可以自己再调整</span>
    <span class="token comment">// 不断循环等待客户端连接</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 使用epoll，设置为永久阻塞，有文件描述符变化才返回</span>
        <span class="token keyword">int</span> num <span class="token operator">=</span> <span class="token function">epoll_wait</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> events<span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"poll"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 当前无文件描述符有变化，执行下一次遍历</span>
            <span class="token comment">// 在本次设置中无效（因为select被设置为永久阻塞）</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 遍历发生改变的文件描述符集合</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 判断监听文件描述符是否发生改变（即是否有客户端连接）</span>
                <span class="token keyword">int</span> curfd <span class="token operator">=</span> events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>curfd <span class="token operator">==</span> listenfd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 4. 接收客户端连接</span>
                    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> client_addr<span class="token punctuation">;</span>
                    socklen_t client_addr_len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> connfd <span class="token operator">=</span> <span class="token function">accept</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client_addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addr_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>connfd <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"accept"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 输出客户端信息，IP组成至少16个字符（包含结束符）</span>
                    <span class="token keyword">char</span> client_ip<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                    <span class="token function">inet_ntop</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> <span class="token operator">&amp;</span>client_addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr<span class="token punctuation">,</span> client_ip<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>client_ip<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">unsigned</span> <span class="token keyword">short</span> client_port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ip:%s, port:%d\n"</span><span class="token punctuation">,</span> client_ip<span class="token punctuation">,</span> client_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// 将信息加入监听集合</span>
                    event<span class="token punctuation">.</span>events <span class="token operator">=</span> EPOLLIN<span class="token punctuation">;</span>
                    event<span class="token punctuation">.</span>data<span class="token punctuation">.</span>fd <span class="token operator">=</span> connfd<span class="token punctuation">;</span>
                    <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_ADD<span class="token punctuation">,</span> connfd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 只检测读事件</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>events<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>events <span class="token operator">&amp;</span> EPOLLOUT<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 接收消息</span>
                    <span class="token keyword">char</span> recv_buf<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                    ret <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>curfd<span class="token punctuation">,</span> recv_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>recv_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"read"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"recv server data : %s\n"</span><span class="token punctuation">,</span> recv_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">write</span><span class="token punctuation">(</span>curfd<span class="token punctuation">,</span> recv_buf<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>recv_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 表示客户端断开连接</span>
                        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"client closed...\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">close</span><span class="token punctuation">(</span>curfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">epoll_ctl</span><span class="token punctuation">(</span>epfd<span class="token punctuation">,</span> EPOLL_CTL_DEL<span class="token punctuation">,</span> curfd<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">close</span><span class="token punctuation">(</span>listenfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>epfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="EPOLLLTET_278">
     </a>
     EPOLL的LT方式和ET方式
    </h3>
    <ul>
     <li>
      LT(缺省模式）
      <ul>
       <li>
        用户不读数据，数据一直在缓冲区，epoll 会一直通知
       </li>
       <li>
        用户只读了一部分数据，epoll会通知
       </li>
       <li>
        缓冲区的数据读完了，不通知
       </li>
      </ul>
     </li>
     <li>
      ET
      <ul>
       <li>
        用户不读数据，数据一致在缓冲区中，epoll下次检测的时候就不通知了
       </li>
       <li>
        用户只读了一部分数据，epoll不通知
       </li>
       <li>
        缓冲区的数据读完了，不通知
       </li>
      </ul>
     </li>
    </ul>
    <p>
     ET的设计方式：event.events = EPOLLIN | EPOLLET;
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f6879645f617368656c792f:61727469636c652f64657461696c732f313436313836393233" class_="artid" style="display:none">
 </p>
</div>


