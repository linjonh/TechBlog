---
layout: post
title: "Visual-Studio-2022和C实现带多组标签的Snowflake-SQL查询批量数据导出程序"
date: 2025-03-14 06:54:33 +0800
description: "设计一个基于多个带标签Snowflake SQL语句作为json配置文件的Visual Studio 2022的C++代码程序，实现根据不同的输入参数自动批量地将Snowflake数据库的数据导出为CSV文件到本地目录上，标签加扩展名.csv为导出数据文件名，文件已经存在则覆盖原始文件。"
keywords: "Visual Studio 2022和C++实现带多组标签的Snowflake SQL查询批量数据导出程序"
categories: ['未分类']
tags: ['数据仓库', '开发语言', '云计算', 'Sql', 'C']
artid: "146247636"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146247636
    alt: "Visual-Studio-2022和C实现带多组标签的Snowflake-SQL查询批量数据导出程序"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146247636
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146247636
cover: https://bing.ee123.net/img/rand?artid=146247636
image: https://bing.ee123.net/img/rand?artid=146247636
img: https://bing.ee123.net/img/rand?artid=146247636
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Visual Studio 2022和C++实现带多组标签的Snowflake SQL查询批量数据导出程序
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     设计一个基于多个带标签Snowflake SQL语句作为json配置文件的Visual Studio 2022的C++代码程序，实现根据不同的输入参数自动批量地将Snowflake数据库的数据导出为CSV文件到本地目录上，标签加扩展名.csv为导出数据文件名，文件已经存在则覆盖原始文件。需要考虑SQL结果集是大数据量分批数据导出的情况，通过多线程和异步操作来提高程序性能，程序需要异常处理和输出，输出出错时的错误信息，每次每个查询导出数据的运行状态和表数据行数以及运行时间戳，导出时间，输出每个文件记录数量的日志。
    </p>
    <p>
     该解决方案实现了高效的大数据导出，通过多线程和分批处理优化性能，同时提供完善的错误处理和日志追踪功能。C++代码解决方案：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;thread&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;mutex&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iomanip&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sql.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sqlext.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;nlohmann/json.hpp&gt;</span></span>

<span class="token keyword">using</span> json <span class="token operator">=</span> nlohmann<span class="token double-colon punctuation">::</span>json<span class="token punctuation">;</span>
<span class="token keyword">namespace</span> fs <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>filesystem<span class="token punctuation">;</span>

<span class="token comment">// 配置结构体</span>
<span class="token keyword">struct</span> <span class="token class-name">SnowflakeConfig</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>string server<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string user<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string password<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string database<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string schema<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string warehouse<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">QueryConfig</span> <span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>string label<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string sql<span class="token punctuation">;</span>
    <span class="token keyword">int</span> batch_size<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 日志管理</span>
<span class="token keyword">class</span> <span class="token class-name">Logger</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>ofstream log_file<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>mutex mtx<span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">Logger</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> path<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        log_file<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> message<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">lock</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> now <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> time <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock<span class="token double-colon punctuation">::</span><span class="token function">to_time_t</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log_file <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span><span class="token function">put_time</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"[%Y-%m-%d %H:%M:%S] "</span><span class="token punctuation">)</span>
                 <span class="token operator">&lt;&lt;</span> message <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// CSV转义处理</span>
std<span class="token double-colon punctuation">::</span>string <span class="token function">escape_csv</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> field<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>field<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token char">'"'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> std<span class="token double-colon punctuation">::</span>string<span class="token double-colon punctuation">::</span>npos <span class="token operator">||</span> 
        field<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token char">','</span><span class="token punctuation">)</span> <span class="token operator">!=</span> std<span class="token double-colon punctuation">::</span>string<span class="token double-colon punctuation">::</span>npos <span class="token operator">||</span>
        field<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token char">'\n'</span><span class="token punctuation">)</span> <span class="token operator">!=</span> std<span class="token double-colon punctuation">::</span>string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"\""</span> <span class="token operator">+</span> std<span class="token double-colon punctuation">::</span><span class="token function">regex_replace</span><span class="token punctuation">(</span>field<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">regex</span><span class="token punctuation">(</span><span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"\"\""</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\""</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> field<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 导出任务处理</span>
<span class="token keyword">void</span> <span class="token function">export_task</span><span class="token punctuation">(</span><span class="token keyword">const</span> QueryConfig<span class="token operator">&amp;</span> query<span class="token punctuation">,</span> <span class="token keyword">const</span> SnowflakeConfig<span class="token operator">&amp;</span> sf_config<span class="token punctuation">,</span> 
                <span class="token keyword">const</span> fs<span class="token double-colon punctuation">::</span>path<span class="token operator">&amp;</span> output_dir<span class="token punctuation">,</span> Logger<span class="token operator">&amp;</span> logger<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">auto</span> start_time <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    SQLHENV env <span class="token operator">=</span> SQL_NULL_HENV<span class="token punctuation">;</span>
    SQLHDBC dbc <span class="token operator">=</span> SQL_NULL_HDBC<span class="token punctuation">;</span>
    SQLHSTMT stmt <span class="token operator">=</span> SQL_NULL_HSTMT<span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 初始化ODBC环境</span>
        <span class="token function">SQLAllocHandle</span><span class="token punctuation">(</span>SQL_HANDLE_ENV<span class="token punctuation">,</span> SQL_NULL_HANDLE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SQLSetEnvAttr</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> SQL_ATTR_ODBC_VERSION<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>SQL_OV_ODBC3<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 建立连接</span>
        <span class="token function">SQLAllocHandle</span><span class="token punctuation">(</span>SQL_HANDLE_DBC<span class="token punctuation">,</span> env<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dbc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string conn_str <span class="token operator">=</span> <span class="token string">"DRIVER=SnowflakeDSIIDriver;SERVER="</span> <span class="token operator">+</span> sf_config<span class="token punctuation">.</span>server <span class="token operator">+</span>
                              <span class="token string">";DATABASE="</span> <span class="token operator">+</span> sf_config<span class="token punctuation">.</span>database <span class="token operator">+</span>
                              <span class="token string">";SCHEMA="</span> <span class="token operator">+</span> sf_config<span class="token punctuation">.</span>schema <span class="token operator">+</span>
                              <span class="token string">";WAREHOUSE="</span> <span class="token operator">+</span> sf_config<span class="token punctuation">.</span>warehouse <span class="token operator">+</span>
                              <span class="token string">";UID="</span> <span class="token operator">+</span> sf_config<span class="token punctuation">.</span>user <span class="token operator">+</span>
                              <span class="token string">";PWD="</span> <span class="token operator">+</span> sf_config<span class="token punctuation">.</span>password <span class="token operator">+</span> <span class="token string">";"</span><span class="token punctuation">;</span>
        
        SQLCHAR conn_out<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        SQLSMALLINT conn_out_len<span class="token punctuation">;</span>
        SQLRETURN ret <span class="token operator">=</span> <span class="token function">SQLDriverConnect</span><span class="token punctuation">(</span>dbc<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>SQLCHAR<span class="token operator">*</span><span class="token punctuation">)</span>conn_str<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SQL_NTS<span class="token punctuation">,</span>
                                        conn_out<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>conn_out<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>conn_out_len<span class="token punctuation">,</span> SQL_DRIVER_COMPLETE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SQL_SUCCEEDED</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"Connection failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 准备语句</span>
        <span class="token function">SQLAllocHandle</span><span class="token punctuation">(</span>SQL_HANDLE_STMT<span class="token punctuation">,</span> dbc<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">SQLExecDirect</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token punctuation">(</span>SQLCHAR<span class="token operator">*</span><span class="token punctuation">)</span>query<span class="token punctuation">.</span>sql<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> SQL_NTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SQL_SUCCEEDED</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"SQL execution failed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取列信息</span>
        SQLSMALLINT num_cols<span class="token punctuation">;</span>
        <span class="token function">SQLNumResultCols</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> <span class="token operator">&amp;</span>num_cols<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> col_names<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> num_cols<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            SQLCHAR col_name<span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            SQLSMALLINT name_len<span class="token punctuation">;</span>
            <span class="token function">SQLColAttribute</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> i<span class="token punctuation">,</span> SQL_DESC_NAME<span class="token punctuation">,</span> col_name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>col_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>name_len<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            col_names<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>col_name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 准备文件输出</span>
        fs<span class="token double-colon punctuation">::</span>path output_path <span class="token operator">=</span> output_dir <span class="token operator">/</span> <span class="token punctuation">(</span>query<span class="token punctuation">.</span>label <span class="token operator">+</span> <span class="token string">".csv"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>ofstream <span class="token function">file</span><span class="token punctuation">(</span>output_path<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>trunc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">)</span> <span class="token keyword">throw</span> std<span class="token double-colon punctuation">::</span><span class="token function">runtime_error</span><span class="token punctuation">(</span><span class="token string">"Failed to open output file"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 写入列头</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> col_names<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            file <span class="token operator">&lt;&lt;</span> <span class="token function">escape_csv</span><span class="token punctuation">(</span>col_names<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> col_names<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> file <span class="token operator">&lt;&lt;</span> <span class="token string">","</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        file <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>

        <span class="token comment">// 设置批次大小</span>
        <span class="token function">SQLSetStmtAttr</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> SQL_ATTR_ROW_ARRAY_SIZE<span class="token punctuation">,</span> <span class="token punctuation">(</span>SQLPOINTER<span class="token punctuation">)</span>query<span class="token punctuation">.</span>batch_size<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SQLSetStmtAttr</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> SQL_ATTR_ROWS_FETCHED_PTR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rows_fetched<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 绑定列缓冲区</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">&gt;&gt;</span> <span class="token function">column_buffers</span><span class="token punctuation">(</span>num_cols<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>SQLLEN<span class="token operator">&gt;</span> <span class="token function">indicators</span><span class="token punctuation">(</span>num_cols<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_cols<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            column_buffers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>batch_size <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">SQLBindCol</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> SQL_C_CHAR<span class="token punctuation">,</span> column_buffers<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                      <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>indicators<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 处理数据批次</span>
        <span class="token keyword">int</span> total_rows <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            SQLRETURN fetch_ret <span class="token operator">=</span> <span class="token function">SQLFetchScroll</span><span class="token punctuation">(</span>stmt<span class="token punctuation">,</span> SQL_FETCH_NEXT<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fetch_ret <span class="token operator">==</span> SQL_NO_DATA<span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SQL_SUCCEEDED</span><span class="token punctuation">(</span>fetch_ret<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>

            <span class="token comment">// 处理每行数据</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> row <span class="token operator">&lt;</span> rows_fetched<span class="token punctuation">;</span> <span class="token operator">++</span>row<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> col <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> col <span class="token operator">&lt;</span> num_cols<span class="token punctuation">;</span> <span class="token operator">++</span>col<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>col <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> file <span class="token operator">&lt;&lt;</span> <span class="token string">","</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>indicators<span class="token punctuation">[</span>col<span class="token punctuation">]</span> <span class="token operator">!=</span> SQL_NULL_DATA<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        std<span class="token double-colon punctuation">::</span>string <span class="token function">value</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
                            column_buffers<span class="token punctuation">[</span>col<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> row <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        file <span class="token operator">&lt;&lt;</span> <span class="token function">escape_csv</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                file <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            total_rows <span class="token operator">+=</span> rows_fetched<span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>label <span class="token operator">+</span> <span class="token string">" - Fetched batch: "</span> <span class="token operator">+</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>rows_fetched<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">auto</span> end_time <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> duration <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">duration_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>milliseconds<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>end_time <span class="token operator">-</span> start_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>label <span class="token operator">+</span> <span class="token string">" - Completed. Total rows: "</span> <span class="token operator">+</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>total_rows<span class="token punctuation">)</span> <span class="token operator">+</span>
                  <span class="token string">" Duration: "</span> <span class="token operator">+</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>duration<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>exception<span class="token operator">&amp;</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span> end_time <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> duration <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">duration_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>milliseconds<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>end_time <span class="token operator">-</span> start_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>label <span class="token operator">+</span> <span class="token string">" - Error: "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
                  <span class="token string">" Duration: "</span> <span class="token operator">+</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>duration<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 清理资源</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>stmt <span class="token operator">!=</span> SQL_NULL_HSTMT<span class="token punctuation">)</span> <span class="token function">SQLFreeHandle</span><span class="token punctuation">(</span>SQL_HANDLE_STMT<span class="token punctuation">,</span> stmt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dbc <span class="token operator">!=</span> SQL_NULL_HDBC<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">SQLDisconnect</span><span class="token punctuation">(</span>dbc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">SQLFreeHandle</span><span class="token punctuation">(</span>SQL_HANDLE_DBC<span class="token punctuation">,</span> dbc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>env <span class="token operator">!=</span> SQL_NULL_HENV<span class="token punctuation">)</span> <span class="token function">SQLFreeHandle</span><span class="token punctuation">(</span>SQL_HANDLE_ENV<span class="token punctuation">,</span> env<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Usage: "</span> <span class="token operator">&lt;&lt;</span> argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token string">" &lt;config.json&gt; &lt;output_dir&gt;"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 读取配置文件</span>
        std<span class="token double-colon punctuation">::</span>ifstream <span class="token function">config_file</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        json config<span class="token punctuation">;</span>
        config_file <span class="token operator">&gt;&gt;</span> config<span class="token punctuation">;</span>

        <span class="token comment">// 解析Snowflake配置</span>
        SnowflakeConfig sf_config<span class="token punctuation">;</span>
        <span class="token comment">// ...解析配置...</span>

        <span class="token comment">// 创建输出目录</span>
        fs<span class="token double-colon punctuation">::</span>path <span class="token function">output_dir</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fs<span class="token double-colon punctuation">::</span><span class="token function">create_directories</span><span class="token punctuation">(</span>output_dir<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 初始化日志</span>
        Logger <span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">(</span>output_dir <span class="token operator">/</span> <span class="token string">"export.log"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建线程池</span>
        std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>thread<span class="token operator">&gt;</span> threads<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> query_json <span class="token operator">:</span> config<span class="token punctuation">[</span><span class="token string">"queries"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            QueryConfig query<span class="token punctuation">{<!-- --></span>
                query_json<span class="token punctuation">[</span><span class="token string">"label"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                query_json<span class="token punctuation">[</span><span class="token string">"sql"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                query_json<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string">"batch_size"</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            threads<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token punctuation">[</span>query<span class="token punctuation">,</span> sf_config<span class="token punctuation">,</span> output_dir<span class="token punctuation">,</span> <span class="token operator">&amp;</span>logger<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">export_task</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> sf_config<span class="token punctuation">,</span> output_dir<span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 等待所有线程完成</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> t <span class="token operator">:</span> threads<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">joinable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> t<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>exception<span class="token operator">&amp;</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"Error: "</span> <span class="token operator">&lt;&lt;</span> e<span class="token punctuation">.</span><span class="token function">what</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="_232">
     </a>
     代码说明：
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        配置文件解析
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用nlohmann/json库解析包含多个SQL查询的JSON配置文件
       </li>
       <li>
        每个查询包含标签、SQL语句和批次大小
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        数据库连接
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用ODBC API连接Snowflake数据库
       </li>
       <li>
        支持连接参数配置（服务器、用户、密码等）
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        数据导出
       </strong>
       ：
      </p>
      <ul>
       <li>
        使用分批次获取数据（通过SQLFetchScroll）
       </li>
       <li>
        动态绑定列缓冲区处理不同数据类型
       </li>
       <li>
        自动处理CSV格式转义和特殊字符
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        多线程处理
       </strong>
       ：
      </p>
      <ul>
       <li>
        每个查询在独立线程中执行
       </li>
       <li>
        使用线程池模式管理并发任务
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        日志系统
       </strong>
       ：
      </p>
      <ul>
       <li>
        线程安全的日志记录
       </li>
       <li>
        记录每个批次的状态、总行数和执行时间
       </li>
       <li>
        错误处理和信息追踪
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        异常处理
       </strong>
       ：
      </p>
      <ul>
       <li>
        全面捕获数据库操作异常
       </li>
       <li>
        文件操作错误处理
       </li>
       <li>
        资源泄漏防护（使用RAII管理句柄）
       </li>
      </ul>
     </li>
    </ol>
    <h4>
     <a id="_261">
     </a>
     使用说明：
    </h4>
    <ol>
     <li>
      准备配置文件（config.json）：
     </li>
    </ol>
    <pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
  <span class="token string-property property">"snowflake"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string-property property">"server"</span><span class="token operator">:</span> <span class="token string">"your_account.snowflakecomputing.com"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"user"</span><span class="token operator">:</span> <span class="token string">"username"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"password"</span><span class="token operator">:</span> <span class="token string">"password"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"database"</span><span class="token operator">:</span> <span class="token string">"database"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"schema"</span><span class="token operator">:</span> <span class="token string">"schema"</span><span class="token punctuation">,</span>
    <span class="token string-property property">"warehouse"</span><span class="token operator">:</span> <span class="token string">"warehouse"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string-property property">"queries"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string-property property">"label"</span><span class="token operator">:</span> <span class="token string">"sales_data"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"sql"</span><span class="token operator">:</span> <span class="token string">"SELECT * FROM sales WHERE date &gt;= '2023-01-01'"</span><span class="token punctuation">,</span>
      <span class="token string-property property">"batch_size"</span><span class="token operator">:</span> <span class="token number">10000</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
    <ol start="2">
     <li>
      编译运行：
     </li>
    </ol>
    <pre><code class="prism language-bash">g++ <span class="token parameter variable">-std</span><span class="token operator">=</span>c++17 <span class="token parameter variable">-lodbc</span> <span class="token parameter variable">-lsnowflakeclient</span> main.cpp <span class="token parameter variable">-o</span> exporter
./exporter config.json ./output
</code></pre>
    <ol start="3">
     <li>
      输出结果：
      <ul>
       <li>
        CSV文件：./output/sales_data.csv
       </li>
       <li>
        日志文件：./output/export.log
       </li>
      </ul>
     </li>
    </ol>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f33303737373931332f:61727469636c652f64657461696c732f313436323437363336" class_="artid" style="display:none">
 </p>
</div>


