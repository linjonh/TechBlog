---
layout: post
title: "kubernetespart3-5-核心概念-Service"
date: 2025-03-09 11:20:05 +0800
description: "使用kubernetes集群运行工作负载时，由于Pod经常处于用后即焚状态，Pod经常被重新生成，因此Pod对应的IP地址也会经常变化，导致无法直接访问Pod提供的服务，Kubernetes中使用了Service来解决这一问题，即在Pod前面使用Service对Pod进行代理，无论Pod怎样变化 ，只要有Label，就可以让Service能够联系上Pod，把PodIP地址添加到Service对应的端点列表（Endpoints）实现对Pod IP跟踪，进而实现通过Service访问Pod目的。"
keywords: "kubernetes——part3-5 核心概念 Service"
categories: ['云原生']
tags: ['容器', '云原生', 'Kubernetes']
artid: "146129136"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146129136
    alt: "kubernetespart3-5-核心概念-Service"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146129136
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146129136
cover: https://bing.ee123.net/img/rand?artid=146129136
image: https://bing.ee123.net/img/rand?artid=146129136
img: https://bing.ee123.net/img/rand?artid=146129136
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     kubernetes——part3-5 核心概念 Service
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_service_0">
     </a>
     一、 service作用
    </h2>
    <p>
     使用kubernetes集群运行工作负载时，由于Pod经常处于用后即焚状态，Pod经常被重新生成，因此Pod对应的IP地址也会经常变化，导致无法直接访问Pod提供的服务，Kubernetes中使用了Service来解决这一问题，即在Pod前面使用Service对Pod进行代理，无论Pod怎样变化 ，只要有Label，就可以让Service能够联系上Pod，把PodIP地址添加到Service对应的端点列表（Endpoints）实现对Pod IP跟踪，进而实现通过Service访问Pod目的。
    </p>
    <ul>
     <li>
      通过service为pod客户端提供访问pod方法，即可客户端访问pod入口
     </li>
     <li>
      通过标签动态感知pod IP地址变化等
     </li>
     <li>
      防止pod失联
     </li>
     <li>
      定义访问pod访问策略
     </li>
     <li>
      通过label-selector相关联
     </li>
     <li>
      通过Service实现Pod的负载均衡（TCP/UDP 4层）
     </li>
     <li>
      底层实现由kube-proxy通过userspace、iptables、ipvs三种代理模式
     </li>
    </ul>
    <h2>
     <a id="kubeproxy_16">
     </a>
     二、kube-proxy三种代理模式
    </h2>
    <ul>
     <li>
      <p>
       kubernetes集群中有三层网络，一类是真实存在的，例如Node Network、Pod Network,提供真实IP地址;一类是虚拟的，例如Cluster Network或Service Network，提供虚拟IP地址，不会出现在接口上，仅会出现在Service当中
      </p>
     </li>
     <li>
      <p>
       kube-proxy始终watch（监控）kube-apiserver上关于Service相关的资源变动状态，一旦获取相关信息kube-proxy都要把相关信息转化为当前节点之上的，能够实现Service资源调度到特定Pod之上的规则，进而实现访问Service就能够获取Pod所提供的服务
      </p>
     </li>
     <li>
      <p>
       kube-proxy三种代理模式：UserSpace模式、iptables模式、ipvs模式
      </p>
     </li>
    </ul>
    <h3>
     <a id="21_UserSpace_26">
     </a>
     2.1 UserSpace模式
    </h3>
    <p>
     <code>
      不再使用了解即可
     </code>
     <br/>
     userspace 模式是 kube-proxy 使用的第一代模式，该模式在 kubernetes v1.0 版本开始支持使用。
    </p>
    <p>
     userspace 模式的实现原理图示如下：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bbd71b753608469cb05dc8f212c484a1.png"/>
    </p>
    <p>
     kube-proxy 会为每个 Service 随机监听一个端口(proxy port)，并增加一条 iptables 规则。所以通过 ClusterIP:Port 访问 Service 的报文都 redirect 到 proxy port，kube-proxy 从它监听的 proxy port 收到报文以后，走 round robin(默认) 或是 session affinity(会话亲和力，即同一 client IP 都走同一链路给同一 pod 服务)，分发给对应的 pod。
    </p>
    <p>
     由于 userspace 模式会造成所有报文都走一遍用户态（也就是 Service 请求会先从用户空间进入内核 iptables，然后再回到用户空间，由 kube-proxy 完成后端 Endpoints 的选择和代理工作），需要在内核空间和用户空间转换，流量从用户空间进出内核会带来性能损耗，所以这种模式效率低、性能不高，不推荐使用。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b208ae37b28c4fda84c09c9296b3a211.png"/>
    </p>
    <h3>
     <a id="22_iptables_40">
     </a>
     2.2 iptables模式
    </h3>
    <p>
     iptables 模式是 kube-proxy 使用的第二代模式，该模式在 kubernetes v1.1 版本开始支持，从 v1.2 版本开始成为 kube-proxy 的默认模式。
    </p>
    <p>
     iptables 模式的负载均衡模式是通过底层 netfilter/iptables 规则来实现的，通过 Informer 机制 Watch 接口实时跟踪 Service 和 Endpoint 的变更事件，并触发对 iptables 规则的同步更新。
    </p>
    <p>
     iptables 模式的实现原理图示如下：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7cabc8a2a0b54202949840631e0ad723.png"/>
    </p>
    <p>
     通过图示我们可以发现在 iptables 模式下，kube-proxy 只是作为 controller，而不是 server，真正服务的是内核的 netfilter，体现在用户态的是 iptables。所以整体的效率会比 userspace 模式高。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b9c293650484450896d603158b0ee611.png"/>
    </p>
    <h3>
     <a id="23_ipvs_54">
     </a>
     2.3 ipvs模式
    </h3>
    <p>
     ipvs 模式被 kube-proxy 采纳为第三代模式，模式在 kubernetes v1.8 版本开始引入，在 v1.9 版本中处于 beta 阶段，在 v1.11 版本中正式开始使用。
    </p>
    <p>
     ipvs(IP Virtual Server) 实现了传输层负载均衡，也就是 4 层交换，作为 Linux 内核的一部分。
     <code>
      ipvs
     </code>
     运行在主机上，在真实服务器前充当负载均衡器。ipvs 可以将基于 TCP 和 UDP 的服务请求转发到真实服务器上，并使真实服务器上的服务在单个 IP 地址上显示为虚拟服务。
    </p>
    <p>
     ipvs 模式的实现原理图示如下：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9a9938f89a964fad9d8be3b3b77b545b.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/caf844ae5cfd415b9bc4a3016186fe5a.png"/>
     </img>
    </p>
    <p>
     ipvs 和 iptables 都是基于 netfilter 的，那么 ipvs 模式有哪些更好的性能呢？
    </p>
    <ul>
     <li>
      ipvs 为大型集群提供了更好的可拓展性和性能
     </li>
     <li>
      ipvs 支持比 iptables 更复杂的负载均衡算法（包括：最小负载、最少连接、加权等）
     </li>
     <li>
      ipvs 支持服务器健康检查和连接重试等功能
     </li>
     <li>
      可以动态修改 ipset 的集合，即使 iptables 的规则正在使用这个集合
     </li>
    </ul>
    <p>
     ipvs 依赖于 iptables。ipvs 会使用 iptables 进行包过滤、airpin-masquerade tricks(地址伪装)、SNAT 等功能，但是使用的是 iptables 的扩展 ipset，并不是直接调用 iptables 来生成规则链。通过 ipset 来存储需要 DROP 或 masquerade 的流量的源或目标地址，用于确保 iptables 规则的数量是恒定的，这样我们就不需要关心有多少 Service 或是 Pod 了。
    </p>
    <p>
     使用 ipset 相较于 iptables 有什么优点呢？iptables 是线性的数据结构，而 ipset 引入了带索引的数据结构，当规则很多的时候，ipset 依然可以很高效的查找和匹配。我们可以将 ipset 简单理解为一个 IP(段) 的集合，这个集合的内容可以是 IP 地址、IP 网段、端口等，iptables 可以直接添加规则对这个“可变的集合进行操作”，这样就可以大大减少 iptables 规则的数量，从而减少性能损耗。
    </p>
    <p>
     举一个例子，如果我们要禁止成千上万个 IP 访问我们的服务器，如果使用 iptables 就需要一条一条的添加规则，这样会在 iptables 中生成大量的规则；如果用 ipset 就只需要将相关的 IP 地址(网段)加入到 ipset 集合中，然后只需要设置少量的 iptables 规则就可以实现这个目标。
    </p>
    <p>
     下面的表格是 ipvs 模式下维护的 ipset 表集合：
    </p>
    <table>
     <thead>
      <tr>
       <th align="left">
        设置名称
       </th>
       <th align="left">
        成员
       </th>
       <th align="left">
        用法
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="left">
        KUBE-CLUSTER-IP
       </td>
       <td align="left">
        所有服务 IP + 端口
       </td>
       <td align="left">
        在 masquerade-all=true 或 clusterCIDR 指定的情况下对 Service Cluster IP 地址进行伪装，解决数据包欺骗问题
       </td>
      </tr>
      <tr>
       <td align="left">
        KUBE-LOOP-BACK
       </td>
       <td align="left">
        所有服务 IP + 端口 + IP
       </td>
       <td align="left">
        解决数据包欺骗问题
       </td>
      </tr>
      <tr>
       <td align="left">
        KUBE-EXTERNAL-IP
       </td>
       <td align="left">
        服务外部 IP + 端口
       </td>
       <td align="left">
        将数据包伪装成 Service 的外部 IP 地址
       </td>
      </tr>
      <tr>
       <td align="left">
        KUBE-LOAD-BALANCER
       </td>
       <td align="left">
        负载均衡器入口 IP + 端口
       </td>
       <td align="left">
        将数据包伪装成 Load Balancer 类型的 Service
       </td>
      </tr>
      <tr>
       <td align="left">
        KUBE-LOAD-BALANCER-LOCAL
       </td>
       <td align="left">
        负载均衡器入口 IP + 端口 以及
        <code>
         externalTrafficPolicy=local
        </code>
       </td>
       <td align="left">
        接受数据包到 Load Balancer externalTrafficPolicy=local
       </td>
      </tr>
      <tr>
       <td align="left">
        KUBE-LOAD-BALANCER-FW
       </td>
       <td align="left">
        负载均衡器入口 IP + 端口 以及
        <code>
         loadBalancerSourceRanges
        </code>
       </td>
       <td align="left">
        使用指定的 loadBalancerSourceRanges 丢弃 Load Balancer 类型 Service 的数据包
       </td>
      </tr>
      <tr>
       <td align="left">
        KUBE-LOAD-BALANCER-SOURCE-CIDR
       </td>
       <td align="left">
        负载均衡器入口 IP + 端口 + 源 CIDR
       </td>
       <td align="left">
        接受 Load Balancer 类型 Service 的数据包，并指定 loadBalancerSourceRanges
       </td>
      </tr>
      <tr>
       <td align="left">
        KUBE-NODE-PORT-TCP
       </td>
       <td align="left">
        NodePort 类型服务 TCP 端口
       </td>
       <td align="left">
        将数据包伪装成 NodePort（TCP）
       </td>
      </tr>
      <tr>
       <td align="left">
        KUBE-NODE-PORT-LOCAL-TCP
       </td>
       <td align="left">
        NodePort 类型服务 TCP 端口，带有
        <code>
         externalTrafficPolicy=local
        </code>
       </td>
       <td align="left">
        接受数据包到 NodePort 服务，使用 externalTrafficPolicy=local
       </td>
      </tr>
      <tr>
       <td align="left">
        KUBE-NODE-PORT-UDP
       </td>
       <td align="left">
        NodePort 类型服务 UDP 端口
       </td>
       <td align="left">
        将数据包伪装成 NodePort(UDP)
       </td>
      </tr>
      <tr>
       <td align="left">
        KUBE-NODE-PORT-LOCAL-UDP
       </td>
       <td align="left">
        NodePort 类型服务 UDP 端口，使用
        <code>
         externalTrafficPolicy=local
        </code>
       </td>
       <td align="left">
        接受数据包到 NodePort 服务，使用 externalTrafficPolicy=local
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="24_iptablesipvs_98">
     </a>
     2.4 iptables与ipvs对比
    </h3>
    <ul>
     <li>
      <p>
       iptables
      </p>
      <ul>
       <li>
        工作在内核空间
       </li>
       <li>
        优点
        <ul>
         <li>
          灵活，功能强大（可以在数据包不同阶段对包进行操作）
         </li>
        </ul>
       </li>
       <li>
        缺点
        <ul>
         <li>
          表中规则过多时，响应变慢，即规则遍历匹配和更新，呈线性时延
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <p>
       ipvs
      </p>
      <ul>
       <li>
        工作在内核空间
       </li>
       <li>
        优点
        <ul>
         <li>
          转发效率高
         </li>
         <li>
          调度算法丰富：rr，wrr，lc，wlc，ip hash…
         </li>
        </ul>
       </li>
       <li>
        缺点
        <ul>
         <li>
          内核支持不全,低版本内核不能使用，需要升级到4.0或5.0以上。
         </li>
        </ul>
       </li>
      </ul>
     </li>
     <li>
      <p>
       使用iptables与ipvs时机
      </p>
      <ul>
       <li>
        1.10版本之前使用iptables(1.1版本之前使用UserSpace进行转发)
       </li>
       <li>
        1.11版本之后同时支持iptables与ipvs，默认使用ipvs，如果ipvs模块没有加载时，会自动降级至iptables
       </li>
      </ul>
     </li>
    </ul>
    <h2>
     <a id="_service_122">
     </a>
     三、 service类型
    </h2>
    <p>
     Service类型决定了访问Service的方法
    </p>
    <h3>
     <a id="31_service_126">
     </a>
     3.1 service类型
    </h3>
    <ul>
     <li>
      <p>
       ClusterIP
      </p>
      <ul>
       <li>
        默认，分配一个集群内部可以访问的虚拟IP
       </li>
      </ul>
     </li>
     <li>
      <p>
       NodePort
      </p>
      <ul>
       <li>
        在每个Node上分配一个端口作为外部访问入口
       </li>
       <li>
        nodePort端口范围为:30000-32767
       </li>
      </ul>
     </li>
     <li>
      <p>
       LoadBalancer
      </p>
      <ul>
       <li>
        工作在特定的Cloud Provider上，例如Google Cloud，AWS，OpenStack
       </li>
      </ul>
     </li>
     <li>
      <p>
       ExternalName
      </p>
      <ul>
       <li>
        表示把集群外部的服务引入到集群内部中来，即实现了集群内部pod和集群外部的服务进行通信
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="32_Service_148">
     </a>
     3.2 Service参数
    </h3>
    <ul>
     <li>
      <p>
       port 访问service使用的端口
      </p>
     </li>
     <li>
      <p>
       targetPort Pod中容器端口 (容器内的端口，例如nginx，80端口)
      </p>
     </li>
     <li>
      <p>
       nodePort 通过Node实现外网用户访问k8s集群内service (30000-32767)（适用于nodeport模式）
      </p>
     </li>
    </ul>
    <h2>
     <a id="_Service_158">
     </a>
     四、 Service创建
    </h2>
    <blockquote>
     <p>
      Service的创建在工作中有两种方式，一是命令行创建，二是通过资源清单文件YAML文件创建。
     </p>
    </blockquote>
    <h3>
     <a id="41_ClusterIP_164">
     </a>
     4.1 ClusterIP类型
    </h3>
    <p>
     ClusterIP根据是否生成ClusterIP又可分为普通Service和Headless Service
    </p>
    <p>
     Service两类：
    </p>
    <ul>
     <li>
      普通Service:
     </li>
    </ul>
    <p>
     为Kubernetes的Service分配一个集群内部可访问的固定虚拟IP(Cluster IP), 实现集群内的访问。
    </p>
    <ul>
     <li>
      Headless Service:
     </li>
    </ul>
    <p>
     该服务不会分配Cluster IP, 也不通过kube-proxy做反向代理和负载均衡。而是通过DNS提供稳定的网络ID来访问，DNS会将headless service的后端直接解析为pod IP列表。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/0fbbd6f17e1a43b787b859ee1b37e3c6.png"/>
    </p>
    <h4>
     <a id="411_ClusterIP_Service_184">
     </a>
     4.1.1 普通ClusterIP Service创建
    </h4>
    <h5>
     <a id="4111_Service_186">
     </a>
     4.1.1.1 命令行创建Service
    </h5>
    <ul>
     <li>
      创建Deployment类型的应用
     </li>
    </ul>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># cat 01_create_deployment_app_nginx.yaml</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-server1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
     metadata:
       labels:
         app: nginx
     spec:
       containers:
       <span class="token operator">-</span> name: c1
         image: nginx:1<span class="token punctuation">.</span>15-alpine
         imagePullPolicy: IfNotPresent
         ports:
         <span class="token operator">-</span> containerPort: 80
</code></pre>
    <ul>
     <li>
      应用资源清单文件
     </li>
    </ul>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl apply -f 01_create_deployment_app_nginx.yaml</span>
</code></pre>
    <ul>
     <li>
      验证Deployment类型的创建情况
     </li>
    </ul>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get deployment.apps</span>
NAME            READY   UP-TO-DATE   AVAILABLE   AGE
nginx-server1   2/2     2            2           13s
</code></pre>
    <ul>
     <li>
      创建ClusterIP类型service与Deployment类型应用关联
     </li>
    </ul>
    <pre><code class="prism language-powershell">命令创建service
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl expose deployment.apps nginx-server1 --type=ClusterIP --target-port=80 --port=80</span>
</code></pre>
    <pre><code class="prism language-powershell">输出
service/nginx-server1 exposed
</code></pre>
    <pre><code class="prism language-powershell">说明
expose 创建service
deployment<span class="token punctuation">.</span>apps 控制器类型
nginx-server1 应用名称，也是service名称
<span class="token operator">--</span><span class="token function">type</span>=ClusterIP 指定service类型
<span class="token operator">--</span>target-port=80 指定Pod中容器端口
<span class="token operator">--</span>port=80 指定service端口
</code></pre>
    <h5>
     <a id="4112_Service_264">
     </a>
     4.1.1.2 通过资源清单文件创建Service
    </h5>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># cat 02_create_deployment_app_nginx_with_service.yaml</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-server1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
     metadata:
       labels:
         app: nginx
     spec:
       containers:
       <span class="token operator">-</span> name: nginx-smart
         image: nginx:1<span class="token punctuation">.</span>15-alpine
         imagePullPolicy: IfNotPresent
         ports:
         <span class="token operator">-</span> containerPort: 80
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
spec:
  <span class="token function">type</span>: ClusterIP
  ports:
  <span class="token operator">-</span> protocol: TCP
    port: 80
    targetPort: 80
  selector:
    app: nginx

</code></pre>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl  apply -f 02_create_deployment_app_nginx_with_service.yaml</span>
</code></pre>
    <ul>
     <li>
      验证
     </li>
    </ul>
    <pre><code class="prism language-powershell">查看service
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get service</span>
NAME         <span class="token function">TYPE</span>        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>    AGE
kubernetes   ClusterIP   10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1        &lt;none&gt;        443/TCP    4d15h
nginx-svc    ClusterIP   10<span class="token punctuation">.</span>101<span class="token punctuation">.</span>153<span class="token punctuation">.</span>50   &lt;none&gt;        80/TCP    3s
</code></pre>
    <pre><code class="prism language-powershell">查看endpoints
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get endpoints</span>
NAME         ENDPOINTS                            AGE
kubernetes   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>122<span class="token punctuation">.</span>30:6443                  4d15h
nginx-svc    172<span class="token punctuation">.</span>16<span class="token punctuation">.</span>189<span class="token punctuation">.</span>74:80<span class="token punctuation">,</span>172<span class="token punctuation">.</span>16<span class="token punctuation">.</span>235<span class="token punctuation">.</span>150:80   8s
</code></pre>
    <pre><code class="prism language-powershell">查看Pod
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get pods -l app=nginx</span>
NAME                             READY   STATUS    RESTARTS   AGE
nginx-server1-77d4c485d8-gsrmq   1/1     Running   0          12s
nginx-server1-77d4c485d8-mmc52   1/1     Running   0          12s
</code></pre>
    <h5>
     <a id="4113__340">
     </a>
     4.1.1.3 访问
    </h5>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># curl http://10.101.153.50:80</span>
&lt;<span class="token operator">!</span>DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;<span class="token operator">/</span>title&gt;
&lt;style&gt;
    body <span class="token punctuation">{<!-- --></span>
        width: 35em<span class="token punctuation">;</span>
        margin: 0 auto<span class="token punctuation">;</span>
        font-family: Tahoma<span class="token punctuation">,</span> Verdana<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
&lt;<span class="token operator">/</span>style&gt;
&lt;<span class="token operator">/</span>head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;<span class="token operator">/</span>h1&gt;
&lt;p&gt;<span class="token keyword">If</span> you see this page<span class="token punctuation">,</span> the nginx web server is successfully installed and
working<span class="token punctuation">.</span> Further configuration is required<span class="token punctuation">.</span>&lt;<span class="token operator">/</span>p&gt;

&lt;p&gt;<span class="token keyword">For</span> online documentation and support please refer to
&lt;a href=<span class="token string">"http://nginx.org/"</span>&gt;nginx<span class="token punctuation">.</span>org&lt;<span class="token operator">/</span>a&gt;<span class="token punctuation">.</span>&lt;br/&gt;
Commercial support is available at
&lt;a href=<span class="token string">"http://nginx.com/"</span>&gt;nginx<span class="token punctuation">.</span>com&lt;<span class="token operator">/</span>a&gt;<span class="token punctuation">.</span>&lt;<span class="token operator">/</span>p&gt;

&lt;p&gt;&lt;em&gt;Thank you <span class="token keyword">for</span> <span class="token keyword">using</span> nginx<span class="token punctuation">.</span>&lt;<span class="token operator">/</span>em&gt;&lt;<span class="token operator">/</span>p&gt;
&lt;<span class="token operator">/</span>body&gt;
&lt;<span class="token operator">/</span>html&gt;
</code></pre>
    <h5>
     <a id="4114_pod_373">
     </a>
     4.1.1.4 两个pod里做成不同的主页方便测试负载均衡
    </h5>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl exec -it nginx-server1-77d4c485d8-gsrmq -- /bin/bash</span>
root@deployment-nginx-6fcfb67547-nv7dn:<span class="token operator">/</span><span class="token comment"># cd /usr/share/nginx/html/</span>
root@deployment-nginx-6fcfb67547-nv7dn:<span class="token operator">/</span>usr/share/nginx/html<span class="token comment"># echo web1 &gt; index.html</span>
root@deployment-nginx-6fcfb67547-nv7dn:<span class="token operator">/</span>usr/share/nginx/html<span class="token comment"># exit</span>
<span class="token keyword">exit</span>
</code></pre>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl exec -it nginx-server1-77d4c485d8-mmc52 -- /bin/bash</span>
root@deployment-nginx-6fcfb67547-rqrcw:<span class="token operator">/</span><span class="token comment"># cd /usr/share/nginx/html/</span>
root@deployment-nginx-6fcfb67547-rqrcw:<span class="token operator">/</span>usr/share/nginx/html<span class="token comment"># echo web2 &gt; index.html</span>
root@deployment-nginx-6fcfb67547-rqrcw:<span class="token operator">/</span>usr/share/nginx/html<span class="token comment"># exit</span>
<span class="token keyword">exit</span>
</code></pre>
    <h5>
     <a id="4115__393">
     </a>
     4.1.1.5 测试
    </h5>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># curl 10.101.153.50</span>
或
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># while true;do curl 10.101.153.50;sleep 1; done</span>
</code></pre>
    <h4>
     <a id="412_Headless_Service_403">
     </a>
     4.1.2 Headless Service
    </h4>
    <ul>
     <li>
      普通的ClusterIP service是service name解析为cluster ip,然后cluster ip对应到后面的pod ip
     </li>
     <li>
      Headless service是指service name 直接解析为后面的pod ip
     </li>
    </ul>
    <h5>
     <a id="4121_Deployment_408">
     </a>
     4.1.2.1 编写用于创建Deployment控制器类型的资源清单文件
    </h5>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># cat 03_create_deployment_app_nginx.yaml</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-server1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
     metadata:
       labels:
         app: nginx
     spec:
       containers:
       <span class="token operator">-</span> name: nginx-smart
         image: nginx:1<span class="token punctuation">.</span>15-alpine
         imagePullPolicy: IfNotPresent
         ports:
         <span class="token operator">-</span> containerPort: 80
</code></pre>
    <h5>
     <a id="4122_headless_Service_436">
     </a>
     4.1.2.2 通过资源清单文件创建headless Service
    </h5>
    <pre><code class="prism language-powershell">编写YAML文件
命令
<span class="token namespace">[root@master ~]</span><span class="token comment"># vim 04_headless-service.yml</span>
apiVersion: v1
kind: Service
metadata:
  name: headless-service
  namespace: default
spec:
  <span class="token function">type</span>: ClusterIP     <span class="token comment"># ClusterIP类型,也是默认类型</span>
  clusterIP: None     <span class="token comment"># None就代表是无头service</span>
  ports:                                <span class="token comment"># 指定service 端口及容器端口</span>
  <span class="token operator">-</span> port: 80                            <span class="token comment"># service ip中的端口</span>
    protocol: TCP
    targetPort: 80                      <span class="token comment"># pod中的端口</span>
  selector:                             <span class="token comment"># 指定后端pod标签</span>
     app: nginx                    <span class="token comment"># 可通过kubectl get pod -l app=nginx查看哪些pod在使用此标签</span>
 
</code></pre>
    <h5>
     <a id="4123_headless_Service_461">
     </a>
     4.1.2.3 应用资源清单文件创建headless Service
    </h5>
    <pre><code class="prism language-powershell">命令
<span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl apply -f 04_headless_service.yml</span>
输出
service/headless-service created
</code></pre>
    <h5>
     <a id="4124_headless_Service_472">
     </a>
     4.1.2.4 查看已创建的headless Service
    </h5>
    <pre><code class="prism language-powershell">命令
<span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl get svc</span>
输出
NAME               <span class="token function">TYPE</span>        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
headless-service   ClusterIP   None             &lt;none&gt;        80/TCP           2m18s
kubernetes         ClusterIP   10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1        &lt;none&gt;        443/TCP          5d9h
可以看到headless-service没有CLUSTER-IP<span class="token punctuation">,</span>用None表示
</code></pre>
    <h5>
     <a id="4125_DNS_486">
     </a>
     4.1.2.5 DNS
    </h5>
    <p>
     DNS服务监视Kubernetes API,为每一个Service创建DNS记录用于域名解析
    </p>
    <p>
     headless service需要DNS来解决访问问题
    </p>
    <p>
     DNS记录格式为: ..svc.cluster.local.
    </p>
    <h6>
     <a id="41251_kubednsIP_496">
     </a>
     4.1.2.5.1 查看kube-dns服务的IP
    </h6>
    <pre><code class="prism language-powershell">命令
<span class="token namespace">[root@master1 ~]</span><span class="token comment"># kubectl get svc -n kube-system</span>


输出
NAME             <span class="token function">TYPE</span>        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                  AGE
kube-dns         ClusterIP   10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>0<span class="token punctuation">.</span>2      &lt;none&gt;        53/UDP<span class="token punctuation">,</span>53/TCP<span class="token punctuation">,</span>9153/TCP   5d9h
metrics-server   ClusterIP   10<span class="token punctuation">.</span>105<span class="token punctuation">.</span>219<span class="token punctuation">.</span>44   &lt;none&gt;        443/TCP                  45h
查看到coreDNS的服务地址是10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>0<span class="token punctuation">.</span>2
</code></pre>
    <h6>
     <a id="41252_DNSdns_512">
     </a>
     4.1.2.5.2 在集群主机通过DNS服务地址查找无头服务的dns解析
    </h6>
    <pre><code class="prism language-powershell">命令
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># dig -t A headless-service.default.svc.cluster.local. @10.96.0.2</span>


输出
<span class="token punctuation">;</span> &lt;&lt;&gt;&gt; DiG 9<span class="token punctuation">.</span>11<span class="token punctuation">.</span>4-P2-RedHat-9<span class="token punctuation">.</span>11<span class="token punctuation">.</span>4-16<span class="token punctuation">.</span>P2<span class="token punctuation">.</span>el7_8<span class="token punctuation">.</span>2 &lt;&lt;&gt;&gt; <span class="token operator">-</span>t A headless-service<span class="token punctuation">.</span>default<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local<span class="token punctuation">.</span> @10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>0<span class="token punctuation">.</span>2
<span class="token punctuation">;</span><span class="token punctuation">;</span> global options: <span class="token operator">+</span>cmd
<span class="token punctuation">;</span><span class="token punctuation">;</span> Got answer:
<span class="token punctuation">;</span><span class="token punctuation">;</span> WARNING: <span class="token punctuation">.</span>local is reserved <span class="token keyword">for</span> Multicast DNS
<span class="token punctuation">;</span><span class="token punctuation">;</span> You are currently testing what happens when an mDNS query is leaked to DNS
<span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token operator">-</span>&gt;&gt;HEADER&lt;&lt;<span class="token operator">-</span> opcode: QUERY<span class="token punctuation">,</span> status: NOERROR<span class="token punctuation">,</span> id: 31371
<span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr aa <span class="token function">rd</span><span class="token punctuation">;</span> QUERY: 1<span class="token punctuation">,</span> ANSWER: 1<span class="token punctuation">,</span> AUTHORITY: 0<span class="token punctuation">,</span> ADDITIONAL: 1
<span class="token punctuation">;</span><span class="token punctuation">;</span> WARNING: recursion requested but not available

<span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:
<span class="token punctuation">;</span> EDNS: version: 0<span class="token punctuation">,</span> flags:<span class="token punctuation">;</span> udp: 4096
<span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:
<span class="token punctuation">;</span>headless-service<span class="token punctuation">.</span>default<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local<span class="token punctuation">.</span> IN A <span class="token comment">#被解析域名</span>

<span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:
headless-service<span class="token punctuation">.</span>default<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local<span class="token punctuation">.</span> 30 IN A 10<span class="token punctuation">.</span>224<span class="token punctuation">.</span>235<span class="token punctuation">.</span>147 <span class="token comment">#注意这里IP</span>

<span class="token punctuation">;</span><span class="token punctuation">;</span> Query time: 0 msec
<span class="token punctuation">;</span><span class="token punctuation">;</span> SERVER: 10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>0<span class="token punctuation">.</span>10<span class="token comment">#53(10.96.0.2)</span>
<span class="token punctuation">;</span><span class="token punctuation">;</span> WHEN: Sun May 17 10:58:50 CST 2020
<span class="token punctuation">;</span><span class="token punctuation">;</span> MSG SIZE  rcvd: 129

</code></pre>
    <h6>
     <a id="41253__podIP_546">
     </a>
     4.1.2.5.3 验证pod的IP
    </h6>
    <pre><code class="prism language-powershell">命令
<span class="token namespace">[root@master ~]</span><span class="token comment"># kubectl get pod -o wide</span>
输出
NAME                                READY   STATUS             RESTARTS   AGE   IP               NODE      NOMINATED NODE   READINESS GATES
nginx-deployment-56bf6c9c8c-jmk7r   1/1     Running            0          35m   10<span class="token punctuation">.</span>224<span class="token punctuation">.</span>235<span class="token punctuation">.</span>147   worker1   &lt;none&gt;           &lt;none&gt;


</code></pre>
    <h6>
     <a id="41254_pod_560">
     </a>
     4.1.2.5.4 在集群中创建一个pod验证
    </h6>
    <blockquote>
     <p>
      创建一个镜像为busyboxplus:curl的pod，pod名称为bb2,用来解析域名
     </p>
    </blockquote>
    <pre><code class="prism language-powershell">命令
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl run bbp --image=busyboxplus:curl -it</span>

或
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl run bbp --image=1.28 -it</span>

输出
<span class="token keyword">If</span> you don<span class="token string">'t see a command prompt, try pressing enter.

解析域名
nslookup headless-service.default.svc.cluster.local.
访问命令
[ root@bbp:/ ]$ curl http://headless-service.default.svc.cluster.local.

输出
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;/h1&gt;
&lt;p&gt;If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.&lt;/p&gt;

&lt;p&gt;For online documentation and support please refer to
&lt;a href="http://nginx.org/"&gt;nginx.org&lt;/a&gt;.&lt;br/&gt;
Commercial support is available at
&lt;a href="http://nginx.com/"&gt;nginx.com&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;em&gt;Thank you for using nginx.&lt;/em&gt;&lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;
[ root@bbp:/ ]$ exit
Session ended, resume using '</span>kubectl attach bbp <span class="token operator">-</span>c bbp <span class="token operator">-</span>i <span class="token operator">-</span>t' command when the pod is running
</code></pre>
    <h3>
     <a id="42_NodePort_615">
     </a>
     4.2 NodePort类型
    </h3>
    <ul>
     <li>
      创建资源清单文件
     </li>
    </ul>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># cat 05_create_nodeport_service_app.yaml</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-app
  labels:
    app: nginx-app
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx-app
  template:
    metadata:
      labels:
        app: nginx-app
    spec:
      containers:
      <span class="token operator">-</span> name: c1
        image: nginx:1<span class="token punctuation">.</span>15-alpine
        imagePullPolicy: IfNotPresent
        ports:
        <span class="token operator">-</span> containerPort: 80
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Service
metadata:
  name: nginx-app
spec:
  <span class="token function">type</span>: NodePort
  selector:
    app: nginx-app
  ports:
  <span class="token operator">-</span> protocol: TCP
    nodePort: 30001
    port: 8060
    targetPort: 80
</code></pre>
    <ul>
     <li>
      应用资源清单文件
     </li>
    </ul>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl apply -f 05_create_nodeport_service_app.yaml</span>
deployment<span class="token punctuation">.</span>apps/nginx-app created
service/nginx-app created
</code></pre>
    <ul>
     <li>
      验证service创建
     </li>
    </ul>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get deployment.apps</span>
NAME         READY   UP-TO-DATE   AVAILABLE   AGE
nginx-app    2/2     2            2           26s


<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get svc</span>
NAME         <span class="token function">TYPE</span>        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
kubernetes   ClusterIP   10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1        &lt;none&gt;        443/TCP          2d22h
nginx-app    NodePort    10<span class="token punctuation">.</span>104<span class="token punctuation">.</span>157<span class="token punctuation">.</span>20    &lt;none&gt;        8060:30001/TCP   36s

<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get endpoints</span>
NAME         ENDPOINTS                       AGE
kubernetes   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>122<span class="token punctuation">.</span>10:6443             2d22h
nginx-app    172<span class="token punctuation">.</span>16<span class="token punctuation">.</span>1<span class="token punctuation">.</span>24:80<span class="token punctuation">,</span>172<span class="token punctuation">.</span>16<span class="token punctuation">.</span>2<span class="token punctuation">.</span>20:80   2m10s


<span class="token namespace">[root@master01 ~]</span><span class="token comment"># ss -anput | grep ":30001"</span>
tcp    LISTEN     0      128      :::30001                :::<span class="token operator">*</span>                   users:<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"kube-proxy"</span><span class="token punctuation">,</span>pid=5826<span class="token punctuation">,</span>fd=9<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token namespace">[root@worker01 ~]</span><span class="token comment"># ss -anput | grep ":30001"</span>
tcp    LISTEN     0      128      :::30001                :::<span class="token operator">*</span>                   users:<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"kube-proxy"</span><span class="token punctuation">,</span>pid=4937<span class="token punctuation">,</span>fd=11<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token namespace">[root@worker02 ~]</span><span class="token comment"># ss -anput | grep ":30001"</span>
tcp    LISTEN     0      128      :::30001                :::<span class="token operator">*</span>                   users:<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"kube-proxy"</span><span class="token punctuation">,</span>pid=5253<span class="token punctuation">,</span>fd=11<span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get pods</span>
NAME                          READY   STATUS    RESTARTS   AGE
nginx-app-ffd5ccc78-cnwbx    1/1     Running   0          8m59s
nginx-app-ffd5ccc78-mz77g    1/1     Running   0          8m59s

<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl exec -it nginx-app-ffd5ccc78-cnwbx -- bash</span>
root@nginx-app-ffd5ccc78-cnwbx:<span class="token operator">/</span><span class="token comment"># echo "nginx-app-1" &gt; /usr/share/nginx/html/index.html</span>
root@nginx-app-ffd5ccc78-cnwbx:<span class="token operator">/</span><span class="token comment"># exit</span>
<span class="token keyword">exit</span>
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl exec -it nginx-app-ffd5ccc78-mz77g -- bash</span>
root@nginx-app-ffd5ccc78-mz77g:<span class="token operator">/</span><span class="token comment"># echo "nginx-app-2" &gt; /usr/share/nginx/html/index.html</span>
root@nginx-app-ffd5ccc78-mz77g:<span class="token operator">/</span><span class="token comment"># exit</span>
<span class="token keyword">exit</span>
</code></pre>
    <ul>
     <li>
      在与kubernetes 节点同一网络主机中访问k8s集群内service
     </li>
    </ul>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@bogon ~]</span><span class="token comment"># curl http://192.168.10.12:30001</span>
nginx-app-2
<span class="token namespace">[root@bogon ~]</span><span class="token comment"># curl http://192.168.10.13:30001</span>
nginx-app-1
<span class="token namespace">[root@bogon ~]</span><span class="token comment"># curl http://192.168.10.14:30001</span>
nginx-app-1
<span class="token namespace">[root@bogon ~]</span><span class="token comment"># curl http://192.168.10.15:30001</span>
nginx-app-2
</code></pre>
    <h3>
     <a id="43_LoadBalancer_732">
     </a>
     4.3 LoadBalancer
    </h3>
    <p>
     负载均衡，类似阿里云的slb
    </p>
    <h4>
     <a id="431__734">
     </a>
     4.3.1 集群外访问过程
    </h4>
    <ul>
     <li>
      <h5>
       <a id="_736">
       </a>
       用户
      </h5>
     </li>
     <li>
      <h5>
       <a id="_738">
       </a>
       域名
      </h5>
     </li>
     <li>
      <h5>
       <a id="LB_740">
       </a>
       云服务提供商提供LB服务
      </h5>
     </li>
     <li>
      <h5>
       <a id="NodeIPPortservice_IP_742">
       </a>
       NodeIP:Port(service IP)
      </h5>
     </li>
     <li>
      <h5>
       <a id="Pod_IP_744">
       </a>
       Pod IP：端口
      </h5>
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ec15443f1e8444d69c833156e21b141c.png"/>
    </p>
    <h4>
     <a id="432__KubernetesLoadBalancerMetalLB_754">
     </a>
     4.3.2 自建Kubernetes的LoadBalancer类型服务方案-MetalLB
    </h4>
    <p>
     （如果是kubeadm创建的k8s集群先执行第6部分）
     <br/>
     MetalLB可以为kubernetes集群中的Service提供网络负载均衡功能。
    </p>
    <p>
     MetalLB两大功能为:
    </p>
    <ul>
     <li>
      地址分配，类似于DHCP
     </li>
     <li>
      外部通告，一旦MetalLB为服务分配了外部IP地址，它就需要使群集之外的网络意识到该IP在群集中“存在”。MetalLB使用标准路由协议来实现此目的：ARP，NDP或BGP。
     </li>
    </ul>
    <h5>
     <a id="4321___765">
     </a>
     4.3.2.1 参考资料
    </h5>
    <p>
     参考网址： https://metallb.universe.tf/installation/
    </p>
    <h5>
     <a id="4322___771">
     </a>
     4.3.2.2 应用资源清单文件
    </h5>
    <pre><code class="prism language-powershell">资源清单文件下载：
<span class="token comment"># kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/namespace.yaml</span>
<span class="token comment"># kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/metallb.yaml</span>
</code></pre>
    <h5>
     <a id="4323_metallb_781">
     </a>
     4.3.2.3 准备metallb配置文件
    </h5>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@nginx metallb]</span><span class="token comment"># cat metallb-conf.yaml</span>
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: metallb-system
  name: config
<span class="token keyword">data</span>:
  config: <span class="token punctuation">|</span>
    address-pools:
    <span class="token operator">-</span> name: default
      protocol: layer2
      addresses:
      <span class="token operator">-</span> 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>90-192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100
 
192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>90-192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100是集群节点服务器IP同一段。

</code></pre>
    <pre><code class="prism language-powershell">在master01节点应用资源清单文件
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl apply -f metallb-conf.yaml	</span>
</code></pre>
    <pre><code class="prism language-powershell">验证配置
<span class="token comment"># kubectl describe configmap config -n metallb-system</span>
Name:         config
Namespace:    metallb-system
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

<span class="token keyword">Data</span>
====
config:
<span class="token operator">--</span><span class="token operator">--</span>
address-pools:
<span class="token operator">-</span> name: default
  protocol: layer2
  addresses:
  <span class="token operator">-</span> 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>90-192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>100

Events:  &lt;none&gt;
</code></pre>
    <h5>
     <a id="4324ServiceLoadBalancerDeployment_836">
     </a>
     4.3.2.4发布Service类型为LoadBalancer的Deployment控制器类型应用
    </h5>
    <pre><code class="prism language-powershell">创建Deployment控制器类型应用nginx-metallb及service，service类型为LoadBalancer

<span class="token namespace">[root@master01 ~]</span><span class="token comment"># vim 02_nginx-metabllb.yaml</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-metallb
spec:
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      <span class="token operator">-</span> name: nginx-metallb1
        image: nginx:1<span class="token punctuation">.</span>15-alpine
        imagePullPolicy: IfNotPresent
        ports:
        <span class="token operator">-</span> containerPort: 80

<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Service
metadata:
  name: nginx-metallb
spec:
  ports:
  <span class="token operator">-</span> port: 8090
    protocol: TCP
    targetPort: 80
  selector:
    app: nginx
  <span class="token function">type</span>: LoadBalancer
  
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl apply -f nginx.yaml</span>
</code></pre>
    <h5>
     <a id="4325__881">
     </a>
     4.3.2.5 验证
    </h5>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get ns</span>
NAME                   STATUS   AGE
default                Active   16d
kube-node-lease        Active   16d
kube-public            Active   16d
kube-system            Active   16d
kubernetes-dashboard   Active   13d
metallb-system         Active   130m
test1                  Active   12d
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get pods -n metallb-system</span>
NAME                         READY   STATUS    RESTARTS   AGE
controller-64f8f944d-qdf8m   1/1     Running   0          110m
speaker-cwzq7                1/1     Running   0          110m
speaker-qk5fb                1/1     Running   0          110m
speaker-wsllb                1/1     Running   0          110m
speaker-x4bwt                1/1     Running   0          110m

<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get svc</span>
NAME            <span class="token function">TYPE</span>           CLUSTER-IP      EXTERNAL-IP      PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>          AGE
kubernetes      ClusterIP      10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1       &lt;none&gt;           443/TCP          16d
nginx-metallb   LoadBalancer   10<span class="token punctuation">.</span>105<span class="token punctuation">.</span>239<span class="token punctuation">.</span>69   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>90   8090:31372/TCP   106m

<span class="token namespace">[root@master01 ~]</span><span class="token comment"># ping 192.168.10.90</span>
PING 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>90 <span class="token punctuation">(</span>192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>90<span class="token punctuation">)</span> 56<span class="token punctuation">(</span>84<span class="token punctuation">)</span> bytes of <span class="token keyword">data</span><span class="token punctuation">.</span>
64 bytes <span class="token keyword">from</span> 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>90: icmp_seq=1 ttl=64 time=3<span class="token punctuation">.</span>45 ms
64 bytes <span class="token keyword">from</span> 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>10<span class="token punctuation">.</span>90: icmp_seq=2 ttl=64 time=0<span class="token punctuation">.</span>040 ms
</code></pre>
    <h5>
     <a id="4326__912">
     </a>
     4.3.2.6 访问
    </h5>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># curl http://192.168.122.90:8090</span>
&lt;<span class="token operator">!</span>DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;<span class="token operator">/</span>title&gt;
&lt;style&gt;
    body <span class="token punctuation">{<!-- --></span>
        width: 35em<span class="token punctuation">;</span>
        margin: 0 auto<span class="token punctuation">;</span>
        font-family: Tahoma<span class="token punctuation">,</span> Verdana<span class="token punctuation">,</span> Arial<span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
&lt;<span class="token operator">/</span>style&gt;
&lt;<span class="token operator">/</span>head&gt;
&lt;body&gt;
&lt;h1&gt;Welcome to nginx!&lt;<span class="token operator">/</span>h1&gt;
&lt;p&gt;<span class="token keyword">If</span> you see this page<span class="token punctuation">,</span> the nginx web server is successfully installed and
working<span class="token punctuation">.</span> Further configuration is required<span class="token punctuation">.</span>&lt;<span class="token operator">/</span>p&gt;

&lt;p&gt;<span class="token keyword">For</span> online documentation and support please refer to
&lt;a href=<span class="token string">"http://nginx.org/"</span>&gt;nginx<span class="token punctuation">.</span>org&lt;<span class="token operator">/</span>a&gt;<span class="token punctuation">.</span>&lt;br/&gt;
Commercial support is available at
&lt;a href=<span class="token string">"http://nginx.com/"</span>&gt;nginx<span class="token punctuation">.</span>com&lt;<span class="token operator">/</span>a&gt;<span class="token punctuation">.</span>&lt;<span class="token operator">/</span>p&gt;

&lt;p&gt;&lt;em&gt;Thank you <span class="token keyword">for</span> <span class="token keyword">using</span> nginx<span class="token punctuation">.</span>&lt;<span class="token operator">/</span>em&gt;&lt;<span class="token operator">/</span>p&gt;
&lt;<span class="token operator">/</span>body&gt;
&lt;<span class="token operator">/</span>html&gt;
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8c4404577dcb4554aadc74c7589706ea.png"/>
    </p>
    <p>
     <strong>
      注意：使用kubeadm部署kubernetes集群修改方法
     </strong>
    </p>
    <pre><code class="prism language-powershell">如果在IPVS模式下使用kube-proxy，从Kubernetes v1<span class="token punctuation">.</span>14<span class="token punctuation">.</span>2开始，必须启用ARP模式。

可以通过在当前集群中编辑kube-proxy配置来实现：
<span class="token comment"># kubectl edit configmap -n kube-system kube-proxy</span>

并设置：
apiVersion: kubeproxy<span class="token punctuation">.</span>config<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1alpha1
kind: KubeProxyConfiguration
mode: <span class="token string">"ipvs"</span>
ipvs:
  strictARP: true
</code></pre>
    <h3>
     <a id="44_ExternalName_968">
     </a>
     4.4 ExternalName
    </h3>
    <h4>
     <a id="441_ExternalName_970">
     </a>
     4.4.1 ExternalName作用
    </h4>
    <ul>
     <li>
      把集群外部的服务引入到集群内部中来，实现了集群内部pod和集群外部的服务进行通信
     </li>
     <li>
      ExternalName 类型的服务适用于外部服务使用域名的方式，缺点是不能指定端口
     </li>
     <li>
      还有一点要注意: 集群内的Pod会继承Node上的DNS解析规则。所以只要Node可以访问的服务，Pod中也可以访问到, 这就实现了集群内服务访问集群外服务
     </li>
    </ul>
    <h4>
     <a id="442____978">
     </a>
     4.4.2 将公网域名引入
    </h4>
    <p>
     1, 编写YAML文件
    </p>
    <pre><code class="prism language-powershell"> <span class="token namespace">[root@master01 ~]</span><span class="token comment"># vim externelname.yml</span>
 
apiVersion: v1
kind: Service
metadata:
  name: my-externalname
  namespace: default
spec:
  <span class="token function">type</span>: ExternalName
  externalName: www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com                  <span class="token comment"># 对应的外部域名为www.baidu.com</span>
 
</code></pre>
    <p>
     2, 应用YAML文件
    </p>
    <pre><code class="prism language-powershell"> <span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl apply -f externelname.yml</span>
 service/my-externalname created
</code></pre>
    <p>
     3, 查看service
    </p>
    <pre><code class="prism language-powershell"> <span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get svc |grep exter</span>
 my-externalname    ExternalName   &lt;none&gt;         www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com   &lt;none&gt;         69s
</code></pre>
    <p>
     4, 查看my-service的dns解析
    </p>
    <pre><code class="prism language-powershell"> <span class="token namespace">[root@master01 ~]</span><span class="token comment"># dig -t A my-externalname.default.svc.cluster.local. @10.96.0.2</span>
 
 <span class="token punctuation">;</span> &lt;&lt;&gt;&gt; DiG 9<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4-RedHat-9<span class="token punctuation">.</span>9<span class="token punctuation">.</span>4-72<span class="token punctuation">.</span>el7 &lt;&lt;&gt;&gt; <span class="token operator">-</span>t A my-externalname<span class="token punctuation">.</span>default<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local<span class="token punctuation">.</span> @10<span class="token punctuation">.</span>2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>2
 <span class="token punctuation">;</span><span class="token punctuation">;</span> global options: <span class="token operator">+</span>cmd
 <span class="token punctuation">;</span><span class="token punctuation">;</span> Got answer:
 <span class="token punctuation">;</span><span class="token punctuation">;</span> <span class="token operator">-</span>&gt;&gt;HEADER&lt;&lt;<span class="token operator">-</span> opcode: QUERY<span class="token punctuation">,</span> status: NOERROR<span class="token punctuation">,</span> id: 31378
 <span class="token punctuation">;</span><span class="token punctuation">;</span> flags: qr aa <span class="token function">rd</span><span class="token punctuation">;</span> QUERY: 1<span class="token punctuation">,</span> ANSWER: 4<span class="token punctuation">,</span> AUTHORITY: 0<span class="token punctuation">,</span> ADDITIONAL: 1
 <span class="token punctuation">;</span><span class="token punctuation">;</span> WARNING: recursion requested but not available
 
 <span class="token punctuation">;</span><span class="token punctuation">;</span> OPT PSEUDOSECTION:
 <span class="token punctuation">;</span> EDNS: version: 0<span class="token punctuation">,</span> flags:<span class="token punctuation">;</span> udp: 4096
 <span class="token punctuation">;</span><span class="token punctuation">;</span> QUESTION SECTION:
 <span class="token punctuation">;</span>my-externalname<span class="token punctuation">.</span>default<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local<span class="token punctuation">.</span> IN A
 
 <span class="token punctuation">;</span><span class="token punctuation">;</span> ANSWER SECTION:
 my-externalname<span class="token punctuation">.</span>default<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local<span class="token punctuation">.</span> 5 IN CNAME www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token punctuation">.</span>
 www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com<span class="token punctuation">.</span>          5       IN      CNAME   www<span class="token punctuation">.</span>a<span class="token punctuation">.</span>shifen<span class="token punctuation">.</span>com<span class="token punctuation">.</span>
 www<span class="token punctuation">.</span>a<span class="token punctuation">.</span>shifen<span class="token punctuation">.</span>com<span class="token punctuation">.</span>       5       IN      A       14<span class="token punctuation">.</span>215<span class="token punctuation">.</span>177<span class="token punctuation">.</span>38           解析的是百度的IP
 www<span class="token punctuation">.</span>a<span class="token punctuation">.</span>shifen<span class="token punctuation">.</span>com<span class="token punctuation">.</span>       5       IN      A       14<span class="token punctuation">.</span>215<span class="token punctuation">.</span>177<span class="token punctuation">.</span>39           解析的是百度的IP
 
 <span class="token punctuation">;</span><span class="token punctuation">;</span> Query time: 32 msec
 <span class="token punctuation">;</span><span class="token punctuation">;</span> SERVER: 10<span class="token punctuation">.</span>2<span class="token punctuation">.</span>0<span class="token punctuation">.</span>2<span class="token comment">#53(10.96.0.2)</span>
 <span class="token punctuation">;</span><span class="token punctuation">;</span> WHEN: Thu Nov 05 11:23:41 CST 2020
 <span class="token punctuation">;</span><span class="token punctuation">;</span> MSG SIZE  rcvd: 245
</code></pre>
    <pre><code class="prism language-powershell"> <span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl exec -it deploy-nginx-6c9764bb69-86gwj -- /bin/sh</span>
 <span class="token operator">/</span> <span class="token comment"># nslookup www.baidu.com</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 Name:      www<span class="token punctuation">.</span>baidu<span class="token punctuation">.</span>com
 Address 1: 14<span class="token punctuation">.</span>215<span class="token punctuation">.</span>177<span class="token punctuation">.</span>39
 Address 2: 14<span class="token punctuation">.</span>215<span class="token punctuation">.</span>177<span class="token punctuation">.</span>38
 
 
 <span class="token operator">/</span> <span class="token comment"># nslookup my-externalname.default.svc.cluster.local         </span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 Name:      my-externalname<span class="token punctuation">.</span>default<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local
 Address 1: 14<span class="token punctuation">.</span>215<span class="token punctuation">.</span>177<span class="token punctuation">.</span>38
 Address 2: 14<span class="token punctuation">.</span>215<span class="token punctuation">.</span>177<span class="token punctuation">.</span>39
</code></pre>
    <p>
     解析此
     <code>
      my-externalname.default.svc.cluster.local
     </code>
     域名和解析
     <code>
      www.baidu.com
     </code>
     是一样的结果
    </p>
    <h4>
     <a id="443__1063">
     </a>
     4.4.3 不同命名空间访问
    </h4>
    <p>
     1， 创建ns1命名空间和相关deploy, pod,service
    </p>
    <pre><code class="prism language-powershell"> <span class="token namespace">[root@master01 ~]</span><span class="token comment"># vim ns1-nginx.yml</span>
apiVersion: v1                                                  
kind: Namespace                                                 
metadata:                                                             
  name: ns1                                                     <span class="token comment"># 创建ns1命名空间</span>
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-nginx                    
  namespace: ns1                                                <span class="token comment"># 属于ns1命名空间</span>
spec:
  replicas: 1                                  
  selector:
    matchLabels:
      app: nginx                                
  template:                                        
    metadata:
      labels:
        app: nginx                             
    spec:
      containers:                              
      <span class="token operator">-</span> name: nginx
        image: nginx:1<span class="token punctuation">.</span>15-alpine
        imagePullPolicy: IfNotPresent
        ports:
        <span class="token operator">-</span> containerPort: 80
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Service
metadata:
  name: svc1                                <span class="token comment"># 服务名</span>
  namespace: ns1                            <span class="token comment"># 属于ns1命名空间</span>
spec:
  selector:
    app: nginx
  clusterIP: None                           <span class="token comment"># 无头service</span>
  ports:
  <span class="token operator">-</span> port: 80                         
    targetPort: 80                  
<span class="token operator">--</span><span class="token operator">-</span>
kind: Service
apiVersion: v1
metadata:
  name: external-svc1
  namespace: ns1                            <span class="token comment">#  属于ns1命名空间</span>
spec:
  <span class="token function">type</span>: ExternalName
  externalName: svc2<span class="token punctuation">.</span>ns2<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local   <span class="token comment"># 将ns2空间的svc2服务引入到ns1命名空间</span>
   
   
 <span class="token namespace">[root@master1 ~]</span><span class="token comment"># kubectl apply -f ns1-nginx.yml</span>
 namespace/ns1 created
 deployment<span class="token punctuation">.</span>apps/deploy-nginx created
 service/svc1 created
 
</code></pre>
    <p>
     2， 创建ns2命名空间和相关deploy, pod,service
    </p>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># vim ns1-nginx.yml</span>
apiVersion: v1                                                  
kind: Namespace                                                 
metadata:                                                             
  name: ns2                                                     <span class="token comment"># 创建ns2命名空间</span>
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deploy-nginx                    
  namespace: ns2                                                <span class="token comment"># 属于ns2命名空间</span>
spec:
  replicas: 1                                  
  selector:
    matchLabels:
      app: nginx                                
  template:                                        
    metadata:
      labels:
        app: nginx                             
    spec:
      containers:                              
      <span class="token operator">-</span> name: nginx
        image: nginx:1<span class="token punctuation">.</span>15-alpine
        imagePullPolicy: IfNotPresent
        ports:
        <span class="token operator">-</span> containerPort: 80
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Service
metadata:
  name: svc2                                <span class="token comment"># 服务名</span>
  namespace: ns2                            <span class="token comment"># 属于ns2命名空间</span>
spec:
  selector:
    app: nginx
  clusterIP: None                           <span class="token comment"># 无头service</span>
  ports:
  <span class="token operator">-</span> port: 80                         
    targetPort: 80                  
<span class="token operator">--</span><span class="token operator">-</span>
kind: Service
apiVersion: v1
metadata:
  name: external-svc1
  namespace: ns2                            <span class="token comment">#  属于ns2命名空间</span>
spec:
  <span class="token function">type</span>: ExternalName
  externalName: svc1<span class="token punctuation">.</span>ns1<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local   <span class="token comment"># 将ns1空间的svc1服务引入到ns2命名空间</span>
</code></pre>
    <pre><code class="prism language-powershell"> <span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl apply -f ns2-nginx.yml</span>
 namespace/ns2 created
 deployment<span class="token punctuation">.</span>apps/deploy-nginx created
 service/svc2 created
 service/external-svc2 created
</code></pre>
    <p>
     3, 在ns1命名空间的pod里验证
    </p>
    <pre><code class="prism language-powershell"> <span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get pods -n ns1</span>
 NAME                            READY   STATUS    RESTARTS   AGE
 deploy-nginx-6c9764bb69-g5xl8   1/1     Running   0          8m10s
</code></pre>
    <pre><code class="prism language-powershell"> <span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl exec -it -n ns1 deploy-nginx-6c9764bb69-g5xl8 -- /bin/sh</span>
 <span class="token operator">/</span> <span class="token comment"># nslookup svc1</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 Name:      svc1
 Address 1: 10<span class="token punctuation">.</span>3<span class="token punctuation">.</span>166<span class="token punctuation">.</span>140 deploy-nginx-6c9764bb69-g5xl8       IP与ns1里的podIP一致<span class="token punctuation">(</span>见下面的查询结果<span class="token punctuation">)</span>
 
 <span class="token operator">/</span> <span class="token comment"># nslookup svc2.ns2.svc.cluster.local</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 Name:      svc2<span class="token punctuation">.</span>ns2<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local
 Address 1: 10<span class="token punctuation">.</span>3<span class="token punctuation">.</span>104<span class="token punctuation">.</span>17 10-3-104-17<span class="token punctuation">.</span>svc2<span class="token punctuation">.</span>ns2<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local   IP与ns2里的podIP一致<span class="token punctuation">(</span>见下面的查询结果<span class="token punctuation">)</span>
 
 <span class="token operator">/</span> <span class="token comment"># exit</span>
 
</code></pre>
    <pre><code class="prism language-powershell"> <span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get pods -o wide -n ns1</span>
 NAME                            READY   STATUS    RESTARTS   AGE   IP             NODE             NOMINATED NODE   READINESS GATES
 deploy-nginx-6c9764bb69-g5xl8   1/1     Running   0          70m   10<span class="token punctuation">.</span>3<span class="token punctuation">.</span>166<span class="token punctuation">.</span>140   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>122<span class="token punctuation">.</span>13   &lt;none&gt;           &lt;none&gt;
 <span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get pods -o wide -n ns2</span>
 NAME                            READY   STATUS    RESTARTS   AGE   IP            NODE             NOMINATED NODE   READI            NESS GATES
 deploy-nginx-6c9764bb69-8psxl   1/1     Running   0          68m   10<span class="token punctuation">.</span>3<span class="token punctuation">.</span>104<span class="token punctuation">.</span>17   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>122<span class="token punctuation">.</span>14   &lt;none&gt;           &lt;none&gt;
 
</code></pre>
    <p>
     反之，在ns2命名空间的pod里访问
     <code>
      svc1.ns1.svc.cluster.local
     </code>
     ，解析的IP是ns1命名空间里的pod的IP(请自行验证)
    </p>
    <p>
     4， 验证ns2中的pod的IP变化, ns1中的pod仍然可以使用
     <code>
      svc2.ns2.svc.cluster.local
     </code>
     访问
    </p>
    <pre><code class="prism language-powershell"> <span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get pod -n ns2</span>
 NAME                            READY   STATUS    RESTARTS   AGE
 deploy-nginx-6c9764bb69-8psxl   1/1     Running   0          81m
 
 <span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl delete pod deploy-nginx-6c9764bb69-8psxl -n ns2</span>
 pod <span class="token string">"deploy-nginx-6c9764bb69-8psxl"</span> deleted                   因为有replicas控制器，所以删除pod会自动拉一个起来
 
 <span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get pod -o wide -n ns2</span>
 NAME                            READY   STATUS    RESTARTS   AGE     IP             NODE             NOMINATED NODE   READINESS GATES
 deploy-nginx-6c9764bb69-8qbz2   1/1     Running   0          5m36s   10<span class="token punctuation">.</span>3<span class="token punctuation">.</span>166<span class="token punctuation">.</span>141   192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>122<span class="token punctuation">.</span>13   &lt;none&gt;           &lt;none&gt;
 
 pod名称变了<span class="token punctuation">,</span>IP也变成了10<span class="token punctuation">.</span>3<span class="token punctuation">.</span>166<span class="token punctuation">.</span>141
</code></pre>
    <p>
     回到ns1中的pod验证
    </p>
    <pre><code class="prism language-powershell"> <span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl exec -it -n ns1 deploy-nginx-6c9764bb69-g5xl8 -- /bin/sh</span>
 
 <span class="token operator">/</span> <span class="token comment"># ping svc2.ns2.svc.cluster.local -c 2</span>
 PING svc2<span class="token punctuation">.</span>ns2<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local <span class="token punctuation">(</span>10<span class="token punctuation">.</span>3<span class="token punctuation">.</span>166<span class="token punctuation">.</span>141<span class="token punctuation">)</span>: 56 <span class="token keyword">data</span> bytes    解析的IP就是ns2中pod的新IP
 64 bytes <span class="token keyword">from</span> 10<span class="token punctuation">.</span>3<span class="token punctuation">.</span>166<span class="token punctuation">.</span>141: seq=0 ttl=63 time=0<span class="token punctuation">.</span>181 ms
 64 bytes <span class="token keyword">from</span> 10<span class="token punctuation">.</span>3<span class="token punctuation">.</span>166<span class="token punctuation">.</span>141: seq=1 ttl=63 time=0<span class="token punctuation">.</span>186 ms
 
 <span class="token operator">--</span><span class="token operator">-</span> svc2<span class="token punctuation">.</span>ns2<span class="token punctuation">.</span>svc<span class="token punctuation">.</span>cluster<span class="token punctuation">.</span>local ping statistics <span class="token operator">--</span><span class="token operator">-</span>
 2 packets transmitted<span class="token punctuation">,</span> 2 packets received<span class="token punctuation">,</span> 0% packet loss
 round-trip min/avg/max = 0<span class="token punctuation">.</span>181/0<span class="token punctuation">.</span>183/0<span class="token punctuation">.</span>186 ms
 <span class="token operator">/</span> <span class="token comment"># exit</span>
 
</code></pre>
    <h2>
     <a id="sessionAffinity_1276">
     </a>
     五、sessionAffinity
    </h2>
    <blockquote>
     <p>
      会话粘贴
     </p>
    </blockquote>
    <p>
     设置sessionAffinity为Clientip (类似nginx的ip_hash算法,lvs的sh算法)
    </p>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@nginx ~]</span><span class="token comment"># cat 02_create_deployment_app_nginx_with_service.yaml</span>
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-server1
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
     metadata:
       labels:
         app: nginx
     spec:
       containers:
       <span class="token operator">-</span> name: c1
         image: nginx:1<span class="token punctuation">.</span>15-alpine
         imagePullPolicy: IfNotPresent
         ports:
         <span class="token operator">-</span> containerPort: 80
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Service
metadata:
  name: nginx-svc
spec:
  <span class="token function">type</span>: ClusterIP
  ports:
  <span class="token operator">-</span> protocol: TCP
    port: 80
    targetPort: 80
  selector:
    app: nginx
</code></pre>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl apply -f 02_create_deployment_app_nginx_with_service.yaml</span>
deployment<span class="token punctuation">.</span>apps/nginx-server1 created
service/nginx-svc created
</code></pre>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get pods</span>
NAME                             READY   STATUS    RESTARTS   AGE
nginx-server1-58845f75f4-9zlnw   1/1     Running   0          2m11s
nginx-server1-58845f75f4-ffqdt   1/1     Running   0          2m11s
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl exec -it nginx-server1-58845f75f4-9zlnw bash</span>
kubectl exec <span class="token namespace">[POD]</span> <span class="token namespace">[COMMAND]</span> is DEPRECATED and will be removed in a future version<span class="token punctuation">.</span> Use kubectl kubectl exec <span class="token namespace">[POD]</span> <span class="token operator">--</span> <span class="token namespace">[COMMAND]</span> instead<span class="token punctuation">.</span>
root@nginx-server1-58845f75f4-9zlnw:<span class="token operator">/</span><span class="token comment"># echo web1 &gt; /usr/share/nginx/html/index.html</span>
root@nginx-server1-58845f75f4-9zlnw:<span class="token operator">/</span><span class="token comment"># exit</span>
<span class="token keyword">exit</span>
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl exec -it nginx-server1-58845f75f4-ffqdt bash</span>
kubectl exec <span class="token namespace">[POD]</span> <span class="token namespace">[COMMAND]</span> is DEPRECATED and will be removed in a future version<span class="token punctuation">.</span> Use kubectl kubectl exec <span class="token namespace">[POD]</span> <span class="token operator">--</span> <span class="token namespace">[COMMAND]</span> instead<span class="token punctuation">.</span>
root@nginx-server1-58845f75f4-ffqdt:<span class="token operator">/</span><span class="token comment"># echo web2 &gt; /usr/share/nginx/html/index.html</span>
root@nginx-server1-58845f75f4-ffqdt:<span class="token operator">/</span><span class="token comment"># exit</span>
<span class="token keyword">exit</span>
</code></pre>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get svc</span>
NAME         <span class="token function">TYPE</span>        CLUSTER-IP     EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
kubernetes   ClusterIP   10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1      &lt;none&gt;        443/TCP   16d
nginx-svc    ClusterIP   10<span class="token punctuation">.</span>100<span class="token punctuation">.</span>53<span class="token punctuation">.</span>31   &lt;none&gt;        80/TCP    3m53s
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># curl http://10.100.53.31</span>
web1
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># curl http://10.100.53.31</span>
web2
或
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># while true;do curl 10.100.53.31;sleep 1; done</span>
</code></pre>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl patch svc nginx-svc -p '{"spec":{"sessionAffinity":"ClientIP"}}'</span>
service/nginx-svc patched

<span class="token namespace">[root@master01 ~]</span><span class="token comment"># curl 10.100.53.31</span>
web1
多次访问<span class="token punctuation">,</span>会话粘贴
</code></pre>
    <pre><code class="prism language-powershell">设置回sessionAffinity为None
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl patch svc nginx-svc -p '{"spec":{"sessionAffinity":"None"}}'</span>
service/my-service patched

</code></pre>
    <pre><code class="prism language-powershell">测试
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># curl 10.100.53.31</span>
web1
多次访问<span class="token punctuation">,</span>回到负载均衡
或
<span class="token namespace">[root@master01 ~]</span><span class="token comment"># while true;do curl 10.100.53.31;sleep 1; done</span>
web1
多次访问<span class="token punctuation">,</span>会话粘贴

</code></pre>
    <h2>
     <a id="ipvs_1399">
     </a>
     六、修改为ipvs调度方式（拓展）
    </h2>
    <blockquote>
     <p>
      部署方式不同，修改方法不一样。
     </p>
     <p>
      本次主要介绍使用kubeadm部署集群方式，二进制部署较为简单。
     </p>
     <p>
      二进制部署修改：/etc/kubernetes/kube-proxy.yaml文件即可。
     </p>
    </blockquote>
    <p>
     从kubernetes1.8版本开始，新增了kube-proxy对ipvs的支持，在kubernetes1.11版本中被纳入了GA.
    </p>
    <h3>
     <a id="61_IPVS_1413">
     </a>
     6.1 修改为IPVS调度方式前升级内核
    </h3>
    <blockquote>
     <p>
      现使用Centos7u6发布版本，默认内核版本为3.10.0，使用kubernetes为1.18.0时，可升级内核版本至4.18.0或5.6.0版本。
     </p>
    </blockquote>
    <blockquote>
     <p>
      在所有节点中安装,需要重启操作系统更换内核。以下升级方法供参考。
     </p>
    </blockquote>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@localhost ~]</span><span class="token comment"># yum -y install perl</span>

<span class="token namespace">[root@localhost ~]</span><span class="token comment"># rpm --import https://www.elrepo.org/RPM-GPG-KEY-elrepo.org</span>

<span class="token namespace">[root@localhost ~]</span><span class="token comment"># yum -y install https://www.elrepo.org/elrepo-release-7.0-4.el7.elrepo.noarch.rpm</span>

<span class="token namespace">[root@localhost ~]</span><span class="token comment"># yum  --enablerepo="elrepo-kernel"  -y install kernel-ml.x86_64 </span>
此处升级为5<span class="token punctuation">.</span>0以上版本。

<span class="token namespace">[root@localhost ~]</span><span class="token comment"># grub2-set-default 0</span>

<span class="token namespace">[root@localhost ~]</span><span class="token comment"># grub2-mkconfig -o /boot/grub2/grub.cfg</span>

<span class="token namespace">[root@localhost ~]</span><span class="token comment"># reboot</span>
</code></pre>
    <h3>
     <a id="62_kubeproxy_1444">
     </a>
     6.2 修改kube-proxy的配置文件
    </h3>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl edit configmap kube-proxy -n kube-system</span>
     26     iptables:
     27       masqueradeAll: false
     28       masqueradeBit: 14
     29       minSyncPeriod: 0s
     30       syncPeriod: 30s
     31     ipvs:
     32       excludeCIDRs: null
     33       minSyncPeriod: 0s
     34       scheduler: <span class="token string">""</span>	  <span class="token comment"># 可以在这里修改ipvs的算法,默认为rr轮循算法</span>
     35       strictARP: false
     36       syncPeriod: 30s
     37     kind: KubeProxyConfiguration
     38     metricsBindAddress: 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:10249
     39     mode: <span class="token string">"ipvs"</span>	  <span class="token comment"># 默认""号里为空,加上ipvs</span>
</code></pre>
    <h3>
     <a id="63__kubesystemnamespacekubeproxypod_1466">
     </a>
     6.3 查看kube-system的namespace中kube-proxy有关的pod
    </h3>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get pods -n kube-system |grep kube-proxy</span>
kube-proxy-69mv6                           1/1     Running   6          2d18h
kube-proxy-jpc6c                           1/1     Running   4          4d16h
kube-proxy-kq65l                           1/1     Running   4          4d16h
kube-proxy-lmphf                           1/1     Running   5          4d16h
</code></pre>
    <h3>
     <a id="64_kubeproxyxxxpod_1478">
     </a>
     6.4 验证kube-proxy-xxx的pod中的信息
    </h3>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl logs kube-proxy-jpc6c -n kube-system</span>
W0517 00:55:10<span class="token punctuation">.</span>914754       1 server_others<span class="token punctuation">.</span>go:559<span class="token punctuation">]</span> Unknown proxy mode <span class="token string">""</span><span class="token punctuation">,</span> assuming iptables proxy
I0517 00:55:10<span class="token punctuation">.</span>923228       1 node<span class="token punctuation">.</span>go:136<span class="token punctuation">]</span> Successfully retrieved node IP: 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>122<span class="token punctuation">.</span>32
I0517 00:55:10<span class="token punctuation">.</span>923264       1 server_others<span class="token punctuation">.</span>go:186<span class="token punctuation">]</span> <span class="token keyword">Using</span> iptables Proxier<span class="token punctuation">.</span>
I0517 00:55:10<span class="token punctuation">.</span>923567       1 server<span class="token punctuation">.</span>go:583<span class="token punctuation">]</span> Version: v1<span class="token punctuation">.</span>18<span class="token punctuation">.</span>2
I0517 00:55:10<span class="token punctuation">.</span>923965       1 conntrack<span class="token punctuation">.</span>go:100<span class="token punctuation">]</span> <span class="token function">Set</span> sysctl <span class="token string">'net/netfilter/nf_conntrack_max'</span> to 131072
I0517 00:55:10<span class="token punctuation">.</span>924001       1 conntrack<span class="token punctuation">.</span>go:52<span class="token punctuation">]</span> Setting nf_conntrack_max to 131072
I0517 00:55:10<span class="token punctuation">.</span>924258       1 conntrack<span class="token punctuation">.</span>go:83<span class="token punctuation">]</span> Setting conntrack hashsize to 32768
I0517 00:55:10<span class="token punctuation">.</span>927041       1 conntrack<span class="token punctuation">.</span>go:100<span class="token punctuation">]</span> <span class="token function">Set</span> sysctl <span class="token string">'net/netfilter/nf_conntrack_tcp_timeout_established'</span> to 86400
I0517 00:55:10<span class="token punctuation">.</span>927086       1 conntrack<span class="token punctuation">.</span>go:100<span class="token punctuation">]</span> <span class="token function">Set</span> sysctl <span class="token string">'net/netfilter/nf_conntrack_tcp_timeout_close_wait'</span> to 3600
I0517 00:55:10<span class="token punctuation">.</span>927540       1 config<span class="token punctuation">.</span>go:315<span class="token punctuation">]</span> Starting service config controller
I0517 00:55:10<span class="token punctuation">.</span>927556       1 shared_informer<span class="token punctuation">.</span>go:223<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> caches to sync <span class="token keyword">for</span> service config
I0517 00:55:10<span class="token punctuation">.</span>927576       1 config<span class="token punctuation">.</span>go:133<span class="token punctuation">]</span> Starting endpoints config controller
I0517 00:55:10<span class="token punctuation">.</span>927594       1 shared_informer<span class="token punctuation">.</span>go:223<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> caches to sync <span class="token keyword">for</span> endpoints config
I0517 00:55:11<span class="token punctuation">.</span>027749       1 shared_informer<span class="token punctuation">.</span>go:230<span class="token punctuation">]</span> Caches are synced <span class="token keyword">for</span> service config
I0517 00:55:11<span class="token punctuation">.</span>027858       1 shared_informer<span class="token punctuation">.</span>go:230<span class="token punctuation">]</span> Caches are synced <span class="token keyword">for</span> endpoints config
</code></pre>
    <h3>
     <a id="65_kubeproxy_1501">
     </a>
     6.5 重新启动kube-proxy
    </h3>
    <blockquote>
     <p>
      删除kube-proxy-xxx的所有pod，让它重新拉取新的kube-proxy-xxx的pod
     </p>
    </blockquote>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl delete pod kube-proxy-69mv6 -n kube-system</span>
pod <span class="token string">"kube-proxy-69mv6"</span> deleted

<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl delete pod kube-proxy-jpc6c -n kube-system</span>
pod <span class="token string">"kube-proxy-jpc6c"</span> deleted

<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl delete pod kube-proxy-kq65l -n kube-system</span>
pod <span class="token string">"kube-proxy-kq65l"</span> deleted

<span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl delete pod kube-proxy-lmphf -n kube-system</span>
pod <span class="token string">"kube-proxy-lmphf"</span> deleted

</code></pre>
    <pre><code class="prism language-powershell"><span class="token namespace">[root@master01 ~]</span><span class="token comment"># kubectl get pods -n kube-system |grep kube-proxy</span>
kube-proxy-2mk2b                           1/1     Running   0          2m23s
kube-proxy-5bj87                           1/1     Running   0          30s
kube-proxy-7qq9l                           1/1     Running   0          52s
kube-proxy-tjtqf                           1/1     Running   0          80s

</code></pre>
    <pre><code class="prism language-powershell">随意查看其中1个或3个kube-proxy-xxx的pod<span class="token punctuation">,</span>验证是否为IPVS方式了

<span class="token namespace">[root@master1 ~]</span><span class="token comment"># kubectl logs kube-proxy-tjtqf -n kube-system</span>
I0517 02:32:26<span class="token punctuation">.</span>557696       1 node<span class="token punctuation">.</span>go:136<span class="token punctuation">]</span> Successfully retrieved node IP: 192<span class="token punctuation">.</span>168<span class="token punctuation">.</span>122<span class="token punctuation">.</span>32
I0517 02:32:26<span class="token punctuation">.</span>557745       1 server_others<span class="token punctuation">.</span>go:259<span class="token punctuation">]</span> <span class="token keyword">Using</span> ipvs Proxier<span class="token punctuation">.</span>
W0517 02:32:26<span class="token punctuation">.</span>557912       1 proxier<span class="token punctuation">.</span>go:429<span class="token punctuation">]</span> IPVS scheduler not specified<span class="token punctuation">,</span> use rr by default
I0517 02:32:26<span class="token punctuation">.</span>560008       1 server<span class="token punctuation">.</span>go:583<span class="token punctuation">]</span> Version: v1<span class="token punctuation">.</span>18<span class="token punctuation">.</span>2
I0517 02:32:26<span class="token punctuation">.</span>560428       1 conntrack<span class="token punctuation">.</span>go:52<span class="token punctuation">]</span> Setting nf_conntrack_max to 131072
I0517 02:32:26<span class="token punctuation">.</span>561094       1 config<span class="token punctuation">.</span>go:315<span class="token punctuation">]</span> Starting service config controller
I0517 02:32:26<span class="token punctuation">.</span>562251       1 shared_informer<span class="token punctuation">.</span>go:223<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> caches to sync <span class="token keyword">for</span> service config
I0517 02:32:26<span class="token punctuation">.</span>561579       1 config<span class="token punctuation">.</span>go:133<span class="token punctuation">]</span> Starting endpoints config controller
I0517 02:32:26<span class="token punctuation">.</span>562271       1 shared_informer<span class="token punctuation">.</span>go:223<span class="token punctuation">]</span> Waiting <span class="token keyword">for</span> caches to sync <span class="token keyword">for</span> endpoints config
I0517 02:32:26<span class="token punctuation">.</span>662541       1 shared_informer<span class="token punctuation">.</span>go:230<span class="token punctuation">]</span> Caches are synced <span class="token keyword">for</span> service config
I0517 02:32:26<span class="token punctuation">.</span>662566       1 shared_informer<span class="token punctuation">.</span>go:230<span class="token punctuation">]</span> Caches are synced <span class="token keyword">for</span> endpoints config
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f67:2e6373646e2e6e65742f466f7262696464656e5f436974792f:61727469636c652f64657461696c732f313436313239313336" class_="artid" style="display:none">
 </p>
</div>


