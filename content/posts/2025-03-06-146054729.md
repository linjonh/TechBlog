---
layout: post
title: "ORB-SLAM2源码学习六相机跟踪局部地图跟踪和关键帧创建"
date: 2025-03-06 00:04:36 +0800
description: "目录1.局部地图跟踪1.1 更新局部关键帧UpdateLocalKeyFrames1.2 更新局部地图点（来自局部关键帧）UpdateLocalPoints()1.3 投影匹配2. 对比四种跟踪方式以及使用的投影匹配3.关键帧创建3.1 判断是否需要创建新关键帧: NeedNewKeyFrame()3.2 关键帧的创建CreateNewKeyFrame()当初始位姿估计成功（参考关键帧来跟踪、恒速模型跟踪、重定位跟踪跟踪成功）后需要进行局部地图跟踪TrackLocalMap()。初始位姿估计只是跟踪一帧得到"
keywords: "slam 局部地图跟踪的作用是什么"
categories: ['Slam']
tags: ['C']
artid: "146054729"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146054729
    alt: "ORB-SLAM2源码学习六相机跟踪局部地图跟踪和关键帧创建"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146054729
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146054729
cover: https://bing.ee123.net/img/rand?artid=146054729
image: https://bing.ee123.net/img/rand?artid=146054729
img: https://bing.ee123.net/img/rand?artid=146054729
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ORB-SLAM2源码学习（六）：相机跟踪（局部地图跟踪和关键帧创建）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <hr id="hr-toc" name="tableOfContents"/>
    <p>
    </p>
    <h2 id="1.%E5%B1%80%E9%83%A8%E5%9C%B0%E5%9B%BE%E8%B7%9F%E8%B8%AA" name="1.%E5%B1%80%E9%83%A8%E5%9C%B0%E5%9B%BE%E8%B7%9F%E8%B8%AA">
     1.局部地图跟踪
    </h2>
    <p>
     当
     <strong>
      初始位姿估计
     </strong>
     成功（
     <strong>
      参考关键帧来跟踪、恒速模型跟踪、重定位跟踪跟踪成功
     </strong>
     ）后需要进行局部地图跟踪
     <span style="color:#fe2c24">
      TrackLocalMap()
     </span>
     。
    </p>
    <p>
     <strong>
      初始位姿估计
     </strong>
     只是跟踪一帧得到初始位姿，
     <span style="color:#fe2c24">
      <strong>
       局部地图跟踪
      </strong>
     </span>
     搜索局部关键帧、局部地图点，和当前帧进行投影匹配，得到更多匹配的MapPoints后进行位姿优化。
    </p>
    <pre><code class="language-cpp">bOK = TrackLocalMap();  </code></pre>
    <p>
     <strong>
      具体流程
     </strong>
     ：
    </p>
    <ol>
     <li>
      更新局部地图，包括局部关键帧和地图点;
      <span style="color:#fe2c24">
       UpdateLocalKeyFrames() UpdateLocalPoints()
      </span>
     </li>
     <li>
      对局部MapPoints进行投影匹配
      <span style="color:#fe2c24">
       SearchLocalPoints()
      </span>
     </li>
     <li>
      BA优化位姿（和初始位姿估计调用优化函数相同）
     </li>
    </ol>
    <h3 id="1.1%C2%A0%E6%9B%B4%E6%96%B0%E5%B1%80%E9%83%A8%E5%85%B3%E9%94%AE%E5%B8%A7UpdateLocalKeyFrames" name="1.1%C2%A0%E6%9B%B4%E6%96%B0%E5%B1%80%E9%83%A8%E5%85%B3%E9%94%AE%E5%B8%A7UpdateLocalKeyFrames">
     1.1 更新局部关键帧UpdateLocalKeyFrames
    </h3>
    <p>
     <img alt="" height="816" src="https://i-blog.csdnimg.cn/direct/85d5b4a59b2d41eda86d11799508f5a1.png" width="1248"/>
    </p>
    <ul>
     <li>
      <strong>
       一级共视关键帧
      </strong>
      ：KF1、KF2是F的一级共视关键帧
     </li>
     <li>
      <strong>
       二级共视关键帧
      </strong>
      ：KF1、KF2的共视关键帧(虚线框内)是F的二级共视关键帧
     </li>
     <li>
      <strong>
       当前帧
      </strong>
      ：mCurrentFrame
     </li>
     <li>
      <strong>
       参考关键帧
      </strong>
      : 与当前帧共视程度最高的关键帧作为参考关键帧，mCurrentFrame.mpReferenceKF 在KeyFrame::UpdateConnections() 里确定关键帧的父子关系
     </li>
     <li>
      <strong>
       父关键帧
      </strong>
      ：和当前关键帧共视程度最高的关键帧
     </li>
     <li>
      <strong>
       子关键帧
      </strong>
      ：是上述父关键帧的子关键帧
     </li>
    </ul>
    <p>
     <span style="color:#fe2c24">
      <strong>
       局部关键帧的组成
      </strong>
     </span>
     ：
    </p>
    <ol>
     <li>
      当前地图点的所有共视关键帧（邻居）。
     </li>
     <li>
      1中所有关键帧共视关系前10大的共视关键帧（邻居的邻居）。
     </li>
     <li>
      1中所有关键帧的父子关键帧（邻居的父母和孩子）。
     </li>
    </ol>
    <p>
     最后将与当前帧共视关系最强的关键帧设为参考关键帧mpReferenceKF
    </p>
    <h3 id="1.2%20%E6%9B%B4%E6%96%B0%E5%B1%80%E9%83%A8%E5%9C%B0%E5%9B%BE%E7%82%B9%EF%BC%88%E6%9D%A5%E8%87%AA%E5%B1%80%E9%83%A8%E5%85%B3%E9%94%AE%E5%B8%A7%EF%BC%89UpdateLocalPoints()" name="1.2%20%E6%9B%B4%E6%96%B0%E5%B1%80%E9%83%A8%E5%9C%B0%E5%9B%BE%E7%82%B9%EF%BC%88%E6%9D%A5%E8%87%AA%E5%B1%80%E9%83%A8%E5%85%B3%E9%94%AE%E5%B8%A7%EF%BC%89UpdateLocalPoints()">
     1.2 更新局部地图点（来自局部关键帧）UpdateLocalPoints()
    </h3>
    <p>
     <span style="color:#fe2c24">
      局部关键帧能够观测到的所有地图点
     </span>
     ，称为局部地图点。
    </p>
    <h3 id="1.3%20%E6%8A%95%E5%BD%B1%E5%8C%B9%E9%85%8D" name="1.3%20%E6%8A%95%E5%BD%B1%E5%8C%B9%E9%85%8D">
     1.3 投影匹配
    </h3>
    <p>
     将局部地图点进行投影匹配，得到更多的匹配关系(
     <strong>
      目的
     </strong>
     )。注意，局部地图点中已经是当前帧地图点的不需要再投影，只需要将此外的并且在视野范围内的点和当前帧进行投影匹配。
    </p>
    <p>
     <strong>
      具体流程
     </strong>
     ：
    </p>
    <ol>
     <li>
      遍历当前帧的地图点，标记这些地图点不参与之后的投影搜索匹配；
     </li>
     <li>
      判断所有局部地图点中除当前帧地图点外的点，是否在当前帧视野范围内；（是否在视野范围内有个单独函数
      <span style="color:#fe2c24">
       isInFrustum()
      </span>
      ）
     </li>
     <li>
      如果需要进行投影匹配的点的数目大于0，就进行投影匹配，增加更多的匹配关系。
      <span style="color:#fe2c24">
       SearchByProjection()
      </span>
     </li>
    </ol>
    <h2 id="" name="">
     2. 对比四种跟踪方式以及使用的投影匹配
    </h2>
    <p>
     ①
     <strong>
      参考关键帧跟踪
     </strong>
    </p>
    <p>
     通过
     <span style="color:#fe2c24">
      词袋模型
     </span>
     计算参考关键帧和当前帧的
     <strong>
      <span style="color:#4da8ee">
       匹配特征点
      </span>
      （
      <span style="color:#fe2c24">
       没有用投影匹配
      </span>
      ）
     </strong>
     ，上一帧的位姿作为
     <span style="color:#4da8ee">
      <strong>
       当前帧的初始位姿
      </strong>
     </span>
     ，然后进行BA求两帧之间的位姿变换。
    </p>
    <p>
     <strong>
      应用场景
     </strong>
     ：没有速度信息的时候、刚完成重定位、或者恒速模型跟踪失败后使用，大部分时间不用。只利用到了参考帧的信息（
     <span style="color:#fe2c24">
      本质上是尝试和最近一个关键帧去做匹配
     </span>
     ）。
    </p>
    <p>
     <img alt="" height="206" src="https://i-blog.csdnimg.cn/direct/1f5dd58f7404477b9b8cd63d34cb21c2.png" width="376"/>
    </p>
    <p>
     <strong>
      ②恒速模型跟踪
     </strong>
    </p>
    <p>
     首先根据上上帧到上一帧的位姿，把上一帧的特征点像素坐标映射到当前帧，然后在映射后结果坐标周围进行搜索，找到与之
     <span style="color:#4da8ee">
      <strong>
       匹配的特征点
      </strong>
     </span>
     ；根据速度得到
     <span style="color:#4da8ee">
      <strong>
       当前帧的初始位姿
      </strong>
     </span>
     ，然后进行BA求两帧之间的位姿变换。
    </p>
    <p>
     使用了
     <span style="color:#fe2c24">
      <strong>
       投影匹配
      </strong>
     </span>
     ，由于恒速模型可以计算当前帧相对于上一帧的平移向量，根据相机的前进/后退来约束
     <strong>
      <span style="color:#4da8ee">
       搜索尺度范围
      </span>
     </strong>
     （在投影点多大的范围内进行匹配）。此外它是对
     <span style="color:null">
      上一帧的有效地图点（过滤外点）
     </span>
     进行投影的。
    </p>
    <p>
     <strong>
      投影匹配流程
     </strong>
     ：1. 计算帧间平移 → 2. 投影上一帧地图点 → 3. 运动方向约束搜索尺度 → 4. 匹配并记录角度差 → 5. 旋转直方图剔除
    </p>
    <blockquote>
     <p>
      <strong>
       尺度范围
      </strong>
      ：
     </p>
     <p>
      在进行投影匹配的时候会给定特征点的搜索范围,考虑到处于不同尺度(也就是距离相机远近,位于图像金字塔中不同图层)的特征点受到相机旋转的影响不同，因此会希望距离相机近的点的搜索范围更大一点,距离相机更远的点的搜索范围更小一点,所以要在这里,根据点到关键帧/帧的距离来估计它在当前的关键帧/帧中，会大概处于哪个尺度。
     </p>
    </blockquote>
    <p>
     <strong>
      应用场景
     </strong>
    </p>
    <p>
     大部分时间都用这个跟踪，只利用到了上一帧的信息。
    </p>
    <p>
     <img alt="" height="276" src="https://i-blog.csdnimg.cn/direct/90ab538cbca742b2a8ae0eb26ad10706.png" width="437"/>
    </p>
    <p>
     <strong>
      ③重定位
     </strong>
    </p>
    <p>
     当TrackWithMotionModel 和 TrackReferenceKeyFrame 都没有跟踪成功，位置丢失后，需要在之前的关键帧中
     <strong>
      匹配相近的关键帧
     </strong>
     ，然后使用3D-2D匹配点的
     <strong>
      EPnP算法求
      <span style="color:#4da8ee">
       初始位姿
      </span>
     </strong>
     ，之后再使用BA来优化位姿。
    </p>
    <p>
     <strong>
      具体而言：
     </strong>
     用词袋找到与当前帧相似的候选关键帧（可能找到多个），再然后通过BoW加速计算每一个候选关键帧和当前帧的
     <span style="color:#4da8ee">
      <strong>
       匹配特征点
      </strong>
     </span>
     （这个过程和 参考关键帧跟踪中当前帧和参考帧匹配特征点一样），使用EPnP依次求
     <strong>
      <span style="color:#4da8ee">
       初始位姿
      </span>
      。
     </strong>
     每个位姿结果使用BA优化，选择内点数量大于50的作为初始位姿。
    </p>
    <p>
     如果内点数量不够多呢？就通过
     <span style="color:#fe2c24">
      <strong>
       投影匹配
      </strong>
     </span>
     方式对之前
     <span style="color:#fe2c24">
      未匹配
     </span>
     的点进行匹配，再进行BA优化求解。由于进行重定位，上一帧没有意义，
     <span style="color:null">
      基于
     </span>
     <span style="color:#4da8ee">
      <strong>
       地图点距离预测尺度范围
      </strong>
     </span>
     。
    </p>
    <p>
     <strong>
      投影匹配流程
     </strong>
     ：1. 遍历局部关键帧地图点 → 2. 过滤已匹配点 → 3. 投影并预测尺度 → 4. 多层级搜索 → 5. 最佳匹配筛选 → 6. 旋转直方图剔除
    </p>
    <p>
     <strong>
      ④局部地图跟踪
     </strong>
    </p>
    <p>
     搜索
     <strong>
      局部关键帧、局部地图点
     </strong>
     ，和当前帧进行
     <span style="color:#fe2c24">
      投影匹配
     </span>
     ，得到更多匹配的地图点后进行位姿优化，
     <span style="color:#4da8ee">
      <strong>
       初始位姿
      </strong>
     </span>
     根据前面三种方法计算的到。
    </p>
    <p>
     <strong>
      具体而言
     </strong>
     ：根据当前帧的地图点来找能观测到当前帧的一级共视关键帧，将这些一级共视关键帧的二级关键共视帧、子关键帧、父关键帧一起作为
     <strong>
      局部关键帧；
     </strong>
     局部关键帧中所有的地图点作为
     <strong>
      局部地图点
     </strong>
     ；局部地图点（
     <strong>
      去掉当前帧的地图点 和 不在当前帧视野范围内无效的地图点
     </strong>
     ）投影到当前帧进行
     <strong>
      <span style="color:#4da8ee">
       特征点匹配
      </span>
     </strong>
     ，匹配结果进行BA优化。
    </p>
    <p>
     <span style="color:#fe2c24">
      投影匹配
     </span>
     的时候通过视角余弦（
     <code>
      RadiusByViewingCos
     </code>
     ）和预测尺度（
     <code>
      nPredictedLevel
     </code>
     ）调整搜索
     <strong>
      <span style="color:#4da8ee">
       尺度范围。
      </span>
     </strong>
    </p>
    <p>
     <span style="color:#fe2c24">
      <strong>
       总结
      </strong>
     </span>
     ：
    </p>
    <p>
     <strong>
      四种跟踪方式对比
     </strong>
     ：
    </p>
    <p>
     相同点：本质上都是计算匹配点对以及初始位姿，然后使用BA进行位姿优化。
    </p>
    <p>
     不同点：
     <strong>
      求解匹配特征点方法
     </strong>
     <strong>
      和
     </strong>
     <strong>
      当前帧的初始位姿设置不同
     </strong>
    </p>
    <ul>
     <li>
      参考关键帧跟踪通过BoW计算当前帧和参考关键帧的匹配点对；初始位姿使用上一帧的位姿；
     </li>
     <li>
      恒速运动模型通过投影匹配计算匹配点对；初始位姿通过速度（这里的速度是上一帧到当前帧的位姿Tcl）确定；
     </li>
     <li>
      重定位 通过BoW计算每一个相似关键帧和当前帧 的匹配点对；初始位姿通过EPnP计算；
     </li>
     <li>
      局部地图跟踪是将 局部地图点（来自局部关键帧）投影到当前帧计算匹配点对；初始位姿由前面三种方法确定。
     </li>
    </ul>
    <h2 id="3.%E5%85%B3%E9%94%AE%E5%B8%A7%E6%8F%92%E5%85%A5" name="3.%E5%85%B3%E9%94%AE%E5%B8%A7%E6%8F%92%E5%85%A5">
     3.关键帧创建
    </h2>
    <p>
     <strong>
      关键帧是取局部相近帧中最有代表性的一帧
     </strong>
    </p>
    <p>
     选取的指标主要有：
    </p>
    <ol>
     <li>
      <span style="color:#fe2c24">
       <strong>
        距离上一关键帧的帧数是否足够多（时间）
       </strong>
      </span>
      。比如我每隔固定帧数选择一个关键帧，这样编程简单但效果不好。比如运动很慢的时候，就会选择大量相似的关键帧，冗余，运动快的时候又丢失了很多重要的帧。
     </li>
     <li>
      <span style="color:#fe2c24">
       <strong>
        距离最近关键帧的距离是否足够远（空间）/运动
       </strong>
      </span>
      。比如相邻帧根据pose计算运动的相对大小，可以是位移也可以是旋转或者两个都考虑，运动足够大（超过一定阈值）就新建一个关键帧，这种方法比第一种好。但问题是如果对着同一个物体来回扫就会出现大量相似关键帧。
     </li>
     <li>
      <span style="color:#fe2c24">
       <strong>
        跟踪局部地图质量（共视特征点数目）
       </strong>
      </span>
      。记录当前视角下跟踪的特征点数或者比例，当相机离开当前场景时（双目或比例明显降低）才会新建关键帧，避免了第2种方法的问题。缺点是数据结构和逻辑比较复杂。
     </li>
    </ol>
    <pre><code class="language-cpp">if(NeedNewKeyFrame())
    CreateNewKeyFrame();</code></pre>
    <h3 id="3.1%20%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E5%88%9B%E5%BB%BA%E6%96%B0%E5%85%B3%E9%94%AE%E5%B8%A7%3A%20NeedNewKeyFrame()" name="3.1%20%E5%88%A4%E6%96%AD%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E5%88%9B%E5%BB%BA%E6%96%B0%E5%85%B3%E9%94%AE%E5%B8%A7%3A%20NeedNewKeyFrame()">
     3.1 判断是否需要创建新关键帧: NeedNewKeyFrame()
    </h3>
    <p>
     是否生成关键帧,需要考虑以下几个方面:
    </p>
    <ol>
     <li>
      最近是否进行过重定位，重定位后位姿不会太准，不适合做参考帧；
     </li>
     <li>
      当前系统的工作状态: 如果LocalMapping线程还有很多KeyFrame没处理的话,不适合再给它增加负担了；
     </li>
     <li>
      距离上次创建关键帧经过的时间: 如果很长时间没创建关键帧了的话,就要抓紧创建关键帧了；
     </li>
     <li>
      当前帧的质量: 当前帧观测到的地图点要足够多，同时与参考关键帧的重合程度不能太大。
     </li>
    </ol>
    <h3 id="3.2%20%E5%85%B3%E9%94%AE%E5%B8%A7%E7%9A%84%E5%88%9B%E5%BB%BACreateNewKeyFrame()" name="3.2%20%E5%85%B3%E9%94%AE%E5%B8%A7%E7%9A%84%E5%88%9B%E5%BB%BACreateNewKeyFrame()">
     3.2 关键帧的创建CreateNewKeyFrame()
    </h3>
    <p>
     <strong>
      注
     </strong>
     ：双目和RGBD创建新的地图点，单目不会（单帧没有尺度）
    </p>
    <p>
     <strong>
      具体流程
     </strong>
     ：
    </p>
    <ol>
     <li>
      将当前帧构造成关键帧；
     </li>
     <li>
      将当前关键帧设置为当前帧的参考关键帧；
     </li>
     <li>
      对于双目或rgbd摄像头，为当前帧生成新的地图点；单目无操作；
     </li>
     <li>
      关键帧插入到链表 mlNewKeyFrames中，等待local mapping线程处理
     </li>
    </ol>
    <p>
    </p>
    <p>
     <strong>
      思维导图
     </strong>
     ：
    </p>
    <p>
     <img alt="" height="434" src="https://i-blog.csdnimg.cn/direct/83862c69bc8745cca887b77057391283.png" width="1413"/>
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34313435313730322f:61727469636c652f64657461696c732f313436303534373239" class_="artid" style="display:none">
 </p>
</div>


