---
layout: post
title: "HeadFirst系列之HeadFirst设计模式第18天之蝇量模式Flyweight-Pattern优化资源的秘密武器"
date: 2025-03-08 13:48:54 +0800
description: "在软件开发中，当系统需要创建大量相似对象时，内存占用和性能问题就会浮出水面。，这是一种优化对象复用的结构型设计模式，旨在减少对象创建的内存开销。本文将深入剖析蝇量模式的核心内容，并结合。如果每棵树都是一个独立的对象，并存储所有属性，那么。：如果对象的外部状态过多，模式的优势就会减少。机制复用字符串对象，避免重复创建。：避免重复创建对象，优化资源利用。：通过对象共享，降低内存消耗。复用小整数，减少对象创建。：共享对象需要考虑并发访问。：需要管理对象池和工厂。：如缓存、池化对象等。，导致应用性能下降。"
keywords: "【HeadFirst系列之HeadFirst设计模式】第18天之蝇量模式（Flyweight Pattern）：优化资源的秘密武器"
categories: ['系统设计', 'Headfirst', 'Headfirst']
tags: ['设计模式', '蝇量模式']
artid: "146115340"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146115340
    alt: "HeadFirst系列之HeadFirst设计模式第18天之蝇量模式Flyweight-Pattern优化资源的秘密武器"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146115340
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146115340
cover: https://bing.ee123.net/img/rand?artid=146115340
image: https://bing.ee123.net/img/rand?artid=146115340
img: https://bing.ee123.net/img/rand?artid=146115340
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【HeadFirst系列之HeadFirst设计模式】第18天之蝇量模式（Flyweight Pattern）：优化资源的秘密武器
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="Flyweight_Pattern_0">
     </a>
     <strong>
      蝇量模式（Flyweight Pattern）：优化资源的秘密武器
     </strong>
    </h2>
    <p>
     在软件开发中，当系统需要创建大量相似对象时，内存占用和性能问题就会浮出水面。《Head First 设计模式》介绍了
     <strong>
      蝇量模式（Flyweight Pattern）
     </strong>
     ，这是一种优化对象复用的结构型设计模式，旨在减少对象创建的内存开销。本文将深入剖析蝇量模式的核心内容，并结合
     <strong>
      JDK 和 Spring 框架中的应用
     </strong>
     进行实践探讨。
    </p>
    <hr/>
    <h3>
     <a id="1__6">
     </a>
     <strong>
      1. 遇到什么问题？
     </strong>
    </h3>
    <h4>
     <a id="_7">
     </a>
     <strong>
      场景：大量重复对象导致内存占用过高
     </strong>
    </h4>
    <p>
     假设我们要开发一款绘图应用，支持绘制大量的“树木”对象，每棵树都有以下属性：
    </p>
    <ul>
     <li>
      <strong>
       内部状态（Intrinsic State）：
      </strong>
      颜色、树种、形状等，所有相同种类的树共享相同的属性。
     </li>
     <li>
      <strong>
       外部状态（Extrinsic State）：
      </strong>
      坐标（X、Y）、环境信息等，每棵树的位置信息不同。
     </li>
    </ul>
    <p>
     如果每棵树都是一个独立的对象，并存储所有属性，那么
     <strong>
      上千棵树可能会占用大量内存
     </strong>
     ，导致应用性能下降。
    </p>
    <hr/>
    <h3>
     <a id="2__16">
     </a>
     <strong>
      2. 怎么解决？
     </strong>
    </h3>
    <h4>
     <a id="_17">
     </a>
     <strong>
      引入蝇量模式
     </strong>
    </h4>
    <p>
     蝇量模式的核心思想是
     <strong>
      将共享部分（内部状态）抽取出来，避免不必要的重复存储，而唯一的不同信息（外部状态）由客户端传递。
     </strong>
     <br/>
     这样，
     <strong>
      相同种类的树可以复用同一个对象
     </strong>
     ，而位置信息等变化属性则由外部提供。
    </p>
    <h4>
     <a id="_21">
     </a>
     <strong>
      核心设计
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       Flyweight（蝇量对象）：
      </strong>
      共享的对象，包含内部状态。
     </li>
     <li>
      <strong>
       FlyweightFactory（工厂类）：
      </strong>
      负责管理和复用 Flyweight 对象，确保相同的对象不会重复创建。
     </li>
     <li>
      <strong>
       Client（客户端）：
      </strong>
      负责存储外部状态，并在需要时从工厂获取共享对象。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="3__28">
     </a>
     <strong>
      3. 代码实现
     </strong>
    </h3>
    <p>
     我们以“绘制森林中的树木”为例，使用
     <strong>
      Java 代码
     </strong>
     实现蝇量模式：
    </p>
    <h4>
     <a id="1_Flyweight__32">
     </a>
     <strong>
      （1）创建 Flyweight 接口
     </strong>
    </h4>
    <pre><code class="prism language-java"><span class="token comment">// 蝇量接口，定义共享方法</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">TreeFlyweight</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">void</span> <span class="token function">display</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 外部状态由方法参数传入</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="2_Flyweight__40">
     </a>
     <strong>
      （2）具体的 Flyweight 类
     </strong>
    </h4>
    <pre><code class="prism language-java"><span class="token comment">// 具体的树对象，包含共享的内部状态</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Tree</span> <span class="token keyword">implements</span> <span class="token class-name">TreeFlyweight</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>  <span class="token comment">// 树的种类</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> color<span class="token punctuation">;</span> <span class="token comment">// 颜色</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> texture<span class="token punctuation">;</span> <span class="token comment">// 纹理</span>

    <span class="token keyword">public</span> <span class="token class-name">Tree</span><span class="token punctuation">(</span><span class="token class-name">String</span> type<span class="token punctuation">,</span> <span class="token class-name">String</span> color<span class="token punctuation">,</span> <span class="token class-name">String</span> texture<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>color <span class="token operator">=</span> color<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>texture <span class="token operator">=</span> texture<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">display</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"绘制 "</span> <span class="token operator">+</span> type <span class="token operator">+</span> <span class="token string">" 树，颜色: "</span> <span class="token operator">+</span> color <span class="token operator">+</span> <span class="token string">"，纹理: "</span> <span class="token operator">+</span> texture <span class="token operator">+</span> <span class="token string">"，位置: ("</span> <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> y <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="3_FlyweightFactory__61">
     </a>
     <strong>
      （3）创建 FlyweightFactory 负责管理共享对象
     </strong>
    </h4>
    <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>

<span class="token comment">// 工厂类，管理共享对象</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TreeFactory</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">TreeFlyweight</span><span class="token punctuation">&gt;</span></span> treeCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">TreeFlyweight</span> <span class="token function">getTree</span><span class="token punctuation">(</span><span class="token class-name">String</span> type<span class="token punctuation">,</span> <span class="token class-name">String</span> color<span class="token punctuation">,</span> <span class="token class-name">String</span> texture<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> type <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> color <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> texture<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>treeCache<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            treeCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Tree</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> color<span class="token punctuation">,</span> texture<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"创建新树对象："</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"复用已有树对象："</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> treeCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="4_Flyweight_83">
     </a>
     <strong>
      （4）客户端使用 Flyweight
     </strong>
    </h4>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FlyweightPatternDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建多个树对象，但只会创建必要的不同种类树，其他复用</span>
        <span class="token class-name">TreeFlyweight</span> tree1 <span class="token operator">=</span> <span class="token class-name">TreeFactory</span><span class="token punctuation">.</span><span class="token function">getTree</span><span class="token punctuation">(</span><span class="token string">"Oak"</span><span class="token punctuation">,</span> <span class="token string">"Green"</span><span class="token punctuation">,</span> <span class="token string">"Smooth"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tree1<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TreeFlyweight</span> tree2 <span class="token operator">=</span> <span class="token class-name">TreeFactory</span><span class="token punctuation">.</span><span class="token function">getTree</span><span class="token punctuation">(</span><span class="token string">"Oak"</span><span class="token punctuation">,</span> <span class="token string">"Green"</span><span class="token punctuation">,</span> <span class="token string">"Smooth"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tree2<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TreeFlyweight</span> tree3 <span class="token operator">=</span> <span class="token class-name">TreeFactory</span><span class="token punctuation">.</span><span class="token function">getTree</span><span class="token punctuation">(</span><span class="token string">"Pine"</span><span class="token punctuation">,</span> <span class="token string">"Dark Green"</span><span class="token punctuation">,</span> <span class="token string">"Rough"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        tree3<span class="token punctuation">.</span><span class="token function">display</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="5_100">
     </a>
     <strong>
      （5）运行结果
     </strong>
    </h4>
    <pre><code class="prism language-plaintext">创建新树对象：Oak-Green-Smooth
绘制 Oak 树，颜色: Green，纹理: Smooth，位置: (10,20)
复用已有树对象：Oak-Green-Smooth
绘制 Oak 树，颜色: Green，纹理: Smooth，位置: (30,40)
创建新树对象：Pine-Dark Green-Rough
绘制 Pine 树，颜色: Dark Green，纹理: Rough，位置: (50,60)
</code></pre>
    <p>
     <strong>
      说明：
     </strong>
    </p>
    <ul>
     <li>
      <code>
       Oak-Green-Smooth
      </code>
      只创建了一次，后续直接复用。
     </li>
     <li>
      <code>
       Pine-Dark Green-Rough
      </code>
      由于是新的类型，所以创建新的对象。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="4__115">
     </a>
     <strong>
      4. 蝇量模式的应用场景
     </strong>
    </h3>
    <h4>
     <a id="1JDK__116">
     </a>
     <strong>
      （1）JDK 中的应用
     </strong>
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        Java String 常量池：
       </strong>
      </p>
      <pre><code class="prism language-java"><span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>
<span class="token class-name">String</span> s2 <span class="token operator">=</span> <span class="token string">"hello"</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1 <span class="token operator">==</span> s2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true（字符串池复用）</span>
</code></pre>
      <p>
       JDK 采用
       <strong>
        字符串池（String Pool）
       </strong>
       机制复用字符串对象，避免重复创建。
      </p>
     </li>
     <li>
      <p>
       <strong>
        Integer.valueOf() 复用小整数对象（-128 ~ 127）：
       </strong>
      </p>
      <pre><code class="prism language-java"><span class="token class-name">Integer</span> a <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Integer</span> b <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>a <span class="token operator">==</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true（缓存复用）</span>
</code></pre>
      <p>
       JDK 通过
       <code>
        IntegerCache
       </code>
       复用小整数，减少对象创建。
      </p>
     </li>
    </ul>
    <h4>
     <a id="2Spring__133">
     </a>
     <strong>
      （2）Spring 框架中的应用
     </strong>
    </h4>
    <ul>
     <li>
      <p>
       <strong>
        Spring Bean 作用域（Scope）中的单例模式
       </strong>
      </p>
      <ul>
       <li>
        默认情况下，Spring 管理的 Bean 是
        <strong>
         单例模式
        </strong>
        ，所有请求共享同一个 Bean 实例，相当于全局的蝇量对象。
       </li>
       <li>
        例如：
        <pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Scope</span><span class="token punctuation">(</span><span class="token string">"singleton"</span><span class="token punctuation">)</span> <span class="token comment">// 只创建一个实例</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SingletonService</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>
</code></pre>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        Spring MVC 中的视图对象复用
       </strong>
      </p>
      <ul>
       <li>
        视图解析器会复用
        <code>
         View
        </code>
        对象，避免重复创建。
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="5__148">
     </a>
     <strong>
      5. 蝇量模式的优缺点
     </strong>
    </h3>
    <h4>
     <a id="_149">
     </a>
     <strong>
      优点
     </strong>
    </h4>
    <p>
     ✅
     <strong>
      减少内存占用
     </strong>
     ：通过对象共享，降低内存消耗。
     <br/>
     ✅
     <strong>
      提高性能
     </strong>
     ：避免重复创建对象，优化资源利用。
     <br/>
     ✅
     <strong>
      适用于大量重复对象的场景
     </strong>
     ：如缓存、池化对象等。
    </p>
    <h4>
     <a id="_154">
     </a>
     <strong>
      缺点
     </strong>
    </h4>
    <p>
     ❌
     <strong>
      引入了额外的管理逻辑
     </strong>
     ：需要管理对象池和工厂。
     <br/>
     ❌
     <strong>
      可能导致线程安全问题
     </strong>
     ：共享对象需要考虑并发访问。
     <br/>
     ❌
     <strong>
      不适用于对象状态差异很大的场景
     </strong>
     ：如果对象的外部状态过多，模式的优势就会减少。
    </p>
    <hr/>
    <h3>
     <a id="6__161">
     </a>
     <strong>
      6. 总结
     </strong>
    </h3>
    <ul>
     <li>
      <strong>
       蝇量模式通过共享对象，减少系统资源开销，优化性能。
      </strong>
     </li>
     <li>
      <strong>
       适用于大量相似对象的场景，如缓存、池化技术。
      </strong>
     </li>
     <li>
      <strong>
       JDK 和 Spring 中广泛使用，如 String 常量池、IntegerCache、Spring 单例 Bean。
      </strong>
     </li>
     <li>
      <strong>
       在使用时，需要权衡管理复杂度和性能优化的收益。
      </strong>
     </li>
    </ul>
    <p>
     <strong>
      如果你的系统面临大量重复对象的内存压力，不妨考虑蝇量模式来优化！
     </strong>
     🚀
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f5072696e63653134303637382f:61727469636c652f64657461696c732f313436313135333430" class_="artid" style="display:none">
 </p>
</div>


