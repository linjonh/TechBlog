---
layout: post
title: "eBPF-实时捕获键盘输入"
date: 2025-03-15 21:15:00 +0800
description: "本文将介绍如何使用eBPF技术通过`Go`语言和`libbpfgo`实现键盘输入的实时捕获。文章首先概述了利用eBPF的`kprobe`技术来监听内核函数`input_handle_event`，从而在按键事件发生时捕获数据，并将其传递到用户空间进行处理。文中详细讲解了从硬件中断触发到字符显示在终端上的完整流程，包括内核态与用户态的不同捕获方式。"
keywords: "eBPF 实时捕获键盘输入"
categories: ['Go']
tags: ['键盘记录', 'Kprobe', 'Ebpf']
artid: "146276525"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146276525
    alt: "eBPF-实时捕获键盘输入"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146276525
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146276525
cover: https://bing.ee123.net/img/rand?artid=146276525
image: https://bing.ee123.net/img/rand?artid=146276525
img: https://bing.ee123.net/img/rand?artid=146276525
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     eBPF 实时捕获键盘输入
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="eBPF__0">
     </a>
     eBPF 实时捕获键盘输入
    </h2>
    <p>
     本文将带你一步步实现一个基于eBPF kprobe的键盘记录功能，通过
     <code>
      Go
     </code>
     语言配合
     <code>
      libbpfgo
     </code>
     ，你将学会如何无损地监控系统键盘输入，并从中获取实时数据，进一步提高系统安全和监控能力。
    </p>
    <hr/>
    <h3>
     <a id="1__6">
     </a>
     1. 说明
    </h3>
    <p>
     本文属于专栏
     <a href="https://licheng.blog.csdn.net/article/details/146085973" rel="nofollow">
      Go语言+libbpfgo实战eBPF开发
     </a>
     ，示例代码目录为
     <code>
      040
     </code>
     。
    </p>
    <p>
     如何下载并运行代码，请参考
     <a href="https://licheng.blog.csdn.net/article/details/146085973" rel="nofollow">
      专栏介绍
     </a>
     。
    </p>
    <blockquote>
     <p>
      <strong>
       注:
      </strong>
      老学员可以直接
      <code>
       git pull
      </code>
      拉取最新代码。
     </p>
    </blockquote>
    <hr/>
    <h3>
     <a id="2__16">
     </a>
     2. 引言
    </h3>
    <p>
     在本篇文章中，我们将利用 eBPF 的
     <code>
      kprobe
     </code>
     技术捕捉键盘输入事件，实现一个简单的键盘记录功能。你将学习如何在内核层面监控
     <code>
      input_handle_event
     </code>
     函数，并将捕获到的按键事件传递到用户空间进行处理。整个过程高效且非侵入式，适用于实时监控场景。💡
    </p>
    <p>
     eBPF 允许在内核中动态加载和执行代码。借助
     <code>
      kprobe
     </code>
     ，我们可以在
     <code>
      input_handle_event
     </code>
     函数入口处挂载探针，从而捕获关键事件。
    </p>
    <ul>
     <li>
      <strong>
       键盘事件类型
      </strong>
      ：我们关注
      <code>
       EV_KEY
      </code>
      类型的按键事件，并仅记录按下（
      <code>
       value=1
      </code>
      ）时的事件。
     </li>
     <li>
      <strong>
       事件传递方式
      </strong>
      ：通过
      <code>
       bpf_perf_event_output
      </code>
      将事件数据发送到用户空间，用户空间程序使用
      <code>
       perf buffer
      </code>
      进行实时读取。
     </li>
    </ul>
    <p>
     这样既能精准监控输入事件，又无需对系统进行侵入式修改。
    </p>
    <hr/>
    <h3>
     <a id="3__28">
     </a>
     3. 原理详解
    </h3>
    <h4>
     <a id="31__30">
     </a>
     3.1 当你按下一个键盘上的按键时，发生了什么？
    </h4>
    <p>
     <strong>
      流程图
     </strong>
    </p>
    <pre><code>硬件中断 → 键盘驱动 → 输入子系统 → TTY 行规程 → Shell 进程 → TTY 回显 → 终端渲染
</code></pre>
    <p>
     在 Linux 系统中，从按下键盘到字符显示在终端上，涉及
     <strong>
      硬件中断处理、内核子系统协作和用户空间进程交互
     </strong>
     。以下是详细流程和关键函数。
    </p>
    <p>
     <strong>
      1. 硬件中断触发
     </strong>
    </p>
    <ul>
     <li>
      <strong>
       硬件层面
      </strong>
      ：键盘控制器（如 PS/2 或 USB）检测到按键动作，生成
      <strong>
       硬件中断
      </strong>
      （PS/2 键盘通常使用 IRQ 1）。
     </li>
     <li>
      <strong>
       中断控制器
      </strong>
      ：将中断路由至 CPU，CPU 通过中断向量表调用对应的
      <strong>
       中断处理程序
      </strong>
      。
     </li>
    </ul>
    <p>
     <strong>
      2. 内核中断处理
     </strong>
    </p>
    <ul>
     <li>
      <strong>
       中断处理函数
      </strong>
      ：内核注册的键盘中断处理程序（
      <code>
       irq_handler
      </code>
      ）被触发。
      <ul>
       <li>
        <strong>
         关键函数
        </strong>
        ：
        <code>
         request_irq()
        </code>
        注册中断处理函数，如 PS/2 键盘的
        <code>
         kbd_event
        </code>
        或 USB 键盘的
        <code>
         usb_kbd_irq
        </code>
        。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       读取扫描码
      </strong>
      ：驱动从键盘控制器读取
      <strong>
       扫描码（Scancode）
      </strong>
      （如
      <code>
       inb(0x60)
      </code>
      读取 PS/2 键盘数据端口）。
     </li>
     <li>
      <strong>
       转换为键码
      </strong>
      ：扫描码转换为
      <strong>
       键码（Keycode）
      </strong>
      （如
      <code>
       kbd_keycode
      </code>
      处理映射关系）。
     </li>
    </ul>
    <p>
     <strong>
      3. 输入子系统（Input Subsystem）
     </strong>
    </p>
    <ul>
     <li>
      <strong>
       生成输入事件
      </strong>
      ：键码通过输入子系统封装为
      <code>
       input_event
      </code>
      结构（包含时间戳、键值、动作等）。
      <ul>
       <li>
        <strong>
         关键函数
        </strong>
        ：
        <code>
         input_event()
        </code>
        →
        <code>
         input_handle_event()
        </code>
        。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       传递事件
      </strong>
      ：事件通过
      <code>
       /dev/input/eventX
      </code>
      设备节点传递，供用户空间程序（如终端）读取。
      <ul>
       <li>
        <strong>
         关键结构
        </strong>
        ：
        <code>
         struct input_handler
        </code>
        负责事件路由（如
        <code>
         evdev_handler
        </code>
        ）。
       </li>
      </ul>
     </li>
    </ul>
    <p>
     <strong>
      4. TTY 子系统处理
     </strong>
    </p>
    <ul>
     <li>
      <strong>
       绑定到 TTY
      </strong>
      ：输入事件传递到当前活动的 TTY（如
      <code>
       /dev/tty1
      </code>
      ）。
      <ul>
       <li>
        <strong>
         关键函数
        </strong>
        ：
        <code>
         tty_insert_flip_char()
        </code>
        将字符写入 TTY 的 flip buffer。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       行规程（Line Discipline）
      </strong>
      ：处理特殊字符（如回车、退格）。默认行规程为
      <code>
       n_tty
      </code>
      。
      <ul>
       <li>
        <strong>
         关键函数
        </strong>
        ：
        <code>
         n_tty_receive_char()
        </code>
        解析字符并执行回显逻辑。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       刷新缓冲区
      </strong>
      ：调用
      <code>
       tty_flip_buffer_push()
      </code>
      推送数据至 TTY 读队列。
     </li>
    </ul>
    <p>
     <strong>
      5. 用户空间进程读取输入
     </strong>
    </p>
    <ul>
     <li>
      <strong>
       前台进程
      </strong>
      ：Shell（如 Bash）通过
      <code>
       read()
      </code>
      系统调用读取 TTY 设备的输入。
      <ul>
       <li>
        <strong>
         关键路径
        </strong>
        ：
        <code>
         read()
        </code>
        →
        <code>
         tty_read()
        </code>
        →
        <code>
         copy_from_read_buf()
        </code>
        。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       行编辑模式（Canonical Mode）
      </strong>
      ：启用时，输入缓存在内核直到用户按下回车。
     </li>
    </ul>
    <p>
     <strong>
      6. 字符显示到终端
     </strong>
    </p>
    <ul>
     <li>
      <strong>
       回显（Echo）
      </strong>
      ：默认
      <code>
       n_tty
      </code>
      规程会自动回显字符到终端。
      <ul>
       <li>
        <strong>
         关键函数
        </strong>
        ：
        <code>
         n_tty_receive_char()
        </code>
        调用
        <code>
         echo_char()
        </code>
        进行回显。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       终端写入
      </strong>
      ：字符通过
      <code>
       write()
      </code>
      系统调用发送至终端显示。
      <ul>
       <li>
        <strong>
         关键路径
        </strong>
        ：
        <code>
         write()
        </code>
        →
        <code>
         tty_write()
        </code>
        →
        <code>
         do_tty_write()
        </code>
        → 终端驱动的写函数。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       终端渲染方式
      </strong>
      ：
      <ul>
       <li>
        <strong>
         物理终端
        </strong>
        ：通过显卡驱动（如
        <code>
         vt_console_print()
        </code>
        ）直接输出。
       </li>
       <li>
        <strong>
         伪终端（PTY）
        </strong>
        ：如 SSH 或终端模拟器（如 GNOME Terminal），字符通过 PTY 主从设备传输，最终由终端模拟器渲染。
       </li>
      </ul>
     </li>
    </ul>
    <h4>
     <a id="32__76">
     </a>
     3.2 在哪里捕获键盘输入事件？
    </h4>
    <p>
     在 Linux 系统中，键盘输入事件可以在不同层次进行捕获，主要包括
     <strong>
      内核态
     </strong>
     和
     <strong>
      用户态
     </strong>
     ，以下是常见的捕获位置及方法。
    </p>
    <h5>
     <a id="1__80">
     </a>
     1. 内核态捕获
    </h5>
    <p>
     <strong>
      1.1 中断处理程序（IRQ 级别）
     </strong>
    </p>
    <ul>
     <li>
      最底层的捕获方式，在键盘触发
      <strong>
       硬件中断
      </strong>
      时，内核的
      <strong>
       中断处理函数
      </strong>
      被调用。
     </li>
     <li>
      相关代码位置：
      <code>
       drivers/input/keyboard/atkbd.c
      </code>
      （PS/2 键盘） 或
      <code>
       drivers/hid/usbhid/usbkbd.c
      </code>
      （USB 键盘）。
     </li>
     <li>
      关键函数：
      <ul>
       <li>
        <code>
         irq_handler_t kbd_event()
        </code>
        （PS/2）
       </li>
       <li>
        <code>
         usb_kbd_irq()
        </code>
        （USB）
       </li>
       <li>
        读取
        <strong>
         扫描码
        </strong>
        并传递至
        <strong>
         输入子系统
        </strong>
        。
       </li>
      </ul>
     </li>
    </ul>
    <p>
     <strong>
      1.2 输入子系统（Input Subsystem）
     </strong>
    </p>
    <ul>
     <li>
      内核的
      <code>
       input_event
      </code>
      机制封装了键盘输入事件。
     </li>
     <li>
      相关设备节点：
      <code>
       /dev/input/eventX
      </code>
      。
     </li>
     <li>
      关键函数：
      <ul>
       <li>
        <code>
         input_event()
        </code>
        生成键盘事件。
       </li>
       <li>
        <code>
         input_handle_event()
        </code>
        处理事件并分发至用户空间。
       </li>
      </ul>
     </li>
    </ul>
    <h5>
     <a id="2__97">
     </a>
     2. 用户态捕获
    </h5>
    <p>
     <strong>
      2.1 通过
      <code>
       /dev/input/eventX
      </code>
      捕获原始输入事件
     </strong>
    </p>
    <ul>
     <li>
      <p>
       适用于读取底层输入设备（适用于键盘监听、按键统计等）。
      </p>
     </li>
     <li>
      <p>
       代码示例（使用
       <code>
        evdev
       </code>
       接口）：
      </p>
      <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fcntl.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/input.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/input/event2"</span><span class="token punctuation">,</span> O_RDONLY<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">perror</span><span class="token punctuation">(</span><span class="token string">"open"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">struct</span> <span class="token class-name">input_event</span> ev<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">read</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ev<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>ev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ev<span class="token punctuation">.</span>type <span class="token operator">==</span> EV_KEY <span class="token operator">&amp;&amp;</span> ev<span class="token punctuation">.</span>value <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Key %d pressed\n"</span><span class="token punctuation">,</span> ev<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
    </ul>
    <p>
     <strong>
      2.2 通过
      <code>
       /dev/tty
      </code>
      读取终端输入
     </strong>
    </p>
    <ul>
     <li>
      <p>
       适用于读取当前终端的键盘输入（受 TTY 规程控制）。
      </p>
     </li>
     <li>
      <p>
       代码示例（读取标准输入）：
      </p>
      <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> c<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        c <span class="token operator">=</span> <span class="token function">getchar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Pressed: %c\n"</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
     </li>
    </ul>
    <p>
     <strong>
      2.3 使用
      <code>
       libinput
      </code>
      监听键盘输入（Wayland 环境）
     </strong>
    </p>
    <ul>
     <li>
      <p>
       适用于现代桌面环境（X11/Wayland）。
      </p>
     </li>
     <li>
      <p>
       监听系统级输入事件，适用于图形界面应用。
      </p>
     </li>
     <li>
      <p>
       代码示例（Python）：
      </p>
      <pre><code class="prism language-python"><span class="token keyword">from</span> evdev <span class="token keyword">import</span> InputDevice<span class="token punctuation">,</span> categorize<span class="token punctuation">,</span> ecodes

dev <span class="token operator">=</span> InputDevice<span class="token punctuation">(</span><span class="token string">'/dev/input/event2'</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> event <span class="token keyword">in</span> dev<span class="token punctuation">.</span>read_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> event<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> ecodes<span class="token punctuation">.</span>EV_KEY<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>categorize<span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
     </li>
    </ul>
    <p>
     <strong>
      2.4 监听 X11 按键事件（X Window System）
     </strong>
    </p>
    <ul>
     <li>
      <p>
       适用于 GUI 应用，使用
       <code>
        Xlib
       </code>
       监听按键。
      </p>
     </li>
     <li>
      <p>
       代码示例（Python +
       <code>
        python-xlib
       </code>
       ）：
      </p>
      <pre><code class="prism language-python"><span class="token keyword">from</span> Xlib <span class="token keyword">import</span> display<span class="token punctuation">,</span> X

d <span class="token operator">=</span> display<span class="token punctuation">.</span>Display<span class="token punctuation">(</span><span class="token punctuation">)</span>
r <span class="token operator">=</span> d<span class="token punctuation">.</span>screen<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>root
r<span class="token punctuation">.</span>grab_keyboard<span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> X<span class="token punctuation">.</span>GrabModeAsync<span class="token punctuation">,</span> X<span class="token punctuation">.</span>GrabModeAsync<span class="token punctuation">,</span> X<span class="token punctuation">.</span>CurrentTime<span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    event <span class="token operator">=</span> r<span class="token punctuation">.</span>display<span class="token punctuation">.</span>next_event<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> event<span class="token punctuation">.</span><span class="token builtin">type</span> <span class="token operator">==</span> X<span class="token punctuation">.</span>KeyPress<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Key pressed"</span><span class="token punctuation">)</span>
</code></pre>
     </li>
    </ul>
    <h4>
     <a id="33__173">
     </a>
     3.3 选择合适的捕获方式
    </h4>
    <table>
     <thead>
      <tr>
       <th>
        需求
       </th>
       <th>
        推荐方法
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        低级输入监控（扫描码）
       </td>
       <td>
        内核
        <code>
         input_event
        </code>
        或者
        <code>
         input_handle_event
        </code>
        API
       </td>
      </tr>
      <tr>
       <td>
        监听所有键盘事件
       </td>
       <td>
        读取
        <code>
         /dev/input/eventX
        </code>
       </td>
      </tr>
      <tr>
       <td>
        监听终端输入
       </td>
       <td>
        读取
        <code>
         /dev/tty
        </code>
       </td>
      </tr>
      <tr>
       <td>
        GUI 应用按键捕获
       </td>
       <td>
        <code>
         Xlib
        </code>
        或
        <code>
         libinput
        </code>
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     不同场景下，可以选择合适的方式进行键盘输入捕获。
    </p>
    <blockquote>
     <p>
      本文将演示通过 hook 内核函数
      <code>
       input_handle_event
      </code>
      实现键盘记录功能。
     </p>
    </blockquote>
    <hr/>
    <h3>
     <a id="4__188">
     </a>
     4. 代码详解
    </h3>
    <h4>
     <a id="41_bpf_190">
     </a>
     4.1 bpf代码
    </h4>
    <h5>
     <a id="411__192">
     </a>
     4.1.1 整体逻辑
    </h5>
    <ul>
     <li>
      <strong>
       加载入口:
      </strong>
      代码通过
      <code>
       SEC("kprobe/input_handle_event")
      </code>
      挂载到内核的
      <code>
       input_handle_event
      </code>
      函数。
     </li>
     <li>
      <strong>
       事件过滤:
      </strong>
      判断传入的
      <code>
       type
      </code>
      是否为
      <code>
       EV_KEY
      </code>
      且
      <code>
       value
      </code>
      是否等于1，只在按键按下时进行处理。
     </li>
     <li>
      <strong>
       数据发送:
      </strong>
      如果满足条件且按键码小于
      <code>
       MAX_KEYS
      </code>
      ，则利用
      <code>
       bpf_perf_event_output
      </code>
      将事件数据发送到用户空间。
     </li>
    </ul>
    <h5>
     <a id="412__198">
     </a>
     4.1.2 代码细节解析
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        头文件与宏定义:
       </strong>
      </p>
      <ul>
       <li>
        包含了
        <code>
         vmlinux.h
        </code>
        、
        <code>
         bpf_helpers.h
        </code>
        、
        <code>
         bpf_tracing.h
        </code>
        和
        <code>
         bpf_core_read.h
        </code>
        等头文件，保证代码能调用内核相关的API。
       </li>
       <li>
        定义了
        <code>
         EV_KEY
        </code>
        和
        <code>
         MAX_KEYS
        </code>
        ，分别代表按键事件类型和允许的最大按键数量。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        事件结构体:
       </strong>
      </p>
      <pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">event_t</span> <span class="token punctuation">{<!-- --></span>
    u32 type<span class="token punctuation">;</span>
    u32 code<span class="token punctuation">;</span>
    u32 value<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
      <p>
       该结构体用于保存按键事件数据，包括事件类型、按键码和按键状态。
      </p>
     </li>
     <li>
      <p>
       <strong>
        kprobe函数:
       </strong>
      </p>
      <pre><code class="prism language-c"><span class="token function">SEC</span><span class="token punctuation">(</span><span class="token string">"kprobe/input_handle_event"</span><span class="token punctuation">)</span>
<span class="token keyword">int</span> <span class="token function">BPF_KPROBE</span><span class="token punctuation">(</span>hook_input_handle_event<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">input_dev</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> code<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">event_t</span> event <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

    event<span class="token punctuation">.</span>type <span class="token operator">=</span> type<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>code <span class="token operator">=</span> code<span class="token punctuation">;</span>
    event<span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">==</span> EV_KEY <span class="token operator">&amp;&amp;</span> value <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>code <span class="token operator">&lt;</span> MAX_KEYS<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">bpf_perf_event_output</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token operator">&amp;</span>events<span class="token punctuation">,</span> BPF_F_CURRENT_CPU<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> 
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
      <ul>
       <li>
        <strong>
         整体逻辑:
        </strong>
        在每次
        <code>
         input_handle_event
        </code>
        调用时，将输入数据封装到
        <code>
         event
        </code>
        中；判断条件满足时，将事件通过
        <code>
         perf event
        </code>
        发送。
       </li>
       <li>
        <strong>
         细节说明:
        </strong>
        <ul>
         <li>
          <code>
           SEC("kprobe/input_handle_event")
          </code>
          ：声明该函数为kprobe处理函数。
         </li>
         <li>
          <code>
           BPF_KPROBE
          </code>
          宏用于自动生成探针入口。
         </li>
         <li>
          <code>
           bpf_perf_event_output
          </code>
          负责将数据传递到用户空间，不涉及错误处理代码。
         </li>
        </ul>
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h4>
     <a id="42_go_243">
     </a>
     4.2 go代码
    </h4>
    <h5>
     <a id="421_maingo_245">
     </a>
     4.2.1 main.go
    </h5>
    <h6>
     <a id="_247">
     </a>
     整体逻辑
    </h6>
    <ul>
     <li>
      <strong>
       信号注册:
      </strong>
      利用
      <code>
       signal.NotifyContext
      </code>
      注册系统信号（如
      <code>
       SIGINT
      </code>
      、
      <code>
       SIGTERM
      </code>
      ），确保程序能优雅退出。
     </li>
     <li>
      <strong>
       加载BPF程序:
      </strong>
      调用
      <code>
       BpfLoadAndAttach
      </code>
      加载并附加BPF程序文件
      <code>
       bpf.o
      </code>
      。
     </li>
     <li>
      <strong>
       创建perf buffer:
      </strong>
      初始化
      <code>
       perf buffer
      </code>
      ，通过
      <code>
       eventsChannel
      </code>
      和
      <code>
       lostChannel
      </code>
      接收事件数据及丢失事件统计。
     </li>
     <li>
      <strong>
       事件处理:
      </strong>
      启动一个事件处理循环，实时解析并打印键盘事件，直到收到退出信号。
     </li>
    </ul>
    <h6>
     <a id="_254">
     </a>
     代码细节解析
    </h6>
    <ul>
     <li>
      <strong>
       日志设置:
      </strong>
      使用
      <code>
       logrus
      </code>
      设置日志级别和时间格式，使调试信息更直观。
     </li>
     <li>
      <strong>
       资源管理:
      </strong>
      利用
      <code>
       defer
      </code>
      语句确保BPF模块和perf buffer在程序结束时被正确关闭。
     </li>
     <li>
      <strong>
       事件循环:
      </strong>
      <pre><code class="prism language-go"><span class="token keyword">for</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 循环接收事件</span>
  	<span class="token keyword">select</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token comment">// 接收到事件时打印事件信息</span>
  	<span class="token keyword">case</span> data <span class="token operator">:=</span> <span class="token operator">&lt;-</span>eventsChannel<span class="token punctuation">:</span>
  		<span class="token keyword">var</span> event Event
  		err <span class="token operator">:=</span> event<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  		<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
  			log<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">"parse event error: %v"</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
  		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
  			log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  		<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
      该循环实时响应来自内核空间的事件数据。
     </li>
    </ul>
    <hr/>
    <h5>
     <a id="422_eventgo_279">
     </a>
     4.2.2 event.go
    </h5>
    <h6>
     <a id="_281">
     </a>
     整体逻辑
    </h6>
    <ul>
     <li>
      <strong>
       数据结构:
      </strong>
      定义了
      <code>
       Event
      </code>
      结构体，用于与内核传来的
      <code>
       event_t
      </code>
      数据一一对应。
     </li>
     <li>
      <strong>
       数据解析:
      </strong>
      <code>
       Parse
      </code>
      方法利用
      <code>
       binary.Read
      </code>
      将接收到的字节流转化为结构体数据。
     </li>
     <li>
      <strong>
       数据展示:
      </strong>
      <code>
       String
      </code>
      方法调用
      <code>
       keyStr
      </code>
      函数，将按键码转换为对应的按键名称，便于直观展示。
     </li>
    </ul>
    <h6>
     <a id="_287">
     </a>
     代码细节解析
    </h6>
    <pre><code class="prism language-go"><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">"bytes"</span>
	<span class="token string">"encoding/binary"</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> Event <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
	Type  <span class="token builtin">uint32</span>
	Code  <span class="token builtin">uint32</span>
	Value <span class="token builtin">uint32</span>
<span class="token punctuation">}</span>

<span class="token comment">// 解析event数据</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Event<span class="token punctuation">)</span> <span class="token function">Parse</span><span class="token punctuation">(</span>data <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{<!-- --></span>
	err <span class="token operator">:=</span> binary<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span><span class="token function">NewBuffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">,</span> e<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// 转换成字符串</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>e <span class="token operator">*</span>Event<span class="token punctuation">)</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">keyStr</span><span class="token punctuation">(</span><span class="token function">int</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>Code<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> MAX_KEYS <span class="token operator">=</span> <span class="token number">256</span>

<span class="token keyword">var</span> keyNames <span class="token operator">=</span> <span class="token punctuation">[</span>MAX_KEYS<span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{<!-- --></span>
	<span class="token number">0</span><span class="token punctuation">:</span> <span class="token string">"RESERVED"</span><span class="token punctuation">,</span>
	<span class="token number">1</span><span class="token punctuation">:</span> <span class="token string">"ESC"</span><span class="token punctuation">,</span>
	<span class="token number">2</span><span class="token punctuation">:</span> <span class="token string">"1"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">:</span> <span class="token string">"2"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">:</span> <span class="token string">"3"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">:</span> <span class="token string">"4"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">:</span> <span class="token string">"5"</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">:</span> <span class="token string">"6"</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">:</span> <span class="token string">"7"</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">:</span> <span class="token string">"8"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">:</span> <span class="token string">"9"</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">:</span> <span class="token string">"0"</span><span class="token punctuation">,</span>
	<span class="token number">12</span><span class="token punctuation">:</span> <span class="token string">"MINUS"</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">:</span> <span class="token string">"EQUAL"</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">:</span> <span class="token string">"BACKSPACE"</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">:</span> <span class="token string">"TAB"</span><span class="token punctuation">,</span>
	<span class="token number">16</span><span class="token punctuation">:</span> <span class="token string">"Q"</span><span class="token punctuation">,</span> <span class="token number">17</span><span class="token punctuation">:</span> <span class="token string">"W"</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">:</span> <span class="token string">"E"</span><span class="token punctuation">,</span> <span class="token number">19</span><span class="token punctuation">:</span> <span class="token string">"R"</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">:</span> <span class="token string">"T"</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">:</span> <span class="token string">"Y"</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">:</span> <span class="token string">"U"</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">:</span> <span class="token string">"I"</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">:</span> <span class="token string">"O"</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">:</span> <span class="token string">"P"</span><span class="token punctuation">,</span>
	<span class="token number">26</span><span class="token punctuation">:</span> <span class="token string">"LEFTBRACE"</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">:</span> <span class="token string">"RIGHTBRACE"</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">:</span> <span class="token string">"ENTER"</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">:</span> <span class="token string">"LEFTCTRL"</span><span class="token punctuation">,</span>
	<span class="token number">30</span><span class="token punctuation">:</span> <span class="token string">"A"</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">:</span> <span class="token string">"S"</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">:</span> <span class="token string">"D"</span><span class="token punctuation">,</span> <span class="token number">33</span><span class="token punctuation">:</span> <span class="token string">"F"</span><span class="token punctuation">,</span> <span class="token number">34</span><span class="token punctuation">:</span> <span class="token string">"G"</span><span class="token punctuation">,</span> <span class="token number">35</span><span class="token punctuation">:</span> <span class="token string">"H"</span><span class="token punctuation">,</span> <span class="token number">36</span><span class="token punctuation">:</span> <span class="token string">"J"</span><span class="token punctuation">,</span> <span class="token number">37</span><span class="token punctuation">:</span> <span class="token string">"K"</span><span class="token punctuation">,</span> <span class="token number">38</span><span class="token punctuation">:</span> <span class="token string">"L"</span><span class="token punctuation">,</span> <span class="token number">39</span><span class="token punctuation">:</span> <span class="token string">"SEMICOLON"</span><span class="token punctuation">,</span>
	<span class="token number">40</span><span class="token punctuation">:</span> <span class="token string">"APOSTROPHE"</span><span class="token punctuation">,</span> <span class="token number">41</span><span class="token punctuation">:</span> <span class="token string">"GRAVE"</span><span class="token punctuation">,</span> <span class="token number">42</span><span class="token punctuation">:</span> <span class="token string">"LEFTSHIFT"</span><span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">:</span> <span class="token string">"BACKSLASH"</span><span class="token punctuation">,</span>
	<span class="token number">44</span><span class="token punctuation">:</span> <span class="token string">"Z"</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">:</span> <span class="token string">"X"</span><span class="token punctuation">,</span> <span class="token number">46</span><span class="token punctuation">:</span> <span class="token string">"C"</span><span class="token punctuation">,</span> <span class="token number">47</span><span class="token punctuation">:</span> <span class="token string">"V"</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">:</span> <span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token number">49</span><span class="token punctuation">:</span> <span class="token string">"N"</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">:</span> <span class="token string">"M"</span><span class="token punctuation">,</span> <span class="token number">51</span><span class="token punctuation">:</span> <span class="token string">"COMMA"</span><span class="token punctuation">,</span> <span class="token number">52</span><span class="token punctuation">:</span> <span class="token string">"DOT"</span><span class="token punctuation">,</span> <span class="token number">53</span><span class="token punctuation">:</span> <span class="token string">"SLASH"</span><span class="token punctuation">,</span>
	<span class="token number">54</span><span class="token punctuation">:</span> <span class="token string">"RIGHTSHIFT"</span><span class="token punctuation">,</span> <span class="token number">55</span><span class="token punctuation">:</span> <span class="token string">"KPASTERISK"</span><span class="token punctuation">,</span> <span class="token number">56</span><span class="token punctuation">:</span> <span class="token string">"LEFTALT"</span><span class="token punctuation">,</span> <span class="token number">57</span><span class="token punctuation">:</span> <span class="token string">"SPACE"</span><span class="token punctuation">,</span>
	<span class="token number">58</span><span class="token punctuation">:</span> <span class="token string">"CAPSLOCK"</span><span class="token punctuation">,</span> <span class="token number">59</span><span class="token punctuation">:</span> <span class="token string">"F1"</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">:</span> <span class="token string">"F2"</span><span class="token punctuation">,</span> <span class="token number">61</span><span class="token punctuation">:</span> <span class="token string">"F3"</span><span class="token punctuation">,</span> <span class="token number">62</span><span class="token punctuation">:</span> <span class="token string">"F4"</span><span class="token punctuation">,</span> <span class="token number">63</span><span class="token punctuation">:</span> <span class="token string">"F5"</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">:</span> <span class="token string">"F6"</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">:</span> <span class="token string">"F7"</span><span class="token punctuation">,</span> <span class="token number">66</span><span class="token punctuation">:</span> <span class="token string">"F8"</span><span class="token punctuation">,</span> <span class="token number">67</span><span class="token punctuation">:</span> <span class="token string">"F9"</span><span class="token punctuation">,</span> <span class="token number">68</span><span class="token punctuation">:</span> <span class="token string">"F10"</span><span class="token punctuation">,</span>
	<span class="token number">69</span><span class="token punctuation">:</span> <span class="token string">"NUMLOCK"</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">:</span> <span class="token string">"SCROLLLOCK"</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">:</span> <span class="token string">"KP7"</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">:</span> <span class="token string">"KP8"</span><span class="token punctuation">,</span> <span class="token number">73</span><span class="token punctuation">:</span> <span class="token string">"KP9"</span><span class="token punctuation">,</span> <span class="token number">74</span><span class="token punctuation">:</span> <span class="token string">"KPMINUS"</span><span class="token punctuation">,</span> <span class="token number">75</span><span class="token punctuation">:</span> <span class="token string">"KP4"</span><span class="token punctuation">,</span> <span class="token number">76</span><span class="token punctuation">:</span> <span class="token string">"KP5"</span><span class="token punctuation">,</span> <span class="token number">77</span><span class="token punctuation">:</span> <span class="token string">"KP6"</span><span class="token punctuation">,</span> <span class="token number">78</span><span class="token punctuation">:</span> <span class="token string">"KPPLUS"</span><span class="token punctuation">,</span>
	<span class="token number">79</span><span class="token punctuation">:</span> <span class="token string">"KP1"</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">:</span> <span class="token string">"KP2"</span><span class="token punctuation">,</span> <span class="token number">81</span><span class="token punctuation">:</span> <span class="token string">"KP3"</span><span class="token punctuation">,</span> <span class="token number">82</span><span class="token punctuation">:</span> <span class="token string">"KP0"</span><span class="token punctuation">,</span> <span class="token number">83</span><span class="token punctuation">:</span> <span class="token string">"KPDOT"</span><span class="token punctuation">,</span>
	<span class="token number">85</span><span class="token punctuation">:</span> <span class="token string">"ZENKAKUHANKAKU"</span><span class="token punctuation">,</span> <span class="token number">86</span><span class="token punctuation">:</span> <span class="token string">"102ND"</span><span class="token punctuation">,</span> <span class="token number">87</span><span class="token punctuation">:</span> <span class="token string">"F11"</span><span class="token punctuation">,</span> <span class="token number">88</span><span class="token punctuation">:</span> <span class="token string">"F12"</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">:</span> <span class="token string">"RO"</span><span class="token punctuation">,</span> <span class="token number">90</span><span class="token punctuation">:</span> <span class="token string">"KATAKANA"</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">:</span> <span class="token string">"HIRAGANA"</span><span class="token punctuation">,</span> <span class="token number">92</span><span class="token punctuation">:</span> <span class="token string">"HENKAN"</span><span class="token punctuation">,</span> <span class="token number">93</span><span class="token punctuation">:</span> <span class="token string">"KATAKANAHIRAGANA"</span><span class="token punctuation">,</span> <span class="token number">94</span><span class="token punctuation">:</span> <span class="token string">"MUHENKAN"</span><span class="token punctuation">,</span>
	<span class="token number">95</span><span class="token punctuation">:</span> <span class="token string">"KPJPCOMMA"</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">:</span> <span class="token string">"KPENTER"</span><span class="token punctuation">,</span> <span class="token number">97</span><span class="token punctuation">:</span> <span class="token string">"RIGHTCTRL"</span><span class="token punctuation">,</span> <span class="token number">98</span><span class="token punctuation">:</span> <span class="token string">"KPSLASH"</span><span class="token punctuation">,</span> <span class="token number">99</span><span class="token punctuation">:</span> <span class="token string">"SYSRQ"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">:</span> <span class="token string">"RIGHTALT"</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">:</span> <span class="token string">"LINEFEED"</span><span class="token punctuation">,</span>
	<span class="token number">102</span><span class="token punctuation">:</span> <span class="token string">"HOME"</span><span class="token punctuation">,</span> <span class="token number">103</span><span class="token punctuation">:</span> <span class="token string">"UP"</span><span class="token punctuation">,</span> <span class="token number">104</span><span class="token punctuation">:</span> <span class="token string">"PAGEUP"</span><span class="token punctuation">,</span> <span class="token number">105</span><span class="token punctuation">:</span> <span class="token string">"LEFT"</span><span class="token punctuation">,</span> <span class="token number">106</span><span class="token punctuation">:</span> <span class="token string">"RIGHT"</span><span class="token punctuation">,</span> <span class="token number">107</span><span class="token punctuation">:</span> <span class="token string">"END"</span><span class="token punctuation">,</span> <span class="token number">108</span><span class="token punctuation">:</span> <span class="token string">"DOWN"</span><span class="token punctuation">,</span> <span class="token number">109</span><span class="token punctuation">:</span> <span class="token string">"PAGEDOWN"</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">:</span> <span class="token string">"INSERT"</span><span class="token punctuation">,</span> <span class="token number">111</span><span class="token punctuation">:</span> <span class="token string">"DELETE"</span><span class="token punctuation">,</span>
	<span class="token number">112</span><span class="token punctuation">:</span> <span class="token string">"MACRO"</span><span class="token punctuation">,</span> <span class="token number">113</span><span class="token punctuation">:</span> <span class="token string">"MUTE"</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">:</span> <span class="token string">"VOLUMEDOWN"</span><span class="token punctuation">,</span> <span class="token number">115</span><span class="token punctuation">:</span> <span class="token string">"VOLUMEUP"</span><span class="token punctuation">,</span> <span class="token number">116</span><span class="token punctuation">:</span> <span class="token string">"POWER"</span><span class="token punctuation">,</span> <span class="token number">117</span><span class="token punctuation">:</span> <span class="token string">"KPEQUAL"</span><span class="token punctuation">,</span> <span class="token number">118</span><span class="token punctuation">:</span> <span class="token string">"KPPLUSMINUS"</span><span class="token punctuation">,</span> <span class="token number">119</span><span class="token punctuation">:</span> <span class="token string">"PAUSE"</span><span class="token punctuation">,</span>
	<span class="token number">120</span><span class="token punctuation">:</span> <span class="token string">"SCALE"</span><span class="token punctuation">,</span> <span class="token number">121</span><span class="token punctuation">:</span> <span class="token string">"KPCOMMA"</span><span class="token punctuation">,</span> <span class="token number">122</span><span class="token punctuation">:</span> <span class="token string">"HANGEUL"</span><span class="token punctuation">,</span> <span class="token number">123</span><span class="token punctuation">:</span> <span class="token string">"HANJA"</span><span class="token punctuation">,</span> <span class="token number">124</span><span class="token punctuation">:</span> <span class="token string">"YEN"</span><span class="token punctuation">,</span> <span class="token number">125</span><span class="token punctuation">:</span> <span class="token string">"LEFTMETA"</span><span class="token punctuation">,</span> <span class="token number">126</span><span class="token punctuation">:</span> <span class="token string">"RIGHTMETA"</span><span class="token punctuation">,</span> <span class="token number">127</span><span class="token punctuation">:</span> <span class="token string">"COMPOSE"</span><span class="token punctuation">,</span>
	<span class="token number">128</span><span class="token punctuation">:</span> <span class="token string">"STOP"</span><span class="token punctuation">,</span> <span class="token number">129</span><span class="token punctuation">:</span> <span class="token string">"AGAIN"</span><span class="token punctuation">,</span> <span class="token number">130</span><span class="token punctuation">:</span> <span class="token string">"PROPS"</span><span class="token punctuation">,</span> <span class="token number">131</span><span class="token punctuation">:</span> <span class="token string">"UNDO"</span><span class="token punctuation">,</span> <span class="token number">132</span><span class="token punctuation">:</span> <span class="token string">"FRONT"</span><span class="token punctuation">,</span> <span class="token number">133</span><span class="token punctuation">:</span> <span class="token string">"COPY"</span><span class="token punctuation">,</span> <span class="token number">134</span><span class="token punctuation">:</span> <span class="token string">"OPEN"</span><span class="token punctuation">,</span> <span class="token number">135</span><span class="token punctuation">:</span> <span class="token string">"PASTE"</span><span class="token punctuation">,</span> <span class="token number">136</span><span class="token punctuation">:</span> <span class="token string">"FIND"</span><span class="token punctuation">,</span> <span class="token number">137</span><span class="token punctuation">:</span> <span class="token string">"CUT"</span><span class="token punctuation">,</span>
	<span class="token number">138</span><span class="token punctuation">:</span> <span class="token string">"HELP"</span><span class="token punctuation">,</span> <span class="token number">139</span><span class="token punctuation">:</span> <span class="token string">"MENU"</span><span class="token punctuation">,</span> <span class="token number">140</span><span class="token punctuation">:</span> <span class="token string">"CALC"</span><span class="token punctuation">,</span> <span class="token number">141</span><span class="token punctuation">:</span> <span class="token string">"SETUP"</span><span class="token punctuation">,</span> <span class="token number">142</span><span class="token punctuation">:</span> <span class="token string">"SLEEP"</span><span class="token punctuation">,</span> <span class="token number">143</span><span class="token punctuation">:</span> <span class="token string">"WAKEUP"</span><span class="token punctuation">,</span> <span class="token number">144</span><span class="token punctuation">:</span> <span class="token string">"FILE"</span><span class="token punctuation">,</span> <span class="token number">145</span><span class="token punctuation">:</span> <span class="token string">"SENDFILE"</span><span class="token punctuation">,</span> <span class="token number">146</span><span class="token punctuation">:</span> <span class="token string">"DELETEFILE"</span><span class="token punctuation">,</span> <span class="token number">147</span><span class="token punctuation">:</span> <span class="token string">"XFER"</span><span class="token punctuation">,</span>
	<span class="token number">148</span><span class="token punctuation">:</span> <span class="token string">"PROG1"</span><span class="token punctuation">,</span> <span class="token number">149</span><span class="token punctuation">:</span> <span class="token string">"PROG2"</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">:</span> <span class="token string">"WWW"</span><span class="token punctuation">,</span> <span class="token number">151</span><span class="token punctuation">:</span> <span class="token string">"MSDOS"</span><span class="token punctuation">,</span> <span class="token number">152</span><span class="token punctuation">:</span> <span class="token string">"COFFEE"</span><span class="token punctuation">,</span> <span class="token number">153</span><span class="token punctuation">:</span> <span class="token string">"ROTATE_DISPLAY"</span><span class="token punctuation">,</span> <span class="token number">154</span><span class="token punctuation">:</span> <span class="token string">"CYCLEWINDOWS"</span><span class="token punctuation">,</span> <span class="token number">155</span><span class="token punctuation">:</span> <span class="token string">"MAIL"</span><span class="token punctuation">,</span> <span class="token number">156</span><span class="token punctuation">:</span> <span class="token string">"BOOKMARKS"</span><span class="token punctuation">,</span>
	<span class="token number">157</span><span class="token punctuation">:</span> <span class="token string">"COMPUTER"</span><span class="token punctuation">,</span> <span class="token number">158</span><span class="token punctuation">:</span> <span class="token string">"BACK"</span><span class="token punctuation">,</span> <span class="token number">159</span><span class="token punctuation">:</span> <span class="token string">"FORWARD"</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">:</span> <span class="token string">"CLOSECD"</span><span class="token punctuation">,</span> <span class="token number">161</span><span class="token punctuation">:</span> <span class="token string">"EJECTCD"</span><span class="token punctuation">,</span> <span class="token number">162</span><span class="token punctuation">:</span> <span class="token string">"EJECTCLOSECD"</span><span class="token punctuation">,</span> <span class="token number">163</span><span class="token punctuation">:</span> <span class="token string">"NEXTSONG"</span><span class="token punctuation">,</span> <span class="token number">164</span><span class="token punctuation">:</span> <span class="token string">"PLAYPAUSE"</span><span class="token punctuation">,</span>
	<span class="token number">165</span><span class="token punctuation">:</span> <span class="token string">"PREVIOUSSONG"</span><span class="token punctuation">,</span> <span class="token number">166</span><span class="token punctuation">:</span> <span class="token string">"STOPCD"</span><span class="token punctuation">,</span> <span class="token number">167</span><span class="token punctuation">:</span> <span class="token string">"RECORD"</span><span class="token punctuation">,</span> <span class="token number">168</span><span class="token punctuation">:</span> <span class="token string">"REWIND"</span><span class="token punctuation">,</span> <span class="token number">169</span><span class="token punctuation">:</span> <span class="token string">"PHONE"</span><span class="token punctuation">,</span> <span class="token number">170</span><span class="token punctuation">:</span> <span class="token string">"ISO"</span><span class="token punctuation">,</span> <span class="token number">171</span><span class="token punctuation">:</span> <span class="token string">"CONFIG"</span><span class="token punctuation">,</span> <span class="token number">172</span><span class="token punctuation">:</span> <span class="token string">"HOMEPAGE"</span><span class="token punctuation">,</span> <span class="token number">173</span><span class="token punctuation">:</span> <span class="token string">"REFRESH"</span><span class="token punctuation">,</span>
	<span class="token number">174</span><span class="token punctuation">:</span> <span class="token string">"EXIT"</span><span class="token punctuation">,</span> <span class="token number">175</span><span class="token punctuation">:</span> <span class="token string">"MOVE"</span><span class="token punctuation">,</span> <span class="token number">176</span><span class="token punctuation">:</span> <span class="token string">"EDIT"</span><span class="token punctuation">,</span> <span class="token number">177</span><span class="token punctuation">:</span> <span class="token string">"SCROLLUP"</span><span class="token punctuation">,</span> <span class="token number">178</span><span class="token punctuation">:</span> <span class="token string">"SCROLLDOWN"</span><span class="token punctuation">,</span> <span class="token number">179</span><span class="token punctuation">:</span> <span class="token string">"KPLEFTPAREN"</span><span class="token punctuation">,</span> <span class="token number">180</span><span class="token punctuation">:</span> <span class="token string">"KPRIGHTPAREN"</span><span class="token punctuation">,</span> <span class="token number">181</span><span class="token punctuation">:</span> <span class="token string">"NEW"</span><span class="token punctuation">,</span> <span class="token number">182</span><span class="token punctuation">:</span> <span class="token string">"REDO"</span><span class="token punctuation">,</span>
	<span class="token number">183</span><span class="token punctuation">:</span> <span class="token string">"F13"</span><span class="token punctuation">,</span> <span class="token number">184</span><span class="token punctuation">:</span> <span class="token string">"F14"</span><span class="token punctuation">,</span> <span class="token number">185</span><span class="token punctuation">:</span> <span class="token string">"F15"</span><span class="token punctuation">,</span> <span class="token number">186</span><span class="token punctuation">:</span> <span class="token string">"F16"</span><span class="token punctuation">,</span> <span class="token number">187</span><span class="token punctuation">:</span> <span class="token string">"F17"</span><span class="token punctuation">,</span> <span class="token number">188</span><span class="token punctuation">:</span> <span class="token string">"F18"</span><span class="token punctuation">,</span> <span class="token number">189</span><span class="token punctuation">:</span> <span class="token string">"F19"</span><span class="token punctuation">,</span> <span class="token number">190</span><span class="token punctuation">:</span> <span class="token string">"F20"</span><span class="token punctuation">,</span> <span class="token number">191</span><span class="token punctuation">:</span> <span class="token string">"F21"</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">:</span> <span class="token string">"F22"</span><span class="token punctuation">,</span> <span class="token number">193</span><span class="token punctuation">:</span> <span class="token string">"F23"</span><span class="token punctuation">,</span> <span class="token number">194</span><span class="token punctuation">:</span> <span class="token string">"F24"</span><span class="token punctuation">,</span>
	<span class="token number">200</span><span class="token punctuation">:</span> <span class="token string">"PLAYCD"</span><span class="token punctuation">,</span> <span class="token number">201</span><span class="token punctuation">:</span> <span class="token string">"PAUSECD"</span><span class="token punctuation">,</span> <span class="token number">202</span><span class="token punctuation">:</span> <span class="token string">"PROG3"</span><span class="token punctuation">,</span> <span class="token number">203</span><span class="token punctuation">:</span> <span class="token string">"PROG4"</span><span class="token punctuation">,</span> <span class="token number">204</span><span class="token punctuation">:</span> <span class="token string">"ALL_APPLICATIONS"</span><span class="token punctuation">,</span> <span class="token number">205</span><span class="token punctuation">:</span> <span class="token string">"SUSPEND"</span><span class="token punctuation">,</span> <span class="token number">206</span><span class="token punctuation">:</span> <span class="token string">"CLOSE"</span><span class="token punctuation">,</span> <span class="token number">207</span><span class="token punctuation">:</span> <span class="token string">"PLAY"</span><span class="token punctuation">,</span> <span class="token number">208</span><span class="token punctuation">:</span> <span class="token string">"FASTFORWARD"</span><span class="token punctuation">,</span>
	<span class="token number">209</span><span class="token punctuation">:</span> <span class="token string">"BASSBOOST"</span><span class="token punctuation">,</span> <span class="token number">210</span><span class="token punctuation">:</span> <span class="token string">"PRINT"</span><span class="token punctuation">,</span> <span class="token number">211</span><span class="token punctuation">:</span> <span class="token string">"HP"</span><span class="token punctuation">,</span> <span class="token number">212</span><span class="token punctuation">:</span> <span class="token string">"CAMERA"</span><span class="token punctuation">,</span> <span class="token number">213</span><span class="token punctuation">:</span> <span class="token string">"SOUND"</span><span class="token punctuation">,</span> <span class="token number">214</span><span class="token punctuation">:</span> <span class="token string">"QUESTION"</span><span class="token punctuation">,</span> <span class="token number">215</span><span class="token punctuation">:</span> <span class="token string">"EMAIL"</span><span class="token punctuation">,</span> <span class="token number">216</span><span class="token punctuation">:</span> <span class="token string">"CHAT"</span><span class="token punctuation">,</span> <span class="token number">217</span><span class="token punctuation">:</span> <span class="token string">"SEARCH"</span><span class="token punctuation">,</span> <span class="token number">218</span><span class="token punctuation">:</span> <span class="token string">"CONNECT"</span><span class="token punctuation">,</span>
	<span class="token number">219</span><span class="token punctuation">:</span> <span class="token string">"FINANCE"</span><span class="token punctuation">,</span> <span class="token number">220</span><span class="token punctuation">:</span> <span class="token string">"SPORT"</span><span class="token punctuation">,</span> <span class="token number">221</span><span class="token punctuation">:</span> <span class="token string">"SHOP"</span><span class="token punctuation">,</span> <span class="token number">222</span><span class="token punctuation">:</span> <span class="token string">"ALTERASE"</span><span class="token punctuation">,</span> <span class="token number">223</span><span class="token punctuation">:</span> <span class="token string">"CANCEL"</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">:</span> <span class="token string">"BRIGHTNESSDOWN"</span><span class="token punctuation">,</span> <span class="token number">225</span><span class="token punctuation">:</span> <span class="token string">"BRIGHTNESSUP"</span><span class="token punctuation">,</span> <span class="token number">226</span><span class="token punctuation">:</span> <span class="token string">"MEDIA"</span><span class="token punctuation">,</span>
	<span class="token number">227</span><span class="token punctuation">:</span> <span class="token string">"SWITCHVIDEOMODE"</span><span class="token punctuation">,</span> <span class="token number">228</span><span class="token punctuation">:</span> <span class="token string">"KBDILLUMTOGGLE"</span><span class="token punctuation">,</span> <span class="token number">229</span><span class="token punctuation">:</span> <span class="token string">"KBDILLUMDOWN"</span><span class="token punctuation">,</span> <span class="token number">230</span><span class="token punctuation">:</span> <span class="token string">"KBDILLUMUP"</span><span class="token punctuation">,</span> <span class="token number">231</span><span class="token punctuation">:</span> <span class="token string">"SEND"</span><span class="token punctuation">,</span> <span class="token number">232</span><span class="token punctuation">:</span> <span class="token string">"REPLY"</span><span class="token punctuation">,</span> <span class="token number">233</span><span class="token punctuation">:</span> <span class="token string">"FORWARDMAIL"</span><span class="token punctuation">,</span> <span class="token number">234</span><span class="token punctuation">:</span> <span class="token string">"SAVE"</span><span class="token punctuation">,</span>
	<span class="token number">235</span><span class="token punctuation">:</span> <span class="token string">"DOCUMENTS"</span><span class="token punctuation">,</span> <span class="token number">236</span><span class="token punctuation">:</span> <span class="token string">"BATTERY"</span><span class="token punctuation">,</span> <span class="token number">237</span><span class="token punctuation">:</span> <span class="token string">"BLUETOOTH"</span><span class="token punctuation">,</span> <span class="token number">238</span><span class="token punctuation">:</span> <span class="token string">"WLAN"</span><span class="token punctuation">,</span> <span class="token number">239</span><span class="token punctuation">:</span> <span class="token string">"UWB"</span><span class="token punctuation">,</span> <span class="token number">240</span><span class="token punctuation">:</span> <span class="token string">"UNKNOWN"</span><span class="token punctuation">,</span> <span class="token number">241</span><span class="token punctuation">:</span> <span class="token string">"VIDEO_NEXT"</span><span class="token punctuation">,</span> <span class="token number">242</span><span class="token punctuation">:</span> <span class="token string">"VIDEO_PREV"</span><span class="token punctuation">,</span>
	<span class="token number">243</span><span class="token punctuation">:</span> <span class="token string">"BRIGHTNESS_CYCLE"</span><span class="token punctuation">,</span> <span class="token number">244</span><span class="token punctuation">:</span> <span class="token string">"BRIGHTNESS_AUTO"</span><span class="token punctuation">,</span> <span class="token number">245</span><span class="token punctuation">:</span> <span class="token string">"DISPLAY_OFF"</span><span class="token punctuation">,</span> <span class="token number">246</span><span class="token punctuation">:</span> <span class="token string">"WWAN"</span><span class="token punctuation">,</span> <span class="token number">247</span><span class="token punctuation">:</span> <span class="token string">"RFKILL"</span><span class="token punctuation">,</span> <span class="token number">248</span><span class="token punctuation">:</span> <span class="token string">"MICMUTE"</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">keyStr</span><span class="token punctuation">(</span>code <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> code <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> code <span class="token operator">&gt;=</span> MAX_KEYS <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token string">"UNKNOWN"</span>
	<span class="token punctuation">}</span>
	name <span class="token operator">:=</span> keyNames<span class="token punctuation">[</span>code<span class="token punctuation">]</span>
	<span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">""</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">return</span> <span class="token string">"UNKNOWN"</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> name
<span class="token punctuation">}</span>

</code></pre>
    <ul>
     <li>
      <strong>
       <code>
        Parse
       </code>
       方法:
      </strong>
      <ul>
       <li>
        通过
        <code>
         binary.LittleEndian
        </code>
        格式解析数据，确保与内核传输的数据格式一致。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       <code>
        String
       </code>
       方法与键值映射:
      </strong>
      <ul>
       <li>
        利用预定义的
        <code>
         keyNames
        </code>
        数组映射按键码到具体按键名称。
       </li>
       <li>
        <code>
         keyStr
        </code>
        函数通过判断码值范围返回对应的字符串，如果不存在则返回
        <code>
         "UNKNOWN"
        </code>
        。
       </li>
      </ul>
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="5__374">
     </a>
     5. 总结
    </h3>
    <p>
     本文通过
     <code>
      Go
     </code>
     语言结合
     <code>
      libbpfgo
     </code>
     演示了如何利用eBPF实现键盘记录功能，具体如下：
    </p>
    <ul>
     <li>
      <strong>
       实时性:
      </strong>
      直接利用内核
      <code>
       kprobe
      </code>
      捕捉键盘事件，无需轮询，实时性极佳⏱️。
     </li>
     <li>
      <strong>
       高效性:
      </strong>
      通过
      <code>
       perf buffer
      </code>
      将数据高效传递到用户空间，确保系统性能不受影响。
     </li>
    </ul>
    <p>
     该方案不仅适用于键盘事件监控，还可以拓展到其他系统监控和安全检测场景。动手实践后，你也可以根据业务需求调整代码，实现更多高级功能。
    </p>
    <hr/>
    <h3>
     <a id="6__384">
     </a>
     6. 练习题
    </h3>
    <ol>
     <li>
      <strong>
       按键过滤:
      </strong>
      修改代码使其只记录特定按键（如
      <code>
       ESC
      </code>
      或
      <code>
       ENTER
      </code>
      ）的事件，并在用户空间进行特别处理。
     </li>
     <li>
      <strong>
       数据统计:
      </strong>
      增加功能，对每种按键的出现次数进行统计，并定时输出统计结果。
     </li>
     <li>
      <strong>
       扩展应用:
      </strong>
      在BPF程序中增加其他类型事件（如鼠标事件）的监控，探索更多内核事件的捕捉方式。
     </li>
    </ol>
    <p>
     🚀
     <strong>
      动手试试吧！遇到问题欢迎留言交流，一起进步！
     </strong>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34373736333632332f:61727469636c652f64657461696c732f313436323736353235" class_="artid" style="display:none">
 </p>
</div>


