---
layout: post
title: "TCP服务器监听状态检测原理与实现技术CC代码实现"
date: 2025-03-16 11:04:13 +0800
description: "在网络安全和系统管理中，检测TCP服务器是否正在监听特定端口是一项常见任务。本文将介绍一个基于C语言实现的TCP服务器监听检测工具的原理、相关技术和实现细节。"
keywords: "TCP服务器监听状态检测原理与实现技术（C/C++代码实现）"
categories: ['C']
tags: ['网络安全', '服务器', 'Tcp', 'C']
artid: "145971186"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145971186
    alt: "TCP服务器监听状态检测原理与实现技术CC代码实现"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145971186
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145971186
cover: https://bing.ee123.net/img/rand?artid=145971186
image: https://bing.ee123.net/img/rand?artid=145971186
img: https://bing.ee123.net/img/rand?artid=145971186
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     TCP服务器监听状态检测原理与实现技术（C/C++代码实现）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     在网络安全和系统管理中，检测TCP服务器是否正在监听特定端口是一项常见任务。本文将介绍一个基于C语言实现的TCP服务器监听检测工具的原理、相关技术和实现细节。
    </p>
    <h3>
     <a id="_4">
     </a>
     概述
    </h3>
    <p>
     该工具通过发送TCP连接请求来检测目标服务器是否在指定端口上监听。它支持IPv4和IPv6，并允许用户自定义连接超时和等待超时时间。工具的核心功能包括：
    </p>
    <ul>
     <li>
      检测TCP服务器是否监听特定端口。
     </li>
     <li>
      支持非阻塞连接和超时机制。
     </li>
     <li>
      提供灵活的命令行选项配置。
     </li>
    </ul>
    <h3>
     <a id="_11">
     </a>
     技术原理
    </h3>
    <h4>
     <a id="1_TCP_13">
     </a>
     1. TCP三次握手
    </h4>
    <p>
     TCP连接的建立基于三次握手过程：
    </p>
    <ol>
     <li>
      客户端发送
      <code>
       SYN
      </code>
      包到服务器。
     </li>
     <li>
      服务器响应
      <code>
       SYN-ACK
      </code>
      包。
     </li>
     <li>
      客户端发送
      <code>
       ACK
      </code>
      包完成握手。
     </li>
    </ol>
    <p>
     如果服务器正在监听目标端口，它会响应
     <code>
      SYN-ACK
     </code>
     包；否则，连接将失败或超时。
    </p>
    <h4>
     <a id="2__22">
     </a>
     2. 非阻塞连接
    </h4>
    <p>
     非阻塞套接字允许程序在发起连接后立即返回，而无需等待连接完成。这使得程序可以在连接过程中执行其他任务，提高效率。
    </p>
    <h4>
     <a id="3_poll_26">
     </a>
     3.
     <code>
      poll
     </code>
     机制
    </h4>
    <p>
     <code>
      poll
     </code>
     系统调用用于监控文件描述符的状态（如是否可读、可写或出错）。在本工具中，
     <code>
      poll
     </code>
     用于检测套接字是否准备好进行数据传输或是否存在错误。
    </p>
    <h3>
     <a id="TCPCC_30">
     </a>
     TCP服务器监听状态检测原理与实现技术（C/C++代码实现）
    </h3>
    <pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">scanfix</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> <span class="token operator">*</span>result<span class="token punctuation">,</span> <span class="token keyword">int</span> scale<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token punctuation">)</span><span class="token operator">-</span><span class="token char">'0'</span> <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&lt;=</span> UINT64_MAX<span class="token operator">/</span><span class="token number">10</span> <span class="token operator">&amp;&amp;</span> <span class="token number">10</span><span class="token operator">*</span>r <span class="token operator">&lt;=</span> UINT64_MAX<span class="token operator">-</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token punctuation">)</span><span class="token operator">-</span><span class="token char">'0'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				r <span class="token operator">=</span> r<span class="token operator">*</span><span class="token number">10</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>s<span class="token punctuation">)</span><span class="token operator">-</span><span class="token char">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span>
				<span class="token keyword">return</span> <span class="token operator">-</span>ERANGE<span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>s <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>d<span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
			d <span class="token operator">=</span> s <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		s<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>d<span class="token punctuation">)</span>
		d <span class="token operator">=</span> s<span class="token punctuation">;</span>

	<span class="token keyword">int</span> o <span class="token operator">=</span> scale <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>s<span class="token operator">-</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> o <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span> o<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&gt;</span> UINT64_MAX<span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>ERANGE<span class="token punctuation">;</span>
		r <span class="token operator">*=</span> <span class="token number">10</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> o <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span> o<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token operator">-</span>ERANGE<span class="token punctuation">;</span>
		r <span class="token operator">/=</span> <span class="token number">10</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token operator">*</span>result <span class="token operator">=</span> r<span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span>
<span class="token function">syn_scan</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> sock <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>addr<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span>
	    addr<span class="token operator">-&gt;</span>ai_socktype <span class="token operator">|</span> SOCK_NONBLOCK<span class="token punctuation">,</span>
	    addr<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">linger</span> l <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token function">setsockopt</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_LINGER<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>l<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">linger</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> zero <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">setsockopt</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> IPPROTO_TCP<span class="token punctuation">,</span> TCP_QUICKACK<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>zero<span class="token punctuation">,</span> <span class="token keyword">sizeof</span> zero<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> r<span class="token punctuation">;</span>
	errno <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	r <span class="token operator">=</span> <span class="token function">connect</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span> addr<span class="token operator">-&gt;</span>ai_addr<span class="token punctuation">,</span> addr<span class="token operator">-&gt;</span>ai_addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> errno <span class="token operator">!=</span> EINPROGRESS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"connect failed: %m\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">99</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">struct</span> <span class="token class-name">pollfd</span> fds<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	fds<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">pollfd</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> sock<span class="token punctuation">,</span> POLLIN <span class="token operator">|</span> POLLOUT <span class="token operator">|</span> POLLERR<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	r <span class="token operator">=</span> <span class="token function">poll</span><span class="token punctuation">(</span>fds<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> connect_timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"timeout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"??? poll = %d %m\n"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">close</span><span class="token punctuation">(</span>sock<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">99</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token keyword">return</span> <span class="token number">99</span><span class="token punctuation">;</span>		
<span class="token punctuation">}</span>

<span class="token keyword">int</span>
<span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">=</span> <span class="token function">getopt</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token string">"+46t:w:"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token char">'4'</span><span class="token operator">:</span> protocol <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token char">'6'</span><span class="token operator">:</span> protocol <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token char">'t'</span><span class="token operator">:</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>err <span class="token operator">=</span> <span class="token function">scanfix</span><span class="token punctuation">(</span>optarg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>connect_timeout<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"failed to parse number '%s': %s\n"</span><span class="token punctuation">,</span>
				    optarg<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token operator">-</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">goto</span> usage<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token char">'w'</span><span class="token operator">:</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>err <span class="token operator">=</span> <span class="token function">scanfix</span><span class="token punctuation">(</span>optarg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wait_timeout<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"failed to parse number '%s': %s\n"</span><span class="token punctuation">,</span>
				    optarg<span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span><span class="token operator">-</span>err<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">goto</span> usage<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
		usage<span class="token operator">:</span>
                        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span>
                            <span class="token string">"Usage: %s [-w WAIT_TIMEOUT] [-t CONNECT_TIMEOUT] [HOST] PORT\n"</span><span class="token punctuation">,</span>
                            argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> <span class="token number">99</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> hints <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token function">clock_gettime</span><span class="token punctuation">(</span>CLOCK_MONOTONIC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
	deadline<span class="token punctuation">.</span>tv_sec <span class="token operator">=</span> now<span class="token punctuation">.</span>tv_sec<span class="token punctuation">;</span>
	deadline<span class="token punctuation">.</span>tv_nsec <span class="token operator">=</span> now<span class="token punctuation">.</span>tv_nsec <span class="token operator">+</span> wait_timeout<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>deadline<span class="token punctuation">.</span>tv_nsec <span class="token operator">&gt;=</span> <span class="token number">1000000000L</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		deadline<span class="token punctuation">.</span>tv_sec <span class="token operator">+=</span> deadline<span class="token punctuation">.</span>tv_nsec <span class="token operator">/</span> <span class="token number">1000000000L</span><span class="token punctuation">;</span>
		deadline<span class="token punctuation">.</span>tv_nsec <span class="token operator">=</span> deadline<span class="token punctuation">.</span>tv_nsec <span class="token operator">%</span> <span class="token number">1000000000L</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span>now<span class="token punctuation">.</span>tv_sec <span class="token operator">&lt;</span> deadline<span class="token punctuation">.</span>tv_sec <span class="token operator">||</span>
	    <span class="token punctuation">(</span>now<span class="token punctuation">.</span>tv_sec <span class="token operator">==</span> deadline<span class="token punctuation">.</span>tv_sec <span class="token operator">&amp;&amp;</span> now<span class="token punctuation">.</span>tv_nsec <span class="token operator">&lt;=</span> deadline<span class="token punctuation">.</span>tv_nsec<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token function">syn_scan</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">99</span><span class="token operator">:</span>
			<span class="token keyword">return</span> <span class="token number">99</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
			<span class="token function">nanosleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>delay<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// avoid busy wait</span>
		<span class="token punctuation">}</span>

		<span class="token function">clock_gettime</span><span class="token punctuation">(</span>CLOCK_MONOTONIC<span class="token punctuation">,</span> <span class="token operator">&amp;</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     If you need the complete source code, please add the WeChat number (
     <strong>
      c17865354792
     </strong>
     )
    </p>
    <h4>
     <a id="1__174">
     </a>
     1. 命令行参数解析
    </h4>
    <p>
     工具通过
     <code>
      getopt
     </code>
     函数解析命令行参数，支持以下选项：
    </p>
    <ul>
     <li>
      <code>
       -4
      </code>
      ：强制使用IPv4。
     </li>
     <li>
      <code>
       -6
      </code>
      ：强制使用IPv6。
     </li>
     <li>
      <code>
       -t
      </code>
      ：设置连接超时时间（单位：毫秒）。
     </li>
     <li>
      <code>
       -w
      </code>
      ：设置等待超时时间（单位：纳秒）。
     </li>
    </ul>
    <h4>
     <a id="2__182">
     </a>
     2. 地址解析
    </h4>
    <p>
     使用
     <code>
      getaddrinfo
     </code>
     函数将目标主机名和端口解析为套接字地址结构（
     <code>
      struct addrinfo
     </code>
     ）。该函数支持IPv4和IPv6地址，并允许指定地址族和套接字类型。
    </p>
    <h4>
     <a id="3__186">
     </a>
     3. 非阻塞连接
    </h4>
    <p>
     通过
     <code>
      socket
     </code>
     函数创建非阻塞套接字，并使用
     <code>
      connect
     </code>
     函数发起连接请求。如果连接成功或处于进行中状态，
     <code>
      connect
     </code>
     将返回特定值。
    </p>
    <h4>
     <a id="4__190">
     </a>
     4. 超时处理
    </h4>
    <p>
     工具使用
     <code>
      poll
     </code>
     监控套接字状态，并根据用户指定的超时时间决定是否继续等待。如果连接超时或失败，工具将输出相应信息并退出。
    </p>
    <h4>
     <a id="5__194">
     </a>
     5. 等待机制
    </h4>
    <p>
     如果用户指定了等待超时时间（
     <code>
      -w
     </code>
     选项），工具将在指定时间内反复尝试连接目标服务器。每次尝试之间会使用
     <code>
      nanosleep
     </code>
     函数引入延迟，避免频繁尝试。
    </p>
    <h3>
     <a id="_198">
     </a>
     应用场景
    </h3>
    <p>
     该工具适用于以下场景：
    </p>
    <ul>
     <li>
      <strong>
       网络安全扫描
      </strong>
      ：检测目标服务器的开放端口。
     </li>
     <li>
      <strong>
       服务监控
      </strong>
      ：检查关键服务是否正常运行。
     </li>
     <li>
      <strong>
       自动化测试
      </strong>
      ：验证网络服务的可用性。
     </li>
    </ul>
    <h3>
     <a id="_205">
     </a>
     总结
    </h3>
    <p>
     本文介绍了基于C语言实现的TCP服务器监听检测工具的原理和实现细节。通过非阻塞连接、
     <code>
      poll
     </code>
     机制和灵活的超时配置，该工具能够高效地检测目标服务器的监听状态。它在网络管理、安全检测和自动化测试中具有广泛的应用价值。
    </p>
    <p>
     Welcome to follow WeChat official account【
     <strong>
      程序猿编码
     </strong>
     】
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f67:2e6373646e2e6e65742f6368656e313431353838363034342f:61727469636c652f64657461696c732f313435393731313836" class_="artid" style="display:none">
 </p>
</div>


