---
layout: post
title: "STM32-HAL库实战轻松实现串口通信驱动蓝牙模块与ESP8266开发"
date: 2025-03-13 15:34:56 +0800
description: "本文通过详细的步骤介绍了如何在STM32F103C8T6上使用HAL库进行串口通信，并展示了如何通过串口驱动蓝牙模块（HC-08）和WiFi模块（ESP8266）。这些技术为实现无线通信功能提供了坚实的基础，适用于各种嵌入式系统应用。"
keywords: "STM32 HAL库实战：轻松实现串口通信驱动蓝牙模块与ESP8266开发"
categories: ['嵌入式开发笔记']
tags: ['嵌入式硬件', '单片机', 'Stm']
artid: "146227794"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146227794
    alt: "STM32-HAL库实战轻松实现串口通信驱动蓝牙模块与ESP8266开发"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146227794
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146227794
cover: https://bing.ee123.net/img/rand?artid=146227794
image: https://bing.ee123.net/img/rand?artid=146227794
img: https://bing.ee123.net/img/rand?artid=146227794
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     STM32 HAL库实战：轻松实现串口通信驱动蓝牙模块与ESP8266开发
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="STM32_HALESP8266_1">
     </a>
     STM32 HAL库实战：轻松实现串口通信驱动蓝牙模块与ESP8266开发
    </h2>
    <hr/>
    <h3>
     <a id="_3">
     </a>
     引言
    </h3>
    <p>
     STM32F103C8T6作为一款性能强劲的32位微控制器，广泛应用于各类嵌入式系统。本文将详细介绍如何使用STM32F103C8T6的HAL库进行串口通信，并展示如何通过串口驱动蓝牙模块（如HC-05）和WiFi模块（如ESP8266），实现无线通信功能。
    </p>
    <hr/>
    <h3>
     <a id="_8">
     </a>
     一、串口通信基础
    </h3>
    <h4>
     <a id="11__9">
     </a>
     1.1 串口通信原理
    </h4>
    <p>
     串口通信是一种广泛使用的通信方式，通过一根发送线（TX）和一根接收线（RX）进行数据传输。STM32F103C8T6提供了多个USART（通用同步异步收发器）接口，支持全双工通信。
    </p>
    <h4>
     <a id="12_HAL_13">
     </a>
     1.2 HAL库配置串口
    </h4>
    <ul>
     <li>
      <h5>
       <a id="_14">
       </a>
       <strong>
        串口初始化设置
       </strong>
       ：
      </h5>
     </li>
    </ul>
    <p>
     在HAL库中，串口通信的配置主要包括波特率设置、数据位、停止位和校验位等。以下是一个基本的串口初始化代码示例：
    </p>
    <pre><code class="prism language-c">UART_HandleTypeDef uart1_handle<span class="token punctuation">;</span>                                            <span class="token comment">/* UART1句柄 */</span>

<span class="token comment">/**
 * @brief       串口1初始化函数
 * @param       baudrate: 波特率, 根据自己需要设置波特率值
 * @retval      无
 */</span>
<span class="token keyword">void</span> <span class="token function">uart1_init</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> baudrate<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*UART1 初始化设置*/</span>
    uart1_handle<span class="token punctuation">.</span>Instance <span class="token operator">=</span> USART1<span class="token punctuation">;</span>                                         <span class="token comment">/* USART1 */</span>
    uart1_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>BaudRate <span class="token operator">=</span> baudrate<span class="token punctuation">;</span>                                  <span class="token comment">/* 波特率 */</span>
    uart1_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>WordLength <span class="token operator">=</span> UART_WORDLENGTH_8B<span class="token punctuation">;</span>                      <span class="token comment">/* 字长为8位数据格式 */</span>
    uart1_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>StopBits <span class="token operator">=</span> UART_STOPBITS_1<span class="token punctuation">;</span>                           <span class="token comment">/* 一个停止位 */</span>
    uart1_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Parity <span class="token operator">=</span> UART_PARITY_NONE<span class="token punctuation">;</span>                            <span class="token comment">/* 无奇偶校验位 */</span>
    uart1_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>HwFlowCtl <span class="token operator">=</span> UART_HWCONTROL_NONE<span class="token punctuation">;</span>                      <span class="token comment">/* 无硬件流控 */</span>
    uart1_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Mode <span class="token operator">=</span> UART_MODE_TX_RX<span class="token punctuation">;</span>                               <span class="token comment">/* 收发模式 */</span>
    <span class="token function">HAL_UART_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uart1_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>                                           <span class="token comment">/* HAL_UART_Init()会使能UART1 */</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <h5>
       <a id="_37">
       </a>
       串口底层初始化：
      </h5>
     </li>
    </ul>
    <p>
     在以下代码中，当函数调用HAL_UART_Init()函数时，就会自动调用 ‌HAL_UART_MspInit()‌，以完成底层硬件相关的配置。
     <br/>
     在下方代码中，我们配置与硬件相关的部分，例如：
    </p>
    <ul>
     <li>
      使能UART和GPIO的时钟。
     </li>
     <li>
      初始化TX/RX引脚（配置为复用功能）。
     </li>
     <li>
      配置中断（串口中断和总线空闲中断）。
     </li>
    </ul>
    <pre><code class="prism language-c">
<span class="token comment">/**
 * @brief       UART底层初始化函数
 * @param       huart: UART句柄类型指针
 * @note        此函数会被HAL_UART_Init()调用
 *              完成时钟使能，引脚配置，中断配置
 * @retval      无
 */</span>
<span class="token keyword">void</span> <span class="token function">HAL_UART_MspInit</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    GPIO_InitTypeDef gpio_init_struct<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>Instance <span class="token operator">==</span> USART1<span class="token punctuation">)</span>                                          <span class="token comment">/* 如果是串口1，进行串口1 MSP初始化 */</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                       <span class="token comment">/* 使能串口TX脚时钟 */</span>
        <span class="token function">__HAL_RCC_USART1_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                      <span class="token comment">/* 使能串口时钟 */</span>

        gpio_init_struct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_9<span class="token punctuation">;</span>                                  <span class="token comment">/* 串口发送引脚号 */</span>
        gpio_init_struct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_AF_PP<span class="token punctuation">;</span>                            <span class="token comment">/* 复用推挽输出 */</span>
        gpio_init_struct<span class="token punctuation">.</span>Pull <span class="token operator">=</span> GPIO_PULLUP<span class="token punctuation">;</span>                                <span class="token comment">/* 上拉 */</span>
        gpio_init_struct<span class="token punctuation">.</span>Speed <span class="token operator">=</span> GPIO_SPEED_FREQ_HIGH<span class="token punctuation">;</span>                      <span class="token comment">/* IO速度设置为高速 */</span>
        <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gpio_init_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
        gpio_init_struct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_10<span class="token punctuation">;</span>                                 <span class="token comment">/* 串口RX脚 模式设置 */</span>
        gpio_init_struct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_AF_INPUT<span class="token punctuation">;</span>    
        <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gpio_init_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">/* 串口RX脚 必须设置成输入模式 */</span>
        
        <span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token comment">/* 使能USART1中断通道 */</span>
        <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">/* 组2，最低优先级:抢占优先级3，子优先级3 */</span>

        <span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> UART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">/* 使能UART1接收中断 */</span>
        <span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> UART_IT_IDLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">/* 使能UART1总线空闲中断 */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <ul>
     <li>
      <h5>
       <a id="_80">
       </a>
       串口中断处理函数:
      </h5>
     </li>
    </ul>
    <p>
     这边暂时体供串口1的中断处理函数。由于我们串口1开启了两个中断：
    </p>
    <ul>
     <li>
      <ul>
       <li>
        接收寄存器非空触发中断
       </li>
       <li>
        串口空闲线路中断
       </li>
      </ul>
     </li>
    </ul>
    <p>
     我们在以下中断处理函数中，处理这两个中断。接收非空中断触发时，将接收到的数据进行缓存到数组中，当触发空闲中断说明数据接收完毕，则将数据打印出来。这边使用printf函数，需要堆fputc函数进行该写。
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">UART1_RX_BUF_SIZE</span>            <span class="token expression"><span class="token number">128</span>  </span><span class="token comment">// </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">UART1_TX_BUF_SIZE</span>            <span class="token expression"><span class="token number">64</span></span></span>
<span class="token class-name">uint8_t</span> uart1_rx_buf<span class="token punctuation">[</span>UART1_RX_BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>                                    <span class="token comment">/* UART1接收缓冲区 */</span>

<span class="token comment">/**
 * @brief       UART1接收缓冲区清除
 * @param       无
 * @retval      无
 */</span>
<span class="token keyword">void</span> <span class="token function">uart1_rx_clear</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">memset</span><span class="token punctuation">(</span>uart1_rx_buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uart1_rx_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">/* 清空接收缓冲区 */</span>
    uart1_rx_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                                       <span class="token comment">/* 接收计数器清零 */</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * @brief       串口1中断服务函数
 * @note        在此使用接收中断及空闲中断，实现不定长数据收发
 * @param       无
 * @retval      无
 */</span>
<span class="token keyword">void</span> <span class="token function">HAL_UART_MspInit</span><span class="token punctuation">(</span>UART_HandleTypeDef <span class="token operator">*</span>huart<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    GPIO_InitTypeDef gpio_init_struct<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>Instance <span class="token operator">==</span> USART1<span class="token punctuation">)</span>                                          <span class="token comment">/* 如果是串口1，进行串口1 MSP初始化 */</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                       <span class="token comment">/* 使能串口TX脚时钟 */</span>
        <span class="token function">__HAL_RCC_USART1_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                      <span class="token comment">/* 使能串口时钟 */</span>

        gpio_init_struct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_9<span class="token punctuation">;</span>                                  <span class="token comment">/* 串口发送引脚号 */</span>
        gpio_init_struct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_AF_PP<span class="token punctuation">;</span>                            <span class="token comment">/* 复用推挽输出 */</span>
        gpio_init_struct<span class="token punctuation">.</span>Pull <span class="token operator">=</span> GPIO_PULLUP<span class="token punctuation">;</span>                                <span class="token comment">/* 上拉 */</span>
        gpio_init_struct<span class="token punctuation">.</span>Speed <span class="token operator">=</span> GPIO_SPEED_FREQ_HIGH<span class="token punctuation">;</span>                      <span class="token comment">/* IO速度设置为高速 */</span>
        <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gpio_init_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
        gpio_init_struct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_10<span class="token punctuation">;</span>                                 <span class="token comment">/* 串口RX脚 模式设置 */</span>
        gpio_init_struct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_AF_INPUT<span class="token punctuation">;</span>    
        <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gpio_init_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">/* 串口RX脚 必须设置成输入模式 */</span>
        
        <span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token comment">/* 使能USART1中断通道 */</span>
        <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>USART1_IRQn<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">/* 组2，最低优先级:抢占优先级3，子优先级3 */</span>

        <span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> UART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">/* 使能UART1接收中断 */</span>
        <span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> UART_IT_IDLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">/* 使能UART1总线空闲中断 */</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>huart<span class="token operator">-&gt;</span>Instance <span class="token operator">==</span> USART2<span class="token punctuation">)</span>                                          <span class="token comment">/* 如果是串口2，进行串口2 MSP初始化 */</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">__HAL_RCC_GPIOA_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                       <span class="token comment">/* 使能串口TX脚时钟 */</span>
        <span class="token function">__HAL_RCC_USART2_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                      <span class="token comment">/* 使能串口时钟 */</span>

        gpio_init_struct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_2<span class="token punctuation">;</span>                                  <span class="token comment">/* 串口发送引脚号 */</span>
        gpio_init_struct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_AF_PP<span class="token punctuation">;</span>                            <span class="token comment">/* 复用推挽输出 */</span>
        gpio_init_struct<span class="token punctuation">.</span>Pull <span class="token operator">=</span> GPIO_PULLUP<span class="token punctuation">;</span>                                <span class="token comment">/* 上拉 */</span>
        gpio_init_struct<span class="token punctuation">.</span>Speed <span class="token operator">=</span> GPIO_SPEED_FREQ_HIGH<span class="token punctuation">;</span>                      <span class="token comment">/* IO速度设置为高速 */</span>
        <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gpio_init_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>
                
        gpio_init_struct<span class="token punctuation">.</span>Pin <span class="token operator">=</span> GPIO_PIN_3<span class="token punctuation">;</span>                                 <span class="token comment">/* 串口RX脚 模式设置 */</span>
        gpio_init_struct<span class="token punctuation">.</span>Mode <span class="token operator">=</span> GPIO_MODE_AF_INPUT<span class="token punctuation">;</span>    
        <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gpio_init_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">/* 串口RX脚 必须设置成输入模式 */</span>
        
        <span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>USART2_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span>                                    <span class="token comment">/* 使能USART2中断通道 */</span>
        <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>USART2_IRQn<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token comment">/* 组2，最低优先级:抢占优先级3，子优先级3 */</span>

        <span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> UART_IT_RXNE<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">/* 使能UART2接收中断 */</span>
        <span class="token function">__HAL_UART_ENABLE_IT</span><span class="token punctuation">(</span>huart<span class="token punctuation">,</span> UART_IT_IDLE<span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">/* 使能UART2总线空闲中断 */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <ul>
     <li>
      <h5>
       <a id="fputc_157">
       </a>
       改写fputc函数
      </h5>
     </li>
    </ul>
    <p>
     我们改写fputc函数，这样就可以直接使用printf函数进行串口打印。
    </p>
    <pre><code class="prism language-c"><span class="token comment">/**
 * @brief       重定义fputc函数
 * @note        printf函数最终会通过调用fputc输出字符串到串口
 */</span>
<span class="token keyword">int</span> <span class="token function">fputc</span><span class="token punctuation">(</span><span class="token keyword">int</span> ch<span class="token punctuation">,</span> FILE <span class="token operator">*</span>f<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>USART1<span class="token operator">-&gt;</span>SR <span class="token operator">&amp;</span> <span class="token number">0X40</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                       <span class="token comment">/* 等待上一个字符发送完成 */</span>

    USART1<span class="token operator">-&gt;</span>DR <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span><span class="token punctuation">)</span>ch<span class="token punctuation">;</span>                                               <span class="token comment">/* 将要发送的字符 ch 写入到DR寄存器 */</span>
    <span class="token keyword">return</span> ch<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     做完这些操作，编译时也记得打开使用MicroLIB。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/37aefbe628f9446782188596c227f431.png">
      <br/>
      至此，我们可以使用printf函数直接利用CH340单片机给电脑发送串口消息。
     </img>
    </p>
    <h3>
     <a id="HC08_178">
     </a>
     二、驱动蓝牙模块（HC-08）
    </h3>
    <h4>
     <a id="21__179">
     </a>
     2.1 硬件连接
    </h4>
    <p>
     将HC-08蓝牙模块的TX引脚连接到STM32的RX引脚，将HC-08的RX引脚连接到STM32的TX引脚。同时，确保蓝牙模块和STM32共地。
    </p>
    <h4>
     <a id="22__183">
     </a>
     2.2 软件配置
    </h4>
    <p>
     在串口初始化完成后，可以通过串口发送AT指令来配置HC-08蓝牙模块。例如，设置蓝牙模块的名称和配对密码，
     <br/>
     我们使用串口二与之交叉相连。
    </p>
    <ul>
     <li>
      <h5>
       <a id="_187">
       </a>
       初始化函数
      </h5>
     </li>
    </ul>
    <pre><code class="prism language-c">UART_HandleTypeDef uart2_handle<span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">bt_init</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> baudrate<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*uart2 初始化设置*/</span>
    uart2_handle<span class="token punctuation">.</span>Instance <span class="token operator">=</span> USART2<span class="token punctuation">;</span>                                         <span class="token comment">/* USART1 */</span>
    uart2_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>BaudRate <span class="token operator">=</span> baudrate<span class="token punctuation">;</span>                                  <span class="token comment">/* 波特率 */</span>
    uart2_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>WordLength <span class="token operator">=</span> UART_WORDLENGTH_8B<span class="token punctuation">;</span>                      <span class="token comment">/* 字长为8位数据格式 */</span>
    uart2_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>StopBits <span class="token operator">=</span> UART_STOPBITS_1<span class="token punctuation">;</span>                           <span class="token comment">/* 一个停止位 */</span>
    uart2_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Parity <span class="token operator">=</span> UART_PARITY_NONE<span class="token punctuation">;</span>                            <span class="token comment">/* 无奇偶校验位 */</span>
    uart2_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>HwFlowCtl <span class="token operator">=</span> UART_HWCONTROL_NONE<span class="token punctuation">;</span>                      <span class="token comment">/* 无硬件流控 */</span>
    uart2_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Mode <span class="token operator">=</span> UART_MODE_TX_RX<span class="token punctuation">;</span>                               <span class="token comment">/* 收发模式 */</span>
    <span class="token function">HAL_UART_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uart2_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>                                           <span class="token comment">/* HAL_UART_Init()会使能uart2 */</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <h5>
       <a id="_205">
       </a>
       中断处理函数
      </h5>
     </li>
    </ul>
    <pre><code class="prism language-c">
<span class="token comment">/**
 * @brief       uart2接收缓冲区清除
 * @param       无
 * @retval      无
 */</span>
<span class="token keyword">void</span> <span class="token function">uart2_rx_clear</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">memset</span><span class="token punctuation">(</span>uart2_rx_buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uart2_rx_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                          <span class="token comment">/* 清空接收缓冲区 */</span>
    uart2_rx_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                                       <span class="token comment">/* 接收计数器清零 */</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * @brief       串口2中断服务函数
 * @note        在此使用接收中断及空闲中断，实现不定长数据收发
 * @param       无
 * @retval      无
 */</span>
<span class="token keyword">void</span> <span class="token function">USART2_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> receive_data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>   
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">__HAL_UART_GET_FLAG</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uart2_handle<span class="token punctuation">,</span> UART_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>        <span class="token comment">/* 获取接收RXNE标志位是否被置位 */</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>uart2_rx_len <span class="token operator">&gt;=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>uart2_rx_buf<span class="token punctuation">)</span><span class="token punctuation">)</span>                            <span class="token comment">/* 如果接收的字符数大于接收缓冲区大小， */</span>
            uart2_rx_len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                                               <span class="token comment">/* 则将接收计数器清零 */</span>
        <span class="token function">HAL_UART_Receive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uart2_handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>receive_data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">/* 接收一个字符 */</span>
        uart2_rx_buf<span class="token punctuation">[</span>uart2_rx_len<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> receive_data<span class="token punctuation">;</span>                        <span class="token comment">/* 将接收到的字符保存在接收缓冲区 */</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">__HAL_UART_GET_FLAG</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uart2_handle<span class="token punctuation">,</span> UART_FLAG_IDLE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span>        <span class="token comment">/* 获取接收空闲中断标志位是否被置位 */</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bt recv: %s\r\n"</span><span class="token punctuation">,</span> uart2_rx_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>                               <span class="token comment">/* 将接收到的数据打印出来 */</span>
        <span class="token function">uart2_rx_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">__HAL_UART_CLEAR_IDLEFLAG</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uart2_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">/* 清除UART总线空闲中断 */</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <h5>
       <a id="_243">
       </a>
       重写蓝牙发送函数
      </h5>
     </li>
    </ul>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stdarg.h"</span></span>


<span class="token keyword">void</span> <span class="token function">bt_send</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span> format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> send_buf<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span> <span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    va_list arg<span class="token punctuation">;</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">vsprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>send_buf<span class="token punctuation">,</span> format<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uart2_handle<span class="token punctuation">,</span> send_buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>send_buf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="23__258">
     </a>
     2.3 数据收发
    </h4>
    <p>
     配置完成后，即可通过串口与蓝牙模块进行数据收发。例如：
    </p>
    <pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">/* 初始化HAL库 */</span>
    <span class="token function">stm32_clock_init</span><span class="token punctuation">(</span>RCC_PLL_MUL9<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">/* 设置时钟, 72Mhz */</span>
    <span class="token function">uart1_init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bt_init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello world!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">uint8_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span> 
        <span class="token function">bt_send</span><span class="token punctuation">(</span><span class="token string">"hello, bt%d\r\n"</span><span class="token punctuation">,</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="WiFiESP8266_280">
     </a>
     三、驱动WiFi模块（ESP8266）
    </h3>
    <p>
     为避免文章过长，ESP8266的驱动，本文暂时只讲最简单的连接测试，他的几种连接方式放在明天的文章中，进行详细介绍。
    </p>
    <h4>
     <a id="31__282">
     </a>
     3.1 硬件连接
    </h4>
    <p>
     将ESP8266模块的TX引脚连接到STM32的RX引脚，将ESP8266的RX引脚连接到STM32的TX引脚。同时，确保ESP8266的VCC、GND正确连接。
    </p>
    <h4>
     <a id="32__284">
     </a>
     3.2 软件配置
    </h4>
    <p>
     ESP8266的配置相对复杂，需要通过串口发送AT指令进行WiFi连接和TCP/UDP通信设置。
     <br/>
     在这个案例中，我们接收连续字符串不采用空闲中断，所以在
     <code>
      HAL_UART_MspInit
     </code>
     函数中，我们将串口2的IDLE中断注释。
     <br/>
     以下是一个简单的WiFi连接示例：
    </p>
    <ul>
     <li>
      <h5>
       <a id="_290">
       </a>
       <strong>
        串口初始化
       </strong>
      </h5>
     </li>
    </ul>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESP8266_RX_BUF_SIZE</span>  <span class="token expression"><span class="token number">128</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESP8266_TX_BUF_SIZE</span>  <span class="token expression"><span class="token number">64</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESP8266_EOK</span>        <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESP8266_ERROR</span>      <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESP8266_ETIMEOUT</span>   <span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ESP8266_EINVAL</span>     <span class="token expression"><span class="token number">3</span></span></span>
</code></pre>
    <pre><code class="prism language-c">UART_HandleTypeDef esp8266_handle <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">esp8266_uart_init</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> baudrate<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    esp8266_handle<span class="token punctuation">.</span>Instance <span class="token operator">=</span> USART2<span class="token punctuation">;</span>
    esp8266_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>BaudRate <span class="token operator">=</span> baudrate<span class="token punctuation">;</span>
    esp8266_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>WordLength <span class="token operator">=</span> UART_WORDLENGTH_8B<span class="token punctuation">;</span>
    esp8266_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>StopBits <span class="token operator">=</span> UART_STOPBITS_1<span class="token punctuation">;</span>
    esp8266_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Parity <span class="token operator">=</span> UART_PARITY_NONE<span class="token punctuation">;</span>
    esp8266_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>HwFlowCtl <span class="token operator">=</span> UART_HWCONTROL_NONE<span class="token punctuation">;</span>
    esp8266_handle<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Mode <span class="token operator">=</span> UART_MODE_TX_RX<span class="token punctuation">;</span>
    <span class="token function">HAL_UART_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>esp8266_handle<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <h5>
       <a id="_315">
       </a>
       中断函数
      </h5>
     </li>
    </ul>
    <pre><code class="prism language-c"><span class="token class-name">uint8_t</span> esp8266_rx_buf<span class="token punctuation">[</span>ESP8266_RX_BUF_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token class-name">uint16_t</span> esp8266_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> esp8266_cntPre <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">USART2_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> receive_data <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">__HAL_UART_GET_FLAG</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>esp8266_handle<span class="token punctuation">,</span> UART_FLAG_RXNE<span class="token punctuation">)</span> <span class="token operator">!=</span> RESET<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>esp8266_cnt <span class="token operator">&gt;=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>esp8266_rx_buf<span class="token punctuation">)</span><span class="token punctuation">)</span>
            esp8266_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">HAL_UART_Receive</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>esp8266_handle<span class="token punctuation">,</span> <span class="token operator">&amp;</span>receive_data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        esp8266_rx_buf<span class="token punctuation">[</span>esp8266_cnt<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> receive_data<span class="token punctuation">;</span>
        <span class="token comment">//uart1_cnt++;</span>
        <span class="token comment">//HAL_UART_Transmit(&amp;uart1_handle, &amp;receive_data, 1, 1000);</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <ul>
     <li>
      <h5>
       <a id="_335">
       </a>
       判断函数
      </h5>
     </li>
    </ul>
    <pre><code class="prism language-c"><span class="token class-name">uint8_t</span> <span class="token function">esp8266_wait_receive</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>esp8266_cnt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ESP8266_ERROR<span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span>esp8266_cnt <span class="token operator">==</span> esp8266_cntPre<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        esp8266_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ESP8266_EOK<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    esp8266_cntPre <span class="token operator">=</span> esp8266_cnt<span class="token punctuation">;</span>
    <span class="token keyword">return</span> ESP8266_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <h5>
       <a id="_352">
       </a>
       清除函数
      </h5>
     </li>
    </ul>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">esp8266_rx_clear</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">memset</span><span class="token punctuation">(</span>esp8266_rx_buf<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>esp8266_rx_buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    esp8266_cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <h5>
       <a id="_360">
       </a>
       接收函数
      </h5>
     </li>
    </ul>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">esp8266_receive_data</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">esp8266_wait_receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ESP8266_EOK<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"esp8266 recv: %s\r\n"</span><span class="token punctuation">,</span> esp8266_rx_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">esp8266_rx_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <h5>
       <a id="_371">
       </a>
       发送函数
      </h5>
     </li>
    </ul>
    <pre><code class="prism language-c">
<span class="token class-name">uint8_t</span> <span class="token function">esp8266_send_command</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>cmd<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>res<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> time_out <span class="token operator">=</span> <span class="token number">250</span><span class="token punctuation">;</span>
    <span class="token function">esp8266_rx_clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">HAL_UART_Transmit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>esp8266_handle<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>cmd<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">while</span><span class="token punctuation">(</span>time_out<span class="token operator">--</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">esp8266_wait_receive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ESP8266_EOK<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>esp8266_rx_buf<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> ESP8266_EOK<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">return</span> ESP8266_ERROR<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <h5>
       <a id="_393">
       </a>
       测试函数
      </h5>
     </li>
    </ul>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">esp8266_test</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">esp8266_send_command</span><span class="token punctuation">(</span><span class="token string">"AT"</span><span class="token punctuation">,</span> <span class="token string">"OK"</span><span class="token punctuation">)</span> <span class="token operator">==</span> ESP8266_EOK<span class="token punctuation">)</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"esp8266 test: %s\r\n"</span><span class="token punctuation">,</span> esp8266_rx_buf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <h4>
     <a id="33__403">
     </a>
     3.3 数据收发
    </h4>
    <p>
     WiFi连接成功后，即可通过串口与ESP8266进行TCP/UDP数据收发。例如，发送数据到服务器：
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"uart1.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"esp8266.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">/* 初始化HAL库 */</span>
    <span class="token function">stm32_clock_init</span><span class="token punctuation">(</span>RCC_PLL_MUL9<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">/* 设置时钟, 72Mhz */</span>
    <span class="token function">uart1_init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">esp8266_init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"hello world!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span> 
        <span class="token function">esp8266_test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_428">
     </a>
     四、总结
    </h3>
    <p>
     本文通过详细的步骤介绍了如何在STM32F103C8T6上使用HAL库进行串口通信，并展示了如何通过串口驱动蓝牙模块（HC-08）和WiFi模块（ESP8266）。这些技术为实现无线通信功能提供了坚实的基础，适用于各种嵌入式系统应用。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f36343034373334322f:61727469636c652f64657461696c732f313436323237373934" class_="artid" style="display:none">
 </p>
</div>


