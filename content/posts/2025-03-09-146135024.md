---
layout: post
title: "Easysearch-ä½¿ç”¨-AWS-S3-è¿›è¡Œå¿«ç…§å¤‡ä»½ä¸è¿˜åŸå®Œæ•´æŒ‡å—åŠå¸¸è§é”™è¯¯æ’æŸ¥"
date: 2025-03-09 17:15:36 +0800
description: "Easysearch å¯ä»¥ä½¿ç”¨ä½œä¸ºè¿œç¨‹å­˜å‚¨åº“ï¼Œè¿›è¡Œç´¢å¼•çš„å¿«ç…§ï¼ˆSnapshotï¼‰å¤‡ä»½å’Œæ¢å¤ã€‚åŒæ—¶ï¼ŒEasysearch å†…ç½®äº† S3 æ’ä»¶ï¼Œæ— éœ€é¢å¤–å®‰è£…ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„é…ç½®å’Œæ“ä½œæ­¥éª¤ã€‚ç™»å½•ï¼Œè¿›å…¥æœåŠ¡ã€‚ï¼ˆä¾‹å¦‚ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰ã€‚ï¼šç¡®ä¿ IAM è§’è‰²å…·æœ‰è®¿é—® S3 çš„æƒé™ã€‚],},],bucketregionä¸€æ—¦ï¼šè¿™ä¼šä»è¿˜åŸmy_indexï¼Œä½†ä»¥å‘½åï¼Œé¿å…ä¸ç°æœ‰ç´¢å¼•å†²çªã€‚å¦‚æœè¦ç›´æ¥è¦†ç›–åŸç´¢å¼•ï¼ˆç¡®ä¿my_indexã€‚"
keywords: "Easysearch ä½¿ç”¨ AWS S3 è¿›è¡Œå¿«ç…§å¤‡ä»½ä¸è¿˜åŸï¼šå®Œæ•´æŒ‡å—åŠå¸¸è§é”™è¯¯æ’æŸ¥"
categories: ['Infinilabs']
tags: ['äº‘è®¡ç®—', 'Linux', 'Es', 'Easysearch', 'Aws']
artid: "146135024"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146135024
    alt: "Easysearch-ä½¿ç”¨-AWS-S3-è¿›è¡Œå¿«ç…§å¤‡ä»½ä¸è¿˜åŸå®Œæ•´æŒ‡å—åŠå¸¸è§é”™è¯¯æ’æŸ¥"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146135024
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146135024
cover: https://bing.ee123.net/img/rand?artid=146135024
image: https://bing.ee123.net/img/rand?artid=146135024
img: https://bing.ee123.net/img/rand?artid=146135024
---

# Easysearch ä½¿ç”¨ AWS S3 è¿›è¡Œå¿«ç…§å¤‡ä»½ä¸è¿˜åŸï¼šå®Œæ•´æŒ‡å—åŠå¸¸è§é”™è¯¯æ’æŸ¥

Easysearch å¯ä»¥ä½¿ç”¨ **AWS S3** ä½œä¸ºè¿œç¨‹å­˜å‚¨åº“ï¼Œè¿›è¡Œç´¢å¼•çš„å¿«ç…§ï¼ˆSnapshotï¼‰å¤‡ä»½å’Œæ¢å¤ã€‚åŒæ—¶ï¼ŒEasysearch å†…ç½®äº† S3
æ’ä»¶ï¼Œæ— éœ€é¢å¤–å®‰è£…ã€‚ä»¥ä¸‹æ˜¯å®Œæ•´çš„é…ç½®å’Œæ“ä½œæ­¥éª¤ã€‚

* * *

### 1\. åœ¨ AWS S3 ä¸Šåˆ›å»ºå­˜å‚¨æ¡¶

  1. ç™»å½• **AWS æ§åˆ¶å°** ï¼Œè¿›å…¥ **S3** æœåŠ¡ã€‚
  2. **åˆ›å»ºä¸€ä¸ªæ–°å­˜å‚¨æ¡¶** ï¼ˆä¾‹å¦‚ `easysearch-backups`ï¼‰ã€‚
  3. **å¯ç”¨ç‰ˆæœ¬æ§åˆ¶** ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰ã€‚
  4. **æƒé™é…ç½®** ï¼šç¡®ä¿ IAM è§’è‰²å…·æœ‰è®¿é—® S3 çš„æƒé™ã€‚

    
    
    {
    "Version": "2012-10-17",
    "Statement": [{
        "Action": [
          "s3:ListBucket"
        ],
        "Effect": "Allow",
        "Resource": [
          "arn:aws:s3:::s3-bucket-name"
        ]
      },
      {
        "Action": [
          "s3:GetObject",
          "s3:PutObject",
          "s3:DeleteObject"
        ],
        "Effect": "Allow",
        "Resource": [
          "arn:aws:s3:::s3-bucket-name/*"
        ]
      }
    ]
    }
    

### 2\. åœ¨ Console ä¸Šæ³¨å†Œ S3 ä½œä¸ºå¿«ç…§å­˜å‚¨åº“

#### **ä½¿ç”¨ Console DevTools æˆ– API**

åœ¨ Easysearch çš„ DevTools æ‰§è¡Œï¼š

    
    
    PUT _snapshot/my_s3_repository
    {
      "type": "s3",
      "settings": {
        "bucket": "easysearch-backups",
        "base_path": ""
      }
    }
    

> **æ³¨æ„** ï¼š
>
>   * `bucket` éœ€è¦å¡«å†™ä½ çš„ S3 å­˜å‚¨æ¡¶åç§°ã€‚
>   * `region` éœ€è¦æ›¿æ¢æˆä½ çš„ AWS S3 æ‰€åœ¨åŒºåŸŸï¼ŒSDK é»˜è®¤ç¾ä¸œåŒºã€‚
>   * å¦‚æœ Bucket åœ¨ä¸­å›½åŒºï¼Œè¿˜éœ€æ·»åŠ  `endpoint: https://s3.<region>.amazonaws.com.cn` å‚æ•°ã€‚
>

* * *

### 3\. åˆ›å»ºå¿«ç…§

ä¸€æ—¦ `my_s3_repository` æ³¨å†Œå®Œæˆï¼Œå°±å¯ä»¥åˆ›å»ºå¿«ç…§ï¼š

    
    
    PUT _snapshot/my_s3_repository/my_snapshot_001
    {
      "indices": "my_index",
      "include_global_state": false
    }
    

æŸ¥çœ‹å½“å‰å­˜å‚¨çš„å¿«ç…§ï¼š

    
    
    GET _snapshot/my_s3_repository/_all
    

* * *

![image-20250309161102887](https://i-blog.csdnimg.cn/img_convert/8ac6983caa20c4deeefb80ff3d41eafe.png)

### 4\. ä» AWS S3 è¿˜åŸå¿«ç…§

å½“ä½ éœ€è¦æ¢å¤ç´¢å¼•æ—¶ï¼š

    
    
    POST _snapshot/my_s3_repository/my_snapshot_001/_restore
    {
      "indices": "my_index",
      "rename_pattern": "my_index",
      "rename_replacement": "restored_my_index"
    }
    

> **è¯´æ˜** ï¼šè¿™ä¼šä» `my_snapshot_001` è¿˜åŸ `my_index`ï¼Œä½†ä»¥ `restored_my_index`
> å‘½åï¼Œé¿å…ä¸ç°æœ‰ç´¢å¼•å†²çªã€‚

å¦‚æœè¦ç›´æ¥è¦†ç›–åŸç´¢å¼•ï¼ˆç¡®ä¿ `my_index` ä¸ºç©ºæˆ–å·²åˆ é™¤ï¼‰ï¼š

    
    
    POST _snapshot/my_s3_repository/my_snapshot_001/_restore
    {
      "indices": "my_index",
      "ignore_unavailable": true,
      "include_global_state": false
    }
    

* * *

### 5\. å¯èƒ½çš„é”™è¯¯ä¸è§£å†³æ–¹æ¡ˆ

**é”™è¯¯ä¿¡æ¯**| **å¯èƒ½åŸå› **| **è§£å†³æ–¹æ¡ˆ**  
---|---|---  
`repository_s3 plugin not installed`| æ²¡æœ‰å®‰è£… `repository-s3` æ’ä»¶| è¿è¡Œ
`bin/elasticsearch-plugin install repository-s3` å¹¶é‡å¯  
`NoSuchBucket`| S3 å­˜å‚¨æ¡¶ä¸å­˜åœ¨| ç¡®ä¿ S3 å­˜å‚¨æ¡¶åç§°æ­£ç¡®  
`AccessDenied`| æƒé™ä¸è¶³| ç¡®ä¿ S3 å­˜å‚¨æ¡¶ç­–ç•¥æ­£ç¡®ï¼Œæ£€æŸ¥ IAM è§’è‰²  
`index_closed_exception`| ç›®æ ‡ç´¢å¼•å·²å…³é—­| å…ˆ `POST my_index/_open` å†æ¢å¤  
`index_already_exists_exception`| ç›®æ ‡ç´¢å¼•å·²å­˜åœ¨| å…ˆ `DELETE my_index` å†æ¢å¤  
  
* * *

### 6\. å¿«ç…§æ¢å¤å¸¸è§é”™è¯¯æ’æŸ¥

#### **æŠ¥é”™ 1ï¼šæ— æ³•è¿æ¥åˆ° S3**

    
    
    {
      "error": {
        "root_cause": [
          {
            "type": "repository_verification_exception",
            "reason": "[my_s3_repository] path [/] is not accessible on master node"
          }
        ],
        "type": "repository_verification_exception",
        "reason": "[my_s3_repository] path [/] is not accessible on master node",
        "caused_by": {
          "type": "i_o_exception",
          "reason": "Unable to upload object [//tests-sXkmh3q5ThCCIX2VJp609g/master.dat] using a single upload",
          "caused_by": {
            "type": "sdk_client_exception",
            "reason": "Failed to connect to service endpoint: ",
            "caused_by": {
              "type": "socket_timeout_exception",
              "reason": "Connect timed out"
            }
          }
        }
      },
      "status": 500
    }
    

##### **è§£å†³æ–¹æ¡ˆ** ï¼š

  1. åœ¨ keystore ä¸­æ·»åŠ  AWS å‡­è¯ï¼š
    
        sudo ./bin/easysearch-keystore add s3.client.default.access_key
    sudo ./bin/easysearch-keystore add s3.client.default.secret_key
    

  2. å¦‚æœè¿è¡Œåœ¨ EC2 ä¸Šï¼Œç¡®ä¿å®ä¾‹æŒ‚è½½äº† IAM Roleã€‚

    
    
    {
      "error": {
        "root_cause": [
          {
            "type": "repository_verification_exception",
            "reason": "[my_s3_repositor1] path  is not accessible on master node"
          }
        ],
        "type": "repository_verification_exception",
        "reason": "[my_s3_repositor1] path  is not accessible on master node",
        "caused_by": {
          "type": "i_o_exception",
          "reason": "Unable to upload object [tests-sUUzs-mTSZeYw1qk372DkQ/master.dat] using a single upload",
          "caused_by": {
            "type": "sdk_client_exception",
            "reason": "The requested metadata is not found at http://169.254.169.254/latest/meta-data/iam/security-credentials/"
          }
        }
      },
      "status": 500
    }
    

* * *

#### æŠ¥é”™ 2ï¼šç´¢å¼•å·²å­˜åœ¨ï¼Œæ— æ³•æ¢å¤

    
    
    {
      "error": {
        "root_cause": [
          {
            "type": "snapshot_restore_exception",
            "reason": "[my_s3_repository:1/9gIDCgSySwKzQqEYvaGM_w] cannot restore index [my_index] because an open index with same name already exists in the cluster. Either close or delete the existing index or restore the index under a different name by providing a rename pattern and replacement name"
          }
        ],
        "type": "snapshot_restore_exception",
        "reason": "[my_s3_repository:1/9gIDCgSySwKzQqEYvaGM_w] cannot restore index [my_index] because an open index with same name already exists in the cluster. Either close or delete the existing index or restore the index under a different name by providing a rename pattern and replacement name"
      },
      "status": 500
    }
    

##### **è§£å†³æ–¹æ¡ˆ** ï¼š

  1. **åˆ é™¤ç°æœ‰ç´¢å¼•åæ¢å¤** ï¼š
    
        DELETE /my_index
    

  2. **å…³é—­ç´¢å¼•åæ¢å¤** ï¼š
    
        POST /my_index/_close
    

  3. **æ¢å¤ä¸ºæ–°çš„ç´¢å¼•åç§°** ï¼š
    
        POST _snapshot/my_s3_repository/1/_restore
    {
      "indices": "my_index",
      "rename_pattern": "my_index",
      "rename_replacement": "restored_my_index"
    }
    

* * *

#### æŠ¥é”™ 3ï¼šæƒé™é”™è¯¯

    
    
    {
      "error": {
        "root_cause": [
          {
            "type": "security_exception",
            "reason": "no permissions for [] and User [name=admin, external_roles=[admin]]"
          }
        ],
        "type": "security_exception",
        "reason": "no permissions for [] and User [name=admin, external_roles=[admin]]"
      },
      "status": 403
    }
    

##### **è§£å†³æ–¹æ¡ˆ** ï¼š

  1. **ç¡®ä¿ç”¨æˆ·æœ‰`manage_snapshots` è§’è‰²æƒé™**ã€‚
  2. **æ’é™¤`.security` ç´¢å¼•æˆ–å…¨å±€çŠ¶æ€**ï¼Œå¦åˆ™æ— æ³•æ¢å¤ã€‚

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/31e63b73d7fd427f84f0079872962f37.png)

    
    
    POST _snapshot/my_s3_repositor1/snapshot_002/_restore
    {
      "indices": "-.security",
      "ignore_unavailable": true,
      "include_global_state": false
    }
    

## **ğŸ“Œ å­˜å‚¨åº“ï¼ˆRepositoryï¼‰ç®¡ç† API**

å­˜å‚¨åº“ç”¨äºå­˜å‚¨å¿«ç…§ï¼ŒElasticsearch æ”¯æŒ AWS S3ã€GCSã€æœ¬åœ°ç­‰å­˜å‚¨ã€‚

### 1ï¸âƒ£ æŸ¥çœ‹æ‰€æœ‰å·²æ³¨å†Œçš„å­˜å‚¨åº“

    
    
    GET _snapshot/_all
    

**ç¤ºä¾‹è¿”å›** ï¼š

    
    
    {
      "my_s3_repository": {
        "type": "s3",
        "settings": {
          "bucket": "es-snapshots-bucket",
          "region": "us-east-1"
        }
      }
    }
    

### 2ï¸âƒ£ æŸ¥çœ‹ç‰¹å®šå­˜å‚¨åº“ä¿¡æ¯

    
    
    GET _snapshot/my_s3_repository
    

### 3ï¸âƒ£ åˆ›å»ºå­˜å‚¨åº“ï¼ˆAWS S3 ç¤ºä¾‹ï¼‰

    
    
    PUT _snapshot/my_s3_repository
    {
      "type": "s3",
      "settings": {
        "bucket": "es-snapshots-bucket",
      }
    }
    

### 4ï¸âƒ£ åˆ é™¤å­˜å‚¨åº“

    
    
    DELETE _snapshot/my_s3_repository
    

**âš  åˆ é™¤å­˜å‚¨åº“ä¸ä¼šåˆ é™¤å¿«ç…§ï¼Œéœ€è¦æ‰‹åŠ¨åˆ é™¤å¿«ç…§ï¼**

* * *

## **ğŸ“Œ å¿«ç…§ï¼ˆSnapshotï¼‰ç®¡ç† API**

å¿«ç…§ç”¨äºå¤‡ä»½å’Œæ¢å¤ç´¢å¼•æ•°æ®ã€‚

### 1ï¸âƒ£ åˆ›å»ºå¿«ç…§

**å¤‡ä»½ç‰¹å®šç´¢å¼•**

    
    
    PUT _snapshot/my_s3_repository/snapshot_001
    {
      "indices": "my_index",
      "include_global_state": false
    }
    

**å¤‡ä»½æ‰€æœ‰ç´¢å¼•**

    
    
    PUT _snapshot/my_s3_repository/snapshot_002
    {
      "include_global_state": true
    }
    

### 2ï¸âƒ£ æŸ¥çœ‹æ‰€æœ‰å¿«ç…§

    
    
    GET _snapshot/my_s3_repository/_all
    

### 3ï¸âƒ£ æŸ¥çœ‹ç‰¹å®šå¿«ç…§ä¿¡æ¯

    
    
    GET _snapshot/my_s3_repository/snapshot_001
    

### 4ï¸âƒ£ åˆ é™¤å¿«ç…§

    
    
    DELETE _snapshot/my_s3_repository/snapshot_001
    

* * *

## **ğŸ“Œ å¿«ç…§æ¢å¤ï¼ˆRestoreï¼‰API**

æ¢å¤å·²å¤‡ä»½çš„ç´¢å¼•ã€‚

### 1ï¸âƒ£ è¿˜åŸå•ä¸ªç´¢å¼•

    
    
    POST _snapshot/my_s3_repository/snapshot_001/_restore
    {
      "indices": "my_index",
      "ignore_unavailable": true,
      "include_global_state": false
    }
    

### 2ï¸âƒ£ è¿˜åŸç´¢å¼•å¹¶é‡å‘½å

    
    
    POST _snapshot/my_s3_repository/snapshot_001/_restore
    {
      "indices": "my_index",
      "rename_pattern": "my_index",
      "rename_replacement": "restored_my_index"
    }
    

### 3ï¸âƒ£ è¿˜åŸæ‰€æœ‰ç´¢å¼•

    
    
    POST _snapshot/my_s3_repository/snapshot_002/_restore
    

* * *

## **ğŸ“Œ å¿«ç…§çŠ¶æ€ API**

æŸ¥è¯¢å¿«ç…§çš„æ‰§è¡ŒçŠ¶æ€ã€‚

### 1ï¸âƒ£ æŸ¥çœ‹å½“å‰å¿«ç…§ä»»åŠ¡

    
    
    GET _snapshot/_status
    

### 2ï¸âƒ£ æŸ¥çœ‹ç‰¹å®šå¿«ç…§çŠ¶æ€

    
    
    GET _snapshot/my_s3_repository/snapshot_001/_status
    

* * *

**API**| **ç”¨é€”**  
---|---  
`GET _snapshot/_all`| æŸ¥çœ‹æ‰€æœ‰å­˜å‚¨åº“  
`GET _snapshot/my_s3_repository`| æŸ¥çœ‹ç‰¹å®šå­˜å‚¨åº“  
`PUT _snapshot/my_s3_repository`| åˆ›å»ºå­˜å‚¨åº“  
`DELETE _snapshot/my_s3_repository`| åˆ é™¤å­˜å‚¨åº“  
`PUT _snapshot/my_s3_repository/snapshot_001`| åˆ›å»ºå¿«ç…§  
`GET _snapshot/my_s3_repository/_all`| æŸ¥çœ‹æ‰€æœ‰å¿«ç…§  
`GET _snapshot/my_s3_repository/snapshot_001`| æŸ¥çœ‹å¿«ç…§è¯¦æƒ…  
`DELETE _snapshot/my_s3_repository/snapshot_001`| åˆ é™¤å¿«ç…§  
`POST _snapshot/my_s3_repository/snapshot_001/_restore`| è¿˜åŸå¿«ç…§  
`GET _snapshot/_status`| æŸ¥çœ‹å¿«ç…§çŠ¶æ€  
  
ğŸš€ é€šè¿‡æœ¬æ–‡ï¼Œä½ å¯ä»¥é«˜æ•ˆåœ°ä½¿ç”¨ **AWS S3 è¿›è¡Œ Easysearch å¿«ç…§å¤‡ä»½å’Œæ¢å¤** ï¼Œå¹¶æ’æŸ¥å¯èƒ½çš„é”™è¯¯ï¼Œç¡®ä¿é›†ç¾¤æ•°æ®å®‰å…¨æ— å¿§ï¼



