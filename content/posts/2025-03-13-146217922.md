---
layout: post
title: "嵌入式linux网口和USB热插拔检测"
date: 2025-03-13 00:08:53 +0800
description: "在Linux常常需要对网口和USB等外设接口进行插拔检测，从而执行部分初始化操作。下面简要介绍Linux的Netlink机制，并在C程序中使用Linux的Netlink机制完成网口和USB口插拔检测。"
keywords: "【嵌入式linux】网口和USB热插拔检测"
categories: ['嵌入式', 'Linux', 'C']
tags: ['Linux', 'C']
artid: "146217922"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146217922
    alt: "嵌入式linux网口和USB热插拔检测"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146217922
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146217922
cover: https://bing.ee123.net/img/rand?artid=146217922
image: https://bing.ee123.net/img/rand?artid=146217922
img: https://bing.ee123.net/img/rand?artid=146217922
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【嵌入式linux】网口和USB热插拔检测
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     在Linux常常需要对网口和USB等外设接口进行插拔检测，从而执行部分初始化操作。下面简要介绍
     <strong>
      Linux的Netlink机制
     </strong>
     ，并在C程序中使用Linux的
     <strong>
      Netlink
     </strong>
     机制完成
     <strong>
      网口和USB口插拔检测
     </strong>
     。
    </p>
    <p>
     <strong>
      Netlink 是 Linux 内核与用户空间进程通信的一种机制，主要用于内核模块和用户程序之间的数据传输
     </strong>
     。它比传统的通信方式（如 ioctl、procfs、sysfs）更灵活高效。
     <br/>
     <strong>
      一、主要特点
     </strong>
     <br/>
     <strong>
      双向通信
     </strong>
     ：支持内核与用户空间的双向数据传输。
     <br/>
     <strong>
      多协议支持
     </strong>
     ：通过不同的协议类型（如 NETLINK_ROUTE、NETLINK_SOCK_DIAG）满足多种通信需求。
     <br/>
     <strong>
      多播支持
     </strong>
     ：允许一个消息同时发送给多个接收者。
     <br/>
     <strong>
      异步通信
     </strong>
     ：支持异步消息传递，适合事件驱动场景。
     <br/>
     <strong>
      二、使用场景
     </strong>
     <br/>
     <strong>
      网络配置
     </strong>
     ：如 iproute2 工具通过 Netlink 配置网络接口和路由。
     <br/>
     <strong>
      防火墙和策略路由
     </strong>
     ：如 iptables 和 nftables 使用 Netlink 配置规则。
     <br/>
     <strong>
      设备管理
     </strong>
     ：如 udev 通过 Netlink 监控设备事件。
     <br/>
     <strong>
      三、基本使用步骤
     </strong>
     <br/>
     <strong>
      1.创建套接字：用户空间使用 socket() 创建 Netlink 套接字。
     </strong>
    </p>
    <pre><code class="prism language-c"><span class="token keyword">int</span> sock_fd <span class="token operator">=</span> <span class="token function">socket</span><span class="token punctuation">(</span>AF_NETLINK<span class="token punctuation">,</span> SOCK_RAW<span class="token punctuation">,</span> NETLINK_ROUTE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      2.绑定地址：绑定 Netlink 地址。
     </strong>
    </p>
    <pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">sockaddr_nl</span> addr<span class="token punctuation">;</span>
<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
addr<span class="token punctuation">.</span>nl_family <span class="token operator">=</span> AF_NETLINK<span class="token punctuation">;</span>
addr<span class="token punctuation">.</span>nl_pid <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通常使用进程ID</span>
<span class="token function">bind</span><span class="token punctuation">(</span>sock_fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      3.发送和接收消息：使用 sendmsg() 和 recvmsg() 进行消息传递。
      <br/>
      4.处理消息：解析和处理接收到的消息。
     </strong>
    </p>
    <p>
     <strong>
      Demo1：使用Netlink实现网口热插拔。（ZYNQ-7020平台，linux内核为4.19）
     </strong>
    </p>
    <pre><code class="prism language-c">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/if.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/rtnetlink.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/netlink.h&gt;</span></span>
<span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>network_status_callback<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>eth_name<span class="token punctuation">,</span><span class="token keyword">int</span> status<span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">network_link_monitor</span><span class="token punctuation">(</span>network_status_callback arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> sock<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">sockaddr_nl</span> sa<span class="token punctuation">;</span>
	<span class="token keyword">int</span> len<span class="token operator">=</span><span class="token number">4096</span><span class="token punctuation">;</span>
	<span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">4096</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">nlmsghdr</span> <span class="token operator">*</span>nh<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">ifinfomsg</span>  <span class="token operator">*</span>ifinfo<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">rtattr</span> <span class="token operator">*</span>attr<span class="token punctuation">;</span>
	network_status_callback nm<span class="token operator">=</span>arg<span class="token punctuation">;</span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	<span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	sa<span class="token punctuation">.</span>nl_family<span class="token operator">=</span>AF_NETLINK<span class="token punctuation">;</span>
	sa<span class="token punctuation">.</span>nl_groups<span class="token operator">=</span>RTNLGRP_LINK<span class="token punctuation">;</span>
	<span class="token comment">//sa.nl_pid=getpid();</span>
	
	<span class="token comment">//创建套接字和绑定Netlink地址，这里使用NETLINK_ROUTE</span>
	sock<span class="token operator">=</span><span class="token function">socket</span><span class="token punctuation">(</span>AF_NETLINK<span class="token punctuation">,</span>SOCK_RAW<span class="token punctuation">,</span>NETLINK_ROUTE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>sock<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"socket err %d\n"</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setsockopt</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_RCVBUF<span class="token punctuation">,</span><span class="token operator">&amp;</span>len<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">bind</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>sa<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>sa<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"bind err %d\n"</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token comment">//阻塞接收内核的Netlink消息，可根据应用需求使用非阻塞IO读</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ret<span class="token operator">=</span><span class="token function">read</span><span class="token punctuation">(</span>sock<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>nh<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">nlmsghdr</span><span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">;</span><span class="token function">NLMSG_OK</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>nh<span class="token operator">=</span><span class="token function">NLMSG_NEXT</span><span class="token punctuation">(</span>nh<span class="token punctuation">,</span>ret<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token comment">//解析和处理接收到的内核消息</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>nh<span class="token operator">-&gt;</span>nlmsg_type<span class="token operator">==</span>NLMSG_DONE<span class="token punctuation">)</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>nh<span class="token operator">-&gt;</span>nlmsg_type<span class="token operator">==</span>NLMSG_ERROR<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"read err %d\n"</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">return</span> <span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>nh<span class="token operator">-&gt;</span>nlmsg_type<span class="token operator">!=</span>RTM_NEWLINK<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"nlmsg_type err %d\n"</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">continue</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			ifinfo<span class="token operator">=</span><span class="token function">NLMSG_DATA</span><span class="token punctuation">(</span>nh<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//printf("%u : %s \n",ifinfo-&gt;ifi_index,(ifinfo-&gt;ifi_flags&amp;IFF_LOWER_UP)?"UP":"DOWN");</span>
			attr<span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">rtattr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>nh<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">NLMSG_SPACE</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ifinfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			len<span class="token operator">=</span>nh<span class="token operator">-&gt;</span>nlmsg_len<span class="token operator">-</span><span class="token function">NLMSG_SPACE</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ifinfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token function">RTA_OK</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>attr<span class="token operator">=</span><span class="token function">RTA_NEXT</span><span class="token punctuation">(</span>attr<span class="token punctuation">,</span>len<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>attr<span class="token operator">-&gt;</span>rta_type<span class="token operator">==</span>IFLA_IFNAME<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token comment">//执行热插拔检测回调函数</span>
					<span class="token comment">//printf("%s : %s\n",(char*)RTA_DATA(attr),(ifinfo-&gt;ifi_flags&amp;IFF_LOWER_UP)?"up":"down");</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span>ifinfo<span class="token operator">-&gt;</span>ifi_flags<span class="token operator">&amp;</span>IFF_LOWER_UP<span class="token punctuation">)</span>
						<span class="token function">nm</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">RTA_DATA</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span><span class="token punctuation">,</span>LINK_UP<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">else</span>
						<span class="token function">nm</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">RTA_DATA</span><span class="token punctuation">(</span>attr<span class="token punctuation">)</span><span class="token punctuation">,</span>LINK_DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
网络插拔检测回调
*/</span>
<span class="token keyword">void</span> <span class="token function">monitor_callback</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span>eth_name<span class="token punctuation">,</span><span class="token keyword">int</span> status<span class="token punctuation">)</span><span class="token comment">//status--1 up</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%s %s\n"</span><span class="token punctuation">,</span>eth_name<span class="token punctuation">,</span>status<span class="token operator">?</span><span class="token string">"up"</span><span class="token operator">:</span><span class="token string">"down"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"net test\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">network_link_monitor</span><span class="token punctuation">(</span>monitor_callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     编译Demo生成net_test拷贝到板子上
     <br/>
     测试结果：重复插拔网口可看到内核打印信息和应用程序打印网口up和down信息
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/05187638732e44a785f7cf938274191d.png">
      <br/>
      <strong>
       Demo2：使用Netlink实现USB口热插拔。（ZYNQ-7020平台，linux内核为4.19）
      </strong>
     </img>
    </p>
    <pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">usb_host_thread</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> rcv_buf<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> link_status<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//判断USB口初始拔插状态</span>
    ret<span class="token operator">=</span><span class="token function">usb_exec</span><span class="token punctuation">(</span>USB_HOST_CMD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        link_status<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        link_status<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_nl</span> client<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">timeval</span> tv<span class="token punctuation">;</span>
    <span class="token keyword">int</span> CppLive<span class="token punctuation">,</span>rcvlen<span class="token punctuation">;</span>
    fd_set fds<span class="token punctuation">;</span>
    <span class="token keyword">int</span> buffersize<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">;</span>
    <span class="token comment">//创建套接字和绑定Netlink地址，这里使用NETLINK_KOBJECT_UEVENT</span>
    CppLive<span class="token operator">=</span><span class="token function">socket</span><span class="token punctuation">(</span>AF_NETLINK<span class="token punctuation">,</span>SOCK_RAW<span class="token punctuation">,</span>NETLINK_KOBJECT_UEVENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>CppLive<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
	    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"socket err %d\n"</span><span class="token punctuation">,</span><span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    client<span class="token punctuation">.</span>nl_family<span class="token operator">=</span>AF_NETLINK<span class="token punctuation">;</span>
    <span class="token comment">//client.nl_pid=getpid();</span>
    client<span class="token punctuation">.</span>nl_groups<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>CppLive<span class="token punctuation">,</span>SOL_SOCKET<span class="token punctuation">,</span>SO_RCVBUF<span class="token punctuation">,</span><span class="token operator">&amp;</span>buffersize<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffersize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">bind</span><span class="token punctuation">(</span>CppLive<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>client<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">2048</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">/*
        FD_ZERO(&amp;fds);
        FD_SET(CppLive,&amp;fds);
        tv.tv_sec=0;
        tv.tv_usec=100 * 1000;
        ret=select(CppLive+1,&amp;fds,NULL,NULL,&amp;tv);
        if(ret&lt;0)
        {
            printf("select err %d\n",__LINE__);
            continue;
        }
            
        if(!(ret&gt;0 &amp;&amp; FD_ISSET(CppLive, &amp;fds)))
        {
            printf("select err %d\n",__LINE__);
            continue;
        }
        */</span>  
        <span class="token comment">//阻塞接收内核的Netlink消息，可根据应用需求使用非阻塞IO读</span>
        rcvlen<span class="token operator">=</span><span class="token function">recv</span><span class="token punctuation">(</span>CppLive<span class="token punctuation">,</span>buf<span class="token punctuation">,</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>rcvlen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">//解析和处理接收到的内核消息</span>
            <span class="token comment">//printf("%s\n",buf);</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"add"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>link_status<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                link_status<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span><span class="token string">"remove"</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token constant">NULL</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>link_status<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">)</span>arg<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                link_status<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
            
	<span class="token punctuation">}</span>
	
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">int</span> status<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"usb host up\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"usb host down\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"usb test\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">usb_host_monitor</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     编译Demo生成usb_test拷贝到板子上
     <br/>
     测试结果：重复插拔USB host口可看到应用程序打印USB口的up和down信息
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/29a9d2c08ef2484ebefa5c444cee0b3f.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f796563686f6e6762696e62696e2f:61727469636c652f64657461696c732f313436323137393232" class_="artid" style="display:none">
 </p>
</div>


