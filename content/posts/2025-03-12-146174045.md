---
layout: post
title: "3.1-Spring-Bootæ€§èƒ½ä¼˜åŒ–ä»çº¿ç¨‹æ± è°ƒä¼˜åˆ°JVMå‚æ•°é…ç½®"
date: 2025-03-12 10:06:43 +0800
description: "é€šè¿‡æœ¬æ–‡çš„è°ƒä¼˜æ–¹æ¡ˆï¼ŒæŸç”µå•†ç³»ç»Ÿåœ¨åŒåä¸€å¤§ä¿ƒä¸­æˆåŠŸå°†APIå¹³å‡å“åº”æ—¶é—´ä»320msé™ä½åˆ°98msã€‚è®°ä½ï¼šâ€‹æ‰€æœ‰å‚æ•°éƒ½è¦ç»è¿‡å‹æµ‹éªŒè¯ï¼â€‹æ¬¢è¿åœ¨è¯„è®ºåŒºç•™ä¸‹ä½ çš„ä¼˜åŒ–æ¡ˆä¾‹ï¼æŠ€æœ¯æ‹“å±•ğŸ‘‰ã€ŠSpring Bootç›‘æ§ä½“ç³»æ­å»ºå…¨æ”»ç•¥ã€‹ğŸ‘‰ã€ŠJVMè°ƒä¼˜å®æˆ˜æ¡ˆä¾‹é›†ã€‹#Spring Boot# #æ€§èƒ½ä¼˜åŒ–# #JVMè°ƒä¼˜# #çº¿ç¨‹æ± # æ›´å¤šæŠ€æœ¯å¹²è´§ï¼Œå…³æ³¨ä½œè€…ä¸è¿·è·¯ï¼â€‹ã€‚"
keywords: "springboot webçº¿ç¨‹æ•°é…ç½® ä¼˜åŒ–"
categories: ['é›¶åŸºç¡€7å¤©ç²¾é€šSpring', 'ä»å…¥é—¨åˆ°ç²¾é€š', 'Spring', 'Boot', 'Boot']
tags: ['æ€§èƒ½ä¼˜åŒ–', 'Spring', 'Jvm', 'Boot']
artid: "146174045"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146174045
    alt: "3.1-Spring-Bootæ€§èƒ½ä¼˜åŒ–ä»çº¿ç¨‹æ± è°ƒä¼˜åˆ°JVMå‚æ•°é…ç½®"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146174045
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146174045
cover: https://bing.ee123.net/img/rand?artid=146174045
image: https://bing.ee123.net/img/rand?artid=146174045
img: https://bing.ee123.net/img/rand?artid=146174045
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     3.1 Spring Bootæ€§èƒ½ä¼˜åŒ–ï¼šä»çº¿ç¨‹æ± è°ƒä¼˜åˆ°JVMå‚æ•°é…ç½®
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <pre></pre>
    <p>
     markdown
    </p>
    <pre><code># Spring Bootæ€§èƒ½ä¼˜åŒ–ï¼šä»çº¿ç¨‹æ± è°ƒä¼˜åˆ°JVMå‚æ•°é…ç½®

![æ€§èƒ½ä¼˜åŒ–](https://img-blog.csdnimg.cn/direct/0a3e3d2e4d4b4f7f9c3d4a5b0e8d4e4c.png)

## å¼•è¨€
åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼ŒSpring Bootä½œä¸ºä¸»æµå¼€å‘æ¡†æ¶ï¼Œå…¶æ€§èƒ½ç›´æ¥å½±å“ç³»ç»Ÿçš„ååé‡å’Œå“åº”é€Ÿåº¦ã€‚æœ¬æ–‡å°†æ·±å…¥æ¢è®¨ä»**çº¿ç¨‹æ± è°ƒä¼˜**åˆ°**JVMå‚æ•°é…ç½®**çš„å…¨é“¾è·¯ä¼˜åŒ–æ–¹æ¡ˆï¼Œé€šè¿‡çœŸå®æ¡ˆä¾‹å‚æ•°å¯¹æ¯”ï¼ŒåŠ©ä½ å®ç°QPSç¿»å€æå‡ï¼

---

## ä¸€ã€çº¿ç¨‹æ± è°ƒä¼˜å®æˆ˜

### 1.1 Tomcatçº¿ç¨‹æ± ä¼˜åŒ–
Spring Booté»˜è®¤ä½¿ç”¨Tomcatä½œä¸ºå†…åµŒæœåŠ¡å™¨ï¼Œ`application.yml`é…ç½®ç¤ºä¾‹ï¼š

```yaml
server:
  tomcat:
    max-threads: 200       # IOå¯†é›†å‹æ¨èï¼šCPUæ ¸æ•°*2
    min-spare-threads: 20  # é¿å…çªå‘æµé‡çº¿ç¨‹åˆ›å»ºå»¶è¿Ÿ
    accept-count: 100      # ç­‰å¾…é˜Ÿåˆ—é•¿åº¦ï¼ˆè¶…è¿‡åˆ™æ‹’ç»è¯·æ±‚ï¼‰
    connection-timeout: 5000ms</code></pre>
    <p>
     <strong>
      å‚æ•°è§£æ
     </strong>
     ï¼š
    </p>
    <ul>
     <li>
      <code>
       max-threads
      </code>
      ï¼šæ ¹æ®
      <code>
       CPUæ ¸å¿ƒæ•°
      </code>
      åŠ¨æ€è®¡ç®—ï¼ˆå…¬å¼ï¼š
      <code>
       Runtime.getRuntime().availableProcessors()*2
      </code>
      ï¼‰
     </li>
     <li>
      <code>
       accept-count
      </code>
      ï¼šè®¾ç½®ä¸å½“ä¼šå¯¼è‡´
      <code>
       503 Service Unavailable
      </code>
     </li>
    </ul>
    <hr/>
    <h4>
     1.2 å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± 
    </h4>
    <p>
     é€šè¿‡è‡ªå®šä¹‰çº¿ç¨‹æ± é¿å…
     <code>
      @Async
     </code>
     é»˜è®¤çº¿ç¨‹æ± çš„å‘ï¼š
    </p>
    <pre></pre>
    <p>
     java
    </p>
    <pre><code>@Bean("customExecutor")
public Executor asyncExecutor() {
    ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
    executor.setCorePoolSize(8);             // å¸¸é©»çº¿ç¨‹æ•°
    executor.setMaxPoolSize(50);             // çªå‘æµé‡åº”å¯¹
    executor.setQueueCapacity(100);          // ç¼“å†²é˜Ÿåˆ—
    executor.setRejectedExecutionHandler(
        new ThreadPoolExecutor.CallerRunsPolicy()); // æ‹’ç»ç­–ç•¥
    executor.initialize();
    return executor;
}</code></pre>
    <p>
     <strong>
      æ‹’ç»ç­–ç•¥é€‰æ‹©
     </strong>
     ï¼š
    </p>
    <ul>
     <li>
      <code>
       AbortPolicy
      </code>
      ï¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼ˆç”Ÿäº§ç¯å¢ƒæ…ç”¨ï¼‰
     </li>
     <li>
      <code>
       CallerRunsPolicy
      </code>
      ï¼šä¸»çº¿ç¨‹æ‰§è¡Œï¼ˆæ¨èå…œåº•æ–¹æ¡ˆï¼‰
     </li>
    </ul>
    <hr/>
    <h3>
     äºŒã€JVMå‚æ•°è°ƒä¼˜æŒ‡å—
    </h3>
    <h4>
     2.1 å†…å­˜å‚æ•°é»„é‡‘é…ç½®
    </h4>
    <pre></pre>
    <p>
     bash
    </p>
    <pre><code># JDK8+ æ¨èé…ç½®
-Xms4g -Xmx4g                 # å †å†…å­˜ï¼ˆé¿å…åŠ¨æ€æ‰©å®¹ï¼‰
-XX:MetaspaceSize=256m        # å…ƒç©ºé—´åˆå§‹å¤§å°
-XX:+UseG1GC                  # ä½å»¶è¿Ÿåƒåœ¾å›æ”¶å™¨
-XX:MaxGCPauseMillis=200      # æœ€å¤§GCåœé¡¿æ—¶é—´
-XX:+HeapDumpOnOutOfMemoryError # å†…å­˜æº¢å‡ºè‡ªåŠ¨Dump</code></pre>
    <p>
     https://img-blog.csdnimg.cn/direct/8a1d3c4d4a5a4d6c9b3e7c8d9f4e4b4a.png
    </p>
    <hr/>
    <h4>
     2.2 G1è°ƒä¼˜è¿›é˜¶å‚æ•°
    </h4>
    <pre></pre>
    <p>
     bash
    </p>
    <pre><code>-XX:InitiatingHeapOccupancyPercent=45  # è§¦å‘å¹¶å‘GCå‘¨æœŸ
-XX:G1HeapRegionSize=4m               # Regionå¤§å°è®¾ç½®
-XX:G1ReservePercent=20               # é¢„ç•™å†…å­˜é˜²æ™‹å‡å¤±è´¥</code></pre>
    <p>
     <strong>
      å…³é”®ç›‘æ§æŒ‡æ ‡
     </strong>
     ï¼š
    </p>
    <ul>
     <li>
      <code>
       Young GC Time
      </code>
      ï¼š&gt;200mséœ€ä¼˜åŒ–
     </li>
     <li>
      <code>
       Mixed GC Count
      </code>
      ï¼šé¢‘ç¹è§¦å‘æ£€æŸ¥IHOP
     </li>
    </ul>
    <hr/>
    <h3>
     ä¸‰ã€æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
    </h3>
    <h4>
     HikariCPå‚æ•°æœ€ä½³å®è·µ
    </h4>
    <pre></pre>
    <p>
     yaml
    </p>
    <pre><code>spring:
  datasource:
    hikari:
      maximum-pool-size: 20    # è®¡ç®—å…¬å¼ï¼šCPUæ ¸æ•°*2 + ç£ç›˜æ•°
      minimum-idle: 5         # ç»´æŒæœ€å°ç©ºé—²è¿æ¥
      idle-timeout: 600000    # 10åˆ†é’Ÿç©ºé—²å›æ”¶
      max-lifetime: 1800000   # 30åˆ†é’Ÿå¼ºåˆ¶å›æ”¶</code></pre>
    <p>
     <strong>
      è¿æ¥æ³„éœ²æ£€æµ‹
     </strong>
     ï¼š
    </p>
    <pre></pre>
    <p>
     sql
    </p>
    <pre><code>SELECT * FROM information_schema.innodb_trx 
WHERE TIME_TO_SEC(TIMEDIFF(NOW(),trx_started))&gt;60</code></pre>
    <hr/>
    <h3>
     å››ã€æ€§èƒ½ç›‘æ§ä¸‰æ¿æ–§
    </h3>
    <h4>
     4.1 Arthasè¯Šæ–­å®æˆ˜
    </h4>
    <pre></pre>
    <p>
     bash
    </p>
    <pre><code># æŸ¥çœ‹çº¿ç¨‹é˜»å¡æƒ…å†µ
thread --state BLOCKED

# ç›‘æ§æ–¹æ³•æ‰§è¡Œè€—æ—¶
trace com.example.service.* *</code></pre>
    <h4>
     4.2 Prometheusç›‘æ§ä½“ç³»
    </h4>
    <p>
     https://img-blog.csdnimg.cn/direct/2a2c3d4e4d5b4f7c9c3d4a5b0e8d4e4c.png
    </p>
    <hr/>
    <h3>
     äº”ã€ä¼˜åŒ–æ•ˆæœå¯¹æ¯”
    </h3>
    <table>
     <thead>
      <tr>
       <th>
        ä¼˜åŒ–é˜¶æ®µ
       </th>
       <th>
        é…ç½®é¡¹
       </th>
       <th>
        QPSæå‡
       </th>
       <th>
        å“åº”æ—¶é—´ä¸‹é™
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        é»˜è®¤é…ç½®
       </td>
       <td>
        Tomcaté»˜è®¤çº¿ç¨‹æ± 
       </td>
       <td>
        åŸºå‡†å€¼
       </td>
       <td>
        åŸºå‡†å€¼
       </td>
      </tr>
      <tr>
       <td>
        çº¿ç¨‹æ± ä¼˜åŒ–
       </td>
       <td>
        max-threads=200
       </td>
       <td>
        +180%
       </td>
       <td>
        65%
       </td>
      </tr>
      <tr>
       <td>
        JVMå‚æ•°è°ƒä¼˜
       </td>
       <td>
        G1+å †å†…å­˜ç»Ÿä¸€
       </td>
       <td>
        +90%
       </td>
       <td>
        40%
       </td>
      </tr>
      <tr>
       <td>
        è¿æ¥æ± ä¼˜åŒ–
       </td>
       <td>
        HikariCPå‚æ•°è°ƒä¼˜
       </td>
       <td>
        +35%
       </td>
       <td>
        25%
       </td>
      </tr>
     </tbody>
    </table>
    <hr/>
    <h3>
     å…­ã€é¿å‘æŒ‡å—
    </h3>
    <ol>
     <li>
      â€‹
      <strong>
       ç”Ÿäº§ç¯å¢ƒç¦ç”¨
       <code>
        -XX:+DisableExplicitGC
       </code>
      </strong>
      ï¼šå½“ä½¿ç”¨Nettyç­‰NIOæ¡†æ¶æ—¶ä¼šå¯¼è‡´å †å¤–å†…å­˜æº¢å‡º
     </li>
     <li>
      â€‹
      <strong>
       çº¿ç¨‹æ± é˜Ÿåˆ—é€‰æ‹©
      </strong>
      ï¼š
      <ul>
       <li>
        <code>
         SynchronousQueue
        </code>
        ï¼šé«˜ååä½†æ˜“ä¸¢å¤±è¯·æ±‚
       </li>
       <li>
        <code>
         LinkedBlockingQueue
        </code>
        ï¼šéœ€è®¾ç½®åˆç†å®¹é‡
       </li>
      </ul>
     </li>
     <li>
      â€‹
      <strong>
       å®¹å™¨ç¯å¢ƒå†…å­˜é™åˆ¶
      </strong>
      ï¼šå¿…é¡»æ·»åŠ 
      <code>
       -XX:+UseContainerSupport
      </code>
     </li>
    </ol>
    <hr/>
    <h3>
     ç»“è¯­
    </h3>
    <p>
     é€šè¿‡æœ¬æ–‡çš„è°ƒä¼˜æ–¹æ¡ˆï¼ŒæŸç”µå•†ç³»ç»Ÿåœ¨åŒåä¸€å¤§ä¿ƒä¸­æˆåŠŸå°†APIå¹³å‡å“åº”æ—¶é—´ä»320msé™ä½åˆ°98msã€‚è®°ä½ï¼šâ€‹
     <strong>
      æ‰€æœ‰å‚æ•°éƒ½è¦ç»è¿‡å‹æµ‹éªŒè¯ï¼â€‹
     </strong>
     æ¬¢è¿åœ¨è¯„è®ºåŒºç•™ä¸‹ä½ çš„ä¼˜åŒ–æ¡ˆä¾‹ï¼
    </p>
    <p>
     <strong>
      æŠ€æœ¯æ‹“å±•
     </strong>
     ï¼š
     <br/>
     ğŸ‘‰ã€ŠSpring Bootç›‘æ§ä½“ç³»æ­å»ºå…¨æ”»ç•¥ã€‹
     <br/>
     ğŸ‘‰ã€ŠJVMè°ƒä¼˜å®æˆ˜æ¡ˆä¾‹é›†ã€‹
    </p>
    <hr/>
    <p>
     <strong>
      #Spring Boot# #æ€§èƒ½ä¼˜åŒ–# #JVMè°ƒä¼˜# #çº¿ç¨‹æ± # æ›´å¤šæŠ€æœ¯å¹²è´§ï¼Œå…³æ³¨ä½œè€…ä¸è¿·è·¯ï¼â€‹
     </strong>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031323736323631392f:61727469636c652f64657461696c732f313436313734303435" class_="artid" style="display:none">
 </p>
</div>


