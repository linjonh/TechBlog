---
layout: post
title: "BUG分析微服务无法读取Nacos中的共享配置"
date: 2025-03-12 09:06:03 +0800
description: "基于Spring Cloud微服务的商城系统，无法读取Nacos中共享配置的几个可能原因分析。"
keywords: "【BUG分析】微服务无法读取Nacos中的共享配置"
categories: ['Bug']
tags: ['架构', '微服务', 'Spring', 'Cloud', 'Bug']
artid: "146195277"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146195277
    alt: "BUG分析微服务无法读取Nacos中的共享配置"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146195277
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146195277
cover: https://bing.ee123.net/img/rand?artid=146195277
image: https://bing.ee123.net/img/rand?artid=146195277
img: https://bing.ee123.net/img/rand?artid=146195277
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【BUG分析】微服务无法读取Nacos中的共享配置
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     项目场景
    </h2>
    <p>
     基于Spring Cloud微服务的商城系统。
     <br/>
     使用Nacos进行统一配置管理，在
     <code>
      bootstrap.xml
     </code>
     中读取配置参数。
    </p>
    <hr/>
    <h2>
     <a id="_6">
     </a>
     问题描述
    </h2>
    <p>
     购物车微服务可以读取Nacos中的共享mybatis配置，商品管理微服务却读不到，启动报错提示无法配置数据库源：
    </p>
    <pre><code class="prism language-powershell">Error starting ApplicationContext<span class="token punctuation">.</span> To display the conditions report re-run your application with <span class="token string">'debug'</span> enabled<span class="token punctuation">.</span>
2025-03-12 08:37:45<span class="token punctuation">.</span>930 ERROR 11556 <span class="token operator">--</span><span class="token operator">-</span> <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> o<span class="token punctuation">.</span>s<span class="token punctuation">.</span>b<span class="token punctuation">.</span>d<span class="token punctuation">.</span>LoggingFailureAnalysisReporter   : 

<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
APPLICATION FAILED TO <span class="token function">START</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>

Description:

Failed to configure a DataSource: <span class="token string">'url'</span> attribute is not specified and no embedded datasource could be configured<span class="token punctuation">.</span>

Reason: Failed to determine a suitable driver <span class="token keyword">class</span>


Action:

Consider the following:
	<span class="token keyword">If</span> you want an embedded database <span class="token punctuation">(</span>H2<span class="token punctuation">,</span> HSQL or Derby<span class="token punctuation">)</span><span class="token punctuation">,</span> please put it on the classpath<span class="token punctuation">.</span>
	<span class="token keyword">If</span> you have database settings to be loaded <span class="token keyword">from</span> a particular profile you may need to activate it <span class="token punctuation">(</span>the profiles local are currently active<span class="token punctuation">)</span><span class="token punctuation">.</span>


<span class="token keyword">Process</span> finished with <span class="token keyword">exit</span> code 1

</code></pre>
    <hr/>
    <h2>
     <a id="_36">
     </a>
     可能的原因分析
    </h2>
    <p>
     检查
     <code>
      bootstrap.yaml
     </code>
     中的Nacos服务器地址和共享配置文件名字：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> item<span class="token punctuation">-</span>service  <span class="token comment"># 微服务名称</span>
  <span class="token key atrule">profiles</span><span class="token punctuation">:</span>
    <span class="token key atrule">active</span><span class="token punctuation">:</span> dev
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 192.168.119.128<span class="token punctuation">:</span><span class="token number">8848</span>
      <span class="token key atrule">config</span><span class="token punctuation">:</span>
        <span class="token key atrule">file-extension</span><span class="token punctuation">:</span> yaml  <span class="token comment"># 文件后缀名</span>
        <span class="token key atrule">shared-configs</span><span class="token punctuation">:</span>   <span class="token comment"># 共享配置</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> shared<span class="token punctuation">-</span>jdbc.yaml <span class="token comment"># 共享mybatis配置</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> shared<span class="token punctuation">-</span>log.yaml  <span class="token comment"># 共享日志配置</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> shared<span class="token punctuation">-</span>swagger.yaml  <span class="token comment"># 共享日志配置</span>
          <span class="token punctuation">-</span> <span class="token key atrule">data-id</span><span class="token punctuation">:</span> shared<span class="token punctuation">-</span>seata.yaml
</code></pre>
    <p>
     检查Nacos配置文件
     <code>
      shared-jdbc.yaml
     </code>
     ：
     <br/>
     <img alt="Nacos配置管理" src="https://i-blog.csdnimg.cn/direct/07c6684f059a4f84b7bb1bb44383b78d.png"/>
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//$<span class="token punctuation">{<!-- --></span>hm.db.host<span class="token punctuation">:</span>192.168.119.128<span class="token punctuation">}</span><span class="token punctuation">:</span>$<span class="token punctuation">{<!-- --></span>hm.db.port<span class="token punctuation">:</span><span class="token number">3306</span><span class="token punctuation">}</span>/$<span class="token punctuation">{<!-- --></span>hm.db.database<span class="token punctuation">}</span><span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">username</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>hm.db.un<span class="token punctuation">:</span>root<span class="token punctuation">}</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>hm.db.pw<span class="token punctuation">:</span><span class="token number">123</span><span class="token punctuation">}</span>
<span class="token key atrule">mybatis-plus</span><span class="token punctuation">:</span>
  <span class="token key atrule">configuration</span><span class="token punctuation">:</span>
    <span class="token key atrule">default-enum-type-handler</span><span class="token punctuation">:</span> com.baomidou.mybatisplus.core.handlers.MybatisEnumTypeHandler
  <span class="token key atrule">global-config</span><span class="token punctuation">:</span>
    <span class="token key atrule">db-config</span><span class="token punctuation">:</span>
      <span class="token key atrule">update-strategy</span><span class="token punctuation">:</span> not_null
      <span class="token key atrule">id-type</span><span class="token punctuation">:</span> auto
</code></pre>
    <p>
     检查
     <code>
      application.yaml
     </code>
     中的数据库名称：
    </p>
    <pre><code class="prism language-yaml"><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>
<span class="token key atrule">hm</span><span class="token punctuation">:</span>
  <span class="token key atrule">db</span><span class="token punctuation">:</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span> hm<span class="token punctuation">-</span>item
  <span class="token key atrule">swagger</span><span class="token punctuation">:</span>
    <span class="token key atrule">title</span><span class="token punctuation">:</span> <span class="token string">"商城商品服务接口文档"</span>
    <span class="token key atrule">package</span><span class="token punctuation">:</span> com.hmall.item.controller
</code></pre>
    <p>
     检查
     <code>
      pom.xml
     </code>
     的相关依赖：
    </p>
    <pre><code class="prism language-xml">		<span class="token comment">&lt;!--Nacos统一配置管理--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-nacos-config<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--读取bootstrap文件--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-bootstrap<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <hr/>
    <p>
     疑问：为什么要把配置参数写在
     <code>
      bootstrap.yaml
     </code>
     中，而不直接写在
     <code>
      application.yaml
     </code>
     中？
    </p>
    <ol>
     <li>
      加载顺序
      <ul>
       <li>
        <code>
         bootstrap.yaml
        </code>
        ：
        <strong>
         在Spring Boot应用启动时，
         <code>
          bootstrap.yaml
         </code>
         会先于
         <code>
          application.yaml
         </code>
         加载
        </strong>
        。这使得Nacos配置中心的相关参数（如服务器地址、命名空间等）能在应用启动初期被读取，确保后续配置加载时Nacos已准备就绪。
       </li>
       <li>
        <code>
         application.yaml
        </code>
        ：
        <code>
         application.yaml
        </code>
        的加载在
        <code>
         bootstrap.yaml
        </code>
        之后，适合存放应用自身的配置。
       </li>
      </ul>
     </li>
     <li>
      配置优先级
      <ul>
       <li>
        <code>
         bootstrap.yaml
        </code>
        ：
        <strong>
         <code>
          bootstrap.yaml
         </code>
         中的配置优先级高于
         <code>
          application.yaml
         </code>
         ，确保Nacos配置参数不会被
         <code>
          application.yaml
         </code>
         中的配置覆盖
        </strong>
        。
       </li>
      </ul>
     </li>
     <li>
      环境隔离
      <ul>
       <li>
        <code>
         bootstrap.yaml
        </code>
        ：通常用于与环境相关的配置，如Nacos服务器地址等，便于在不同环境中切换。
       </li>
       <li>
        <code>
         application.yaml
        </code>
        ：适合存放与环境无关的应用配置。
       </li>
      </ul>
     </li>
     <li>
      配置中心集成
      <ul>
       <li>
        <code>
         bootstrap.yaml
        </code>
        ：在集成配置中心时，
        <code>
         bootstrap.yaml
        </code>
        用于指定配置中心的位置和认证信息，确保应用启动时能正确连接到配置中心并获取配置。
       </li>
      </ul>
     </li>
    </ol>
    <p>
     总结：
     <strong>
      将Nacos配置参数放在
      <code>
       bootstrap.yaml
      </code>
      中，主要是为了确保这些配置能在应用启动初期加载，并且不会被其他配置覆盖，同时便于环境隔离和配置中心集成。
     </strong>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34373637383534322f:61727469636c652f64657461696c732f313436313935323737" class_="artid" style="display:none">
 </p>
</div>


