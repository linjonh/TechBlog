---
layout: post
title: "结合-Pandas-使用-SQLite3-实战"
date: 2025-03-08 22:50:49 +0800
description: "通过 Pandas + SQLite3 的组合，你可以：✅快速导入/导出数据：告别手动拼接 SQL 语句。✅无缝衔接数据分析：清洗、计算、可视化后直接入库。✅处理海量数据：分块读写避免内存爆炸。下一步建议尝试将 Excel/CSV 文件自动同步到 SQLite3 数据库。学习使用sqlalchemy库增强 SQL 操作能力。"
keywords: "结合 Pandas 使用 SQLite3 实战"
categories: ['未分类']
tags: ['数据库', 'Sqlite', 'Pandas']
artid: "146124471"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146124471
    alt: "结合-Pandas-使用-SQLite3-实战"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146124471
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146124471
cover: https://bing.ee123.net/img/rand?artid=146124471
image: https://bing.ee123.net/img/rand?artid=146124471
img: https://bing.ee123.net/img/rand?artid=146124471
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     结合 Pandas 使用 SQLite3 实战
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_Pandas__SQLite3__0">
     </a>
     结合 Pandas 使用 SQLite3 实战
    </h2>
    <p>
     <strong>
      让数据分析更高效！用 Pandas 直接读写 SQLite3 数据，告别手动拼接 SQL 语句！
     </strong>
    </p>
    <hr/>
    <h3>
     <a id="1__4">
     </a>
     1 环境准备
    </h3>
    <p>
     确保已安装
     <code>
      pandas
     </code>
     和
     <code>
      sqlite3
     </code>
     （前者需单独安装，后者是 Python 内置）：
    </p>
    <pre><code class="prism language-bash">pip <span class="token function">install</span> pandas
</code></pre>
    <hr/>
    <h3>
     <a id="2__SQLite3__DataFrame_12">
     </a>
     2 从 SQLite3 读取数据到 DataFrame
    </h3>
    <h3>
     <a id="_13">
     </a>
     基础用法：读取整个表
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> sqlite3

<span class="token comment"># 连接到数据库</span>
conn <span class="token operator">=</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">'test.db'</span><span class="token punctuation">)</span>

<span class="token comment"># 读取 users 表到 DataFrame</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span><span class="token string">'SELECT * FROM users'</span><span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 查看前5行数据</span>

<span class="token comment"># 关闭连接</span>
conn<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_29">
     </a>
     高级用法：筛选和聚合
    </h3>
    <pre><code class="prism language-python">query <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
    SELECT 
        name, 
        AVG(age) as avg_age   -- 计算平均年龄
    FROM users 
    WHERE age &gt; 20 
    GROUP BY name
'''</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span>query<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h3>
     <a id="3__DataFrame__SQLite3_45">
     </a>
     3 将 DataFrame 写入 SQLite3
    </h3>
    <h3>
     <a id="_46">
     </a>
     基本写入（全量覆盖）
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># 创建一个示例 DataFrame</span>
data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'name'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'David'</span><span class="token punctuation">,</span> <span class="token string">'Eve'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'email'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'david@test.com'</span><span class="token punctuation">,</span> <span class="token string">'eve@test.com'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>data<span class="token punctuation">)</span>

<span class="token comment"># 写入到 users 表（全量覆盖）</span>
df<span class="token punctuation">.</span>to_sql<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">'users'</span><span class="token punctuation">,</span>     <span class="token comment"># 表名</span>
    con<span class="token operator">=</span>conn<span class="token punctuation">,</span>         <span class="token comment"># 数据库连接</span>
    if_exists<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">,</span>  <span class="token comment"># 如果表存在，直接替换（慎用！）</span>
    index<span class="token operator">=</span><span class="token boolean">False</span>       <span class="token comment"># 不保存 DataFrame 的索引列</span>
<span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_66">
     </a>
     追加数据（增量写入）
    </h3>
    <pre><code class="prism language-python">df<span class="token punctuation">.</span>to_sql<span class="token punctuation">(</span>
    name<span class="token operator">=</span><span class="token string">'users'</span><span class="token punctuation">,</span>
    con<span class="token operator">=</span>conn<span class="token punctuation">,</span>
    if_exists<span class="token operator">=</span><span class="token string">'append'</span><span class="token punctuation">,</span>  <span class="token comment"># 追加到现有表</span>
    index<span class="token operator">=</span><span class="token boolean">False</span>
<span class="token punctuation">)</span>
conn<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h3>
     <a id="4____79">
     </a>
     4 实战场景：数据清洗 + 入库
    </h3>
    <p>
     假设有一个 CSV 文件
     <code>
      dirty_data.csv
     </code>
     ，需要清洗后存入 SQLite3：
    </p>
    <pre><code class="prism language-csv">id,name,age,email
1, Alice,30,alice@example.com
2, Bob , invalid, bob@example.com  # 错误年龄
3, Charlie,35,missing_email
</code></pre>
    <h3>
     <a id="_1_Pandas__88">
     </a>
     步骤 1：用 Pandas 清洗数据
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># 读取 CSV</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'dirty_data.csv'</span><span class="token punctuation">)</span>

<span class="token comment"># 清洗操作</span>
df<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_numeric<span class="token punctuation">(</span>df<span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> errors<span class="token operator">=</span><span class="token string">'coerce'</span><span class="token punctuation">)</span>  <span class="token comment"># 无效年龄转为 NaN</span>
df <span class="token operator">=</span> df<span class="token punctuation">.</span>dropna<span class="token punctuation">(</span>subset<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'age'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                        <span class="token comment"># 删除年龄无效的行</span>
df<span class="token punctuation">[</span><span class="token string">'email'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'email'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token string">'unknown'</span><span class="token punctuation">)</span>            <span class="token comment"># 填充缺失邮箱</span>
df<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">str</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>                   <span class="token comment"># 去除名字前后空格</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>df<span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_2_102">
     </a>
     步骤 2：写入数据库
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">with</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">'test.db'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
    <span class="token comment"># 写入新表 cleaned_users</span>
    df<span class="token punctuation">.</span>to_sql<span class="token punctuation">(</span><span class="token string">'cleaned_users'</span><span class="token punctuation">,</span> conn<span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> if_exists<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 验证写入结果</span>
    df_check <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span><span class="token string">'SELECT * FROM cleaned_users'</span><span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>df_check<span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h3>
     <a id="5__115">
     </a>
     5 性能优化：分块写入大数据
    </h3>
    <p>
     处理超大型数据时（如 10 万行），避免一次性加载到内存：
    </p>
    <pre><code class="prism language-python"><span class="token comment"># 分块读取 CSV（每次读 1 万行）</span>
chunk_iter <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'big_data.csv'</span><span class="token punctuation">,</span> chunksize<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">)</span>

<span class="token keyword">with</span> sqlite3<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">'big_db.db'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> conn<span class="token punctuation">:</span>
    <span class="token keyword">for</span> chunk <span class="token keyword">in</span> chunk_iter<span class="token punctuation">:</span>
        <span class="token comment"># 对每个块做简单处理</span>
        chunk<span class="token punctuation">[</span><span class="token string">'timestamp'</span><span class="token punctuation">]</span> <span class="token operator">=</span> pd<span class="token punctuation">.</span>to_datetime<span class="token punctuation">(</span>chunk<span class="token punctuation">[</span><span class="token string">'timestamp'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token comment"># 分块写入数据库</span>
        chunk<span class="token punctuation">.</span>to_sql<span class="token punctuation">(</span>
            name<span class="token operator">=</span><span class="token string">'big_table'</span><span class="token punctuation">,</span>
            con<span class="token operator">=</span>conn<span class="token punctuation">,</span>
            if_exists<span class="token operator">=</span><span class="token string">'append'</span><span class="token punctuation">,</span>  <span class="token comment"># 追加模式</span>
            index<span class="token operator">=</span><span class="token boolean">False</span>
        <span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"全部写入完成！"</span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h3>
     <a id="6__SQL__137">
     </a>
     6 高级技巧：直接执行 SQL 操作
    </h3>
    <p>
     Pandas 虽然强大，但复杂查询仍需直接操作 SQL：
    </p>
    <pre><code class="prism language-python"><span class="token comment"># 创建临时 DataFrame</span>
df <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'product'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'A'</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'price'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment"># 写入 products 表</span>
df<span class="token punctuation">.</span>to_sql<span class="token punctuation">(</span><span class="token string">'products'</span><span class="token punctuation">,</span> conn<span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> if_exists<span class="token operator">=</span><span class="token string">'replace'</span><span class="token punctuation">)</span>

<span class="token comment"># 执行复杂查询（连接 users 和 orders 表）</span>
query <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
    SELECT 
        u.name,
        p.product,
        p.price
    FROM users u
    JOIN orders o ON u.id = o.user_id
    JOIN products p ON o.product_id = p.id
    WHERE p.price &gt; 10
'''</span>
result_df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_sql<span class="token punctuation">(</span>query<span class="token punctuation">,</span> conn<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>result_df<span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h3>
     <a id="7__163">
     </a>
     7 避坑指南
    </h3>
    <p>
     <strong>
      数据类型匹配问题
     </strong>
     ：
    </p>
    <ul>
     <li>
      SQLite 默认所有列为
      <code>
       TEXT
      </code>
      ，但 Pandas 会自动推断类型。
     </li>
     <li>
      写入时可用
      <code>
       dtype
      </code>
      参数手动指定类型：
      <pre><code class="prism language-python">df<span class="token punctuation">.</span>to_sql<span class="token punctuation">(</span><span class="token string">'table'</span><span class="token punctuation">,</span> conn<span class="token punctuation">,</span> dtype<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'age'</span><span class="token punctuation">:</span> <span class="token string">'INTEGER'</span><span class="token punctuation">,</span> <span class="token string">'price'</span><span class="token punctuation">:</span> <span class="token string">'REAL'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
     </li>
    </ul>
    <ol start="2">
     <li>
      <p>
       <strong>
        主键和索引
       </strong>
       ：
      </p>
      <ul>
       <li>
        Pandas 不会自动创建主键或索引，需提前用 SQL 语句定义表结构。
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        性能瓶颈
       </strong>
       ：
      </p>
      <ul>
       <li>
        写入大量数据时，关闭事务自动提交可提速：
        <pre><code class="prism language-python"><span class="token keyword">with</span> conn<span class="token punctuation">:</span>
    df<span class="token punctuation">.</span>to_sql<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>  <span class="token comment"># 使用上下文管理器自动提交</span>
</code></pre>
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <h3>
     <a id="8__182">
     </a>
     8 总结
    </h3>
    <p>
     通过 Pandas + SQLite3 的组合，你可以：
     <br/>
     ✅
     <strong>
      快速导入/导出数据
     </strong>
     ：告别手动拼接 SQL 语句。
     <br/>
     ✅
     <strong>
      无缝衔接数据分析
     </strong>
     ：清洗、计算、可视化后直接入库。
     <br/>
     ✅
     <strong>
      处理海量数据
     </strong>
     ：分块读写避免内存爆炸。
    </p>
    <p>
     <strong>
      下一步建议
     </strong>
     ：
    </p>
    <ul>
     <li>
      尝试将 Excel/CSV 文件自动同步到 SQLite3 数据库。
     </li>
     <li>
      学习使用
      <code>
       sqlalchemy
      </code>
      库增强 SQL 操作能力。
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f6c756f636f6e673332312f:61727469636c652f64657461696c732f313436313234343731" class_="artid" style="display:none">
 </p>
</div>


