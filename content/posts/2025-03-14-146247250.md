---
arturl_encode: "68747470:733a2f2f626c6f672e6373646e2e6e65742f6366383833332f:61727469636c652f64657461696c732f313436323437323530"
layout: post
title: "fastapiangularå®ç°Tcpåœ¨çº¿èŠå¤©å®¤åŠŸèƒ½"
date: 2025-03-14 05:17:07 +0800
description: "step6:å¥½äº†ï¼Œåç«¯éƒ¨åˆ†å†™å®Œäº†ï¼ŒéªŒè¯æˆåŠŸï¼Œå¯ä»¥å±•ç°å½“å‰åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼Œå¹¶ä¸”å¯ä»¥ç¾¤èŠï¼Œå¯ä»¥ç§å‘ï¼Œæ¥ä¸‹æ¥å†™å‰ç«¯angularã€‚step4:ç„¶åå¼€å¯ä¸¤ä¸ªæ§åˆ¶å°çª—å£ï¼Œåˆ†åˆ«è¿è¡Œå®¢æˆ·ç«¯ç¨‹åº æ¯”å¦‚ï¼Œå®¢æˆ·ç«¯1ã€‚æˆ‘è®¡åˆ’ç”¨fastapi+angularï¼Œå®ç°ä¸€ä¸ªåœ¨çº¿èŠå¤©å®¤çš„åŠŸèƒ½ï¼Œstep3:å¥½äº†ï¼Œåç«¯ä»£ç å†™å®Œäº†ï¼Œæ¥ä¸‹æ¥æ˜¯éªŒè¯ï¼Œé¦–å…ˆè¿è¡ŒæœåŠ¡ç«¯ã€‚3.æ‰€æœ‰åœ¨çº¿çš„ç”¨æˆ·ï¼Œå¿…é¡»å®ç°ç¾¤èŠå’Œå•ç‹¬èŠå¤©ã€‚2.ç”¨ä¸€ä¸ªåˆ—è¡¨ï¼Œæ˜¾ç¤ºå½“å‰æ‰€æœ‰åœ¨çº¿çš„ç”¨æˆ·ã€‚1.å¿…é¡»æœ‰ä¸€ä¸ªæœåŠ¡ç«¯å’Œå¤šä¸ªå®¢æˆ·ç«¯ã€‚step5:å®¢æˆ·ç«¯2ã€‚"
keywords: "fastapi+angularå®ç°Tcpåœ¨çº¿èŠå¤©å®¤åŠŸèƒ½"
categories: ['Typescript']
tags: ['Tcp', 'Fastapi', 'Angular']
artid: "146247250"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146247250
    alt: "fastapiangularå®ç°Tcpåœ¨çº¿èŠå¤©å®¤åŠŸèƒ½"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146247250
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146247250
cover: https://bing.ee123.net/img/rand?artid=146247250
image: https://bing.ee123.net/img/rand?artid=146247250
img: https://bing.ee123.net/img/rand?artid=146247250
---

# fastapi+angularå®ç°Tcpåœ¨çº¿èŠå¤©å®¤åŠŸèƒ½

è¯´æ˜ï¼š
  
æˆ‘è®¡åˆ’ç”¨fastapi+angularï¼Œå®ç°ä¸€ä¸ªåœ¨çº¿èŠå¤©å®¤çš„åŠŸèƒ½ï¼Œ
  
1.å¿…é¡»æœ‰ä¸€ä¸ªæœåŠ¡ç«¯å’Œå¤šä¸ªå®¢æˆ·ç«¯
  
2.ç”¨ä¸€ä¸ªåˆ—è¡¨ï¼Œæ˜¾ç¤ºå½“å‰æ‰€æœ‰åœ¨çº¿çš„ç”¨æˆ·
  
3.æ‰€æœ‰åœ¨çº¿çš„ç”¨æˆ·ï¼Œå¿…é¡»å®ç°ç¾¤èŠå’Œå•ç‹¬èŠå¤©
  
æ•ˆæœå›¾ï¼š
  
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://i-blog.csdnimg.cn/direct/a6cbd2bfb00a43408fd94726827f5a26.png#pic_center)
  
æ–°å¢å®‰å“æµ‹è¯•ç¨‹åº C:\Users\wangrusheng\AndroidStudioProjects\MyApplication9\app\src\test\java\com\example\myapplication\MyFirstTest.kt

```java
package com.example.myapplication

import kotlinx.coroutines.*
import okhttp3.*
import java.util.*
import java.util.concurrent.TimeUnit
import com.google.gson.Gson

fun main() = runBlocking {
    val client = ChatTester("UserA", "ws://127.0.0.1:8000/ws") // Android emulator local address
    launch { client.start() }

    // Test operation sequence
    delay(1500) // Wait for connection establishment
    client.sendPublicMessage("Hello everyone, this is UserA")
    delay(1000)
    client.sendPrivateMessage("UserB", "Hi B, this is a private message")
    delay(3000)

    client.close()
}

class ChatTester(private val username: String, private val wsUrl: String) {
    private val client = OkHttpClient.Builder()
        .connectTimeout(10, TimeUnit.SECONDS) // Connection timeout[6](@ref)
        .build()

    private var webSocket: WebSocket? = null
    private val gson = Gson()
    private val scope = CoroutineScope(Dispatchers.Default)

    fun start() {
        val request = Request.Builder().url(wsUrl).build()
        webSocket = client.newWebSocket(request, object : WebSocketListener() {
            override fun onOpen(webSocket: WebSocket, response: Response) {
                println("[$username] Connection established")
                sendInitMessage()
            }

            override fun onMessage(webSocket: WebSocket, text: String) {
                handleMessage(text)
            }

            override fun onClosed(webSocket: WebSocket, code: Int, reason: String) {
                println("[$username] Connection closed")
            }

            override fun onFailure(webSocket: WebSocket, t: Throwable, response: Response?) {
                println("[$username] Connection error: ${t.message}")
            }
        })
    }

    private fun sendInitMessage() {
        val initMsg = mapOf("username" to username)
        webSocket?.send(gson.toJson(initMsg))
    }

    fun sendPublicMessage(content: String) {
        val message = mapOf(
            "type" to "public",
            "content" to content
        )
        webSocket?.send(gson.toJson(message))
        println("[$username] Sent public message: $content")
    }

    fun sendPrivateMessage(targetUser: String, content: String) {
        val message = mapOf(
            "type" to "private",
            "to" to targetUser,
            "content" to content
        )
        webSocket?.send(gson.toJson(message))
        println("[$username] Sent private to $targetUser: $content")
    }

    private fun handleMessage(json: String) {
        val data = gson.fromJson(json, Map::class.java)
        when (data["type"]) {
            "user_list" -> {
                val users = data["users"] as List<Map<String, String>>
                println("\n[$username] Online users updated:")
                users.forEach { println("  ${it["client_id"]} - ${it["username"]}") }
            }
            "private" -> {
                println("\n[$username] Received private from ${data["sender_name"]}: ${data["content"]}")
            }
            "public" -> {
                println("\n[$username] Received public message from ${data["sender_name"]}: ${data["content"]}")
            }
            "system" -> {
                println("\n[$username] System notification: ${data["content"]}")
            }
        }
    }

    fun close() {
        webSocket?.close(1000, "Normal closure")
        client.dispatcher.executorService.shutdown()
    }
}

```

step1:C:\Users\wag\PycharmProjects\FastAPIProject\main.py

```python
from fastapi import FastAPI, WebSocket, WebSocketDisconnect
from typing import Dict
import uuid
import json
import datetime
import logging

# é…ç½®æ—¥å¿—
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("ChatServer")

app = FastAPI()


class ConnectionManager:
    def __init__(self):
        self.active_connections: Dict[str, dict] = {}

    async def connect(self, websocket: WebSocket, client_id: str, username: str):
        self.active_connections[client_id] = {
            "websocket": websocket,
            "username": username
        }
        logger.info(f"ç”¨æˆ· {username}({client_id}) å·²è¿æ¥")
        await self._broadcast_user_list()
        await self._send_system_message(f"{username} è¿›å…¥èŠå¤©å®¤")

    async def disconnect(self, client_id: str):
        if client_id in self.active_connections:
            user = self.active_connections[client_id]
            del self.active_connections[client_id]
            logger.info(f"ç”¨æˆ· {user['username']}({client_id}) å·²æ–­å¼€")
            await self._broadcast_user_list()
            await self._send_system_message(f"{user['username']} å·²ç¦»å¼€")

    async def handle_message(self, sender_id: str, data: dict):
        if data["type"] == "private":
            await self._send_private_message(
                sender_id=sender_id,
                recipient_id=data["to"],
                content=data["content"]
            )
        else:
            await self._broadcast_message(sender_id, data["content"])

    async def _send_private_message(self, sender_id: str, recipient_id: str, content: str):
        sender = self.active_connections.get(sender_id)
        recipient = self.active_connections.get(recipient_id)

        if sender and recipient:
            message = {
                "type": "private",
                "from": sender_id,
                "to": recipient_id,
                "sender_name": sender["username"],
                "content": content,
                "timestamp": self._current_time()
            }
            await recipient["websocket"].send_text(json.dumps(message))
            await sender["websocket"].send_text(json.dumps(message))  # å›æ˜¾

    async def _broadcast_message(self, sender_id: str, content: str):
        sender = self.active_connections.get(sender_id)
        if sender:
            message = {
                "type": "public",
                "from": sender_id,
                "sender_name": sender["username"],
                "content": content,
                "timestamp": self._current_time()
            }
            for conn in self.active_connections.values():
                await conn["websocket"].send_text(json.dumps(message))

    async def _send_system_message(self, content: str):
        message = {
            "type": "system",
            "content": content,
            "timestamp": self._current_time()
        }
        for conn in self.active_connections.values():
            await conn["websocket"].send_text(json.dumps(message))

    async def _broadcast_user_list(self):
        users = [{
            "client_id": cid,
            "username": info["username"]
        } for cid, info in self.active_connections.items()]

        message = {
            "type": "user_list",
            "users": users
        }
        for conn in self.active_connections.values():
            await conn["websocket"].send_text(json.dumps(message))

    def _current_time(self):
        return datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")


manager = ConnectionManager()


@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    client_id = str(uuid.uuid4())[:8]  # ç”Ÿæˆ8ä½çŸ­ID

    try:
        # æ¥æ”¶åˆå§‹åŒ–ä¿¡æ¯
        init_data = await websocket.receive_json()
        username = init_data.get("username", f"ç”¨æˆ·{client_id}")

        await manager.connect(websocket, client_id, username)

        while True:
            data = await websocket.receive_json()
            await manager.handle_message(client_id, data)

    except json.JSONDecodeError:
        logger.error("æ”¶åˆ°æ— æ•ˆçš„JSONæ•°æ®")
    except WebSocketDisconnect:
        await manager.disconnect(client_id)
    except Exception as e:
        logger.error(f"è¿æ¥å¼‚å¸¸: {str(e)}")
        await manager.disconnect(client_id)
    finally:
        await websocket.close()


if __name__ == "__main__":
    import uvicorn

    uvicorn.run(app, host="0.0.0.0", port=8000)

```

step2:C:\Users\wg\PycharmProjects\FastAPIProject\client.py

```python
import websockets
import asyncio
import json
import time


class ChatClient:
    def __init__(self):
        self.username = ""
        self.client_id = ""

    async def run(self):
        self.username = input("è¯·è¾“å…¥ç”¨æˆ·å: ")
        async with websockets.connect("ws://localhost:8000/ws") as websocket:
            # å‘é€åˆå§‹åŒ–ä¿¡æ¯
            await websocket.send(json.dumps({"username": self.username}))

            # æ¶ˆæ¯æ¥æ”¶ä»»åŠ¡
            receive_task = asyncio.create_task(self.receive_handler(websocket))

            try:
                while True:
                    await self.input_handler(websocket)
            except (asyncio.CancelledError, KeyboardInterrupt):
                pass
            finally:
                receive_task.cancel()
                await receive_task

    async def receive_handler(self, websocket):
        try:
            async for message in websocket:
                data = json.loads(message)
                self.handle_message(data)
        except websockets.ConnectionClosed:
            print("\nè¿æ¥å·²æ–­å¼€")

    def handle_message(self, data):
        msg_type = data["type"]
        timestamp = data.get("timestamp", "")

        if msg_type == "user_list":
            print("\n" + "=" * 50)
            print("ğŸ“‹ åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆID | ç”¨æˆ·åï¼‰")
            print("-" * 50)
            for user in data["users"]:
                print(f"  {user['client_id']} | {user['username']}")
            print("=" * 50 + "\n")

        elif msg_type == "private":
            sender = data["sender_name"]
            content = data["content"]
            print(f"\nğŸ”’ [{timestamp}] æ¥è‡ª {sender} çš„ç§èŠæ¶ˆæ¯:")
            print(f"   {content}")

        elif msg_type == "public":
            sender = data["sender_name"]
            content = data["content"]
            print(f"\nğŸ“¢ [{timestamp}] å…¬å…±æ¶ˆæ¯ {sender}:")
            print(f"   {content}")

        elif msg_type == "system":
            print(f"\nâš ï¸ [{timestamp}] ç³»ç»Ÿé€šçŸ¥:")
            print(f"   {data['content']}")

    async def input_handler(self, websocket):
        prompt = "\nè¾“å…¥æ¶ˆæ¯ï¼ˆæ ¼å¼è¯´æ˜ï¼‰:\n" \
                 "1. ç¾¤å‘æ¶ˆæ¯ â†’ ç›´æ¥è¾“å…¥å†…å®¹\n" \
                 "2. ç§èŠæ¶ˆæ¯ â†’ @ç”¨æˆ·ID æ¶ˆæ¯å†…å®¹\n" \
                 "3. é€€å‡º â†’ è¾“å…¥ exit\n" \
                 "è¯·è¾“å…¥: "

        cmd = await asyncio.get_event_loop().run_in_executor(None, input, prompt)

        if cmd.lower() == 'exit':
            await websocket.close()
            raise asyncio.CancelledError

        if cmd.startswith("@"):
            parts = cmd.split(" ", 1)
            if len(parts) == 2:
                user_id, content = parts[0][1:], parts[1]
                message = {
                    "type": "private",
                    "to": user_id,
                    "content": content
                }
                await websocket.send(json.dumps(message))
                return
            else:
                print("! ç§èŠæ ¼å¼é”™è¯¯ï¼Œæ­£ç¡®æ ¼å¼ï¼š@ç”¨æˆ·ID æ¶ˆæ¯å†…å®¹")
                return

        # å‘é€å…¬å…±æ¶ˆæ¯
        await websocket.send(json.dumps({
            "type": "public",
            "content": cmd
        }))


if __name__ == "__main__":
    client = ChatClient()
    try:
        asyncio.run(client.run())
    except KeyboardInterrupt:
        print("\nå®¢æˆ·ç«¯å·²é€€å‡º")

```

step3:å¥½äº†ï¼Œåç«¯ä»£ç å†™å®Œäº†ï¼Œæ¥ä¸‹æ¥æ˜¯éªŒè¯ï¼Œé¦–å…ˆè¿è¡ŒæœåŠ¡ç«¯

```bash
(.venv) PS C:\Users\wangrusheng\PycharmProjects\FastAPIProject> python main.py
INFO:     Started server process [9720]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 (Press CTRL+C to quit)
INFO:     ('127.0.0.1', 51061) - "WebSocket /ws" [accepted]
INFO:     connection open
INFO:ChatServer:ç”¨æˆ· å¼ é£(bf0c711b) å·²è¿æ¥
INFO:     ('127.0.0.1', 51071) - "WebSocket /ws" [accepted]
INFO:     connection open
INFO:ChatServer:ç”¨æˆ· åˆ˜å¤‡(4be9b4df) å·²è¿æ¥



```

step4:ç„¶åå¼€å¯ä¸¤ä¸ªæ§åˆ¶å°çª—å£ï¼Œåˆ†åˆ«è¿è¡Œå®¢æˆ·ç«¯ç¨‹åº æ¯”å¦‚ï¼Œå®¢æˆ·ç«¯1

```bash
(.venv) PS C:\Users\wangrusheng\PycharmProjects\FastAPIProject> python client.py
è¯·è¾“å…¥ç”¨æˆ·å: å¼ é£ 

è¾“å…¥æ¶ˆæ¯ï¼ˆæ ¼å¼è¯´æ˜ï¼‰:
1. ç¾¤å‘æ¶ˆæ¯ â†’ ç›´æ¥è¾“å…¥å†…å®¹
2. ç§èŠæ¶ˆæ¯ â†’ @ç”¨æˆ·ID æ¶ˆæ¯å†…å®¹
3. é€€å‡º â†’ è¾“å…¥ exit
è¯·è¾“å…¥: 
==================================================
ğŸ“‹ åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆID | ç”¨æˆ·åï¼‰
--------------------------------------------------
  bf0c711b | å¼ é£
==================================================


âš ï¸ [2025-03-14 05:05:40] ç³»ç»Ÿé€šçŸ¥:
   å¼ é£ è¿›å…¥èŠå¤©å®¤

==================================================
ğŸ“‹ åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆID | ç”¨æˆ·åï¼‰
--------------------------------------------------
  bf0c711b | å¼ é£
  4be9b4df | åˆ˜å¤‡
==================================================


âš ï¸ [2025-03-14 05:05:47] ç³»ç»Ÿé€šçŸ¥:
   åˆ˜å¤‡ è¿›å…¥èŠå¤©å®¤

ğŸ“¢ [2025-03-14 05:05:57] å…¬å…±æ¶ˆæ¯ åˆ˜å¤‡:
   hello
ä»Šå¤©å¤©æ°”ä¸é”™

è¾“å…¥æ¶ˆæ¯ï¼ˆæ ¼å¼è¯´æ˜ï¼‰:
1. ç¾¤å‘æ¶ˆæ¯ â†’ ç›´æ¥è¾“å…¥å†…å®¹
2. ç§èŠæ¶ˆæ¯ â†’ @ç”¨æˆ·ID æ¶ˆæ¯å†…å®¹
3. é€€å‡º â†’ è¾“å…¥ exit
è¯·è¾“å…¥:
ğŸ“¢ [2025-03-14 05:06:12] å…¬å…±æ¶ˆæ¯ å¼ é£:
   ä»Šå¤©å¤©æ°”ä¸é”™

ğŸ“¢ [2025-03-14 05:06:20] å…¬å…±æ¶ˆæ¯ åˆ˜å¤‡:
   æ˜¯çš„ï¼Œé€‚åˆéƒŠæ¸¸
@4be9b4df å¤§å“¥ï¼Œè¦ä¸ï¼Œä»Šå¤©å»èšé¤å§

è¾“å…¥æ¶ˆæ¯ï¼ˆæ ¼å¼è¯´æ˜ï¼‰:
1. ç¾¤å‘æ¶ˆæ¯ â†’ ç›´æ¥è¾“å…¥å†…å®¹
2. ç§èŠæ¶ˆæ¯ â†’ @ç”¨æˆ·ID æ¶ˆæ¯å†…å®¹
3. é€€å‡º â†’ è¾“å…¥ exit
è¯·è¾“å…¥:
ğŸ”’ [2025-03-14 05:06:48] æ¥è‡ª å¼ é£ çš„ç§èŠæ¶ˆæ¯:
   å¤§å“¥ï¼Œè¦ä¸ï¼Œä»Šå¤©å»èšé¤å§

ğŸ”’ [2025-03-14 05:07:09] æ¥è‡ª åˆ˜å¤‡ çš„ç§èŠæ¶ˆæ¯:
   å¯ä»¥çš„ï¼Œä¸‰å¼Ÿï¼Œå«ä¸Šå…³ç¾½


```

step5:å®¢æˆ·ç«¯2

```bash
(.venv) PS C:\Users\wangrusheng\PycharmProjects\FastAPIProject> python client.py
è¯·è¾“å…¥ç”¨æˆ·å: åˆ˜å¤‡

è¾“å…¥æ¶ˆæ¯ï¼ˆæ ¼å¼è¯´æ˜ï¼‰:
1. ç¾¤å‘æ¶ˆæ¯ â†’ ç›´æ¥è¾“å…¥å†…å®¹
2. ç§èŠæ¶ˆæ¯ â†’ @ç”¨æˆ·ID æ¶ˆæ¯å†…å®¹
3. é€€å‡º â†’ è¾“å…¥ exit
è¯·è¾“å…¥: 
==================================================
ğŸ“‹ åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼ˆID | ç”¨æˆ·åï¼‰
--------------------------------------------------
  bf0c711b | å¼ é£
  4be9b4df | åˆ˜å¤‡
==================================================


âš ï¸ [2025-03-14 05:05:47] ç³»ç»Ÿé€šçŸ¥:
   åˆ˜å¤‡ è¿›å…¥èŠå¤©å®¤
hello

è¾“å…¥æ¶ˆæ¯ï¼ˆæ ¼å¼è¯´æ˜ï¼‰:
1. ç¾¤å‘æ¶ˆæ¯ â†’ ç›´æ¥è¾“å…¥å†…å®¹
2. ç§èŠæ¶ˆæ¯ â†’ @ç”¨æˆ·ID æ¶ˆæ¯å†…å®¹
3. é€€å‡º â†’ è¾“å…¥ exit
è¯·è¾“å…¥:
ğŸ“¢ [2025-03-14 05:05:57] å…¬å…±æ¶ˆæ¯ åˆ˜å¤‡:
   hello

ğŸ“¢ [2025-03-14 05:06:12] å…¬å…±æ¶ˆæ¯ å¼ é£:
   ä»Šå¤©å¤©æ°”ä¸é”™
æ˜¯çš„ï¼Œé€‚åˆéƒŠæ¸¸

è¾“å…¥æ¶ˆæ¯ï¼ˆæ ¼å¼è¯´æ˜ï¼‰:
1. ç¾¤å‘æ¶ˆæ¯ â†’ ç›´æ¥è¾“å…¥å†…å®¹
2. ç§èŠæ¶ˆæ¯ â†’ @ç”¨æˆ·ID æ¶ˆæ¯å†…å®¹
3. é€€å‡º â†’ è¾“å…¥ exit
è¯·è¾“å…¥:
ğŸ“¢ [2025-03-14 05:06:20] å…¬å…±æ¶ˆæ¯ åˆ˜å¤‡:
   æ˜¯çš„ï¼Œé€‚åˆéƒŠæ¸¸

ğŸ”’ [2025-03-14 05:06:48] æ¥è‡ª å¼ é£ çš„ç§èŠæ¶ˆæ¯:
   å¤§å“¥ï¼Œè¦ä¸ï¼Œä»Šå¤©å»èšé¤å§
@bf0c711b å¯ä»¥çš„ï¼Œä¸‰å¼Ÿï¼Œå«ä¸Šå…³ç¾½

è¾“å…¥æ¶ˆæ¯ï¼ˆæ ¼å¼è¯´æ˜ï¼‰:
1. ç¾¤å‘æ¶ˆæ¯ â†’ ç›´æ¥è¾“å…¥å†…å®¹
2. ç§èŠæ¶ˆæ¯ â†’ @ç”¨æˆ·ID æ¶ˆæ¯å†…å®¹
3. é€€å‡º â†’ è¾“å…¥ exit
è¯·è¾“å…¥:
ğŸ”’ [2025-03-14 05:07:09] æ¥è‡ª åˆ˜å¤‡ çš„ç§èŠæ¶ˆæ¯:
   å¯ä»¥çš„ï¼Œä¸‰å¼Ÿï¼Œå«ä¸Šå…³ç¾½



```

step6:å¥½äº†ï¼Œåç«¯éƒ¨åˆ†å†™å®Œäº†ï¼ŒéªŒè¯æˆåŠŸï¼Œå¯ä»¥å±•ç°å½“å‰åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼Œå¹¶ä¸”å¯ä»¥ç¾¤èŠï¼Œå¯ä»¥ç§å‘ï¼Œæ¥ä¸‹æ¥å†™å‰ç«¯angular

step7:C:\Users\wangrusheng\WebstormProjects\untitled4\src\app\chat\chat.service.ts

```javascript
import { Injectable } from '@angular/core';
import { webSocket, WebSocketSubject } from 'rxjs/webSocket';
import { BehaviorSubject } from 'rxjs';

export interface ChatMessage {
  type: 'public' | 'private' | 'system';
  from?: string;
  to?: string;
  sender_name?: string;
  content: string;
  timestamp: string;
}

export interface User {
  client_id: string;
  username: string;
}

@Injectable({ providedIn: 'root' })
export class ChatService {
  private socket$!: WebSocketSubject<any>;
  private readonly WS_URL = 'ws://localhost:8000/ws';

  public messages$ = new BehaviorSubject<ChatMessage[]>([]);
  public users$ = new BehaviorSubject<User[]>([]);
  public currentUser: User | null = null;

  constructor() {
    this.connect();
  }

  private connect() {
    this.socket$ = webSocket({
      url: this.WS_URL,
      openObserver: {
        next: () => this.initializeConnection()
      },
      serializer: msg => JSON.stringify(msg),
      deserializer: e => JSON.parse(e.data)
    });

    this.socket$.subscribe({
      next: msg => this.handleMessage(msg),
      error: err => console.error('WS error:', err),
      complete: () => console.log('WS connection closed')
    });
  }

  private initializeConnection() {
    const username = prompt('è¯·è¾“å…¥ç”¨æˆ·å') || `ç”¨æˆ·${Date.now().toString().slice(-4)}`;
    this.currentUser = {
      client_id: '',
      username: username
    };
    this.socket$.next({ username });
  }

  private handleMessage(msg: any) {
    switch(msg.type) {
      case 'user_list':
        this.users$.next(msg.users);
        if (!this.currentUser?.client_id && msg.users.length) {
          this.currentUser!.client_id = msg.users.find((u: User) =>
            u.username === this.currentUser?.username)?.client_id;
        }
        break;

      case 'private':
      case 'public':
      case 'system':
        this.messages$.next([...this.messages$.value, msg]);
        break;
    }
  }

  sendMessage(content: string, recipient?: string) {
    if (recipient) {
      this.socket$.next({
        type: 'private',
        to: recipient,
        content
      });
    } else {
      this.socket$.next({
        content,
        type: 'public'
      });
    }
  }
}


```

step8:C:\Users\wangrusheng\WebstormProjects\untitled4\src\app\chat\chat.component.ts

```javascript
import { Component, OnDestroy } from '@angular/core';
import { ChatService, ChatMessage, User } from './chat.service';
import {FormControl, ReactiveFormsModule} from '@angular/forms';
import {AsyncPipe, DatePipe, NgForOf, NgIf} from '@angular/common';

@Component({
  selector: 'app-chat',
  template: `
    <div class="chat-container">
      <!-- ç”¨æˆ·åˆ—è¡¨ -->
      <div class="user-list">
        <div class="current-user">
          <h3>{{ chatService.currentUser?.username }}</h3>
          <small>ID: {{ chatService.currentUser?.client_id }}</small>
        </div>

        <div class="divider"></div>

        <div *ngFor="let user of chatService.users$ | async"
             class="user-item"
             [class.active]="selectedUser?.client_id === user.client_id"
             (click)="selectUser(user)">
          <div class="username">{{ user.username }}</div>
          <div class="client-id">ID: {{ user.client_id }}</div>
        </div>
      </div>

      <!-- èŠå¤©åŒºåŸŸ -->
      <div class="chat-area">
        <div class="messages">
          <div *ngFor="let msg of chatService.messages$ | async"
               class="message"
               [class.private]="msg.type === 'private'">

            <div class="message-header">
              <span class="sender">{{ msg.sender_name || 'ç³»ç»Ÿ' }}</span>
              <span class="time">{{ msg.timestamp | date:'HH:mm' }}</span>
            </div>

            <div class="content">{{ msg.content }}</div>

            <div *ngIf="msg.type === 'private'" class="private-label">
              {{ msg.from === chatService.currentUser?.client_id ? 'å‘é€ç»™' : 'æ¥è‡ª' }}
              {{ msg.from === chatService.currentUser?.client_id ? msg.to : msg.from }}
            </div>
          </div>
        </div>

        <div class="message-input">
          <input [formControl]="messageControl"
                 placeholder="è¾“å…¥æ¶ˆæ¯..."
                 (keyup.enter)="sendMessage()">
          <button (click)="sendMessage()">å‘é€</button>
        </div>
      </div>
    </div>
  `,
  imports: [
    NgForOf,
    AsyncPipe,
    DatePipe,
    ReactiveFormsModule,
    NgIf
  ],
  styleUrls: ['./chat.component.css']
})
export class ChatComponent {
  messageControl = new FormControl('');
  selectedUser: User | null = null;

  constructor(public chatService: ChatService) {}

  selectUser(user: User) {
    this.selectedUser = this.selectedUser?.client_id === user.client_id ? null : user;
  }

  sendMessage() {
    if (this.messageControl.value?.trim()) {
      this.chatService.sendMessage(
        this.messageControl.value,
        this.selectedUser?.client_id
      );
      this.messageControl.reset();
    }
  }
}


```

step9:C:\Users\wangrusheng\WebstormProjects\untitled4\src\app\chat\chat.component.css

```css
.chat-container {
  display: flex;
  height: 100vh;
  font-family: Arial, sans-serif;
}

.user-list {
  width: 280px;
  background: #2c3e50;
  color: white;
  padding: 20px;
  overflow-y: auto;
}

.current-user {
  padding: 15px;
  background: #34495e;
  border-radius: 8px;
  margin-bottom: 20px;
}

.current-user h3 {
  margin: 0 0 5px;
}

.user-item {
  padding: 12px;
  margin: 8px 0;
  background: #34495e;
  border-radius: 6px;
  cursor: pointer;
  transition: background 0.2s;
}

.user-item:hover {
  background: #3d566e;
}

.user-item.active {
  background: #3498db;
}

.client-id {
  font-size: 0.8em;
  color: #95a5a6;
}

.chat-area {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #ecf0f1;
}

.messages {
  flex: 1;
  padding: 20px;
  overflow-y: auto;
}

.message {
  background: white;
  padding: 15px;
  margin-bottom: 15px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.message.private {
  border-left: 4px solid #3498db;
}

.message-header {
  display: flex;
  justify-content: space-between;
  margin-bottom: 8px;
  font-size: 0.9em;
  color: #7f8c8d;
}

.private-label {
  font-size: 0.8em;
  color: #3498db;
  margin-top: 8px;
}

.message-input {
  padding: 20px;
  background: white;
  border-top: 1px solid #ddd;
  display: flex;
  gap: 10px;
}

.message-input input {
  flex: 1;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 25px;
  outline: none;
}

.message-input button {
  padding: 12px 25px;
  background: #3498db;
  color: white;
  border: none;
  border-radius: 25px;
  cursor: pointer;
  transition: background 0.2s;
}

.message-input button:hover {
  background: #2980b9;
}


```

end