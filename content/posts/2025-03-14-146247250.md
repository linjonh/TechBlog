---
layout: post
title: "fastapiangular实现Tcp在线聊天室功能"
date: 2025-03-14 05:17:07 +0800
description: "step6:好了，后端部分写完了，验证成功，可以展现当前在线用户列表，并且可以群聊，可以私发，接下来写前端angular。step4:然后开启两个控制台窗口，分别运行客户端程序 比如，客户端1。我计划用fastapi+angular，实现一个在线聊天室的功能，step3:好了，后端代码写完了，接下来是验证，首先运行服务端。3.所有在线的用户，必须实现群聊和单独聊天。2.用一个列表，显示当前所有在线的用户。1.必须有一个服务端和多个客户端。step5:客户端2。"
keywords: "fastapi+angular实现Tcp在线聊天室功能"
categories: ['Typescript']
tags: ['Tcp', 'Fastapi', 'Angular']
artid: "146247250"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146247250
    alt: "fastapiangular实现Tcp在线聊天室功能"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146247250
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146247250
cover: https://bing.ee123.net/img/rand?artid=146247250
image: https://bing.ee123.net/img/rand?artid=146247250
img: https://bing.ee123.net/img/rand?artid=146247250
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     fastapi+angular实现Tcp在线聊天室功能
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     说明：
     <br/>
     我计划用fastapi+angular，实现一个在线聊天室的功能，
     <br/>
     1.必须有一个服务端和多个客户端
     <br/>
     2.用一个列表，显示当前所有在线的用户
     <br/>
     3.所有在线的用户，必须实现群聊和单独聊天
     <br/>
     效果图：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a6cbd2bfb00a43408fd94726827f5a26.png#pic_center">
      <br/>
      新增安卓测试程序 C:\Users\wangrusheng\AndroidStudioProjects\MyApplication9\app\src\test\java\com\example\myapplication\MyFirstTest.kt
     </img>
    </p>
    <pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>myapplication</span>

<span class="token keyword">import</span> <span class="token namespace">kotlinx<span class="token punctuation">.</span>coroutines<span class="token punctuation">.</span></span><span class="token operator">*</span>
<span class="token keyword">import</span> <span class="token namespace">okhttp3<span class="token punctuation">.</span></span><span class="token operator">*</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token operator">*</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>gson<span class="token punctuation">.</span></span><span class="token class-name">Gson</span>

fun <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> runBlocking <span class="token punctuation">{<!-- --></span>
    val client <span class="token operator">=</span> <span class="token class-name">ChatTester</span><span class="token punctuation">(</span><span class="token string">"UserA"</span><span class="token punctuation">,</span> <span class="token string">"ws://127.0.0.1:8000/ws"</span><span class="token punctuation">)</span> <span class="token comment">// Android emulator local address</span>
    launch <span class="token punctuation">{<!-- --></span> client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>

    <span class="token comment">// Test operation sequence</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1500</span><span class="token punctuation">)</span> <span class="token comment">// Wait for connection establishment</span>
    client<span class="token punctuation">.</span><span class="token function">sendPublicMessage</span><span class="token punctuation">(</span><span class="token string">"Hello everyone, this is UserA"</span><span class="token punctuation">)</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span>
    client<span class="token punctuation">.</span><span class="token function">sendPrivateMessage</span><span class="token punctuation">(</span><span class="token string">"UserB"</span><span class="token punctuation">,</span> <span class="token string">"Hi B, this is a private message"</span><span class="token punctuation">)</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>

    client<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ChatTester</span><span class="token punctuation">(</span><span class="token keyword">private</span> val username<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token keyword">private</span> val wsUrl<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> val client <span class="token operator">=</span> <span class="token class-name">OkHttpClient<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">connectTimeout</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span> <span class="token comment">// Connection timeout[6](@ref)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">private</span> <span class="token keyword">var</span> webSocket<span class="token operator">:</span> <span class="token class-name">WebSocket</span><span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token keyword">private</span> val gson <span class="token operator">=</span> <span class="token class-name">Gson</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> val scope <span class="token operator">=</span> <span class="token class-name">CoroutineScope</span><span class="token punctuation">(</span><span class="token class-name">Dispatchers<span class="token punctuation">.</span>Default</span><span class="token punctuation">)</span>

    fun <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        val request <span class="token operator">=</span> <span class="token class-name">Request<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span>wsUrl<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        webSocket <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">newWebSocket</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> object <span class="token operator">:</span> <span class="token class-name">WebSocketListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            override fun <span class="token function">onOpen</span><span class="token punctuation">(</span>webSocket<span class="token operator">:</span> <span class="token class-name">WebSocket</span><span class="token punctuation">,</span> response<span class="token operator">:</span> <span class="token class-name">Response</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"[$username] Connection established"</span><span class="token punctuation">)</span>
                <span class="token function">sendInitMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            override fun <span class="token function">onMessage</span><span class="token punctuation">(</span>webSocket<span class="token operator">:</span> <span class="token class-name">WebSocket</span><span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">handleMessage</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            override fun <span class="token function">onClosed</span><span class="token punctuation">(</span>webSocket<span class="token operator">:</span> <span class="token class-name">WebSocket</span><span class="token punctuation">,</span> code<span class="token operator">:</span> <span class="token class-name">Int</span><span class="token punctuation">,</span> reason<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"[$username] Connection closed"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>

            override fun <span class="token function">onFailure</span><span class="token punctuation">(</span>webSocket<span class="token operator">:</span> <span class="token class-name">WebSocket</span><span class="token punctuation">,</span> t<span class="token operator">:</span> <span class="token class-name">Throwable</span><span class="token punctuation">,</span> response<span class="token operator">:</span> <span class="token class-name">Response</span><span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"[$username] Connection error: ${t.message}"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> fun <span class="token function">sendInitMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        val initMsg <span class="token operator">=</span> <span class="token function">mapOf</span><span class="token punctuation">(</span><span class="token string">"username"</span> <span class="token keyword">to</span> <span class="token namespace">username</span><span class="token punctuation">)</span>
        webSocket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>initMsg<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    fun <span class="token function">sendPublicMessage</span><span class="token punctuation">(</span>content<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        val message <span class="token operator">=</span> <span class="token function">mapOf</span><span class="token punctuation">(</span>
            <span class="token string">"type"</span> <span class="token keyword">to</span> <span class="token string">"public"</span><span class="token punctuation">,</span>
            <span class="token string">"content"</span> <span class="token keyword">to</span> <span class="token namespace">content</span>
        <span class="token punctuation">)</span>
        webSocket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"[$username] Sent public message: $content"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    fun <span class="token function">sendPrivateMessage</span><span class="token punctuation">(</span>targetUser<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span> content<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        val message <span class="token operator">=</span> <span class="token function">mapOf</span><span class="token punctuation">(</span>
            <span class="token string">"type"</span> <span class="token keyword">to</span> <span class="token string">"private"</span><span class="token punctuation">,</span>
            <span class="token string">"to"</span> <span class="token keyword">to</span> <span class="token namespace">targetUser</span><span class="token punctuation">,</span>
            <span class="token string">"content"</span> <span class="token keyword">to</span> <span class="token namespace">content</span>
        <span class="token punctuation">)</span>
        webSocket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>gson<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"[$username] Sent private to $targetUser: $content"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> fun <span class="token function">handleMessage</span><span class="token punctuation">(</span>json<span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        val data <span class="token operator">=</span> gson<span class="token punctuation">.</span><span class="token function">fromJson</span><span class="token punctuation">(</span>json<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
        when <span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"user_list"</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                val users <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">]</span> as <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>
                <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n[$username] Online users updated:"</span><span class="token punctuation">)</span>
                users<span class="token punctuation">.</span>forEach <span class="token punctuation">{<!-- --></span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"  ${it["</span>client_id<span class="token string">"]} - ${it["</span>username<span class="token string">"]}"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token string">"private"</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n[$username] Received private from ${data["</span>sender_name<span class="token string">"]}: ${data["</span>content<span class="token string">"]}"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token string">"public"</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n[$username] Received public message from ${data["</span>sender_name<span class="token string">"]}: ${data["</span>content<span class="token string">"]}"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token string">"system"</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"\n[$username] System notification: ${data["</span>content<span class="token string">"]}"</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    fun <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        webSocket<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token string">"Normal closure"</span><span class="token punctuation">)</span>
        client<span class="token punctuation">.</span>dispatcher<span class="token punctuation">.</span>executorService<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     step1:C:\Users\wag\PycharmProjects\FastAPIProject\main.py
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> fastapi <span class="token keyword">import</span> FastAPI<span class="token punctuation">,</span> WebSocket<span class="token punctuation">,</span> WebSocketDisconnect
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Dict
<span class="token keyword">import</span> uuid
<span class="token keyword">import</span> json
<span class="token keyword">import</span> datetime
<span class="token keyword">import</span> logging

<span class="token comment"># 配置日志</span>
logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>
logger <span class="token operator">=</span> logging<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span><span class="token string">"ChatServer"</span><span class="token punctuation">)</span>

app <span class="token operator">=</span> FastAPI<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">ConnectionManager</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>active_connections<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> <span class="token builtin">dict</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">connect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">,</span> client_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> username<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>client_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"websocket"</span><span class="token punctuation">:</span> websocket<span class="token punctuation">,</span>
            <span class="token string">"username"</span><span class="token punctuation">:</span> username
        <span class="token punctuation">}</span>
        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"用户 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>username<span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>client_id<span class="token punctuation">}</span></span><span class="token string">) 已连接"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> self<span class="token punctuation">.</span>_broadcast_user_list<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> self<span class="token punctuation">.</span>_send_system_message<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>username<span class="token punctuation">}</span></span><span class="token string"> 进入聊天室"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">disconnect</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> client_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> client_id <span class="token keyword">in</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">:</span>
            user <span class="token operator">=</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>client_id<span class="token punctuation">]</span>
            <span class="token keyword">del</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">[</span>client_id<span class="token punctuation">]</span>
            logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"用户 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>user<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>client_id<span class="token punctuation">}</span></span><span class="token string">) 已断开"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>_broadcast_user_list<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>_send_system_message<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>user<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> 已离开"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sender_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> data<span class="token punctuation">:</span> <span class="token builtin">dict</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"private"</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>_send_private_message<span class="token punctuation">(</span>
                sender_id<span class="token operator">=</span>sender_id<span class="token punctuation">,</span>
                recipient_id<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token string">"to"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                content<span class="token operator">=</span>data<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span>
            <span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> self<span class="token punctuation">.</span>_broadcast_message<span class="token punctuation">(</span>sender_id<span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_send_private_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sender_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> recipient_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sender <span class="token operator">=</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">.</span>get<span class="token punctuation">(</span>sender_id<span class="token punctuation">)</span>
        recipient <span class="token operator">=</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">.</span>get<span class="token punctuation">(</span>recipient_id<span class="token punctuation">)</span>

        <span class="token keyword">if</span> sender <span class="token keyword">and</span> recipient<span class="token punctuation">:</span>
            message <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"private"</span><span class="token punctuation">,</span>
                <span class="token string">"from"</span><span class="token punctuation">:</span> sender_id<span class="token punctuation">,</span>
                <span class="token string">"to"</span><span class="token punctuation">:</span> recipient_id<span class="token punctuation">,</span>
                <span class="token string">"sender_name"</span><span class="token punctuation">:</span> sender<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"content"</span><span class="token punctuation">:</span> content<span class="token punctuation">,</span>
                <span class="token string">"timestamp"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_current_time<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">await</span> recipient<span class="token punctuation">[</span><span class="token string">"websocket"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>send_text<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> sender<span class="token punctuation">[</span><span class="token string">"websocket"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>send_text<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 回显</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_broadcast_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sender_id<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        sender <span class="token operator">=</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">.</span>get<span class="token punctuation">(</span>sender_id<span class="token punctuation">)</span>
        <span class="token keyword">if</span> sender<span class="token punctuation">:</span>
            message <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"public"</span><span class="token punctuation">,</span>
                <span class="token string">"from"</span><span class="token punctuation">:</span> sender_id<span class="token punctuation">,</span>
                <span class="token string">"sender_name"</span><span class="token punctuation">:</span> sender<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                <span class="token string">"content"</span><span class="token punctuation">:</span> content<span class="token punctuation">,</span>
                <span class="token string">"timestamp"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_current_time<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> conn <span class="token keyword">in</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">await</span> conn<span class="token punctuation">[</span><span class="token string">"websocket"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>send_text<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_send_system_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> content<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        message <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"system"</span><span class="token punctuation">,</span>
            <span class="token string">"content"</span><span class="token punctuation">:</span> content<span class="token punctuation">,</span>
            <span class="token string">"timestamp"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>_current_time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> conn <span class="token keyword">in</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> conn<span class="token punctuation">[</span><span class="token string">"websocket"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>send_text<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">_broadcast_user_list</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        users <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">"client_id"</span><span class="token punctuation">:</span> cid<span class="token punctuation">,</span>
            <span class="token string">"username"</span><span class="token punctuation">:</span> info<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span> <span class="token keyword">for</span> cid<span class="token punctuation">,</span> info <span class="token keyword">in</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span>

        message <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"user_list"</span><span class="token punctuation">,</span>
            <span class="token string">"users"</span><span class="token punctuation">:</span> users
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> conn <span class="token keyword">in</span> self<span class="token punctuation">.</span>active_connections<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> conn<span class="token punctuation">[</span><span class="token string">"websocket"</span><span class="token punctuation">]</span><span class="token punctuation">.</span>send_text<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_current_time</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strftime<span class="token punctuation">(</span><span class="token string">"%Y-%m-%d %H:%M:%S"</span><span class="token punctuation">)</span>


manager <span class="token operator">=</span> ConnectionManager<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>websocket</span><span class="token punctuation">(</span><span class="token string">"/ws"</span><span class="token punctuation">)</span>
<span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">websocket_endpoint</span><span class="token punctuation">(</span>websocket<span class="token punctuation">:</span> WebSocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>
    client_id <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>uuid<span class="token punctuation">.</span>uuid4<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span>  <span class="token comment"># 生成8位短ID</span>

    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 接收初始化信息</span>
        init_data <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>receive_json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        username <span class="token operator">=</span> init_data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string-interpolation"><span class="token string">f"用户</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>client_id<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">await</span> manager<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>websocket<span class="token punctuation">,</span> client_id<span class="token punctuation">,</span> username<span class="token punctuation">)</span>

        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            data <span class="token operator">=</span> <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>receive_json<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">await</span> manager<span class="token punctuation">.</span>handle_message<span class="token punctuation">(</span>client_id<span class="token punctuation">,</span> data<span class="token punctuation">)</span>

    <span class="token keyword">except</span> json<span class="token punctuation">.</span>JSONDecodeError<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">"收到无效的JSON数据"</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> WebSocketDisconnect<span class="token punctuation">:</span>
        <span class="token keyword">await</span> manager<span class="token punctuation">.</span>disconnect<span class="token punctuation">(</span>client_id<span class="token punctuation">)</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        logger<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"连接异常: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">await</span> manager<span class="token punctuation">.</span>disconnect<span class="token punctuation">(</span>client_id<span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">import</span> uvicorn

    uvicorn<span class="token punctuation">.</span>run<span class="token punctuation">(</span>app<span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">8000</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     step2:C:\Users\wg\PycharmProjects\FastAPIProject\client.py
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> websockets
<span class="token keyword">import</span> asyncio
<span class="token keyword">import</span> json
<span class="token keyword">import</span> time


<span class="token keyword">class</span> <span class="token class-name">ChatClient</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token string">""</span>
        self<span class="token punctuation">.</span>client_id <span class="token operator">=</span> <span class="token string">""</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>username <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"请输入用户名: "</span><span class="token punctuation">)</span>
        <span class="token keyword">async</span> <span class="token keyword">with</span> websockets<span class="token punctuation">.</span>connect<span class="token punctuation">(</span><span class="token string">"ws://localhost:8000/ws"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> websocket<span class="token punctuation">:</span>
            <span class="token comment"># 发送初始化信息</span>
            <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"username"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>username<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token comment"># 消息接收任务</span>
            receive_task <span class="token operator">=</span> asyncio<span class="token punctuation">.</span>create_task<span class="token punctuation">(</span>self<span class="token punctuation">.</span>receive_handler<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span><span class="token punctuation">)</span>

            <span class="token keyword">try</span><span class="token punctuation">:</span>
                <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
                    <span class="token keyword">await</span> self<span class="token punctuation">.</span>input_handler<span class="token punctuation">(</span>websocket<span class="token punctuation">)</span>
            <span class="token keyword">except</span> <span class="token punctuation">(</span>asyncio<span class="token punctuation">.</span>CancelledError<span class="token punctuation">,</span> KeyboardInterrupt<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">pass</span>
            <span class="token keyword">finally</span><span class="token punctuation">:</span>
                receive_task<span class="token punctuation">.</span>cancel<span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">await</span> receive_task

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">receive_handler</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> websocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">async</span> <span class="token keyword">for</span> message <span class="token keyword">in</span> websocket<span class="token punctuation">:</span>
                data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>handle_message<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        <span class="token keyword">except</span> websockets<span class="token punctuation">.</span>ConnectionClosed<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n连接已断开"</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">handle_message</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span>
        msg_type <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"type"</span><span class="token punctuation">]</span>
        timestamp <span class="token operator">=</span> data<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"timestamp"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> msg_type <span class="token operator">==</span> <span class="token string">"user_list"</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n"</span> <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"📋 在线用户列表（ID | 用户名）"</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"-"</span> <span class="token operator">*</span> <span class="token number">50</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> user <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">"users"</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"  </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>user<span class="token punctuation">[</span><span class="token string">'client_id'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string"> | </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>user<span class="token punctuation">[</span><span class="token string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"="</span> <span class="token operator">*</span> <span class="token number">50</span> <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">)</span>

        <span class="token keyword">elif</span> msg_type <span class="token operator">==</span> <span class="token string">"private"</span><span class="token punctuation">:</span>
            sender <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"sender_name"</span><span class="token punctuation">]</span>
            content <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n🔒 [</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>timestamp<span class="token punctuation">}</span></span><span class="token string">] 来自 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>sender<span class="token punctuation">}</span></span><span class="token string"> 的私聊消息:"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>content<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">elif</span> msg_type <span class="token operator">==</span> <span class="token string">"public"</span><span class="token punctuation">:</span>
            sender <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"sender_name"</span><span class="token punctuation">]</span>
            content <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">"content"</span><span class="token punctuation">]</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n📢 [</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>timestamp<span class="token punctuation">}</span></span><span class="token string">] 公共消息 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>sender<span class="token punctuation">}</span></span><span class="token string">:"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>content<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

        <span class="token keyword">elif</span> msg_type <span class="token operator">==</span> <span class="token string">"system"</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"\n⚠️ [</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>timestamp<span class="token punctuation">}</span></span><span class="token string">] 系统通知:"</span></span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"   </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>data<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">input_handler</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> websocket<span class="token punctuation">)</span><span class="token punctuation">:</span>
        prompt <span class="token operator">=</span> <span class="token string">"\n输入消息（格式说明）:\n"</span> \
                 <span class="token string">"1. 群发消息 → 直接输入内容\n"</span> \
                 <span class="token string">"2. 私聊消息 → @用户ID 消息内容\n"</span> \
                 <span class="token string">"3. 退出 → 输入 exit\n"</span> \
                 <span class="token string">"请输入: "</span>

        cmd <span class="token operator">=</span> <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>get_event_loop<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>run_in_executor<span class="token punctuation">(</span><span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">,</span> prompt<span class="token punctuation">)</span>

        <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'exit'</span><span class="token punctuation">:</span>
            <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">raise</span> asyncio<span class="token punctuation">.</span>CancelledError

        <span class="token keyword">if</span> cmd<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">"@"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            parts <span class="token operator">=</span> cmd<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">" "</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>parts<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
                user_id<span class="token punctuation">,</span> content <span class="token operator">=</span> parts<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> parts<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
                message <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"private"</span><span class="token punctuation">,</span>
                    <span class="token string">"to"</span><span class="token punctuation">:</span> user_id<span class="token punctuation">,</span>
                    <span class="token string">"content"</span><span class="token punctuation">:</span> content
                <span class="token punctuation">}</span>
                <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"! 私聊格式错误，正确格式：@用户ID 消息内容"</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span>

        <span class="token comment"># 发送公共消息</span>
        <span class="token keyword">await</span> websocket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"public"</span><span class="token punctuation">,</span>
            <span class="token string">"content"</span><span class="token punctuation">:</span> cmd
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    client <span class="token operator">=</span> ChatClient<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        asyncio<span class="token punctuation">.</span>run<span class="token punctuation">(</span>client<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">except</span> KeyboardInterrupt<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n客户端已退出"</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     step3:好了，后端代码写完了，接下来是验证，首先运行服务端
    </p>
    <pre><code class="prism language-bash"><span class="token punctuation">(</span>.venv<span class="token punctuation">)</span> PS C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>wangrusheng<span class="token punctuation">\</span>PycharmProjects<span class="token punctuation">\</span>FastAPIProject<span class="token operator">&gt;</span> python main.py
INFO:     Started server process <span class="token punctuation">[</span><span class="token number">9720</span><span class="token punctuation">]</span>
INFO:     Waiting <span class="token keyword">for</span> application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000 <span class="token punctuation">(</span>Press CTRL+C to quit<span class="token punctuation">)</span>
INFO:     <span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span>, <span class="token number">51061</span><span class="token punctuation">)</span> - <span class="token string">"WebSocket /ws"</span> <span class="token punctuation">[</span>accepted<span class="token punctuation">]</span>
INFO:     connection <span class="token function">open</span>
INFO:ChatServer:用户 张飞<span class="token punctuation">(</span>bf0c711b<span class="token punctuation">)</span> 已连接
INFO:     <span class="token punctuation">(</span><span class="token string">'127.0.0.1'</span>, <span class="token number">51071</span><span class="token punctuation">)</span> - <span class="token string">"WebSocket /ws"</span> <span class="token punctuation">[</span>accepted<span class="token punctuation">]</span>
INFO:     connection <span class="token function">open</span>
INFO:ChatServer:用户 刘备<span class="token punctuation">(</span>4be9b4df<span class="token punctuation">)</span> 已连接


</code></pre>
    <p>
     step4:然后开启两个控制台窗口，分别运行客户端程序 比如，客户端1
    </p>
    <pre><code class="prism language-bash"><span class="token punctuation">(</span>.venv<span class="token punctuation">)</span> PS C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>wangrusheng<span class="token punctuation">\</span>PycharmProjects<span class="token punctuation">\</span>FastAPIProject<span class="token operator">&gt;</span> python client.py
请输入用户名: 张飞 

输入消息（格式说明）:
<span class="token number">1</span>. 群发消息 → 直接输入内容
<span class="token number">2</span>. 私聊消息 → @用户ID 消息内容
<span class="token number">3</span>. 退出 → 输入 <span class="token builtin class-name">exit</span>
请输入: 
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
📋 在线用户列表（ID <span class="token operator">|</span> 用户名）
--------------------------------------------------
  bf0c711b <span class="token operator">|</span> 张飞
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>


⚠️ <span class="token punctuation">[</span><span class="token number">2025</span>-03-14 05:05:40<span class="token punctuation">]</span> 系统通知:
   张飞 进入聊天室

<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
📋 在线用户列表（ID <span class="token operator">|</span> 用户名）
--------------------------------------------------
  bf0c711b <span class="token operator">|</span> 张飞
  4be9b4df <span class="token operator">|</span> 刘备
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>


⚠️ <span class="token punctuation">[</span><span class="token number">2025</span>-03-14 05:05:47<span class="token punctuation">]</span> 系统通知:
   刘备 进入聊天室

📢 <span class="token punctuation">[</span><span class="token number">2025</span>-03-14 05:05:57<span class="token punctuation">]</span> 公共消息 刘备:
   hello
今天天气不错

输入消息（格式说明）:
<span class="token number">1</span>. 群发消息 → 直接输入内容
<span class="token number">2</span>. 私聊消息 → @用户ID 消息内容
<span class="token number">3</span>. 退出 → 输入 <span class="token builtin class-name">exit</span>
请输入:
📢 <span class="token punctuation">[</span><span class="token number">2025</span>-03-14 05:06:12<span class="token punctuation">]</span> 公共消息 张飞:
   今天天气不错

📢 <span class="token punctuation">[</span><span class="token number">2025</span>-03-14 05:06:20<span class="token punctuation">]</span> 公共消息 刘备:
   是的，适合郊游
@4be9b4df 大哥，要不，今天去聚餐吧

输入消息（格式说明）:
<span class="token number">1</span>. 群发消息 → 直接输入内容
<span class="token number">2</span>. 私聊消息 → @用户ID 消息内容
<span class="token number">3</span>. 退出 → 输入 <span class="token builtin class-name">exit</span>
请输入:
🔒 <span class="token punctuation">[</span><span class="token number">2025</span>-03-14 05:06:48<span class="token punctuation">]</span> 来自 张飞 的私聊消息:
   大哥，要不，今天去聚餐吧

🔒 <span class="token punctuation">[</span><span class="token number">2025</span>-03-14 05:07:09<span class="token punctuation">]</span> 来自 刘备 的私聊消息:
   可以的，三弟，叫上关羽

</code></pre>
    <p>
     step5:客户端2
    </p>
    <pre><code class="prism language-bash"><span class="token punctuation">(</span>.venv<span class="token punctuation">)</span> PS C:<span class="token punctuation">\</span>Users<span class="token punctuation">\</span>wangrusheng<span class="token punctuation">\</span>PycharmProjects<span class="token punctuation">\</span>FastAPIProject<span class="token operator">&gt;</span> python client.py
请输入用户名: 刘备

输入消息（格式说明）:
<span class="token number">1</span>. 群发消息 → 直接输入内容
<span class="token number">2</span>. 私聊消息 → @用户ID 消息内容
<span class="token number">3</span>. 退出 → 输入 <span class="token builtin class-name">exit</span>
请输入: 
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
📋 在线用户列表（ID <span class="token operator">|</span> 用户名）
--------------------------------------------------
  bf0c711b <span class="token operator">|</span> 张飞
  4be9b4df <span class="token operator">|</span> 刘备
<span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>


⚠️ <span class="token punctuation">[</span><span class="token number">2025</span>-03-14 05:05:47<span class="token punctuation">]</span> 系统通知:
   刘备 进入聊天室
hello

输入消息（格式说明）:
<span class="token number">1</span>. 群发消息 → 直接输入内容
<span class="token number">2</span>. 私聊消息 → @用户ID 消息内容
<span class="token number">3</span>. 退出 → 输入 <span class="token builtin class-name">exit</span>
请输入:
📢 <span class="token punctuation">[</span><span class="token number">2025</span>-03-14 05:05:57<span class="token punctuation">]</span> 公共消息 刘备:
   hello

📢 <span class="token punctuation">[</span><span class="token number">2025</span>-03-14 05:06:12<span class="token punctuation">]</span> 公共消息 张飞:
   今天天气不错
是的，适合郊游

输入消息（格式说明）:
<span class="token number">1</span>. 群发消息 → 直接输入内容
<span class="token number">2</span>. 私聊消息 → @用户ID 消息内容
<span class="token number">3</span>. 退出 → 输入 <span class="token builtin class-name">exit</span>
请输入:
📢 <span class="token punctuation">[</span><span class="token number">2025</span>-03-14 05:06:20<span class="token punctuation">]</span> 公共消息 刘备:
   是的，适合郊游

🔒 <span class="token punctuation">[</span><span class="token number">2025</span>-03-14 05:06:48<span class="token punctuation">]</span> 来自 张飞 的私聊消息:
   大哥，要不，今天去聚餐吧
@bf0c711b 可以的，三弟，叫上关羽

输入消息（格式说明）:
<span class="token number">1</span>. 群发消息 → 直接输入内容
<span class="token number">2</span>. 私聊消息 → @用户ID 消息内容
<span class="token number">3</span>. 退出 → 输入 <span class="token builtin class-name">exit</span>
请输入:
🔒 <span class="token punctuation">[</span><span class="token number">2025</span>-03-14 05:07:09<span class="token punctuation">]</span> 来自 刘备 的私聊消息:
   可以的，三弟，叫上关羽


</code></pre>
    <p>
     step6:好了，后端部分写完了，验证成功，可以展现当前在线用户列表，并且可以群聊，可以私发，接下来写前端angular
    </p>
    <p>
     step7:C:\Users\wangrusheng\WebstormProjects\untitled4\src\app\chat\chat.service.ts
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> webSocket<span class="token punctuation">,</span> WebSocketSubject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs/webSocket'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> BehaviorSubject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'rxjs'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ChatMessage</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'public'</span> <span class="token operator">|</span> <span class="token string">'private'</span> <span class="token operator">|</span> <span class="token string">'system'</span><span class="token punctuation">;</span>
  from<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  to<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  sender_name<span class="token operator">?</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token literal-property property">content</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token literal-property property">timestamp</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">User</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">client_id</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
  <span class="token literal-property property">username</span><span class="token operator">:</span> string<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

@<span class="token function">Injectable</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">providedIn</span><span class="token operator">:</span> <span class="token string">'root'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ChatService</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> socket$<span class="token operator">!</span><span class="token operator">:</span> WebSocketSubject<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> readonly <span class="token constant">WS_URL</span> <span class="token operator">=</span> <span class="token string">'ws://localhost:8000/ws'</span><span class="token punctuation">;</span>

  <span class="token keyword">public</span> messages$ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BehaviorSubject</span><span class="token operator">&lt;</span>ChatMessage<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> users$ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BehaviorSubject</span><span class="token operator">&lt;</span>User<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">public</span> <span class="token literal-property property">currentUser</span><span class="token operator">:</span> User <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>socket$ <span class="token operator">=</span> <span class="token function">webSocket</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token constant">WS_URL</span><span class="token punctuation">,</span>
      <span class="token literal-property property">openObserver</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initializeConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token function-variable function">serializer</span><span class="token operator">:</span> <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">deserializer</span><span class="token operator">:</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>socket$<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token function-variable function">next</span><span class="token operator">:</span> <span class="token parameter">msg</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleMessage</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">error</span><span class="token operator">:</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'WS error:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function-variable function">complete</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'WS connection closed'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">initializeConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> username <span class="token operator">=</span> <span class="token function">prompt</span><span class="token punctuation">(</span><span class="token string">'请输入用户名'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">用户</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>currentUser <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">client_id</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      <span class="token literal-property property">username</span><span class="token operator">:</span> username
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>socket$<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> username <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">msg</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">case</span> <span class="token string">'user_list'</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>users$<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>currentUser<span class="token operator">?.</span>client_id <span class="token operator">&amp;&amp;</span> msg<span class="token punctuation">.</span>users<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>currentUser<span class="token operator">!</span><span class="token punctuation">.</span>client_id <span class="token operator">=</span> msg<span class="token punctuation">.</span>users<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">u</span><span class="token operator">:</span> User</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            u<span class="token punctuation">.</span>username <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currentUser<span class="token operator">?.</span>username<span class="token punctuation">)</span><span class="token operator">?.</span>client_id<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">'private'</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token string">'public'</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token string">'system'</span><span class="token operator">:</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messages$<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>messages$<span class="token punctuation">.</span>value<span class="token punctuation">,</span> msg<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">content</span><span class="token operator">:</span> string<span class="token punctuation">,</span> recipient<span class="token operator">?</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>recipient<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>socket$<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'private'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">to</span><span class="token operator">:</span> recipient<span class="token punctuation">,</span>
        content
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>socket$<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        content<span class="token punctuation">,</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'public'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     step8:C:\Users\wangrusheng\WebstormProjects\untitled4\src\app\chat\chat.component.ts
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> Component<span class="token punctuation">,</span> OnDestroy <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> ChatService<span class="token punctuation">,</span> ChatMessage<span class="token punctuation">,</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./chat.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>FormControl<span class="token punctuation">,</span> ReactiveFormsModule<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/forms'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>AsyncPipe<span class="token punctuation">,</span> DatePipe<span class="token punctuation">,</span> NgForOf<span class="token punctuation">,</span> NgIf<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@angular/common'</span><span class="token punctuation">;</span>

@<span class="token function">Component</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">selector</span><span class="token operator">:</span> <span class="token string">'app-chat'</span><span class="token punctuation">,</span>
  <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    &lt;div class="chat-container"&gt;
      &lt;!-- 用户列表 --&gt;
      &lt;div class="user-list"&gt;
        &lt;div class="current-user"&gt;
          &lt;h3&gt;{<!-- -->{ chatService.currentUser?.username }}&lt;/h3&gt;
          &lt;small&gt;ID: {<!-- -->{ chatService.currentUser?.client_id }}&lt;/small&gt;
        &lt;/div&gt;

        &lt;div class="divider"&gt;&lt;/div&gt;

        &lt;div *ngFor="let user of chatService.users$ | async"
             class="user-item"
             [class.active]="selectedUser?.client_id === user.client_id"
             (click)="selectUser(user)"&gt;
          &lt;div class="username"&gt;{<!-- -->{ user.username }}&lt;/div&gt;
          &lt;div class="client-id"&gt;ID: {<!-- -->{ user.client_id }}&lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;

      &lt;!-- 聊天区域 --&gt;
      &lt;div class="chat-area"&gt;
        &lt;div class="messages"&gt;
          &lt;div *ngFor="let msg of chatService.messages$ | async"
               class="message"
               [class.private]="msg.type === 'private'"&gt;

            &lt;div class="message-header"&gt;
              &lt;span class="sender"&gt;{<!-- -->{ msg.sender_name || '系统' }}&lt;/span&gt;
              &lt;span class="time"&gt;{<!-- -->{ msg.timestamp | date:'HH:mm' }}&lt;/span&gt;
            &lt;/div&gt;

            &lt;div class="content"&gt;{<!-- -->{ msg.content }}&lt;/div&gt;

            &lt;div *ngIf="msg.type === 'private'" class="private-label"&gt;
              {<!-- -->{ msg.from === chatService.currentUser?.client_id ? '发送给' : '来自' }}
              {<!-- -->{ msg.from === chatService.currentUser?.client_id ? msg.to : msg.from }}
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class="message-input"&gt;
          &lt;input [formControl]="messageControl"
                 placeholder="输入消息..."
                 (keyup.enter)="sendMessage()"&gt;
          &lt;button (click)="sendMessage()"&gt;发送&lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token literal-property property">imports</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    NgForOf<span class="token punctuation">,</span>
    AsyncPipe<span class="token punctuation">,</span>
    DatePipe<span class="token punctuation">,</span>
    ReactiveFormsModule<span class="token punctuation">,</span>
    NgIf
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token literal-property property">styleUrls</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'./chat.component.css'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ChatComponent</span> <span class="token punctuation">{<!-- --></span>
  messageControl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FormControl</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token literal-property property">selectedUser</span><span class="token operator">:</span> User <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token keyword">public</span> <span class="token literal-property property">chatService</span><span class="token operator">:</span> ChatService</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  <span class="token function">selectUser</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">user</span><span class="token operator">:</span> User</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>selectedUser <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>selectedUser<span class="token operator">?.</span>client_id <span class="token operator">===</span> user<span class="token punctuation">.</span>client_id <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> user<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageControl<span class="token punctuation">.</span>value<span class="token operator">?.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>chatService<span class="token punctuation">.</span><span class="token function">sendMessage</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>messageControl<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>selectedUser<span class="token operator">?.</span>client_id
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>messageControl<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     step9:C:\Users\wangrusheng\WebstormProjects\untitled4\src\app\chat\chat.component.css
    </p>
    <pre><code class="prism language-css"><span class="token selector">.chat-container</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100vh<span class="token punctuation">;</span>
  <span class="token property">font-family</span><span class="token punctuation">:</span> Arial<span class="token punctuation">,</span> sans-serif<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.user-list</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">width</span><span class="token punctuation">:</span> 280px<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #2c3e50<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
  <span class="token property">overflow-y</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.current-user</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #34495e<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.current-user h3</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">margin</span><span class="token punctuation">:</span> 0 0 5px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.user-item</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 12px<span class="token punctuation">;</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> 8px 0<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #34495e<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 6px<span class="token punctuation">;</span>
  <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>
  <span class="token property">transition</span><span class="token punctuation">:</span> background 0.2s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.user-item:hover</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">background</span><span class="token punctuation">:</span> #3d566e<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.user-item.active</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">background</span><span class="token punctuation">:</span> #3498db<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.client-id</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 0.8em<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #95a5a6<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.chat-area</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">flex</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  <span class="token property">flex-direction</span><span class="token punctuation">:</span> column<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #ecf0f1<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.messages</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">flex</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
  <span class="token property">overflow-y</span><span class="token punctuation">:</span> auto<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.message</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">background</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 15px<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>
  <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 2px 4px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0<span class="token punctuation">,</span>0.1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.message.private</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">border-left</span><span class="token punctuation">:</span> 4px solid #3498db<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.message-header</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  <span class="token property">justify-content</span><span class="token punctuation">:</span> space-between<span class="token punctuation">;</span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 0.9em<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #7f8c8d<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.private-label</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 0.8em<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #3498db<span class="token punctuation">;</span>
  <span class="token property">margin-top</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.message-input</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
  <span class="token property">border-top</span><span class="token punctuation">:</span> 1px solid #ddd<span class="token punctuation">;</span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  <span class="token property">gap</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.message-input input</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">flex</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 12px<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #ddd<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 25px<span class="token punctuation">;</span>
  <span class="token property">outline</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.message-input button</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 12px 25px<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #3498db<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 25px<span class="token punctuation">;</span>
  <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>
  <span class="token property">transition</span><span class="token punctuation">:</span> background 0.2s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.message-input button:hover</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">background</span><span class="token punctuation">:</span> #2980b9<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     end
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f6366383833332f:61727469636c652f64657461696c732f313436323437323530" class_="artid" style="display:none">
 </p>
</div>


