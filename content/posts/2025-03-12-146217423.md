---
layout: post
title: "springcloud-gateway通过数据库获取路由信息"
date: 2025-03-12 23:05:25 +0800
description: "/ JSON 字符串，如 [{\"name\":\"Path\", \"args\":{\"pattern\":\"/api/**\"}}]// JSON 字符串，如 [{\"name\":\"StripPrefix\", \"args\":{\"parts\":\"1\"}}]`uri` varchar(200) NOT NULL COMMENT '目标服务地址（如 lb://user-service）',`order` int(11) DEFAULT '0' COMMENT '路由优先级',return \"路由刷新成功\";"
keywords: "springcloud gateway通过数据库获取路由信息"
categories: ['Springcloud']
tags: ['数据库', 'Spring', 'Gateway', 'Cloud']
artid: "146217423"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146217423
    alt: "springcloud-gateway通过数据库获取路由信息"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146217423
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146217423
cover: https://bing.ee123.net/img/rand?artid=146217423
image: https://bing.ee123.net/img/rand?artid=146217423
img: https://bing.ee123.net/img/rand?artid=146217423
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     springcloud gateway通过数据库获取路由信息
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     在 Spring Cloud Gateway 中结合
     <strong>
      MyBatis
     </strong>
     动态从数据库加载路由配置，可以实现灵活的路由管理。以下是详细实现步骤：
    </p>
    <hr/>
    <h4>
     <strong>
      1. 数据库表设计
     </strong>
    </h4>
    <p>
     创建路由配置表
     <code>
      gateway_route
     </code>
     ：
    </p>
    <pre><code>CREATE TABLE `gateway_route` (
  `id` varchar(50) NOT NULL COMMENT '路由唯一标识',
  `uri` varchar(200) NOT NULL COMMENT '目标服务地址（如 lb://user-service）',
  `predicates` text COMMENT '路由断言（JSON 数组格式）',
  `filters` text COMMENT '路由过滤器（JSON 数组格式）',
  `order` int(11) DEFAULT '0' COMMENT '路由优先级',
  `enabled` tinyint(1) DEFAULT '1' COMMENT '是否启用',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;</code></pre>
    <pre><strong>路由配置字段说明</strong></pre>
    <table>
     <thead>
      <tr>
       <th>
        字段名
       </th>
       <th>
        值
       </th>
       <th>
        含义
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        <code>
         id
        </code>
       </td>
       <td>
        <code>
         user_route
        </code>
       </td>
       <td>
        路由的唯一标识符，用于区分不同路由规则
       </td>
      </tr>
      <tr>
       <td>
        <code>
         uri
        </code>
       </td>
       <td>
        <code>
         http://127.0.0.1:8081
        </code>
       </td>
       <td>
        目标服务地址，请求将被转发到此地址
       </td>
      </tr>
      <tr>
       <td>
        <code>
         predicates
        </code>
       </td>
       <td>
        <code>
         [{"name":"Path","args":{"pattern":"/test/**"}}]
        </code>
       </td>
       <td>
        路由断言规则，匹配请求路径
       </td>
      </tr>
      <tr>
       <td>
        <code>
         filters
        </code>
       </td>
       <td>
        <code>
         [{"name":"StripPrefix","args":{"parts":"1"}}]
        </code>
       </td>
       <td>
        路由过滤器，修改请求路径
       </td>
      </tr>
      <tr>
       <td>
        <code>
         order
        </code>
       </td>
       <td>
        <code>
         0
        </code>
       </td>
       <td>
        路由优先级（数值越小优先级越高）
       </td>
      </tr>
      <tr>
       <td>
        <code>
         enabled
        </code>
       </td>
       <td>
        <code>
         1
        </code>
       </td>
       <td>
        是否启用该路由（1-启用，0-禁用）
       </td>
      </tr>
     </tbody>
    </table>
    <p>
    </p>
    <p>
     示例数据：
    </p>
    <pre><code>INSERT INTO `gateway_route` 
VALUES ('user_route', 'lb://user-service', 
        '[{"name":"Path","args":{"pattern":"/api/users/**"}}]',
        '[{"name":"StripPrefix","args":{"parts":"1"}}]',
        0, 1);</code></pre>
    <pre></pre>
    <hr/>
    <h4>
     <strong>
      2. 添加依赖
     </strong>
    </h4>
    <p>
     在
     <code>
      pom.xml
     </code>
     中添加以下依赖：
    </p>
    <pre><code>&lt;!-- Spring Cloud Gateway --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- MyBatis 整合 Spring Boot --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
    &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
    &lt;version&gt;3.0.3&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- MySQL 驱动 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.mysql&lt;/groupId&gt;
    &lt;artifactId&gt;mysql-connector-j&lt;/artifactId&gt;
    &lt;scope&gt;runtime&lt;/scope&gt;
&lt;/dependency&gt;

&lt;!-- JSON 处理工具 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
    &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
    <hr/>
    <h4>
     <strong>
      3. 实体类与 Mapper
     </strong>
    </h4>
    <h5>
     <strong>
      实体类
      <code>
       GatewayRoute
      </code>
     </strong>
    </h5>
    <pre><code>public class GatewayRoute {
    private String id;
    private String uri;
    private String predicates;  // JSON 字符串，如 [{"name":"Path", "args":{"pattern":"/api/**"}}]
    private String filters;     // JSON 字符串，如 [{"name":"StripPrefix", "args":{"parts":"1"}}]
    private int order;
    private boolean enabled;
    // Getters &amp; Setters
}</code></pre>
    <pre></pre>
    <h5>
     <strong>
      Mapper 接口
     </strong>
    </h5>
    <pre><code>@Mapper
public interface RouteMapper {
    @Select("SELECT * FROM gateway_route WHERE enabled = 1")
    List&lt;GatewayRoute&gt; findAllEnabledRoutes();
}</code></pre>
    <hr/>
    <h4>
     <strong>
      4. 动态路由加载实现
     </strong>
    </h4>
    <h5>
     <strong>
      自定义路由仓库
     </strong>
    </h5>
    <pre><code>@Component
public class DbRouteDefinitionRepository implements RouteDefinitionLocator {
    private final RouteMapper routeMapper;
    private final ObjectMapper objectMapper;

    public DbRouteDefinitionRepository(RouteMapper routeMapper, ObjectMapper objectMapper) {
        this.routeMapper = routeMapper;
        this.objectMapper = objectMapper;
    }

    @Override
    public Flux&lt;RouteDefinition&gt; getRouteDefinitions() {
        List&lt;GatewayRoute&gt; routes = routeMapper.findAllEnabledRoutes();
        return Flux.fromIterable(routes)
                .map(this::convertToRouteDefinition);
    }

    private RouteDefinition convertToRouteDefinition(GatewayRoute route) {
        RouteDefinition definition = new RouteDefinition();
        definition.setId(route.getId());
        definition.setUri(URI.create(route.getUri()));
        definition.setOrder(route.getOrder());

        try {
            // 解析 Predicates
            List&lt;PredicateDefinition&gt; predicates = objectMapper.readValue(
                    route.getPredicates(),
                    new TypeReference&lt;List&lt;PredicateDefinition&gt;&gt;() {}
            );
            definition.setPredicates(predicates);

            // 解析 Filters
            List&lt;FilterDefinition&gt; filters = objectMapper.readValue(
                    route.getFilters(),
                    new TypeReference&lt;List&lt;FilterDefinition&gt;&gt;() {}
            );
            definition.setFilters(filters);
        } catch (JsonProcessingException e) {
            throw new RuntimeException("路由配置解析失败: " + route.getId(), e);
        }

        return definition;
    }
}</code></pre>
    <h4>
     <strong>
      5. 配置 MyBatis 和数据源
     </strong>
    </h4>
    <h5>
     <strong>
      <code>
       application.yml
      </code>
      配置
     </strong>
    </h5>
    <pre><code>spring:
  datasource:
    url: jdbc:mysql://localhost:3306/gateway_db?useSSL=false&amp;characterEncoding=utf8
    username: root
    password: 123456
    driver-class-name: com.mysql.cj.jdbc.Driver

# MyBatis 配置
mybatis:
  type-aliases-package: com.example.gateway.entity  # 实体类包路径
  configuration:
    map-underscore-to-camel-case: true  # 自动驼峰命名转换</code></pre>
    <h5>
     <strong>
      启动类添加 Mapper 扫描
     </strong>
    </h5>
    <pre><code>@SpringBootApplication
@MapperScan("com.example.gateway.mapper")  // 指定 Mapper 接口所在包
public class GatewayApplication {
    public static void main(String[] args) {
        SpringApplication.run(GatewayApplication.class, args);
    }
}</code></pre>
    <hr/>
    <h4>
     <strong>
      6. 动态路由刷新接口
     </strong>
    </h4>
    <p>
     添加一个触发路由刷新的接口：
    </p>
    <pre><code>@RestController
@RequestMapping("/gateway")
public class RouteRefreshController {
    private final ApplicationEventPublisher eventPublisher;

    public RouteRefreshController(ApplicationEventPublisher eventPublisher) {
        this.eventPublisher = eventPublisher;
    }

    @PostMapping("/refresh")
    public String refreshRoutes() {
        eventPublisher.publishEvent(new RefreshRoutesEvent(this));
        return "路由刷新成功";
    }
}</code></pre>
    <hr/>
    <h4>
     <strong>
      7. 测试验证
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        启动应用
       </strong>
       ：确保数据库连接正常且表数据存在。
      </p>
     </li>
     <li>
      <p>
       <strong>
        触发路由刷新
       </strong>
       ：
      </p>
      <pre><code>curl -X POST http://localhost:8080/gateway/refresh</code></pre>
      <p>
      </p>
     </li>
     <li>
      <p>
       <strong>
        验证路由转发
       </strong>
       ：
      </p>
      <pre><code>curl http://localhost:8080/api/users/1</code></pre>
      <p>
       请求应被转发到
       <code>
        user-service
       </code>
       服务。
      </p>
     </li>
    </ol>
    <pre><code>INSERT INTO gateway.gateway_route (id,uri,predicates,filters,`order`,enabled) VALUES
	 ('user_route','http://127.0.0.1:8081','[{"name":"Path","args":{"pattern":"/test/**"}}]','[{"name":"StripPrefix","args":{"parts":"1"}}]',0,1);
</code></pre>
    <p>
     我启动的是普通的springboot项目，端口是8081
    </p>
    <pre><code>@RestController
@RequestMapping("/test")
public class TestController {
    @GetMapping(value = "/echo/{string}")
    public String echo(@PathVariable String string) {
        return string;
    }
}</code></pre>
    <p>
    </p>
    <p>
     <img alt="" height="206" src="https://i-blog.csdnimg.cn/direct/04e7a29d3350430fac039481c698b967.png" width="669"/>
    </p>
    <p>
    </p>
    <hr/>
    <h4>
     <strong>
      8. 动态更新流程
     </strong>
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        修改数据库路由数据
       </strong>
       ：通过 SQL 或管理界面更新路由配置。
      </p>
     </li>
     <li>
      <p>
       <strong>
        调用刷新接口
       </strong>
       ：
      </p>
      <pre><code>curl -X POST http://localhost:8080/gateway/refresh</code></pre>
     </li>
     <li>
      <p>
       <strong>
        观察日志
       </strong>
       ：检查新路由是否加载成功。
      </p>
     </li>
    </ol>
    <hr/>
    <h4>
     <strong>
      常见问题与解决
     </strong>
    </h4>
    <h5>
     <strong>
      问题 1：MyBatis Mapper 未注入
     </strong>
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        错误信息
       </strong>
       ：
       <code>
        No qualifying bean of type 'com.example.gateway.mapper.RouteMapper'
       </code>
      </p>
     </li>
     <li>
      <p>
       <strong>
        解决
       </strong>
       ：
      </p>
      <ol>
       <li>
        <p>
         确认
         <code>
          @MapperScan
         </code>
         注解指定了正确的包路径。
        </p>
       </li>
       <li>
        <p>
         检查 Mapper 接口是否有
         <code>
          @Mapper
         </code>
         注解。
        </p>
       </li>
      </ol>
     </li>
    </ul>
    <h5>
     <strong>
      问题 2：JSON 解析失败
     </strong>
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        错误信息
       </strong>
       ：
       <code>
        路由配置解析失败
       </code>
      </p>
     </li>
     <li>
      <p>
       <strong>
        解决
       </strong>
       ：
      </p>
      <ol>
       <li>
        <p>
         检查数据库中的
         <code>
          predicates
         </code>
         和
         <code>
          filters
         </code>
         字段是否符合 JSON 格式。
        </p>
       </li>
       <li>
        <p>
         使用 JSON 校验工具验证字段内容。
        </p>
       </li>
      </ol>
     </li>
    </ul>
    <h5>
     <strong>
      问题 3：路由未生效
     </strong>
    </h5>
    <ul>
     <li>
      <p>
       <strong>
        排查步骤
       </strong>
       ：
      </p>
      <ol>
       <li>
        <p>
         确认数据库中的
         <code>
          enabled
         </code>
         字段为
         <code>
          1
         </code>
         。
        </p>
       </li>
       <li>
        <p>
         检查
         <code>
          uri
         </code>
         格式是否正确（如
         <code>
          lb://service-name
         </code>
         需确保服务发现已启用）。
        </p>
       </li>
      </ol>
     </li>
    </ul>
    <hr/>
    <h4>
     <strong>
      9. 扩展优化
     </strong>
    </h4>
    <h5>
     <strong>
      添加缓存
     </strong>
    </h5>
    <p>
     减少数据库频繁查询：
    </p>
    <pre><code>@Component
public class CachedRouteDefinitionRepository implements RouteDefinitionLocator {
    private final RouteDefinitionLocator delegate;
    private final Cache&lt;String, RouteDefinition&gt; cache = Caffeine.newBuilder()
            .expireAfterWrite(10, TimeUnit.MINUTES)
            .build();

    public CachedRouteDefinitionRepository(RouteDefinitionLocator delegate) {
        this.delegate = delegate;
    }

    @Override
    public Flux&lt;RouteDefinition&gt; getRouteDefinitions() {
        return delegate.getRouteDefinitions()
                .doOnNext(route -&gt; cache.put(route.getId(), route));
    }

    public RouteDefinition getRoute(String id) {
        return cache.getIfPresent(id);
    }
}</code></pre>
    <h5>
     <strong>
      集成服务发现
     </strong>
    </h5>
    <p>
     在
     <code>
      uri
     </code>
     中使用
     <code>
      lb://
     </code>
     格式时，确保已启用服务发现：
    </p>
    <pre><code>spring:
  cloud:
    discovery:
      enabled: true</code></pre>
    <hr/>
    <p>
     通过以上步骤，即可实现基于
     <strong>
      MyBatis
     </strong>
     的 Spring Cloud Gateway 动态路由管理，支持通过数据库灵活配置和实时更新路由规则。
    </p>
   </div>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f627870313332312f:61727469636c652f64657461696c732f313436323137343233" class_="artid" style="display:none">
 </p>
</div>


