---
layout: post
title: "djangovue3实现前后端大文件分片下载"
date: 2025-03-16 11:30:12 +0800
description: "django+vue3大文件分片下载"
keywords: "django+vue3实现前后端大文件分片下载"
categories: ['Django']
tags: ['Vue', 'Django']
artid: "146291716"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146291716
    alt: "djangovue3实现前后端大文件分片下载"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146291716
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146291716
cover: https://bing.ee123.net/img/rand?artid=146291716
image: https://bing.ee123.net/img/rand?artid=146291716
img: https://bing.ee123.net/img/rand?artid=146291716
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     django+vue3实现前后端大文件分片下载
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     效果：
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/425e6fbf6be941eaae587062f687eabf.gif#pic_center"/>
    </p>
    <p>
     大文件分片下载支持的功能：
    </p>
    <ul>
     <li>
      展示目标文件信息
     </li>
     <li>
      提高下载速度：通过并发请求多个块，可以更有效地利用网络带宽
     </li>
     <li>
      断点续传：支持暂停后从已下载部分继续，无需重新开始
     </li>
     <li>
      错误恢复：单个块下载失败只需重试该块，而不是整个文件
     </li>
     <li>
      更好的用户体验：实时显示下载进度、速度和预计剩余时间
     </li>
     <li>
      内存效率：通过分块下载和处理，减少了一次性内存占用
     </li>
    </ul>
    <h2>
     <a id="_14">
     </a>
     大文件分片下载
    </h2>
    <p>
     前端处理流程：
    </p>
    <div class="mermaid">
     <svg class="mermaid-svg" height="1277.84228515625" id="mermaid-svg-V9j0FHEGvQ9SYI5T" viewbox="0 0 741.5179443359375 1277.84228515625" width="741.5179443359375" xmlns="http://www.w3.org/2000/svg">
      <style>
       #mermaid-svg-V9j0FHEGvQ9SYI5T {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-V9j0FHEGvQ9SYI5T .error-icon{fill:#552222;}#mermaid-svg-V9j0FHEGvQ9SYI5T .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-V9j0FHEGvQ9SYI5T .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-V9j0FHEGvQ9SYI5T .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-V9j0FHEGvQ9SYI5T .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-V9j0FHEGvQ9SYI5T .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-V9j0FHEGvQ9SYI5T .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-V9j0FHEGvQ9SYI5T .marker{fill:#333333;stroke:#333333;}#mermaid-svg-V9j0FHEGvQ9SYI5T .marker.cross{stroke:#333333;}#mermaid-svg-V9j0FHEGvQ9SYI5T svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-V9j0FHEGvQ9SYI5T .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-V9j0FHEGvQ9SYI5T .cluster-label text{fill:#333;}#mermaid-svg-V9j0FHEGvQ9SYI5T .cluster-label span{color:#333;}#mermaid-svg-V9j0FHEGvQ9SYI5T .label text,#mermaid-svg-V9j0FHEGvQ9SYI5T span{fill:#333;color:#333;}#mermaid-svg-V9j0FHEGvQ9SYI5T .node rect,#mermaid-svg-V9j0FHEGvQ9SYI5T .node circle,#mermaid-svg-V9j0FHEGvQ9SYI5T .node ellipse,#mermaid-svg-V9j0FHEGvQ9SYI5T .node polygon,#mermaid-svg-V9j0FHEGvQ9SYI5T .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-V9j0FHEGvQ9SYI5T .node .label{text-align:center;}#mermaid-svg-V9j0FHEGvQ9SYI5T .node.clickable{cursor:pointer;}#mermaid-svg-V9j0FHEGvQ9SYI5T .arrowheadPath{fill:#333333;}#mermaid-svg-V9j0FHEGvQ9SYI5T .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-V9j0FHEGvQ9SYI5T .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-V9j0FHEGvQ9SYI5T .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-V9j0FHEGvQ9SYI5T .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-V9j0FHEGvQ9SYI5T .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-V9j0FHEGvQ9SYI5T .cluster text{fill:#333;}#mermaid-svg-V9j0FHEGvQ9SYI5T .cluster span{color:#333;}#mermaid-svg-V9j0FHEGvQ9SYI5T div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-V9j0FHEGvQ9SYI5T :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
      </style>
      <g transform="translate(0, 0)">
       <marker class="marker flowchart" id="flowchart-pointEnd" markerheight="12" markerunits="userSpaceOnUse" markerwidth="12" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
        <path class="arrowMarkerPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
        </path>
       </marker>
       <marker class="marker flowchart" id="flowchart-pointStart" markerheight="12" markerunits="userSpaceOnUse" markerwidth="12" orient="auto" refx="0" refy="5" viewbox="0 0 10 10">
        <path class="arrowMarkerPath" d="M 0 5 L 10 10 L 10 0 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
        </path>
       </marker>
       <marker class="marker flowchart" id="flowchart-circleEnd" markerheight="11" markerunits="userSpaceOnUse" markerwidth="11" orient="auto" refx="11" refy="5" viewbox="0 0 10 10">
        <circle class="arrowMarkerPath" cx="5" cy="5" r="5" style="stroke-width: 1; stroke-dasharray: 1, 0;">
        </circle>
       </marker>
       <marker class="marker flowchart" id="flowchart-circleStart" markerheight="11" markerunits="userSpaceOnUse" markerwidth="11" orient="auto" refx="-1" refy="5" viewbox="0 0 10 10">
        <circle class="arrowMarkerPath" cx="5" cy="5" r="5" style="stroke-width: 1; stroke-dasharray: 1, 0;">
        </circle>
       </marker>
       <marker class="marker cross flowchart" id="flowchart-crossEnd" markerheight="11" markerunits="userSpaceOnUse" markerwidth="11" orient="auto" refx="12" refy="5.2" viewbox="0 0 11 11">
        <path class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9" style="stroke-width: 2; stroke-dasharray: 1, 0;">
        </path>
       </marker>
       <marker class="marker cross flowchart" id="flowchart-crossStart" markerheight="11" markerunits="userSpaceOnUse" markerwidth="11" orient="auto" refx="-1" refy="5.2" viewbox="0 0 11 11">
        <path class="arrowMarkerPath" d="M 1,1 l 9,9 M 10,1 l -9,9" style="stroke-width: 2; stroke-dasharray: 1, 0;">
        </path>
       </marker>
       <g class="root">
        <g class="clusters">
         <g class="cluster default" id="用户操作">
          <rect height="207.98639297485352" rx="0" ry="0" style="" width="551.0131072998047" x="182.50479125976562" y="300.9964714050293">
          </rect>
          <g class="cluster-label" transform="translate(426.0052947998047, 305.9964714050293)">
           <foreignobject height="25.995464324951172" width="64.01210021972656">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              用户操作
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
        <g class="edgePaths">
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-Start LE-FileInfo" d="M84.00050354003906,48.99546432495117L84.00050354003906,53.162130991617836C84.00050354003906,57.32879765828451,84.00050354003906,65.66213099161784,84.08383687337239,74.07879797617595C84.16717020670573,82.49546496073405,84.33383687337239,90.99546559651692,84.41717020670572,95.24546591440838L84.50050354003905,99.49546623229982" id="L-Start-FileInfo-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-FileInfo LE-Calculate" d="M84.50050354003905,251.49647331237796L84.41717020670572,255.57980632781985C84.33383687337239,259.6631393432617,84.16717020670573,267.8298053741455,84.08383687337239,276.0798050562541C84.00050354003906,284.3298047383626,84.00050354003906,292.663138071696,84.00050354003906,300.9964714050293C84.00050354003906,309.3298047383626,84.00050354003906,317.663138071696,84.00050354003906,321.8298047383626L84.00050354003906,325.9964714050293" id="L-FileInfo-Calculate-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-Calculate LE-InitChunks" d="M84.00050354003906,366.99193572998047L84.00050354003906,371.15860239664715C84.00050354003906,375.3252690633138,84.00050354003906,383.65860239664715,84.00050354003906,394.1582244237264C84.00050354003906,404.65784645080566,84.00050354003906,417.32375717163086,84.00050354003906,423.65671253204346L84.00050354003906,429.98966789245605" id="L-Calculate-InitChunks-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-InitChunks LE-Download" d="M84.00050354003906,470.9851322174072L84.00050354003906,477.3180875778198C84.00050354003906,483.6510429382324,84.00050354003906,496.3169536590576,84.00050354003906,506.8165756861369C84.00050354003906,517.3161977132162,84.00050354003906,525.6495310465494,120.04290596644084,535.5148575646682C156.08530839284262,545.380184082787,228.17011324564615,556.7775037856912,264.2125156720479,562.4761636371433L300.2549180984497,568.1748234885954" id="L-InitChunks-Download-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-Download LE-ChunkComplete" d="M301.049013050429,599.978328704834L279.2020078566604,606.3112840652466C257.35500266289176,612.6442394256592,213.6609922753546,625.3101501464844,191.89732041491934,640.7265659968058C170.13364855448404,656.1429818471273,170.30031522115073,674.3099028269451,170.38364855448407,683.393363316854L170.4669818878174,692.4768238067628" id="L-Download-ChunkComplete-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-ChunkComplete LE-NextChunk" d="M170.4669818878174,850.3498020172119L170.38364855448407,859.2665964762369C170.30031522115073,868.1833909352621,170.13364855448404,886.0169798533121,171.85851117837854,907.8510716756185C173.58337380227303,929.6851634979248,177.19976571672865,955.5197582244873,179.00796167395643,968.4370555877686L180.81615763118427,981.3543529510498" id="L-ChunkComplete-NextChunk-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-NextChunk LE-Download" d="M205.41783756606668,981.3543529510498L219.1131720890013,968.4370555877686C232.80850661193588,955.5197582244873,260.19917565780514,929.6851634979248,273.8945101807397,894.6116571426392C287.5898447036743,859.5381507873535,287.5898447036743,815.2257328033447,287.5898447036743,770.9133148193359C287.5898447036743,726.6008968353271,287.5898447036743,682.2884788513184,296.7025234300313,653.7993144989014C305.8152021563883,625.3101501464844,324.04055960910233,612.6442394256592,333.1532383354593,606.3112840652466L342.2659170618163,599.978328704834" id="L-NextChunk-Download-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-ChunkComplete LE-RetryLogic" d="M213.3008430616153,807.5159408434142L232.3657059782158,823.5717121647389C251.43056889481628,839.6274834860636,289.56029472801725,871.7390261287129,311.3116895543147,896.5251428100854C333.0630843806121,921.3112594914579,338.436148200006,938.7719502115538,341.12268010970297,947.5022955716016L343.8092120193999,956.2326409316495" id="L-ChunkComplete-RetryLogic-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-RetryLogic LE-Download" d="M369.02671290434546,953.6814618209714L370.8578638318276,945.37631297937C372.6890147593097,937.0711641377684,376.351316614274,920.4608664545653,378.1824675417561,889.9995086209595C380.0136184692383,859.5381507873535,380.0136184692383,815.2257328033447,380.0136184692383,770.9133148193359C380.0136184692383,726.6008968353271,380.0136184692383,682.2884788513184,379.12012594363847,653.7993144989014C378.2266334180387,625.3101501464844,376.4396483668392,612.6442394256592,375.5461558412394,606.3112840652466L374.65266331563964,599.978328704834" id="L-RetryLogic-Download-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-RetryLogic LE-Error" d="M357.6935539245605,1062.3558635711674L357.61022059122723,1068.6054865519209C357.52688725789386,1074.8551095326745,357.36022059122723,1087.3543554941814,357.27688725789386,1099.9369338353474C357.19355392456055,1112.5195121765137,357.19355392456055,1125.1854228973389,357.19355392456055,1131.5183782577515L357.19355392456055,1137.851333618164" id="L-RetryLogic-Error-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-Download LE-AllComplete" d="M423.5357921546189,599.978328704834L439.5321590060565,606.3112840652466C455.5285258574941,612.6442394256592,487.52125956036934,625.3101501464844,507.6760443957676,642.4242256838962C527.8308292311658,659.5383012213081,536.1476651990869,681.1005415753066,540.3060831830475,691.8816617523058L544.464501167008,702.6627819293051" id="L-Download-AllComplete-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-AllComplete LE-Download" d="M587.1718872212507,692.9921901845075L589.0024067679327,683.8228352983078C590.8329263146147,674.6534804121083,594.4939654079787,656.3147706397089,570.5097366674598,640.4754343665626C546.5255079269409,624.6360980934164,494.89601135253906,611.2961353195234,469.08126306533813,604.6261539325768L443.2665147781372,597.9561725456302" id="L-AllComplete-Download-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-AllComplete LE-MergeChunks" d="M570.6534919738767,866.3528308868413L570.5701586405435,872.6024538675947C570.4868253072101,878.8520768483482,570.3201586405436,891.3513228098553,570.2368253072103,910.51824315389C570.153491973877,929.6851634979248,570.153491973877,955.5197582244873,570.153491973877,968.4370555877686L570.153491973877,981.3543529510498" id="L-AllComplete-MergeChunks-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-MergeChunks LE-CreateFile" d="M570.153491973877,1022.349817276001L570.153491973877,1035.2671146392822C570.153491973877,1048.1844120025635,570.153491973877,1074.019006729126,570.153491973877,1093.2692594528198C570.153491973877,1112.5195121765137,570.153491973877,1125.1854228973389,570.153491973877,1131.5183782577515L570.153491973877,1137.851333618164" id="L-MergeChunks-CreateFile-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-CreateFile LE-End" d="M570.153491973877,1178.8467979431152L570.153491973877,1183.013464609782C570.153491973877,1187.1801312764485,570.153491973877,1195.513464609782,570.153491973877,1203.8467979431152C570.153491973877,1212.1801312764485,570.153491973877,1220.513464609782,570.153491973877,1224.6801312764485L570.153491973877,1228.8467979431152" id="L-CreateFile-End-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-Pause LE-PauseState" d="M273.00756454467773,366.99193572998047L273.00756454467773,371.15860239664715C273.00756454467773,375.3252690633138,273.00756454467773,383.65860239664715,273.00756454467773,391.99193572998047C273.00756454467773,400.3252690633138,273.00756454467773,408.65860239664715,273.00756454467773,412.8252690633138L273.00756454467773,416.99193572998047" id="L-Pause-PauseState-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-Resume LE-ResumeState" d="M458.01134490966797,366.99193572998047L458.01134490966797,371.15860239664715C458.01134490966797,375.3252690633138,458.01134490966797,383.65860239664715,458.01134490966797,394.1582244237264C458.01134490966797,404.65784645080566,458.01134490966797,417.32375717163086,458.01134490966797,423.65671253204346L458.01134490966797,429.98966789245605" id="L-Resume-ResumeState-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-solid flowchart-link LS-Cancel LE-CancelState" d="M643.0151252746582,366.99193572998047L643.0151252746582,371.15860239664715C643.0151252746582,375.3252690633138,643.0151252746582,383.65860239664715,643.0151252746582,391.99193572998047C643.0151252746582,400.3252690633138,643.0151252746582,408.65860239664715,643.0151252746582,412.8252690633138L643.0151252746582,416.99193572998047" id="L-Cancel-CancelState-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;">
         </path>
         <path class="edge-thickness-normal edge-pattern-dotted flowchart-link LS-PauseState LE-Download" d="M273.00756454467773,483.9828643798828L273.00756454467773,488.1495310465495C273.00756454467773,492.3161977132161,273.00756454467773,500.6495310465495,273.00756454467773,508.9828643798828C273.00756454467773,517.3161977132162,273.00756454467773,525.6495310465494,282.0513442380041,533.9828643798828C291.0951239313305,542.3161977132162,309.1826833179832,550.6495310465494,318.2264630113096,554.8161977132162L327.27024270463596,558.9828643798828" id="L-PauseState-Download-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;stroke-width:2px;stroke-dasharray:3;">
         </path>
         <path class="edge-thickness-normal edge-pattern-dotted flowchart-link LS-ResumeState LE-Download" d="M458.01134490966797,470.9851322174072L458.01134490966797,477.3180875778198C458.01134490966797,483.6510429382324,458.01134490966797,496.3169536590576,458.01134490966797,506.8165756861369C458.01134490966797,517.3161977132162,458.01134490966797,525.6495310465494,450.112542012254,533.9828643798828C442.21373911484005,542.3161977132162,426.4161333200121,550.6495310465494,418.51733042259815,554.8161977132162L410.6185275251841,558.9828643798828" id="L-ResumeState-Download-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;stroke-width:2px;stroke-dasharray:3;">
         </path>
         <path class="edge-thickness-normal edge-pattern-dotted flowchart-link LS-CancelState LE-Download" d="M643.0151252746582,483.9828643798828L643.0151252746582,488.1495310465495C643.0151252746582,492.3161977132161,643.0151252746582,500.6495310465495,643.0151252746582,508.9828643798828C643.0151252746582,517.3161977132162,643.0151252746582,525.6495310465494,609.7236901919047,535.400198368532C576.4322551091512,545.1508656905145,509.8493849436442,556.318867001146,476.5579498608907,561.9028676564618L443.2665147781372,567.4868683117777" id="L-CancelState-Download-0" marker-end="url(#flowchart-pointEnd)" style="fill:none;stroke-width:2px;stroke-dasharray:3;">
         </path>
        </g>
        <g class="edgeLabels">
         <g class="edgeLabel">
          <g class="label" transform="translate(0, 0)">
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel">
          <g class="label" transform="translate(0, 0)">
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel">
          <g class="label" transform="translate(0, 0)">
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel">
          <g class="label" transform="translate(0, 0)">
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel">
          <g class="label" transform="translate(0, 0)">
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" transform="translate(169.96698188781738, 903.8505687713623)">
          <g class="label" transform="translate(-8.00151252746582, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="16.00302505493164">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
              是
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel">
          <g class="label" transform="translate(0, 0)">
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" transform="translate(327.69002056121826, 903.8505687713623)">
          <g class="label" transform="translate(-8.00151252746582, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="16.00302505493164">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
              否
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" transform="translate(380.0136184692383, 770.9133148193359)">
          <g class="label" transform="translate(-60.20035171508789, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="120.40070343017578">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
              重试次数&lt;最大值
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" transform="translate(357.19355392456055, 1099.8536014556885)">
          <g class="label" transform="translate(-48.00277328491211, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="96.00554656982422">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
              达到最大重试
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel">
          <g class="label" transform="translate(0, 0)">
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" transform="translate(598.1550045013428, 637.9760608673096)">
          <g class="label" transform="translate(-8.00151252746582, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="16.00302505493164">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
              否
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" transform="translate(570.153491973877, 903.8505687713623)">
          <g class="label" transform="translate(-8.00151252746582, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="16.00302505493164">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
              是
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel">
          <g class="label" transform="translate(0, 0)">
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel">
          <g class="label" transform="translate(0, 0)">
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel">
          <g class="label" transform="translate(0, 0)">
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel">
          <g class="label" transform="translate(0, 0)">
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel">
          <g class="label" transform="translate(0, 0)">
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel">
          <g class="label" transform="translate(0, 0)">
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel">
          <g class="label" transform="translate(0, 0)">
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel">
          <g class="label" transform="translate(0, 0)">
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
        <g class="nodes">
         <g class="node default default" id="flowchart-PauseState-2801" transform="translate(273.00756454467773, 450.48740005493164)">
          <rect class="basic label-container" height="66.99092864990234" rx="0" ry="0" style="" width="111.00554656982422" x="-55.50277328491211" y="-33.49546432495117">
          </rect>
          <g class="label" style="" transform="translate(-48.00277328491211, -25.995464324951172)">
           <foreignobject height="51.990928649902344" width="96.00554656982422">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              取消当前请求
              <br/>
              保存下载状态
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-Pause-2800" transform="translate(273.00756454467773, 346.4942035675049)">
          <rect class="basic label-container" height="40.99546432495117" rx="0" ry="0" style="" width="79.01210021972656" x="-39.50605010986328" y="-20.497732162475586">
          </rect>
          <g class="label" style="" transform="translate(-32.00605010986328, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="64.01210021972656">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              暂停下载
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-ResumeState-2803" transform="translate(458.01134490966797, 450.48740005493164)">
          <rect class="basic label-container" height="40.99546432495117" rx="0" ry="0" style="" width="159.00201416015625" x="-79.50100708007812" y="-20.497732162475586">
          </rect>
          <g class="label" style="" transform="translate(-72.00100708007812, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="144.00201416015625">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              重新开始未完成分块
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-Resume-2802" transform="translate(458.01134490966797, 346.4942035675049)">
          <rect class="basic label-container" height="40.99546432495117" rx="0" ry="0" style="" width="79.01210021972656" x="-39.50605010986328" y="-20.497732162475586">
          </rect>
          <g class="label" style="" transform="translate(-32.00605010986328, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="64.01210021972656">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              恢复下载
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-CancelState-2805" transform="translate(643.0151252746582, 450.48740005493164)">
          <rect class="basic label-container" height="66.99092864990234" rx="0" ry="0" style="" width="111.00554656982422" x="-55.50277328491211" y="-33.49546432495117">
          </rect>
          <g class="label" style="" transform="translate(-48.00277328491211, -25.995464324951172)">
           <foreignobject height="51.990928649902344" width="96.00554656982422">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              取消所有请求
              <br/>
              重置所有状态
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-Cancel-2804" transform="translate(643.0151252746582, 346.4942035675049)">
          <rect class="basic label-container" height="40.99546432495117" rx="0" ry="0" style="" width="79.01210021972656" x="-39.50605010986328" y="-20.497732162475586">
          </rect>
          <g class="label" style="" transform="translate(-32.00605010986328, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="64.01210021972656">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              取消下载
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-Start-2770" transform="translate(84.00050354003906, 28.497732162475586)">
          <rect height="40.99546432495117" rx="20.497732162475586" ry="20.497732162475586" style="" width="57.254916191101074" x="-28.627458095550537" y="-20.497732162475586">
          </rect>
          <g class="label" style="" transform="translate(-16.00302505493164, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="32.00605010986328">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              开始
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-FileInfo-2771" transform="translate(84.00050354003906, 174.99596786499023)">
          <polygon class="label-container" points="76.0005054473877,0 152.0010108947754,-76.0005054473877 76.0005054473877,-152.0010108947754 0,-76.0005054473877" style="" transform="translate(-76.0005054473877,76.0005054473877)">
          </polygon>
          <g class="label" style="" transform="translate(-48.00277328491211, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="96.00554656982422">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              获取文件信息
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-Calculate-2773" transform="translate(84.00050354003906, 346.4942035675049)">
          <rect class="basic label-container" height="40.99546432495117" rx="0" ry="0" style="" width="111.00554656982422" x="-55.50277328491211" y="-20.497732162475586">
          </rect>
          <g class="label" style="" transform="translate(-48.00277328491211, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="96.00554656982422">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              计算总分块数
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-InitChunks-2775" transform="translate(84.00050354003906, 450.48740005493164)">
          <rect class="basic label-container" height="40.99546432495117" rx="0" ry="0" style="" width="127.0085678100586" x="-63.5042839050293" y="-20.497732162475586">
          </rect>
          <g class="label" style="" transform="translate(-56.0042839050293, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="112.0085678100586">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              初始化分块状态
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-Download-2777" transform="translate(371.76071643829346, 579.4805965423584)">
          <rect class="basic label-container" height="40.99546432495117" rx="0" ry="0" style="" width="143.0115966796875" x="-71.50579833984375" y="-20.497732162475586">
          </rect>
          <g class="label" style="" transform="translate(-64.00579833984375, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="128.0115966796875">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              并发下载多个分块
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-ChunkComplete-2779" transform="translate(169.96698188781738, 770.9133148193359)">
          <polygon class="label-container" points="78.93649101257324,0 157.87298202514648,-78.93649101257324 78.93649101257324,-157.87298202514648 0,-78.93649101257324" style="" transform="translate(-78.93649101257324,78.93649101257324)">
          </polygon>
          <g class="label" style="" transform="translate(-50.938758850097656, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="101.87751770019531">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              分块下载完成?
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-NextChunk-2781" transform="translate(183.68548202514648, 1001.8520851135254)">
          <rect class="basic label-container" height="40.99546432495117" rx="0" ry="0" style="" width="127.0085678100586" x="-63.5042839050293" y="-20.497732162475586">
          </rect>
          <g class="label" style="" transform="translate(-56.0042839050293, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="112.0085678100586">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              下载下一个分块
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-RetryLogic-2785" transform="translate(357.19355392456055, 1001.8520851135254)">
          <polygon class="label-container" points="60.00378227233887,0 120.00756454467773,-60.00378227233887 60.00378227233887,-120.00756454467773 0,-60.00378227233887" style="" transform="translate(-60.00378227233887,60.00378227233887)">
          </polygon>
          <g class="label" style="" transform="translate(-32.00605010986328, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="64.01210021972656">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              重试逻辑
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-Error-2789" transform="translate(357.19355392456055, 1158.3490657806396)">
          <rect class="basic label-container" height="40.99546432495117" rx="0" ry="0" style="" width="79.01210021972656" x="-39.50605010986328" y="-20.497732162475586">
          </rect>
          <g class="label" style="" transform="translate(-32.00605010986328, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="64.01210021972656">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              错误处理
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-AllComplete-2791" transform="translate(570.153491973877, 770.9133148193359)">
          <polygon class="label-container" points="94.93951988220215,0 189.8790397644043,-94.93951988220215 94.93951988220215,-189.8790397644043 0,-94.93951988220215" style="" transform="translate(-94.93951988220215,94.93951988220215)">
          </polygon>
          <g class="label" style="" transform="translate(-66.94178771972656, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="133.88357543945312">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              所有分块下载完成?
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-MergeChunks-2795" transform="translate(570.153491973877, 1001.8520851135254)">
          <rect class="basic label-container" height="40.99546432495117" rx="0" ry="0" style="" width="111.00554656982422" x="-55.50277328491211" y="-20.497732162475586">
          </rect>
          <g class="label" style="" transform="translate(-48.00277328491211, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="96.00554656982422">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              合并所有分块
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-CreateFile-2797" transform="translate(570.153491973877, 1158.3490657806396)">
          <rect class="basic label-container" height="40.99546432495117" rx="0" ry="0" style="" width="111.00554656982422" x="-55.50277328491211" y="-20.497732162475586">
          </rect>
          <g class="label" style="" transform="translate(-48.00277328491211, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="96.00554656982422">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              创建完整文件
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="node default default" id="flowchart-End-2799" transform="translate(570.153491973877, 1249.3445301055908)">
          <rect height="40.99546432495117" rx="20.497732162475586" ry="20.497732162475586" style="" width="57.254916191101074" x="-28.627458095550537" y="-20.497732162475586">
          </rect>
          <g class="label" style="" transform="translate(-16.00302505493164, -12.997732162475586)">
           <foreignobject height="25.995464324951172" width="32.00605010986328">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="nodeLabel">
              结束
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
       </g>
      </g>
     </svg>
    </div>
    <p>
     后端处理流程：
    </p>
    <div class="mermaid">
     <svg class="mermaid-svg" height="1429.82763671875" id="mermaid-svg-kaGXgYn398HzP0me" viewbox="0 0 640.5838623046875 1429.82763671875" width="640.5838623046875" xmlns="http://www.w3.org/2000/svg">
      <style>
       #mermaid-svg-kaGXgYn398HzP0me {font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#mermaid-svg-kaGXgYn398HzP0me .error-icon{fill:#552222;}#mermaid-svg-kaGXgYn398HzP0me .error-text{fill:#552222;stroke:#552222;}#mermaid-svg-kaGXgYn398HzP0me .edge-thickness-normal{stroke-width:2px;}#mermaid-svg-kaGXgYn398HzP0me .edge-thickness-thick{stroke-width:3.5px;}#mermaid-svg-kaGXgYn398HzP0me .edge-pattern-solid{stroke-dasharray:0;}#mermaid-svg-kaGXgYn398HzP0me .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-svg-kaGXgYn398HzP0me .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-svg-kaGXgYn398HzP0me .marker{fill:#333333;stroke:#333333;}#mermaid-svg-kaGXgYn398HzP0me .marker.cross{stroke:#333333;}#mermaid-svg-kaGXgYn398HzP0me svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#mermaid-svg-kaGXgYn398HzP0me .label{font-family:"trebuchet ms",verdana,arial,sans-serif;color:#333;}#mermaid-svg-kaGXgYn398HzP0me .cluster-label text{fill:#333;}#mermaid-svg-kaGXgYn398HzP0me .cluster-label span{color:#333;}#mermaid-svg-kaGXgYn398HzP0me .label text,#mermaid-svg-kaGXgYn398HzP0me span{fill:#333;color:#333;}#mermaid-svg-kaGXgYn398HzP0me .node rect,#mermaid-svg-kaGXgYn398HzP0me .node circle,#mermaid-svg-kaGXgYn398HzP0me .node ellipse,#mermaid-svg-kaGXgYn398HzP0me .node polygon,#mermaid-svg-kaGXgYn398HzP0me .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-svg-kaGXgYn398HzP0me .node .label{text-align:center;}#mermaid-svg-kaGXgYn398HzP0me .node.clickable{cursor:pointer;}#mermaid-svg-kaGXgYn398HzP0me .arrowheadPath{fill:#333333;}#mermaid-svg-kaGXgYn398HzP0me .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-svg-kaGXgYn398HzP0me .flowchart-link{stroke:#333333;fill:none;}#mermaid-svg-kaGXgYn398HzP0me .edgeLabel{background-color:#e8e8e8;text-align:center;}#mermaid-svg-kaGXgYn398HzP0me .edgeLabel rect{opacity:0.5;background-color:#e8e8e8;fill:#e8e8e8;}#mermaid-svg-kaGXgYn398HzP0me .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-svg-kaGXgYn398HzP0me .cluster text{fill:#333;}#mermaid-svg-kaGXgYn398HzP0me .cluster span{color:#333;}#mermaid-svg-kaGXgYn398HzP0me div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-svg-kaGXgYn398HzP0me :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}
      </style>
      <g>
       <g class="output">
        <g class="clusters">
         <g class="cluster" id="flowchart-后端-2877" style="opacity: 1;" transform="translate(167.6143503189087,836.4070110321045)">
          <rect height="1170.841236114502" width="319.2287006378174" x="-159.6143503189087" y="-585.420618057251">
          </rect>
          <g class="label" id="mermaid-svg-kaGXgYn398HzP0meText" transform="translate(0, -571.4205932617188)">
           <g transform="translate(-16.00302505493164,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="32.00605010986328">
             <div style="display: inline-block; white-space: nowrap;">
              后端
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="cluster" id="flowchart-前端-2878" style="opacity: 1;" transform="translate(489.90624618530273,558.420618057251)">
          <rect height="1100.841236114502" width="285.3550910949707" x="-142.67754554748535" y="-550.420618057251">
          </rect>
          <g class="label" id="mermaid-svg-kaGXgYn398HzP0meText" transform="translate(0, -536.4205932617188)">
           <g transform="translate(-16.00302505493164,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="32.00605010986328">
             <div style="display: inline-block; white-space: nowrap;">
              前端
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
        </g>
        <g class="edgePaths">
         <g class="edgePath LS-A LE-B" id="L-A-B" style="opacity: 1;">
          <path class="path" d="M463.934850692749,78.99546432495117L463.934850692749,83.16213099161784C463.934850692749,87.3287976582845,463.934850692749,95.66213099161784,463.934850692749,103.99546432495117C463.934850692749,112.3287976582845,463.934850692749,120.66213099161784,463.934850692749,124.8287976582845L463.934850692749,128.99546432495117" marker-end="url(#arrowhead4739)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead4739" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B LE-C" id="L-B-C" style="opacity: 1;">
          <path class="path" d="M472.8719727613512,174.99092864990234L475.33301521158745,181.32388401031494C477.7940576618236,187.65683937072754,482.71614256229606,200.32275009155273,485.17718501253233,212.98866081237793C487.63822746276855,225.65457153320312,487.63822746276855,238.32048225402832,487.63822746276855,252.65305964152017C487.63822746276855,266.985637029012,487.63822746276855,282.9848810831706,487.63822746276855,298.9841251373291C487.63822746276855,314.9833691914876,487.63822746276855,330.9826132456462,487.63822746276855,346.9818572998047C487.63822746276855,362.9811013539632,487.63822746276855,378.98034540812176,487.63822746276855,394.9795894622803C487.63822746276855,410.9788335164388,487.63822746276855,426.97807757059735,487.63822746276855,439.14436626434326C487.63822746276855,451.3106549580892,487.63822746276855,459.64398829142254,487.63822746276855,463.8106549580892L487.63822746276855,467.97732162475586" marker-end="url(#arrowhead4740)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead4740" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-C LE-D" id="L-C-D" style="opacity: 1;">
          <path class="path" d="M487.63822746276855,513.972785949707L487.63822746276855,518.1394526163737C487.63822746276855,522.3061192830404,487.63822746276855,530.6394526163737,487.63822746276855,538.972785949707C487.63822746276855,547.3061192830404,487.63822746276855,555.6394526163737,487.63822746276855,559.8061192830404L487.63822746276855,563.972785949707" marker-end="url(#arrowhead4741)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead4741" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-D LE-E" id="L-D-E" style="opacity: 1;">
          <path class="path" d="M487.63822746276855,609.9682502746582L487.63822746276855,614.1349169413248C487.63822746276855,618.3015836079916,487.63822746276855,626.6349169413248,487.63822746276855,634.9682502746582C487.63822746276855,643.3015836079916,487.63822746276855,651.6349169413248,487.63822746276855,655.8015836079916L487.63822746276855,659.9682502746582" marker-end="url(#arrowhead4742)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead4742" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-E LE-F" id="L-E-F" style="opacity: 1;">
          <path class="path" d="M481.9577314748464,705.9637145996094L480.3934760403383,712.296669960022C478.82922060583024,718.6296253204346,475.7007097368141,731.2955360412598,475.15149866377624,745.6240744371034C474.6022875907384,759.9526128329472,476.632376313679,775.9437789038096,477.64742067514925,783.9393619392407L478.66246503661955,791.9349449746719" marker-end="url(#arrowhead4743)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead4743" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-F LE-E" id="L-F-E" style="opacity: 1;">
          <path class="path" d="M512.8520404262023,807.1729882640317L516.7285405333404,796.6377313470406C520.6050406404785,786.1024744300494,528.3580408547546,765.0319605960672,527.2017706049584,748.1637483186636C526.0455003551621,731.2955360412598,515.9799596412935,718.6296253204346,510.9471892843591,712.296669960022L505.91441892742483,705.9637145996094" marker-end="url(#arrowhead4744)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead4744" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-F LE-G" id="L-F-G" style="opacity: 1;">
          <path class="path" d="M488.1382274627688,962.3503110885621L488.05489412943535,968.5999325116476C487.97156079610204,974.8495539347332,487.8048941294353,987.3487967809042,487.72156079610187,999.9313735644023C487.63822746276855,1012.5139503479004,487.63822746276855,1025.1798610687256,487.63822746276855,1031.5128164291382L487.63822746276855,1037.8457717895508" marker-end="url(#arrowhead4745)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead4745" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-H LE-I" id="L-H-I" style="opacity: 1;">
          <path class="path" d="M146.08341598510742,321.9818572998047L146.08341598510742,326.1485239664714C146.08341598510742,330.315190633138,146.08341598510742,338.6485239664714,146.08341598510742,346.9818572998047C146.08341598510742,355.315190633138,146.08341598510742,363.6485239664714,146.08341598510742,367.815190633138L146.08341598510742,371.9818572998047" marker-end="url(#arrowhead4746)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead4746" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-J LE-K" id="L-J-K" style="opacity: 1;">
          <path class="path" d="M139.16431427001953,894.9024753570557L139.16431427001953,912.3934027353922C139.16431427001953,929.8843301137289,139.16431427001953,964.866184870402,139.16431427001953,988.6900676091512C139.16431427001953,1012.5139503479004,139.16431427001953,1025.1798610687256,139.16431427001953,1031.5128164291382L139.16431427001953,1037.8457717895508" marker-end="url(#arrowhead4747)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead4747" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-K LE-L" id="L-K-L" style="opacity: 1;">
          <path class="path" d="M139.16431427001953,1083.841236114502L139.16431427001953,1088.0079027811687C139.16431427001953,1092.1745694478352,139.16431427001953,1100.5079027811687,139.16431427001953,1108.841236114502C139.16431427001953,1117.1745694478352,139.16431427001953,1125.5079027811687,139.16431427001953,1133.841236114502C139.16431427001953,1142.1745694478352,139.16431427001953,1150.5079027811687,139.16431427001953,1154.6745694478352L139.16431427001953,1158.841236114502" marker-end="url(#arrowhead4748)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead4748" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-L LE-M" id="L-L-M" style="opacity: 1;">
          <path class="path" d="M139.16431427001953,1204.8367004394531L139.16431427001953,1209.0033671061199C139.16431427001953,1213.1700337727864,139.16431427001953,1221.5033671061199,139.16431427001953,1229.8367004394531C139.16431427001953,1238.1700337727864,139.16431427001953,1246.5033671061199,139.16431427001953,1250.6700337727864L139.16431427001953,1254.8367004394531" marker-end="url(#arrowhead4749)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead4749" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-M LE-N" id="L-M-N" style="opacity: 1;">
          <path class="path" d="M139.16431427001953,1300.8321647644043L139.16431427001953,1304.998831431071C139.16431427001953,1309.1654980977376,139.16431427001953,1317.498831431071,142.90250031960855,1325.8321647644043C146.6406863691976,1334.1654980977376,154.1170584683757,1342.498831431071,157.8552445179647,1346.6654980977376L161.59343056755375,1350.8321647644043" marker-end="url(#arrowhead4750)" style="fill:none">
          </path>
          <defs>
           <marker id="arrowhead4750" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-B LE-H" id="L-B-H" style="opacity: 1;">
          <path class="path" d="M449.31723263622473,174.99092864990234L445.29193475148037,181.32388401031494C441.26663686673606,187.65683937072754,433.2160410972474,200.32275009155273,429.1907432125031,212.98866081237793C425.1654453277588,225.65457153320312,425.1654453277588,238.32048225402832,387.557604153951,251.1213964870385C349.94976298014325,263.9223107200487,274.73408063252765,276.85822846524394,237.12623945871988,283.32618733784153L199.5183982849121,289.7941462104391" marker-end="url(#arrowhead4751)" style="fill:none;stroke-width:2px;stroke-dasharray:3;">
          </path>
          <defs>
           <marker id="arrowhead4751" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-E LE-J" id="L-E-J" style="opacity: 1;">
          <path class="path" d="M464.0834873376421,705.9637145996094L457.5971470026616,712.296669960022C451.11080666768095,718.6296253204346,438.1381259977199,731.2955360412598,392.55301962389177,755.1194187800089C346.9679132500637,778.9433015187582,268.7703811723687,813.9251562754313,229.67161513352116,831.4160836537679L190.57284909467361,848.9070110321045" marker-end="url(#arrowhead4752)" style="fill:none;stroke-width:2px;stroke-dasharray:3;">
          </path>
          <defs>
           <marker id="arrowhead4752" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-I LE-C" id="L-I-C" style="opacity: 1;">
          <path class="path" d="M146.08341598510742,417.97732162475586L146.08341598510742,422.14398829142254C146.08341598510742,426.3106549580892,146.08341598510742,434.64398829142254,193.34208901723227,445.4517826902286C240.6007620493571,456.2595770890346,335.11810811360675,469.54183255331344,382.3767811457316,476.1829602854528L429.63545417785645,482.8240880175922" marker-end="url(#arrowhead4753)" style="fill:none;stroke-width:2px;stroke-dasharray:3;">
          </path>
          <defs>
           <marker id="arrowhead4753" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
         <g class="edgePath LS-N LE-E" id="L-N-E" style="opacity: 1;">
          <path class="path" d="M221.4873941401013,1350.8321647644043L228.60063377845356,1346.6654980977376C235.7138734168058,1342.498831431071,249.94035269351033,1334.1654980977376,257.0535923318626,1321.9992094039917C264.16683197021484,1309.8329207102458,264.16683197021484,1293.8336766560872,264.16683197021484,1277.8344326019287C264.16683197021484,1261.8351885477703,264.16683197021484,1245.8359444936116,264.16683197021484,1229.8367004394531C264.16683197021484,1213.8374563852947,264.16683197021484,1197.838212331136,264.16683197021484,1181.8389682769775C264.16683197021484,1165.839724222819,264.16683197021484,1149.8404801686604,322.23632526397705,1137.6741914749146C380.30581855773926,1125.5079027811687,496.4448051452637,1117.1745694478352,554.5142984390259,1105.0082807540894C612.5837917327881,1092.8419920603435,612.5837917327881,1076.8427480061848,612.5837917327881,1058.6772152582805C612.5837917327881,1040.511682510376,612.5837917327881,1020.1798610687256,612.5837917327881,988.6900676091512C612.5837917327881,957.2002741495768,612.5837917327881,914.5525086720785,612.5837917327881,871.9047431945801C612.5837917327881,829.2569777170817,612.5837917327881,786.6092122395834,599.611111062827,758.9523741404215C586.6384303928659,731.2955360412598,560.6930690529437,718.6296253204346,547.7203883829826,712.296669960022L534.7477077130214,705.9637145996094" marker-end="url(#arrowhead4754)" style="fill:none;stroke-width:2px;stroke-dasharray:3;">
          </path>
          <defs>
           <marker id="arrowhead4754" markerheight="6" markerunits="strokeWidth" markerwidth="8" orient="auto" refx="9" refy="5" viewbox="0 0 10 10">
            <path class="arrowheadPath" d="M 0 0 L 10 5 L 0 10 z" style="stroke-width: 1; stroke-dasharray: 1, 0;">
            </path>
           </marker>
          </defs>
         </g>
        </g>
        <g class="edgeLabels">
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-A' L-LE-B" id="L-L-A-B">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B' L-LE-C" id="L-L-B-C">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-C' L-LE-D" id="L-L-C-D">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-D' L-LE-E" id="L-L-D-E">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-E' L-LE-F" id="L-L-E-F">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(536.1110410690308,743.961446762085)">
          <g class="label" transform="translate(-7.999937057495117,-12.997732162475586)">
           <rect height="25.995464324951172" rx="0" ry="0" width="15.999874114990234">
           </rect>
           <foreignobject height="25.995464324951172" width="15.999874114990234">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-F' L-LE-E" id="L-L-F-E">
              否
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(487.63822746276855,999.8480396270752)">
          <g class="label" transform="translate(-7.999937057495117,-12.997732162475586)">
           <rect height="25.995464324951172" rx="0" ry="0" width="15.999874114990234">
           </rect>
           <foreignobject height="25.995464324951172" width="15.999874114990234">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-F' L-LE-G" id="L-L-F-G">
              是
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-H' L-LE-I" id="L-L-H-I">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-J' L-LE-K" id="L-L-J-K">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-K' L-LE-L" id="L-L-K-L">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-L' L-LE-M" id="L-L-L-M">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-M' L-LE-N" id="L-L-M-N">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(425.1654453277588,212.98866081237793)">
          <g class="label" transform="translate(-27.406753540039062,-12.997732162475586)">
           <rect height="25.995464324951172" rx="0" ry="0" width="54.813507080078125">
           </rect>
           <foreignobject height="25.995464324951172" width="54.813507080078125">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-B' L-LE-H" id="L-L-B-H">
              API调用
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="translate(425.1654453277588,743.961446762085)">
          <g class="label" transform="translate(-27.406753540039062,-12.997732162475586)">
           <rect height="25.995464324951172" rx="0" ry="0" width="54.813507080078125">
           </rect>
           <foreignobject height="25.995464324951172" width="54.813507080078125">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-E' L-LE-J" id="L-L-E-J">
              API调用
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-I' L-LE-C" id="L-L-I-C">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
         <g class="edgeLabel" style="opacity: 1;" transform="">
          <g class="label" transform="translate(0,0)">
           <rect height="0" rx="0" ry="0" width="0">
           </rect>
           <foreignobject height="0" width="0">
            <div style="display: inline-block; white-space: nowrap;">
             <span class="edgeLabel L-LS-N' L-LE-E" id="L-L-N-E">
             </span>
            </div>
           </foreignobject>
          </g>
         </g>
        </g>
        <g class="nodes">
         <g class="node default" id="flowchart-I-2860" style="opacity: 1;" transform="translate(146.08341598510742,394.9795894622803)">
          <rect class="label-container" height="45.99546432495117" rx="0" ry="0" width="132.0085678100586" x="-66.0042839050293" y="-22.997732162475586">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-56.0042839050293,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="112.0085678100586">
             <div style="display: inline-block; white-space: nowrap;">
              返回文件元数据
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-H-2859" style="opacity: 1;" transform="translate(146.08341598510742,298.9841251373291)">
          <rect class="label-container" height="45.99546432495117" rx="0" ry="0" width="106.86995697021484" x="-53.43497848510742" y="-22.997732162475586">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-43.43497848510742,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="86.86995697021484">
             <div style="display: inline-block; white-space: nowrap;">
              file_info API
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-K-2862" style="opacity: 1;" transform="translate(139.16431427001953,1060.8435039520264)">
          <rect class="label-container" height="45.99546432495117" rx="0" ry="0" width="111.22984313964844" x="-55.61492156982422" y="-22.997732162475586">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-45.61492156982422,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="91.22984313964844">
             <div style="display: inline-block; white-space: nowrap;">
              解析Range头
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-J-2861" style="opacity: 1;" transform="translate(139.16431427001953,871.9047431945801)">
          <rect class="label-container" height="45.99546432495117" rx="0" ry="0" width="192.32862854003906" x="-96.16431427001953" y="-22.997732162475586">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-86.16431427001953,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="172.32862854003906">
             <div style="display: inline-block; white-space: nowrap;">
              download_large_file API
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-L-2864" style="opacity: 1;" transform="translate(139.16431427001953,1181.8389682769775)">
          <rect class="label-container" height="45.99546432495117" rx="0" ry="0" width="116.00554656982422" x="-58.00277328491211" y="-22.997732162475586">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48.00277328491211,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="96.00554656982422">
             <div style="display: inline-block; white-space: nowrap;">
              定位文件指针
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-M-2866" style="opacity: 1;" transform="translate(139.16431427001953,1277.8344326019287)">
          <rect class="label-container" height="45.99546432495117" rx="0" ry="0" width="180.00503540039062" x="-90.00251770019531" y="-22.997732162475586">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-80.00251770019531,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="160.00503540039062">
             <div style="display: inline-block; white-space: nowrap;">
              流式读取响应字节范围
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-N-2868" style="opacity: 1;" transform="translate(182.22618293762207,1373.8298969268799)">
          <rect class="label-container" height="45.99546432495117" rx="0" ry="0" width="173.17539978027344" x="-86.58769989013672" y="-22.997732162475586">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-76.58769989013672,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="153.17539978027344">
             <div style="display: inline-block; white-space: nowrap;">
              返回206状态码和数据
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-B-2846" style="opacity: 1;" transform="translate(463.934850692749,151.99319648742676)">
          <rect class="label-container" height="45.99546432495117" rx="0" ry="0" width="116.00554656982422" x="-58.00277328491211" y="-22.997732162475586">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48.00277328491211,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="96.00554656982422">
             <div style="display: inline-block; white-space: nowrap;">
              获取文件信息
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-A-2845" style="opacity: 1;" transform="translate(463.934850692749,55.997732162475586)">
          <rect class="label-container" height="45.99546432495117" rx="0" ry="0" width="116.00554656982422" x="-58.00277328491211" y="-22.997732162475586">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48.00277328491211,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="96.00554656982422">
             <div style="display: inline-block; white-space: nowrap;">
              初始化下载器
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-C-2848" style="opacity: 1;" transform="translate(487.63822746276855,490.97505378723145)">
          <rect class="label-container" height="45.99546432495117" rx="0" ry="0" width="116.00554656982422" x="-58.00277328491211" y="-22.997732162475586">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-48.00277328491211,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="96.00554656982422">
             <div style="display: inline-block; white-space: nowrap;">
              计算分块策略
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-D-2850" style="opacity: 1;" transform="translate(487.63822746276855,586.9705181121826)">
          <rect class="label-container" height="45.99546432495117" rx="0" ry="0" width="148.0115966796875" x="-74.00579833984375" y="-22.997732162475586">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-64.00579833984375,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="128.0115966796875">
             <div style="display: inline-block; white-space: nowrap;">
              创建并发下载队列
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-E-2852" style="opacity: 1;" transform="translate(487.63822746276855,682.9659824371338)">
          <rect class="label-container" height="45.99546432495117" rx="0" ry="0" width="127.22026062011719" x="-63.610130310058594" y="-22.997732162475586">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-53.610130310058594,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="107.22026062011719">
             <div style="display: inline-block; white-space: nowrap;">
              发送Range请求
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-F-2854" style="opacity: 1;" transform="translate(487.63822746276855,871.9047431945801)">
          <polygon class="label-container" points="89.94556789398193,0 179.89113578796386,-89.94556789398193 89.94556789398193,-179.89113578796386 0,-89.94556789398193" transform="translate(-89.94556789398193,89.94556789398193)">
          </polygon>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-66.94178771972656,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="133.88357543945312">
             <div style="display: inline-block; white-space: nowrap;">
              所有分块下载完成?
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
         <g class="node default" id="flowchart-G-2858" style="opacity: 1;" transform="translate(487.63822746276855,1060.8435039520264)">
          <rect class="label-container" height="45.99546432495117" rx="0" ry="0" width="132.0085678100586" x="-66.0042839050293" y="-22.997732162475586">
          </rect>
          <g class="label" transform="translate(0,0)">
           <g transform="translate(-56.0042839050293,-12.997732162475586)">
            <foreignobject height="25.995464324951172" width="112.0085678100586">
             <div style="display: inline-block; white-space: nowrap;">
              合并分块并下载
             </div>
            </foreignobject>
           </g>
          </g>
         </g>
        </g>
       </g>
      </g>
     </svg>
    </div>
    <h2>
     <a id="django_75">
     </a>
     django代码
    </h2>
    <h3>
     <a id="1_76">
     </a>
     1，代码
    </h3>
    <pre><code class="prism language-python"><span class="token comment"># settings.py</span>
<span class="token comment"># 指定文件访问的 URL 前缀</span>
MEDIA_URL <span class="token operator">=</span> <span class="token string">'/media/'</span>
MEDIA_ROOT <span class="token operator">=</span> BASE_DIR <span class="token operator">/</span> <span class="token string">'media/'</span>




<span class="token comment"># views.py</span>
<span class="token keyword">import</span> os
<span class="token keyword">import</span> mimetypes
<span class="token keyword">from</span> django<span class="token punctuation">.</span>conf <span class="token keyword">import</span> settings
<span class="token keyword">from</span> django<span class="token punctuation">.</span>http <span class="token keyword">import</span> StreamingHttpResponse<span class="token punctuation">,</span> JsonResponse<span class="token punctuation">,</span> HttpResponse
<span class="token keyword">from</span> django<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>http <span class="token keyword">import</span> http_date
<span class="token keyword">from</span> django<span class="token punctuation">.</span>views<span class="token punctuation">.</span>decorators<span class="token punctuation">.</span>http <span class="token keyword">import</span> require_http_methods


<span class="token keyword">def</span> <span class="token function">get_file_info</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    获取文件信息：
    - name: 文件名
    - size: 文件大小，单位字节
    - type: 文件类型
    """</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token boolean">None</span>

    file_size <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getsize<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
    file_name <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
    content_type<span class="token punctuation">,</span> encoding <span class="token operator">=</span> mimetypes<span class="token punctuation">.</span>guess_type<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>

    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'name'</span><span class="token punctuation">:</span> file_name<span class="token punctuation">,</span>
        <span class="token string">'size'</span><span class="token punctuation">:</span> file_size<span class="token punctuation">,</span>
        <span class="token string">'type'</span><span class="token punctuation">:</span> content_type <span class="token keyword">or</span> <span class="token string">'application/octet-stream'</span>
    <span class="token punctuation">}</span>


<span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">file_info</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""获取文件信息API"""</span>
    file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>MEDIA_ROOT<span class="token punctuation">,</span> <span class="token string">"user_info_big.csv"</span><span class="token punctuation">)</span>
    info <span class="token operator">=</span> get_file_info<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>

    <span class="token keyword">if</span> info <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"File not found"</span><span class="token punctuation">}</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> JsonResponse<span class="token punctuation">(</span>info<span class="token punctuation">)</span>


<span class="token decorator annotation punctuation">@require_http_methods</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">"GET"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">download_large_file</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    分片下载文件的API
    :param request: 请求对象
    :return: 文件流
    """</span>
    file_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>settings<span class="token punctuation">.</span>MEDIA_ROOT<span class="token punctuation">,</span> <span class="token string">"user_info_big.csv"</span><span class="token punctuation">)</span>

    <span class="token comment"># 1，检查文件是否存在</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> HttpResponse<span class="token punctuation">(</span><span class="token string">"File not found"</span><span class="token punctuation">,</span> status<span class="token operator">=</span><span class="token number">404</span><span class="token punctuation">)</span>

    <span class="token comment"># 2，获取文件信息</span>
    file_size <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getsize<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
    file_name <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
    content_type<span class="token punctuation">,</span> encoding <span class="token operator">=</span> mimetypes<span class="token punctuation">.</span>guess_type<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span>
    content_type <span class="token operator">=</span> content_type <span class="token keyword">or</span> <span class="token string">'application/octet-stream'</span>

    <span class="token comment"># 3，获取请求中的Range头</span>
    range_header <span class="token operator">=</span> request<span class="token punctuation">.</span>META<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'HTTP_RANGE'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># 格式：bytes=0-100</span>
    range_match <span class="token operator">=</span> range_header<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'bytes='</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
    <span class="token comment"># 起始位置</span>
    range_start <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>range_match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> range_match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">else</span> <span class="token number">0</span>
    <span class="token comment"># 结束位置</span>
    range_end <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>range_match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> range_match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">else</span> file_size <span class="token operator">-</span> <span class="token number">1</span>

    <span class="token comment"># 4，确保范围合法</span>
    range_start <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> range_start<span class="token punctuation">)</span>
    range_end <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>file_size <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> range_end<span class="token punctuation">)</span>

    <span class="token comment"># 5，计算实际要发送的数据大小</span>
    content_length <span class="token operator">=</span> range_end <span class="token operator">-</span> range_start <span class="token operator">+</span> <span class="token number">1</span>

    <span class="token comment"># 6，创建响应：使用StreamingHttpResponse，将文件流式传输。206表示部分内容，200表示全部内容</span>
    response <span class="token operator">=</span> StreamingHttpResponse<span class="token punctuation">(</span>
        file_iterator<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> range_start<span class="token punctuation">,</span> range_end<span class="token punctuation">,</span> chunk_size<span class="token operator">=</span><span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        status<span class="token operator">=</span><span class="token number">206</span> <span class="token keyword">if</span> range_header <span class="token keyword">else</span> <span class="token number">200</span><span class="token punctuation">,</span>
        content_type<span class="token operator">=</span>content_type
    <span class="token punctuation">)</span>

    <span class="token comment"># 7，设置响应头</span>
    response<span class="token punctuation">[</span><span class="token string">'Content-Length'</span><span class="token punctuation">]</span> <span class="token operator">=</span> content_length
    response<span class="token punctuation">[</span><span class="token string">'Accept-Ranges'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'bytes'</span>
    response<span class="token punctuation">[</span><span class="token string">'Content-Disposition'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'attachment; filename="</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>file_name<span class="token punctuation">}</span></span><span class="token string">"'</span></span>

    <span class="token keyword">if</span> range_header<span class="token punctuation">:</span>
        response<span class="token punctuation">[</span><span class="token string">'Content-Range'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'bytes </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>range_start<span class="token punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>range_end<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>file_size<span class="token punctuation">}</span></span><span class="token string">'</span></span>

    response<span class="token punctuation">[</span><span class="token string">'Last-Modified'</span><span class="token punctuation">]</span> <span class="token operator">=</span> http_date<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>getmtime<span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 模拟处理延迟，方便测试暂停/继续功能</span>
    <span class="token comment"># time.sleep(0.1)  # 取消注释以添加人为延迟</span>

    <span class="token comment"># 8，返回响应</span>
    <span class="token keyword">return</span> response


<span class="token keyword">def</span> <span class="token function">file_iterator</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> start_byte<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> end_byte<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">,</span> chunk_size<span class="token operator">=</span><span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    文件读取迭代器
    :param file_path: 文件路径
    :param start_byte: 起始字节
    :param end_byte: 结束字节
    :param chunk_size: 块大小
    """</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        <span class="token comment"># 移动到起始位置</span>
        f<span class="token punctuation">.</span>seek<span class="token punctuation">(</span>start_byte<span class="token punctuation">)</span>

        <span class="token comment"># 计算剩余字节数</span>
        remaining <span class="token operator">=</span> end_byte <span class="token operator">-</span> start_byte <span class="token operator">+</span> <span class="token number">1</span> <span class="token keyword">if</span> end_byte <span class="token keyword">else</span> <span class="token boolean">None</span>

        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> remaining <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                <span class="token comment"># 如果指定了结束位置，则读取剩余字节或块大小，取小的那个</span>
                bytes_to_read <span class="token operator">=</span> <span class="token builtin">min</span><span class="token punctuation">(</span>chunk_size<span class="token punctuation">,</span> remaining<span class="token punctuation">)</span>
                <span class="token keyword">if</span> bytes_to_read <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">:</span>
                    <span class="token keyword">break</span>
            <span class="token keyword">else</span><span class="token punctuation">:</span>
                <span class="token comment"># 否则读取指定块大小</span>
                bytes_to_read <span class="token operator">=</span> chunk_size

            data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span>bytes_to_read<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> data<span class="token punctuation">:</span>
                <span class="token keyword">break</span>

            <span class="token keyword">yield</span> data

            <span class="token keyword">if</span> remaining <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
                remaining <span class="token operator">-=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>




<span class="token comment"># proj urls.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path<span class="token punctuation">,</span> include

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment"># 下载文件</span>
    path<span class="token punctuation">(</span><span class="token string">'download/'</span><span class="token punctuation">,</span> include<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'download.urls'</span><span class="token punctuation">,</span> <span class="token string">'download'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> namespace<span class="token operator">=</span><span class="token string">'download'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>





<span class="token comment"># download.urls.py</span>
<span class="token keyword">from</span> django<span class="token punctuation">.</span>urls <span class="token keyword">import</span> path

<span class="token keyword">from</span> download <span class="token keyword">import</span> views

urlpatterns <span class="token operator">=</span> <span class="token punctuation">[</span>
    path<span class="token punctuation">(</span><span class="token string">'large_file/file_info/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>file_info<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'file_info'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    path<span class="token punctuation">(</span><span class="token string">'large_file/download_large_file/'</span><span class="token punctuation">,</span> views<span class="token punctuation">.</span>download_large_file<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'download_large_file'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
</code></pre>
    <h3>
     <a id="2_247">
     </a>
     2，核心功能解析
    </h3>
    <h4>
     <a id="1file_info____248">
     </a>
     （1）file_info 端点 - 获取文件元数据
    </h4>
    <p>
     这个端点提供文件的基本信息，让前端能够规划下载策略：
    </p>
    <ul>
     <li>
      功能：返回文件名称、大小和MIME类型
     </li>
     <li>
      用途：前端根据文件大小和设置的块大小计算出需要下载的分块数量
     </li>
    </ul>
    <h4>
     <a id="2download_large_file____255">
     </a>
     （2）download_large_file 端点 - 实现分片下载
    </h4>
    <p>
     这是实现分片下载的核心API，通过HTTP Range请求实现：
     <br/>
     1，解析Range头：从HTTP_RANGE头部解析客户端请求的字节范围
    </p>
    <pre><code class="prism language-python">range_header <span class="token operator">=</span> request<span class="token punctuation">.</span>META<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'HTTP_RANGE'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span>
range_match <span class="token operator">=</span> range_header<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'bytes='</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'-'</span><span class="token punctuation">)</span>
range_start <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>range_match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> range_match<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">else</span> <span class="token number">0</span>
range_end <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>range_match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">if</span> range_match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">else</span> file_size <span class="token operator">-</span> <span class="token number">1</span>
</code></pre>
    <p>
     2，流式传输：使用StreamingHttpResponse和迭代器按块读取和传输文件，避免一次加载整个文件到内存
    </p>
    <pre><code class="prism language-python">response <span class="token operator">=</span> StreamingHttpResponse<span class="token punctuation">(</span>
    file_iterator<span class="token punctuation">(</span>file_path<span class="token punctuation">,</span> range_start<span class="token punctuation">,</span> range_end<span class="token punctuation">,</span> chunk_size<span class="token operator">=</span><span class="token number">8192</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    status<span class="token operator">=</span><span class="token number">206</span> <span class="token keyword">if</span> range_header <span class="token keyword">else</span> <span class="token number">200</span><span class="token punctuation">,</span>
    content_type<span class="token operator">=</span>content_type
<span class="token punctuation">)</span>
</code></pre>
    <p>
     3，返回响应头：设置必要的响应头，包括Content-Range指示返回内容的范围
    </p>
    <pre><code class="prism language-python">response<span class="token punctuation">[</span><span class="token string">'Content-Range'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'bytes </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>range_start<span class="token punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>range_end<span class="token punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>file_size<span class="token punctuation">}</span></span><span class="token string">'</span></span>
</code></pre>
    <h4>
     <a id="3file_iterator____280">
     </a>
     （3）file_iterator 函数 - 高效的文件读取
    </h4>
    <p>
     这个函数创建一个迭代器，高效地读取文件的指定部分：
    </p>
    <p>
     1，文件定位：将文件指针移动到请求的起始位置
    </p>
    <pre><code class="prism language-python">f<span class="token punctuation">.</span>seek<span class="token punctuation">(</span>start_byte<span class="token punctuation">)</span>
</code></pre>
    <p>
     2，分块读取：按指定的块大小读取文件，避免一次性读取大量数据
    </p>
    <pre><code class="prism language-python">data <span class="token operator">=</span> f<span class="token punctuation">.</span>read<span class="token punctuation">(</span>bytes_to_read<span class="token punctuation">)</span>
</code></pre>
    <p>
     3，边界控制：确保只读取请求范围内的数据
    </p>
    <pre><code class="prism language-python">remaining <span class="token operator">-=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="HTTP_301">
     </a>
     HTTP状态码和响应头的作用
    </h4>
    <p>
     1，206 Partial Content：
    </p>
    <ul>
     <li>
      表示服务器成功处理了部分GET请求
     </li>
     <li>
      分片下载的标准HTTP状态码
     </li>
    </ul>
    <p>
     2，Content-Range: bytes start-end/total：
    </p>
    <ul>
     <li>
      指示响应中包含的字节范围和文件总大小
     </li>
     <li>
      帮助客户端确认接收的是哪部分数据
     </li>
    </ul>
    <p>
     3，Accept-Ranges: bytes：
    </p>
    <ul>
     <li>
      表明服务器支持范围请求
     </li>
     <li>
      让客户端知道可以使用Range头请求部分内容
     </li>
    </ul>
    <p>
     4，Content-Length：
    </p>
    <ul>
     <li>
      表示当前响应内容的长度
     </li>
     <li>
      不是文件总长度，而是本次返回的片段长度
     </li>
    </ul>
    <h2>
     <a id="vue3_323">
     </a>
     vue3代码
    </h2>
    <h3>
     <a id="1_328">
     </a>
     1，代码
    </h3>
    <p>
     1，前端界面 (Vue组件):
    </p>
    <ul>
     <li>
      提供配置选项：并发块数、块大小
     </li>
     <li>
      显示下载进度：进度条、已下载量、下载速度、剩余时间提供操作按钮：开始、暂停、继续、取消
     </li>
     <li>
      可视化显示每个分块的下载状态
     </li>
    </ul>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>enhanced-downloader<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>card<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>大文件分块下载<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>file-info<span class="token punctuation">"</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>fileInfo<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>文件名:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span> {<!-- -->{ fileInfo.name }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>文件大小:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span> {<!-- -->{ formatFileSize(fileInfo.size) }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>strong</span><span class="token punctuation">&gt;</span></span>类型:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>strong</span><span class="token punctuation">&gt;</span></span> {<!-- -->{ fileInfo.type }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>config-panel<span class="token punctuation">"</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>!isDownloading &amp;&amp; !isPaused<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>config-item<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>并发块数:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>concurrency<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>8<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>config-item<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">&gt;</span></span>块大小:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">v-model</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>chunkSize<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>512 * 1024<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>512 KB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1024 * 1024<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>1 MB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2 * 1024 * 1024<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>2 MB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">:value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5 * 1024 * 1024<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>5 MB<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>progress-container<span class="token punctuation">"</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>isDownloading || isPaused<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>progress-bar<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>progress<span class="token punctuation">"</span></span> <span class="token attr-name">:style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{ width: `${progress}%` }<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>progress-stats<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stat-item<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>label<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>进度:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>value<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{<!-- -->{ progress.toFixed(2) }}%<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stat-item<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>label<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>已下载:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>value<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{<!-- -->{ formatFileSize(downloadedBytes) }} / {<!-- -->{ formatFileSize(totalBytes) }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stat-item<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>label<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>速度:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>value<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{<!-- -->{ downloadSpeed }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stat-item<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>label<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>已完成块:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>value<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{<!-- -->{ downloadedChunks }} / {<!-- -->{ totalChunks }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stat-item<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>label<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>剩余时间:<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>value<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{<!-- -->{ remainingTime }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>chunk-visualization<span class="token punctuation">"</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>isDownloading || isPaused<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>chunk-grid<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span>
              <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>(chunk, index) in chunkStatus<span class="token punctuation">"</span></span>
              <span class="token attr-name">:key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>index<span class="token punctuation">"</span></span>
              <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>chunk-block<span class="token punctuation">"</span></span>
              <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{
              'downloaded': chunk === 'completed',
              'downloading': chunk === 'downloading',
              'pending': chunk === 'pending',
              'error': chunk === 'error'
            }<span class="token punctuation">"</span></span>
              <span class="token attr-name">:title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>`块 ${index + 1}: ${chunk}`<span class="token punctuation">"</span></span>
          <span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>actions<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>
            <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>startDownload<span class="token punctuation">"</span></span>
            <span class="token attr-name">:disabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>isDownloading<span class="token punctuation">"</span></span>
            <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>!isDownloading &amp;&amp; !isPaused<span class="token punctuation">"</span></span>
            <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-primary<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          开始下载
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>
            <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pauseDownload<span class="token punctuation">"</span></span>
            <span class="token attr-name">:disabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>!isDownloading<span class="token punctuation">"</span></span>
            <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>isDownloading &amp;&amp; !isPaused<span class="token punctuation">"</span></span>
            <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-warning<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          暂停
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>
            <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>resumeDownload<span class="token punctuation">"</span></span>
            <span class="token attr-name">:disabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>!isPaused<span class="token punctuation">"</span></span>
            <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>isPaused<span class="token punctuation">"</span></span>
            <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-success<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          继续
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span>
            <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cancelDownload<span class="token punctuation">"</span></span>
            <span class="token attr-name">:disabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>!isDownloading &amp;&amp; !isPaused<span class="token punctuation">"</span></span>
            <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>btn btn-danger<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
          取消
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>status-message<span class="token punctuation">"</span></span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>statusMessage<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        {<!-- -->{ statusMessage }}
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">setup</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>computed<span class="token punctuation">,</span> onMounted<span class="token punctuation">,</span> onUnmounted<span class="token punctuation">,</span> ref<span class="token punctuation">,</span> watch<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span>ChunkDownloader<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./downloadService'</span><span class="token punctuation">;</span>

<span class="token comment">// API URL</span>
<span class="token keyword">const</span> <span class="token constant">API_BASE_URL</span> <span class="token operator">=</span> <span class="token string">'http://localhost:8000/download/'</span><span class="token punctuation">;</span>

<span class="token comment">// 下载配置</span>
<span class="token keyword">const</span> concurrency <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chunkSize <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1MB</span>
<span class="token keyword">const</span> downloader <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 状态变量</span>
<span class="token keyword">const</span> fileInfo <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> isDownloading <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> isPaused <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> downloadedBytes <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> totalBytes <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> downloadedChunks <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> totalChunks <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> statusMessage <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'准备就绪'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> downloadStartTime <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> lastUpdateTime <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> lastBytes <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> downloadSpeed <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'0 KB/s'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> remainingTime <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">'计算中...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> speedInterval <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 块状态</span>
<span class="token keyword">const</span> chunkStatus <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 计算下载进度百分比</span>
<span class="token keyword">const</span> progress <span class="token operator">=</span> <span class="token function">computed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>totalBytes<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>downloadedBytes<span class="token punctuation">.</span>value <span class="token operator">/</span> totalBytes<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化</span>
<span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">await</span> <span class="token function">fetchFileInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'获取文件信息失败:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    statusMessage<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">获取文件信息失败: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 清理资源</span>
<span class="token function">onUnmounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>downloader<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    downloader<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">clearInterval</span><span class="token punctuation">(</span>speedInterval<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 获取文件信息</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">fetchFileInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token constant">API_BASE_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">large_file/file_info/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">HTTP 错误! 状态码: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>response<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  fileInfo<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  totalBytes<span class="token punctuation">.</span>value <span class="token operator">=</span> fileInfo<span class="token punctuation">.</span>value<span class="token punctuation">.</span>size<span class="token punctuation">;</span>

  <span class="token comment">// 根据文件大小初始化分块状态</span>
  <span class="token keyword">const</span> initialTotalChunks <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">.</span>value<span class="token punctuation">.</span>size <span class="token operator">/</span> chunkSize<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  chunkStatus<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>initialTotalChunks<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'pending'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  totalChunks<span class="token punctuation">.</span>value <span class="token operator">=</span> initialTotalChunks<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 开始下载</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">startDownload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>isDownloading<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 初始化下载器</span>
    downloader<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChunkDownloader</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token constant">API_BASE_URL</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">chunkSize</span><span class="token operator">:</span> chunkSize<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      <span class="token literal-property property">concurrency</span><span class="token operator">:</span> concurrency<span class="token punctuation">.</span>value<span class="token punctuation">,</span>
      <span class="token literal-property property">maxRetries</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token literal-property property">onProgress</span><span class="token operator">:</span> handleProgress<span class="token punctuation">,</span>
      <span class="token literal-property property">onComplete</span><span class="token operator">:</span> handleComplete<span class="token punctuation">,</span>
      <span class="token literal-property property">onError</span><span class="token operator">:</span> handleError<span class="token punctuation">,</span>
      <span class="token literal-property property">onStatusChange</span><span class="token operator">:</span> handleStatusChange
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化状态</span>
    downloadedBytes<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    downloadedChunks<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    isDownloading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    isPaused<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    statusMessage<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'准备下载...'</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取文件信息</span>
    <span class="token keyword">await</span> downloader<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">fetchFileInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 更新总块数</span>
    totalChunks<span class="token punctuation">.</span>value <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>downloader<span class="token punctuation">.</span>value<span class="token punctuation">.</span>fileSize <span class="token operator">/</span> chunkSize<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    chunkStatus<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>totalChunks<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'pending'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 开始下载</span>
    downloadStartTime<span class="token punctuation">.</span>value <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lastUpdateTime<span class="token punctuation">.</span>value <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lastBytes<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">startSpeedCalculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> downloader<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'下载启动失败:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    statusMessage<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">下载启动失败: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    isDownloading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 暂停下载</span>
<span class="token keyword">function</span> <span class="token function">pauseDownload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDownloading<span class="token punctuation">.</span>value <span class="token operator">||</span> <span class="token operator">!</span>downloader<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  downloader<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  isDownloading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  isPaused<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  statusMessage<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'下载已暂停'</span><span class="token punctuation">;</span>
  <span class="token function">clearInterval</span><span class="token punctuation">(</span>speedInterval<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 继续下载</span>
<span class="token keyword">function</span> <span class="token function">resumeDownload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isPaused<span class="token punctuation">.</span>value <span class="token operator">||</span> <span class="token operator">!</span>downloader<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  downloader<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  isDownloading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  isPaused<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  statusMessage<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'继续下载...'</span><span class="token punctuation">;</span>

  <span class="token comment">// 重新开始速度计算</span>
  lastUpdateTime<span class="token punctuation">.</span>value <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  lastBytes<span class="token punctuation">.</span>value <span class="token operator">=</span> downloadedBytes<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
  <span class="token function">startSpeedCalculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 取消下载</span>
<span class="token keyword">function</span> <span class="token function">cancelDownload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>downloader<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  downloader<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  isDownloading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  isPaused<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  downloadedBytes<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  downloadedChunks<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  statusMessage<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'下载已取消'</span><span class="token punctuation">;</span>
  <span class="token function">clearInterval</span><span class="token punctuation">(</span>speedInterval<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 重置块状态</span>
  chunkStatus<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>totalChunks<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'pending'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 处理进度更新</span>
<span class="token keyword">function</span> <span class="token function">handleProgress</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  downloadedBytes<span class="token punctuation">.</span>value <span class="token operator">=</span> data<span class="token punctuation">.</span>downloadedBytes<span class="token punctuation">;</span>
  downloadedChunks<span class="token punctuation">.</span>value <span class="token operator">=</span> data<span class="token punctuation">.</span>downloadedChunks<span class="token punctuation">;</span>

  <span class="token comment">// 更新块状态（这里仅是简化的更新方式，实际上应该由downloader提供精确的块状态）</span>
  <span class="token keyword">const</span> newChunkStatus <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span>chunkStatus<span class="token punctuation">.</span>value<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> completedChunksCount <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>downloadedChunks<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> newChunkStatus<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> completedChunksCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      newChunkStatus<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'completed'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> completedChunksCount <span class="token operator">+</span> concurrency<span class="token punctuation">.</span>value <span class="token operator">&amp;&amp;</span> newChunkStatus<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">'completed'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      newChunkStatus<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'downloading'</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  chunkStatus<span class="token punctuation">.</span>value <span class="token operator">=</span> newChunkStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 处理下载完成</span>
<span class="token keyword">function</span> <span class="token function">handleComplete</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  isDownloading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  isPaused<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  statusMessage<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'下载完成'</span><span class="token punctuation">;</span>
  <span class="token function">clearInterval</span><span class="token punctuation">(</span>speedInterval<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 标记所有块为已完成</span>
  chunkStatus<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>totalChunks<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'completed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 处理错误</span>
<span class="token keyword">function</span> <span class="token function">handleError</span><span class="token punctuation">(</span><span class="token parameter">error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'下载错误:'</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
  statusMessage<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">下载错误: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>error<span class="token punctuation">.</span>message<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 处理状态变化</span>
<span class="token keyword">function</span> <span class="token function">handleStatusChange</span><span class="token punctuation">(</span><span class="token parameter">status<span class="token punctuation">,</span> error</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> <span class="token string">'downloading'</span><span class="token operator">:</span>
      isDownloading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      isPaused<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      statusMessage<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'下载中...'</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'paused'</span><span class="token operator">:</span>
      isDownloading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      isPaused<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      statusMessage<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'下载已暂停'</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'completed'</span><span class="token operator">:</span>
      isDownloading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      isPaused<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      statusMessage<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'下载完成'</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'error'</span><span class="token operator">:</span>
      isDownloading<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      statusMessage<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">下载错误: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>error<span class="token operator">?.</span>message <span class="token operator">||</span> <span class="token string">'未知错误'</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 启动下载速度计算器</span>
<span class="token keyword">function</span> <span class="token function">startSpeedCalculator</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">clearInterval</span><span class="token punctuation">(</span>speedInterval<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  speedInterval<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> now <span class="token operator">=</span> Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> timeElapsed <span class="token operator">=</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> lastUpdateTime<span class="token punctuation">.</span>value<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// 转换为秒</span>
    <span class="token keyword">const</span> bytesDownloaded <span class="token operator">=</span> downloadedBytes<span class="token punctuation">.</span>value <span class="token operator">-</span> lastBytes<span class="token punctuation">.</span>value<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeElapsed <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> speed <span class="token operator">=</span> bytesDownloaded <span class="token operator">/</span> timeElapsed<span class="token punctuation">;</span> <span class="token comment">// 字节/秒</span>
      downloadSpeed<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">formatFileSize</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'/s'</span><span class="token punctuation">;</span>

      <span class="token comment">// 计算剩余时间</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>speed <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> bytesRemaining <span class="token operator">=</span> totalBytes<span class="token punctuation">.</span>value <span class="token operator">-</span> downloadedBytes<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token keyword">const</span> secondsRemaining <span class="token operator">=</span> bytesRemaining <span class="token operator">/</span> speed<span class="token punctuation">;</span>
        remainingTime<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">formatTime</span><span class="token punctuation">(</span>secondsRemaining<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        remainingTime<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">'计算中...'</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      lastUpdateTime<span class="token punctuation">.</span>value <span class="token operator">=</span> now<span class="token punctuation">;</span>
      lastBytes<span class="token punctuation">.</span>value <span class="token operator">=</span> downloadedBytes<span class="token punctuation">.</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 格式化文件大小</span>
<span class="token keyword">function</span> <span class="token function">formatFileSize</span><span class="token punctuation">(</span><span class="token parameter">bytes</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>bytes <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token string">'0 B'</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> k <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> sizes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'B'</span><span class="token punctuation">,</span> <span class="token string">'KB'</span><span class="token punctuation">,</span> <span class="token string">'MB'</span><span class="token punctuation">,</span> <span class="token string">'GB'</span><span class="token punctuation">,</span> <span class="token string">'TB'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> i <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span> <span class="token operator">/</span> Math<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token function">parseFloat</span><span class="token punctuation">(</span><span class="token punctuation">(</span>bytes <span class="token operator">/</span> Math<span class="token punctuation">.</span><span class="token function">pow</span><span class="token punctuation">(</span>k<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' '</span> <span class="token operator">+</span> sizes<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 格式化时间</span>
<span class="token keyword">function</span> <span class="token function">formatTime</span><span class="token punctuation">(</span><span class="token parameter">seconds</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isFinite</span><span class="token punctuation">(</span>seconds<span class="token punctuation">)</span> <span class="token operator">||</span> seconds <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token string">'计算中...'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>seconds <span class="token operator">&lt;</span> <span class="token number">60</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>seconds<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">秒</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>seconds <span class="token operator">&lt;</span> <span class="token number">3600</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> minutes <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>seconds <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> secs <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>seconds <span class="token operator">%</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>minutes<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">分</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>secs<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">秒</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> hours <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>seconds <span class="token operator">/</span> <span class="token number">3600</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> minutes <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>seconds <span class="token operator">%</span> <span class="token number">3600</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>hours<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">小时</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>minutes<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">分钟</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听配置改变，更新块状态</span>
<span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">[</span>chunkSize<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fileInfo<span class="token punctuation">.</span>value <span class="token operator">&amp;&amp;</span> fileInfo<span class="token punctuation">.</span>value<span class="token punctuation">.</span>size<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    totalChunks<span class="token punctuation">.</span>value <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>fileInfo<span class="token punctuation">.</span>value<span class="token punctuation">.</span>size <span class="token operator">/</span> chunkSize<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    chunkStatus<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">Array</span><span class="token punctuation">(</span>totalChunks<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token string">'pending'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span> <span class="token attr-name">scoped</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
<span class="token selector">.enhanced-downloader</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">max-width</span><span class="token punctuation">:</span> 800px<span class="token punctuation">;</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> 0 auto<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.card</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">background</span><span class="token punctuation">:</span> #fff<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>
  <span class="token property">box-shadow</span><span class="token punctuation">:</span> 0 2px 10px <span class="token function">rgba</span><span class="token punctuation">(</span>0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0<span class="token punctuation">,</span> 0.1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">h2</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">margin-top</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #333<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.file-info</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.progress-container</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.progress-bar</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">height</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #f0f0f0<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.progress</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">height</span><span class="token punctuation">:</span> 100%<span class="token punctuation">;</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #4CAF50<span class="token punctuation">;</span>
  <span class="token property">transition</span><span class="token punctuation">:</span> width 0.3s ease<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.progress-stats</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  <span class="token property">justify-content</span><span class="token punctuation">:</span> space-between<span class="token punctuation">;</span>
  <span class="token property">font-size</span><span class="token punctuation">:</span> 14px<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #666<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.actions</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
  <span class="token property">gap</span><span class="token punctuation">:</span> 10px<span class="token punctuation">;</span>
  <span class="token property">margin-bottom</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.btn</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 8px 16px<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span>
  <span class="token property">border-radius</span><span class="token punctuation">:</span> 4px<span class="token punctuation">;</span>
  <span class="token property">cursor</span><span class="token punctuation">:</span> pointer<span class="token punctuation">;</span>
  <span class="token property">font-weight</span><span class="token punctuation">:</span> bold<span class="token punctuation">;</span>
  <span class="token property">transition</span><span class="token punctuation">:</span> background-color 0.3s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.btn:disabled</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">opacity</span><span class="token punctuation">:</span> 0.5<span class="token punctuation">;</span>
  <span class="token property">cursor</span><span class="token punctuation">:</span> not-allowed<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.btn-primary</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #4CAF50<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.btn-warning</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #FF9800<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.btn-success</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #2196F3<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.btn-danger</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #F44336<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> white<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token selector">.status</span> <span class="token punctuation">{<!-- --></span>
  <span class="token property">font-style</span><span class="token punctuation">:</span> italic<span class="token punctuation">;</span>
  <span class="token property">color</span><span class="token punctuation">:</span> #666<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <p>
     2，下载服务 (ChunkDownloader类):
    </p>
    <ul>
     <li>
      负责管理整个下载过程
     </li>
     <li>
      处理文件信息获取、分块下载、进度追踪
     </li>
     <li>
      实现并发控制、重试机制、暂停/继续功能
     </li>
    </ul>
    <pre><code class="prism language-javascript"><span class="token comment">// downloadService.js - 分块下载实现</span>

<span class="token comment">/*
 文件分块下载器
 */</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">ChunkDownloader</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chunkSize <span class="token operator">=</span> options<span class="token punctuation">.</span>chunkSize <span class="token operator">||</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span> <span class="token comment">// 默认1MB每块</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>maxRetries <span class="token operator">=</span> options<span class="token punctuation">.</span>maxRetries <span class="token operator">||</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>concurrency <span class="token operator">=</span> options<span class="token punctuation">.</span>concurrency <span class="token operator">||</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token comment">// 并发下载块数</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>timeout <span class="token operator">=</span> options<span class="token punctuation">.</span>timeout <span class="token operator">||</span> <span class="token number">30000</span><span class="token punctuation">;</span> <span class="token comment">// 超时时间</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>contentType <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>downloadedChunks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>activeDownloads <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>totalChunks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>downloadedBytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'idle'</span><span class="token punctuation">;</span> <span class="token comment">// idle, downloading, paused, completed, error</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>onProgress <span class="token operator">=</span> options<span class="token punctuation">.</span>onProgress <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onComplete <span class="token operator">=</span> options<span class="token punctuation">.</span>onComplete <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onError <span class="token operator">=</span> options<span class="token punctuation">.</span>onError <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>onStatusChange <span class="token operator">=</span> options<span class="token punctuation">.</span>onStatusChange <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>abortControllers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pendingChunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>processedChunks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取文件信息</span>
    <span class="token keyword">async</span> <span class="token function">fetchFileInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">+</span> <span class="token string">'large_file/file_info/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">无法获取文件信息: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>response<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">=</span> info<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>fileName <span class="token operator">=</span> info<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>contentType <span class="token operator">=</span> info<span class="token punctuation">.</span>type<span class="token punctuation">;</span>

            <span class="token comment">// 计算分块数量</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>totalChunks <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> info<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onStatusChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 开始下载</span>
    <span class="token keyword">async</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'downloading'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 如果还没获取文件信息，先获取</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchFileInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 初始化状态</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'downloading'</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onStatusChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 如果是全新下载，初始化块数组</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>chunks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>totalChunks<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>pendingChunks <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalChunks<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 开始并发下载</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startConcurrentDownloads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onStatusChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 开始并发下载</span>
    <span class="token function">startConcurrentDownloads</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 确保同时只有指定数量的并发下载</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeDownloads <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>concurrency <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pendingChunks<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> chunkIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pendingChunks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">downloadChunk</span><span class="token punctuation">(</span>chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 下载指定的块</span>
    <span class="token keyword">async</span> <span class="token function">downloadChunk</span><span class="token punctuation">(</span><span class="token parameter">chunkIndex<span class="token punctuation">,</span> retryCount <span class="token operator">=</span> <span class="token number">0</span></span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token string">'downloading'</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processedChunks<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>chunkIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>activeDownloads<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> startByte <span class="token operator">=</span> chunkIndex <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunkSize<span class="token punctuation">;</span>
        <span class="token keyword">const</span> endByte <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>startByte <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunkSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建用于取消请求的控制器</span>
        <span class="token keyword">const</span> controller <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbortController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>abortControllers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>chunkIndex<span class="token punctuation">,</span> controller<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">+</span> <span class="token string">'large_file/download_large_file/'</span><span class="token punctuation">,</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token string-property property">'Range'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bytes=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>startByte<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>endByte<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">signal</span><span class="token operator">:</span> controller<span class="token punctuation">.</span>signal<span class="token punctuation">,</span>
                    <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>timeout
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok <span class="token operator">&amp;&amp;</span> response<span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token number">206</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">服务器错误: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>response<span class="token punctuation">.</span>status<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 获取块数据</span>
            <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span><span class="token function">blob</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">[</span>chunkIndex<span class="token punctuation">]</span> <span class="token operator">=</span> blob<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>downloadedChunks<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>downloadedBytes <span class="token operator">+=</span> blob<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>processedChunks<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 更新进度</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onProgress</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">downloadedChunks</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>downloadedChunks<span class="token punctuation">,</span>
                <span class="token literal-property property">totalChunks</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalChunks<span class="token punctuation">,</span>
                <span class="token literal-property property">downloadedBytes</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>downloadedBytes<span class="token punctuation">,</span>
                <span class="token literal-property property">totalBytes</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize<span class="token punctuation">,</span>
                <span class="token literal-property property">progress</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>downloadedBytes <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 清理控制器</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>abortControllers<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 检查是否下载完成</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>downloadedChunks <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalChunks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">completeDownload</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'downloading'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 继续下载下一个块</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>activeDownloads<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startConcurrentDownloads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>abortControllers<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">.</span>name <span class="token operator">===</span> <span class="token string">'AbortError'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 用户取消，不进行重试</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>activeDownloads<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 重试逻辑</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>retryCount <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxRetries<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">块 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>chunkIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 下载失败，重试 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>retryCount <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>maxRetries<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>activeDownloads<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">downloadChunk</span><span class="token punctuation">(</span>chunkIndex<span class="token punctuation">,</span> retryCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">块 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>chunkIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 下载失败，已达到最大重试次数</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onStatusChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>activeDownloads<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 完成下载</span>
    <span class="token function">completeDownload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'completed'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 合并所有块</span>
            <span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>contentType<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 创建下载链接</span>
            <span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> a <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            a<span class="token punctuation">.</span>href <span class="token operator">=</span> url<span class="token punctuation">;</span>
            a<span class="token punctuation">.</span>download <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileName<span class="token punctuation">;</span>
            document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
            a<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 清理资源</span>
            <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">revokeObjectURL</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 更新状态</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'completed'</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onStatusChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">fileName</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileName<span class="token punctuation">,</span>
                <span class="token literal-property property">fileSize</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize<span class="token punctuation">,</span>
                <span class="token literal-property property">contentType</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>contentType<span class="token punctuation">,</span>
                <span class="token literal-property property">blob</span><span class="token operator">:</span> blob
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> error<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'error'</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onStatusChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 暂停下载</span>
    <span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token string">'downloading'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 取消所有正在进行的请求</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>abortControllers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">controller</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            controller<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 清空控制器集合</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>abortControllers<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 更新状态</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'paused'</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>activeDownloads <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onStatusChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将当前处理中的块重新加入待处理队列</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pendingChunks <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalChunks<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> i<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>processedChunks<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 继续下载</span>
    <span class="token function">resume</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">!==</span> <span class="token string">'paused'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'downloading'</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onStatusChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startConcurrentDownloads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 取消下载</span>
    <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 取消所有正在进行的请求</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>abortControllers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">controller</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            controller<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 重置所有状态</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>downloadedChunks <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>activeDownloads <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>downloadedBytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'idle'</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>error <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>abortControllers<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pendingChunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>processedChunks<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onStatusChange</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取当前状态</span>
    <span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">status</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>status<span class="token punctuation">,</span>
            <span class="token literal-property property">downloadedChunks</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>downloadedChunks<span class="token punctuation">,</span>
            <span class="token literal-property property">totalChunks</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalChunks<span class="token punctuation">,</span>
            <span class="token literal-property property">downloadedBytes</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>downloadedBytes<span class="token punctuation">,</span>
            <span class="token literal-property property">totalBytes</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize<span class="token punctuation">,</span>
            <span class="token literal-property property">progress</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>downloadedBytes <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileSize<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">100</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            <span class="token literal-property property">fileName</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileName<span class="token punctuation">,</span>
            <span class="token literal-property property">error</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>error
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="2_1151">
     </a>
     2，核心技术原理
    </h3>
    <h4>
     <a id="1HTTP_Range_1152">
     </a>
     （1）HTTP Range请求
    </h4>
    <p>
     该实现通过HTTP的Range头部实现分块下载：
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">const</span> response <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">+</span> <span class="token string">'large_file/download_large_file/'</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token literal-property property">method</span><span class="token operator">:</span> <span class="token string">'GET'</span><span class="token punctuation">,</span>
        <span class="token literal-property property">headers</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string-property property">'Range'</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">bytes=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>startByte<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>endByte<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">signal</span><span class="token operator">:</span> controller<span class="token punctuation">.</span>signal<span class="token punctuation">,</span>
        <span class="token literal-property property">timeout</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>timeout
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      服务器会返回状态码206（Partial Content）和请求的文件片段。
     </li>
    </ul>
    <h4>
     <a id="2_1169">
     </a>
     （2）并发控制
    </h4>
    <p>
     代码通过控制同时活跃的下载请求数量来实现并发：
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>activeDownloads <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>concurrency <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pendingChunks<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> chunkIndex <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pendingChunks<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">downloadChunk</span><span class="token punctuation">(</span>chunkIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="3_1179">
     </a>
     （3）状态管理和进度追踪
    </h4>
    <ul>
     <li>
      跟踪每个块的下载状态（待下载、下载中、已完成、错误）
     </li>
     <li>
      计算并报告总体进度、下载速度和剩余时间
     </li>
    </ul>
    <h4>
     <a id="4_1184">
     </a>
     （4）错误处理和重试机制
    </h4>
    <p>
     对下载失败的块进行自动重试：
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span>retryCount <span class="token operator">&lt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>maxRetries<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">块 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>chunkIndex<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 下载失败，重试 </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>retryCount <span class="token operator">+</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>maxRetries<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>activeDownloads<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">downloadChunk</span><span class="token punctuation">(</span>chunkIndex<span class="token punctuation">,</span> retryCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="5_1194">
     </a>
     （5）暂停/恢复功能
    </h4>
    <p>
     通过AbortController取消活跃的请求，并保存未完成的块索引：
    </p>
    <pre><code class="prism language-javascript"><span class="token function">pause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 取消所有正在进行的请求</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>abortControllers<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">controller</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        controller<span class="token punctuation">.</span><span class="token function">abort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 将当前处理中的块重新加入待处理队列</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>pendingChunks <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">length</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalChunks<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">_<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> i<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">i</span> <span class="token operator">=&gt;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>processedChunks<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="6_1209">
     </a>
     （6）文件合并和下载
    </h4>
    <p>
     所有块下载完成后，使用Blob API合并所有分块并创建下载链接：
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">const</span> blob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>chunks<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>contentType<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> url <span class="token operator">=</span> <span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> a <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
a<span class="token punctuation">.</span>href <span class="token operator">=</span> url<span class="token punctuation">;</span>
a<span class="token punctuation">.</span>download <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>fileName<span class="token punctuation">;</span>
a<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f64616e6766756c696e2f:61727469636c652f64657461696c732f313436323931373136" class_="artid" style="display:none">
 </p>
</div>


