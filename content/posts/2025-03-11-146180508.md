---
layout: post
title: "多线程基于环形队列RingQueue的生产者-消费者模型的实现"
date: 2025-03-11 16:01:16 +0800
description: "[多线程]基于环形队列（RingQueue）的生产者-消费者模型的实现"
keywords: "[多线程]基于环形队列（RingQueue）的生产者-消费者模型的实现"
categories: ['项目实践']
tags: ['运维', '生产者消费者模型', '生产者', '消费者', '服务器', 'Linux']
artid: "146180508"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146180508
    alt: "多线程基于环形队列RingQueue的生产者-消费者模型的实现"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146180508
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146180508
cover: https://bing.ee123.net/img/rand?artid=146180508
image: https://bing.ee123.net/img/rand?artid=146180508
img: https://bing.ee123.net/img/rand?artid=146180508
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     [多线程]基于环形队列（RingQueue）的生产者-消费者模型的实现
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <strong>
      标题：[多线程]基于环形队列（RingQueue）的生产者-消费者模型
      <br/>
      @水墨不写bug
     </strong>
    </p>
    <hr/>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/091da627e95a4b75b0d0f53fe27d5332.jpeg#pic_center"/>
    </p>
    <hr/>
    <h2>
     <a id="_6">
     </a>
     一、模型实现
    </h2>
    <p>
     接下来我们要实现一个基于
     <code>
      环形队列（RingQueue）
     </code>
     的
     <code>
      生产者-消费者模型
     </code>
     。该模型使用信号量和互斥锁来保证生产者和消费者之间的同步与互斥操作。
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;semaphore.h&gt;</span></span>

<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">;</span>
<span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>

<span class="token comment">// 基于环形队列的生产消费模型</span>
<span class="token comment">// 与加锁不同，加锁要求对象rq内部内嵌一个锁，而两个信号量</span>
<span class="token comment">// （sem_t _data_sem;  // 数据信号量</span>
<span class="token comment">//     sem_t _spase_sem; // 空间信号量）</span>
<span class="token comment">// 可以做到完美维护以下的四条规则：</span>
<span class="token comment">/*
    1.生产者不会套消费者一圈
    2.消费者不超过生产者
    3.队列为空，消费者先消费
    4.队列为满，生产者先生产
*/</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">RingQueue</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">// 信号量（计数器）自减——申请信号量</span>
    <span class="token keyword">void</span> <span class="token function">P</span><span class="token punctuation">(</span>sem_t <span class="token operator">&amp;</span>psem<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">sem_wait</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>psem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 信号量（计数器）自增——归还信号量</span>
    <span class="token keyword">void</span> <span class="token function">V</span><span class="token punctuation">(</span>sem_t <span class="token operator">&amp;</span>vsem<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">sem_post</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>vsem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">RingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxcap<span class="token punctuation">)</span>
        <span class="token operator">:</span> <span class="token function">_ringqueue</span><span class="token punctuation">(</span>maxcap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_maxcap</span><span class="token punctuation">(</span>maxcap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_data_sem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_space_sem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_p_step</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_c_step</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>   
        <span class="token comment">// 初始化信号量</span>
        <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_data_sem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_space_sem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> maxcap<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 初始化互斥锁</span>
        <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_p_mutex<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_c_mutex<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 生产者向环形队列插入数据</span>
    <span class="token keyword">void</span> <span class="token function">Push</span><span class="token punctuation">(</span><span class="token keyword">const</span> T<span class="token operator">&amp;</span> in<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 申请空间信号量</span>
        <span class="token function">P</span><span class="token punctuation">(</span>_space_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_p_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _ringqueue<span class="token punctuation">[</span>_p_step<span class="token punctuation">]</span> <span class="token operator">=</span> in<span class="token punctuation">;</span>
        _p_step<span class="token operator">++</span><span class="token punctuation">;</span>
        _p_step <span class="token operator">%=</span> _maxcap<span class="token punctuation">;</span>
        _size<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_p_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">V</span><span class="token punctuation">(</span>_data_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 消费者从环形队列拿出数据</span>
    <span class="token keyword">void</span> <span class="token function">Pop</span><span class="token punctuation">(</span>T <span class="token operator">*</span>out<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 申请数据信号量</span>
        <span class="token function">P</span><span class="token punctuation">(</span>_data_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_c_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">*</span>out <span class="token operator">=</span> _ringqueue<span class="token punctuation">[</span>_c_step<span class="token punctuation">]</span><span class="token punctuation">;</span>
        _c_step<span class="token operator">++</span><span class="token punctuation">;</span>
        _c_step <span class="token operator">%=</span> _maxcap<span class="token punctuation">;</span>
        _size<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_c_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">V</span><span class="token punctuation">(</span>_space_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">~</span><span class="token function">RingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 销毁信号量</span>
        <span class="token function">sem_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_data_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sem_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_space_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    size_t <span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> _size<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">// 环形队列</span>
    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> _ringqueue<span class="token punctuation">;</span>

    <span class="token keyword">int</span> _maxcap<span class="token punctuation">;</span> <span class="token comment">// 最大数据个数</span>

    sem_t _data_sem<span class="token punctuation">;</span>  <span class="token comment">// 数据信号量</span>
    sem_t _space_sem<span class="token punctuation">;</span> <span class="token comment">// 空间信号量</span>

    pthread_mutex_t _p_mutex<span class="token punctuation">;</span> <span class="token comment">// 维护生产者之间关系的互斥锁</span>
    pthread_mutex_t _c_mutex<span class="token punctuation">;</span> <span class="token comment">// 维护消费者之间关系的互斥锁</span>

    <span class="token keyword">int</span> _p_step<span class="token punctuation">;</span> <span class="token comment">// 生产者位置</span>
    <span class="token keyword">int</span> _c_step<span class="token punctuation">;</span> <span class="token comment">// 消费者位置</span>

    <span class="token keyword">int</span> _size<span class="token punctuation">;</span> <span class="token comment">// 队列内数据个数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h2>
     <a id="_121">
     </a>
     二、模型设计详解
    </h2>
    <h3>
     <a id="1__123">
     </a>
     1. 成员变量
    </h3>
    <ul>
     <li>
      <code>
       std::vector&lt;T&gt; _ringqueue
      </code>
      ：环形队列，用于存储数据。
     </li>
     <li>
      <code>
       int _maxcap
      </code>
      ：队列的最大容量。
     </li>
     <li>
      <code>
       sem_t _data_sem
      </code>
      和
      <code>
       sem_t _space_sem
      </code>
      ：信号量，分别用于表示队列中的数据量和剩余空间量。（
      <strong>
       生产者和消费者关系的资源类型不同；生产者关心剩余空间资源，消费者关心剩余数据资源
      </strong>
      ）
     </li>
     <li>
      <code>
       pthread_mutex_t _p_mutex
      </code>
      和
      <code>
       pthread_mutex_t _c_mutex
      </code>
      ：互斥锁，分别用于保护生产者和消费者的操作。
     </li>
     <li>
      <code>
       int _p_step
      </code>
      和
      <code>
       int _c_step
      </code>
      ：生产者和消费者在队列中的位置指针。
     </li>
     <li>
      <code>
       int _size
      </code>
      ：队列内数据的当前个数。
     </li>
    </ul>
    <h3>
     <a id="2__132">
     </a>
     2. 构造函数
    </h3>
    <pre><code class="prism language-cpp"><span class="token function">RingQueue</span><span class="token punctuation">(</span><span class="token keyword">int</span> maxcap<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token function">_ringqueue</span><span class="token punctuation">(</span>maxcap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_maxcap</span><span class="token punctuation">(</span>maxcap<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_data_sem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_space_sem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_p_step</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_c_step</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 初始化信号量</span>
    <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_data_sem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sem_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_space_sem<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> maxcap<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化互斥锁</span>
    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_p_mutex<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_c_mutex<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      初始化环形队列的最大容量。
     </li>
     <li>
      初始化信号量，其中
      <code>
       _data_sem
      </code>
      的初始值为 0，表示初始时没有数据；
      <code>
       _space_sem
      </code>
      的初始值为
      <code>
       maxcap
      </code>
      ，表示初始时队列可用空间为最大容量。
     </li>
     <li>
      初始化互斥锁
      <code>
       _p_mutex
      </code>
      和
      <code>
       _c_mutex
      </code>
      ，分别用于维持生产者之间和消费者之间的互斥。
     </li>
    </ul>
    <h3>
     <a id="3_Push__152">
     </a>
     3.
     <code>
      Push
     </code>
     函数
    </h3>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">Push</span><span class="token punctuation">(</span><span class="token keyword">const</span> T<span class="token operator">&amp;</span> in<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 申请空间信号量</span>
    <span class="token function">P</span><span class="token punctuation">(</span>_space_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_p_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    _ringqueue<span class="token punctuation">[</span>_p_step<span class="token punctuation">]</span> <span class="token operator">=</span> in<span class="token punctuation">;</span>
    _p_step<span class="token operator">++</span><span class="token punctuation">;</span>
    _p_step <span class="token operator">%=</span> _maxcap<span class="token punctuation">;</span>
    _size<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_p_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">V</span><span class="token punctuation">(</span>_data_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <code>
       P(_space_sem)
      </code>
      ：生产者申请空间信号量，如果队列已满（信号量为0），则生产者阻塞等待。
     </li>
     <li>
      <code>
       pthread_mutex_lock(&amp;_p_mutex)
      </code>
      ：加锁保护生产者的操作。
     </li>
     <li>
      将数据插入到环形队列的当前位置
      <code>
       _p_step
      </code>
      ，然后更新
      <code>
       _p_step
      </code>
      和
      <code>
       _size
      </code>
      。
     </li>
     <li>
      <code>
       pthread_mutex_unlock(&amp;_p_mutex)
      </code>
      ：解锁。
     </li>
     <li>
      <code>
       V(_data_sem)
      </code>
      ：释放数据信号量，通知消费者有新数据可用。
     </li>
    </ul>
    <h3>
     <a id="4_Pop__175">
     </a>
     4.
     <code>
      Pop
     </code>
     函数
    </h3>
    <pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">Pop</span><span class="token punctuation">(</span>T <span class="token operator">*</span>out<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 申请数据信号量</span>
    <span class="token function">P</span><span class="token punctuation">(</span>_data_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_c_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>out <span class="token operator">=</span> _ringqueue<span class="token punctuation">[</span>_c_step<span class="token punctuation">]</span><span class="token punctuation">;</span>
    _c_step<span class="token operator">++</span><span class="token punctuation">;</span>
    _c_step <span class="token operator">%=</span> _maxcap<span class="token punctuation">;</span>
    _size<span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_c_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">V</span><span class="token punctuation">(</span>_space_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      <code>
       P(_data_sem)
      </code>
      ：消费者申请数据信号量，如果队列为空（信号量为0），则消费者阻塞等待。
     </li>
     <li>
      <code>
       pthread_mutex_lock(&amp;_c_mutex)
      </code>
      ：加锁保护消费者的操作。
     </li>
     <li>
      从环形队列的当前位置
      <code>
       _c_step
      </code>
      取出数据，然后更新
      <code>
       _c_step
      </code>
      和
      <code>
       _size
      </code>
      。
     </li>
     <li>
      <code>
       pthread_mutex_unlock(&amp;_c_mutex)
      </code>
      ：解锁。
     </li>
     <li>
      <code>
       V(_space_sem)
      </code>
      ：释放空间信号量，通知生产者有新的可用空间。
     </li>
    </ul>
    <h3>
     <a id="5__198">
     </a>
     5. 析构函数
    </h3>
    <pre><code class="prism language-cpp"><span class="token operator">~</span><span class="token function">RingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 销毁信号量</span>
    <span class="token function">sem_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_data_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">sem_destroy</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_space_sem<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      销毁信号量，释放资源。
     </li>
    </ul>
    <h3>
     <a id="6_GetSize__211">
     </a>
     6.
     <code>
      GetSize
     </code>
     函数
    </h3>
    <pre><code class="prism language-cpp">size_t <span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> _size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <ul>
     <li>
      返回队列的当前大小。
     </li>
    </ul>
    <h2>
     <a id="_222">
     </a>
     三、模型总结
    </h2>
    <p>
     上述代码实现了一个基于
     <code>
      环形队列
     </code>
     的生产者-消费者模型，通过使用
     <code>
      信号量
     </code>
     来控制
     <code>
      生产者和消费者之间
     </code>
     的同步和互斥，通过
     <code>
      互斥锁
     </code>
     来保证
     <code>
      生产者之间
     </code>
     、
     <code>
      消费者之间
     </code>
     的互斥。
     <br/>
     信号量用于控制队列中的数据量和剩余空间量，互斥锁用于保护生产者和消费者的操作。通过这种方式，可以有效地避免资源竞争和死锁问题，实现了高效的生产和消费操作。
    </p>
    <h2>
     <a id="_226">
     </a>
     四、模型测试
    </h2>
    <p>
     以下给出了模型的测试逻辑代码，可以清晰的观察出单生产单消费，多生产多消费的情况：
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"RingQueue.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib&gt;</span></span>
<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">Product</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    RingQueue<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token operator">*</span>rq <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>RingQueue<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.生产数据</span>
        <span class="token keyword">int</span> tem <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">37</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.加入环形队列（访问临界资源）</span>
        rq<span class="token operator">-&gt;</span><span class="token function">Push</span><span class="token punctuation">(</span>tem<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Product num : "</span> <span class="token operator">&lt;&lt;</span> tem <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// usleep(100000);</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">Consume</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>args<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    RingQueue<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token operator">*</span>rq <span class="token operator">=</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>RingQueue<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.拿到数据（访问临界资源）</span>
        <span class="token keyword">int</span> get<span class="token punctuation">;</span>
        rq<span class="token operator">-&gt;</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>get<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.处理数据</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Consumer get :"</span> <span class="token operator">&lt;&lt;</span> get <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token comment">//usleep(110000);</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread started ---pid:"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">srand</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    RingQueue<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token operator">*</span>rq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-function"><span class="token function">RingQueue</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建线程</span>
    pthread_t p<span class="token punctuation">,</span> c<span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> Product<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> Consume<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"队列内数据个数:"</span> <span class="token operator">&lt;&lt;</span> rq<span class="token operator">-&gt;</span><span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 等待线程</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"main thread started ---pid:"</span> <span class="token operator">&lt;&lt;</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token function">srand</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    RingQueue<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token operator">*</span>rq <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-function"><span class="token function">RingQueue</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建多个生产者消费者</span>
    pthread_t p1<span class="token punctuation">,</span> c1<span class="token punctuation">;</span>
    pthread_t p2<span class="token punctuation">,</span> c2<span class="token punctuation">;</span>
    pthread_t p3<span class="token punctuation">,</span> c3<span class="token punctuation">;</span>
    pthread_t p4<span class="token punctuation">,</span> c4<span class="token punctuation">;</span>

    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> Product<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> Product<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> Product<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> Product<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> Consume<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> Consume<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> Consume<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>c4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> Consume<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>rq<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"队列内数据个数:"</span> <span class="token operator">&lt;&lt;</span> rq<span class="token operator">-&gt;</span><span class="token function">GetSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 等待线程</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>p2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>p3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>p4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pthread_join</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>c2<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>c3<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pthread_join</span><span class="token punctuation">(</span>c4<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 测试单生产单消费</span>
    <span class="token comment">//  test1();</span>

    <span class="token comment">// 测试多生产多消费</span>
    <span class="token function">test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <p>
     <strong>
      完~
      <br/>
      转载请注明出处
     </strong>
    </p>
    <hr/>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/fcd257414def4580ad579a5ee589f7a4.png#pic_center"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330315f37393436353338382f:61727469636c652f64657461696c732f313436313830353038" class_="artid" style="display:none">
 </p>
</div>


