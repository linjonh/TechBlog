---
layout: post
title: "乐观锁与悲观锁-学习笔记"
date: 2025-03-14 13:21:15 +0800
description: "悲观锁：假设冲突是常态，因此在操作数据时直接加锁，直到操作完成才释放锁。乐观锁：假设冲突是少数情况，因此在操作数据时不加锁，但在更新数据时检查数据是否被其他操作修改。悲观锁（Pessimistic Locking）是一种基于“悲观”假设的锁机制。它认为在并发环境中，数据冲突是常态，因此在操作数据时会先加锁，直到操作完成才会释放锁。这种方式类似于传统的关系型数据库中的锁机制，通过锁来防止其他线程或事务对数据的并发访问。"
keywords: "乐观锁与悲观锁 学习笔记"
categories: ['未分类']
tags: ['Java']
artid: "146255070"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146255070
    alt: "乐观锁与悲观锁-学习笔记"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146255070
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146255070
cover: https://bing.ee123.net/img/rand?artid=146255070
image: https://bing.ee123.net/img/rand?artid=146255070
img: https://bing.ee123.net/img/rand?artid=146255070
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     乐观锁与悲观锁 学习笔记
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <br/>
    在多线程和分布式系统中，锁机制是保证数据一致性和并发控制的关键技术。乐观锁和悲观锁是两种常见的锁策略，它们在不同的场景下有着各自的优势和适用性。本文将详细介绍乐观锁和悲观锁的原理、区别以及代码示例，帮助你更好地理解和选择合适的锁机制。
    <p>
    </p>
    <h3>
     <a id="_3">
     </a>
     前言
    </h3>
    <p>
     <strong>
      悲观锁：假设冲突是常态，因此在操作数据时直接加锁，直到操作完成才释放锁。
      <br/>
      乐观锁：假设冲突是少数情况，因此在操作数据时不加锁，但在更新数据时检查数据是否被其他操作修改。
     </strong>
    </p>
    <h3>
     <a id="_6">
     </a>
     一、悲观锁
    </h3>
    <h4>
     <a id="11__8">
     </a>
     1.1 悲观锁的定义
    </h4>
    <p>
     悲观锁（Pessimistic Locking）是一种基于“悲观”假设的锁机制。它认为在并发环境中，数据冲突是常态，因此在操作数据时会先加锁，直到操作完成才会释放锁。这种方式类似于传统的关系型数据库中的锁机制，通过锁来防止其他线程或事务对数据的并发访问。
    </p>
    <h4>
     <a id="12__11">
     </a>
     1.2 悲观锁的实现方式
    </h4>
    <p>
     悲观锁可以通过数据库的锁机制（如行锁、表锁）或编程语言中的锁（如 Java 中的 synchronized 或 ReentrantLock）来实现。
    </p>
    <h5>
     <a id="_1_Java__synchronized__14">
     </a>
     示例 1：使用 Java 的 synchronized 实现悲观锁
    </h5>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PessimisticLockExample</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 使用 synchronized 方法锁</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> temp <span class="token operator">=</span> count<span class="token punctuation">;</span>
        temp <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        count <span class="token operator">=</span> temp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">PessimisticLockExample</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PessimisticLockExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建多个线程模拟并发</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    example<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待线程执行完成</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Final count: "</span> <span class="token operator">+</span> example<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="_2_48">
     </a>
     示例 2：使用数据库的悲观锁
    </h5>
    <p>
     在 SQL 中，可以通过
     <code>
      SELECT ... FOR UPDATE
     </code>
     语句实现悲观锁，锁定目标行，防止其他事务修改。
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- 假设有一个表 `account`</span>
<span class="token keyword">BEGIN</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>

<span class="token comment">-- 锁定目标行</span>
<span class="token keyword">SELECT</span> balance <span class="token keyword">FROM</span> account <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span><span class="token punctuation">;</span>

<span class="token comment">-- 更新余额</span>
<span class="token keyword">UPDATE</span> account <span class="token keyword">SET</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">100</span> <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="13__63">
     </a>
     1.3 悲观锁的优缺点
    </h4>
    <ul>
     <li>
      <strong>
       优点
      </strong>
      ：
      <ul>
       <li>
        能够有效防止数据冲突，保证数据一致性。
       </li>
       <li>
        适合写操作频繁的场景。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       缺点
      </strong>
      ：
      <ul>
       <li>
        锁的开销较大，可能导致性能瓶颈。
       </li>
       <li>
        容易出现死锁问题。
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="_71">
     </a>
     二、乐观锁
    </h3>
    <h4>
     <a id="21__73">
     </a>
     2.1 乐观锁的定义
    </h4>
    <p>
     乐观锁（Optimistic Locking）基于“乐观”假设，认为在大多数情况下，数据冲突是很少发生的。因此，它不会在操作数据时直接加锁，而是通过版本号（Version Number）或时间戳（Timestamp）来检测数据是否被其他线程修改。
    </p>
    <h4>
     <a id="22__76">
     </a>
     2.2 乐观锁的实现方式
    </h4>
    <p>
     乐观锁通常通过以下两种方式实现：
    </p>
    <ol>
     <li>
      <strong>
       基于版本号（Version Number）
      </strong>
      ：每次更新数据时，版本号加一，更新时检查版本号是否一致。
     </li>
     <li>
      <strong>
       基于时间戳（Timestamp）
      </strong>
      ：记录数据的最后修改时间戳，更新时检查时间戳是否被修改。
     </li>
    </ol>
    <h5>
     <a id="_1_81">
     </a>
     示例 1：基于版本号的乐观锁
    </h5>
    <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OptimisticLockExample</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> version <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> currentVersion <span class="token operator">=</span> version<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> temp <span class="token operator">=</span> count<span class="token punctuation">;</span>
            temp <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>

            <span class="token comment">// 检查版本号是否被其他线程修改</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>version<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>currentVersion<span class="token punctuation">,</span> currentVersion <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                count <span class="token operator">=</span> temp<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 如果版本号被修改，重新获取版本号并重试</span>
                currentVersion <span class="token operator">=</span> version<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">OptimisticLockExample</span> example <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OptimisticLockExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建多个线程模拟并发</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    example<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 等待线程执行完成</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Final count: "</span> <span class="token operator">+</span> example<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="_2_128">
     </a>
     示例 2：基于时间戳的乐观锁
    </h5>
    <p>
     在数据库中，可以通过记录时间戳来实现乐观锁。
    </p>
    <pre><code class="prism language-sql"><span class="token comment">-- 假设有一个表 `account`，包含 `balance` 和 `last_modified` 时间戳字段</span>
<span class="token keyword">BEGIN</span> <span class="token keyword">TRANSACTION</span><span class="token punctuation">;</span>

<span class="token comment">-- 获取当前行的版本信息</span>
<span class="token keyword">SELECT</span> balance<span class="token punctuation">,</span> last_modified <span class="token keyword">FROM</span> account <span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">-- 更新余额并检查时间戳</span>
<span class="token keyword">UPDATE</span> account 
<span class="token keyword">SET</span> balance <span class="token operator">=</span> balance <span class="token operator">+</span> <span class="token number">100</span><span class="token punctuation">,</span> last_modified <span class="token operator">=</span> <span class="token function">NOW</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">WHERE</span> id <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">AND</span> last_modified <span class="token operator">=</span> <span class="token string">'2025-03-14 10:00:00'</span><span class="token punctuation">;</span>

<span class="token keyword">COMMIT</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="23__145">
     </a>
     2.3 乐观锁的优缺点
    </h4>
    <ul>
     <li>
      <strong>
       优点
      </strong>
      ：
      <ul>
       <li>
        减少了锁的开销，提高了系统性能。
       </li>
       <li>
        适合读多写少的场景。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       缺点
      </strong>
      ：
      <ul>
       <li>
        在高并发写操作场景下，可能会导致大量重试，性能下降。
       </li>
       <li>
        实现相对复杂，需要额外的版本号或时间戳字段。
       </li>
      </ul>
     </li>
    </ul>
    <h3>
     <a id="_153">
     </a>
     三、乐观锁与悲观锁的选择
    </h3>
    <p>
     选择乐观锁还是悲观锁，需要根据具体的业务场景来决定：
    </p>
    <ol>
     <li>
      <strong>
       读多写少的场景
      </strong>
      ：优先选择乐观锁，因为它减少了锁的开销，提高了性能。
     </li>
     <li>
      <strong>
       写操作频繁的场景
      </strong>
      ：优先选择悲观锁，因为它能够有效防止数据冲突。
     </li>
     <li>
      <strong>
       对性能要求极高的场景
      </strong>
      ：可以尝试使用乐观锁，但需要仔细评估重试机制对性能的影响。
     </li>
    </ol>
    <h3>
     <a id="_160">
     </a>
     四、总结
    </h3>
    <p>
     乐观锁和悲观锁是并发控制中的两种重要策略。悲观锁通过加锁来防止数据冲突，适合写操作频繁的场景；乐观锁通过版本号或时间戳来检测数据冲突，适合读多写少的场景。在实际开发中，我们需要根据业务需求和性能要求，合理选择锁机制，以实现高效且可靠的并发控制。
    </p>
    <p>
     希望本文对大家理解乐观锁和悲观锁有所帮助。如果你有任何疑问或建议，欢迎在评论区留言交流。
    </p>
    <hr/>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f37323638363139362f:61727469636c652f64657461696c732f313436323535303730" class_="artid" style="display:none">
 </p>
</div>


