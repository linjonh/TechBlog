---
layout: post
title: "kong搭建一套微信小程序的公司研发环境"
date: 2025-03-14 10:23:39 +0800
description: "本文通过图文的方式，把微信小程序的公司研发环境搭建整过程详细描述，使用到的api网关是kong。如果是其他网关，原理大同，见文章最开头的架构图。另外，你需要知道公司研发环境的网络相关知识，比如外网和内网的端口映射应该如何做。"
keywords: "kong搭建一套微信小程序的公司研发环境"
categories: ['未分类']
tags: ['微信小程序', '小程序', '后端', 'Kong', 'Java']
artid: "146203976"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146203976
    alt: "kong搭建一套微信小程序的公司研发环境"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146203976
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146203976
cover: https://bing.ee123.net/img/rand?artid=146203976
image: https://bing.ee123.net/img/rand?artid=146203976
img: https://bing.ee123.net/img/rand?artid=146203976
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     kong搭建一套微信小程序的公司研发环境
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     一、物理架构
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e6062f6c213a49fc8ff5496b7e4e7f10.png"/>
    </p>
    <p>
     微信小程序H5部署在微信公众平台，需要通过外网域名访问到公司机房。
    </p>
    <p>
     为了区分生产和研发环境，需要创建两个外网域名。
    </p>
    <p>
     另外，微信小程序需要配置业务域名, 请参考文章-
     <a href="https://blog.csdn.net/zhuganlai168/article/details/145554565">
      微信小程序的业务域名配置（通过kong网关的pre-function配置）
     </a>
    </p>
    <p>
     本文试着图文结合的方式，把整个流程要做的事项梳理出来，以供参考。
    </p>
    <h2>
     <a id="_11">
     </a>
     二、新建外网域名
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f7c91b51402c44519003d90c2dca4c63.png">
      <br/>
      无论是研发环境域名，还是正式环境域名，均指向IDC的kong。
     </img>
    </p>
    <p>
     研发环境的搭建，相当于是把正式环境一拆为二，一部分配置在IDC kong，另一部分配置在公司研发环境 kong。
    </p>
    <p>
     接下来就详细说一说kong应该如何配置路由及upstream。
    </p>
    <h2>
     <a id="kong_route__20">
     </a>
     三、kong route 路由配置
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9818e6746fde4a3a90609673edfa7a29.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8c0fec9b89314d13b9b49ca0afb35cc6.png">
       <br/>
       Hosts 填写测试外网域名，指向公司研发环境。
      </img>
     </img>
    </p>
    <h2>
     <a id="kong_upstream__26">
     </a>
     四、kong upstream 配置
    </h2>
    <p>
     填写公司研发环境的外网出口IP及端口， 此端口6008映射到公司研发环境下的kong_80端口。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/77a2cb1ea0ca42f89618bf6207c7093e.png">
      <br/>
      回过头说一下，Kong service的配置，有一个地方需要和这里的upstream名称保持一致。
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/921507db30d247ffa37bbdb967539b76.png">
      <br/>
      至此，当用户访问测试外网域名的时候，请求将转发至公司研发环境kong上。
     </img>
    </p>
    <p>
     下面，我们将说明公司研发环境应该如何配置kong。
    </p>
    <h2>
     <a id="Kong_36">
     </a>
     五、公司研发环境Kong
    </h2>
    <ul>
     <li>
      service配置，Host填写upstream名称，默认所有的请求都将转发至该upstream的意思
     </li>
     <li>
      upstream配置，跟普通的服务一样，填写内网IP和端口
     </li>
     <li>
      route配置，是我们的重点，详细见下文
     </li>
    </ul>
    <p>
     前文也说了，公司研发环境下，暴露的外网端口是6008，它将指向Kong。
     <br/>
     但是，当有多个域名都想要指向公司研发的kong时，为了区分不同的路由，所以在Path增加不同的前缀。
    </p>
    <p>
     比如说，122.220.130.109/user 指向 kong 的 user-service（kong service的名称），
     <br/>
     现在新增了一个product-service（kong service的名称），
     <br/>
     在外网地址相同且只有一个的情况下，product-service的路由地址就不能是122.220.130.109/user，而应该是122.220.130.109/product。
    </p>
    <p>
     这样，通过path的不同，把同一个外网地址，路由到不同的service下。
    </p>
    <p>
     对于外网来说，公司研发环境kong就只有一个外网地址，它就是122.220.130.109。
     <br/>
     理解了这一层，下面的路由创建就容易理解了。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9c8cecb0c3d9457db4501fe8b5101561.png">
      <br/>
      测试验证方法，curl某个接口，比如curl http://122.220.130.109:6008/dev/api/v1/pub/userId/1001/info
     </img>
    </p>
    <p>
     如果是通的，说明公司研发环境下的路由没问题。
    </p>
    <p>
     接下来就使用外网域名进一步验证：
    </p>
    <p>
     还是curl同一个接口，比如curl http://xxx-test.edu.net/dev/api/v1/pub/userId/1001/info
    </p>
    <p>
     如果是通的，才说明整个链路畅通。
    </p>
    <p>
     除了创建这个接口路由，还需创建一个路由，用于配置业务域名。（前文已提及，这里就不赘述）
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/efc3c48b11c943aeae0273a648c971e9.png"/>
    </p>
    <h2>
     <a id="_67">
     </a>
     六、总结
    </h2>
    <p>
     本文通过图文的方式，把微信小程序的公司研发环境搭建整过程详细描述，使用到的api网关是kong。
     <br/>
     如果是其他网关，原理大同，见文章最开头的架构图。
     <br/>
     另外，你需要知道公司研发环境的网络相关知识，比如外网和内网的端口映射应该如何做。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f7a687567616e6c61693136382f:61727469636c652f64657461696c732f313436323033393736" class_="artid" style="display:none">
 </p>
</div>


