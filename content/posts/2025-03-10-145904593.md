---
layout: post
title: "WPFåœ¨System.Drawing.Rectangleä¸­é™åˆ¶é¼ æ ‡ä¿æŒåœ¨Rectangleä¸­ç§»åŠ¨"
date: 2025-03-10 18:46:35 +0800
description: "ã€WPFã€‘åœ¨System.Drawing.Rectangleä¸­é™åˆ¶é¼ æ ‡ä¿æŒåœ¨Rectangleä¸­ç§»åŠ¨ï¼Ÿ"
keywords: "é¼ æ ‡ç‚¹å‡»ä¼šæœ‰æ¡†æ¡† wpf"
categories: ['Wpf', 'C']
tags: ['Wpf', 'C']
artid: "145904593"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145904593
    alt: "WPFåœ¨System.Drawing.Rectangleä¸­é™åˆ¶é¼ æ ‡ä¿æŒåœ¨Rectangleä¸­ç§»åŠ¨"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145904593
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145904593
cover: https://bing.ee123.net/img/rand?artid=145904593
image: https://bing.ee123.net/img/rand?artid=145904593
img: https://bing.ee123.net/img/rand?artid=145904593
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     ã€WPFã€‘åœ¨System.Drawing.Rectangleä¸­é™åˆ¶é¼ æ ‡ä¿æŒåœ¨Rectangleä¸­ç§»åŠ¨ï¼Ÿ
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h2>
     æ–¹æ¡ˆä¸€ï¼Œåœ¨OnMouseMoveæ–¹æ³•é™åˆ¶
    </h2>
    <p>
     åœ¨WPFåº”ç”¨ç¨‹åºä¸­ï¼Œé¼ æ ‡åœ¨ç§»åŠ¨è¿‡ç¨‹ä¸­ä¿æŒåœ¨è¿™ä¸ªçŸ©å½¢åŒºåŸŸå†…ï¼Œå¯ä»¥é€šè¿‡ç›‘å¬é¼ æ ‡çš„ç§»åŠ¨äº‹ä»¶å¹¶æ ¹æ®é¼ æ ‡çš„å½“å‰ä½ç½®è°ƒæ•´å…¶åæ ‡æ¥å®ç°ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒWPFåŸç”Ÿä½¿ç”¨çš„æ˜¯
     <code>
      System.Windows.Rect
     </code>
     è€Œä¸æ˜¯
     <code>
      System.Drawing.Rectangle
     </code>
     ï¼Œæ‰€ä»¥åœ¨å®é™…åº”ç”¨æ—¶å¯èƒ½éœ€è¦åšä¸€äº›è½¬æ¢ã€‚
    </p>
    <p>
     åŸºæœ¬çš„å®ç°æ€è·¯ï¼š
    </p>
    <ol>
     <li>
      <p>
       <strong>
        ç›‘å¬é¼ æ ‡ç§»åŠ¨äº‹ä»¶
       </strong>
       ï¼šé¦–å…ˆä½ éœ€è¦ç›‘å¬é¼ æ ‡çš„ç§»åŠ¨äº‹ä»¶ã€‚å¯ä»¥é€šè¿‡ç»™ç›¸åº”çš„UIå…ƒç´ ï¼ˆä¾‹å¦‚ä¸€ä¸ªCanvasæˆ–è€…Gridï¼‰æ·»åŠ MouseMoveäº‹ä»¶å¤„ç†å™¨æ¥å®ç°ã€‚
      </p>
     </li>
     <li>
      <p>
       <strong>
        æ£€æŸ¥é¼ æ ‡ä½ç½®
       </strong>
       ï¼šåœ¨MouseMoveäº‹ä»¶å¤„ç†å™¨ä¸­ï¼Œè·å–é¼ æ ‡çš„å½“å‰ä½ç½®ï¼Œå¹¶å°†å…¶ä¸ä½ çš„Rectangleè¿›è¡Œæ¯”è¾ƒã€‚
      </p>
     </li>
     <li>
      <p>
       <strong>
        é™åˆ¶é¼ æ ‡ä½ç½®
       </strong>
       ï¼šå¦‚æœé¼ æ ‡çš„å½“å‰ä½ç½®è¶…å‡ºäº†Rectangleçš„è¾¹ç•Œï¼Œåˆ™æ‰‹åŠ¨è®¾ç½®é¼ æ ‡çš„åæ ‡ä¸ºæœ€è¿‘çš„è¾¹ç•Œå€¼ã€‚ç„¶è€Œï¼Œåœ¨WPFä¸­ç›´æ¥è®¾ç½®é¼ æ ‡çš„å±å¹•ä½ç½®å¹¶ä¸ç›´è§‚ï¼Œå› ä¸ºWPFæ›´ä¾§é‡äºç›¸å¯¹ä½ç½®è€Œéç»å¯¹å±å¹•åæ ‡ã€‚å› æ­¤ï¼Œé€šå¸¸çš„åšæ³•æ˜¯è°ƒæ•´å¯äº¤äº’å…ƒç´ çš„ä½ç½®æˆ–å¤§å°ï¼Œè€Œä¸æ˜¯ç›´æ¥æ§åˆ¶é¼ æ ‡çš„å±å¹•ä½ç½®ã€‚
      </p>
     </li>
    </ol>
    <p>
     è€ƒè™‘åˆ°ä¸Šè¿°æƒ…å†µï¼Œè¿™é‡Œæä¾›ä¸€ç§é—´æ¥æ–¹æ³•æ¥è¾¾åˆ°ç±»ä¼¼æ•ˆæœï¼Œå³ç¡®ä¿æŸä¸ªå¯æ‹–åŠ¨å…ƒç´ åœ¨æŒ‡å®šçš„Rectangleå†…ç§»åŠ¨ï¼š
    </p>
    <pre><code class="language-cs">private void OnMouseMove(object sender, MouseEventArgs e)
{
    var pos = e.GetPosition(this); // è·å–é¼ æ ‡ç›¸å¯¹äºå½“å‰å…ƒç´ çš„ä½ç½®

    // å‡è®¾ä½ æœ‰ä¸€ä¸ªåä¸ºrectçš„System.Drawing.Rectangleå¯¹è±¡
    // éœ€è¦å…ˆè½¬æ¢æˆSystem.Windows.Rectï¼Œå› ä¸ºä½ æ­£åœ¨WPFç¯å¢ƒä¸­å·¥ä½œ
    System.Windows.Rect wpfRect = new System.Windows.Rect(rect.X, rect.Y, rect.Width, rect.Height);

    if (!wpfRect.Contains(pos))
    {
        // å¦‚æœé¼ æ ‡è¶…å‡ºèŒƒå›´ï¼Œè°ƒæ•´é¼ æ ‡ç›¸å…³çš„é€»è¾‘æˆ–å…ƒç´ çš„ä½ç½®
        // ä¾‹å¦‚ï¼Œå¦‚æœæ˜¯æ‹–åŠ¨å…ƒç´ ï¼Œå¯ä»¥åœ¨è¿™é‡Œè°ƒæ•´å…ƒç´ çš„ä½ç½®ä»¥ä¿è¯å®ƒä¸è¶…å‡ºé™å®šåŒºåŸŸ
        double newX = Math.Max(wpfRect.Left, Math.Min(pos.X, wpfRect.Right));
        double newY = Math.Max(wpfRect.Top, Math.Min(pos.Y, wpfRect.Bottom));

        // æ›´æ–°ä½ çš„é€»è¾‘ï¼Œæ¯”å¦‚æ›´æ–°è¢«æ‹–åŠ¨å…ƒç´ çš„ä½ç½®
        yourElement.SetValue(Canvas.LeftProperty, newX);
        yourElement.SetValue(Canvas.TopProperty, newY);
    }
}</code></pre>
    <p>
     è¿™æ®µä»£ç ç¤ºä¾‹å±•ç¤ºäº†å¦‚ä½•åœ¨é¼ æ ‡ç§»åŠ¨æ—¶ï¼Œé™åˆ¶æŸä¸ªå…ƒç´ çš„ä½ç½®åœ¨ç‰¹å®šçš„çŸ©å½¢åŒºåŸŸå†…ã€‚è¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ä»£ç ä¸­çš„ç»†èŠ‚ï¼Œå¦‚æ›¿æ¢
     <code>
      yourElement
     </code>
     ä¸ºå®é™…ä½¿ç”¨çš„UIå…ƒç´ ç­‰ã€‚æ³¨æ„ï¼Œè¿™ç§æ–¹æ³•å¹¶æ²¡æœ‰ç›´æ¥é™åˆ¶é¼ æ ‡çš„ç§»åŠ¨ï¼Œè€Œæ˜¯é€šè¿‡è°ƒæ•´UIå…ƒç´ çš„ä½ç½®æ¥æ¨¡æ‹Ÿè¿™ç§æ•ˆæœã€‚
    </p>
    <h2>
     æ–¹æ¡ˆäºŒï¼Œä½¿ç”¨ç³»ç»Ÿçº§API
    </h2>
    <p>
     åœ¨WPFä¸­å®ç°é¼ æ ‡é™åˆ¶åœ¨æŒ‡å®šåŒºåŸŸå†…çš„æŠ€æœ¯æ–¹æ¡ˆï¼š
    </p>
    <p>
     å…³é”®å®ç°è¦ç‚¹ï¼š
    </p>
    <ol>
     <li>
      â€Œ
      <strong>
       Win32 APIè°ƒç”¨
      </strong>
      â€Œï¼šé€šè¿‡
      <code>
       GetCursorPos
      </code>
      å’Œ
      <code>
       SetCursorPos
      </code>
      å®ç°é¼ æ ‡ä½ç½®æ§åˆ¶
     </li>
     <li>
      â€Œ
      <strong>
       åæ ‡è½¬æ¢
      </strong>
      â€Œï¼šä½¿ç”¨
      <code>
       PointToScreen
      </code>
      å¤„ç†WPFæ§ä»¶åˆ°å±å¹•åæ ‡çš„è½¬æ¢
     </li>
     <li>
      â€Œ
      <strong>
       åŠ¨æ€é™åˆ¶
      </strong>
      â€Œï¼šåœ¨
      <code>
       CompositionTarget.Rendering
      </code>
      äº‹ä»¶ä¸­æŒç»­æ£€æµ‹ï¼ˆçº¦60fpsï¼‰
     </li>
     <li>
      â€Œ
      <strong>
       è¾¹ç•Œå¤„ç†
      </strong>
      â€Œï¼šä½¿ç”¨
      <code>
       Math.Clamp
      </code>
      ç¡®ä¿é¼ æ ‡ä¸è¶…å‡ºçŸ©å½¢åŒºåŸŸ
     </li>
    </ol>
    <p>
     âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
    </p>
    <ul>
     <li>
      éœ€è¦å¼•ç”¨
      <code>
       System.Drawing
      </code>
      ç¨‹åºé›†
     </li>
     <li>
      é«˜DPIç¯å¢ƒä¸‹éœ€å¤„ç†ç¼©æ”¾ï¼š
      <code>
       PresentationSource.FromVisual(this).CompositionTarget.TransformToDevice
      </code>
     </li>
     <li>
      ç»“æŸé™åˆ¶åéœ€è§£é™¤äº‹ä»¶ç»‘å®šï¼š
      <code>
       CompositionTarget.Rendering -= OnRenderingFrame
      </code>
     </li>
     <li>
      ç®¡ç†å‘˜æƒé™å¯èƒ½éœ€è¦ï¼ˆå–å†³äºç³»ç»ŸUACè®¾ç½®ï¼‰
     </li>
    </ul>
    <p>
     ğŸ”„ æ‰©å±•å»ºè®®ï¼š
    </p>
    <ul>
     <li>
      æ·»åŠ å¯ç”¨/ç¦ç”¨é”å®šå¼€å…³
     </li>
     <li>
      æ”¯æŒå¤šæ˜¾ç¤ºå™¨ç¯å¢ƒä¸‹çš„åæ ‡è®¡ç®—
     </li>
     <li>
      ä½¿ç”¨
      <code>
       ClipCursor
      </code>
      APIå®ç°æ›´ä¸¥æ ¼çš„é™åˆ¶ï¼ˆéœ€é…åˆ
      <code>
       RECT
      </code>
      ç»“æ„ï¼‰
     </li>
    </ul>
    <p>
     æ­¤æ–¹æ¡ˆé€šè¿‡ç³»ç»Ÿçº§APIå®ç°ç²¾å‡†çš„é¼ æ ‡é™åˆ¶ï¼Œé€‚ç”¨äºéœ€è¦ä¸¥æ ¼è¾“å…¥æ§åˆ¶çš„åœºæ™¯ï¼ˆå¦‚å…¨å±åº”ç”¨ã€æ¸¸æˆç­‰ï¼‰ã€‚
    </p>
    <pre><code class="language-cs">using System;
using System.Drawing; // æ³¨æ„ï¼šSystem.Drawingéœ€è¦å¼•ç”¨ç¨‹åºé›†
using System.Runtime.InteropServices;
using System.Windows;
using System.Windows.Input;

public class MouseLocker
{
    [DllImport("user32.dll")]
    private static extern bool GetCursorPos(out POINT lpPoint);

    [DllImport("user32.dll")]
    private static extern bool SetCursorPos(int x, int y);

    private struct POINT
    {
        public int X;
        public int Y;
    }

    // æ ¸å¿ƒé™åˆ¶é€»è¾‘
    public static void LockMouseInRectangle(Rectangle bounds)
    {
        POINT currentPos;
        GetCursorPos(out currentPos);

        int clampedX = Math.Clamp(currentPos.X, bounds.Left, bounds.Right);
        int clampedY = Math.Clamp(currentPos.Y, bounds.Top, bounds.Bottom);

        if (currentPos.X != clampedX || currentPos.Y != clampedY)
        {
            SetCursorPos(clampedX, clampedY);
        }
    }

    // WPFåæ ‡è½¬æ¢è¾…åŠ©æ–¹æ³•
    public static Rectangle ConvertWpfRectToScreen(Rect wpfRect, Window window)
    {
        Point screenTopLeft = window.PointToScreen(new Point(wpfRect.Left, wpfRect.Top));
        Point screenBottomRight = window.PointToScreen(new Point(wpfRect.Right, wpfRect.Bottom));

        return new Rectangle(
            (int)screenTopLeft.X,
            (int)screenTopLeft.Y,
            (int)(screenBottomRight.X - screenTopLeft.X),
            (int)(screenBottomRight.Y - screenTopLeft.Y));
    }
}

// ä½¿ç”¨ç¤ºä¾‹ï¼š
public partial class MainWindow : Window
{
    private Rectangle _lockArea;

    public MainWindow()
    {
        InitializeComponent();
        CompositionTarget.Rendering += OnRenderingFrame;
    }

    private void OnRenderingFrame(object sender, EventArgs e)
    {
        // å°†WPFæ§ä»¶ï¼ˆä¾‹å¦‚canvasï¼‰çš„åæ ‡è½¬æ¢ä¸ºå±å¹•çŸ©å½¢
        Rect controlRect = new Rect(Canvas.GetLeft(myCanvas), Canvas.GetTop(myCanvas), 
                                  myCanvas.ActualWidth, myCanvas.ActualHeight);
        
        _lockArea = MouseLocker.ConvertWpfRectToScreen(controlRect, this);
        MouseLocker.LockMouseInRectangle(_lockArea);
    }
}
</code></pre>
    <p>
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f77616e676e61697368656e672f:61727469636c652f64657461696c732f313435393034353933" class_="artid" style="display:none">
 </p>
</div>


