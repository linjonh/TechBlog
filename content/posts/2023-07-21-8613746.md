---
layout: post
title: "cocos2d-x实现游戏剧情对话打字效果"
date: 2023-07-21 15:15:33 +0800
description: "本文介绍如何使用Cocos2d-x 2.0.4版本在游戏中实现对话的打字效果，并自动换行。通过解析X"
keywords: "游戏剧情自动打字中文和英文的区别"
categories: ['X']
tags: ['无标签']
artid: "8613746"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=8613746
    alt: "cocos2d-x实现游戏剧情对话打字效果"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=8613746
featuredImagePreview: https://bing.ee123.net/img/rand?artid=8613746
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     cocos2d-x实现游戏剧情对话——打字效果
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     <br/>
     <span style="white-space:pre">
     </span>
    </p>
    <p>
    </p>
    <p align="left">
     <span style="color:silver">
      cocos2d-x
     </span>
     <span style="color:silver">
      版本
     </span>
     <span style="color:silver">
      2.0.4
     </span>
    </p>
    <p align="left">
     做RPG游戏的时候会有剧情对，中英文混搭，要求打字效果，一个字一个字的往出蹦。
    </p>
    <p align="left">
     先看一下xml文件
    </p>
    <p align="left">
    </p>
    <pre><code class="language-html">&lt;?xml version="1.0" encoding="UTF-8"?&gt;

&lt;plist version="1.0"&gt;
  &lt;talk anchor="0" icon="talk/icon.png" name="路人甲：" content="  听说他已经30了。"/&gt;
  &lt;talk anchor="1" icon="talk/icon.png" name="路人乙：" content="  是啊！都30了还叫to3（奔三），装嫩呢！"/&gt;
  &lt;talk anchor="0" icon="talk/icon.png" name="路人甲：" content="  哈哈哈……"/&gt;
&lt;/plist&gt;
</code></pre>
    <br/>
    <p align="left">
     anchor：对齐方式 0左 1右
    </p>
    <p>
     <br/>
     <br/>
    </p>
    <p align="left">
     创建一个对话映射的节点TalkNode
    </p>
    <p align="left">
    </p>
    <p align="left">
    </p>
    <pre><code class="language-cpp">class TalkNode
{
public:
        bool anchor;
        std::string icon;
        std::string name;
        std::string content;
        void init(TiXmlNode *node);
        bool getAnchor(){return anchor;};
        const char* getIcon(){returnicon.c_str();};
        const char* getName(){returnname.c_str();};
        const char* getContent(){returncontent.c_str();};
        std::string getContentByLength(intlength);
        int contentLeght;
        int getContentLength();
};</code></pre>
    <p>
     <br/>
    </p>
    <p align="left">
     再看TalkNode的实现
    </p>
    <p align="left">
    </p>
    <pre><code class="language-cpp">voidTalkNode::init(TiXmlNode *node)
{
        TiXmlElement *element =node-&gt;ToElement();
 
        int intValue;
        if(element-&gt;QueryIntAttribute("anchor", &amp;intValue) ==TIXML_SUCCESS)
        {
               anchor = intValue;
        }
        else
        {
               anchor = false;
        }
       
        name =element-&gt;Attribute("name");
        icon =element-&gt;Attribute("icon");
        content =element-&gt;Attribute("content");
        contentLeght = 0;
 
        int length = content.length();
        int i = 0;
        while(i &lt; length)
        {
               char ch = getContent()[i];
               //重点在这里
               //中文在ASCII码中是-127~0
               if (ch &gt; -127 &amp;&amp; ch&lt; 0)
               {
                       //这里为什么+＝3呢
                       //因为一个中文占3个字节
                       i+=3;
               }
               else
               {
                       i++;
               }
               contentLeght++;
        }
}
//获取内容的总长度
int TalkNode::getContentLength()
{
	return contentLeght;
}

//返回所需长度的字符串
std::string TalkNode::getContentByLength(int length)
{
	if (length &gt;= contentLeght)
	{
		return getContent();
	}
	int i = 0;
	int index = 0;
	while(index &lt; length)
	{
		char ch = getContent()[i];
		//这里上面说过了
		if (ch &gt; -127 &amp;&amp; ch &lt; 0)
		{
			i+=3;
		}
		else
		{
			i++;
		}
		index++;
	}

	//截取strng
	std::string str = content.substr(0, i);
	return str;
}</code></pre>
    <br/>
    <p align="left">
     有同学会问TiXmlElement是哪来的？ to3是用的tinyxml解析xml，度娘可以找的到。
    </p>
    <p align="left">
     下面看一下to3的读取xml的函数
    </p>
    <p align="left">
    </p>
    <pre><code class="language-cpp">std::vector &lt;TalkNode*&gt; talkList;
void Talking::readXml(const char *filename)
{
	unsigned long filesize;
	const char *path = CCFileUtils::sharedFileUtils()-&gt;fullPathFromRelativePath(filename);
	char *buffer = (char *)CCFileUtils::sharedFileUtils()-&gt;getFileData(path, "rb", &amp;filesize);


	if (buffer == NULL)
	{
		return;
	}

	TiXmlDocument doc;
	doc.Parse(buffer);
	TiXmlNode *root = doc.FirstChild("plist"); 

	if (root)
	{
		TiXmlElement *element = root-&gt;ToElement();
		for (TiXmlNode* entityNode = root-&gt;FirstChild(); entityNode; entityNode = entityNode-&gt;NextSibling())
		{
			TalkNode *node= new TalkNode();
			node-&gt;init(entityNode);
			talkList.push_back(node);
		}
		talkCount = talkList.size();
	}
}</code></pre>
    <br/>
    <br/>
    <br/>
    <p>
    </p>
    <p align="left">
     到这里就可以实现打字效果了，但我们还得自动换行，这个cocos2d-x的CCLabelTTF有提供这个API
    </p>
    <p align="left">
     CCLabelTTF * CCLabelTTF::create(const char *string, const char *fontName, float fontSize,  const CCSize&amp; dimensions, CCTextAlignment hAlignment);
     <br/>
    </p>
    <p align="left">
     string：内容
     <br/>
    </p>
    <p align="left">
     fontName：字体
     <br/>
    </p>
    <p align="left">
     fontSize：字号
     <br/>
    </p>
    <p align="left">
     dimensions：显示框
     <br/>
    </p>
    <p align="left">
     hAlignment：对齐方式
     <br/>
    </p>
    <p>
     <br/>
    </p>
    <p>
     最后在逻辑循环里更新你的CCLabelTTF字符串就可以了
    </p>
    <p>
    </p>
    <pre><code class="language-cpp">void Talking::logic(float cTime)
{
	TalkNode* node = (TalkNode*)talkList[talkIndex];
	if (wordCount &gt; node-&gt;getContentLength())
	{
		return;
	}


	wordCount++;
	CCLabelTTF* label = (CCLabelTTF*)this-&gt;getChildByTag(kTalkingLabelTag);
	label-&gt;setString(node-&gt;getContentByLength(wordCount).c_str());
}</code></pre>
    <p>
     再加上点击屏幕显示全部内容
    </p>
    <p>
    </p>
    <pre><code class="language-cpp">bool Talking::ccTouchBegan(CCTouch *pTouch, CCEvent *pEvent)
{
	TalkNode* node = (TalkNode*)talkList[talkIndex];
	if (wordCount &lt; node-&gt;getContentLength())
	{
		wordCount = node-&gt;getContentLength();
	}
	
	return true;
}</code></pre>
    <br/>
    <br/>
    <p>
    </p>
    <p>
     <br/>
    </p>
    <p>
     附上效果图两张
    </p>
    <p>
    </p>
    <p>
     <img alt="" src="https://img-my.csdn.net/uploads/201302/26/1361867490_9062.png">
      <br/>
     </img>
    </p>
    <p>
     <br/>
    </p>
    <p>
     <img alt="" src="https://img-my.csdn.net/uploads/201302/26/1361867527_6104.png">
      <br/>
     </img>
    </p>
    <p>
     <br/>
    </p>
    <p>
     <strong>
      <span style="font-size:18px; color:#cc0000; background-color:rgb(255,255,255)">
       初次写博文，有什么不对的地方请指正，谢谢！
      </span>
     </strong>
    </p>
    <br/>
    <br/>
   </div>
  </div>
 </article>
 <p alt="68:747470733a2f2f626c6f672e6373646e2e6e65742f6c6e736c:632f61727469636c652f64657461696c732f38363133373436" class_="artid" style="display:none">
 </p>
</div>


