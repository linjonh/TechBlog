---
layout: post
title: "慕慕手记项目日记-熟悉SQLAIChemy-ORM框架-2025-3-5"
date: 2025-03-06 16:12:52 +0800
description: "是一个功能强大的 Python，用于简化数据库操作。它提供了全套企业级持久化模式，既支持纯 SQL 开发，也支持高级 ORM 操作，是 Python 生态中最流行的数据库工具之一。"
keywords: "sqlalchemy包下载"
categories: ['慕慕手记项目日志']
tags: ['开发语言', 'Lua']
artid: "146073300"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146073300
    alt: "慕慕手记项目日记-熟悉SQLAIChemy-ORM框架-2025-3-5"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146073300
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146073300
cover: https://bing.ee123.net/img/rand?artid=146073300
image: https://bing.ee123.net/img/rand?artid=146073300
img: https://bing.ee123.net/img/rand?artid=146073300
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     慕慕手记项目日记 熟悉SQLAIChemy ORM框架 2025-3-5
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_SQLAIChemy_ORM_202535_0">
     </a>
     慕慕手记项目日记 熟悉SQLAIChemy ORM框架 2025-3-5
    </h2>
    <h2>
     <a id="SQLAIChemy_4">
     </a>
     SQLAIChemy框架
    </h2>
    <p>
     <strong>
      SQLAlchemy
     </strong>
     是一个功能强大的 Python
     <strong>
      SQL 工具包和对象关系映射（ORM）框架
     </strong>
     ，用于简化数据库操作。它提供了全套企业级持久化模式，既支持纯 SQL 开发，也支持高级 ORM 操作，是 Python 生态中最流行的数据库工具之一。
    </p>
    <h3>
     <a id="SQLAlChemy_10">
     </a>
     安装SQLAlChemy
    </h3>
    <p>
     使用以下命令进行安装
    </p>
    <pre><code class="prism language-shell">pip <span class="token function">install</span> sqlalchemy
</code></pre>
    <h3>
     <a id="postman_20">
     </a>
     安装postman
    </h3>
    <p>
     如果是win11可以使用以下命令进行安装：
    </p>
    <pre><code class="prism language-shell">winget <span class="token function">install</span> post
</code></pre>
    <p>
     也可以选择打开官网：
    </p>
    <p>
     <a href="https://www.postman.com/downloads/" rel="nofollow">
      Download Postman | Get Started for Free
     </a>
    </p>
    <p>
     进去点击下载即可。后续还需要创建账号登录，此部分省略。
    </p>
    <h3>
     <a id="_40">
     </a>
     开发用户登录功能
    </h3>
    <p>
     这个案例展示了如何使用sqlalchemy来创建基类和动态映射User表，还有创建会话对象和使用 scoped_session 确保线程安全的会话管理。最后通过postman发送测试数据，这个客户端收到json请求后会立马请求我们的mysql数据库。由于暂时使用明文存储，没有使用md5进行加密。所以省去了md5函数验证的步骤
    </p>
    <pre><code class="prism language-python"><span class="token keyword">import</span> json
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request<span class="token punctuation">,</span> jsonify
<span class="token keyword">import</span> sqlalchemy
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> Table
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>engine <span class="token keyword">import</span> create_engine
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> sessionmaker<span class="token punctuation">,</span> scoped_session<span class="token punctuation">,</span> declarative_base

<span class="token comment"># 创建 SQLAlchemy 基类，用于映射表结构</span>
Base <span class="token operator">=</span> declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment"># 创建 Flask 应用实例</span>
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token comment"># 创建数据库连接</span>
engine <span class="token operator">=</span> create_engine<span class="token punctuation">(</span><span class="token string">"mysql+pymysql://root:123456@172.27.13.88:3306/mumushouji"</span><span class="token punctuation">,</span> echo<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># 创建会话工厂</span>
session <span class="token operator">=</span> sessionmaker<span class="token punctuation">(</span>engine<span class="token punctuation">)</span>

<span class="token comment"># 使用 scoped_session 确保线程安全的会话管理</span>
db_session <span class="token operator">=</span> scoped_session<span class="token punctuation">(</span>session<span class="token punctuation">)</span>

<span class="token comment"># 定义 User 类，映射到数据库中的 USER 表</span>
<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>Base<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __table__ <span class="token operator">=</span> Table<span class="token punctuation">(</span><span class="token string">"USER"</span><span class="token punctuation">,</span> Base<span class="token punctuation">.</span>metadata<span class="token punctuation">,</span> autoload_with<span class="token operator">=</span>engine<span class="token punctuation">)</span>  <span class="token comment"># 自动加载表结构</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/login"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 建议仅保留 POST 方法</span>
<span class="token keyword">def</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    处理用户登录请求。
    
    请求方法：POST
    请求体：JSON 格式，包含 "username" 和 "password" 字段
    返回值：JSON 格式的响应，包含成功或错误信息
    """</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 获取并解析请求体中的 JSON 数据</span>
        request_data <span class="token operator">=</span> request<span class="token punctuation">.</span>get_json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> request_data<span class="token punctuation">:</span>
            <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Invalid or empty JSON"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">400</span>  <span class="token comment"># 如果 JSON 数据无效或为空，返回 400 错误</span>

        <span class="token comment"># 检查必填字段是否存在于请求数据中</span>
        required_fields <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">,</span> <span class="token string">"password"</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> field <span class="token keyword">in</span> required_fields<span class="token punctuation">:</span>
            <span class="token keyword">if</span> field <span class="token keyword">not</span> <span class="token keyword">in</span> request_data<span class="token punctuation">:</span>
                <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"Missing field: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>field<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">400</span>  <span class="token comment"># 缺少必填字段，返回 400 错误</span>

        <span class="token comment"># 提取用户名和密码</span>
        user_input_name <span class="token operator">=</span> request_data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span>
        input_password <span class="token operator">=</span> request_data<span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>user_input_name<span class="token punctuation">,</span> input_password<span class="token punctuation">)</span>  <span class="token comment"># 打印用户名和密码（仅用于调试）</span>

        <span class="token comment"># 查询用户是否存在</span>
        result <span class="token operator">=</span> db_session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span>user_input_name<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> result<span class="token punctuation">:</span>
            <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"User not found"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">404</span>  <span class="token comment"># 用户不存在，返回 404 错误</span>

        <span class="token comment"># 验证密码（假设密码是明文存储，实际应使用哈希）</span>
        <span class="token keyword">if</span> result<span class="token punctuation">.</span>password <span class="token operator">!=</span> input_password<span class="token punctuation">:</span>
            <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string">"Invalid password"</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">401</span>  <span class="token comment"># 密码不匹配，返回 401 错误</span>

        <span class="token comment"># 登录成功，返回成功消息</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"message"</span><span class="token punctuation">:</span> <span class="token string">"登录成功"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token comment"># 捕获所有异常，并返回服务器内部错误</span>
        <span class="token keyword">return</span> jsonify<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"error"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f"Internal server error: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">500</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span>debug<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>  <span class="token comment"># 启动 Flask 应用，启用调试模式方便开发</span>


</code></pre>
    <h3>
     <a id="_123">
     </a>
     数据插入
    </h3>
    <p>
     这里是一个插入数据的逻辑，先拿到请求数据里面的内容，然后单独对密码进行md5加密，这次不再对密码做明文存储。然后再将数据依次放进User类里面，然后将数据添加到数据库，最后提交。
    </p>
    <pre><code class="prism language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/register"</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">"POST"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    request_data <span class="token operator">=</span> request<span class="token punctuation">.</span>data
    request_data <span class="token operator">=</span> json<span class="token punctuation">.</span>loads<span class="token punctuation">(</span>request_data<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>request_data<span class="token punctuation">)</span>

    <span class="token comment">#设置用户名和密码</span>
    username <span class="token operator">=</span> request_data<span class="token punctuation">[</span><span class="token string">"username"</span><span class="token punctuation">]</span>
    password <span class="token operator">=</span> request_data<span class="token punctuation">[</span><span class="token string">"password"</span><span class="token punctuation">]</span>
    nickname <span class="token operator">=</span> request_data<span class="token punctuation">[</span><span class="token string">"nickname"</span><span class="token punctuation">]</span>
    picture <span class="token operator">=</span> request_data<span class="token punctuation">[</span><span class="token string">"picture"</span><span class="token punctuation">]</span>
    <span class="token comment">#暂时只使用四个参数，后面可以添加更多参数</span>

    password <span class="token operator">=</span> hashlib<span class="token punctuation">.</span>md5<span class="token punctuation">(</span>password<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>hexdigest<span class="token punctuation">(</span><span class="token punctuation">)</span>
    insert_param <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"username"</span><span class="token punctuation">:</span> username<span class="token punctuation">,</span>
        <span class="token string">"password"</span><span class="token punctuation">:</span> password<span class="token punctuation">,</span>
        <span class="token string">"nickname"</span><span class="token punctuation">:</span> nickname<span class="token punctuation">,</span>
        <span class="token string">"picture"</span><span class="token punctuation">:</span> picture
    <span class="token punctuation">}</span>

    user <span class="token operator">=</span> User<span class="token punctuation">(</span><span class="token operator">**</span>insert_param<span class="token punctuation">)</span>
    db_session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
    db_session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">"注册成功"</span>
</code></pre>
    <p>
     可以看到，数据已经插入进来了。
    </p>
    <p>
     关于
     <code>
      User(**insert_param)
     </code>
     的含义，以下是AI的解释：
    </p>
    <p>
     在Python中，
     <code>
      User(**insert_param)
     </code>
     这种语法使用了可变参数传递的方式（也称为解包操作符）。这里是如何工作的：
    </p>
    <p>
     假设你有一个类
     <code>
      User
     </code>
     ，它可能定义了一些初始化参数，比如这样：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> username<span class="token punctuation">,</span> password<span class="token punctuation">,</span> nickname<span class="token punctuation">,</span> picture<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>username <span class="token operator">=</span> username
        self<span class="token punctuation">.</span>password <span class="token operator">=</span> password
        self<span class="token punctuation">.</span>nickname <span class="token operator">=</span> nickname
        self<span class="token punctuation">.</span>picture <span class="token operator">=</span> picture
</code></pre>
    <p>
     现在，如果你想创建一个
     <code>
      User
     </code>
     类的实例，并且你有一个字典
     <code>
      insert_param
     </code>
     包含了所有必要的键值对，你可以使用解包操作符
     <code>
      **
     </code>
     来将这个字典解包为关键字参数传递给
     <code>
      User
     </code>
     类的构造函数。例如：
    </p>
    <pre><code class="prism language-python">insert_param <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"username"</span><span class="token punctuation">:</span> <span class="token string">"user12345"</span><span class="token punctuation">,</span>
    <span class="token string">"password"</span><span class="token punctuation">:</span> <span class="token string">"pass$W0rd6789"</span><span class="token punctuation">,</span>
    <span class="token string">"nickname"</span><span class="token punctuation">:</span> <span class="token string">"CoolUser_123"</span><span class="token punctuation">,</span>
    <span class="token string">"picture"</span><span class="token punctuation">:</span> <span class="token string">"https://example.com/images/user_profile_12345.png"</span>
<span class="token punctuation">}</span>

user <span class="token operator">=</span> User<span class="token punctuation">(</span><span class="token operator">**</span>insert_param<span class="token punctuation">)</span>
</code></pre>
    <p>
     这里的
     <code>
      **insert_param
     </code>
     会将字典中的键值对解包成关键字参数的形式，相当于这样调用：
    </p>
    <pre><code class="prism language-python">user <span class="token operator">=</span> User<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">"user12345"</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">"pass$W0rd6789"</span><span class="token punctuation">,</span> nickname<span class="token operator">=</span><span class="token string">"CoolUser_123"</span><span class="token punctuation">,</span> picture<span class="token operator">=</span><span class="token string">"https://example.com/images/user_profile_12345.png"</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     这种技术非常有用，尤其是在处理动态生成的参数或者当你想要从字典中提取数据来创建对象实例时。它提供了一种简洁的方式来传递一组名称-值对作为关键字参数给函数或方法。确保字典中的键名与类构造函数期待的关键字参数名称相匹配是很重要的，否则将会导致错误，比如
     <code>
      TypeError
     </code>
     提示找不到正确的参数。
    </p>
    <h3>
     <a id="_197">
     </a>
     删除和修改数据
    </h3>
    <p>
     这两个例子展示了如何通过SQLAlchemy简单高效地执行删除和更新操作。重要的是要记得在完成这些操作后调用
     <code>
      db_session.commit()
     </code>
     来提交更改，否则更改不会被保存到数据库中。此外，在生产环境中执行删除或更新操作时应格外小心，最好先备份数据，确保操作的安全性和准确性。
    </p>
    <pre><code class="prism language-python"><span class="token comment">#删除数据</span>
del_data <span class="token operator">=</span> db_session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">"dazhoulaos222"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
db_session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"删除成功"</span><span class="token punctuation">)</span>

<span class="token comment">#修改数据</span>
change_data <span class="token operator">=</span> db_session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">"test_user"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"nickname"</span><span class="token punctuation">:</span> <span class="token string">"test_user_change"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
db_session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"修改成功"</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_215">
     </a>
     单表查询操作补充
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> and_

<span class="token comment"># 查询操作</span>
<span class="token keyword">def</span> <span class="token function">query_users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 查询 User 表中的所有记录</span>
    users <span class="token operator">=</span> db_session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span> user <span class="token keyword">in</span> users<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"User ID: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>user<span class="token punctuation">.</span>user_id<span class="token punctuation">}</span></span><span class="token string">, Username: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>user<span class="token punctuation">.</span>username<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># 根据条件查询，例如 username 等于 'test_user'</span>
    user <span class="token operator">=</span> db_session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'test_user'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> user<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Found user: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>user<span class="token punctuation">.</span>username<span class="token punctuation">}</span></span><span class="token string">, Nickname: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>user<span class="token punctuation">.</span>nickname<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    <span class="token comment"># 统计 user_id 小于 10 的用户数量</span>
    count <span class="token operator">=</span> db_session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>user_id <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>count<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Number of users with user_id &lt; 10: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>count<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token comment"># 插入操作</span>
<span class="token keyword">def</span> <span class="token function">insert_user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    new_user <span class="token operator">=</span> User<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'new_username'</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">'secure_password'</span><span class="token punctuation">,</span> nickname<span class="token operator">=</span><span class="token string">'Newbie'</span><span class="token punctuation">,</span> picture<span class="token operator">=</span><span class="token string">'http://example.com/pic.png'</span><span class="token punctuation">)</span>
    db_session<span class="token punctuation">.</span>add<span class="token punctuation">(</span>new_user<span class="token punctuation">)</span>
    db_session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Inserted new user."</span><span class="token punctuation">)</span>

<span class="token comment"># 更新操作</span>
<span class="token keyword">def</span> <span class="token function">update_user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 使用 filter_by 进行更新</span>
    user <span class="token operator">=</span> db_session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'user_to_update'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> user<span class="token punctuation">:</span>
        user<span class="token punctuation">.</span>nickname <span class="token operator">=</span> <span class="token string">'UpdatedNickname'</span>
        db_session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"User updated."</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 或者直接使用 update 方法批量更新</span>
    db_session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'another_user_to_update'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">"nickname"</span><span class="token punctuation">:</span> <span class="token string">"AnotherUpdatedNickname"</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    db_session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Users batch updated."</span><span class="token punctuation">)</span>

<span class="token comment"># 删除操作</span>
<span class="token keyword">def</span> <span class="token function">delete_user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 删除单个实体</span>
    user <span class="token operator">=</span> db_session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>filter_by<span class="token punctuation">(</span>username<span class="token operator">=</span><span class="token string">'username_to_delete'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> user<span class="token punctuation">:</span>
        db_session<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        db_session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"User deleted."</span><span class="token punctuation">)</span>
    
    <span class="token comment"># 批量删除</span>
    db_session<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>username<span class="token punctuation">.</span>like<span class="token punctuation">(</span><span class="token string">'delete_me_%'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
    db_session<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Batch deletion completed."</span><span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># 执行查询</span>
        query_users<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 执行插入</span>
        insert_user<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 执行更新</span>
        update_user<span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token comment"># 执行删除</span>
        delete_user<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        db_session<span class="token punctuation">.</span>rollback<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 如果发生错误则回滚</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"An error occurred: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>e<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">finally</span><span class="token punctuation">:</span>
        db_session<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 确保关闭数据库会话</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f37323638363439322f:61727469636c652f64657461696c732f313436303733333030" class_="artid" style="display:none">
 </p>
</div>


