---
layout: post
title: "TensorFLow深度学习实战11风格迁移详解"
date: 2025-03-12 09:01:27 +0800
description: "使用风格迁移算法生成图像的核心思想是通过获取损失和梯度变化值以生成风格迁移图像，将内容图像和风格参考图像混合在一起。在本节中，首先介绍了神经风格迁移的核心思想与风格迁移图像的生成流程，然后利用 TensorFlow 从零开始实现了风格迁移算法，可以通过修改模型中的超参数来生成不同观感的图像。"
keywords: "TensorFLow深度学习实战（11）——风格迁移详解"
categories: ['未分类']
tags: ['深度学习', '人工智能', 'Tensorflow']
artid: "146195594"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146195594
    alt: "TensorFLow深度学习实战11风格迁移详解"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146195594
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146195594
cover: https://bing.ee123.net/img/rand?artid=146195594
image: https://bing.ee123.net/img/rand?artid=146195594
img: https://bing.ee123.net/img/rand?artid=146195594
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     TensorFLow深度学习实战（11）——风格迁移详解
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <h3>
     <a id="0__1">
     </a>
     0. 前言
    </h3>
    <p>
     风格迁移是用于训练神经网络创作艺术作品的深度学习技术，同时也是一种有趣的神经网络应用，提供了一种用于深入理解神经网络的方式。在本节中，我们将学习神经风格迁移算法。在神经风格迁移中，我们需要一个内容图像和一个风格图像，我们的目标是保持内容图像的同时融和风格图像中的风格样式，以组合这两个图像生成全新图像。
    </p>
    <h3>
     <a id="1__4">
     </a>
     1. 风格迁移原理
    </h3>
    <p>
     当我们观察一幅画作时，我们通常会关注两种元素：画作本身(比如一只宠物或者一幅风景)以及艺术家内在的风格。很难具体定义风格，但我们知道毕加索、梵高等艺术家都有自己的风格。假设我们将梵高的一幅画作交给神经网络，让神经网络以毕加索的风格重新绘制，或者将照片交给神经网络，让它以梵高或毕加索(或其他任何艺术家)的风格重新绘制照片，这就是风格迁移的概念。
     <br/>
     接下来，我们正式地定义风格迁移的过程，风格迁移是生成一幅图像
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        x 
        
       
      
        x
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal">
          x
         </span>
        </span>
       </span>
      </span>
     </span>
     ，既保留了源内容图像
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        p 
        
       
      
        p
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal">
          p
         </span>
        </span>
       </span>
      </span>
     </span>
     的内容，又采用了源风格图像
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        a 
        
       
      
        a
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal">
          a
         </span>
        </span>
       </span>
      </span>
     </span>
     的风格。因此，直观地说，我们需要两个损失函数：一个损失函数测量两幅图像内容的差异
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        L 
         
         
         
           c 
          
         
           o 
          
         
           n 
          
         
           t 
          
         
           e 
          
         
           n 
          
         
           t 
          
         
        
       
      
        L_{content}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           L
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2806em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  co
                 </span>
                 <span class="mord mathnormal mtight">
                  n
                 </span>
                 <span class="mord mathnormal mtight">
                  t
                 </span>
                 <span class="mord mathnormal mtight">
                  e
                 </span>
                 <span class="mord mathnormal mtight">
                  n
                 </span>
                 <span class="mord mathnormal mtight">
                  t
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     ，另一个损失函数测量两幅图像风格的差异
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        L 
         
         
         
           s 
          
         
           t 
          
         
           y 
          
         
           l 
          
         
           e 
          
         
        
       
      
        L_{style}
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.9694em; vertical-align: -0.2861em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           L
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3361em;">
              <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  s
                 </span>
                 <span class="mord mathnormal mtight">
                  t
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                  y
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                  l
                 </span>
                 <span class="mord mathnormal mtight">
                  e
                 </span>
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.2861em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     。然后，风格迁移可以看作是一个优化问题，试图最小化这两个损失函数。 接下来，我们使用预训练的网络来实现风格迁移，使用
     <code>
      VGG19
     </code>
     提取有效表示图像的特征。首先定义用于训练网络的两个函数：内容损失和风格损失。
    </p>
    <p>
     <img alt="风格迁移" src="https://i-blog.csdnimg.cn/direct/558d818b251d4304948dc99b5ac33566.png#pic_center"/>
    </p>
    <h4>
     <a id="11__10">
     </a>
     1.1 内容损失
    </h4>
    <p>
     给定两幅图像，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        p 
        
       
      
        p
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.625em; vertical-align: -0.1944em;">
         </span>
         <span class="mord mathnormal">
          p
         </span>
        </span>
       </span>
      </span>
     </span>
     为内容图像，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        x 
        
       
      
        x
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal">
          x
         </span>
        </span>
       </span>
      </span>
     </span>
     为生成的风格图像，定义内容损失为在
     <code>
      VGG19
     </code>
     网络(网络接收这两幅图像作为输入)的某一层
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        l 
        
       
      
        l
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6944em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0197em;">
          l
         </span>
        </span>
       </span>
      </span>
     </span>
     定义的特征空间中的距离。换句话说，两幅图像由预训练的
     <code>
      VGG19
     </code>
     提取的特征表示，这些特征将图像投影到一个特征内容空间中，在这个空间中可以方便地计算内容损失：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         L 
          
          
          
            c 
           
          
            o 
           
          
            n 
           
          
            t 
           
          
            e 
           
          
            n 
           
          
            t 
           
          
         
           l 
          
         
        
          ( 
         
        
          p 
         
        
          , 
         
        
          x 
         
        
          ) 
         
        
          = 
         
         
         
           ∑ 
          
          
          
            i 
           
          
            , 
           
          
            j 
           
          
         
        
          ( 
         
         
         
           F 
          
          
          
            i 
           
          
            j 
           
          
         
           l 
          
         
        
          ( 
         
        
          x 
         
        
          ) 
         
        
          − 
         
         
         
           P 
          
          
          
            i 
           
          
            j 
           
          
         
           l 
          
         
        
          ( 
         
        
          p 
         
        
          ) 
         
         
         
           ) 
          
         
           2 
          
         
        
       
         L_{content}^l(p,x)=\sum_{i,j}(F_{ij}^l(x)-P_{ij}^l(p))^2
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.1491em; vertical-align: -0.25em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            L
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8991em;">
               <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   co
                  </span>
                  <span class="mord mathnormal mtight">
                   n
                  </span>
                  <span class="mord mathnormal mtight">
                   t
                  </span>
                  <span class="mord mathnormal mtight">
                   e
                  </span>
                  <span class="mord mathnormal mtight">
                   n
                  </span>
                  <span class="mord mathnormal mtight">
                   t
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                  l
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.247em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           p
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal">
           x
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.4638em; vertical-align: -1.4138em;">
          </span>
          <span class="mop op-limits">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 1.05em;">
              <span class="" style="top: -1.8723em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                 <span class="mpunct mtight">
                  ,
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  j
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.05em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="">
                <span class="mop op-symbol large-op">
                 ∑
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 1.4138em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            F
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8991em;">
               <span class="" style="top: -2.453em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   ij
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                  l
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3831em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           x
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           −
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1.2822em; vertical-align: -0.3831em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.1389em;">
            P
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8991em;">
               <span class="" style="top: -2.453em; margin-left: -0.1389em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   ij
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                  l
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3831em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           p
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mclose">
           <span class="mclose">
            )
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8641em;">
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  2
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     为了生成优秀的图像，我们需要确保生成图像的内容与输入内容图像的内容相似(即距离较小)，通过标准反向传播最小化内容损失：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">get_content_loss</span><span class="token punctuation">(</span>base_content<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>square<span class="token punctuation">(</span>base_content <span class="token operator">-</span> target<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="12__20">
     </a>
     1.2 风格损失
    </h4>
    <p>
     <code>
      VGG19
     </code>
     较高层的特征用作内容表示，可以将这些特征视为卷积核激活。为了表示风格，我们使用
     <code>
      gram
     </code>
     矩阵
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        G 
        
       
      
        G
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.6833em;">
         </span>
         <span class="mord mathnormal">
          G
         </span>
        </span>
       </span>
      </span>
     </span>
     (定义为向量
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        v 
        
       
      
        v
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0359em;">
          v
         </span>
        </span>
       </span>
      </span>
     </span>
     的矩阵
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        v 
         
        
          T 
         
        
       
         v 
        
       
      
        v^Tv
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8413em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.0359em;">
           v
          </span>
          <span class="msupsub">
           <span class="vlist-t">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8413em;">
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.1389em;">
                 T
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
         <span class="mord mathnormal" style="margin-right: 0.0359em;">
          v
         </span>
        </span>
       </span>
      </span>
     </span>
     )，
     <code>
      gram
     </code>
     矩阵表示了不同卷积核激活之间的相关性矩阵。每层对总风格损失的贡献定义为：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         E 
          
         
           l 
          
         
        
          = 
         
         
         
           1 
          
          
          
            4 
           
           
           
             N 
            
           
             l 
            
           
             2 
            
           
           
           
             M 
            
           
             l 
            
           
             2 
            
           
          
         
         
         
           ∑ 
          
          
          
            i 
           
          
            , 
           
          
            j 
           
          
         
        
          ( 
         
         
         
           G 
          
          
          
            i 
           
          
            j 
           
          
         
           l 
          
         
        
          − 
         
         
         
           A 
          
          
          
            i 
           
          
            j 
           
          
         
           l 
          
         
         
         
           ) 
          
         
           2 
          
         
        
       
         E_l=\frac 1{4N_l^2M_l^2}\sum_{i,j}(G_{ij}^l-A_{ij}^l)^2
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0576em;">
            E
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                  l
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.7352em; vertical-align: -1.4138em;">
          </span>
          <span class="mord">
           <span class="mopen nulldelimiter">
           </span>
           <span class="mfrac">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 1.3214em;">
               <span class="" style="top: -2.314em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  4
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal" style="margin-right: 0.109em;">
                   N
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.7959em;">
                      <span class="" style="top: -2.3987em; margin-left: -0.109em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                         l
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         2
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3013em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                 <span class="mord">
                  <span class="mord mathnormal" style="margin-right: 0.109em;">
                   M
                  </span>
                  <span class="msupsub">
                   <span class="vlist-t vlist-t2">
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.7959em;">
                      <span class="" style="top: -2.3987em; margin-left: -0.109em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                         l
                        </span>
                       </span>
                      </span>
                      <span class="" style="top: -3.0448em; margin-right: 0.05em;">
                       <span class="pstrut" style="height: 2.7em;">
                       </span>
                       <span class="sizing reset-size6 size3 mtight">
                        <span class="mord mtight">
                         2
                        </span>
                       </span>
                      </span>
                     </span>
                     <span class="vlist-s">
                      ​
                     </span>
                    </span>
                    <span class="vlist-r">
                     <span class="vlist" style="height: 0.3013em;">
                      <span class="">
                      </span>
                     </span>
                    </span>
                   </span>
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.23em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="frac-line" style="border-bottom-width: 0.04em;">
                </span>
               </span>
               <span class="" style="top: -3.677em;">
                <span class="pstrut" style="height: 3em;">
                </span>
                <span class="mord">
                 <span class="mord">
                  1
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.9873em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
           <span class="mclose nulldelimiter">
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mop op-limits">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 1.05em;">
              <span class="" style="top: -1.8723em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight">
                  i
                 </span>
                 <span class="mpunct mtight">
                  ,
                 </span>
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  j
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.05em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="">
                <span class="mop op-symbol large-op">
                 ∑
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 1.4138em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            G
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8991em;">
               <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   ij
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                  l
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3831em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
          <span class="mbin">
           −
          </span>
          <span class="mspace" style="margin-right: 0.2222em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 1.2822em; vertical-align: -0.3831em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            A
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8991em;">
               <span class="" style="top: -2.453em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                   ij
                  </span>
                 </span>
                </span>
               </span>
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                  l
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3831em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mclose">
           <span class="mclose">
            )
           </span>
           <span class="msupsub">
            <span class="vlist-t">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.8641em;">
               <span class="" style="top: -3.113em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  2
                 </span>
                </span>
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     其中
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        G 
         
         
         
           i 
          
         
           j 
          
         
        
          l 
         
        
       
      
        G_{ij}^l
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.2439em; vertical-align: -0.3948em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           G
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8491em;">
              <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  ij
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                 l
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3948em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     是生成的风格图像
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        x 
        
       
      
        x
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.4306em;">
         </span>
         <span class="mord mathnormal">
          x
         </span>
        </span>
       </span>
      </span>
     </span>
     的
     <code>
      gram
     </code>
     矩阵，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        A 
         
         
         
           i 
          
         
           j 
          
         
        
          l 
         
        
       
      
        A_{ij}^l
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 1.2439em; vertical-align: -0.3948em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal">
           A
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.8491em;">
              <span class="" style="top: -2.4413em; margin-left: 0em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0572em;">
                  ij
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.063em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                 l
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3948em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     是样式图像a的格拉姆矩阵，
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        N 
         
        
          l 
         
        
       
      
        N_l
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.109em;">
           N
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3361em;">
              <span class="" style="top: -2.55em; margin-left: -0.109em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                 l
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     是特征图的数量，每个特征图的大小是
     <span class="katex--inline">
      <span class="katex">
       <span class="katex-mathml">
        M 
         
        
          l 
         
        
       
      
        M_l
       </span>
       <span class="katex-html">
        <span class="base">
         <span class="strut" style="height: 0.8333em; vertical-align: -0.15em;">
         </span>
         <span class="mord">
          <span class="mord mathnormal" style="margin-right: 0.109em;">
           M
          </span>
          <span class="msupsub">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 0.3361em;">
              <span class="" style="top: -2.55em; margin-left: -0.109em; margin-right: 0.05em;">
               <span class="pstrut" style="height: 2.7em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                 l
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 0.15em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     。格拉姆矩阵可以将图像投影到风格空间中。此外，使用来自多个
     <code>
      VGG19
     </code>
     层的特征相关性，因为我们希望考虑多尺度信息和更鲁棒的风格表示。总风格损失是各层风格损失的加权和：
     <br/>
     <span class="katex--display">
      <span class="katex-display">
       <span class="katex">
        <span class="katex-mathml">
         L 
          
          
          
            s 
           
          
            t 
           
          
            y 
           
          
            l 
           
          
            e 
           
          
         
        
          ( 
         
        
          a 
         
        
          , 
         
        
          x 
         
        
          ) 
         
        
          = 
         
         
         
           ∑ 
          
          
          
            l 
           
          
            ∈ 
           
          
            L 
           
          
         
         
         
           w 
          
         
           l 
          
         
         
         
           E 
          
         
           l 
          
         
        
       
         L_{style}(a,x)=\sum_{l\in L}w_lE_l
        </span>
        <span class="katex-html">
         <span class="base">
          <span class="strut" style="height: 1.0361em; vertical-align: -0.2861em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal">
            L
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mtight">
                  <span class="mord mathnormal mtight">
                   s
                  </span>
                  <span class="mord mathnormal mtight">
                   t
                  </span>
                  <span class="mord mathnormal mtight" style="margin-right: 0.0359em;">
                   y
                  </span>
                  <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                   l
                  </span>
                  <span class="mord mathnormal mtight">
                   e
                  </span>
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.2861em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mopen">
           (
          </span>
          <span class="mord mathnormal">
           a
          </span>
          <span class="mpunct">
           ,
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord mathnormal">
           x
          </span>
          <span class="mclose">
           )
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
          <span class="mrel">
           =
          </span>
          <span class="mspace" style="margin-right: 0.2778em;">
          </span>
         </span>
         <span class="base">
          <span class="strut" style="height: 2.3795em; vertical-align: -1.3295em;">
          </span>
          <span class="mop op-limits">
           <span class="vlist-t vlist-t2">
            <span class="vlist-r">
             <span class="vlist" style="height: 1.05em;">
              <span class="" style="top: -1.8479em; margin-left: 0em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="sizing reset-size6 size3 mtight">
                <span class="mord mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                  l
                 </span>
                 <span class="mrel mtight">
                  ∈
                 </span>
                 <span class="mord mathnormal mtight">
                  L
                 </span>
                </span>
               </span>
              </span>
              <span class="" style="top: -3.05em;">
               <span class="pstrut" style="height: 3.05em;">
               </span>
               <span class="">
                <span class="mop op-symbol large-op">
                 ∑
                </span>
               </span>
              </span>
             </span>
             <span class="vlist-s">
              ​
             </span>
            </span>
            <span class="vlist-r">
             <span class="vlist" style="height: 1.3295em;">
              <span class="">
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mspace" style="margin-right: 0.1667em;">
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0269em;">
            w
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: -0.0269em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                  l
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
          <span class="mord">
           <span class="mord mathnormal" style="margin-right: 0.0576em;">
            E
           </span>
           <span class="msupsub">
            <span class="vlist-t vlist-t2">
             <span class="vlist-r">
              <span class="vlist" style="height: 0.3361em;">
               <span class="" style="top: -2.55em; margin-left: -0.0576em; margin-right: 0.05em;">
                <span class="pstrut" style="height: 2.7em;">
                </span>
                <span class="sizing reset-size6 size3 mtight">
                 <span class="mord mathnormal mtight" style="margin-right: 0.0197em;">
                  l
                 </span>
                </span>
               </span>
              </span>
              <span class="vlist-s">
               ​
              </span>
             </span>
             <span class="vlist-r">
              <span class="vlist" style="height: 0.15em;">
               <span class="">
               </span>
              </span>
             </span>
            </span>
           </span>
          </span>
         </span>
        </span>
       </span>
      </span>
     </span>
     <br/>
     因此，关键思想是在内容图像上执行梯度下降，使其风格与风格图像相似：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">gram_matrix</span><span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># image channels first</span>
    channels <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>input_tensor<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    a <span class="token operator">=</span> tf<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>input_tensor<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> channels<span class="token punctuation">]</span><span class="token punctuation">)</span>
    n <span class="token operator">=</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    gram <span class="token operator">=</span> tf<span class="token punctuation">.</span>matmul<span class="token punctuation">(</span>a<span class="token punctuation">,</span> a<span class="token punctuation">,</span> transpose_a<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> gram <span class="token operator">/</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>n<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">get_style_loss</span><span class="token punctuation">(</span>base_style<span class="token punctuation">,</span> gram_target<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># height, width, num filters of each layer</span>
    height<span class="token punctuation">,</span> width<span class="token punctuation">,</span> channels <span class="token operator">=</span> base_style<span class="token punctuation">.</span>get_shape<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>as_list<span class="token punctuation">(</span><span class="token punctuation">)</span>
    gram_style <span class="token operator">=</span> gram_matrix<span class="token punctuation">(</span>base_style<span class="token punctuation">)</span>
    <span class="token keyword">return</span> tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>square<span class="token punctuation">(</span>gram_style <span class="token operator">-</span> gram_target<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     简言之，风格迁移首先使用
     <code>
      VGG19
     </code>
     作为特征提取器，然后定义两个适当的损失函数以最小化，一个用于风格，另一个用于内容。
    </p>
    <h3>
     <a id="2__45">
     </a>
     2. 模型分析
    </h3>
    <p>
     在了解了神经风格迁移的基本原理之后，我们继续对模型的运行流程进行分析，主要通过以下步骤实现神经风格迁移：
    </p>
    <ul>
     <li>
      通过预训练的模型处理图像，并在预定义的网络层上提取图像特征
      <ul>
       <li>
        将内容图像输入到预训练模型中，并在预定义的内容网络层上提取图像特征
       </li>
       <li>
        计算内容损失
       </li>
       <li>
        将风格图像输入到预训练模型中，并在预定义的风格网络层上提取图像特征，然后计算风格图像的
        <code>
         gram
        </code>
        矩阵值
       </li>
      </ul>
     </li>
     <li>
      将生成图像传递给风格图像所经过的同样的网络层，并计算对应的
      <code>
       gram
      </code>
      矩阵值
     </li>
     <li>
      提取两个图像的
      <code>
       gram
      </code>
      矩阵值的平方差，得到的结果即为风格损失
     </li>
     <li>
      总损失为风格损失和内容损失的加权平均值
     </li>
     <li>
      根据损失修改输入图像，得到令总损失最小的图像即为最终的图像
     </li>
    </ul>
    <h3>
     <a id="3__TensorFlow__55">
     </a>
     3. 使用 TensorFlow 实现神经风格迁移
    </h3>
    <p>
     了解了模型原理和运算流程后，在本节中，我们利用
     <code>
      Keras
     </code>
     实现神经风格迁移。
    </p>
    <p>
     <strong>
      (1)
     </strong>
     导入所需要的库，以及用于神经风格迁移的内容图像和风格图像：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>applications <span class="token keyword">import</span> vgg19
<span class="token keyword">from</span> tensorflow<span class="token punctuation">.</span>keras <span class="token keyword">import</span> backend <span class="token keyword">as</span> K
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> tensorflow <span class="token keyword">as</span> tf

style_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'Vincent_van_Gogh_779.jpg'</span><span class="token punctuation">)</span>
style_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>style_img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>
style_shape <span class="token operator">=</span> style_img<span class="token punctuation">.</span>shape

content_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'3.jpeg'</span><span class="token punctuation">)</span>
content_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>content_img<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>
content_shape <span class="token operator">=</span> content_img<span class="token punctuation">.</span>shape
</code></pre>
    <p>
     <strong>
      (2)
     </strong>
     为了便于理解神经风格迁移算法的效果，在生成图像前先查看风格和内容图像：
    </p>
    <pre><code class="prism language-python">plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">211</span><span class="token punctuation">)</span>
<span class="token comment"># 为了进行对比，将风格图像进行缩放，以与内容图像具有相同的尺寸</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>style_img<span class="token punctuation">,</span> <span class="token punctuation">(</span>content_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> content_shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Style image'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">212</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>content_img<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Content image'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>axis<span class="token punctuation">(</span><span class="token string">'off'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <img alt="风格图像与内容图像" src="https://i-blog.csdnimg.cn/blog_migrate/a5c39faae5938ab62f2f55da11acb603.png#pic_center"/>
    </p>
    <p>
     <strong>
      (3)
     </strong>
     初始化
     <code>
      VGG19
     </code>
     模型，以便获取输入图像在网络层中的特征输出：
    </p>
    <pre><code class="prism language-python">vgg <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>applications<span class="token punctuation">.</span>VGG19<span class="token punctuation">(</span>include_top<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> weights<span class="token operator">=</span><span class="token string">'imagenet'</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      (4)
     </strong>
     定义图像预处理函数，并加载图像：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">tensor_to_image</span><span class="token punctuation">(</span>tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    tensor <span class="token operator">=</span> tensor<span class="token operator">*</span><span class="token number">255</span>
    tensor <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>tensor<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
    <span class="token keyword">if</span> np<span class="token punctuation">.</span>ndim<span class="token punctuation">(</span>tensor<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">3</span><span class="token punctuation">:</span>
        <span class="token keyword">assert</span> tensor<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span>
        tensor <span class="token operator">=</span> tensor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>tensor<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">load_img</span><span class="token punctuation">(</span>path_to_img<span class="token punctuation">)</span><span class="token punctuation">:</span>
    max_dim <span class="token operator">=</span> <span class="token number">512</span>
    img <span class="token operator">=</span> tf<span class="token punctuation">.</span>io<span class="token punctuation">.</span>read_file<span class="token punctuation">(</span>path_to_img<span class="token punctuation">)</span>
    img <span class="token operator">=</span> tf<span class="token punctuation">.</span>image<span class="token punctuation">.</span>decode_image<span class="token punctuation">(</span>img<span class="token punctuation">,</span> channels<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
    img <span class="token operator">=</span> tf<span class="token punctuation">.</span>image<span class="token punctuation">.</span>convert_image_dtype<span class="token punctuation">(</span>img<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>

    shape <span class="token operator">=</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    long_dim <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span>shape<span class="token punctuation">)</span>
    scale <span class="token operator">=</span> max_dim <span class="token operator">/</span> long_dim

    new_shape <span class="token operator">=</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>shape <span class="token operator">*</span> scale<span class="token punctuation">,</span> tf<span class="token punctuation">.</span>int32<span class="token punctuation">)</span>

    img <span class="token operator">=</span> tf<span class="token punctuation">.</span>image<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> new_shape<span class="token punctuation">)</span>
    img <span class="token operator">=</span> img<span class="token punctuation">[</span>tf<span class="token punctuation">.</span>newaxis<span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> img

<span class="token keyword">def</span> <span class="token function">imshow</span><span class="token punctuation">(</span>image<span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>image<span class="token punctuation">.</span>shape<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">:</span>
        image <span class="token operator">=</span> tf<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span>image<span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
    <span class="token keyword">if</span> title<span class="token punctuation">:</span>
        plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span>title<span class="token punctuation">)</span>

content_path <span class="token operator">=</span> <span class="token string">'3.jpeg'</span>
style_path <span class="token operator">=</span> <span class="token string">'Vincent_van_Gogh_779.jpg'</span>
content_image <span class="token operator">=</span> load_img<span class="token punctuation">(</span>content_path<span class="token punctuation">)</span>
style_image <span class="token operator">=</span> load_img<span class="token punctuation">(</span>style_path<span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      (5)
     </strong>
     接下来，定义需要提取用于计算内容和风格损失的神经网络图层：
    </p>
    <pre><code class="prism language-python">content_layers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'block5_conv2'</span><span class="token punctuation">]</span> 

style_layers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'block1_conv1'</span><span class="token punctuation">,</span>
                <span class="token string">'block2_conv1'</span><span class="token punctuation">,</span>
                <span class="token string">'block3_conv1'</span><span class="token punctuation">,</span> 
                <span class="token string">'block4_conv1'</span><span class="token punctuation">,</span> 
                <span class="token string">'block5_conv1'</span><span class="token punctuation">]</span>

num_content_layers <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>content_layers<span class="token punctuation">)</span>
num_style_layers <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>style_layers<span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      (6)
     </strong>
     构建了一个
     <code>
      VGG19
     </code>
     模型，该模型返回一个中间层输出的列表，并构建模型：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">vgg_layers</span><span class="token punctuation">(</span>layer_names<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">""" Creates a VGG model that returns a list of intermediate output values."""</span>
    vgg <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>applications<span class="token punctuation">.</span>VGG19<span class="token punctuation">(</span>include_top<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> weights<span class="token operator">=</span><span class="token string">'imagenet'</span><span class="token punctuation">)</span>
    vgg<span class="token punctuation">.</span>trainable <span class="token operator">=</span> <span class="token boolean">False</span>

    outputs <span class="token operator">=</span> <span class="token punctuation">[</span>vgg<span class="token punctuation">.</span>get_layer<span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">.</span>output <span class="token keyword">for</span> name <span class="token keyword">in</span> layer_names<span class="token punctuation">]</span>

    model <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>Model<span class="token punctuation">(</span><span class="token punctuation">[</span>vgg<span class="token punctuation">.</span><span class="token builtin">input</span><span class="token punctuation">]</span><span class="token punctuation">,</span> outputs<span class="token punctuation">)</span>
    <span class="token keyword">return</span> model

style_extractor <span class="token operator">=</span> vgg_layers<span class="token punctuation">(</span>style_layers<span class="token punctuation">)</span>
style_outputs <span class="token operator">=</span> style_extractor<span class="token punctuation">(</span>style_image<span class="token operator">*</span><span class="token number">255</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      (7)
     </strong>
     定义函数
     <code>
      gram_matrix
     </code>
     ，用于计算输入的
     <code>
      gram
     </code>
     矩阵：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">gram_matrix</span><span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span><span class="token punctuation">:</span>
    result <span class="token operator">=</span> tf<span class="token punctuation">.</span>linalg<span class="token punctuation">.</span>einsum<span class="token punctuation">(</span><span class="token string">'bijc,bijd-&gt;bcd'</span><span class="token punctuation">,</span> input_tensor<span class="token punctuation">,</span> input_tensor<span class="token punctuation">)</span>
    input_shape <span class="token operator">=</span> tf<span class="token punctuation">.</span>shape<span class="token punctuation">(</span>input_tensor<span class="token punctuation">)</span>
    num_locations <span class="token operator">=</span> tf<span class="token punctuation">.</span>cast<span class="token punctuation">(</span>input_shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>input_shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> tf<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
    <span class="token keyword">return</span> result<span class="token operator">/</span><span class="token punctuation">(</span>num_locations<span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      (8)
     </strong>
     构建一个返回风格和内容张量的模型，在图像上调用此模型，可以返回
     <code>
      style_layers
     </code>
     的
     <code>
      gram
     </code>
     矩阵和
     <code>
      content_layers
     </code>
     的内容：
    </p>
    <pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">StyleContentModel</span><span class="token punctuation">(</span>tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>models<span class="token punctuation">.</span>Model<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> style_layers<span class="token punctuation">,</span> content_layers<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>StyleContentModel<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>vgg <span class="token operator">=</span> vgg_layers<span class="token punctuation">(</span>style_layers <span class="token operator">+</span> content_layers<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>style_layers <span class="token operator">=</span> style_layers
        self<span class="token punctuation">.</span>content_layers <span class="token operator">=</span> content_layers
        self<span class="token punctuation">.</span>num_style_layers <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>style_layers<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>vgg<span class="token punctuation">.</span>trainable <span class="token operator">=</span> <span class="token boolean">False</span>

    <span class="token keyword">def</span> <span class="token function">call</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> inputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token string">"Expects float input in [0,1]"</span>
        inputs <span class="token operator">=</span> inputs<span class="token operator">*</span><span class="token number">255.0</span>
        preprocessed_input <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>applications<span class="token punctuation">.</span>vgg19<span class="token punctuation">.</span>preprocess_input<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>
        outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>vgg<span class="token punctuation">(</span>preprocessed_input<span class="token punctuation">)</span>
        style_outputs<span class="token punctuation">,</span> content_outputs <span class="token operator">=</span> <span class="token punctuation">(</span>outputs<span class="token punctuation">[</span><span class="token punctuation">:</span>self<span class="token punctuation">.</span>num_style_layers<span class="token punctuation">]</span><span class="token punctuation">,</span>
                                        outputs<span class="token punctuation">[</span>self<span class="token punctuation">.</span>num_style_layers<span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

        style_outputs <span class="token operator">=</span> <span class="token punctuation">[</span>gram_matrix<span class="token punctuation">(</span>style_output<span class="token punctuation">)</span>
                        <span class="token keyword">for</span> style_output <span class="token keyword">in</span> style_outputs<span class="token punctuation">]</span>

        content_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>content_name<span class="token punctuation">:</span> value
                        <span class="token keyword">for</span> content_name<span class="token punctuation">,</span> value
                        <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>content_layers<span class="token punctuation">,</span> content_outputs<span class="token punctuation">)</span><span class="token punctuation">}</span>

        style_dict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>style_name<span class="token punctuation">:</span> value
                    <span class="token keyword">for</span> style_name<span class="token punctuation">,</span> value
                    <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>style_layers<span class="token punctuation">,</span> style_outputs<span class="token punctuation">)</span><span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">'content'</span><span class="token punctuation">:</span> content_dict<span class="token punctuation">,</span> <span class="token string">'style'</span><span class="token punctuation">:</span> style_dict<span class="token punctuation">}</span>

extractor <span class="token operator">=</span> StyleContentModel<span class="token punctuation">(</span>style_layers<span class="token punctuation">,</span> content_layers<span class="token punctuation">)</span>
results <span class="token operator">=</span> extractor<span class="token punctuation">(</span>tf<span class="token punctuation">.</span>constant<span class="token punctuation">(</span>content_image<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      (9)
     </strong>
     设置风格和内容的目标值，定义一个
     <code>
      tf.Variable
     </code>
     表示要优化的图像，并创建优化器：
    </p>
    <pre><code class="prism language-python">style_targets <span class="token operator">=</span> extractor<span class="token punctuation">(</span>style_image<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'style'</span><span class="token punctuation">]</span>
content_targets <span class="token operator">=</span> extractor<span class="token punctuation">(</span>content_image<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span>
image <span class="token operator">=</span> tf<span class="token punctuation">.</span>Variable<span class="token punctuation">(</span>content_image<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">clip_0_1</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> tf<span class="token punctuation">.</span>clip_by_value<span class="token punctuation">(</span>image<span class="token punctuation">,</span> clip_value_min<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> clip_value_max<span class="token operator">=</span><span class="token number">1.0</span><span class="token punctuation">)</span>

opt <span class="token operator">=</span> tf<span class="token punctuation">.</span>keras<span class="token punctuation">.</span>optimizers<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>learning_rate<span class="token operator">=</span><span class="token number">0.02</span><span class="token punctuation">,</span> beta_1<span class="token operator">=</span><span class="token number">0.99</span><span class="token punctuation">,</span> epsilon<span class="token operator">=</span><span class="token number">1e-1</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     <strong>
      (9)
     </strong>
     使用内容损失和风格损失的加权组合获得总损失：
    </p>
    <pre><code class="prism language-python">style_weight<span class="token operator">=</span><span class="token number">1e-2</span>
content_weight<span class="token operator">=</span><span class="token number">1e4</span>

<span class="token keyword">def</span> <span class="token function">style_content_loss</span><span class="token punctuation">(</span>outputs<span class="token punctuation">)</span><span class="token punctuation">:</span>
    style_outputs <span class="token operator">=</span> outputs<span class="token punctuation">[</span><span class="token string">'style'</span><span class="token punctuation">]</span>
    content_outputs <span class="token operator">=</span> outputs<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span>
    style_loss <span class="token operator">=</span> tf<span class="token punctuation">.</span>add_n<span class="token punctuation">(</span><span class="token punctuation">[</span>tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span><span class="token punctuation">(</span>style_outputs<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token operator">-</span>style_targets<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span> 
                           <span class="token keyword">for</span> name <span class="token keyword">in</span> style_outputs<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    style_loss <span class="token operator">*=</span> style_weight <span class="token operator">/</span> num_style_layers

    content_loss <span class="token operator">=</span> tf<span class="token punctuation">.</span>add_n<span class="token punctuation">(</span><span class="token punctuation">[</span>tf<span class="token punctuation">.</span>reduce_mean<span class="token punctuation">(</span><span class="token punctuation">(</span>content_outputs<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token operator">-</span>content_targets<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">**</span><span class="token number">2</span><span class="token punctuation">)</span> 
                             <span class="token keyword">for</span> name <span class="token keyword">in</span> content_outputs<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    content_loss <span class="token operator">*=</span> content_weight <span class="token operator">/</span> num_content_layers
    loss <span class="token operator">=</span> style_loss <span class="token operator">+</span> content_loss
    <span class="token keyword">return</span> loss
</code></pre>
    <p>
     <strong>
      (10)
     </strong>
     使用
     <code>
      tf.GradientTape
     </code>
     更新图像：
    </p>
    <pre><code class="prism language-python"><span class="token decorator annotation punctuation">@tf<span class="token punctuation">.</span>function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">train_step</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> tf<span class="token punctuation">.</span>GradientTape<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> tape<span class="token punctuation">:</span>
        outputs <span class="token operator">=</span> extractor<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
        loss <span class="token operator">=</span> style_content_loss<span class="token punctuation">(</span>outputs<span class="token punctuation">)</span>

    grad <span class="token operator">=</span> tape<span class="token punctuation">.</span>gradient<span class="token punctuation">(</span>loss<span class="token punctuation">,</span> image<span class="token punctuation">)</span>
    opt<span class="token punctuation">.</span>apply_gradients<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">(</span>grad<span class="token punctuation">,</span> image<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    image<span class="token punctuation">.</span>assign<span class="token punctuation">(</span>clip_0_1<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    train_step<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
tensor_to_image<span class="token punctuation">(</span>image<span class="token punctuation">)</span>
</code></pre>
    <p>
     使用以上代码生成图像，得到内容图像和风格图像的融合后的风格迁移图片：
    </p>
    <p>
     <img alt="结果图像" src="https://i-blog.csdnimg.cn/blog_migrate/bfa800512b966336b3035f088376951f.png#pic_center"/>
    </p>
    <p>
     可以通过选择不同的神经网络层来计算内容和风格损失，并为不同网络层分配不同的权重系数，观察生成图像的差别。
    </p>
    <h3>
     <a id="_270">
     </a>
     小结
    </h3>
    <p>
     使用风格迁移算法生成图像的核心思想是通过获取损失和梯度变化值以生成风格迁移图像，将内容图像和风格参考图像混合在一起。在本节中，首先介绍了神经风格迁移的核心思想与风格迁移图像的生成流程，然后利用
     <code>
      TensorFlow
     </code>
     从零开始实现了风格迁移算法，可以通过修改模型中的超参数来生成不同观感的图像。
    </p>
    <h3>
     <a id="_273">
     </a>
     系列链接
    </h3>
    <p>
     <a href="https://blog.csdn.net/LOVEmy134611/article/details/144225156">
      TensorFlow深度学习实战（1）——神经网络与模型训练过程详解
     </a>
     <br/>
     <a href="https://blog.csdn.net/LOVEmy134611/article/details/144225400">
      TensorFlow深度学习实战（2）——使用TensorFlow构建神经网络
     </a>
     <br/>
     <a href="https://blog.csdn.net/LOVEmy134611/article/details/144226029">
      TensorFlow深度学习实战（3）——深度学习中常用激活函数详解
     </a>
     <br/>
     <a href="https://blog.csdn.net/LOVEmy134611/article/details/144227318">
      TensorFlow深度学习实战（4）——正则化技术详解
     </a>
     <br/>
     <a href="https://blog.csdn.net/LOVEmy134611/article/details/144227301">
      TensorFlow深度学习实战（5）——神经网络性能优化技术详解
     </a>
     <br/>
     <a href="https://blog.csdn.net/LOVEmy134611/article/details/144253026">
      TensorFlow深度学习实战（6）——回归分析详解
     </a>
     <br/>
     <a href="https://blog.csdn.net/LOVEmy134611/article/details/144253050">
      TensorFlow深度学习实战（7）——分类任务详解
     </a>
     <br/>
     <a href="https://blog.csdn.net/LOVEmy134611/article/details/144276122">
      TensorFlow深度学习实战（8）——卷积神经网络
     </a>
     <br/>
     <a href="https://blog.csdn.net/LOVEmy134611/article/details/144276193">
      TensorFlow深度学习实战（9）——构建VGG模型实现图像分类
     </a>
     <br/>
     <a href="https://blog.csdn.net/LOVEmy134611/article/details/144276215">
      TensorFlow深度学习实战（10）——迁移学习详解
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
  <div class="blog-extension-box" id="blogExtensionBox" style="width:400px;margin:auto;margin-top:12px">
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f4c4f56456d793133343631312f:61727469636c652f64657461696c732f313436313935353934" class_="artid" style="display:none">
 </p>
</div>


