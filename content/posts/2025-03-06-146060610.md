---
layout: post
title: "Dify部署踩坑指南WindowsMac"
date: 2025-03-06 11:38:07 +0800
description: "⚠️！！！！！！！"
keywords: "dify 改源码host.docker.internal"
categories: ['本地知识库']
tags: ['Dify']
artid: "146060610"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146060610
    alt: "Dify部署踩坑指南WindowsMac"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146060610
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146060610
cover: https://bing.ee123.net/img/rand?artid=146060610
image: https://bing.ee123.net/img/rand?artid=146060610
img: https://bing.ee123.net/img/rand?artid=146060610
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Dify部署踩坑指南（Windows+Mac）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_0">
     </a>
     组件说明
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/faa4c559b93e4b54bbc5c818c9c87e85.png"/>
    </p>
    <h2>
     <a id="Dify_3">
     </a>
     Dify踩坑及解决方案
    </h2>
    <p>
     ⚠️
     <strong>
      除了修改镜像版本，nginx端口不要直接修改docker-compose.yaml
     </strong>
     ！！！！！！！
    </p>
    <h3>
     <a id="1_6">
     </a>
     1、更换镜像版本
    </h3>
    <p>
     这个文件是由.env自动生成的，在.env配置
    </p>
    <p>
     拉取dify-main后，默认的镜像版本是1.0.0，我将镜像版本修改为0.14.2是可以正常用的
     <br/>
     （开始在Mac中拉取的就是1.0.0的镜像版本，在添加模型供应商时提示组件缺失，需要再次手动下载各个模型供应商组件，0.14.2版本不存在这个问题）
    </p>
    <p>
     修改方式：在yaml中搜索1.0.0，将所有的版本号替换为0.14.2
    </p>
    <pre><code class="prism language-cpp">services<span class="token operator">:</span>
  <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">API service</span></span>
  api<span class="token operator">:</span>
    image<span class="token operator">:</span> langgenius<span class="token operator">/</span>dify<span class="token operator">-</span>api<span class="token operator">:</span><span class="token number">0.14</span><span class="token punctuation">.</span><span class="token number">2</span> 
</code></pre>
    <pre><code class="prism language-cpp"> web<span class="token operator">:</span>
    image<span class="token operator">:</span> langgenius<span class="token operator">/</span>dify<span class="token operator">-</span>web<span class="token operator">:</span><span class="token number">0.14</span><span class="token punctuation">.</span><span class="token number">2</span>
    restart<span class="token operator">:</span> always
</code></pre>
    <pre><code class="prism language-cpp"> <span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">worker</span> <span class="token expression">service</span></span>
  <span class="token macro property"><span class="token directive-hash">#</span> <span class="token expression">The Celery worker <span class="token keyword">for</span> processing the queue<span class="token punctuation">.</span></span></span>
  worker<span class="token operator">:</span>
    image<span class="token operator">:</span> langgenius<span class="token operator">/</span>dify<span class="token operator">-</span>api<span class="token operator">:</span><span class="token number">0.14</span><span class="token punctuation">.</span><span class="token number">2</span>
    restart<span class="token operator">:</span> always
</code></pre>
    <h3>
     <a id="2ollamadify_33">
     </a>
     2、ollama接入dify报错（容器网络隔离）
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/41052a10f0aa4962916206551c9eb560.jpeg#pic_center"/>
    </p>
    <blockquote>
     <p>
      Docker内部容器地址默认为127.0.0.1和localhost，非宿主机，需要将 Ollama 服务暴露给网络才可以正常接入
     </p>
    </blockquote>
    <p>
     解决：使用host.docker.internal
    </p>
    <h4>
     <a id="Windows_39">
     </a>
     Windows
    </h4>
    <p>
     Ollama的默认监听地址为127.0.0.1，导致其他容器无法访问，启动Ollama时指定监听所有网络接口0.0.0.0
    </p>
    <p>
     <strong>
      首先
     </strong>
     ，在系统环境变量中添加OLLAMA_HOST,值为0.0.0.0，并启动ollama
    </p>
    <pre><code class="prism language-cpp">ollama serve
</code></pre>
    <p>
     如果提示端口被占用，在任务管理器中关闭所有运行的ollama服务
    </p>
    <p>
     <strong>
      然后
     </strong>
     ，在宿主机上验证Ollama是否运行正常
    </p>
    <pre><code class="prism language-cpp">curl http<span class="token operator">:</span><span class="token comment">//localhost:11434</span>
</code></pre>
    <p>
     <strong>
      接着
     </strong>
     ，配置防火墙确保允许外部设备访问Ollama所使用的端口
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d4a4b30b2a8d4e668e6cc34d0a184dd9.jpeg#pic_center"/>
    </p>
    <h4>
     <a id="Mac_55">
     </a>
     Mac
    </h4>
    <p>
     1、设置Ollama环境变量
    </p>
    <pre><code class="prism language-cpp">launchctl setenv OLLAMA_HOST <span class="token string">"0.0.0.0"</span>
</code></pre>
    <p>
     如果是手动启动 Ollama，可以使用以下命令（临时）
    </p>
    <pre><code class="prism language-cpp">ollama serve <span class="token operator">--</span>host <span class="token number">0.0</span><span class="token punctuation">.</span><span class="token number">0.0</span>
</code></pre>
    <p>
     在 Dify 配置中使用 host.docker.internal
    </p>
    <p>
     2、从 Dify 容器中测试连接
    </p>
    <pre><code class="prism language-cpp">curl http<span class="token operator">:</span><span class="token comment">//host.docker.internal:11434</span>
</code></pre>
    <p>
     3、将 Ollama 的地址设置为
    </p>
    <pre><code class="prism language-cpp">http<span class="token operator">:</span><span class="token comment">//host.docker.internal:11434</span>
</code></pre>
    <h4>
     <a id="Linux_80">
     </a>
     Linux
    </h4>
    <p>
     在[Service]下加上Environment=“OLLAMA_HOST=0.0.0.0”
     <br/>
     <a href="https://blog.csdn.net/weixin_51455837/article/details/144189459?ops_request_misc=%257B%2522request%255Fid%2522%253A%25229d27d2cdd6b38af0c210338718b5d1bd%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=9d27d2cdd6b38af0c210338718b5d1bd&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-144189459-null-null.142%5Ev101%5Econtrol&amp;utm_term=dify%E6%8E%A5%E5%85%A5ollama%E6%8A%A5%E9%94%99&amp;spm=1018.2226.3001.4187">
      具体修改方法在这里
     </a>
    </p>
    <h3>
     <a id="3_83">
     </a>
     3、启动
    </h3>
    <p>
     在dify所在地址栏输入cmd，进入终端，拉取镜像，复制环境变量，采用默认端口启动
    </p>
    <pre><code class="prism language-cpp">cd dify<span class="token operator">/</span>docker
cp <span class="token punctuation">.</span>env<span class="token punctuation">.</span>example <span class="token punctuation">.</span>env
docker compose up <span class="token operator">-</span>d
</code></pre>
    <p>
     如果修改了配置，需要重启docker，命令如下：
    </p>
    <pre><code class="prism language-cpp">docker compose down
docker compose up <span class="token operator">-</span>d
</code></pre>
    <p>
     如果在拉取镜像中报错
    </p>
    <pre><code class="prism language-cpp">Error response from daemon<span class="token operator">:</span> Get “https<span class="token operator">:</span><span class="token comment">//registry-1.docker.io/v2/”: EOF</span>
</code></pre>
    <p>
     请docker镜像源换为国内镜像源
    </p>
    <h5>
     <a id="MacWindowsDocker_103">
     </a>
     Mac&amp;Windows在Docker桌面中修改
    </h5>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/14ebb178f65b4405901d41794ee3fc57.png">
      <br/>
      点击顶部齿轮，进入Docker Engine
     </img>
    </p>
    <blockquote>
     <p>
      #镜像源如下
     </p>
    </blockquote>
    <pre><code class="prism language-cpp">
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"registry-mirrors"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">"https://docker.1panel.live"</span><span class="token punctuation">,</span>
    <span class="token string">"https://docker.nju.edu.cn"</span><span class="token punctuation">,</span>
    <span class="token string">"https://docker.m.daocloud.io"</span><span class="token punctuation">,</span>
    <span class="token string">"https://dockerproxy.com"</span><span class="token punctuation">,</span>
    <span class="token string">"https://hub-mirror.c.163.com"</span><span class="token punctuation">,</span>
    <span class="token string">"https://docker.mirrors.ustc.edu.cn"</span><span class="token punctuation">,</span>
    <span class="token string">"https://registry.docker-cn.com"</span><span class="token punctuation">,</span>
    <span class="token string">"https://registry.cn-hangzhou.aliyuncs.com"</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="Linuxdaemonjson_125">
     </a>
     Linux请修改daemon.json文件
    </h5>
    <p>
     vim /etc/docker/daemon.json
     <br/>
     保存退出：esc–&gt;:wq–&gt;Enter
    </p>
    <h3>
     <a id="4url_128">
     </a>
     4、接入模型供应商时模型的url
    </h3>
    <blockquote>
     <p>
      模型供应商” &gt; “ollama” &gt; “添加”。
      <br/>
      将 URL 设置为 http://host.docker.internal:11434，让 Docker 通过内部地址访问
     </p>
    </blockquote>
    <p>
     Ollama的端口号默认为11434
    </p>
    <h3>
     <a id="_135">
     </a>
     端口冲突
    </h3>
    <h4>
     <a id="1Ollama_136">
     </a>
     1、Ollama端口被占用
    </h4>
    <p>
     如果之前部署过其他应用，用Ollama链接过其他应用，可能会遇到端口冲突的问题
     <br/>
     <strong>
      方法1:关闭其他占用Ollama的进程
     </strong>
     <br/>
     Windows
    </p>
    <pre><code class="prism language-cpp">netstat <span class="token operator">-</span>ano <span class="token operator">|</span> findstr <span class="token operator">:</span><span class="token number">11434</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5f2a713332334b34831af23a2b710e5e.png"/>
    </p>
    <p>
     Mac/Linux
    </p>
    <pre><code class="prism language-cpp">sudo lsof <span class="token operator">-</span>i <span class="token operator">:</span><span class="token number">11434</span>
</code></pre>
    <p>
     运行以下命令终止进程
     <br/>
     Windows
    </p>
    <pre><code class="prism language-cpp">taskkill <span class="token operator">/</span>PID <span class="token operator">&lt;</span>PID<span class="token operator">&gt;</span> <span class="token operator">/</span>F
</code></pre>
    <p>
     Mac/Linux
    </p>
    <pre><code class="prism language-cpp">kill <span class="token operator">-</span><span class="token number">9</span> <span class="token operator">&lt;</span>PID<span class="token operator">&gt;</span>
</code></pre>
    <p>
     <strong>
      方法2，修改Ollama默认端口号
     </strong>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/22cc197a50a144bbb5bedd82ae06517e.png"/>
    </p>
    <h4>
     <a id="2dify_167">
     </a>
     2、dify默认端口被占用
    </h4>
    <p>
     dify的默认web端口号80
     <br/>
     在docker中的.env文件中修改web端口号
     <br/>
     修改如下：
    </p>
    <blockquote>
     <p>
      EXPOSE_NGINX_PORT=8080 # 修改 Web 访问端口 （改这个）
      <br/>
      EXPOSE_NGINX_SSL_PORT=8443 # 修改 SSL 端口
      <br/>
      DIFY_PORT=5002 # 修改 API 服务端口
     </p>
    </blockquote>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34333030383331322f:61727469636c652f64657461696c732f313436303630363130" class_="artid" style="display:none">
 </p>
</div>


