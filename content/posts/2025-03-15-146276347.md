---
layout: post
title: "Certbot实现SSL免费证书自动续签CentOS-7版-Docker部署的nginx"
date: 2025-03-15 12:21:00 +0800
description: "docker容器部署的Nginx使用certbot实现SSL自动续期"
keywords: "Certbot实现SSL免费证书自动续签（CentOS 7版 + Docker部署的nginx）"
categories: ['未分类']
tags: ['Ssl', 'Docker', 'Centos']
artid: "146276347"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146276347
    alt: "Certbot实现SSL免费证书自动续签CentOS-7版-Docker部署的nginx"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146276347
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146276347
cover: https://bing.ee123.net/img/rand?artid=146276347
image: https://bing.ee123.net/img/rand?artid=146276347
img: https://bing.ee123.net/img/rand?artid=146276347
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Certbot实现SSL免费证书自动续签（CentOS 7版 + Docker部署的nginx）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     前置安装，可参考
     <a href="https://blog.csdn.net/u014681799/article/details/146276066?sharetype=blogdetail&amp;sharerId=146276066&amp;sharerefer=PC&amp;sharesource=u014681799&amp;spm=1011.2480.3001.8118">
      Certbot实现SSL免费证书自动续签（CentOS 7 + nginx/apache）
     </a>
    </p>
    <p>
     如果是通过
     <strong>
      Docker
     </strong>
     运行 Nginx，
     <code>
      certbot
     </code>
     无法直接检测到本地的 Nginx 配置。解决方案是
     <strong>
      使用 standalone 模式
     </strong>
     或
     <strong>
      挂载 Webroot
     </strong>
     方式获取 SSL 证书，并手动配置 Nginx。
    </p>
    <hr/>
    <h3>
     <a id="_1Standalone__Nginx__7">
     </a>
     <strong>
      方案 1：Standalone 模式（临时关闭 Nginx 获取证书）
     </strong>
    </h3>
    <p>
     如果你的服务器
     <strong>
      不支持 Webroot
     </strong>
     （或 Nginx 配置不方便修改），可以使用
     <strong>
      Standalone 模式
     </strong>
     ，但需要
     <strong>
      短暂关闭 Nginx
     </strong>
     。
    </p>
    <h4>
     <a id="1__Nginx__10">
     </a>
     <strong>
      1. 停止 Nginx 容器
     </strong>
    </h4>
    <p>
     先找到 Nginx 容器 ID：
    </p>
    <pre><code class="prism language-bash"><span class="token function">docker</span> <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> nginx
</code></pre>
    <p>
     然后停止容器：
    </p>
    <pre><code class="prism language-bash"><span class="token function">docker</span> stop <span class="token operator">&lt;</span>nginx-container-id<span class="token operator">&gt;</span>
</code></pre>
    <h4>
     <a id="2__SSL__20">
     </a>
     <strong>
      2. 申请 SSL 证书
     </strong>
    </h4>
    <p>
     运行 Certbot，使用
     <code>
      standalone
     </code>
     模式：
    </p>
    <pre><code class="prism language-bash">certbot certonly <span class="token parameter variable">--standalone</span> <span class="token parameter variable">-d</span> youdomain.com <span class="token parameter variable">-d</span> www.youdomain.com
</code></pre>
    <blockquote>
     <p>
      <strong>
       说明
      </strong>
      ：
     </p>
     <ul>
      <li>
       <code>
        certonly
       </code>
       ：只获取证书，不修改配置
      </li>
      <li>
       <code>
        --standalone
       </code>
       ：使用 Certbot 内置的 web 服务器进行验证（需要 80 端口）
      </li>
      <li>
       <code>
        -d
       </code>
       指定域名
      </li>
     </ul>
    </blockquote>
    <h4>
     <a id="3__Nginx_30">
     </a>
     <strong>
      3. 启动 Nginx
     </strong>
    </h4>
    <pre><code class="prism language-bash"><span class="token function">docker</span> start <span class="token operator">&lt;</span>nginx-container-id<span class="token operator">&gt;</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_2Webroot__Nginx_37">
     </a>
     <strong>
      方案 2：Webroot 模式（不停止 Nginx）
     </strong>
    </h3>
    <p>
     <strong>
      适用于 Nginx 容器可挂载
      <code>
       /var/www/html
      </code>
      或有
      <code>
       root
      </code>
      目录
     </strong>
    </p>
    <h4>
     <a id="1__Nginx__Webroot__40">
     </a>
     <strong>
      1. 确定 Nginx 容器的 Webroot 路径
     </strong>
    </h4>
    <p>
     进入容器：
    </p>
    <pre><code class="prism language-bash"><span class="token function">docker</span> <span class="token builtin class-name">exec</span> <span class="token parameter variable">-it</span> <span class="token operator">&lt;</span>nginx-container-id<span class="token operator">&gt;</span> <span class="token function">sh</span>
</code></pre>
    <p>
     查找
     <code>
      root
     </code>
     路径（通常是
     <code>
      /usr/share/nginx/html
     </code>
     ）：
    </p>
    <pre><code class="prism language-bash"><span class="token function">grep</span> <span class="token parameter variable">-r</span> <span class="token string">"root"</span> /etc/nginx/nginx.conf
</code></pre>
    <p>
     假设 Webroot 是
     <code>
      /usr/share/nginx/html
     </code>
     ，退出容器。
    </p>
    <h4>
     <a id="2__SSL__51">
     </a>
     <strong>
      2. 申请 SSL 证书
     </strong>
    </h4>
    <p>
     在宿主机运行：
    </p>
    <pre><code class="prism language-bash">certbot certonly <span class="token parameter variable">--webroot</span> <span class="token parameter variable">-w</span> /usr/share/nginx/html <span class="token parameter variable">-d</span> youdomain.com <span class="token parameter variable">-d</span> www.youdomain.com
</code></pre>
    <p>
     输入邮箱后按enter
     <br/>
     协议输入Y后按enter
     <br/>
     是否接收来自官方的新闻等邮件通知，可以选择Y/N，不影响使用
    </p>
    <h4>
     <a id="3__Nginx__SSL_59">
     </a>
     <strong>
      3. 配置 Nginx 使用 SSL
     </strong>
    </h4>
    <p>
     编辑
     <code>
      nginx.conf
     </code>
     （在
     <code>
      server
     </code>
     配置中添加 SSL）：
    </p>
    <pre><code class="prism language-nginx">server {
    listen 443 ssl;
    server_name youdomain.com www.youdomain.com;

    ssl_certificate /etc/letsencrypt/live/youdomain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/youdomain.com/privkey.pem;

    location / {
        root /usr/share/nginx/html;
        index index.html;
    }
}
</code></pre>
    <p>
     <mark>
      <strong>
       注意：容器要挂载/etc/letsencrypt目录 :ro表示只读
      </strong>
     </mark>
    </p>
    <pre><code>-v /etc/letsencrypt:/etc/letsencrypt:ro
</code></pre>
    <p>
     然后重启 Nginx：
    </p>
    <pre><code class="prism language-bash"><span class="token function">docker</span> restart <span class="token operator">&lt;</span>nginx-container-id<span class="token operator">&gt;</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_SSL__87">
     </a>
     <strong>
      配置 SSL 证书自动续约
     </strong>
    </h3>
    <p>
     Let’s Encrypt 证书
     <strong>
      90 天
     </strong>
     后过期，因此需要自动续约。
    </p>
    <h4>
     <a id="1__90">
     </a>
     <strong>
      1. 测试续约
     </strong>
    </h4>
    <pre><code class="prism language-bash">certbot renew --dry-run
</code></pre>
    <p>
     如果显示
     <code>
      Congratulations
     </code>
     ，说明续约正常。
    </p>
    <h4>
     <a id="2__96">
     </a>
     <strong>
      2. 设置自动续约
     </strong>
    </h4>
    <p>
     添加
     <code>
      crontab
     </code>
     任务，每天检查证书并重启 Nginx：
    </p>
    <pre><code class="prism language-bash"><span class="token function">crontab</span> <span class="token parameter variable">-e</span>
</code></pre>
    <p>
     添加：
    </p>
    <pre><code class="prism language-bash"><span class="token number">0</span> <span class="token number">2</span> * * * certbot renew <span class="token parameter variable">--quiet</span> --deploy-hook <span class="token string">"docker restart &lt;nginx-container-id&gt;"</span>
</code></pre>
    <blockquote>
     <p>
      <strong>
       解释
      </strong>
      ：
     </p>
     <ul>
      <li>
       <code>
        0 2 * * *
       </code>
       ：每天凌晨 2 点运行
      </li>
      <li>
       <code>
        certbot renew --quiet
       </code>
       ：静默续约
      </li>
      <li>
       <code>
        delopy-hook
       </code>
       ：只有成功续期后才执行后面的命令
      </li>
      <li>
       <code>
        docker restart nginx
       </code>
       ：续约后重启 Nginx 使新证书生效
      </li>
     </ul>
    </blockquote>
    <hr/>
    <h3>
     <a id="_113">
     </a>
     <strong>
      验证证书是否生效
     </strong>
    </h3>
    <pre><code class="prism language-bash">certbot certificates
或者
openssl s_client <span class="token parameter variable">-connect</span> yourdomain.com:443 <span class="token parameter variable">-servername</span> yourdomain.com <span class="token operator">|</span> openssl x509 <span class="token parameter variable">-noout</span> <span class="token parameter variable">-dates</span>
</code></pre>
    <p>
     如果
     <code>
      Not After
     </code>
     日期已更新，说明证书续约成功！✅
    </p>
    <hr/>
    <h4>
     <a id="_123">
     </a>
     <strong>
      总结
     </strong>
    </h4>
    <ul>
     <li>
      <strong>
       Docker 运行 Nginx 不能直接用
       <code>
        certbot --nginx
       </code>
      </strong>
     </li>
     <li>
      <strong>
       推荐
       <code>
        standalone
       </code>
       模式（需临时关闭 Nginx）
      </strong>
     </li>
     <li>
      <strong>
       或者
       <code>
        webroot
       </code>
       模式（需手动修改 Nginx 配置）
      </strong>
     </li>
     <li>
      <strong>
       自动续约通过
       <code>
        cron
       </code>
       计划任务完成
      </strong>
     </li>
    </ul>
    <p>
     这样，你的
     <strong>
      SSL 证书会自动更新，无需手动操作
     </strong>
     ！🚀
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f753031343638313739392f:61727469636c652f64657461696c732f313436323736333437" class_="artid" style="display:none">
 </p>
</div>


