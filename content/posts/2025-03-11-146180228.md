---
layout: post
title: "基于Golang的微服务Consul"
date: 2025-03-11 15:27:20 +0800
description: "和服务类似,一个检查可以通过检查定义或HTTP API请求来注册.我们将使用和检查定义来注册检查.和服务类似,因为这是建立检查最常用的方式.// 健康检查的 HTTP API 方式 curl http://localhost:8500/v1/health/state/critical重启agent或者发送SIGHUP信号,就可以看到日志输出。"
keywords: "基于Golang的微服务——Consul"
categories: ['未分类']
tags: ['微服务', 'Golang', 'Consul']
artid: "146180228"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146180228
    alt: "基于Golang的微服务Consul"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146180228
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146180228
cover: https://bing.ee123.net/img/rand?artid=146180228
image: https://bing.ee123.net/img/rand?artid=146180228
img: https://bing.ee123.net/img/rand?artid=146180228
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     基于Golang的微服务——Consul
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <blockquote>
     <p>
      自我简介：4年导游，10年程序员，最近6年一直深耕低代码领域，分享低代码和AI领域见解。
     </p>
    </blockquote>
    <p>
     这系列文章很基础，主要给想尝试后端技术栈的前端看的，后端大佬别看了，很可能浪费你的时间。
    </p>
    <p>
     虽然我更擅长写前端相关的知识点总结文章，但是也阻止不了我对后端技术的向往啊,后端相关的文章质量不会高，主要目的是为了记录自己的学习历程，也是希望把自己的短板和缺点暴露出来，跟小伙伴们一起成长。
    </p>
    <h3>
     <a id="_5">
     </a>
     初衷
    </h3>
    <p>
     学习Go很大一个原因是因为想尝试写微服务，于是在探索Go构建微服务的道路上越走越远，甚至有些求快和焦躁了，但是在成长就行。
    </p>
    <h3>
     <a id="Consul__8">
     </a>
     Consul 是什么？
    </h3>
    <p>
     首先奉上中文文档
     <a href="https://book-consul-guide.vnzmi.com/" rel="nofollow">
      Consul
     </a>
     .
    </p>
    <p>
     Consul由多个模块组成，是一个为基础设施提供服务发现和服务配置的工具。当用微服务架构时，传统的单体应用全部拆分为了细粒度的功能模块，这些模块就是微服务，他们可以拥有自己独立的数据库，遵循单一职责原则，可以独立部署。减少系统之间的耦合。那这么多的微服务之间怎么相互调用和发现呢？就可以借助consul来集中注册管理来。
    </p>
    <ul>
     <li>
      <strong>
       服务发现：
      </strong>
      Consul的客户端可用提供一个服务,比如 api 或者mysql ,另外一些客户端可用使用Consul去发现(依赖的是Http / DNS)一个指定服务的提供者。
     </li>
     <li>
      <strong>
       健康检查：
      </strong>
      避免将流量发送到不健康的主机。
     </li>
     <li>
      <strong>
       Key/Value存储
      </strong>
      可以理解为简易的数据库，可以完成动态配置,功能标记,协调,领袖选举等功能。
     </li>
     <li>
      <strong>
       多数据中心
      </strong>
      可以将项目部署拓展到多个数据中心。
     </li>
    </ul>
    <h3>
     <a id="_18">
     </a>
     运行原理
    </h3>
    <p>
     每个服务节点（这个节点可以理解为一个服务器或者一个容器）都运行了一个Consul agent。这个agent是负责对节点自身和节点上的服务进行健康检查的。consul 可以用两种模式运行 server 和 client ,其中 server模式是以集群的方式运行的，最少建议 3-5台服务器/容器。每个数据中心（可以是多个服务器节点 / 容器的集合）至少必须拥有一台server。
    </p>
    <pre><code class="prism language-bash">consul agent <span class="token parameter variable">-dev</span>
consul members
</code></pre>
    <p>
     可以启动 consul,然后查看当前集群的成员
    </p>
    <p>
     也可以通过Http 和 DNS 的方式查询集群信息
    </p>
    <pre><code class="prism language-bash"><span class="token function">curl</span> localhost:8500/v1/catalog/nodes

<span class="token function">dig</span> @127.0.0.1 <span class="token parameter variable">-p</span> <span class="token number">8600</span> Armons-MacBook-Air.node.consul
</code></pre>
    <h3>
     <a id="_34">
     </a>
     服务注册
    </h3>
    <p>
     服务注册有两种方式：
    </p>
    <ul>
     <li>
      <strong>
       服务定义文件
      </strong>
     </li>
     <li>
      <strong>
       调用HTTP API注册
      </strong>
     </li>
    </ul>
    <p>
     为Consul配置创建一个目录.Consul会载入配置文件夹里的所有配置文件。
    </p>
    <pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">mkdir</span> /etc/consul.d 

// 写入配置
<span class="token builtin class-name">echo</span> <span class="token string">'{"service": {"name": "web", "tags": ["rails"], "port": 80}}'</span> <span class="token punctuation">\</span>
    <span class="token operator">&gt;</span>/etc/consul.d/web.json
    
// Consul服务重启
consul agent <span class="token parameter variable">-dev</span> -config-dir /etc/consul.d
</code></pre>
    <p>
     .d 后缀意思是这个路径包含了一组配置文件.
    </p>
    <h3>
     <a id="_55">
     </a>
     服务查询
    </h3>
    <p>
     一旦agent启动并且服务同步了.我们可以通过DNS或者HTTP的API来查询服务.
     <br/>
     在DNS API中,服务的DNS名字是
     <code>
      NAME.service.consul
     </code>
     NAME是服务的名称
    </p>
    <p>
     对于我们上面注册的Web服务.它的域名是
     <code>
      web.service.consul
     </code>
    </p>
    <pre><code class="prism language-bash"><span class="token function">dig</span> @127.0.0.1 <span class="token parameter variable">-p</span> <span class="token number">8600</span> web.service.consul
// 会返回一个A记录返回了一个可用的服务所在的节点的IP地址

<span class="token function">dig</span> @127.0.0.1 <span class="token parameter variable">-p</span> <span class="token number">8600</span> web.service.consul SRV
//接收包含 地址，服务节点和端口的 SRV记录

<span class="token function">curl</span> http://localhost:8500/v1/catalog/service/web
// 通过 Http API 方式查询
</code></pre>
    <h3>
     <a id="_71">
     </a>
     更新服务
    </h3>
    <p>
     服务定义可以通过配置文件并发送SIGHUP给agent来进行更新.这样你可以让你在不关闭服务或者保持服务请求可用的情况下进行更新.
     <br/>
     另外 HTTP API可以用来动态的添加,移除和修改服务.
    </p>
    <h3>
     <a id="_75">
     </a>
     拓展集群
    </h3>
    <p>
     将Consul 拓展成面向生成环境，拥有多个成员的服务发现架构。
     <br/>
     当一个agent启动时。他是孤立的，通过与存在的集群成员沟通来发现其他成员。
     <br/>
     Consul agent可以加入任何agent而不只是出于server模式的agent
    </p>
    <ul>
     <li>
      <p>
       每个集群中的节点都必须要一个唯一的名字.Consul默认会使用机器的hostname.我们
       <br/>
       可以使用-node手动覆盖他.
      </p>
     </li>
     <li>
      <p>
       我们也可以使用-bind指定一个绑定的地址让Consul在这个地址上进行监听,这个地址必须可以被其他集群成员访问到
      </p>
     </li>
    </ul>
    <pre><code class="prism language-bash">consul agent <span class="token parameter variable">-server</span> -bootstrap-expect <span class="token number">1</span>  -data-dir /tmp/consul <span class="token parameter variable">-node</span><span class="token operator">=</span>hdp2 <span class="token parameter variable">-bind</span><span class="token operator">=</span><span class="token number">10.0</span>.0.52  -config-dir /etc/consul.d
</code></pre>
    <p>
     参数介绍：
    </p>
    <ul>
     <li>
      -server : 告诉consul agent节点将扮演集群的唯一server
     </li>
     <li>
      -bootstrap-expect : 提示Consul我们期待加入的server节点的数量
     </li>
     <li>
      -config-dir : 指定服务和健康检查定义文件存放的路径
     </li>
     <li>
      -node : 覆盖默认的节点名称
     </li>
     <li>
      -bind : 绑定一个固定地址
     </li>
     <li>
      -data-dir ： 为agent存储状态提供了一个数据目录
     </li>
    </ul>
    <pre><code class="prism language-bash">consul <span class="token function">join</span> <span class="token number">10.0</span>.0.53
// 当前agent加入 <span class="token number">10.0</span>.0.53 agent
</code></pre>
    <h3>
     <a id="_103">
     </a>
     节点查询
    </h3>
    <p>
     就像查询服务一样.Consul有一个API用来查询节点自己.你可以通过DNS和HTTP的API来进行.
    </p>
    <p>
     DNS API中节点名称结构为 NAME.node.consul或者NAME.node.DATACENTER.consul.如果数据中心名字省略,Consul只会查询本地数据中心.
    </p>
    <pre><code class="prism language-bash"><span class="token function">dig</span> @127.0.0.1 <span class="token parameter variable">-p</span> <span class="token number">8600</span> hdp3.node.consul
</code></pre>
    <h3>
     <a id="_112">
     </a>
     退出集群
    </h3>
    <p>
     离开集群,你可以Ctrl-C优雅的退出,也可以直接Kill掉agent进程.优雅的退出可以让节点转变为离开状态.否则节点将被标记为失败.
    </p>
    <h3>
     <a id="_115">
     </a>
     定义检查
    </h3>
    <p>
     和服务类似,一个检查可以通过检查定义或HTTP API请求来注册.
     <br/>
     我们将使用和检查定义来注册检查.和服务类似,因为这是建立检查最常用的方式.
    </p>
    <pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> <span class="token string">'{"check": {"name": "ping",
  "script": "ping -c1 163.com &gt;/dev/null", "interval": "30s"}}'</span> <span class="token punctuation">\</span>
  <span class="token operator">&gt;</span>/etc/consul.d/ping.json

// 健康检查的 HTTP API 方式
<span class="token function">curl</span> http://localhost:8500/v1/health/state/critical
</code></pre>
    <p>
     重启agent或者发送SIGHUP信号,就可以看到日志输出。
    </p>
    <h3>
     <a id="web_129">
     </a>
     启动web界面
    </h3>
    <pre><code class="prism language-bash">consul agent <span class="token parameter variable">-ui</span>

http://localhost:8500/ui 
</code></pre>
    <p>
     未完待续。。。
    </p>
    <p>
     AI时代，对各行业的冲击力只会越来越大，随着AI大模型的竞赛，越来越多强悍的AI模型都会涌现，像软件开发行业的很多工作都会被取代。软件将不再是程序员的专属产物，会由AI创建很多的软件产品。
    </p>
    <p>
     4年导游，10年程序员，深耕低代码领域6年，持续分享低代码和AI领域领域有价值的思考和沉淀，欢迎关注：winyh5
    </p>
    <p>
     后续会推出：【挑战365天做 100 套常见的互联网系统】系列文章，让大家可以真实感受到低代码快速落地项目的可行性
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f67:2e6373646e2e6e65742f73696e61745f33333337303436382f:61727469636c652f64657461696c732f313436313830323238" class_="artid" style="display:none">
 </p>
</div>


