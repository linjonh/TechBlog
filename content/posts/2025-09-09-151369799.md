---
layout: post
title: "Elasticsearché¢è¯•ç²¾è®²-Day-14æ•°æ®å†™å…¥ä¸åˆ·æ–°æœºåˆ¶"
date: 2025-09-09T19:31:43+0800
description: "å½“ä¸€ä¸ªæ–‡æ¡£è¢«å†™å…¥ Elasticsearch æ—¶ï¼Œå®ƒå¹¶ä¸ä¼šç«‹å³å¯¹æœç´¢å¯è§ã€‚Elasticsearch é‡‡ç”¨äº†ä¸€ç§ç§°ä¸ºè¿‘å®æ—¶ï¼ˆNRT, Near Real-Timeï¼‰çš„è®¾è®¡ï¼Œé€šè¿‡ä¸€ç³»åˆ—å¼‚æ­¥æ“ä½œæ¥å¹³è¡¡å†™å…¥æ€§èƒ½ä¸æœç´¢å»¶è¿Ÿã€‚å†™å…¥å†…å­˜ç¼“å†²åŒºï¼ˆIn-Memory Bufferï¼‰è¿½åŠ äº‹åŠ¡æ—¥å¿—ï¼ˆTranslogï¼‰Refresh æ“ä½œï¼šç”Ÿæˆæ–° segmentï¼Œä½¿æ–‡æ¡£å¯æœç´¢Flush æ“ä½œï¼šæŒä¹…åŒ– segment åˆ°ç£ç›˜å¹¶æ¸…ç©º translogğŸ’¡ ç±»æ¯”ç†è§£ï¼šå¯ä»¥æŠŠå†™å…¥è¿‡ç¨‹æƒ³è±¡æˆâ€œè®°è´¦â€ã€‚"
keywords: "Elasticsearché¢è¯•ç²¾è®² Day 14ï¼šæ•°æ®å†™å…¥ä¸åˆ·æ–°æœºåˆ¶"
categories: ['Elasticsearch']
tags: ['é¢è¯•', 'æœç´¢å¼•æ“', 'å¤§æ•°æ®', 'åˆ†å¸ƒå¼', 'Elasticsearch']
artid: "151369799"
arturl: "https://blog.csdn.net/qq_qingtian/article/details/151369799"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=151369799
    alt: "Elasticsearché¢è¯•ç²¾è®²-Day-14æ•°æ®å†™å…¥ä¸åˆ·æ–°æœºåˆ¶"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=151369799
featuredImagePreview: https://bing.ee123.net/img/rand?artid=151369799
cover: https://bing.ee123.net/img/rand?artid=151369799
image: https://bing.ee123.net/img/rand?artid=151369799
img: https://bing.ee123.net/img/rand?artid=151369799
---



# Elasticsearché¢è¯•ç²¾è®² Day 14ï¼šæ•°æ®å†™å…¥ä¸åˆ·æ–°æœºåˆ¶



## ã€Elasticsearché¢è¯•ç²¾è®² Day 14ã€‘æ•°æ®å†™å…¥ä¸åˆ·æ–°æœºåˆ¶

åœ¨â€œElasticsearché¢è¯•ç²¾è®²â€ç³»åˆ—çš„ç¬¬14å¤©ï¼Œæˆ‘ä»¬å°†æ·±å…¥æ¢è®¨ **æ•°æ®å†™å…¥ä¸åˆ·æ–°æœºåˆ¶** è¿™ä¸€æ ¸å¿ƒåº•å±‚åŸç†ã€‚ä½œä¸ºç†è§£ Elasticsearch â€œè¿‘å®æ—¶æœç´¢ï¼ˆNear Real-Time Searchï¼‰â€ç‰¹æ€§çš„å…³é”®ï¼ŒæŒæ¡å…¶å†™å…¥æµç¨‹ã€refresh æœºåˆ¶ã€translog ä½œç”¨ä»¥åŠ segment çš„ç”Ÿæˆè¿‡ç¨‹ï¼Œæ˜¯åŒºåˆ†åˆçº§ä½¿ç”¨è€…ä¸é«˜çº§å·¥ç¨‹å¸ˆçš„é‡è¦åˆ†æ°´å²­ã€‚

æœ¬ç¯‡æ–‡ç« å°†ç³»ç»Ÿè§£æ Elasticsearch ä»æ¥æ”¶åˆ°æ–‡æ¡£å†™å…¥è¯·æ±‚ï¼Œåˆ°æ•°æ®å¯è¢«æœç´¢çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸï¼Œæ¶µç›– `refresh`ã€`flush`ã€`translog`ã€`segment` ç­‰æ ¸å¿ƒæ¦‚å¿µï¼Œç»“åˆ REST API å’Œ Java ä»£ç ç¤ºä¾‹ï¼Œå¹¶é€šè¿‡çœŸå®ç”Ÿäº§æ¡ˆä¾‹æ­ç¤ºå¸¸è§æ€§èƒ½ç“¶é¢ˆä¸ä¼˜åŒ–ç­–ç•¥ã€‚è¿™äº›å†…å®¹ä¸ä»…æ˜¯ä¸­é«˜çº§é¢è¯•ä¸­çš„å¿…è€ƒé¢˜ï¼Œæ›´æ˜¯è°ƒä¼˜ç´¢å¼•æ€§èƒ½ã€ä¿éšœæ•°æ®å®‰å…¨çš„åŸºç¡€ã€‚

---

### ä¸€ã€æ¦‚å¿µè§£æï¼šä»€ä¹ˆæ˜¯æ•°æ®å†™å…¥ä¸åˆ·æ–°æœºåˆ¶ï¼Ÿ

å½“ä¸€ä¸ªæ–‡æ¡£è¢«å†™å…¥ Elasticsearch æ—¶ï¼Œå®ƒå¹¶ä¸ä¼šç«‹å³å¯¹æœç´¢å¯è§ã€‚Elasticsearch é‡‡ç”¨äº†ä¸€ç§ç§°ä¸º **è¿‘å®æ—¶ï¼ˆNRT, Near Real-Timeï¼‰** çš„è®¾è®¡ï¼Œé€šè¿‡ä¸€ç³»åˆ—å¼‚æ­¥æ“ä½œæ¥å¹³è¡¡å†™å…¥æ€§èƒ½ä¸æœç´¢å»¶è¿Ÿã€‚

#### æ ¸å¿ƒæµç¨‹æ¦‚è¿°ï¼š

1. **å†™å…¥å†…å­˜ç¼“å†²åŒºï¼ˆIn-Memory Bufferï¼‰**
2. **è¿½åŠ äº‹åŠ¡æ—¥å¿—ï¼ˆTranslogï¼‰**
3. **Refresh æ“ä½œï¼šç”Ÿæˆæ–° segmentï¼Œä½¿æ–‡æ¡£å¯æœç´¢**
4. **Flush æ“ä½œï¼šæŒä¹…åŒ– segment åˆ°ç£ç›˜å¹¶æ¸…ç©º translog**

> ğŸ’¡ ç±»æ¯”ç†è§£ï¼šå¯ä»¥æŠŠå†™å…¥è¿‡ç¨‹æƒ³è±¡æˆâ€œè®°è´¦â€ã€‚å…ˆåœ¨è‰ç¨¿çº¸ï¼ˆbufferï¼‰ä¸Šè®°å½•ï¼ŒåŒæ—¶åœ¨æ­£å¼è´¦æœ¬ï¼ˆtranslogï¼‰ä¸Šå¤‡ä»½ï¼›æ¯éš”ä¸€æ®µæ—¶é—´æŠŠè‰ç¨¿æ•´ç†æˆä¸€é¡µæ–°è´¦ç°¿ï¼ˆsegmentï¼‰ï¼Œä¾›å¤§å®¶æŸ¥é˜…ï¼ˆrefreshï¼‰ï¼›æœ€åå®šæœŸå½’æ¡£ï¼ˆflushï¼‰ã€‚

#### å…³é”®æœ¯è¯­è¯´æ˜ï¼š

| æœ¯è¯­ | å«ä¹‰ |
| --- | --- |
| **Indexing Buffer** | å†…å­˜ç¼“å†²åŒºï¼Œæš‚å­˜æ–°å†™å…¥çš„æ–‡æ¡£ |
| **Translogï¼ˆTransaction Logï¼‰** | äº‹åŠ¡æ—¥å¿—ï¼Œç”¨äºæ•…éšœæ¢å¤ |
| **Segment** | ä¸å¯å˜çš„å€’æ’ç´¢å¼•æ–‡ä»¶å•å…ƒ |
| **Refresh** | å°†å†…å­˜ä¸­çš„æ–‡æ¡£æäº¤ä¸ºå¯æœç´¢çŠ¶æ€ |
| **Flush** | å°† segment å†™å…¥ç£ç›˜å¹¶é‡ç½® translog |

---

### äºŒã€åŸç†å‰–æï¼šæ•°æ®å†™å…¥çš„åº•å±‚å®ç°æœºåˆ¶

#### 1. æ•°æ®å†™å…¥å…¨æµç¨‹å›¾è§£ï¼ˆæ— å›¾æ–‡å­—æè¿°ï¼‰

```text
Client â†’ HTTP Request â†’ Index Request
â†“
å†™å…¥ Translogï¼ˆæŒä¹…åŒ–ï¼‰
â†“
å†™å…¥ In-Memory Buffer
â†“
[refresh] â†’ åˆ›å»ºæ–° Segmentï¼ˆLucene Indexï¼‰
â†“
Segment è¢«æ‰“å¼€ â†’ æ–‡æ¡£å¯è¢«æœç´¢
â†“
[flush] â†’ Segment æŒä¹…åŒ–åˆ°ç£ç›˜ï¼ŒTranslog æ¸…é™¤

```

#### 2. Refresh æœºåˆ¶è¯¦è§£

* é»˜è®¤æ¯ **1ç§’** è‡ªåŠ¨æ‰§è¡Œä¸€æ¬¡ `refresh`ï¼›
* è§¦å‘æ¡ä»¶ï¼š
* æ—¶é—´é—´éš”è¾¾åˆ° `index.refresh_interval`ï¼ˆé»˜è®¤ `1s`ï¼‰
* æ‰‹åŠ¨è°ƒç”¨ `_refresh` API
* æŸ¥è¯¢å‰è‹¥è¶…è¿‡ `refresh_interval`ï¼Œä¹Ÿå¯èƒ½è§¦å‘

> âœ… å› æ­¤ Elasticsearch è¢«ç§°ä¸ºâ€œè¿‘å®æ—¶â€ï¼Œè€Œéâ€œå®æ—¶â€ã€‚

##### ä¿®æ”¹ refresh_interval ç¤ºä¾‹ï¼š

```json
PUT /my-index/_settings
{
"index.refresh_interval": "30s"
}

```

ğŸ“Œ é€‚ç”¨åœºæ™¯ï¼šæ—¥å¿—ç±»ç´¢å¼•ï¼Œé™ä½ segment ç”Ÿæˆé¢‘ç‡ï¼Œå‡å°‘æ–‡ä»¶å¥æŸ„æ¶ˆè€—ã€‚

---

#### 3. Translog çš„ä½œç”¨ä¸é…ç½®

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
| --- | --- | --- |
| `index.translog.durability` | `request` | æ˜¯å¦æ¯æ¬¡å†™å…¥éƒ½ fsync |
| `index.translog.sync_interval` | `5s` | å®šæœŸåŒæ­¥ translog åˆ°ç£ç›˜ |
| `index.translog.retention.size` | `512mb` | æœ€å¤§ä¿ç•™å¤§å° |
| `index.translog.retention.age` | `12h` | æœ€å¤§ä¿ç•™æ—¶é—´ |

* `durability=request`ï¼šæ¯æ¬¡ç´¢å¼•è¯·æ±‚å syncï¼Œä¿è¯ä¸ä¸¢æ•°æ®ï¼›
* `durability=async`ï¼šæŒ‰ `sync_interval` å¼‚æ­¥ syncï¼Œæå‡ååä½†æœ‰ä¸¢å¤±é£é™©ã€‚

> âš ï¸ ç”Ÿäº§ç¯å¢ƒå»ºè®®ä¿æŒ `request`ï¼Œé™¤éå®¹å¿å°‘é‡ä¸¢å¤±ã€‚

---

#### 4. Flush æ“ä½œè§¦å‘æ—¶æœº

* æ¯ **30åˆ†é’Ÿ** æˆ– translog å¤§å°è¾¾åˆ° `index.translog.flush_threshold_size`ï¼ˆé»˜è®¤ `512mb`ï¼‰ï¼›
* æ‰€æœ‰æ“ä½œå®Œæˆåå¼ºåˆ¶ flushï¼ˆå¦‚å…³é—­ç´¢å¼•ï¼‰ï¼›
* å¯æ‰‹åŠ¨è§¦å‘ï¼š

```bash
POST /my-index/_flush

```

Flush åä¼šï¼š

* å°†å½“å‰æ‰€æœ‰ in-memory segments å†™å…¥ç£ç›˜ï¼›
* æäº¤ä¸€ä¸ªæ–°çš„ commit pointï¼›
* æ¸…ç©º translogã€‚

---

### ä¸‰ã€ä»£ç å®ç°ï¼šå…³é”®æ“ä½œç¤ºä¾‹

#### ç¤ºä¾‹ 1ï¼šæ§åˆ¶ refresh è¡Œä¸ºä»¥æå‡æ‰¹é‡å†™å…¥æ€§èƒ½

```java
import org.elasticsearch.action.index.IndexRequest;
import org.elasticsearch.client.RequestOptions;
import org.elasticsearch.client.RestHighLevelClient;
import org.elasticsearch.common.xcontent.XContentType;

import java.io.IOException;
import java.util.HashMap;

public class BulkIndexWithNoRefresh {

public static void main(String[] args) throws IOException {
RestHighLevelClient client = new RestHighLevelClient(
RestClient.builder(new HttpHost("localhost", 9200, "http")));

// æ­¥éª¤1ï¼šä¸´æ—¶å…³é—­è‡ªåŠ¨ refresh
client.indices().putSettings(RequestOptions.DEFAULT, IndicesPutSettingsRequest.of(r -> r
.indices("my-bulk-index")
.settings(s -> s.put("index.refresh_interval", "-1"))));

// æ­¥éª¤2ï¼šæ‰¹é‡å†™å…¥å¤§é‡æ–‡æ¡£
for (int i = 0; i < 10000; i++) {
HashMap<String, Object> source = new HashMap<>();
source.put("id", i);
source.put("message", "log entry " + i);
source.put("timestamp", System.currentTimeMillis());

IndexRequest request = new IndexRequest("my-bulk-index")
.id(String.valueOf(i))
.source(source, XContentType.JSON);

client.index(request, RequestOptions.DEFAULT);
}

// æ­¥éª¤3ï¼šæ‰‹åŠ¨ refreshï¼Œä½¿æ•°æ®å¯æŸ¥
client.indices().refresh(RequestOptions.DEFAULT, RefreshRequest.of(r -> r.index("my-bulk-index")));

// æ­¥éª¤4ï¼šæ¢å¤ refresh_interval
client.indices().putSettings(RequestOptions.DEFAULT, IndicesPutSettingsRequest.of(r -> r
.indices("my-bulk-index")
.settings(s -> s.put("index.refresh_interval", "1s"))));

client.close();
}
}

```

ğŸ“Œ **ç”¨é€”**ï¼šé€‚ç”¨äºå¤§æ‰¹é‡å¯¼å…¥åœºæ™¯ï¼Œé¿å…é¢‘ç¹ refresh å¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚

---

#### ç¤ºä¾‹ 2ï¼šæ‰‹åŠ¨è§¦å‘ refresh ä¿è¯æµ‹è¯•æ•°æ®ç«‹å³å¯è§

```json
POST /test-index/_refresh

```

æˆ–åœ¨ç´¢å¼•æ–‡æ¡£åç«‹å³åˆ·æ–°ï¼š

```json
PUT /test-index/_doc/1?refresh=true
{
"title": "Test Document",
"status": "published"
}

```

> âœ… ä½¿ç”¨ `?refresh=true` å¯ç¡®ä¿åç»­æŸ¥è¯¢èƒ½ç«‹å³çœ‹åˆ°è¯¥æ–‡æ¡£ï¼Œå¸¸ç”¨äºå•å…ƒæµ‹è¯•æˆ–è°ƒè¯•ã€‚

---

#### ç¤ºä¾‹ 3ï¼šç›‘æ§ segment ä¸ translog çŠ¶æ€

```bash
GET /my-index/_segments

```

è¿”å›å­—æ®µå…³é”®ä¿¡æ¯ï¼š

* `num_committed_segments`ï¼šå·²æäº¤çš„ segment æ•°é‡
* `memory_in_bytes`ï¼šå†…å­˜å ç”¨
* `committed`ï¼šæ˜¯å¦å·²æŒä¹…åŒ–

```bash
GET /my-index/_stats/translog

```

æŸ¥çœ‹ translog å½“å‰å¤§å°å’Œæ“ä½œæ•°ã€‚

---

### å››ã€é¢è¯•é¢˜è§£æï¼šé«˜é¢‘è€ƒç‚¹æ·±åº¦æ‹†è§£

#### â“ é¢è¯•é¢˜ 1ï¼šElasticsearch æ˜¯å®æ—¶çš„å—ï¼Ÿä¸ºä»€ä¹ˆæ–°å¢æ–‡æ¡£ä¸æ˜¯ç«‹åˆ»å°±èƒ½æœåˆ°ï¼Ÿ

âœ… **ç»“æ„åŒ–ç­”é¢˜æ¨¡æ¿ï¼ˆPREPï¼‰**

> **Point**ï¼šElasticsearch æ˜¯è¿‘å®æ—¶ï¼ˆNRTï¼‰ï¼Œä¸æ˜¯ä¸¥æ ¼æ„ä¹‰ä¸Šçš„å®æ—¶ã€‚
>
> **Reason**ï¼š
>
> * æ–°æ–‡æ¡£å…ˆå†™å…¥å†…å­˜ buffer å’Œ translogï¼›
> * æ¯éš” `refresh_interval`ï¼ˆé»˜è®¤ 1sï¼‰æ‰ä¼šç”Ÿæˆæ–° segment å¹¶å¼€æ”¾æœç´¢ï¼›
> * è¿™ä¸ªå»¶è¿Ÿæ˜¯ä¸ºäº†é¿å…é¢‘ç¹ç”Ÿæˆ segment å¯¼è‡´æ€§èƒ½é—®é¢˜ï¼›
>
> **Example**ï¼š
>
> * å¯é€šè¿‡ `?refresh=true` å¼ºåˆ¶ç«‹å³å¯è§ï¼›
> * æˆ–è®¾ç½® `refresh_interval=-1` å…³é—­è‡ªåŠ¨ refresh æå‡å†™å…¥é€Ÿåº¦ï¼›
>
> **Point**ï¼šè¿™æ˜¯æ€§èƒ½ä¸å®æ—¶æ€§ä¹‹é—´çš„æƒè¡¡è®¾è®¡ã€‚

---

#### â“ é¢è¯•é¢˜ 2ï¼šTranslog çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿå®ƒå¦‚ä½•ä¿è¯æ•°æ®ä¸ä¸¢å¤±ï¼Ÿ

âœ… **æ ¸å¿ƒå›ç­”è¦ç‚¹**ï¼š

> Translogï¼ˆäº‹åŠ¡æ—¥å¿—ï¼‰çš„æ ¸å¿ƒä½œç”¨æ˜¯ **æä¾›æŒä¹…åŒ–ä¿éšœå’Œæ•…éšœæ¢å¤èƒ½åŠ›**ã€‚

å…·ä½“æœºåˆ¶å¦‚ä¸‹ï¼š

1. æ¯æ¬¡å†™å…¥æ“ä½œéƒ½ä¼šå…ˆè¿½åŠ åˆ° translog æ–‡ä»¶ï¼›
2. translog é»˜è®¤ `durability=request`ï¼Œå³æ¯æ¬¡å†™å…¥åæ‰§è¡Œ `fsync` åˆ°ç£ç›˜ï¼›
3. è‹¥èŠ‚ç‚¹å®•æœºï¼Œé‡å¯æ—¶ä¼šé‡æ”¾ translog ä¸­æœªæŒä¹…åŒ–çš„æ“ä½œï¼›
4. ç¡®ä¿ä»ä¸Šæ¬¡ `flush` ä¹‹åçš„æ‰€æœ‰å†™å…¥éƒ½èƒ½æ¢å¤ã€‚

> ğŸ“Œ ç›¸å½“äºæ•°æ®åº“çš„ redo logï¼Œæ˜¯æ•°æ®å®‰å…¨çš„æœ€åä¸€é“é˜²çº¿ã€‚

---

#### â“ é¢è¯•é¢˜ 3ï¼šé¢‘ç¹ refresh ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚ä½•ä¼˜åŒ–ï¼Ÿ

âœ… **é—®é¢˜ä¸ä¼˜åŒ–å¯¹æ¯”è¡¨**ï¼š

| é—®é¢˜ | åŸå›  | ä¼˜åŒ–æ–¹æ¡ˆ |
| --- | --- | --- |
| æ–‡ä»¶å¥æŸ„è¿‡å¤š | æ¯ä¸ª segment å ç”¨ fd | å‡å°‘ refresh é¢‘ç‡ï¼ˆå¦‚è®¾ä¸º `30s`ï¼‰ |
| æŸ¥è¯¢æ€§èƒ½ä¸‹é™ | segment æ•°é‡å¤šï¼Œéœ€åˆå¹¶æŸ¥æ‰¾ | å¯ç”¨ `merge` ç­–ç•¥è‡ªåŠ¨åˆå¹¶ |
| å†™å…¥ååé™ä½ | é¢‘ç¹ I/O å¼€é”€ | æ‰¹é‡å†™å…¥ + ä¸´æ—¶å…³é—­ refresh |
| JVM å‹åŠ›å¤§ | segment ç¼“å­˜å¢å¤š | è°ƒæ•´ `indices.memory.index_buffer_size` |

> âœ… æ¨èï¼šæ—¥å¿—ç±»ç´¢å¼•è®¾ç½® `refresh_interval=30s`ï¼Œæå‡ç¨³å®šæ€§ã€‚

---

#### â“ é¢è¯•é¢˜ 4ï¼šrefresh å’Œ flush æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

| å¯¹æ¯”é¡¹ | Refresh | Flush |
| --- | --- | --- |
| ç›®çš„ | ä½¿æ–‡æ¡£å¯æœç´¢ | æŒä¹…åŒ– segment å¹¶æ¸…ç† translog |
| è§¦å‘é¢‘ç‡ | æ¯ç§’ä¸€æ¬¡ï¼ˆé»˜è®¤ï¼‰ | æ¯ 30 åˆ†é’Ÿæˆ– translog è¾¾é™ |
| æ˜¯å¦å†™ç£ç›˜ | å¦ï¼ˆsegment åœ¨ JVM heapï¼‰ | æ˜¯ï¼ˆsegment æŒä¹…åŒ–ï¼‰ |
| æ˜¯å¦æ¸…ç©º translog | å¦ | æ˜¯ |
| æ€§èƒ½å½±å“ | ä¸­ç­‰ | è¾ƒé«˜ï¼ˆI/O å¯†é›†ï¼‰ |

> ğŸ’¡ è®°å¿†æŠ€å·§ï¼š**Refresh = å¯è§ï¼ŒFlush = æŒä¹…**ã€‚

---

### äº”ã€å®è·µæ¡ˆä¾‹ï¼šç”Ÿäº§ç¯å¢ƒä¸­çš„å†™å…¥æ€§èƒ½ä¼˜åŒ–

#### æ¡ˆä¾‹ 1ï¼šæ—¥å¿—ç³»ç»Ÿå›  segment è¿‡å¤šå¯¼è‡´æŸ¥è¯¢ç¼“æ…¢

**ç°è±¡**ï¼šæŸ ELK æ¶æ„çš„æ—¥å¿—ç³»ç»Ÿï¼ŒæŸ¥è¯¢å“åº”æ—¶é—´ä» 200ms ä¸Šå‡è‡³ 3sã€‚

**æ’æŸ¥è¿‡ç¨‹**ï¼š

1. æ‰§è¡Œ `_cat/segments` å‘ç°å•ä¸ªç´¢å¼•æœ‰è¶…è¿‡ 500 ä¸ª segmentï¼›
2. æŸ¥çœ‹ `refresh_interval` ä¸ºé»˜è®¤ `1s`ï¼›
3. æ—¥å‡å†™å…¥é‡è¾¾ 500 ä¸‡æ¡ï¼Œæ¯ç§’çº¦ 60 æ¡ï¼›
4. é«˜é¢‘ refresh å¯¼è‡´ segment ç¢ç‰‡åŒ–ä¸¥é‡ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

* ä¿®æ”¹ç´¢å¼•æ¨¡æ¿ï¼Œè®¾ç½®ï¼š

```json
"index.refresh_interval": "30s"

```

* å¯ç”¨ force merge åœ¨ä½å³°æœŸåˆå¹¶ segmentï¼š

```json
POST /logs-*/_forcemerge?max_num_segments=1

```

> âœ… ç»“æœï¼šsegment æ•°é‡ä¸‹é™ 90%ï¼ŒæŸ¥è¯¢å»¶è¿Ÿæ¢å¤è‡³ 300ms ä»¥å†…ã€‚

---

#### æ¡ˆä¾‹ 2ï¼šæ‰¹é‡å¯¼å…¥æ—¶æœªå…³é—­ refresh å¯¼è‡´è¶…æ—¶

**èƒŒæ™¯**ï¼šæŸæ•°æ®è¿ç§»ä»»åŠ¡ä½¿ç”¨ Java Client æ‰¹é‡å¯¼å…¥ 100 ä¸‡æ¡è®°å½•ï¼Œå¹³å‡è€—æ—¶é•¿è¾¾ 2 å°æ—¶ã€‚

**æ ¹æœ¬åŸå› **ï¼š

* æ¯æ¬¡å†™å…¥è™½ä¸º bulk è¯·æ±‚ï¼Œä½†ä»å— `refresh_interval=1s` å½±å“ï¼›
* æ¯ç§’è§¦å‘ä¸€æ¬¡ refreshï¼Œäº§ç”Ÿå¤§é‡ I/Oï¼›
* JVM GC é¢‘ç¹ï¼Œå¯¼è‡´çº¿ç¨‹é˜»å¡ã€‚

**ä¿®å¤æªæ–½**ï¼š

* å¯¼å…¥å‰ä¸´æ—¶å…³é—­ refreshï¼š

```json
PUT /data-migration/_settings
{ "index.refresh_interval": "-1" }

```

* å¯¼å…¥å®Œæˆåæ‰‹åŠ¨ refreshï¼›
* æ¢å¤åŸè®¾ç½®ã€‚

> âœ… æ•ˆæœï¼šå¯¼å…¥æ—¶é—´ä» 2 å°æ—¶ç¼©çŸ­è‡³ 8 åˆ†é’Ÿã€‚

---

### å…­ã€æŠ€æœ¯å¯¹æ¯”ï¼šä¸åŒå†™å…¥æ¨¡å¼çš„é€‚ç”¨åœºæ™¯

| å†™å…¥æ¨¡å¼ | refresh_interval | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
| --- | --- | --- | --- | --- |
| å®æ—¶å†™å…¥ | `1s`ï¼ˆé»˜è®¤ï¼‰ | å®æ—¶ç›‘æ§ã€ç”¨æˆ·è¡Œä¸ºè¿½è¸ª | æ•°æ®å¿«é€Ÿå¯è§ | segment å¤šï¼Œèµ„æºæ¶ˆè€—é«˜ |
| æ‰¹é‡ä¼˜åŒ– | `-1` æˆ– `30s` | æ—¥å¿—åˆ†æã€ç¦»çº¿å¯¼å…¥ | å†™å…¥ååé«˜ï¼Œèµ„æºèŠ‚çœ | å»¶è¿Ÿé«˜ï¼Œä¸å¯ç«‹å³æœç´¢ |
| å¼ºä¸€è‡´æ€§ | `1s` + `translog.durability=request` | é‡‘èäº¤æ˜“ã€è®¢å•ç³»ç»Ÿ | æ•°æ®ä¸ä¸¢å¤± | æ€§èƒ½å¼€é”€å¤§ |
| é«˜ååä½ä¸€è‡´ | `30s` + `async` sync | ä¼ æ„Ÿå™¨æ•°æ®é‡‡é›† | æé«˜åå | æ•…éšœå¯èƒ½ä¸¢å¤±æ•°ç§’æ•°æ® |

> ğŸ“Š å»ºè®®ï¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„ç»„åˆç­–ç•¥ã€‚

---

### ä¸ƒã€é¢è¯•ç­”é¢˜æ¨¡æ¿ï¼šå¦‚ä½•å›ç­”â€œä½ ä»¬æ˜¯æ€ä¹ˆä¼˜åŒ–å†™å…¥æ€§èƒ½çš„ï¼Ÿâ€

> **STAR-L æ¨¡æ¿ï¼ˆSituation-Task-Action-Result-Learningï¼‰**

* **Situation**ï¼šæˆ‘ä»¬æœ‰ä¸€ä¸ªæ—¥å¿—ç´¢å¼•æ¯å¤©å†™å…¥åƒä¸‡çº§æ•°æ®ã€‚
* **Task**ï¼šéœ€è¦æå‡å†™å…¥ååå¹¶é™ä½èµ„æºæ¶ˆè€—ã€‚
* **Action**ï¼š
* å°† `refresh_interval` ä» 1s æ”¹ä¸º 30sï¼›
* æ‰¹é‡å¯¼å…¥æ—¶ä¸´æ—¶å…³é—­ refreshï¼›
* è®¾ç½® translog retention ç­–ç•¥é˜²æ­¢æ— é™å¢é•¿ï¼›
* **Result**ï¼šå†™å…¥æ€§èƒ½æå‡ 5 å€ï¼ŒJVM ç¨³å®šæ€§æ˜¾è‘—æ”¹å–„ã€‚
* **Learning**ï¼šå¿…é¡»æ ¹æ®åœºæ™¯æƒè¡¡å®æ—¶æ€§ä¸æ€§èƒ½ã€‚

---

### å…«ã€æ€»ç»“ä¸é¢„å‘Š

ä»Šå¤©æˆ‘ä»¬ç³»ç»Ÿå­¦ä¹ äº† Elasticsearch çš„ **æ•°æ®å†™å…¥ä¸åˆ·æ–°æœºåˆ¶**ï¼Œæ¶µç›–ï¼š

* å†™å…¥æµç¨‹ä¸­çš„ bufferã€translogã€segment ä¸‰å¤§ç»„ä»¶
* refresh ä¸ flush çš„åŒºåˆ«åŠè§¦å‘æ¡ä»¶
* translog å¦‚ä½•ä¿éšœæ•°æ®å®‰å…¨
* ç”Ÿäº§ç¯å¢ƒä¸­å¸¸è§çš„æ€§èƒ½é—®é¢˜ä¸ä¼˜åŒ–æ‰‹æ®µ

æŒæ¡è¿™äº›åº•å±‚çŸ¥è¯†ï¼Œä¸ä»…èƒ½è®©ä½ åœ¨é¢è¯•ä¸­è„±é¢–è€Œå‡ºï¼Œæ›´èƒ½å¸®åŠ©ä½ åœ¨å®é™…é¡¹ç›®ä¸­è®¾è®¡å‡ºé«˜æ€§èƒ½ã€é«˜å¯é çš„æœç´¢ç³»ç»Ÿã€‚

ğŸ‘‰ **æ˜å¤©æˆ‘ä»¬å°†è¿›å…¥ã€Day 15ï¼šç´¢å¼•åˆ«åä¸é›¶åœæœºæ›´æ–°ã€‘**ï¼Œæ·±å…¥è®²è§£å¦‚ä½•åˆ©ç”¨åˆ«åå®ç°æ— ç¼ç´¢å¼•åˆ‡æ¢ã€ç°åº¦å‘å¸ƒå’Œæ»šåŠ¨æ›´æ–°ï¼Œæ•¬è¯·æœŸå¾…ï¼

---

### æ–‡æœ«å½©è›‹ï¼šé¢è¯•å®˜å–œæ¬¢çš„å›ç­”è¦ç‚¹

âœ… **é«˜åˆ†å›ç­”ç‰¹å¾æ€»ç»“**ï¼š

* èƒ½æ¸…æ™°è¯´å‡º refresh å’Œ flush çš„åŒºåˆ«ï¼›
* ç†è§£ translog çš„å®¹ç¾ä½œç”¨ï¼›
* çŸ¥é“å¦‚ä½•é€šè¿‡è°ƒæ•´ `refresh_interval` ä¼˜åŒ–æ€§èƒ½ï¼›
* æåˆ° `?refresh=true` çš„ä½¿ç”¨åœºæ™¯ï¼›
* èƒ½ç»“åˆä¸šåŠ¡ç»™å‡ºåˆç†çš„é…ç½®å»ºè®®ï¼›
* ä¸ç›²ç›®è¯´â€œElasticsearch æ˜¯å®æ—¶çš„â€ï¼Œè€Œæ˜¯å®¢è§‚åˆ†æ NRT ç‰¹æ€§ã€‚

---

### å‚è€ƒèµ„æºæ¨è

1. [Elasticå®˜æ–¹æ–‡æ¡£ - Indexing Buffer](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-buffer.html)
2. [Elasticåšå®¢ï¼šHow Fast is Real-Time Search?](https://www.elastic.co/cn/blog/found-elasticsearch-from-the-bottom-up)
3. [ã€ŠElasticsearch: The Definitive Guideã€‹ç¬¬11ç«  - Inside a Cluster](https://www.elastic.co/guide/en/elasticsearch/guide/current/inside-a-cluster.html)

---

**æ–‡ç« æ ‡ç­¾**ï¼šElasticsearch, æ•°æ®å†™å…¥, refresh, translog, segment, flush, è¿‘å®æ—¶æœç´¢, é¢è¯•ç²¾è®², å†™å…¥æ€§èƒ½, æœç´¢å¼•æ“

**æ–‡ç« ç®€è¿°**ï¼šæœ¬æ–‡æ·±å…¥è®²è§£ Elasticsearch æ•°æ®å†™å…¥ä¸åˆ·æ–°æœºåˆ¶çš„æ ¸å¿ƒåŸç†ï¼Œæ¶µç›– refresh_intervalã€translog ä½œç”¨ã€segment ç”Ÿæˆä¸ flush æµç¨‹ç­‰å…³é”®çŸ¥è¯†ç‚¹ï¼Œç»“åˆ REST API ä¸ Java ä»£ç ç¤ºä¾‹ï¼Œè§£æçœŸå®ç”Ÿäº§æ¡ˆä¾‹ã€‚å¸®åŠ©å¼€å‘è€…æŒæ¡è¿‘å®æ—¶æœç´¢çš„åº•å±‚é€»è¾‘ï¼Œåº”å¯¹ä¸­é«˜çº§é¢è¯•ä¸­çš„æ€§èƒ½è°ƒä¼˜ä¸æ¶æ„è®¾è®¡éš¾é¢˜ã€‚



