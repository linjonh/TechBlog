---
layout: post
title: "如何利用-PostgreSQL-的-JSONB-API-作为扩展的轻量级-JSON-解析器"
date: 2025-03-11 10:45:32 +0800
description: "在基于 C 语言的 PostgreSQL 扩展开发中，您可能会遇到需要处理 JSON 等结构化数据的情况。通常，您可能会在扩展中引入第三方 JSON 解析库，例如 cJSON 或 libjansson。这些库功能强大、易于使用且提供了丰富的特性，但如果我们并未充分利用这些库的高级功能，引入它们则会显得多余。很多时候，我们只是希望从 JSON 中读取某个特定值或简单地遍历它。PostgreSQL 本身已经具备了处理 JSON 数据的足够能力，尽管这些功能可能不如第三方库那样直观。"
keywords: "如何利用 PostgreSQL 的 JSONB API 作为扩展的轻量级 JSON 解析器"
categories: ['未分类']
tags: ['数据库', 'Postgresql', 'Json']
artid: "146172660"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146172660
    alt: "如何利用-PostgreSQL-的-JSONB-API-作为扩展的轻量级-JSON-解析器"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146172660
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146172660
cover: https://bing.ee123.net/img/rand?artid=146172660
image: https://bing.ee123.net/img/rand?artid=146172660
img: https://bing.ee123.net/img/rand?artid=146172660
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     如何利用 PostgreSQL 的 JSONB API 作为扩展的轻量级 JSON 解析器
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     前言
    </h3>
    <p>
     在基于 C 语言的 PostgreSQL 扩展开发中，您可能会遇到需要处理 JSON 等结构化数据的情况。通常，您可能会在扩展中引入第三方 JSON 解析库，例如 cJSON 或 libjansson。这些库功能强大、易于使用且提供了丰富的特性，但如果我们并未充分利用这些库的高级功能，引入它们则会显得多余。很多时候，我们只是希望从 JSON 中读取某个特定值或简单地遍历它。PostgreSQL 本身已经具备了处理 JSON 数据的足够能力，尽管这些功能可能不如第三方库那样直观。如果您能够充分掌握 PostgreSQL 已有的功能，或许可以避免引入第三方 JSON 库的成本。
    </p>
    <p>
     在本文中，将向您展示如何使用 PostgreSQL 的 JSONB API 来解析、提取和遍历 JSON 结构。
    </p>
    <h3>
     <a id="_6">
     </a>
     解析和获取
    </h3>
    <p>
     要使用 PostgreSQL 的 JSONB API，您需要在 C 扩展中包含其头文件：
    </p>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"utils/jsonb.h"</span></span>
</code></pre>
    <p>
     现在，我们可以开始使用 JSONB 了。假设我们有一个
     <code>
      char *
     </code>
     指针，指向一个完整的 JSON 结构内容。我们需要将其转换为
     <code>
      Jsonb *
     </code>
     ，然后才能对其进行操作。
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* myjson points to a complete JSON content */</span>
<span class="token keyword">void</span> <span class="token function">jsonb_example</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> myjson<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Datum jsonb_datum<span class="token punctuation">;</span>
    Jsonb <span class="token operator">*</span> jb<span class="token punctuation">;</span>

    <span class="token comment">/* we first convert char * to datum representation */</span>
    jsonb_datum <span class="token operator">=</span> <span class="token function">DirectFunctionCall1</span><span class="token punctuation">(</span>jsonb_in<span class="token punctuation">,</span> <span class="token function">CStringGetDatum</span><span class="token punctuation">(</span>myjson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* then, we convert it to Jsonb * */</span>
    jb <span class="token operator">=</span> <span class="token function">DatumGetJsonbP</span><span class="token punctuation">(</span>jsonb_datum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     假设我们的 JSON 如下所示：
    </p>
    <pre><code class="prism language-c"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"version"</span><span class="token operator">:</span> <span class="token string">"1.0"</span><span class="token punctuation">,</span>
  <span class="token string">"payload"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"name"</span><span class="token operator">:</span> <span class="token string">"exampleapp"</span><span class="token punctuation">,</span>
    <span class="token string">"ts_ms"</span><span class="token operator">:</span> <span class="token number">1720811216000</span><span class="token punctuation">,</span>
    <span class="token string">"db"</span><span class="token operator">:</span> <span class="token string">"postgresql"</span><span class="token punctuation">,</span>
    <span class="token string">"table"</span><span class="token operator">:</span> <span class="token string">"mytable"</span><span class="token punctuation">,</span>
    <span class="token string">"schema"</span><span class="token operator">:</span> <span class="token string">"myschema"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"queries"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"query"</span><span class="token operator">:</span> <span class="token string">"select * from mytable"</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token string">"query"</span><span class="token operator">:</span> <span class="token string">"update mytable set a = 1"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     为了获取 payload 组下 db 的值，我们可以使用 JSONB 的
     <code>
      jsonb_get_element()
     </code>
     函数，函数原型如下：
    </p>
    <pre><code class="prism language-c">Datum <span class="token function">jsonb_get_element</span><span class="token punctuation">(</span>Jsonb <span class="token operator">*</span>jb<span class="token punctuation">,</span> Datum <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token keyword">int</span> npath<span class="token punctuation">,</span>
 bool <span class="token operator">*</span>isnull<span class="token punctuation">,</span> bool as_text<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     该函数接受一个
     <code>
      JSONB
     </code>
     指针（即我们之前创建的表示整个 JSON 消息的指针），以及一个
     <code>
      Datum
     </code>
     数组和
     <code>
      npath
     </code>
     ，用于表示 JSON 元素的路径。请注意，此路径不必一直指向标量值，它可以停在另一个内部组或数组，具体取决于您的用例。它还接受一个
     <code>
      isnull
     </code>
     布尔指针，如果找不到元素，函数会将其设置为
     <code>
      false
     </code>
     。最后，
     <code>
      as_text
     </code>
     布尔值指示函数是否将结果作为
     <code>
      Text Datum
     </code>
     或
     <code>
      Jsonb Datum
     </code>
     返回。我倾向于将其设置为
     <code>
      false
     </code>
     ，以便返回 JSONB Datum，从而可以进一步操作。将其转换为字符串表示也很简单（通过
     <code>
      stringinfo
     </code>
     结构）。请参见以下示例。
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* myjson points to a complete JSON content */</span>
<span class="token keyword">void</span> <span class="token function">jsonb_example</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> myjson<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Datum jsonb_datum<span class="token punctuation">;</span>
    Jsonb <span class="token operator">*</span> jb<span class="token punctuation">;</span>

    <span class="token comment">/* variables needed for fetching element */</span>
    Datum datum_elems<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    Datum res<span class="token punctuation">;</span>
    <span class="token keyword">int</span> numpath <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    bool isnull<span class="token punctuation">;</span>
    StringInfoData strinfo<span class="token punctuation">;</span>

    <span class="token comment">/* we first convert char * to datum representation */</span>
    jsonb_datum <span class="token operator">=</span> <span class="token function">DirectFunctionCall1</span><span class="token punctuation">(</span>jsonb_in<span class="token punctuation">,</span> <span class="token function">CStringGetDatum</span><span class="token punctuation">(</span>myjson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* then, we convert it to Jsonb * */</span>
    jb <span class="token operator">=</span> <span class="token function">DatumGetJsonbP</span><span class="token punctuation">(</span>jsonb_datum<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* prepare element paths to fetch, from outer to inner */</span>
    <span class="token function">initStringInfo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>strinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    datum_elems<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">CStringGetTextDatum</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    datum_elems<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">CStringGetTextDatum</span><span class="token punctuation">(</span><span class="token string">"db"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* fetch it */</span>
    res <span class="token operator">=</span> <span class="token function">jsonb_get_element</span><span class="token punctuation">(</span>jb<span class="token punctuation">,</span> datum_elems<span class="token punctuation">,</span> numPaths<span class="token punctuation">,</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>isnull<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isnull<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* write NULL if element does not exist */</span>
        <span class="token function">resetStringInfo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>strinfoo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">appendStringInfoString</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>strinfoo<span class="token punctuation">,</span> <span class="token string">"NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        Jsonb <span class="token operator">*</span>resjb <span class="token operator">=</span> <span class="token function">DatumGetJsonbP</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resetStringInfo</span><span class="token punctuation">(</span>strinfoout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">JsonbToCString</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>strinfo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>resjb<span class="token operator">-&gt;</span>root<span class="token punctuation">,</span> <span class="token function">VARSIZE</span><span class="token punctuation">(</span>resjb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* strinfo contains the value of the element at this point. Print it */</span>
    <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"data = %s"</span><span class="token punctuation">,</span> strinfo<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     现在，如果我们想从数组中的特定索引处获取特定值。例如，
     <code>
      queries
     </code>
     数组下索引为 1 的
     <code>
      query
     </code>
     值（
     <code>
      update mytable set a = 1
     </code>
     ）。我们只需要修改描述此路径的
     <code>
      datum_elems
     </code>
     。我们可以在数组元素后的
     <code>
      datum_elems
     </code>
     中直接放入一个数字（作为字符串），以告诉函数我们要获取特定索引。请参见以下示例：
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* myjson points to a complete JSON content */</span>
<span class="token keyword">void</span> <span class="token function">jsonb_example</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> myjson<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Datum jsonb_datum<span class="token punctuation">;</span>
    Jsonb <span class="token operator">*</span> jb<span class="token punctuation">;</span>

    <span class="token comment">/* variables needed for fetching element */</span>
    Datum datum_elems<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    Datum res<span class="token punctuation">;</span>
    <span class="token keyword">int</span> numpath <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
    bool isnull<span class="token punctuation">;</span>
    StringInfoData strinfo<span class="token punctuation">;</span>

    <span class="token comment">/* we first convert char * to datum representation */</span>
    jsonb_datum <span class="token operator">=</span> <span class="token function">DirectFunctionCall1</span><span class="token punctuation">(</span>jsonb_in<span class="token punctuation">,</span> <span class="token function">CStringGetDatum</span><span class="token punctuation">(</span>myjson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* then, we convert it to Jsonb * */</span>
    jb <span class="token operator">=</span> <span class="token function">DatumGetJsonbP</span><span class="token punctuation">(</span>jsonb_datum<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* prepare element paths to fetch, from outer to inner */</span>
    <span class="token function">initStringInfo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>strinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    datum_elems<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">CStringGetTextDatum</span><span class="token punctuation">(</span><span class="token string">"queries"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    datum_elems<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">CStringGetTextDatum</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    datum_elems<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">CStringGetTextDatum</span><span class="token punctuation">(</span><span class="token string">"query"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* fetch it */</span>
    res <span class="token operator">=</span> <span class="token function">jsonb_get_element</span><span class="token punctuation">(</span>jb<span class="token punctuation">,</span> datum_elems<span class="token punctuation">,</span> numPaths<span class="token punctuation">,</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>isnull<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isnull<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* write NULL if element does not exist */</span>
        <span class="token function">resetStringInfo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>strinfoo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">appendStringInfoString</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>strinfoo<span class="token punctuation">,</span> <span class="token string">"NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        Jsonb <span class="token operator">*</span>resjb <span class="token operator">=</span> <span class="token function">DatumGetJsonbP</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resetStringInfo</span><span class="token punctuation">(</span>strinfoout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">JsonbToCString</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>strinfo<span class="token punctuation">,</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>resjb<span class="token operator">-&gt;</span>root<span class="token punctuation">,</span> <span class="token function">VARSIZE</span><span class="token punctuation">(</span>resjb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* strinfo contains the value of the element at this point. Print it */</span>
    <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"data = %s"</span><span class="token punctuation">,</span> strinfo<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     如你所见，获取特定元素非常简单。我们只需要准备正确的
     <code>
      datum_elems
     </code>
     数组来描述通向某个值的路径，其他部分保持不变。我们可以编写一个辅助函数，通过从单个字符串自动创建
     <code>
      datum_elems
     </code>
     来简化此过程，该字符串用点分隔每个层次结构（例如：“payload.name”，“queries.0.query” 等）。
    </p>
    <pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">getPathElementString</span><span class="token punctuation">(</span>Jsonb <span class="token operator">*</span> jb<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> path<span class="token punctuation">,</span> StringInfoData strinfoout<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Datum <span class="token operator">*</span> datum_elems <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span> str_elems <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">*</span> p <span class="token operator">=</span> path<span class="token punctuation">;</span>
    <span class="token keyword">int</span> numPaths <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> curr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span> pathcopy <span class="token operator">=</span> <span class="token function">pstrdup</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Datum res<span class="token punctuation">;</span>
    bool isnull<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>strinfoout<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"strinfo is null"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Count the number of elements in the path */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>pathcopy<span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">!=</span> <span class="token char">'\0'</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>p <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                 numPaths<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            p<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        numPaths<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">/* Add the last one */</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        numPaths <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    datum_elems <span class="token operator">=</span> <span class="token function">palloc0</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Datum<span class="token punctuation">)</span> <span class="token operator">*</span> numPaths<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* Parse the path into elements */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strstr</span><span class="token punctuation">(</span>pathcopy<span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>

        str_elems<span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span>pathcopy<span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>str_elems<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            datum_elems<span class="token punctuation">[</span>curr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">CStringGetTextDatum</span><span class="token punctuation">(</span>str_elems<span class="token punctuation">)</span><span class="token punctuation">;</span>
            curr<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>str_elems <span class="token operator">=</span> <span class="token function">strtok</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                datum_elems<span class="token punctuation">[</span>curr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">CStringGetTextDatum</span><span class="token punctuation">(</span>str_elems<span class="token punctuation">)</span><span class="token punctuation">;</span>
                curr<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* only one level, just use pathcopy*/</span>
        datum_elems<span class="token punctuation">[</span>curr<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">CStringGetTextDatum</span><span class="token punctuation">(</span>pathcopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Get the element from JSONB */</span>
    res <span class="token operator">=</span> <span class="token function">jsonb_get_element</span><span class="token punctuation">(</span>jb<span class="token punctuation">,</span> datum_elems<span class="token punctuation">,</span> numPaths<span class="token punctuation">,</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>isnull<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isnull<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">resetStringInfo</span><span class="token punctuation">(</span>strinfoout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">appendStringInfoString</span><span class="token punctuation">(</span>strinfoout<span class="token punctuation">,</span> <span class="token string">"NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        Jsonb <span class="token operator">*</span>resjb <span class="token operator">=</span> <span class="token function">DatumGetJsonbP</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">resetStringInfo</span><span class="token punctuation">(</span>strinfoout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">JsonbToCString</span><span class="token punctuation">(</span>strinfoout<span class="token punctuation">,</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>resjb<span class="token operator">-&gt;</span>root<span class="token punctuation">,</span> <span class="token function">VARSIZE</span><span class="token punctuation">(</span>resjb<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">pfree</span><span class="token punctuation">(</span>datum_elems<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pfree</span><span class="token punctuation">(</span>pathcopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* myjson points to a complete JSON content */</span>
<span class="token keyword">void</span> <span class="token function">jsonb_example</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> myjson<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Datum jsonb_datum<span class="token punctuation">;</span>
    Jsonb <span class="token operator">*</span> jb<span class="token punctuation">;</span>
    StringInfoData strinfo<span class="token punctuation">;</span>

    <span class="token comment">/* we first convert char * to datum representation */</span>
    jsonb_datum <span class="token operator">=</span> <span class="token function">DirectFunctionCall1</span><span class="token punctuation">(</span>jsonb_in<span class="token punctuation">,</span> <span class="token function">CStringGetDatum</span><span class="token punctuation">(</span>myjson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* then, we convert it to Jsonb * */</span>
    jb <span class="token operator">=</span> <span class="token function">DatumGetJsonbP</span><span class="token punctuation">(</span>jsonb_datum<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">initStringInfo</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>strinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">getPathElementString</span><span class="token punctuation">(</span>jb<span class="token punctuation">,</span> <span class="token string">"payload.db"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>strinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"payload.db= %s"</span><span class="token punctuation">,</span> strinfo<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">getPathElementString</span><span class="token punctuation">(</span>jb<span class="token punctuation">,</span> <span class="token string">"queries.0.query"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>strinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"queries.0.query= %s"</span><span class="token punctuation">,</span> strinfo<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_JSON__256">
     </a>
     遍历整个 JSON 结构
    </h3>
    <p>
     现在，我们已经知道如何在知道目标的情况下从 JSON 中获取特定值。有时，我们需要遍历整个 JSON 以构建内部数据结构以满足某些需求。在这种情况下，我们可以利用 JSONB 的迭代函数。以下示例代码将创建一个 JSONB 迭代器，然后尝试遍历其中的每个元素。它会在迭代器即将进入组或数组时以及即将退出组或数组时进行指示。您可以根据需要保存键和值。JSONB 读取的值可以表示为不同的数据类型，例如字符串、二进制、数字等。以下示例尝试将它们转换为字符串（二进制除外）以进行输出。
    </p>
    <pre><code class="prism language-c"><span class="token comment">/* myjson points to a complete JSON content */</span>
<span class="token keyword">void</span> <span class="token function">jsonb_iterate_example</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> myjson<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Datum jsonb_datum<span class="token punctuation">;</span>
    Jsonb <span class="token operator">*</span> jb<span class="token punctuation">;</span>

    <span class="token comment">/* iterator related */</span>
    JsonbIterator <span class="token operator">*</span>it<span class="token punctuation">;</span>
    JsonbValue v<span class="token punctuation">;</span>
    JsonbIteratorToken r<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span> key <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span> value <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">/* we first convert char * to datum representation */</span>
    jsonb_datum <span class="token operator">=</span> <span class="token function">DirectFunctionCall1</span><span class="token punctuation">(</span>jsonb_in<span class="token punctuation">,</span> <span class="token function">CStringGetDatum</span><span class="token punctuation">(</span>myjson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* then, we convert it to Jsonb * */</span>
    jb <span class="token operator">=</span> <span class="token function">DatumGetJsonbP</span><span class="token punctuation">(</span>jsonb_datum<span class="token punctuation">)</span><span class="token punctuation">;</span>

    it <span class="token operator">=</span> <span class="token function">JsonbIteratorInit</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>jb<span class="token operator">-&gt;</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">=</span> <span class="token function">JsonbIteratorNext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>it<span class="token punctuation">,</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>v<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> WJB_DONE<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> WJB_BEGIN_OBJECT<span class="token operator">:</span>
                <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"begin group --------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> WJB_END_OBJECT<span class="token operator">:</span>
                <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"end group --------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> WJB_BEGIN_ARRAY<span class="token operator">:</span>
                <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"begin array --------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> WJB_END_ARRAY<span class="token operator">:</span>
                <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"end array --------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> WJB_KEY<span class="token operator">:</span>
                key <span class="token operator">=</span> <span class="token function">pnstrdup</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>val<span class="token punctuation">.</span>string<span class="token punctuation">.</span>val<span class="token punctuation">,</span> v<span class="token punctuation">.</span>val<span class="token punctuation">.</span>string<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"key: %s"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> WJB_VALUE<span class="token operator">:</span>
            <span class="token keyword">case</span> WJB_ELEM<span class="token operator">:</span>
                <span class="token keyword">switch</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span>type<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">case</span> jbvNull<span class="token operator">:</span>
                        <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"value: NULL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> jbvString<span class="token operator">:</span>
                        value <span class="token operator">=</span> <span class="token function">pnstrdup</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>val<span class="token punctuation">.</span>string<span class="token punctuation">.</span>val<span class="token punctuation">,</span> v<span class="token punctuation">.</span>val<span class="token punctuation">.</span>string<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"string value: %s"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> jbvNumeric<span class="token operator">:</span>
                    <span class="token punctuation">{<!-- --></span>
                        value <span class="token operator">=</span> <span class="token function">DatumGetCString</span><span class="token punctuation">(</span><span class="token function">DirectFunctionCall1</span><span class="token punctuation">(</span>numeric_out<span class="token punctuation">,</span> <span class="token function">PointerGetDatum</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>val<span class="token punctuation">.</span>numeric<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"numeric value: %s"</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">case</span> jbvBool<span class="token operator">:</span>
                        <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"boolean value: %s"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>val<span class="token punctuation">.</span>boolean <span class="token operator">?</span> <span class="token string">"true"</span> <span class="token operator">:</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>v<span class="token punctuation">.</span>val<span class="token punctuation">.</span>boolean<span class="token punctuation">)</span>
                            value <span class="token operator">=</span> <span class="token function">pnstrdup</span><span class="token punctuation">(</span><span class="token string">"true"</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">else</span>
                            value <span class="token operator">=</span> <span class="token function">pnstrdup</span><span class="token punctuation">(</span><span class="token string">"false"</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">case</span> jbvBinary<span class="token operator">:</span>
                        <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"binary value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token keyword">default</span><span class="token operator">:</span>
                        <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"unknown value type: %d"</span><span class="token punctuation">,</span> v<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token function">elog</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">,</span> <span class="token string">"Unknown token: %d"</span><span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;</span>amp<span class="token punctuation">;</span><span class="token operator">&amp;</span>amp<span class="token punctuation">;</span> value <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">pfree</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">pfree</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            key <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
            value <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_348">
     </a>
     总结
    </h3>
    <p>
     PostgreSQL 中的 JSONB API 能做的不仅仅是简单的获取和遍历。例如，它还可以将额外的值推送到现有的 JSONB 结构中。今天我们主要关注获取和遍历，在我看来，这是处理 JSON 时最常见的用例。我希望这里分享的代码示例能对你有所帮助，并防止你在扩展开发中引入第三方 JSON 解析器，因为那可能是多余的。
    </p>
    <h3>
     <a id="_IvorySQL_352">
     </a>
     关于 IvorySQL
    </h3>
    <p>
     lvorySQL 是由瀚高股份主导研发的一款开源的兼容 Oracle 的 PostgreSQL。IvorySQL 与 PostgreSQL 国际社区紧密合作，保持与最新 PG 版本内核同步，为用户提供便捷的升级体验。基于双 Parser 架构设计，100% 与原生 PostgreSQL 兼容，支持丰富的 PostgreSQL 周边工具和扩展，并根据用户需求提供定制化工具。同时，IvorySQL 4.0 提供更全面灵活的 Oracle 兼容功能，具备高度的 SQL 和 PL/SQL 兼容性能够为企业构建更加高效、稳定和灵活的数据库解决方案。
    </p>
    <ul>
     <li>
      官网：https://www.ivorysql.org
     </li>
     <li>
      GitHub（欢迎点击 star 收藏哦）：https://github.com/IvorySQL/IvorySQL
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f49766f727953514c2f:61727469636c652f64657461696c732f313436313732363630" class_="artid" style="display:none">
 </p>
</div>


