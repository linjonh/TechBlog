---
layout: post
title: "nest学习4"
date: 2025-03-12 10:16:11 +0800
description: "Monorepo 是一种项目代码管理方式，指单个仓库中管理多个项目，有助于简化代码共享、版本控制、构建和部署等方面的复杂性，并提供更好的可重用性和协作性。这是protocol buffer 的语法，因为要跨语言通信，不同语言语法不同，所以需要一个通用的通信语言。然后就可以调用他的方法了。微服务在启动的时候，向注册中心注册，销毁的时候也在注册中心注销，并通过定时发送心跳包来回报自己的状态。在查找其他微服务的时候，去注册中心查一下这个服务的所有节点信息，然后再选一个来用，这个叫做服务发现。"
keywords: "nest学习(4)"
categories: ['未分类']
tags: ['学习']
artid: "145277908"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=145277908
    alt: "nest学习4"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=145277908
featuredImagePreview: https://bing.ee123.net/img/rand?artid=145277908
cover: https://bing.ee123.net/img/rand?artid=145277908
image: https://bing.ee123.net/img/rand?artid=145277908
img: https://bing.ee123.net/img/rand?artid=145277908
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     nest学习(4)
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <a href="https://juejin.cn/book/7226988578700525605?enter_from=course_center&amp;utm_source=course_center" rel="nofollow">
      学习小册(nest通关秘籍)
     </a>
    </p>
    <h4>
     <a id="Nest_3">
     </a>
     Nest创建微服务
    </h4>
    <p>
     前面的http服务都是单体架构的，所有业务逻辑都在一个服务实现。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4036aeb278bb4d6f90eb574dfc8ed1ea.png">
      <br/>
      项目越来越大后，模块越来越多，可以将业务模块拆成单独的微服务。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9cfd9c40fd724978883df5452b3cdc1b.png">
       <br/>
       微服务之间一般不使用http通信的，因为http会携带大量的header。增大通信开销。一般直接用tcp。
      </img>
     </img>
    </p>
    <p>
     启动一个微服务
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c3b63db90ac449d09b3a6d67f482b397.png">
      <br/>
      使用TCP通信，然后暴露一个端口
     </img>
    </p>
    <pre><code class="prism language-ts"><span class="token decorator"><span class="token at operator">@</span><span class="token function">MessagePattern</span></span><span class="token punctuation">(</span><span class="token string">'sum'</span><span class="token punctuation">)</span>
<span class="token function">sum</span><span class="token punctuation">(</span>numArr<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> numArr<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span>total<span class="token punctuation">,</span> item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> total <span class="token operator">+</span> item<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     提供方法也不是@Post这些了，而是MessagePattern。
     <br/>
     这样我们就创建了一个微服务
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/314dd86848b64c4ea718dd2f7d9ac06d.png">
      <br/>
      再创建一个正常的http服务，然后引用这个微服务。
      <br/>
      通过ClientsModule来注入。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6ac97d69cb784b9e96953062423c790f.png">
       <br/>
       然后直接用就行
      </img>
     </img>
    </p>
    <pre><code class="prism language-ts"><span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span><span class="token string">'USER_SERVICE'</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> userClient<span class="token operator">:</span> ClientProxy<span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Get</span></span><span class="token punctuation">(</span><span class="token string">'sum'</span><span class="token punctuation">)</span>
<span class="token function">calc</span><span class="token punctuation">(</span><span class="token decorator"><span class="token at operator">@</span><span class="token function">Query</span></span><span class="token punctuation">(</span><span class="token string">'num'</span><span class="token punctuation">)</span> str<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> numArr <span class="token operator">=</span> str<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">','</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userClient<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'sum'</span><span class="token punctuation">,</span> numArr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     注入的对象就是连接这个微服务的客户端代理。
     <br/>
     这样调用sum接口就会调用微服务的sum方法
     <br/>
     。
     <br/>
     前面在微服务里是用 @MessagePattern 声明的要处理的消息。
     <br/>
     如果并不需要返回消息的话，可以用 @EventPattern 声明：
    </p>
    <pre><code class="prism language-ts"><span class="token decorator"><span class="token at operator">@</span><span class="token function">EventPattern</span></span><span class="token punctuation">(</span><span class="token string">'log'</span><span class="token punctuation">)</span>
<span class="token function">log</span><span class="token punctuation">(</span>str<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     通过抓包我们可以得到他们的通信内容
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a7fe739db8d24ce08274c31e29673247.png">
      <br/>
      他们tcp之间通过json消息格式来通信。
     </img>
    </p>
    <h4>
     <a id="NestMonorepoLibarary_53">
     </a>
     Nest的Monorepo和Libarary
    </h4>
    <blockquote>
     <p>
      Monorepo 是一种项目代码管理方式，指单个仓库中管理多个项目，有助于简化代码共享、版本控制、构建和部署等方面的复杂性，并提供更好的可重用性和协作性。Monorepo 提倡了开放、透明、共享的组织文化，这种方法已经被很多大型公司广泛使用，如 Google、Facebook 和 Microsoft 等。
     </p>
    </blockquote>
    <p>
     如果我们每个服务都用一个git仓库，那微服务多了后，维护成本也变高了，此时可以用monorepo模式。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a5cb0c962f8f434fab55822882432bef.png">
      <br/>
      Nest支持monorepo模式。
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b84c59c6c0ba4bca8db268006a733a20.png"/>
      <br/>
      通过nest g app app2即可，然后会创建apps目录，里面放着对应的每个服务代码。
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d03db09d86c4435ab6fe601aca07e6bd.png"/>
     <br/>
     nest-cli.json保存着每个项目的基本信息。
    </p>
    <p>
     每个模块还可以有公共模块，nest支持library。
     <br/>
     <code>
      nest g lib lib1
     </code>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/27000e853948488c8239b6b19509cc12.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/437cb3eacc9145d9b230ab8af1497f15.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/592ba3f7c2cf4dde8f9b5a3ec1908246.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9a266fe3deb244babb37837b896393a1.png"/>
     <br/>
     这样就可以在其他微服务里面直接应用这个lib。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/22a45e0137a94c679441453ed10ae15a.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a5d0fe1e95914e8db646ff2334994b10.png"/>
    </p>
    <h4>
     <a id="_75">
     </a>
     配置中心和注册中心
    </h4>
    <p>
     不同的服务需要使用相同的配置
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6bd14b825b464bcbbc173d6f1c5646c9.png"/>
     <br/>
     所以需要一个专门管理配置信息的服务。
    </p>
    <h5>
     <a id="_80">
     </a>
     注册中心
    </h5>
    <p>
     服务之间会相互依赖，怎么知道对应的服务挂了吗，或者还有哪些节点可用。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/93701969085e434facd7ca9f1eec3408.png"/>
     <br/>
     微服务在启动的时候，向注册中心注册，销毁的时候也在注册中心注销，并通过定时发送心跳包来回报自己的状态。
     <br/>
     在查找其他微服务的时候，去注册中心查一下这个服务的所有节点信息，然后再选一个来用，这个叫做服务发现。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/09e86110d14040c6b992576c67ccab4f.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f486311aab51409aab66d83f9b83bdfa.png"/>
     <br/>
     配置中心和注册中心是必备组件
     <br/>
     可以做配置中心、注册中心的中间件还是挺多的，比如 nacos、apollo、etcd 等。
    </p>
    <h5>
     <a id="etcd__89">
     </a>
     etcd 实现注册中心和配置中心。
    </h5>
    <p>
     etcd是一个kv的存储服务，k8s 就是用它来做的注册中心、配置中心。
     <br/>
     用法跟redis类似，但可以监听key的变化。
     <br/>
     如下
    </p>
    <pre><code class="prism language-ts"><span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> Etcd3 <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'etcd3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Etcd3</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    hosts<span class="token operator">:</span> <span class="token string">'http://localhost:2379'</span><span class="token punctuation">,</span>
    auth<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        username<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
        password<span class="token operator">:</span> <span class="token string">'guang'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 保存配置</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">saveConfig</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 读取配置</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">getConfig</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 删除配置</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">deleteConfig</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">key</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
   
<span class="token comment">// 服务注册</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">registerService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> instanceId<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/services/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>serviceName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>instanceId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> lease <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">lease</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> lease<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>metadata<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    lease<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'lost'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'租约过期，重新注册...'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">await</span> <span class="token function">registerService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> instanceId<span class="token punctuation">,</span> metadata<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 服务发现</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">discoverService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> instances <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/services/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>serviceName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">strings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span>instances<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 监听服务变更</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">watchService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> callback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> watcher <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">prefix</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/services/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>serviceName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    watcher<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'put'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> event <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'新的服务节点添加:'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">discoverService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'delete'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> event <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务节点删除:'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">discoverService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// (async function main() {<!-- --></span>
<span class="token comment">//     await saveConfig('config-key', 'config-value');</span>
<span class="token comment">//     const configValue = await getConfig('config-key');</span>
<span class="token comment">//     console.log('Config value:', configValue);</span>
<span class="token comment">// })();</span>

<span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> serviceName <span class="token operator">=</span> <span class="token string">'my_service'</span><span class="token punctuation">;</span>
    
    <span class="token keyword">await</span> <span class="token function">registerService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> <span class="token string">'instance_1'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">:</span><span class="token number">3000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">registerService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> <span class="token string">'instance_2'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> host<span class="token operator">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">:</span><span class="token number">3002</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> instances <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">discoverService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'所有服务节点:'</span><span class="token punctuation">,</span> instances<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">watchService</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> updatedInstances <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务节点有变动:'</span><span class="token punctuation">,</span> updatedInstances<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
    <ul>
     <li>
      不同服务的配置需要统一管理，并且在更新后通知所有的服务，所以需要配置中心。
     </li>
     <li>
      微服务的节点可能动态的增加或者删除，依赖他的服务在调用之前需要知道有哪些实例可用，所以需要注册中心。
     </li>
     <li>
      服务启动的时候注册到注册中心，并定时续租期，调用别的服务的时候，可以查一下有哪些服务实例可用，也就是服务注册、服务发现功能。
     </li>
    </ul>
    <h5>
     <a id="Nest_172">
     </a>
     集成到Nest
    </h5>
    <ul>
     <li>
      先写成一个provider
     </li>
    </ul>
    <pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> Module <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> AppController <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.controller'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> AppService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./app.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> Etcd3 <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'etcd3'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  imports<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  controllers<span class="token operator">:</span> <span class="token punctuation">[</span>AppController<span class="token punctuation">]</span><span class="token punctuation">,</span>
  providers<span class="token operator">:</span> <span class="token punctuation">[</span>
    AppService<span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span>
      provide<span class="token operator">:</span> <span class="token string">'ETCD_CLIENT'</span><span class="token punctuation">,</span>
      <span class="token function">useFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Etcd3</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            hosts<span class="token operator">:</span> <span class="token string">'http://localhost:2379'</span><span class="token punctuation">,</span>
            auth<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                username<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
                password<span class="token operator">:</span> <span class="token string">'guang'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> client<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">AppModule</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre>
    <p>
     这样就可以直接注入该provider。
    </p>
    <h6>
     <a id="_204">
     </a>
     封装动态模块
    </h6>
    <pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> DynamicModule<span class="token punctuation">,</span> Module<span class="token punctuation">,</span> ModuleMetadata<span class="token punctuation">,</span> Type <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> EtcdService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./etcd.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> Etcd3<span class="token punctuation">,</span> IOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'etcd3'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">ETCD_CLIENT_TOKEN</span> <span class="token operator">=</span> <span class="token string">'ETCD_CLIENT'</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">ETCD_CLIENT_OPTIONS_TOKEN</span> <span class="token operator">=</span> <span class="token string">'ETCD_CLIENT_OPTIONS'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Module</span></span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">EtcdModule</span> <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">static</span> <span class="token function">forRoot</span><span class="token punctuation">(</span>options<span class="token operator">?</span><span class="token operator">:</span> IOptions<span class="token punctuation">)</span><span class="token operator">:</span> DynamicModule <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
      module<span class="token operator">:</span> EtcdModule<span class="token punctuation">,</span>
      providers<span class="token operator">:</span> <span class="token punctuation">[</span>
        EtcdService<span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span>
          provide<span class="token operator">:</span> <span class="token constant">ETCD_CLIENT_TOKEN</span><span class="token punctuation">,</span>
          <span class="token function">useFactory</span><span class="token punctuation">(</span>options<span class="token operator">:</span> IOptions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Etcd3</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> client<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          inject<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">ETCD_CLIENT_OPTIONS_TOKEN</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span>
          provide<span class="token operator">:</span> <span class="token constant">ETCD_CLIENT_OPTIONS_TOKEN</span><span class="token punctuation">,</span>
          useValue<span class="token operator">:</span> options
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      exports<span class="token operator">:</span> <span class="token punctuation">[</span>
        EtcdService
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     通过动态模块，将options通过forRoot动态传入。然后编写etcdSerivce，其他地方用的时候直接注入该动态模块调用EtcdService的方法就行。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f8aabaebd7d54e1fa619035ccb21811b.png"/>
    </p>
    <h5>
     <a id="gRPC_246">
     </a>
     基于gRPC实现跨语言的微服务通信
    </h5>
    <p>
     多语言实现的微服务之间如何通信呢，http的话是文本传输，效率低。跨语言调用服务一般会用gRPC。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4a14d455dc644d7b940068e5ed580250.png"/>
     <br/>
     将server改造成grpc的微服务
    </p>
    <pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> NestFactory <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/core'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> GrpcOptions<span class="token punctuation">,</span> Transport <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/microservices'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> GrpcServerModule <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./grpc-server.module'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> join <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">await</span> NestFactory<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">createMicroservice</span><span class="token generic class-name"><span class="token operator">&lt;</span>GrpcOptions<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>GrpcServerModule<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    transport<span class="token operator">:</span> Transport<span class="token punctuation">.</span><span class="token constant">GRPC</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      url<span class="token operator">:</span> <span class="token string">'localhost:8888'</span><span class="token punctuation">,</span>
      <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">'book'</span><span class="token punctuation">,</span>
      protoPath<span class="token operator">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'book/book.proto'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">await</span> app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">bootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     tpc改为GRPC。
     <br/>
     在指定位置场景book.proto文件。
     <br/>
     src/book/book.proto
    </p>
    <pre><code class="prism language-ts"><span class="token comment">// 版本语法</span>
syntax <span class="token operator">=</span> <span class="token string">"proto3"</span><span class="token punctuation">;</span>

<span class="token comment">// 包名称</span>
<span class="token keyword">package</span> book<span class="token punctuation">;</span>

<span class="token comment">// 提供的服务方法</span>
service BookService <span class="token punctuation">{<!-- --></span>
  rpc <span class="token function">FindBook</span> <span class="token punctuation">(</span>BookById<span class="token punctuation">)</span> <span class="token function">returns</span> <span class="token punctuation">(</span>Book<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义参数BookById的格式</span>
message BookById <span class="token punctuation">{<!-- --></span>
  int32 id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 定义返回的Book的格式</span>
message Book <span class="token punctuation">{<!-- --></span>
  int32 id <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token builtin">string</span> name <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
  <span class="token builtin">string</span> desc <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这是protocol buffer 的语法，因为要跨语言通信，不同语言语法不同，所以需要一个通用的通信语言。
    </p>
    <p>
     这里book.proto只是定义了格式，具体实现需要在controller中实现。
    </p>
    <pre><code class="prism language-ts"><span class="token decorator"><span class="token at operator">@</span><span class="token function">GrpcMethod</span></span><span class="token punctuation">(</span><span class="token string">'BookService'</span><span class="token punctuation">,</span> <span class="token string">'FindBook'</span><span class="token punctuation">)</span>
<span class="token function">findBook</span><span class="token punctuation">(</span>data<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{<!-- --></span> id<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'前端调试通关秘籍'</span><span class="token punctuation">,</span> desc<span class="token operator">:</span> <span class="token string">'网页和 node 调试'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{<!-- --></span> id<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token string">'Nest 通关秘籍'</span><span class="token punctuation">,</span> desc<span class="token operator">:</span> <span class="token string">'Nest 和各种后端中间件'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> items<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> id <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> id <span class="token operator">===</span> data<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     通过@GrpcMethod标识为grpcde的远程盗用方法。
     <br/>
     并在nest-cli.json中添加assets配置，build的时候可以复制到disst目录下。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/08d0c3478dba43c2ad19fab974d54e6f.png"/>
     <br/>
     然后在另一个服务可以联该grpc服务了。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/21ac997a167041aea532d3ff12acc8e8.png"/>
     <br/>
     先在module中import进来。
     <br/>
     同样调用方也是需要book.proto文件的，不然不知道怎么解析协议数据。文件内容跟grpc服务保持一致即可。
    </p>
    <p>
     然后就可以在controller里面去掉用了
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c67d9c6a48414e2bbf0d1c31899f02dd.png"/>
     <br/>
     通过 @Inject注入，在模块初始化的时候，拿到BookService实例。然后就可以调用他的方法了。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e5466425b11e40b7a9271df1404da2b4.png"/>
     <br/>
     这就是基于grpc的远程方法调用。
    </p>
    <p>
     通过 protocol buffer 的语法定义通信数据的格式，比如 package、service 等。
     <br/>
     然后再server端实现方法，在client端调用该方法。
    </p>
    <p>
     java里面是，安装这两个依赖
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1d3d28fe451a46ababbd1feccc1d86b3.png"/>
     <br/>
     定义同样的proto文件。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9c7ccfc80a2e4cb4b35f1d1e6ac29ad7.png"/>
     <br/>
     然后创建对应的service即可。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a04662e622b848eaaa66145b0c2ba8b8.png"/>
     <br/>
     在client端调用该java服务的时候，跟调用nest服务是一样的。
    </p>
    <h6>
     <a id="_336">
     </a>
     小结
    </h6>
    <ul>
     <li>
      不同语言服务可以用grpc来实现互相调用，而不是http。
     </li>
     <li>
      实现方式是protocol buffer语法来定义通信数据格式，定义package和service。
     </li>
     <li>
      然后在server端实现方法，client通过注入拿到实例，直接调用。
     </li>
    </ul>
    <h5>
     <a id="Prisma_342">
     </a>
     Prisma
    </h5>
    <p>
     Typeorm是一个传统的ORM框架，表映射到entity类，把表的关联映射成enttiy类的属性关联。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f57ae91c7e7f4d0698dcb29041a81473.png"/>
     <br/>
     完成entity和表的映射之后，只需要调用userRepositor和postRepository的find,delete,save等api，typeorm会自动生成对应的sql语句并执行。
    </p>
    <p>
     这就是
     <code>
      ORM (Object Relational Mapping)
     </code>
     ，对象和关系型数据库映射。
    </p>
    <p>
     而Prisma不是这样的。他没有entity类的存在。
    </p>
    <p>
     用法
     <br/>
     定义model，
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/4f9164a5e75943e3bab7ed89f483ab93.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b1e72c59bb0e4f918be37c94677c2856.png"/>
    </p>
    <pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> PrismaClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@prisma/client'</span>

<span class="token keyword">const</span> prisma <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrismaClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">await</span> prisma<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        data<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            name<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
            email<span class="token operator">:</span> <span class="token string">'111@tesst.com'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">await</span> prisma<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        data<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            name<span class="token operator">:</span> <span class="token string">'test'</span><span class="token punctuation">,</span>
            email<span class="token operator">:</span> <span class="token string">'222@test.com'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> users <span class="token operator">=</span> <span class="token keyword">await</span> prisma<span class="token punctuation">.</span>user<span class="token punctuation">.</span><span class="token function">findMany</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>users<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     创建 PrismaClient，用 create 方法创建了 2 个 user，然后查询出来
    </p>
    <p>
     其他命令
    </p>
    <ul>
     <li>
      init：创建 schema 文件
     </li>
     <li>
      generate： 根据 shcema 文件生成 client 代码
     </li>
     <li>
      db：同步数据库和 schema
     </li>
     <li>
      migrate：生成数据表结构更新的 sql 文件
     </li>
     <li>
      studio：用于 CRUD 的图形化界面
     </li>
     <li>
      validate：检查 schema 文件的语法错误
     </li>
     <li>
      format：格式化 schema 文件
     </li>
     <li>
      version：版本信息
     </li>
    </ul>
    <p>
     model 部分定义和数据库表的对应关系：
     <br/>
     @id 定义主键
     <br/>
     @default 定义默认值
     <br/>
     @map 定义字段在数据库中的名字
     <br/>
     @db.xx 定义对应的具体类型
     <br/>
     @updatedAt 定义更新时间的列
     <br/>
     @unique 添加唯一约束
     <br/>
     @relation 定义外键引用
     <br/>
     @@map 定义表在数据库中的名字
     <br/>
     @@index 定义索引
     <br/>
     @@id 定义联合主键
    </p>
    <pre><code class="prism language-ts">model Department <span class="token punctuation">{<!-- --></span>
  id        Int    <span class="token decorator"><span class="token at operator">@</span><span class="token function">id</span></span> @<span class="token keyword">default</span><span class="token punctuation">(</span><span class="token function">autoincrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  name      String  <span class="token decorator"><span class="token at operator">@</span><span class="token function">db</span></span><span class="token punctuation">.</span><span class="token function">VarChar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
  createTime DateTime @<span class="token keyword">default</span><span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  updateTime DateTime <span class="token decorator"><span class="token at operator">@</span><span class="token function">updatedAt</span></span>
  employees     Employee<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

model Employee <span class="token punctuation">{<!-- --></span>
  id         Int       <span class="token decorator"><span class="token at operator">@</span><span class="token function">id</span></span> @<span class="token keyword">default</span><span class="token punctuation">(</span><span class="token function">autoincrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  name      String     <span class="token decorator"><span class="token at operator">@</span><span class="token function">db</span></span><span class="token punctuation">.</span><span class="token function">VarChar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
  phone     String     <span class="token decorator"><span class="token at operator">@</span><span class="token function">db</span></span><span class="token punctuation">.</span><span class="token function">VarChar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>

  deaprtmentId Int
  department     Department      <span class="token decorator"><span class="token at operator">@</span><span class="token function">relation</span></span><span class="token punctuation">(</span>fields<span class="token operator">:</span> <span class="token punctuation">[</span>deaprtmentId<span class="token punctuation">]</span><span class="token punctuation">,</span> references<span class="token operator">:</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     创建时间我们使用 @default(now()) 的方式指定，这样插入数据的时候会自动填入当前时间。
    </p>
    <p>
     更新时间使用 @updatedAt，会自动设置当前时间。
    </p>
    <p>
     员工和部门是多对一关系，在员工那一侧添加一个 departmentId 的列，然后通过 @relation 声明 deaprtmentId 的列引用 department 的 id 列。
    </p>
    <h6>
     <a id="CRUD_api_432">
     </a>
     CRUD api
    </h6>
    <p>
     create、crateMany、update、updateMany、delete、deleteMany、findMany、findFirst、findFirstOrThrow、findUnique、findUniqueOrThrow。
    </p>
    <p>
     统计相关： count、aggregate、groupBy
    </p>
    <pre><code class="prism language-ts">
<span class="token comment">// 返回的最大值、最小值、计数、平均值</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test12</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> prisma<span class="token punctuation">.</span>aaa<span class="token punctuation">.</span><span class="token function">aggregate</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        where<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            email<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                contains<span class="token operator">:</span> <span class="token string">'xx.com'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        _count<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            _all<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        _max<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            age<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        _min<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            age<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        _avg<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            age<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 按照 email 分组，过滤出平均年龄大于 2 的分组，计算年龄总和返回。</span>
<span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">test13</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> prisma<span class="token punctuation">.</span>aaa<span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        by<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'email'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        _count<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          _all<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        _sum<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          age<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        having<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
          age<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            _avg<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
              gt<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <h6>
     <a id="Nestprisma_485">
     </a>
     Nest集成prisma
    </h6>
    <p>
     先primsa init生成prisma文件
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a29cc2374e3e4f1ea55855504be3708e.png"/>
    </p>
    <p>
     创建对应model
    </p>
    <pre><code class="prism language-ts">generator client <span class="token punctuation">{<!-- --></span>
  provider <span class="token operator">=</span> <span class="token string">"prisma-client-js"</span>
<span class="token punctuation">}</span>

datasource db <span class="token punctuation">{<!-- --></span>
  provider <span class="token operator">=</span> <span class="token string">"mysql"</span>
  url      <span class="token operator">=</span> <span class="token function">env</span><span class="token punctuation">(</span><span class="token string">"DATABASE_URL"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

model Department <span class="token punctuation">{<!-- --></span>
  id        Int    <span class="token decorator"><span class="token at operator">@</span><span class="token function">id</span></span> @<span class="token keyword">default</span><span class="token punctuation">(</span><span class="token function">autoincrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  name      String  <span class="token decorator"><span class="token at operator">@</span><span class="token function">db</span></span><span class="token punctuation">.</span><span class="token function">VarChar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
  createTime DateTime @<span class="token keyword">default</span><span class="token punctuation">(</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  updateTime DateTime <span class="token decorator"><span class="token at operator">@</span><span class="token function">updatedAt</span></span>
  employees     Employee<span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

model Employee <span class="token punctuation">{<!-- --></span>
  id         Int       <span class="token decorator"><span class="token at operator">@</span><span class="token function">id</span></span> @<span class="token keyword">default</span><span class="token punctuation">(</span><span class="token function">autoincrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  name      String     <span class="token decorator"><span class="token at operator">@</span><span class="token function">db</span></span><span class="token punctuation">.</span><span class="token function">VarChar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>
  phone     String     <span class="token decorator"><span class="token at operator">@</span><span class="token function">db</span></span><span class="token punctuation">.</span><span class="token function">VarChar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span>  

  deaprtmentId Int
  department     Department      <span class="token decorator"><span class="token at operator">@</span><span class="token function">relation</span></span><span class="token punctuation">(</span>fields<span class="token operator">:</span> <span class="token punctuation">[</span>deaprtmentId<span class="token punctuation">]</span><span class="token punctuation">,</span> references<span class="token operator">:</span> <span class="token punctuation">[</span>id<span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     <code>
      npx prisma migrate reset
     </code>
     <code>
      npx prisma migrate dev --name init
     </code>
     rest后直接初始化，这样数据库就会有两张表。
    </p>
    <p>
     创建一个PrimsaService，方便调用
    </p>
    <pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> Injectable<span class="token punctuation">,</span> OnModuleInit <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> PrismaClient <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@prisma/client'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PrismaService</span> <span class="token keyword">extends</span> <span class="token class-name">PrismaClient</span> <span class="token keyword">implements</span> <span class="token class-name">OnModuleInit</span> <span class="token punctuation">{<!-- --></span>

    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            log<span class="token operator">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                    emit<span class="token operator">:</span> <span class="token string">'stdout'</span><span class="token punctuation">,</span>
                    level<span class="token operator">:</span> <span class="token string">'query'</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">async</span> <span class="token function">onModuleInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     使用直接注入该Service即可
    </p>
    <pre><code class="prism language-ts"><span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> Inject<span class="token punctuation">,</span> Injectable <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@nestjs/common'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> PrismaService <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./prisma.service'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{<!-- --></span> Prisma <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'@prisma/client'</span><span class="token punctuation">;</span>

<span class="token decorator"><span class="token at operator">@</span><span class="token function">Injectable</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">DepartmentService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token decorator"><span class="token at operator">@</span><span class="token function">Inject</span></span><span class="token punctuation">(</span>PrismaService<span class="token punctuation">)</span>
    <span class="token keyword">private</span> prisma<span class="token operator">:</span> PrismaService<span class="token punctuation">;</span>

    <span class="token keyword">async</span> <span class="token function">create</span><span class="token punctuation">(</span>data<span class="token operator">:</span> Prisma<span class="token punctuation">.</span>DepartmentCreateInput<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>prisma<span class="token punctuation">.</span>department<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            data<span class="token punctuation">,</span>
            select<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                id<span class="token operator">:</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这样就可以在nest里面使用Prisma的CRUD了。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6c696e5f6669676874696e2f:61727469636c652f64657461696c732f313435323737393038" class_="artid" style="display:none">
 </p>
</div>


