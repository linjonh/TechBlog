---
arturl_encode: "68747470733a2f2f62:6c6f672e6373646e2e6e65742f58305f496d50655269616c2f:61727469636c652f64657461696c732f313330343338323735"
layout: post
title: "51å•ç‰‡æœº-è‡ªå†™æ“ä½œç³»ç»Ÿ"
date: 2023-04-29 09:37:39 +08:00
description: "æ–‡ç« å±•ç¤ºäº†åœ¨51å•ç‰‡æœºä¸Šå®ç°æ“ä½œç³»ç»Ÿæœ€ç®€æ¨¡å‹çš„è¿‡ç¨‹ï¼Œä»ä»»åŠ¡å»ºç«‹ä¸åˆ‡"
keywords: "51å•ç‰‡æœºæ“ä½œç³»ç»Ÿ"
categories: ['51å•ç‰‡æœºå¤–è®¾é©±åŠ¨']
tags: ['å•ç‰‡æœº']
artid: "130438275"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=130438275
    alt: "51å•ç‰‡æœº-è‡ªå†™æ“ä½œç³»ç»Ÿ"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=130438275
featuredImagePreview: https://bing.ee123.net/img/rand?artid=130438275
---

# 51å•ç‰‡æœº - è‡ªå†™æ“ä½œç³»ç»Ÿ

#### æœ€ç®€OS

* [1> ç‰ˆæœ¬1ï¼šä»»åŠ¡å»ºç«‹ä¸åˆ‡æ¢](#1_1_12)
* [2> ç‰ˆæœ¬2ï¼šå®šæ—¶å™¨åˆ‡æ¢](#2_2_141)
* + [2.1> main.c](#21_mainc_146)
  + [2.2> task.c](#22_taskc_187)
  + [2.3> sleep.c](#23_sleepc_309)
* [3> ç‰ˆæœ¬3ï¼šåŠ æ—¶é—´ç‰‡è½®è½¬](#3_3_403)

> åœ¨51å•ç‰‡æœºä¸Šï¼Œå®ç°æ“ä½œç³»ç»Ÿæœ€ç®€æ¨¡å‹ï¼Œ å­¦ä¹ ç†è§£æ“ä½œç³»ç»Ÿçš„åŸºæœ¬æ¦‚å¿µï¼›

[ğŸ”— //----------- å‚è€ƒè§†é¢‘é“¾æ¥ ï¼ˆ15é›†ï¼‰ -----------//](https://www.bilibili.com/video/BV1ym4y1y7Jm/?spm_id_from=333.999.list.card_archive.click&vd_source=c3471ffcf292e2d0642995f2056a2b8c)

## 1> ç‰ˆæœ¬1ï¼šä»»åŠ¡å»ºç«‹ä¸åˆ‡æ¢

```c
#include <STC89C5xRC.H>
#include <intrins.h>


sbit LED_0	 = P0^0;
sbit LED_1	 = P0^1;

#define MAX_TASKS		2		// ä»»åŠ¡ä¸ªæ•°ï¼štask0ï¼Œtask1ï¼›		
#define MAX_TASK_DEP	32		// ä»»åŠ¡æœ€å¤§æ ˆæ·±åº¦ï¼šä»»åŠ¡åˆ‡æ¢æ—¶ä¿å­˜ç°åœºï¼›

unsigned char idata task_sp[MAX_TASKS];		// ä»»åŠ¡å †æ ˆæŒ‡é’ˆæ•°ç»„ï¼›
unsigned char idata task_stack[MAX_TASKS][MAX_TASK_DEP];	// ä»»åŠ¡å †æ ˆï¼Œ 2ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡åˆ†é…32Byteç©ºé—´ï¼›

unsigned char task_id;


/*-- CPU Delay --*/
void Delay1000ms()		//@22.1184MHz
{
	unsigned char i, j, k;

	_nop_();
	i = 15;
	j = 2;
	k = 235;
	do
	{
		do
		{
			while (--k);
		} while (--j);
	} while (--i);
}




/**
  * @brief  ä»»ä½•åˆ‡æ¢å‡½æ•°ï¼ˆä»»åŠ¡è°ƒåº¦ï¼‰
  * @param  None
  * @retval None
  */
void task_switch()
{
	task_sp[task_id] = SP;	// ä¿å­˜å½“å‰çš„SPï¼›

	task_id = task_id + 1;
	if (task_id == MAX_TASKS) {
		task_id = 0;
	}

	SP = task_sp[task_id];	// æŠŠä¸‹ä¸€ä¸ªtaskçš„spæ”¾å…¥åˆ°å½“å‰çš„SP
}


/**
  * @brief  ä»»åŠ¡0ï¼›
  * @param  None
  * @retval None
  */
void task0()
{
	
	LED_0 = 0;
	while (1) {
		LED_0 = ~LED_0;

		Delay1000ms();

		task_switch();	// ä»»åŠ¡åˆ‡æ¢ 
	}
}

/**
  * @brief  ä»»åŠ¡1ï¼›
  * @param  None
  * @retval None
  */
void task1()
{
	
	LED_1 = 0;
	while (1) {
		LED_1 = ~LED_1;
		Delay1000ms();
		task_switch();	// ä»»åŠ¡åˆ‡æ¢ 
	}
}


// å‡½æ•°çš„åœ°å€ï¼ˆæŒ‡é’ˆï¼‰å 16bitï¼›
// fn:å­˜æ”¾å‡½æ•°çš„åœ°å€ï¼›
// tidï¼štask idï¼Œ0æˆ–1ï¼›

void task_load(unsigned int fn, unsigned char tid)
{
	// 51å•ç‰‡æœºä¸­ï¼Œå †æ ˆå‘ä¸Šå¢é•¿ï¼›
	task_sp[tid] = task_stack[tid] + 1;	 // å°†ä»»åŠ¡å †æ ˆæŒ‡é’ˆè®¾ç½®ä¸ºä¸‹ä¸€ä¸ªç©ºé—²ä½ç½®ï¼Œé¢„ç•™2ä¸ªByteç”¨æ¥å­˜æ”¾taskçš„å‡½æ•°åœ°å€ï¼›

	// å­˜æ”¾task0æˆ–task1å‡½æ•°çš„é¦–åœ°å€
	task_stack[tid][0] = fn & 0xff;
	task_stack[tid][1] = fn >> 8;  
}

void main()
{
	task_load(task0, 0);
	task_load(task1, 1);

	task_id = 0;		// æŠŠå½“å‰ä»»åŠ¡è®¾ç½®ä¸ºtask0ï¼›
	SP = task_sp[0];	// æ‰§è¡Œtask0ï¼› 
}
//----------------------------------- End ---------------------------//

```

å†…å­˜åˆ†é…ï¼š
  
![1](https://i-blog.csdnimg.cn/blog_migrate/a816acb3a31af38a07a7e5665baced10.png)

å®éªŒç»“æœï¼šLED0æ³¢å½¢
  
![1](https://i-blog.csdnimg.cn/blog_migrate/835dce044afcd1ba7478d2d723358fdd.png#pic_center)

> é—®é¢˜ï¼šä¸ºä»€ä¹ˆLED0å’ŒLED1ä¼šäº®2sï¼Œç­2så‘¢ï¼Œå¦‚ä½•æ”¹ä¸ºæƒ³è¦äº®1sï¼Œç­1s

> void Delay1000ms()ï¼š æ˜¯CPUåœ¨ï¼Œä¸å¹²å…¶ä»–æ´»ï¼Œå‚»å»¶æ—¶ï¼Œæ‰€ä»¥LED0åœ¨ç­‰çš„åŒæ—¶LED1ä¹Ÿåœ¨ç­‰ï¼›

---

## 2> ç‰ˆæœ¬2ï¼šå®šæ—¶å™¨åˆ‡æ¢

> ä½¿ç”¨51å†…éƒ¨ï¼Œå®šæ—¶å™¨0ç¡¬ä»¶èµ„æºæ¥å®šæ—¶ï¼Œè®©CPUé‡Šæ”¾ï¼›

---

### 2.1> main.c

```c
#include "main.h"

void main()
{
	Timer0_Init();
	task_load(task0, 0);
	task_load(task1, 1);

	task_id = 0;		// æŠŠå½“å‰ä»»åŠ¡è®¾ç½®ä¸ºtask0ï¼›
	SP = task_sp[0];	// æ‰§è¡Œtask0ï¼› 
}

```

---

main.h

```c
#ifndef __MAIN_H__
#define __MAIN_H__

#include <STC89C5xRC.H>

sbit LED_0	= P0^0;
sbit LED_1	= P0^1;

#define MAX_TASKS		2		// ä»»åŠ¡ä¸ªæ•°ï¼štask0ï¼Œtask1ï¼›		
#define MAX_TASK_DEP	32		// ä»»åŠ¡æœ€å¤§æ ˆæ·±åº¦ï¼šä»»åŠ¡åˆ‡æ¢æ—¶ä¿å­˜ç°åœºï¼›


#include "sleep.h"
#include "task.h"

#endif



```

---

### 2.2> task.c

```c

#include "task.h"

unsigned char idata task_sp[MAX_TASKS];		// ä»»åŠ¡å †æ ˆæŒ‡é’ˆæ•°ç»„ï¼›
unsigned char idata task_stack[MAX_TASKS][MAX_TASK_DEP];	// ä»»åŠ¡å †æ ˆï¼Œ 2ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡åˆ†é…32Byteç©ºé—´ï¼›

unsigned char task_id;


/**
  * @brief  ä»»ä½•åˆ‡æ¢å‡½æ•°ï¼ˆä»»åŠ¡è°ƒåº¦ï¼‰
  * @param  None
  * @retval None
  */
void task_switch()
{
	task_sp[task_id] = SP;	// ä¿å­˜å½“å‰çš„SPï¼›

	task_id = task_id + 1;
	if (task_id == MAX_TASKS) {
		task_id = 0;
	}

	SP = task_sp[task_id];	// æŠŠä¸‹ä¸€ä¸ªtaskçš„spæ”¾å…¥åˆ°å½“å‰çš„SP
}


/**
  * @brief  ä»»åŠ¡0ï¼›
  * @param  None
  * @retval None
  */
void task0()
{
	
	LED_0 = 0;
	while (1) {
		
		if (tasks[0].status == TASK_SUSPENDED) {
			task_switch();
			continue;	// å¦‚æœä»»åŠ¡å¤„äºsleepæŒ‚èµ·çŠ¶æ€ï¼Œç›´æ¥è·³å‡º		
		}


		LED_0 = ~LED_0;

		sleep(0, 1000); // ä»»åŠ¡0ï¼Œç¡çœ 1sï¼›æ²¡æœ‰ä»»ä½•é˜»å¡ï¼›

		task_switch();	// ä»»åŠ¡åˆ‡æ¢ 
	}
}

/**
  * @brief  ä»»åŠ¡1ï¼›
  * @param  None
  * @retval None
  */
void task1()
{
	
	LED_1 = 0;
	while (1) {

		if (tasks[1].status == TASK_SUSPENDED) {
			task_switch();
			continue;	// å¦‚æœä»»åŠ¡å¤„äºsleepæŒ‚èµ·çŠ¶æ€ï¼Œç›´æ¥è·³å‡º		
		}

		LED_1 = ~LED_1;
		sleep(1, 1000);
		task_switch();	// ä»»åŠ¡åˆ‡æ¢ 
	}
}


// å‡½æ•°çš„åœ°å€ï¼ˆæŒ‡é’ˆï¼‰å 16bitï¼›
// fn:å­˜æ”¾å‡½æ•°çš„åœ°å€ï¼›
// tidï¼štask idï¼Œ0æˆ–1ï¼›

void task_load(unsigned int fn, unsigned char tid)
{
	// 51å•ç‰‡æœºä¸­ï¼Œå †æ ˆå‘ä¸Šå¢é•¿ï¼›
	task_sp[tid] = task_stack[tid] + 1;	 // å°†ä»»åŠ¡å †æ ˆæŒ‡é’ˆè®¾ç½®ä¸ºä¸‹ä¸€ä¸ªç©ºé—²ä½ç½®ï¼Œé¢„ç•™2ä¸ªByteç”¨æ¥å­˜æ”¾taskçš„å‡½æ•°åœ°å€ï¼›

	// å­˜æ”¾task0æˆ–task1å‡½æ•°çš„é¦–åœ°å€
	task_stack[tid][0] = fn & 0xff;
	task_stack[tid][1] = fn >> 8;  
}


```

task.h

```c
#ifndef __TASK_H__
#define __TASK_H__


#include "main.h"



extern unsigned char idata task_sp[MAX_TASKS];		// ä»»åŠ¡å †æ ˆæŒ‡é’ˆæ•°ç»„ï¼›
extern unsigned char idata task_stack[MAX_TASKS][MAX_TASK_DEP];	// ä»»åŠ¡å †æ ˆï¼Œ 2ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡åˆ†é…32Byteç©ºé—´ï¼›

extern unsigned char task_id;

void task0();
void task1();
void task_load(unsigned int fn, unsigned char tid);
void task_switch();


#endif

```

---

### 2.3> sleep.c

```c

#include "sleep.h" 

Task idata tasks[MAX_TASKS] = {
	{0, TASK_RUNNING, 0, 0},	// ä»»åŠ¡0ï¼Œé»˜è®¤è¿è¡ŒçŠ¶æ€ï¼Œä¸å»¶æ—¶ï¼Œå½“å‰å»¶æ—¶æ—¶é—´0ï¼›
	{0, TASK_RUNNING, 0, 0},	// ä»»åŠ¡1ï¼Œé»˜è®¤è¿è¡ŒçŠ¶æ€ï¼Œä¸å»¶æ—¶ï¼Œå½“å‰å»¶æ—¶æ—¶é—´0ï¼›
};

void sleep(unsigned int task_id, unsigned int delay_ms)
{	
	tasks[task_id].status = TASK_SUSPENDED;
	tasks[task_id].delay_count = 0;
	tasks[task_id].delay_duration = delay_ms;
}

//1æ¯«ç§’@22.1184MHz
void Timer0_Init(void)	
{
	TMOD &= 0xF0;	//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
	TMOD |= 0x01;	//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
	TL0 = 0xCD;		//è®¾ç½®å®šæ—¶åˆå§‹å€¼
	TH0 = 0xF8;		//è®¾ç½®å®šæ—¶åˆå§‹å€¼
	TF0 = 0;		//æ¸…é™¤TF0æ ‡å¿—

	ET0 = 1;
	EA = 1;
	TR0 = 1;		//å®šæ—¶å™¨0å¼€å§‹è®¡æ—¶
}


/*--- å®šä½å™¨0ä¸­æ–­æœåŠ¡å‡½æ•°, 1msä¸­æ–­1æ¬¡ ---*/
void Timer0_ISR(void) interrupt 1  
{
	unsigned char i;

	TL0 = 0xCD;		//è®¾ç½®å®šæ—¶åˆå§‹å€¼
	TH0 = 0xF8;		//è®¾ç½®å®šæ—¶åˆå§‹å€¼

	for (i = 0; i < MAX_TASKS; i++) {
		if (tasks[i].status == TASK_SUSPENDED) {
			tasks[i].delay_count++;

			if (tasks[i].delay_count >= tasks[i].delay_duration) {
				tasks[i].status = TASK_RUNNING;
				tasks[i].delay_count = 0;
			}
		}
	}

}


```

---

sleep.h

```c
#ifndef __SLEEP_H__
#define __SLEEP_H__


#include "main.h"



typedef enum {
	TASK_RUNNING,
	TASK_SUSPENDED
} TaskStatus;


/*--- å®šä¹‰ä»»åŠ¡ç»“æ„ä½“ ---*/
typedef struct {
	unsigned char id; 				// ä»»åŠ¡id
	TaskStatus status;				// ä»»åŠ¡çŠ¶æ€
	unsigned int delay_count;		// å»¶æ—¶è®¡æ•°å™¨
	unsigned int delay_duration;	// å»¶æ—¶æ—¶é—´
} Task;

extern Task idata tasks[MAX_TASKS];

void Timer0_Init(void);
void sleep(unsigned int task_id, unsigned int delay_ms);


#endif

```

---

## 3> ç‰ˆæœ¬3ï¼šåŠ æ—¶é—´ç‰‡è½®è½¬

> ç‰ˆæœ¬2ä¸­å¦‚æœå…¶ä¸­ä¸€ä¸ªä»»åŠ¡ï¼Œä¸ä¸»åŠ¨task_switch()åˆ‡æ¢ä»»åŠ¡ï¼Œæ€ä¹ˆåŠï¼Ÿ
>   
> å†ç”¨ä¸€ä¸ªç¡¬ä»¶èµ„æºTimer1ï¼Œ200usä¸­æ–­ä¸€æ¬¡ï¼Œå¹¶å¼ºåˆ¶åˆ‡æ¢ï¼›

sleep.c å¢åŠ ï¼š

```c

void Timer1_Init(void)		//200å¾®ç§’@22.1184MHz
{
	TMOD &= 0x0F;			//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
	TMOD |= 0x10;			//è®¾ç½®å®šæ—¶å™¨æ¨¡å¼
	TL1 = 0xB8;				//è®¾ç½®å®šæ—¶åˆå§‹å€¼
	TH1 = 0xEE;				//è®¾ç½®å®šæ—¶åˆå§‹å€¼
	TF1 = 0;				//æ¸…é™¤TF1æ ‡å¿—
	
	ET1 = 1;
	EA = 1;
	TR1 = 1;				//å®šæ—¶å™¨1å¼€å§‹è®¡æ—¶
}




void Timer1_ISR(void) interrupt 3  
{
	TL1 = 0xB8;				//è®¾ç½®å®šæ—¶åˆå§‹å€¼
	TH1 = 0xEE;				//è®¾ç½®å®šæ—¶åˆå§‹å€¼
	
	task_switch();
}

```

ä»£ç æ²¡å®ç°ï¼š

> ä»»åŠ¡çš„ä¼˜å…ˆçº§ï¼›
>   
> ä»»åŠ¡ä¹‹é—´æ²¡æœ‰ä¿¡å·é‡ï¼Œæ¶ˆæ¯æœºåˆ¶ï¼›
>   
> æ–‡ä»¶ç®¡ç†ï¼›
>   
> å†…å­˜ç®¡ç†ï¼›