---
layout: post
title: "FFmpeg系列四-mp4音视频流分离"
date: 2024-12-03 15:52:19 +0800
description: "ffmpeg系列，将mp4音视频流分离成h264和aac格式文件_ffmpeg 提取mp4 中的视频"
keywords: "ffmpeg 提取mp4 中的视频"
categories: ['Ffmpeg']
tags: ['Ffmpeg']
artid: "121867036"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=121867036
    alt: "FFmpeg系列四-mp4音视频流分离"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=121867036
featuredImagePreview: https://bing.ee123.net/img/rand?artid=121867036
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     FFmpeg系列（四）—— mp4音视频流分离
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <a href="#1_2" rel="nofollow">
        1、介绍
       </a>
      </li>
      <li>
       <a href="#2_5" rel="nofollow">
        2、完整代码
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h2>
     <a id="1_2">
     </a>
     1、介绍
    </h2>
    <p>
     本文将介绍如何将mp4文件里的音视频分离出来，输出成h264和aac格式文件。整个代码逻辑相对比较简单，main函数一开始做一些基本的初始化，然后在死循环里不断读取音视频流，如果是音频则将数据写入aac文件，如果是视频则写入h264文件，直到音视频帧读取完成。
     <br/>
     需要注意的是，在写入音频帧时需要加如adts音频头，格式是固定的，代码如下：
    </p>
    <h2>
     <a id="2_5">
     </a>
     2、完整代码
    </h2>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token keyword">extern</span> <span class="token string">"C"</span>
<span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavutil/log.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavformat/avformat.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">__cplusplus</span></span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token comment">// 添加音频头，固定格式</span>
<span class="token keyword">int</span> <span class="token function">adts_header</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> p_adts_header<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> data_length<span class="token punctuation">,</span>
                <span class="token keyword">const</span> <span class="token keyword">int</span> profile<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> samplerate<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">int</span> channels<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> sampling_index   <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>               <span class="token comment">// 默认使用48000hz</span>
    <span class="token keyword">int</span> adtsLen          <span class="token operator">=</span> data_length <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment">// adts长度等于数据长度+7字节音频头</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>samplerate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>                   <span class="token comment">// 将采样率转换成索引值</span>
        <span class="token keyword">case</span> <span class="token number">96000</span><span class="token operator">:</span> sampling_index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">88200</span><span class="token operator">:</span> sampling_index <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">64000</span><span class="token operator">:</span> sampling_index <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">48000</span><span class="token operator">:</span> sampling_index <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">44100</span><span class="token operator">:</span> sampling_index <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">32000</span><span class="token operator">:</span> sampling_index <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">24000</span><span class="token operator">:</span> sampling_index <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>    sampling_index <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    p_adts_header<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xff</span><span class="token punctuation">;</span>                                <span class="token comment">//syncword:0xfff                          高8bits</span>
    p_adts_header<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xf0</span><span class="token punctuation">;</span>                                <span class="token comment">//syncword:0xfff                          低4bits</span>
    p_adts_header<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">//MPEG Version:0 for MPEG-4,1 for MPEG-2  1bit</span>
    p_adts_header<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">//Layer:0                                 2bits</span>
    p_adts_header<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token number">1</span><span class="token punctuation">;</span>                                  <span class="token comment">//protection absent:1                     1bit</span>

    p_adts_header<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>profile<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">;</span>                        <span class="token comment">//profile:profile                 2bits</span>
    p_adts_header<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span>sampling_index <span class="token operator">&amp;</span> <span class="token number">0x0f</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">;</span>         <span class="token comment">//sampling frequency index:sampling_frequency_index  4bits</span>
    p_adts_header<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">//private bit:0                   1bit</span>
    p_adts_header<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span>channels <span class="token operator">&amp;</span> <span class="token number">0x04</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">2</span><span class="token punctuation">;</span>               <span class="token comment">//channel configuration:channels  高1bit</span>

    p_adts_header<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>channels <span class="token operator">&amp;</span> <span class="token number">0x03</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">;</span>                <span class="token comment">//channel configuration:channels  低2bits</span>
    p_adts_header<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">//original：0                     1bit</span>
    p_adts_header<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">//home：0                         1bit</span>
    p_adts_header<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">//copyright id bit：0             1bit</span>
    p_adts_header<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">//copyright id start：0           1bit</span>
    p_adts_header<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>adtsLen <span class="token operator">&amp;</span> <span class="token number">0x1800</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//frame length：value             高2bits</span>

    p_adts_header<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>adtsLen <span class="token operator">&amp;</span> <span class="token number">0x7f8</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//frame length:value              中间8bits</span>
    p_adts_header<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>adtsLen <span class="token operator">&amp;</span> <span class="token number">0x7</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//frame length:value              低3bits</span>
    p_adts_header<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token number">0x1f</span><span class="token punctuation">;</span>                               <span class="token comment">//buffer fullness:0x7ff           高5bits</span>
    p_adts_header<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0xfc</span><span class="token punctuation">;</span>                                <span class="token comment">//‭buffer fullness:0x7ff           低6bits 11111100‬</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span>            <span class="token operator">*</span>mp4_filename     <span class="token operator">=</span> <span class="token string">"source.mp4"</span><span class="token punctuation">;</span>               <span class="token comment">// mp4视频，200kbps.768x320</span>
    <span class="token keyword">char</span>            <span class="token operator">*</span>h264_filename    <span class="token operator">=</span> <span class="token string">"out.h264"</span><span class="token punctuation">;</span>                 <span class="token comment">// 视频流输出文件</span>
    <span class="token keyword">char</span>            <span class="token operator">*</span>aac_filename     <span class="token operator">=</span> <span class="token string">"out.aac"</span><span class="token punctuation">;</span>                  <span class="token comment">// 音频流输出文件</span>
    FILE            <span class="token operator">*</span>aac_fd           <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>aac_filename<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 打开aac音频输出文件</span>
    FILE            <span class="token operator">*</span>h264_fd          <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>h264_filename<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开h264视频输出文件</span>
    AVFormatContext <span class="token operator">*</span>fmt_ctx          <span class="token operator">=</span> <span class="token function">avformat_alloc_context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 解封装上下文</span>
    AVPacket        <span class="token operator">*</span>pkt              <span class="token operator">=</span> <span class="token function">av_packet_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">// 为packet分配空间，用于存放音视频帧数据</span>
    AVBSFContext    <span class="token operator">*</span>bsf_ctx          <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>                       <span class="token comment">// bit流过滤器上下文</span>
    <span class="token keyword">int</span>             video_index       <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                         <span class="token comment">// 视频流索引</span>
    <span class="token keyword">int</span>             audio_index       <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>                         <span class="token comment">// 音频流索引</span>
    <span class="token keyword">const</span> AVBitStreamFilter <span class="token operator">*</span>bsfilter <span class="token operator">=</span> <span class="token function">av_bsf_get_by_name</span><span class="token punctuation">(</span><span class="token string">"h264_mp4toannexb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 查找h264比特流过滤器</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>h264_fd<span class="token punctuation">)</span>  <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span class="token comment">// h264视频输出文件打开失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>aac_fd<span class="token punctuation">)</span>   <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span class="token comment">// aac音频输出文件打开失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fmt_ctx<span class="token punctuation">)</span>  <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span class="token comment">// 解封装上下文创建失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pkt<span class="token punctuation">)</span>      <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span class="token comment">// AVPacket创建失败</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bsfilter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>  <span class="token comment">// bit流过滤器创建失败</span>


    <span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token function">avformat_open_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fmt_ctx<span class="token punctuation">,</span> mp4_filename<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打开音视频流</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fmt_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭音视频流</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取视频和音频索引</span>
    video_index <span class="token operator">=</span> <span class="token function">av_find_best_stream</span><span class="token punctuation">(</span>fmt_ctx<span class="token punctuation">,</span> AVMEDIA_TYPE_VIDEO<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    audio_index <span class="token operator">=</span> <span class="token function">av_find_best_stream</span><span class="token punctuation">(</span>fmt_ctx<span class="token punctuation">,</span> AVMEDIA_TYPE_AUDIO<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>video_index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> audio_index <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fmt_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭音视频流</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 音视频索引获取失败</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">av_bsf_alloc</span><span class="token punctuation">(</span>bsfilter<span class="token punctuation">,</span> <span class="token operator">&amp;</span>bsf_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 为h264比特流过滤器分配空间</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fmt_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭音视频流</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 空间分配失败</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 将编码器的参数拷贝给bit流过滤器</span>
    ret <span class="token operator">=</span> <span class="token function">avcodec_parameters_copy</span><span class="token punctuation">(</span>bsf_ctx<span class="token operator">-&gt;</span>par_in<span class="token punctuation">,</span> fmt_ctx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>video_index<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fmt_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭音视频流</span>
        <span class="token function">av_bsf_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bsf_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 参数拷贝失败</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">av_bsf_init</span><span class="token punctuation">(</span>bsf_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 初始化bit流过滤器</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fmt_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭音视频流</span>
        <span class="token function">av_bsf_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>bsf_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">av_init_packet</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">av_read_frame</span><span class="token punctuation">(</span>fmt_ctx<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>              <span class="token comment">// 音视频流读取结束</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>stream_index <span class="token operator">==</span> video_index<span class="token punctuation">)</span> <span class="token comment">// 视频流</span>
        <span class="token punctuation">{<!-- --></span>
            ret <span class="token operator">=</span> <span class="token function">av_bsf_send_packet</span><span class="token punctuation">(</span>bsf_ctx<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ret <span class="token operator">=</span> <span class="token function">av_bsf_receive_packet</span><span class="token punctuation">(</span>bsf_ctx<span class="token punctuation">,</span> pkt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 检索已过滤的数据包</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
                <span class="token function">fwrite</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">,</span> h264_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 写入h264数据</span>
                <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放buffer</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>stream_index <span class="token operator">==</span> audio_index<span class="token punctuation">)</span>  <span class="token comment">// 音频流</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">char</span> adts_header_buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token comment">// 每个packet都要添加一个7字节的音频头</span>
            <span class="token function">adts_header</span><span class="token punctuation">(</span>adts_header_buf<span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">,</span>
                        fmt_ctx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>audio_index<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>profile<span class="token punctuation">,</span>     <span class="token comment">// 编码器bit流限制</span>
                        fmt_ctx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>audio_index<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>sample_rate<span class="token punctuation">,</span> <span class="token comment">// 采样率</span>
                        fmt_ctx<span class="token operator">-&gt;</span>streams<span class="token punctuation">[</span>audio_index<span class="token punctuation">]</span><span class="token operator">-&gt;</span>codecpar<span class="token operator">-&gt;</span>channels<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 通道数</span>
            <span class="token function">fwrite</span><span class="token punctuation">(</span>adts_header_buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> aac_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 写adts header，7字节音频头</span>
            <span class="token function">fwrite</span><span class="token punctuation">(</span>pkt<span class="token operator">-&gt;</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> pkt<span class="token operator">-&gt;</span>size<span class="token punctuation">,</span> aac_fd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写adts data，音频数据</span>
            <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放buffer</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token comment">// 其他流</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_packet_unref</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 释放buffer</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Split OK!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>h264_fd<span class="token punctuation">)</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>h264_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>aac_fd<span class="token punctuation">)</span>
        <span class="token function">fclose</span><span class="token punctuation">(</span>aac_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>pkt<span class="token punctuation">)</span>
        <span class="token function">av_packet_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pkt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>fmt_ctx<span class="token punctuation">)</span>
        <span class="token function">avformat_close_input</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fmt_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34393430363239352f:61727469636c652f64657461696c732f313231383637303336" class_="artid" style="display:none">
 </p>
</div>


