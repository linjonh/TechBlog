---
layout: post
title: "WxJava开发小程序登录手机号小程序码微信支付"
date: 2023-09-12 18:19:03 +0800
description: "WxJava是微信Java开发工具包，支持包括微信支付、开放平台、"
keywords: "wxjava"
categories: ['Java']
tags: ['微信', 'Spring', 'Java', 'Boot']
artid: "132837104"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=132837104
    alt: "WxJava开发小程序登录手机号小程序码微信支付"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=132837104
featuredImagePreview: https://bing.ee123.net/img/rand?artid=132837104
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     WxJava开发小程序登录、手机号、小程序码、微信支付
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      WxJava开发微信支付、微信登录
     </h4>
     <ul>
      <li>
       <a href="#_5" rel="nofollow">
        前言
       </a>
      </li>
      <li>
       <a href="#_19" rel="nofollow">
        一、引入依赖
       </a>
      </li>
      <li>
       <a href="#_34" rel="nofollow">
        二、修改配置文件
       </a>
      </li>
      <li>
       <a href="#_54" rel="nofollow">
        三、小程序微信登录
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1_55" rel="nofollow">
          1.登录流程时序
         </a>
        </li>
        <li>
         <a href="#2openidunionidcode_57" rel="nofollow">
          2.认识openid、unionid和code
         </a>
        </li>
        <li>
         <a href="#3_76" rel="nofollow">
          3.代码实现
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_284" rel="nofollow">
        四、小程序手机号快速验证
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1_285" rel="nofollow">
          1.小程序端
         </a>
        </li>
        <li>
         <a href="#2Java_304" rel="nofollow">
          2.Java端
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_319" rel="nofollow">
        五、获取小程序二维码
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1yml_332" rel="nofollow">
          1.配置yml文件
         </a>
        </li>
        <li>
         <a href="#2properties_345" rel="nofollow">
          2.注入properties
         </a>
        </li>
        <li>
         <a href="#3WxMaConfiguration_WxMaQrcodeService_391" rel="nofollow">
          3.修改WxMaConfiguration 注入WxMaQrcodeService
         </a>
        </li>
        <li>
         <a href="#4_405" rel="nofollow">
          4.调用
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_413" rel="nofollow">
        六、小程序微信支付
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1_414" rel="nofollow">
          1.业务流程图
         </a>
        </li>
        <li>
         <a href="#2_416" rel="nofollow">
          2.签名、私钥、证书、敏感信息加解密说明
         </a>
        </li>
        <li>
         <a href="#3_452" rel="nofollow">
          3.代码实现
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <hr/>
    <h2>
     <a id="_5">
     </a>
     前言
    </h2>
    <p>
     WxJava是微信Java开发工具包，支持包括微信支付、开放平台、公众号、企业微信/企业号、小程序等微信功能模块的后端开发。
    </p>
    <table>
     <thead>
      <tr>
       <th>
        名称
       </th>
       <th>
        网站
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        Gitee官网
       </td>
       <td>
        <a href="https://gitee.com/binary/weixin-java-tools" rel="nofollow">
         https://gitee.com/binary/weixin-java-tools
        </a>
       </td>
      </tr>
      <tr>
       <td>
        WxJava在线文档
       </td>
       <td>
        <a href="http://wxjava.fly2you.cn/zh-CN/start/pay/explain.html" rel="nofollow">
         http://wxjava.fly2you.cn/zh-CN/start/pay/explain.html
        </a>
       </td>
      </tr>
      <tr>
       <td>
        开发文档Wiki
       </td>
       <td>
        <a href="https://github.com/wechat-group/WxJava/wiki">
         https://github.com/wechat-group/WxJava/wiki
        </a>
       </td>
      </tr>
      <tr>
       <td>
        Javadoc
       </td>
       <td>
        <a href="http://binary.ac.cn/weixin-java-miniapp-javadoc/" rel="nofollow">
         weixin-java-miniapp
        </a>
        、
        <a href="http://binary.ac.cn/weixin-java-pay-javadoc/" rel="nofollow">
         weixin-java-pay
        </a>
        、
        <a href="http://binary.ac.cn/weixin-java-mp-javadoc/" rel="nofollow">
         weixin-java-mp
        </a>
        、
        <a href="http://binary.ac.cn/weixin-java-common-javadoc/" rel="nofollow">
         weixin-java-common
        </a>
        、
        <a href="http://binary.ac.cn/weixin-java-cp-javadoc/" rel="nofollow">
         weixin-java-cp
        </a>
        、
        <a href="http://binary.ac.cn/weixin-java-open-javadoc/" rel="nofollow">
         weixin-java-open
        </a>
       </td>
      </tr>
      <tr>
       <td>
        微信支付文档
       </td>
       <td>
        <a href="https://pay.weixin.qq.com/docs/merchant/apis/mini-program-payment/mini-prepay.html" rel="nofollow">
         https://pay.weixin.qq.com/docs/merchant/apis/mini-program-payment/mini-prepay.html
        </a>
       </td>
      </tr>
      <tr>
       <td>
        微信登录文档
       </td>
       <td>
        <a href="https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html" rel="nofollow">
         https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-login/code2Session.html
        </a>
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <strong>
      准备工作
     </strong>
     <br/>
     微信支付需要开通微信支付商户具体需要什么查看官网：
     <a href="https://pay.weixin.qq.com/docs/merchant/products/jsapi-payment/preparation.html" rel="nofollow">
      https://pay.weixin.qq.com/docs/merchant/products/jsapi-payment/preparation.html
     </a>
    </p>
    <h2>
     <a id="_19">
     </a>
     一、引入依赖
    </h2>
    <p>
     我这里使用的版本是4.5.0
    </p>
    <pre><code class="prism language-bash"><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com.github.binarywang<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>weixin-java-pay<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token variable">${weixin-java.version}</span><span class="token operator">&lt;</span>/version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com.github.binarywang<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>weixin-java-miniapp<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token variable">${weixin-java.version}</span><span class="token operator">&lt;</span>/version<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
</code></pre>
    <h2>
     <a id="_34">
     </a>
     二、修改配置文件
    </h2>
    <p>
     此处配置信息已经更改过不能直接使用
     <br/>
     微信支付采用的是apiV3版本
     <br/>
     证书路径可以是绝对路径也可以是classpath，我放到的项目的/resource/cert下
    </p>
    <pre><code class="prism language-yml"><span class="token key atrule">wx</span><span class="token punctuation">:</span>
  <span class="token key atrule">miniapp</span><span class="token punctuation">:</span>
    <span class="token key atrule">configs</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">appid</span><span class="token punctuation">:</span> wx2xxxxxxxx
        <span class="token key atrule">secret</span><span class="token punctuation">:</span> f7bd3ed88cxxxxxxx222e1a7e4f722ad9
        <span class="token key atrule">msgDataFormat</span><span class="token punctuation">:</span> JSON
  <span class="token key atrule">pay</span><span class="token punctuation">:</span>
    <span class="token key atrule">appId</span><span class="token punctuation">:</span> wx2d0f68xxx7f <span class="token comment">#微信公众号或者小程序等的appid</span>
    <span class="token key atrule">mchId</span><span class="token punctuation">:</span> <span class="token number">1650000080</span> <span class="token comment">#微信支付商户号</span>
    <span class="token key atrule">apiV3Key</span><span class="token punctuation">:</span> TWBQNkNwwjxxxxx2hN5oQ
    <span class="token key atrule">certSerialNo</span><span class="token punctuation">:</span> 2078791B21788DC90E44xxxxxx7291FFD
    <span class="token key atrule">privateKeyPath</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>cert/apiclient_key.pem <span class="token comment">#apiclient_key.pem证书文件的绝对路径或者以classpath:开头的类路径</span>
    <span class="token key atrule">privateCertPath</span><span class="token punctuation">:</span> classpath<span class="token punctuation">:</span>cert/apiclient_cert.pem <span class="token comment">#apiclient_cert.pem证书文件的绝对路径或者以classpath:开头的类路径</span>
    <span class="token key atrule">notifyUrl</span><span class="token punctuation">:</span> https<span class="token punctuation">:</span>//35fxxxxxpbf.guyubao.com/anonymous/wx/notify/order
</code></pre>
    <h2>
     <a id="_54">
     </a>
     三、小程序微信登录
    </h2>
    <h3>
     <a id="1_55">
     </a>
     1.登录流程时序
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3d6d1855ddec49e518b0a134f2fe9844.jpeg"/>
    </p>
    <h3>
     <a id="2openidunionidcode_57">
     </a>
     2.认识openid、unionid和code
    </h3>
    <p>
     <strong>
      1.openid
     </strong>
    </p>
    <blockquote>
     <p>
      openid是用来唯一标识用户的一个字符串。在微信小程序中，每个用户的openid都是唯一的。通过openid，小程序可以获取用户的基本信息，如头像、昵称等。
     </p>
    </blockquote>
    <p>
     <strong>
      注意：同一个用户在不同的小程序中拥有不同的openid。因此，在开发小程序时，不能使用openid来进行用户的唯一性判断。
     </strong>
    </p>
    <p>
     <strong>
      2.unionid
     </strong>
    </p>
    <blockquote>
     <p>
      unionid是在用户绑定同一微信开放平台账号下的多个应用时，用来唯一标识用户的一个字符串。如果用户在多个小程序中使用同一个微信号进行登录授权，那么这些小程序中的unionid都是相同的。
     </p>
    </blockquote>
    <p>
     <strong>
      注意：用户的unionid只有在用户将多个应用绑定到同一个微信开放平台账号下时才会生成。因此，如果用户没有绑定多个应用，那么小程序将无法获取用户的unionid。
     </strong>
    </p>
    <p>
     <strong>
      3. code
     </strong>
    </p>
    <blockquote>
     <p>
      code是用户登录凭证，由微信服务器颁发给小程序。在用户授权登录后，小程序可以通过调用微信登录接口获取用户的code。然后，通过code向微信服务器请求用户的openid和session_key等信息。
     </p>
    </blockquote>
    <p>
     <strong>
      注意：每个code只能使用一次，且有效期为5分钟。因此，在使用code进行登录时，需要及时将其转换成用户的openid和session_key等信息，以免出现code过期的情况
     </strong>
    </p>
    <h3>
     <a id="3_76">
     </a>
     3.代码实现
    </h3>
    <p>
     1.在config目录下新增文件WxMaProperties
    </p>
    <pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ruoyi<span class="token punctuation">.</span>xyhj<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author &lt;a href="https://github.com/binarywang"&gt;Binary Wang&lt;/a&gt;
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"wx.miniapp"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxMaProperties</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Config</span><span class="token punctuation">&gt;</span></span> configs<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Data</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Config</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/**
         * 设置微信小程序的appid
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> appid<span class="token punctuation">;</span>

        <span class="token comment">/**
         * 设置微信小程序的Secret
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> secret<span class="token punctuation">;</span>

        <span class="token comment">/**
         * 设置微信小程序消息服务器配置的token
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> token<span class="token punctuation">;</span>

        <span class="token comment">/**
         * 设置微信小程序消息服务器配置的EncodingAESKey
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> aesKey<span class="token punctuation">;</span>

        <span class="token comment">/**
         * 消息格式，XML或者JSON
         */</span>
        <span class="token keyword">private</span> <span class="token class-name">String</span> msgDataFormat<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre>
    <p>
     2.注入wxMaService
    </p>
    <pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ruoyi<span class="token punctuation">.</span>xyhj<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>binarywang<span class="token punctuation">.</span>wx<span class="token punctuation">.</span>miniapp<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">WxMaService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>binarywang<span class="token punctuation">.</span>wx<span class="token punctuation">.</span>miniapp<span class="token punctuation">.</span>api<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">WxMaServiceImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>binarywang<span class="token punctuation">.</span>wx<span class="token punctuation">.</span>miniapp<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span><span class="token class-name">WxMaKefuMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>binarywang<span class="token punctuation">.</span>wx<span class="token punctuation">.</span>miniapp<span class="token punctuation">.</span>bean<span class="token punctuation">.</span></span><span class="token class-name">WxMaSubscribeMessage</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>binarywang<span class="token punctuation">.</span>wx<span class="token punctuation">.</span>miniapp<span class="token punctuation">.</span>config<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">WxMaDefaultConfigImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>binarywang<span class="token punctuation">.</span>wx<span class="token punctuation">.</span>miniapp<span class="token punctuation">.</span>message<span class="token punctuation">.</span></span><span class="token class-name">WxMaMessageHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">cn<span class="token punctuation">.</span>binarywang<span class="token punctuation">.</span>wx<span class="token punctuation">.</span>miniapp<span class="token punctuation">.</span>message<span class="token punctuation">.</span></span><span class="token class-name">WxMaMessageRouter</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>google<span class="token punctuation">.</span>common<span class="token punctuation">.</span>collect<span class="token punctuation">.</span></span><span class="token class-name">Lists</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">me<span class="token punctuation">.</span>chanjar<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>common<span class="token punctuation">.</span>bean<span class="token punctuation">.</span>result<span class="token punctuation">.</span></span><span class="token class-name">WxMediaUploadResult</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">me<span class="token punctuation">.</span>chanjar<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>common<span class="token punctuation">.</span>error<span class="token punctuation">.</span></span><span class="token class-name">WxErrorException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">me<span class="token punctuation">.</span>chanjar<span class="token punctuation">.</span>weixin<span class="token punctuation">.</span>common<span class="token punctuation">.</span>error<span class="token punctuation">.</span></span><span class="token class-name">WxRuntimeException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">EnableConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author &lt;a href="https://github.com/binarywang"&gt;Binary Wang&lt;/a&gt;
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">WxMaProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxMaConfiguration</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">WxMaProperties</span> properties<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token class-name">WxMaConfiguration</span><span class="token punctuation">(</span><span class="token class-name">WxMaProperties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>properties <span class="token operator">=</span> properties<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"wxMaService"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">WxMaService</span> <span class="token function">wxMaService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">WxMaProperties<span class="token punctuation">.</span>Config</span><span class="token punctuation">&gt;</span></span> configs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getConfigs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>configs <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WxRuntimeException</span><span class="token punctuation">(</span><span class="token string">"大哥，拜托先看下项目首页的说明（readme文件），添加下相关配置，注意别配错了！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">WxMaService</span> maService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxMaServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        maService<span class="token punctuation">.</span><span class="token function">setMultiConfigs</span><span class="token punctuation">(</span>
            configs<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>a <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">WxMaDefaultConfigImpl</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxMaDefaultConfigImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//                WxMaDefaultConfigImpl config = new WxMaRedisConfigImpl(new JedisPool());</span>
                    <span class="token comment">// 使用上面的配置时，需要同时引入jedis-lock的依赖，否则会报类无法找到的异常</span>
                    config<span class="token punctuation">.</span><span class="token function">setAppid</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getAppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    config<span class="token punctuation">.</span><span class="token function">setSecret</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getSecret</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    config<span class="token punctuation">.</span><span class="token function">setToken</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    config<span class="token punctuation">.</span><span class="token function">setAesKey</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getAesKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    config<span class="token punctuation">.</span><span class="token function">setMsgDataFormat</span><span class="token punctuation">(</span>a<span class="token punctuation">.</span><span class="token function">getMsgDataFormat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> config<span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">WxMaDefaultConfigImpl</span><span class="token operator">::</span><span class="token function">getAppid</span><span class="token punctuation">,</span> a <span class="token operator">-&gt;</span> a<span class="token punctuation">,</span> <span class="token punctuation">(</span>o<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> o<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> maService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">WxMaMessageRouter</span> <span class="token function">wxMaMessageRouter</span><span class="token punctuation">(</span><span class="token class-name">WxMaService</span> wxMaService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">WxMaMessageRouter</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxMaMessageRouter</span><span class="token punctuation">(</span>wxMaService<span class="token punctuation">)</span><span class="token punctuation">;</span>
        router
            <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>logHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token string">"订阅消息"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>subscribeMsgHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token string">"文本"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>textHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token string">"图片"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>picHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">rule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">async</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token string">"二维码"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>qrcodeHandler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> router<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">WxMaMessageHandler</span> subscribeMsgHandler <span class="token operator">=</span> <span class="token punctuation">(</span>wxMessage<span class="token punctuation">,</span> context<span class="token punctuation">,</span> service<span class="token punctuation">,</span> sessionManager<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        service<span class="token punctuation">.</span><span class="token function">getMsgService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendSubscribeMsg</span><span class="token punctuation">(</span><span class="token class-name">WxMaSubscribeMessage</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">templateId</span><span class="token punctuation">(</span><span class="token string">"此处更换为自己的模板id"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token class-name">Lists</span><span class="token punctuation">.</span><span class="token function">newArrayList</span><span class="token punctuation">(</span>
                <span class="token keyword">new</span> <span class="token class-name">WxMaSubscribeMessage<span class="token punctuation">.</span>MsgData</span><span class="token punctuation">(</span><span class="token string">"keyword1"</span><span class="token punctuation">,</span> <span class="token string">"339208499"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">toUser</span><span class="token punctuation">(</span>wxMessage<span class="token punctuation">.</span><span class="token function">getFromUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">WxMaMessageHandler</span> logHandler <span class="token operator">=</span> <span class="token punctuation">(</span>wxMessage<span class="token punctuation">,</span> context<span class="token punctuation">,</span> service<span class="token punctuation">,</span> sessionManager<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"收到消息："</span> <span class="token operator">+</span> wxMessage<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        service<span class="token punctuation">.</span><span class="token function">getMsgService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendKefuMsg</span><span class="token punctuation">(</span><span class="token class-name">WxMaKefuMessage</span><span class="token punctuation">.</span><span class="token function">newTextBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token string">"收到信息为："</span> <span class="token operator">+</span> wxMessage<span class="token punctuation">.</span><span class="token function">toJson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">toUser</span><span class="token punctuation">(</span>wxMessage<span class="token punctuation">.</span><span class="token function">getFromUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">WxMaMessageHandler</span> textHandler <span class="token operator">=</span> <span class="token punctuation">(</span>wxMessage<span class="token punctuation">,</span> context<span class="token punctuation">,</span> service<span class="token punctuation">,</span> sessionManager<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        service<span class="token punctuation">.</span><span class="token function">getMsgService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendKefuMsg</span><span class="token punctuation">(</span><span class="token class-name">WxMaKefuMessage</span><span class="token punctuation">.</span><span class="token function">newTextBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">content</span><span class="token punctuation">(</span><span class="token string">"回复文本消息"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">toUser</span><span class="token punctuation">(</span>wxMessage<span class="token punctuation">.</span><span class="token function">getFromUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">WxMaMessageHandler</span> picHandler <span class="token operator">=</span> <span class="token punctuation">(</span>wxMessage<span class="token punctuation">,</span> context<span class="token punctuation">,</span> service<span class="token punctuation">,</span> sessionManager<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">WxMediaUploadResult</span> uploadResult <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getMediaService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">uploadMedia</span><span class="token punctuation">(</span><span class="token string">"image"</span><span class="token punctuation">,</span> <span class="token string">"png"</span><span class="token punctuation">,</span>
                    <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemResourceAsStream</span><span class="token punctuation">(</span><span class="token string">"tmp.png"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span><span class="token function">getMsgService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendKefuMsg</span><span class="token punctuation">(</span>
                <span class="token class-name">WxMaKefuMessage</span>
                    <span class="token punctuation">.</span><span class="token function">newImageBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">mediaId</span><span class="token punctuation">(</span>uploadResult<span class="token punctuation">.</span><span class="token function">getMediaId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">toUser</span><span class="token punctuation">(</span>wxMessage<span class="token punctuation">.</span><span class="token function">getFromUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">WxErrorException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">WxMaMessageHandler</span> qrcodeHandler <span class="token operator">=</span> <span class="token punctuation">(</span>wxMessage<span class="token punctuation">,</span> context<span class="token punctuation">,</span> service<span class="token punctuation">,</span> sessionManager<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">final</span> <span class="token class-name">File</span> file <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getQrcodeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">createQrcode</span><span class="token punctuation">(</span><span class="token string">"123"</span><span class="token punctuation">,</span> <span class="token number">430</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">WxMediaUploadResult</span> uploadResult <span class="token operator">=</span> service<span class="token punctuation">.</span><span class="token function">getMediaService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">uploadMedia</span><span class="token punctuation">(</span><span class="token string">"image"</span><span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
            service<span class="token punctuation">.</span><span class="token function">getMsgService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendKefuMsg</span><span class="token punctuation">(</span>
                <span class="token class-name">WxMaKefuMessage</span>
                    <span class="token punctuation">.</span><span class="token function">newImageBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">mediaId</span><span class="token punctuation">(</span>uploadResult<span class="token punctuation">.</span><span class="token function">getMediaId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">toUser</span><span class="token punctuation">(</span>wxMessage<span class="token punctuation">.</span><span class="token function">getFromUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">WxErrorException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre>
    <p>
     3.调用
    </p>
    <pre><code class="prism language-java">	<span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span> <span class="token class-name">WxMaService</span> wxMaService<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">wxLoginOrRegister</span><span class="token punctuation">(</span><span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">"empty jscode"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//根据code获取openid</span>
            <span class="token class-name">WxMaJscode2SessionResult</span> session <span class="token operator">=</span> wxMaService<span class="token punctuation">.</span><span class="token function">getUserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSessionInfo</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">WxErrorException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">WxLoginException</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">WxMaConfigHolder</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清理ThreadLocal</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     更多请参考官方示例：
     <a href="https://github.com/binarywang/weixin-java-miniapp-demo">
      https://github.com/binarywang/weixin-java-miniapp-demo
     </a>
     或javadoc
    </p>
    <h2>
     <a id="_284">
     </a>
     四、小程序手机号快速验证
    </h2>
    <h3>
     <a id="1_285">
     </a>
     1.小程序端
    </h3>
    <p>
     <a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html" rel="nofollow">
      手机号快速验证组件
     </a>
    </p>
    <pre><code class="prism language-bash"><span class="token operator">&lt;</span>button open-type<span class="token operator">=</span><span class="token string">"getPhoneNumber"</span> <span class="token assign-left variable">bindgetphonenumber</span><span class="token operator">=</span><span class="token string">"getPhoneNumber"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>/button<span class="token operator">&gt;</span>

Page<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  getPhoneNumber <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console.log<span class="token punctuation">(</span>e.detail.code<span class="token punctuation">)</span>  // 动态令牌
    console.log<span class="token punctuation">(</span>e.detail.errMsg<span class="token punctuation">)</span> // 回调信息（成功失败都会返回）
    console.log<span class="token punctuation">(</span>e.detail.errno<span class="token punctuation">)</span>  // 错误码（失败时返回）
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     返回参数说明
    </p>
    <table>
     <thead>
      <tr>
       <th>
        参数
       </th>
       <th>
        类型
       </th>
       <th>
        说明
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        code
       </td>
       <td>
        String
       </td>
       <td>
        动态令牌。可通过动态令牌换取用户手机号。使用方法详情
        <a href="https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/phonenumber/phonenumber.getPhoneNumber.html" rel="nofollow">
         phonenumber.getPhoneNumber
        </a>
        接口
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="2Java_304">
     </a>
     2.Java端
    </h3>
    <p>
     WxMaPhoneNumberInfo 返回值说明
     <br/>
     <a href="https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/user-info/phone-number/getPhoneNumber.html" rel="nofollow">
      手机号验证官网
     </a>
    </p>
    <table>
     <thead>
      <tr>
       <th>
        属性
       </th>
       <th>
        类型
       </th>
       <th>
        说明
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        phoneNumber
       </td>
       <td>
        string
       </td>
       <td>
        用户绑定的手机号（国外手机号会有区号）
       </td>
      </tr>
      <tr>
       <td>
        purePhoneNumber
       </td>
       <td>
        string
       </td>
       <td>
        没有区号的手机号
       </td>
      </tr>
      <tr>
       <td>
        countryCode
       </td>
       <td>
        string
       </td>
       <td>
        区号
       </td>
      </tr>
     </tbody>
    </table>
    <pre><code class="prism language-bash">    public WxMaPhoneNumberInfo wxGetPhoneNumber<span class="token punctuation">(</span>String code<span class="token punctuation">)</span> throws WxErrorException <span class="token punctuation">{<!-- --></span>
        WxMaPhoneNumberInfo phoneNumberInfo <span class="token operator">=</span> wxMaService.getUserService<span class="token punctuation">(</span><span class="token punctuation">)</span>.getPhoneNoInfo<span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin class-name">return</span> phoneNumberInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="_319">
     </a>
     五、获取小程序二维码
    </h2>
    <blockquote>
     <p>
      注意page参数前不需要加/,例/pages/index/index这是错误的
      <br/>
      <a href="https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/qrcode-link/qr-code/getUnlimitedQRCode.html" rel="nofollow">
       获取不限制的小程序码
      </a>
      https://developers.weixin.qq.com/miniprogram/dev/OpenApiDoc/qrcode-link/qr-code/getUnlimitedQRCode.html)
      <br/>
      调用示例：
      <code>
       { "page": "pages/index/index", "scene": "a=1", "check_path": true, "env_version": "release" }
      </code>
     </p>
    </blockquote>
    <h3>
     <a id="1yml_332">
     </a>
     1.配置yml文件
    </h3>
    <pre><code class="prism language-bash">wx:
  qrcode:
    bindTeacherUrl: pages/user/index <span class="token comment">#绑定老师页面</span>
    bindStudentUrl: pages/user/index <span class="token comment">#绑定家长页面</span>
    envVersion: release <span class="token comment">#要打开小程序版本</span>
    width: <span class="token number">430</span> <span class="token comment">#二维码宽度</span>
    autoColor: <span class="token boolean">true</span> <span class="token comment">#默认true 自动配置线条颜色，如果颜色依然是黑色，则说明不建议配置主色调</span>
    checkPath: <span class="token boolean">true</span> <span class="token comment">#默认true 检查 page 是否存在，为 true 时 page 必须是已经发布的小程序存在的页面（否则报错）； 为 false 时允许小程序未发布或者 page 不存在，但 page 有数量上限（60000个）请勿滥用</span>
    isHyaline: <span class="token boolean">false</span> <span class="token comment">#是否需要透明底色， is_hyaline 为true时，生成透明底色的小程序码</span>
</code></pre>
    <h3>
     <a id="2properties_345">
     </a>
     2.注入properties
    </h3>
    <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"wx.qrcode"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxQrcodeProperties</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 绑定老师url
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> bindTeacherUrl<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 绑定家长url
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> bindStudentUrl<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 要打开的小程序版本。正式版为 "release"，体验版为 "trial"，开发版为 "develop"。默认是正式版。
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> envVersion<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 二维码宽度
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> width<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 默认true 自动配置线条颜色，如果颜色依然是黑色，则说明不建议配置主色调
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> autoColor<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 默认true 检查 page 是否存在，为 true 时 page 必须是已经发布的小程序存在的页面（否则报错）； 为 false 时允许小程序未发布或者 page 不存在，但 page 有数量上限（60000个）请勿滥用
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> checkPath<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 是否需要透明底色， is_hyaline 为true时，生成透明底色的小程序码
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Boolean</span> isHyaline<span class="token punctuation">;</span>


<span class="token punctuation">}</span>

</code></pre>
    <h3>
     <a id="3WxMaConfiguration_WxMaQrcodeService_391">
     </a>
     3.修改WxMaConfiguration 注入WxMaQrcodeService
    </h3>
    <pre><code class="prism language-java">    <span class="token comment">/**
     * 注入 二维码相关操作接口.
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"wxMaQrcodeService"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">WxMaQrcodeService</span> <span class="token function">wxMaQrcodeService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">WxMaQrcodeService</span> wxMaQrcodeService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxMaQrcodeServiceImpl</span><span class="token punctuation">(</span><span class="token function">wxMaService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> wxMaQrcodeService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="4_405">
     </a>
     4.调用
    </h3>
    <pre><code class="prism language-bash">public String generateWxaCodeUnlimit<span class="token punctuation">(</span>String path, String query,String version<span class="token punctuation">)</span> throws WxErrorException <span class="token punctuation">{<!-- --></span>
        byte<span class="token punctuation">[</span><span class="token punctuation">]</span> unlimitBytes <span class="token operator">=</span> wxMaQrcodeService.createWxaCodeUnlimitBytes<span class="token punctuation">(</span>query, path, wxQrcodeProperties.getCheckPath<span class="token punctuation">(</span><span class="token punctuation">)</span>, version, wxQrcodeProperties.getWidth<span class="token punctuation">(</span><span class="token punctuation">)</span>, wxQrcodeProperties.getAutoColor<span class="token punctuation">(</span><span class="token punctuation">)</span>, <span class="token punctuation">(</span>WxMaCodeLineColor<span class="token punctuation">)</span>null, wxQrcodeProperties.getIsHyaline<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token builtin class-name">return</span> Base64.getEncoder<span class="token punctuation">(</span><span class="token punctuation">)</span>.encodeToString<span class="token punctuation">(</span>unlimitBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="_413">
     </a>
     六、小程序微信支付
    </h2>
    <h3>
     <a id="1_414">
     </a>
     1.业务流程图
    </h3>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/93a37a379a72cb75022a96dc6cb91143.bmp"/>
    </p>
    <h3>
     <a id="2_416">
     </a>
     2.签名、私钥、证书、敏感信息加解密说明
    </h3>
    <p>
     1.签名格式
     <br/>
     我们希望商户的技术开发人员按照当前文档约定的规则构造签名串。微信支付会使用同样的方式构造签名串。如果商户构造签名串的方式错误，将导致签名验证不通过。下面先说明签名串的具体格式。
    </p>
    <p>
     签名串一共有五行，每一行为一个参数。结尾以\n（换行符，ASCII编码值为0x0A）结束，包括最后一行。如果参数本身以\n结束，也需要附加一个\n。
    </p>
    <pre><code class="prism language-bash">HTTP请求方法<span class="token punctuation">\</span>n
URL<span class="token punctuation">\</span>n
请求时间戳<span class="token punctuation">\</span>n
请求随机串<span class="token punctuation">\</span>n
请求报文主体<span class="token punctuation">\</span>n
</code></pre>
    <p>
     文档地址：
     <br/>
     <a href="https://pay.weixin.qq.com/docs/merchant/development/interface-rules/signature-generation.html" rel="nofollow">
      https://pay.weixin.qq.com/docs/merchant/development/interface-rules/signature-generation.html
     </a>
    </p>
    <p>
     2.私钥
     <br/>
     商户申请商户 API 证书时，证书工具会生成商户私钥，并保存在本地证书文件夹的文件 apiclient_key.pem 中。私钥也可通过工具从商户的 p12 证书中导出。请妥善保管好商户私钥文件。
     <br/>
     文档地址：
     <br/>
     <a href="https://pay.weixin.qq.com/docs/merchant/development/interface-rules/privatekey-and-certificate.html" rel="nofollow">
      https://pay.weixin.qq.com/docs/merchant/development/interface-rules/privatekey-and-certificate.html
     </a>
    </p>
    <p>
     3.证书
     <br/>
     商户API证书是指由商户申请的，包含商户的商户号、公司名称、公钥信息的证书。
    </p>
    <p>
     微信支付 APIv3 使用由 证书授权机构（Certificate Authority，简称CA）签发的证书。商户可以自行生成证书请求串，也可以下载微信支付证书工具生成证书请求串。提交证书请求串至商户平台后，即可获得商户 API 证书文件。请注意安全保存私钥文件。
    </p>
    <blockquote>
     <p>
      每个微信支付平台证书的有效期为5年。在证书过期之前，微信支付将逐步使用新的平台证书生成签名。为了避免缺少对应证书而验签失败，商户系统需支持多个微信支付平台证书，定期通过接口下载新证书并部署至服务器。请参阅我们的 证书更新指引 ，避免依赖人工更新证书，保证业务的连续运转。
     </p>
    </blockquote>
    <p>
     文档地址：
     <br/>
     <a href="https://pay.weixin.qq.com/docs/merchant/development/interface-rules/privatekey-and-certificate.html" rel="nofollow">
      https://pay.weixin.qq.com/docs/merchant/development/interface-rules/privatekey-and-certificate.html
     </a>
    </p>
    <p>
     4.加解密
     <br/>
     为了保证通信过程中敏感信息字段（如用户的住址、银行卡号、手机号码等）的机密性，微信支付API v3要求商户对上送的敏感信息字段进行加密。与之相对应，微信支付会对下行的敏感信息字段进行加密，商户需解密后方能得到原文。下面详细介绍加解密的方式，以及如何进行相应的计算。
    </p>
    <p>
     文档地址：
     <br/>
     <a href="https://pay.weixin.qq.com/docs/merchant/development/interface-rules/sensitive-data-encryption.html" rel="nofollow">
      https://pay.weixin.qq.com/docs/merchant/development/interface-rules/sensitive-data-encryption.html
     </a>
    </p>
    <h3>
     <a id="3_452">
     </a>
     3.代码实现
    </h3>
    <p>
     1.在config目录下新增文件WxPayProperties
    </p>
    <pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ruoyi<span class="token punctuation">.</span>xyhj<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * wxpay pay properties.
 *
 * @author Binary Wang
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">"wx.pay"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxPayProperties</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/**
   * 设置微信公众号或者小程序等的appid
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> appId<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 微信支付商户号
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> mchId<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 微信支付商户V3密钥
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> apiV3Key<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 证书号
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> certSerialNo<span class="token punctuation">;</span>

  <span class="token comment">/**
   * apiclient_key.pem证书文件的绝对路径或者以classpath:开头的类路径
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> privateKeyPath<span class="token punctuation">;</span>

  <span class="token comment">/**
   * apiclient_cert.pem证书文件的绝对路径或者以classpath:开头的类路径
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> privateCertPath<span class="token punctuation">;</span>

  <span class="token comment">/**
   * 回调地址
   */</span>
  <span class="token keyword">private</span> <span class="token class-name">String</span> notifyUrl<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre>
    <p>
     2.注入WxPayService
    </p>
    <pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ruoyi<span class="token punctuation">.</span>xyhj<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>binarywang<span class="token punctuation">.</span>wxpay<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">WxPayConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>binarywang<span class="token punctuation">.</span>wxpay<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">WxPayService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>binarywang<span class="token punctuation">.</span>wxpay<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">WxPayServiceImpl</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>lang3<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>condition<span class="token punctuation">.</span></span><span class="token class-name">ConditionalOnClass</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span>condition<span class="token punctuation">.</span></span><span class="token class-name">ConditionalOnMissingBean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">EnableConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author Binary Wang
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@ConditionalOnClass</span><span class="token punctuation">(</span><span class="token class-name">WxPayService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">WxPayProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxPayConfiguration</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token class-name">WxPayProperties</span> properties<span class="token punctuation">;</span>

  <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span><span class="token string">"wxPayService"</span><span class="token punctuation">)</span>
  <span class="token annotation punctuation">@ConditionalOnMissingBean</span>
  <span class="token keyword">public</span> <span class="token class-name">WxPayService</span> <span class="token function">wxService</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">WxPayConfig</span> payConfig <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxPayConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payConfig<span class="token punctuation">.</span><span class="token function">setAppId</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">trimToNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payConfig<span class="token punctuation">.</span><span class="token function">setMchId</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">trimToNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getMchId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payConfig<span class="token punctuation">.</span><span class="token function">setApiV3Key</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">trimToNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getApiV3Key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payConfig<span class="token punctuation">.</span><span class="token function">setCertSerialNo</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">trimToNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getCertSerialNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payConfig<span class="token punctuation">.</span><span class="token function">setPrivateKeyPath</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">trimToNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getPrivateKeyPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payConfig<span class="token punctuation">.</span><span class="token function">setPrivateCertPath</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">trimToNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getPrivateCertPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payConfig<span class="token punctuation">.</span><span class="token function">setNotifyUrl</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">trimToNull</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>properties<span class="token punctuation">.</span><span class="token function">getNotifyUrl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payConfig<span class="token punctuation">.</span><span class="token function">setTradeType</span><span class="token punctuation">(</span><span class="token string">"JSAPI"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    payConfig<span class="token punctuation">.</span><span class="token function">setSignType</span><span class="token punctuation">(</span><span class="token string">"MD5"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">WxPayService</span> wxPayService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxPayServiceImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    wxPayService<span class="token punctuation">.</span><span class="token function">setConfig</span><span class="token punctuation">(</span>payConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> wxPayService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

</code></pre>
    <p>
     3.创建预支付订单
    </p>
    <p>
     注意我们使用的是v3版本所以创建对象或者调用wxpayService时需要调用v3版本的不然参数可能对不上
    </p>
    <pre><code class="prism language-java"><span class="token comment">/**
* 创建预支付订单
*/</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token class-name">WxUnifiedOrderVo</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">PatriarchCreateOrderBo</span> bo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">WxPayException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">SignatureException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span> <span class="token punctuation">{<!-- --></span>
  
        <span class="token comment">//构建预支付订单对象</span>
        <span class="token class-name">WxPayUnifiedOrderV3Request</span> orderV3Request <span class="token operator">=</span> <span class="token function">buildWxPayUnifiedOrderRequest</span><span class="token punctuation">(</span>order<span class="token punctuation">,</span> parentUser<span class="token punctuation">.</span><span class="token function">getOpenid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> product<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WxPayUnifiedOrderV3Result</span> wxPayUnifiedOrderV3Result <span class="token operator">=</span> wxPayService<span class="token punctuation">.</span><span class="token function">unifiedOrderV3</span><span class="token punctuation">(</span><span class="token class-name">TradeTypeEnum</span><span class="token punctuation">.</span><span class="token constant">JSAPI</span><span class="token punctuation">,</span> orderV3Request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//构建返回参数</span>
        <span class="token class-name">WxUnifiedOrderVo</span> tokenJSAPI <span class="token operator">=</span> <span class="token class-name">WechatSignUtil</span><span class="token punctuation">.</span><span class="token function">getTokenJSAPI</span><span class="token punctuation">(</span>wxPayProperties<span class="token punctuation">.</span><span class="token function">getAppId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wxPayUnifiedOrderV3Result<span class="token punctuation">.</span><span class="token function">getPrepayId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wxPayProperties<span class="token punctuation">.</span><span class="token function">getPrivateKeyPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> tokenJSAPI<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token comment">/**
     * 构建统一下单对象
     * @param order 订单对象
     * @param openId user openId
     * @param productName 产品名
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">WxPayUnifiedOrderV3Request</span> <span class="token function">buildWxPayUnifiedOrderRequest</span><span class="token punctuation">(</span><span class="token class-name">TelOrder</span> order<span class="token punctuation">,</span> <span class="token class-name">String</span> openId<span class="token punctuation">,</span><span class="token class-name">String</span> productName<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">WxPayUnifiedOrderV3Request</span> orderRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxPayUnifiedOrderV3Request</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置订单号</span>
        orderRequest<span class="token punctuation">.</span><span class="token function">setOutTradeNo</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置交易结束时间为24小时</span>
        orderRequest<span class="token punctuation">.</span><span class="token function">setTimeExpire</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">"yyyy-MM-dd'T'HH:mm:ssXXX"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置订单金额</span>
        orderRequest<span class="token punctuation">.</span><span class="token function">setAmount</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WxPayUnifiedOrderV3Request<span class="token punctuation">.</span>Amount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">setTotal</span><span class="token punctuation">(</span><span class="token class-name">BaseWxPayRequest</span><span class="token punctuation">.</span><span class="token function">yuanToFen</span><span class="token punctuation">(</span>order<span class="token punctuation">.</span><span class="token function">getAmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置支付者信息</span>
        orderRequest<span class="token punctuation">.</span><span class="token function">setPayer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WxPayUnifiedOrderV3Request<span class="token punctuation">.</span>Payer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setOpenid</span><span class="token punctuation">(</span>openId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//设置商品描述</span>
        orderRequest<span class="token punctuation">.</span><span class="token function">setDescription</span><span class="token punctuation">(</span>productName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderRequest<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     4.签名工具类
    </p>
    <pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ruoyi<span class="token punctuation">.</span>xyhj<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ruoyi<span class="token punctuation">.</span>xyhj<span class="token punctuation">.</span>domain<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">WxUnifiedOrderVo</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">InvalidKeySpecException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">PKCS8EncodedKeySpec</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WechatSignUtil</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/**
     * 参考网站 https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_5_4.shtml
     * 计算签名值
     *
     * @param appId
     * @param prepay_id
     * @return
     * @throws IOException
     * @throws SignatureException
     * @throws NoSuchAlgorithmException
     * @throws InvalidKeyException
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">WxUnifiedOrderVo</span> <span class="token function">getTokenJSAPI</span><span class="token punctuation">(</span><span class="token class-name">String</span> appId<span class="token punctuation">,</span> <span class="token class-name">String</span> prepay_id<span class="token punctuation">,</span> <span class="token class-name">String</span> privateKey<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">SignatureException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取随机字符串</span>
        <span class="token class-name">String</span> nonceStr <span class="token operator">=</span> <span class="token function">getNonceStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取微信小程序支付package</span>
        <span class="token class-name">String</span> packagestr <span class="token operator">=</span> <span class="token string">"prepay_id="</span> <span class="token operator">+</span> prepay_id<span class="token punctuation">;</span>
        <span class="token keyword">long</span> timestamp <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token comment">//签名，使用字段appId、timeStamp、nonceStr、package计算得出的签名值</span>
        <span class="token class-name">String</span> message <span class="token operator">=</span> <span class="token function">buildMessageTwo</span><span class="token punctuation">(</span>appId<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> nonceStr<span class="token punctuation">,</span> packagestr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//获取对应的签名</span>
        <span class="token class-name">String</span> signature <span class="token operator">=</span> <span class="token function">sign</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 组装返回</span>
        <span class="token class-name">WxUnifiedOrderVo</span> vo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WxUnifiedOrderVo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vo<span class="token punctuation">.</span><span class="token function">setAppId</span><span class="token punctuation">(</span>appId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        vo<span class="token punctuation">.</span><span class="token function">setTimeStamp</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vo<span class="token punctuation">.</span><span class="token function">setNonceStr</span><span class="token punctuation">(</span>nonceStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        vo<span class="token punctuation">.</span><span class="token function">setPackageStr</span><span class="token punctuation">(</span>packagestr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        vo<span class="token punctuation">.</span><span class="token function">setSignType</span><span class="token punctuation">(</span><span class="token string">"RSA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        vo<span class="token punctuation">.</span><span class="token function">setPaySign</span><span class="token punctuation">(</span>signature<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> vo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 生成随机数
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getNonceStr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 拼接参数
     *
     * @return
     */</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">buildMessageTwo</span><span class="token punctuation">(</span><span class="token class-name">String</span> appId<span class="token punctuation">,</span> <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">String</span> nonceStr<span class="token punctuation">,</span> <span class="token class-name">String</span> packag<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> appId <span class="token operator">+</span> <span class="token string">"\n"</span>
                <span class="token operator">+</span> timestamp <span class="token operator">+</span> <span class="token string">"\n"</span>
                <span class="token operator">+</span> nonceStr <span class="token operator">+</span> <span class="token string">"\n"</span>
                <span class="token operator">+</span> packag <span class="token operator">+</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 生成签名
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">sign</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> message<span class="token punctuation">,</span><span class="token class-name">String</span> privateKey<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">SignatureException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Signature</span> sign <span class="token operator">=</span> <span class="token class-name">Signature</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"SHA256withRSA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//SHA256withRSA</span>
        sign<span class="token punctuation">.</span><span class="token function">initSign</span><span class="token punctuation">(</span><span class="token function">getPrivateKey</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sign<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encodeToString</span><span class="token punctuation">(</span>sign<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 获取私钥
     * @param filename 私钥文件路径  (required)
     * @return 私钥对象
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PrivateKey</span> <span class="token function">getPrivateKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> filename<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"filename:"</span> <span class="token operator">+</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        filename <span class="token operator">=</span> filename<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"classpath:"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">WechatSignUtil</span> wechatSignUtil <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WechatSignUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InputStream</span> resourceAsStream <span class="token operator">=</span> wechatSignUtil<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>resourceAsStream<span class="token punctuation">.</span><span class="token function">available</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        resourceAsStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        String content = new String(Files.readAllBytes(Paths.get(resource.getPath())), "utf-8");</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> privateKey <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"-----BEGIN PRIVATE KEY-----"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"-----END PRIVATE KEY-----"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"\\s+"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">KeyFactory</span> kf <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token string">"RSA"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> kf<span class="token punctuation">.</span><span class="token function">generatePrivate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PKCS8EncodedKeySpec</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">getDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchAlgorithmException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"当前Java环境不支持RSA"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InvalidKeySpecException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"无效的密钥格式"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     5.回调接口
    </p>
    <pre><code class="prism language-java"> <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"支付回调通知处理"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/wx/notify/order"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">parseOrderNotifyResult</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">String</span> resultData<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">WxPayException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">WxPayOrderNotifyV3Result</span> notifyV3Result <span class="token operator">=</span> wxPayService<span class="token punctuation">.</span><span class="token function">parseOrderNotifyV3Result</span><span class="token punctuation">(</span>resultData<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"回调：{}"</span><span class="token punctuation">,</span>notifyV3Result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderService<span class="token punctuation">.</span><span class="token function">wxNotify</span><span class="token punctuation">(</span>notifyV3Result<span class="token punctuation">.</span><span class="token function">getResult</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34333534383539302f:61727469636c652f64657461696c732f313332383337313034" class_="artid" style="display:none">
 </p>
</div>


