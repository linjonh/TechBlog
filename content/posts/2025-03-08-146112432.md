---
layout: post
title: "GoTeams-5引入Docker"
date: 2025-03-08 14:45:19 +0800
description: "一直对docker的实战有点少，并且随着hub被封之后，也有点惧怕用docker这些，比如写docker-compose进行容器编排，写dockerfile文件编译镜像，编译go程序为可执行文件等，通过本次实战，熟悉了不少，也对整个部署运营有了了解，实战大于学习，之前看过再多的知识，不如自己实战效果更好一些，学习和收获会更大。勇于挑战才能进步。"
keywords: "【GoTeams】-5：引入Docker"
categories: ['Goteams']
tags: ['Dockerfile', 'Docker', 'Compose']
artid: "146112432"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146112432
    alt: "GoTeams-5引入Docker"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146112432
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146112432
cover: https://bing.ee123.net/img/rand?artid=146112432
image: https://bing.ee123.net/img/rand?artid=146112432
img: https://bing.ee123.net/img/rand?artid=146112432
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【GoTeams】-5：引入Docker
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a2d8d61533ac4583b392adaa1a6548b7.png"/>
    </p>
    <p>
    </p>
    <p>
    </p>
    <h2>
     <a id="1_Dokcercompose_6">
     </a>
     1. Dokcer-compose
    </h2>
    <p>
     这里简单先用一下win版本的Docker，后期开发好了部署的时候再移植到服务器下进行docker部署。
    </p>
    <p>
     输入命令
     <code>
      docker-compose version
     </code>
     就可以看到已经装好的docker版本了，顺便装一个dockerdesktop。
    </p>
    <h3>
     <a id="Docker_12">
     </a>
     回顾下Docker知识
    </h3>
    <p>
     Docker 是一个开源的
     <strong>
      应用容器引擎
     </strong>
     ，它通过容器技术来实现轻量级的虚拟化。容器允许开发者将
     <strong>
      应用及其所有依赖包
     </strong>
     打包到一个可移植的容器中，以便在任何环境中一致地运行。
    </p>
    <p>
     Docker Compose 是 Docker 官方提供的一个工具，用于定义和运行多容器的 Docker 应用。通过
     <code>
      Compose
     </code>
     ，用户可以使用 YAML 文件来定义多个 Docker 容器的服务、网络、存储卷等配置，并通过一个命令（
     <code>
      docker-compose up
     </code>
     ）启动所有定义好的服务。
    </p>
    <p>
     Dockerfile 是用来构建 Docker 镜像的文件，包含创建镜像的步骤和指令，可以与 Docker Compose 配合使用，在 Compose 中定义服务时使用自定义的 Docker 镜像。
    </p>
    <h3>
     <a id="dockercomposeyaml_21">
     </a>
     编写docker-compose.yaml
    </h3>
    <p>
     目前需要部署Mysql、Redis、Etcd、User、Api服务，所以需要编写一下Docker方便以后启动。
    </p>
    <p>
     创建一个
     <code>
      docker-compose.yaml
     </code>
     文件，然后进行容器编排。
    </p>
    <pre><code class="prism language-go">version<span class="token punctuation">:</span> <span class="token char">'3'</span>
services<span class="token punctuation">:</span>
  mysql<span class="token punctuation">:</span>
    container_name<span class="token punctuation">:</span> mysql8
    image<span class="token punctuation">:</span> mysql<span class="token punctuation">:</span>$<span class="token punctuation">{<!-- --></span>MYSQL_VERSION<span class="token punctuation">}</span>
    restart<span class="token punctuation">:</span> always
    ports<span class="token punctuation">:</span>
      <span class="token operator">-</span> <span class="token number">3309</span><span class="token punctuation">:</span><span class="token number">3306</span>
    environment<span class="token punctuation">:</span>
      TZ<span class="token punctuation">:</span> Asia<span class="token operator">/</span>Shanghai
      MYSQL_ROOT_PASSWORD<span class="token punctuation">:</span> root
      MYSQL_DATABASE<span class="token punctuation">:</span> msproject
    volumes<span class="token punctuation">:</span>
      <span class="token operator">-</span> $<span class="token punctuation">{<!-- --></span>MYSQL_DIR<span class="token punctuation">}</span><span class="token operator">/</span>data<span class="token punctuation">:</span><span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib<span class="token operator">/</span>mysql
      <span class="token operator">-</span> $<span class="token punctuation">{<!-- --></span>MYSQL_DIR<span class="token punctuation">}</span><span class="token operator">/</span>conf<span class="token punctuation">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>mysql<span class="token operator">/</span>conf<span class="token punctuation">.</span>d<span class="token operator">/</span>
      <span class="token operator">-</span> $<span class="token punctuation">{<!-- --></span>MYSQL_DIR<span class="token punctuation">}</span><span class="token operator">/</span>logs<span class="token punctuation">:</span><span class="token operator">/</span>logs
    command<span class="token punctuation">:</span>
      <span class="token operator">--</span><span class="token keyword">default</span><span class="token operator">-</span>authentication<span class="token operator">-</span>plugin<span class="token operator">=</span>mysql_native_password
      <span class="token operator">--</span>character<span class="token operator">-</span>set<span class="token operator">-</span>server<span class="token operator">=</span>utf8mb4
      <span class="token operator">--</span>collation<span class="token operator">-</span>server<span class="token operator">=</span>utf8mb4_general_ci
      <span class="token operator">--</span>explicit_defaults_for_timestamp<span class="token operator">=</span><span class="token boolean">true</span>
      <span class="token operator">--</span>lower_case_table_names<span class="token operator">=</span><span class="token number">1</span>
</code></pre>
    <p>
     这里大致讲一下进行了什么操作，回顾下之前学过的docker容器。
    </p>
    <p>
     首先定义容器名称，
     <code>
      container_name: mysql8
     </code>
     ，定义了容器的名称为 mysql8，可以通过这个名称来管理MySQL容器。
    </p>
    <p>
     <code>
      image: mysql:${MYSQL_VERSION}
     </code>
     该配置使用指定版本的MySQL镜像，
     <code>
      ${MYSQL_VERSION}
     </code>
     是一个变量，表示MySQL的版本号。该变量的实际值在运行时会由环境变量提供。
    </p>
    <p>
     <code>
      3309:3306
     </code>
     将容器的3306端口（MySQL默认端口）映射到主机的3309端口。可以通过主机的3309端口访问容器中的MySQL服务。
    </p>
    <p>
     <code>
      MYSQL_DATABASE
     </code>
     : msproject 创建一个名为msproject的数据库。
    </p>
    <p>
     <code>
      ${MYSQL_DIR}/data:/var/lib/mysql
     </code>
     将主机上
     <code>
      ${MYSQL_DIR}/data
     </code>
     目录映射到容器的
     <code>
      /var/lib/mysql
     </code>
     目录，这是MySQL存储数据的位置。
    </p>
    <p>
     <code>
      ${MYSQL_DIR}/conf:/etc/mysql/conf.d/
     </code>
     将主机上
     <code>
      ${MYSQL_DIR}/conf
     </code>
     目录映射到容器的
     <code>
      /etc/mysql/conf.d/
     </code>
     ，用于配置MySQL。
    </p>
    <p>
     <code>
      ${MYSQL_DIR}/logs:/logs
     </code>
     将主机上
     <code>
      ${MYSQL_DIR}/logs
     </code>
     目录映射到容器的 /logs 目录，用于存储MySQL的日志。
    </p>
    <p>
     然后是Redis的持久化。
    </p>
    <pre><code class="prism language-go">  Redis<span class="token punctuation">:</span>
    container_name<span class="token punctuation">:</span> redis6
    image<span class="token punctuation">:</span> redis<span class="token punctuation">:</span>$<span class="token punctuation">{<!-- --></span>REDIS_VERSION<span class="token punctuation">}</span>
    restart<span class="token punctuation">:</span> always
    volumes<span class="token punctuation">:</span>
      <span class="token operator">-</span> $<span class="token punctuation">{<!-- --></span>REDIS_DIR<span class="token punctuation">}</span><span class="token operator">/</span>data<span class="token punctuation">:</span><span class="token operator">/</span>data
      <span class="token operator">-</span> $<span class="token punctuation">{<!-- --></span>REDIS_DIR<span class="token punctuation">}</span><span class="token operator">/</span>conf<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf<span class="token punctuation">:</span><span class="token operator">/</span>etc<span class="token operator">/</span>redis<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
    ports<span class="token punctuation">:</span>
      <span class="token operator">-</span> $<span class="token punctuation">{<!-- --></span>REDIS_PORT<span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token number">6379</span>
    command<span class="token punctuation">:</span> redis<span class="token operator">-</span>server <span class="token operator">/</span>etc<span class="token operator">/</span>redis<span class="token operator">/</span>redis<span class="token punctuation">.</span>conf
</code></pre>
    <p>
     Etcd持久化。
    </p>
    <pre><code class="prism language-go">  Project<span class="token operator">-</span>User<span class="token punctuation">:</span>
    container_name<span class="token punctuation">:</span> project<span class="token operator">-</span>user
    image<span class="token punctuation">:</span> project<span class="token operator">-</span>user<span class="token punctuation">:</span>latest
    ports<span class="token punctuation">:</span>
      <span class="token operator">-</span> <span class="token number">8080</span><span class="token punctuation">:</span><span class="token number">8080</span>
      <span class="token operator">-</span> <span class="token number">8881</span><span class="token punctuation">:</span><span class="token number">8881</span>
</code></pre>
    <p>
     User服务持久化。
    </p>
    <pre><code class="prism language-go">  Etcd<span class="token punctuation">:</span>
    container_name<span class="token punctuation">:</span> etcd3
    image<span class="token punctuation">:</span> bitnami<span class="token operator">/</span>etcd<span class="token punctuation">:</span>$<span class="token punctuation">{<!-- --></span>ETCD_VERSION<span class="token punctuation">}</span>
    deploy<span class="token punctuation">:</span>
      replicas<span class="token punctuation">:</span> <span class="token number">1</span>
      restart_policy<span class="token punctuation">:</span>
        condition<span class="token punctuation">:</span> on<span class="token operator">-</span>failure
    environment<span class="token punctuation">:</span>
      <span class="token operator">-</span> ALLOW_NONE_AUTHENTICATION<span class="token operator">=</span>yes
    privileged<span class="token punctuation">:</span> <span class="token boolean">true</span>
    volumes<span class="token punctuation">:</span>
      <span class="token operator">-</span> $<span class="token punctuation">{<!-- --></span>ETCD_DIR<span class="token punctuation">}</span><span class="token operator">/</span>data<span class="token punctuation">:</span><span class="token operator">/</span>bitnami<span class="token operator">/</span>etcd<span class="token operator">/</span>data
    ports<span class="token punctuation">:</span>
      <span class="token operator">-</span> $<span class="token punctuation">{<!-- --></span>ETCD_PORT<span class="token punctuation">}</span><span class="token punctuation">:</span><span class="token number">2379</span>
      <span class="token operator">-</span> <span class="token number">2380</span><span class="token punctuation">:</span><span class="token number">2380</span>
</code></pre>
    <p>
     上面我们有一些需要环境提供的参数，这里需要在
     <code>
      .env
     </code>
     环境编写。
    </p>
    <pre><code class="prism language-go">MYSQL_VERSION<span class="token operator">=</span><span class="token number">8.0</span><span class="token number">.20</span>
MYSQL_DIR<span class="token operator">=</span>D<span class="token punctuation">:</span>\GoProject\msproject<span class="token operator">-</span>data\mysql
MYSQL_PORT<span class="token operator">=</span><span class="token number">3309</span>
REDIS_VERSION<span class="token operator">=</span><span class="token number">6.2</span><span class="token number">.7</span>
REDIS_PORT<span class="token operator">=</span><span class="token number">6379</span>
REDIS_DIR<span class="token operator">=</span>D<span class="token punctuation">:</span>\GoProject\msproject<span class="token operator">-</span>data\redis
ETCD_VERSION<span class="token operator">=</span><span class="token number">3.5</span><span class="token number">.6</span>
ETCD_PORT<span class="token operator">=</span><span class="token number">2379</span>
ETCD_DIR<span class="token operator">=</span>D<span class="token punctuation">:</span>\GoProject\msproject<span class="token operator">-</span>data\etcd
</code></pre>
    <p>
     此外还需要在redis下来配置
     <code>
      .conf文件
     </code>
     ，
     <code>
      D:\GoProject\msproject-data\redis\conf
     </code>
    </p>
    <pre><code class="prism language-go"># 任意ip可访问
bind <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span>
# 自定义启动端口
port <span class="token number">6379</span>
# rdb或aof文件存储位置
dir <span class="token operator">/</span>data
save <span class="token number">900</span> <span class="token number">1</span>
save <span class="token number">300</span> <span class="token number">10</span>
save <span class="token number">60</span> <span class="token number">10000</span>
appendonly yes
appendfilename <span class="token string">"appendonly.aof"</span>
</code></pre>
    <h3>
     <a id="docker_141">
     </a>
     运行docker
    </h3>
    <p>
     我们在项目路径下直接
     <code>
      docker-compose up -d
     </code>
     ，-d的作用是后台启动，然后直接等待拉取启动即可。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/cac002d14e964b7c9323e8facca4c619.png">
      <br/>
      在desktop中能看到帮我们拉取的镜像。
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/55cf14d1cca042eab630641ed5cb761d.png">
      <br/>
      以及启动的容器。
     </img>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d55db938198e4e428d60dc66edb2a8ab.png"/>
    </p>
    <p>
     通过redis试试是否能够添加成功。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/cd9a6f3b2e07484f8c9a03bae32319f8.png"/>
    </p>
    <pre><code class="prism language-go">CREATE TABLE <span class="token string">`ms_member`</span>  <span class="token punctuation">(</span>
  <span class="token string">`id`</span> <span class="token function">bigint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> NOT NULL AUTO_INCREMENT COMMENT <span class="token char">'系统前台用户表'</span><span class="token punctuation">,</span>
  <span class="token string">`account`</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL DEFAULT <span class="token char">''</span> COMMENT <span class="token char">'用户登陆账号'</span><span class="token punctuation">,</span>
  <span class="token string">`password`</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT <span class="token char">''</span> COMMENT <span class="token char">'登陆密码'</span><span class="token punctuation">,</span>
  <span class="token string">`name`</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT <span class="token char">''</span> COMMENT <span class="token char">'用户昵称'</span><span class="token punctuation">,</span>
  <span class="token string">`mobile`</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT <span class="token char">'手机'</span><span class="token punctuation">,</span>
  <span class="token string">`realname`</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL DEFAULT NULL COMMENT <span class="token char">'真实姓名'</span><span class="token punctuation">,</span>
  <span class="token string">`create_time`</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="token char">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token string">`status`</span> <span class="token function">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> NULL DEFAULT <span class="token number">0</span> COMMENT <span class="token char">'状态'</span><span class="token punctuation">,</span>
  <span class="token string">`last_login_time`</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="token char">'上次登录时间'</span><span class="token punctuation">,</span>
  <span class="token string">`sex`</span> <span class="token function">tinyint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> NULL DEFAULT <span class="token number">0</span> COMMENT <span class="token char">'性别'</span><span class="token punctuation">,</span>
  <span class="token string">`avatar`</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT <span class="token char">''</span> COMMENT <span class="token char">'头像'</span><span class="token punctuation">,</span>
  <span class="token string">`idcard`</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="token char">'身份证'</span><span class="token punctuation">,</span>
  <span class="token string">`province`</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> NULL DEFAULT <span class="token number">0</span> COMMENT <span class="token char">'省'</span><span class="token punctuation">,</span>
  <span class="token string">`city`</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> NULL DEFAULT <span class="token number">0</span> COMMENT <span class="token char">'市'</span><span class="token punctuation">,</span>
  <span class="token string">`area`</span> <span class="token function">int</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> NULL DEFAULT <span class="token number">0</span> COMMENT <span class="token char">'区'</span><span class="token punctuation">,</span>
  <span class="token string">`address`</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="token char">'所在地址'</span><span class="token punctuation">,</span>
  <span class="token string">`description`</span> text CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci NULL COMMENT <span class="token char">'备注'</span><span class="token punctuation">,</span>
  <span class="token string">`email`</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="token char">'邮箱'</span><span class="token punctuation">,</span>
  <span class="token string">`dingtalk_openid`</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="token char">'钉钉openid'</span><span class="token punctuation">,</span>
  <span class="token string">`dingtalk_unionid`</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="token char">'钉钉unionid'</span><span class="token punctuation">,</span>
  <span class="token string">`dingtalk_userid`</span> <span class="token function">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> CHARACTER SET utf8 COLLATE utf8_general_ci NULL DEFAULT NULL COMMENT <span class="token char">'钉钉用户id'</span><span class="token punctuation">,</span>
  PRIMARY KEY <span class="token punctuation">(</span><span class="token string">`id`</span><span class="token punctuation">)</span> USING BTREE
<span class="token punctuation">)</span> ENGINE <span class="token operator">=</span> InnoDB AUTO_INCREMENT <span class="token operator">=</span> <span class="token number">1000</span> CHARACTER SET <span class="token operator">=</span> utf8 COLLATE <span class="token operator">=</span> utf8_general_ci COMMENT <span class="token operator">=</span> <span class="token char">'用户表'</span> ROW_FORMAT <span class="token operator">=</span> COMPACT<span class="token punctuation">;</span>
</code></pre>
    <p>
     我们把准备好的表，在mysql中导入。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d179cc7599f241f1b18a3f0ab7c0a328.png">
      <br/>
      这样服务就跑起来了，我们来看看现在etcd是否能用。
     </img>
    </p>
    <p>
     分别把user服务和api服务跑起来，然后看看前端是否能够正常请求。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6614736fabe948ff9c6a400b70e57aec.png"/>
    </p>
    <p>
     验证无误，现在把mysql、redis、etcd迁移到docker上了，查询redis也能够查询到记录的验证码！
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/387aa53fc2f34890895252f2d2d651d0.png"/>
    </p>
    <h2>
     <a id="2_go_197">
     </a>
     2. 部署go服务
    </h2>
    <p>
     需要把go服务也编译打包成镜像，然后运行起来。下面是一个编译的脚本。
    </p>
    <pre><code class="prism language-go">chcp <span class="token number">65001</span>
@echo off
<span class="token punctuation">:</span>loop
@echo off<span class="token operator">&amp;</span>amp<span class="token punctuation">;</span>color 0A
cls
echo<span class="token punctuation">,</span>
echo 请选择要编译的系统环境：
echo<span class="token punctuation">,</span>
echo <span class="token number">1.</span> Windows_amd64
echo <span class="token number">2.</span> linux_amd64

set<span class="token operator">/</span>p action<span class="token operator">=</span>请选择<span class="token punctuation">:</span>
<span class="token keyword">if</span> <span class="token operator">%</span>action<span class="token operator">%</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token keyword">goto</span> build_Windows_amd64
<span class="token keyword">if</span> <span class="token operator">%</span>action<span class="token operator">%</span> <span class="token operator">==</span> <span class="token number">2</span> <span class="token keyword">goto</span> build_linux_amd64

<span class="token punctuation">:</span>build_Windows_amd64
echo 编译Windows版本<span class="token number">64</span>位
SET CGO_ENABLED<span class="token operator">=</span><span class="token number">0</span>
SET GOOS<span class="token operator">=</span>windows
SET GOARCH<span class="token operator">=</span>amd64
<span class="token keyword">go</span> build <span class="token operator">-</span>o project<span class="token operator">-</span>user<span class="token operator">/</span>target<span class="token operator">/</span>project<span class="token operator">-</span>user<span class="token punctuation">.</span>exe project<span class="token operator">-</span>user<span class="token operator">/</span>main<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token keyword">go</span> build <span class="token operator">-</span>o project<span class="token operator">-</span>api<span class="token operator">/</span>target<span class="token operator">/</span>project<span class="token operator">-</span>api<span class="token punctuation">.</span>exe project<span class="token operator">-</span>api<span class="token operator">/</span>main<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token punctuation">:</span>build_linux_amd64
echo 编译Linux版本<span class="token number">64</span>位
SET CGO_ENABLED<span class="token operator">=</span><span class="token number">0</span>
SET GOOS<span class="token operator">=</span>linux
SET GOARCH<span class="token operator">=</span>amd64
<span class="token keyword">go</span> build <span class="token operator">-</span>o project<span class="token operator">-</span>user<span class="token operator">/</span>target<span class="token operator">/</span>project<span class="token operator">-</span>user project<span class="token operator">-</span>user<span class="token operator">/</span>main<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token keyword">go</span> build <span class="token operator">-</span>o project<span class="token operator">-</span>api<span class="token operator">/</span>target<span class="token operator">/</span>project<span class="token operator">-</span>api project<span class="token operator">-</span>api<span class="token operator">/</span>main<span class="token punctuation">.</span><span class="token keyword">go</span>
</code></pre>
    <p>
     在脚本下执行
     <code>
      build
     </code>
     命令，然后进行编译，这里我们需要编译linux版本，放到docker中去。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b5d44f17f4d841be9b2e8994fad5647b.png"/>
    </p>
    <h3>
     <a id="dockerfile_236">
     </a>
     编写dockerfile
    </h3>
    <p>
     写dockerfile是为了编译成镜像。
    </p>
    <pre><code class="prism language-go">FROM alpine
WORKDIR <span class="token operator">/</span>Initial
COPY <span class="token punctuation">.</span><span class="token operator">/</span>target<span class="token operator">/</span>project<span class="token operator">-</span>user <span class="token punctuation">.</span>
COPY <span class="token punctuation">.</span><span class="token operator">/</span>config<span class="token operator">/</span>config<span class="token operator">-</span>docker<span class="token punctuation">.</span>yaml <span class="token punctuation">.</span>
RUN  mkdir config <span class="token operator">&amp;&amp;</span> mv config<span class="token operator">-</span>docker<span class="token punctuation">.</span>yaml config<span class="token operator">/</span>config<span class="token punctuation">.</span>yaml
EXPOSE <span class="token number">8080</span> <span class="token number">8881</span>
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"./project-user"</span><span class="token punctuation">]</span>
</code></pre>
    <p>
     <code>
      FROM alpine
     </code>
     指定了构建镜像所使用的基础镜像为 alpine，这是一个非常轻量的 Linux 发行版。使用 alpine 作为基础镜像，可以减小镜像的体积，因为 alpine 镜像通常非常小，只有几十兆。
    </p>
    <p>
     <code>
      WORKDIR /Initial
     </code>
     设置容器内的工作目录为 /Initial。工作目录是指在容器中运行命令时默认的目录。如果该目录不存在，WORKDIR 会创建它。
    </p>
    <p>
     <code>
      COPY ./target/project-user .
     </code>
     将本地系统中的 ./target/project-user 文件复制到 Docker 容器中的当前工作目录（即 /Initial）中。
    </p>
    <p>
     <code>
      COPY ./config/config-docker.yaml .
     </code>
     将本地系统中的 ./config/config-docker.yaml 文件复制到 Docker 容器的当前工作目录（/Initial）中。此文件通常用于存储容器中应用的配置文件。
    </p>
    <p>
     <code>
      RUN mkdir config &amp;&amp; mv config-docker.yaml config/config.yaml
     </code>
     ，首先在在容器的当前工作目录中创建一个名为 config 的新目录。然后mv config-docker.yaml config/config.yaml：将之前复制到容器中的 config-docker.yaml 文件重命名为 config/config.yaml 并移动到新创建的 config 目录中。
    </p>
    <p>
     <code>
      EXPOSE 8080 8881
     </code>
     告知 Docker 容器将暴露端口 8080 和 8881，意味着容器运行时，这些端口将会被开放，并允许主机或其他容器与之通信。需要注意的是，EXPOSE 仅是一个声明，它不会自动将端口映射到主机上，实际的端口映射需要通过
     <code>
      docker run -p 或 docker-compose.yml
     </code>
     配置来完成。
    </p>
    <p>
     <code>
      ENTRYPOINT ["./project-user"]
     </code>
     指定容器启动时的默认命令。ENTRYPOINT 设置容器运行时的入口点，容器启动后，会执行 ./project-user 这个命令。通常，ENTRYPOINT 用来指定容器的主进程。在这里，./project-user 是容器内的一个可执行文件，它会在容器启动时运行。
    </p>
    <p>
     然后我们需要把原来config文件复制一份改为
     <code>
      config-docker.yaml
     </code>
     文件，并且需要修改配置代码。原本我们的server地址是127.0.0.1，这是本地回环地址，任何绑定在 127.0.0.1 上的服务只能在本地机器上访问，不能从其他机器或者网络中访问
    </p>
    <p>
     需要改为0.0.0.0，绑定到 0.0.0.0 上的服务将接受来自所有网络接口（包括外部网络接口）的请求。这意味着服务不仅能接受本地机器的请求，还能接受来自其他机器或容器的请求。
    </p>
    <pre><code class="prism language-go">server<span class="token punctuation">:</span>
  name<span class="token punctuation">:</span> <span class="token string">"project-user"</span>
  addr<span class="token punctuation">:</span> <span class="token string">"0.0.0.0:8080"</span>
zap<span class="token punctuation">:</span>
  debugFileName<span class="token punctuation">:</span> <span class="token string">"/logs/debug/project-debug.log"</span>
  infoFileName<span class="token punctuation">:</span> <span class="token string">"/logs/info/project-info.log"</span>
  warnFileName<span class="token punctuation">:</span> <span class="token string">"/logs/error/project-error.log"</span>
  maxSize<span class="token punctuation">:</span> <span class="token number">500</span><span class="token punctuation">,</span>
  maxAge<span class="token punctuation">:</span> <span class="token number">28</span><span class="token punctuation">,</span>
  MaxBackups<span class="token punctuation">:</span> <span class="token number">3</span>
redis<span class="token punctuation">:</span>
  host<span class="token punctuation">:</span> <span class="token string">"redis6"</span>
  port<span class="token punctuation">:</span> <span class="token number">6379</span>
  password<span class="token punctuation">:</span> <span class="token string">""</span>
  db<span class="token punctuation">:</span> <span class="token number">0</span>
grpc<span class="token punctuation">:</span>
  addr<span class="token punctuation">:</span> <span class="token string">"0.0.0.0:8881"</span>
  name<span class="token punctuation">:</span> <span class="token string">"user"</span>
  version<span class="token punctuation">:</span> <span class="token string">"1.0.0"</span>
  weight<span class="token punctuation">:</span> <span class="token number">2</span>
etcd<span class="token punctuation">:</span>
  addrs<span class="token punctuation">:</span>
    <span class="token operator">-</span> <span class="token string">"etcd3:2379"</span>
</code></pre>
    <p>
     也就是说，在 Docker 容器中，通常容器中的服务是通过 容器的网络接口 与其他容器或主机进行通信的。如果你将应用绑定到 127.0.0.1，那么它将只能接受来自容器内部（即容器的网络栈）或者本地机器的请求，而不能接受外部请求。这对多容器应用或需要外部访问的服务（如 Web 服务、gRPC 服务等）会构成问题。
    </p>
    <p>
     同时还要对redis和etcd的容器名设定好，已经起来的容器名称是redis6和etcd3，我们需要对应设置好。
    </p>
    <p>
     并且在docker-compoose.yaml的文件下，加入User相关配置。
    </p>
    <pre><code class="prism language-go">  Project<span class="token operator">-</span>User<span class="token punctuation">:</span>
    container_name<span class="token punctuation">:</span> project<span class="token operator">-</span>user
    image<span class="token punctuation">:</span> project<span class="token operator">-</span>user<span class="token punctuation">:</span>latest
    ports<span class="token punctuation">:</span>
      <span class="token operator">-</span> <span class="token number">8080</span><span class="token punctuation">:</span><span class="token number">8080</span>
      <span class="token operator">-</span> <span class="token number">8881</span><span class="token punctuation">:</span><span class="token number">8881</span>
</code></pre>
    <p>
     然后再写一个run.bat的脚本，一起来打包运行。
    </p>
    <pre><code class="prism language-go">chcp <span class="token number">65001</span>
cd project<span class="token operator">-</span>user
docker build <span class="token operator">-</span>t project<span class="token operator">-</span>user<span class="token punctuation">:</span>latest <span class="token punctuation">.</span>
cd <span class="token punctuation">.</span><span class="token punctuation">.</span>
docker<span class="token operator">-</span>compose up <span class="token operator">-</span>d
</code></pre>
    <p>
     <code>
      chcp 65001
     </code>
     用于 设置命令行的字符编码 为 UTF-8（65001 是 UTF-8 编码的代码页）。
    </p>
    <p>
     <code>
      docker build -t project-user:latest .
     </code>
     构建 Docker 镜像的命令。
     <code>
      -t project-user:latest
     </code>
     ：这是为构建出来的 Docker 镜像指定一个标签（-t 参数），标签为 project-user:latest。latest 是镜像的版本标签，意味着这是最新版本的镜像。
     <code>
      .
     </code>
     ：指的是当前目录（
     <code>
      即 project-user 目录
     </code>
     ）。构建过程会查找当前目录下的 Dockerfile 文件，使用
     <code>
      Dockerfile 中的指令
     </code>
     来构建镜像。
    </p>
    <p>
     <code>
      docker-compose up -d
     </code>
     也就是cd到上层目录之后，会根据当前目录下的 docker-compose.yml 文件来启动定义的服务。docker-compose.yml 文件通常包含一个或多个服务（如 Web 服务、数据库服务等）的配置。
    </p>
    <p>
     然后我们来run这个bat脚本，然后等待运行即可。（这个过程需要魔法，不然会失败，这个点大家自行解决即可。）
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a812ece1ce7945baafaf4e5a129a4e0a.png"/>
     <br/>
     嗯，魔法也不行，魔法只能pull，但是不能构建dockerfile，会一直提示报错，这里还需要添加docker的镜像地址。
    </p>
    <pre><code class="prism language-go"><span class="token punctuation">{<!-- --></span>
  <span class="token string">"builder"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"gc"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"defaultKeepStorage"</span><span class="token punctuation">:</span> <span class="token string">"20GB"</span><span class="token punctuation">,</span>
      <span class="token string">"enabled"</span><span class="token punctuation">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"experimental"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  <span class="token string">"registry-mirrors"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"https://docker.registry.cyou/"</span><span class="token punctuation">,</span>
        <span class="token string">"https://docker-cf.registry.cyou/"</span><span class="token punctuation">,</span>
        <span class="token string">"https://dockercf.jsdelivr.fyi/"</span><span class="token punctuation">,</span>
        <span class="token string">"https://docker.jsdelivr.fyi/"</span><span class="token punctuation">,</span>
        <span class="token string">"https://dockertest.jsdelivr.fyi/"</span><span class="token punctuation">,</span>
        <span class="token string">"https://mirror.aliyuncs.com/"</span><span class="token punctuation">,</span>
        <span class="token string">"https://dockerproxy.com/"</span><span class="token punctuation">,</span>
        <span class="token string">"https://mirror.baidubce.com/"</span><span class="token punctuation">,</span>
        <span class="token string">"https://docker.m.daocloud.io/"</span><span class="token punctuation">,</span>
        <span class="token string">"https://docker.nju.edu.cn/"</span><span class="token punctuation">,</span>
        <span class="token string">"https://docker.mirrors.sjtug.sjtu.edu.cn/"</span><span class="token punctuation">,</span>
        <span class="token string">"https://docker.mirrors.ustc.edu.cn/"</span><span class="token punctuation">,</span>
        <span class="token string">"https://mirror.iscas.ac.cn/"</span><span class="token punctuation">,</span>
        <span class="token string">"https://docker.rainbond.cc/"</span><span class="token punctuation">,</span>
        <span class="token string">"https://jq794zz5.mirror.aliyuncs.com"</span>
    <span class="token punctuation">]</span>

<span class="token punctuation">}</span>
</code></pre>
    <p>
     这里我们在docker引擎里面设置即可。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/8fcd9c27fef94616bf027c22c4f17d20.png"/>
     <br/>
     现在再重新
     <code>
      run.bat
     </code>
     这个脚本，就可以构造我们user的镜像，并且运行全部的docker compose了。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9d7a3ff64b124aaabbca6fdd3af8ec5e.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bfd560a47cf54f0890a1046c8483fde4.png"/>
     <br/>
     这个时候我们也能看到user镜像了。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7ba0fc5ab3ee4b02be8e9bab70ed9ff2.png"/>
    </p>
    <p>
     现在启动就可以不用通过本地goland用go run 命令启动服务了，已经在容器里面跑起来了。
    </p>
    <p>
     通过命令
     <code>
      docker logs -f project-user
     </code>
     可以查看对应的docker容器日志。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/3aca67bc4dcb45319d4f5c3ed17639b1.png"/>
     <br/>
     然后在本地启动api服务，在前端发送请求，验证成功。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/fe1b06098ff14b0eba058daf806c7063.png"/>
     <br/>
     此时user容器的日志也已更新。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7b5d59c9b49e4ba1978d9bc2601afbb8.png"/>
    </p>
    <p>
     如果后续改动了代码，需要验证的话，步骤就是先运行命令
     <code>
      build.bat
     </code>
     命令，build对应的linux版本。也就是先编译Go程序为linux版本。
    </p>
    <p>
     然后运行
     <code>
      run.bat
     </code>
     脚本，重新编译镜像并运行容器。这样等待重新生效即可。
    </p>
    <hr/>
    <p>
     后续如何在linux下查看占用的端口情况，这里有两个命令：
    </p>
    <pre><code class="prism language-go">netstat <span class="token operator">-</span>tulnp

ss <span class="token operator">-</span>tuln
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f7468656169706f7765722f:61727469636c652f64657461696c732f313436313132343332" class_="artid" style="display:none">
 </p>
</div>


