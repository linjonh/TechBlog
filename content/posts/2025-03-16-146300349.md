---
layout: post
title: "使用-Express.js-和-better-sqlite3-的最佳实践指南"
date: 2025-03-16 19:56:48 +0800
description: "通过遵循上述最佳实践，你可以构建出既安全又高效的基于Express.js和的应用。单一实例管理数据库连接：确保在整个应用程序生命周期内只打开一次数据库连接。使用事务：保证数据一致性，避免部分更新导致的数据不一致问题。预编译语句：提高性能并防止SQL注入攻击。错误处理：对所有数据库操作进行适当的错误处理，确保即使发生错误也能提供清晰的信息或采取适当的恢复措施。关闭数据库连接：在特定情况下（如应用退出时）关闭数据库连接，避免潜在的资源泄漏。测试与维护：编写单元测试，定期备份数据库，并监控性能。"
keywords: "使用 `Express.js` 和 `better-sqlite3` 的最佳实践指南"
categories: ['Express']
tags: ['Sqlite', 'Javascript', 'Express']
artid: "146300349"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146300349
    alt: "使用-Express.js-和-better-sqlite3-的最佳实践指南"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146300349
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146300349
cover: https://bing.ee123.net/img/rand?artid=146300349
image: https://bing.ee123.net/img/rand?artid=146300349
img: https://bing.ee123.net/img/rand?artid=146300349
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     使用 `Express.js` 和 `better-sqlite3` 的最佳实践指南
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     在构建基于
     <code>
      Express.js
     </code>
     和
     <code>
      better-sqlite3
     </code>
     的应用时，遵循一些最佳实践可以帮助你更高效地管理数据库连接、提高代码的可读性和可维护性，并确保应用的安全性和性能。以下是一些详细的建议和示例代码。
    </p>
    <hr/>
    <h5>
     <a id="_4">
     </a>
     一、数据库连接管理
    </h5>
    <p>
     <strong>
      1. 单例模式管理数据库连接
     </strong>
    </p>
    <p>
     创建一个单独的文件来初始化和导出数据库实例，确保在整个应用程序生命周期内只打开一次数据库连接。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// db.js</span>
<span class="token keyword">const</span> Database <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'better-sqlite3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Database</span><span class="token punctuation">(</span><span class="token string">'path/to/database.db'</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">verbose</span><span class="token operator">:</span> console<span class="token punctuation">.</span>log <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> db<span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      2. 中间件集成
     </strong>
    </p>
    <p>
     通过中间件将数据库对象挂载到请求对象上，简化路由处理函数中的数据库访问。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// middleware/db.js</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    req<span class="token punctuation">.</span>db <span class="token operator">=</span> db<span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     在主应用文件中使用该中间件：
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">const</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dbMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./middleware/db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>dbMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <hr/>
    <h5>
     <a id="_45">
     </a>
     二、使用事务
    </h5>
    <p>
     对于需要保证数据一致性的操作，使用事务可以避免部分更新导致的数据不一致问题。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 在某个服务函数中</span>
<span class="token keyword">const</span> transaction <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">transaction</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">userId<span class="token punctuation">,</span> name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> insertStmt <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO users (id, name) VALUES (?, ?)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    insertStmt<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">transaction</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'John Doe'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Transaction failed:'</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <h5>
     <a id="Prepared_Statements_65">
     </a>
     三、预编译语句（Prepared Statements）
    </h5>
    <p>
     使用预编译语句不仅能提升性能，还能有效防止SQL注入攻击。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 在某个路由处理器中</span>
<span class="token keyword">const</span> stmt <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM users WHERE id = ?'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> stmt<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>params<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>user<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'User not found'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <h5>
     <a id="_83">
     </a>
     四、错误处理
    </h5>
    <p>
     对所有数据库操作进行适当的错误处理，确保即使发生错误也能提供清晰的信息或采取适当的恢复措施。
    </p>
    <pre><code class="prism language-javascript">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/users'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> stmt <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO users (name, email) VALUES (?, ?)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stmt<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>name<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">.</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">201</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'User created'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'Error inserting new user:'</span><span class="token punctuation">,</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">'Internal Server Error'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <hr/>
    <h5>
     <a id="_102">
     </a>
     五、关闭数据库连接
    </h5>
    <p>
     尽管大多数情况下不需要显式关闭
     <code>
      better-sqlite3
     </code>
     的数据库连接，但在某些特殊情况下（如长时间不活动或在多进程环境中），考虑在适当的时候关闭数据库连接以优化资源使用。
    </p>
    <p>
     <strong>
      1. 监听退出信号
     </strong>
    </p>
    <p>
     在应用退出前关闭数据库连接是一个好的做法，特别是当你有其他资源需要释放时。可以使用 Node.js 的
     <code>
      process
     </code>
     事件来监听退出信号并关闭数据库连接。
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">function</span> <span class="token function">handleShutdown</span><span class="token punctuation">(</span><span class="token parameter">signal</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Received </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>signal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">. Closing database connection.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'SIGINT'</span><span class="token punctuation">,</span> handleShutdown<span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'SIGTERM'</span><span class="token punctuation">,</span> handleShutdown<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      2. 中间件模式中的关闭
     </strong>
    </p>
    <p>
     如果你使用中间件模式来管理数据库连接，确保在应用程序关闭时能够正确关闭数据库连接：
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// middleware/db.js</span>
<span class="token keyword">const</span> Database <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'better-sqlite3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Database</span><span class="token punctuation">(</span><span class="token string">'path/to/database.db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    req<span class="token punctuation">.</span>db <span class="token operator">=</span> db<span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 在应用的入口文件中添加关闭逻辑</span>
<span class="token keyword">const</span> dbMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./middleware/db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 如果你在单独的文件中初始化了db</span>

<span class="token keyword">function</span> <span class="token function">handleShutdown</span><span class="token punctuation">(</span><span class="token parameter">signal</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Received </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>signal<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">. Closing database connection.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    db<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'SIGINT'</span><span class="token punctuation">,</span> handleShutdown<span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'SIGTERM'</span><span class="token punctuation">,</span> handleShutdown<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>dbMiddleware<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <hr/>
    <h5>
     <a id="_153">
     </a>
     六、测试与维护
    </h5>
    <p>
     <strong>
      编写单元测试：
     </strong>
    </p>
    <p>
     为您的数据库交互逻辑编写单元测试，确保其按预期工作。
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">const</span> assert <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'assert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'Users'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should insert a user'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> stmt <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">'INSERT INTO users (name, email) VALUES (?, ?)'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        stmt<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string">'Test User'</span><span class="token punctuation">,</span> <span class="token string">'test@example.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">const</span> user <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM users WHERE email = ?'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'test@example.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        assert<span class="token punctuation">.</span><span class="token function">strictEqual</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token string">'Test User'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <strong>
      定期备份数据库：
     </strong>
    </p>
    <p>
     定期备份数据库，并考虑实现自动化的备份策略。监控数据库性能，必要时优化查询或调整索引。
    </p>
    <hr/>
    <h4>
     <a id="_180">
     </a>
     总结
    </h4>
    <p>
     通过遵循上述最佳实践，你可以构建出既安全又高效的基于
     <code>
      Express.js
     </code>
     和
     <code>
      better-sqlite3
     </code>
     的应用。以下是关键点：
    </p>
    <ul>
     <li>
      <strong>
       单一实例管理数据库连接
      </strong>
      ：确保在整个应用程序生命周期内只打开一次数据库连接。
     </li>
     <li>
      <strong>
       使用事务
      </strong>
      ：保证数据一致性，避免部分更新导致的数据不一致问题。
     </li>
     <li>
      <strong>
       预编译语句
      </strong>
      ：提高性能并防止SQL注入攻击。
     </li>
     <li>
      <strong>
       错误处理
      </strong>
      ：对所有数据库操作进行适当的错误处理，确保即使发生错误也能提供清晰的信息或采取适当的恢复措施。
     </li>
     <li>
      <strong>
       关闭数据库连接
      </strong>
      ：在特定情况下（如应用退出时）关闭数据库连接，避免潜在的资源泄漏。
     </li>
     <li>
      <strong>
       测试与维护
      </strong>
      ：编写单元测试，定期备份数据库，并监控性能。
     </li>
    </ul>
    <p>
     希望这些最佳实践能帮助你在构建高效、可靠的 Web 应用时做出更好的决策。如果有任何进一步的问题或具体场景的需求，请随时提问！
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f677573757368616e74616e672f:61727469636c652f64657461696c732f313436333030333439" class_="artid" style="display:none">
 </p>
</div>


