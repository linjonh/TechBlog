---
layout: post
title: "Redis三大件-穿透雪崩击穿"
date: 2025-03-14 00:01:32 +0800
description: "元素\"apple“经过k个不同的哈希函数计算后，得到k个哈希值h1(“apple”)、h2(“apple”)…缓存穿透是指客户端发来的请求，在缓存和数据库中都无法找到，那么因此缓存就永远不会存在，所以每次请求都会被打到数据库。如果过期，则先使用Redis中的旧数据，然后使用异步单线程去数据库获取新数据，然后重新缓存到Redis。预加载所有可能存在的数据哈希值到布隆过滤器中，查询时先判断数据是否存在。将元素 y 通过同样的 k 个哈希函数计算，得到 k 个位置。缓存永不过期，但存储数据时附加逻辑过期时间。"
keywords: "Redis三大件 穿透、雪崩、击穿"
categories: ['未分类']
tags: ['缓存', '数据库', 'Redis']
artid: "146245431"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146245431
    alt: "Redis三大件-穿透雪崩击穿"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146245431
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146245431
cover: https://bing.ee123.net/img/rand?artid=146245431
image: https://bing.ee123.net/img/rand?artid=146245431
img: https://bing.ee123.net/img/rand?artid=146245431
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Redis三大件 穿透、雪崩、击穿
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-github-gist" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_0">
     </a>
     一.缓存穿透：查无此物攻击。
    </h3>
    <h4>
     <a id="_2">
     </a>
     问题本质
    </h4>
    <p>
     缓存穿透是指客户端发来的请求，在缓存和数据库中都无法找到，那么因此缓存就永远不会存在，所以每次请求都会被打到数据库
    </p>
    <p>
     eg：黑客暴力扫描不存在的ID，然后发送大量垃圾请求，实现穿透攻击
    </p>
    <h4>
     <a id="_8">
     </a>
     解决方法
    </h4>
    <h5>
     <a id="1_10">
     </a>
     1.布隆过滤器
    </h5>
    <p>
     预加载所有可能存在的数据哈希值到布隆过滤器中，查询时先判断数据是否存在。
    </p>
    <pre><code class="prism language-java"><span class="token comment">// 使用Guava实现布隆过滤器</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BloomFilterDemo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">EXPECTED_INSERTIONS</span> <span class="token operator">=</span> <span class="token number">1000000</span><span class="token punctuation">;</span>  <span class="token comment">//预计插入数据量</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> <span class="token constant">FPP</span> <span class="token operator">=</span> <span class="token number">0.01</span><span class="token punctuation">;</span>	<span class="token comment">//允许的误判率（即允许 “可能存在但实际不存在” 的概率。）</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">BloomFilter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> bloomFilter <span class="token operator">=</span> 
        <span class="token class-name">BloomFilter</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token class-name">Funnels</span><span class="token punctuation">.</span><span class="token function">stringFunnel</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">EXPECTED_INSERTIONS</span><span class="token punctuation">,</span> <span class="token constant">FPP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化加载有效ID</span>
    <span class="token annotation punctuation">@PostConstruct</span>	<span class="token comment">//标记方法在 Bean 初始化完成后自动执行</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> validIds <span class="token operator">=</span> dao<span class="token punctuation">.</span><span class="token function">getAllIds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 从数据库获取所有有效ID</span>
        validIds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>bloomFilter<span class="token operator">::</span><span class="token function">put</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">// 将所有ID写入布隆过滤器</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>bloomFilter<span class="token punctuation">.</span><span class="token function">mightContain</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token string">"Invalid ID"</span><span class="token punctuation">;</span> <span class="token comment">// 直接拦截非法请求</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 继续查询缓存和数据库...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="2_38">
     </a>
     2.缓存异常值
    </h5>
    <p>
     将查询结果为空的值也插入到缓存，并设置一个较短的过期时间。
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">public</span> Object <span class="token function">getDataWithNullCache</span><span class="token punctuation">(</span><span class="token parameter">String key</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Object value <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"NULL"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> value<span class="token punctuation">;</span> <span class="token comment">// 空值标识处理</span>
    <span class="token punctuation">}</span>
    
    Object dbValue <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dbValue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token string">"NULL"</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 空值缓存30秒</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dbValue<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> TimeUnit<span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> dbValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="_60">
     </a>
     对比
    </h5>
    <table>
     <thead>
      <tr>
       <th>
        方案
       </th>
       <th>
        优点
       </th>
       <th>
        缺点
       </th>
       <th>
        适用场景
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        布隆过滤器
       </td>
       <td>
        内存高效，永久拦截非法请求
       </td>
       <td>
        存在误判率，需要预加载数据
       </td>
       <td>
        数据库定且可预加载
       </td>
      </tr>
      <tr>
       <td>
        缓存空值
       </td>
       <td>
        实现简单，实时生效
       </td>
       <td>
        可能缓存大量无效Key
       </td>
       <td>
        动态变化的Key
       </td>
      </tr>
     </tbody>
    </table>
    <h3>
     <a id="_67">
     </a>
     二.缓存雪崩：批量失效灾难
    </h3>
    <h4>
     <a id="_69">
     </a>
     问题本质
    </h4>
    <ul>
     <li>
      批量过期：大量key在同一时间过期
     </li>
     <li>
      Redis宕机：集群故障导致所有请求被打到数据库
     </li>
    </ul>
    <h4>
     <a id="_74">
     </a>
     解决方法
    </h4>
    <h5>
     <a id="_76">
     </a>
     随机过期时间
    </h5>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCacheWithRandomExpire</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> baseExpire <span class="token operator">=</span> <span class="token number">3600</span><span class="token punctuation">;</span> <span class="token comment">// 基础过期时间1小时</span>
    <span class="token keyword">int</span> randomExpire <span class="token operator">=</span> <span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0-10分钟随机偏移</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
        key<span class="token punctuation">,</span> 
        value<span class="token punctuation">,</span> 
        baseExpire <span class="token operator">+</span> randomExpire<span class="token punctuation">,</span> 
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="_91">
     </a>
     多级缓存架构
    </h5>
    <pre><code class="prism language-java"><span class="token comment">// 使用Caffeine作为本地缓存</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MultiLevelCache</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> localCache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getData</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.检查本地缓存</span>
        <span class="token class-name">Object</span> value <span class="token operator">=</span> localCache<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span>
        
        <span class="token comment">// 2.检查Redis缓存</span>
        value <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            localCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 回填本地缓存</span>
            <span class="token keyword">return</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        <span class="token comment">// 3.查询数据库并重建缓存...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_118">
     </a>
     三.缓存击穿：热点数据暴雷
    </h3>
    <h4>
     <a id="_120">
     </a>
     问题本质
    </h4>
    <p>
     高并发访问的热点 key 突然失效，导致数据库被击穿
    </p>
    <h4>
     <a id="_124">
     </a>
     解决方法
    </h4>
    <h5>
     <a id="Redisson_126">
     </a>
     分布式锁（Redisson实现）
    </h5>
    <p>
     当缓存失效时，通过分布式锁控制仅一个线程去数据库获取数据，重建缓存
    </p>
    <pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getDataWithLock</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Object</span> value <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RLock</span> lock <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 等待3秒，持有10秒</span>
                <span class="token comment">// 二次检查</span>
                value <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    value <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MINUTES</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h5>
     <a id="_152">
     </a>
     逻辑过期时间
    </h5>
    <p>
     缓存永不过期，但存储数据时附加逻辑过期时间。
    </p>
    <p>
     Redis中缓存永不过期（除非手动清理），由应用层逻辑过期时间戳来判断是否过期。
     <br/>
     如果过期，则先使用Redis中的旧数据，然后使用异步单线程去数据库获取新数据，然后重新缓存到Redis。
    </p>
    <pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogicalExpireData</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">Object</span> data<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> expireTime<span class="token punctuation">;</span> <span class="token comment">// 逻辑过期时间戳</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getDataWithLogicalExpire</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">LogicalExpireData</span> cached <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cached <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">loadDataAndSetCache</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 首次加载</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> cached<span class="token punctuation">.</span><span class="token function">getExpireTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 提交异步刷新任务</span>
        executor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getLock</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 获取互斥锁</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">loadDataAndSetCache</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">releaseLock</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cached<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 返回旧数据</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Object</span> <span class="token function">loadDataAndSetCache</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Object</span> dbValue <span class="token operator">=</span> db<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">LogicalExpireData</span> newData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LogicalExpireData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    newData<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span>dbValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    newData<span class="token punctuation">.</span><span class="token function">setExpireTime</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3600_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1小时后逻辑过期</span>
    redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> newData<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//Redis中永不过期！</span>
    <span class="token keyword">return</span> dbValue<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <table>
     <thead>
      <tr>
       <th>
        方案
       </th>
       <th>
        优点
       </th>
       <th>
        缺点
       </th>
       <th>
        适用场景
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td>
        分布式锁
       </td>
       <td>
        数据强一致性
       </td>
       <td>
        性能损耗较高
       </td>
       <td>
        对一致性要求严格的场景
       </td>
      </tr>
      <tr>
       <td>
        逻辑过期
       </td>
       <td>
        零等待时间
       </td>
       <td>
        存在短暂的数据不一致（新旧数据）
       </td>
       <td>
        高并发读场景
       </td>
      </tr>
     </tbody>
    </table>
    <h4>
     <a id="_206">
     </a>
     布隆过滤器是什么？
    </h4>
    <p>
     布隆过滤器是一种空间高效的概率型数据结构，用于快速判断一个元素是否属于某个集合
    </p>
    <p>
     <strong>
      特点
     </strong>
    </p>
    <ul>
     <li>
      可能误判（错误地认为某个不存在的元素存在）：不同元素的哈希函数计算结果可能覆盖相同位，导致查询时误以为元素存在。
     </li>
     <li>
      绝不漏判（错误地认为某个存在的元素不存在）：如果元素实际存在于集合中，其哈希对应的所有位在添加时已被置为 1，不可能出现某一位为 0
     </li>
    </ul>
    <p>
     <strong>
      数据结构
     </strong>
    </p>
    <ul>
     <li>
      位数组：一个长度为 m 的二进制数组，初始所有位为 0。
     </li>
     <li>
      哈希函数：使用 k 个不同的哈希函数，每个函数将元素映射到位数组的某个位置。
     </li>
    </ul>
    <p>
     <strong>
      流程
     </strong>
    </p>
    <p>
     (1)添加元素
    </p>
    <p>
     元素"apple“经过k个不同的哈希函数计算后，得到k个哈希值h1(“apple”)、h2(“apple”)…hk(“apple”)
    </p>
    <p>
     在位数组中将这k个哈希函数计算出来的位置设为1
    </p>
    <pre><code class="prism language-sql"><span class="token comment">// 示例：添加元素 "apple"</span>
hash1<span class="token punctuation">(</span><span class="token string">"apple"</span><span class="token punctuation">)</span> → 位置<span class="token number">3</span>
hash2<span class="token punctuation">(</span><span class="token string">"apple"</span><span class="token punctuation">)</span> → 位置<span class="token number">7</span>
hash3<span class="token punctuation">(</span><span class="token string">"apple"</span><span class="token punctuation">)</span> → 位置<span class="token number">12</span>
将位数组的<span class="token number">3</span>、<span class="token number">7</span>、<span class="token number">12</span>位设置为<span class="token number">1</span>
</code></pre>
    <p>
     （2）判断元素是否存在
    </p>
    <p>
     将元素 y 通过同样的 k 个哈希函数计算，得到 k 个位置。
    </p>
    <p>
     检查位数组中这 k 个位置是否全为 1：
    </p>
    <ul>
     <li>
      全为 1 → 元素可能存在于集合（可能误判）
     </li>
     <li>
      至少有一个 0 → 元素绝对不存在
     </li>
    </ul>
    <pre><code class="prism language-yaml">// 示例：查询元素 "banana"
hash1("banana") → 位置3
hash2("banana") → 位置9
hash3("banana") → 位置12
检查位数组的3、9、12位：
<span class="token punctuation">-</span> 位置9为0 → 元素不存在
</code></pre>
    <p>
     <strong>
      误判率
     </strong>
    </p>
    <p>
     误判率 p 与以下参数相关：
    </p>
    <ul>
     <li>
      m：位数组长度
     </li>
     <li>
      k：哈希函数数量
     </li>
     <li>
      n：集合中元素数量
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f496861766542422f:61727469636c652f64657461696c732f313436323435343331" class_="artid" style="display:none">
 </p>
</div>


