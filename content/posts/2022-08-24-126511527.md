---
layout: post
title: "本机-Socket-进程间通信时数据包是否经过网卡"
date: 2022-08-24 19:58:39 +0800
description: "在进行 socket 通信的时候突然想到一个问题：自身既作为 client 又作为 server 时"
keywords: "socket网络数据包"
categories: ['计算机网络']
tags: ['网络协议', '网络', 'Tcp']
artid: "126511527"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=126511527
    alt: "本机-Socket-进程间通信时数据包是否经过网卡"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=126511527
featuredImagePreview: https://bing.ee123.net/img/rand?artid=126511527
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     本机 Socket 进程间通信时数据包是否经过网卡
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="_3">
     </a>
     目录
    </h2>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <a href="#_3" rel="nofollow">
        目录
       </a>
      </li>
      <li>
       <a href="#_16" rel="nofollow">
        实验
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#1__socket__21" rel="nofollow">
          1. 编写 socket 代码
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#client_25" rel="nofollow">
            client
           </a>
          </li>
          <li>
           <a href="#server_46" rel="nofollow">
            server
           </a>
          </li>
         </ul>
        </li>
        <li>
         <a href="#2__76" rel="nofollow">
          2. 抓包
         </a>
        </li>
        <li>
         <a href="#3__92" rel="nofollow">
          3. 分析包结构
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_105" rel="nofollow">
        结论
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <hr/>
    <p>
     在进行 socket 通信的时候突然想到一个问题：自身既作为 client 又作为 server 时，数据包在传递过程中是否会经过网卡呢？
    </p>
    <p>
     <strong>
      先说结论：不经过
     </strong>
     。
    </p>
    <p>
     下面通过实验验证此结论。
    </p>
    <h2>
     <a id="_16">
     </a>
     实验
    </h2>
    <ul>
     <li>
      设计实验：在一台设备上进行 socket 通信，并抓包查看数据包是否存在 MAC 地址，因为如果经过网卡的话，一定是有 MAC 地址的。
     </li>
    </ul>
    <h3>
     <a id="1__socket__21">
     </a>
     1. 编写 socket 代码
    </h3>
    <p>
     编写 TCP 通信代码，如下。
    </p>
    <h4>
     <a id="client_25">
     </a>
     client
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># coding:utf-8</span>

<span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>

tcp_client <span class="token operator">=</span> socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">)</span>
addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">7788</span><span class="token punctuation">)</span>  <span class="token comment"># 服务器地址</span>
tcp_client<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>  <span class="token comment"># 连接到服务器</span>

<span class="token comment"># while True:</span>
send_data <span class="token operator">=</span> <span class="token string">"Hello World"</span>
tcp_client<span class="token punctuation">.</span>send<span class="token punctuation">(</span>send_data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 向服务器发送数据</span>

recv_data <span class="token operator">=</span> tcp_client<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span>  <span class="token comment"># 接收服务器发过来的数据</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>recv_data<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

tcp_client<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h4>
     <a id="server_46">
     </a>
     server
    </h4>
    <pre><code class="prism language-python"><span class="token comment"># coding:utf-8</span>

<span class="token keyword">from</span> socket <span class="token keyword">import</span> <span class="token operator">*</span>

tcp_server <span class="token operator">=</span> socket<span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_STREAM<span class="token punctuation">)</span>

addr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> <span class="token number">7788</span><span class="token punctuation">)</span>  <span class="token comment"># 接收数据的端口</span>
tcp_server<span class="token punctuation">.</span>bind<span class="token punctuation">(</span>addr<span class="token punctuation">)</span>  <span class="token comment"># 绑定地址</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>

    tcp_server<span class="token punctuation">.</span>listen<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span>  <span class="token comment"># 监听连接</span>

    client_socket<span class="token punctuation">,</span> client_addr <span class="token operator">=</span> tcp_server<span class="token punctuation">.</span>accept<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 创建新的套接字为客户端服务</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>client_addr<span class="token punctuation">)</span>  <span class="token comment"># 打印客户端地址</span>

    recv_data <span class="token operator">=</span> client_socket<span class="token punctuation">.</span>recv<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span>  <span class="token comment"># 接收客户端信息</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>recv_data<span class="token punctuation">)</span>

    send_data <span class="token operator">=</span> <span class="token string">"ok."</span>
    client_socket<span class="token punctuation">.</span>send<span class="token punctuation">(</span>send_data<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">"utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    client_socket<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>

tcp_server<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="2__76">
     </a>
     2. 抓包
    </h3>
    <p>
     启动 server 和 client 进行 tcp 通信，使用 wireshark 抓包，如下：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5c9ecd5b967b966161ff0d901313e9dc.png#pic_center"/>
    </p>
    <p>
     从图中可以看出，client 和 server 有完整的三次握手和四次挥手。
    </p>
    <p>
     如果为了验证所抓的包是否真的是我们编写的 socket 通信代码产生的数据包，可以查看此数据包：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/9874d2af6b73ced2a705ba63b3e9af9f.png#pic_center"/>
    </p>
    <p>
     从上图可以看到我们确实捕获了正确的数据包。
    </p>
    <h3>
     <a id="3__92">
     </a>
     3. 分析包结构
    </h3>
    <p>
     随便选中一个数据包，在 wireshark 下方窗口查看其包结构，如下：
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/1c10b80ed9854ea27f019e47d696af13.png#pic_center"/>
    </p>
    <p>
     可以看到此数据包并没有 MAC 地址，这个 「Null/Loopback」是什么呢？
    </p>
    <p>
     看
     <a href="https://blog.51cto.com/cchome/385323" rel="nofollow">
      博客
     </a>
     说 Loopback 接口是一种纯软件性质的虚拟接口，任何送达该接口的网络数据报文都会被认为是送往设备自身的，所以数据包并没有经过网卡。
    </p>
    <h2>
     <a id="_105">
     </a>
     结论
    </h2>
    <p>
     所以本机 Socket 进程间通信时，数据包并不经过网卡。
    </p>
    <p>
     报文经过的路径是这样的：
    </p>
    <p>
     应用层 —— Socket 接口 —— 传输层 —— 网络层 —— 传输层 —— Socket 接口 —— 应用层。
    </p>
    <p>
     即，先从上而下到网络层，然后随即再向上到应用层。
    </p>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f756e6f6e6f692f:61727469636c652f64657461696c732f313236353131353237" class_="artid" style="display:none">
 </p>
</div>


