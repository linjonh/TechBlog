---
layout: post
title: "物联网基础EC20-MQTTS连接服务器进行加密数据传输"
date: 2024-12-09 00:00:00 +0800
description: "SSL(Secure Sockets Layer 安全套接字协议),及其继任者传输层安全（Trans"
keywords: "mqtts 工具"
categories: ['物联网基础']
tags: ['物联网', 'S', '4G']
artid: "107140678"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=107140678
    alt: "物联网基础EC20-MQTTS连接服务器进行加密数据传输"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=107140678
featuredImagePreview: https://bing.ee123.net/img/rand?artid=107140678
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     物联网基础：EC20 MQTTS连接服务器进行加密数据传输
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     <strong>
      SSL(Secure Sockets Layer 安全套接字协议),及其继任者传输层安全（Transport Layer Security，TLS）是为网络通信提供安全及数据完整性的一种安全协议。TLS与SSL在传输层与应用层之间对网络连接进行加密
     </strong>
    </p>
    <p>
     <strong>
      本文将介绍使用EC20 封装好的AT指令通过 MQTTS(即MQTT+SSL) 协议连接私有云服务器进行加密传输数据
     </strong>
    </p>
    <h3>
     <a id="1_4">
     </a>
     1、准备工作
    </h3>
    <h4>
     <a id="11_MQTTS__6">
     </a>
     1.1 MQTTS 账号
    </h4>
    <p>
     要连接私有云服务器，需有一个私有云服务器的mqtt客户端账号，笔者就用公司服务器的MQTTS测试账号做演示，后续涉及到账号密码相关部分打码，望理解
    </p>
    <p>
     服务器地址及mqtts账号相关信息：
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/7d0f06228d30415ce6da1bb8794ec12b.png"/>
    </p>
    <h4>
     <a id="12_CA__13">
     </a>
     1.2 CA 证书
    </h4>
    <p>
     使用MQTTS加密传输数据的话需要服务器提供一个CA证书，可向相关服务器技术人员咨询
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/bd2700d3634f52f9a836a0ae7c1f4ec6.png"/>
    </p>
    <p>
     用记事本打开CA证书，计算出CA证书的字节大小，后续需要用到，我所使用的CA证书大小为1163
    </p>
    <h4>
     <a id="13_MQTT_21">
     </a>
     1.3 MQTT工具连接服务器
    </h4>
    <p>
     使用MQTT工具 MQTTBox模拟务器，订阅设备的发布主题，即能接收到设备发送到服务器的数据，也能模拟向设备下发数据
    </p>
    <p>
     安装MQTTBox，填写服务器及设备MQTT的相关信息即能连接上服务器
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/2b19800059535fd695e11e22a4403fab.png"/>
    </p>
    <p>
     再订阅设备的发布主题，即可接收到设备往服务器发送的数据
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/1dbc7a80a5541fc23fbc70937be31f92.png"/>
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/63bd985761ec449c82d19ee1602633de.png"/>
    </p>
    <h3>
     <a id="2_36">
     </a>
     2、连接测试
    </h3>
    <p>
     使用串口调试助手，选择 USB AT Port端口，并对串口调试助手做简单设置
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/e00147b2a8638694de5cd79ad5123221.png"/>
    </p>
    <h4>
     <a id="21_AT_42">
     </a>
     2.1 AT指令连接云服务器：
    </h4>
    <p>
     AT指令连接私有云服务器过程：
    </p>
    <p>
     1)AT指令入网、模块测试
    </p>
    <table>
     <thead>
      <tr>
       <th align="left">
        序号
       </th>
       <th align="left">
        AT指令
       </th>
       <th align="left">
        指令解析
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="left">
        1
       </td>
       <td align="left">
        AT
       </td>
       <td align="left">
        测试指令，若返回OK，则模块可正常通信
       </td>
      </tr>
      <tr>
       <td align="left">
        2
       </td>
       <td align="left">
        AT+CPIN?
       </td>
       <td align="left">
        检查SIM卡是否在位
       </td>
      </tr>
      <tr>
       <td align="left">
        3
       </td>
       <td align="left">
        AT+CSQ
       </td>
       <td align="left">
        查询信号质量
       </td>
      </tr>
      <tr>
       <td align="left">
        4
       </td>
       <td align="left">
        AT+CREG?
       </td>
       <td align="left">
        查询入网状态
       </td>
      </tr>
      <tr>
       <td align="left">
        5
       </td>
       <td align="left">
        AT+CGATT=1
       </td>
       <td align="left">
        激活网络
       </td>
      </tr>
      <tr>
       <td align="left">
        6
       </td>
       <td align="left">
        AT+CGATT?
       </td>
       <td align="left">
        查询激活状态
       </td>
      </tr>
      <tr>
       <td align="left">
        7
       </td>
       <td align="left">
        AT+CGPADDR
       </td>
       <td align="left">
        获取PDP地址
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/c20c1e21f532a41d4dea7f75cfc7b7bb.png"/>
    </p>
    <p>
     2）MQTTS参数配置
    </p>
    <p>
     分别发送以下AT指令进行MQTTS参数配置（注意替换CA证书的相关指令部分部分）：
    </p>
    <table>
     <thead>
      <tr>
       <th align="left">
        序号
       </th>
       <th align="left">
        AT指令
       </th>
       <th align="left">
        指令解析
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="left">
        1
       </td>
       <td align="left">
        AT+QMTCFG="recv/mode"0,0,1
       </td>
       <td align="left">
        配置为接收模式
       </td>
      </tr>
      <tr>
       <td align="left">
        2
       </td>
       <td align="left">
        AT+QMTCFG=“SSL”,0,1,2
       </td>
       <td align="left">
        配置MQTT连接进入SSL模式
       </td>
      </tr>
      <tr>
       <td align="left">
        3
       </td>
       <td align="left">
        AT+QFUPL=“RAM:cacert.pem”,1163,100
       </td>
       <td align="left">
        将CA证书保存到EC20 RAM
       </td>
      </tr>
      <tr>
       <td align="left">
        4
       </td>
       <td align="left">
        AT+QSSLCFG=“cacert”,2,“RAM:cacert.pem”
       </td>
       <td align="left">
        配置CA证书
       </td>
      </tr>
      <tr>
       <td align="left">
        5
       </td>
       <td align="left">
        AT+QSSLCFG=“seclevel”,2,1
       </td>
       <td align="left">
        选择SSL认证模式
       </td>
      </tr>
      <tr>
       <td align="left">
        6
       </td>
       <td align="left">
        AT+QSSLCFG=“sslversion”,2,4
       </td>
       <td align="left">
        选择SSL版本
       </td>
      </tr>
      <tr>
       <td align="left">
        7
       </td>
       <td align="left">
        AT+QSSLCFG=“ciphersuite”,2,0xFFFF
       </td>
       <td align="left">
        选择SSL密码套件
       </td>
      </tr>
      <tr>
       <td align="left">
        8
       </td>
       <td align="left">
        AT+QSSLCFG=“ignorelocaltime”,2,1
       </td>
       <td align="left">
        配置身份验证时间
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/9be4ab837c9feb65cd7c6a5a213a86e6.png"/>
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/5163674c334cdfa222b09256e60dc602.png"/>
    </p>
    <p>
     3）连接服务器
    </p>
    <p>
     注意：测试时需将服务器地址信息及MQTT账号信息替换成自己的账户信息
    </p>
    <table>
     <thead>
      <tr>
       <th align="left">
        序号
       </th>
       <th align="left">
        AT指令
       </th>
       <th align="left">
        指令解析
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="left">
        1
       </td>
       <td align="left">
        AT+QMTOPEN=0,“121.36.47.54”,8883
       </td>
       <td align="left">
        开启MQTT SSL 连接，连接服务器
       </td>
      </tr>
      <tr>
       <td align="left">
        2
       </td>
       <td align="left">
        AT+QMTCONN=0,“Clientid”,“Username”,“Password”
       </td>
       <td align="left">
        配置MQTT连接
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/560b3ac11609f746c634b006790b6770.png"/>
    </p>
    <h4>
     <a id="22__94">
     </a>
     2.2 发送数据
    </h4>
    <p>
     AT指令发送数据的过程如下：
    </p>
    <table>
     <thead>
      <tr>
       <th align="left">
        序号
       </th>
       <th align="left">
        AT指令
       </th>
       <th align="left">
        指令解析
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="left">
        1
       </td>
       <td align="left">
        AT+QMTPUB=0,1,1,0,“PubTopic”
       </td>
       <td align="left">
        发布主题消息
       </td>
      </tr>
      <tr>
       <td align="left">
        2
       </td>
       <td align="left">
        {params:{IndoorTemperature:55,mhumi:55}}
       </td>
       <td align="left">
        发送的JSON数据
       </td>
      </tr>
      <tr>
       <td align="left">
        3
       </td>
       <td align="left">
        0x1a
       </td>
       <td align="left">
        数据结束符
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/201f2619f9075ab52be9677969c4e8fd.png"/>
    </p>
    <p>
     此时，可在MQTTBox数据接收区查看EC20往服务器发送的数据
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/48158226e61faac21a1ef373134d90b6.png"/>
    </p>
    <h4>
     <a id="23__110">
     </a>
     2.3 接收数据
    </h4>
    <p>
     AT指令接收服务器数据指令如下：
    </p>
    <p>
     EC20接收服务器下发的数据只需要订阅服务器的发布主题，即设备订阅主题：SubTopic 即能接收到服务器下发的数据
    </p>
    <table>
     <thead>
      <tr>
       <th align="left">
        序号
       </th>
       <th align="left">
        AT指令
       </th>
       <th align="left">
        指令解析
       </th>
      </tr>
     </thead>
     <tbody>
      <tr>
       <td align="left">
        1
       </td>
       <td align="left">
        AT+QMTSUB=0,1,“SubTopic”,0
       </td>
       <td align="left">
        订阅服务器发布主题
       </td>
      </tr>
     </tbody>
    </table>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/eb7e3b1730fbb63fbe8261846727d9a3.png"/>
    </p>
    <p>
     使用MQTTBox工具模拟服务器下发数据
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/8002778c86187ce8e179483ec1f94cd7.png"/>
    </p>
    <p>
     在本地串口调试助手数据接收区就能收到对应的数据
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/573567a8b7583ea5bd6a99327a6520f2.png"/>
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/cbb48fb4c417a11baac3517556dca505.gif"/>
    </p>
    <blockquote>
     <p>
      笔者知识有限，如果发现本文有错误的地方欢迎批评、指正，若本文对您有所帮助，点赞、在看也是笔者坚持的动力；扫码关注公众号，后台回复 EC20模块获取EC20全套资料
     </p>
    </blockquote>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/1ff30a2b914a6e0e1a8498180fdfe2a1.gif"/>
    </p>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f34323936353733392f:61727469636c652f64657461696c732f313037313430363738" class_="artid" style="display:none">
 </p>
</div>


