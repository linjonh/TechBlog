---
layout: post
title: "网络-socket编程-udp_echo_server"
date: 2025-03-16 23:29:07 +0800
description: "socket编程--udp_echo_server编码详解"
keywords: "[网络] socket编程--udp_echo_server"
categories: ['未分类']
tags: ['网络协议', '网络', 'Udp']
artid: "146300036"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146300036
    alt: "网络-socket编程-udp_echo_server"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146300036
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146300036
cover: https://bing.ee123.net/img/rand?artid=146300036
image: https://bing.ee123.net/img/rand?artid=146300036
img: https://bing.ee123.net/img/rand?artid=146300036
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     [网络] socket编程--udp_echo_server
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-kimbie-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <p>
    </p>
    <p>
     好的, 今天我们开始写一个简单的网络代码. 整体代码难度不大, 不过我打算其中穿插着说一点基础知识, 整体可能就比较多了.
    </p>
    <h3>
     <a id="1_udp_echo_server_4">
     </a>
     1. udp_echo_server是个什么东西?
    </h3>
    <p>
     首先, 我们先来说一下
     <code>
      udp_echo_server
     </code>
     这个程序要做什么? 这个是我们开始学习网络的第一个编码实践, 所以说是很简单, 整体的功能是有两个端, 一端是客户端, 一端是服务端, 客户端每次向服务端发送数据, 服务端接受到后吧这个数据又发回客户端, 实现一个客户端数据回显的效果.
     <br/>
     然后这个程序使用的网络协议是
     <code>
      UDP协议
     </code>
     , 整体很简单.
    </p>
    <h3>
     <a id="2__7">
     </a>
     2. 初步文件构建.
    </h3>
    <p>
     我们先来简单预测一下有哪些文件?
     <br/>
     我打算:
    </p>
    <ul>
     <li>
      <code>
       UdpServer.hpp
      </code>
      服务端头文件
     </li>
     <li>
      <code>
       UdpServerMain.cc
      </code>
      服务端主函数
     </li>
     <li>
      <code>
       UdpClientMain.cc
      </code>
      客户端主函数
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/a3213ec3c44641618cfbd39b37fe955e.png">
       <br/>
       不过因为我们可能中间需要多次编译, 所以我们先写一个
       <code>
        makefile
       </code>
       脚本文件吧:
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/784015131c464aa8a81c444357a36c49.png">
        <br/>
        哎, 那有人可能会有疑问, 你这个用户端你咋不编译啊? 这是因为我们一上来先写服务端, 用户端等写完了我们再用make编译, 因为现在还没写嘛…
       </img>
      </img>
     </li>
    </ul>
    <p>
     好的, 下面我们开始编码吧.
    </p>
    <h3>
     <a id="3_nocopy_20">
     </a>
     3.
     <code>
      nocopy
     </code>
     服务器防止被拷贝
    </h3>
    <p>
     一般来说, 服务器程序是不会用到拷贝的, 因此为了防止其他人误写拷贝或者错误使用服务端的类, 我们写一个
     <code>
      nocopy
     </code>
     , 我们的服务端类可以继承这个类, 从而间接实现服务端不会被拷贝的一个效果.
    </p>
    <p>
     我花两分钟就编完了, 我把这个类的
     <strong>
      拷贝构造
     </strong>
     和
     <strong>
      赋值运算符重载函数
     </strong>
     直接
     <code>
      delete
     </code>
     掉了:
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1c9e148c1abf4eddab8d5391bfea14f1.png">
      <br/>
      那下面我们让
      <code>
       UdpServer.hpp
      </code>
      中的服务端继承一下:
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/dd6fdbd7f3564a789434fe7d9adee6c4.png">
       <br/>
       好的, 这样的话我们的
       <code>
        UdpServer
       </code>
       类就不能拷贝了…
      </img>
     </img>
    </p>
    <p>
     之后, 我们来构思一下我们的服务端主函数要实现什么功能?
     <br/>
     作为一个服务器, 应该先构建出一个服务类对象, 然后这个类对象需要先初始化, 然后启动起来进行服务.
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d3d9ea518680435a8b06d6a094c6b903.png">
      <br/>
      好的, 我们围绕这个实现功能, 我们来写一写服务端.
     </img>
    </p>
    <h3>
     <a id="4__32">
     </a>
     4. 创建套接字
    </h3>
    <p>
     一个程序要跨网络通信, 需要套接字, 即
     <code>
      socket
     </code>
     , 那我们来给我们的服务端写一个
     <strong>
      套接字
     </strong>
     . 套接字socket = ip + port, 实际上套接字就是一个整数, 一个文件描述符, 我们在网络编程的时候万物皆文件, 然后把这个文件和ip以及端口号绑定起来, 表示一个网络当中具有唯一性的进程, 这叫做
     <strong>
      套接字的作用
     </strong>
     .
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2436ae3733254948bbd99a3c68a381e1.png"/>
    </p>
    <p>
     这样就完成了吗? 显然没有啊兄弟, 这样你只是在栈上定义出来了一个类型, 一个空间而已, 系统中没有真正的文件的兄弟, 想要有真正的文件, 我们需要调用接口
     <code>
      socket
     </code>
     . 来, 让我们看看对应的接口介绍:
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/136cf0fe0b9a42e3bb25de3ff3526961.png">
      <br/>
      <br/>
      <mark>
       <font size="4">
        <strong>
         int socket(int domain, int type, int protocol);
        </strong>
       </font>
      </mark>
     </img>
    </p>
    <ul>
     <li>
      domain: 域, 用来指定该socket是网络通信还是本地通信.
      <ul>
       <li>
        AF_UNIX Local communication unix(7)
       </li>
       <li>
        AF_INET IPv4 Internet protocols ip(7)
       </li>
      </ul>
     </li>
     <li>
      type: 套接字类型
      <ul>
       <li>
        SOCK_DGRAM Supports datagrams (connectionless, unreliable messages of a fixed maximum length).
       </li>
      </ul>
     </li>
     <li>
      protocol 协议类型
      <ul>
       <li>
        因为我们前面指明了
        <code>
         AF_INET
        </code>
        和
        <code>
         SOCK_DGRAM
        </code>
        , 因此可以写0为默认.
       </li>
      </ul>
     </li>
     <li>
      返回值:
      <ul>
       <li>
        success 返回文件描述符
       </li>
       <li>
        失败, -1, 错误码被设置
       </li>
      </ul>
     </li>
    </ul>
    <p>
     好的, 所以我们写这样:
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5634940f761e40bda1149ba42680d59e.png"/>
     <br/>
     好的, 显然我们的exit是红色的, 所以我们把头文件给他包上.
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/6b16be8e911143d4843a92409c297318.png"/>
     <br/>
     好的, 我们再来考虑一下如果socket创建失败了? 那我们是不是需要终止这个进程呀? 因为文件命名符都要不过来了, 后面肯定是没办法继续的嘛. 如果socket创建成功了, 那么咱们就打印一个
     <code>
      std::cout &lt;&lt; "DEBUG :socket create success, _sockfd: " &lt;&lt; _sockfd &lt;&lt; std::endl;
     </code>
     用来当作debug信息. 我们预期这个sockfd是3, 为什么? 因为0是标准输入, 1是标准输出, 2是标准错误, 所以下一个系统肯定给咱们的程序分配一个3给到sockfd.
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/867a59b0507e4f35b5d253a1e58a490f.png"/>
    </p>
    <p>
     基于这个预测, 我们来测试一下.
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/7922dc9147344135a38d6cca9514ac40.png"/>
     <br/>
     看来是符合我们预期的, 那我们继续? 我们创建好了一个sockfd文件描述符, 但是我们的套接字已经弄好了吗?
     <br/>
     显然没有啊兄弟, 现在只是创建了这么一个文件和文件描述符而已, 咱们现在需要把这个sockfd关联上ip地址和prot.
     <br/>
     所以, 下一步是
     <code>
      bind
     </code>
     操作.
    </p>
    <h3>
     <a id="5_sockfd_bind_ip__port_64">
     </a>
     5. sockfd bind ip &amp; port
    </h3>
    <p>
     接下来我们继续写我们的bind操作哈. 我们先来看一下bind接口所需要的参数是啥?
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/3388d29fe21642a1af0f088ce0da7737.png"/>
    </p>
    <p>
     <br/>
     <font size="4">
      <strong>
       int bind(int sockfd, const struct sockaddr *addr, socklen_t addrlen);
      </strong>
     </font>
    </p>
    <ul>
     <li>
      sockfd: 套接字描述符
     </li>
     <li>
      sockaddr: 绑定的ip + port信息
     </li>
     <li>
      addrlen: 绑定的ip + port结构体的大小.
     </li>
     <li>
      返回值是如果失败返回-1, 错误码被设置, 成功返回0.
     </li>
    </ul>
    <p>
     所以, 我们可以get到, 我们绑定ip + port, 就需要用一个
     <code>
      struct sockaddr_in
     </code>
     类型的结构体给他套进去.
     <br/>
     请注意, 这个地方用的是
     <code>
      struct sockaddr_in
     </code>
     而非
     <code>
      struct sockaddr
     </code>
     , 这是一个类似于多态的接口,
     <code>
      struct sockaddr*
     </code>
     是一个通用指针, 然后
     <code>
      struct sockaddr_in
     </code>
     是专门用来处理网络通信的
     <code>
      ip
     </code>
     &amp;
     <code>
      port
     </code>
     等信息的结构体.
    </p>
    <p>
     我们来认识一下
     <code>
      struct sockaddr_in
     </code>
     这个结构体:
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/63857512b82244f78cede2abbd97726f.png"/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/c45070b89a794173a5f8eb22fc831f9f.png"/>
    </p>
    <p>
     不过好像有个小问题啊? 咋有个"不允许使用不完整的类型"的报错呢? 这是因为没有包头文件, 我们查找一下对应的头文件.
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/1ce59f8465a944bd954b4e2200585d82.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/03bb992ec0a24a43ab19e30b6ad624b7.png"/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/313d23dc2308405e861f181a843e2fbc.png"/>
    </p>
    <p>
     上面这个地方需要额外注意, 就是我们在填充
     <code>
      sockadd_in
     </code>
     类型的时候, 我们这个类型中的数据将来是要发到网络当中的, 所以需要把主机字节序转换成网络字节序. 说白了就是大小端问题.
     <br/>
     其中, 对于ip地址, 需要把ip地址从字符串形式转换成4字节的形式, 然后再转成网络字节序, 对于port, 需要转网络字节序.
     <br/>
     自己做这个工作很麻烦, 还需要判断大小端, 然后再进行转换, 我们有对应的库函数去做这个事情, 转ip:
     <code>
      inet_addr()
     </code>
     以及 转port:
     <code>
      htons()
     </code>
     .
     <br/>
     下面是两个接口的截图:
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b3d6c508526048aeb7feb7fe9f7ea872.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/cf8c90eb8a564b9db61a40de562d3526.png"/>
     <br/>
     但是代码中
     <code>
      local.sin_family = AF_INET;
     </code>
     是啥玩意呢? 是一个标志位, 用来标识
     <code>
      struct sockaddr_in
     </code>
     是将来用来网络通信的还是本地进程通信的.
     <code>
      AF_INET
     </code>
     标识是网络通信.
    </p>
    <p>
     那到这里是绑定成功了吗? 没有啊兄弟, 我们只是填充好了一个在用户栈上的一个变量而已, 下面开始绑定, 把sockfd 与 对应的ip和port绑定起来.
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/03ee595e33dd4a98a75d7a0016b4691e.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d642c1df8748479ebb4f177283f9fc6d.png"/>
     <br/>
     咱们来解释一下为啥用ip -&gt; "127.0.0.1"来进行测试, 这个是因为这个ip比较特殊, 是一个本地回环, 就是在本主机内部通讯的ip地址, 用这个ip如果通过了, 则证明我们的软件内部是没问题的, 再上线网络, 如果这个都过不了, 则问题一定在软件内部.
     <br/>
     然后, 我们运行测试一下:
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/82b77afe28dc445aa8787fc6c7f931aa.png"/>
     <br/>
     看来没啥大问题哈, 我们看来是绑定成功了.
     <br/>
     所以呢, 我们创建套接字然后绑定完了ip和port, 这才算是为网络通信做了铺垫, 下面我们得开始写我们的服务逻辑了.
    </p>
    <h3>
     <a id="6_start__102">
     </a>
     6. start 开始服务
    </h3>
    <p>
     首先搞明白一个问题, 就是服务器是个啥玩意? 这个东西是一个24小时不断运行的死循环代码. 所以我们的进程一旦开始, 就不会主动退出.
     <br/>
     所以我们的
     <code>
      Start()
     </code>
     逻辑应该是这样的:
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e93e828a7ba6434c9a15b3f1c7b651b3.png"/>
    </p>
    <p>
     写到这里, 我们需要想我们的服务器要干嘛的? 接受数据包, 然后把这个数据包扔回客户端的!
     <br/>
     要接受数据包, 需要用接口 -&gt;
     <code>
      recvfrom()
     </code>
     , 这个地方咋不是
     <code>
      read()
     </code>
     呢? 因为UDP协议是面向数据报的, 而非字节流的.
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5b257d69368548cf91974d29bbf4679f.png"/>
     <br/>
     我们来简单介绍一下这个
     <code>
      recvfrom()
     </code>
     接口.
    </p>
    <ul>
     <li>
      sockfd: sockfd.
     </li>
     <li>
      buf: 缓冲区
     </li>
     <li>
      len: 缓冲区大小
     </li>
     <li>
      flags: 接受标识符, (0是阻塞接受)
     </li>
     <li>
      src_addr: 输入输出参数, 用来保存接收到的数据报的客户端信息.
     </li>
     <li>
      addrlen: 输入输出参数, 用来保存接收到的数据报的客户端信息的大小.
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ae7fbe1867ce4f82bd412045dd6985a5.png"/>
     <br/>
     我们拿到了数据呢? 之后我们是不是要在服务器端打印一下, 看看是不是真的拿到了, 然后再构造一个返回给客户端的数据? 如果n &lt;= 0, 咱们直接
     <code>
      std::cout &lt;&lt; "recvfrom , error" &lt;&lt; std::endl; // debug 信息.
     </code>
     即可.
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/950eb22235cd4a6081c231c697901aa1.png"/>
     <br/>
     好的, 我们大体逻辑写好了吧? 然后把析构写一下:
     <font color="ff0000">
      要记得关掉文件描述符.
     </font>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/16c3b62985194a5983a3061a6d49ea77.png"/>
     <br/>
     我们现在可以测试吗? 不能啊兄弟, 没有客户端怎么测试呢? 我们先快速写一个客户端代码出来:
    </p>
    <h3>
     <a id="7__125">
     </a>
     7. 编码客户端
    </h3>
    <p>
     我们的客户端也需要跨网络发数据吧? 所以, 也是第一步弄一个
     <code>
      sockfd
     </code>
     .
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/b005d5de4e1843e7a7c4bda7c541126b.png"/>
     <br/>
     然后呢, 我们要发给服务器, 所以我们需要提前"内置"好服务器的套接字吧?
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/78672b37759549acb99977c7b4f1ff6c.png"/>
     <br/>
     这个地方需要注意, 我们的客户端是不需要绑定端口号的ip地址的, 为啥呢? 为啥服务端需要绑定端口号和ip地址, 而我们的客户端不需要绑定端口号和ip地址?
     <br/>
     兄弟, 你想想看啊, 服务器在公司手里, 服务端是运行在服务器上的, 一般一个主机上是只运行那个服务的, 所以端口号基本不会改变嘛, 但是客户端呢? 运行在用户的手机上吧? 用户开多少个应用你知道吗? 你不知道, 那有没有各种应用的端口号如果让程序员指定会不会冲突呢? 肯定会啊, 所以说客户端让用户的OS分配就好了, 程序员是不需要明确写的.
     <br/>
     那, 有人可能会有疑问, 那么服务器怎么找到用户的用户端呢? 首先, 是客户端先给服务器发消息, 第二就是服务器拿到消息之后, 就会拿到这次客户端的具体ip地址和port.
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e7cc6d8fbf8648338f3a611266d54d71.png"/>
    </p>
    <p>
     所以, 我们的客户端应该不断发消息, 所以写一个循环嘛, 然后发成功了, 就阻塞等待接受消息, 如果收到了, 咱们就打印一遍(回显), 如果接受失败, 就break出去. 如果一上来就没发成功, 我们也是break, 然后打个提示信息, 好找错误.
    </p>
    <p>
     我们测试一下吧?
     <br/>
     不过, 我们先把makefile在写一下, 因为现在是一个客户端和一个服务端同时编译了.
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bbea5d38bc3f44d9b53f7f224557ccfa.png"/>
     <br/>
     输入:
     <code>
      netstat -aupn
     </code>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/63a0b44ce0ef47a29df7e43bc3d375b1.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9baeb7d2cb1b45289cce18c97b40d74a.png"/>
     <br/>
     看来好像是能跑了~
    </p>
    <p>
     但是, 还是稍微存在一点细节的, 下面来进行细说:
    </p>
    <h3>
     <a id="8_ip0pi_147">
     </a>
     8. 服务端ip应该绑0号pi.
    </h3>
    <p>
     实际上, 我们的服务端是由很多ip地址的, 有内网, 有公网, 我们尝试用客户端以内网的形式发送信息给服务端.
    </p>
    <p>
     我们看一下这台机器的内网ip:
     <br/>
     在linux机器上输入:
     <code>
      ifconfig
     </code>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/911bfd1c39f844a8a736676d991931c4.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5834325a62864bd18d3497a3f64a2538.png"/>
     <br/>
     我们启动一下看一下结果:
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/d79ff834e0bc4a1ab9c41dccd189f84d.png"/>
     <br/>
     这是为啥呢? 因为我们的服务端绑定的不是内网啊, 服务端有很多个ip, 但是只能通过绑定的ip给他发信息, 是不太好的, 我们希望服务端的任何ip的数据包都可以被拿到. 所以:
     <br/>
     我们给服务端绑定ip地址为0号ip(0.0.0.0). 看来我们需要修改一下代码:
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/279f16f9f4234da49de82c5c3aadffde.png"/>
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/100113e4dc2e4110bc371886ab0d9cb6.png"/>
    </p>
    <h3>
     <a id="9__163">
     </a>
     9. 加入日志
    </h3>
    <p>
     为了输入一些debug和error信息比较方便, 我们可以写一个日志加进去, 之前是写好的了, 所以我们直接CV到代码里就好了.
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/35356c4369874d56ba10df9f15c7b233.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/59e1c868f28b4bedb2749be6fdb06a33.png"/>
     <br/>
     我们再来看一下效果:
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f7e76f5bbb514f559b84b05b834909b6.png"/>
    </p>
    <p>
     然后我们还可以把那个ip + port封装起来, 可以让他自动转为主机序列, 而不用在外面转换.
    </p>
    <h3>
     <a id="10_ip__port_171">
     </a>
     10. 封装ip + port类
    </h3>
    <p>
     // InetAddr.hpp
    </p>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">InetAddr</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">ToHost</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _ip <span class="token operator">=</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">InetAddr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">_addr</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">ToHost</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token double-colon punctuation">::</span>string <span class="token function">Ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> _ip<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">uint16_t</span> <span class="token function">Port</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> _port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">InetAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>string _ip<span class="token punctuation">;</span>
    <span class="token keyword">uint16_t</span> _port<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> _addr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     我们把封装好的这个ip + port弄到服务端代码中去:
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/bc95a92b3fcd4ef390929fb0e08b7df5.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/87ee05e14dec49179feec78cba7f7585.png"/>
     <br/>
     好的, 终于差不多了, 当然也有一些细节是没有处理好的, 或者说想要处理好细节, 还需要很多代码进行补充, 这次只是一个练习, 也就不求甚解了~
    </p>
    <h3>
     <a id="11_reference_code_221">
     </a>
     11. reference code
    </h3>
    <h4>
     <a id="UdpServerhpp_222">
     </a>
     UdpServer.hpp
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"nocopy.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span> <span class="token comment">// 主要 socket 函数和类型</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"LockGuard.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Log.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"InetAddr.hpp"</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> log_ns<span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> gsockfd <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> glocalport <span class="token operator">=</span> <span class="token number">8899</span><span class="token punctuation">;</span>
<span class="token keyword">enum</span>
<span class="token punctuation">{<!-- --></span>
    SOCKET_ERROR <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
    BIND_ERROR
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">UdpServer</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">nocopy</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">UdpServer</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string localip<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_sockfd</span><span class="token punctuation">(</span>gsockfd<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_localport</span><span class="token punctuation">(</span>glocalport<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">/*_localip(localip),*/</span> <span class="token function">_isrunning</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建sockfd文件</span>
        _sockfd <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_sockfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// std::cout &lt;&lt; "FATAL: socket error" &lt;&lt; std::endl;</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">,</span> <span class="token string">"socket error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>SOCKET_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// std::cout &lt;&lt; "DEBUG :socket create success, _sockfd: " &lt;&lt; _sockfd &lt;&lt; std::endl; // 3"</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">,</span> <span class="token string">"socket create success, _sockfd: %d\n"</span><span class="token punctuation">,</span> _sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 3</span>

        <span class="token comment">// bind ip &amp; port</span>
        <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> local<span class="token punctuation">;</span>
        <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>local<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>sockaddr_in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        local<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
        <span class="token comment">/*local.sin_addr.s_addr = inet_addr(_localip.c_str());*/</span>
        local<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> INADDR_ANY<span class="token punctuation">;</span> <span class="token comment">// 服务器端，进行任意IP地址绑定, INADDR_ANY -&gt; 0, 表示绑定任意端口号</span>
        local<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span>_localport<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">bind</span><span class="token punctuation">(</span>_sockfd<span class="token punctuation">,</span> <span class="token punctuation">(</span>sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>local<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>local<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// std::cout &lt;&lt; "FATAL, bind error" &lt;&lt; std::endl;</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">,</span> <span class="token string">"bind error\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>BIND_ERROR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// std::cout &lt;&lt; "DEBUG, socket bind success" &lt;&lt; std::endl;</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">,</span> <span class="token string">"socket bind success\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _isrunning <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> inbuffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> peer<span class="token punctuation">;</span>
        socklen_t len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>_isrunning<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span>_sockfd<span class="token punctuation">,</span> inbuffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>inbuffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>sockaddr <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>peer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 转换成主机序列</span>
                InetAddr <span class="token function">addr</span><span class="token punctuation">(</span>peer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// uint16_t _port = ntohs(peer.sin_port);</span>
                <span class="token comment">// std::string _ip = inet_ntoa(peer.sin_addr);</span>
                inbuffer<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token comment">// std::cout &lt;&lt; "[" &lt;&lt; _ip &lt;&lt; ":" &lt;&lt; _port &lt;&lt; "]# " &lt;&lt; inbuffer &lt;&lt; std::endl; // 打印一下消息</span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"["</span> <span class="token operator">&lt;&lt;</span> addr<span class="token punctuation">.</span><span class="token function">Ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">":"</span> <span class="token operator">&lt;&lt;</span> addr<span class="token punctuation">.</span><span class="token function">Port</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"]# "</span> <span class="token operator">&lt;&lt;</span> inbuffer <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// 打印一下消息</span>

                <span class="token comment">// 制造要发给客户端的数据</span>
                std<span class="token double-colon punctuation">::</span>string echo_string <span class="token operator">=</span> <span class="token string">"[udp_server echo] #"</span><span class="token punctuation">;</span>
                echo_string <span class="token operator">+=</span> inbuffer<span class="token punctuation">;</span>
                <span class="token function">sendto</span><span class="token punctuation">(</span>_sockfd<span class="token punctuation">,</span> echo_string<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> echo_string<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>peer<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"recvfrom ,  error"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// debug 信息.</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">UdpServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>_sockfd <span class="token operator">&gt;</span> gsockfd<span class="token punctuation">)</span>
            <span class="token double-colon punctuation">::</span><span class="token function">close</span><span class="token punctuation">(</span>_sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">int</span> _sockfd<span class="token punctuation">;</span>
    <span class="token keyword">uint16_t</span> _localport<span class="token punctuation">;</span>
    <span class="token comment">// std::string _localip;</span>
    <span class="token keyword">bool</span> _isrunning<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="UdpServerMaincc_327">
     </a>
     UdpServerMain.cc
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">"UdpServer.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;memory&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>UdpServer<span class="token operator">&gt;</span> usvr <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>UdpServer<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//C++14的标准</span>
    usvr<span class="token operator">-&gt;</span><span class="token function">InitServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    usvr<span class="token operator">-&gt;</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="UdpClientMaincc_341">
     </a>
     UdpClientMain.cc
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> sockfd <span class="token operator">=</span> <span class="token double-colon punctuation">::</span><span class="token function">socket</span><span class="token punctuation">(</span>AF_INET<span class="token punctuation">,</span> SOCK_DGRAM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sockfd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>cerr <span class="token operator">&lt;&lt;</span> <span class="token string">"create socket error"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 客户端的socket文件会自动绑定ip地址和端口号, 我们无需关心</span>

    <span class="token comment">// 你要发给谁?</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> server<span class="token punctuation">;</span>
    <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>server<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>sin_family <span class="token operator">=</span> AF_INET<span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>sin_port <span class="token operator">=</span> <span class="token function">htons</span><span class="token punctuation">(</span><span class="token number">8899</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span>sin_addr<span class="token punctuation">.</span>s_addr <span class="token operator">=</span> <span class="token function">inet_addr</span><span class="token punctuation">(</span><span class="token string">"10.0.16.4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 让用户输入信息</span>
        std<span class="token double-colon punctuation">::</span>string line<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Please Enter# "</span><span class="token punctuation">;</span>
        std<span class="token operator">:</span><span class="token function">getline</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>cin<span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 发消息</span>
        <span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token function">sendto</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> line<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> line<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>server<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 收消息</span>
            <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> temp<span class="token punctuation">;</span>
            socklen_t len <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 缓冲区</span>
            <span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token function">recvfrom</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">,</span> buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>temp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>m <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                buffer<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// 写好字符串截至的位置</span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> buffer <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"recvfrom error"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span> <span class="token comment">// debug</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token comment">// 没有发送出去</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"sendto error"</span> <span class="token operator">&lt;&lt;</span> std<span class="token double-colon punctuation">::</span>endl<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token double-colon punctuation">::</span><span class="token function">close</span><span class="token punctuation">(</span>sockfd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <h4>
     <a id="nocopyhpp_407">
     </a>
     nocopy.hpp
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token keyword">class</span> <span class="token class-name">nocopy</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">nocopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">nocopy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token function">nocopy</span><span class="token punctuation">(</span><span class="token keyword">const</span> nocopy<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> nocopy<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> nocopy<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="Loghpp_420">
     </a>
     Log.hpp
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ctime&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdarg&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstring&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"LockGuard.hpp"</span></span>

<span class="token keyword">namespace</span> log_ns
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">enum</span>
    <span class="token punctuation">{<!-- --></span>
        DEBUG <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
        INFO<span class="token punctuation">,</span>
        WARNING<span class="token punctuation">,</span>
        ERROR<span class="token punctuation">,</span>
        FATAL
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>string <span class="token function">LevelToString</span><span class="token punctuation">(</span><span class="token keyword">int</span> level<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>level<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> DEBUG<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"DEBUG"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> INFO<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"INFO"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> WARNING<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"WARNING"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> ERROR<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"ERROR"</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> FATAL<span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"FATAL"</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token string">"UNKNOWN"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    std<span class="token double-colon punctuation">::</span>string <span class="token function">GetCurrTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        time_t now <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">tm</span> <span class="token operator">*</span>curr_time <span class="token operator">=</span> <span class="token function">localtime</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">char</span> buffer<span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%d-%02d-%02d %02d:%02d:%02d"</span><span class="token punctuation">,</span>
                 curr_time<span class="token operator">-&gt;</span>tm_year <span class="token operator">+</span> <span class="token number">1900</span><span class="token punctuation">,</span>
                 curr_time<span class="token operator">-&gt;</span>tm_mon <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>
                 curr_time<span class="token operator">-&gt;</span>tm_mday<span class="token punctuation">,</span>
                 curr_time<span class="token operator">-&gt;</span>tm_hour<span class="token punctuation">,</span>
                 curr_time<span class="token operator">-&gt;</span>tm_min<span class="token punctuation">,</span>
                 curr_time<span class="token operator">-&gt;</span>tm_sec<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">class</span> <span class="token class-name">logmessage</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        std<span class="token double-colon punctuation">::</span>string _level<span class="token punctuation">;</span>
        pid_t _id<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string _filename<span class="token punctuation">;</span>
        <span class="token keyword">int</span> _filenumber<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string _curr_time<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string _message_info<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SCREEN_TYPE</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">FILE_TYPE</span> <span class="token expression"><span class="token number">2</span></span></span>

    <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string glogfile <span class="token operator">=</span> <span class="token string">"./log.txt"</span><span class="token punctuation">;</span>
    pthread_mutex_t glock <span class="token operator">=</span> PTHREAD_MUTEX_INITIALIZER<span class="token punctuation">;</span>

    <span class="token comment">// log.logMessage("", 12, INFO, "this is a %d message ,%f, %s hellwrodl", x, , , );</span>
    <span class="token keyword">class</span> <span class="token class-name">Log</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Log</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string <span class="token operator">&amp;</span>logfile <span class="token operator">=</span> glogfile<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">_logfile</span><span class="token punctuation">(</span>logfile<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">_type</span><span class="token punctuation">(</span>SCREEN_TYPE<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">Enable</span><span class="token punctuation">(</span><span class="token keyword">int</span> type<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _type <span class="token operator">=</span> type<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">FlushLogToScreen</span><span class="token punctuation">(</span><span class="token keyword">const</span> logmessage <span class="token operator">&amp;</span>lg<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"[%s][%d][%s][%d][%s] %s"</span><span class="token punctuation">,</span>
                   lg<span class="token punctuation">.</span>_level<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   lg<span class="token punctuation">.</span>_id<span class="token punctuation">,</span>
                   lg<span class="token punctuation">.</span>_filename<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   lg<span class="token punctuation">.</span>_filenumber<span class="token punctuation">,</span>
                   lg<span class="token punctuation">.</span>_curr_time<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                   lg<span class="token punctuation">.</span>_message_info<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">FlushLogToFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> logmessage <span class="token operator">&amp;</span>lg<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>ofstream <span class="token function">out</span><span class="token punctuation">(</span>_logfile<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>ios<span class="token double-colon punctuation">::</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>out<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> logtxt<span class="token punctuation">[</span><span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">snprintf</span><span class="token punctuation">(</span>logtxt<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>logtxt<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"[%s][%d][%s][%d][%s] %s"</span><span class="token punctuation">,</span>
                     lg<span class="token punctuation">.</span>_level<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     lg<span class="token punctuation">.</span>_id<span class="token punctuation">,</span>
                     lg<span class="token punctuation">.</span>_filename<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     lg<span class="token punctuation">.</span>_filenumber<span class="token punctuation">,</span>
                     lg<span class="token punctuation">.</span>_curr_time<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     lg<span class="token punctuation">.</span>_message_info<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>logtxt<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span>logtxt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">FlushLog</span><span class="token punctuation">(</span><span class="token keyword">const</span> logmessage <span class="token operator">&amp;</span>lg<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 加过滤逻辑 --- TODO</span>

            LockGuard <span class="token function">lockguard</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>glock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>_type<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> SCREEN_TYPE<span class="token operator">:</span>
                <span class="token function">FlushLogToScreen</span><span class="token punctuation">(</span>lg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> FILE_TYPE<span class="token operator">:</span>
                <span class="token function">FlushLogToFile</span><span class="token punctuation">(</span>lg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">void</span> <span class="token function">logMessage</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>string filename<span class="token punctuation">,</span> <span class="token keyword">int</span> filenumber<span class="token punctuation">,</span> <span class="token keyword">int</span> level<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            logmessage lg<span class="token punctuation">;</span>

            lg<span class="token punctuation">.</span>_level <span class="token operator">=</span> <span class="token function">LevelToString</span><span class="token punctuation">(</span>level<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lg<span class="token punctuation">.</span>_id <span class="token operator">=</span> <span class="token function">getpid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lg<span class="token punctuation">.</span>_filename <span class="token operator">=</span> filename<span class="token punctuation">;</span>
            lg<span class="token punctuation">.</span>_filenumber <span class="token operator">=</span> filenumber<span class="token punctuation">;</span>
            lg<span class="token punctuation">.</span>_curr_time <span class="token operator">=</span> <span class="token function">GetCurrTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            va_list ap<span class="token punctuation">;</span>
            <span class="token function">va_start</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">char</span> log_info<span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">vsnprintf</span><span class="token punctuation">(</span>log_info<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>log_info<span class="token punctuation">)</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">va_end</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lg<span class="token punctuation">.</span>_message_info <span class="token operator">=</span> log_info<span class="token punctuation">;</span>

            <span class="token comment">// 打印出来日志</span>
            <span class="token function">FlushLog</span><span class="token punctuation">(</span>lg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token operator">~</span><span class="token function">Log</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">int</span> _type<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span>string _logfile<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    Log lg<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG</span><span class="token expression"><span class="token punctuation">(</span>Level<span class="token punctuation">,</span> Format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>                                        </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">do</span>                                                                 </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">{<!-- --></span>                                                                  </span><span class="token punctuation">\</span>
        <span class="token expression">lg<span class="token punctuation">.</span><span class="token function">logMessage</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">,</span> Level<span class="token punctuation">,</span> Format<span class="token punctuation">,</span> </span><span class="token punctuation">##</span><span class="token expression">__VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EnableScreen</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">do</span>                          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">{<!-- --></span>                           </span><span class="token punctuation">\</span>
        <span class="token expression">lg<span class="token punctuation">.</span><span class="token function">Enable</span><span class="token punctuation">(</span>SCREEN_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">EnableFILE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>          </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">do</span>                        </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">{<!-- --></span>                         </span><span class="token punctuation">\</span>
        <span class="token expression">lg<span class="token punctuation">.</span><span class="token function">Enable</span><span class="token punctuation">(</span>FILE_TYPE<span class="token punctuation">)</span><span class="token punctuation">;</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="LockGuardhpp_598">
     </a>
     LockGuard.hpp
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;pthread.h&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">LockGuard</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">LockGuard</span><span class="token punctuation">(</span>pthread_mutex_t <span class="token operator">*</span>mutex<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">_mutex</span><span class="token punctuation">(</span>mutex<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_lock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">LockGuard</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_mutex_unlock</span><span class="token punctuation">(</span>_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    pthread_mutex_t <span class="token operator">*</span>_mutex<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="InetAddrhpp_620">
     </a>
     InetAddr.hpp
    </h4>
    <pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sys/socket.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;arpa/inet.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;netinet/in.h&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">InetAddr</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">ToHost</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        _port <span class="token operator">=</span> <span class="token function">ntohs</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sin_port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        _ip <span class="token operator">=</span> <span class="token function">inet_ntoa</span><span class="token punctuation">(</span>addr<span class="token punctuation">.</span>sin_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">InetAddr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> <span class="token operator">&amp;</span>addr<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">_addr</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">ToHost</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    std<span class="token double-colon punctuation">::</span>string <span class="token function">Ip</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> _ip<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">uint16_t</span> <span class="token function">Port</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> _port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">~</span><span class="token function">InetAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    std<span class="token double-colon punctuation">::</span>string _ip<span class="token punctuation">;</span>
    <span class="token keyword">uint16_t</span> _port<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sockaddr_in</span> _addr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="makefile_664">
     </a>
     makefile
    </h4>
    <pre><code class="prism language-cpp"><span class="token punctuation">.</span>PHONT<span class="token operator">:</span> all
all<span class="token operator">:</span> udpserver udpclient

udpserver<span class="token operator">:</span> UdpServerMain<span class="token punctuation">.</span>cc
	g<span class="token operator">++</span> <span class="token operator">-</span>o $@ $<span class="token operator">^</span> <span class="token operator">-</span>std<span class="token operator">=</span>c<span class="token operator">++</span><span class="token number">14</span>
udpclient<span class="token operator">:</span> UdpClientMain<span class="token punctuation">.</span>cc
	g<span class="token operator">++</span> <span class="token operator">-</span>o $@ $<span class="token operator">^</span> <span class="token operator">-</span>std<span class="token operator">=</span>c<span class="token operator">++</span><span class="token number">14</span>
<span class="token punctuation">.</span>PHONY<span class="token operator">:</span>clean
clean<span class="token operator">:</span>
	rm <span class="token operator">-</span>rf udpserver udpclient
</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f:672e6373646e2e6e65742f323330325f37393033313634362f:61727469636c652f64657461696c732f313436333030303336" class_="artid" style="display:none">
 </p>
</div>


