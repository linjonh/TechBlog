---
arturl_encode: "68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34333139373338302f:61727469636c652f64657461696c732f313436323438343433"
layout: post
title: "CQt-æ§½å‡½æ•°æ”¶ä¸åˆ°ä¿¡å·é—®é¢˜ä¿¡å·çš„æ³¨å†Œ"
date: 2025-03-14 13:02:32 +08:00
description: "å¦‚æœä¿¡å·å‚æ•°æ˜¯ã€‚"
keywords: "[C++&Qt] æ§½å‡½æ•°æ”¶ä¸åˆ°ä¿¡å·é—®é¢˜ï¼ˆä¿¡å·çš„æ³¨å†Œï¼‰"
categories: ['Qt', 'Gui']
tags: ['æ•°æ®åº“', 'Qt', 'C']
artid: "146248443"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146248443
    alt: "CQt-æ§½å‡½æ•°æ”¶ä¸åˆ°ä¿¡å·é—®é¢˜ä¿¡å·çš„æ³¨å†Œ"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146248443
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146248443
cover: https://bing.ee123.net/img/rand?artid=146248443
image: https://bing.ee123.net/img/rand?artid=146248443
img: https://bing.ee123.net/img/rand?artid=146248443
---

# [C++&Qt] æ§½å‡½æ•°æ”¶ä¸åˆ°ä¿¡å·é—®é¢˜ï¼ˆä¿¡å·çš„æ³¨å†Œï¼‰

> * ğŸ“¢åšå®¢ä¸»é¡µï¼š
>   [https://loewen.blog.csdn.net](https://blog.csdn.net/weixin_43197380)
> * ğŸ“¢æ¬¢è¿ç‚¹èµ ğŸ‘ æ”¶è— â­ç•™è¨€ ğŸ“ å¦‚æœ‰é”™è¯¯æ•¬è¯·æŒ‡æ­£ï¼
> * ğŸ“¢æœ¬æ–‡ç”±
>   ä¸¶å¸ƒå¸ƒ
>   åŸåˆ›ï¼Œé¦–å‘äº CSDNï¼Œ
>   è½¬è½½æ³¨æ˜å‡ºå¤„
>   ğŸ™‰
> * ğŸ“¢ç°åœ¨çš„ä»˜å‡ºï¼Œéƒ½ä¼šæ˜¯ä¸€ç§æ²‰æ·€ï¼Œåªä¸ºè®©ä½ æˆä¸ºæ›´å¥½çš„äººâœ¨

---

---

#### ä¸€. éœ€è¦æ³¨å†Œä¿¡å·å‚æ•°çš„æƒ…å†µ

**1ã€è·¨çº¿ç¨‹çš„ä¿¡å·æ§½è¿æ¥ï¼ˆä½¿ç”¨ QueuedConnectionï¼‰**

å½“ä¿¡å·å’Œæ§½ä½äºä¸åŒçº¿ç¨‹ï¼Œä¸”è¿æ¥æ–¹å¼ä¸º
`Qt::QueuedConnection`
æˆ–
`Qt::BlockingQueuedConnection`
æ—¶ï¼Œ
å‚æ•°ç±»å‹å¿…é¡»æ³¨å†Œ
ã€‚

åŸå› ï¼šè·¨çº¿ç¨‹é€šä¿¡æ—¶ï¼ŒQt éœ€è¦å°†å‚æ•°åºåˆ—åŒ–åˆ°æ¥æ”¶çº¿ç¨‹çš„äº‹ä»¶é˜Ÿåˆ—ä¸­ï¼Œè¿™è¦æ±‚ç±»å‹å¿…é¡»èƒ½è¢« Qt çš„å…ƒå¯¹è±¡ç³»ç»Ÿè¯†åˆ«ã€‚

**2ã€ä½¿ç”¨ QVariant ä¼ é€’è‡ªå®šä¹‰ç±»å‹**

å¦‚æœä¿¡å·å‚æ•°æ˜¯
`è‡ªå®šä¹‰ç±»å‹`
ï¼Œä¸”éœ€è¦ä¸
`QVariant`
ç»“åˆä½¿ç”¨ï¼Œå¿…é¡»æ³¨å†Œç±»å‹ã€‚

---

#### äºŒ. ä¸æ³¨å†Œå¯èƒ½å¼•å‘çš„é—®é¢˜

**1ã€è¿è¡Œæ—¶è­¦å‘Šæˆ–é”™è¯¯**

å¦‚æœæœªæ³¨å†Œè‡ªå®šä¹‰ç±»å‹ï¼Œ
`Qt`
ä¼šåœ¨è¿è¡Œæ—¶è¾“å‡ºç±»ä¼¼ä»¥ä¸‹è­¦å‘Šï¼š

```cpp
QObject::connect: Cannot queue arguments of type 'MyCustomType'
(Make sure 'MyCustomType' is registered using qRegisterMetaType().)

```

**åæœ**
ï¼šè·¨çº¿ç¨‹çš„ä¿¡å·æ§½è°ƒç”¨ä¼šå¤±è´¥ï¼Œæ§½å‡½æ•°ä¸ä¼šæ‰§è¡Œï¼Œç¨‹åºå¯èƒ½æ— å“åº”æˆ–å´©æºƒã€‚

**2ã€å‚æ•°æ— æ³•æ­£ç¡®ä¼ é€’**

æœªæ³¨å†Œçš„ç±»å‹æ— æ³•è¢« Qt åºåˆ—åŒ–/ååºåˆ—åŒ–ï¼Œå¯¼è‡´æ§½å‡½æ•°æ¥æ”¶åˆ°çš„å‚æ•°æ˜¯æ— æ•ˆæˆ–æœªåˆå§‹åŒ–çš„å€¼ã€‚

**3ã€æ— æ³•ä¸ QVariant äº¤äº’**

è‡ªå®šä¹‰ç±»å‹æ— æ³•é€šè¿‡
`QVariant`
å­˜å‚¨æˆ–ä¼ é€’ï¼Œå¯¼è‡´ç›¸å…³åŠŸèƒ½ï¼ˆå¦‚å±æ€§ç³»ç»Ÿã€æ¨¡å‹/è§†å›¾ï¼‰å¤±æ•ˆã€‚

---

#### ä¸‰. å¦‚ä½•æ³¨å†Œè‡ªå®šä¹‰ç±»å‹

**1ã€ä½¿ç”¨ Q_DECLARE_METATYPE å®**

```cpp
#include <QMetaType>

// è‡ªå®šä¹‰ç±»å‹å®šä¹‰
struct MyCustomType {
    int id;
    QString name;
};

// å£°æ˜å…ƒç±»å‹æ”¯æŒï¼ˆæ”¾åœ¨å¤´æ–‡ä»¶æœ«å°¾ï¼‰
Q_DECLARE_METATYPE(MyCustomType)

```

**æ³¨**
ï¼š
**Q_DECLARE_METATYPE çš„ä½œç”¨**

1ï¼‰ç¼–è¯‘æ—¶å…ƒä¿¡æ¯ç”Ÿæˆ

**Q_DECLARE_METATYPE**
å®ä¼šä¸ºç±»å‹ç”Ÿæˆç¼–è¯‘æ—¶çš„å…ƒä¿¡æ¯ï¼ˆå¦‚ç±»å‹åç§°ã€å¤§å°ã€å¯¹é½æ–¹å¼ç­‰ï¼‰ï¼Œä½¿å¾—ä»¥ä¸‹åŠŸèƒ½å¯ç”¨ï¼š

* `QVariant`
  çš„æ„é€ å’Œç±»å‹è½¬æ¢ï¼ˆä¾‹å¦‚
  `QVariant::fromValue å’Œ QVariant::value`
  ï¼‰ã€‚
* ç±»å‹åœ¨æ¨¡æ¿å’Œå®ä¸­çš„é™æ€è¯†åˆ«ï¼ˆä¾‹å¦‚
  `QMetaType`
  çš„é™æ€æ¥å£ï¼‰ã€‚

2ï¼‰éšå¼è¦æ±‚

å¦‚æœæœªä½¿ç”¨
**Q_DECLARE_METATYPE**
ï¼Œå³ä½¿é€šè¿‡
`qRegisterMetaType`
æ³¨å†Œäº†ç±»å‹ï¼Œä»¥ä¸‹æ“ä½œå¯èƒ½å¤±è´¥ï¼š

```cpp
MyCustomType data;
QVariant variant = QVariant::fromValue(data); // ç¼–è¯‘é”™è¯¯ï¼

```

**2ã€ä½¿ç”¨ qRegisterMetaType æ³¨å†Œç±»å‹**

åœ¨ç¨‹åºå¯åŠ¨æ—¶ï¼ˆå¦‚ main å‡½æ•°ã€æ„é€ å‡½æ•°ç­‰ä¸­ï¼‰æ³¨å†Œç±»å‹ï¼š

```cpp
#include <QMetaType>

int main(int argc, char *argv[]) {
    QApplication app(argc, argv);

    // æ³¨å†Œè‡ªå®šä¹‰ç±»å‹
    qRegisterMetaType<MyCustomType>("MyCustomType");

    // å¦‚æœç±»å‹æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œå¯ä»¥ç®€å†™ä¸ºï¼š
    qRegisterMetaType<MyCustomType>();

    return app.exec();
}

```

---

#### å››. ç¤ºä¾‹ï¼šè·¨çº¿ç¨‹ä¿¡å·æ§½çš„æ­£ç¡®ç”¨æ³•

```cpp
// è‡ªå®šä¹‰ç±»å‹
struct MyCustomType {
    int id;
    QString name;
};
Q_DECLARE_METATYPE(MyCustomType)

// å‘é€è€…ç±»
class Sender : public QObject {
    Q_OBJECT
public:
    void sendData() {
        MyCustomType data{1, "Test"};
        emit signalData(data); // å‘é€ä¿¡å·
    }
signals:
    void signalData(const MyCustomType& data);
};

// æ¥æ”¶è€…ç±»
class Receiver : public QObject {
    Q_OBJECT
public slots:
    void onDataReceived(const MyCustomType& data) {
        qDebug() << "Received:" << data.id << data.name;
    }
};

int main(int argc, char *argv[]) {
    QApplication app(argc, argv);
    qRegisterMetaType<MyCustomType>(); // æ³¨å†Œç±»å‹

    Sender sender;
    Receiver receiver;
    QThread thread;

    // è·¨çº¿ç¨‹è¿æ¥
    QObject::connect(&sender, &Sender::signalData,
                     &receiver, &Receiver::onDataReceived,
                     Qt::QueuedConnection);
                     
    //å°†æ¥å—è€…ç§»è‡³çº¿ç¨‹ä¸­ï¼Œè¿™æ ·ä¸å‘é€è€…å³åˆ†å±äºä¸åŒçš„çº¿ç¨‹ä¸­
    receiver.moveToThread(&thread);
    thread.start();

    sender.sendData();
    return app.exec();
}

```

---

#### äº”. ä¸ºä»€ä¹ˆâ€œä»…ç”¨ qRegisterMetaType ä¹Ÿèƒ½å·¥ä½œâ€ï¼Ÿ

**åœºæ™¯ 1**
ï¼šè·¨çº¿ç¨‹ä¿¡å·æ§½é€šä¿¡

* å¦‚æœä»…åœ¨è·¨çº¿ç¨‹ä¿¡å·æ§½ä¸­ä½¿ç”¨è‡ªå®šä¹‰ç±»å‹ï¼Œä¸”æœªç›´æ¥æ“ä½œ QVariantï¼Œç¨‹åºå¯èƒ½æ­£å¸¸æ‰§è¡Œã€‚
* **åŸå› **
  ï¼š
    
  `qRegisterMetaType`
  åœ¨è¿è¡Œæ—¶æ³¨å†Œäº†ç±»å‹ï¼Œä½¿å¾— Qt èƒ½æ­£ç¡®åºåˆ—åŒ–å‚æ•°ã€‚
    
  `Q_DECLARE_METATYPE`
  çš„ç¼ºå¤±åœ¨æ­¤åœºæ™¯ä¸‹å¯èƒ½ä¸ä¼šç«‹å³æš´éœ²é—®é¢˜ã€‚

**åœºæ™¯ 2**
ï¼šä½ç‰ˆæœ¬ Qt çš„å®½æ¾å¤„ç†

* æŸäº›æ—§ç‰ˆ Qtï¼ˆå¦‚ Qt4ï¼‰å¯¹ç±»å‹æ³¨å†Œçš„è¦æ±‚è¾ƒä¸ºå®½æ¾ï¼Œå¯èƒ½å…è®¸æœªå£°æ˜ Q_DECLARE_METATYPEã€‚
* é£é™©ï¼š
    
  è¿™ç§è¡Œä¸ºæ˜¯æœªå®šä¹‰çš„ï¼Œå¯èƒ½å›  Qt ç‰ˆæœ¬æˆ–å¹³å°ä¸åŒè€Œå¤±æ•ˆã€‚

---

|  |
| --- |
| ä¸‹é›¨å¤©ï¼Œæœ€æƒ¬æ„çš„äº‹è«è¿‡äºèººåœ¨åºŠä¸Šé™é™å¬é›¨ï¼Œé›¨ä¸­å…¥çœ ï¼Œè¿æ¢¦é‡Œä¹Ÿé•¿å‡ºé’è‹”ã€‚ |