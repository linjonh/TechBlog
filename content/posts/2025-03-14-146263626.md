---
layout: post
title: "通过qemu仿真树莓派系统调试IoT固件和程序"
date: 2025-03-14 18:02:42 +0800
description: "本文将介绍如何使用 QEMU 模拟器在 x86 架构的主机上运行 Raspberry Pi OS（树莓派操作系统）。我们将从下载镜像、提取内核和设备树文件，到启动模拟环境，并进行一些常见的操作，如更改密码和交叉编译，以及如何通过 GDB 进行远程调试。"
keywords: "通过qemu仿真树莓派系统调试IoT固件和程序"
categories: ['未分类']
tags: ['网络', '物联网', 'Qemu', 'Linux']
artid: "146263626"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146263626
    alt: "通过qemu仿真树莓派系统调试IoT固件和程序"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146263626
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146263626
cover: https://bing.ee123.net/img/rand?artid=146263626
image: https://bing.ee123.net/img/rand?artid=146263626
img: https://bing.ee123.net/img/rand?artid=146263626
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     通过qemu仿真树莓派系统调试IoT固件和程序
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="qemuIoT_0">
     </a>
     通过qemu仿真树莓派系统调试IoT固件和程序
    </h2>
    <p>
     本文将介绍如何使用 QEMU 模拟器在 x86 架构的主机上运行 Raspberry Pi OS（树莓派操作系统）。我们将从下载镜像、提取内核和设备树文件，到启动模拟环境，并进行一些常见的操作，如更改密码和交叉编译，以及如何通过 GDB 进行远程调试。
    </p>
    <hr/>
    <h3>
     <a id="1__Raspberry_Pi_OS__8">
     </a>
     1. 下载 Raspberry Pi OS 镜像
    </h3>
    <p>
     首先，我们需要下载适用于树莓派的轻量版 Raspberry Pi OS 镜像。本文使用的是
     <code>
      2024-10-22-raspios-bullseye-armhf-lite.img
     </code>
     ，这是一个基于 Debian Bullseye 的 ARM 架构镜像。
    </p>
    <p>
     你可以从
     <a href="https://www.raspberrypi.org/software/operating-systems/" rel="nofollow">
      Raspberry Pi 官方网站
     </a>
     或其他可信来源下载该镜像。
    </p>
    <hr/>
    <h3>
     <a id="2__16">
     </a>
     2. 提取内核和设备树文件
    </h3>
    <p>
     为了在 QEMU 中运行 Raspberry Pi OS，我们需要从镜像中提取内核 (
     <code>
      kernel*.img
     </code>
     ) 和设备树文件 (
     <code>
      .dtb
     </code>
     )。以下是具体步骤：
    </p>
    <h4>
     <a id="21__20">
     </a>
     2.1 创建挂载点并挂载镜像
    </h4>
    <pre><code class="prism language-sh"><span class="token comment"># 1. 创建挂载点</span>
<span class="token function">sudo</span> <span class="token function">mkdir</span> /mnt/rpi

<span class="token comment"># 2. 挂载镜像文件</span>
<span class="token function">sudo</span> losetup <span class="token parameter variable">-f</span> <span class="token parameter variable">--show</span> <span class="token parameter variable">-P</span> <span class="token number">2024</span>-10-22-raspios-bullseye-armhf-lite.img
<span class="token comment"># 假设输出为 /dev/loop0</span>

<span class="token comment"># 3. 挂载第一个分区</span>
<span class="token function">sudo</span> <span class="token function">mount</span> /dev/loop0p1 /mnt/rpi
</code></pre>
    <h4>
     <a id="22__34">
     </a>
     2.2 复制内核和设备树文件
    </h4>
    <pre><code class="prism language-sh"><span class="token comment"># 4. 复制内核和设备树文件</span>
<span class="token function">cp</span> /mnt/rpi/kernel* <span class="token builtin class-name">.</span>
<span class="token function">cp</span> /mnt/rpi/*.dtb <span class="token builtin class-name">.</span>

<span class="token comment"># 5. 卸载分区</span>
<span class="token function">sudo</span> <span class="token function">umount</span> /mnt/rpi

<span class="token comment"># 6. 删除 loop 设备</span>
<span class="token function">sudo</span> losetup <span class="token parameter variable">-d</span> /dev/loop0
</code></pre>
    <p>
     至此，我们已经成功提取了内核和设备树文件，这些文件将在后续步骤中用于 QEMU 启动。
    </p>
    <hr/>
    <h3>
     <a id="3__QEMU__Raspberry_Pi_OS_52">
     </a>
     3. 使用 QEMU 启动 Raspberry Pi OS
    </h3>
    <h4>
     <a id="31__3B__54">
     </a>
     3.1 启动树莓派 3B 模拟环境
    </h4>
    <p>
     以下命令将使用 QEMU 模拟树莓派 3B 环境，并加载我们提取的内核和设备树文件：
    </p>
    <pre><code class="prism language-sh"><span class="token function">sudo</span> qemu-system-aarch64 <span class="token parameter variable">-M</span> raspi3b <span class="token punctuation">\</span>
<span class="token parameter variable">-append</span> <span class="token string">"rw earlyprintk loglevel=8 console=ttyAMA0,115200 dwc_otg.lpm_enable=0 root=/dev/mmcblk0p2 rootdelay=1"</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-dtb</span> ./bcm2710-rpi-3-b-plus.dtb <span class="token punctuation">\</span>
<span class="token parameter variable">-drive</span> <span class="token assign-left variable">format</span><span class="token operator">=</span>raw,file<span class="token operator">=</span><span class="token number">2024</span>-10-22-raspios-bullseye-armhf-lite.img <span class="token punctuation">\</span>
<span class="token parameter variable">-kernel</span> kernel8.img <span class="token punctuation">\</span>
<span class="token parameter variable">-m</span> 1G <span class="token punctuation">\</span>
<span class="token parameter variable">-smp</span> <span class="token number">4</span> <span class="token parameter variable">-serial</span> stdio <span class="token punctuation">\</span>
<span class="token parameter variable">-net</span> nic <span class="token parameter variable">-net</span> user,hostfwd<span class="token operator">=</span>tcp::5022-:22  <span class="token punctuation">\</span>
<span class="token parameter variable">-usb</span> <span class="token parameter variable">-device</span> usb-kbd  <span class="token parameter variable">-device</span> usb-mouse <span class="token punctuation">\</span>
<span class="token parameter variable">-k</span> en-us <span class="token punctuation">\</span>
<span class="token parameter variable">-display</span> sdl 
</code></pre>
    <h5>
     <a id="_72">
     </a>
     参数说明：
    </h5>
    <ul>
     <li>
      <code>
       -M raspi3b
      </code>
      ：指定模拟的硬件平台为树莓派 3B。
     </li>
     <li>
      <code>
       -append
      </code>
      ：传递给内核的启动参数，包括根文件系统位置、日志级别等。
     </li>
     <li>
      <code>
       -dtb
      </code>
      ：指定设备树文件。
     </li>
     <li>
      <code>
       -drive
      </code>
      ：指定镜像文件及其格式。
     </li>
     <li>
      <code>
       -kernel
      </code>
      ：指定内核文件。
     </li>
     <li>
      <code>
       -m
      </code>
      ：分配内存大小（1GB）。
     </li>
     <li>
      <code>
       -smp
      </code>
      ：指定 CPU 核心数（4 核）。
     </li>
     <li>
      <code>
       -net
      </code>
      ：配置网络，允许通过 SSH 访问（主机端口 5022 映射到虚拟机端口 22）。
     </li>
     <li>
      <code>
       -usb
      </code>
      ：启用 USB 支持，添加键盘和鼠标设备。
     </li>
     <li>
      <code>
       -display sdl
      </code>
      ：使用 SDL 图形显示。
     </li>
    </ul>
    <p>
     运行上述命令后，QEMU 将启动树莓派模拟环境，并进入 Raspberry Pi OS 的登录界面。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/450a44fc81f8458b87b36758de56726d.png"/>
    </p>
    <hr/>
    <h3>
     <a id="4__versatilepb__92">
     </a>
     4. 使用预编译的 versatilepb 内核进行仿真
    </h3>
    <p>
     https://github.com/dhruvvyas90/qemu-rpi-kernel
    </p>
    <p>
     如果你希望使用更通用的 ARM 平台（如 VersatilePB），可以使用以下命令：
    </p>
    <pre><code class="prism language-sh">qemu-system-arm <span class="token parameter variable">-M</span> versatilepb <span class="token parameter variable">-cpu</span> arm1176 <span class="token parameter variable">-m</span> <span class="token number">256</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-drive</span> <span class="token assign-left variable">format</span><span class="token operator">=</span>raw,file<span class="token operator">=</span><span class="token number">2024</span>-10-22-raspios-bullseye-armhf-lite.img <span class="token punctuation">\</span>
<span class="token parameter variable">-dtb</span> versatile-pb-bullseye-5.10.63.dtb <span class="token punctuation">\</span>
<span class="token parameter variable">-kernel</span> kernel-qemu-5.10.63-bullseye <span class="token punctuation">\</span>
<span class="token parameter variable">-net</span> nic <span class="token parameter variable">-net</span> user,hostfwd<span class="token operator">=</span>tcp::5022-:22  <span class="token punctuation">\</span>
<span class="token parameter variable">-net</span> user,hostfwd<span class="token operator">=</span>tcp::2333-:2333 <span class="token punctuation">\</span>
<span class="token parameter variable">-nographic</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-append</span> <span class="token string">"root=/dev/sda2 panic=1 rootfstype=ext4 rw"</span>
</code></pre>
    <h5>
     <a id="_109">
     </a>
     参数说明：
    </h5>
    <ul>
     <li>
      <code>
       -M versatilepb
      </code>
      ：指定模拟的硬件平台为 VersatilePB。
     </li>
     <li>
      <code>
       -cpu arm1176
      </code>
      ：指定 CPU 类型。
     </li>
     <li>
      <code>
       -nographic
      </code>
      ：禁用图形界面，仅使用命令行模式。
     </li>
    </ul>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/f63b89ca73d6404992a6d7d75a7d8cc6.png"/>
    </p>
    <hr/>
    <h3>
     <a id="4__119">
     </a>
     4. 更改默认密码
    </h3>
    <p>
     Raspberry Pi OS 新版本需要通过在镜像文件中写入文件进行配置账号密码，否则无法实现登录。
    </p>
    <p>
     这里我们直接挂载镜像来修改密码
    </p>
    <p>
     以下是具体步骤：
    </p>
    <pre><code class="prism language-sh"><span class="token comment"># 1. 创建挂载点</span>
<span class="token function">sudo</span> <span class="token function">mkdir</span> /mnt/rpi

<span class="token comment"># 2. 挂载镜像文件</span>
<span class="token function">sudo</span> losetup <span class="token parameter variable">-f</span> <span class="token parameter variable">--show</span> <span class="token parameter variable">-P</span> <span class="token number">2024</span>-10-22-raspios-bullseye-armhf-lite.img

<span class="token comment"># 3. 挂载第二个分区</span>
<span class="token function">sudo</span> <span class="token function">mount</span> /dev/loop0p2 /mnt/rpi

<span class="token comment"># 4. 更改密码</span>
<span class="token function">sudo</span> <span class="token function">chroot</span> /mnt/rpi <span class="token function">passwd</span> pi

<span class="token comment"># 5. 卸载分区</span>
<span class="token function">sudo</span> <span class="token function">umount</span> /mnt/rpi

<span class="token comment"># 6. 删除 loop 设备</span>
<span class="token function">sudo</span> losetup <span class="token parameter variable">-d</span> /dev/loop0
</code></pre>
    <p>
     运行上述命令后，输入新密码即可完成更改。
    </p>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/ea1f581c57694a61bbf3149fd4422758.png"/>
    </p>
    <hr/>
    <h3>
     <a id="5__157">
     </a>
     5. 交叉编译与远程调试
    </h3>
    <h4>
     <a id="51__159">
     </a>
     5.1 交叉编译工具链配置
    </h4>
    <p>
     为了在 x86 主机上为 ARM 架构编译程序，我们需要设置交叉编译工具链。以下是配置示例：
    </p>
    <pre><code class="prism language-sh">./configure <span class="token parameter variable">--host</span><span class="token operator">=</span>arm-linux-gnueabihf <span class="token parameter variable">--target</span><span class="token operator">=</span>arm-linux-gnueabihf <span class="token assign-left variable">CC</span><span class="token operator">=</span>/home/kali/rpi-tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin/arm-linux-gnueabihf-gcc <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/opt/arm-linux-gnueabihf-gdb-8.2

<span class="token function">make</span> <span class="token assign-left variable">CXX</span><span class="token operator">=</span>/home/kali/rpi-tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin/arm-linux-gnueabihf-g++ <span class="token assign-left variable">CC</span><span class="token operator">=</span>/home/kali/rpi-tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin/arm-linux-gnueabihf-gcc
</code></pre>
    <h4>
     <a id="52__GDB__169">
     </a>
     5.2 使用 GDB 进行远程调试
    </h4>
    <p>
     在目标系统中启动
     <code>
      gdbserver
     </code>
     ：
    </p>
    <pre><code class="prism language-sh">$ ./gdbserver :2333 /bin/sh
</code></pre>
    <p>
     在主机端使用 GDB 连接到目标系统：
    </p>
    <pre><code class="prism language-sh">gef➤ gef-remote <span class="token number">127.0</span>.0.1 <span class="token number">2333</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/73f870dd2d24400a927bccf3deef8e31.png"/>
    </p>
    <hr/>
    <h2>
     <a id="6_qemu_188">
     </a>
     6. 使用qemu直接进行调试
    </h2>
    <p>
     qemu-aarch64 配合gdb可以实现调试arm架构的程序
    </p>
    <pre><code class="prism language-sh"><span class="token comment"># 1. 安装 QEMU User 模式工具</span>
<span class="token function">sudo</span> <span class="token function">apt</span> <span class="token function">install</span> qemu-user gdb-multiarch

<span class="token comment"># 2. 用 QEMU 运行 ARM 可执行程序</span>
qemu-aarch64 <span class="token operator">&lt;</span>你的ARM程序<span class="token operator">&gt;</span>

<span class="token comment"># 3. 运行 gdbserver 进行远程调试（在主机上执行）</span>
qemu-aarch64 <span class="token parameter variable">-g</span> <span class="token number">2333</span> <span class="token operator">&lt;</span>你的ARM程序<span class="token operator">&gt;</span>

<span class="token comment"># 4. 在另一个终端启动 gdb-multiarch 并连接 gdbserver</span>
gdb-multiarch
gef<span class="token operator">&gt;</span> <span class="token builtin class-name">set</span> architecture aarch64
gef<span class="token operator">&gt;</span> gef-remote <span class="token number">127.0</span>.0.1:2333

</code></pre>
    <h3>
     <a id="_213">
     </a>
     参考链接
    </h3>
    <p>
     https://zhuanlan.zhihu.com/p/613032457
    </p>
    <p>
     https://www.gandalf.site/2018/12/iotqemuiot.html
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f474b44323031392f:61727469636c652f64657461696c732f313436323633363236" class_="artid" style="display:none">
 </p>
</div>


