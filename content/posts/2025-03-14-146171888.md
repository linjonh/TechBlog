---
layout: post
title: "Android-Framework-之了解系统启动流程一"
date: 2025-03-14 14:11:34 +0800
description: "首先，Bootloader 初始化硬件并加载 Linux 内核。内核启动后，运行第一个用户空间进程 init，它解析 init.rc 脚本，启动 Zygote 进程。Zygote 进程预加载系统类和资源，并 fork 出 SystemServer 进程。SystemServer 启动核心系统服务，如 ActivityManagerService 和 PackageManagerService，并启动 Launcher 应用。"
keywords: "Android Framework 之了解系统启动流程一"
categories: ['未分类']
tags: ['Android']
artid: "146171888"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146171888
    alt: "Android-Framework-之了解系统启动流程一"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146171888
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146171888
cover: https://bing.ee123.net/img/rand?artid=146171888
image: https://bing.ee123.net/img/rand?artid=146171888
img: https://bing.ee123.net/img/rand?artid=146171888
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Android Framework 之了解系统启动流程一
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     Android Framework 源码阅读系列篇章有：
    </p>
    <ol>
     <li>
      <a href="https://blog.csdn.net/Bonnie_cat/article/details/146171888">
       系统启动流程一之init进程和zygote进程启动分析
      </a>
     </li>
     <li>
      <a href="https://blog.csdn.net/Bonnie_cat/article/details/146256561">
       系统启动流程二之SystemServer进程启动分析
      </a>
     </li>
    </ol>
    <h2>
     <a id="1__5">
     </a>
     1. 系统总体启动流程
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/e0a565617b744f18bdd908c06e4a15fe.png"/>
    </p>
    <p>
     （1）当电源按下时，引导芯片代码会从预定义的地方（固化在 ROM）开始执行，加载引导程序 BootLoader 到 RAM，然后执行；
     <br/>
     （2）BootLoader 会启动 Android 的第一个进程 idle（pid = 0）,也叫 swapper。它会初始化进程管理、内存管理，加载 Binder Driver、Display、Camera Driver 等相关工作。
     <br/>
     （3）idle 会创建两个进程，init 用户空间进程和 kthread 内核空间进程。kthread 负责创建内核工作线程 kworker，软中断线程 ksoftirqd、thermal 等内核守护进程。
     <br/>
     （4）init 进程会 fork 出 zygote 进程。
     <br/>
     （5）zygote 进程相当于 java 进程的鼻祖，它会 fork 出 SystemServer 进程。
     <br/>
     （6）SystemServer 进程会启动 90 多个服务，并且会通过 AMS 通知 zygote fork 出 App 进程。
    </p>
    <h2>
     <a id="2_init__15">
     </a>
     2. init 进程启动过程
    </h2>
    <pre><code class="prism language-cpp"><span class="token comment">// frameworks/core/core/init/main.cpp</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">__has_feature</span><span class="token punctuation">(</span>address_sanitizer<span class="token punctuation">)</span></span></span>
    <span class="token function">__asan_set_error_report_callback</span><span class="token punctuation">(</span>AsanReportCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token function">basename</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ueventd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">ueventd_main</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"subcontext"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            android<span class="token double-colon punctuation">::</span>base<span class="token double-colon punctuation">::</span><span class="token function">InitLogging</span><span class="token punctuation">(</span>argv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>android<span class="token double-colon punctuation">::</span>base<span class="token double-colon punctuation">::</span>KernelLogger<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> BuiltinFunctionMap<span class="token operator">&amp;</span> function_map <span class="token operator">=</span> <span class="token function">GetBuiltinFunctionMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token function">SubcontextMain</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>function_map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"selinux_setup"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 代码2</span>
            <span class="token keyword">return</span> <span class="token function">SetupSelinux</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"second_stage"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 代码3</span>
            <span class="token keyword">return</span> <span class="token function">SecondStageMain</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 代码1</span>
    <span class="token keyword">return</span> <span class="token function">FirstStageMain</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     在 init.cpp 中的 入口函数 main() 中，
     <br/>
     （1）首先执行
     <code>
      FirstStageMain(argc, argv)
     </code>
     ，
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// frameworks/core/core/init/first_stage_init.cpp</span>
<span class="token keyword">int</span> <span class="token function">FirstStageMain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 做安全处理</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>REBOOT_BOOTLOADER_ON_PANIC<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">InstallRebootSignalHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    boot_clock<span class="token double-colon punctuation">::</span>time_point start_time <span class="token operator">=</span> boot_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>pair<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> errors<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">CHECKCALL</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> errors<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>#x </span><span class="token string">" failed"</span><span class="token expression"><span class="token punctuation">,</span> errno<span class="token punctuation">)</span><span class="token punctuation">;</span></span></span>

    <span class="token comment">// Clear the umask.</span>
    <span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">clearenv</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"PATH"</span><span class="token punctuation">,</span> _PATH_DEFPATH<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Get the basic filesystem setup we need put together in the initramdisk</span>
    <span class="token comment">// on / and then we'll let the rc file figure out the rest.</span>
    <span class="token comment">// 从这开始做一些文件挂载</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"tmpfs"</span><span class="token punctuation">,</span> <span class="token string">"/dev"</span><span class="token punctuation">,</span> <span class="token string">"tmpfs"</span><span class="token punctuation">,</span> MS_NOSUID<span class="token punctuation">,</span> <span class="token string">"mode=0755"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">"/dev/pts"</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">"/dev/socket"</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"devpts"</span><span class="token punctuation">,</span> <span class="token string">"/dev/pts"</span><span class="token punctuation">,</span> <span class="token string">"devpts"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">MAKE_STR</span><span class="token expression"><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token function">__STRING</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span></span></span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"proc"</span><span class="token punctuation">,</span> <span class="token string">"/proc"</span><span class="token punctuation">,</span> <span class="token string">"proc"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">"hidepid=2,gid="</span> <span class="token function">MAKE_STR</span><span class="token punctuation">(</span>AID_READPROC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">MAKE_STR</span></span>
    <span class="token comment">// Don't expose the raw commandline to unprivileged processes.</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">chmod</span><span class="token punctuation">(</span><span class="token string">"/proc/cmdline"</span><span class="token punctuation">,</span> <span class="token number">0440</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>string cmdline<span class="token punctuation">;</span>
    android<span class="token double-colon punctuation">::</span>base<span class="token double-colon punctuation">::</span><span class="token function">ReadFileToString</span><span class="token punctuation">(</span><span class="token string">"/proc/cmdline"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>cmdline<span class="token punctuation">)</span><span class="token punctuation">;</span>
    gid_t groups<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>AID_READPROC<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">setgroups</span><span class="token punctuation">(</span><span class="token function">arraysize</span><span class="token punctuation">(</span>groups<span class="token punctuation">)</span><span class="token punctuation">,</span> groups<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"sysfs"</span><span class="token punctuation">,</span> <span class="token string">"/sys"</span><span class="token punctuation">,</span> <span class="token string">"sysfs"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"selinuxfs"</span><span class="token punctuation">,</span> <span class="token string">"/sys/fs/selinux"</span><span class="token punctuation">,</span> <span class="token string">"selinuxfs"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mknod</span><span class="token punctuation">(</span><span class="token string">"/dev/kmsg"</span><span class="token punctuation">,</span> S_IFCHR <span class="token operator">|</span> <span class="token number">0600</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token keyword">constexpr</span> <span class="token punctuation">(</span>WORLD_WRITABLE_KMSG<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mknod</span><span class="token punctuation">(</span><span class="token string">"/dev/kmsg_debug"</span><span class="token punctuation">,</span> S_IFCHR <span class="token operator">|</span> <span class="token number">0622</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mknod</span><span class="token punctuation">(</span><span class="token string">"/dev/random"</span><span class="token punctuation">,</span> S_IFCHR <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mknod</span><span class="token punctuation">(</span><span class="token string">"/dev/urandom"</span><span class="token punctuation">,</span> S_IFCHR <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// This is needed for log wrapper, which gets called before ueventd runs.</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mknod</span><span class="token punctuation">(</span><span class="token string">"/dev/ptmx"</span><span class="token punctuation">,</span> S_IFCHR <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mknod</span><span class="token punctuation">(</span><span class="token string">"/dev/null"</span><span class="token punctuation">,</span> S_IFCHR <span class="token operator">|</span> <span class="token number">0666</span><span class="token punctuation">,</span> <span class="token function">makedev</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// These below mounts are done in first stage init so that first stage mount can mount</span>
    <span class="token comment">// subdirectories of /mnt/{vendor,product}/.  Other mounts, not required by first stage mount,</span>
    <span class="token comment">// should be done in rc files.</span>
    <span class="token comment">// Mount staging areas for devices managed by vold</span>
    <span class="token comment">// See storage config details at http://source.android.com/devices/storage/</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"tmpfs"</span><span class="token punctuation">,</span> <span class="token string">"/mnt"</span><span class="token punctuation">,</span> <span class="token string">"tmpfs"</span><span class="token punctuation">,</span> MS_NOEXEC <span class="token operator">|</span> MS_NOSUID <span class="token operator">|</span> MS_NODEV<span class="token punctuation">,</span>
                    <span class="token string">"mode=0755,uid=0,gid=1000"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// /mnt/vendor is used to mount vendor-specific partitions that can not be</span>
    <span class="token comment">// part of the vendor partition, e.g. because they are mounted read-write.</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">"/mnt/vendor"</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// /mnt/product is used to mount product-specific partitions that can not be</span>
    <span class="token comment">// part of the product partition, e.g. because they are mounted read-write.</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">"/mnt/product"</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// /debug_ramdisk is used to preserve additional files from the debug ramdisk</span>
    <span class="token function">CHECKCALL</span><span class="token punctuation">(</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"tmpfs"</span><span class="token punctuation">,</span> <span class="token string">"/debug_ramdisk"</span><span class="token punctuation">,</span> <span class="token string">"tmpfs"</span><span class="token punctuation">,</span> MS_NOEXEC <span class="token operator">|</span> MS_NOSUID <span class="token operator">|</span> MS_NODEV<span class="token punctuation">,</span>
                    <span class="token string">"mode=0755,uid=0,gid=0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">undef</span> <span class="token expression">CHECKCALL</span></span>

    <span class="token function">SetStdioToDevNull</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Now that tmpfs is mounted on /dev and we have /dev/kmsg, we can actually</span>
    <span class="token comment">// talk to the outside world...</span>
    <span class="token comment">// 初始化内核的日志打印</span>
    <span class="token function">InitKernelLogging</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>errors<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> <span class="token punctuation">[</span>error_string<span class="token punctuation">,</span> error_errno<span class="token punctuation">]</span> <span class="token operator">:</span> errors<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> error_string <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> <span class="token function">strerror</span><span class="token punctuation">(</span>error_errno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Init encountered errors starting first stage, aborting"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"init first stage started!"</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> old_root_dir <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>unique_ptr<span class="token operator">&lt;</span>DIR<span class="token punctuation">,</span> <span class="token keyword">decltype</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>closedir<span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token function">opendir</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> closedir<span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>old_root_dir<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not opendir(\"/\"), not freeing ramdisk"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">struct</span> <span class="token class-name">stat</span> old_root_info<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>old_root_info<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not stat(\"/\"), not freeing ramdisk"</span><span class="token punctuation">;</span>
        old_root_dir<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">auto</span> want_console <span class="token operator">=</span> ALLOW_FIRST_STAGE_CONSOLE <span class="token operator">?</span> <span class="token function">FirstStageConsole</span><span class="token punctuation">(</span>cmdline<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LoadKernelModules</span><span class="token punctuation">(</span><span class="token function">IsRecoveryMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">ForceNormalBoot</span><span class="token punctuation">(</span>cmdline<span class="token punctuation">)</span><span class="token punctuation">,</span> want_console<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>want_console <span class="token operator">!=</span> FirstStageConsoleParam<span class="token double-colon punctuation">::</span>DISABLED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to load kernel modules, starting console"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to load kernel modules"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>want_console <span class="token operator">==</span> FirstStageConsoleParam<span class="token double-colon punctuation">::</span>CONSOLE_ON_FAILURE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">StartConsole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">ForceNormalBoot</span><span class="token punctuation">(</span>cmdline<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token string">"/first_stage_ramdisk"</span><span class="token punctuation">,</span> <span class="token number">0755</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// SwitchRoot() must be called with a mount point as the target, so we bind mount the</span>
        <span class="token comment">// target directory to itself here.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">"/first_stage_ramdisk"</span><span class="token punctuation">,</span> <span class="token string">"/first_stage_ramdisk"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> MS_BIND<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not bind mount /first_stage_ramdisk to itself"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">SwitchRoot</span><span class="token punctuation">(</span><span class="token string">"/first_stage_ramdisk"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If this file is present, the second-stage init will use a userdebug sepolicy</span>
    <span class="token comment">// and load adb_debug.prop to allow adb root, if the device is unlocked.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">access</span><span class="token punctuation">(</span><span class="token string">"/force_debuggable"</span><span class="token punctuation">,</span> F_OK<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>error_code ec<span class="token punctuation">;</span>  <span class="token comment">// to invoke the overloaded copy_file() that won't throw.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token double-colon punctuation">::</span><span class="token function">copy_file</span><span class="token punctuation">(</span><span class="token string">"/adb_debug.prop"</span><span class="token punctuation">,</span> kDebugRamdiskProp<span class="token punctuation">,</span> ec<span class="token punctuation">)</span> <span class="token operator">||</span>
            <span class="token operator">!</span>fs<span class="token double-colon punctuation">::</span><span class="token function">copy_file</span><span class="token punctuation">(</span><span class="token string">"/userdebug_plat_sepolicy.cil"</span><span class="token punctuation">,</span> kDebugRamdiskSEPolicy<span class="token punctuation">,</span> ec<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to setup debug ramdisk"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// setenv for second-stage init to read above kDebugRamdisk* files.</span>
            <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"INIT_FORCE_DEBUGGABLE"</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">DoFirstStageMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Failed to mount required partitions early ..."</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">struct</span> <span class="token class-name">stat</span> new_root_info<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>new_root_info<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">PLOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Could not stat(\"/\"), not freeing ramdisk"</span><span class="token punctuation">;</span>
        old_root_dir<span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>old_root_dir <span class="token operator">&amp;&amp;</span> old_root_info<span class="token punctuation">.</span>st_dev <span class="token operator">!=</span> new_root_info<span class="token punctuation">.</span>st_dev<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">FreeRamdisk</span><span class="token punctuation">(</span>old_root_dir<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> old_root_info<span class="token punctuation">.</span>st_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">SetInitAvbVersionInRecovery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setenv</span><span class="token punctuation">(</span>kEnvFirstStageStartedAt<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>start_time<span class="token punctuation">.</span><span class="token function">time_since_epoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
           <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path <span class="token operator">=</span> <span class="token string">"/system/bin/init"</span><span class="token punctuation">;</span>
    <span class="token comment">// 启动 selinux_setup</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>path<span class="token punctuation">,</span> <span class="token string">"selinux_setup"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/kmsg"</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> STDOUT_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">dup2</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> STDERR_FILENO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">execv</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// execv() only returns if an error happened, in which case we</span>
    <span class="token comment">// panic and never fall through this conditional.</span>
    <span class="token function">PLOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"execv(\""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\") failed"</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     总结：
     <br/>
     FirstStageMain() 主要做的事情：
     <br/>
     1.init 进程 crash 时重启引导加载程序；
     <br/>
     2.创建和挂载启动所需的文件目录；
     <br/>
     3.输入输出等重定向到 /dev/null；
     <br/>
     4.初始化 kernel Log
     <br/>
     5.启动 init 进程，/system/bin/init，参数：selinux_setup
    </p>
    <p>
     （2）代码2，
     <code>
      SetupSelinux(argv)
     </code>
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// frameworks/core/core/init/selinux.cpp</span>
<span class="token keyword">int</span> <span class="token function">SetupSelinux</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">SetStdioToDevNull</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">InitKernelLogging</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>REBOOT_BOOTLOADER_ON_PANIC<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">InstallRebootSignalHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    boot_clock<span class="token double-colon punctuation">::</span>time_point start_time <span class="token operator">=</span> boot_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">MountMissingSystemPartitions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Set up SELinux, loading the SELinux policy.</span>
    <span class="token function">SelinuxSetupKernelLogging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SelinuxInitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// We're in the kernel domain and want to transition to the init domain.  File systems that</span>
    <span class="token comment">// store SELabels in their xattrs, such as ext4 do not need an explicit restorecon here,</span>
    <span class="token comment">// but other file systems do.  In particular, this is needed for ramdisks such as the</span>
    <span class="token comment">// recovery image for A/B devices.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">selinux_android_restorecon</span><span class="token punctuation">(</span><span class="token string">"/system/bin/init"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">PLOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"restorecon failed of /system/bin/init failed"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">setenv</span><span class="token punctuation">(</span>kEnvSelinuxStartedAt<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>start_time<span class="token punctuation">.</span><span class="token function">time_since_epoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> path <span class="token operator">=</span> <span class="token string">"/system/bin/init"</span><span class="token punctuation">;</span>
    <span class="token comment">// 执行 second_stage</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>path<span class="token punctuation">,</span> <span class="token string">"second_stage"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token function">execv</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// execv() only returns if an error happened, in which case we</span>
    <span class="token comment">// panic and never return from this function.</span>
    <span class="token function">PLOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"execv(\""</span> <span class="token operator">&lt;&lt;</span> path <span class="token operator">&lt;&lt;</span> <span class="token string">"\") failed"</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     SetupSelinux 主要做的事情：
     <br/>
     1.用来提高 linux 的安全，进一步约束访问的权限；
     <br/>
     2.调用 execv 开启 init 进程，参数：second_stage；
    </p>
    <p>
     （3）代码3，SecondStageMain(argc, argv)
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// frameworks/core/core/init/init.cpp</span>
<span class="token keyword">int</span> <span class="token function">SecondStageMain</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>REBOOT_BOOTLOADER_ON_PANIC<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">InstallRebootSignalHandlers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 记录第二阶段的启动时间</span>
    boot_clock<span class="token double-colon punctuation">::</span>time_point start_time <span class="token operator">=</span> boot_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    trigger_shutdown <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> command<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> shutdown_state<span class="token punctuation">.</span><span class="token function">TriggerShutdown</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">// 将标准输入输出重定向到 /dev/null，并初始化内核日志系统</span>
    <span class="token function">SetStdioToDevNull</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">InitKernelLogging</span><span class="token punctuation">(</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"init second stage started!"</span><span class="token punctuation">;</span>

    <span class="token comment">// Init should not crash because of a dependence on any other process, therefore we ignore</span>
    <span class="token comment">// SIGPIPE and handle EPIPE at the call site directly.  Note that setting a signal to SIG_IGN</span>
    <span class="token comment">// is inherited across exec, but custom signal handlers are not.  Since we do not want to</span>
    <span class="token comment">// ignore SIGPIPE for child processes, we set a no-op function for the signal handler instead.</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> <span class="token class-name">sigaction</span> action <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span>sa_flags <span class="token operator">=</span> SA_RESTART<span class="token punctuation">}</span><span class="token punctuation">;</span>
        action<span class="token punctuation">.</span>sa_handler <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token function">sigaction</span><span class="token punctuation">(</span>SIGPIPE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>action<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Set init and its forked children's oom_adj.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> result <span class="token operator">=</span>
                <span class="token function">WriteFile</span><span class="token punctuation">(</span><span class="token string">"/proc/1/oom_score_adj"</span><span class="token punctuation">,</span> <span class="token function">StringPrintf</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> DEFAULT_OOM_SCORE_ADJUST<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Unable to write "</span> <span class="token operator">&lt;&lt;</span> DEFAULT_OOM_SCORE_ADJUST
                   <span class="token operator">&lt;&lt;</span> <span class="token string">" to /proc/1/oom_score_adj: "</span> <span class="token operator">&lt;&lt;</span> result<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Set up a session keyring that all processes will have access to. It</span>
    <span class="token comment">// will hold things like FBE encryption keys. No process should override</span>
    <span class="token comment">// its session keyring.</span>
    <span class="token function">keyctl_get_keyring_ID</span><span class="token punctuation">(</span>KEY_SPEC_SESSION_KEYRING<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Indicate that booting is in progress to background fw loaders, etc.</span>
    <span class="token function">close</span><span class="token punctuation">(</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">"/dev/.booting"</span><span class="token punctuation">,</span> O_WRONLY <span class="token operator">|</span> O_CREAT <span class="token operator">|</span> O_CLOEXEC<span class="token punctuation">,</span> <span class="token number">0000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// See if need to load debug props to allow adb root, when the device is unlocked.</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> force_debuggable_env <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"INIT_FORCE_DEBUGGABLE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> load_debug_prop <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>force_debuggable_env <span class="token operator">&amp;&amp;</span> <span class="token class-name">AvbHandle</span><span class="token double-colon punctuation">::</span><span class="token function">IsDeviceUnlocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        load_debug_prop <span class="token operator">=</span> <span class="token string">"true"</span>s <span class="token operator">==</span> force_debuggable_env<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">unsetenv</span><span class="token punctuation">(</span><span class="token string">"INIT_FORCE_DEBUGGABLE"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Umount the debug ramdisk so property service doesn't read .prop files from there, when it</span>
    <span class="token comment">// is not meant to.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>load_debug_prop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">UmountDebugRamdisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 初始化属性域</span>
    <span class="token function">PropertyInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Umount the debug ramdisk after property service has read the .prop files when it means to.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>load_debug_prop<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">UmountDebugRamdisk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Mount extra filesystems required during second stage init</span>
    <span class="token function">MountExtraFilesystems</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Now set up SELinux for second stage.</span>
    <span class="token function">SelinuxSetupKernelLogging</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SelabelInitialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SelinuxRestoreContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	 <span class="token comment">// 初始化 epoll 实例</span>
    Epoll epoll<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> result <span class="token operator">=</span> epoll<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">PLOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> result<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 下面三行处理终止信号</span>
    <span class="token function">InstallSignalFdHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epoll<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">InstallInitNotifier</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epoll<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">StartPropertyService</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>property_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Make the time that init stages started available for bootstat to log.</span>
    <span class="token function">RecordStageBoottimes</span><span class="token punctuation">(</span>start_time<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Set libavb version for Framework-only OTA match in Treble build.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> avb_version <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"INIT_AVB_VERSION"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> avb_version <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">SetProperty</span><span class="token punctuation">(</span><span class="token string">"ro.boot.avb_version"</span><span class="token punctuation">,</span> avb_version<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">unsetenv</span><span class="token punctuation">(</span><span class="token string">"INIT_AVB_VERSION"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">fs_mgr_vendor_overlay_mount_all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">export_oem_lock_status</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    MountHandler <span class="token function">mount_handler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epoll<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SetUsbController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> BuiltinFunctionMap<span class="token operator">&amp;</span> function_map <span class="token operator">=</span> <span class="token function">GetBuiltinFunctionMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Action</span><span class="token double-colon punctuation">::</span><span class="token function">set_function_map</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>function_map<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">SetupMountNamespaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">PLOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"SetupMountNamespaces failed"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">InitializeSubcontext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ActionManager<span class="token operator">&amp;</span> am <span class="token operator">=</span> <span class="token class-name">ActionManager</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ServiceList<span class="token operator">&amp;</span> sm <span class="token operator">=</span> <span class="token class-name">ServiceList</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 解析并加载 init.rc 脚本</span>
    <span class="token function">LoadBootScripts</span><span class="token punctuation">(</span>am<span class="token punctuation">,</span> sm<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Turning this on and letting the INFO logging be discarded adds 0.2s to</span>
    <span class="token comment">// Nexus 9 boot time, so it's disabled by default.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token function">DumpState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Make the GSI status available before scripts start running.</span>
    <span class="token keyword">auto</span> is_running <span class="token operator">=</span> android<span class="token double-colon punctuation">::</span>gsi<span class="token double-colon punctuation">::</span><span class="token function">IsGsiRunning</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"1"</span> <span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">;</span>
    <span class="token function">SetProperty</span><span class="token punctuation">(</span>gsi<span class="token double-colon punctuation">::</span>kGsiBootedProp<span class="token punctuation">,</span> is_running<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> is_installed <span class="token operator">=</span> android<span class="token double-colon punctuation">::</span>gsi<span class="token double-colon punctuation">::</span><span class="token function">IsGsiInstalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"1"</span> <span class="token operator">:</span> <span class="token string">"0"</span><span class="token punctuation">;</span>
    <span class="token function">SetProperty</span><span class="token punctuation">(</span>gsi<span class="token double-colon punctuation">::</span>kGsiInstalledProp<span class="token punctuation">,</span> is_installed<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 将一些内置动作加入队列</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>SetupCgroupsAction<span class="token punctuation">,</span> <span class="token string">"SetupCgroups"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>SetKptrRestrictAction<span class="token punctuation">,</span> <span class="token string">"SetKptrRestrict"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>TestPerfEventSelinuxAction<span class="token punctuation">,</span> <span class="token string">"TestPerfEventSelinux"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    am<span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"early-init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Queue an action that waits for coldboot done so we know ueventd has set up all of /dev...</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>wait_for_coldboot_done_action<span class="token punctuation">,</span> <span class="token string">"wait_for_coldboot_done"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ... so that we can start queuing up actions that require stuff from /dev.</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>MixHwrngIntoLinuxRngAction<span class="token punctuation">,</span> <span class="token string">"MixHwrngIntoLinuxRng"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>SetMmapRndBitsAction<span class="token punctuation">,</span> <span class="token string">"SetMmapRndBits"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Keychords keychords<span class="token punctuation">;</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>
            <span class="token punctuation">[</span><span class="token operator">&amp;</span>epoll<span class="token punctuation">,</span> <span class="token operator">&amp;</span>keychords<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> BuiltinArguments<span class="token operator">&amp;</span> args<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> Result<span class="token operator">&lt;</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> svc <span class="token operator">:</span> <span class="token class-name">ServiceList</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    keychords<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>svc<span class="token operator">-&gt;</span><span class="token function">keycodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                keychords<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>epoll<span class="token punctuation">,</span> HandleKeychord<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"KeychordInit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 触发 init 事件</span>
    am<span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span>
    <span class="token comment">// wasn't ready immediately after wait_for_coldboot_done</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>MixHwrngIntoLinuxRngAction<span class="token punctuation">,</span> <span class="token string">"MixHwrngIntoLinuxRng"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 根据启动模式（例如 charger 模式）触发不同事件</span>
    std<span class="token double-colon punctuation">::</span>string bootmode <span class="token operator">=</span> <span class="token function">GetProperty</span><span class="token punctuation">(</span><span class="token string">"ro.bootmode"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bootmode <span class="token operator">==</span> <span class="token string">"charger"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        am<span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"charger"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        am<span class="token punctuation">.</span><span class="token function">QueueEventTrigger</span><span class="token punctuation">(</span><span class="token string">"late-init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Run all property triggers based on current state of the properties.</span>
    am<span class="token punctuation">.</span><span class="token function">QueueBuiltinAction</span><span class="token punctuation">(</span>queue_property_triggers_action<span class="token punctuation">,</span> <span class="token string">"queue_property_triggers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 循环处理脚本中事件</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// By default, sleep until something happens.</span>
        <span class="token keyword">auto</span> epoll_timeout <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>optional<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>milliseconds<span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token keyword">auto</span> shutdown_command <span class="token operator">=</span> shutdown_state<span class="token punctuation">.</span><span class="token function">CheckShutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>shutdown_command<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">HandlePowerctlMessage</span><span class="token punctuation">(</span><span class="token operator">*</span>shutdown_command<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>prop_waiter_state<span class="token punctuation">.</span><span class="token function">MightBeWaiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">Service</span><span class="token double-colon punctuation">::</span><span class="token function">is_exec_service_running</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            am<span class="token punctuation">.</span><span class="token function">ExecuteOneCommand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsShuttingDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> next_process_action_time <span class="token operator">=</span> <span class="token function">HandleProcessActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// If there's a process that needs restarting, wake up in time for that.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>next_process_action_time<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                epoll_timeout <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">ceil</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>milliseconds<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
                        <span class="token operator">*</span>next_process_action_time <span class="token operator">-</span> boot_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>epoll_timeout <span class="token operator">&lt;</span> <span class="token number">0</span>ms<span class="token punctuation">)</span> epoll_timeout <span class="token operator">=</span> <span class="token number">0</span>ms<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>prop_waiter_state<span class="token punctuation">.</span><span class="token function">MightBeWaiting</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">Service</span><span class="token double-colon punctuation">::</span><span class="token function">is_exec_service_running</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// If there's more work to do, wake up again immediately.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>am<span class="token punctuation">.</span><span class="token function">HasMoreCommands</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> epoll_timeout <span class="token operator">=</span> <span class="token number">0</span>ms<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// epoll.Wait 等待</span>
        <span class="token keyword">auto</span> pending_functions <span class="token operator">=</span> epoll<span class="token punctuation">.</span><span class="token function">Wait</span><span class="token punctuation">(</span>epoll_timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pending_functions<span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> pending_functions<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pending_functions<span class="token operator">-&gt;</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// We always reap children before responding to the other pending functions. This is to</span>
            <span class="token comment">// prevent a race where other daemons see that a service has exited and ask init to</span>
            <span class="token comment">// start it again via ctl.start before init has reaped it.</span>
            <span class="token function">ReapAnyOutstandingChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> function <span class="token operator">:</span> <span class="token operator">*</span>pending_functions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">(</span><span class="token operator">*</span>function<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsShuttingDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">HandleControlMessages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">SetUsbController</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     SecondStageMain 主要做的事情：
     <br/>
     1.监听子进程终止信号，并从程序表中移除对应子进程；
     <br/>
     2.解析 init.rc 文件；
     <br/>
     3.向执行队列中添加 action；
     <br/>
     4.循环处理脚本中事件；
    </p>
    <p>
     （4）init 进程解析 init.rc，
     <code>
      LoadBootScripts(am, sm)
     </code>
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// frameworks/core/core/init/init.cpp</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">LoadBootScripts</span><span class="token punctuation">(</span>ActionManager<span class="token operator">&amp;</span> action_manager<span class="token punctuation">,</span> ServiceList<span class="token operator">&amp;</span> service_list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Parser parser <span class="token operator">=</span> <span class="token function">CreateParser</span><span class="token punctuation">(</span>action_manager<span class="token punctuation">,</span> service_list<span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>string bootscript <span class="token operator">=</span> <span class="token function">GetProperty</span><span class="token punctuation">(</span><span class="token string">"ro.boot.init_rc"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>bootscript<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 解析 init.rc</span>
        parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/system/etc/init/hw/init.rc"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/system/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            late_import_paths<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token string">"/system/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// late_import is available only in Q and earlier release. As we don't</span>
        <span class="token comment">// have system_ext in those versions, skip late_import for system_ext.</span>
        parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/system_ext/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/product/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            late_import_paths<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token string">"/product/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/odm/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            late_import_paths<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token string">"/odm/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span><span class="token string">"/vendor/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            late_import_paths<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span><span class="token string">"/vendor/etc/init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        parser<span class="token punctuation">.</span><span class="token function">ParseConfig</span><span class="token punctuation">(</span>bootscript<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

Parser <span class="token function">CreateParser</span><span class="token punctuation">(</span>ActionManager<span class="token operator">&amp;</span> action_manager<span class="token punctuation">,</span> ServiceList<span class="token operator">&amp;</span> service_list<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Parser parser<span class="token punctuation">;</span>

    parser<span class="token punctuation">.</span><span class="token function">AddSectionParser</span><span class="token punctuation">(</span><span class="token string">"service"</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>ServiceParser<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>
                                               <span class="token operator">&amp;</span>service_list<span class="token punctuation">,</span> <span class="token function">GetSubcontext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>nullopt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    parser<span class="token punctuation">.</span><span class="token function">AddSectionParser</span><span class="token punctuation">(</span><span class="token string">"on"</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>ActionParser<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>action_manager<span class="token punctuation">,</span> <span class="token function">GetSubcontext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    parser<span class="token punctuation">.</span><span class="token function">AddSectionParser</span><span class="token punctuation">(</span><span class="token string">"import"</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span>ImportParser<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>parser<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> parser<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     这里就是创建了一个解析器 Parser，然后一行行解析 init.rc 文件。
    </p>
    <p>
     init.rc 文件中定义了系统启动时需要执行的一系列命令和服务。init.rc 文件的位置和内容会根据 Android 系统的版本和设置的不同而有所差异。
     <br/>
     在 Android 系统中，init.rc 文件通常位于以下路径：
     <code>
      /system/etc/init/init.rc
     </code>
     或者在某些设备上，它可能位于：
     <code>
      /init.rc
     </code>
     。
    </p>
    <p>
     <strong>
      init 进程启动总结：
     </strong>
     <br/>
     init 进程会走 main.cpp，然后分阶段去执行 main 函数，这个调用是循环的方式，最后一个阶段是 SecondStageMain，里面执行了一个非常重要的方法 LoadBootScript(am, sm)，这个方法解析了 init.rc 文件，并将这些命令写到 am 和 sm 中，在 while 循环里面，通过 ExecuteOneCommand 去执行这些命令。其中就包含了启动 zygote 的命令。当然，这个 while 循环 是一个死循环，为什么是死循环呢？进程一定是活着的。那要是没事做怎么办？睡眠、等待。那就是有用 epoll.wait。
    </p>
    <p>
     init 做的事：
     <br/>
     1.挂载文件：识别各类文件，相当于解析硬盘；
     <br/>
     2.设置 selinux – 安全策略，安全内核，属性权限；
     <br/>
     3.启动属性服务；
     <br/>
     4.解析 init.rc 执行脚本中一行一行的 Linux 命令来启动进程；
     <br/>
     5.循环处理脚本–包括启动 zygote，包括启动 ServiceManager 进程；
     <br/>
     6. 守护系统关键进程：如蓝牙、铃声、接打电话、安装应用等进程名结尾带“d”的系统进程；
    </p>
    <p>
     最重要的事：
     <br/>
     1.启动了 zygote，启动了 ServiceManager（系统服务的 binder 的管家）进程；
     <br/>
     2. 守护服务：假设 zygote 进程挂了，那 zygote 进程下的所有子进程都可能会被杀，整个 Android 系统会出现大问题。这就需要把 zygote 进程重启起来。init 进程守护服务做的就是这些事，当接收到子进程退出信号，就会触发对应的函数进行处理，去根据这个进程所对应的服务，处理后事（重启等）。
    </p>
    <h2>
     <a id="3_zygote__551">
     </a>
     3. zygote 进程启动过程
    </h2>
    <p>
     启动 zygote ，有
     <code>
      init.zygote32.rc
     </code>
     32位系统 和
     <code>
      init.zygote64.rc
     </code>
     64位系统。
     <br/>
     如
     <code>
      init.zygote32.rc
     </code>
     ：启动 zygote。
    </p>
    <pre><code class="prism language-cpp">service zygote <span class="token operator">/</span>system<span class="token operator">/</span>bin<span class="token operator">/</span>app_process <span class="token operator">-</span>Xzygote <span class="token operator">/</span>system<span class="token operator">/</span>bin <span class="token operator">--</span>zygote <span class="token operator">--</span>start<span class="token operator">-</span>system<span class="token operator">-</span>server
</code></pre>
    <p>
     zygote 一部分在 Native，一部分在 Java，承上启下。
    </p>
    <p>
     <strong>
      （1）先看 zygote 的 native 部分：
     </strong>
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// frameworks/base/cmds/app_process/app_main.cpp</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>LOG_NDEBUG<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      String8 argv_String<span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        argv_String<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        argv_String<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        argv_String<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"app_process main with argv: %s"</span><span class="token punctuation">,</span> argv_String<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 创建 AppRuntime 对象，用于管理 Android 运行时环境</span>
    AppRuntime <span class="token function">runtime</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token function">computeArgBlockSize</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Process command line arguments</span>
    <span class="token comment">// ignore argv[0]</span>
    argc<span class="token operator">--</span><span class="token punctuation">;</span>
    argv<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> spaced_commands<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"-cp"</span><span class="token punctuation">,</span> <span class="token string">"-classpath"</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// Allow "spaced commands" to be succeeded by exactly 1 argument (regardless of -s).</span>
    <span class="token keyword">bool</span> known_command <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>known_command <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          runtime<span class="token punctuation">.</span><span class="token function">addOption</span><span class="token punctuation">(</span><span class="token function">strdup</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将特殊命令的参数添加到运行时选项</span>
          <span class="token comment">// The static analyzer gets upset that we don't ever free the above</span>
          <span class="token comment">// string. Since the allocation is from main, leaking it doesn't seem</span>
          <span class="token comment">// problematic. NOLINTNEXTLINE</span>
          <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"app_process main add known option '%s'"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          known_command <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 检查是否为特殊命令（如 -cp 或 -classpath）</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
             j <span class="token operator">&lt;</span> <span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>spaced_commands<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>spaced_commands<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> spaced_commands<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            known_command <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"app_process main found known command '%s'"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 如果参数不以 '-' 开头，停止解析 VM 参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token char">'-'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果参数是 '--'，跳过它并停止解析 VM 参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'-'</span> <span class="token operator">&amp;&amp;</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">++</span>i<span class="token punctuation">;</span> <span class="token comment">// Skip --.</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 将 VM 参数添加到运行时选项</span>
        runtime<span class="token punctuation">.</span><span class="token function">addOption</span><span class="token punctuation">(</span><span class="token function">strdup</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// The static analyzer gets upset that we don't ever free the above</span>
        <span class="token comment">// string. Since the allocation is from main, leaking it doesn't seem</span>
        <span class="token comment">// problematic. NOLINTNEXTLINE</span>
        <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"app_process main add option '%s'"</span><span class="token punctuation">,</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 解析运行时参数，确定运行模式和相关配置</span>
    <span class="token keyword">bool</span> zygote <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 是否以 Zygote 模式启动</span>
    <span class="token keyword">bool</span> startSystemServer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 是否启动系统服务</span>
    <span class="token keyword">bool</span> application <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 是否以应用程序模式启动</span>
    String8 niceName<span class="token punctuation">;</span>
    String8 className<span class="token punctuation">;</span>

    <span class="token operator">++</span>i<span class="token punctuation">;</span>  <span class="token comment">// Skip unused "parent dir" argument.</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;</span> argc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> arg <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"--zygote"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            zygote <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 设置为 Zygote 模式</span>
            niceName <span class="token operator">=</span> ZYGOTE_NICE_NAME<span class="token punctuation">;</span> <span class="token comment">// 设置进程名称为 "zygote"</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"--start-system-server"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            startSystemServer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 设置启动系统服务</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"--application"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            application <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 设置为应用程序模式</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"--nice-name="</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            niceName<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>arg <span class="token operator">+</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strncmp</span><span class="token punctuation">(</span>arg<span class="token punctuation">,</span> <span class="token string">"--"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            className<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">--</span>i<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 准备传递给 RuntimeInit 或 ZygoteInit 的参数</span>
    Vector<span class="token operator">&lt;</span>String8<span class="token operator">&gt;</span> args<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>className<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">// 如果不是 Zygote 模式，将主类名和剩余参数传递给 RuntimeInit</span>
        args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>application <span class="token operator">?</span> <span class="token function">String8</span><span class="token punctuation">(</span><span class="token string">"application"</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">String8</span><span class="token punctuation">(</span><span class="token string">"tool"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        runtime<span class="token punctuation">.</span><span class="token function">setClassNameAndArgs</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> argc <span class="token operator">-</span> i<span class="token punctuation">,</span> argv <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>LOG_NDEBUG<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          String8 restOfArgs<span class="token punctuation">;</span>
          <span class="token keyword">char</span><span class="token operator">*</span> <span class="token keyword">const</span><span class="token operator">*</span> argv_new <span class="token operator">=</span> argv <span class="token operator">+</span> i<span class="token punctuation">;</span>
          <span class="token keyword">int</span> argc_new <span class="token operator">=</span> argc <span class="token operator">-</span> i<span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> argc_new<span class="token punctuation">;</span> <span class="token operator">++</span>k<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            restOfArgs<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            restOfArgs<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>argv_new<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            restOfArgs<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"\" "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token function">ALOGV</span><span class="token punctuation">(</span><span class="token string">"Class name = %s, args = %s"</span><span class="token punctuation">,</span> className<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> restOfArgs<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 如果是 Zygote 模式，创建 Dalvik 缓存（如果需要）</span>
        <span class="token function">maybeCreateDalvikCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 如果需要启动系统服务，添加参数</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">String8</span><span class="token punctuation">(</span><span class="token string">"start-system-server"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 获取 ABI 列表并添加到参数中</span>
        <span class="token keyword">char</span> prop<span class="token punctuation">[</span>PROP_VALUE_MAX<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">property_get</span><span class="token punctuation">(</span>ABI_LIST_PROPERTY<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG_ALWAYS_FATAL</span><span class="token punctuation">(</span><span class="token string">"app_process: Unable to determine ABI list from property %s."</span><span class="token punctuation">,</span>
                ABI_LIST_PROPERTY<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">11</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        String8 <span class="token function">abiFlag</span><span class="token punctuation">(</span><span class="token string">"--abi-list="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        abiFlag<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
        args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>abiFlag<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// In zygote mode, pass all remaining arguments to the zygote</span>
        <span class="token comment">// main() method.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argc<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            args<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">String8</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>niceName<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        runtime<span class="token punctuation">.</span><span class="token function">setArgv0</span><span class="token punctuation">(</span>niceName<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span> <span class="token comment">/* setProcName */</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 根据运行模式启动相应的 Java 类</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>zygote<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 以 Zygote 模式启动，调用 ZygoteInit</span>
        runtime<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"com.android.internal.os.ZygoteInit"</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> zygote<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>className<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
    	<span class="token comment">// 以应用程序模式启动，调用 RuntimeInit</span>
        runtime<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token string">"com.android.internal.os.RuntimeInit"</span><span class="token punctuation">,</span> args<span class="token punctuation">,</span> zygote<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 如果未提供类名或 --zygote 参数，报错并退出</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error: no class name or --zygote supplied.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">app_usage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG_ALWAYS_FATAL</span><span class="token punctuation">(</span><span class="token string">"app_process: no class name or --zygote supplied."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     重点看一下
     <code>
      runtime.start("com.android.internal.os.ZygoteInit", args, zygote)
     </code>
     ，
    </p>
    <pre><code class="prism language-cpp"><span class="token comment">// frameworks/base/core/jni/AndroidRuntime.cpp</span>
<span class="token comment">/*
 * 启动虚拟机
 */</span>
<span class="token keyword">void</span> <span class="token class-name">AndroidRuntime</span><span class="token double-colon punctuation">::</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> className<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector<span class="token operator">&lt;</span>String8<span class="token operator">&gt;</span><span class="token operator">&amp;</span> options<span class="token punctuation">,</span> <span class="token keyword">bool</span> zygote<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 打印启动日志，显示要启动的类名和当前用户 ID</span>
    <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"&gt;&gt;&gt;&gt;&gt;&gt; START %s uid %d &lt;&lt;&lt;&lt;&lt;&lt;\n"</span><span class="token punctuation">,</span>
            className <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">?</span> className <span class="token operator">:</span> <span class="token string">"(unknown)"</span><span class="token punctuation">,</span> <span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 定义常量字符串 "start-system-server"，用于判断是否需要启动系统服务</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> String8 <span class="token function">startSystemServer</span><span class="token punctuation">(</span><span class="token string">"start-system-server"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Whether this is the primary zygote, meaning the zygote which will fork system server.</span>
    <span class="token keyword">bool</span> primary_zygote <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 是否是主 Zygote 进程</span>

    <span class="token comment">// 遍历options，检查是否需要启动系统服务</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> options<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            primary_zygote <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 如果是 Zygote 进程，标记为 true</span>
           <span class="token comment">// 记录系统启动进度</span>
           <span class="token keyword">const</span> <span class="token keyword">int</span> LOG_BOOT_PROGRESS_START <span class="token operator">=</span> <span class="token number">3000</span><span class="token punctuation">;</span>
           <span class="token function">LOG_EVENT_LONG</span><span class="token punctuation">(</span>LOG_BOOT_PROGRESS_START<span class="token punctuation">,</span>  <span class="token function">ns2ms</span><span class="token punctuation">(</span><span class="token function">systemTime</span><span class="token punctuation">(</span>SYSTEM_TIME_MONOTONIC<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	<span class="token comment">// 获取 Android 根目录环境变量，如果未设置，默认使用 "/system"</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> rootDir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"ANDROID_ROOT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rootDir <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        rootDir <span class="token operator">=</span> <span class="token string">"/system"</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasDir</span><span class="token punctuation">(</span><span class="token string">"/system"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG_FATAL</span><span class="token punctuation">(</span><span class="token string">"No root directory specified, and /system does not exist."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">setenv</span><span class="token punctuation">(</span><span class="token string">"ANDROID_ROOT"</span><span class="token punctuation">,</span> rootDir<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置环境变量</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 检查 ART 根目录环境变量，如果未设置，报错并退出</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> artRootDir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"ANDROID_ART_ROOT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>artRootDir <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_FATAL</span><span class="token punctuation">(</span><span class="token string">"No ART directory specified with ANDROID_ART_ROOT environment variable."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> i18nRootDir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"ANDROID_I18N_ROOT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i18nRootDir <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_FATAL</span><span class="token punctuation">(</span><span class="token string">"No runtime directory specified with ANDROID_I18N_ROOT environment variable."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> tzdataRootDir <span class="token operator">=</span> <span class="token function">getenv</span><span class="token punctuation">(</span><span class="token string">"ANDROID_TZDATA_ROOT"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tzdataRootDir <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">LOG_FATAL</span><span class="token punctuation">(</span><span class="token string">"No tz data directory specified with ANDROID_TZDATA_ROOT environment variable."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//const char* kernelHack = getenv("LD_ASSUME_KERNEL");</span>
    <span class="token comment">//ALOGD("Found LD_ASSUME_KERNEL='%s'\n", kernelHack);</span>

    <span class="token comment">// 初始化 JNI 调用接口</span>
    JniInvocation jni_invocation<span class="token punctuation">;</span>
    jni_invocation<span class="token punctuation">.</span><span class="token function">Init</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    JNIEnv<span class="token operator">*</span> env<span class="token punctuation">;</span>
    <span class="token comment">// 代码1 启动 Java 虚拟机</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startVm</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mJavaVM<span class="token punctuation">,</span> <span class="token operator">&amp;</span>env<span class="token punctuation">,</span> zygote<span class="token punctuation">,</span> primary_zygote<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
        <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// 如果启动失败，直接返回</span>
    <span class="token punctuation">}</span>
    <span class="token function">onVmCreated</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 虚拟机创建后的回调</span>

    <span class="token comment">// 代码2 注册 Android 常用的 JNI 方法</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">startReg</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//×¢²áandroid ³£ÓÃµÄJNI</span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"Unable to register all android natives\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
     * We want to call main() with a String array with arguments in it.
     * At present we have two arguments, the class name and an option string.
     * Create an array to hold them.
     */</span>
    jclass stringClass<span class="token punctuation">;</span>
    jobjectArray strArray<span class="token punctuation">;</span>
    jstring classNameStr<span class="token punctuation">;</span>

    stringClass <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">FindClass</span><span class="token punctuation">(</span><span class="token string">"java/lang/String"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>stringClass <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    strArray <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">NewObjectArray</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> stringClass<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>strArray <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    classNameStr <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>classNameStr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    env<span class="token operator">-&gt;</span><span class="token function">SetObjectArrayElement</span><span class="token punctuation">(</span>strArray<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> classNameStr<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> options<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        jstring optionsStr <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">NewStringUTF</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span><span class="token function">itemAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">assert</span><span class="token punctuation">(</span>optionsStr <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        env<span class="token operator">-&gt;</span><span class="token function">SetObjectArrayElement</span><span class="token punctuation">(</span>strArray<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> optionsStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/*
     * Start VM.  This thread becomes the main thread of the VM, and will
     * not return until the VM exits.
     */</span>
    <span class="token comment">// 查找要启动的类</span>
    <span class="token keyword">char</span><span class="token operator">*</span> slashClassName <span class="token operator">=</span> <span class="token function">toSlashClassName</span><span class="token punctuation">(</span>className <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">?</span> className <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jclass startClass <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">FindClass</span><span class="token punctuation">(</span>slashClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>startClass <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"JavaVM unable to locate class '%s'\n"</span><span class="token punctuation">,</span> slashClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* keep going */</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// 查找类的 main 方法</span>
        jmethodID startMeth <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetStaticMethodID</span><span class="token punctuation">(</span>startClass<span class="token punctuation">,</span> <span class="token string">"main"</span><span class="token punctuation">,</span>
            <span class="token string">"([Ljava/lang/String;)V"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>startMeth <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"JavaVM unable to find main() in '%s'\n"</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/* keep going */</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        	<span class="token comment">// 代码3 调用 main 方法，传入参数数组</span>
            env<span class="token operator">-&gt;</span><span class="token function">CallStaticVoidMethod</span><span class="token punctuation">(</span>startClass<span class="token punctuation">,</span> startMeth<span class="token punctuation">,</span> strArray<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token number">0</span></span></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>env<span class="token operator">-&gt;</span><span class="token function">ExceptionCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">threadExitUncaughtException</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">free</span><span class="token punctuation">(</span>slashClassName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ALOGD</span><span class="token punctuation">(</span><span class="token string">"Shutting down VM\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mJavaVM<span class="token operator">-&gt;</span><span class="token function">DetachCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Warning: unable to detach main thread\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mJavaVM<span class="token operator">-&gt;</span><span class="token function">DestroyJavaVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">ALOGW</span><span class="token punctuation">(</span><span class="token string">"Warning: VM did not shut down cleanly\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <p>
     app_process 中 app_main.cpp 的 main() 方法主要做的事情有：
     <br/>
     调用
     <code>
      runtime.start("com.android.internal.os.ZygoteInit", args, zygote)
     </code>
    </p>
    <ol>
     <li>
      startVm 启动 JVM 虚拟机；
     </li>
     <li>
      startReg() 注册 JNI，zygote 是开启 java 世界的，Java 和 native 通信是通过 JNI，所以需要在 zygote 注册 jni；
     </li>
     <li>
      env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray)，使用 JNI 调用 ZygoteInit.java 的 main() 方法，进入 java 世界；
     </li>
    </ol>
    <p>
     <strong>
      （2）再看 zygote 的 java 部分：
     </strong>
    </p>
    <pre><code class="prism language-java">	<span class="token comment">// frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">// Zygote 服务对象</span>
        <span class="token class-name">ZygoteServer</span> zygoteServer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token comment">// 标记 Zygote 启动，确保在 Zygote 启动期间不会创建新线程</span>
        <span class="token class-name">ZygoteHooks</span><span class="token punctuation">.</span><span class="token function">startZygoteNoThreadCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 将 Zygote 进程放入自己的进程组</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Os</span><span class="token punctuation">.</span><span class="token function">setpgid</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ErrnoException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Failed to setpgid(0,0)"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">Runnable</span> caller<span class="token punctuation">;</span><span class="token comment">// 用于存储子进程的任务</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// Store now for StatsLogging later.</span>
            <span class="token keyword">final</span> <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">elapsedRealtime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> isRuntimeRestarted <span class="token operator">=</span> <span class="token string">"1"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>
                    <span class="token class-name">SystemProperties</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"sys.boot_completed"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 判断是否是运行时重启</span>

            <span class="token class-name">String</span> bootTimeTag <span class="token operator">=</span> <span class="token class-name">Process</span><span class="token punctuation">.</span><span class="token function">is64Bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"Zygote64Timing"</span> <span class="token operator">:</span> <span class="token string">"Zygote32Timing"</span><span class="token punctuation">;</span>
            <span class="token class-name">TimingsTraceLog</span> bootTimingsTraceLog <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TimingsTraceLog</span><span class="token punctuation">(</span>bootTimeTag<span class="token punctuation">,</span>
                    <span class="token class-name">Trace</span><span class="token punctuation">.</span><span class="token constant">TRACE_TAG_DALVIK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token string">"ZygoteInit"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 开始记录 Zygote 初始化时间</span>
            <span class="token comment">// 在 fork 之前进行一些初始化工作</span>
            <span class="token class-name">RuntimeInit</span><span class="token punctuation">.</span><span class="token function">preForkInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
			<span class="token comment">// 解析命令行参数</span>
            <span class="token keyword">boolean</span> startSystemServer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 是否需要启动系统服务</span>
            <span class="token class-name">String</span> zygoteSocketName <span class="token operator">=</span> <span class="token string">"zygote"</span><span class="token punctuation">;</span> <span class="token comment">// Zygote 的 Socket 名称</span>
            <span class="token class-name">String</span> abiList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token comment">// ABI 列表</span>
            <span class="token keyword">boolean</span> enableLazyPreload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 是否启用延迟预加载</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argv<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"start-system-server"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    startSystemServer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 需要启动系统服务</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"--enable-lazy-preload"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    enableLazyPreload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 启用延迟预加载</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">ABI_LIST_ARG</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    abiList <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token constant">ABI_LIST_ARG</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token constant">SOCKET_NAME_ARG</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    zygoteSocketName <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token constant">SOCKET_NAME_ARG</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Unknown command line argument: "</span> <span class="token operator">+</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
		
			<span class="token comment">// 判断是否是 Zygote 进程</span>
            <span class="token keyword">final</span> <span class="token keyword">boolean</span> isPrimaryZygote <span class="token operator">=</span> zygoteSocketName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token constant">PRIMARY_SOCKET_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isRuntimeRestarted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>isPrimaryZygote<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">FrameworkStatsLog</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">FrameworkStatsLog</span><span class="token punctuation">.</span><span class="token constant">BOOT_TIME_EVENT_ELAPSED_TIME_REPORTED</span><span class="token punctuation">,</span>
                            <span class="token constant">BOOT_TIME_EVENT_ELAPSED_TIME__EVENT__ZYGOTE_INIT_START</span><span class="token punctuation">,</span>
                            startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>zygoteSocketName<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token constant">SECONDARY_SOCKET_NAME</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token class-name">FrameworkStatsLog</span><span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">FrameworkStatsLog</span><span class="token punctuation">.</span><span class="token constant">BOOT_TIME_EVENT_ELAPSED_TIME_REPORTED</span><span class="token punctuation">,</span>
                            <span class="token constant">BOOT_TIME_EVENT_ELAPSED_TIME__EVENT__SECONDARY_ZYGOTE_INIT_START</span><span class="token punctuation">,</span>
                            startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>abiList <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"No ABI list supplied."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// In some configurations, we avoid preloading resources and classes eagerly.</span>
            <span class="token comment">// 如果不启用延迟预加载，立即预加载资源和类</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enableLazyPreload<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token string">"ZygotePreload"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">EventLog</span><span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span><span class="token constant">LOG_BOOT_PROGRESS_PRELOAD_START</span><span class="token punctuation">,</span>
                        <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// 第一步 预加载资源和类</span>
                <span class="token function">preload</span><span class="token punctuation">(</span>bootTimingsTraceLog<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">EventLog</span><span class="token punctuation">.</span><span class="token function">writeEvent</span><span class="token punctuation">(</span><span class="token constant">LOG_BOOT_PROGRESS_PRELOAD_END</span><span class="token punctuation">,</span>
                        <span class="token class-name">SystemClock</span><span class="token punctuation">.</span><span class="token function">uptimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ZygotePreload</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// Do an initial gc to clean up after startup</span>
            bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token string">"PostZygoteInitGC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">gcAndFinalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// PostZygoteInitGC</span>

            bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// ZygoteInit</span>

			<span class="token comment">// 初始化 Zygote 的本地状态</span>
            <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">initNativeState</span><span class="token punctuation">(</span>isPrimaryZygote<span class="token punctuation">)</span><span class="token punctuation">;</span> 

            <span class="token class-name">ZygoteHooks</span><span class="token punctuation">.</span><span class="token function">stopZygoteNoThreadCreation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//第二步 创建 Zygote 服务对象，用于监听和处理请求，ZygoteServer 就是socket</span>
            zygoteServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteServer</span><span class="token punctuation">(</span>isPrimaryZygote<span class="token punctuation">)</span><span class="token punctuation">;</span>  

            <span class="token keyword">if</span> <span class="token punctuation">(</span>startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//第三步 如果需要启动系统服务，fork 出系统服务进程</span>
                <span class="token class-name">Runnable</span> r <span class="token operator">=</span> <span class="token function">forkSystemServer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">,</span> zygoteSocketName<span class="token punctuation">,</span> zygoteServer<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// {@code r == null} in the parent (zygote) process, and {@code r != null} in the</span>
                <span class="token comment">// child (system_server) process.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Accepting command socket connections"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// The select loop returns early in the child process after a fork and</span>
            <span class="token comment">// loops forever in the zygote.</span>
           <span class="token comment">//第四步 进入死循环，监听和处理来自其他进程的请求</span>
            caller <span class="token operator">=</span> zygoteServer<span class="token punctuation">.</span><span class="token function">runSelectLoop</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"System zygote died with exception"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>zygoteServer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// We're in the child process and have exited the select loop. Proceed to execute the</span>
        <span class="token comment">// command.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>caller <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 在子进程中执行任务</span>
            caller<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre>
    <p>
     ZygoteInit.java 的 main() 方法中主要的做的事情：
     <br/>
     1）调用 preload() 预加载资源和类;
     <br/>
     2) new ZygoteServer()，创建 Zygote 服务对象，用于监听和处理请求，ZygoteServer 就是 socket；
     <br/>
     3）调用 forkSystemServer()，fork 出 systemserver 进程；
     <br/>
     4）调用 zygoteServer.runSelectLoop()，进入死循环，监听和处理来自其他进程的请求;
    </p>
    <p>
     <strong>
      zygote 进程启动过程总结：
     </strong>
    </p>
    <ul>
     <li>
      native 层
      <ul>
       <li>
        初始化运行环境，调用 startVm() 创建 JVM Android 虚拟机；
       </li>
       <li>
        注册 JNI 方法；
       </li>
       <li>
        使用 JNI 调用 ZygoteInit 的 main 函数，进入 java 世界；
       </li>
      </ul>
     </li>
     <li>
      Java 层
      <ul>
       <li>
        调用 preload() 预加载信息：加快进程启动；
       </li>
       <li>
        new ZygoteServer() 创建 zygote 的 socket 服务；
       </li>
       <li>
        调用 forkSystemServer()，fork 出 systemserver 进程；
       </li>
       <li>
        调用 ZygoteServer.runSelectLoop() 让 zygote 进入无限循环，监听和处理来自其他进程的请求；
       </li>
      </ul>
     </li>
    </ul>
    <h2>
     <a id="_1001">
     </a>
     总结
    </h2>
    <p>
     通过分析，我们知道了Android 系统的启动流程可以分为以下几个阶段：
    </p>
    <ol>
     <li>
      首先，Bootloader 初始化硬件并加载 Linux 内核。
     </li>
     <li>
      内核启动后，运行第一个用户空间进程 init，它解析 init.rc 脚本，启动 Zygote 进程。
     </li>
     <li>
      Zygote 进程预加载系统类和资源，并 fork 出 SystemServer 进程。
     </li>
     <li>
      SystemServer 启动核心系统服务，如 ActivityManagerService 和 PackageManagerService，并启动 Launcher 应用。
     </li>
     <li>
      当用户点击应用图标时，ActivityManagerService 向 Zygote 发送请求，Zygote fork 出应用进程，最终启动应用的 Activity。
     </li>
    </ol>
    <p>
     在整个启动流程中，Zygote 的预加载机制和 SystemServer 的服务管理是 Android 系统高效运行的关键。
    </p>
    <p>
     本篇介绍了init 进程和 Zygote 进程，关于 SystemServer 介绍可以看后续文章。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f:626c6f672e6373646e2e6e65742f426f6e6e69655f6361742f:61727469636c652f64657461696c732f313436313731383838" class_="artid" style="display:none">
 </p>
</div>


