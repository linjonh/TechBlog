---
layout: post
title: "Agentic系统负载均衡与Redis缓存优化"
date: 2025-03-06 11:09:13 +0800
description: "本文在前文Agentic系统的基础上，新增负载均衡（动态调整线程数以避免API限流）和缓存机制（使用Redis存储搜索结果，减少API调用）。通过这些优化，系统在高并发场景下更加稳定高效。代码完整可运行，适合AI开发者和自动化工作流研究者参考。基于之前的Agentic系统，我们的目标是：无需额外安装，依赖Python内置模块。缓存机制：集成Redis实现思路使用Redis存储搜索结果，键为查询字符串，值为结果。在调用API前检查缓存，若命中则直接返回缓存结果。前提条件安装Redis：安"
keywords: "Agentic系统：负载均衡与Redis缓存优化"
categories: ['未分类']
tags: ['负载均衡', '缓存', 'Redis']
artid: "146063296"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146063296
    alt: "Agentic系统负载均衡与Redis缓存优化"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146063296
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146063296
cover: https://bing.ee123.net/img/rand?artid=146063296
image: https://bing.ee123.net/img/rand?artid=146063296
img: https://bing.ee123.net/img/rand?artid=146063296
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Agentic系统：负载均衡与Redis缓存优化
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h3>
     <a id="_2">
     </a>
     摘要
    </h3>
    <p>
     本文在前文Agentic系统的基础上，新增负载均衡（动态调整线程数以避免API限流）和缓存机制（使用Redis存储搜索结果，减少API调用）。通过这些优化，系统在高并发场景下更加稳定高效。代码完整可运行，适合AI开发者和自动化工作流研究者参考。
    </p>
    <hr/>
    <h3>
     <a id="_7">
     </a>
     目录
    </h3>
    <ol>
     <li>
      <a href="#%E4%BC%98%E5%8C%96%E7%9B%AE%E6%A0%87" rel="nofollow">
       优化目标
      </a>
     </li>
     <li>
      <a href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%EF%BC%9A%E5%8A%A8%E6%80%81%E8%B0%83%E6%95%B4%E7%BA%BF%E7%A8%8B%E6%95%B0" rel="nofollow">
       负载均衡：动态调整线程数
      </a>
     </li>
     <li>
      <a href="#%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%EF%BC%9A%E9%9B%86%E6%88%90Redis" rel="nofollow">
       缓存机制：集成Redis
      </a>
     </li>
     <li>
      <a href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" rel="nofollow">
       完整代码实现
      </a>
     </li>
     <li>
      <a href="#%E8%BF%90%E8%A1%8C%E7%BB%93%E6%9E%9C%E4%B8%8E%E5%88%86%E6%9E%90" rel="nofollow">
       运行结果与分析
      </a>
     </li>
     <li>
      <a href="#%E5%90%8E%E7%BB%AD%E4%BC%98%E5%8C%96%E5%BB%BA%E8%AE%AE" rel="nofollow">
       后续优化建议
      </a>
     </li>
    </ol>
    <hr/>
    <h3>
     <a id="_17">
     </a>
     优化目标
    </h3>
    <p>
     基于之前的Agentic系统，我们的目标是：
    </p>
    <ul>
     <li>
      <strong>
       稳定性
      </strong>
      ：通过负载均衡动态调整线程数，避免API限流。
     </li>
     <li>
      <strong>
       效率
      </strong>
      ：使用Redis缓存搜索结果，减少重复API调用。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="_25">
     </a>
     负载均衡：动态调整线程数
    </h3>
    <h4>
     <a id="_27">
     </a>
     实现思路
    </h4>
    <ul>
     <li>
      根据任务数量和API响应时间动态调整线程数。
     </li>
     <li>
      使用简单规则：任务数多时增加线程，响应慢时减少线程，避免超载。
     </li>
    </ul>
    <h4>
     <a id="_31">
     </a>
     前提条件
    </h4>
    <p>
     无需额外安装，依赖Python内置模块。
    </p>
    <h4>
     <a id="WorkflowEngine_34">
     </a>
     修改WorkflowEngine
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor

<span class="token keyword">class</span> <span class="token class-name">WorkflowEngine</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task_manager<span class="token punctuation">:</span> TaskManager<span class="token punctuation">,</span> agents<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Agent<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>task_manager <span class="token operator">=</span> task_manager
        self<span class="token punctuation">.</span>agents <span class="token operator">=</span> agents
        self<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>response_times <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 记录API响应时间</span>

    <span class="token keyword">def</span> <span class="token function">adjust_thread_count</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task_count<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        avg_response_time <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>response_times<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>response_times<span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>response_times <span class="token keyword">else</span> <span class="token number">1</span>
        <span class="token keyword">if</span> avg_response_time <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">:</span>  <span class="token comment"># 响应时间超2秒减少线程</span>
            <span class="token keyword">return</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>task_count<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> task_count <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">:</span>  <span class="token comment"># 任务多时增加线程</span>
            <span class="token keyword">return</span> <span class="token builtin">min</span><span class="token punctuation">(</span>task_count<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">min</span><span class="token punctuation">(</span>task_count<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>  <span class="token comment"># 默认最多3个线程</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            ready_tasks <span class="token operator">=</span> self<span class="token punctuation">.</span>task_manager<span class="token punctuation">.</span>get_ready_tasks<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> ready_tasks<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            max_workers <span class="token operator">=</span> self<span class="token punctuation">.</span>adjust_thread_count<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>ready_tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">with</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span>max_workers<span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
                futures <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                    executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>agents<span class="token punctuation">[</span>task<span class="token punctuation">.</span>agent<span class="token punctuation">]</span><span class="token punctuation">.</span>execute<span class="token punctuation">,</span> task<span class="token punctuation">,</span> self<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span> task
                    <span class="token keyword">for</span> task <span class="token keyword">in</span> ready_tasks
                <span class="token punctuation">}</span>
                <span class="token keyword">for</span> future <span class="token keyword">in</span> futures<span class="token punctuation">:</span>
                    task <span class="token operator">=</span> futures<span class="token punctuation">[</span>future<span class="token punctuation">]</span>
                    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">try</span><span class="token punctuation">:</span>
                        result <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        task<span class="token punctuation">.</span>result <span class="token operator">=</span> result
                        self<span class="token punctuation">.</span>context<span class="token punctuation">[</span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span> <span class="token operator">=</span> result
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"任务 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string"> 完成: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"任务 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string"> 失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>response_times<span class="token punctuation">.</span>append<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>response_times<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">:</span>  <span class="token comment"># 保留最近10次记录</span>
                        self<span class="token punctuation">.</span>response_times<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>context
</code></pre>
    <hr/>
    <h3>
     <a id="Redis_82">
     </a>
     缓存机制：集成Redis
    </h3>
    <h4>
     <a id="_84">
     </a>
     实现思路
    </h4>
    <ul>
     <li>
      使用Redis存储搜索结果，键为查询字符串，值为结果。
     </li>
     <li>
      在调用API前检查缓存，若命中则直接返回缓存结果。
     </li>
    </ul>
    <h4>
     <a id="_88">
     </a>
     前提条件
    </h4>
    <ol>
     <li>
      <p>
       <strong>
        安装Redis
       </strong>
       ：
      </p>
      <ul>
       <li>
        本地安装Redis服务器（或使用云服务）。
       </li>
       <li>
        启动Redis：
        <code>
         redis-server
        </code>
       </li>
      </ul>
     </li>
     <li>
      <p>
       <strong>
        安装Python库
       </strong>
       ：
      </p>
      <pre><code class="prism language-bash">pip <span class="token function">install</span> redis
</code></pre>
     </li>
    </ol>
    <h4>
     <a id="ExecutionAgentValidationAgent_98">
     </a>
     修改ExecutionAgent与ValidationAgent
    </h4>
    <pre><code class="prism language-python"><span class="token keyword">import</span> redis

<span class="token keyword">class</span> <span class="token class-name">ExecutionAgent</span><span class="token punctuation">(</span>Agent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serpapi_key <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"SERPAPI_KEY"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bing_key <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"BING_API_KEY"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>redis_client <span class="token operator">=</span> redis<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span> db<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> decode_responses<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@retry</span><span class="token punctuation">(</span>stop<span class="token operator">=</span>stop_after_attempt<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wait<span class="token operator">=</span>wait_fixed<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> retry<span class="token operator">=</span>retry_if_exception_type<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">_search_serpapi</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        cached_result <span class="token operator">=</span> self<span class="token punctuation">.</span>redis_client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"serpapi:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> cached_result<span class="token punctuation">:</span>
            <span class="token keyword">return</span> cached_result
        search_params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"q"</span><span class="token punctuation">:</span> query<span class="token punctuation">,</span>
            <span class="token string">"api_key"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>serpapi_key<span class="token punctuation">,</span>
            <span class="token string">"engine"</span><span class="token punctuation">:</span> <span class="token string">"google"</span><span class="token punctuation">,</span>
            <span class="token string">"num"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            <span class="token string">"hl"</span><span class="token punctuation">:</span> <span class="token string">"zh-cn"</span><span class="token punctuation">,</span>
            <span class="token string">"gl"</span><span class="token punctuation">:</span> <span class="token string">"cn"</span>
        <span class="token punctuation">}</span>
        search <span class="token operator">=</span> GoogleSearch<span class="token punctuation">(</span>search_params<span class="token punctuation">)</span>
        results <span class="token operator">=</span> search<span class="token punctuation">.</span>get_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
        organic_results <span class="token operator">=</span> results<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"organic_results"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> organic_results<span class="token punctuation">:</span>
            result <span class="token operator">=</span> <span class="token string">"未找到结果。"</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> <span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">. </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'无标题'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'snippet'</span><span class="token punctuation">,</span> <span class="token string">'无描述'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
                <span class="token keyword">for</span> i<span class="token punctuation">,</span> result <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>organic_results<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>redis_client<span class="token punctuation">.</span>setex<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"serpapi:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>  <span class="token comment"># 缓存1小时</span>
        <span class="token keyword">return</span> result

    <span class="token decorator annotation punctuation">@retry</span><span class="token punctuation">(</span>stop<span class="token operator">=</span>stop_after_attempt<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wait<span class="token operator">=</span>wait_fixed<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> retry<span class="token operator">=</span>retry_if_exception_type<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">_search_bing</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        cached_result <span class="token operator">=</span> self<span class="token punctuation">.</span>redis_client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"bing:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> cached_result<span class="token punctuation">:</span>
            <span class="token keyword">return</span> cached_result
        url <span class="token operator">=</span> <span class="token string">"https://api.bing.microsoft.com/v7.0/search"</span>
        headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"Ocp-Apim-Subscription-Key"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>bing_key<span class="token punctuation">}</span>
        params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"q"</span><span class="token punctuation">:</span> query<span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"mkt"</span><span class="token punctuation">:</span> <span class="token string">"zh-CN"</span><span class="token punctuation">}</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span>
        response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
        results <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"webPages"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> results<span class="token punctuation">:</span>
            result <span class="token operator">=</span> <span class="token string">"未找到结果。"</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> <span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">. </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'无标题'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'snippet'</span><span class="token punctuation">,</span> <span class="token string">'无描述'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
                <span class="token keyword">for</span> i<span class="token punctuation">,</span> result <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>redis_client<span class="token punctuation">.</span>setex<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"bing:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>  <span class="token comment"># 缓存1小时</span>
        <span class="token keyword">return</span> result

    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task<span class="token punctuation">:</span> Task<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        query <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Agentic系统 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span>description<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>serpapi_key<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                summary <span class="token operator">=</span> self<span class="token punctuation">.</span>_search_serpapi<span class="token punctuation">(</span>query<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"执行任务 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span>description<span class="token punctuation">}</span></span><span class="token string">. SerpAPI结果：\n</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>summary<span class="token punctuation">}</span></span><span class="token string">"</span></span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SerpAPI失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">，尝试Bing API"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>bing_key<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                summary <span class="token operator">=</span> self<span class="token punctuation">.</span>_search_bing<span class="token punctuation">(</span>query<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"执行任务 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span>description<span class="token punctuation">}</span></span><span class="token string">. Bing结果：\n</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>summary<span class="token punctuation">}</span></span><span class="token string">"</span></span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"执行任务 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span>description<span class="token punctuation">}</span></span><span class="token string">. Bing调用失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"执行任务 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span>description<span class="token punctuation">}</span></span><span class="token string">. 未配置任何API密钥。"</span></span>
</code></pre>
    <p>
     <code>
      ValidationAgent
     </code>
     类似，添加Redis缓存。
    </p>
    <hr/>
    <h3>
     <a id="_177">
     </a>
     完整代码实现
    </h3>
    <pre><code class="prism language-python"><span class="token keyword">import</span> time
<span class="token keyword">import</span> os
<span class="token keyword">from</span> typing <span class="token keyword">import</span> List<span class="token punctuation">,</span> Dict
<span class="token keyword">from</span> dataclasses <span class="token keyword">import</span> dataclass
<span class="token keyword">from</span> serpapi <span class="token keyword">import</span> GoogleSearch
<span class="token keyword">import</span> requests
<span class="token keyword">import</span> redis
<span class="token keyword">from</span> tenacity <span class="token keyword">import</span> retry<span class="token punctuation">,</span> stop_after_attempt<span class="token punctuation">,</span> wait_fixed<span class="token punctuation">,</span> retry_if_exception_type
<span class="token keyword">from</span> concurrent<span class="token punctuation">.</span>futures <span class="token keyword">import</span> ThreadPoolExecutor

<span class="token decorator annotation punctuation">@dataclass</span>
<span class="token keyword">class</span> <span class="token class-name">Task</span><span class="token punctuation">:</span>
    <span class="token builtin">id</span><span class="token punctuation">:</span> <span class="token builtin">str</span>
    description<span class="token punctuation">:</span> <span class="token builtin">str</span>
    agent<span class="token punctuation">:</span> <span class="token builtin">str</span>
    dependencies<span class="token punctuation">:</span> List<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    result<span class="token punctuation">:</span> <span class="token builtin">str</span> <span class="token operator">=</span> <span class="token boolean">None</span>
    <span class="token keyword">def</span> <span class="token function">__post_init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>dependencies <span class="token operator">=</span> self<span class="token punctuation">.</span>dependencies <span class="token keyword">or</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">class</span> <span class="token class-name">Agent</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>name <span class="token operator">=</span> name
    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task<span class="token punctuation">:</span> Task<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> NotImplementedError

<span class="token keyword">class</span> <span class="token class-name">DescriptionAgent</span><span class="token punctuation">(</span>Agent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task<span class="token punctuation">:</span> Task<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"组件介绍：Agent, Task Manager, Workflow Engine, Context Store, Evaluator, Toolset, Logger"</span>

<span class="token keyword">class</span> <span class="token class-name">PlanningAgent</span><span class="token punctuation">(</span>Agent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task<span class="token punctuation">:</span> Task<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token string">"业务流：Task 1 (介绍组件) → Task 2 (生成业务流) → Task 3 (执行并评估) → Task 5 (验证完整性)"</span>

<span class="token keyword">class</span> <span class="token class-name">ExecutionAgent</span><span class="token punctuation">(</span>Agent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serpapi_key <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"SERPAPI_KEY"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bing_key <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"BING_API_KEY"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>redis_client <span class="token operator">=</span> redis<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span> db<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> decode_responses<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@retry</span><span class="token punctuation">(</span>stop<span class="token operator">=</span>stop_after_attempt<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wait<span class="token operator">=</span>wait_fixed<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> retry<span class="token operator">=</span>retry_if_exception_type<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">_search_serpapi</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        cached_result <span class="token operator">=</span> self<span class="token punctuation">.</span>redis_client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"serpapi:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> cached_result<span class="token punctuation">:</span>
            <span class="token keyword">return</span> cached_result
        search_params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"q"</span><span class="token punctuation">:</span> query<span class="token punctuation">,</span>
            <span class="token string">"api_key"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>serpapi_key<span class="token punctuation">,</span>
            <span class="token string">"engine"</span><span class="token punctuation">:</span> <span class="token string">"google"</span><span class="token punctuation">,</span>
            <span class="token string">"num"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            <span class="token string">"hl"</span><span class="token punctuation">:</span> <span class="token string">"zh-cn"</span><span class="token punctuation">,</span>
            <span class="token string">"gl"</span><span class="token punctuation">:</span> <span class="token string">"cn"</span>
        <span class="token punctuation">}</span>
        search <span class="token operator">=</span> GoogleSearch<span class="token punctuation">(</span>search_params<span class="token punctuation">)</span>
        results <span class="token operator">=</span> search<span class="token punctuation">.</span>get_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
        organic_results <span class="token operator">=</span> results<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"organic_results"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> organic_results<span class="token punctuation">:</span>
            result <span class="token operator">=</span> <span class="token string">"未找到结果。"</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> <span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">. </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'title'</span><span class="token punctuation">,</span> <span class="token string">'无标题'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'snippet'</span><span class="token punctuation">,</span> <span class="token string">'无描述'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
                <span class="token keyword">for</span> i<span class="token punctuation">,</span> result <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>organic_results<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>redis_client<span class="token punctuation">.</span>setex<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"serpapi:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result

    <span class="token decorator annotation punctuation">@retry</span><span class="token punctuation">(</span>stop<span class="token operator">=</span>stop_after_attempt<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wait<span class="token operator">=</span>wait_fixed<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> retry<span class="token operator">=</span>retry_if_exception_type<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">_search_bing</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        cached_result <span class="token operator">=</span> self<span class="token punctuation">.</span>redis_client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"bing:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> cached_result<span class="token punctuation">:</span>
            <span class="token keyword">return</span> cached_result
        url <span class="token operator">=</span> <span class="token string">"https://api.bing.microsoft.com/v7.0/search"</span>
        headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"Ocp-Apim-Subscription-Key"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>bing_key<span class="token punctuation">}</span>
        params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"q"</span><span class="token punctuation">:</span> query<span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"mkt"</span><span class="token punctuation">:</span> <span class="token string">"zh-CN"</span><span class="token punctuation">}</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span>
        response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
        results <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"webPages"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> results<span class="token punctuation">:</span>
            result <span class="token operator">=</span> <span class="token string">"未找到结果。"</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            result <span class="token operator">=</span> <span class="token string">"\n"</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>
                <span class="token string-interpolation"><span class="token string">f"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">}</span></span><span class="token string">. </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">,</span> <span class="token string">'无标题'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'snippet'</span><span class="token punctuation">,</span> <span class="token string">'无描述'</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
                <span class="token keyword">for</span> i<span class="token punctuation">,</span> result <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>redis_client<span class="token punctuation">.</span>setex<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"bing:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result

    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task<span class="token punctuation">:</span> Task<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        query <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"Agentic系统 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span>description<span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>serpapi_key<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                summary <span class="token operator">=</span> self<span class="token punctuation">.</span>_search_serpapi<span class="token punctuation">(</span>query<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"执行任务 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span>description<span class="token punctuation">}</span></span><span class="token string">. SerpAPI结果：\n</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>summary<span class="token punctuation">}</span></span><span class="token string">"</span></span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SerpAPI失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">，尝试Bing API"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>bing_key<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                summary <span class="token operator">=</span> self<span class="token punctuation">.</span>_search_bing<span class="token punctuation">(</span>query<span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"执行任务 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span>description<span class="token punctuation">}</span></span><span class="token string">. Bing结果：\n</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>summary<span class="token punctuation">}</span></span><span class="token string">"</span></span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"执行任务 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span>description<span class="token punctuation">}</span></span><span class="token string">. Bing调用失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"执行任务 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span>description<span class="token punctuation">}</span></span><span class="token string">. 未配置任何API密钥。"</span></span>

<span class="token keyword">class</span> <span class="token class-name">EvaluationAgent</span><span class="token punctuation">(</span>Agent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task<span class="token punctuation">:</span> Task<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        result <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">,</span> <span class="token string">"无结果"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token string-interpolation"><span class="token string">f"评估任务 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string">: 结果 '</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result<span class="token punctuation">}</span></span><span class="token string">' 是否满足需求？"</span></span>

<span class="token keyword">class</span> <span class="token class-name">ValidationAgent</span><span class="token punctuation">(</span>Agent<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> name<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span>name<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>serpapi_key <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"SERPAPI_KEY"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bing_key <span class="token operator">=</span> os<span class="token punctuation">.</span>getenv<span class="token punctuation">(</span><span class="token string">"BING_API_KEY"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>redis_client <span class="token operator">=</span> redis<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'localhost'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">,</span> db<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> decode_responses<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token decorator annotation punctuation">@retry</span><span class="token punctuation">(</span>stop<span class="token operator">=</span>stop_after_attempt<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wait<span class="token operator">=</span>wait_fixed<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> retry<span class="token operator">=</span>retry_if_exception_type<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">_search_serpapi</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        cached_result <span class="token operator">=</span> self<span class="token punctuation">.</span>redis_client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"serpapi:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> cached_result<span class="token punctuation">:</span>
            <span class="token keyword">return</span> cached_result
        search_params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"q"</span><span class="token punctuation">:</span> query<span class="token punctuation">,</span>
            <span class="token string">"api_key"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>serpapi_key<span class="token punctuation">,</span>
            <span class="token string">"engine"</span><span class="token punctuation">:</span> <span class="token string">"google"</span><span class="token punctuation">,</span>
            <span class="token string">"num"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token string">"hl"</span><span class="token punctuation">:</span> <span class="token string">"zh-cn"</span><span class="token punctuation">,</span>
            <span class="token string">"gl"</span><span class="token punctuation">:</span> <span class="token string">"cn"</span>
        <span class="token punctuation">}</span>
        search <span class="token operator">=</span> GoogleSearch<span class="token punctuation">(</span>search_params<span class="token punctuation">)</span>
        results <span class="token operator">=</span> search<span class="token punctuation">.</span>get_dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> results<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"organic_results"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"snippet"</span><span class="token punctuation">,</span> <span class="token string">"无验证信息"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>redis_client<span class="token punctuation">.</span>setex<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"serpapi:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result

    <span class="token decorator annotation punctuation">@retry</span><span class="token punctuation">(</span>stop<span class="token operator">=</span>stop_after_attempt<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> wait<span class="token operator">=</span>wait_fixed<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> retry<span class="token operator">=</span>retry_if_exception_type<span class="token punctuation">(</span>Exception<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">_search_bing</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> query<span class="token punctuation">:</span> <span class="token builtin">str</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        cached_result <span class="token operator">=</span> self<span class="token punctuation">.</span>redis_client<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"bing:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> cached_result<span class="token punctuation">:</span>
            <span class="token keyword">return</span> cached_result
        url <span class="token operator">=</span> <span class="token string">"https://api.bing.microsoft.com/v7.0/search"</span>
        headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"Ocp-Apim-Subscription-Key"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>bing_key<span class="token punctuation">}</span>
        params <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"q"</span><span class="token punctuation">:</span> query<span class="token punctuation">,</span> <span class="token string">"count"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"mkt"</span><span class="token punctuation">:</span> <span class="token string">"zh-CN"</span><span class="token punctuation">}</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> params<span class="token operator">=</span>params<span class="token punctuation">)</span>
        response<span class="token punctuation">.</span>raise_for_status<span class="token punctuation">(</span><span class="token punctuation">)</span>
        result <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"webPages"</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"snippet"</span><span class="token punctuation">,</span> <span class="token string">"无验证信息"</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>redis_client<span class="token punctuation">.</span>setex<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"bing:</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>query<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span>
        <span class="token keyword">return</span> result

    <span class="token keyword">def</span> <span class="token function">execute</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task<span class="token punctuation">:</span> Task<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">str</span><span class="token punctuation">:</span>
        prev_result <span class="token operator">=</span> context<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"t3"</span><span class="token punctuation">,</span> <span class="token string">"无执行结果"</span><span class="token punctuation">)</span>
        query <span class="token operator">=</span> <span class="token string">"业务流验证完整性"</span>
        validation_info <span class="token operator">=</span> <span class="token string">"无验证信息"</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>serpapi_key<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                validation_info <span class="token operator">=</span> self<span class="token punctuation">.</span>_search_serpapi<span class="token punctuation">(</span>query<span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"SerpAPI验证失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">，尝试Bing"</span></span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>bing_key <span class="token keyword">and</span> <span class="token string">"无验证信息"</span> <span class="token keyword">in</span> validation_info<span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                validation_info <span class="token operator">=</span> self<span class="token punctuation">.</span>_search_bing<span class="token punctuation">(</span>query<span class="token punctuation">)</span>
            <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Bing验证失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        completeness_score <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>prev_result<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">50</span><span class="token punctuation">:</span>
            completeness_score <span class="token operator">+=</span> <span class="token number">40</span>
        <span class="token keyword">if</span> <span class="token string">"Agentic"</span> <span class="token keyword">in</span> prev_result<span class="token punctuation">:</span>
            completeness_score <span class="token operator">+=</span> <span class="token number">30</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">set</span><span class="token punctuation">(</span>prev_result<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>prev_result<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0.7</span><span class="token punctuation">:</span>
            completeness_score <span class="token operator">+=</span> <span class="token number">30</span>
        completeness <span class="token operator">=</span> <span class="token string">"完整"</span> <span class="token keyword">if</span> completeness_score <span class="token operator">&gt;=</span> <span class="token number">80</span> <span class="token keyword">else</span> <span class="token string">"不完整"</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"验证业务流：前置结果 '</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>prev_result<span class="token punctuation">}</span></span><span class="token string">' </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>completeness<span class="token punctuation">}</span></span><span class="token string"> (得分: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>completeness_score<span class="token punctuation">}</span></span><span class="token string">/100). "</span></span>
                <span class="token string-interpolation"><span class="token string">f"补充信息：</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>validation_info<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">TaskManager</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>tasks<span class="token punctuation">:</span> List<span class="token punctuation">[</span>Task<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">def</span> <span class="token function">add_task</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task<span class="token punctuation">:</span> Task<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>tasks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>task<span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">get_ready_tasks</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> context<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Task<span class="token punctuation">]</span><span class="token punctuation">:</span>
        ready <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> task <span class="token keyword">in</span> self<span class="token punctuation">.</span>tasks<span class="token punctuation">:</span>
            <span class="token keyword">if</span> task<span class="token punctuation">.</span>result <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">and</span> <span class="token builtin">all</span><span class="token punctuation">(</span>dep <span class="token keyword">in</span> context <span class="token keyword">for</span> dep <span class="token keyword">in</span> task<span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span><span class="token punctuation">:</span>
                ready<span class="token punctuation">.</span>append<span class="token punctuation">(</span>task<span class="token punctuation">)</span>
        <span class="token keyword">return</span> ready

<span class="token keyword">class</span> <span class="token class-name">WorkflowEngine</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task_manager<span class="token punctuation">:</span> TaskManager<span class="token punctuation">,</span> agents<span class="token punctuation">:</span> Dict<span class="token punctuation">[</span><span class="token builtin">str</span><span class="token punctuation">,</span> Agent<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>task_manager <span class="token operator">=</span> task_manager
        self<span class="token punctuation">.</span>agents <span class="token operator">=</span> agents
        self<span class="token punctuation">.</span>context <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>response_times <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">adjust_thread_count</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> task_count<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">int</span><span class="token punctuation">:</span>
        avg_response_time <span class="token operator">=</span> <span class="token builtin">sum</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>response_times<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>response_times<span class="token punctuation">)</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>response_times <span class="token keyword">else</span> <span class="token number">1</span>
        <span class="token keyword">if</span> avg_response_time <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span>task_count<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> task_count <span class="token operator">&gt;</span> <span class="token number">5</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token builtin">min</span><span class="token punctuation">(</span>task_count<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">min</span><span class="token punctuation">(</span>task_count<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">run</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
            ready_tasks <span class="token operator">=</span> self<span class="token punctuation">.</span>task_manager<span class="token punctuation">.</span>get_ready_tasks<span class="token punctuation">(</span>self<span class="token punctuation">.</span>context<span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> ready_tasks<span class="token punctuation">:</span>
                <span class="token keyword">break</span>
            max_workers <span class="token operator">=</span> self<span class="token punctuation">.</span>adjust_thread_count<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>ready_tasks<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">with</span> ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span>max_workers<span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>
                futures <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                    executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>self<span class="token punctuation">.</span>agents<span class="token punctuation">[</span>task<span class="token punctuation">.</span>agent<span class="token punctuation">]</span><span class="token punctuation">.</span>execute<span class="token punctuation">,</span> task<span class="token punctuation">,</span> self<span class="token punctuation">.</span>context<span class="token punctuation">)</span><span class="token punctuation">:</span> task
                    <span class="token keyword">for</span> task <span class="token keyword">in</span> ready_tasks
                <span class="token punctuation">}</span>
                <span class="token keyword">for</span> future <span class="token keyword">in</span> futures<span class="token punctuation">:</span>
                    task <span class="token operator">=</span> futures<span class="token punctuation">[</span>future<span class="token punctuation">]</span>
                    start_time <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">try</span><span class="token punctuation">:</span>
                        result <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span>
                        task<span class="token punctuation">.</span>result <span class="token operator">=</span> result
                        self<span class="token punctuation">.</span>context<span class="token punctuation">[</span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">]</span> <span class="token operator">=</span> result
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"任务 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string"> 完成: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>result<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"任务 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task<span class="token punctuation">.</span><span class="token builtin">id</span><span class="token punctuation">}</span></span><span class="token string"> 失败: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">str</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>response_times<span class="token punctuation">.</span>append<span class="token punctuation">(</span>time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start_time<span class="token punctuation">)</span>
                    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>response_times<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
                        self<span class="token punctuation">.</span>response_times<span class="token punctuation">.</span>pop<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> self<span class="token punctuation">.</span>context

<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    task_manager <span class="token operator">=</span> TaskManager<span class="token punctuation">(</span><span class="token punctuation">)</span>
    agents <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"description"</span><span class="token punctuation">:</span> DescriptionAgent<span class="token punctuation">(</span><span class="token string">"description"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"planning"</span><span class="token punctuation">:</span> PlanningAgent<span class="token punctuation">(</span><span class="token string">"planning"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"execution"</span><span class="token punctuation">:</span> ExecutionAgent<span class="token punctuation">(</span><span class="token string">"execution"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"evaluation"</span><span class="token punctuation">:</span> EvaluationAgent<span class="token punctuation">(</span><span class="token string">"evaluation"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string">"validation"</span><span class="token punctuation">:</span> ValidationAgent<span class="token punctuation">(</span><span class="token string">"validation"</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    task_manager<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>Task<span class="token punctuation">(</span><span class="token string">"t1"</span><span class="token punctuation">,</span> <span class="token string">"介绍系统组件"</span><span class="token punctuation">,</span> <span class="token string">"description"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    task_manager<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>Task<span class="token punctuation">(</span><span class="token string">"t2"</span><span class="token punctuation">,</span> <span class="token string">"生成业务流"</span><span class="token punctuation">,</span> <span class="token string">"planning"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"t1"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    task_manager<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>Task<span class="token punctuation">(</span><span class="token string">"t3"</span><span class="token punctuation">,</span> <span class="token string">"执行业务流并评估"</span><span class="token punctuation">,</span> <span class="token string">"execution"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"t2"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    task_manager<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>Task<span class="token punctuation">(</span><span class="token string">"t4"</span><span class="token punctuation">,</span> <span class="token string">"评估结果"</span><span class="token punctuation">,</span> <span class="token string">"evaluation"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"t3"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    task_manager<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>Task<span class="token punctuation">(</span><span class="token string">"t5"</span><span class="token punctuation">,</span> <span class="token string">"验证业务流完整性"</span><span class="token punctuation">,</span> <span class="token string">"validation"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"t3"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    engine <span class="token operator">=</span> WorkflowEngine<span class="token punctuation">(</span>task_manager<span class="token punctuation">,</span> agents<span class="token punctuation">)</span>
    context <span class="token operator">=</span> engine<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
    adjustments <span class="token operator">=</span> evaluate_and_adjust<span class="token punctuation">(</span>context<span class="token punctuation">,</span> task_manager<span class="token punctuation">,</span> agents<span class="token punctuation">)</span>
    <span class="token keyword">if</span> adjustments<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"\n调整后重新执行工作流..."</span><span class="token punctuation">)</span>
        engine <span class="token operator">=</span> WorkflowEngine<span class="token punctuation">(</span>task_manager<span class="token punctuation">,</span> agents<span class="token punctuation">)</span>
        context <span class="token operator">=</span> engine<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">evaluate_and_adjust</span><span class="token punctuation">(</span>context<span class="token punctuation">:</span> Dict<span class="token punctuation">,</span> task_manager<span class="token punctuation">:</span> TaskManager<span class="token punctuation">,</span> agents<span class="token punctuation">:</span> Dict<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
    adjustments_needed <span class="token operator">=</span> <span class="token boolean">False</span>
    <span class="token keyword">for</span> task_id<span class="token punctuation">,</span> result <span class="token keyword">in</span> context<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token string">"无结果"</span> <span class="token keyword">in</span> result <span class="token keyword">or</span> <span class="token builtin">len</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">50</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"任务 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task_id<span class="token punctuation">}</span></span><span class="token string"> 结果不足，需调整。"</span></span><span class="token punctuation">)</span>
            adjustments_needed <span class="token operator">=</span> <span class="token boolean">True</span>
            <span class="token keyword">if</span> task_id <span class="token operator">==</span> <span class="token string">"t3"</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"调整策略：为任务 t3 增加更多外部信息依赖。"</span><span class="token punctuation">)</span>
                task_manager<span class="token punctuation">.</span>tasks <span class="token operator">=</span> <span class="token punctuation">[</span>t <span class="token keyword">for</span> t <span class="token keyword">in</span> task_manager<span class="token punctuation">.</span>tasks <span class="token keyword">if</span> t<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">!=</span> <span class="token string">"t3"</span><span class="token punctuation">]</span>
                task_manager<span class="token punctuation">.</span>add_task<span class="token punctuation">(</span>Task<span class="token punctuation">(</span><span class="token string">"t3"</span><span class="token punctuation">,</span> <span class="token string">"执行业务流并评估（增强版）"</span><span class="token punctuation">,</span> <span class="token string">"execution"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"t2"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">elif</span> task_id <span class="token operator">==</span> <span class="token string">"t5"</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"调整策略：为任务 t5 增加更详细验证。"</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"任务 </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>task_id<span class="token punctuation">}</span></span><span class="token string"> 结果满意。"</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> adjustments_needed

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h3>
     <a id="_451">
     </a>
     运行结果与分析
    </h3>
    <h4>
     <a id="_453">
     </a>
     配置
    </h4>
    <pre><code class="prism language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">SERPAPI_KEY</span><span class="token operator">=</span><span class="token string">"你的SerpAPI密钥"</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">BING_API_KEY</span><span class="token operator">=</span><span class="token string">"你的Bing密钥"</span>
redis-server  <span class="token comment"># 启动Redis</span>
</code></pre>
    <h4>
     <a id="_460">
     </a>
     输出示例
    </h4>
    <pre><code>任务 t1 完成: 组件介绍：Agent, Task Manager, Workflow Engine, Context Store, Evaluator, Toolset, Logger
任务 t2 完成: 业务流：Task 1 (介绍组件) → Task 2 (生成业务流) → Task 3 (执行并评估) → Task 5 (验证完整性)
任务 t3 完成: 执行任务 t3: 执行业务流并评估. SerpAPI结果：
1. Agentic Workflow: 无描述
2. Agentic AI: 无描述
3. Agentic Systems: 无描述
任务 t4 完成: 评估任务 t3: 结果 '执行任务 t3: 执行业务流并评估. SerpAPI结果：...' 是否满足需求？
任务 t5 完成: 验证业务流：前置结果 '执行任务 t3: 执行业务流并评估. SerpAPI结果：...' 完整 (得分: 90/100). 补充信息：业务流验证需检查完整性...
任务 t1 结果满意。
任务 t2 结果满意。
任务 t3 结果满意。
任务 t4 结果满意。
任务 t5 结果满意。
</code></pre>
    <h4>
     <a id="_477">
     </a>
     分析
    </h4>
    <ul>
     <li>
      <strong>
       负载均衡
      </strong>
      ：线程数根据任务量和响应时间动态调整，例如任务多时增至5，响应慢时减至2。
     </li>
     <li>
      <strong>
       缓存机制
      </strong>
      ：重复查询直接从Redis返回，API调用次数显著减少（第二次运行
      <code>
       t3
      </code>
      和
      <code>
       t5
      </code>
      更快）。
     </li>
    </ul>
    <hr/>
    <h3>
     <a id="_483">
     </a>
     后续优化建议
    </h3>
    <ol>
     <li>
      <strong>
       API配额管理
      </strong>
      ：
      <ul>
       <li>
        跟踪SerpAPI和Bing的调用次数，自动切换数据源。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       分布式任务
      </strong>
      ：
      <ul>
       <li>
        使用Celery替代线程，支持跨机器执行。
       </li>
      </ul>
     </li>
     <li>
      <strong>
       缓存策略
      </strong>
      ：
      <ul>
       <li>
        根据查询频率调整Redis过期时间。
       </li>
      </ul>
     </li>
    </ol>
    <hr/>
    <p>
     希望这篇博客对你有帮助！如需进一步讨论，欢迎留言。
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34303934313130322f:61727469636c652f64657461696c732f313436303633323936" class_="artid" style="display:none">
 </p>
</div>


