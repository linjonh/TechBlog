---
layout: post
title: "K8S学习之基础二十七k8s中daemonset控制器"
date: 2025-03-12 17:08:34 +0800
description: "k8s的DaemonSet控制器"
keywords: "K8S学习之基础二十七：k8s中daemonset控制器"
categories: ['未分类']
tags: ['容器', '云原生', 'Kubernetes', 'Jenkins']
artid: "146209829"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146209829
    alt: "K8S学习之基础二十七k8s中daemonset控制器"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146209829
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146209829
cover: https://bing.ee123.net/img/rand?artid=146209829
image: https://bing.ee123.net/img/rand?artid=146209829
img: https://bing.ee123.net/img/rand?artid=146209829
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     K8S学习之基础二十七：k8s中daemonset控制器
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h2>
     <a id="k8sDaemonSet_0">
     </a>
     k8s中DaemonSet控制器
    </h2>
    <p>
     ​ DaemonSet控制器确保k8s集群中，所有节点都运行一个相同的pod，当node节点增加时，新节点也会自动创建一个pod，当node节点从集群移除，对应的pod也会自动删除。删除DaemonSet也会删除创建的pod。
    </p>
    <p>
     ​ DaemonSet控制器会监听k8s的ds对象、pod对象、node对象，这些被监听的对象变动，就会出发syncLoop循环让k8s集群朝着ds对象魔术的状态进行演进。
    </p>
    <p>
     应用场景：
    </p>
    <p>
     ​ 在集群每个节点运行存储，如glusterd或ceph
    </p>
    <p>
     ​ 在每个节点运行日志收集组件：如flunentd、logstash、filebeat
    </p>
    <p>
     ​ 在每个节点运行监控组件，如Prometheus、NodeExporter、collectd
    </p>
    <p>
     ​ 以fluntend测试
    </p>
    <p>
     ​ 上传镜像fluentd到harbor
    </p>
    <pre><code>vi daemonset-flunted.yaml 
kind: DaemonSet
metadata:
  name: fluentd-elasticsearch
  namespace: kube-system            # 定义命名空间
  labels:
    k8s-app: fluentd-logging        # 定义标签
spec:
  selector:
    matchLabels:
      name: fluentd-elasticsearch   # 匹配标签，与pod一致
  template:
    metadata:
      labels:
        name: fluentd-elasticsearch  # pod标签
    spec:
      tolerations:                # 定义容忍度，因为要在master上部署
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule        # 容忍度调度
      containers:
      - name: fluentd-elasticsearch
        image: 172.16.80.140/fluented/fluented:v2.5.1   # harbor镜像地址
        resources:           # 资源配额
          limits:
            memory: 200Mi
          requests:
            cpu: 100m
            memory: 200Mi
        volumeMounts:                              # 挂载卷
        - name: varlog
          mountPath: /var/log                     # 监控/var/log
        - name: varlibdockercontainers
          mountPath: /var/lib/docker/containers   # 监控容器日志
          readOnly: true
      terminationGracePeriodSeconds: 30
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
      - name: varlibdockercontainers
        hostPath:
          path: /var/lib/docker/containers                                                    
</code></pre>
    <p>
     <img alt="image-20250312170015706" src="https://i-blog.csdnimg.cn/img_convert/87468486ef920996ce4838615a421f0f.png"/>
    </p>
    <p>
     手工删除一个pod，ds就会自动创建一个新的pod
    </p>
    <p>
     <img alt="image-20250312170232411" src="https://i-blog.csdnimg.cn/img_convert/2353bf50d3278ff4e0658997fd497467.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c:6f672e6373646e2e6e65742f7869616f66656e676b616e672f:61727469636c652f64657461696c732f313436323039383239" class_="artid" style="display:none">
 </p>
</div>


