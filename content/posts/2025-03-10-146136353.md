---
layout: post
title: "NAT-NAPT"
date: 2025-03-10 18:11:43 +0800
description: "通过这种方式，正向代理可以实现多种功能，如提高访问速度、隐藏客户端身份、实施访问控制等。工作原理客户端将请求发送给正向代理服务器。正向代理服务器接收请求，并根据配置进行处理，如缓存查找、内容过滤等。正向代理服务器将处理后的请求转发给目标服务器。目标服务器处理请求，并将响应返回给正向代理服务器。正向代理服务器将响应返回给客户端。功能特点。"
keywords: "NAT NAPT"
categories: ['未分类']
tags: ['运维', '网络', '服务器']
artid: "146136353"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146136353
    alt: "NAT-NAPT"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146136353
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146136353
cover: https://bing.ee123.net/img/rand?artid=146136353
image: https://bing.ee123.net/img/rand?artid=146136353
img: https://bing.ee123.net/img/rand?artid=146136353
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     NAT NAPT
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <h2>
     NAT
    </h2>
    <blockquote>
     <p>
      <strong>
       NAT（Network Address Translation，网络地址转换）
      </strong>
      主要用于在不同网络（如
      <strong>
       私有网络和公共互联网
      </strong>
      ）之间进行
      <strong>
       IP 地址转换
      </strong>
      ，解决
      <strong>
       IP 地址短缺
      </strong>
      问题，并提供一定的
      <strong>
       安全性
      </strong>
      。
     </p>
     <ul>
      <li>
       IPv4 地址是
       <strong>
        32 位
       </strong>
       （最多
       <code>
        2^32 ≈ 43 亿
       </code>
       个地址），但全球设备数量远超这个范围。
      </li>
      <li>
       <strong>
        私有 IP 地址（如
        <code>
         192.168.1.0/24
        </code>
        ）不能直接在公网使用
       </strong>
       ，必须通过 NAT 转换成公网 IP。
      </li>
     </ul>
    </blockquote>
    <h3>
     NAT IP转换过程
    </h3>
    <blockquote>
     <p>
      当主机A私有IP地址访问服务器公有IP时，先把数据发给路由器，NAT 路由器将报文的源地址从 10.0.0.10 替换成全局的 IP 202.244.174.37;并在转换表中建立私有IP和公有IP的映射关系。
      <br/>
      当服务器返回报文时，NAT 路由器收到外部的数据时, 再根据转变表的映射关系，把目标 IP 从 202.244.174.37 替换回10.0.0.10;
      <br/>
      当 10.0.0.10 第一次向 163.221.120.9 发送数据时就会生成表中的映射关系;
     </p>
    </blockquote>
    <p>
     <img alt="" height="519" src="https://i-blog.csdnimg.cn/direct/f518a3bdf7664a02bf01478176301040.png" width="1195"/>
    </p>
    <h3>
     NAPT
    </h3>
    <blockquote>
     <p>
      那么问题来了, 如果局域网内,
      <strong>
       有多个主机都访问同一个外网服务器
      </strong>
      , 那么对于服务器返
      <br/>
      回的数据中,
      <strong>
       目的 IP 都是相同的
      </strong>
      . 那么 NAT 路由器如何判定将这个数据包
      <strong>
       转发给哪个
       <br/>
       局域网的主机?
      </strong>
     </p>
     <p>
      这时候就不能但使用IP建立联系，要用IP+port。
     </p>
    </blockquote>
    <p>
     <img alt="" height="826" src="https://i-blog.csdnimg.cn/direct/861d17ec0d6249b7860f15001109a8a2.png" width="1206"/>
    </p>
    <blockquote>
     <p>
      在
      <strong>
       同一个子网中每个主机的私有 IP 是唯一的
      </strong>
      ，即使端口号一样，也能保证唯一性。
      <strong>
       IP+端口号保证了在同一个子网中，每台主机以及主机上客户端的唯一性。
      </strong>
     </p>
     <p>
      NAPT，转换的公网IP一样，
      <strong>
       但可以分配不同的端口号，也保证了唯一性。
      </strong>
     </p>
     <p>
      <strong>
       这样映射双方都保证了唯一性。
      </strong>
     </p>
    </blockquote>
    <blockquote>
     <p>
      再来想一下，同一子网中主机的私有IP不同，但不同子网的私有IP可能会相同。如果这两个子网有同一个路由器，在
      <strong>
       不同子网的两个主机私有IP相同，端口号也相同
      </strong>
      ，访问同一个服务器，会怎么样？
     </p>
     <p>
      即使不同子网的主机 IP + 端口号相同，
      <strong>
       NAPT 仍然能基于 NAT 端口号 + 子网信息(
      </strong>
      NAPT 设备用来区分不同子网的标识信息：
      <strong>
       入接口
      </strong>
      eth 源子网 VLAN 标识
      <strong>
       )唯一映射，确保数据包不会错误地送达另一台主机。
      </strong>
     </p>
     <p>
     </p>
     <p>
      子网 A 的 192.168.1.100:5001 → 203.0.113.1:30001
     </p>
     <p>
      子网 B 的 192.168.1.100:5001 → 203.0.113.1:30002
     </p>
     <p>
      服务器返回数据时，NAPT 设备根据 NAT 端口号找到正确的原始子网，并正确转发回去。
     </p>
     <p>
     </p>
     <p>
      <strong>
       其他 NAT 方案：
      </strong>
     </p>
     <ul>
      <li>
       <p>
        <strong>
         策略 NAT（Policy-Based NAT）
        </strong>
       </p>
       <ul>
        <li>
         <strong>
          不同子网使用不同的 NAT 端口范围
         </strong>
         ，确保 NAT 端口不重叠。
        </li>
        <li>
         例如：
         <ul>
          <li>
           <strong>
            子网 A：NAT 端口
            <code>
             30000-31000
            </code>
           </strong>
          </li>
          <li>
           <strong>
            子网 B：NAT 端口
            <code>
             31001-32000
            </code>
           </strong>
          </li>
         </ul>
        </li>
       </ul>
      </li>
      <li>
       <p>
        <strong>
         使用多个公网 IP
        </strong>
       </p>
       <ul>
        <li>
         如果 NAT 设备支持多个公网 IP，
         <strong>
          可以为不同子网分配不同的公网 IP
         </strong>
         ，避免 NAT 端口冲突：
         <ul>
          <li>
           <strong>
            子网 A →
            <code>
             203.0.113.1
            </code>
           </strong>
          </li>
          <li>
           <strong>
            子网 B →
            <code>
             203.0.113.2
            </code>
           </strong>
          </li>
         </ul>
        </li>
       </ul>
      </li>
     </ul>
    </blockquote>
    <h2>
    </h2>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
    <p>
    </p>
   </div>
  </div>
 </article>
 <p alt="6874747073:3a2f2f626c6f672e6373646e2e6e65742f777773373932302f:61727469636c652f64657461696c732f313436313336333533" class_="artid" style="display:none">
 </p>
</div>


