---
layout: post
title: "C-Channel"
date: 2025-03-10 11:12:01 +0800
description: "在C#中，提供了，适用于多任务间的数据传递。"
keywords: "C# Channel"
categories: ['C']
tags: ['数据库', 'Javascript', 'C']
artid: "146147985"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146147985
    alt: "C-Channel"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146147985
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146147985
cover: https://bing.ee123.net/img/rand?artid=146147985
image: https://bing.ee123.net/img/rand?artid=146147985
img: https://bing.ee123.net/img/rand?artid=146147985
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     C# Channel
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-github-gist" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <br/>
    在
    <code>
     C#
    </code>
    中，
    <code>
     System.Threading.Channels
    </code>
    提供了
    <em>
     <strong>
      高效的异步生产-消费模型
     </strong>
    </em>
    ，适用于多任务间的数据传递。以下是其核心概念及使用方法的总结：
    <p>
    </p>
    <h2>
     <a id="_3">
     </a>
     核心概念
    </h2>
    <p>
     <code>
      Channel&lt;T&gt;
     </code>
     ：异步消息队列，支持多生产者和多消费者。
    </p>
    <p>
     <code>
      ChannelWriter&lt;T&gt;
     </code>
     ：用于异步写入数据（
     <code>
      WriteAsync
     </code>
     ），完成后需调用
     <code>
      Complete()
     </code>
     。
    </p>
    <p>
     <code>
      ChannelReader&lt;T&gt;
     </code>
     ：用于异步读取数据，支持
     <code>
      ReadAsync
     </code>
     或
     <code>
      ReadAllAsync
     </code>
     遍历。
    </p>
    <h2>
     <a id="Channel_10">
     </a>
     创建Channel
    </h2>
    <h3>
     <a id="_11">
     </a>
     无界通道
    </h3>
    <pre><code class="prism language-c">var channel <span class="token operator">=</span> Channel<span class="token punctuation">.</span>CreateUnbounded<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     容量无限，适用于不确定数据量的场景。
    </p>
    <h3>
     <a id="_19">
     </a>
     有界通道
    </h3>
    <pre><code class="prism language-c">var options <span class="token operator">=</span> new <span class="token function">BoundedChannelOptions</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FullMode <span class="token operator">=</span> BoundedChannelFullMode<span class="token punctuation">.</span>Wait <span class="token comment">// 满时等待</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
var channel <span class="token operator">=</span> Channel<span class="token punctuation">.</span>CreateBounded<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h4>
     <a id="FullMode_29">
     </a>
     <code>
      FullMode
     </code>
     选项
    </h4>
    <ul>
     <li>
      <p>
       <code>
        Wait
       </code>
       （默认）：写入时阻塞直到有空间。
      </p>
     </li>
     <li>
      <p>
       <code>
        DropOldest
       </code>
       /
       <code>
        DropNewest
       </code>
       ：丢弃最旧/最新数据。
      </p>
     </li>
     <li>
      <p>
       <code>
        DropWrite
       </code>
       ：丢弃当前写入的数据。
      </p>
     </li>
    </ul>
    <h2>
     <a id="_37">
     </a>
     生产者-消费者模式
    </h2>
    <h3>
     <a id="_38">
     </a>
     生产者写入数据
    </h3>
    <pre><code class="prism language-c">async Task <span class="token function">Producer</span><span class="token punctuation">(</span>ChannelWriter<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> writer<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        await writer<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        await Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    writer<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 标记完成</span>
<span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="_52">
     </a>
     消费者读取数据
    </h3>
    <pre><code class="prism language-c">async Task <span class="token function">Consumer</span><span class="token punctuation">(</span>ChannelReader<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> reader<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 方式1: ReadAllAsync遍历</span>
    await <span class="token function">foreach</span> <span class="token punctuation">(</span>var item in reader<span class="token punctuation">.</span><span class="token function">ReadAllAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Received: {item}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 方式2: 手动循环</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>await reader<span class="token punctuation">.</span><span class="token function">WaitToReadAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>reader<span class="token punctuation">.</span><span class="token function">TryRead</span><span class="token punctuation">(</span>out var item<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Received: {item}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="_74">
     </a>
     完整示例
    </h2>
    <pre><code class="prism language-c">using System<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Channels<span class="token punctuation">;</span>
using System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">;</span>

class Program
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> async Task <span class="token function">Main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        var channel <span class="token operator">=</span> Channel<span class="token punctuation">.</span>CreateUnbounded<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        var producer <span class="token operator">=</span> <span class="token function">Producer</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        var consumer <span class="token operator">=</span> <span class="token function">Consumer</span><span class="token punctuation">(</span>channel<span class="token punctuation">.</span>Reader<span class="token punctuation">)</span><span class="token punctuation">;</span>

        await Task<span class="token punctuation">.</span><span class="token function">WhenAll</span><span class="token punctuation">(</span>producer<span class="token punctuation">,</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> async Task <span class="token function">Producer</span><span class="token punctuation">(</span>ChannelWriter<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> writer<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        try
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                await writer<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                await Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">catch</span> <span class="token punctuation">(</span>Exception ex<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            writer<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 传递异常</span>
        <span class="token punctuation">}</span>
        finally
        <span class="token punctuation">{<!-- --></span>
            writer<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> async Task <span class="token function">Consumer</span><span class="token punctuation">(</span>ChannelReader<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> reader<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        try
        <span class="token punctuation">{<!-- --></span>
            await <span class="token function">foreach</span> <span class="token punctuation">(</span>var item in reader<span class="token punctuation">.</span><span class="token function">ReadAllAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Processed: {item}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">catch</span> <span class="token punctuation">(</span>Exception ex<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Error: {ex.Message}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="_130">
     </a>
     高级配置
    </h2>
    <h3>
     <a id="_131">
     </a>
     优化选项：
    </h3>
    <pre><code class="prism language-c">var options <span class="token operator">=</span> new <span class="token function">UnboundedChannelOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    SingleWriter <span class="token operator">=</span> true<span class="token punctuation">,</span>  <span class="token comment">// 单一生产者优化</span>
    SingleReader <span class="token operator">=</span> false  <span class="token comment">// 允许多消费者</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <h3>
     <a id="_CancellationToken__142">
     </a>
     取消操作：通过
     <code>
      CancellationToken
     </code>
     取消读写。
    </h3>
    <pre><code class="prism language-c">await writer<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span> cancellationToken<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h2>
     <a id="_149">
     </a>
     错误处理
    </h2>
    <p>
     生产者异常时，调用
     <code>
      writer.Complete(ex)
     </code>
     通知消费者。
    </p>
    <p>
     消费者通过
     <code>
      try-catch
     </code>
     捕获遍历时的异常。
    </p>
    <h2>
     <a id="_154">
     </a>
     适用场景
    </h2>
    <p>
     数据流水线处理。
    </p>
    <p>
     高吞吐量的异步任务。
    </p>
    <p>
     多任务间的负载均衡。
    </p>
    <hr/>
    <p>
     在
     <code>
      C#
     </code>
     中，
     <code>
      System.Threading.Channels
     </code>
     是一个强大的异步通信机制，主要用于实现生产者-消费者模式。它提供了线程安全的通道（
     <code>
      Channel
     </code>
     ），用于在不同线程之间传递数据。以下是关于
     <code>
      C# Channel
     </code>
     的详细介绍：
    </p>
    <h2>
     <a id="Channel_163">
     </a>
     <code>
      Channel
     </code>
     的类型
    </h2>
    <p>
     <code>
      Channel
     </code>
     有两种类型：
     <br/>
     有界通道（
     <code>
      Bounded Channel
     </code>
     ）：具有固定容量，当通道已满时，可以根据指定的策略处理新消息。
     <br/>
     无界通道（
     <code>
      Unbounded Channel
     </code>
     ）：没有容量限制，适合生产者和消费者速度匹配的场景。
    </p>
    <h2>
     <a id="Channel_167">
     </a>
     创建
     <code>
      Channel
     </code>
    </h2>
    <p>
     使用
     <code>
      Channel.CreateBounded&lt;T&gt;
     </code>
     创建有界通道，需要指定容量和满时的处理策略（如
     <code>
      Wait
     </code>
     、
     <code>
      DropNewest
     </code>
     、
     <code>
      DropOldest
     </code>
     等）。
     <br/>
     使用
     <code>
      Channel.CreateUnbounded&lt;T&gt;
     </code>
     创建无界通道。
    </p>
    <h2>
     <a id="_170">
     </a>
     写入和读取消息
    </h2>
    <p>
     生产者通过
     <code>
      channel.Writer.WriteAsync()
     </code>
     方法写入消息。
     <br/>
     消费者通过
     <code>
      channel.Reader.ReadAsync()
     </code>
     或
     <code>
      channel.Reader.WaitToReadAsync()
     </code>
     读取消息。
    </p>
    <h2>
     <a id="_173">
     </a>
     使用场景
    </h2>
    <p>
     <code>
      Channel
     </code>
     主要用于生产者-消费者模式，可以实现高效的异步数据处理。它支持多线程操作，并可以通过
     <code>
      SingleReader
     </code>
     和
     <code>
      SingleWriter
     </code>
     属性限制通道的读写行为。
    </p>
    <h2>
     <a id="_175">
     </a>
     示例代码
    </h2>
    <p>
     以下是一个简单的生产者-消费者示例：
    </p>
    <pre><code class="prism language-c">var channel <span class="token operator">=</span> Channel<span class="token punctuation">.</span>CreateBounded<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>new <span class="token function">BoundedChannelOptions</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    FullMode <span class="token operator">=</span> BoundedChannelFullMode<span class="token punctuation">.</span>Wait
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Task producer <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token function">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        await channel<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">WriteAsync</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Produced: {i}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    channel<span class="token punctuation">.</span>Writer<span class="token punctuation">.</span><span class="token function">Complete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Task consumer <span class="token operator">=</span> Task<span class="token punctuation">.</span><span class="token function">Run</span><span class="token punctuation">(</span><span class="token function">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>await channel<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">WaitToReadAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span>Reader<span class="token punctuation">.</span><span class="token function">TryRead</span><span class="token punctuation">(</span>out var item<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>$<span class="token string">"Consumed: {item}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

await Task<span class="token punctuation">.</span><span class="token function">WhenAll</span><span class="token punctuation">(</span>producer<span class="token punctuation">,</span> consumer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <h2>
     <a id="_208">
     </a>
     注意事项
    </h2>
    <ul>
     <li>
      缓冲区溢出：生产者写入速度过快可能导致缓冲区溢出。
     </li>
     <li>
      正确关闭
      <code>
       Channel
      </code>
      ：在数据完全消费后关闭
      <code>
       Channel
      </code>
      ，避免数据丢失。
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f6d305f35303835393734332f:61727469636c652f64657461696c732f313436313437393835" class_="artid" style="display:none">
 </p>
</div>


