---
layout: post
title: "tcc编译器教程2-编译lua解释器"
date: 2025-03-07 00:03:58 +0800
description: "tcc编译器教程2 编译lua解释器"
keywords: "tcc编译器教程2 编译lua解释器"
categories: ['C']
tags: ['开发语言', 'Lua']
artid: "146031852"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=146031852
    alt: "tcc编译器教程2-编译lua解释器"
render_with_liquid: false
featuredImage: https://bing.ee123.net/img/rand?artid=146031852
featuredImagePreview: https://bing.ee123.net/img/rand?artid=146031852
cover: https://bing.ee123.net/img/rand?artid=146031852
image: https://bing.ee123.net/img/rand?artid=146031852
img: https://bing.ee123.net/img/rand?artid=146031852
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     tcc编译器教程2 编译lua解释器
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="./../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="./../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     本文主要介绍了使用tcc编译器编译lua解释器源码。
    </p>
    <h2>
     <a id="1__1">
     </a>
     1 介绍
    </h2>
    <p>
     lua是一门编程语言,开源且源码很容易编译,我平时用来测试C语言编程环境时经常使用。一般能编译成功就说明编程环境设置正常。下面用之前设置好的tcc编程环境进行测试。
    </p>
    <h2>
     <a id="2__3">
     </a>
     2 获取源码
    </h2>
    <p>
     我一般有保留多个版本的lua源码进行测试,你可以去官网进行下载.
     <br/>
     官网地址
     <br/>
     https://www.lua.org/home.html
     <br/>
     下载页面
     <br/>
     https://www.lua.org/download.html
     <br/>
     最新版本即可,现在最新版为Lua 5.4.7,直接下载地址为
     <br/>
     https://www.lua.org/ftp/lua-5.4.7.tar.gz
     <br/>
     下载下来的文件保存到任意文件夹,我保存在C:\run\test,解压得到lua-5.4.7文件夹,文件如下
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2d09ede5e2f542b8983f3a7d741c43b9.png">
      <br/>
      其中src就是源码文件夹。
     </img>
    </p>
    <h2>
     <a id="3__14">
     </a>
     3 初次编译
    </h2>
    <p>
     将前文配置好的tcc编程环境.bat复制到C:\run\test\lua-5.4.7\src下,直接打开。输入下面批处理指令
    </p>
    <pre><code class="prism language-c"><span class="token operator">::</span>编译所有c文件并生成可执行文件
tcc <span class="token operator">*</span><span class="token punctuation">.</span>c
<span class="token operator">::</span>可执行文件名称为lapi<span class="token punctuation">.</span>exe
</code></pre>
    <p>
     编译会失败,显示luac.c: error: ‘main’ defined twice,因为luac.c是一个lua编译器源码,里面也有一个main函数,luac.c文件暂时不用到,可以直接删除,或者想剪切到其他文件夹保留。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/5e42a344bb9d4a3da3fb2b666826e96b.png">
      <br/>
      删除或移动后,重新执行上面命令,没有提示错误信息即编译成功,一般编译速度很快。文件夹下面会生成lapi.exe文件,点击打开
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/9131a5fb04dd41f692e399c7ee7f2127.png">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/946e3b0cd1654d798a571ecb21b24045.png">
        <br/>
        即说明编译成功,你可以输入一些lua代码测试一下效果。
       </img>
      </img>
     </img>
    </p>
    <pre><code class="prism language-lua"><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"你好,世界"</span><span class="token punctuation">)</span>
</code></pre>
    <h2>
     <a id="4__31">
     </a>
     4 编译测试
    </h2>
    <p>
     上面编译指令为最简单的编译指令,使用很简单,但是有一个问题,输出文件为lapi.exe文件而不是lua.exe,因为没有指定输出程序名称,可以使用-o文件进行指定输出文件名称。
    </p>
    <pre><code class="prism language-c"><span class="token operator">::</span>编译所有c文件并生成可执行文件<span class="token punctuation">,</span>
<span class="token operator">::</span><span class="token operator">-</span>o选项指定输出文件为lua<span class="token punctuation">.</span>exe
tcc <span class="token operator">*</span><span class="token punctuation">.</span>c <span class="token operator">-</span>o lua<span class="token punctuation">.</span>exe
</code></pre>
    <p>
     上面编译命令虽然简单,但是隐藏了很多细节,下面进一步分析。
     <br/>
     lua.c为解释器源码,如果直接编译lua.c文件则会出错,出错信息如下
    </p>
    <pre><code class="prism language-c">tcc lua<span class="token punctuation">.</span>c <span class="token operator">-</span>o lua<span class="token punctuation">.</span>exe
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/direct/2a088c84f12c441f98aa1f993dedbd0b.png">
      <br/>
      因为编译这个解释器需要链接到其他代码的信息。即所有c代码均要指出,如
     </img>
    </p>
    <pre><code class="prism language-c"><span class="token operator">::</span>编译所有c代码<span class="token punctuation">,</span>输出程序为lua<span class="token punctuation">.</span>exe
<span class="token operator">::</span>等价于tcc <span class="token operator">*</span><span class="token punctuation">.</span>c <span class="token operator">-</span>o lua<span class="token punctuation">.</span>exe
tcc lapi<span class="token punctuation">.</span>c lauxlib<span class="token punctuation">.</span>c lbaselib<span class="token punctuation">.</span>c lcode<span class="token punctuation">.</span>c lcorolib<span class="token punctuation">.</span>c lctype<span class="token punctuation">.</span>c ldblib<span class="token punctuation">.</span>c ldebug<span class="token punctuation">.</span>c ldo<span class="token punctuation">.</span>c ldump<span class="token punctuation">.</span>c lfunc<span class="token punctuation">.</span>c lgc<span class="token punctuation">.</span>c linit<span class="token punctuation">.</span>c liolib<span class="token punctuation">.</span>c llex<span class="token punctuation">.</span>c lmathlib<span class="token punctuation">.</span>c lmem<span class="token punctuation">.</span>c loadlib<span class="token punctuation">.</span>c lobject<span class="token punctuation">.</span>c lopcodes<span class="token punctuation">.</span>c loslib<span class="token punctuation">.</span>c lparser<span class="token punctuation">.</span>c lstate<span class="token punctuation">.</span>c lstring<span class="token punctuation">.</span>c lstrlib<span class="token punctuation">.</span>c ltable<span class="token punctuation">.</span>c ltablib<span class="token punctuation">.</span>c ltm<span class="token punctuation">.</span>c lua<span class="token punctuation">.</span>c lundump<span class="token punctuation">.</span>c lutf8lib<span class="token punctuation">.</span>c lvm<span class="token punctuation">.</span>c lzio<span class="token punctuation">.</span>c <span class="token operator">-</span>o lua<span class="token punctuation">.</span>exe
</code></pre>
    <p>
     正常c语言程序包含编译和链接两个步骤,使用tcc编译和链接如下:
    </p>
    <pre><code class="prism language-c"><span class="token operator">::</span>编译所有c文件并生成obj文件<span class="token punctuation">,</span>
<span class="token operator">::</span><span class="token operator">-</span>c选项指定只编译不进行链接
tcc <span class="token operator">-</span>c <span class="token operator">*</span><span class="token punctuation">.</span>c 
<span class="token operator">::</span>将所有obj文件链接为可执行文件<span class="token punctuation">,</span><span class="token operator">-</span>o选项指定输出文件为lua<span class="token punctuation">.</span>exe
tcc <span class="token operator">*</span><span class="token punctuation">.</span>o <span class="token operator">-</span>o lua<span class="token punctuation">.</span>exe
</code></pre>
    <p>
     除了一次性编译所有c代码文件,还可以逐个编译c代码文件,再进行链接。
    </p>
    <pre><code class="prism language-c"><span class="token operator">::</span>逐个编译所有c文件并生成obj文件<span class="token punctuation">,</span>
<span class="token operator">::</span><span class="token operator">-</span>c选项指定只编译不进行链接
tcc <span class="token operator">-</span>c lapi<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lauxlib<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lbaselib<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lcode<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lcorolib<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lctype<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c ldblib<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c ldebug<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c ldo<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c ldump<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lfunc<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lgc<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c linit<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c liolib<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c llex<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lmathlib<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lmem<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c loadlib<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lobject<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lopcodes<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c loslib<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lparser<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lstate<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lstring<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lstrlib<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c ltable<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c ltablib<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c ltm<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lua<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lundump<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lutf8lib<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lvm<span class="token punctuation">.</span>c
tcc <span class="token operator">-</span>c lzio<span class="token punctuation">.</span>c
<span class="token operator">::</span>将所有obj文件链接为可执行文件<span class="token punctuation">,</span><span class="token operator">-</span>o选项指定输出文件为lua<span class="token punctuation">.</span>exe
tcc <span class="token operator">*</span><span class="token punctuation">.</span>o <span class="token operator">-</span>o lua<span class="token punctuation">.</span>exe
</code></pre>
    <p>
     这样写的好处是当你修改某个c代码文件时可以,直接重新编译这个文件而其他未修改文件可以不编译,提高编译效率。
    </p>
    <pre><code class="prism language-c"><span class="token operator">::</span>若我们只修改了lua<span class="token punctuation">.</span>c文件<span class="token punctuation">,</span>不需编译其他文件<span class="token punctuation">,</span>只需编译lua<span class="token punctuation">.</span>c文件
tcc <span class="token operator">-</span>c lua<span class="token punctuation">.</span>c
<span class="token operator">::</span>将所有obj文件链接为可执行文件<span class="token punctuation">,</span><span class="token operator">-</span>o选项指定输出文件为lua<span class="token punctuation">.</span>exe
tcc <span class="token operator">*</span><span class="token punctuation">.</span>o <span class="token operator">-</span>o lua<span class="token punctuation">.</span>exe
</code></pre>
    <p>
     此外还c语言开发中有两种特殊的编译方法,一个是生成静态链接库,如下
    </p>
    <pre><code class="prism language-c"><span class="token operator">::</span>编译除lua<span class="token punctuation">.</span>c外所有c代码文件<span class="token punctuation">,</span>生成静态链接库liblua<span class="token punctuation">.</span>a
<span class="token operator">::</span><span class="token operator">-</span>r代表重定向
tcc <span class="token operator">-</span>r  lapi<span class="token punctuation">.</span>c lcode<span class="token punctuation">.</span>c lctype<span class="token punctuation">.</span>c ldebug<span class="token punctuation">.</span>c ldo<span class="token punctuation">.</span>c ldump<span class="token punctuation">.</span>c lfunc<span class="token punctuation">.</span>c lgc<span class="token punctuation">.</span>c llex<span class="token punctuation">.</span>c lmem<span class="token punctuation">.</span>c lobject<span class="token punctuation">.</span>c lopcodes<span class="token punctuation">.</span>c lparser<span class="token punctuation">.</span>c lstate<span class="token punctuation">.</span>c lstring<span class="token punctuation">.</span>c ltable<span class="token punctuation">.</span>c ltm<span class="token punctuation">.</span>c lundump<span class="token punctuation">.</span>c lvm<span class="token punctuation">.</span>c lzio<span class="token punctuation">.</span>c lauxlib<span class="token punctuation">.</span>c lbaselib<span class="token punctuation">.</span>c  lcorolib<span class="token punctuation">.</span>c ldblib<span class="token punctuation">.</span>c liolib<span class="token punctuation">.</span>c lmathlib<span class="token punctuation">.</span>c loslib<span class="token punctuation">.</span>c lstrlib<span class="token punctuation">.</span>c ltablib<span class="token punctuation">.</span>c loadlib<span class="token punctuation">.</span>c linit<span class="token punctuation">.</span>c lutf8lib<span class="token punctuation">.</span>c  <span class="token operator">-</span>o liblua<span class="token punctuation">.</span>a

<span class="token operator">::</span>生成文件静态链接库liblua<span class="token punctuation">.</span>a<span class="token punctuation">,</span>
<span class="token operator">::</span>编译生成<span class="token function">lua</span><span class="token punctuation">(</span>静态链接库版本<span class="token punctuation">)</span><span class="token punctuation">.</span>exe<span class="token punctuation">,</span>需用到liblua<span class="token punctuation">.</span>a文件
tcc  liblua<span class="token punctuation">.</span>a lua<span class="token punctuation">.</span>c <span class="token operator">-</span>o <span class="token function">lua</span><span class="token punctuation">(</span>静态链接库版本<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
</code></pre>
    <p>
     还有一种是生成动态链接库版本
    </p>
    <pre><code class="prism language-c"><span class="token operator">::</span>编译除lua<span class="token punctuation">.</span>c外所有c代码文件<span class="token punctuation">,</span>生成动态链接库lua<span class="token punctuation">.</span>dll
tcc <span class="token operator">-</span>shared <span class="token operator">-</span>rdynamic  lapi<span class="token punctuation">.</span>c lcode<span class="token punctuation">.</span>c lctype<span class="token punctuation">.</span>c ldebug<span class="token punctuation">.</span>c ldo<span class="token punctuation">.</span>c ldump<span class="token punctuation">.</span>c lfunc<span class="token punctuation">.</span>c lgc<span class="token punctuation">.</span>c llex<span class="token punctuation">.</span>c lmem<span class="token punctuation">.</span>c lobject<span class="token punctuation">.</span>c lopcodes<span class="token punctuation">.</span>c lparser<span class="token punctuation">.</span>c lstate<span class="token punctuation">.</span>c lstring<span class="token punctuation">.</span>c ltable<span class="token punctuation">.</span>c ltm<span class="token punctuation">.</span>c lundump<span class="token punctuation">.</span>c lvm<span class="token punctuation">.</span>c lzio<span class="token punctuation">.</span>c lauxlib<span class="token punctuation">.</span>c lbaselib<span class="token punctuation">.</span>c  lcorolib<span class="token punctuation">.</span>c ldblib<span class="token punctuation">.</span>c liolib<span class="token punctuation">.</span>c lmathlib<span class="token punctuation">.</span>c loslib<span class="token punctuation">.</span>c lstrlib<span class="token punctuation">.</span>c ltablib<span class="token punctuation">.</span>c loadlib<span class="token punctuation">.</span>c linit<span class="token punctuation">.</span>c lutf8lib<span class="token punctuation">.</span>c <span class="token operator">-</span>o lua<span class="token punctuation">.</span>dll
<span class="token operator">::</span>生成文件动态链接库lua<span class="token punctuation">.</span>dll<span class="token punctuation">,</span>以及导出函数表lua<span class="token punctuation">.</span>def文件
<span class="token operator">::</span>编译生成<span class="token function">lua</span><span class="token punctuation">(</span>动态链接库版本<span class="token punctuation">)</span><span class="token punctuation">.</span>exe<span class="token punctuation">,</span>需用到lua<span class="token punctuation">.</span>def文件
tcc  lua<span class="token punctuation">.</span>def lua<span class="token punctuation">.</span>c <span class="token operator">-</span>o <span class="token function">lua</span><span class="token punctuation">(</span>动态链接库版本<span class="token punctuation">)</span><span class="token punctuation">.</span>exe
</code></pre>
    <h2>
     <a id="5__132">
     </a>
     5 小结
    </h2>
    <p>
     使用tcc来编译lua源代码还是比较简单的,一方面是tcc编译器使用比较简单容易上手,另一方面是lua源代码也比较简单没有其他第三方库依赖,而且所有源码位于同一文件夹方便编译。
    </p>
   </div>
   <link href="./../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="./../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f67:2e6373646e2e6e65742f73696e61745f34313632393932312f:61727469636c652f64657461696c732f313436303331383532" class_="artid" style="display:none">
 </p>
</div>


