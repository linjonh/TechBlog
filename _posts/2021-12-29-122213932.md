---
layout: post
title: "stm32硬件SPI驱动3线SPI-LCD的方法"
date: 2021-12-29 20:09:25 +0800
description: "本文介绍了如何使用STM32单片机驱动3线SPI-LCD，包括单字节和多字节转换后发送的方法，以及如"
keywords: "三线spi读数据方法"
categories: ['Openmv']
tags: ['单片机', 'Stm', 'Arm']
artid: "122213932"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=122213932
    alt: "stm32硬件SPI驱动3线SPI-LCD的方法"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     stm32硬件SPI驱动3线SPI-LCD的方法
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     1.基本控制原理
     <br/>
     三线SPI LCD， 顾名思义，最少只需要3个IO控制LCD显示，如果采用硬件控制上电时序和背光，最少只需要接SCK，CS，MOSI三个引脚即可控制LCD，并且不管接不接其他引脚，控制刷屏的只需要这三个引脚；
     <br/>
     CS为片选引脚，CS拉低代表数据传输开始；CS拉高，代表数据传输结束；
     <br/>
     SCK为SPI时钟线，一般LCD上标识SCL；
     <br/>
     MOSI是master数据输出，即单片机发送数据到LCD，一般LCD上标识SDA；
     <br/>
     3线SPI-LCD与4线的唯一区别是少了一个DC引脚，DC拉低代表传输的是指令；DC拉高代表传输的是数据，3线SPI驱动需要使用MOSI模拟DC的时序；
     <br/>
     那么使用STM32单片机驱动，很容易使用GPIO模拟SPI时序实现3线SPI-LCD的驱动，但是由于GPIO的翻转速度，就算使用寄存器操作，屏幕刷新速度也非常慢；
     <br/>
     2.如何使用硬件SPI驱动3线SPI-LCD
     <br/>
     本文提供两种方法使用stm32单片机实现：
     <br/>
     （1）单字节转换后SPI发送；
     <br/>
     所谓单字节转换后发送，就是每次只发送一个有效字节，将一个8位的数据，转换成16位，再位或0x8000，然后通过SPI发送出去，具体可以拆分成两个8bit数据发送；
     <br/>
     具体实现如下：
    </p>
    <pre><code>unsigned char spi_send_data_8bit(unsigned char Txdata)
{
	while((SPI2-&gt;SR &amp; SPI_I2S_FLAG_TXNE) == (uint16_t)RESET);
	 SPI2-&gt;DR=Txdata;  
	while((SPI2-&gt;SR &amp; SPI_I2S_FLAG_RXNE) == (uint16_t)RESET);  
	return (unsigned char)(SPI2-&gt;DR)；
}

void LCD_Send_8bit(unsigned char data)
{
	cs_low;
	spi_send_data_8bit((data&gt;&gt;1)|0x80);
	spi_send_data_8bit(data&lt;&lt;7);
	cs_high;			
}
</code></pre>
    <p>
     上述单字节发送在stm32F4平台，50MHz SPI下，320x240 分辨率显示能刷4fps；
     <br/>
     320x240x2x4x8 大约有5Mbps，如果采用更小的分辨率刷10帧以上没有问题。
    </p>
    <p>
     （2）多字节转换后发送
     <br/>
     使用单字节发送存在一个问题，SPI 每次只能按字节发送，就算SPI速度再快，单字节发送出去也会影响性能，其次每次发送一个有效字节都存在cs的拉高拉低，极大的影响了效率。既然单字节转换后可以发送，多字节转换后当然也能发送。其原理就是每一个DC后面跟8个有效bit，使用MOSI模拟时序做数据转换；
     <br/>
     先看看怎么一次发8个字节；
    </p>
    <pre><code>void LCD_Send_8byte(unsigned char  *send_buf,unsigned char buflen)
{

	if(send_buf==NULL||buflen!=8)
	{
		printf("param error");
		return;
	}
	unsigned char  *pbuf=send_buf;
	nsigned char lcd_buf[9]={0};
	lcd_buf[0]=0x80|(*pbuf&gt;&gt;1);
	lcd_buf[1]=0x40|(*pbuf&lt;&lt;7)|(*(pbuf+1)&gt;&gt;2);
	lcd_buf[2]=0x20|(*(pbuf+1)&lt;&lt;6)|(*(pbuf+2)&gt;&gt;3);
	lcd_buf[3]=0x10|(*(pbuf+2)&lt;&lt;5)|(*(pbuf+3)&gt;&gt;4);
	lcd_buf[4]=0x08|(*(pbuf+3)&lt;&lt;4)|(*(pbuf+4)&gt;&gt;5);
	lcd_buf[5]=0x04|(*(pbuf+4)&lt;&lt;3)|(*(pbuf+5)&gt;&gt;6);
	lcd_buf[6]=0x02|(*(pbuf+5)&lt;&lt;2)|(*(pbuf+6)&gt;&gt;7);
	lcd_buf[7]=0x01|(*(pbuf+6)&lt;&lt;1);
	lcd_buf[8]=*(pbuf+7);
	int i=0;
	 cs_low;
	 for(i=0;i&lt;9;i++)
	 {
	 	spi_send_data_8bit(lcd_buf[i]);
	 }
	 cs_high; 
}
</code></pre>
    <pre><code class="prism language-c"><span class="token comment">//使用CCM快速内存分配数据作为LCD的缓冲，如果内存足够这个缓冲也可以大一点</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> nwidth<span class="token operator">=</span>image_width8<span class="token operator">/</span><span class="token number">9</span><span class="token operator">*</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">2</span>；<span class="token comment">//分配一个16行的缓冲</span>

<span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> lcd_buf<span class="token operator">=</span><span class="token function">mymalloc</span><span class="token punctuation">(</span>SRAM_CCM，nwidth<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*******************************

功能：lcd显示n行数据，发送RGB565

入参：图像数据指针，发送长度，LCD缓冲数据指针，长度

出参：无

*********************************/</span>

<span class="token keyword">void</span> <span class="token function">LCD_Send_Nwith</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span>  <span class="token operator">*</span>send_buf<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> send_length，<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>lcd_buf<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> nwidth<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>send_buf <span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token punctuation">(</span>send_length<span class="token operator">%</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">printf</span><span class="token punctuation">(</span>“param error”<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span>  <span class="token operator">*</span>pbuf<span class="token operator">=</span>send_buf<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span>  <span class="token operator">*</span>plcd_buf<span class="token operator">=</span>lcd_buf<span class="token punctuation">;</span>
	<span class="token function">or</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>nwidth<span class="token operator">/</span><span class="token number">9</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token operator">*</span>plcd_buf<span class="token operator">=</span><span class="token number">0x80</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">*</span>pbuf<span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span><span class="token punctuation">(</span>plcd_buf<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0x40</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">*</span>pbuf<span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>pbuf<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span><span class="token punctuation">(</span>plcd_buf<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0x20</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>pbuf<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>pbuf<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span><span class="token punctuation">(</span>plcd_buf<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0x10</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>pbuf<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>pbuf<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span><span class="token punctuation">(</span>plcd_buf<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0x08</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>pbuf<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>pbuf<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span><span class="token punctuation">(</span>plcd_buf<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0x04</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>pbuf<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>pbuf<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span><span class="token punctuation">(</span>plcd_buf<span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0x02</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>pbuf<span class="token operator">+</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>pbuf<span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span><span class="token punctuation">(</span>plcd_buf<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">0x01</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>pbuf<span class="token operator">+</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token operator">*</span><span class="token punctuation">(</span>plcd_buf<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">*</span>pbuf<span class="token operator">+</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pbuf<span class="token operator">+=</span><span class="token number">8</span>；
		plcd_buf<span class="token operator">+=</span><span class="token number">9</span>；
	<span class="token punctuation">}</span>
		pbuf<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
	plcd_buf<span class="token operator">=</span>lcd_buf<span class="token punctuation">;</span>；
	cs_low<span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>nwidth–<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">spi_send_data_8bit</span><span class="token punctuation">(</span><span class="token operator">*</span>plcd_buf<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	cs_high<span class="token punctuation">;</span>
	plcd_buf<span class="token operator">=</span><span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
	```
	对应与发送<span class="token number">8</span>bit的有效数据，实际需要MOSI发送<span class="token number">9</span>bit数据，因为第一个bit代表了数据标识，那么发送任意字节长度的<span class="token number">3</span>线SPI数据，可以按照下面的方式：


	<span class="token keyword">void</span> <span class="token function">LCD_Send_bytes</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>send_buf<span class="token punctuation">,</span><span class="token keyword">int</span> length<span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>  

		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>send_buf <span class="token operator">==</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span><span class="token punctuation">(</span>length<span class="token operator">%</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"param error \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">int</span> len1<span class="token operator">=</span>length<span class="token operator">/</span><span class="token number">8</span><span class="token punctuation">;</span>
		<span class="token keyword">unsigned</span> <span class="token keyword">char</span>  <span class="token operator">*</span>pbuf<span class="token operator">=</span> send_buf<span class="token punctuation">;</span>		
		 cs_low<span class="token punctuation">;</span>  
		 <span class="token keyword">while</span><span class="token punctuation">(</span> len1<span class="token operator">--</span><span class="token punctuation">)</span>
		  <span class="token punctuation">{<!-- --></span>   
		    <span class="token function">LCD_Send_8byte</span><span class="token punctuation">(</span>pbuf<span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		
		    pbuf<span class="token operator">+=</span><span class="token number">8</span><span class="token punctuation">;</span>
		 <span class="token punctuation">}</span>   
		  cs_high<span class="token punctuation">;</span>  
	<span class="token punctuation">}</span> 
	
	
按照以上方式，<span class="token number">3</span>线SPI发送数据时可以按行进行批量发送，并且可以配置DMA进行搬运，CPU只需要处理数据转换即可；
上述单字节发送在stm32F4平台，<span class="token number">50</span>MHz SPI下，<span class="token number">320</span>x240 分辨率显示能刷到<span class="token number">8f</span>ps；
<span class="token number">320</span>x240x2x8x8 大约有<span class="token number">10</span>Mbps，如果采用更小的分辨率刷<span class="token number">20</span>帧以上没有问题。

以上为全部<span class="token number">3</span>线SPI<span class="token operator">-</span>LCD的硬件SPI驱动方法，下次在ESP32<span class="token operator">-</span>CAM平台也试试，采用<span class="token number">16</span>bit模式会更快。















</code></pre>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34303637323836312f:61727469636c652f64657461696c732f313232323133393332" class_="artid" style="display:none">
 </p>
</div>


