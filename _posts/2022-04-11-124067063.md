---
layout: post
title: "复基于-WebRTC-的音视频在线监考模块的设计与实现下"
date: 2022-04-11 15:32:23 +0800
description: "文章目录前言P2P 通话实现媒体设备通讯连接前言在上一篇博文 【复】基于 WebRTC 的音视频在线"
keywords: "利用webrct做考试监控"
categories: ['项目实战']
tags: ['音视频通话', 'Webrtc', 'Vue', 'Node']
artid: "124067063"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=124067063
    alt: "复基于-WebRTC-的音视频在线监考模块的设计与实现下"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     【复】基于 WebRTC 的音视频在线监考模块的设计与实现（下）
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <a href="#_2" rel="nofollow">
        前言
       </a>
      </li>
      <li>
       <a href="#P2P__10" rel="nofollow">
        P2P 通话实现
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#_12" rel="nofollow">
          媒体设备
         </a>
        </li>
        <li>
         <a href="#_85" rel="nofollow">
          通讯连接
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_190" rel="nofollow">
        在线监考
       </a>
      </li>
      <li>
       <a href="#_634" rel="nofollow">
        后记
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h2>
     <a id="_2">
     </a>
     前言
    </h2>
    <p>
     在上一篇博文
     <a href="https://blog.csdn.net/weixin_46263782/article/details/124032312">
      【复】基于 WebRTC 的音视频在线监考模块的设计与实现（上）
     </a>
     中，主要介绍了关于 WebRTC 的基本理论，那么这篇文章我们将进入实战阶段，通过 WebRTC 框架，去实现 P2P 通话，以及延伸到一对多的音视频通话，从而实现在线监考功能；
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/a89eca6a3d7127c168f1f41e46738320.png"/>
    </p>
    <p>
    </p>
    <h2>
     <a id="P2P__10">
     </a>
     P2P 通话实现
    </h2>
    <h3>
     <a id="_12">
     </a>
     媒体设备
    </h3>
    <p>
     在开发 Web 时，WebRTC 标准提供了 API，用于访问连接到计算机或智能手机的相机和麦克风，这些设备通常称为媒体设备，可以通过实现
     <code>
      MediaDevices
     </code>
     接口的
     <code>
      navigator.mediaDevices
     </code>
     对象使用 JavaScript 进行访问。通过该对象，我们可以枚举所有已连接的设备，侦听设备更改（连接或断开设备时），并打开设备以检索媒体流。
    </p>
    <p>
     调用
     <code>
      getUserMedia()
     </code>
     将触发权限请求。如果用户接受许可，则通过包含一个视频和一个音轨的
     <code>
      MediaStream
     </code>
     来解决承诺。如果权限被拒绝，则抛出
     <code>
      PermissionDeniedError
     </code>
     。如果没有连接匹配的设备，则会抛出
     <code>
      NotFoundError
     </code>
     。
    </p>
    <ul>
     <li>
      创建媒体流
     </li>
    </ul>
    <pre><code class="prism language-js"> <span class="token keyword">async</span> <span class="token function">createMedia</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">let</span> streamTep <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// 保存本地流到全局</span>
        streamTep <span class="token operator">=</span> <span class="token keyword">await</span> navigator<span class="token punctuation">.</span>mediaDevices<span class="token punctuation">.</span><span class="token function">getUserMedia</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
	        audio<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> 
	        video<span class="token operator">:</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"streamTep"</span><span class="token punctuation">,</span>streamTep<span class="token punctuation">)</span>
        <span class="token keyword">return</span> streamTep<span class="token punctuation">;</span>
 <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
    <ul>
     <li>
      播放媒体流
     </li>
    </ul>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token style language-css"><span class="token property">float</span><span class="token punctuation">:</span> left</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>video</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sucA<span class="token punctuation">"</span></span> <span class="token attr-name">autoplay</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>video</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <pre><code class="prism language-js"><span class="token comment">// 打开本地摄像头</span>
<span class="token keyword">async</span> <span class="token function">nativeMedia</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        that<span class="token punctuation">.</span>localStream <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createMedia</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">let</span> video <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#sucA'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 旧的浏览器可能没有srcObject</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"srcObject"</span> <span class="token keyword">in</span> video<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          video<span class="token punctuation">.</span>srcObject <span class="token operator">=</span> that<span class="token punctuation">.</span>localStream<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          video<span class="token punctuation">.</span>src <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>that<span class="token punctuation">.</span>localStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        that<span class="token punctuation">.</span><span class="token function">initPeer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取到媒体流后，调用函数初始化 RTCPeerConnection</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
    <ul>
     <li>
      媒体设备约束条件
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token comment">// 设置视频窗口的范围</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"video"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"width"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"min"</span><span class="token operator">:</span> <span class="token number">640</span><span class="token punctuation">,</span>
            <span class="token string">"max"</span><span class="token operator">:</span> <span class="token number">1024</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"height"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"min"</span><span class="token operator">:</span> <span class="token number">480</span><span class="token punctuation">,</span>
            <span class="token string">"max"</span><span class="token operator">:</span> <span class="token number">768</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 获取手机端前置摄像头</span>
<span class="token punctuation">{<!-- --></span> audio<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> video<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> facingMode<span class="token operator">:</span> <span class="token string">"user"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>

<span class="token comment">// 后置摄像头</span>
<span class="token punctuation">{<!-- --></span> audio<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> video<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> facingMode<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> exact<span class="token operator">:</span> <span class="token string">"environment"</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>

<span class="token comment">// 具有带宽限制的WebRTC传输，可能需要较低的帧速率</span>
<span class="token punctuation">{<!-- --></span> video<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> frameRate<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> ideal<span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span> max<span class="token operator">:</span> <span class="token number">15</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
</code></pre>
    <p>
    </p>
    <h3>
     <a id="_85">
     </a>
     通讯连接
    </h3>
    <blockquote>
     <p>
      <strong>
       RTCPeerConnection
      </strong>
      接口表示本地计算机和远程对等方之间的 WebRTC 连接。它提供了连接到远程对等方，维护和监视连接以及在不再需要连接时关闭连接的方法。
     </p>
    </blockquote>
    <p>
     <strong>
      RTCPeerConnection 建立
     </strong>
    </p>
    <ul>
     <li>
      本地流获取（上述内容）
     </li>
     <li>
      全局参数初始化
     </li>
    </ul>
    <pre><code class="prism language-js">window<span class="token punctuation">.</span>RTCPeerConnection <span class="token operator">=</span> window<span class="token punctuation">.</span>RTCPeerConnection <span class="token operator">||</span> window<span class="token punctuation">.</span>mozRTCPeerConnection <span class="token operator">||</span> window<span class="token punctuation">.</span>webkitRTCPeerConnection<span class="token punctuation">;</span>

<span class="token keyword">var</span> iceServers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
	iceServers<span class="token operator">:</span> <span class="token punctuation">[</span>
		<span class="token punctuation">{<!-- --></span> url<span class="token operator">:</span> <span class="token string">"stun:stun.l.google.com:19302"</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">// 谷歌的公共服务</span>
		<span class="token punctuation">{<!-- --></span>
			url<span class="token operator">:</span> <span class="token string">'turn:numb.viagenie.ca'</span><span class="token punctuation">,</span>
			credential<span class="token operator">:</span> <span class="token string">'muazkh'</span><span class="token punctuation">,</span>
			username<span class="token operator">:</span> <span class="token string">'webrtc@live.com'</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <ul>
     <li>
      初始化两个模拟客户端
     </li>
    </ul>
    <pre><code class="prism language-js"><span class="token comment">// 以下 pc1 和 pc2 分别代表两个模拟客户端的链接服务简写</span>
<span class="token comment">// pc1: 代表 pc1-&gt;pc2 链接  pc2: 代表 pc2-&gt;pc1 链接</span>

<span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
that<span class="token punctuation">.</span>pc1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerConnection</span><span class="token punctuation">(</span>iceServers<span class="token punctuation">)</span><span class="token punctuation">;</span>
that<span class="token punctuation">.</span>pc2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PeerConnection</span><span class="token punctuation">(</span>iceServers<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 将全局视频流赋给 pc1 链接服务</span>
that<span class="token punctuation">.</span>pc1<span class="token punctuation">.</span><span class="token function">addStream</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>localStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 监听 ice 候选信息</span>
that<span class="token punctuation">.</span>pc1<span class="token punctuation">.</span><span class="token function-variable function">onicecandidate</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pc1 onicecandidate"</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>candidate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 一般来说这个地方是通过第三方 (socket 后面会将网络端点对点) 发送给另一个客户端，但是现在本地演示直接将候选信息发送到 pc2 链接服务</span>
    that<span class="token punctuation">.</span>pc2<span class="token punctuation">.</span><span class="token function">addIceCandidate</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>candidate<span class="token punctuation">.</span><span class="token function">toJSON</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 监听远程视频 pc1 充当呼叫端，所以只要监听 pc2 有无视频流信息进来</span>
that<span class="token punctuation">.</span>pc2<span class="token punctuation">.</span><span class="token function-variable function">onaddstream</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"pc2 onaddstream"</span><span class="token punctuation">,</span>event<span class="token punctuation">)</span>
  <span class="token comment">// 监听到流后将视频流赋给另一个 video 标签</span>
  <span class="token keyword">let</span> video <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#sucB'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  video<span class="token punctuation">.</span>srcObject <span class="token operator">=</span> event<span class="token punctuation">.</span>stream<span class="token punctuation">;</span>
  video<span class="token punctuation">.</span><span class="token function-variable function">onloadedmetadata</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
    video<span class="token punctuation">.</span><span class="token function">play</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <code>
      onicecandidate
     </code>
     : 候选 ICE 描述了 WebRTC 能够与远程设备进行通信所需的协议和路由。在启动 WebRTC 对等连接时，通常在连接的每一端都建议多个候选对象，直到他们相互同意描述他们认为最好的连接的候选对象为止。
    </p>
    <ul>
     <li>
      呼叫端模拟呼叫（pc1）和应答端模拟应答（pc2）
     </li>
    </ul>
    <pre><code class="prism language-js"> <span class="token keyword">async</span> <span class="token function">createOffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 创建 offer</span>
	<span class="token keyword">let</span> offer_tep <span class="token operator">=</span> <span class="token keyword">await</span> that<span class="token punctuation">.</span>pc1<span class="token punctuation">.</span><span class="token function">createOffer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>offerOption<span class="token punctuation">)</span><span class="token punctuation">;</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"offer_tep"</span><span class="token punctuation">,</span> offer_tep<span class="token punctuation">)</span>
	
	<span class="token comment">// 设置本地描述</span>
	<span class="token keyword">await</span> that<span class="token punctuation">.</span>pc1<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span>offer_tep<span class="token punctuation">)</span>
	
	<span class="token comment">//接收端设置远程 offer 描述</span>
	<span class="token keyword">await</span> that<span class="token punctuation">.</span>pc2<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span>offer_tep<span class="token punctuation">)</span>
	
	<span class="token comment">// 接收端创建 answer</span>
	<span class="token keyword">let</span> answer <span class="token operator">=</span> <span class="token keyword">await</span> that<span class="token punctuation">.</span>pc2<span class="token punctuation">.</span><span class="token function">createAnswer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 接收端设置本地 answer 描述</span>
	<span class="token keyword">await</span> that<span class="token punctuation">.</span>pc2<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// 发送端设置远程 answer 描述</span>
	<span class="token keyword">await</span> that<span class="token punctuation">.</span>pc1<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
	
<span class="token comment">// 呼叫</span>
<span class="token keyword">async</span> <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">const</span> that <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
	
	<span class="token comment">//创建 offer 并保存本地描述</span>
	<span class="token keyword">await</span> that<span class="token punctuation">.</span><span class="token function">createOffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre>
    <p>
     为何呼叫会有这么麻烦的步骤呢？这就又涉及到 WebRTC 的会话了，具体看下面一条：
    </p>
    <blockquote>
     <p>
      “当用户 (上述pc1) 向另一个用户（上述pc2）发起 WebRTC 呼叫时，会创建一个特殊的描述，称为 offer。此描述包括有关呼叫者为呼叫建议的配置的所有信息。然后，接收者用一个答案来回应，这是他们通话结束的描述。以此方式，两个设备彼此共享为了交换媒体数据所需的信息。这种交换是使用交互式连接建立（ICE）处理的，该协议允许两个设备使用中介程序交换要约和答复，即使两个设备之间都被网络地址转换（NAT）隔开。然后，每个对等方都保留两个描述：本地描述（描述自己）和远程描述（描述呼叫的另一端）”
     </p>
    </blockquote>
    <blockquote>
     <p>
      上面的话简单来说就是 A 呼叫 B，A 创建 offer，在本地保留 offer，然后发送给 B，B 创建 answer，之后本地保留 answer，再将 answer 发送给 A，A 拿到后将 B 的 answer 设置为本地的远程描述。
     </p>
    </blockquote>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/ab931843839017cc016e4156b674a948.png"/>
    </p>
    <p>
    </p>
    <h2>
     <a id="_190">
     </a>
     在线监考
    </h2>
    <p>
     通过刚才的 P2P 学习，想必已经了解了双方之间是如何建立通讯的，那么基于 WebRTC 的在线监考原理也是如此，老师与同学们建立通讯即可，即一对多的关系，这样就能实现在线监考了；
    </p>
    <p>
     这里使用的是 vue + node 的实现形式，可以根据自己的需要进行改进；
    </p>
    <pre><code class="prism language-js"><span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> config <span class="token keyword">from</span> <span class="token string">'../../configure'</span><span class="token punctuation">;</span>

navigator<span class="token punctuation">.</span>getUserMedia <span class="token operator">=</span> navigator<span class="token punctuation">.</span>getUserMedia <span class="token operator">||</span> navigator<span class="token punctuation">.</span>mozGetUserMedia <span class="token operator">||</span> navigator<span class="token punctuation">.</span>webkitGetUserMedia<span class="token punctuation">;</span>
window<span class="token punctuation">.</span>RTCPeerConnection <span class="token operator">=</span> window<span class="token punctuation">.</span>RTCPeerConnection <span class="token operator">||</span> window<span class="token punctuation">.</span>mozRTCPeerConnection <span class="token operator">||</span> window<span class="token punctuation">.</span>webkitRTCPeerConnection<span class="token punctuation">;</span>
window<span class="token punctuation">.</span>RTCIceCandidate <span class="token operator">=</span> window<span class="token punctuation">.</span>RTCIceCandidate <span class="token operator">||</span> window<span class="token punctuation">.</span>mozRTCIceCandidate <span class="token operator">||</span> window<span class="token punctuation">.</span>webkitRTCIceCandidate<span class="token punctuation">;</span>
window<span class="token punctuation">.</span>RTCSessionDescription <span class="token operator">=</span>
  window<span class="token punctuation">.</span>RTCSessionDescription <span class="token operator">||</span> window<span class="token punctuation">.</span>mozRTCSessionDescription <span class="token operator">||</span> window<span class="token punctuation">.</span>webkitRTCSessionDescription<span class="token punctuation">;</span>

<span class="token keyword">const</span> socket <span class="token operator">=</span> io<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token constant">API_ROOT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> configuration <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  iceServers<span class="token operator">:</span> <span class="token punctuation">[</span>config<span class="token punctuation">.</span><span class="token constant">DEFAULT_ICE_SERVER</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> localStream<span class="token punctuation">,</span> peerConn<span class="token punctuation">;</span>
<span class="token keyword">let</span> connectedUser <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
      user_name<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      show<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      users<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      call_username<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      remote_video<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
      accept_video<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      peersList<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function">mounted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>
      <span class="token string">'message'</span><span class="token punctuation">,</span>
      <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">case</span> <span class="token string">'show'</span><span class="token operator">:</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>users <span class="token operator">=</span> data<span class="token punctuation">.</span>allUsers<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'join'</span><span class="token operator">:</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleLogin</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'call'</span><span class="token operator">:</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleCall</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'accept'</span><span class="token operator">:</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleAccept</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'offer'</span><span class="token operator">:</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleOffer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'candidate'</span><span class="token operator">:</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleCandidate</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'msg'</span><span class="token operator">:</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleMsg</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'answer'</span><span class="token operator">:</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleAnswer</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">case</span> <span class="token string">'leave'</span><span class="token operator">:</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleLeave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
          <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  methods<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user_name <span class="token operator">!==</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
          event<span class="token operator">:</span> <span class="token string">'join'</span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>user_name<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>connectedUser <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        message<span class="token punctuation">.</span>connectedUser <span class="token operator">=</span> connectedUser<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      socket<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">handleLogin</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>success <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Ooops...please try a different username'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>show <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>users <span class="token operator">=</span> data<span class="token punctuation">.</span>allUsers<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">addVideoURL</span><span class="token punctuation">(</span><span class="token parameter">elementId<span class="token punctuation">,</span> stream</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">var</span> video <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>elementId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Older brower may have no srcObject</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'srcObject'</span> <span class="token keyword">in</span> video<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        video<span class="token punctuation">.</span>srcObject <span class="token operator">=</span> stream<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 防止在新的浏览器里使用它，应为它已经不再支持了</span>
        video<span class="token punctuation">.</span>src <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">initCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">const</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      navigator<span class="token punctuation">.</span>mediaDevices
        <span class="token punctuation">.</span><span class="token function">getUserMedia</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> audio<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> video<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">stream</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">var</span> video <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'localVideo'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          self<span class="token punctuation">.</span><span class="token function">addVideoURL</span><span class="token punctuation">(</span><span class="token string">'localVideo'</span><span class="token punctuation">,</span> stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
          video<span class="token punctuation">.</span>muted <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          localStream <span class="token operator">=</span> stream<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">': '</span> <span class="token operator">+</span> err<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>call_username<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>users<span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>call_username<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          connectedUser <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>call_username<span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>connectedUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            event<span class="token operator">:</span> <span class="token string">'call'</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'The current user is calling, try another'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Ooops...this username cannot be empty, please try again'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token parameter">username</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      peerConn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RTCPeerConnection</span><span class="token punctuation">(</span>configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>
      peerConn<span class="token punctuation">.</span><span class="token function">addStream</span><span class="token punctuation">(</span>localStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
      peerConn<span class="token punctuation">.</span><span class="token function-variable function">onaddstream</span> <span class="token operator">=</span> <span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addVideoURL</span><span class="token punctuation">(</span><span class="token string">'remoteVideo'</span><span class="token operator">+</span>username<span class="token punctuation">,</span> e<span class="token punctuation">.</span>stream<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
      peerConn<span class="token punctuation">.</span><span class="token function-variable function">onicecandidate</span> <span class="token operator">=</span> <span class="token parameter">event</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>candidate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
              event<span class="token operator">:</span> <span class="token string">'candidate'</span><span class="token punctuation">,</span>
              candidate<span class="token operator">:</span> event<span class="token punctuation">.</span>candidate<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">handleCall</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>accept_video <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      connectedUser <span class="token operator">=</span> data<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">reject</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        event<span class="token operator">:</span> <span class="token string">'accept'</span><span class="token punctuation">,</span>
        accept<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>accept_video <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        event<span class="token operator">:</span> <span class="token string">'accept'</span><span class="token punctuation">,</span>
        accept<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>accept_video <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">handleAccept</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>accept<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Create an offer</span>
        peerConn<span class="token punctuation">.</span><span class="token function">createOffer</span><span class="token punctuation">(</span>
          <span class="token parameter">offer</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
              event<span class="token operator">:</span> <span class="token string">'offer'</span><span class="token punctuation">,</span>
              offer<span class="token operator">:</span> offer<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            peerConn<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span>offer<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Error when creating an offer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'对方已拒绝'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">handleOffer</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      connectedUser <span class="token operator">=</span> data<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>connectedUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
      peerConn<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RTCSessionDescription</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>offer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Create an answer to an offer</span>
      peerConn<span class="token punctuation">.</span><span class="token function">createAnswer</span><span class="token punctuation">(</span>
        <span class="token parameter">answer</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          peerConn<span class="token punctuation">.</span><span class="token function">setLocalDescription</span><span class="token punctuation">(</span>answer<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            event<span class="token operator">:</span> <span class="token string">'answer'</span><span class="token punctuation">,</span>
            answer<span class="token operator">:</span> answer<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'Error when creating an answer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>peersList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>connectedUser<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">handleMsg</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">handleAnswer</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      peerConn<span class="token punctuation">.</span><span class="token function">setRemoteDescription</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RTCSessionDescription</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>answer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">handleCandidate</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// ClientB 通过 PeerConnection 的 AddIceCandidate 方法保存起来</span>
      peerConn<span class="token punctuation">.</span><span class="token function">addIceCandidate</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RTCIceCandidate</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>candidate<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">hangUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        event<span class="token operator">:</span> <span class="token string">'leave'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleLeave</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">handleLeave</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">alert</span><span class="token punctuation">(</span><span class="token string">'通话已结束'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      connectedUser <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>remote_video <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
      peerConn<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      peerConn<span class="token punctuation">.</span>onicecandidate <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      peerConn<span class="token punctuation">.</span>onaddstream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>peerConn<span class="token punctuation">.</span>signalingState <span class="token operator">===</span> <span class="token string">'closed'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initCreate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function">closePreview</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>accept_video <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre>
    <pre><code class="prism language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token constant">IO</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'socket.io'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> <span class="token punctuation">{<!-- --></span> <span class="token constant">APT_HOST</span><span class="token punctuation">,</span> <span class="token constant">API_PORT</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./configure'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token function">static</span><span class="token punctuation">(</span><span class="token string">'dist'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'The HTTPS server is up and running'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> io <span class="token operator">=</span> <span class="token constant">IO</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Socket Secure server is up and running.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token constant">API_PORT</span><span class="token punctuation">,</span> <span class="token constant">APT_HOST</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Access Address: http://%s:%s'</span><span class="token punctuation">,</span> <span class="token constant">APT_HOST</span><span class="token punctuation">,</span> <span class="token constant">API_PORT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// All joined users</span>
<span class="token keyword">var</span> allUsers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// All joined sockets</span>
<span class="token keyword">var</span> allSockets <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  
io<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'connect'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">socket</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">var</span> user <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span> <span class="token comment">// current joined user</span>

  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// When has new user join in</span>
      <span class="token keyword">case</span> <span class="token string">'join'</span><span class="token operator">:</span>
        user <span class="token operator">=</span> data<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'User joined'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Save users info</span>
        allUsers<span class="token punctuation">[</span>user<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 'true' means has not call, 'false' means calling</span>
        allSockets<span class="token punctuation">[</span>user<span class="token punctuation">]</span> <span class="token operator">=</span> socket<span class="token punctuation">;</span>
        socket<span class="token punctuation">.</span>name <span class="token operator">=</span> user<span class="token punctuation">;</span>
        <span class="token function">showUserInfo</span><span class="token punctuation">(</span>allUsers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">sendTo</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
          event<span class="token operator">:</span> <span class="token string">'join'</span><span class="token punctuation">,</span>
          allUsers<span class="token operator">:</span> allUsers<span class="token punctuation">,</span>
          success<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">'call'</span><span class="token operator">:</span>
        <span class="token keyword">var</span> conn <span class="token operator">=</span> allSockets<span class="token punctuation">[</span>data<span class="token punctuation">.</span>connectedUser<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">sendTo</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
          event<span class="token operator">:</span> <span class="token string">'call'</span><span class="token punctuation">,</span>
          name<span class="token operator">:</span> socket<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">'offer'</span><span class="token operator">:</span>
        <span class="token comment">// i.e. UserA wants to call UserB</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Sending offer to: '</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>connectedUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//if UserB exists then send him offer details</span>
        <span class="token keyword">var</span> conn <span class="token operator">=</span> allSockets<span class="token punctuation">[</span>data<span class="token punctuation">.</span>connectedUser<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// allUsers[user] = false;</span>
        allUsers<span class="token punctuation">[</span>user<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">showUserInfo</span><span class="token punctuation">(</span>allUsers<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token comment">// Setting that UserA connected with UserB</span>
          socket<span class="token punctuation">.</span>otherName <span class="token operator">=</span> data<span class="token punctuation">.</span>connectedUser<span class="token punctuation">;</span>
          <span class="token function">sendTo</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            event<span class="token operator">:</span> <span class="token string">'offer'</span><span class="token punctuation">,</span>
            offer<span class="token operator">:</span> data<span class="token punctuation">.</span>offer<span class="token punctuation">,</span>
            name<span class="token operator">:</span> socket<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">sendTo</span><span class="token punctuation">(</span>socket<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            event<span class="token operator">:</span> <span class="token string">'msg'</span><span class="token punctuation">,</span>
            message<span class="token operator">:</span> <span class="token string">'Not found this name'</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">'accept'</span><span class="token operator">:</span>
        <span class="token keyword">var</span> conn <span class="token operator">=</span> allSockets<span class="token punctuation">[</span>data<span class="token punctuation">.</span>connectedUser<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>accept<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">sendTo</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
              event<span class="token operator">:</span> <span class="token string">'accept'</span><span class="token punctuation">,</span>
              accept<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            allUsers<span class="token punctuation">[</span>data<span class="token punctuation">.</span>connectedUser<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">sendTo</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
              event<span class="token operator">:</span> <span class="token string">'accept'</span><span class="token punctuation">,</span>
              accept<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">'answer'</span><span class="token operator">:</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Sending answer to: '</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>connectedUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// i.e. UserB answers UserA</span>
        <span class="token keyword">var</span> conn <span class="token operator">=</span> allSockets<span class="token punctuation">[</span>data<span class="token punctuation">.</span>connectedUser<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token comment">// allUsers[user] = false;</span>
        allUsers<span class="token punctuation">[</span>user<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">showUserInfo</span><span class="token punctuation">(</span>allUsers<span class="token punctuation">)</span><span class="token punctuation">;</span>
          socket<span class="token punctuation">.</span>otherName <span class="token operator">=</span> data<span class="token punctuation">.</span>connectedUser<span class="token punctuation">;</span>
          <span class="token function">sendTo</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            event<span class="token operator">:</span> <span class="token string">'answer'</span><span class="token punctuation">,</span>
            answer<span class="token operator">:</span> data<span class="token punctuation">.</span>answer<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">'candidate'</span><span class="token operator">:</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Sending candidate to:'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>connectedUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> conn1 <span class="token operator">=</span> allSockets<span class="token punctuation">[</span>data<span class="token punctuation">.</span>connectedUser<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> conn2 <span class="token operator">=</span> allSockets<span class="token punctuation">[</span>socket<span class="token punctuation">.</span>otherName<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conn1 <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">sendTo</span><span class="token punctuation">(</span>conn1<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            event<span class="token operator">:</span> <span class="token string">'candidate'</span><span class="token punctuation">,</span>
            candidate<span class="token operator">:</span> data<span class="token punctuation">.</span>candidate<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">sendTo</span><span class="token punctuation">(</span>conn2<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            event<span class="token operator">:</span> <span class="token string">'candidate'</span><span class="token punctuation">,</span>
            candidate<span class="token operator">:</span> data<span class="token punctuation">.</span>candidate<span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

      <span class="token keyword">case</span> <span class="token string">'leave'</span><span class="token operator">:</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Disconnecting from'</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>connectedUser<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> conn <span class="token operator">=</span> allSockets<span class="token punctuation">[</span>data<span class="token punctuation">.</span>connectedUser<span class="token punctuation">]</span><span class="token punctuation">;</span>
        allUsers<span class="token punctuation">[</span>socket<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        allUsers<span class="token punctuation">[</span>data<span class="token punctuation">.</span>connectedUser<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        socket<span class="token punctuation">.</span>otherName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// Notify the other user so he can disconnect his peer connection</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">showUserInfo</span><span class="token punctuation">(</span>allUsers<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token function">sendTo</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            event<span class="token operator">:</span> <span class="token string">'leave'</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  socket<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'disconnect'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>socket<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">delete</span> allUsers<span class="token punctuation">[</span>socket<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">delete</span> allSockets<span class="token punctuation">[</span>socket<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token function">showUserInfo</span><span class="token punctuation">(</span>allUsers<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>socket<span class="token punctuation">.</span>otherName<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Disconnecting from '</span><span class="token punctuation">,</span> socket<span class="token punctuation">.</span>otherName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> conn <span class="token operator">=</span> allSockets<span class="token punctuation">[</span>socket<span class="token punctuation">.</span>otherName<span class="token punctuation">]</span><span class="token punctuation">;</span>
        allUsers<span class="token punctuation">[</span>socket<span class="token punctuation">.</span>otherName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        socket<span class="token punctuation">.</span>otherName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>conn <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">sendTo</span><span class="token punctuation">(</span>conn<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
            type<span class="token operator">:</span> <span class="token string">'leave'</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">showUserInfo</span><span class="token punctuation">(</span><span class="token parameter">allUsers</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">sendTo</span><span class="token punctuation">(</span>io<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
    event<span class="token operator">:</span> <span class="token string">'show'</span><span class="token punctuation">,</span>
    allUsers<span class="token operator">:</span> allUsers<span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">sendTo</span><span class="token punctuation">(</span><span class="token parameter">connection<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  connection<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
    <p>
     界面自己调整，这里就是为了方便展示；
     <br/>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/a89eca6a3d7127c168f1f41e46738320.png"/>
    </p>
    <p>
     <font color="red">
      注意，如果浏览器无法获取到摄像头，并报错
      <code>
       Cannot read properties of undefined (reading 'getUserMedia')
      </code>
      ，是因为浏览器有安全设置
     </font>
     ，只需要进行如下操作即可开放摄像头权限：
    </p>
    <p>
     <code>
      chrome://flags/#unsafely-treat-insecure-origin-as-secure
     </code>
    </p>
    <p>
     不是用谷歌的小伙伴可以自行替换前缀，比如 Edge 浏览器：
    </p>
    <p>
     <code>
      edge://flags/#unsafely-treat-insecure-origin-as-secure
     </code>
    </p>
    <p>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/929e043ad55f1fb003888d638ff4e79e.png"/>
    </p>
    <p>
     最后在旁边的空白处点一下，底部就会出现如下图所示：
     <br/>
     <img alt="" src="https://i-blog.csdnimg.cn/blog_migrate/9bd13df5d8b2ec4e862f4b1fd464bd9e.png"/>
    </p>
    <p>
     点一下
     <strong>
      Relauch
     </strong>
     就可以了；
    </p>
    <p>
    </p>
    <h2>
     <a id="_634">
     </a>
     后记
    </h2>
    <p>
     总的来说，WebRTC 还是超赞的，node.js 也是，记录每一个脚印！
    </p>
    <p>
     参考：
    </p>
    <ul>
     <li>
      <a href="https://juejin.cn/post/6866252061336567822" rel="nofollow">
       webrtc实现群聊系列文章(一)本地模拟视频通话
      </a>
     </li>
     <li>
      <a href="https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Protocols" rel="nofollow">
       Introduction to WebRTC protocols
      </a>
     </li>
     <li>
      <a href="https://blog.csdn.net/github_39274378/article/details/103767330?utm_medium=distribute.wap_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-9.wap_blog_relevant_default&amp;spm=1001.2101.3001.4242.6&amp;utm_relevant_index=12">
       vue+node(socket.io)+webRTC实现一对一通话测试
      </a>
     </li>
     <li>
      <a href="https://blog.csdn.net/yunzhonghefei/article/details/120290541">
       使用浏览器访问远程服务，调用本地摄像头录制音视频报错
      </a>
     </li>
    </ul>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f672e:6373646e2e6e65742f77656978696e5f34363236333738322f:61727469636c652f64657461696c732f313234303637303633" class_="artid" style="display:none">
 </p>
</div>


