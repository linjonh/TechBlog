---
layout: post
title: "基于联邦学习的MNIST手写数字识别-Pytorch实现"
date: 2024-12-27 09:36:06 +0800
description: "基于联邦学习的MNIST手写数字识别-Pytorch实现背景知识导入库读取MNIST数据集训练和测试"
keywords: "联邦学习 mnist csdn"
categories: ["未分类"]
tags: ["神经网络", "机器学习", "Pytorch"]
artid: "107899927"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=107899927
  alt: "基于联邦学习的MNIST手写数字识别-Pytorch实现"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     基于联邦学习的MNIST手写数字识别-Pytorch实现
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      基于联邦学习的MNIST手写数字识别-Pytorch实现
     </h4>
     <ul>
      <li>
       <ul>
        <li>
         <a href="#_2" rel="nofollow">
          背景知识
         </a>
        </li>
        <li>
         <a href="#_9" rel="nofollow">
          导入库
         </a>
        </li>
        <li>
         <a href="#MNIST_20" rel="nofollow">
          读取MNIST数据集
         </a>
        </li>
        <li>
         <a href="#_36" rel="nofollow">
          训练和测试
         </a>
        </li>
        <li>
         <a href="#_194" rel="nofollow">
          实验结果
         </a>
        </li>
        <li>
         <a href="#_201" rel="nofollow">
          结语
         </a>
        </li>
       </ul>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h3>
     <a id="_2">
     </a>
     背景知识
    </h3>
    <p>
     <strong>
      联邦学习
     </strong>
     ：联邦学习是为了解决“数据孤岛”的问题，即不同机构由于隐私保护等限制无法获取更多的数据来完善模型，从而形成孤岛。联邦学习让不同的机构通过一个中心服务器传输模型参数，在一定程度上达到了共享数据集的效果。各个机构通过联邦学习框架进行合作，最大化其收益。
     <br/>
     <strong>
      MNIST数据集
     </strong>
     ：MNIST数据集是计算机视觉领域中比较常用的数据集，它包含60000个训练数据和10000个测试数据。其内容是0-9的手写数字，且每张图片都是灰度图像，像素为28×28，具体见下图：
     <br/>
     <img src="https://i-blog.csdnimg.cn/blog_migrate/ed7eceb7a556bcb3e80aea0e8a40c417.png" width="40%">
      <br/>
      <strong>
       Pytorch
      </strong>
      ：Pytorch是开源的机器学习库，在近几年的论文中得到广泛应用。
     </img>
    </p>
    <h3>
     <a id="_9">
     </a>
     导入库
    </h3>
    <pre><code class="prism language-javascript"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torchvision
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>dataloader <span class="token keyword">as</span> dataloader
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Subset
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>parameter <span class="token keyword">import</span> Parameter
</code></pre>
    <h3>
     <a id="MNIST_20">
     </a>
     读取MNIST数据集
    </h3>
    <p>
     使用Subset函数对训练数据集进行划分，这里总共有ABC三个机构，每个机构的训练集数目为1000。然后将训练数据集放入Dataloader里，这里batch_size即每次往神经网络放入多少数据，比如batch_size为100就是每次放入100个数据，总共放10次。shuffle为True意为将数据集打乱。这里我们把整个训练集作为一个batch_size，所以不需要打乱。
    </p>
    <pre><code class="prism language-javascript">train_set <span class="token operator">=</span> torchvision<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span><span class="token constant">MNIST</span><span class="token punctuation">(</span>root<span class="token operator">=</span><span class="token string">"./data"</span><span class="token punctuation">,</span>train<span class="token operator">=</span>True<span class="token punctuation">,</span>transform<span class="token operator">=</span>transforms<span class="token punctuation">.</span><span class="token function">ToTensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>download<span class="token operator">=</span>True<span class="token punctuation">)</span>
train_set_A<span class="token operator">=</span><span class="token function">Subset</span><span class="token punctuation">(</span>train_set<span class="token punctuation">,</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
train_set_B<span class="token operator">=</span><span class="token function">Subset</span><span class="token punctuation">(</span>train_set<span class="token punctuation">,</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
train_set_C<span class="token operator">=</span><span class="token function">Subset</span><span class="token punctuation">(</span>train_set<span class="token punctuation">,</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">,</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
train_loader_A <span class="token operator">=</span> dataloader<span class="token punctuation">.</span><span class="token function">DataLoader</span><span class="token punctuation">(</span>dataset<span class="token operator">=</span>train_set_A<span class="token punctuation">,</span>batch_size<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>shuffle<span class="token operator">=</span>False<span class="token punctuation">)</span>
train_loader_B <span class="token operator">=</span> dataloader<span class="token punctuation">.</span><span class="token function">DataLoader</span><span class="token punctuation">(</span>dataset<span class="token operator">=</span>train_set_B<span class="token punctuation">,</span>batch_size<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>shuffle<span class="token operator">=</span>False<span class="token punctuation">)</span>
train_loader_C <span class="token operator">=</span> dataloader<span class="token punctuation">.</span><span class="token function">DataLoader</span><span class="token punctuation">(</span>dataset<span class="token operator">=</span>train_set_C<span class="token punctuation">,</span>batch_size<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">,</span>shuffle<span class="token operator">=</span>False<span class="token punctuation">)</span>
test_set <span class="token operator">=</span> torchvision<span class="token punctuation">.</span>datasets<span class="token punctuation">.</span><span class="token constant">MNIST</span><span class="token punctuation">(</span>root<span class="token operator">=</span><span class="token string">"./data"</span><span class="token punctuation">,</span>train<span class="token operator">=</span>False<span class="token punctuation">,</span>transform<span class="token operator">=</span>transforms<span class="token punctuation">.</span><span class="token function">ToTensor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>download<span class="token operator">=</span>True<span class="token punctuation">)</span>
test_set<span class="token operator">=</span><span class="token function">Subset</span><span class="token punctuation">(</span>test_set<span class="token punctuation">,</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
test_loader <span class="token operator">=</span> dataloader<span class="token punctuation">.</span><span class="token function">DataLoader</span><span class="token punctuation">(</span>dataset<span class="token operator">=</span>test_set<span class="token punctuation">,</span>shuffle<span class="token operator">=</span>True<span class="token punctuation">)</span>
</code></pre>
    <h3>
     <a id="_36">
     </a>
     训练和测试
    </h3>
    <p>
     <strong>
      train_and_test_1
     </strong>
     :普通的训练测试过程。
     <br/>
     首先定义神经网络的类型，这里用的是最简单的三层神经网络（也可以说是两层，不算输入层），输入层28×28，隐藏层12个神经元，输出层10个神经元。
    </p>
    <pre><code class="prism language-javascript">def <span class="token function">train_and_test_1</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">,</span>test_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">class</span> <span class="token class-name">NeuralNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
        def <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_num<span class="token punctuation">,</span> hidden_num<span class="token punctuation">,</span> output_num<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>NeuralNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">__init__</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span><span class="token function">Linear</span><span class="token punctuation">(</span>input_num<span class="token punctuation">,</span> hidden_num<span class="token punctuation">)</span>  # 服从正态分布的权重w
            self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span><span class="token function">Linear</span><span class="token punctuation">(</span>hidden_num<span class="token punctuation">,</span> output_num<span class="token punctuation">)</span>
            nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span><span class="token function">normal_</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">.</span>weight<span class="token punctuation">)</span>
            nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span><span class="token function">normal_</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc2<span class="token punctuation">.</span>weight<span class="token punctuation">)</span>
            nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span><span class="token function">constant_</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> val<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>  # 初始化bias为<span class="token number">0</span>
            nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span><span class="token function">constant_</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc2<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> val<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>relu <span class="token operator">=</span> nn<span class="token punctuation">.</span><span class="token function">ReLU</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  # Relu激励函数

        def <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">fc1</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">relu</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
            y <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">fc2</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
            <span class="token keyword">return</span> y

    epoches <span class="token operator">=</span> <span class="token number">20</span>  # 迭代<span class="token number">20</span>轮
    lr <span class="token operator">=</span> <span class="token number">0.01</span>  # 学习率，即步长
    input_num <span class="token operator">=</span> <span class="token number">784</span>
    hidden_num <span class="token operator">=</span> <span class="token number">12</span>
    output_num <span class="token operator">=</span> <span class="token number">10</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token function">device</span><span class="token punctuation">(</span><span class="token string">"cuda"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span><span class="token function">is_available</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>

    model <span class="token operator">=</span> <span class="token function">NeuralNet</span><span class="token punctuation">(</span>input_num<span class="token punctuation">,</span> hidden_num<span class="token punctuation">,</span> output_num<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    loss_func <span class="token operator">=</span> nn<span class="token punctuation">.</span><span class="token function">CrossEntropyLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  # 损失函数的类型：交叉熵损失函数
    optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span><span class="token function">Adam</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token function">parameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">)</span>  # Adam优化，也可以用<span class="token constant">SGD</span>随机梯度下降法
    # optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span><span class="token constant">SGD</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token function">parameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">)</span>
    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token function">range</span><span class="token punctuation">(</span>epoches<span class="token punctuation">)</span><span class="token punctuation">:</span>
        flag <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> images<span class="token punctuation">,</span> labels <span class="token keyword">in</span> train_loader<span class="token punctuation">:</span>
            images <span class="token operator">=</span> images<span class="token punctuation">.</span><span class="token function">reshape</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">28</span> <span class="token operator">*</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            labels <span class="token operator">=</span> labels<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            output <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span>

            loss <span class="token operator">=</span> <span class="token function">loss_func</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span><span class="token function">zero_grad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span><span class="token function">backward</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  # 误差反向传播，计算参数更新值
            optimizer<span class="token punctuation">.</span><span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  # 将参数更新值施加到net的parameters上

            # 以下两步可以看每轮损失函数具体的变化情况
            # <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                # <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Epoch [{}/{}], Loss: {:.4f}'</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> epoches<span class="token punctuation">,</span> loss<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            flag <span class="token operator">+=</span> <span class="token number">1</span>

    params <span class="token operator">=</span> <span class="token function">list</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token function">named_parameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  # 获取模型参数

    # 测试，评估准确率
    correct <span class="token operator">=</span> <span class="token number">0</span>
    total <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> images<span class="token punctuation">,</span> labels <span class="token keyword">in</span> test_loader<span class="token punctuation">:</span>
        images <span class="token operator">=</span> images<span class="token punctuation">.</span><span class="token function">reshape</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">28</span> <span class="token operator">*</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        labels <span class="token operator">=</span> labels<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        output <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span>
        values<span class="token punctuation">,</span> predicte <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>  # <span class="token number">0</span>是每列的最大值，<span class="token number">1</span>是每行的最大值
        total <span class="token operator">+=</span> labels<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        # predicte <span class="token operator">==</span> labels 返回每张图片的布尔类型
        correct <span class="token operator">+=</span> <span class="token punctuation">(</span>predicte <span class="token operator">==</span> labels<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"The accuracy of total {} images: {}%"</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>total<span class="token punctuation">,</span> <span class="token number">100</span> <span class="token operator">*</span> correct <span class="token operator">/</span> total<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> params

</code></pre>
<p>
<strong>
train*and_test_2
</strong>
：联邦后的训练测试过程。
<br/>
注意每次联邦前，bias 都要重置为 0，这样效果会好。并且需要把做完平均后的 w 传入到模型中。
</p>
<pre><code class="prism language-javascript">def <span class="token function">train_and_test_2</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">,</span>test_loader<span class="token punctuation">,</span>com_para_fc1<span class="token punctuation">,</span>com_para_fc2<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token keyword">class</span> <span class="token class-name">NeuralNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
def <span class="token function">**init**</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_num<span class="token punctuation">,</span> hidden_num<span class="token punctuation">,</span> output_num<span class="token punctuation">,</span>com_para_fc1<span class="token punctuation">,</span>com_para_fc2<span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token keyword">super</span><span class="token punctuation">(</span>NeuralNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">**init**</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span><span class="token function">Linear</span><span class="token punctuation">(</span>input_num<span class="token punctuation">,</span> hidden_num<span class="token punctuation">)</span>
self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span><span class="token function">Linear</span><span class="token punctuation">(</span>hidden_num<span class="token punctuation">,</span> output_num<span class="token punctuation">)</span>
self<span class="token punctuation">.</span>fc1<span class="token punctuation">.</span>weight<span class="token operator">=</span><span class="token function">Parameter</span><span class="token punctuation">(</span>com_para_fc1<span class="token punctuation">)</span>
self<span class="token punctuation">.</span>fc2<span class="token punctuation">.</span>weight<span class="token operator">=</span><span class="token function">Parameter</span><span class="token punctuation">(</span>com_para_fc2<span class="token punctuation">)</span>
nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span><span class="token function">constant*</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> val<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span><span class="token function">constant\_</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc2<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> val<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
self<span class="token punctuation">.</span>relu <span class="token operator">=</span> nn<span class="token punctuation">.</span><span class="token function">ReLU</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        def <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">fc1</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
            x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">relu</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
            y <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">fc2</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
            <span class="token keyword">return</span> y

    epoches <span class="token operator">=</span> <span class="token number">20</span>
    lr <span class="token operator">=</span> <span class="token number">0.01</span>
    input_num <span class="token operator">=</span> <span class="token number">784</span>
    hidden_num <span class="token operator">=</span> <span class="token number">12</span>
    output_num <span class="token operator">=</span> <span class="token number">10</span>
    device <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token function">device</span><span class="token punctuation">(</span><span class="token string">"cuda"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span><span class="token function">is_available</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>

    model <span class="token operator">=</span> <span class="token function">NeuralNet</span><span class="token punctuation">(</span>input_num<span class="token punctuation">,</span> hidden_num<span class="token punctuation">,</span> output_num<span class="token punctuation">,</span>com_para_fc1<span class="token punctuation">,</span>com_para_fc2<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    loss_func <span class="token operator">=</span> nn<span class="token punctuation">.</span><span class="token function">CrossEntropyLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span><span class="token function">Adam</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token function">parameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">)</span>
    # optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span><span class="token constant">SGD</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token function">parameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>lr<span class="token punctuation">)</span>

    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token function">range</span><span class="token punctuation">(</span>epoches<span class="token punctuation">)</span><span class="token punctuation">:</span>
        flag <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">for</span> images<span class="token punctuation">,</span> labels <span class="token keyword">in</span> train_loader<span class="token punctuation">:</span>
            # <span class="token punctuation">(</span>images<span class="token punctuation">,</span> labels<span class="token punctuation">)</span> <span class="token operator">=</span> data
            images <span class="token operator">=</span> images<span class="token punctuation">.</span><span class="token function">reshape</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">28</span> <span class="token operator">*</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            labels <span class="token operator">=</span> labels<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            output <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span>

            loss <span class="token operator">=</span> <span class="token function">loss_func</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span><span class="token function">zero_grad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span><span class="token function">backward</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            optimizer<span class="token punctuation">.</span><span class="token function">step</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

            # <span class="token keyword">if</span> <span class="token punctuation">(</span>flag <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                # <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'Epoch [{}/{}], Loss: {:.4f}'</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> epoches<span class="token punctuation">,</span> loss<span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            flag <span class="token operator">+=</span> <span class="token number">1</span>
    params <span class="token operator">=</span> <span class="token function">list</span><span class="token punctuation">(</span>model<span class="token punctuation">.</span><span class="token function">named_parameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>#<span class="token keyword">get</span> the index by debuging

    correct <span class="token operator">=</span> <span class="token number">0</span>
    total <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> images<span class="token punctuation">,</span> labels <span class="token keyword">in</span> test_loader<span class="token punctuation">:</span>
        images <span class="token operator">=</span> images<span class="token punctuation">.</span><span class="token function">reshape</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">28</span> <span class="token operator">*</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        labels <span class="token operator">=</span> labels<span class="token punctuation">.</span><span class="token function">to</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span>
        output <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span>images<span class="token punctuation">)</span>
        values<span class="token punctuation">,</span> predicte <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        total <span class="token operator">+=</span> labels<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
        correct <span class="token operator">+=</span> <span class="token punctuation">(</span>predicte <span class="token operator">==</span> labels<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">item</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"The accuracy of total {} images: {}%"</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>total<span class="token punctuation">,</span> <span class="token number">100</span> <span class="token operator">*</span> correct <span class="token operator">/</span> total<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> params

</code></pre>
<p>
<strong>
combine_params
</strong>
：对模型参数做平均，只对权重 w 做平均。
</p>
<pre><code class="prism language-javascript">def <span class="token function">combine_params</span><span class="token punctuation">(</span>para_A<span class="token punctuation">,</span>para_B<span class="token punctuation">,</span>para_C<span class="token punctuation">)</span><span class="token punctuation">:</span>
fc1_wA<span class="token operator">=</span>para_A<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data
fc1_wB<span class="token operator">=</span>para_B<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data
fc1_wC<span class="token operator">=</span>para_C<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data

    fc2_wA<span class="token operator">=</span>para_A<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data
    fc2_wB<span class="token operator">=</span>para_B<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data
    fc2_wC<span class="token operator">=</span>para_C<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data

    com_para_fc1<span class="token operator">=</span><span class="token punctuation">(</span>fc1_wA<span class="token operator">+</span>fc1_wB<span class="token operator">+</span>fc1_wC<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">3</span>
    com_para_fc2<span class="token operator">=</span><span class="token punctuation">(</span>fc2_wA<span class="token operator">+</span>fc2_wB<span class="token operator">+</span>fc2_wC<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">3</span>
    <span class="token keyword">return</span> com_para_fc1<span class="token punctuation">,</span>com_para_fc2

</code></pre>
<p>
<strong>
主函数
</strong>
:先进行正常的训练测试，再进行联邦后的训练测试。
</p>
<pre><code class="prism language-javascript">para_A<span class="token operator">=</span><span class="token function">train_and_test_1</span><span class="token punctuation">(</span>train_loader_A<span class="token punctuation">,</span>test_loader<span class="token punctuation">)</span>
para_B<span class="token operator">=</span><span class="token function">train_and_test_1</span><span class="token punctuation">(</span>train_loader_B<span class="token punctuation">,</span>test_loader<span class="token punctuation">)</span>
para_C<span class="token operator">=</span><span class="token function">train_and_test_1</span><span class="token punctuation">(</span>train_loader_C<span class="token punctuation">,</span>test_loader<span class="token punctuation">)</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"The {} round to be federated!!!"</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
com_para_fc1<span class="token punctuation">,</span>com_para_fc2<span class="token operator">=</span><span class="token function">combine_params</span><span class="token punctuation">(</span>para_A<span class="token punctuation">,</span>para_B<span class="token punctuation">,</span>para_C<span class="token punctuation">)</span>
para_A<span class="token operator">=</span><span class="token function">train_and_test_2</span><span class="token punctuation">(</span>train_loader_A<span class="token punctuation">,</span>test_loader<span class="token punctuation">,</span>com_para_fc1<span class="token punctuation">,</span>com_para_fc2<span class="token punctuation">)</span>
para_B<span class="token operator">=</span><span class="token function">train_and_test_2</span><span class="token punctuation">(</span>train_loader_B<span class="token punctuation">,</span>test_loader<span class="token punctuation">,</span>com_para_fc1<span class="token punctuation">,</span>com_para_fc2<span class="token punctuation">)</span>
para_C<span class="token operator">=</span><span class="token function">train_and_test_2</span><span class="token punctuation">(</span>train_loader_C<span class="token punctuation">,</span>test_loader<span class="token punctuation">,</span>com_para_fc1<span class="token punctuation">,</span>com_para_fc2<span class="token punctuation">)</span>
</code></pre>
<h3>
<a id="_194">
</a>
实验结果
</h3>
<p>
<strong>
三个机构
</strong>
:
<br/>
<img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/570c762d2f1970a21a29efdde11107e3.png">
<br/>
可以看到，刚开始三个机构的准确率分别为 24.85%、17.95%和 20%，而联邦以后，其准确率有明显提高，且随着联邦轮数的增加，最终三个机构的准确率均能达到 80%以上。
<br/>
<strong>
五个机构
</strong>
:对于五个机构，只需改一下对参数做平均的函数以及主函数。
<br/>
<img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/00b4b079b353bd85ca2ca8f8d6b8ed99.png">
<br/>
机构数目越多，意味着可共享的数据越多，当第六轮联邦后，各机构的准确率均达到 82%以上，继续联邦，其准确率提高不大。由于我们采用的是最简单的三层神经网络（输入层、隐藏层、输出层），这样的准确率还是令人满意的。
</img>
</img>
</p>
<h3>
<a id="_201">
</a>
结语
</h3>
<p>
以前碰到配置环境中的 bug、程序的 bug 或者无从下手得项目，都是看 csdn 博客来学习。本着分享知识和见证自己成长的初心，我写下了自己的第一篇博客！
</p>

   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33393232303330382f:61727469636c652f64657461696c732f313037383939393237" class_="artid" style="display:none">
 </p>
</div>
