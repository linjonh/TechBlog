---
layout: post
title: "RTCPeerConnection基本概念-以及创建和绑定音视频以及渲染远端视频时候的作用"
date: 2022-05-09 22:43:46 +0800
description: "RTCPeerConnection  是WebRTC的核心的 是其暴露个用户的统一接口 其由多个模块"
keywords: "rtcpeerconnection"
categories: ["未分类"]
tags: ["音视频", "前端", "Javascript"]
artid: "124674777"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=124674777
  alt: "RTCPeerConnection基本概念-以及创建和绑定音视频以及渲染远端视频时候的作用"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     RTCPeerConnection基本概念 -- 以及创建和绑定音视频以及渲染远端视频时候的作用
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     RTCPeerConnection 是WebRTC的核心的 是其暴露个用户的统一接口 其由多个模块组成
     <br/>
     · 网络处理模块
     <br/>
     · 服务质量模块
     <br/>
     · 音视频引擎模块 等等
     <br/>
     最最厉害的就是根据网络情况动态调整出音视频的最佳服务质量
    </p>
    <p>
     创建RTCPeerConnection
    </p>
    <pre><code class="prism language-c">配置ICE  也就是建立网络协商方式

var pcConfig <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token char">'iceServers'</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
<span class="token char">'urls'</span><span class="token operator">:</span> <span class="token char">'turn:xxx.fun:3478'</span><span class="token punctuation">,</span>
<span class="token char">'credential'</span><span class="token operator">:</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
<span class="token char">'username'</span><span class="token operator">:</span> <span class="token string">"root"</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

pc <span class="token operator">=</span> new <span class="token function">RTCPeerConnection</span><span class="token punctuation">(</span>pcConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre>
<h4>
<a id="configuration__24">
</a>
configuration 参数分析
</h4>
<h5>
<a id="bundlePolicy__25">
</a>
bundlePolicy 指定如何绑定传输通道
</h5>
<pre><code>banlanced：音频与视频轨使用各自的传输通道
max­compat：每个轨使用自己的传输通道
max­bundle：都绑定到同一个传输通道(主要使用)
</code></pre>
<h5>
<a id="iceTransportPolicy_ICE_29">
</a>
iceTransportPolicy 指定 ICE 的传输策略
</h5>
<pre><code>relay：只使用中继候选者 （测试时使用）
all：可以使用任何类型的候选者（一般使用）
</code></pre>
<h5>
<a id="iceServers_RTCIceServerRTCIceServerICEdemo_32">
</a>
iceServers 其由 RTCIceServer 组成，每个 RTCIceServer 都是一个 ICE 代理的服务器（如上 demo）
</h5>
<pre><code>credential 凭据，只有 TURN 服务使用
credentialType 凭据类型，可以 password 或 oauth
urls 用于连接服中的 ur 数组
username 用户名，只有 TURN 服务使用
</code></pre>
<h5>
<a id="rtcpMuxPolicy__rtcpICE_37">
</a>
rtcpMuxPolicy rtcp 的复用策略，该选项在收集 ICE 候选者时使用
</h5>
<pre><code>negotiate 收集 RTCP 与 RTP 复用的 ICE 候选者，如果 RTCP 能复用就与 RTP 复用，如果不能复用，就将他们单独使用
require 只能收集 RTCP 与 RTP 复用的 ICE 候选者，如果 RTCP 不能复用，则失败(一般使用)
</code></pre>
<p>
绑定本本地流
</p>
<pre><code class="prism language-c">function <span class="token function">bindTracks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>'bind tracks into RTCPeerConnection<span class="token operator">!</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span> pc <span class="token operator">==</span><span class="token operator">=</span> null <span class="token operator">||</span> pc <span class="token operator">==</span><span class="token operator">=</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token char">'pc is null or undefined!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>localStream <span class="token operator">==</span><span class="token operator">=</span> null <span class="token operator">||</span> localStream <span class="token operator">==</span><span class="token operator">=</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>'localstream is null or undefined<span class="token operator">!</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//add all track into peer connection</span>
    localStream<span class="token punctuation">.</span><span class="token function">getTracks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>track<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
    	pc<span class="token punctuation">.</span><span class="token function">addTrack</span><span class="token punctuation">(</span>track<span class="token punctuation">,</span> localStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

function <span class="token function">getMediaStream</span><span class="token punctuation">(</span>stream<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>localStream<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    	stream<span class="token punctuation">.</span><span class="token function">getAudioTracks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>track<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>
    		localStream<span class="token punctuation">.</span><span class="token function">addTrack</span><span class="token punctuation">(</span>track<span class="token punctuation">)</span><span class="token punctuation">;</span>
    		stream<span class="token punctuation">.</span><span class="token function">removeTrack</span><span class="token punctuation">(</span>track<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    	localStream <span class="token operator">=</span> stream<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    localVideo<span class="token punctuation">.</span>srcObject <span class="token operator">=</span> localStream<span class="token punctuation">;</span>

    <span class="token comment">//这个函数的位置特别重要，</span>
    <span class="token comment">//一定要放到getMediaStream之后再调用</span>
    <span class="token comment">//否则就会出现绑定失败的情况</span>

    <span class="token function">conn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>

</code></pre>
<h4>
<a id="_87">
</a>
远端音视频渲染
</h4>
<p>
每当远端的音视频数据传递过来的时候 RTCPeerConnection 对象的 Ontrack（）事件就会触发
<br/>
我们只需要给其设置一个回调函数即可
</p>
<pre><code class="prism language-c"> pc <span class="token operator">=</span> new <span class="token function">RTCPeerConnection</span><span class="token punctuation">(</span>pcConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>

        pc<span class="token punctuation">.</span>onicecandidate <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>candidate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">sendMessage</span><span class="token punctuation">(</span>roomid<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
                    type<span class="token operator">:</span> <span class="token char">'candidate'</span><span class="token punctuation">,</span>
                    label<span class="token operator">:</span>event<span class="token punctuation">.</span>candidate<span class="token punctuation">.</span>sdpMLineIndex<span class="token punctuation">,</span>
                    id<span class="token operator">:</span>event<span class="token punctuation">.</span>candidate<span class="token punctuation">.</span>sdpMid<span class="token punctuation">,</span>
                    candidate<span class="token operator">:</span> event<span class="token punctuation">.</span>candidate<span class="token punctuation">.</span>candidate
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token char">'this is the end candidate'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        pc<span class="token punctuation">.</span>ontrack <span class="token operator">=</span> getRemoteStream<span class="token punctuation">;</span>

function <span class="token function">getRemoteStream</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
remoteStream <span class="token operator">=</span> e<span class="token punctuation">.</span>streams<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
remoteVideo<span class="token punctuation">.</span>srcObject <span class="token operator">=</span> e<span class="token punctuation">.</span>streams<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>

   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a2f2f62:6c6f672e6373646e2e6e65742f71715f33333332393331362f:61727469636c652f64657461696c732f313234363734373737" class_="artid" style="display:none">
 </p>
</div>
