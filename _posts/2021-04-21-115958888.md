---
layout: post
title: STM32F103RFID-RC522模块-实现简单读卡写卡demo
date: 2021-04-21 17:20:25 +0800
categories: ['嵌入式', 'Stm']
tags: ['嵌入式', 'Stm', 'Rc']
image:
    path: https://img-blog.csdnimg.cn/20210422124412824.png?x-oss-process&#61;image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0lrYXJvc181MjE&#61;,size_16,color_FFFFFF,t_70
    alt: STM32F103RFID-RC522模块-实现简单读卡写卡demo
artid: 115958888
render_with_liquid: false
---
<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     STM32F103+RFID-RC522模块 实现简单读卡写卡demo
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-light" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      目录
     </h4>
     <ul>
      <li>
       <a href="#_1" rel="nofollow">
        前言
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#_2" rel="nofollow">
          特别声明:
         </a>
        </li>
        <li>
         <a href="#_36" rel="nofollow">
          代码下载：
         </a>
        </li>
        <li>
         <a href="#_40" rel="nofollow">
          功能介绍：
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_61" rel="nofollow">
        接线
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#STM32_74" rel="nofollow">
          STM32
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#STM32F1_V12_75" rel="nofollow">
            STM32F1开发指南(精英版)-库函数版本_V1.2
           </a>
          </li>
          <li>
           <a href="#STM32_77" rel="nofollow">
            STM32中文参考手册
           </a>
          </li>
         </ul>
        </li>
        <li>
         <a href="#RFIDRC522_80" rel="nofollow">
          RFID-RC522
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#RFID_82" rel="nofollow">
            RFID射频模块电路原理图
           </a>
          </li>
         </ul>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_85" rel="nofollow">
        使用图+效果图
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#0_RC522_Handle_86" rel="nofollow">
          测试程序0 RC522_Handle()
         </a>
        </li>
        <li>
         <ul>
          <li>
           <a href="#_87" rel="nofollow">
            最终效果
           </a>
          </li>
          <li>
           <a href="#NFC_Writer_90" rel="nofollow">
            一、先用手机软件NFC Writer读取空卡看看内容
           </a>
          </li>
          <li>
           <ul>
            <li>
             <a href="#1NFCps10_91" rel="nofollow">
              1、打开软件和NFC（ps：我的手机是小米10）
             </a>
            </li>
            <li>
             <a href="#2_93" rel="nofollow">
              2、将空卡贴于手机背部，弹出提示发现新卡，点击“好的”
             </a>
            </li>
            <li>
             <a href="#31_95" rel="nofollow">
              3、上面的新卡片左滑到新卡片1，单击这个卡片
             </a>
            </li>
            <li>
             <a href="#4_97" rel="nofollow">
              4、进入卡片信息详细页面
             </a>
            </li>
            <li>
             <ul>
              <li>
               <a href="#_98" rel="nofollow">
                钥匙扣卡
               </a>
              </li>
              <li>
               <a href="#M1_100" rel="nofollow">
                M1空白卡
               </a>
              </li>
             </ul>
            </li>
           </ul>
          </li>
          <li>
           <a href="#_105" rel="nofollow">
            二、编译、烧写程序
           </a>
          </li>
          <li>
           <a href="#_107" rel="nofollow">
            三、将钥匙扣卡发在模块上，打开串口，开始测试
           </a>
          </li>
         </ul>
        </li>
        <li>
         <a href="#1_RC522_Handle1_125" rel="nofollow">
          测试程序1 RC522_Handle1()
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_139" rel="nofollow">
        核心代码
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#mainc_142" rel="nofollow">
          main.c
         </a>
        </li>
        <li>
         <a href="#rc522h_186" rel="nofollow">
          rc522.h
         </a>
        </li>
        <li>
         <a href="#rc522c_375" rel="nofollow">
          rc522.c
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_1688" rel="nofollow">
        额外资料
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <h2>
     <a id="_1">
     </a>
     前言
    </h2>
    <h3>
     <a id="_2">
     </a>
     特别声明:
    </h3>
    <ul>
     <li>
      <p>
       本仓库发布的程序，仅用于测试和学习研究，禁止用于商业用途，不能保证其合法性，准确性，完整性和有效性，请根据情况自行判断。
      </p>
     </li>
     <li>
      <p>
       本人对任何脚本问题概不负责，包括但不限于由任何脚本错误导致的任何损失或损害。
      </p>
     </li>
     <li>
      <p>
       间接使用脚本的任何用户，包括但不限于建立VPS或在某些行为违反国家/地区法律或相关法规的情况下进行传播, 本人对于由此引起的任何隐私泄漏或其他后果概不负责。
      </p>
     </li>
     <li>
      <p>
       任何以任何方式查看此项目的人或直接或间接使用该项目的任何程序的使用者都应仔细阅读此声明。本人保留随时更改或补充此免责声明的权利。一旦使用并复制了任何相关脚本或Script项目的规则，则视为您已接受此免责声明。
      </p>
     </li>
    </ul>
    <p>
     本文不含任何广告性质，仅供学习参考。
     <strong>
      写卡
     </strong>
     需谨慎！！！，不然可能会玩崩了。血的教训！！！
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/baf83dd0b0802e46590a8759fa3ffd4b.png"/>
    </p>
    <p>
     参考资料：
     <br/>
     <a href="https://blog.csdn.net/hiwoshixiaoyu/article/details/104048663">
      浅谈IC卡数据分析
     </a>
     <br/>
     <a href="https://blog.csdn.net/wowocpp/article/details/79910800">
      智能卡 ISO14443 协议 解读
     </a>
     <br/>
     <a href="https://blog.csdn.net/qq_28877125/article/details/80437095">
      STM32F103ZET–RFID-RC522使用例程(战舰版)
     </a>
     <br/>
     <a href="https://wenku.baidu.com/view/50f8bff17c1cfad6195fa712.html" rel="nofollow">
      M1卡使用说明书
     </a>
     <br/>
     <a href="https://www.cnblogs.com/ivantang/p/3904025.html" rel="nofollow">
      M1卡介绍
     </a>
     <br/>
     <a href="http://www.pudn.com/Download/item/id/2857485.html" rel="nofollow">
      STM32-RC522
     </a>
     <br/>
     <a href="https://www.docin.com/p-379085837.html" rel="nofollow">
      Mifare1技术说明(M1卡说明文档)
     </a>
     <br/>
     源码参考：
     <a href="http://www.pudn.com/Download/item/id/3930282.html" rel="nofollow">
      RFID-RC522
     </a>
     ，不能使用，我进行了一定的修改。下载参考下方传送门。
     <br/>
     开发板：正点原子 STM32F103 精英版
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/7931b0722b72c52e78288e77a27adec2.png">
      <br/>
      语言：C语言
      <br/>
      开发环境：Keil5
      <br/>
      <strong>
       开发板
      </strong>
      使用了 LED SPI USART RFID-RC522模块 钥匙扣卡 M1卡
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/17233354db29da48b67419584266c2fd.jpeg">
       <br/>
       <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/de608c0624819b727133738bec9f8c34.jpeg">
        <br/>
        <strong>
         Win10软件
        </strong>
        SSCOM串口调试 FlyMcu烧录（ps:电脑安装驱动CH340）
        <br/>
        <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/fc32c1c62d8327489892272c04e15035.png">
         <br/>
         <strong>
          安卓软件
         </strong>
         NFC Writer （手机需有NFC功能）
         <br/>
         <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c04a0b33f18729446ec2a38c51780e6e.jpeg"/>
        </img>
       </img>
      </img>
     </img>
    </p>
    <h3>
     <a id="_36">
     </a>
     代码下载：
    </h3>
    <p>
     ⭐⭐⭐⭐⭐⭐⭐⭐⭐
     <br/>
     ⭐⭐
     <a href="https://gitee.com/ikaros-521/STM32_RFID-RC522_ReadWrite_card_demo" rel="nofollow">
      码云
     </a>
     |
     <a href="https://github.com/Ikaros-521/STM32_RFID-RC522_ReadWrite_card_demo">
      GitHub
     </a>
     ⭐⭐
     <br/>
     ⭐⭐⭐⭐⭐⭐⭐⭐⭐
    </p>
    <h3>
     <a id="_40">
     </a>
     功能介绍：
    </h3>
    <p>
     寻卡-》防冲撞-》选卡-》验证2扇区密钥-》读取2扇区0区块数据-》写入数据到2扇区0区块-》再读取2扇区0区块数据。
     <br/>
     串口打印卡UID，验证结果，读取到的2扇区0区块数据等信息。
     <br/>
     <strong>
      注意
     </strong>
     ：只有验证成功的扇区，才能对此扇区进行读写操作！
    </p>
    <pre><code class="prism language-c"><span class="token comment">// 验证A密钥 块地址 密码 SN </span>
<span class="token comment">// 注意：此处的块地址0x0B即2扇区3区块，此块地址只需要指向某一扇区就可以了，</span>
<span class="token comment">// 即2扇区为0x08-0x0B这个范围都有效，且只能对验证过的扇区进行读写操作</span>
status <span class="token operator">=</span> <span class="token function">PcdAuthState</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token number">0x0B</span><span class="token punctuation">,</span> KEY_A<span class="token punctuation">,</span> SN<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 读取M1卡一块数据 块地址 读取的数据</span>
<span class="token comment">// 注意：因为上面验证的扇区是2扇区，所以只能对2扇区的数据进行读写，即0x08-0x0B这个范围，</span>
<span class="token comment">// 超出范围读取失败。</span>
status <span class="token operator">=</span> <span class="token function">PcdRead</span><span class="token punctuation">(</span><span class="token number">0x08</span><span class="token punctuation">,</span> DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     另外：3区块的密钥A单片机读取出来是全00，手机是全ff
     <br/>
     控制字的默认值是“FF078069”，此时
     <br/>
     A密钥：不可被读出，有全部权限
     <br/>
     B密钥：可被读出，没有任何权限
     <br/>
     下图参考：
     <a href="https://blog.csdn.net/hiwoshixiaoyu/article/details/104048663">
      https://blog.csdn.net/hiwoshixiaoyu/article/details/104048663
     </a>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/dab8fbb0dfd2ea1e8092050cd28d7da9.png"/>
    </p>
    <h2>
     <a id="_61">
     </a>
     接线
    </h2>
    <pre><code class="prism language-javascript"><span class="token number">1</span><span class="token operator">--</span><span class="token constant">SDA</span>  <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">PA4</span>
<span class="token number">2</span><span class="token operator">--</span><span class="token constant">SCK</span>  <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">PA5</span>
<span class="token number">3</span><span class="token operator">--</span><span class="token constant">MOSI</span> <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">PA7</span>
<span class="token number">4</span><span class="token operator">--</span><span class="token constant">MISO</span> <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">PA6</span>
<span class="token number">5</span><span class="token operator">--</span>悬空
<span class="token number">6</span><span class="token operator">--</span><span class="token constant">GND</span> <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">GND</span>
<span class="token number">7</span><span class="token operator">--</span><span class="token constant">RST</span> <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">PB0</span>
<span class="token number">8</span><span class="token operator">--</span><span class="token constant">VCC</span> <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token constant">VCC</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5977c8eb0b146ba09f556db34f8f5972.png"/>
    </p>
    <h3>
     <a id="STM32_74">
     </a>
     STM32
    </h3>
    <h4>
     <a id="STM32F1_V12_75">
     </a>
     STM32F1开发指南(精英版)-库函数版本_V1.2
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/4275a55cadeb97b94371fca19d9ec9de.png"/>
    </p>
    <h4>
     <a id="STM32_77">
     </a>
     STM32中文参考手册
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0d6f44624f4d02987a75ca0beba9d499.png">
      <br/>
      <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/4ee38d89d8ceb11983497c4af1645670.png"/>
     </img>
    </p>
    <h3>
     <a id="RFIDRC522_80">
     </a>
     RFID-RC522
    </h3>
    <p>
     参考：
     <a href="https://www.cirmall.com/circuit/2149/" rel="nofollow">
      https://www.cirmall.com/circuit/2149/
     </a>
    </p>
    <h4>
     <a id="RFID_82">
     </a>
     RFID射频模块电路原理图
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/c90d376d18bff7bde59a547ac3e0f30f.png"/>
    </p>
    <h2>
     <a id="_85">
     </a>
     使用图+效果图
    </h2>
    <h3>
     <a id="0_RC522_Handle_86">
     </a>
     测试程序0 RC522_Handle()
    </h3>
    <h4>
     <a id="_87">
     </a>
     最终效果
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/81bbccec66213b6f4430bb88e5a42645.gif#pic_center"/>
    </p>
    <h4>
     <a id="NFC_Writer_90">
     </a>
     一、先用手机软件NFC Writer读取空卡看看内容
    </h4>
    <h5>
     <a id="1NFCps10_91">
     </a>
     1、打开软件和NFC（ps：我的手机是小米10）
    </h5>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/e3ac73cce812c7633b5e3ad24fea7d91.jpeg"/>
    </p>
    <h5>
     <a id="2_93">
     </a>
     2、将空卡贴于手机背部，弹出提示发现新卡，点击“好的”
    </h5>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/9093ccbb212ed821aaa1a6d1de361dc3.jpeg"/>
    </p>
    <h5>
     <a id="31_95">
     </a>
     3、上面的新卡片左滑到新卡片1，单击这个卡片
    </h5>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/25cb921f2dcef4488dd5ac59f0037cb8.jpeg"/>
    </p>
    <h5>
     <a id="4_97">
     </a>
     4、进入卡片信息详细页面
    </h5>
    <h6>
     <a id="_98">
     </a>
     钥匙扣卡
    </h6>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0695d51fa1674e0f74e654b2abd95554.jpeg"/>
    </p>
    <h6>
     <a id="M1_100">
     </a>
     M1空白卡
    </h6>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/26f74f0fd828867c5675c8ffdb57790e.jpeg"/>
     <br/>
     可以发现2张卡除了卡号和卡号异或值不同外，其他数据都一样，之后的例子都以
     <strong>
      钥匙扣卡
     </strong>
     举例。
     <br/>
     下图参考：
     <a href="https://blog.csdn.net/hiwoshixiaoyu/article/details/104048663">
      https://blog.csdn.net/hiwoshixiaoyu/article/details/104048663
     </a>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/30461d89e97c974bd86d3604312573ce.png"/>
    </p>
    <h4>
     <a id="_105">
     </a>
     二、编译、烧写程序
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/dbb9f25bb435a37ed11ade126d473618.png"/>
    </p>
    <h4>
     <a id="_107">
     </a>
     三、将钥匙扣卡发在模块上，打开串口，开始测试
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3a6605e200e5ba550f7f92b1d359d283.jpeg"/>
     <br/>
     串口打印
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/41fb3279c91f5664dff6b38b3d6cf03c.png"/>
     <br/>
     注意 原卡 2扇区0区块数据为
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/53f90388f874c8579a00da7d76077def.png"/>
     <br/>
     我们放上卡后，进行了数据写入，之后读取到的数据都为DATA1的数据0.0
    </p>
    <pre><code class="prism language-c"><span class="token keyword">unsigned</span> <span class="token keyword">char</span> DATA1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x12</span><span class="token punctuation">,</span><span class="token number">0x34</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token number">0x9A</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 0x08 就是2扇区0区块（即第9块）</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> addr<span class="token operator">=</span><span class="token number">0x08</span><span class="token punctuation">;</span>
status <span class="token operator">=</span> <span class="token function">PcdWrite</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> DATA1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/037bbfb27b3a6a9185a7c250d142643b.png"/>
     <br/>
     此时数据写入完毕后，我们再将钥匙扣卡贴于手机，看看现在手机读取出来的结果
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/eb50dc02856108bb3dbe57ad2833ea09.png"/>
     <br/>
     OK，看样子写入成功了，那么到此例程就结束了。
    </p>
    <h3>
     <a id="1_RC522_Handle1_125">
     </a>
     测试程序1 RC522_Handle1()
    </h3>
    <p>
     测试程序1，完成0x0F块 验证KEY_A、KEY_B 读 写RFID1 验证KEY_A1、KEY_B1 读 写RFID2
    </p>
    <pre><code class="prism language-c"><span class="token comment">// 测试用 3区块数据</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> RFID1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0x06</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> RFID2<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 测试用 3区块密钥</span>
u8 KEY_A1<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
u8 KEY_B1<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0x06</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/a6d5f4f500f2afcbca9e433e1e1f2d23.png"/>
    </p>
    <h2>
     <a id="_139">
     </a>
     核心代码
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/333a74c6d099587c1fb223ee9141b5fd.png"/>
    </p>
    <h3>
     <a id="mainc_142">
     </a>
     main.c
    </h3>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rc522.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>

<span class="token comment">/**
*   连线说明：
*   1--SDA  &lt;-----&gt;PA4
*   2--SCK  &lt;-----&gt;PA5
*   3--MOSI &lt;-----&gt;PA7
*   4--MISO &lt;-----&gt;PA6
*   5--悬空
*   6--GND &lt;-----&gt;GND
*   7--RST &lt;-----&gt;PB0
*   8--VCC &lt;-----&gt;VCC
**/</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">delay_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	    	 <span class="token comment">//延时函数初始化</span>
    <span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置中断优先级分组为组2：2位抢占优先级，2位响应优先级</span>
    <span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 	<span class="token comment">//串口初始化为115200</span>
    <span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RC522_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">//初始化射频卡模块</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 重要提醒，写卡操作有风险，请勿随意尝试，不能保证程序安全性，本人对任何程序问题概不负责，不限于由任何程序错误导致的任何损失或损害</span>
		<span class="token comment">// 测试程序0，完成addr读写读</span>
        <span class="token function">RC522_Handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// 谨慎使用 测试程序1，完成0x0F块 验证KEY_A、KEY_B 读 写RFID1 验证KEY_A1、KEY_B1 读 写RFID2</span>
		<span class="token comment">// RC522_Handle1();</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>num <span class="token operator">%</span> <span class="token number">20</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            LED0 <span class="token operator">=</span> <span class="token operator">!</span>LED0<span class="token punctuation">;</span>
        num<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre>
    <h3>
     <a id="rc522h_186">
     </a>
     rc522.h
    </h3>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__RC522_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__RC522_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"stm32f10x.h"</span></span>

<span class="token comment">/</span>
<span class="token comment">//MF522命令字</span>
<span class="token comment">/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PCD_IDLE</span>              <span class="token expression"><span class="token number">0x00</span>               </span><span class="token comment">//取消当前命令</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PCD_AUTHENT</span>           <span class="token expression"><span class="token number">0x0E</span>               </span><span class="token comment">//验证密钥</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PCD_RECEIVE</span>           <span class="token expression"><span class="token number">0x08</span>               </span><span class="token comment">//接收数据</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PCD_TRANSMIT</span>          <span class="token expression"><span class="token number">0x04</span>               </span><span class="token comment">//发送数据</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PCD_TRANSCEIVE</span>        <span class="token expression"><span class="token number">0x0C</span>               </span><span class="token comment">//发送并接收数据</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PCD_RESETPHASE</span>        <span class="token expression"><span class="token number">0x0F</span>               </span><span class="token comment">//复位</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PCD_CALCCRC</span>           <span class="token expression"><span class="token number">0x03</span>               </span><span class="token comment">//CRC计算</span></span>

<span class="token comment">/</span>
<span class="token comment">//Mifare_One卡片命令字</span>
<span class="token comment">/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PICC_REQIDL</span>           <span class="token expression"><span class="token number">0x26</span>               </span><span class="token comment">//寻天线区内未进入休眠状态</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PICC_REQALL</span>           <span class="token expression"><span class="token number">0x52</span>               </span><span class="token comment">//寻天线区内全部卡</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PICC_ANTICOLL1</span>        <span class="token expression"><span class="token number">0x93</span>               </span><span class="token comment">//防冲撞</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PICC_ANTICOLL2</span>        <span class="token expression"><span class="token number">0x95</span>               </span><span class="token comment">//防冲撞</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PICC_AUTHENT1A</span>        <span class="token expression"><span class="token number">0x60</span>               </span><span class="token comment">//验证A密钥</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PICC_AUTHENT1B</span>        <span class="token expression"><span class="token number">0x61</span>               </span><span class="token comment">//验证B密钥</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PICC_READ</span>             <span class="token expression"><span class="token number">0x30</span>               </span><span class="token comment">//读块</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PICC_WRITE</span>            <span class="token expression"><span class="token number">0xA0</span>               </span><span class="token comment">//写块</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PICC_DECREMENT</span>        <span class="token expression"><span class="token number">0xC0</span>               </span><span class="token comment">//扣款</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PICC_INCREMENT</span>        <span class="token expression"><span class="token number">0xC1</span>               </span><span class="token comment">//充值</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PICC_RESTORE</span>          <span class="token expression"><span class="token number">0xC2</span>               </span><span class="token comment">//调块数据到缓冲区</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PICC_TRANSFER</span>         <span class="token expression"><span class="token number">0xB0</span>               </span><span class="token comment">//保存缓冲区中数据</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PICC_HALT</span>             <span class="token expression"><span class="token number">0x50</span>               </span><span class="token comment">//休眠</span></span>

<span class="token comment">/</span>
<span class="token comment">//MF522 FIFO长度定义</span>
<span class="token comment">/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DEF_FIFO_LENGTH</span>       <span class="token expression"><span class="token number">64</span>                 </span><span class="token comment">//FIFO size=64byte</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MAXRLEN</span>  <span class="token expression"><span class="token number">18</span></span></span>

<span class="token comment">/</span>
<span class="token comment">//MF522寄存器定义</span>
<span class="token comment">/</span>
<span class="token comment">// PAGE 0</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFU00</span>                 <span class="token expression"><span class="token number">0x00</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">CommandReg</span>            <span class="token expression"><span class="token number">0x01</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">ComIEnReg</span>             <span class="token expression"><span class="token number">0x02</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">DivlEnReg</span>             <span class="token expression"><span class="token number">0x03</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">ComIrqReg</span>             <span class="token expression"><span class="token number">0x04</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">DivIrqReg</span>             <span class="token expression"><span class="token number">0x05</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">ErrorReg</span>              <span class="token expression"><span class="token number">0x06</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">Status1Reg</span>            <span class="token expression"><span class="token number">0x07</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">Status2Reg</span>            <span class="token expression"><span class="token number">0x08</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">FIFODataReg</span>           <span class="token expression"><span class="token number">0x09</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">FIFOLevelReg</span>          <span class="token expression"><span class="token number">0x0A</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">WaterLevelReg</span>         <span class="token expression"><span class="token number">0x0B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">ControlReg</span>            <span class="token expression"><span class="token number">0x0C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">BitFramingReg</span>         <span class="token expression"><span class="token number">0x0D</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">CollReg</span>               <span class="token expression"><span class="token number">0x0E</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFU0F</span>                 <span class="token expression"><span class="token number">0x0F</span></span></span>
<span class="token comment">// PAGE 1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFU10</span>                 <span class="token expression"><span class="token number">0x10</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">ModeReg</span>               <span class="token expression"><span class="token number">0x11</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TxModeReg</span>             <span class="token expression"><span class="token number">0x12</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RxModeReg</span>             <span class="token expression"><span class="token number">0x13</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TxControlReg</span>          <span class="token expression"><span class="token number">0x14</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TxAutoReg</span>             <span class="token expression"><span class="token number">0x15</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TxSelReg</span>              <span class="token expression"><span class="token number">0x16</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RxSelReg</span>              <span class="token expression"><span class="token number">0x17</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RxThresholdReg</span>        <span class="token expression"><span class="token number">0x18</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">DemodReg</span>              <span class="token expression"><span class="token number">0x19</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFU1A</span>                 <span class="token expression"><span class="token number">0x1A</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFU1B</span>                 <span class="token expression"><span class="token number">0x1B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">MifareReg</span>             <span class="token expression"><span class="token number">0x1C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFU1D</span>                 <span class="token expression"><span class="token number">0x1D</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFU1E</span>                 <span class="token expression"><span class="token number">0x1E</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">SerialSpeedReg</span>        <span class="token expression"><span class="token number">0x1F</span></span></span>
<span class="token comment">// PAGE 2</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFU20</span>                 <span class="token expression"><span class="token number">0x20</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">CRCResultRegM</span>         <span class="token expression"><span class="token number">0x21</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">CRCResultRegL</span>         <span class="token expression"><span class="token number">0x22</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFU23</span>                 <span class="token expression"><span class="token number">0x23</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">ModWidthReg</span>           <span class="token expression"><span class="token number">0x24</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFU25</span>                 <span class="token expression"><span class="token number">0x25</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFCfgReg</span>              <span class="token expression"><span class="token number">0x26</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">GsNReg</span>                <span class="token expression"><span class="token number">0x27</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">CWGsCfgReg</span>            <span class="token expression"><span class="token number">0x28</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">ModGsCfgReg</span>           <span class="token expression"><span class="token number">0x29</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TModeReg</span>              <span class="token expression"><span class="token number">0x2A</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TPrescalerReg</span>         <span class="token expression"><span class="token number">0x2B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TReloadRegH</span>           <span class="token expression"><span class="token number">0x2C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TReloadRegL</span>           <span class="token expression"><span class="token number">0x2D</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TCounterValueRegH</span>     <span class="token expression"><span class="token number">0x2E</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TCounterValueRegL</span>     <span class="token expression"><span class="token number">0x2F</span></span></span>
<span class="token comment">// PAGE 3</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFU30</span>                 <span class="token expression"><span class="token number">0x30</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TestSel1Reg</span>           <span class="token expression"><span class="token number">0x31</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TestSel2Reg</span>           <span class="token expression"><span class="token number">0x32</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TestPinEnReg</span>          <span class="token expression"><span class="token number">0x33</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TestPinValueReg</span>       <span class="token expression"><span class="token number">0x34</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TestBusReg</span>            <span class="token expression"><span class="token number">0x35</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">AutoTestReg</span>           <span class="token expression"><span class="token number">0x36</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">VersionReg</span>            <span class="token expression"><span class="token number">0x37</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">AnalogTestReg</span>         <span class="token expression"><span class="token number">0x38</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TestDAC1Reg</span>           <span class="token expression"><span class="token number">0x39</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TestDAC2Reg</span>           <span class="token expression"><span class="token number">0x3A</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">TestADCReg</span>            <span class="token expression"><span class="token number">0x3B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFU3C</span>                 <span class="token expression"><span class="token number">0x3C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFU3D</span>                 <span class="token expression"><span class="token number">0x3D</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFU3E</span>                 <span class="token expression"><span class="token number">0x3E</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>     <span class="token macro-name">RFU3F</span>		  		        <span class="token expression"><span class="token number">0x3F</span></span></span>

<span class="token comment">/</span>
<span class="token comment">//和MF522通讯时返回的错误代码</span>
<span class="token comment">/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> 	<span class="token macro-name">MI_OK</span>                 <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> 	<span class="token macro-name">MI_NOTAGERR</span>           <span class="token expression"><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> 	<span class="token macro-name">MI_ERR</span>                <span class="token expression"><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">SHAQU1</span>	<span class="token expression"><span class="token number">0X01</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">KUAI4</span>	<span class="token expression"><span class="token number">0X04</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">KUAI7</span>	<span class="token expression"><span class="token number">0X07</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">REGCARD</span>	<span class="token expression"><span class="token number">0xa1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">CONSUME</span>	<span class="token expression"><span class="token number">0xa2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">READCARD</span>	<span class="token expression"><span class="token number">0xa3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ADDMONEY</span>	<span class="token expression"><span class="token number">0xa4</span></span></span>

<span class="token comment">//</span>
<span class="token comment">//#define  spi_cs 1;</span>
<span class="token comment">//sbit  spi_ck=P0^6;</span>
<span class="token comment">//sbit  spi_mosi=P0^7;</span>
<span class="token comment">//sbit  spi_miso=P4^1;</span>
<span class="token comment">//sbit  spi_rst=P2^7;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">SPIReadByte</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>	<span class="token function">SPIWriteByte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span></span></span>
u8 <span class="token function">SPIWriteByte</span><span class="token punctuation">(</span>u8 byte<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">SPI1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//void SPI2_Init(void);</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SET_SPI_CS</span>  <span class="token expression"><span class="token punctuation">(</span>GPIOF<span class="token operator">-&gt;</span>BSRR<span class="token operator">=</span><span class="token number">0X01</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CLR_SPI_CS</span>  <span class="token expression"><span class="token punctuation">(</span>GPIOF<span class="token operator">-&gt;</span>BRR<span class="token operator">=</span><span class="token number">0X01</span><span class="token punctuation">)</span></span></span>



<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SET_RC522RST</span>  <span class="token expression">GPIOF<span class="token operator">-&gt;</span>BSRR<span class="token operator">=</span><span class="token number">0X02</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CLR_RC522RST</span>  <span class="token expression">GPIOF<span class="token operator">-&gt;</span>BRR<span class="token operator">=</span><span class="token number">0X02</span></span></span>


<span class="token comment">/***********************RC522 函数宏定义**********************/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>          <span class="token macro-name function">RC522_CS_Enable</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token function">GPIO_ResetBits</span> <span class="token punctuation">(</span> GPIOA<span class="token punctuation">,</span> GPIO_Pin_4 <span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>          <span class="token macro-name function">RC522_CS_Disable</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token function">GPIO_SetBits</span> <span class="token punctuation">(</span> GPIOA<span class="token punctuation">,</span> GPIO_Pin_4 <span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>          <span class="token macro-name function">RC522_Reset_Enable</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span> GPIOB<span class="token punctuation">,</span> GPIO_Pin_0 <span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>          <span class="token macro-name function">RC522_Reset_Disable</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>     <span class="token function">GPIO_SetBits</span> <span class="token punctuation">(</span> GPIOB<span class="token punctuation">,</span> GPIO_Pin_0 <span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>          <span class="token macro-name function">RC522_SCK_0</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>             <span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span> GPIOA<span class="token punctuation">,</span> GPIO_Pin_5 <span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>          <span class="token macro-name function">RC522_SCK_1</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>             <span class="token function">GPIO_SetBits</span> <span class="token punctuation">(</span> GPIOA<span class="token punctuation">,</span> GPIO_Pin_5 <span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>          <span class="token macro-name function">RC522_MOSI_0</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token function">GPIO_ResetBits</span><span class="token punctuation">(</span> GPIOA<span class="token punctuation">,</span> GPIO_Pin_7 <span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>          <span class="token macro-name function">RC522_MOSI_1</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token function">GPIO_SetBits</span> <span class="token punctuation">(</span> GPIOA<span class="token punctuation">,</span> GPIO_Pin_7 <span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>          <span class="token macro-name function">RC522_MISO_GET</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>          <span class="token function">GPIO_ReadInputDataBit</span> <span class="token punctuation">(</span> GPIOA<span class="token punctuation">,</span> GPIO_Pin_6 <span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span>             <span class="token function">RC522_Handle</span>               <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">// 测试程序0，完成addr读写读</span>
<span class="token keyword">void</span>             <span class="token function">RC522_Handle1</span>              <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">// 测试程序1，完成0x0F块 验证KEY_A、KEY_B 读 写RFID1 验证KEY_A1、KEY_B1 读 写RFID2</span>
<span class="token keyword">void</span>             <span class="token function">RC522_data_break</span>           <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">// 测试用数据爆破程序，仅供学习参考，请勿非法使用</span>
<span class="token keyword">void</span>             <span class="token function">RC522_Init</span>                 <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">//初始化</span>
<span class="token keyword">void</span>             <span class="token function">PcdReset</span>                   <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>                       <span class="token comment">//复位</span>
<span class="token keyword">void</span>             <span class="token function">M500PcdConfigISOType</span>       <span class="token punctuation">(</span> u8 type <span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//工作方式</span>
<span class="token keyword">char</span>             <span class="token function">PcdRequest</span>                 <span class="token punctuation">(</span> u8 req_code<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pTagType <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//寻卡</span>
<span class="token keyword">char</span>             <span class="token function">PcdAnticoll</span>                <span class="token punctuation">(</span> u8 <span class="token operator">*</span> pSnr<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">//读卡号</span>

<span class="token keyword">char</span>             <span class="token function">PcdSelect</span>                  <span class="token punctuation">(</span> u8 <span class="token operator">*</span> pSnr <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span>             <span class="token function">PcdAuthState</span>               <span class="token punctuation">(</span> u8 ucAuth_mode<span class="token punctuation">,</span> u8 ucAddr<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pKey<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pSnr <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span>             <span class="token function">PcdWrite</span>                   <span class="token punctuation">(</span> u8 ucAddr<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pData <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">char</span>             <span class="token function">PcdRead</span>                    <span class="token punctuation">(</span> u8 ucAddr<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pData <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">ShowID</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>	 <span class="token comment">//显示卡的卡号，以十六进制显示</span>

<span class="token keyword">extern</span> <span class="token keyword">char</span><span class="token operator">*</span> POINT_LNG<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">char</span><span class="token operator">*</span> POINT_LAT<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">char</span><span class="token operator">*</span> POINT_LNG_ON<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">char</span><span class="token operator">*</span> POINT_LAT_ON<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">char</span><span class="token operator">*</span> POINT_LNG_OFF<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">char</span><span class="token operator">*</span> POINT_LAT_OFF<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

</code></pre>
    <h3>
     <a id="rc522c_375">
     </a>
     rc522.c
    </h3>
    <pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rc522.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"string.h"</span></span>

<span class="token comment">//</span>
<span class="token comment">// M1卡分为16个扇区，每个扇区由四个块（块0、块1、块2、块3）组成</span>
<span class="token comment">// 将16个扇区的64个块按绝对地址编号为：0~63</span>
<span class="token comment">// 第0个扇区的块0（即绝对地址0块），用于存放厂商代码，已经固化不可更改</span>
<span class="token comment">// 每个扇区的块0、块1、块2为数据块，可用于存放数据</span>
<span class="token comment">// 每个扇区的块3为控制块（绝对地址为:块3、块7、块11.....）包括密码A，存取控制、密码B等</span>

<span class="token comment">/*******************************
*连线说明：
*1--SDA  &lt;-----&gt;PA4
*2--SCK  &lt;-----&gt;PA5
*3--MOSI &lt;-----&gt;PA7
*4--MISO &lt;-----&gt;PA6
*5--悬空
*6--GND &lt;-----&gt;GND
*7--RST &lt;-----&gt;PB0
*8--VCC &lt;-----&gt;VCC
************************************/</span>

<span class="token comment">/*全局变量*/</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> CT<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//卡类型</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> SN<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//卡号</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> DATA<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>			<span class="token comment">//存放数据</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> RFID<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>			<span class="token comment">//存放RFID</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card0_bit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card1_bit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card2_bit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card3_bit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card4_bit<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> total<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// 这UID定义在这不知道干啥用的。。。 替换成自己卡的UID</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card_0<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">73</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">152</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card_1<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">105</span><span class="token punctuation">,</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">152</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card_2<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">208</span><span class="token punctuation">,</span><span class="token number">121</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">57</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card_3<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">176</span><span class="token punctuation">,</span><span class="token number">177</span><span class="token punctuation">,</span><span class="token number">143</span><span class="token punctuation">,</span><span class="token number">165</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> card_4<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">158</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">136</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
u8 KEY_A<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
u8 KEY_B<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
u8 AUDIO_OPEN<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0xAA</span><span class="token punctuation">,</span> <span class="token number">0x07</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x09</span><span class="token punctuation">,</span> <span class="token number">0xBC</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 测试用 3区块数据</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> RFID1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0x06</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> RFID2<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 测试用 3区块密钥</span>
u8 KEY_A1<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x50</span><span class="token punctuation">,</span><span class="token number">0x60</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
u8 KEY_A2<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
u8 KEY_B1<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x05</span><span class="token punctuation">,</span><span class="token number">0x06</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
u8 KEY_B2<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x30</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
u8 KEY_B3<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x03</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 置零用</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> DATA0<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> DATA1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0x12</span><span class="token punctuation">,</span><span class="token number">0x34</span><span class="token punctuation">,</span><span class="token number">0x56</span><span class="token punctuation">,</span><span class="token number">0x78</span><span class="token punctuation">,</span><span class="token number">0x9A</span><span class="token punctuation">,</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">,</span><span class="token number">0x29</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">,</span><span class="token number">0xff</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> status<span class="token punctuation">;</span>
<span class="token comment">// 0x08 就是2扇区0区块（即第9块）</span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> addr<span class="token operator">=</span><span class="token number">0x08</span><span class="token punctuation">;</span>
<span class="token comment">// unsigned char addr=0x08;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>   <span class="token macro-name function">RC522_DELAY</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token function">delay_us</span><span class="token punctuation">(</span> <span class="token number">20</span> <span class="token punctuation">)</span></span></span>

<span class="token comment">// 测试程序0，完成addr读写读</span>
<span class="token keyword">void</span> <span class="token function">RC522_Handle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    status <span class="token operator">=</span> <span class="token function">PcdRequest</span><span class="token punctuation">(</span>PICC_REQALL<span class="token punctuation">,</span>CT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//寻卡</span>

    <span class="token comment">// printf("\r\nstatus&gt;&gt;&gt;&gt;&gt;&gt;%d\r\n", status);</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">==</span>MI_OK<span class="token punctuation">)</span><span class="token comment">// 寻卡成功</span>
    <span class="token punctuation">{<!-- --></span>
        status<span class="token operator">=</span>MI_ERR<span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token function">PcdAnticoll</span><span class="token punctuation">(</span>SN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 防冲撞 获得UID 存入SN</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token operator">==</span>MI_OK<span class="token punctuation">)</span><span class="token comment">// 防冲撞成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
        <span class="token function">ShowID</span><span class="token punctuation">(</span>SN<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 串口打印卡的ID号 UID</span>

        <span class="token comment">// 难道就是为了做个判断吗。。。</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>card_0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span>card_0<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span>card_0<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span>card_0<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            card0_bit<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\nThe User is:card_0\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>card_1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span>card_1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span>card_1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span>card_1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            card1_bit<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\nThe User is:card_1\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>card_2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span>card_2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span>card_2<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span>card_2<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            card2_bit<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\nThe User is:card_2\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>card_3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span>card_3<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span>card_3<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span>card_3<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            card3_bit<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\nThe User is:card_3\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>card_4<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span>card_4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span>card_4<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span>card_4<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            card4_bit<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\nThe User is:card_4\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//total = card1_bit+card2_bit+card3_bit+card4_bit+card0_bit;</span>
        status <span class="token operator">=</span> <span class="token function">PcdSelect</span><span class="token punctuation">(</span>SN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//选卡成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
        <span class="token comment">// 验证A密钥 块地址 密码 SN </span>
		<span class="token comment">// 注意：此处的块地址0x0B即2扇区3区块，可以替换成变量addr ，此块地址只需要指向某一扇区就可以了，即2扇区为0x08-0x0B这个范围都有效，且只能对验证过的扇区进行读写操作</span>
        status <span class="token operator">=</span> <span class="token function">PcdAuthState</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token number">0x0B</span><span class="token punctuation">,</span> KEY_A<span class="token punctuation">,</span> SN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//验证成功</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(A) success\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(A) failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 验证B密钥 块地址 密码 SN  块地址0x0B即2扇区3区块，可以替换成变量addr</span>
		status <span class="token operator">=</span> <span class="token function">PcdAuthState</span><span class="token punctuation">(</span><span class="token number">0x61</span><span class="token punctuation">,</span> <span class="token number">0x0B</span><span class="token punctuation">,</span> KEY_B<span class="token punctuation">,</span> SN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//验证成功</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(B) success\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(B) failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//验证成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
        <span class="token comment">// 读取M1卡一块数据 块地址 读取的数据 注意：因为上面验证的扇区是2扇区，所以只能对2扇区的数据进行读写，即0x08-0x0B这个范围，超出范围读取失败。</span>
        status <span class="token operator">=</span> <span class="token function">PcdRead</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//读卡成功</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// printf("RFID:%s\r\n", RFID);</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"DATA:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02x"</span><span class="token punctuation">,</span> DATA<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdRead() failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//读卡成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Write the card after 1 second. Do not move the card!!!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// status = PcdWrite(addr, DATA0);</span>
        <span class="token comment">// 写数据到M1卡一块</span>
        status <span class="token operator">=</span> <span class="token function">PcdWrite</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> DATA1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//写卡成功</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdWrite() success\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdWrite() failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//写卡成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
        <span class="token comment">// 读取M1卡一块数据 块地址 读取的数据</span>
        status <span class="token operator">=</span> <span class="token function">PcdRead</span><span class="token punctuation">(</span>addr<span class="token punctuation">,</span> DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//读卡成功</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// printf("DATA:%s\r\n", DATA);</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"DATA:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02x"</span><span class="token punctuation">,</span> DATA<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdRead() failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//读卡成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"RC522_Handle() run finished after 1 second!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试程序1，完成0x0F块 验证KEY_A、KEY_B 读 写RFID1 验证KEY_A1、KEY_B1 读 写RFID2</span>
<span class="token keyword">void</span> <span class="token function">RC522_Handle1</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> test_addr<span class="token operator">=</span><span class="token number">0x0F</span><span class="token punctuation">;</span>
    status <span class="token operator">=</span> <span class="token function">PcdRequest</span><span class="token punctuation">(</span>PICC_REQALL<span class="token punctuation">,</span>CT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//寻卡</span>

    <span class="token comment">// printf("\r\nstatus&gt;&gt;&gt;&gt;&gt;&gt;%d\r\n", status);</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">==</span>MI_OK<span class="token punctuation">)</span><span class="token comment">// 寻卡成功</span>
    <span class="token punctuation">{<!-- --></span>
        status<span class="token operator">=</span>MI_ERR<span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token function">PcdAnticoll</span><span class="token punctuation">(</span>SN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 防冲撞 获得UID 存入SN</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token operator">==</span>MI_OK<span class="token punctuation">)</span><span class="token comment">// 防冲撞成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
        <span class="token function">ShowID</span><span class="token punctuation">(</span>SN<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 串口打印卡的ID号 UID</span>

        <span class="token comment">// 难道就是为了做个判断吗。。。</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>card_0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span>card_0<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span>card_0<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span>card_0<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            card0_bit<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\nThe User is:card_0\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>card_1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span>card_1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span>card_1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span>card_1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            card1_bit<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\nThe User is:card_1\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        status <span class="token operator">=</span> <span class="token function">PcdSelect</span><span class="token punctuation">(</span>SN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//选卡成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
        <span class="token comment">// 验证A密钥 块地址 密码 SN </span>
		<span class="token comment">// 注意：此处的块地址0x0F即3扇区3区块，此块地址只需要指向某一扇区就可以了，即3扇区为0x0C-0x0F这个范围都有效，且只能对验证过的扇区进行读写操作</span>
        status <span class="token operator">=</span> <span class="token function">PcdAuthState</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> test_addr<span class="token punctuation">,</span> KEY_A<span class="token punctuation">,</span> SN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//验证成功</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(A) success\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(A) failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			status <span class="token operator">=</span> MI_OK<span class="token punctuation">;</span>
			<span class="token keyword">goto</span> P1<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 验证B密钥 块地址 密码 SN </span>
		status <span class="token operator">=</span> <span class="token function">PcdAuthState</span><span class="token punctuation">(</span><span class="token number">0x61</span><span class="token punctuation">,</span> test_addr<span class="token punctuation">,</span> KEY_B<span class="token punctuation">,</span> SN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//验证成功</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(B) success\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(B) failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//验证成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
        <span class="token comment">// 读取M1卡一块数据 块地址 读取的数据 注意：因为上面验证的扇区是3扇区，所以只能对2扇区的数据进行读写，即0x0C-0x0F这个范围，超出范围读取失败。</span>
        status <span class="token operator">=</span> <span class="token function">PcdRead</span><span class="token punctuation">(</span>test_addr<span class="token punctuation">,</span> DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//读卡成功</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// printf("RFID:%s\r\n", RFID);</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"DATA:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02x"</span><span class="token punctuation">,</span> DATA<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdRead() failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//读卡成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
        <span class="token comment">// 写数据到M1卡一块</span>
        status <span class="token operator">=</span> <span class="token function">PcdWrite</span><span class="token punctuation">(</span>test_addr<span class="token punctuation">,</span> RFID1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//写卡成功</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdWrite(RFID1) success\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdWrite(RFID1) failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

P1<span class="token operator">:</span>	
	<span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//写卡成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
        <span class="token comment">// 验证A密钥 块地址 密码 SN </span>
		<span class="token comment">// 注意：此处的块地址0x0F即3扇区3区块，此块地址只需要指向某一扇区就可以了，即3扇区为0x0C-0x0F这个范围都有效，且只能对验证过的扇区进行读写操作</span>
        status <span class="token operator">=</span> <span class="token function">PcdAuthState</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> test_addr<span class="token punctuation">,</span> KEY_A1<span class="token punctuation">,</span> SN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//验证成功</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(A1) success\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(A1) failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token comment">// 验证B密钥 块地址 密码 SN </span>
		status <span class="token operator">=</span> <span class="token function">PcdAuthState</span><span class="token punctuation">(</span><span class="token number">0x61</span><span class="token punctuation">,</span> test_addr<span class="token punctuation">,</span> KEY_B1<span class="token punctuation">,</span> SN<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//验证成功</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(B1) success\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(B1) failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//验证成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
        <span class="token comment">// 读取M1卡一块数据 块地址 读取的数据 注意：因为上面验证的扇区是3扇区，所以只能对2扇区的数据进行读写，即0x0C-0x0F这个范围，超出范围读取失败。</span>
        status <span class="token operator">=</span> <span class="token function">PcdRead</span><span class="token punctuation">(</span>test_addr<span class="token punctuation">,</span> DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//读卡成功</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// printf("RFID:%s\r\n", RFID);</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"DATA:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02x"</span><span class="token punctuation">,</span> DATA<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdRead() failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//读卡成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
        <span class="token comment">// 写数据到M1卡一块</span>
        status <span class="token operator">=</span> <span class="token function">PcdWrite</span><span class="token punctuation">(</span>test_addr<span class="token punctuation">,</span> RFID2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//写卡成功</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdWrite(RFID2) success\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdWrite(RFID2) failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//写卡成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
        <span class="token comment">// 读取M1卡一块数据 块地址 读取的数据</span>
        status <span class="token operator">=</span> <span class="token function">PcdRead</span><span class="token punctuation">(</span>test_addr<span class="token punctuation">,</span> DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//读卡成功</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// printf("DATA:%s\r\n", DATA);</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"DATA:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02x"</span><span class="token punctuation">,</span> DATA<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdRead() failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//读卡成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"RC522_Handle1() run finished after 1 second!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试用数据爆破程序，仅供学习参考，请勿非法使用 针对card_0进行破解</span>
<span class="token keyword">void</span> <span class="token function">RC522_data_break</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 爆破的块地址</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> break_addr <span class="token operator">=</span> <span class="token number">0x0F</span><span class="token punctuation">;</span>
	u8 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token comment">/*
	u8 key_arr[257] = {	0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0A, 0x0B, 0x0C, 0x0D, 0x0E, 0x0F, 
						0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x1A, 0x1B, 0x1C, 0x1D, 0x1E, 0x1F, 
						0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x2A, 0x2B, 0x2C, 0x2D, 0x2E, 0x2F, 
						0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x3A, 0x3B, 0x3C, 0x3D, 0x3E, 0x3F, 
						0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48, 0x49, 0x4A, 0x4B, 0x4C, 0x4D, 0x4E, 0x4F, 
						0x50, 0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58, 0x59, 0x5A, 0x5B, 0x5C, 0x5D, 0x5E, 0x5F, 
						0x60, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66, 0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E, 0x6F, 
						0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76, 0x77, 0x78, 0x79, 0x7A, 0x7B, 0x7C, 0x7D, 0x7E, 0x7F, 
						0x80, 0x81, 0x82, 0x83, 0x84, 0x85, 0x86, 0x87, 0x88, 0x89, 0x8A, 0x8B, 0x8C, 0x8D, 0x8E, 0x8F, 
						0x90, 0x91, 0x92, 0x93, 0x94, 0x95, 0x96, 0x97, 0x98, 0x99, 0x9A, 0x9B, 0x9C, 0x9D, 0x9E, 0x9F, 
						0xA0, 0xA1, 0xA2, 0xA3, 0xA4, 0xA5, 0xA6, 0xA7, 0xA8, 0xA9, 0xAA, 0xAB, 0xAC, 0xAD, 0xAE, 0xAF, 
						0xB0, 0xB1, 0xB2, 0xB3, 0xB4, 0xB5, 0xB6, 0xB7, 0xB8, 0xB9, 0xBA, 0xBB, 0xBC, 0xBD, 0xBE, 0xBF, 
						0xC0, 0xC1, 0xC2, 0xC3, 0xC4, 0xC5, 0xC6, 0xC7, 0xC8, 0xC9, 0xCA, 0xCB, 0xCC, 0xCD, 0xCE, 0xCF, 
						0xD0, 0xD1, 0xD2, 0xD3, 0xD4, 0xD5, 0xD6, 0xD7, 0xD8, 0xD9, 0xDA, 0xDB, 0xDC, 0xDD, 0xDE, 0xDF, 
						0xE0, 0xE1, 0xE2, 0xE3, 0xE4, 0xE5, 0xE6, 0xE7, 0xE8, 0xE9, 0xEA, 0xEB, 0xEC, 0xED, 0xEE, 0xEF, 
						0xF0, 0xF1, 0xF2, 0xF3, 0xF4, 0xF5, 0xF6, 0xF7, 0xF8, 0xF9, 0xFA, 0xFB, 0xFC, 0xFD, 0xFE, 0xFF };
	*/</span>
	u8 break_KEY<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	
    status <span class="token operator">=</span> <span class="token function">PcdRequest</span><span class="token punctuation">(</span>PICC_REQALL<span class="token punctuation">,</span>CT<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//寻卡</span>

    <span class="token comment">// printf("\r\nstatus&gt;&gt;&gt;&gt;&gt;&gt;%d\r\n", status);</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>status<span class="token operator">==</span>MI_OK<span class="token punctuation">)</span><span class="token comment">// 寻卡成功</span>
    <span class="token punctuation">{<!-- --></span>
        status<span class="token operator">=</span>MI_ERR<span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token function">PcdAnticoll</span><span class="token punctuation">(</span>SN<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 防冲撞 获得UID 存入SN</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token operator">==</span>MI_OK<span class="token punctuation">)</span><span class="token comment">// 防冲撞成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
        <span class="token function">ShowID</span><span class="token punctuation">(</span>SN<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 串口打印卡的ID号 UID</span>

        <span class="token comment">// 难道就是为了做个判断吗。。。</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span>card_0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">==</span>card_0<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">==</span>card_0<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>SN<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">==</span>card_0<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            card0_bit<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\nThe User is:card_0\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\nThe User isn't:card_0\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
        
        status <span class="token operator">=</span> <span class="token function">PcdSelect</span><span class="token punctuation">(</span>SN<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//选卡成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
		
		<span class="token comment">// 自由发挥 。。。</span>
		
		<span class="token comment">// 验证A密钥 块地址 密码 SN </span>
		<span class="token comment">// 注意：此处的块地址0x0F即3扇区3区块，此块地址只需要指向某一扇区就可以了，即3扇区为0x0C-0x0F这个范围都有效，且只能对验证过的扇区进行读写操作</span>
		status <span class="token operator">=</span> <span class="token function">PcdAuthState</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">,</span> break_addr<span class="token punctuation">,</span> break_KEY<span class="token punctuation">,</span> SN<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//验证成功</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(A) success\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(A) failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			status <span class="token operator">=</span> MI_OK<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token comment">// 验证B密钥 块地址 密码 SN </span>
		status <span class="token operator">=</span> <span class="token function">PcdAuthState</span><span class="token punctuation">(</span><span class="token number">0x61</span><span class="token punctuation">,</span> break_addr<span class="token punctuation">,</span> break_KEY<span class="token punctuation">,</span> SN<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//验证成功</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(B) success\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdAuthState(B) failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//验证成功</span>
    <span class="token punctuation">{<!-- --></span>
        status <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
        <span class="token comment">// 读取M1卡一块数据 块地址 读取的数据 注意：因为上面验证的扇区是3扇区，所以只能对2扇区的数据进行读写，即0x0C-0x0F这个范围，超出范围读取失败。</span>
        status <span class="token operator">=</span> <span class="token function">PcdRead</span><span class="token punctuation">(</span>break_addr<span class="token punctuation">,</span> DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span><span class="token comment">//读卡成功</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// printf("RFID:%s\r\n", RFID);</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"DATA:"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02x"</span><span class="token punctuation">,</span> DATA<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"PcdRead() failed\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">RC522_Init</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">SPI1_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">RC522_Reset_Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">RC522_CS_Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">PcdReset</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">M500PcdConfigISOType</span> <span class="token punctuation">(</span> <span class="token char">'A'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置工作方式</span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">SPI1_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
    SPI_InitTypeDef  SPI_InitStructure<span class="token punctuation">;</span>
    <span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>	RCC_APB2Periph_GPIOA <span class="token operator">|</span> RCC_APB2Periph_GPIOB<span class="token punctuation">,</span> ENABLE <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//PORTA、B时钟使能</span>
    <span class="token function">RCC_APB1PeriphClockCmd</span><span class="token punctuation">(</span>	RCC_APB2Periph_SPI1<span class="token punctuation">,</span>  ENABLE <span class="token punctuation">)</span><span class="token punctuation">;</span>												<span class="token comment">//SPI1时钟使能</span>

    <span class="token comment">// CS</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_4<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP<span class="token punctuation">;</span> 		 <span class="token comment">//推挽输出</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>		 <span class="token comment">//IO口速度为50MHz</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>					 <span class="token comment">//根据设定参数初始化PF0、PF1</span>

    <span class="token comment">// SCK</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_5<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP<span class="token punctuation">;</span> 		 <span class="token comment">//推挽输出</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>		 <span class="token comment">//IO口速度为50MHz</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// MISO</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_6<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_IN_FLOATING<span class="token punctuation">;</span> 		 <span class="token comment">//推挽输出</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>		 <span class="token comment">//IO口速度为50MHz</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// MOSI</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_7<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP<span class="token punctuation">;</span> 		 <span class="token comment">//推挽输出</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>		 <span class="token comment">//IO口速度为50MHz</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// RST</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_0<span class="token punctuation">;</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP<span class="token punctuation">;</span> 		 <span class="token comment">//推挽输出</span>
    GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span>		 <span class="token comment">//IO口速度为50MHz</span>
    <span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

    SPI_InitStructure<span class="token punctuation">.</span>SPI_Direction <span class="token operator">=</span> SPI_Direction_2Lines_FullDuplex<span class="token punctuation">;</span>  					<span class="token comment">//设置SPI单向或者双向的数据模式:SPI设置为双线双向全双工</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_Mode <span class="token operator">=</span> SPI_Mode_Master<span class="token punctuation">;</span>																	<span class="token comment">//设置SPI工作模式:设置为主SPI</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_DataSize <span class="token operator">=</span> SPI_DataSize_8b<span class="token punctuation">;</span>															<span class="token comment">//设置SPI的数据大小:SPI发送接收8位帧结构</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CPOL <span class="token operator">=</span> SPI_CPOL_High<span class="token punctuation">;</span>																		<span class="token comment">//串行同步时钟的空闲状态为高电平</span>
    <span class="token comment">// SPI_InitStructure.SPI_CPOL = SPI_CPOL_Low;</span>
    <span class="token comment">// SPI_InitStructure.SPI_CPHA = SPI_CPHA_1Edge;																	//串行同步时钟的第一个跳变沿（下降）数据被采样</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CPHA <span class="token operator">=</span> SPI_CPHA_2Edge<span class="token punctuation">;</span>																		<span class="token comment">//串行同步时钟的第二个跳变沿（上升）数据被采样</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_NSS <span class="token operator">=</span> SPI_NSS_Soft<span class="token punctuation">;</span>																			<span class="token comment">//NSS信号由硬件（NSS管脚）还是软件（使用SSI位）管理:内部NSS信号有SSI位控制</span>
    <span class="token comment">// RC522 SPI通讯时钟周期最小为100ns	即频率最大为10MHZ</span>
    <span class="token comment">// RC522 数据在下降沿变化</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_BaudRatePrescaler <span class="token operator">=</span> SPI_BaudRatePrescaler_256<span class="token punctuation">;</span>					<span class="token comment">//定义波特率预分频的值:波特率预分频值为256、传输速率36M/256=140.625KHz</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_FirstBit <span class="token operator">=</span> SPI_FirstBit_MSB<span class="token punctuation">;</span>														<span class="token comment">//指定数据传输从MSB位还是LSB位开始:数据传输从MSB位开始</span>
    SPI_InitStructure<span class="token punctuation">.</span>SPI_CRCPolynomial <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>																			<span class="token comment">//CRC值计算的多项式</span>
    <span class="token function">SPI_Init</span><span class="token punctuation">(</span>SPI1<span class="token punctuation">,</span> <span class="token operator">&amp;</span>SPI_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span> 						 															<span class="token comment">//根据SPI_InitStruct中指定的参数初始化外设SPIx寄存器</span>

    <span class="token function">SPI_Cmd</span><span class="token punctuation">(</span>SPI1<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//使能SPI外设</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：SPI_RC522_SendByte
 * 描述  ：向RC522发送1 Byte 数据
 * 输入  ：byte，要发送的数据
 * 返回  : RC522返回的数据
 * 调用  ：内部调用
 */</span>
<span class="token keyword">void</span> <span class="token function">SPI_RC522_SendByte</span> <span class="token punctuation">(</span> u8 byte <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 counter<span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span>counter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> counter<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span> counter<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> byte <span class="token operator">&amp;</span> <span class="token number">0x80</span> <span class="token punctuation">)</span>
            <span class="token function">RC522_MOSI_1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span>
            <span class="token function">RC522_MOSI_0</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">RC522_DELAY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">RC522_SCK_0</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">RC522_DELAY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">RC522_SCK_1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">RC522_DELAY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        byte <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：SPI_RC522_ReadByte
 * 描述  ：从RC522发送1 Byte 数据
 * 输入  ：无
 * 返回  : RC522返回的数据
 * 调用  ：内部调用
 */</span>
u8 <span class="token function">SPI_RC522_ReadByte</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 counter<span class="token punctuation">;</span>
    u8 SPI_Data<span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span>counter<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> counter<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span> counter<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        SPI_Data <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token function">RC522_SCK_0</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">RC522_DELAY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">RC522_MISO_GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
            SPI_Data <span class="token operator">|=</span> <span class="token number">0x01</span><span class="token punctuation">;</span>

        <span class="token function">RC522_DELAY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">RC522_SCK_1</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">RC522_DELAY</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">//	printf("****%c****",SPI_Data);</span>
    <span class="token keyword">return</span> SPI_Data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：ReadRawRC
 * 描述  ：读RC522寄存器
 * 输入  ：ucAddress，寄存器地址
 * 返回  : 寄存器的当前值
 * 调用  ：内部调用
 */</span>
u8 <span class="token function">ReadRawRC</span> <span class="token punctuation">(</span> u8 ucAddress <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 ucAddr<span class="token punctuation">,</span> ucReturn<span class="token punctuation">;</span>

    ucAddr <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> ucAddress <span class="token operator">&lt;&lt;</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x7E</span> <span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x80</span><span class="token punctuation">;</span>

    <span class="token function">RC522_CS_Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_RC522_SendByte</span> <span class="token punctuation">(</span> ucAddr <span class="token punctuation">)</span><span class="token punctuation">;</span>

    ucReturn <span class="token operator">=</span> <span class="token function">SPI_RC522_ReadByte</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">RC522_CS_Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> ucReturn<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：WriteRawRC
 * 描述  ：写RC522寄存器
 * 输入  ：ucAddress，寄存器地址
 *         ucValue，写入寄存器的值
 * 返回  : 无
 * 调用  ：内部调用
 */</span>
<span class="token keyword">void</span> <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> u8 ucAddress<span class="token punctuation">,</span> u8 ucValue <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 ucAddr<span class="token punctuation">;</span>

    ucAddr <span class="token operator">=</span> <span class="token punctuation">(</span> ucAddress <span class="token operator">&lt;&lt;</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x7E</span><span class="token punctuation">;</span>

    <span class="token function">RC522_CS_Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_RC522_SendByte</span> <span class="token punctuation">(</span> ucAddr <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SPI_RC522_SendByte</span> <span class="token punctuation">(</span> ucValue <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">RC522_CS_Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：SetBitMask
 * 描述  ：对RC522寄存器置位
 * 输入  ：ucReg，寄存器地址
 *         ucMask，置位值
 * 返回  : 无
 * 调用  ：内部调用
 */</span>
<span class="token keyword">void</span> <span class="token function">SetBitMask</span> <span class="token punctuation">(</span> u8 ucReg<span class="token punctuation">,</span> u8 ucMask <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 ucTemp<span class="token punctuation">;</span>

    ucTemp <span class="token operator">=</span> <span class="token function">ReadRawRC</span> <span class="token punctuation">(</span> ucReg <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> ucReg<span class="token punctuation">,</span> ucTemp <span class="token operator">|</span> ucMask <span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// set bit mask</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：ClearBitMask
 * 描述  ：对RC522寄存器清位
 * 输入  ：ucReg，寄存器地址
 *         ucMask，清位值
 * 返回  : 无
 * 调用  ：内部调用
 */</span>
<span class="token keyword">void</span> <span class="token function">ClearBitMask</span> <span class="token punctuation">(</span> u8 ucReg<span class="token punctuation">,</span> u8 ucMask <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 ucTemp<span class="token punctuation">;</span>

    ucTemp <span class="token operator">=</span> <span class="token function">ReadRawRC</span> <span class="token punctuation">(</span> ucReg <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> ucReg<span class="token punctuation">,</span> ucTemp <span class="token operator">&amp;</span> <span class="token punctuation">(</span> <span class="token operator">~</span> ucMask<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// clear bit mask</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：PcdAntennaOn
 * 描述  ：开启天线
 * 输入  ：无
 * 返回  : 无
 * 调用  ：内部调用
 */</span>
<span class="token keyword">void</span> <span class="token function">PcdAntennaOn</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 uc<span class="token punctuation">;</span>

    uc <span class="token operator">=</span> <span class="token function">ReadRawRC</span> <span class="token punctuation">(</span> TxControlReg <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token punctuation">(</span> uc <span class="token operator">&amp;</span> <span class="token number">0x03</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
        <span class="token function">SetBitMask</span><span class="token punctuation">(</span>TxControlReg<span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：PcdAntennaOff
 * 描述  ：开启天线
 * 输入  ：无
 * 返回  : 无
 * 调用  ：内部调用
 */</span>
<span class="token keyword">void</span> <span class="token function">PcdAntennaOff</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">ClearBitMask</span> <span class="token punctuation">(</span> TxControlReg<span class="token punctuation">,</span> <span class="token number">0x03</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：PcdRese
 * 描述  ：复位RC522
 * 输入  ：无
 * 返回  : 无
 * 调用  ：外部调用
 */</span>
<span class="token keyword">void</span> <span class="token function">PcdReset</span> <span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">RC522_Reset_Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">delay_us</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">RC522_Reset_Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">delay_us</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">RC522_Reset_Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">delay_us</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> CommandReg<span class="token punctuation">,</span> <span class="token number">0x0f</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token function">ReadRawRC</span> <span class="token punctuation">(</span> CommandReg <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x10</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">delay_us</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> ModeReg<span class="token punctuation">,</span> <span class="token number">0x3D</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//定义发送和接收常用模式 和Mifare卡通讯，CRC初始值0x6363</span>

    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> TReloadRegL<span class="token punctuation">,</span> <span class="token number">30</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//16位定时器低位</span>
    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> TReloadRegH<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>			 <span class="token comment">//16位定时器高位</span>

    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> TModeReg<span class="token punctuation">,</span> <span class="token number">0x8D</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>		      <span class="token comment">//定义内部定时器的设置</span>

    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> TPrescalerReg<span class="token punctuation">,</span> <span class="token number">0x3E</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>			 <span class="token comment">//设置定时器分频系数</span>

    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> TxAutoReg<span class="token punctuation">,</span> <span class="token number">0x40</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>				   <span class="token comment">//调制发送信号为100%ASK</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：M500PcdConfigISOType
 * 描述  ：设置RC522的工作方式
 * 输入  ：ucType，工作方式
 * 返回  : 无
 * 调用  ：外部调用
 */</span>
<span class="token keyword">void</span> <span class="token function">M500PcdConfigISOType</span> <span class="token punctuation">(</span> u8 ucType <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> ucType <span class="token operator">==</span> <span class="token char">'A'</span><span class="token punctuation">)</span>                     <span class="token comment">//ISO14443_A</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">ClearBitMask</span> <span class="token punctuation">(</span> Status2Reg<span class="token punctuation">,</span> <span class="token number">0x08</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> ModeReg<span class="token punctuation">,</span> <span class="token number">0x3D</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//3F</span>

        <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> RxSelReg<span class="token punctuation">,</span> <span class="token number">0x86</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//84</span>

        <span class="token function">WriteRawRC</span><span class="token punctuation">(</span> RFCfgReg<span class="token punctuation">,</span> <span class="token number">0x7F</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//4F</span>

        <span class="token function">WriteRawRC</span><span class="token punctuation">(</span> TReloadRegL<span class="token punctuation">,</span> <span class="token number">30</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//tmoLength);// TReloadVal = 'h6a =tmoLength(dec)</span>

        <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> TReloadRegH<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> TModeReg<span class="token punctuation">,</span> <span class="token number">0x8D</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> TPrescalerReg<span class="token punctuation">,</span> <span class="token number">0x3E</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">delay_us</span> <span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">PcdAntennaOn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开天线</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：PcdComMF522
 * 描述  ：通过RC522和ISO14443卡通讯
 * 输入  ：ucCommand，RC522命令字
 *         pInData，通过RC522发送到卡片的数据
 *         ucInLenByte，发送数据的字节长度
 *         pOutData，接收到的卡片返回数据
 *         pOutLenBit，返回数据的位长度
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：内部调用
 */</span>
<span class="token keyword">char</span> <span class="token function">PcdComMF522</span> <span class="token punctuation">(</span> u8 ucCommand<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pInData<span class="token punctuation">,</span> u8 ucInLenByte<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pOutData<span class="token punctuation">,</span> u32 <span class="token operator">*</span> pOutLenBit <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
    u8 ucIrqEn   <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    u8 ucWaitFor <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
    u8 ucLastBits<span class="token punctuation">;</span>
    u8 ucN<span class="token punctuation">;</span>
    u32 ul<span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span> ucCommand <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">case</span> PCD_AUTHENT<span class="token operator">:</span>		<span class="token comment">//Mifare认证</span>
        ucIrqEn   <span class="token operator">=</span> <span class="token number">0x12</span><span class="token punctuation">;</span>		<span class="token comment">//允许错误中断请求ErrIEn  允许空闲中断IdleIEn</span>
        ucWaitFor <span class="token operator">=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>		<span class="token comment">//认证寻卡等待时候 查询空闲中断标志位</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">case</span> PCD_TRANSCEIVE<span class="token operator">:</span>		<span class="token comment">//接收发送 发送接收</span>
        ucIrqEn   <span class="token operator">=</span> <span class="token number">0x77</span><span class="token punctuation">;</span>		<span class="token comment">//允许TxIEn RxIEn IdleIEn LoAlertIEn ErrIEn TimerIEn</span>
        ucWaitFor <span class="token operator">=</span> <span class="token number">0x30</span><span class="token punctuation">;</span>		<span class="token comment">//寻卡等待时候 查询接收中断标志位与 空闲中断标志位</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>

    <span class="token keyword">default</span><span class="token operator">:</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> ComIEnReg<span class="token punctuation">,</span> ucIrqEn <span class="token operator">|</span> <span class="token number">0x80</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//IRqInv置位管脚IRQ与Status1Reg的IRq位的值相反</span>
    <span class="token function">ClearBitMask</span> <span class="token punctuation">(</span> ComIrqReg<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//Set1该位清零时，CommIRqReg的屏蔽位清零</span>
    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> CommandReg<span class="token punctuation">,</span> PCD_IDLE <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//写空闲命令</span>
    <span class="token function">SetBitMask</span> <span class="token punctuation">(</span> FIFOLevelReg<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//置位FlushBuffer清除内部FIFO的读和写指针以及ErrReg的BufferOvfl标志位被清除</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span> ul <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ul <span class="token operator">&lt;</span> ucInLenByte<span class="token punctuation">;</span> ul <span class="token operator">++</span> <span class="token punctuation">)</span>
        <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> FIFODataReg<span class="token punctuation">,</span> pInData <span class="token punctuation">[</span> ul <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>    		<span class="token comment">//写数据进FIFOdata</span>

    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> CommandReg<span class="token punctuation">,</span> ucCommand <span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//写命令</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> ucCommand <span class="token operator">==</span> PCD_TRANSCEIVE <span class="token punctuation">)</span>
        <span class="token function">SetBitMask</span><span class="token punctuation">(</span>BitFramingReg<span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  				<span class="token comment">//StartSend置位启动数据发送 该位与收发命令使用时才有效</span>

    ul <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span><span class="token comment">//根据时钟频率调整，操作M1卡最大等待时间25ms</span>

    <span class="token keyword">do</span> 														<span class="token comment">//认证 与寻卡等待时间</span>
    <span class="token punctuation">{<!-- --></span>
        ucN <span class="token operator">=</span> <span class="token function">ReadRawRC</span> <span class="token punctuation">(</span> ComIrqReg <span class="token punctuation">)</span><span class="token punctuation">;</span>							<span class="token comment">//查询事件中断</span>
        ul <span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> ul <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token punctuation">(</span> ucN <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token punctuation">(</span> ucN <span class="token operator">&amp;</span> ucWaitFor <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//退出条件i=0,定时器中断，与写空闲命令</span>

    <span class="token function">ClearBitMask</span> <span class="token punctuation">(</span> BitFramingReg<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">//清理允许StartSend位</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> ul <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token punctuation">(</span><span class="token punctuation">(</span> <span class="token function">ReadRawRC</span> <span class="token punctuation">(</span> ErrorReg <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x1B</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>			<span class="token comment">//读错误标志寄存器BufferOfI CollErr ParityErr ProtocolErr</span>
        <span class="token punctuation">{<!-- --></span>
            cStatus <span class="token operator">=</span> MI_OK<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span> ucN <span class="token operator">&amp;</span> ucIrqEn <span class="token operator">&amp;</span> <span class="token number">0x01</span> <span class="token punctuation">)</span>					<span class="token comment">//是否发生定时器中断</span>
                cStatus <span class="token operator">=</span> MI_NOTAGERR<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span> ucCommand <span class="token operator">==</span> PCD_TRANSCEIVE <span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                ucN <span class="token operator">=</span> <span class="token function">ReadRawRC</span> <span class="token punctuation">(</span> FIFOLevelReg <span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//读FIFO中保存的字节数</span>

                ucLastBits <span class="token operator">=</span> <span class="token function">ReadRawRC</span> <span class="token punctuation">(</span> ControlReg <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x07</span><span class="token punctuation">;</span>	<span class="token comment">//最后接收到得字节的有效位数</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span> ucLastBits <span class="token punctuation">)</span>
                    <span class="token operator">*</span> pOutLenBit <span class="token operator">=</span> <span class="token punctuation">(</span> ucN <span class="token operator">-</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">8</span> <span class="token operator">+</span> ucLastBits<span class="token punctuation">;</span>   	<span class="token comment">//N个字节数减去1（最后一个字节）+最后一位的位数 读取到的数据总位数</span>
                <span class="token keyword">else</span>
                    <span class="token operator">*</span> pOutLenBit <span class="token operator">=</span> ucN <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">;</span>   					<span class="token comment">//最后接收到的字节整个字节有效</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span> ucN <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span>
                    ucN <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span> ucN <span class="token operator">&gt;</span> MAXRLEN <span class="token punctuation">)</span>
                    ucN <span class="token operator">=</span> MAXRLEN<span class="token punctuation">;</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span> ul <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ul <span class="token operator">&lt;</span> ucN<span class="token punctuation">;</span> ul <span class="token operator">++</span> <span class="token punctuation">)</span>
                    pOutData <span class="token punctuation">[</span> ul <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ReadRawRC</span> <span class="token punctuation">(</span> FIFODataReg <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
            cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
<span class="token comment">//			printf(ErrorReg);</span>
    <span class="token punctuation">}</span>

    <span class="token function">SetBitMask</span> <span class="token punctuation">(</span> ControlReg<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// stop timer now</span>
    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> CommandReg<span class="token punctuation">,</span> PCD_IDLE <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> cStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：PcdRequest
 * 描述  ：寻卡
 * 输入  ：ucReq_code，寻卡方式
 *                     = 0x52，寻感应区内所有符合14443A标准的卡
 *                     = 0x26，寻未进入休眠状态的卡
 *         pTagType，卡片类型代码
 *                   = 0x4400，Mifare_UltraLight
 *                   = 0x0400，Mifare_One(S50)
 *                   = 0x0200，Mifare_One(S70)
 *                   = 0x0800，Mifare_Pro(X))
 *                   = 0x4403，Mifare_DESFire
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：外部调用
 */</span>
<span class="token keyword">char</span> <span class="token function">PcdRequest</span> <span class="token punctuation">(</span> u8 ucReq_code<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pTagType <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> cStatus<span class="token punctuation">;</span>
    u8 ucComMF522Buf <span class="token punctuation">[</span> MAXRLEN <span class="token punctuation">]</span><span class="token punctuation">;</span>
    u32 ulLen<span class="token punctuation">;</span>

    <span class="token function">ClearBitMask</span> <span class="token punctuation">(</span> Status2Reg<span class="token punctuation">,</span> <span class="token number">0x08</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//清理指示MIFARECyptol单元接通以及所有卡的数据通信被加密的情况</span>
    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> BitFramingReg<span class="token punctuation">,</span> <span class="token number">0x07</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//	发送的最后一个字节的 七位</span>
    <span class="token function">SetBitMask</span> <span class="token punctuation">(</span> TxControlReg<span class="token punctuation">,</span> <span class="token number">0x03</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//TX1,TX2管脚的输出信号传递经发送调制的13.56的能量载波信号</span>

    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> ucReq_code<span class="token punctuation">;</span>		<span class="token comment">//存入 卡片命令字</span>

    cStatus <span class="token operator">=</span> <span class="token function">PcdComMF522</span> <span class="token punctuation">(</span> PCD_TRANSCEIVE<span class="token punctuation">,</span>	ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//寻卡</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> cStatus <span class="token operator">==</span> MI_OK <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> ulLen <span class="token operator">==</span> <span class="token number">0x10</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>	<span class="token comment">//寻卡成功返回卡类型</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span> pTagType <span class="token operator">=</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token operator">*</span> <span class="token punctuation">(</span> pTagType <span class="token operator">+</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">=</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>

    <span class="token keyword">return</span> cStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：PcdAnticoll
 * 描述  ：防冲撞
 * 输入  ：pSnr，卡片序列号，4字节
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：外部调用
 */</span>
<span class="token keyword">char</span> <span class="token function">PcdAnticoll</span> <span class="token punctuation">(</span> u8 <span class="token operator">*</span> pSnr <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> cStatus<span class="token punctuation">;</span>
    u8 uc<span class="token punctuation">,</span> ucSnr_check <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    u8 ucComMF522Buf <span class="token punctuation">[</span> MAXRLEN <span class="token punctuation">]</span><span class="token punctuation">;</span>
    u32 ulLen<span class="token punctuation">;</span>

    <span class="token function">ClearBitMask</span> <span class="token punctuation">(</span> Status2Reg<span class="token punctuation">,</span> <span class="token number">0x08</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//清MFCryptol On位 只有成功执行MFAuthent命令后，该位才能置位</span>
    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> BitFramingReg<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//清理寄存器 停止收发</span>
    <span class="token function">ClearBitMask</span> <span class="token punctuation">(</span> CollReg<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//清ValuesAfterColl所有接收的位在冲突后被清除</span>

    <span class="token comment">/*
    参考ISO14443协议：https://blog.csdn.net/wowocpp/article/details/79910800
    PCD 发送 SEL = ‘93’，NVB = ‘20’两个字节
    迫使所有的在场的PICC发回完整的UID CLn作为应答。
    */</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x93</span><span class="token punctuation">;</span>	<span class="token comment">//卡片防冲突命令</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x20</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送并接收数据 接收的数据存储于ucComMF522Buf</span>
    cStatus <span class="token operator">=</span> <span class="token function">PcdComMF522</span> <span class="token punctuation">(</span> PCD_TRANSCEIVE<span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//与卡片通信</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> cStatus <span class="token operator">==</span> MI_OK<span class="token punctuation">)</span>		<span class="token comment">//通信成功</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 收到的UID 存入pSnr</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> uc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> uc <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> uc <span class="token operator">++</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span> <span class="token punctuation">(</span> pSnr <span class="token operator">+</span> uc <span class="token punctuation">)</span>  <span class="token operator">=</span> ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token punctuation">]</span><span class="token punctuation">;</span>			<span class="token comment">//读出UID</span>
            ucSnr_check <span class="token operator">^=</span> ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> ucSnr_check <span class="token operator">!=</span> ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token punctuation">]</span> <span class="token punctuation">)</span>
            cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token function">SetBitMask</span> <span class="token punctuation">(</span> CollReg<span class="token punctuation">,</span> <span class="token number">0x80</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> cStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：CalulateCRC
 * 描述  ：用RC522计算CRC16
 * 输入  ：pIndata，计算CRC16的数组
 *         ucLen，计算CRC16的数组字节长度
 *         pOutData，存放计算结果存放的首地址
 * 返回  : 无
 * 调用  ：内部调用
 */</span>
<span class="token keyword">void</span> <span class="token function">CalulateCRC</span> <span class="token punctuation">(</span> u8 <span class="token operator">*</span> pIndata<span class="token punctuation">,</span> u8 ucLen<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pOutData <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 uc<span class="token punctuation">,</span> ucN<span class="token punctuation">;</span>

    <span class="token function">ClearBitMask</span><span class="token punctuation">(</span>DivIrqReg<span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">WriteRawRC</span><span class="token punctuation">(</span>CommandReg<span class="token punctuation">,</span> PCD_IDLE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">SetBitMask</span><span class="token punctuation">(</span>FIFOLevelReg<span class="token punctuation">,</span> <span class="token number">0x80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span> uc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> uc <span class="token operator">&lt;</span> ucLen<span class="token punctuation">;</span> uc <span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> FIFODataReg<span class="token punctuation">,</span> <span class="token operator">*</span> <span class="token punctuation">(</span> pIndata <span class="token operator">+</span> uc <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">WriteRawRC</span> <span class="token punctuation">(</span> CommandReg<span class="token punctuation">,</span> PCD_CALCCRC <span class="token punctuation">)</span><span class="token punctuation">;</span>

    uc <span class="token operator">=</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>

    <span class="token keyword">do</span>
    <span class="token punctuation">{<!-- --></span>
        ucN <span class="token operator">=</span> <span class="token function">ReadRawRC</span> <span class="token punctuation">(</span> DivIrqReg <span class="token punctuation">)</span><span class="token punctuation">;</span>
        uc <span class="token operator">--</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> uc <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> <span class="token punctuation">(</span> ucN <span class="token operator">&amp;</span> <span class="token number">0x04</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    pOutData <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ReadRawRC</span> <span class="token punctuation">(</span> CRCResultRegL <span class="token punctuation">)</span><span class="token punctuation">;</span>
    pOutData <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">ReadRawRC</span> <span class="token punctuation">(</span> CRCResultRegM <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：PcdSelect
 * 描述  ：选定卡片
 * 输入  ：pSnr，卡片序列号，4字节
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：外部调用
 */</span>
<span class="token keyword">char</span> <span class="token function">PcdSelect</span> <span class="token punctuation">(</span> u8 <span class="token operator">*</span> pSnr <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> cStatus<span class="token punctuation">;</span>
    u8 uc<span class="token punctuation">;</span>
    u8 ucComMF522Buf <span class="token punctuation">[</span> MAXRLEN <span class="token punctuation">]</span><span class="token punctuation">;</span>
    u32  ulLen<span class="token punctuation">;</span>

    <span class="token comment">// 防冲撞 0x93</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> PICC_ANTICOLL1<span class="token punctuation">;</span>
    <span class="token comment">// 假设没有冲突，PCD 指定NVB为70，此值表示PCD将发送完整的UID CLn，与40位UID CLn 匹配的PICC，以SAK作为应答</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x70</span><span class="token punctuation">;</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">6</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 3 4 5 6位存放UID，第7位一直异或。。。</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> uc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> uc <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> uc <span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token operator">+</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span> <span class="token punctuation">(</span> pSnr <span class="token operator">+</span> uc <span class="token punctuation">)</span><span class="token punctuation">;</span>
        ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">6</span> <span class="token punctuation">]</span> <span class="token operator">^=</span> <span class="token operator">*</span> <span class="token punctuation">(</span> pSnr <span class="token operator">+</span> uc <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// CRC(循环冗余校验)</span>
    <span class="token function">CalulateCRC</span> <span class="token punctuation">(</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">7</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">ClearBitMask</span> <span class="token punctuation">(</span> Status2Reg<span class="token punctuation">,</span> <span class="token number">0x08</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 发送并接收数据</span>
    cStatus <span class="token operator">=</span> <span class="token function">PcdComMF522</span> <span class="token punctuation">(</span> PCD_TRANSCEIVE<span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> cStatus <span class="token operator">==</span> MI_OK <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> ulLen <span class="token operator">==</span> <span class="token number">0x18</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
        cStatus <span class="token operator">=</span> MI_OK<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>

    <span class="token keyword">return</span> cStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：PcdAuthState
 * 描述  ：验证卡片密码
 * 输入  ：ucAuth_mode，密码验证模式
 *                     = 0x60，验证A密钥
 *                     = 0x61，验证B密钥
 *         u8 ucAddr，块地址
 *         pKey，密码
 *         pSnr，卡片序列号，4字节
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：外部调用
 */</span>
<span class="token keyword">char</span> <span class="token function">PcdAuthState</span> <span class="token punctuation">(</span> u8 ucAuth_mode<span class="token punctuation">,</span> u8 ucAddr<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pKey<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pSnr <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> cStatus<span class="token punctuation">;</span>
    u8 uc<span class="token punctuation">,</span> ucComMF522Buf <span class="token punctuation">[</span> MAXRLEN <span class="token punctuation">]</span><span class="token punctuation">;</span>
    u32 ulLen<span class="token punctuation">;</span>

    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> ucAuth_mode<span class="token punctuation">;</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> ucAddr<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span> uc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> uc <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> uc <span class="token operator">++</span> <span class="token punctuation">)</span>
        ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token operator">+</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span> <span class="token punctuation">(</span> pKey <span class="token operator">+</span> uc <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span> uc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> uc <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> uc <span class="token operator">++</span> <span class="token punctuation">)</span>
        ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token operator">+</span> <span class="token number">8</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span> <span class="token punctuation">(</span> pSnr <span class="token operator">+</span> uc <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// printf("char PcdAuthState ( u8 ucAuth_mode, u8 ucAddr, u8 * pKey, u8 * pSnr )\r\n");</span>
    <span class="token comment">// printf("before PcdComMF522() ucComMF522Buf:%s\r\n", ucComMF522Buf);</span>

    <span class="token comment">// 验证密钥命令</span>
    cStatus <span class="token operator">=</span> <span class="token function">PcdComMF522</span> <span class="token punctuation">(</span> PCD_AUTHENT<span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// printf("after PcdComMF522() ucComMF522Buf:%s\r\n", ucComMF522Buf);</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> cStatus <span class="token operator">!=</span> MI_OK <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token punctuation">(</span> <span class="token function">ReadRawRC</span> <span class="token punctuation">(</span> Status2Reg <span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x08</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
<span class="token comment">//			if(cStatus != MI_OK)</span>
<span class="token comment">//					printf("666")	;</span>
<span class="token comment">//			else</span>
<span class="token comment">//				printf("888");</span>
        cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> cStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：PcdWrite
 * 描述  ：写数据到M1卡一块
 * 输入  ：u8 ucAddr，块地址
 *         pData，写入的数据，16字节
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：外部调用
 */</span>
<span class="token keyword">char</span> <span class="token function">PcdWrite</span> <span class="token punctuation">(</span> u8 ucAddr<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pData <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> cStatus<span class="token punctuation">;</span>
    u8 uc<span class="token punctuation">,</span> ucComMF522Buf <span class="token punctuation">[</span> MAXRLEN <span class="token punctuation">]</span><span class="token punctuation">;</span>
    u32 ulLen<span class="token punctuation">;</span>

    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> PICC_WRITE<span class="token punctuation">;</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> ucAddr<span class="token punctuation">;</span>

    <span class="token function">CalulateCRC</span> <span class="token punctuation">(</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    cStatus <span class="token operator">=</span> <span class="token function">PcdComMF522</span> <span class="token punctuation">(</span> PCD_TRANSCEIVE<span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> cStatus <span class="token operator">!=</span> MI_OK <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> ulLen <span class="token operator">!=</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span> <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x0A</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
        cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> cStatus <span class="token operator">==</span> MI_OK <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">memcpy</span><span class="token punctuation">(</span>ucComMF522Buf<span class="token punctuation">,</span> pData<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> uc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> uc <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> uc <span class="token operator">++</span> <span class="token punctuation">)</span>
            ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span> <span class="token punctuation">(</span> pData <span class="token operator">+</span> uc <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">CalulateCRC</span> <span class="token punctuation">(</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">16</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        cStatus <span class="token operator">=</span> <span class="token function">PcdComMF522</span> <span class="token punctuation">(</span> PCD_TRANSCEIVE<span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> cStatus <span class="token operator">!=</span> MI_OK <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> ulLen <span class="token operator">!=</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span> <span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x0A</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
            cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：PcdRead
 * 描述  ：读取M1卡一块数据
 * 输入  ：u8 ucAddr，块地址
 *         pData，读出的数据，16字节
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：外部调用
 */</span>
<span class="token keyword">char</span> <span class="token function">PcdRead</span> <span class="token punctuation">(</span> u8 ucAddr<span class="token punctuation">,</span> u8 <span class="token operator">*</span> pData <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> cStatus<span class="token punctuation">;</span>
    u8 uc<span class="token punctuation">,</span> ucComMF522Buf <span class="token punctuation">[</span> MAXRLEN <span class="token punctuation">]</span><span class="token punctuation">;</span>
    u32 ulLen<span class="token punctuation">;</span>

    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> PICC_READ<span class="token punctuation">;</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> ucAddr<span class="token punctuation">;</span>

    <span class="token function">CalulateCRC</span> <span class="token punctuation">(</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    cStatus <span class="token operator">=</span> <span class="token function">PcdComMF522</span> <span class="token punctuation">(</span> PCD_TRANSCEIVE<span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> cStatus <span class="token operator">==</span> MI_OK <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> ulLen <span class="token operator">==</span> <span class="token number">0x90</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> uc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> uc <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> uc <span class="token operator">++</span> <span class="token punctuation">)</span>
            <span class="token operator">*</span> <span class="token punctuation">(</span> pData <span class="token operator">+</span> uc <span class="token punctuation">)</span> <span class="token operator">=</span> ucComMF522Buf <span class="token punctuation">[</span> uc <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
        cStatus <span class="token operator">=</span> MI_ERR<span class="token punctuation">;</span>

    <span class="token keyword">return</span> cStatus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">/*
 * 函数名：PcdHalt
 * 描述  ：命令卡片进入休眠状态
 * 输入  ：无
 * 返回  : 状态值
 *         = MI_OK，成功
 * 调用  ：外部调用
 */</span>
<span class="token keyword">char</span> <span class="token function">PcdHalt</span><span class="token punctuation">(</span> <span class="token keyword">void</span> <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 ucComMF522Buf <span class="token punctuation">[</span> MAXRLEN <span class="token punctuation">]</span><span class="token punctuation">;</span>
    u32  ulLen<span class="token punctuation">;</span>

    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">0</span> <span class="token punctuation">]</span> <span class="token operator">=</span> PICC_HALT<span class="token punctuation">;</span>
    ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">1</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">CalulateCRC</span> <span class="token punctuation">(</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span> ucComMF522Buf <span class="token punctuation">[</span> <span class="token number">2</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">PcdComMF522</span> <span class="token punctuation">(</span> PCD_TRANSCEIVE<span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> ucComMF522Buf<span class="token punctuation">,</span> <span class="token operator">&amp;</span> ulLen <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> MI_OK<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">IC_CMT</span> <span class="token punctuation">(</span> u8 <span class="token operator">*</span> UID<span class="token punctuation">,</span> u8 <span class="token operator">*</span> KEY<span class="token punctuation">,</span> u8 RW<span class="token punctuation">,</span> u8 <span class="token operator">*</span> Dat <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 ucArray_ID <span class="token punctuation">[</span> <span class="token number">4</span> <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//先后存放IC卡的类型和UID(IC卡序列号)</span>

    <span class="token function">PcdRequest</span> <span class="token punctuation">(</span> <span class="token number">0x52</span><span class="token punctuation">,</span> ucArray_ID <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//寻卡</span>

    <span class="token function">PcdAnticoll</span> <span class="token punctuation">(</span> ucArray_ID <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//防冲撞</span>

    <span class="token function">PcdSelect</span> <span class="token punctuation">(</span> UID <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//选定卡</span>

    <span class="token function">PcdAuthState</span> <span class="token punctuation">(</span> <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token number">0x10</span><span class="token punctuation">,</span> KEY<span class="token punctuation">,</span> UID <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//校验</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> RW <span class="token punctuation">)</span><span class="token comment">//读写选择，1是读，0是写</span>
        <span class="token function">PcdRead</span> <span class="token punctuation">(</span> <span class="token number">0x10</span><span class="token punctuation">,</span> Dat <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token function">PcdWrite</span> <span class="token punctuation">(</span> <span class="token number">0x10</span><span class="token punctuation">,</span> Dat <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">PcdHalt</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 显示卡的卡号，以十六进制显示</span>
<span class="token keyword">void</span> <span class="token function">ShowID</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 num<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    u8 i<span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        num<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">;</span>
        num<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">9</span> <span class="token operator">?</span> <span class="token punctuation">(</span>num<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token char">'7'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>num<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token char">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        num<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">%</span> <span class="token number">16</span><span class="token punctuation">;</span>
        num<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">9</span> <span class="token operator">?</span> <span class="token punctuation">(</span>num<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token char">'7'</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token punctuation">(</span>num<span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token number">2</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token char">'0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    num<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"ID&gt;&gt;&gt;%s\r\n"</span><span class="token punctuation">,</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre>
    <h2>
     <a id="_1688">
     </a>
     额外资料
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/3d625e0f82fb70ebebdd7636247a8195.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/5a64d9ab21c6e2ed3e27b2af9e398ab5.png"/>
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/59c60389bc1a90bad23f9f852ce60241.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
</div>


