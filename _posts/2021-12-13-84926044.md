---
layout: post
title: "db2数据库常见问题处理"
date: 2021-12-13 10:45:36 +0800
description: "1 数据库实例挂起 现象：数据库操作无返回，应用程序无响应，分析：1、执行ps -ef|grep d"
keywords: "sql1040n the maximum number of applications is already connecte"
categories: ['数据库']
tags: ['死锁', '数据库', '常见问题', 'Sql', 'Db']
artid: "84926044"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=84926044
    alt: "db2数据库常见问题处理"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     db2数据库常见问题处理
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <div class="iteye-blog-content-contain" style="font-size:14px;">
     <p>
      <span style="font-size:16px;">
       <strong>
        1 数据库实例挂起
       </strong>
      </span>
     </p>
     <p>
     </p>
     <p>
      <span style="font-size:14px;">
       <strong>
        现象：
       </strong>
      </span>
     </p>
     <p>
      数据库操作无返回，应用程序无响应，查看数据库实例发现挂起。
     </p>
     <p>
     </p>
     <p>
      <strong>
       <span style="font-size:14px;">
        分析：
       </span>
      </strong>
     </p>
     <p>
      1、执行ps -ef|grep db2sysc 确认系统中是否存在db2sysc 进程，判断数据库实例是否出现异常。
     </p>
     <p>
      2、执行db2gcf -s -p 分区号-i 实例名确认实例状态是否为Available。
     </p>
     <p>
     </p>
     <p>
      <strong>
       <span style="font-size:14px;">
        处理：
       </span>
      </strong>
     </p>
     <p>
      1、执行如下命令收集db2fodc -hang 数据：
     </p>
     <p>
      db2fodc –hang –alldbs
     </p>
     <p>
      2、如果收集的时间过长，可适当减小收集范围：
     </p>
     <p>
      db2pd –stack all –repeat 5
     </p>
     <p>
      db2pd –latch –repeat 5
     </p>
     <p>
      3、使用DB2 数据库系统用户执行db2_kill 命令杀掉DB2 进程，使用ps –ef|grep db2 命令确认DB2 进程已全部清除，然后执行db2start 命令启动数据库，再执行
     </p>
     <p>
      db2 connect to db_name；
     </p>
     <p>
      db2 "select * from syscat.bufferpools"
     </p>
     <p>
      验证DB2 数据库操作正常。
     </p>
     <p>
      4、重新启动DB2 后再使用db2support 收集相关信息：
     </p>
     <p>
      db2support /tmp/db2data -d &lt;db_name&gt; -a -g -l -r -s
     </p>
     <p>
      5、在AIX 系统中可执行snap -gc 命令、在Linux 系统可执行support –a 命令收集操作系统信息，以帮助分析数据库实例进程为何出现异常。
     </p>
     <p>
     </p>
     <p>
     </p>
     <p>
      <span style="font-size:16px;">
       <strong>
        2 数据库实例崩溃
       </strong>
      </span>
     </p>
     <p>
     </p>
     <p>
      <strong>
       <span style="font-size:14px;">
        现象：
       </span>
      </strong>
     </p>
     <p>
      DB2 进程异常结束，无法提供服务。
     </p>
     <p>
     </p>
     <p>
      <strong>
       <span style="font-size:14px;">
        分析：
       </span>
      </strong>
     </p>
     <p>
      执行ps –ef |grep db2sysc 发现DB2 进程消失。
     </p>
     <p>
     </p>
     <p>
      <strong>
       <span style="font-size:14px;">
        处理：
       </span>
      </strong>
     </p>
     <p>
      1、使用DB2 数据库系统用户执行db2start 命令启动数据库，并执行
     </p>
     <p>
      db2 connect to db_name；
     </p>
     <p>
      db2 "select * from syscat.bufferpools"
     </p>
     <p>
      验证DB2 数据库操作正常。
     </p>
     <p>
      2、执行db2support . –d db_name -c –s –f 命令收集数据，执行
     </p>
     <p>
      db2trc on -t -f server.dmp；
     </p>
     <p>
      db2trc fmt server.dmp server.fmt;
     </p>
     <p>
      db2trc flw -t server.dmp server.flw
     </p>
     <p>
      命令开启db2trc，监控问题是否重现，收集trace 数据。
     </p>
     <p>
     </p>
     <p>
     </p>
     <p>
      <span style="font-size:16px;">
       <strong>
        3 数据库连接数满
       </strong>
      </span>
     </p>
     <p>
     </p>
     <p>
      <strong>
       <span style="font-size:14px;">
        现象：
       </span>
      </strong>
     </p>
     <p>
      应用程序连接数据库时出现SQL1040N The maximum number of applications is already connected to the database 报错，无法建立新的数据库连接。
     </p>
     <p>
     </p>
     <p>
      <span style="font-size:14px;">
       <strong>
        分析：
       </strong>
      </span>
     </p>
     <p>
      1、执行db2 get db cfg for sample | grep –i maxappls 查看当前数据库maxappls 参数值。
     </p>
     <p>
      2、执行db2pd –db db_name –app 或者db2 list applications |wc –l 检查应用程序的总连接数是否已超过数据库最大允许连接数。
     </p>
     <p>
     </p>
     <p>
      <strong>
       <span style="font-size:14px;">
        处理：
       </span>
      </strong>
     </p>
     <p>
      执行db2 update db cfg for sample using maxappls automatic 命令更新maxappls 参数，使之自动增长。
     </p>
     <p>
     </p>
     <p>
     </p>
     <p>
      <strong>
       <span style="font-size:16px;">
        4 数据库事务日志满
       </span>
      </strong>
     </p>
     <p>
     </p>
     <p>
      <span style="font-size:14px;">
       <strong>
        现象：
       </strong>
      </span>
     </p>
     <p>
      单个交易处理数据量大，导致日志满情况发生。
     </p>
     <p>
     </p>
     <p>
      <strong>
       <span style="font-size:14px;">
        分析：
       </span>
      </strong>
     </p>
     <p>
      执行如下查询，可检查占用日志较大的交易：
     </p>
     <p>
      db2 "SELECT SUBSTR(DB_NAME,1,8) AS DB_NAME, AGENT_ID, ROWS_READ,ROWS_WRITTEN, UOW_LOG_SPACE_USED, UOW_START_TIME, UOW_STOP_TIME,ELAPSED_EXEC_TIME_S FROM SYSIBMADM.SNAPAPPL"
     </p>
     <p>
     </p>
     <p>
      <strong>
       <span style="font-size:14px;">
        处理：
       </span>
      </strong>
     </p>
     <p>
      1、若数据库日志满，DB2 将强制回滚事务。可通过db2pd –db db_name –apinfo 数据库名察看应用状态，应该处于rollback 状态。
     </p>
     <p>
      2、DB2 数据库有2 个参数可以控制每个交易使用的日志量，避免单个交易占用索引日志情况， 可执行
     </p>
     <p>
      db2 update dbm cfg using MAX_LOG 80 和db2 update dbm cfg usingNUM_LOG_SPAN 80
     </p>
     <p>
      设置该参数为80%，避免单个大交易的情况。
     </p>
     <p>
      3、规避方法：
     </p>
     <p>
      当数据库日志空间存在用尽风险时，可以通过在线增加logsecond 参数来增加可用的日志空间，避免出现日志空间满的情况。在扩展此参数前，需确认数据库日志所在的文件系统有空闲空间。
     </p>
     <p>
      确认数据库的日志路径:
     </p>
     <p>
      db2 get db cfg for &lt;dbname&gt; |grep "Path to log files"
     </p>
     <p>
      增加logsecond:
     </p>
     <p>
      单分区环境：
     </p>
     <p>
      db2 update db cfg using logsecond &lt;num&gt;
     </p>
     <p>
      注：num 为参数logsecond 的新的值。
     </p>
     <p>
      多分区环境：
     </p>
     <p>
      db2_all "db2 update db cfg using logsecond &lt;num&gt;"
     </p>
     <p>
      注：num 为参数logsecond 的新的值。
     </p>
     <p>
     </p>
     <p>
     </p>
     <p>
      <strong>
       <span style="font-size:16px;">
        5 数据库事务日志误删
       </span>
      </strong>
     </p>
     <p>
     </p>
     <p>
      <span style="font-size:14px;">
       <strong>
        现象：
       </strong>
      </span>
     </p>
     <p>
      数据库活动日志被误删除。
     </p>
     <p>
     </p>
     <p>
      <strong>
       分析：
      </strong>
     </p>
     <p>
      进入DB2 活动日志目录下，检查发现日志文件已经被误删除。
     </p>
     <p>
     </p>
     <p>
      <strong>
       处理：
      </strong>
     </p>
     <p>
      通过最新的数据库备份进行恢复，执行恢复之后前滚日志。命令：
     </p>
     <p>
      db2 RESTORE DATABASE 数据库名 FROM 备份文件位置" TAKEN AT 时间戳 to 待恢复的实例名" logtarget 日志目录REPLACE EXISTING redirect
     </p>
     <p>
      注：日志重置后，强烈建议数据库重建，避免存在隐患。
     </p>
     <p>
     </p>
     <p>
     </p>
     <p>
      <strong>
       <span style="font-size:16px;">
        6 数据库表空间满
       </span>
      </strong>
     </p>
     <p>
     </p>
     <p>
      <strong>
       现象：
      </strong>
     </p>
     <p>
      巡检发现数据库日志中出现如下错误信息：
     </p>
     <p>
      FUNCTION: DB2 UDB, buffer pool services, sqlbDMScheckObjAlloc, probe:830
     </p>
     <p>
      MESSAGE : ZRC=0x85020021=-2063466463=SQLB_END_OF_CONTAINER "DMS Containerspace full"
     </p>
     <p>
     </p>
     <p>
      <strong>
       分析：
      </strong>
     </p>
     <p>
      1、执行如下SQL 语句，确认表空间使用率：
     </p>
     <p>
      $db2 "connect to 数据库名 user 用户 using 密码
     </p>
     <p>
      $db2 "select substr(a.tbsp_name,1,18) as name,substr(a.tbsp_type,1,10) as
     </p>
     <p>
      tbstype,a.TBSP_USING_AUTO_STORAGE as AUTO_STORAGE,substr(a.tbsp_state,1,8) as
     </p>
     <p>
      state,a.tbsp_total_size_kb/1024 as TotalMB ,a.TBSP_PAGE_TOP*a.TBSP_PAGE_SIZE/1024/1024 as
     </p>
     <p>
      top_size_mb,a.tbsp_used_size_kb/1024 as UsedMB, a.TBSP_UTILIZATION_PERCENT as
     </p>
     <p>
      UsedPer ,b.CONTAINER_NAME from sysibmadm.tbsp_utilization a, sysibmadm.SNAPCONTAINER
     </p>
     <p>
      b where tbsp_type='DMS' and a.TBSP_ID=b.TBSP_ID order by AUTO_STORAGE,UsedPer desc"
     </p>
     <p>
      2、执行如下命令确认容器类型：
     </p>
     <p>
      单分区环境
     </p>
     <p>
      $db2pd -d &lt;db&gt; -tab
     </p>
     <p>
      多分区环境：
     </p>
     <p>
      $db2_all "db2pd -d &lt;db&gt; -tab"
     </p>
     <p>
     </p>
     <p>
      <strong>
       处理：
      </strong>
     </p>
     <p>
      执行
     </p>
     <p>
      $db2 "alter tablespace &lt;name&gt; extend(all NG)"
     </p>
     <p>
      扩容表空间。
     </p>
     <p>
      注：表空间增加的大小为容器数量*N，N 为每个容器增加的大小。
     </p>
     <p>
     </p>
     <p>
     </p>
     <p>
      <strong>
       <span style="font-size:16px;">
        7 数据库表空间状态异常
       </span>
      </strong>
     </p>
     <p>
     </p>
     <p>
      <strong>
       现象：
      </strong>
     </p>
     <p>
      系统监控报警数据库表空间状态异常。
     </p>
     <p>
     </p>
     <p>
      <strong>
       分析：
      </strong>
     </p>
     <p>
      1、由于存储、操作或者权限等原因，会导致DB2 表空间状态异常。此时，可查询表空间16 进制的状态值。命令：
     </p>
     <p>
      $db2 list tablespaces show detail|grep -i state
     </p>
     <p>
      2、根据返回的16 进制值，确认表空间状态。命令：
     </p>
     <p>
      $db2tbst &lt;tablespace state&gt;
     </p>
     <p>
      3、表空间状态信息对应的描述：
     </p>
     <p>
     </p>
     <p>
     </p>
     <table cellpadding="0" cellspacing="0" style="border-collapse:collapse;">
      <tbody>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Return code
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Description
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          描述
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x0
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Normal
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          正常
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x1
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Quiesced: SHARE
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          静止态共享
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x2
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Quiesced: UPDATE
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          静止态更新
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x4
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Quiesced: EXCLUSIVE
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          静止态排它
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x8
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Load pending
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          载入挂起
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x10
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Delete pending
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          删除挂起
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x20
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Backup pending
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          备份挂起
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x40
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Roll forward in progress
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          正在回滚
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x80
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Roll forward pending
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          回滚挂起
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x100
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Restore pending
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          存储挂起
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x100
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Recovery pending (not used)
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          恢复挂起
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x200
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Disable pending
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          禁用挂起
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x400
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Reorg in progress
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          正在重组
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x800
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Backup in progress
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          正在备份
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x1000
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Storage must be defined
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          存储器未被指定
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x2000
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Restore in progress
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          正在恢复
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x4000
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Offline and not accessible
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          表空间不可访问
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x8000
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Drop pending
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          删除挂起
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x2000000
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Storage may be defined
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          存储器需被指定
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x4000000
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          StorDef is in 'final' state
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          存储器终止
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x8000000
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          StorDef was changed prior to rollforward
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          存储器被改变至回滚状态
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x10000000
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          DMS rebalancer is active
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          表空间的容器重新分布
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x20000000
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          TBS deletion in progress
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          表空间删除
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x40000000
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          TBS creation in progress
         </p>
        </td>
        <td style="width:133px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          表空间建立
         </p>
        </td>
       </tr>
      </tbody>
     </table>
     <p>
     </p>
     <p>
     </p>
     <p>
      <strong>
       处理：
      </strong>
     </p>
     <p>
      常见异常状态的处理方式：
     </p>
     <p>
     </p>
     <p>
     </p>
     <p>
     </p>
     <table cellpadding="0" cellspacing="0" style="border-collapse:collapse;">
      <tbody>
       <tr>
        <td style="width:46px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          状态
         </p>
        </td>
        <td style="width:34px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          状态值
         </p>
        </td>
        <td style="width:154px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          原因
         </p>
        </td>
        <td style="width:156px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          状态描述及处理方式
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:46px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Backup
         </p>
         <p>
          Pending
         </p>
        </td>
        <td style="width:34px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x20
         </p>
        </td>
        <td style="width:154px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          归档日志下进行LOAD 操作导致
         </p>
        </td>
        <td style="width:156px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          对状态异常的表空间执行备份，命令： db2 backup database db_name tablespace(syscatspace, userspace1) to/dbbackupdir
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:46px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Offline and
         </p>
         <p>
          Not
         </p>
         <p>
          Accessible
         </p>
        </td>
        <td style="width:34px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x4000
         </p>
        </td>
        <td style="width:154px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          1．表空间使用的物理设备不可访问
         </p>
         <p>
          2．物理设备权限不对
         </p>
        </td>
        <td style="width:156px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          修复物理设备问题，保证权限正确,然后修改表空间为online 状态，命令：
         </p>
         <p>
          db2 ALTER TABLESPACE &lt;name&gt; SWITCH ONLINE
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:46px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Restore
         </p>
         <p>
          Pending
         </p>
        </td>
        <td style="width:34px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x100
         </p>
        </td>
        <td style="width:154px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          恢复过程中，表空间对应的物理设备不可用，表空间就处于这种状态。
         </p>
        </td>
        <td style="width:156px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          必须恢复单个表空间（或者是整
         </p>
         <p>
          个数据库）。命令：
         </p>
         <p>
          db2 restore database db_name tablespace (XXX)
         </p>
         <p>
          如果是归档日志，则前滚日志，命令：
         </p>
         <p>
          db2 rollfoward db db_name to end of logs and complete
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:46px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Roll
         </p>
         <p>
          Forward
         </p>
         <p>
          Pending
         </p>
        </td>
        <td style="width:34px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x80
         </p>
        </td>
        <td style="width:154px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          由于物理设备不可用或者权限问题， 导致CRASH RECOVERY 时日志无法前滚，出现上述问题；
         </p>
        </td>
        <td style="width:156px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          必须前滚数据库，命令：
         </p>
         <p>
          db2 rollfoward db db_name to end of logs and complete
         </p>
        </td>
       </tr>
       <tr>
        <td style="width:46px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          Storage
         </p>
         <p>
          Must be
         </p>
         <p>
          Defined
         </p>
        </td>
        <td style="width:34px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          0x1000
         </p>
        </td>
        <td style="width:154px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          在将恢复操作重定向到新数据库期间，如果省略了设置表空间容器的阶段，或者，如果在设置表空间容器的阶段期间无法获得指定的容器，那么数据库的表空间就会处于这种状态。
         </p>
        </td>
        <td style="width:156px;border-style:solid;border-width:1px;border-color:#000000 #000000 #000000 #000000;">
         <p>
          需要重新制定表空间使用的容器，命令：
         </p>
         <p>
          db2 SET TABLESPACE CONTAINERS FOR 1 USING (容器名)
         </p>
        </td>
       </tr>
      </tbody>
     </table>
     <p>
     </p>
     <p>
     </p>
     <p>
      <span style="font-size:16px;">
       <strong>
        8 数据库表或数据误删
       </strong>
      </span>
     </p>
     <p>
     </p>
     <p>
      <strong>
       现象：
      </strong>
     </p>
     <p>
      数据库中的表或数据被误删除。
     </p>
     <p>
     </p>
     <p>
      <strong>
       分析：
      </strong>
     </p>
     <p>
      与操作人员确认误删除发生的时间以及被删除的数据内容。
     </p>
     <p>
     </p>
     <p>
      <strong>
       处理：
      </strong>
     </p>
     <p>
      1、如果该表或数据所在的表空间不大，恢复时间较短，且该表所在的表空间已启用DROPPED TABLE RECOVERY 选项，建议采用数据库前滚恢复的方式恢复表或数据。可通过如下命令查询字典表SYSCAT.TABLESPACES 来验证表空间是否已开启DROPPED TABLE RECOVERY选项：
     </p>
     <p>
      db2 "select tbspace,drop_recovery from syscat.tablespaces"
     </p>
     <p>
      TBSPACE DROP_RECOVERY
     </p>
     <p>
      ---------------------- ------------------
     </p>
     <p>
      SYSCATSPACE N
     </p>
     <p>
      TEMPSPACE1 N
     </p>
     <p>
      USERSPACE1 Y
     </p>
     <p>
      ALANSPACE1 Y
     </p>
     <p>
      ALANSPACE2 Y
     </p>
     <p>
      SYSTOOLSPACE Y
     </p>
     <p>
      2、尝试恢复数据库：
     </p>
     <p>
      （a）、执行db2 restore database irmdb from D:\IBM\alanbak taken at 20100628154742 into irmdb命令，将会显示SQL2539W 警告！正在复原至与备份映像数据库相同的现有数据库。
     </p>
     <p>
      数据库文件将被删除。想要继续吗？（y/n）
     </p>
     <p>
      回答Y。
     </p>
     <p>
      DB20000I RESTORE DATABASE 命令成功完成。
     </p>
     <p>
      （b）、执行db2 list history dropped table all for irmdb从历史文件中检索已经丢失表对象的ID。列示irmdb 的历史记录文件：
     </p>
     <p>
      匹配的文件条目数= 1
     </p>
     <p>
      Op 对象时间戳记+序列类型设备最早日志当前日志备份标识
     </p>
     <p>
      -- --- ------------------ ---- --- ------------ ------------ ----------
     </p>
     <p>
      D T 20100628154949 000000000000f40200030004
     </p>
     <p>
      ----------------------------------------------------
     </p>
     <p>
      "DB2ADMIN"."ALANTEST1" 驻留在1 表空间中：00001 ALANSPACE1
     </p>
     <p>
      ----------------------------------------------------
     </p>
     <p>
      注释：DROP TABLE
     </p>
     <p>
      开始时间：20100628154949
     </p>
     <p>
      结束时间：20100628154949
     </p>
     <p>
      状态：A
     </p>
     <p>
      ----------------------------------------------------
     </p>
     <p>
      EID：13
     </p>
     <p>
      DDL: CREATE TABLE "DB2ADMIN"."ALANTEST1" ( "ID" INTEGER , "NAME" VARCHAR(10) ) IN "ALANSPACE1" ;
     </p>
     <p>
      ----------------------------------------------------
     </p>
     <p>
      其中我们可以查看一下备份标识:000000000000f40200030004，这个信息对于恢复表非常重要。
     </p>
     <p>
      （c）、Rollforward数据库到日志结尾,同时生成恢复导入文件(我们需要利用上面的备份标识000000000000f40200030004来恢复数据库,同时准备出一个导出目录D:\IBM\exporttab)。执行如下命令：
     </p>
     <p>
      db2 "rollforward database irmdb to end of logs and stop tablespace (alanspace1) online recover
     </p>
     <p>
      dropped table 000000000000f40200030004 to D:\IBM\exporttab"
     </p>
     <p>
      前滚状态
     </p>
     <p>
      输入数据库别名= irmdb
     </p>
     <p>
      节点数已返回状态= 1
     </p>
     <p>
      节点号= 0
     </p>
     <p>
      前滚状态= 未暂挂
     </p>
     <p>
      下一个要读取的日志文件=
     </p>
     <p>
      已处理的日志文件= S0000002.LOG - S0000004.LOG
     </p>
     <p>
      上次落实的事务= 2010-06-28-07.49.50.000000 UTC
     </p>
     <p>
      DB20000I ROLLFORWARD 命令成功完成。
     </p>
     <p>
      （d）、此时我们可以看到在D:\IBM\exporttab\NODE0000目录下生成了一个data文件,内容就是我们表中丢失的数据。然后，我们用LIST HISTORY中的DDL来重建表结构并IMPORT相应的数据，如下：
     </p>
     <p>
      DDL: CREATE TABLE "DB2ADMIN"."ALANTEST1" ( "ID" INTEGER , "NAME" VARCHAR(10) ) IN "ALANSPACE1" ;
     </p>
     <p>
      db2 CREATE TABLE "DB2ADMIN"."ALANTEST1" ( "ID" INTEGER , "NAME" VARCHAR(10) )
     </p>
     <p>
      DB20000I SQL 命令成功完成。
     </p>
     <p>
      db2 import from D:\IBM\exporttab\NODE0000\data of del insert into db2admin.alantest1
     </p>
     <p>
      SQL3109N 实用程序正在开始从文件"D:\IBM\exporttab\NODE0000\data" 装入数据。
     </p>
     <p>
      SQL3110N 实用程序已完成处理。从输入文件读了"5" 行。
     </p>
     <p>
      SQL3221W ...开始COMMIT WORK。输入记录计数= "5"。
     </p>
     <p>
      SQL3222W ...对任何数据库更改的COMMIT 都成功。
     </p>
     <p>
      SQL3149N 处理了输入文件中的"5" 行。已将"5" 行成功插入表中。拒绝了"0" 行。
     </p>
     <p>
      读取行数= 5
     </p>
     <p>
      跳过行数= 0
     </p>
     <p>
      插入行数= 5
     </p>
     <p>
      更新行数= 0
     </p>
     <p>
      拒绝行数= 0
     </p>
     <p>
      落实行数= 5
     </p>
     <p>
      3、如果该表所在的表空间很大，恢复时间远大于停机窗口，建议根据之前的建表语句重建表，并利用最新的逻辑备份导入最新的备份数据，手工补做数据丢失的时间段业务。
     </p>
     <p>
     </p>
     <p>
     </p>
     <p>
      <span style="font-size:16px;">
       <strong>
        9 死锁或超时，导致当前事务回滚
       </strong>
      </span>
     </p>
     <p>
     </p>
     <p>
      <strong>
       现象：
      </strong>
     </p>
     <p>
      当前事务因死锁或超时而回滚，提示信息如下：
     </p>
     <p>
      SQL0911N The current transaction has been rolled back because of a deadlock or timeout. Reason code "2"
     </p>
     <p>
     </p>
     <p>
      <strong>
       分析：
      </strong>
     </p>
     <p>
      根据报错的具体信息，可以判定，原因为死锁导致超时。
     </p>
     <p>
     </p>
     <p>
      <strong>
       处理：
      </strong>
     </p>
     <p>
      为了帮助避免死锁或锁定超时，可以采用如下两种方法
     </p>
     <p>
      1、对长时间运行的应用程序或有可能遇到死锁的应用程序频繁发出COMMIT 操作（若有可能的话）。
     </p>
     <p>
      2、修改数据库参数，适当地增大锁超时时间（此处60 秒为例），命令如下：
     </p>
     <p>
      db2 update db cfg using LOCKTIMEOUT 60
     </p>
     <div>
     </div>
    </div>
   </div>
  </div>
  <div id="recommendDown">
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f44755f776f6f64:2f61727469636c652f64657461696c732f3834393236303434" class_="artid" style="display:none">
 </p>
</div>


