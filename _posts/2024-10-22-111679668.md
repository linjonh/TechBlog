---
layout: post
title: "微信小程序之踩坑与填坑记录持续更新..."
date: 2024-10-22 15:27:33 +0800
description: "之前主要做Java开发，前些时间有机会接触了小程序开发，也挺有意思的，不过在开发微信小程序过程中也遇"
keywords: "微信小程序内存块每个相同吗"
categories: ['微信小程序']
tags: ['踩坑', '注意事项', '微信小程序']
artid: "111679668"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=111679668
    alt: "微信小程序之踩坑与填坑记录持续更新..."
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     微信小程序之踩坑与填坑记录(持续更新...)
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-tomorrow-night-eighties" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
     之前主要做Java开发，前些时间有机会接触了小程序开发，也挺有意思的，不过在开发微信小程序过程中也遇到了很多坑，特此记录一下所有的坑和解决方案，持续更新······
    </p>
    <h2>
     <a id="__4">
     </a>
     一. 注意事项
    </h2>
    <hr/>
    <h4>
     <a id="1_7">
     </a>
     1.微信小程序的缓存是共通的
    </h4>
    <p>
     开发版，体验版，正式版的微信小程序的缓存居然是通用的。
    </p>
    <p>
     这个真的有点惊吓，当时开发账号缓存直接显示在正式版微信小程序上，吓得以为要被祭天了，排查了半天才知道原来缓存是通用的。
    </p>
    <p>
     <strong>
      解决方案
     </strong>
    </p>
    <p>
     在登录前先清除缓存，再重新请求获取。
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">// 清空所有缓存</span>
wx<span class="token punctuation">.</span><span class="token function">clearStorageSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
    <hr/>
    <h4>
     <a id="2WXML__22">
     </a>
     2.WXML 中的属性绑定是单向的
    </h4>
    <p>
     在 WXML 中，普通的属性的绑定是单向的，比如：
    </p>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{value}}<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre>
    <p>
     如果使用
     <code>
      this.setData({ value: '123' })
     </code>
     ，
     <code>
      this.data.value
     </code>
     和输入框显示的值都会被更新；但如果用户修改了输入框里的值，却不会改变
     <code>
      this.data.value
     </code>
     的值。
    </p>
    <p>
     如果需要双向绑定机制，可以在之前加入
     <code>
      model:
     </code>
     前缀：
    </p>
    <pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name"><span class="token namespace">model:</span>value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{<!-- -->{value}}<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre>
    <p>
     这样，如果输入框的值被改变， this.data.value 就能同时改变了。
    </p>
    <hr/>
    <h4>
     <a id="3_41">
     </a>
     3.快速滑动无法及时触发底部事件
    </h4>
    <p>
     微信小程序中的reachBottom 触底事件有 350ms 的频率限制，如果快速滑动就可能会导致数据不能继续加载。
    </p>
    <p>
     <strong>
      解决方案
     </strong>
    </p>
    <p>
     下拉触底后，添加一个加载中的显示效果，延迟350ms显示下一页数据。
    </p>
    <hr/>
    <h4>
     <a id="4_50">
     </a>
     4.特殊机型的触底高度设置
    </h4>
    <p>
     之前设置全局下拉触底事件的触发高度参数
     <strong>
      onReachBottomDistance
     </strong>
     为 0，在其他机型显示没有问题，只有红米和小米手机下拉几次后就无法再加载更多数据了，猜测可能是因为小米系列手机有什么特别的通用设计。
    </p>
    <p>
     <strong>
      解决方案
     </strong>
    </p>
    <p>
     将 onReachBottomDistance 改大一点，也就是在距离底部 100px 的时候就触发，这样就能够提前加载下一页数据了。
    </p>
    <pre><code class="prism language-json"><span class="token string">"window"</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"onReachBottomDistance"</span><span class="token operator">:</span> <span class="token number">100</span>
 <span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <h4>
     <a id="5appwxss_64">
     </a>
     5.自定义组件拿不到app.wxss样式
    </h4>
    <p>
     自定义组件后，发现所有公共样式都会失效，当时我的解决方案是直接导入，看网上也有直接添加配置的，我没有试过，大家也可以试一下。
    </p>
    <p>
     <strong>
      解决方案
     </strong>
    </p>
    <p>
     (1) 直接导入
    </p>
    <pre><code class="prism language-css"><span class="token atrule"><span class="token rule">@import</span> <span class="token string">'/app.wxss'</span><span class="token punctuation">;</span></span>
</code></pre>
    <p>
     (2) 添加配置
    </p>
    <pre><code class="prism language-javascript">options<span class="token operator">:</span><span class="token punctuation">{<!-- --></span>
	addGlobalClass<span class="token operator">:</span><span class="token boolean">true</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <h4>
     <a id="6_backgroundurl_83">
     </a>
     6. background图片url不能为本地图片
    </h4>
    <p>
     背景图片设置为本地图片不能正常显示，解决方案可以参考以下博客：
    </p>
    <p>
     <a href="https://blog.csdn.net/j1231230/article/details/111561581">
      微信小程序之 如何添加背景图片 &amp; 包大小超限解决方案
     </a>
    </p>
    <hr/>
    <h4>
     <a id="7_appjs_89">
     </a>
     7. app.js的回调
    </h4>
    <p>
     因为 app.js 中的 onLaunch 是异步的，当小程序首页打开时，app.js中在onLaunch里的接口还没有返回，globalData的值还未来得及设置，但index.js已经执行了，所以会遇到获取不到globalData的问题。
    </p>
    <p>
     <strong>
      解决方案
     </strong>
    </p>
    <p>
     在 onLaunch 请求返回之后，再执行index.js中的onLoad方法。
    </p>
    <p>
     app.js 代码
    </p>
    <pre><code class="prism language-javascript"><span class="token function">App</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
	<span class="token function-variable function">onLaunch</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		wx<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
			url<span class="token operator">:</span> <span class="token string">'https://www.xxx.com/test'</span><span class="token punctuation">,</span>
			data<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
			<span class="token punctuation">}</span><span class="token punctuation">,</span>
			<span class="token function-variable function">success</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">//设置全局变量</span>
				<span class="token keyword">this</span><span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userId <span class="token operator">=</span> res<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>
				<span class="token comment">//由于是网络请求，可能会在Page.onLoad后才返回,加入callback以防止这种情况</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>userIdCallback<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
					<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">userIdCallback</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
    globalData<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    	userId<span class="token operator">:</span> <span class="token string">''</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <p>
     index.js 代码
    </p>
    <pre><code class="prism language-javascript"><span class="token comment">//获取应用实例</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">getApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token function">Page</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  data<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    showPic<span class="token operator">:</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token function-variable function">onLoad</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//判断是用户是否绑定</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userId <span class="token operator">&amp;&amp;</span> app<span class="token punctuation">.</span>globalData<span class="token punctuation">.</span>userId <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        showPic<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      app<span class="token punctuation">.</span><span class="token function-variable function">userIdCallback</span> <span class="token operator">=</span> <span class="token parameter">userId</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">!=</span> <span class="token string">''</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            showPic<span class="token operator">:</span> <span class="token boolean">true</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
    <hr/>
    <h4>
     <a id="8_wxlogin_code_150">
     </a>
     8. 微信小程序wx.login 获取的code只能用一次
    </h4>
    <p>
     这个是因为我们的场景比较特殊，首先要判断用户是否绑定，没有的话就跳转到登录界面进行账号绑定，此时再根据code获取openId就失效了，最后采用后端缓存的方式解决的，具体方案见之前我写的另外一篇博客：
    </p>
    <p>
     <a href="https://blog.csdn.net/j1231230/article/details/109403086">
      微信小程序登录流程（自定义账号绑定功能）
     </a>
    </p>
    <hr/>
    <h4>
     <a id="9__156">
     </a>
     9. 微信小程序中的生命周期管理
    </h4>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/2a18388b39e31e2175f9c85c8c4efbca.png">
      <br/>
      这个其实是很重要的，了解生命周期和页面的加载销毁机制能够让我们更好的把控全局。
     </img>
    </p>
    <p>
     比如一个刚绑定的用户，点击后退按钮退回到上一个页面，会触发onShow事件而不是onLoad事件，所以我们需要把身份判断写在onShow中才能显示已经绑定后的内容。
     <br/>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/6a179d34d2dac5f88891aac840c319c2.png"/>
    </p>
    <h2>
     <a id="__162">
     </a>
     二. 踩坑与完善
    </h2>
    <p>
     除了以上的注意事项，微信小程序还有很多官方的坑以及需要完善的地方：
    </p>
    <hr/>
    <h4>
     <a id="1table_166">
     </a>
     1.微信小程序没有table效果
    </h4>
    <p>
     堂堂微信小程序居然没有 table 效果，但是项目有需求，只能通过view来模拟了，具体实现代码可以参照我之前写的博客：
    </p>
    <p>
     <a href="https://blog.csdn.net/j1231230/article/details/111032917">
      微信小程序之实现隔行变色表格
     </a>
    </p>
    <hr/>
    <h4>
     <a id="2input__172">
     </a>
     2.input 输入框聚焦时闪烁
    </h4>
    <p>
     官方BUG最为致命，搜索了很多方法都不是很完美，如果要求不高，可以使用textarea来模拟实现。
    </p>
    <hr/>
    <h4>
     <a id="3textarea_176">
     </a>
     3.textarea最大值超限输入
    </h4>
    <p>
     textarea有maxlength属性，可以用来限制用户输入的最大字数，但是有的时候不停的复制粘贴是可以输入超出限制值的字数的，还也不会显示在文本框中，这样就需要在提交数据时进行二次判断：
    </p>
    <p>
     js代码
    </p>
    <pre><code class="prism language-javascript"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>content <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>content<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      wx<span class="token punctuation">.</span><span class="token function">showToast</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        title<span class="token operator">:</span> <span class="token string">'内容不得超过200个字符'</span><span class="token punctuation">,</span>
        icon<span class="token operator">:</span> <span class="token string">'none'</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
    <hr/>
    <h4>
     <a id="4tab_191">
     </a>
     4.tab切换高度无法自适应
    </h4>
    <p>
     swiper 的 tab 选项卡高度默认为 150px，不能做到自适应，如果tab页面的内容较多，就会出现无法完全显示的问题。
    </p>
    <p>
     <strong>
      解决方案
     </strong>
    </p>
    <p>
     <a href="https://blog.csdn.net/j1231230/article/details/110289694">
      微信小程序之 swiper 的 tab 选项卡高度自适应问题解决方案
     </a>
    </p>
    <hr/>
    <h4>
     <a id="5unknown_200">
     </a>
     5.上传图片出现unknown后缀
    </h4>
    <p>
     拍照时选原图，出现"unknown"扩展名，不选原图正常。
    </p>
    <p>
     属于官方BUG，至今仍未解决，不过测试发现虽然后缀格式不对，但是不影响显示，根据该格式图片生成缩略图也能正确显示，所以暂时不做处理，希望官方尽快修复。
    </p>
    <hr/>
    <h4>
     <a id="6_ios__207">
     </a>
     6.安卓和 ios 下的样式适配
    </h4>
    <p>
     微信小程序虽然尽可能屏蔽了安卓和 ios 下的各种差异，但是一些样式上还是会存在问题，比如，ios 中 input 的 placeholder 属性字体不居中。
    </p>
    <p>
     <strong>
      解决方案
     </strong>
    </p>
    <ul>
     <li>
      对 placeholder 设置 line-height 及 font-size
     </li>
     <li>
      对 input 设置高度
     </li>
    </ul>
    <p>
     其实安卓和 ios 的样式差异还是挺多的，平时开发中需要多测试多调整。
    </p>
    <hr/>
    <p>
     做久了后端，发现小程序和前端开发真的需要很多的耐心，虚心请教，坚持学习非常重要，继续加油！
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f6a313233313233302f:61727469636c652f64657461696c732f313131363739363638" class_="artid" style="display:none">
 </p>
</div>


