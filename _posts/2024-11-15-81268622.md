---
layout: post
title: "iOS直播一AVFoundation音视频采集"
date: 2024-11-15 22:02:01 +0800
description: "一、要实现从摄像头和麦克风获取视频和音频，需要使用苹果提供的AVFoundation框架，下面是需要"
keywords: "直播av"
categories: ['Ios']
tags: ['无标签']
artid: "81268622"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=81268622
    alt: "iOS直播一AVFoundation音视频采集"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     iOS直播（一）AVFoundation音视频采集
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <h4 id="一要实现从摄像头和麦克风获取视频和音频需要使用苹果提供的avfoundation框架下面是需要用到的类的说明">
     一、要实现从摄像头和麦克风获取视频和音频，需要使用苹果提供的AVFoundation框架，下面是需要用到的类的说明：
    </h4>
    <h5 id="1avcapturesession">
     1.AVCaptureSession
    </h5>
    <p>
     AV Foundation捕捉栈的核心类是AVCaptureSession。一个AVCaptureSession相当于一个虚拟的“插线板”，用以连接输入和输出的资源。
    </p>
    <h5 id="2avcapturedevice">
     2.AVCaptureDevice
    </h5>
    <p>
     AVCaptureDevice为诸如摄像头或麦克风等物理设备定义了一个接口，针对物理设备定义了大量的控制方法，比如控制摄像头的对焦、曝光、白平衡和闪光灯等。
    </p>
    <h5 id="3avcapturedeviceinput">
     3.AVCaptureDeviceInput
    </h5>
    <p>
     在使用捕捉设备进行处理前，首先需要将它添加为捕捉会话的输入。但是需要将它封装在一个AVCaptureDeviceInput实例中，这个对象在设备输出数据和捕捉会话间扮演接线板的作用。
    </p>
    <h5 id="4avcaptureoutput">
     4.AVCaptureOutput
    </h5>
    <p>
     AVCaptureOutput是一个抽象基类，用于为从捕捉会话得到的数据寻找输出目的地。
    </p>
    <h5 id="5avcaptureconnection">
     5.AVCaptureConnection
    </h5>
    <p>
     捕捉会话首先需要确定由给定捕捉设备输入渲染的媒体类型，并自动建立其到能够接收该媒体类型的捕捉输出端的连接。可以让开发者对信号流进行底层的控制。比如禁用某些特定的连接，或在音频连接中访问单独的音频轨道。
    </p>
    <h5 id="6avcapturevideopreviewlayer">
     6.AVCaptureVideoPreviewLayer
    </h5>
    <p>
     预览层是一个Core Animation的CALayer子类，对捕捉视频数据进行实时预览。
    </p>
    <h4 id="二示例代码">
     二、示例代码
    </h4>
    <p>
     1.将整个过程拆分为视频采集、音频采集、预览三步实现：
    </p>
    <pre class="prettyprint"><code class="hljs scss">    override func <span class="hljs-function">viewDidLoad()</span> {
        <span class="hljs-value">super</span><span class="hljs-class">.viewDidLoad</span>()
        <span class="hljs-comment">//1.初始化视频的输入&amp;输出</span>
        <span class="hljs-function">setUpVideoInputOutput()</span>

        <span class="hljs-comment">//2.初始化音频的输入&amp;输出</span>
        <span class="hljs-function">setupAudioInputOutput()</span>

        <span class="hljs-comment">//3.初始化一个预览图层</span>
        <span class="hljs-function">setupPreviewLayer()</span>

    }</code></pre>
    <p>
     2.视频采集
    </p>
    <pre class="prettyprint"><code class="hljs rust">    fileprivate func setUpVideoInputOutput() {
        <span class="hljs-comment">//1.获取视频输入设备列表</span>
        guard <span class="hljs-keyword">let</span> devices = AVCaptureDevice.devices() as? [AVCaptureDevice] <span class="hljs-keyword">else</span> {<!-- --><span class="hljs-keyword">return</span>}
        <span class="hljs-comment">//2.获取视频输入设备（前置摄像头）</span>
        guard <span class="hljs-keyword">let</span> device = devices.filter({$<span class="hljs-number">0</span>.position == .front}).first <span class="hljs-keyword">else</span> {<!-- --><span class="hljs-keyword">return</span>}
        <span class="hljs-comment">//3.创建输入</span>
        guard <span class="hljs-keyword">let</span> input = try? AVCaptureDeviceInput(device: device) <span class="hljs-keyword">else</span> {<!-- --><span class="hljs-keyword">return</span>}
        <span class="hljs-keyword">self</span>.videoInput = input

        <span class="hljs-comment">//2.添加视频输出</span>
        <span class="hljs-keyword">let</span> output = AVCaptureVideoDataOutput()
        <span class="hljs-keyword">let</span> queue = DispatchQueue.global()
        output.setSampleBufferDelegate(<span class="hljs-keyword">self</span>, queue: queue)
        <span class="hljs-keyword">self</span>.videoOutput = output

        <span class="hljs-comment">//3.添加输入&amp;输出</span>
        addInputOutputToSession(input, output)
    }</code></pre>
    <p>
     3.音频采集
    </p>
    <pre class="prettyprint"><code class="hljs lasso">    fileprivate func setupAudioInputOutput() {
        <span class="hljs-comment">//1.获取麦克风输入设备</span>
        guard <span class="hljs-keyword">let</span> device <span class="hljs-subst">=</span> AVCaptureDevice<span class="hljs-built_in">.</span>default(for: <span class="hljs-built_in">.</span>audio) <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
        <span class="hljs-comment">//2.创建输入</span>
        guard <span class="hljs-keyword">let</span> input <span class="hljs-subst">=</span> try<span class="hljs-subst">?</span> AVCaptureDeviceInput(device: device) <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }

        <span class="hljs-comment">//2.创建输出</span>
        <span class="hljs-keyword">let</span> output <span class="hljs-subst">=</span> AVCaptureAudioDataOutput()
        <span class="hljs-keyword">let</span> <span class="hljs-built_in">queue</span> <span class="hljs-subst">=</span> DispatchQueue<span class="hljs-built_in">.</span><span class="hljs-built_in">global</span>()
        output<span class="hljs-built_in">.</span>setSampleBufferDelegate(<span class="hljs-built_in">self</span>, <span class="hljs-built_in">queue</span>: <span class="hljs-built_in">queue</span>)

        <span class="hljs-comment">//3.添加输入&amp;输出</span>
        addInputOutputToSession(input, output)
    }</code></pre>
    <p>
     4.音视频添加输入&amp;输出的公用方法（2、3步中的addInputOutputToSession方法）
    </p>
    <pre class="prettyprint"><code class="hljs cs">    <span class="hljs-keyword">private</span> func <span class="hljs-title">addInputOutputToSession</span>(_ input : AVCaptureInput, _ output : AVCaptureOutput){
        session.beginConfiguration()
        <span class="hljs-comment">//将输入连接到session</span>
        <span class="hljs-keyword">if</span> session.canAddInput(input) {
            session.addInput(input)
        }
        <span class="hljs-comment">//将输出连接到session</span>
        <span class="hljs-keyword">if</span> session.canAddOutput(output) {
            session.addOutput(output)
        }
        session.commitConfiguration()
    }</code></pre>
    <p>
     5.实现2、3步中的SampleBufferDelegate代理方法（采集到音视频时的回调方法）
    </p>
    <pre class="prettyprint"><code class="hljs go">extension ViewController : AVCaptureVideoDataOutputSampleBufferDelegate,AVCaptureAudioDataOutputSampleBufferDelegate{
    <span class="hljs-keyword">func</span> captureOutput(_ output: AVCaptureOutput, didOutput sampleBuffer: CMSampleBuffer, from connection: AVCaptureConnection) {
        <span class="hljs-keyword">if</span> videoOutput?.connection(with: .video) == connection {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"采集视频"</span>)
        }<span class="hljs-keyword">else</span>{
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"采集音频"</span>)
        }
    }
}</code></pre>
    <p>
     6.创建预览层
    </p>
    <pre class="prettyprint"><code class="hljs rust">    fileprivate func setupPreviewLayer() {
        <span class="hljs-comment">//1.创建预览图层</span>
        <span class="hljs-keyword">let</span> previewLayer = AVCaptureVideoPreviewLayer(session: session)

        <span class="hljs-comment">//2.设置previewLayer属性</span>
        previewLayer.frame = view.bounds;

        <span class="hljs-comment">//3.将图层添加到控制器的view的layer中</span>
        view.layer.insertSublayer(previewLayer, at: <span class="hljs-number">0</span>)
        <span class="hljs-keyword">self</span>.previewLayer = previewLayer
    }</code></pre>
    <p>
     完整demo代码：
     <br/>
     <a href="https://github.com/dolacmeng/VideoCaptureDemo">
      https://github.com/dolacmeng/VideoCaptureDemo
     </a>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470733a:2f2f626c6f672e6373646e2e6e65742f646f6c61636d656e67:2f61727469636c652f64657461696c732f3831323638363232" class_="artid" style="display:none">
 </p>
</div>


