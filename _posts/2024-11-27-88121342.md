---
layout: post
title: "Redis集群使用keys命令搜索匹配的Key"
date: 2024-11-27 19:26:27 +0800
description: "需求今天在项目过程中碰到了一个需求：1.所有节点（数量在1～10万）都会存储一个在线状态的Key在R"
keywords: "jedis集群keys能否查出所有匹配的键"
categories: ['未分类']
tags: ['数据库', '操作系统', 'Java']
artid: "88121342"
image:
  path: https://api.vvhan.com/api/bing?rand=sj&artid=88121342
  alt: "Redis集群使用keys命令搜索匹配的Key"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     Redis集群使用keys命令搜索匹配的Key
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <div class="article-content">
     <h2 class="heading">
      需求
     </h2>
     <p>
      今天在项目过程中碰到了一个需求：
     </p>
     <p>
      1.所有节点（数量在1～10万）都会存储一个在线状态的Key在Redis集群，3分钟失效， 收到节点上报的任何数据后，刷新这个缓存。
     </p>
     <p>
      2.需定时查询所有节点在Redis的状态，并将节点状态同步到数据库。
     </p>
     <h2 class="heading">
      问题
     </h2>
     <p>
      因为Redis只有顶级的Key才可以设置超时时间，所以无法使用hset,hgetAll命令一次
      <br/>
      性获取所有的节点信息，只有使用get(key)方法一个一个获取设备的在线状态，由于
      <br/>
      Redis是单线程应用，这就造成了比较严重的性能问题。
     </p>
     <p>
      经测试循环获取8万个节点的在线状态，耗时会达到50s左右，这是完全无法容忍的。
     </p>
     <p>
      而项目中为保证可靠性，使用的是Redis集群，Redis操作都必须通过JedisCluster的
      <br/>
      接口来实现，故而也无法使用Jedis的keys(pattern)方法来一次性搜索所有的在线节
      <br/>
      点的Key。
     </p>
     <h2 class="heading">
      解决思路
     </h2>
     <p>
      网络上搜索了一些解决方法，都感觉有些复杂，所以自己考虑是否可以用更简单的方
      <br/>
      式解决这个问题。
     </p>
     <p>
      思路是Redis集群有6个节点，其中有3个主节点，每个主节点各自有一个从节点，其
      <br/>
      实只需要将集群视为3个单独的Redis，分别用keys(pattern)方法搜索各自的key，然
      <br/>
      后把3次搜索的结果相加，就是集群内所有的Key了。
     </p>
     <p>
      JedisCluster在网上的API很少，进去这个类看了一下，发现有一个方法：
     </p>
     <pre><code class="hljs bash copyable">Map&lt;String,JedisPool&gt; getClusterNodes();
<span class="copy-code-btn">复制代码</span></code></pre>
     <p>
      根据方法名和返回值判断，这应该就是我要找的获取Redis集群所有节点的方法了，
      <br/>
      写了个方法测试了一下，果然可以拿到集群内所有的节点，那剩下的事情就好办了。
     </p>
     <p>
      最终的搜索集群内匹配的Key方法如下：
     </p>
     <pre><code class="hljs bash copyable">/**
 * 搜索集群内匹配的Key
 *
 * @param pattern 匹配规则,该参数和Jedis keys(pattern)方法相同。
 *                eg:搜索Node_status_开头的所有key，该参数填Node_status_*
 * @<span class="hljs-built_in">return</span> 集群内所有符合规则的Key列表
 */
public Set&lt;String&gt; clusterKeys(String pattern)throws DataLoadException{
    Set&lt;String&gt; result = new HashSet&lt;&gt;();
    try {
        // 获取Redis集群内所有节点
        Map&lt;String, JedisPool&gt; clusterNodes = jedisCluster.getClusterNodes();

        <span class="hljs-keyword">for</span> (Map.Entry&lt;String, JedisPool&gt; entry : clusterNodes.entrySet()) {
            Jedis jedis = entry.getValue().getResource();
            // 判断非从节点(因为若主从复制，从节点会跟随主节点的变化而变化)
            <span class="hljs-keyword">if</span> (!jedis.info(<span class="hljs-string">"replication"</span>).contains(<span class="hljs-string">"role:slave"</span>)) {
                // 搜索单个节点内匹配的Key
                Set&lt;String&gt; keys = jedis.keys(pattern);
                // 合并搜索结果
                result.addAll(keys);
            }
            jedis.close();
        }
    } catch (Exception e) {
        throw new DataLoadException(e);
    } finally {
        <span class="hljs-built_in">return</span>JedisCluster(jedisCluster);
    }
    <span class="hljs-built_in">return</span> result;

}
<span class="copy-code-btn">复制代码</span></code></pre>
<p>
经测试，该方法一次性搜索 8 万个节点的在线状态，耗时在 100ms 左右。
</p>
</div>

   </div>
  </div>
  <div id="recommendDown">
  </div>
 </article>
 <p alt="68747470733a2f2f626c6f67:2e6373646e2e6e65742f77656978696e5f3333373031323531:2f61727469636c652f64657461696c732f3838313231333432" class_="artid" style="display:none">
 </p>
</div>
