---
layout: post
title: "AWS-s3-java-api使用"
date: 2024-12-02 11:39:53 +0800
description: "    由于项目需要采用minio快速搭建了一个分布式s3存储系统，为了考虑以后迁移到ceph的可能"
keywords: "java s3 api"
categories: ['分布式']
tags: ['S', 'Java', 'Aws', 'Api']
artid: "87204090"
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=87204090
    alt: "AWS-s3-java-api使用"
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     AWS s3 java api使用
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="htmledit_views" id="content_views">
    <p>
     由于项目需要采用minio快速搭建了一个分布式s3存储系统，为了考虑以后迁移到ceph的可能性，后端api放弃了minio的官方api而采用Amazon提供的官方s3 api，由于minio是兼容s3协议的存储系统，因此理论上可以采用aws sdk进行调用。
    </p>
    <p>
     下载java sdk的sample代码：
    </p>
    <p>
     git clone
     <a href="https://github.com/awslabs/aws-java-sample.git">
      https://github.com/awslabs/aws-java-sample.git
     </a>
    </p>
    <p>
     执行mvn package将自动下载依赖jar包和编译
    </p>
    <p>
     期间将遇到错误 [Maven] Can't build because of Source option 1.5 is no longer supported，解决方式是：
    </p>
    <p>
     将
    </p>
    <p>
     &lt;properties&gt;
     <br/>
     &lt;maven.compiler.source&gt;1.6&lt;/maven.compiler.source&gt;
     <br/>
     &lt;maven.compiler.target&gt;1.6&lt;/maven.compiler.target&gt;
     <br/>
     &lt;/properties&gt;
    </p>
    <p>
     添加到pod.xml文件
    </p>
    <p>
     修改sample代码，将endpoint指定到内部搭建的s3地址，并且指定access_key和secret_key:
    </p>
    <p>
     <br/>
     +        //AmazonS3 s3 = new AmazonS3Client();
     <br/>
     +        AmazonS3 s3 = new AmazonS3Client(new BasicAWSCredentials("admin", "password"));
     <br/>
     Region usWest2 = Region.getRegion(Regions.US_WEST_2);
     <br/>
     s3.setRegion(usWest2);
     <br/>
     +        s3.setEndpoint("http://192.168.101.200:31001");
    </p>
    <p>
    </p>
    <p>
     mvn package编译
    </p>
    <p>
     mvn exec:java执行
    </p>
    <p>
     执行期间将报
    </p>
    <p>
     Caused by: java.lang.NoClassDefFoundError: javax/xml/bind/DatatypeConverter的Exception，
    </p>
    <p>
     请在pod.xml中添加
    </p>
    <p>
     &lt;dependency&gt;
     <br/>
     &lt;groupId&gt;javax.xml.bind&lt;/groupId&gt;
     <br/>
     &lt;artifactId&gt;jaxb-api&lt;/artifactId&gt;
     <br/>
     &lt;version&gt;2.3.0&lt;/version&gt;
     <br/>
     &lt;/dependency&gt;
    </p>
    <p>
     依赖
    </p>
    <p>
     mvn exec:java执行
    </p>
    <p>
     可以看到创建bucket和list bucket成功，但是往bucket中upload数据的时候，报
    </p>
    <p>
     java.lang.NullPointerException异常，这是由于ETag和eTag大小写导致的兼容问题，在最新的sdk版本中有修复。
    </p>
    <p>
     修改pod.xml中aws-sdk的version至最新版本：
    </p>
    <p>
     &lt;dependency&gt;
     <br/>
     &lt;groupId&gt;com.amazonaws&lt;/groupId&gt;
     <br/>
     &lt;artifactId&gt;aws-java-sdk&lt;/artifactId&gt;
     <br/>
     &lt;version&gt;1.11.497&lt;/version&gt;
     <br/>
     &lt;/dependency&gt;
    </p>
    <p>
     再次编译，记录运行结果：
    </p>
    <p>
     lyh@lyh:~/Project/aws-java-sample$ mvn exec:java
     <br/>
     WARNING: An illegal reflective access operation has occurred
     <br/>
     WARNING: Illegal reflective access by com.google.inject.internal.cglib.core.$ReflectUtils$1 (file:/usr/share/maven/lib/guice.jar) to method java.lang.ClassLoader.defineClass(java.lang.String,byte[],int,int,java.security.ProtectionDomain)
     <br/>
     WARNING: Please consider reporting this to the maintainers of com.google.inject.internal.cglib.core.$ReflectUtils$1
     <br/>
     WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations
     <br/>
     WARNING: All illegal access operations will be denied in a future release
     <br/>
     [INFO] Scanning for projects...
     <br/>
     [INFO]
     <br/>
     [INFO] ------------------------------------------------------------------------
     <br/>
     [INFO] Building aws-java-sample 1.0
     <br/>
     [INFO] ------------------------------------------------------------------------
     <br/>
     [INFO]
     <br/>
     [INFO] &gt;&gt;&gt; exec-maven-plugin:1.2.1:java (default-cli) &gt; validate @ aws-java-sample &gt;&gt;&gt;
     <br/>
     [INFO]
     <br/>
     [INFO] &lt;&lt;&lt; exec-maven-plugin:1.2.1:java (default-cli) &lt; validate @ aws-java-sample &lt;&lt;&lt;
     <br/>
     [INFO]
     <br/>
     [INFO]
     <br/>
     [INFO] --- exec-maven-plugin:1.2.1:java (default-cli) @ aws-java-sample ---
     <br/>
     ===========================================
     <br/>
     Getting Started with Amazon S3
     <br/>
     ===========================================
    </p>
    <p>
     Creating bucket my-first-s3-bucket-49530254-b8e0-49ab-80f5-ac5d285e2cea
    </p>
    <p>
     Listing buckets
     <br/>
     - dddd
     <br/>
     - my-first
     <br/>
     - my-first-s3-bucket-06f0d306-8671-4bf6-bc90-6132431e461d
     <br/>
     - my-first-s3-bucket-30a8e103-1f69-4656-85e2-2f2fcbd3948e
     <br/>
     - my-first-s3-bucket-49530254-b8e0-49ab-80f5-ac5d285e2cea
    </p>
    <p>
     Uploading a new object to S3 from a file
    </p>
    <p>
     Downloading an object
     <br/>
     Content-Type: text/plain
     <br/>
     abcdefghijklmnopqrstuvwxyz
     <br/>
     01234567890112345678901234
     <br/>
     !@#$%^&amp;*()-=[]{};':',.&lt;&gt;/?
     <br/>
     01234567890112345678901234
     <br/>
     abcdefghijklmnopqrstuvwxyz
    </p>
    <p>
     Listing objects
     <br/>
     - MyObjectKey  (size = 135)
    </p>
    <p>
     Deleting an object
    </p>
    <p>
     Deleting bucket my-first-s3-bucket-49530254-b8e0-49ab-80f5-ac5d285e2cea
     <br/>
    </p>
   </div>
  </div>
 </article>
 <p alt="68747470733a2f:2f626c6f672e6373646e2e6e65742f736d616c6c68756a6975:2f61727469636c652f64657461696c732f3837323034303930" class_="artid" style="display:none">
 </p>
</div>


