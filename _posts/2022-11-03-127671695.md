---
layout: post
title: websocket实时推送统计数据给前端页面
date: 2022-11-03 16:02:30 +0800
description: 文章浏览阅读3.1k次。每秒推送一次,`前日/昨日/今日` 三个维度中的前十名的客户统计数据给前端页
keywords: websocket实时推送统计数据给前端页面
categories: ['实操']
tags: ['前端', 'Websocket', 'Java']
image:
    path: https://api.vvhan.com/api/bing?rand=sj&artid=127671695
    alt: websocket实时推送统计数据给前端页面
artid: 127671695
render_with_liquid: false
---

<div class="blog-content-box">
 <div class="article-header-box">
  <div class="article-header">
   <div class="article-title-box">
    <h1 class="title-article" id="articleContentId">
     websocket实时推送统计数据给前端页面
    </h1>
   </div>
  </div>
 </div>
 <article class="baidu_pl">
  <div class="article_content clearfix" id="article_content">
   <link href="../../assets/css/kdoc_html_views-1a98987dfd.css" rel="stylesheet"/>
   <link href="../../assets/css/ck_htmledit_views-704d5b9767.css" rel="stylesheet"/>
   <div class="markdown_views prism-atom-one-dark" id="content_views">
    <svg style="display: none;" xmlns="http://www.w3.org/2000/svg">
     <path d="M5,0 0,2.5 5,5z" id="raphael-marker-block" stroke-linecap="round" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     </path>
    </svg>
    <p>
    </p>
    <div class="toc">
     <h4>
      文章目录
     </h4>
     <ul>
      <li>
       <a href="#_7" rel="nofollow">
        连接触发业务定义
       </a>
      </li>
      <li>
       <a href="#_162" rel="nofollow">
        使用到的业务方法
       </a>
      </li>
      <li>
       <ul>
        <li>
         <a href="#sql_243" rel="nofollow">
          涉及的查询sql
         </a>
        </li>
       </ul>
      </li>
      <li>
       <a href="#_266" rel="nofollow">
        推送数据给前端演示图
       </a>
      </li>
     </ul>
    </div>
    <p>
    </p>
    <ul>
     <li>
      <p>
       前提须知:
       <a href="https://blog.csdn.net/EDT777/article/details/114537721?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166746222916800192257216%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=166746222916800192257216&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-1-114537721-null-null.nonecase&amp;utm_term=websocket&amp;spm=1018.2226.3001.4450">
        websocket基本使用
       </a>
      </p>
     </li>
     <li>
      <p>
       业务场景,每秒推送统计数据给前端页面,分别显示前天,昨天,今天的前十名客户数据
      </p>
     </li>
    </ul>
    <h2>
     <a id="_7">
     </a>
     连接触发业务定义
    </h2>
    <ul>
     <li>
      <code>
       @ServerEndpoint("/smsMCustomerStaTop10Ws")
      </code>
      定义推送数据给到具体的连接标识
     </li>
    </ul>
    <pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span>JSON<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONArray</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span></span><span class="token class-name">JSONObject</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>xyc<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">SmsMonitorService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>xyc<span class="token punctuation">.</span>monitor<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl<span class="token punctuation">.</span></span><span class="token class-name">SmsMonitorServiceImpl</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>websocket<span class="token punctuation">.</span>server<span class="token punctuation">.</span></span><span class="token class-name">ServerEndpoint</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Set</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ConcurrentHashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CopyOnWriteArraySet</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Top10客户发送量推送
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@ServerEndpoint</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">"/smsMCustomerStaTop10Ws"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SmsMCustomerStaTop10Ws</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> LOGGER <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">SmsMCustomerStaTop10Ws</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">//静态变量，用来记录当前在线连接数。应该把它设计成线程安全的。</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> onlineCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">//concurrent包的线程安全Set，用来存放每个客户端对应的当前对象。</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SmsMCustomerStaTop10Ws</span><span class="token punctuation">&gt;</span></span> webSocketSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArraySet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SmsMCustomerStaTop10Ws</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Session</span><span class="token punctuation">,</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//与某个客户端的连接会话，需要通过它来给客户端发送数据</span>
    <span class="token keyword">private</span> <span class="token class-name">Session</span> session<span class="token punctuation">;</span>
    <span class="token comment">//客户端传过来的参数 ,ip:port</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> parameter<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">SmsMonitorService</span> smsMonitorService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setSmsMonitorService</span><span class="token punctuation">(</span><span class="token class-name">SmsMonitorService</span> smsMonitorService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SmsMCustomerStaTop10Ws</span><span class="token punctuation">.</span>smsMonitorService <span class="token operator">=</span> smsMonitorService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *  连接建立成功调用的方法
     * @param session
     */</span>
    <span class="token annotation punctuation">@OnOpen</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onOpen</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>session <span class="token operator">=</span> session<span class="token punctuation">;</span>
        webSocketSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//加入set中</span>
        <span class="token function">addOnlineCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//在线数加1</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"SmsMCustomerStaTop10Ws ===&gt; 有新连接加入！当前在线人数为"</span> <span class="token operator">+</span> <span class="token function">getOnlineCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 连接关闭调用的方法
     */</span>
    <span class="token annotation punctuation">@OnClose</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onClose</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        map<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//UDPMsgQueueStatusClient.removeUdpClient(parameter);</span>
        webSocketSet<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//从set中删除</span>
        <span class="token function">subOnlineCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//在线数减1</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"SmsMCustomerStaTop10Ws ===&gt; 有一连接关闭！当前在线人数为"</span> <span class="token operator">+</span> <span class="token function">getOnlineCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 收到客户端消息后调用的方法
     *
     * @param message 客户端发送过来的消息
     *
     * */</span>
    <span class="token annotation punctuation">@OnMessage</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">String</span> message<span class="token punctuation">,</span> <span class="token class-name">Session</span> session<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//关闭前一个udp</span>
        <span class="token comment">//UDPMsgQueueStatusClient.removeUdpClient(parameter);</span>
        <span class="token comment">//this.parameter = message;</span>
        <span class="token class-name">JSONArray</span> objects <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//JSONObject jso = JSON.parseObject(message);</span>
        <span class="token class-name">Integer</span> status<span class="token operator">=</span> objects<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInteger</span><span class="token punctuation">(</span><span class="token string">"status"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//SmsMonitorServiceImpl.statusSCSSo = status;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"SmsMCustomerStaTop10Ws ===&gt; 来自客户端的消息:"</span> <span class="token operator">+</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 发生错误时调用
     */</span>
    <span class="token annotation punctuation">@OnError</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Session</span> session<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"SmsMCustomerStaTop10Ws 发生错误"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"onError ===&gt; "</span><span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 推送触发
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">pushTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">SmsMCustomerStaTop10Ws</span><span class="token punctuation">.</span>onlineCount <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">SmsMonitorServiceImpl</span><span class="token punctuation">.</span>isPushSCS<span class="token punctuation">)</span>
                <span class="token class-name">SmsMonitorServiceImpl</span><span class="token punctuation">.</span>isPushSCS <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            smsMonitorService<span class="token punctuation">.</span><span class="token function">pushSmsMCustomerStaTop10</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">SmsMCustomerStaTop10Ws</span><span class="token punctuation">.</span>onlineCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">SmsMonitorServiceImpl</span><span class="token punctuation">.</span>isPushSCS <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     *  发送文本类型消息  192.168.3.146:10086
     * @throws IOException
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">sendInfo</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> status<span class="token punctuation">,</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SmsMCustomerStaTop10Ws</span> item <span class="token operator">:</span> webSocketSet<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Session</span> session <span class="token operator">=</span> item<span class="token punctuation">.</span>session<span class="token punctuation">;</span>
                <span class="token class-name">Integer</span> integer <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>integer <span class="token operator">==</span> status<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    item<span class="token punctuation">.</span>session<span class="token punctuation">.</span><span class="token function">getBasicRemote</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sendText</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"SmsMCustomerStaTop10Ws ===&gt; 发送文本消息错误"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">getOnlineCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> onlineCount<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">addOnlineCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SmsMCustomerStaTop10Ws</span><span class="token punctuation">.</span>onlineCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token function">pushTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">subOnlineCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">SmsMCustomerStaTop10Ws</span><span class="token punctuation">.</span>onlineCount<span class="token operator">--</span><span class="token punctuation">;</span>
        <span class="token function">pushTrigger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
    <h2>
     <a id="_162">
     </a>
     使用到的业务方法
    </h2>
    <ul>
     <li>
      以上
      <code>
       onOpen()
      </code>
      方法最终触发的业务方法
      <code>
       smsMonitorService.pushSmsMCustomerStaTop10();
      </code>
     </li>
    </ul>
    <pre><code class="prism language-java">
<span class="token comment">/**
     * 记录线程数，保证只创建一个线程
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token keyword">int</span> threadCountSCS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">/**
     * 数据推送开关，是否推送数据到前端，默认关闭
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> isPushSCS <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token comment">/**
     * 今日1,昨天2,前天3 数据 默认今日
     */</span>
     
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ImmutableSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> statusSCS <span class="token operator">=</span> <span class="token class-name">ImmutableSet</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
 <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pushSmsMCustomerStaTop10</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>threadCountSCS <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
            
      threadCountSCS<span class="token operator">++</span><span class="token punctuation">;</span>
      
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">"pushSmsMCustomerStaTop10-"</span> <span class="token operator">+</span> threadCountSCS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"top10客户发送量推送服务线程启动"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>isPushSCS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span> statusSC <span class="token operator">:</span> statusSCS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SmsMCustomerStaVo</span><span class="token punctuation">&gt;</span></span> smsMCustomerStaTop10 <span class="token operator">=</span> smsMonitorMapper<span class="token punctuation">.</span><span class="token function">findSmsMCustomerStaTop10</span><span class="token punctuation">(</span>statusSC<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SmsMCustomerStaView</span><span class="token punctuation">&gt;</span></span> smsMCustomerStaViewList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SmsMCustomerStaVo</span> sm <span class="token operator">:</span> smsMCustomerStaTop10<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                                <span class="token class-name">SmsMCustomerStaView</span> smsMCustomerStaView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SmsMCustomerStaView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                smsMCustomerStaView<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                smsMCustomerStaView<span class="token punctuation">.</span><span class="token function">setShortName</span><span class="token punctuation">(</span><span class="token class-name">SmsSymbol</span><span class="token punctuation">.</span>customerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getCustomerNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getShortName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                smsMCustomerStaView<span class="token punctuation">.</span><span class="token function">setCustomerName</span><span class="token punctuation">(</span><span class="token class-name">SmsSymbol</span><span class="token punctuation">.</span>customerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getCustomerNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                smsMCustomerStaView<span class="token punctuation">.</span><span class="token function">setSubmitCount</span><span class="token punctuation">(</span>sm<span class="token punctuation">.</span><span class="token function">getAllCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token class-name">Integer</span> issueCount <span class="token operator">=</span> sm<span class="token punctuation">.</span><span class="token function">getSendSuccessCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> sm<span class="token punctuation">.</span><span class="token function">getSendFailCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> sm<span class="token punctuation">.</span><span class="token function">getSubmitSuccessCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//下发总量 = 总量除开提交失败</span>
                                smsMCustomerStaView<span class="token punctuation">.</span><span class="token function">setIssueCount</span><span class="token punctuation">(</span>issueCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token comment">//成功率(前30分钟成功率)</span>
                                <span class="token class-name">Double</span> sendSuccessCountRate <span class="token operator">=</span> <span class="token number">0D</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span><span class="token punctuation">(</span>sm <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> sm<span class="token punctuation">.</span><span class="token function">getAllCountThirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>  sm<span class="token punctuation">.</span><span class="token function">getAllCountThirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                                    sendSuccessCountRate <span class="token operator">=</span> sm<span class="token punctuation">.</span><span class="token function">getSendSuccessCountThirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> sm<span class="token punctuation">.</span><span class="token function">getAllCountThirty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                                <span class="token comment">//未知率</span>
                                <span class="token class-name">Double</span> unknownRateRate <span class="token operator">=</span> <span class="token number">0D</span><span class="token punctuation">;</span>
                                <span class="token keyword">if</span><span class="token punctuation">(</span>sm <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> sm<span class="token punctuation">.</span><span class="token function">getAllCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> sm<span class="token punctuation">.</span><span class="token function">getAllCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                                    <span class="token comment">//sendSuccessCountRate = sm.getSendSuccessCount() / issueCount.doubleValue(); //发送成功率</span>
                                    unknownRateRate <span class="token operator">=</span> sm<span class="token punctuation">.</span><span class="token function">getSubmitSuccessCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> sm<span class="token punctuation">.</span><span class="token function">getAllCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">doubleValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//未知率 = 提交成功 / 提交总量</span>
                                <span class="token punctuation">}</span>
                                smsMCustomerStaView<span class="token punctuation">.</span><span class="token function">setSuccessRate</span><span class="token punctuation">(</span>sendSuccessCountRate <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span><span class="token string">"0%"</span><span class="token operator">:</span><span class="token keyword">new</span> <span class="token class-name">DecimalFormat</span><span class="token punctuation">(</span><span class="token string">"#0.00"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>sendSuccessCountRate <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"%"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                smsMCustomerStaView<span class="token punctuation">.</span><span class="token function">setUnknownRate</span><span class="token punctuation">(</span>unknownRateRate <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">?</span><span class="token string">"0%"</span><span class="token operator">:</span><span class="token keyword">new</span> <span class="token class-name">DecimalFormat</span><span class="token punctuation">(</span><span class="token string">"#0.00"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>unknownRateRate <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"%"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                i<span class="token operator">++</span><span class="token punctuation">;</span>
                                smsMCustomerStaViewList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>smsMCustomerStaView<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token punctuation">}</span>
                            <span class="token comment">//List&lt;SmsMCustomerStaView&gt; collect = smsMCustomerStaViewList.stream().sorted(Comparator.comparing(SmsMCustomerStaView::getSubmitCount).reversed()).collect(Collectors.toList());</span>
                            <span class="token class-name">SmsMCustomerStaTop10Ws</span><span class="token punctuation">.</span><span class="token function">sendInfo</span><span class="token punctuation">(</span>statusSC<span class="token punctuation">,</span>smsMCustomerStaViewList<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token comment">// TODO Auto-generated catch block</span>
                            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"top10客户发送量推送服务报错"</span><span class="token punctuation">,</span>e <span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"top10客户发送量推送服务线程停止"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                threadCountSCS<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
    <h3>
     <a id="sql_243">
     </a>
     涉及的查询sql
    </h3>
    <ul>
     <li>
      以上
      <code>
       smsMonitorMapper.findSmsMCustomerStaTop10(statusSC);
      </code>
      (传参区分查
      <code>
       前日/昨日/今日
      </code>
      数据)
     </li>
     <li>
      oracle数据库查询语句
     </li>
    </ul>
    <pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>findSmsMCustomerStaTop10<span class="token punctuation">"</span></span> <span class="token attr-name">resultMap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>SmsMCustomerStaResultMap<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
		select t.* from (
		 SELECT SUM(ALL_COUNT) ALL_COUNT,SUM(SUBMIT_SUCCESS_COUNT) SUBMIT_SUCCESS_COUNT,SUM(SUBMIT_FAIL_COUNT) SUBMIT_FAIL_COUNT,
		 SUM(SEND_SUCCESS_COUNT) SEND_SUCCESS_COUNT,SUM(SEND_FAIL_COUNT) SEND_FAIL_COUNT,SUM(ALL_COUNT_THIRTY) ALL_COUNT_THIRTY,
		SUM(SEND_SUCCESS_COUNT_THIRTY) SEND_SUCCESS_COUNT_THIRTY,CUSTOMER_NO
		 FROM SMS_M_CUSTOMER_STA
		 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>statusSCS == 1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
			 WHERE STA_DATE_TIME &gt;= trunc(sysdate)
		 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>statusSCS == 2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
			WHERE STA_DATE_TIME &gt;= trunc(sysdate-1) AND STA_DATE_TIME <span class="token cdata">&lt;![CDATA[ &lt; ]]&gt;</span> trunc(sysdate)
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>if</span> <span class="token attr-name">test</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>statusSCS == 3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
			WHERE STA_DATE_TIME &gt;= trunc(sysdate-2) AND STA_DATE_TIME <span class="token cdata">&lt;![CDATA[ &lt; ]]&gt;</span> trunc(sysdate-1)
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>if</span><span class="token punctuation">&gt;</span></span>
	    GROUP BY CUSTOMER_NO ORDER BY ALL_COUNT DESC)t where rownum <span class="token entity named-entity" title="&lt;">&amp;lt;</span>= 20
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">&gt;</span></span>
</code></pre>
    <h2>
     <a id="_266">
     </a>
     推送数据给前端演示图
    </h2>
    <p>
     <img alt="在这里插入图片描述" src="https://i-blog.csdnimg.cn/blog_migrate/0c1b07b457e513e0016238b6bd886f8d.png"/>
    </p>
   </div>
   <link href="../../assets/css/markdown_views-a5d25dd831.css" rel="stylesheet"/>
   <link href="../../assets/css/style-e504d6a974.css" rel="stylesheet"/>
  </div>
 </article>
 <p alt="68747470:733a2f2f626c6f672e6373646e2e6e65742f4544543737372f:61727469636c652f64657461696c732f313237363731363935" class_="artid" style="display:none">
 </p>
</div>


